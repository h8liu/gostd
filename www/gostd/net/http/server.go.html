<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1418701">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1418756">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1418810">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1418861">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418893">package</span>&nbsp;<span class="ident" id="1418901">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418907">import</span>&nbsp;<span class="op" id="1418914">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418917">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418926">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418940">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418950">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418957">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418963">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418976">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418983">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1418990">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419001">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419007">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419015">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419026">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419037">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419048">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419056">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1419071">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1419078">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1419081">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="1419122">var</span>&nbsp;<span class="op" id="1419126">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419129">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="1419148">=</span>&nbsp;<span class="ident" id="1419150">errors</span><span class="op" id="1419156">.</span><span class="ident" id="1419157">New</span><span class="op" id="1419160">(</span><span class="string" id="1419161">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="1419192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419195">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="1419214">=</span>&nbsp;<span class="ident" id="1419216">errors</span><span class="op" id="1419222">.</span><span class="ident" id="1419223">New</span><span class="op" id="1419226">(</span><span class="string" id="1419227">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="1419293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419296">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1419315">=</span>&nbsp;<span class="ident" id="1419317">errors</span><span class="op" id="1419323">.</span><span class="ident" id="1419324">New</span><span class="op" id="1419327">(</span><span class="string" id="1419328">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="1419352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1419355">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1419374">=</span>&nbsp;<span class="ident" id="1419376">errors</span><span class="op" id="1419382">.</span><span class="ident" id="1419383">New</span><span class="op" id="1419386">(</span><span class="string" id="1419387">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="1419443">)</span><br>
<span class="lineno">35</span><span class="op" id="1419445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1419448">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1419501">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="1419553">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="1419576">//</span><br>
<span class="lineno"></span><span class="comment" id="1419579">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="1419650">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="1419718">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1419781">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="1419800">//</span><br>
<span class="lineno"></span><span class="comment" id="1419803">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="1419872">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="1419940">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1420010">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="1420042">//</span><br>
<span class="lineno"></span><span class="keyword" id="1420045">type</span>&nbsp;<span class="ident" id="1420050">Handler</span>&nbsp;<span class="keyword" id="1420058">interface</span>&nbsp;<span class="op" id="1420068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420071">ServeHTTP</span><span class="op" id="1420080">(</span><span class="ident" id="1420081">ResponseWriter</span><span class="op" id="1420095">,</span>&nbsp;<span class="op" id="1420097">*</span><span class="ident" id="1420098">Request</span><span class="op" id="1420105">)</span><br>
<span class="lineno"></span><span class="op" id="1420107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="1420110">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1420170">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="1420201">type</span>&nbsp;<span class="ident" id="1420206">ResponseWriter</span>&nbsp;<span class="keyword" id="1420221">interface</span>&nbsp;<span class="op" id="1420231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420234">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420302">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420369">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420384">Header</span><span class="op" id="1420390">(</span><span class="op" id="1420391">)</span>&nbsp;<span class="ident" id="1420393">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420402">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420472">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420555">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420618">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420696">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1420760">Write</span><span class="op" id="1420765">(</span><span class="op" id="1420766">[</span><span class="op" id="1420767">]</span><span class="builtintype" id="1420768">byte</span><span class="op" id="1420772">)</span>&nbsp;<span class="op" id="1420774">(</span><span class="builtintype" id="1420775">int</span><span class="op" id="1420778">,</span>&nbsp;<span class="builtintype" id="1420780">error</span><span class="op" id="1420785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420789">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420853">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420922">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1420979">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421037">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1421059">WriteHeader</span><span class="op" id="1421070">(</span><span class="builtintype" id="1421071">int</span><span class="op" id="1421074">)</span><br>
<span class="lineno"></span><span class="op" id="1421076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1421079">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="1421149">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="1421206">//</span><br>
<span class="lineno"></span><span class="comment" id="1421209">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="1421267">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="1421320">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="1421385">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="1421399">type</span>&nbsp;<span class="ident" id="1421404">Flusher</span>&nbsp;<span class="keyword" id="1421412">interface</span>&nbsp;<span class="op" id="1421422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421425">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1421474">Flush</span><span class="op" id="1421479">(</span><span class="op" id="1421480">)</span><br>
<span class="lineno"></span><span class="op" id="1421482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="1421485">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="1421556">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="1421604">type</span>&nbsp;<span class="ident" id="1421609">Hijacker</span>&nbsp;<span class="keyword" id="1421618">interface</span>&nbsp;<span class="op" id="1421628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421631">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421684">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421738">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421789">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1421842">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1421872">Hijack</span><span class="op" id="1421878">(</span><span class="op" id="1421879">)</span>&nbsp;<span class="op" id="1421881">(</span><span class="ident" id="1421882">net</span><span class="op" id="1421885">.</span><span class="ident" id="1421886">Conn</span><span class="op" id="1421890">,</span>&nbsp;<span class="op" id="1421892">*</span><span class="ident" id="1421893">bufio</span><span class="op" id="1421898">.</span><span class="ident" id="1421899">ReadWriter</span><span class="op" id="1421909">,</span>&nbsp;<span class="builtintype" id="1421911">error</span><span class="op" id="1421916">)</span><br>
<span class="lineno"></span><span class="op" id="1421918">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="1421921">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1421992">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="1422057">//</span><br>
<span class="lineno"></span><span class="comment" id="1422060">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="1422130">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="1422194">type</span>&nbsp;<span class="ident" id="1422199">CloseNotifier</span>&nbsp;<span class="keyword" id="1422213">interface</span>&nbsp;<span class="op" id="1422223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422226">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1422289">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422335">CloseNotify</span><span class="op" id="1422346">(</span><span class="op" id="1422347">)</span>&nbsp;<span class="op" id="1422349">&lt;-</span><span class="keyword" id="1422351">chan</span>&nbsp;<span class="builtintype" id="1422356">bool</span><br>
<span class="lineno">110</span><span class="op" id="1422361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1422364">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="1422424">type</span>&nbsp;<span class="ident" id="1422429">conn</span>&nbsp;<span class="keyword" id="1422434">struct</span>&nbsp;<span class="op" id="1422441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422444">remoteAddr</span>&nbsp;<span class="builtintype" id="1422455">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422476">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422511">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422522">*</span><span class="ident" id="1422523">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422543">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422590">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422601">net</span><span class="op" id="1422604">.</span><span class="ident" id="1422605">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422622">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422641">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422652">io</span><span class="op" id="1422654">.</span><span class="ident" id="1422655">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422673">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422734">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1422745">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422766">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422794">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1422805">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422826">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422880">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422891">*</span><span class="ident" id="1422892">io</span><span class="op" id="1422894">.</span><span class="ident" id="1422895">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422912">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1422935">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1422946">*</span><span class="ident" id="1422947">bufio</span><span class="op" id="1422952">.</span><span class="ident" id="1422953">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1422967">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423030">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1423041">*</span><span class="ident" id="1423042">tls</span><span class="op" id="1423045">.</span><span class="ident" id="1423046">ConnectionState</span>&nbsp;<span class="comment" id="1423062">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423093">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423106">sync</span><span class="op" id="1423110">.</span><span class="ident" id="1423111">Mutex</span>&nbsp;<span class="comment" id="1423117">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423142">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1423155">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1423166">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423209">closeNotifyc</span>&nbsp;<span class="keyword" id="1423222">chan</span>&nbsp;<span class="builtintype" id="1423227">bool</span>&nbsp;&nbsp;<span class="comment" id="1423233">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423249">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1423262">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1423273">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="1423316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="1423319">func</span>&nbsp;<span class="op" id="1423324">(</span><span class="ident" id="1423325">c</span>&nbsp;<span class="op" id="1423327">*</span><span class="ident" id="1423328">conn</span><span class="op" id="1423332">)</span>&nbsp;<span class="ident" id="1423334">hijacked</span><span class="op" id="1423342">(</span><span class="op" id="1423343">)</span>&nbsp;<span class="builtintype" id="1423345">bool</span>&nbsp;<span class="op" id="1423350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423353">c</span><span class="op" id="1423354">.</span><span class="ident" id="1423355">mu</span><span class="op" id="1423357">.</span><span class="ident" id="1423358">Lock</span><span class="op" id="1423362">(</span><span class="op" id="1423363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423366">defer</span>&nbsp;<span class="ident" id="1423372">c</span><span class="op" id="1423373">.</span><span class="ident" id="1423374">mu</span><span class="op" id="1423376">.</span><span class="ident" id="1423377">Unlock</span><span class="op" id="1423383">(</span><span class="op" id="1423384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423387">return</span>&nbsp;<span class="ident" id="1423394">c</span><span class="op" id="1423395">.</span><span class="ident" id="1423396">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="1423406">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1423409">func</span>&nbsp;<span class="op" id="1423414">(</span><span class="ident" id="1423415">c</span>&nbsp;<span class="op" id="1423417">*</span><span class="ident" id="1423418">conn</span><span class="op" id="1423422">)</span>&nbsp;<span class="ident" id="1423424">hijack</span><span class="op" id="1423430">(</span><span class="op" id="1423431">)</span>&nbsp;<span class="op" id="1423433">(</span><span class="ident" id="1423434">rwc</span>&nbsp;<span class="ident" id="1423438">net</span><span class="op" id="1423441">.</span><span class="ident" id="1423442">Conn</span><span class="op" id="1423446">,</span>&nbsp;<span class="ident" id="1423448">buf</span>&nbsp;<span class="op" id="1423452">*</span><span class="ident" id="1423453">bufio</span><span class="op" id="1423458">.</span><span class="ident" id="1423459">ReadWriter</span><span class="op" id="1423469">,</span>&nbsp;<span class="ident" id="1423471">err</span>&nbsp;<span class="builtintype" id="1423475">error</span><span class="op" id="1423480">)</span>&nbsp;<span class="op" id="1423482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423485">c</span><span class="op" id="1423486">.</span><span class="ident" id="1423487">mu</span><span class="op" id="1423489">.</span><span class="ident" id="1423490">Lock</span><span class="op" id="1423494">(</span><span class="op" id="1423495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423498">defer</span>&nbsp;<span class="ident" id="1423504">c</span><span class="op" id="1423505">.</span><span class="ident" id="1423506">mu</span><span class="op" id="1423508">.</span><span class="ident" id="1423509">Unlock</span><span class="op" id="1423515">(</span><span class="op" id="1423516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423519">if</span>&nbsp;<span class="ident" id="1423522">c</span><span class="op" id="1423523">.</span><span class="ident" id="1423524">hijackedv</span>&nbsp;<span class="op" id="1423534">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423538">return</span>&nbsp;<span class="ident" id="1423545">nil</span><span class="op" id="1423548">,</span>&nbsp;<span class="ident" id="1423550">nil</span><span class="op" id="1423553">,</span>&nbsp;<span class="ident" id="1423555">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423571">if</span>&nbsp;<span class="ident" id="1423574">c</span><span class="op" id="1423575">.</span><span class="ident" id="1423576">closeNotifyc</span>&nbsp;<span class="op" id="1423589">!=</span>&nbsp;<span class="ident" id="1423592">nil</span>&nbsp;<span class="op" id="1423596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423600">return</span>&nbsp;<span class="ident" id="1423607">nil</span><span class="op" id="1423610">,</span>&nbsp;<span class="ident" id="1423612">nil</span><span class="op" id="1423615">,</span>&nbsp;<span class="ident" id="1423617">errors</span><span class="op" id="1423623">.</span><span class="ident" id="1423624">New</span><span class="op" id="1423627">(</span><span class="string" id="1423628">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="1423684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1423687">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423690">c</span><span class="op" id="1423691">.</span><span class="ident" id="1423692">hijackedv</span>&nbsp;<span class="op" id="1423702">=</span>&nbsp;<span class="builtintype" id="1423704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423710">rwc</span>&nbsp;<span class="op" id="1423714">=</span>&nbsp;<span class="ident" id="1423716">c</span><span class="op" id="1423717">.</span><span class="ident" id="1423718">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423723">buf</span>&nbsp;<span class="op" id="1423727">=</span>&nbsp;<span class="ident" id="1423729">c</span><span class="op" id="1423730">.</span><span class="ident" id="1423731">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423736">c</span><span class="op" id="1423737">.</span><span class="ident" id="1423738">rwc</span>&nbsp;<span class="op" id="1423742">=</span>&nbsp;<span class="ident" id="1423744">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423749">c</span><span class="op" id="1423750">.</span><span class="ident" id="1423751">buf</span>&nbsp;<span class="op" id="1423755">=</span>&nbsp;<span class="ident" id="1423757">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423762">c</span><span class="op" id="1423763">.</span><span class="ident" id="1423764">setState</span><span class="op" id="1423772">(</span><span class="ident" id="1423773">rwc</span><span class="op" id="1423776">,</span>&nbsp;<span class="ident" id="1423778">StateHijacked</span><span class="op" id="1423791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423794">return</span><br>
<span class="lineno"></span><span class="op" id="1423801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1423804">func</span>&nbsp;<span class="op" id="1423809">(</span><span class="ident" id="1423810">c</span>&nbsp;<span class="op" id="1423812">*</span><span class="ident" id="1423813">conn</span><span class="op" id="1423817">)</span>&nbsp;<span class="ident" id="1423819">closeNotify</span><span class="op" id="1423830">(</span><span class="op" id="1423831">)</span>&nbsp;<span class="op" id="1423833">&lt;-</span><span class="keyword" id="1423835">chan</span>&nbsp;<span class="builtintype" id="1423840">bool</span>&nbsp;<span class="op" id="1423845">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423848">c</span><span class="op" id="1423849">.</span><span class="ident" id="1423850">mu</span><span class="op" id="1423852">.</span><span class="ident" id="1423853">Lock</span><span class="op" id="1423857">(</span><span class="op" id="1423858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423861">defer</span>&nbsp;<span class="ident" id="1423867">c</span><span class="op" id="1423868">.</span><span class="ident" id="1423869">mu</span><span class="op" id="1423871">.</span><span class="ident" id="1423872">Unlock</span><span class="op" id="1423878">(</span><span class="op" id="1423879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423882">if</span>&nbsp;<span class="ident" id="1423885">c</span><span class="op" id="1423886">.</span><span class="ident" id="1423887">closeNotifyc</span>&nbsp;<span class="op" id="1423900">==</span>&nbsp;<span class="ident" id="1423903">nil</span>&nbsp;<span class="op" id="1423907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1423911">c</span><span class="op" id="1423912">.</span><span class="ident" id="1423913">closeNotifyc</span>&nbsp;<span class="op" id="1423926">=</span>&nbsp;<span class="builtinfunc" id="1423928">make</span><span class="op" id="1423932">(</span><span class="keyword" id="1423933">chan</span>&nbsp;<span class="builtintype" id="1423938">bool</span><span class="op" id="1423942">,</span>&nbsp;<span class="num" id="1423944">1</span><span class="op" id="1423945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1423949">if</span>&nbsp;<span class="ident" id="1423952">c</span><span class="op" id="1423953">.</span><span class="ident" id="1423954">hijackedv</span>&nbsp;<span class="op" id="1423964">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1423969">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1424019">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424054">return</span>&nbsp;<span class="ident" id="1424061">c</span><span class="op" id="1424062">.</span><span class="ident" id="1424063">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424082">pr</span><span class="op" id="1424084">,</span>&nbsp;<span class="ident" id="1424086">pw</span>&nbsp;<span class="op" id="1424089">:=</span>&nbsp;<span class="ident" id="1424092">io</span><span class="op" id="1424094">.</span><span class="ident" id="1424095">Pipe</span><span class="op" id="1424099">(</span><span class="op" id="1424100">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424105">readSource</span>&nbsp;<span class="op" id="1424116">:=</span>&nbsp;<span class="ident" id="1424119">c</span><span class="op" id="1424120">.</span><span class="ident" id="1424121">sr</span><span class="op" id="1424123">.</span><span class="ident" id="1424124">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424128">c</span><span class="op" id="1424129">.</span><span class="ident" id="1424130">sr</span><span class="op" id="1424132">.</span><span class="ident" id="1424133">Lock</span><span class="op" id="1424137">(</span><span class="op" id="1424138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424142">c</span><span class="op" id="1424143">.</span><span class="ident" id="1424144">sr</span><span class="op" id="1424146">.</span><span class="ident" id="1424147">r</span>&nbsp;<span class="op" id="1424149">=</span>&nbsp;<span class="ident" id="1424151">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424156">c</span><span class="op" id="1424157">.</span><span class="ident" id="1424158">sr</span><span class="op" id="1424160">.</span><span class="ident" id="1424161">Unlock</span><span class="op" id="1424167">(</span><span class="op" id="1424168">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424172">go</span>&nbsp;<span class="keyword" id="1424175">func</span><span class="op" id="1424179">(</span><span class="op" id="1424180">)</span>&nbsp;<span class="op" id="1424182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424187">_</span><span class="op" id="1424188">,</span>&nbsp;<span class="ident" id="1424190">err</span>&nbsp;<span class="op" id="1424194">:=</span>&nbsp;<span class="ident" id="1424197">io</span><span class="op" id="1424199">.</span><span class="ident" id="1424200">Copy</span><span class="op" id="1424204">(</span><span class="ident" id="1424205">pw</span><span class="op" id="1424207">,</span>&nbsp;<span class="ident" id="1424209">readSource</span><span class="op" id="1424219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424224">if</span>&nbsp;<span class="ident" id="1424227">err</span>&nbsp;<span class="op" id="1424231">==</span>&nbsp;<span class="ident" id="1424234">nil</span>&nbsp;<span class="op" id="1424238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424244">err</span>&nbsp;<span class="op" id="1424248">=</span>&nbsp;<span class="ident" id="1424250">io</span><span class="op" id="1424252">.</span><span class="ident" id="1424253">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424260">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424265">pw</span><span class="op" id="1424267">.</span><span class="ident" id="1424268">CloseWithError</span><span class="op" id="1424282">(</span><span class="ident" id="1424283">err</span><span class="op" id="1424286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424291">c</span><span class="op" id="1424292">.</span><span class="ident" id="1424293">noteClientGone</span><span class="op" id="1424307">(</span><span class="op" id="1424308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424312">}</span><span class="op" id="1424313">(</span><span class="op" id="1424314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424320">return</span>&nbsp;<span class="ident" id="1424327">c</span><span class="op" id="1424328">.</span><span class="ident" id="1424329">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="1424342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1424345">func</span>&nbsp;<span class="op" id="1424350">(</span><span class="ident" id="1424351">c</span>&nbsp;<span class="op" id="1424353">*</span><span class="ident" id="1424354">conn</span><span class="op" id="1424358">)</span>&nbsp;<span class="ident" id="1424360">noteClientGone</span><span class="op" id="1424374">(</span><span class="op" id="1424375">)</span>&nbsp;<span class="op" id="1424377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424380">c</span><span class="op" id="1424381">.</span><span class="ident" id="1424382">mu</span><span class="op" id="1424384">.</span><span class="ident" id="1424385">Lock</span><span class="op" id="1424389">(</span><span class="op" id="1424390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424393">defer</span>&nbsp;<span class="ident" id="1424399">c</span><span class="op" id="1424400">.</span><span class="ident" id="1424401">mu</span><span class="op" id="1424403">.</span><span class="ident" id="1424404">Unlock</span><span class="op" id="1424410">(</span><span class="op" id="1424411">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1424414">if</span>&nbsp;<span class="ident" id="1424417">c</span><span class="op" id="1424418">.</span><span class="ident" id="1424419">closeNotifyc</span>&nbsp;<span class="op" id="1424432">!=</span>&nbsp;<span class="ident" id="1424435">nil</span>&nbsp;<span class="op" id="1424439">&amp;&amp;</span>&nbsp;<span class="op" id="1424442">!</span><span class="ident" id="1424443">c</span><span class="op" id="1424444">.</span><span class="ident" id="1424445">clientGone</span>&nbsp;<span class="op" id="1424456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424460">c</span><span class="op" id="1424461">.</span><span class="ident" id="1424462">closeNotifyc</span>&nbsp;<span class="op" id="1424475">&lt;-</span>&nbsp;<span class="builtintype" id="1424478">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1424484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424487">c</span><span class="op" id="1424488">.</span><span class="ident" id="1424489">clientGone</span>&nbsp;<span class="op" id="1424500">=</span>&nbsp;<span class="builtintype" id="1424502">true</span><br>
<span class="lineno"></span><span class="op" id="1424507">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="1424510">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1424568">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="1424620">type</span>&nbsp;<span class="ident" id="1424625">switchReader</span>&nbsp;<span class="keyword" id="1424638">struct</span>&nbsp;<span class="op" id="1424645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424648">io</span><span class="op" id="1424650">.</span><span class="ident" id="1424651">Reader</span><br>
<span class="lineno">195</span><span class="op" id="1424658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1424661">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1424719">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="1424772">type</span>&nbsp;<span class="ident" id="1424777">switchWriter</span>&nbsp;<span class="keyword" id="1424790">struct</span>&nbsp;<span class="op" id="1424797">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424800">io</span><span class="op" id="1424802">.</span><span class="ident" id="1424803">Writer</span><br>
<span class="lineno"></span><span class="op" id="1424810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1424813">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="1424880">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="1424925">type</span>&nbsp;<span class="ident" id="1424930">liveSwitchReader</span>&nbsp;<span class="keyword" id="1424947">struct</span>&nbsp;<span class="op" id="1424954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424957">sync</span><span class="op" id="1424961">.</span><span class="ident" id="1424962">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1424969">r</span>&nbsp;<span class="ident" id="1424971">io</span><span class="op" id="1424973">.</span><span class="ident" id="1424974">Reader</span><br>
<span class="lineno"></span><span class="op" id="1424981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="1424984">func</span>&nbsp;<span class="op" id="1424989">(</span><span class="ident" id="1424990">sr</span>&nbsp;<span class="op" id="1424993">*</span><span class="ident" id="1424994">liveSwitchReader</span><span class="op" id="1425010">)</span>&nbsp;<span class="ident" id="1425012">Read</span><span class="op" id="1425016">(</span><span class="ident" id="1425017">p</span>&nbsp;<span class="op" id="1425019">[</span><span class="op" id="1425020">]</span><span class="builtintype" id="1425021">byte</span><span class="op" id="1425025">)</span>&nbsp;<span class="op" id="1425027">(</span><span class="ident" id="1425028">n</span>&nbsp;<span class="builtintype" id="1425030">int</span><span class="op" id="1425033">,</span>&nbsp;<span class="ident" id="1425035">err</span>&nbsp;<span class="builtintype" id="1425039">error</span><span class="op" id="1425044">)</span>&nbsp;<span class="op" id="1425046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425049">sr</span><span class="op" id="1425051">.</span><span class="ident" id="1425052">Lock</span><span class="op" id="1425056">(</span><span class="op" id="1425057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425060">r</span>&nbsp;<span class="op" id="1425062">:=</span>&nbsp;<span class="ident" id="1425065">sr</span><span class="op" id="1425067">.</span><span class="ident" id="1425068">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425071">sr</span><span class="op" id="1425073">.</span><span class="ident" id="1425074">Unlock</span><span class="op" id="1425080">(</span><span class="op" id="1425081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1425084">return</span>&nbsp;<span class="ident" id="1425091">r</span><span class="op" id="1425092">.</span><span class="ident" id="1425093">Read</span><span class="op" id="1425097">(</span><span class="ident" id="1425098">p</span><span class="op" id="1425099">)</span><br>
<span class="lineno">215</span><span class="op" id="1425101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1425104">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="1425158">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="1425200">const</span>&nbsp;<span class="ident" id="1425206">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="1425231">=</span>&nbsp;<span class="num" id="1425233">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="1425239">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="1425308">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="1425357">//</span><br>
<span class="lineno"></span><span class="comment" id="1425360">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="1425432">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="1425503">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="1425575">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="1425649">//</span><br>
<span class="lineno"></span><span class="comment" id="1425652">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="1425722">type</span>&nbsp;<span class="ident" id="1425727">chunkWriter</span>&nbsp;<span class="keyword" id="1425739">struct</span>&nbsp;<span class="op" id="1425746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425749">res</span>&nbsp;<span class="op" id="1425753">*</span><span class="ident" id="1425754">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1425765">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1425827">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1425885">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1425943">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1425983">header</span>&nbsp;<span class="ident" id="1425990">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1425999">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1426063">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1426113">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1426174">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426197">wroteHeader</span>&nbsp;<span class="builtintype" id="1426209">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1426216">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426251">chunking</span>&nbsp;<span class="builtintype" id="1426260">bool</span>&nbsp;<span class="comment" id="1426265">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="1426315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1426318">var</span>&nbsp;<span class="op" id="1426322">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426325">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1426336">=</span>&nbsp;<span class="op" id="1426338">[</span><span class="op" id="1426339">]</span><span class="builtintype" id="1426340">byte</span><span class="op" id="1426344">(</span><span class="string" id="1426345">&#34;\r\n&#34;</span><span class="op" id="1426351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426354">colonSpace</span>&nbsp;<span class="op" id="1426365">=</span>&nbsp;<span class="op" id="1426367">[</span><span class="op" id="1426368">]</span><span class="builtintype" id="1426369">byte</span><span class="op" id="1426373">(</span><span class="string" id="1426374">&#34;:&nbsp;&#34;</span><span class="op" id="1426378">)</span><br>
<span class="lineno"></span><span class="op" id="1426380">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1426383">func</span>&nbsp;<span class="op" id="1426388">(</span><span class="ident" id="1426389">cw</span>&nbsp;<span class="op" id="1426392">*</span><span class="ident" id="1426393">chunkWriter</span><span class="op" id="1426404">)</span>&nbsp;<span class="ident" id="1426406">Write</span><span class="op" id="1426411">(</span><span class="ident" id="1426412">p</span>&nbsp;<span class="op" id="1426414">[</span><span class="op" id="1426415">]</span><span class="builtintype" id="1426416">byte</span><span class="op" id="1426420">)</span>&nbsp;<span class="op" id="1426422">(</span><span class="ident" id="1426423">n</span>&nbsp;<span class="builtintype" id="1426425">int</span><span class="op" id="1426428">,</span>&nbsp;<span class="ident" id="1426430">err</span>&nbsp;<span class="builtintype" id="1426434">error</span><span class="op" id="1426439">)</span>&nbsp;<span class="op" id="1426441">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426444">if</span>&nbsp;<span class="op" id="1426447">!</span><span class="ident" id="1426448">cw</span><span class="op" id="1426450">.</span><span class="ident" id="1426451">wroteHeader</span>&nbsp;<span class="op" id="1426463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426467">cw</span><span class="op" id="1426469">.</span><span class="ident" id="1426470">writeHeader</span><span class="op" id="1426481">(</span><span class="ident" id="1426482">p</span><span class="op" id="1426483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426489">if</span>&nbsp;<span class="ident" id="1426492">cw</span><span class="op" id="1426494">.</span><span class="ident" id="1426495">res</span><span class="op" id="1426498">.</span><span class="ident" id="1426499">req</span><span class="op" id="1426502">.</span><span class="ident" id="1426503">Method</span>&nbsp;<span class="op" id="1426510">==</span>&nbsp;<span class="string" id="1426513">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1426520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1426524">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426541">return</span>&nbsp;<span class="builtinfunc" id="1426548">len</span><span class="op" id="1426551">(</span><span class="ident" id="1426552">p</span><span class="op" id="1426553">)</span><span class="op" id="1426554">,</span>&nbsp;<span class="ident" id="1426556">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426564">if</span>&nbsp;<span class="ident" id="1426567">cw</span><span class="op" id="1426569">.</span><span class="ident" id="1426570">chunking</span>&nbsp;<span class="op" id="1426579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426583">_</span><span class="op" id="1426584">,</span>&nbsp;<span class="ident" id="1426586">err</span>&nbsp;<span class="op" id="1426590">=</span>&nbsp;<span class="ident" id="1426592">fmt</span><span class="op" id="1426595">.</span><span class="ident" id="1426596">Fprintf</span><span class="op" id="1426603">(</span><span class="ident" id="1426604">cw</span><span class="op" id="1426606">.</span><span class="ident" id="1426607">res</span><span class="op" id="1426610">.</span><span class="ident" id="1426611">conn</span><span class="op" id="1426615">.</span><span class="ident" id="1426616">buf</span><span class="op" id="1426619">,</span>&nbsp;<span class="string" id="1426621">&#34;%x\r\n&#34;</span><span class="op" id="1426629">,</span>&nbsp;<span class="builtinfunc" id="1426631">len</span><span class="op" id="1426634">(</span><span class="ident" id="1426635">p</span><span class="op" id="1426636">)</span><span class="op" id="1426637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426641">if</span>&nbsp;<span class="ident" id="1426644">err</span>&nbsp;<span class="op" id="1426648">!=</span>&nbsp;<span class="ident" id="1426651">nil</span>&nbsp;<span class="op" id="1426655">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426660">cw</span><span class="op" id="1426662">.</span><span class="ident" id="1426663">res</span><span class="op" id="1426666">.</span><span class="ident" id="1426667">conn</span><span class="op" id="1426671">.</span><span class="ident" id="1426672">rwc</span><span class="op" id="1426675">.</span><span class="ident" id="1426676">Close</span><span class="op" id="1426681">(</span><span class="op" id="1426682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426687">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426702">n</span><span class="op" id="1426703">,</span>&nbsp;<span class="ident" id="1426705">err</span>&nbsp;<span class="op" id="1426709">=</span>&nbsp;<span class="ident" id="1426711">cw</span><span class="op" id="1426713">.</span><span class="ident" id="1426714">res</span><span class="op" id="1426717">.</span><span class="ident" id="1426718">conn</span><span class="op" id="1426722">.</span><span class="ident" id="1426723">buf</span><span class="op" id="1426726">.</span><span class="ident" id="1426727">Write</span><span class="op" id="1426732">(</span><span class="ident" id="1426733">p</span><span class="op" id="1426734">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426737">if</span>&nbsp;<span class="ident" id="1426740">cw</span><span class="op" id="1426742">.</span><span class="ident" id="1426743">chunking</span>&nbsp;<span class="op" id="1426752">&amp;&amp;</span>&nbsp;<span class="ident" id="1426755">err</span>&nbsp;<span class="op" id="1426759">==</span>&nbsp;<span class="ident" id="1426762">nil</span>&nbsp;<span class="op" id="1426766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426770">_</span><span class="op" id="1426771">,</span>&nbsp;<span class="ident" id="1426773">err</span>&nbsp;<span class="op" id="1426777">=</span>&nbsp;<span class="ident" id="1426779">cw</span><span class="op" id="1426781">.</span><span class="ident" id="1426782">res</span><span class="op" id="1426785">.</span><span class="ident" id="1426786">conn</span><span class="op" id="1426790">.</span><span class="ident" id="1426791">buf</span><span class="op" id="1426794">.</span><span class="ident" id="1426795">Write</span><span class="op" id="1426800">(</span><span class="ident" id="1426801">crlf</span><span class="op" id="1426805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426811">if</span>&nbsp;<span class="ident" id="1426814">err</span>&nbsp;<span class="op" id="1426818">!=</span>&nbsp;<span class="ident" id="1426821">nil</span>&nbsp;<span class="op" id="1426825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426829">cw</span><span class="op" id="1426831">.</span><span class="ident" id="1426832">res</span><span class="op" id="1426835">.</span><span class="ident" id="1426836">conn</span><span class="op" id="1426840">.</span><span class="ident" id="1426841">rwc</span><span class="op" id="1426844">.</span><span class="ident" id="1426845">Close</span><span class="op" id="1426850">(</span><span class="op" id="1426851">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426857">return</span><br>
<span class="lineno"></span><span class="op" id="1426864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1426867">func</span>&nbsp;<span class="op" id="1426872">(</span><span class="ident" id="1426873">cw</span>&nbsp;<span class="op" id="1426876">*</span><span class="ident" id="1426877">chunkWriter</span><span class="op" id="1426888">)</span>&nbsp;<span class="ident" id="1426890">flush</span><span class="op" id="1426895">(</span><span class="op" id="1426896">)</span>&nbsp;<span class="op" id="1426898">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1426901">if</span>&nbsp;<span class="op" id="1426904">!</span><span class="ident" id="1426905">cw</span><span class="op" id="1426907">.</span><span class="ident" id="1426908">wroteHeader</span>&nbsp;<span class="op" id="1426920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426924">cw</span><span class="op" id="1426926">.</span><span class="ident" id="1426927">writeHeader</span><span class="op" id="1426938">(</span><span class="ident" id="1426939">nil</span><span class="op" id="1426942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1426945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1426948">cw</span><span class="op" id="1426950">.</span><span class="ident" id="1426951">res</span><span class="op" id="1426954">.</span><span class="ident" id="1426955">conn</span><span class="op" id="1426959">.</span><span class="ident" id="1426960">buf</span><span class="op" id="1426963">.</span><span class="ident" id="1426964">Flush</span><span class="op" id="1426969">(</span><span class="op" id="1426970">)</span><br>
<span class="lineno"></span><span class="op" id="1426972">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="1426975">func</span>&nbsp;<span class="op" id="1426980">(</span><span class="ident" id="1426981">cw</span>&nbsp;<span class="op" id="1426984">*</span><span class="ident" id="1426985">chunkWriter</span><span class="op" id="1426996">)</span>&nbsp;<span class="builtinfunc" id="1426998">close</span><span class="op" id="1427003">(</span><span class="op" id="1427004">)</span>&nbsp;<span class="op" id="1427006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427009">if</span>&nbsp;<span class="op" id="1427012">!</span><span class="ident" id="1427013">cw</span><span class="op" id="1427015">.</span><span class="ident" id="1427016">wroteHeader</span>&nbsp;<span class="op" id="1427028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427032">cw</span><span class="op" id="1427034">.</span><span class="ident" id="1427035">writeHeader</span><span class="op" id="1427046">(</span><span class="ident" id="1427047">nil</span><span class="op" id="1427050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427053">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1427056">if</span>&nbsp;<span class="ident" id="1427059">cw</span><span class="op" id="1427061">.</span><span class="ident" id="1427062">chunking</span>&nbsp;<span class="op" id="1427071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427075">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427131">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427185">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427196">cw</span><span class="op" id="1427198">.</span><span class="ident" id="1427199">res</span><span class="op" id="1427202">.</span><span class="ident" id="1427203">conn</span><span class="op" id="1427207">.</span><span class="ident" id="1427208">buf</span><span class="op" id="1427211">.</span><span class="ident" id="1427212">WriteString</span><span class="op" id="1427223">(</span><span class="string" id="1427224">&#34;0\r\n\r\n&#34;</span><span class="op" id="1427235">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1427238">}</span><br>
<span class="lineno"></span><span class="op" id="1427240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1427243">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="1427305">type</span>&nbsp;<span class="ident" id="1427310">response</span>&nbsp;<span class="keyword" id="1427319">struct</span>&nbsp;<span class="op" id="1427326">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427329">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427343">*</span><span class="ident" id="1427344">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427350">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427364">*</span><span class="ident" id="1427365">Request</span>&nbsp;<span class="comment" id="1427373">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427403">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1427417">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1427426">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427472">wroteContinue</span>&nbsp;<span class="builtintype" id="1427486">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1427495">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427534">w</span>&nbsp;&nbsp;<span class="op" id="1427537">*</span><span class="ident" id="1427538">bufio</span><span class="op" id="1427543">.</span><span class="ident" id="1427544">Writer</span>&nbsp;<span class="comment" id="1427551">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427595">cw</span>&nbsp;<span class="ident" id="1427598">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427611">sw</span>&nbsp;<span class="op" id="1427614">*</span><span class="ident" id="1427615">switchWriter</span>&nbsp;<span class="comment" id="1427628">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427683">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427744">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427806">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1427864">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427908">handlerHeader</span>&nbsp;<span class="ident" id="1427922">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427930">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="1427944">bool</span>&nbsp;<span class="comment" id="1427949">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1427996">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428010">int64</span>&nbsp;<span class="comment" id="1428016">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428052">contentLength</span>&nbsp;<span class="ident" id="1428066">int64</span>&nbsp;<span class="comment" id="1428072">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428118">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1428132">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1428138">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428177">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428236">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428289">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428340">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428360">closeAfterReply</span>&nbsp;<span class="builtintype" id="1428376">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428383">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428438">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428493">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428544">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428606">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428662">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428722">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428741">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="1428761">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428768">handlerDone</span>&nbsp;<span class="builtintype" id="1428780">bool</span>&nbsp;<span class="comment" id="1428785">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1428822">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428862">dateBuf</span>&nbsp;<span class="op" id="1428870">[</span><span class="builtinfunc" id="1428871">len</span><span class="op" id="1428874">(</span><span class="ident" id="1428875">TimeFormat</span><span class="op" id="1428885">)</span><span class="op" id="1428886">]</span><span class="builtintype" id="1428887">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1428893">clenBuf</span>&nbsp;<span class="op" id="1428901">[</span><span class="num" id="1428902">10</span><span class="op" id="1428904">]</span><span class="builtintype" id="1428905">byte</span><br>
<span class="lineno">340</span><span class="op" id="1428910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1428913">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="1428984">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="1429014">func</span>&nbsp;<span class="op" id="1429019">(</span><span class="ident" id="1429020">w</span>&nbsp;<span class="op" id="1429022">*</span><span class="ident" id="1429023">response</span><span class="op" id="1429031">)</span>&nbsp;<span class="ident" id="1429033">requestTooLarge</span><span class="op" id="1429048">(</span><span class="op" id="1429049">)</span>&nbsp;<span class="op" id="1429051">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1429054">w</span><span class="op" id="1429055">.</span><span class="ident" id="1429056">closeAfterReply</span>&nbsp;<span class="op" id="1429072">=</span>&nbsp;<span class="builtintype" id="1429074">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1429080">w</span><span class="op" id="1429081">.</span><span class="ident" id="1429082">requestBodyLimitHit</span>&nbsp;<span class="op" id="1429102">=</span>&nbsp;<span class="builtintype" id="1429104">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429110">if</span>&nbsp;<span class="op" id="1429113">!</span><span class="ident" id="1429114">w</span><span class="op" id="1429115">.</span><span class="ident" id="1429116">wroteHeader</span>&nbsp;<span class="op" id="1429128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1429132">w</span><span class="op" id="1429133">.</span><span class="ident" id="1429134">Header</span><span class="op" id="1429140">(</span><span class="op" id="1429141">)</span><span class="op" id="1429142">.</span><span class="ident" id="1429143">Set</span><span class="op" id="1429146">(</span><span class="string" id="1429147">&#34;Connection&#34;</span><span class="op" id="1429159">,</span>&nbsp;<span class="string" id="1429161">&#34;close&#34;</span><span class="op" id="1429168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1429171">}</span><br>
<span class="lineno">350</span><span class="op" id="1429173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1429176">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="1429248">func</span>&nbsp;<span class="op" id="1429253">(</span><span class="ident" id="1429254">w</span>&nbsp;<span class="op" id="1429256">*</span><span class="ident" id="1429257">response</span><span class="op" id="1429265">)</span>&nbsp;<span class="ident" id="1429267">needsSniff</span><span class="op" id="1429277">(</span><span class="op" id="1429278">)</span>&nbsp;<span class="builtintype" id="1429280">bool</span>&nbsp;<span class="op" id="1429285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1429288">_</span><span class="op" id="1429289">,</span>&nbsp;<span class="ident" id="1429291">haveType</span>&nbsp;<span class="op" id="1429300">:=</span>&nbsp;<span class="ident" id="1429303">w</span><span class="op" id="1429304">.</span><span class="ident" id="1429305">handlerHeader</span><span class="op" id="1429318">[</span><span class="string" id="1429319">&#34;Content-Type&#34;</span><span class="op" id="1429333">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429336">return</span>&nbsp;<span class="op" id="1429343">!</span><span class="ident" id="1429344">w</span><span class="op" id="1429345">.</span><span class="ident" id="1429346">cw</span><span class="op" id="1429348">.</span><span class="ident" id="1429349">wroteHeader</span>&nbsp;<span class="op" id="1429361">&amp;&amp;</span>&nbsp;<span class="op" id="1429364">!</span><span class="ident" id="1429365">haveType</span>&nbsp;<span class="op" id="1429374">&amp;&amp;</span>&nbsp;<span class="ident" id="1429377">w</span><span class="op" id="1429378">.</span><span class="ident" id="1429379">written</span>&nbsp;<span class="op" id="1429387">&lt;</span>&nbsp;<span class="ident" id="1429389">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="1429398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1429401">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="1429467">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="1429484">type</span>&nbsp;<span class="ident" id="1429489">writerOnly</span>&nbsp;<span class="keyword" id="1429500">struct</span>&nbsp;<span class="op" id="1429507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1429510">io</span><span class="op" id="1429512">.</span><span class="ident" id="1429513">Writer</span><br>
<span class="lineno"></span><span class="op" id="1429520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1429523">func</span>&nbsp;<span class="ident" id="1429528">srcIsRegularFile</span><span class="op" id="1429544">(</span><span class="ident" id="1429545">src</span>&nbsp;<span class="ident" id="1429549">io</span><span class="op" id="1429551">.</span><span class="ident" id="1429552">Reader</span><span class="op" id="1429558">)</span>&nbsp;<span class="op" id="1429560">(</span><span class="ident" id="1429561">isRegular</span>&nbsp;<span class="builtintype" id="1429571">bool</span><span class="op" id="1429575">,</span>&nbsp;<span class="ident" id="1429577">err</span>&nbsp;<span class="builtintype" id="1429581">error</span><span class="op" id="1429586">)</span>&nbsp;<span class="op" id="1429588">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429591">switch</span>&nbsp;<span class="ident" id="1429598">v</span>&nbsp;<span class="op" id="1429600">:=</span>&nbsp;<span class="ident" id="1429603">src</span><span class="op" id="1429606">.</span><span class="op" id="1429607">(</span><span class="keyword" id="1429608">type</span><span class="op" id="1429612">)</span>&nbsp;<span class="op" id="1429614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429617">case</span>&nbsp;<span class="op" id="1429622">*</span><span class="ident" id="1429623">os</span><span class="op" id="1429625">.</span><span class="ident" id="1429626">File</span><span class="op" id="1429630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1429634">fi</span><span class="op" id="1429636">,</span>&nbsp;<span class="ident" id="1429638">err</span>&nbsp;<span class="op" id="1429642">:=</span>&nbsp;<span class="ident" id="1429645">v</span><span class="op" id="1429646">.</span><span class="ident" id="1429647">Stat</span><span class="op" id="1429651">(</span><span class="op" id="1429652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429656">if</span>&nbsp;<span class="ident" id="1429659">err</span>&nbsp;<span class="op" id="1429663">!=</span>&nbsp;<span class="ident" id="1429666">nil</span>&nbsp;<span class="op" id="1429670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429675">return</span>&nbsp;<span class="builtintype" id="1429682">false</span><span class="op" id="1429687">,</span>&nbsp;<span class="ident" id="1429689">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1429695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429699">return</span>&nbsp;<span class="ident" id="1429706">fi</span><span class="op" id="1429708">.</span><span class="ident" id="1429709">Mode</span><span class="op" id="1429713">(</span><span class="op" id="1429714">)</span><span class="op" id="1429715">.</span><span class="ident" id="1429716">IsRegular</span><span class="op" id="1429725">(</span><span class="op" id="1429726">)</span><span class="op" id="1429727">,</span>&nbsp;<span class="ident" id="1429729">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429734">case</span>&nbsp;<span class="op" id="1429739">*</span><span class="ident" id="1429740">io</span><span class="op" id="1429742">.</span><span class="ident" id="1429743">LimitedReader</span><span class="op" id="1429756">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429760">return</span>&nbsp;<span class="ident" id="1429767">srcIsRegularFile</span><span class="op" id="1429783">(</span><span class="ident" id="1429784">v</span><span class="op" id="1429785">.</span><span class="ident" id="1429786">R</span><span class="op" id="1429787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429790">default</span><span class="op" id="1429797">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1429801">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1429809">}</span><br>
<span class="lineno"></span><span class="op" id="1429811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1429814">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="1429884">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="1429920">func</span>&nbsp;<span class="op" id="1429925">(</span><span class="ident" id="1429926">w</span>&nbsp;<span class="op" id="1429928">*</span><span class="ident" id="1429929">response</span><span class="op" id="1429937">)</span>&nbsp;<span class="ident" id="1429939">ReadFrom</span><span class="op" id="1429947">(</span><span class="ident" id="1429948">src</span>&nbsp;<span class="ident" id="1429952">io</span><span class="op" id="1429954">.</span><span class="ident" id="1429955">Reader</span><span class="op" id="1429961">)</span>&nbsp;<span class="op" id="1429963">(</span><span class="ident" id="1429964">n</span>&nbsp;<span class="ident" id="1429966">int64</span><span class="op" id="1429971">,</span>&nbsp;<span class="ident" id="1429973">err</span>&nbsp;<span class="builtintype" id="1429977">error</span><span class="op" id="1429982">)</span>&nbsp;<span class="op" id="1429984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1429987">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1430049">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1430113">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430165">rf</span><span class="op" id="1430167">,</span>&nbsp;<span class="ident" id="1430169">ok</span>&nbsp;<span class="op" id="1430172">:=</span>&nbsp;<span class="ident" id="1430175">w</span><span class="op" id="1430176">.</span><span class="ident" id="1430177">conn</span><span class="op" id="1430181">.</span><span class="ident" id="1430182">rwc</span><span class="op" id="1430185">.</span><span class="op" id="1430186">(</span><span class="ident" id="1430187">io</span><span class="op" id="1430189">.</span><span class="ident" id="1430190">ReaderFrom</span><span class="op" id="1430200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430203">regFile</span><span class="op" id="1430210">,</span>&nbsp;<span class="ident" id="1430212">err</span>&nbsp;<span class="op" id="1430216">:=</span>&nbsp;<span class="ident" id="1430219">srcIsRegularFile</span><span class="op" id="1430235">(</span><span class="ident" id="1430236">src</span><span class="op" id="1430239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430242">if</span>&nbsp;<span class="ident" id="1430245">err</span>&nbsp;<span class="op" id="1430249">!=</span>&nbsp;<span class="ident" id="1430252">nil</span>&nbsp;<span class="op" id="1430256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430260">return</span>&nbsp;<span class="num" id="1430267">0</span><span class="op" id="1430268">,</span>&nbsp;<span class="ident" id="1430270">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1430275">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430278">if</span>&nbsp;<span class="op" id="1430281">!</span><span class="ident" id="1430282">ok</span>&nbsp;<span class="op" id="1430285">||</span>&nbsp;<span class="op" id="1430288">!</span><span class="ident" id="1430289">regFile</span>&nbsp;<span class="op" id="1430297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430301">return</span>&nbsp;<span class="ident" id="1430308">io</span><span class="op" id="1430310">.</span><span class="ident" id="1430311">Copy</span><span class="op" id="1430315">(</span><span class="ident" id="1430316">writerOnly</span><span class="op" id="1430326">{</span><span class="ident" id="1430327">w</span><span class="op" id="1430328">}</span><span class="op" id="1430329">,</span>&nbsp;<span class="ident" id="1430331">src</span><span class="op" id="1430334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1430337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1430341">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430361">if</span>&nbsp;<span class="op" id="1430364">!</span><span class="ident" id="1430365">w</span><span class="op" id="1430366">.</span><span class="ident" id="1430367">wroteHeader</span>&nbsp;<span class="op" id="1430379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430383">w</span><span class="op" id="1430384">.</span><span class="ident" id="1430385">WriteHeader</span><span class="op" id="1430396">(</span><span class="ident" id="1430397">StatusOK</span><span class="op" id="1430405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1430408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430412">if</span>&nbsp;<span class="ident" id="1430415">w</span><span class="op" id="1430416">.</span><span class="ident" id="1430417">needsSniff</span><span class="op" id="1430427">(</span><span class="op" id="1430428">)</span>&nbsp;<span class="op" id="1430430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430434">n0</span><span class="op" id="1430436">,</span>&nbsp;<span class="ident" id="1430438">err</span>&nbsp;<span class="op" id="1430442">:=</span>&nbsp;<span class="ident" id="1430445">io</span><span class="op" id="1430447">.</span><span class="ident" id="1430448">Copy</span><span class="op" id="1430452">(</span><span class="ident" id="1430453">writerOnly</span><span class="op" id="1430463">{</span><span class="ident" id="1430464">w</span><span class="op" id="1430465">}</span><span class="op" id="1430466">,</span>&nbsp;<span class="ident" id="1430468">io</span><span class="op" id="1430470">.</span><span class="ident" id="1430471">LimitReader</span><span class="op" id="1430482">(</span><span class="ident" id="1430483">src</span><span class="op" id="1430486">,</span>&nbsp;<span class="ident" id="1430488">sniffLen</span><span class="op" id="1430496">)</span><span class="op" id="1430497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430501">n</span>&nbsp;<span class="op" id="1430503">+=</span>&nbsp;<span class="ident" id="1430506">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430511">if</span>&nbsp;<span class="ident" id="1430514">err</span>&nbsp;<span class="op" id="1430518">!=</span>&nbsp;<span class="ident" id="1430521">nil</span>&nbsp;<span class="op" id="1430525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430530">return</span>&nbsp;<span class="ident" id="1430537">n</span><span class="op" id="1430538">,</span>&nbsp;<span class="ident" id="1430540">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1430546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1430549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430553">w</span><span class="op" id="1430554">.</span><span class="ident" id="1430555">w</span><span class="op" id="1430556">.</span><span class="ident" id="1430557">Flush</span><span class="op" id="1430562">(</span><span class="op" id="1430563">)</span>&nbsp;&nbsp;<span class="comment" id="1430566">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430601">w</span><span class="op" id="1430602">.</span><span class="ident" id="1430603">cw</span><span class="op" id="1430605">.</span><span class="ident" id="1430606">flush</span><span class="op" id="1430611">(</span><span class="op" id="1430612">)</span>&nbsp;<span class="comment" id="1430614">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1430666">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430746">if</span>&nbsp;<span class="op" id="1430749">!</span><span class="ident" id="1430750">w</span><span class="op" id="1430751">.</span><span class="ident" id="1430752">cw</span><span class="op" id="1430754">.</span><span class="ident" id="1430755">chunking</span>&nbsp;<span class="op" id="1430764">&amp;&amp;</span>&nbsp;<span class="ident" id="1430767">w</span><span class="op" id="1430768">.</span><span class="ident" id="1430769">bodyAllowed</span><span class="op" id="1430780">(</span><span class="op" id="1430781">)</span>&nbsp;<span class="op" id="1430783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430787">n0</span><span class="op" id="1430789">,</span>&nbsp;<span class="ident" id="1430791">err</span>&nbsp;<span class="op" id="1430795">:=</span>&nbsp;<span class="ident" id="1430798">rf</span><span class="op" id="1430800">.</span><span class="ident" id="1430801">ReadFrom</span><span class="op" id="1430809">(</span><span class="ident" id="1430810">src</span><span class="op" id="1430813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430817">n</span>&nbsp;<span class="op" id="1430819">+=</span>&nbsp;<span class="ident" id="1430822">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430827">w</span><span class="op" id="1430828">.</span><span class="ident" id="1430829">written</span>&nbsp;<span class="op" id="1430837">+=</span>&nbsp;<span class="ident" id="1430840">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430845">return</span>&nbsp;<span class="ident" id="1430852">n</span><span class="op" id="1430853">,</span>&nbsp;<span class="ident" id="1430855">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1430860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430864">n0</span><span class="op" id="1430866">,</span>&nbsp;<span class="ident" id="1430868">err</span>&nbsp;<span class="op" id="1430872">:=</span>&nbsp;<span class="ident" id="1430875">io</span><span class="op" id="1430877">.</span><span class="ident" id="1430878">Copy</span><span class="op" id="1430882">(</span><span class="ident" id="1430883">writerOnly</span><span class="op" id="1430893">{</span><span class="ident" id="1430894">w</span><span class="op" id="1430895">}</span><span class="op" id="1430896">,</span>&nbsp;<span class="ident" id="1430898">src</span><span class="op" id="1430901">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1430904">n</span>&nbsp;<span class="op" id="1430906">+=</span>&nbsp;<span class="ident" id="1430909">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1430913">return</span>&nbsp;<span class="ident" id="1430920">n</span><span class="op" id="1430921">,</span>&nbsp;<span class="ident" id="1430923">err</span><br>
<span class="lineno"></span><span class="op" id="1430927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1430930">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="1430999">const</span>&nbsp;<span class="ident" id="1431005">noLimit</span>&nbsp;<span class="ident" id="1431013">int64</span>&nbsp;<span class="op" id="1431019">=</span>&nbsp;<span class="op" id="1431021">(</span><span class="num" id="1431022">1</span>&nbsp;<span class="op" id="1431024">&lt;&lt;</span>&nbsp;<span class="num" id="1431027">63</span><span class="op" id="1431029">)</span>&nbsp;<span class="op" id="1431031">-</span>&nbsp;<span class="num" id="1431033">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1431036">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="1431114">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="1431149">const</span>&nbsp;<span class="ident" id="1431155">debugServerConnections</span>&nbsp;<span class="op" id="1431178">=</span>&nbsp;<span class="builtintype" id="1431180">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="1431187">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="1431222">func</span>&nbsp;<span class="op" id="1431227">(</span><span class="ident" id="1431228">srv</span>&nbsp;<span class="op" id="1431232">*</span><span class="ident" id="1431233">Server</span><span class="op" id="1431239">)</span>&nbsp;<span class="ident" id="1431241">newConn</span><span class="op" id="1431248">(</span><span class="ident" id="1431249">rwc</span>&nbsp;<span class="ident" id="1431253">net</span><span class="op" id="1431256">.</span><span class="ident" id="1431257">Conn</span><span class="op" id="1431261">)</span>&nbsp;<span class="op" id="1431263">(</span><span class="ident" id="1431264">c</span>&nbsp;<span class="op" id="1431266">*</span><span class="ident" id="1431267">conn</span><span class="op" id="1431271">,</span>&nbsp;<span class="ident" id="1431273">err</span>&nbsp;<span class="builtintype" id="1431277">error</span><span class="op" id="1431282">)</span>&nbsp;<span class="op" id="1431284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431287">c</span>&nbsp;<span class="op" id="1431289">=</span>&nbsp;<span class="builtinfunc" id="1431291">new</span><span class="op" id="1431294">(</span><span class="ident" id="1431295">conn</span><span class="op" id="1431299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431302">c</span><span class="op" id="1431303">.</span><span class="ident" id="1431304">remoteAddr</span>&nbsp;<span class="op" id="1431315">=</span>&nbsp;<span class="ident" id="1431317">rwc</span><span class="op" id="1431320">.</span><span class="ident" id="1431321">RemoteAddr</span><span class="op" id="1431331">(</span><span class="op" id="1431332">)</span><span class="op" id="1431333">.</span><span class="ident" id="1431334">String</span><span class="op" id="1431340">(</span><span class="op" id="1431341">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431344">c</span><span class="op" id="1431345">.</span><span class="ident" id="1431346">server</span>&nbsp;<span class="op" id="1431353">=</span>&nbsp;<span class="ident" id="1431355">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431360">c</span><span class="op" id="1431361">.</span><span class="ident" id="1431362">rwc</span>&nbsp;<span class="op" id="1431366">=</span>&nbsp;<span class="ident" id="1431368">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431373">c</span><span class="op" id="1431374">.</span><span class="ident" id="1431375">w</span>&nbsp;<span class="op" id="1431377">=</span>&nbsp;<span class="ident" id="1431379">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431384">if</span>&nbsp;<span class="ident" id="1431387">debugServerConnections</span>&nbsp;<span class="op" id="1431410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431414">c</span><span class="op" id="1431415">.</span><span class="ident" id="1431416">rwc</span>&nbsp;<span class="op" id="1431420">=</span>&nbsp;<span class="ident" id="1431422">newLoggingConn</span><span class="op" id="1431436">(</span><span class="string" id="1431437">&#34;server&#34;</span><span class="op" id="1431445">,</span>&nbsp;<span class="ident" id="1431447">c</span><span class="op" id="1431448">.</span><span class="ident" id="1431449">rwc</span><span class="op" id="1431452">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431458">c</span><span class="op" id="1431459">.</span><span class="ident" id="1431460">sr</span>&nbsp;<span class="op" id="1431463">=</span>&nbsp;<span class="ident" id="1431465">liveSwitchReader</span><span class="op" id="1431481">{</span><span class="ident" id="1431482">r</span><span class="op" id="1431483">:</span>&nbsp;<span class="ident" id="1431485">c</span><span class="op" id="1431486">.</span><span class="ident" id="1431487">rwc</span><span class="op" id="1431490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431493">c</span><span class="op" id="1431494">.</span><span class="ident" id="1431495">lr</span>&nbsp;<span class="op" id="1431498">=</span>&nbsp;<span class="ident" id="1431500">io</span><span class="op" id="1431502">.</span><span class="ident" id="1431503">LimitReader</span><span class="op" id="1431514">(</span><span class="op" id="1431515">&amp;</span><span class="ident" id="1431516">c</span><span class="op" id="1431517">.</span><span class="ident" id="1431518">sr</span><span class="op" id="1431520">,</span>&nbsp;<span class="ident" id="1431522">noLimit</span><span class="op" id="1431529">)</span><span class="op" id="1431530">.</span><span class="op" id="1431531">(</span><span class="op" id="1431532">*</span><span class="ident" id="1431533">io</span><span class="op" id="1431535">.</span><span class="ident" id="1431536">LimitedReader</span><span class="op" id="1431549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431552">br</span>&nbsp;<span class="op" id="1431555">:=</span>&nbsp;<span class="ident" id="1431558">newBufioReader</span><span class="op" id="1431572">(</span><span class="ident" id="1431573">c</span><span class="op" id="1431574">.</span><span class="ident" id="1431575">lr</span><span class="op" id="1431577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431580">bw</span>&nbsp;<span class="op" id="1431583">:=</span>&nbsp;<span class="ident" id="1431586">newBufioWriterSize</span><span class="op" id="1431604">(</span><span class="ident" id="1431605">checkConnErrorWriter</span><span class="op" id="1431625">{</span><span class="ident" id="1431626">c</span><span class="op" id="1431627">}</span><span class="op" id="1431628">,</span>&nbsp;<span class="num" id="1431630">4</span><span class="op" id="1431631">&lt;&lt;</span><span class="num" id="1431633">10</span><span class="op" id="1431635">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431638">c</span><span class="op" id="1431639">.</span><span class="ident" id="1431640">buf</span>&nbsp;<span class="op" id="1431644">=</span>&nbsp;<span class="ident" id="1431646">bufio</span><span class="op" id="1431651">.</span><span class="ident" id="1431652">NewReadWriter</span><span class="op" id="1431665">(</span><span class="ident" id="1431666">br</span><span class="op" id="1431668">,</span>&nbsp;<span class="ident" id="1431670">bw</span><span class="op" id="1431672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431675">return</span>&nbsp;<span class="ident" id="1431682">c</span><span class="op" id="1431683">,</span>&nbsp;<span class="ident" id="1431685">nil</span><br>
<span class="lineno"></span><span class="op" id="1431689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1431692">var</span>&nbsp;<span class="op" id="1431696">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431699">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1431717">sync</span><span class="op" id="1431721">.</span><span class="ident" id="1431722">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431728">bufioWriter2kPool</span>&nbsp;<span class="ident" id="1431746">sync</span><span class="op" id="1431750">.</span><span class="ident" id="1431751">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1431757">bufioWriter4kPool</span>&nbsp;<span class="ident" id="1431775">sync</span><span class="op" id="1431779">.</span><span class="ident" id="1431780">Pool</span><br>
<span class="lineno"></span><span class="op" id="1431785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="1431788">func</span>&nbsp;<span class="ident" id="1431793">bufioWriterPool</span><span class="op" id="1431808">(</span><span class="ident" id="1431809">size</span>&nbsp;<span class="builtintype" id="1431814">int</span><span class="op" id="1431817">)</span>&nbsp;<span class="op" id="1431819">*</span><span class="ident" id="1431820">sync</span><span class="op" id="1431824">.</span><span class="ident" id="1431825">Pool</span>&nbsp;<span class="op" id="1431830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431833">switch</span>&nbsp;<span class="ident" id="1431840">size</span>&nbsp;<span class="op" id="1431845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431848">case</span>&nbsp;<span class="num" id="1431853">2</span>&nbsp;<span class="op" id="1431855">&lt;&lt;</span>&nbsp;<span class="num" id="1431858">10</span><span class="op" id="1431860">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431864">return</span>&nbsp;<span class="op" id="1431871">&amp;</span><span class="ident" id="1431872">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431891">case</span>&nbsp;<span class="num" id="1431896">4</span>&nbsp;<span class="op" id="1431898">&lt;&lt;</span>&nbsp;<span class="num" id="1431901">10</span><span class="op" id="1431903">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431907">return</span>&nbsp;<span class="op" id="1431914">&amp;</span><span class="ident" id="1431915">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1431934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1431937">return</span>&nbsp;<span class="ident" id="1431944">nil</span><br>
<span class="lineno"></span><span class="op" id="1431948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="1431951">func</span>&nbsp;<span class="ident" id="1431956">newBufioReader</span><span class="op" id="1431970">(</span><span class="ident" id="1431971">r</span>&nbsp;<span class="ident" id="1431973">io</span><span class="op" id="1431975">.</span><span class="ident" id="1431976">Reader</span><span class="op" id="1431982">)</span>&nbsp;<span class="op" id="1431984">*</span><span class="ident" id="1431985">bufio</span><span class="op" id="1431990">.</span><span class="ident" id="1431991">Reader</span>&nbsp;<span class="op" id="1431998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432001">if</span>&nbsp;<span class="ident" id="1432004">v</span>&nbsp;<span class="op" id="1432006">:=</span>&nbsp;<span class="ident" id="1432009">bufioReaderPool</span><span class="op" id="1432024">.</span><span class="ident" id="1432025">Get</span><span class="op" id="1432028">(</span><span class="op" id="1432029">)</span><span class="op" id="1432030">;</span>&nbsp;<span class="ident" id="1432032">v</span>&nbsp;<span class="op" id="1432034">!=</span>&nbsp;<span class="ident" id="1432037">nil</span>&nbsp;<span class="op" id="1432041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432045">br</span>&nbsp;<span class="op" id="1432048">:=</span>&nbsp;<span class="ident" id="1432051">v</span><span class="op" id="1432052">.</span><span class="op" id="1432053">(</span><span class="op" id="1432054">*</span><span class="ident" id="1432055">bufio</span><span class="op" id="1432060">.</span><span class="ident" id="1432061">Reader</span><span class="op" id="1432067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432071">br</span><span class="op" id="1432073">.</span><span class="ident" id="1432074">Reset</span><span class="op" id="1432079">(</span><span class="ident" id="1432080">r</span><span class="op" id="1432081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432085">return</span>&nbsp;<span class="ident" id="1432092">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432099">return</span>&nbsp;<span class="ident" id="1432106">bufio</span><span class="op" id="1432111">.</span><span class="ident" id="1432112">NewReader</span><span class="op" id="1432121">(</span><span class="ident" id="1432122">r</span><span class="op" id="1432123">)</span><br>
<span class="lineno"></span><span class="op" id="1432125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432128">func</span>&nbsp;<span class="ident" id="1432133">putBufioReader</span><span class="op" id="1432147">(</span><span class="ident" id="1432148">br</span>&nbsp;<span class="op" id="1432151">*</span><span class="ident" id="1432152">bufio</span><span class="op" id="1432157">.</span><span class="ident" id="1432158">Reader</span><span class="op" id="1432164">)</span>&nbsp;<span class="op" id="1432166">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432169">br</span><span class="op" id="1432171">.</span><span class="ident" id="1432172">Reset</span><span class="op" id="1432177">(</span><span class="ident" id="1432178">nil</span><span class="op" id="1432181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432184">bufioReaderPool</span><span class="op" id="1432199">.</span><span class="ident" id="1432200">Put</span><span class="op" id="1432203">(</span><span class="ident" id="1432204">br</span><span class="op" id="1432206">)</span><br>
<span class="lineno"></span><span class="op" id="1432208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432211">func</span>&nbsp;<span class="ident" id="1432216">newBufioWriterSize</span><span class="op" id="1432234">(</span><span class="ident" id="1432235">w</span>&nbsp;<span class="ident" id="1432237">io</span><span class="op" id="1432239">.</span><span class="ident" id="1432240">Writer</span><span class="op" id="1432246">,</span>&nbsp;<span class="ident" id="1432248">size</span>&nbsp;<span class="builtintype" id="1432253">int</span><span class="op" id="1432256">)</span>&nbsp;<span class="op" id="1432258">*</span><span class="ident" id="1432259">bufio</span><span class="op" id="1432264">.</span><span class="ident" id="1432265">Writer</span>&nbsp;<span class="op" id="1432272">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432275">pool</span>&nbsp;<span class="op" id="1432280">:=</span>&nbsp;<span class="ident" id="1432283">bufioWriterPool</span><span class="op" id="1432298">(</span><span class="ident" id="1432299">size</span><span class="op" id="1432303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432306">if</span>&nbsp;<span class="ident" id="1432309">pool</span>&nbsp;<span class="op" id="1432314">!=</span>&nbsp;<span class="ident" id="1432317">nil</span>&nbsp;<span class="op" id="1432321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432325">if</span>&nbsp;<span class="ident" id="1432328">v</span>&nbsp;<span class="op" id="1432330">:=</span>&nbsp;<span class="ident" id="1432333">pool</span><span class="op" id="1432337">.</span><span class="ident" id="1432338">Get</span><span class="op" id="1432341">(</span><span class="op" id="1432342">)</span><span class="op" id="1432343">;</span>&nbsp;<span class="ident" id="1432345">v</span>&nbsp;<span class="op" id="1432347">!=</span>&nbsp;<span class="ident" id="1432350">nil</span>&nbsp;<span class="op" id="1432354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432359">bw</span>&nbsp;<span class="op" id="1432362">:=</span>&nbsp;<span class="ident" id="1432365">v</span><span class="op" id="1432366">.</span><span class="op" id="1432367">(</span><span class="op" id="1432368">*</span><span class="ident" id="1432369">bufio</span><span class="op" id="1432374">.</span><span class="ident" id="1432375">Writer</span><span class="op" id="1432381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432386">bw</span><span class="op" id="1432388">.</span><span class="ident" id="1432389">Reset</span><span class="op" id="1432394">(</span><span class="ident" id="1432395">w</span><span class="op" id="1432396">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432401">return</span>&nbsp;<span class="ident" id="1432408">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432419">return</span>&nbsp;<span class="ident" id="1432426">bufio</span><span class="op" id="1432431">.</span><span class="ident" id="1432432">NewWriterSize</span><span class="op" id="1432445">(</span><span class="ident" id="1432446">w</span><span class="op" id="1432447">,</span>&nbsp;<span class="ident" id="1432449">size</span><span class="op" id="1432453">)</span><br>
<span class="lineno"></span><span class="op" id="1432455">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="1432458">func</span>&nbsp;<span class="ident" id="1432463">putBufioWriter</span><span class="op" id="1432477">(</span><span class="ident" id="1432478">bw</span>&nbsp;<span class="op" id="1432481">*</span><span class="ident" id="1432482">bufio</span><span class="op" id="1432487">.</span><span class="ident" id="1432488">Writer</span><span class="op" id="1432494">)</span>&nbsp;<span class="op" id="1432496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432499">bw</span><span class="op" id="1432501">.</span><span class="ident" id="1432502">Reset</span><span class="op" id="1432507">(</span><span class="ident" id="1432508">nil</span><span class="op" id="1432511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432514">if</span>&nbsp;<span class="ident" id="1432517">pool</span>&nbsp;<span class="op" id="1432522">:=</span>&nbsp;<span class="ident" id="1432525">bufioWriterPool</span><span class="op" id="1432540">(</span><span class="ident" id="1432541">bw</span><span class="op" id="1432543">.</span><span class="ident" id="1432544">Available</span><span class="op" id="1432553">(</span><span class="op" id="1432554">)</span><span class="op" id="1432555">)</span><span class="op" id="1432556">;</span>&nbsp;<span class="ident" id="1432558">pool</span>&nbsp;<span class="op" id="1432563">!=</span>&nbsp;<span class="ident" id="1432566">nil</span>&nbsp;<span class="op" id="1432570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1432574">pool</span><span class="op" id="1432578">.</span><span class="ident" id="1432579">Put</span><span class="op" id="1432582">(</span><span class="ident" id="1432583">bw</span><span class="op" id="1432585">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432588">}</span><br>
<span class="lineno"></span><span class="op" id="1432590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1432593">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="1432663">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="1432686">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="1432746">const</span>&nbsp;<span class="ident" id="1432752">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="1432774">=</span>&nbsp;<span class="num" id="1432776">1</span>&nbsp;<span class="op" id="1432778">&lt;&lt;</span>&nbsp;<span class="num" id="1432781">20</span>&nbsp;<span class="comment" id="1432784">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432793">func</span>&nbsp;<span class="op" id="1432798">(</span><span class="ident" id="1432799">srv</span>&nbsp;<span class="op" id="1432803">*</span><span class="ident" id="1432804">Server</span><span class="op" id="1432810">)</span>&nbsp;<span class="ident" id="1432812">maxHeaderBytes</span><span class="op" id="1432826">(</span><span class="op" id="1432827">)</span>&nbsp;<span class="builtintype" id="1432829">int</span>&nbsp;<span class="op" id="1432833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432836">if</span>&nbsp;<span class="ident" id="1432839">srv</span><span class="op" id="1432842">.</span><span class="ident" id="1432843">MaxHeaderBytes</span>&nbsp;<span class="op" id="1432858">&gt;</span>&nbsp;<span class="num" id="1432860">0</span>&nbsp;<span class="op" id="1432862">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432866">return</span>&nbsp;<span class="ident" id="1432873">srv</span><span class="op" id="1432876">.</span><span class="ident" id="1432877">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1432893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432896">return</span>&nbsp;<span class="ident" id="1432903">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="1432925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="1432928">func</span>&nbsp;<span class="op" id="1432933">(</span><span class="ident" id="1432934">srv</span>&nbsp;<span class="op" id="1432938">*</span><span class="ident" id="1432939">Server</span><span class="op" id="1432945">)</span>&nbsp;<span class="ident" id="1432947">initialLimitedReaderSize</span><span class="op" id="1432971">(</span><span class="op" id="1432972">)</span>&nbsp;<span class="ident" id="1432974">int64</span>&nbsp;<span class="op" id="1432980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1432983">return</span>&nbsp;<span class="ident" id="1432990">int64</span><span class="op" id="1432995">(</span><span class="ident" id="1432996">srv</span><span class="op" id="1432999">.</span><span class="ident" id="1433000">maxHeaderBytes</span><span class="op" id="1433014">(</span><span class="op" id="1433015">)</span><span class="op" id="1433016">)</span>&nbsp;<span class="op" id="1433018">+</span>&nbsp;<span class="num" id="1433020">4096</span>&nbsp;<span class="comment" id="1433025">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="1433039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1433042">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="1433106">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="1433138">type</span>&nbsp;<span class="ident" id="1433143">expectContinueReader</span>&nbsp;<span class="keyword" id="1433164">struct</span>&nbsp;<span class="op" id="1433171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433174">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1433185">*</span><span class="ident" id="1433186">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433196">readCloser</span>&nbsp;<span class="ident" id="1433207">io</span><span class="op" id="1433209">.</span><span class="ident" id="1433210">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433222">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1433233">bool</span><br>
<span class="lineno">520</span><span class="op" id="1433238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433241">func</span>&nbsp;<span class="op" id="1433246">(</span><span class="ident" id="1433247">ecr</span>&nbsp;<span class="op" id="1433251">*</span><span class="ident" id="1433252">expectContinueReader</span><span class="op" id="1433272">)</span>&nbsp;<span class="ident" id="1433274">Read</span><span class="op" id="1433278">(</span><span class="ident" id="1433279">p</span>&nbsp;<span class="op" id="1433281">[</span><span class="op" id="1433282">]</span><span class="builtintype" id="1433283">byte</span><span class="op" id="1433287">)</span>&nbsp;<span class="op" id="1433289">(</span><span class="ident" id="1433290">n</span>&nbsp;<span class="builtintype" id="1433292">int</span><span class="op" id="1433295">,</span>&nbsp;<span class="ident" id="1433297">err</span>&nbsp;<span class="builtintype" id="1433301">error</span><span class="op" id="1433306">)</span>&nbsp;<span class="op" id="1433308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433311">if</span>&nbsp;<span class="ident" id="1433314">ecr</span><span class="op" id="1433317">.</span><span class="ident" id="1433318">closed</span>&nbsp;<span class="op" id="1433325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433329">return</span>&nbsp;<span class="num" id="1433336">0</span><span class="op" id="1433337">,</span>&nbsp;<span class="ident" id="1433339">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433365">if</span>&nbsp;<span class="op" id="1433368">!</span><span class="ident" id="1433369">ecr</span><span class="op" id="1433372">.</span><span class="ident" id="1433373">resp</span><span class="op" id="1433377">.</span><span class="ident" id="1433378">wroteContinue</span>&nbsp;<span class="op" id="1433392">&amp;&amp;</span>&nbsp;<span class="op" id="1433395">!</span><span class="ident" id="1433396">ecr</span><span class="op" id="1433399">.</span><span class="ident" id="1433400">resp</span><span class="op" id="1433404">.</span><span class="ident" id="1433405">conn</span><span class="op" id="1433409">.</span><span class="ident" id="1433410">hijacked</span><span class="op" id="1433418">(</span><span class="op" id="1433419">)</span>&nbsp;<span class="op" id="1433421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433425">ecr</span><span class="op" id="1433428">.</span><span class="ident" id="1433429">resp</span><span class="op" id="1433433">.</span><span class="ident" id="1433434">wroteContinue</span>&nbsp;<span class="op" id="1433448">=</span>&nbsp;<span class="builtintype" id="1433450">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433457">ecr</span><span class="op" id="1433460">.</span><span class="ident" id="1433461">resp</span><span class="op" id="1433465">.</span><span class="ident" id="1433466">conn</span><span class="op" id="1433470">.</span><span class="ident" id="1433471">buf</span><span class="op" id="1433474">.</span><span class="ident" id="1433475">WriteString</span><span class="op" id="1433486">(</span><span class="string" id="1433487">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="1433518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433522">ecr</span><span class="op" id="1433525">.</span><span class="ident" id="1433526">resp</span><span class="op" id="1433530">.</span><span class="ident" id="1433531">conn</span><span class="op" id="1433535">.</span><span class="ident" id="1433536">buf</span><span class="op" id="1433539">.</span><span class="ident" id="1433540">Flush</span><span class="op" id="1433545">(</span><span class="op" id="1433546">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433552">return</span>&nbsp;<span class="ident" id="1433559">ecr</span><span class="op" id="1433562">.</span><span class="ident" id="1433563">readCloser</span><span class="op" id="1433573">.</span><span class="ident" id="1433574">Read</span><span class="op" id="1433578">(</span><span class="ident" id="1433579">p</span><span class="op" id="1433580">)</span><br>
<span class="lineno"></span><span class="op" id="1433582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433585">func</span>&nbsp;<span class="op" id="1433590">(</span><span class="ident" id="1433591">ecr</span>&nbsp;<span class="op" id="1433595">*</span><span class="ident" id="1433596">expectContinueReader</span><span class="op" id="1433616">)</span>&nbsp;<span class="ident" id="1433618">Close</span><span class="op" id="1433623">(</span><span class="op" id="1433624">)</span>&nbsp;<span class="builtintype" id="1433626">error</span>&nbsp;<span class="op" id="1433632">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433635">ecr</span><span class="op" id="1433638">.</span><span class="ident" id="1433639">closed</span>&nbsp;<span class="op" id="1433646">=</span>&nbsp;<span class="builtintype" id="1433648">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433654">return</span>&nbsp;<span class="ident" id="1433661">ecr</span><span class="op" id="1433664">.</span><span class="ident" id="1433665">readCloser</span><span class="op" id="1433675">.</span><span class="ident" id="1433676">Close</span><span class="op" id="1433681">(</span><span class="op" id="1433682">)</span><br>
<span class="lineno"></span><span class="op" id="1433684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1433687">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="1433732">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="1433780">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="1433820">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="1433884">const</span>&nbsp;<span class="ident" id="1433890">TimeFormat</span>&nbsp;<span class="op" id="1433901">=</span>&nbsp;<span class="string" id="1433903">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="1433936">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="1434016">func</span>&nbsp;<span class="ident" id="1434021">appendTime</span><span class="op" id="1434031">(</span><span class="ident" id="1434032">b</span>&nbsp;<span class="op" id="1434034">[</span><span class="op" id="1434035">]</span><span class="builtintype" id="1434036">byte</span><span class="op" id="1434040">,</span>&nbsp;<span class="ident" id="1434042">t</span>&nbsp;<span class="ident" id="1434044">time</span><span class="op" id="1434048">.</span><span class="ident" id="1434049">Time</span><span class="op" id="1434053">)</span>&nbsp;<span class="op" id="1434055">[</span><span class="op" id="1434056">]</span><span class="builtintype" id="1434057">byte</span>&nbsp;<span class="op" id="1434062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434065">const</span>&nbsp;<span class="ident" id="1434071">days</span>&nbsp;<span class="op" id="1434076">=</span>&nbsp;<span class="string" id="1434078">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434103">const</span>&nbsp;<span class="ident" id="1434109">months</span>&nbsp;<span class="op" id="1434116">=</span>&nbsp;<span class="string" id="1434118">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434159">t</span>&nbsp;<span class="op" id="1434161">=</span>&nbsp;<span class="ident" id="1434163">t</span><span class="op" id="1434164">.</span><span class="ident" id="1434165">UTC</span><span class="op" id="1434168">(</span><span class="op" id="1434169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434172">yy</span><span class="op" id="1434174">,</span>&nbsp;<span class="ident" id="1434176">mm</span><span class="op" id="1434178">,</span>&nbsp;<span class="ident" id="1434180">dd</span>&nbsp;<span class="op" id="1434183">:=</span>&nbsp;<span class="ident" id="1434186">t</span><span class="op" id="1434187">.</span><span class="ident" id="1434188">Date</span><span class="op" id="1434192">(</span><span class="op" id="1434193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434196">hh</span><span class="op" id="1434198">,</span>&nbsp;<span class="ident" id="1434200">mn</span><span class="op" id="1434202">,</span>&nbsp;<span class="ident" id="1434204">ss</span>&nbsp;<span class="op" id="1434207">:=</span>&nbsp;<span class="ident" id="1434210">t</span><span class="op" id="1434211">.</span><span class="ident" id="1434212">Clock</span><span class="op" id="1434217">(</span><span class="op" id="1434218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434221">day</span>&nbsp;<span class="op" id="1434225">:=</span>&nbsp;<span class="ident" id="1434228">days</span><span class="op" id="1434232">[</span><span class="num" id="1434233">3</span><span class="op" id="1434234">*</span><span class="ident" id="1434235">t</span><span class="op" id="1434236">.</span><span class="ident" id="1434237">Weekday</span><span class="op" id="1434244">(</span><span class="op" id="1434245">)</span><span class="op" id="1434246">:</span><span class="op" id="1434247">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434250">mon</span>&nbsp;<span class="op" id="1434254">:=</span>&nbsp;<span class="ident" id="1434257">months</span><span class="op" id="1434263">[</span><span class="num" id="1434264">3</span><span class="op" id="1434265">*</span><span class="op" id="1434266">(</span><span class="ident" id="1434267">mm</span><span class="op" id="1434269">-</span><span class="num" id="1434270">1</span><span class="op" id="1434271">)</span><span class="op" id="1434272">:</span><span class="op" id="1434273">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434277">return</span>&nbsp;<span class="builtinfunc" id="1434284">append</span><span class="op" id="1434290">(</span><span class="ident" id="1434291">b</span><span class="op" id="1434292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434296">day</span><span class="op" id="1434299">[</span><span class="num" id="1434300">0</span><span class="op" id="1434301">]</span><span class="op" id="1434302">,</span>&nbsp;<span class="ident" id="1434304">day</span><span class="op" id="1434307">[</span><span class="num" id="1434308">1</span><span class="op" id="1434309">]</span><span class="op" id="1434310">,</span>&nbsp;<span class="ident" id="1434312">day</span><span class="op" id="1434315">[</span><span class="num" id="1434316">2</span><span class="op" id="1434317">]</span><span class="op" id="1434318">,</span>&nbsp;<span class="string" id="1434320">&#39;,&#39;</span><span class="op" id="1434323">,</span>&nbsp;<span class="string" id="1434325">&#39;&nbsp;&#39;</span><span class="op" id="1434328">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1434332">byte</span><span class="op" id="1434336">(</span><span class="string" id="1434337">&#39;0&#39;</span><span class="op" id="1434340">+</span><span class="ident" id="1434341">dd</span><span class="op" id="1434343">/</span><span class="num" id="1434344">10</span><span class="op" id="1434346">)</span><span class="op" id="1434347">,</span>&nbsp;<span class="builtintype" id="1434349">byte</span><span class="op" id="1434353">(</span><span class="string" id="1434354">&#39;0&#39;</span><span class="op" id="1434357">+</span><span class="ident" id="1434358">dd</span><span class="op" id="1434360">%</span><span class="num" id="1434361">10</span><span class="op" id="1434363">)</span><span class="op" id="1434364">,</span>&nbsp;<span class="string" id="1434366">&#39;&nbsp;&#39;</span><span class="op" id="1434369">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434373">mon</span><span class="op" id="1434376">[</span><span class="num" id="1434377">0</span><span class="op" id="1434378">]</span><span class="op" id="1434379">,</span>&nbsp;<span class="ident" id="1434381">mon</span><span class="op" id="1434384">[</span><span class="num" id="1434385">1</span><span class="op" id="1434386">]</span><span class="op" id="1434387">,</span>&nbsp;<span class="ident" id="1434389">mon</span><span class="op" id="1434392">[</span><span class="num" id="1434393">2</span><span class="op" id="1434394">]</span><span class="op" id="1434395">,</span>&nbsp;<span class="string" id="1434397">&#39;&nbsp;&#39;</span><span class="op" id="1434400">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1434404">byte</span><span class="op" id="1434408">(</span><span class="string" id="1434409">&#39;0&#39;</span><span class="op" id="1434412">+</span><span class="ident" id="1434413">yy</span><span class="op" id="1434415">/</span><span class="num" id="1434416">1000</span><span class="op" id="1434420">)</span><span class="op" id="1434421">,</span>&nbsp;<span class="builtintype" id="1434423">byte</span><span class="op" id="1434427">(</span><span class="string" id="1434428">&#39;0&#39;</span><span class="op" id="1434431">+</span><span class="op" id="1434432">(</span><span class="ident" id="1434433">yy</span><span class="op" id="1434435">/</span><span class="num" id="1434436">100</span><span class="op" id="1434439">)</span><span class="op" id="1434440">%</span><span class="num" id="1434441">10</span><span class="op" id="1434443">)</span><span class="op" id="1434444">,</span>&nbsp;<span class="builtintype" id="1434446">byte</span><span class="op" id="1434450">(</span><span class="string" id="1434451">&#39;0&#39;</span><span class="op" id="1434454">+</span><span class="op" id="1434455">(</span><span class="ident" id="1434456">yy</span><span class="op" id="1434458">/</span><span class="num" id="1434459">10</span><span class="op" id="1434461">)</span><span class="op" id="1434462">%</span><span class="num" id="1434463">10</span><span class="op" id="1434465">)</span><span class="op" id="1434466">,</span>&nbsp;<span class="builtintype" id="1434468">byte</span><span class="op" id="1434472">(</span><span class="string" id="1434473">&#39;0&#39;</span><span class="op" id="1434476">+</span><span class="ident" id="1434477">yy</span><span class="op" id="1434479">%</span><span class="num" id="1434480">10</span><span class="op" id="1434482">)</span><span class="op" id="1434483">,</span>&nbsp;<span class="string" id="1434485">&#39;&nbsp;&#39;</span><span class="op" id="1434488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1434492">byte</span><span class="op" id="1434496">(</span><span class="string" id="1434497">&#39;0&#39;</span><span class="op" id="1434500">+</span><span class="ident" id="1434501">hh</span><span class="op" id="1434503">/</span><span class="num" id="1434504">10</span><span class="op" id="1434506">)</span><span class="op" id="1434507">,</span>&nbsp;<span class="builtintype" id="1434509">byte</span><span class="op" id="1434513">(</span><span class="string" id="1434514">&#39;0&#39;</span><span class="op" id="1434517">+</span><span class="ident" id="1434518">hh</span><span class="op" id="1434520">%</span><span class="num" id="1434521">10</span><span class="op" id="1434523">)</span><span class="op" id="1434524">,</span>&nbsp;<span class="string" id="1434526">&#39;:&#39;</span><span class="op" id="1434529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1434533">byte</span><span class="op" id="1434537">(</span><span class="string" id="1434538">&#39;0&#39;</span><span class="op" id="1434541">+</span><span class="ident" id="1434542">mn</span><span class="op" id="1434544">/</span><span class="num" id="1434545">10</span><span class="op" id="1434547">)</span><span class="op" id="1434548">,</span>&nbsp;<span class="builtintype" id="1434550">byte</span><span class="op" id="1434554">(</span><span class="string" id="1434555">&#39;0&#39;</span><span class="op" id="1434558">+</span><span class="ident" id="1434559">mn</span><span class="op" id="1434561">%</span><span class="num" id="1434562">10</span><span class="op" id="1434564">)</span><span class="op" id="1434565">,</span>&nbsp;<span class="string" id="1434567">&#39;:&#39;</span><span class="op" id="1434570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1434574">byte</span><span class="op" id="1434578">(</span><span class="string" id="1434579">&#39;0&#39;</span><span class="op" id="1434582">+</span><span class="ident" id="1434583">ss</span><span class="op" id="1434585">/</span><span class="num" id="1434586">10</span><span class="op" id="1434588">)</span><span class="op" id="1434589">,</span>&nbsp;<span class="builtintype" id="1434591">byte</span><span class="op" id="1434595">(</span><span class="string" id="1434596">&#39;0&#39;</span><span class="op" id="1434599">+</span><span class="ident" id="1434600">ss</span><span class="op" id="1434602">%</span><span class="num" id="1434603">10</span><span class="op" id="1434605">)</span><span class="op" id="1434606">,</span>&nbsp;<span class="string" id="1434608">&#39;&nbsp;&#39;</span><span class="op" id="1434611">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1434615">&#39;G&#39;</span><span class="op" id="1434618">,</span>&nbsp;<span class="string" id="1434620">&#39;M&#39;</span><span class="op" id="1434623">,</span>&nbsp;<span class="string" id="1434625">&#39;T&#39;</span><span class="op" id="1434628">)</span><br>
<span class="lineno">565</span><span class="op" id="1434630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1434633">var</span>&nbsp;<span class="ident" id="1434637">errTooLarge</span>&nbsp;<span class="op" id="1434649">=</span>&nbsp;<span class="ident" id="1434651">errors</span><span class="op" id="1434657">.</span><span class="ident" id="1434658">New</span><span class="op" id="1434661">(</span><span class="string" id="1434662">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="1434687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1434690">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="1434728">func</span>&nbsp;<span class="op" id="1434733">(</span><span class="ident" id="1434734">c</span>&nbsp;<span class="op" id="1434736">*</span><span class="ident" id="1434737">conn</span><span class="op" id="1434741">)</span>&nbsp;<span class="ident" id="1434743">readRequest</span><span class="op" id="1434754">(</span><span class="op" id="1434755">)</span>&nbsp;<span class="op" id="1434757">(</span><span class="ident" id="1434758">w</span>&nbsp;<span class="op" id="1434760">*</span><span class="ident" id="1434761">response</span><span class="op" id="1434769">,</span>&nbsp;<span class="ident" id="1434771">err</span>&nbsp;<span class="builtintype" id="1434775">error</span><span class="op" id="1434780">)</span>&nbsp;<span class="op" id="1434782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434785">if</span>&nbsp;<span class="ident" id="1434788">c</span><span class="op" id="1434789">.</span><span class="ident" id="1434790">hijacked</span><span class="op" id="1434798">(</span><span class="op" id="1434799">)</span>&nbsp;<span class="op" id="1434801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434805">return</span>&nbsp;<span class="ident" id="1434812">nil</span><span class="op" id="1434815">,</span>&nbsp;<span class="ident" id="1434817">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434834">if</span>&nbsp;<span class="ident" id="1434837">d</span>&nbsp;<span class="op" id="1434839">:=</span>&nbsp;<span class="ident" id="1434842">c</span><span class="op" id="1434843">.</span><span class="ident" id="1434844">server</span><span class="op" id="1434850">.</span><span class="ident" id="1434851">ReadTimeout</span><span class="op" id="1434862">;</span>&nbsp;<span class="ident" id="1434864">d</span>&nbsp;<span class="op" id="1434866">!=</span>&nbsp;<span class="num" id="1434869">0</span>&nbsp;<span class="op" id="1434871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434875">c</span><span class="op" id="1434876">.</span><span class="ident" id="1434877">rwc</span><span class="op" id="1434880">.</span><span class="ident" id="1434881">SetReadDeadline</span><span class="op" id="1434896">(</span><span class="ident" id="1434897">time</span><span class="op" id="1434901">.</span><span class="ident" id="1434902">Now</span><span class="op" id="1434905">(</span><span class="op" id="1434906">)</span><span class="op" id="1434907">.</span><span class="ident" id="1434908">Add</span><span class="op" id="1434911">(</span><span class="ident" id="1434912">d</span><span class="op" id="1434913">)</span><span class="op" id="1434914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434920">if</span>&nbsp;<span class="ident" id="1434923">d</span>&nbsp;<span class="op" id="1434925">:=</span>&nbsp;<span class="ident" id="1434928">c</span><span class="op" id="1434929">.</span><span class="ident" id="1434930">server</span><span class="op" id="1434936">.</span><span class="ident" id="1434937">WriteTimeout</span><span class="op" id="1434949">;</span>&nbsp;<span class="ident" id="1434951">d</span>&nbsp;<span class="op" id="1434953">!=</span>&nbsp;<span class="num" id="1434956">0</span>&nbsp;<span class="op" id="1434958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434962">defer</span>&nbsp;<span class="keyword" id="1434968">func</span><span class="op" id="1434972">(</span><span class="op" id="1434973">)</span>&nbsp;<span class="op" id="1434975">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434980">c</span><span class="op" id="1434981">.</span><span class="ident" id="1434982">rwc</span><span class="op" id="1434985">.</span><span class="ident" id="1434986">SetWriteDeadline</span><span class="op" id="1435002">(</span><span class="ident" id="1435003">time</span><span class="op" id="1435007">.</span><span class="ident" id="1435008">Now</span><span class="op" id="1435011">(</span><span class="op" id="1435012">)</span><span class="op" id="1435013">.</span><span class="ident" id="1435014">Add</span><span class="op" id="1435017">(</span><span class="ident" id="1435018">d</span><span class="op" id="1435019">)</span><span class="op" id="1435020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435024">}</span><span class="op" id="1435025">(</span><span class="op" id="1435026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435033">c</span><span class="op" id="1435034">.</span><span class="ident" id="1435035">lr</span><span class="op" id="1435037">.</span><span class="ident" id="1435038">N</span>&nbsp;<span class="op" id="1435040">=</span>&nbsp;<span class="ident" id="1435042">c</span><span class="op" id="1435043">.</span><span class="ident" id="1435044">server</span><span class="op" id="1435050">.</span><span class="ident" id="1435051">initialLimitedReaderSize</span><span class="op" id="1435075">(</span><span class="op" id="1435076">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435079">var</span>&nbsp;<span class="ident" id="1435083">req</span>&nbsp;<span class="op" id="1435087">*</span><span class="ident" id="1435088">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435097">if</span>&nbsp;<span class="ident" id="1435100">req</span><span class="op" id="1435103">,</span>&nbsp;<span class="ident" id="1435105">err</span>&nbsp;<span class="op" id="1435109">=</span>&nbsp;<span class="ident" id="1435111">ReadRequest</span><span class="op" id="1435122">(</span><span class="ident" id="1435123">c</span><span class="op" id="1435124">.</span><span class="ident" id="1435125">buf</span><span class="op" id="1435128">.</span><span class="ident" id="1435129">Reader</span><span class="op" id="1435135">)</span><span class="op" id="1435136">;</span>&nbsp;<span class="ident" id="1435138">err</span>&nbsp;<span class="op" id="1435142">!=</span>&nbsp;<span class="ident" id="1435145">nil</span>&nbsp;<span class="op" id="1435149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435153">if</span>&nbsp;<span class="ident" id="1435156">c</span><span class="op" id="1435157">.</span><span class="ident" id="1435158">lr</span><span class="op" id="1435160">.</span><span class="ident" id="1435161">N</span>&nbsp;<span class="op" id="1435163">==</span>&nbsp;<span class="num" id="1435166">0</span>&nbsp;<span class="op" id="1435168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435173">return</span>&nbsp;<span class="ident" id="1435180">nil</span><span class="op" id="1435183">,</span>&nbsp;<span class="ident" id="1435185">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435199">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435203">return</span>&nbsp;<span class="ident" id="1435210">nil</span><span class="op" id="1435213">,</span>&nbsp;<span class="ident" id="1435215">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435223">c</span><span class="op" id="1435224">.</span><span class="ident" id="1435225">lr</span><span class="op" id="1435227">.</span><span class="ident" id="1435228">N</span>&nbsp;<span class="op" id="1435230">=</span>&nbsp;<span class="ident" id="1435232">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435242">req</span><span class="op" id="1435245">.</span><span class="ident" id="1435246">RemoteAddr</span>&nbsp;<span class="op" id="1435257">=</span>&nbsp;<span class="ident" id="1435259">c</span><span class="op" id="1435260">.</span><span class="ident" id="1435261">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435273">req</span><span class="op" id="1435276">.</span><span class="ident" id="1435277">TLS</span>&nbsp;<span class="op" id="1435281">=</span>&nbsp;<span class="ident" id="1435283">c</span><span class="op" id="1435284">.</span><span class="ident" id="1435285">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435296">w</span>&nbsp;<span class="op" id="1435298">=</span>&nbsp;<span class="op" id="1435300">&amp;</span><span class="ident" id="1435301">response</span><span class="op" id="1435309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435313">conn</span><span class="op" id="1435317">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1435328">c</span><span class="op" id="1435329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435333">req</span><span class="op" id="1435336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1435348">req</span><span class="op" id="1435351">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435355">handlerHeader</span><span class="op" id="1435368">:</span>&nbsp;<span class="builtinfunc" id="1435370">make</span><span class="op" id="1435374">(</span><span class="ident" id="1435375">Header</span><span class="op" id="1435381">)</span><span class="op" id="1435382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435386">contentLength</span><span class="op" id="1435399">:</span>&nbsp;<span class="op" id="1435401">-</span><span class="num" id="1435402">1</span><span class="op" id="1435403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435409">w</span><span class="op" id="1435410">.</span><span class="ident" id="1435411">cw</span><span class="op" id="1435413">.</span><span class="ident" id="1435414">res</span>&nbsp;<span class="op" id="1435418">=</span>&nbsp;<span class="ident" id="1435420">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435423">w</span><span class="op" id="1435424">.</span><span class="ident" id="1435425">w</span>&nbsp;<span class="op" id="1435427">=</span>&nbsp;<span class="ident" id="1435429">newBufioWriterSize</span><span class="op" id="1435447">(</span><span class="op" id="1435448">&amp;</span><span class="ident" id="1435449">w</span><span class="op" id="1435450">.</span><span class="ident" id="1435451">cw</span><span class="op" id="1435453">,</span>&nbsp;<span class="ident" id="1435455">bufferBeforeChunkingSize</span><span class="op" id="1435479">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435482">return</span>&nbsp;<span class="ident" id="1435489">w</span><span class="op" id="1435490">,</span>&nbsp;<span class="ident" id="1435492">nil</span><br>
<span class="lineno"></span><span class="op" id="1435496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1435499">func</span>&nbsp;<span class="op" id="1435504">(</span><span class="ident" id="1435505">w</span>&nbsp;<span class="op" id="1435507">*</span><span class="ident" id="1435508">response</span><span class="op" id="1435516">)</span>&nbsp;<span class="ident" id="1435518">Header</span><span class="op" id="1435524">(</span><span class="op" id="1435525">)</span>&nbsp;<span class="ident" id="1435527">Header</span>&nbsp;<span class="op" id="1435534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435537">if</span>&nbsp;<span class="ident" id="1435540">w</span><span class="op" id="1435541">.</span><span class="ident" id="1435542">cw</span><span class="op" id="1435544">.</span><span class="ident" id="1435545">header</span>&nbsp;<span class="op" id="1435552">==</span>&nbsp;<span class="ident" id="1435555">nil</span>&nbsp;<span class="op" id="1435559">&amp;&amp;</span>&nbsp;<span class="ident" id="1435562">w</span><span class="op" id="1435563">.</span><span class="ident" id="1435564">wroteHeader</span>&nbsp;<span class="op" id="1435576">&amp;&amp;</span>&nbsp;<span class="op" id="1435579">!</span><span class="ident" id="1435580">w</span><span class="op" id="1435581">.</span><span class="ident" id="1435582">cw</span><span class="op" id="1435584">.</span><span class="ident" id="1435585">wroteHeader</span>&nbsp;<span class="op" id="1435597">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435601">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435656">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1435713">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435767">w</span><span class="op" id="1435768">.</span><span class="ident" id="1435769">cw</span><span class="op" id="1435771">.</span><span class="ident" id="1435772">header</span>&nbsp;<span class="op" id="1435779">=</span>&nbsp;<span class="ident" id="1435781">w</span><span class="op" id="1435782">.</span><span class="ident" id="1435783">handlerHeader</span><span class="op" id="1435796">.</span><span class="ident" id="1435797">clone</span><span class="op" id="1435802">(</span><span class="op" id="1435803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1435806">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435809">w</span><span class="op" id="1435810">.</span><span class="ident" id="1435811">calledHeader</span>&nbsp;<span class="op" id="1435824">=</span>&nbsp;<span class="builtintype" id="1435826">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435832">return</span>&nbsp;<span class="ident" id="1435839">w</span><span class="op" id="1435840">.</span><span class="ident" id="1435841">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="1435855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1435858">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="1435929">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="1435996">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="1436066">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="1436134">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="1436154">//</span><br>
<span class="lineno">625</span><span class="comment" id="1436157">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="1436225">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1436295">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="1436314">const</span>&nbsp;<span class="ident" id="1436320">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="1436344">=</span>&nbsp;<span class="num" id="1436346">256</span>&nbsp;<span class="op" id="1436350">&lt;&lt;</span>&nbsp;<span class="num" id="1436353">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="1436357">func</span>&nbsp;<span class="op" id="1436362">(</span><span class="ident" id="1436363">w</span>&nbsp;<span class="op" id="1436365">*</span><span class="ident" id="1436366">response</span><span class="op" id="1436374">)</span>&nbsp;<span class="ident" id="1436376">WriteHeader</span><span class="op" id="1436387">(</span><span class="ident" id="1436388">code</span>&nbsp;<span class="builtintype" id="1436393">int</span><span class="op" id="1436396">)</span>&nbsp;<span class="op" id="1436398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436401">if</span>&nbsp;<span class="ident" id="1436404">w</span><span class="op" id="1436405">.</span><span class="ident" id="1436406">conn</span><span class="op" id="1436410">.</span><span class="ident" id="1436411">hijacked</span><span class="op" id="1436419">(</span><span class="op" id="1436420">)</span>&nbsp;<span class="op" id="1436422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436426">w</span><span class="op" id="1436427">.</span><span class="ident" id="1436428">conn</span><span class="op" id="1436432">.</span><span class="ident" id="1436433">server</span><span class="op" id="1436439">.</span><span class="ident" id="1436440">logf</span><span class="op" id="1436444">(</span><span class="string" id="1436445">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="1436496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436500">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436508">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436511">if</span>&nbsp;<span class="ident" id="1436514">w</span><span class="op" id="1436515">.</span><span class="ident" id="1436516">wroteHeader</span>&nbsp;<span class="op" id="1436528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436532">w</span><span class="op" id="1436533">.</span><span class="ident" id="1436534">conn</span><span class="op" id="1436538">.</span><span class="ident" id="1436539">server</span><span class="op" id="1436545">.</span><span class="ident" id="1436546">logf</span><span class="op" id="1436550">(</span><span class="string" id="1436551">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="1436594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436598">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436609">w</span><span class="op" id="1436610">.</span><span class="ident" id="1436611">wroteHeader</span>&nbsp;<span class="op" id="1436623">=</span>&nbsp;<span class="builtintype" id="1436625">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436631">w</span><span class="op" id="1436632">.</span><span class="ident" id="1436633">status</span>&nbsp;<span class="op" id="1436640">=</span>&nbsp;<span class="ident" id="1436642">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436649">if</span>&nbsp;<span class="ident" id="1436652">w</span><span class="op" id="1436653">.</span><span class="ident" id="1436654">calledHeader</span>&nbsp;<span class="op" id="1436667">&amp;&amp;</span>&nbsp;<span class="ident" id="1436670">w</span><span class="op" id="1436671">.</span><span class="ident" id="1436672">cw</span><span class="op" id="1436674">.</span><span class="ident" id="1436675">header</span>&nbsp;<span class="op" id="1436682">==</span>&nbsp;<span class="ident" id="1436685">nil</span>&nbsp;<span class="op" id="1436689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436693">w</span><span class="op" id="1436694">.</span><span class="ident" id="1436695">cw</span><span class="op" id="1436697">.</span><span class="ident" id="1436698">header</span>&nbsp;<span class="op" id="1436705">=</span>&nbsp;<span class="ident" id="1436707">w</span><span class="op" id="1436708">.</span><span class="ident" id="1436709">handlerHeader</span><span class="op" id="1436722">.</span><span class="ident" id="1436723">clone</span><span class="op" id="1436728">(</span><span class="op" id="1436729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436732">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436736">if</span>&nbsp;<span class="ident" id="1436739">cl</span>&nbsp;<span class="op" id="1436742">:=</span>&nbsp;<span class="ident" id="1436745">w</span><span class="op" id="1436746">.</span><span class="ident" id="1436747">handlerHeader</span><span class="op" id="1436760">.</span><span class="ident" id="1436761">get</span><span class="op" id="1436764">(</span><span class="string" id="1436765">&#34;Content-Length&#34;</span><span class="op" id="1436781">)</span><span class="op" id="1436782">;</span>&nbsp;<span class="ident" id="1436784">cl</span>&nbsp;<span class="op" id="1436787">!=</span>&nbsp;<span class="string" id="1436790">&#34;&#34;</span>&nbsp;<span class="op" id="1436793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436797">v</span><span class="op" id="1436798">,</span>&nbsp;<span class="ident" id="1436800">err</span>&nbsp;<span class="op" id="1436804">:=</span>&nbsp;<span class="ident" id="1436807">strconv</span><span class="op" id="1436814">.</span><span class="ident" id="1436815">ParseInt</span><span class="op" id="1436823">(</span><span class="ident" id="1436824">cl</span><span class="op" id="1436826">,</span>&nbsp;<span class="num" id="1436828">10</span><span class="op" id="1436830">,</span>&nbsp;<span class="num" id="1436832">64</span><span class="op" id="1436834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436838">if</span>&nbsp;<span class="ident" id="1436841">err</span>&nbsp;<span class="op" id="1436845">==</span>&nbsp;<span class="ident" id="1436848">nil</span>&nbsp;<span class="op" id="1436852">&amp;&amp;</span>&nbsp;<span class="ident" id="1436855">v</span>&nbsp;<span class="op" id="1436857">&gt;=</span>&nbsp;<span class="num" id="1436860">0</span>&nbsp;<span class="op" id="1436862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436867">w</span><span class="op" id="1436868">.</span><span class="ident" id="1436869">contentLength</span>&nbsp;<span class="op" id="1436883">=</span>&nbsp;<span class="ident" id="1436885">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1436889">}</span>&nbsp;<span class="keyword" id="1436891">else</span>&nbsp;<span class="op" id="1436896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436901">w</span><span class="op" id="1436902">.</span><span class="ident" id="1436903">conn</span><span class="op" id="1436907">.</span><span class="ident" id="1436908">server</span><span class="op" id="1436914">.</span><span class="ident" id="1436915">logf</span><span class="op" id="1436919">(</span><span class="string" id="1436920">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="1436956">,</span>&nbsp;<span class="ident" id="1436958">cl</span><span class="op" id="1436960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436965">w</span><span class="op" id="1436966">.</span><span class="ident" id="1436967">handlerHeader</span><span class="op" id="1436980">.</span><span class="ident" id="1436981">Del</span><span class="op" id="1436984">(</span><span class="string" id="1436985">&#34;Content-Length&#34;</span><span class="op" id="1437001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437008">}</span><br>
<span class="lineno">655</span><span class="op" id="1437010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1437013">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="1437094">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="1437173">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="1437230">type</span>&nbsp;<span class="ident" id="1437235">extraHeader</span>&nbsp;<span class="keyword" id="1437247">struct</span>&nbsp;<span class="op" id="1437254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437257">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1437274">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437282">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1437299">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437307">transferEncoding</span>&nbsp;<span class="builtintype" id="1437324">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437332">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1437349">[</span><span class="op" id="1437350">]</span><span class="builtintype" id="1437351">byte</span>&nbsp;<span class="comment" id="1437356">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437379">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1437396">[</span><span class="op" id="1437397">]</span><span class="builtintype" id="1437398">byte</span>&nbsp;<span class="comment" id="1437403">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="1437425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1437428">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="1437476">var</span>&nbsp;<span class="ident" id="1437480">extraHeaderKeys</span>&nbsp;<span class="op" id="1437496">=</span>&nbsp;<span class="op" id="1437498">[</span><span class="op" id="1437499">]</span><span class="op" id="1437500">[</span><span class="op" id="1437501">]</span><span class="builtintype" id="1437502">byte</span><span class="op" id="1437506">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437509">[</span><span class="op" id="1437510">]</span><span class="builtintype" id="1437511">byte</span><span class="op" id="1437515">(</span><span class="string" id="1437516">&#34;Content-Type&#34;</span><span class="op" id="1437530">)</span><span class="op" id="1437531">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437534">[</span><span class="op" id="1437535">]</span><span class="builtintype" id="1437536">byte</span><span class="op" id="1437540">(</span><span class="string" id="1437541">&#34;Connection&#34;</span><span class="op" id="1437553">)</span><span class="op" id="1437554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1437557">[</span><span class="op" id="1437558">]</span><span class="builtintype" id="1437559">byte</span><span class="op" id="1437563">(</span><span class="string" id="1437564">&#34;Transfer-Encoding&#34;</span><span class="op" id="1437583">)</span><span class="op" id="1437584">,</span><br>
<span class="lineno"></span><span class="op" id="1437586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="1437589">var</span>&nbsp;<span class="op" id="1437593">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437596">headerContentLength</span>&nbsp;<span class="op" id="1437616">=</span>&nbsp;<span class="op" id="1437618">[</span><span class="op" id="1437619">]</span><span class="builtintype" id="1437620">byte</span><span class="op" id="1437624">(</span><span class="string" id="1437625">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="1437643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437646">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1437666">=</span>&nbsp;<span class="op" id="1437668">[</span><span class="op" id="1437669">]</span><span class="builtintype" id="1437670">byte</span><span class="op" id="1437674">(</span><span class="string" id="1437675">&#34;Date:&nbsp;&#34;</span><span class="op" id="1437683">)</span><br>
<span class="lineno"></span><span class="op" id="1437685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="1437688">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="1437737">//</span><br>
<span class="lineno"></span><span class="comment" id="1437740">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="1437809">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1437879">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="1437938">func</span>&nbsp;<span class="op" id="1437943">(</span><span class="ident" id="1437944">h</span>&nbsp;<span class="ident" id="1437946">extraHeader</span><span class="op" id="1437957">)</span>&nbsp;<span class="ident" id="1437959">Write</span><span class="op" id="1437964">(</span><span class="ident" id="1437965">w</span>&nbsp;<span class="op" id="1437967">*</span><span class="ident" id="1437968">bufio</span><span class="op" id="1437973">.</span><span class="ident" id="1437974">Writer</span><span class="op" id="1437980">)</span>&nbsp;<span class="op" id="1437982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437985">if</span>&nbsp;<span class="ident" id="1437988">h</span><span class="op" id="1437989">.</span><span class="ident" id="1437990">date</span>&nbsp;<span class="op" id="1437995">!=</span>&nbsp;<span class="ident" id="1437998">nil</span>&nbsp;<span class="op" id="1438002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438006">w</span><span class="op" id="1438007">.</span><span class="ident" id="1438008">Write</span><span class="op" id="1438013">(</span><span class="ident" id="1438014">headerDate</span><span class="op" id="1438024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438028">w</span><span class="op" id="1438029">.</span><span class="ident" id="1438030">Write</span><span class="op" id="1438035">(</span><span class="ident" id="1438036">h</span><span class="op" id="1438037">.</span><span class="ident" id="1438038">date</span><span class="op" id="1438042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438046">w</span><span class="op" id="1438047">.</span><span class="ident" id="1438048">Write</span><span class="op" id="1438053">(</span><span class="ident" id="1438054">crlf</span><span class="op" id="1438058">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438064">if</span>&nbsp;<span class="ident" id="1438067">h</span><span class="op" id="1438068">.</span><span class="ident" id="1438069">contentLength</span>&nbsp;<span class="op" id="1438083">!=</span>&nbsp;<span class="ident" id="1438086">nil</span>&nbsp;<span class="op" id="1438090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438094">w</span><span class="op" id="1438095">.</span><span class="ident" id="1438096">Write</span><span class="op" id="1438101">(</span><span class="ident" id="1438102">headerContentLength</span><span class="op" id="1438121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438125">w</span><span class="op" id="1438126">.</span><span class="ident" id="1438127">Write</span><span class="op" id="1438132">(</span><span class="ident" id="1438133">h</span><span class="op" id="1438134">.</span><span class="ident" id="1438135">contentLength</span><span class="op" id="1438148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438152">w</span><span class="op" id="1438153">.</span><span class="ident" id="1438154">Write</span><span class="op" id="1438159">(</span><span class="ident" id="1438160">crlf</span><span class="op" id="1438164">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438170">for</span>&nbsp;<span class="ident" id="1438174">i</span><span class="op" id="1438175">,</span>&nbsp;<span class="ident" id="1438177">v</span>&nbsp;<span class="op" id="1438179">:=</span>&nbsp;<span class="keyword" id="1438182">range</span>&nbsp;<span class="op" id="1438188">[</span><span class="op" id="1438189">]</span><span class="builtintype" id="1438190">string</span><span class="op" id="1438196">{</span><span class="ident" id="1438197">h</span><span class="op" id="1438198">.</span><span class="ident" id="1438199">contentType</span><span class="op" id="1438210">,</span>&nbsp;<span class="ident" id="1438212">h</span><span class="op" id="1438213">.</span><span class="ident" id="1438214">connection</span><span class="op" id="1438224">,</span>&nbsp;<span class="ident" id="1438226">h</span><span class="op" id="1438227">.</span><span class="ident" id="1438228">transferEncoding</span><span class="op" id="1438244">}</span>&nbsp;<span class="op" id="1438246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438250">if</span>&nbsp;<span class="ident" id="1438253">v</span>&nbsp;<span class="op" id="1438255">!=</span>&nbsp;<span class="string" id="1438258">&#34;&#34;</span>&nbsp;<span class="op" id="1438261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438266">w</span><span class="op" id="1438267">.</span><span class="ident" id="1438268">Write</span><span class="op" id="1438273">(</span><span class="ident" id="1438274">extraHeaderKeys</span><span class="op" id="1438289">[</span><span class="ident" id="1438290">i</span><span class="op" id="1438291">]</span><span class="op" id="1438292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438297">w</span><span class="op" id="1438298">.</span><span class="ident" id="1438299">Write</span><span class="op" id="1438304">(</span><span class="ident" id="1438305">colonSpace</span><span class="op" id="1438315">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438320">w</span><span class="op" id="1438321">.</span><span class="ident" id="1438322">WriteString</span><span class="op" id="1438333">(</span><span class="ident" id="1438334">v</span><span class="op" id="1438335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438340">w</span><span class="op" id="1438341">.</span><span class="ident" id="1438342">Write</span><span class="op" id="1438347">(</span><span class="ident" id="1438348">crlf</span><span class="op" id="1438352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438359">}</span><br>
<span class="lineno"></span><span class="op" id="1438361">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="1438364">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1438433">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="1438456">//</span><br>
<span class="lineno"></span><span class="comment" id="1438459">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="1438530">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1438600">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1438669">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="1438735">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="1438747">func</span>&nbsp;<span class="op" id="1438752">(</span><span class="ident" id="1438753">cw</span>&nbsp;<span class="op" id="1438756">*</span><span class="ident" id="1438757">chunkWriter</span><span class="op" id="1438768">)</span>&nbsp;<span class="ident" id="1438770">writeHeader</span><span class="op" id="1438781">(</span><span class="ident" id="1438782">p</span>&nbsp;<span class="op" id="1438784">[</span><span class="op" id="1438785">]</span><span class="builtintype" id="1438786">byte</span><span class="op" id="1438790">)</span>&nbsp;<span class="op" id="1438792">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438795">if</span>&nbsp;<span class="ident" id="1438798">cw</span><span class="op" id="1438800">.</span><span class="ident" id="1438801">wroteHeader</span>&nbsp;<span class="op" id="1438813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438817">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438828">cw</span><span class="op" id="1438830">.</span><span class="ident" id="1438831">wroteHeader</span>&nbsp;<span class="op" id="1438843">=</span>&nbsp;<span class="builtintype" id="1438845">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438852">w</span>&nbsp;<span class="op" id="1438854">:=</span>&nbsp;<span class="ident" id="1438857">cw</span><span class="op" id="1438859">.</span><span class="ident" id="1438860">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438865">keepAlivesEnabled</span>&nbsp;<span class="op" id="1438883">:=</span>&nbsp;<span class="ident" id="1438886">w</span><span class="op" id="1438887">.</span><span class="ident" id="1438888">conn</span><span class="op" id="1438892">.</span><span class="ident" id="1438893">server</span><span class="op" id="1438899">.</span><span class="ident" id="1438900">doKeepAlives</span><span class="op" id="1438912">(</span><span class="op" id="1438913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438916">isHEAD</span>&nbsp;<span class="op" id="1438923">:=</span>&nbsp;<span class="ident" id="1438926">w</span><span class="op" id="1438927">.</span><span class="ident" id="1438928">req</span><span class="op" id="1438931">.</span><span class="ident" id="1438932">Method</span>&nbsp;<span class="op" id="1438939">==</span>&nbsp;<span class="string" id="1438942">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438951">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439015">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439077">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439133">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439195">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439223">header</span>&nbsp;<span class="op" id="1439230">:=</span>&nbsp;<span class="ident" id="1439233">cw</span><span class="op" id="1439235">.</span><span class="ident" id="1439236">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439244">owned</span>&nbsp;<span class="op" id="1439250">:=</span>&nbsp;<span class="ident" id="1439253">header</span>&nbsp;<span class="op" id="1439260">!=</span>&nbsp;<span class="ident" id="1439263">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439268">if</span>&nbsp;<span class="op" id="1439271">!</span><span class="ident" id="1439272">owned</span>&nbsp;<span class="op" id="1439278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439282">header</span>&nbsp;<span class="op" id="1439289">=</span>&nbsp;<span class="ident" id="1439291">w</span><span class="op" id="1439292">.</span><span class="ident" id="1439293">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439311">var</span>&nbsp;<span class="ident" id="1439315">excludeHeader</span>&nbsp;<span class="keyword" id="1439329">map</span><span class="op" id="1439332">[</span><span class="builtintype" id="1439333">string</span><span class="op" id="1439339">]</span><span class="builtintype" id="1439340">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439346">delHeader</span>&nbsp;<span class="op" id="1439356">:=</span>&nbsp;<span class="keyword" id="1439359">func</span><span class="op" id="1439363">(</span><span class="ident" id="1439364">key</span>&nbsp;<span class="builtintype" id="1439368">string</span><span class="op" id="1439374">)</span>&nbsp;<span class="op" id="1439376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439380">if</span>&nbsp;<span class="ident" id="1439383">owned</span>&nbsp;<span class="op" id="1439389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439394">header</span><span class="op" id="1439400">.</span><span class="ident" id="1439401">Del</span><span class="op" id="1439404">(</span><span class="ident" id="1439405">key</span><span class="op" id="1439408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439413">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439422">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439426">if</span>&nbsp;<span class="ident" id="1439429">_</span><span class="op" id="1439430">,</span>&nbsp;<span class="ident" id="1439432">ok</span>&nbsp;<span class="op" id="1439435">:=</span>&nbsp;<span class="ident" id="1439438">header</span><span class="op" id="1439444">[</span><span class="ident" id="1439445">key</span><span class="op" id="1439448">]</span><span class="op" id="1439449">;</span>&nbsp;<span class="op" id="1439451">!</span><span class="ident" id="1439452">ok</span>&nbsp;<span class="op" id="1439455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439460">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439473">if</span>&nbsp;<span class="ident" id="1439476">excludeHeader</span>&nbsp;<span class="op" id="1439490">==</span>&nbsp;<span class="ident" id="1439493">nil</span>&nbsp;<span class="op" id="1439497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439502">excludeHeader</span>&nbsp;<span class="op" id="1439516">=</span>&nbsp;<span class="builtinfunc" id="1439518">make</span><span class="op" id="1439522">(</span><span class="keyword" id="1439523">map</span><span class="op" id="1439526">[</span><span class="builtintype" id="1439527">string</span><span class="op" id="1439533">]</span><span class="builtintype" id="1439534">bool</span><span class="op" id="1439538">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439546">excludeHeader</span><span class="op" id="1439559">[</span><span class="ident" id="1439560">key</span><span class="op" id="1439563">]</span>&nbsp;<span class="op" id="1439565">=</span>&nbsp;<span class="builtintype" id="1439567">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439576">var</span>&nbsp;<span class="ident" id="1439580">setHeader</span>&nbsp;<span class="ident" id="1439590">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439604">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439663">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439727">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439788">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439824">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439895">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439959">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440021">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440085">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440149">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440209">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440271">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440305">if</span>&nbsp;<span class="ident" id="1440308">w</span><span class="op" id="1440309">.</span><span class="ident" id="1440310">handlerDone</span>&nbsp;<span class="op" id="1440322">&amp;&amp;</span>&nbsp;<span class="ident" id="1440325">bodyAllowedForStatus</span><span class="op" id="1440345">(</span><span class="ident" id="1440346">w</span><span class="op" id="1440347">.</span><span class="ident" id="1440348">status</span><span class="op" id="1440354">)</span>&nbsp;<span class="op" id="1440356">&amp;&amp;</span>&nbsp;<span class="ident" id="1440359">header</span><span class="op" id="1440365">.</span><span class="ident" id="1440366">get</span><span class="op" id="1440369">(</span><span class="string" id="1440370">&#34;Content-Length&#34;</span><span class="op" id="1440386">)</span>&nbsp;<span class="op" id="1440388">==</span>&nbsp;<span class="string" id="1440391">&#34;&#34;</span>&nbsp;<span class="op" id="1440394">&amp;&amp;</span>&nbsp;<span class="op" id="1440397">(</span><span class="op" id="1440398">!</span><span class="ident" id="1440399">isHEAD</span>&nbsp;<span class="op" id="1440406">||</span>&nbsp;<span class="builtinfunc" id="1440409">len</span><span class="op" id="1440412">(</span><span class="ident" id="1440413">p</span><span class="op" id="1440414">)</span>&nbsp;<span class="op" id="1440416">&gt;</span>&nbsp;<span class="num" id="1440418">0</span><span class="op" id="1440419">)</span>&nbsp;<span class="op" id="1440421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440425">w</span><span class="op" id="1440426">.</span><span class="ident" id="1440427">contentLength</span>&nbsp;<span class="op" id="1440441">=</span>&nbsp;<span class="ident" id="1440443">int64</span><span class="op" id="1440448">(</span><span class="builtinfunc" id="1440449">len</span><span class="op" id="1440452">(</span><span class="ident" id="1440453">p</span><span class="op" id="1440454">)</span><span class="op" id="1440455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440459">setHeader</span><span class="op" id="1440468">.</span><span class="ident" id="1440469">contentLength</span>&nbsp;<span class="op" id="1440483">=</span>&nbsp;<span class="ident" id="1440485">strconv</span><span class="op" id="1440492">.</span><span class="ident" id="1440493">AppendInt</span><span class="op" id="1440502">(</span><span class="ident" id="1440503">cw</span><span class="op" id="1440505">.</span><span class="ident" id="1440506">res</span><span class="op" id="1440509">.</span><span class="ident" id="1440510">clenBuf</span><span class="op" id="1440517">[</span><span class="op" id="1440518">:</span><span class="num" id="1440519">0</span><span class="op" id="1440520">]</span><span class="op" id="1440521">,</span>&nbsp;<span class="ident" id="1440523">int64</span><span class="op" id="1440528">(</span><span class="builtinfunc" id="1440529">len</span><span class="op" id="1440532">(</span><span class="ident" id="1440533">p</span><span class="op" id="1440534">)</span><span class="op" id="1440535">)</span><span class="op" id="1440536">,</span>&nbsp;<span class="num" id="1440538">10</span><span class="op" id="1440540">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440547">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440613">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440681">if</span>&nbsp;<span class="ident" id="1440684">w</span><span class="op" id="1440685">.</span><span class="ident" id="1440686">req</span><span class="op" id="1440689">.</span><span class="ident" id="1440690">wantsHttp10KeepAlive</span><span class="op" id="1440710">(</span><span class="op" id="1440711">)</span>&nbsp;<span class="op" id="1440713">&amp;&amp;</span>&nbsp;<span class="ident" id="1440716">keepAlivesEnabled</span>&nbsp;<span class="op" id="1440734">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440738">sentLength</span>&nbsp;<span class="op" id="1440749">:=</span>&nbsp;<span class="ident" id="1440752">header</span><span class="op" id="1440758">.</span><span class="ident" id="1440759">get</span><span class="op" id="1440762">(</span><span class="string" id="1440763">&#34;Content-Length&#34;</span><span class="op" id="1440779">)</span>&nbsp;<span class="op" id="1440781">!=</span>&nbsp;<span class="string" id="1440784">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440789">if</span>&nbsp;<span class="ident" id="1440792">sentLength</span>&nbsp;<span class="op" id="1440803">&amp;&amp;</span>&nbsp;<span class="ident" id="1440806">header</span><span class="op" id="1440812">.</span><span class="ident" id="1440813">get</span><span class="op" id="1440816">(</span><span class="string" id="1440817">&#34;Connection&#34;</span><span class="op" id="1440829">)</span>&nbsp;<span class="op" id="1440831">==</span>&nbsp;<span class="string" id="1440834">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="1440847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440852">w</span><span class="op" id="1440853">.</span><span class="ident" id="1440854">closeAfterReply</span>&nbsp;<span class="op" id="1440870">=</span>&nbsp;<span class="builtintype" id="1440872">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440883">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440887">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440947">hasCL</span>&nbsp;<span class="op" id="1440953">:=</span>&nbsp;<span class="ident" id="1440956">w</span><span class="op" id="1440957">.</span><span class="ident" id="1440958">contentLength</span>&nbsp;<span class="op" id="1440972">!=</span>&nbsp;<span class="op" id="1440975">-</span><span class="num" id="1440976">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440980">if</span>&nbsp;<span class="ident" id="1440983">w</span><span class="op" id="1440984">.</span><span class="ident" id="1440985">req</span><span class="op" id="1440988">.</span><span class="ident" id="1440989">wantsHttp10KeepAlive</span><span class="op" id="1441009">(</span><span class="op" id="1441010">)</span>&nbsp;<span class="op" id="1441012">&amp;&amp;</span>&nbsp;<span class="op" id="1441015">(</span><span class="ident" id="1441016">isHEAD</span>&nbsp;<span class="op" id="1441023">||</span>&nbsp;<span class="ident" id="1441026">hasCL</span><span class="op" id="1441031">)</span>&nbsp;<span class="op" id="1441033">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441037">_</span><span class="op" id="1441038">,</span>&nbsp;<span class="ident" id="1441040">connectionHeaderSet</span>&nbsp;<span class="op" id="1441060">:=</span>&nbsp;<span class="ident" id="1441063">header</span><span class="op" id="1441069">[</span><span class="string" id="1441070">&#34;Connection&#34;</span><span class="op" id="1441082">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441086">if</span>&nbsp;<span class="op" id="1441089">!</span><span class="ident" id="1441090">connectionHeaderSet</span>&nbsp;<span class="op" id="1441110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441115">setHeader</span><span class="op" id="1441124">.</span><span class="ident" id="1441125">connection</span>&nbsp;<span class="op" id="1441136">=</span>&nbsp;<span class="string" id="1441138">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441156">}</span>&nbsp;<span class="keyword" id="1441158">else</span>&nbsp;<span class="keyword" id="1441163">if</span>&nbsp;<span class="op" id="1441166">!</span><span class="ident" id="1441167">w</span><span class="op" id="1441168">.</span><span class="ident" id="1441169">req</span><span class="op" id="1441172">.</span><span class="ident" id="1441173">ProtoAtLeast</span><span class="op" id="1441185">(</span><span class="num" id="1441186">1</span><span class="op" id="1441187">,</span>&nbsp;<span class="num" id="1441189">1</span><span class="op" id="1441190">)</span>&nbsp;<span class="op" id="1441192">||</span>&nbsp;<span class="ident" id="1441195">w</span><span class="op" id="1441196">.</span><span class="ident" id="1441197">req</span><span class="op" id="1441200">.</span><span class="ident" id="1441201">wantsClose</span><span class="op" id="1441211">(</span><span class="op" id="1441212">)</span>&nbsp;<span class="op" id="1441214">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441218">w</span><span class="op" id="1441219">.</span><span class="ident" id="1441220">closeAfterReply</span>&nbsp;<span class="op" id="1441236">=</span>&nbsp;<span class="builtintype" id="1441238">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441248">if</span>&nbsp;<span class="ident" id="1441251">header</span><span class="op" id="1441257">.</span><span class="ident" id="1441258">get</span><span class="op" id="1441261">(</span><span class="string" id="1441262">&#34;Connection&#34;</span><span class="op" id="1441274">)</span>&nbsp;<span class="op" id="1441276">==</span>&nbsp;<span class="string" id="1441279">&#34;close&#34;</span>&nbsp;<span class="op" id="1441287">||</span>&nbsp;<span class="op" id="1441290">!</span><span class="ident" id="1441291">keepAlivesEnabled</span>&nbsp;<span class="op" id="1441309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441313">w</span><span class="op" id="1441314">.</span><span class="ident" id="1441315">closeAfterReply</span>&nbsp;<span class="op" id="1441331">=</span>&nbsp;<span class="builtintype" id="1441333">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441343">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441403">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441464">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441525">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441576">if</span>&nbsp;<span class="ident" id="1441579">w</span><span class="op" id="1441580">.</span><span class="ident" id="1441581">req</span><span class="op" id="1441584">.</span><span class="ident" id="1441585">ContentLength</span>&nbsp;<span class="op" id="1441599">!=</span>&nbsp;<span class="num" id="1441602">0</span>&nbsp;<span class="op" id="1441604">&amp;&amp;</span>&nbsp;<span class="op" id="1441607">!</span><span class="ident" id="1441608">w</span><span class="op" id="1441609">.</span><span class="ident" id="1441610">closeAfterReply</span>&nbsp;<span class="op" id="1441626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441630">ecr</span><span class="op" id="1441633">,</span>&nbsp;<span class="ident" id="1441635">isExpecter</span>&nbsp;<span class="op" id="1441646">:=</span>&nbsp;<span class="ident" id="1441649">w</span><span class="op" id="1441650">.</span><span class="ident" id="1441651">req</span><span class="op" id="1441654">.</span><span class="ident" id="1441655">Body</span><span class="op" id="1441659">.</span><span class="op" id="1441660">(</span><span class="op" id="1441661">*</span><span class="ident" id="1441662">expectContinueReader</span><span class="op" id="1441682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441686">if</span>&nbsp;<span class="op" id="1441689">!</span><span class="ident" id="1441690">isExpecter</span>&nbsp;<span class="op" id="1441701">||</span>&nbsp;<span class="ident" id="1441704">ecr</span><span class="op" id="1441707">.</span><span class="ident" id="1441708">resp</span><span class="op" id="1441712">.</span><span class="ident" id="1441713">wroteContinue</span>&nbsp;<span class="op" id="1441727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441732">n</span><span class="op" id="1441733">,</span>&nbsp;<span class="ident" id="1441735">_</span>&nbsp;<span class="op" id="1441737">:=</span>&nbsp;<span class="ident" id="1441740">io</span><span class="op" id="1441742">.</span><span class="ident" id="1441743">CopyN</span><span class="op" id="1441748">(</span><span class="ident" id="1441749">ioutil</span><span class="op" id="1441755">.</span><span class="ident" id="1441756">Discard</span><span class="op" id="1441763">,</span>&nbsp;<span class="ident" id="1441765">w</span><span class="op" id="1441766">.</span><span class="ident" id="1441767">req</span><span class="op" id="1441770">.</span><span class="ident" id="1441771">Body</span><span class="op" id="1441775">,</span>&nbsp;<span class="ident" id="1441777">maxPostHandlerReadBytes</span><span class="op" id="1441800">+</span><span class="num" id="1441801">1</span><span class="op" id="1441802">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441807">if</span>&nbsp;<span class="ident" id="1441810">n</span>&nbsp;<span class="op" id="1441812">&gt;=</span>&nbsp;<span class="ident" id="1441815">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="1441839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441845">w</span><span class="op" id="1441846">.</span><span class="ident" id="1441847">requestTooLarge</span><span class="op" id="1441862">(</span><span class="op" id="1441863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441869">delHeader</span><span class="op" id="1441878">(</span><span class="string" id="1441879">&#34;Connection&#34;</span><span class="op" id="1441891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441897">setHeader</span><span class="op" id="1441906">.</span><span class="ident" id="1441907">connection</span>&nbsp;<span class="op" id="1441918">=</span>&nbsp;<span class="string" id="1441920">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441931">}</span>&nbsp;<span class="keyword" id="1441933">else</span>&nbsp;<span class="op" id="1441938">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441944">w</span><span class="op" id="1441945">.</span><span class="ident" id="1441946">req</span><span class="op" id="1441949">.</span><span class="ident" id="1441950">Body</span><span class="op" id="1441954">.</span><span class="ident" id="1441955">Close</span><span class="op" id="1441960">(</span><span class="op" id="1441961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441977">code</span>&nbsp;<span class="op" id="1441982">:=</span>&nbsp;<span class="ident" id="1441985">w</span><span class="op" id="1441986">.</span><span class="ident" id="1441987">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441995">if</span>&nbsp;<span class="ident" id="1441998">bodyAllowedForStatus</span><span class="op" id="1442018">(</span><span class="ident" id="1442019">code</span><span class="op" id="1442023">)</span>&nbsp;<span class="op" id="1442025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442029">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442088">_</span><span class="op" id="1442089">,</span>&nbsp;<span class="ident" id="1442091">haveType</span>&nbsp;<span class="op" id="1442100">:=</span>&nbsp;<span class="ident" id="1442103">header</span><span class="op" id="1442109">[</span><span class="string" id="1442110">&#34;Content-Type&#34;</span><span class="op" id="1442124">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442128">if</span>&nbsp;<span class="op" id="1442131">!</span><span class="ident" id="1442132">haveType</span>&nbsp;<span class="op" id="1442141">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442146">setHeader</span><span class="op" id="1442155">.</span><span class="ident" id="1442156">contentType</span>&nbsp;<span class="op" id="1442168">=</span>&nbsp;<span class="ident" id="1442170">DetectContentType</span><span class="op" id="1442187">(</span><span class="ident" id="1442188">p</span><span class="op" id="1442189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442196">}</span>&nbsp;<span class="keyword" id="1442198">else</span>&nbsp;<span class="op" id="1442203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442207">for</span>&nbsp;<span class="ident" id="1442211">_</span><span class="op" id="1442212">,</span>&nbsp;<span class="ident" id="1442214">k</span>&nbsp;<span class="op" id="1442216">:=</span>&nbsp;<span class="keyword" id="1442219">range</span>&nbsp;<span class="ident" id="1442225">suppressedHeaders</span><span class="op" id="1442242">(</span><span class="ident" id="1442243">code</span><span class="op" id="1442247">)</span>&nbsp;<span class="op" id="1442249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442254">delHeader</span><span class="op" id="1442263">(</span><span class="ident" id="1442264">k</span><span class="op" id="1442265">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442276">if</span>&nbsp;<span class="ident" id="1442279">_</span><span class="op" id="1442280">,</span>&nbsp;<span class="ident" id="1442282">ok</span>&nbsp;<span class="op" id="1442285">:=</span>&nbsp;<span class="ident" id="1442288">header</span><span class="op" id="1442294">[</span><span class="string" id="1442295">&#34;Date&#34;</span><span class="op" id="1442301">]</span><span class="op" id="1442302">;</span>&nbsp;<span class="op" id="1442304">!</span><span class="ident" id="1442305">ok</span>&nbsp;<span class="op" id="1442308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442312">setHeader</span><span class="op" id="1442321">.</span><span class="ident" id="1442322">date</span>&nbsp;<span class="op" id="1442327">=</span>&nbsp;<span class="ident" id="1442329">appendTime</span><span class="op" id="1442339">(</span><span class="ident" id="1442340">cw</span><span class="op" id="1442342">.</span><span class="ident" id="1442343">res</span><span class="op" id="1442346">.</span><span class="ident" id="1442347">dateBuf</span><span class="op" id="1442354">[</span><span class="op" id="1442355">:</span><span class="num" id="1442356">0</span><span class="op" id="1442357">]</span><span class="op" id="1442358">,</span>&nbsp;<span class="ident" id="1442360">time</span><span class="op" id="1442364">.</span><span class="ident" id="1442365">Now</span><span class="op" id="1442368">(</span><span class="op" id="1442369">)</span><span class="op" id="1442370">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442377">te</span>&nbsp;<span class="op" id="1442380">:=</span>&nbsp;<span class="ident" id="1442383">header</span><span class="op" id="1442389">.</span><span class="ident" id="1442390">get</span><span class="op" id="1442393">(</span><span class="string" id="1442394">&#34;Transfer-Encoding&#34;</span><span class="op" id="1442413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442416">hasTE</span>&nbsp;<span class="op" id="1442422">:=</span>&nbsp;<span class="ident" id="1442425">te</span>&nbsp;<span class="op" id="1442428">!=</span>&nbsp;<span class="string" id="1442431">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442435">if</span>&nbsp;<span class="ident" id="1442438">hasCL</span>&nbsp;<span class="op" id="1442444">&amp;&amp;</span>&nbsp;<span class="ident" id="1442447">hasTE</span>&nbsp;<span class="op" id="1442453">&amp;&amp;</span>&nbsp;<span class="ident" id="1442456">te</span>&nbsp;<span class="op" id="1442459">!=</span>&nbsp;<span class="string" id="1442462">&#34;identity&#34;</span>&nbsp;<span class="op" id="1442473">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442477">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442543">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442588">w</span><span class="op" id="1442589">.</span><span class="ident" id="1442590">conn</span><span class="op" id="1442594">.</span><span class="ident" id="1442595">server</span><span class="op" id="1442601">.</span><span class="ident" id="1442602">logf</span><span class="op" id="1442606">(</span><span class="string" id="1442607">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="1442694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442699">te</span><span class="op" id="1442701">,</span>&nbsp;<span class="ident" id="1442703">w</span><span class="op" id="1442704">.</span><span class="ident" id="1442705">contentLength</span><span class="op" id="1442718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442722">delHeader</span><span class="op" id="1442731">(</span><span class="string" id="1442732">&#34;Content-Length&#34;</span><span class="op" id="1442748">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442752">hasCL</span>&nbsp;<span class="op" id="1442758">=</span>&nbsp;<span class="builtintype" id="1442760">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442771">if</span>&nbsp;<span class="ident" id="1442774">w</span><span class="op" id="1442775">.</span><span class="ident" id="1442776">req</span><span class="op" id="1442779">.</span><span class="ident" id="1442780">Method</span>&nbsp;<span class="op" id="1442787">==</span>&nbsp;<span class="string" id="1442790">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1442797">||</span>&nbsp;<span class="op" id="1442800">!</span><span class="ident" id="1442801">bodyAllowedForStatus</span><span class="op" id="1442821">(</span><span class="ident" id="1442822">code</span><span class="op" id="1442826">)</span>&nbsp;<span class="op" id="1442828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442832">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442847">}</span>&nbsp;<span class="keyword" id="1442849">else</span>&nbsp;<span class="keyword" id="1442854">if</span>&nbsp;<span class="ident" id="1442857">code</span>&nbsp;<span class="op" id="1442862">==</span>&nbsp;<span class="ident" id="1442865">StatusNoContent</span>&nbsp;<span class="op" id="1442881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442885">delHeader</span><span class="op" id="1442894">(</span><span class="string" id="1442895">&#34;Transfer-Encoding&#34;</span><span class="op" id="1442914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442917">}</span>&nbsp;<span class="keyword" id="1442919">else</span>&nbsp;<span class="keyword" id="1442924">if</span>&nbsp;<span class="ident" id="1442927">hasCL</span>&nbsp;<span class="op" id="1442933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442937">delHeader</span><span class="op" id="1442946">(</span><span class="string" id="1442947">&#34;Transfer-Encoding&#34;</span><span class="op" id="1442966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442969">}</span>&nbsp;<span class="keyword" id="1442971">else</span>&nbsp;<span class="keyword" id="1442976">if</span>&nbsp;<span class="ident" id="1442979">w</span><span class="op" id="1442980">.</span><span class="ident" id="1442981">req</span><span class="op" id="1442984">.</span><span class="ident" id="1442985">ProtoAtLeast</span><span class="op" id="1442997">(</span><span class="num" id="1442998">1</span><span class="op" id="1442999">,</span>&nbsp;<span class="num" id="1443001">1</span><span class="op" id="1443002">)</span>&nbsp;<span class="op" id="1443004">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443008">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443086">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443165">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443237">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443309">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443325">if</span>&nbsp;<span class="ident" id="1443328">hasTE</span>&nbsp;<span class="op" id="1443334">&amp;&amp;</span>&nbsp;<span class="ident" id="1443337">te</span>&nbsp;<span class="op" id="1443340">==</span>&nbsp;<span class="string" id="1443343">&#34;identity&#34;</span>&nbsp;<span class="op" id="1443354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443359">cw</span><span class="op" id="1443361">.</span><span class="ident" id="1443362">chunking</span>&nbsp;<span class="op" id="1443371">=</span>&nbsp;<span class="builtintype" id="1443373">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443382">w</span><span class="op" id="1443383">.</span><span class="ident" id="1443384">closeAfterReply</span>&nbsp;<span class="op" id="1443400">=</span>&nbsp;<span class="builtintype" id="1443402">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443409">}</span>&nbsp;<span class="keyword" id="1443411">else</span>&nbsp;<span class="op" id="1443416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443421">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443478">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443524">cw</span><span class="op" id="1443526">.</span><span class="ident" id="1443527">chunking</span>&nbsp;<span class="op" id="1443536">=</span>&nbsp;<span class="builtintype" id="1443538">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443546">setHeader</span><span class="op" id="1443555">.</span><span class="ident" id="1443556">transferEncoding</span>&nbsp;<span class="op" id="1443573">=</span>&nbsp;<span class="string" id="1443575">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443590">}</span>&nbsp;<span class="keyword" id="1443592">else</span>&nbsp;<span class="op" id="1443597">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443601">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443653">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443707">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443746">w</span><span class="op" id="1443747">.</span><span class="ident" id="1443748">closeAfterReply</span>&nbsp;<span class="op" id="1443764">=</span>&nbsp;<span class="builtintype" id="1443766">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443773">delHeader</span><span class="op" id="1443782">(</span><span class="string" id="1443783">&#34;Transfer-Encoding&#34;</span><span class="op" id="1443802">)</span>&nbsp;<span class="comment" id="1443804">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443832">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443899">if</span>&nbsp;<span class="ident" id="1443902">cw</span><span class="op" id="1443904">.</span><span class="ident" id="1443905">chunking</span>&nbsp;<span class="op" id="1443914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443918">delHeader</span><span class="op" id="1443927">(</span><span class="string" id="1443928">&#34;Content-Length&#34;</span><span class="op" id="1443944">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443950">if</span>&nbsp;<span class="op" id="1443953">!</span><span class="ident" id="1443954">w</span><span class="op" id="1443955">.</span><span class="ident" id="1443956">req</span><span class="op" id="1443959">.</span><span class="ident" id="1443960">ProtoAtLeast</span><span class="op" id="1443972">(</span><span class="num" id="1443973">1</span><span class="op" id="1443974">,</span>&nbsp;<span class="num" id="1443976">0</span><span class="op" id="1443977">)</span>&nbsp;<span class="op" id="1443979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443983">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443995">if</span>&nbsp;<span class="ident" id="1443998">w</span><span class="op" id="1443999">.</span><span class="ident" id="1444000">closeAfterReply</span>&nbsp;<span class="op" id="1444016">&amp;&amp;</span>&nbsp;<span class="op" id="1444019">(</span><span class="op" id="1444020">!</span><span class="ident" id="1444021">keepAlivesEnabled</span>&nbsp;<span class="op" id="1444039">||</span>&nbsp;<span class="op" id="1444042">!</span><span class="ident" id="1444043">hasToken</span><span class="op" id="1444051">(</span><span class="ident" id="1444052">cw</span><span class="op" id="1444054">.</span><span class="ident" id="1444055">header</span><span class="op" id="1444061">.</span><span class="ident" id="1444062">get</span><span class="op" id="1444065">(</span><span class="string" id="1444066">&#34;Connection&#34;</span><span class="op" id="1444078">)</span><span class="op" id="1444079">,</span>&nbsp;<span class="string" id="1444081">&#34;close&#34;</span><span class="op" id="1444088">)</span><span class="op" id="1444089">)</span>&nbsp;<span class="op" id="1444091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444095">delHeader</span><span class="op" id="1444104">(</span><span class="string" id="1444105">&#34;Connection&#34;</span><span class="op" id="1444117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444121">if</span>&nbsp;<span class="ident" id="1444124">w</span><span class="op" id="1444125">.</span><span class="ident" id="1444126">req</span><span class="op" id="1444129">.</span><span class="ident" id="1444130">ProtoAtLeast</span><span class="op" id="1444142">(</span><span class="num" id="1444143">1</span><span class="op" id="1444144">,</span>&nbsp;<span class="num" id="1444146">1</span><span class="op" id="1444147">)</span>&nbsp;<span class="op" id="1444149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444154">setHeader</span><span class="op" id="1444163">.</span><span class="ident" id="1444164">connection</span>&nbsp;<span class="op" id="1444175">=</span>&nbsp;<span class="string" id="1444177">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444187">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444194">w</span><span class="op" id="1444195">.</span><span class="ident" id="1444196">conn</span><span class="op" id="1444200">.</span><span class="ident" id="1444201">buf</span><span class="op" id="1444204">.</span><span class="ident" id="1444205">WriteString</span><span class="op" id="1444216">(</span><span class="ident" id="1444217">statusLine</span><span class="op" id="1444227">(</span><span class="ident" id="1444228">w</span><span class="op" id="1444229">.</span><span class="ident" id="1444230">req</span><span class="op" id="1444233">,</span>&nbsp;<span class="ident" id="1444235">code</span><span class="op" id="1444239">)</span><span class="op" id="1444240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444243">cw</span><span class="op" id="1444245">.</span><span class="ident" id="1444246">header</span><span class="op" id="1444252">.</span><span class="ident" id="1444253">WriteSubset</span><span class="op" id="1444264">(</span><span class="ident" id="1444265">w</span><span class="op" id="1444266">.</span><span class="ident" id="1444267">conn</span><span class="op" id="1444271">.</span><span class="ident" id="1444272">buf</span><span class="op" id="1444275">,</span>&nbsp;<span class="ident" id="1444277">excludeHeader</span><span class="op" id="1444290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444293">setHeader</span><span class="op" id="1444302">.</span><span class="ident" id="1444303">Write</span><span class="op" id="1444308">(</span><span class="ident" id="1444309">w</span><span class="op" id="1444310">.</span><span class="ident" id="1444311">conn</span><span class="op" id="1444315">.</span><span class="ident" id="1444316">buf</span><span class="op" id="1444319">.</span><span class="ident" id="1444320">Writer</span><span class="op" id="1444326">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444329">w</span><span class="op" id="1444330">.</span><span class="ident" id="1444331">conn</span><span class="op" id="1444335">.</span><span class="ident" id="1444336">buf</span><span class="op" id="1444339">.</span><span class="ident" id="1444340">Write</span><span class="op" id="1444345">(</span><span class="ident" id="1444346">crlf</span><span class="op" id="1444350">)</span><br>
<span class="lineno"></span><span class="op" id="1444352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1444355">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="1444424">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="1444492">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="1444561">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="1444629">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1444667">var</span>&nbsp;<span class="op" id="1444671">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444674">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444686">sync</span><span class="op" id="1444690">.</span><span class="ident" id="1444691">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444700">statusLines</span>&nbsp;<span class="op" id="1444712">=</span>&nbsp;<span class="builtinfunc" id="1444714">make</span><span class="op" id="1444718">(</span><span class="keyword" id="1444719">map</span><span class="op" id="1444722">[</span><span class="builtintype" id="1444723">int</span><span class="op" id="1444726">]</span><span class="builtintype" id="1444727">string</span><span class="op" id="1444733">)</span><br>
<span class="lineno"></span><span class="op" id="1444735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1444738">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="1444806">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="1444857">func</span>&nbsp;<span class="ident" id="1444862">statusLine</span><span class="op" id="1444872">(</span><span class="ident" id="1444873">req</span>&nbsp;<span class="op" id="1444877">*</span><span class="ident" id="1444878">Request</span><span class="op" id="1444885">,</span>&nbsp;<span class="ident" id="1444887">code</span>&nbsp;<span class="builtintype" id="1444892">int</span><span class="op" id="1444895">)</span>&nbsp;<span class="builtintype" id="1444897">string</span>&nbsp;<span class="op" id="1444904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444907">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444922">key</span>&nbsp;<span class="op" id="1444926">:=</span>&nbsp;<span class="ident" id="1444929">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444935">proto11</span>&nbsp;<span class="op" id="1444943">:=</span>&nbsp;<span class="ident" id="1444946">req</span><span class="op" id="1444949">.</span><span class="ident" id="1444950">ProtoAtLeast</span><span class="op" id="1444962">(</span><span class="num" id="1444963">1</span><span class="op" id="1444964">,</span>&nbsp;<span class="num" id="1444966">1</span><span class="op" id="1444967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444970">if</span>&nbsp;<span class="op" id="1444973">!</span><span class="ident" id="1444974">proto11</span>&nbsp;<span class="op" id="1444982">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444986">key</span>&nbsp;<span class="op" id="1444990">=</span>&nbsp;<span class="op" id="1444992">-</span><span class="ident" id="1444993">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445001">statusMu</span><span class="op" id="1445009">.</span><span class="ident" id="1445010">RLock</span><span class="op" id="1445015">(</span><span class="op" id="1445016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445019">line</span><span class="op" id="1445023">,</span>&nbsp;<span class="ident" id="1445025">ok</span>&nbsp;<span class="op" id="1445028">:=</span>&nbsp;<span class="ident" id="1445031">statusLines</span><span class="op" id="1445042">[</span><span class="ident" id="1445043">key</span><span class="op" id="1445046">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445049">statusMu</span><span class="op" id="1445057">.</span><span class="ident" id="1445058">RUnlock</span><span class="op" id="1445065">(</span><span class="op" id="1445066">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445069">if</span>&nbsp;<span class="ident" id="1445072">ok</span>&nbsp;<span class="op" id="1445075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445079">return</span>&nbsp;<span class="ident" id="1445086">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445096">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445111">proto</span>&nbsp;<span class="op" id="1445117">:=</span>&nbsp;<span class="string" id="1445120">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445132">if</span>&nbsp;<span class="ident" id="1445135">proto11</span>&nbsp;<span class="op" id="1445143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445147">proto</span>&nbsp;<span class="op" id="1445153">=</span>&nbsp;<span class="string" id="1445155">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445170">codestring</span>&nbsp;<span class="op" id="1445181">:=</span>&nbsp;<span class="ident" id="1445184">strconv</span><span class="op" id="1445191">.</span><span class="ident" id="1445192">Itoa</span><span class="op" id="1445196">(</span><span class="ident" id="1445197">code</span><span class="op" id="1445201">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445204">text</span><span class="op" id="1445208">,</span>&nbsp;<span class="ident" id="1445210">ok</span>&nbsp;<span class="op" id="1445213">:=</span>&nbsp;<span class="ident" id="1445216">statusText</span><span class="op" id="1445226">[</span><span class="ident" id="1445227">code</span><span class="op" id="1445231">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445234">if</span>&nbsp;<span class="op" id="1445237">!</span><span class="ident" id="1445238">ok</span>&nbsp;<span class="op" id="1445241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445245">text</span>&nbsp;<span class="op" id="1445250">=</span>&nbsp;<span class="string" id="1445252">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="1445267">+</span>&nbsp;<span class="ident" id="1445269">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445284">line</span>&nbsp;<span class="op" id="1445289">=</span>&nbsp;<span class="ident" id="1445291">proto</span>&nbsp;<span class="op" id="1445297">+</span>&nbsp;<span class="string" id="1445299">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="1445303">+</span>&nbsp;<span class="ident" id="1445305">codestring</span>&nbsp;<span class="op" id="1445316">+</span>&nbsp;<span class="string" id="1445318">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="1445322">+</span>&nbsp;<span class="ident" id="1445324">text</span>&nbsp;<span class="op" id="1445329">+</span>&nbsp;<span class="string" id="1445331">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445339">if</span>&nbsp;<span class="ident" id="1445342">ok</span>&nbsp;<span class="op" id="1445345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445349">statusMu</span><span class="op" id="1445357">.</span><span class="ident" id="1445358">Lock</span><span class="op" id="1445362">(</span><span class="op" id="1445363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445367">defer</span>&nbsp;<span class="ident" id="1445373">statusMu</span><span class="op" id="1445381">.</span><span class="ident" id="1445382">Unlock</span><span class="op" id="1445388">(</span><span class="op" id="1445389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445393">statusLines</span><span class="op" id="1445404">[</span><span class="ident" id="1445405">key</span><span class="op" id="1445408">]</span>&nbsp;<span class="op" id="1445410">=</span>&nbsp;<span class="ident" id="1445412">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445418">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445421">return</span>&nbsp;<span class="ident" id="1445428">line</span><br>
<span class="lineno"></span><span class="op" id="1445433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1445436">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1445510">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="1445575">func</span>&nbsp;<span class="op" id="1445580">(</span><span class="ident" id="1445581">w</span>&nbsp;<span class="op" id="1445583">*</span><span class="ident" id="1445584">response</span><span class="op" id="1445592">)</span>&nbsp;<span class="ident" id="1445594">bodyAllowed</span><span class="op" id="1445605">(</span><span class="op" id="1445606">)</span>&nbsp;<span class="builtintype" id="1445608">bool</span>&nbsp;<span class="op" id="1445613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445616">if</span>&nbsp;<span class="op" id="1445619">!</span><span class="ident" id="1445620">w</span><span class="op" id="1445621">.</span><span class="ident" id="1445622">wroteHeader</span>&nbsp;<span class="op" id="1445634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1445638">panic</span><span class="op" id="1445643">(</span><span class="string" id="1445644">&#34;&#34;</span><span class="op" id="1445646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445652">return</span>&nbsp;<span class="ident" id="1445659">bodyAllowedForStatus</span><span class="op" id="1445679">(</span><span class="ident" id="1445680">w</span><span class="op" id="1445681">.</span><span class="ident" id="1445682">status</span><span class="op" id="1445688">)</span><br>
<span class="lineno">940</span><span class="op" id="1445690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1445693">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="1445730">//</span><br>
<span class="lineno"></span><span class="comment" id="1445733">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="1445800">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="1445875">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="1445919">//</span><br>
<span class="lineno"></span><span class="comment" id="1445922">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="1445992">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="1446060">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1446131">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="1446157">//</span><br>
<span class="lineno"></span><span class="comment" id="1446160">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1446229">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="1446266">//</span><br>
<span class="lineno"></span><span class="comment" id="1446269">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="1446309">//</span><br>
<span class="lineno"></span><span class="comment" id="1446312">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="1446352">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="1446423">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="1446498">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="1446551">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="1446620">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="1446690">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="1446757">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="1446786">//</span><br>
<span class="lineno"></span><span class="comment" id="1446789">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1446853">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="1446920">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="1446988">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1447053">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1447123">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="1447192">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="1447263">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="1447334">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="1447356">func</span>&nbsp;<span class="op" id="1447361">(</span><span class="ident" id="1447362">w</span>&nbsp;<span class="op" id="1447364">*</span><span class="ident" id="1447365">response</span><span class="op" id="1447373">)</span>&nbsp;<span class="ident" id="1447375">Write</span><span class="op" id="1447380">(</span><span class="ident" id="1447381">data</span>&nbsp;<span class="op" id="1447386">[</span><span class="op" id="1447387">]</span><span class="builtintype" id="1447388">byte</span><span class="op" id="1447392">)</span>&nbsp;<span class="op" id="1447394">(</span><span class="ident" id="1447395">n</span>&nbsp;<span class="builtintype" id="1447397">int</span><span class="op" id="1447400">,</span>&nbsp;<span class="ident" id="1447402">err</span>&nbsp;<span class="builtintype" id="1447406">error</span><span class="op" id="1447411">)</span>&nbsp;<span class="op" id="1447413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447416">return</span>&nbsp;<span class="ident" id="1447423">w</span><span class="op" id="1447424">.</span><span class="ident" id="1447425">write</span><span class="op" id="1447430">(</span><span class="builtinfunc" id="1447431">len</span><span class="op" id="1447434">(</span><span class="ident" id="1447435">data</span><span class="op" id="1447439">)</span><span class="op" id="1447440">,</span>&nbsp;<span class="ident" id="1447442">data</span><span class="op" id="1447446">,</span>&nbsp;<span class="string" id="1447448">&#34;&#34;</span><span class="op" id="1447450">)</span><br>
<span class="lineno"></span><span class="op" id="1447452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="1447455">func</span>&nbsp;<span class="op" id="1447460">(</span><span class="ident" id="1447461">w</span>&nbsp;<span class="op" id="1447463">*</span><span class="ident" id="1447464">response</span><span class="op" id="1447472">)</span>&nbsp;<span class="ident" id="1447474">WriteString</span><span class="op" id="1447485">(</span><span class="ident" id="1447486">data</span>&nbsp;<span class="builtintype" id="1447491">string</span><span class="op" id="1447497">)</span>&nbsp;<span class="op" id="1447499">(</span><span class="ident" id="1447500">n</span>&nbsp;<span class="builtintype" id="1447502">int</span><span class="op" id="1447505">,</span>&nbsp;<span class="ident" id="1447507">err</span>&nbsp;<span class="builtintype" id="1447511">error</span><span class="op" id="1447516">)</span>&nbsp;<span class="op" id="1447518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447521">return</span>&nbsp;<span class="ident" id="1447528">w</span><span class="op" id="1447529">.</span><span class="ident" id="1447530">write</span><span class="op" id="1447535">(</span><span class="builtinfunc" id="1447536">len</span><span class="op" id="1447539">(</span><span class="ident" id="1447540">data</span><span class="op" id="1447544">)</span><span class="op" id="1447545">,</span>&nbsp;<span class="ident" id="1447547">nil</span><span class="op" id="1447550">,</span>&nbsp;<span class="ident" id="1447552">data</span><span class="op" id="1447556">)</span><br>
<span class="lineno"></span><span class="op" id="1447558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1447561">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="1447599">func</span>&nbsp;<span class="op" id="1447604">(</span><span class="ident" id="1447605">w</span>&nbsp;<span class="op" id="1447607">*</span><span class="ident" id="1447608">response</span><span class="op" id="1447616">)</span>&nbsp;<span class="ident" id="1447618">write</span><span class="op" id="1447623">(</span><span class="ident" id="1447624">lenData</span>&nbsp;<span class="builtintype" id="1447632">int</span><span class="op" id="1447635">,</span>&nbsp;<span class="ident" id="1447637">dataB</span>&nbsp;<span class="op" id="1447643">[</span><span class="op" id="1447644">]</span><span class="builtintype" id="1447645">byte</span><span class="op" id="1447649">,</span>&nbsp;<span class="ident" id="1447651">dataS</span>&nbsp;<span class="builtintype" id="1447657">string</span><span class="op" id="1447663">)</span>&nbsp;<span class="op" id="1447665">(</span><span class="ident" id="1447666">n</span>&nbsp;<span class="builtintype" id="1447668">int</span><span class="op" id="1447671">,</span>&nbsp;<span class="ident" id="1447673">err</span>&nbsp;<span class="builtintype" id="1447677">error</span><span class="op" id="1447682">)</span>&nbsp;<span class="op" id="1447684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447687">if</span>&nbsp;<span class="ident" id="1447690">w</span><span class="op" id="1447691">.</span><span class="ident" id="1447692">conn</span><span class="op" id="1447696">.</span><span class="ident" id="1447697">hijacked</span><span class="op" id="1447705">(</span><span class="op" id="1447706">)</span>&nbsp;<span class="op" id="1447708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447712">w</span><span class="op" id="1447713">.</span><span class="ident" id="1447714">conn</span><span class="op" id="1447718">.</span><span class="ident" id="1447719">server</span><span class="op" id="1447725">.</span><span class="ident" id="1447726">logf</span><span class="op" id="1447730">(</span><span class="string" id="1447731">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="1447776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447780">return</span>&nbsp;<span class="num" id="1447787">0</span><span class="op" id="1447788">,</span>&nbsp;<span class="ident" id="1447790">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447803">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447806">if</span>&nbsp;<span class="op" id="1447809">!</span><span class="ident" id="1447810">w</span><span class="op" id="1447811">.</span><span class="ident" id="1447812">wroteHeader</span>&nbsp;<span class="op" id="1447824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447828">w</span><span class="op" id="1447829">.</span><span class="ident" id="1447830">WriteHeader</span><span class="op" id="1447841">(</span><span class="ident" id="1447842">StatusOK</span><span class="op" id="1447850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447856">if</span>&nbsp;<span class="ident" id="1447859">lenData</span>&nbsp;<span class="op" id="1447867">==</span>&nbsp;<span class="num" id="1447870">0</span>&nbsp;<span class="op" id="1447872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447876">return</span>&nbsp;<span class="num" id="1447883">0</span><span class="op" id="1447884">,</span>&nbsp;<span class="ident" id="1447886">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447894">if</span>&nbsp;<span class="op" id="1447897">!</span><span class="ident" id="1447898">w</span><span class="op" id="1447899">.</span><span class="ident" id="1447900">bodyAllowed</span><span class="op" id="1447911">(</span><span class="op" id="1447912">)</span>&nbsp;<span class="op" id="1447914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447918">return</span>&nbsp;<span class="num" id="1447925">0</span><span class="op" id="1447926">,</span>&nbsp;<span class="ident" id="1447928">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447951">w</span><span class="op" id="1447952">.</span><span class="ident" id="1447953">written</span>&nbsp;<span class="op" id="1447961">+=</span>&nbsp;<span class="ident" id="1447964">int64</span><span class="op" id="1447969">(</span><span class="ident" id="1447970">lenData</span><span class="op" id="1447977">)</span>&nbsp;<span class="comment" id="1447979">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448016">if</span>&nbsp;<span class="ident" id="1448019">w</span><span class="op" id="1448020">.</span><span class="ident" id="1448021">contentLength</span>&nbsp;<span class="op" id="1448035">!=</span>&nbsp;<span class="op" id="1448038">-</span><span class="num" id="1448039">1</span>&nbsp;<span class="op" id="1448041">&amp;&amp;</span>&nbsp;<span class="ident" id="1448044">w</span><span class="op" id="1448045">.</span><span class="ident" id="1448046">written</span>&nbsp;<span class="op" id="1448054">&gt;</span>&nbsp;<span class="ident" id="1448056">w</span><span class="op" id="1448057">.</span><span class="ident" id="1448058">contentLength</span>&nbsp;<span class="op" id="1448072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448076">return</span>&nbsp;<span class="num" id="1448083">0</span><span class="op" id="1448084">,</span>&nbsp;<span class="ident" id="1448086">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448107">if</span>&nbsp;<span class="ident" id="1448110">dataB</span>&nbsp;<span class="op" id="1448116">!=</span>&nbsp;<span class="ident" id="1448119">nil</span>&nbsp;<span class="op" id="1448123">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448127">return</span>&nbsp;<span class="ident" id="1448134">w</span><span class="op" id="1448135">.</span><span class="ident" id="1448136">w</span><span class="op" id="1448137">.</span><span class="ident" id="1448138">Write</span><span class="op" id="1448143">(</span><span class="ident" id="1448144">dataB</span><span class="op" id="1448149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448152">}</span>&nbsp;<span class="keyword" id="1448154">else</span>&nbsp;<span class="op" id="1448159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448163">return</span>&nbsp;<span class="ident" id="1448170">w</span><span class="op" id="1448171">.</span><span class="ident" id="1448172">w</span><span class="op" id="1448173">.</span><span class="ident" id="1448174">WriteString</span><span class="op" id="1448185">(</span><span class="ident" id="1448186">dataS</span><span class="op" id="1448191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448194">}</span><br>
<span class="lineno"></span><span class="op" id="1448196">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="1448199">func</span>&nbsp;<span class="op" id="1448204">(</span><span class="ident" id="1448205">w</span>&nbsp;<span class="op" id="1448207">*</span><span class="ident" id="1448208">response</span><span class="op" id="1448216">)</span>&nbsp;<span class="ident" id="1448218">finishRequest</span><span class="op" id="1448231">(</span><span class="op" id="1448232">)</span>&nbsp;<span class="op" id="1448234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448237">w</span><span class="op" id="1448238">.</span><span class="ident" id="1448239">handlerDone</span>&nbsp;<span class="op" id="1448251">=</span>&nbsp;<span class="builtintype" id="1448253">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448260">if</span>&nbsp;<span class="op" id="1448263">!</span><span class="ident" id="1448264">w</span><span class="op" id="1448265">.</span><span class="ident" id="1448266">wroteHeader</span>&nbsp;<span class="op" id="1448278">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448282">w</span><span class="op" id="1448283">.</span><span class="ident" id="1448284">WriteHeader</span><span class="op" id="1448295">(</span><span class="ident" id="1448296">StatusOK</span><span class="op" id="1448304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448311">w</span><span class="op" id="1448312">.</span><span class="ident" id="1448313">w</span><span class="op" id="1448314">.</span><span class="ident" id="1448315">Flush</span><span class="op" id="1448320">(</span><span class="op" id="1448321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448324">putBufioWriter</span><span class="op" id="1448338">(</span><span class="ident" id="1448339">w</span><span class="op" id="1448340">.</span><span class="ident" id="1448341">w</span><span class="op" id="1448342">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448345">w</span><span class="op" id="1448346">.</span><span class="ident" id="1448347">cw</span><span class="op" id="1448349">.</span><span class="builtinfunc" id="1448350">close</span><span class="op" id="1448355">(</span><span class="op" id="1448356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448359">w</span><span class="op" id="1448360">.</span><span class="ident" id="1448361">conn</span><span class="op" id="1448365">.</span><span class="ident" id="1448366">buf</span><span class="op" id="1448369">.</span><span class="ident" id="1448370">Flush</span><span class="op" id="1448375">(</span><span class="op" id="1448376">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448380">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448443">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448485">w</span><span class="op" id="1448486">.</span><span class="ident" id="1448487">req</span><span class="op" id="1448490">.</span><span class="ident" id="1448491">Body</span><span class="op" id="1448495">.</span><span class="ident" id="1448496">Close</span><span class="op" id="1448501">(</span><span class="op" id="1448502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448506">if</span>&nbsp;<span class="ident" id="1448509">w</span><span class="op" id="1448510">.</span><span class="ident" id="1448511">req</span><span class="op" id="1448514">.</span><span class="ident" id="1448515">MultipartForm</span>&nbsp;<span class="op" id="1448529">!=</span>&nbsp;<span class="ident" id="1448532">nil</span>&nbsp;<span class="op" id="1448536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448540">w</span><span class="op" id="1448541">.</span><span class="ident" id="1448542">req</span><span class="op" id="1448545">.</span><span class="ident" id="1448546">MultipartForm</span><span class="op" id="1448559">.</span><span class="ident" id="1448560">RemoveAll</span><span class="op" id="1448569">(</span><span class="op" id="1448570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448573">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448577">if</span>&nbsp;<span class="ident" id="1448580">w</span><span class="op" id="1448581">.</span><span class="ident" id="1448582">req</span><span class="op" id="1448585">.</span><span class="ident" id="1448586">Method</span>&nbsp;<span class="op" id="1448593">!=</span>&nbsp;<span class="string" id="1448596">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1448603">&amp;&amp;</span>&nbsp;<span class="ident" id="1448606">w</span><span class="op" id="1448607">.</span><span class="ident" id="1448608">contentLength</span>&nbsp;<span class="op" id="1448622">!=</span>&nbsp;<span class="op" id="1448625">-</span><span class="num" id="1448626">1</span>&nbsp;<span class="op" id="1448628">&amp;&amp;</span>&nbsp;<span class="ident" id="1448631">w</span><span class="op" id="1448632">.</span><span class="ident" id="1448633">bodyAllowed</span><span class="op" id="1448644">(</span><span class="op" id="1448645">)</span>&nbsp;<span class="op" id="1448647">&amp;&amp;</span>&nbsp;<span class="ident" id="1448650">w</span><span class="op" id="1448651">.</span><span class="ident" id="1448652">contentLength</span>&nbsp;<span class="op" id="1448666">!=</span>&nbsp;<span class="ident" id="1448669">w</span><span class="op" id="1448670">.</span><span class="ident" id="1448671">written</span>&nbsp;<span class="op" id="1448679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448683">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448737">w</span><span class="op" id="1448738">.</span><span class="ident" id="1448739">closeAfterReply</span>&nbsp;<span class="op" id="1448755">=</span>&nbsp;<span class="builtintype" id="1448757">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448763">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448767">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448829">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448880">if</span>&nbsp;<span class="ident" id="1448883">w</span><span class="op" id="1448884">.</span><span class="ident" id="1448885">conn</span><span class="op" id="1448889">.</span><span class="ident" id="1448890">werr</span>&nbsp;<span class="op" id="1448895">!=</span>&nbsp;<span class="ident" id="1448898">nil</span>&nbsp;<span class="op" id="1448902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448906">w</span><span class="op" id="1448907">.</span><span class="ident" id="1448908">closeAfterReply</span>&nbsp;<span class="op" id="1448924">=</span>&nbsp;<span class="builtintype" id="1448926">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448932">}</span><br>
<span class="lineno"></span><span class="op" id="1448934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1448937">func</span>&nbsp;<span class="op" id="1448942">(</span><span class="ident" id="1448943">w</span>&nbsp;<span class="op" id="1448945">*</span><span class="ident" id="1448946">response</span><span class="op" id="1448954">)</span>&nbsp;<span class="ident" id="1448956">Flush</span><span class="op" id="1448961">(</span><span class="op" id="1448962">)</span>&nbsp;<span class="op" id="1448964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448967">if</span>&nbsp;<span class="op" id="1448970">!</span><span class="ident" id="1448971">w</span><span class="op" id="1448972">.</span><span class="ident" id="1448973">wroteHeader</span>&nbsp;<span class="op" id="1448985">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448989">w</span><span class="op" id="1448990">.</span><span class="ident" id="1448991">WriteHeader</span><span class="op" id="1449002">(</span><span class="ident" id="1449003">StatusOK</span><span class="op" id="1449011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449017">w</span><span class="op" id="1449018">.</span><span class="ident" id="1449019">w</span><span class="op" id="1449020">.</span><span class="ident" id="1449021">Flush</span><span class="op" id="1449026">(</span><span class="op" id="1449027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449030">w</span><span class="op" id="1449031">.</span><span class="ident" id="1449032">cw</span><span class="op" id="1449034">.</span><span class="ident" id="1449035">flush</span><span class="op" id="1449040">(</span><span class="op" id="1449041">)</span><br>
<span class="lineno"></span><span class="op" id="1449043">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="1449046">func</span>&nbsp;<span class="op" id="1449051">(</span><span class="ident" id="1449052">c</span>&nbsp;<span class="op" id="1449054">*</span><span class="ident" id="1449055">conn</span><span class="op" id="1449059">)</span>&nbsp;<span class="ident" id="1449061">finalFlush</span><span class="op" id="1449071">(</span><span class="op" id="1449072">)</span>&nbsp;<span class="op" id="1449074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449077">if</span>&nbsp;<span class="ident" id="1449080">c</span><span class="op" id="1449081">.</span><span class="ident" id="1449082">buf</span>&nbsp;<span class="op" id="1449086">!=</span>&nbsp;<span class="ident" id="1449089">nil</span>&nbsp;<span class="op" id="1449093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449097">c</span><span class="op" id="1449098">.</span><span class="ident" id="1449099">buf</span><span class="op" id="1449102">.</span><span class="ident" id="1449103">Flush</span><span class="op" id="1449108">(</span><span class="op" id="1449109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449114">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449184">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449221">putBufioReader</span><span class="op" id="1449235">(</span><span class="ident" id="1449236">c</span><span class="op" id="1449237">.</span><span class="ident" id="1449238">buf</span><span class="op" id="1449241">.</span><span class="ident" id="1449242">Reader</span><span class="op" id="1449248">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449253">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449323">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449360">putBufioWriter</span><span class="op" id="1449374">(</span><span class="ident" id="1449375">c</span><span class="op" id="1449376">.</span><span class="ident" id="1449377">buf</span><span class="op" id="1449380">.</span><span class="ident" id="1449381">Writer</span><span class="op" id="1449387">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449392">c</span><span class="op" id="1449393">.</span><span class="ident" id="1449394">buf</span>&nbsp;<span class="op" id="1449398">=</span>&nbsp;<span class="ident" id="1449400">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449405">}</span><br>
<span class="lineno">1065</span><span class="op" id="1449407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1449410">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="1449435">func</span>&nbsp;<span class="op" id="1449440">(</span><span class="ident" id="1449441">c</span>&nbsp;<span class="op" id="1449443">*</span><span class="ident" id="1449444">conn</span><span class="op" id="1449448">)</span>&nbsp;<span class="builtinfunc" id="1449450">close</span><span class="op" id="1449455">(</span><span class="op" id="1449456">)</span>&nbsp;<span class="op" id="1449458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449461">c</span><span class="op" id="1449462">.</span><span class="ident" id="1449463">finalFlush</span><span class="op" id="1449473">(</span><span class="op" id="1449474">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449477">if</span>&nbsp;<span class="ident" id="1449480">c</span><span class="op" id="1449481">.</span><span class="ident" id="1449482">rwc</span>&nbsp;<span class="op" id="1449486">!=</span>&nbsp;<span class="ident" id="1449489">nil</span>&nbsp;<span class="op" id="1449493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449497">c</span><span class="op" id="1449498">.</span><span class="ident" id="1449499">rwc</span><span class="op" id="1449502">.</span><span class="ident" id="1449503">Close</span><span class="op" id="1449508">(</span><span class="op" id="1449509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449513">c</span><span class="op" id="1449514">.</span><span class="ident" id="1449515">rwc</span>&nbsp;<span class="op" id="1449519">=</span>&nbsp;<span class="ident" id="1449521">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449526">}</span><br>
<span class="lineno"></span><span class="op" id="1449528">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="1449531">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1449601">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="1449669">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="1449738">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="1449809">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1449862">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="1449927">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="1449995">const</span>&nbsp;<span class="ident" id="1450001">rstAvoidanceDelay</span>&nbsp;<span class="op" id="1450019">=</span>&nbsp;<span class="num" id="1450021">500</span>&nbsp;<span class="op" id="1450025">*</span>&nbsp;<span class="ident" id="1450027">time</span><span class="op" id="1450031">.</span><span class="ident" id="1450032">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="1450045">type</span>&nbsp;<span class="ident" id="1450050">closeWriter</span>&nbsp;<span class="keyword" id="1450062">interface</span>&nbsp;<span class="op" id="1450072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450075">CloseWrite</span><span class="op" id="1450085">(</span><span class="op" id="1450086">)</span>&nbsp;<span class="builtintype" id="1450088">error</span><br>
<span class="lineno"></span><span class="op" id="1450094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1450097">var</span>&nbsp;<span class="ident" id="1450101">_</span>&nbsp;<span class="ident" id="1450103">closeWriter</span>&nbsp;<span class="op" id="1450115">=</span>&nbsp;<span class="op" id="1450117">(</span><span class="op" id="1450118">*</span><span class="ident" id="1450119">net</span><span class="op" id="1450122">.</span><span class="ident" id="1450123">TCPConn</span><span class="op" id="1450130">)</span><span class="op" id="1450131">(</span><span class="ident" id="1450132">nil</span><span class="op" id="1450135">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="1450138">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1450208">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1450278">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="1450340">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="1450359">//</span><br>
<span class="lineno"></span><span class="comment" id="1450362">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="1450398">func</span>&nbsp;<span class="op" id="1450403">(</span><span class="ident" id="1450404">c</span>&nbsp;<span class="op" id="1450406">*</span><span class="ident" id="1450407">conn</span><span class="op" id="1450411">)</span>&nbsp;<span class="ident" id="1450413">closeWriteAndWait</span><span class="op" id="1450430">(</span><span class="op" id="1450431">)</span>&nbsp;<span class="op" id="1450433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450436">c</span><span class="op" id="1450437">.</span><span class="ident" id="1450438">finalFlush</span><span class="op" id="1450448">(</span><span class="op" id="1450449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450452">if</span>&nbsp;<span class="ident" id="1450455">tcp</span><span class="op" id="1450458">,</span>&nbsp;<span class="ident" id="1450460">ok</span>&nbsp;<span class="op" id="1450463">:=</span>&nbsp;<span class="ident" id="1450466">c</span><span class="op" id="1450467">.</span><span class="ident" id="1450468">rwc</span><span class="op" id="1450471">.</span><span class="op" id="1450472">(</span><span class="ident" id="1450473">closeWriter</span><span class="op" id="1450484">)</span><span class="op" id="1450485">;</span>&nbsp;<span class="ident" id="1450487">ok</span>&nbsp;<span class="op" id="1450490">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450494">tcp</span><span class="op" id="1450497">.</span><span class="ident" id="1450498">CloseWrite</span><span class="op" id="1450508">(</span><span class="op" id="1450509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450515">time</span><span class="op" id="1450519">.</span><span class="ident" id="1450520">Sleep</span><span class="op" id="1450525">(</span><span class="ident" id="1450526">rstAvoidanceDelay</span><span class="op" id="1450543">)</span><br>
<span class="lineno"></span><span class="op" id="1450545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="1450548">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="1450612">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="1450681">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="1450739">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="1450759">func</span>&nbsp;<span class="ident" id="1450764">validNPN</span><span class="op" id="1450772">(</span><span class="ident" id="1450773">proto</span>&nbsp;<span class="builtintype" id="1450779">string</span><span class="op" id="1450785">)</span>&nbsp;<span class="builtintype" id="1450787">bool</span>&nbsp;<span class="op" id="1450792">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450795">switch</span>&nbsp;<span class="ident" id="1450802">proto</span>&nbsp;<span class="op" id="1450808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450811">case</span>&nbsp;<span class="string" id="1450816">&#34;&#34;</span><span class="op" id="1450818">,</span>&nbsp;<span class="string" id="1450820">&#34;http/1.1&#34;</span><span class="op" id="1450830">,</span>&nbsp;<span class="string" id="1450832">&#34;http/1.0&#34;</span><span class="op" id="1450842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450846">return</span>&nbsp;<span class="builtintype" id="1450853">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450863">return</span>&nbsp;<span class="builtintype" id="1450870">true</span><br>
<span class="lineno">1115</span><span class="op" id="1450875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1450878">func</span>&nbsp;<span class="op" id="1450883">(</span><span class="ident" id="1450884">c</span>&nbsp;<span class="op" id="1450886">*</span><span class="ident" id="1450887">conn</span><span class="op" id="1450891">)</span>&nbsp;<span class="ident" id="1450893">setState</span><span class="op" id="1450901">(</span><span class="ident" id="1450902">nc</span>&nbsp;<span class="ident" id="1450905">net</span><span class="op" id="1450908">.</span><span class="ident" id="1450909">Conn</span><span class="op" id="1450913">,</span>&nbsp;<span class="ident" id="1450915">state</span>&nbsp;<span class="ident" id="1450921">ConnState</span><span class="op" id="1450930">)</span>&nbsp;<span class="op" id="1450932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450935">if</span>&nbsp;<span class="ident" id="1450938">hook</span>&nbsp;<span class="op" id="1450943">:=</span>&nbsp;<span class="ident" id="1450946">c</span><span class="op" id="1450947">.</span><span class="ident" id="1450948">server</span><span class="op" id="1450954">.</span><span class="ident" id="1450955">ConnState</span><span class="op" id="1450964">;</span>&nbsp;<span class="ident" id="1450966">hook</span>&nbsp;<span class="op" id="1450971">!=</span>&nbsp;<span class="ident" id="1450974">nil</span>&nbsp;<span class="op" id="1450978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450982">hook</span><span class="op" id="1450986">(</span><span class="ident" id="1450987">nc</span><span class="op" id="1450989">,</span>&nbsp;<span class="ident" id="1450991">state</span><span class="op" id="1450996">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450999">}</span><br>
<span class="lineno"></span><span class="op" id="1451001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1451004">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="1451031">func</span>&nbsp;<span class="op" id="1451036">(</span><span class="ident" id="1451037">c</span>&nbsp;<span class="op" id="1451039">*</span><span class="ident" id="1451040">conn</span><span class="op" id="1451044">)</span>&nbsp;<span class="ident" id="1451046">serve</span><span class="op" id="1451051">(</span><span class="op" id="1451052">)</span>&nbsp;<span class="op" id="1451054">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451057">origConn</span>&nbsp;<span class="op" id="1451066">:=</span>&nbsp;<span class="ident" id="1451069">c</span><span class="op" id="1451070">.</span><span class="ident" id="1451071">rwc</span>&nbsp;<span class="comment" id="1451075">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451126">defer</span>&nbsp;<span class="keyword" id="1451132">func</span><span class="op" id="1451136">(</span><span class="op" id="1451137">)</span>&nbsp;<span class="op" id="1451139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451143">if</span>&nbsp;<span class="ident" id="1451146">err</span>&nbsp;<span class="op" id="1451150">:=</span>&nbsp;<span class="builtinfunc" id="1451153">recover</span><span class="op" id="1451160">(</span><span class="op" id="1451161">)</span><span class="op" id="1451162">;</span>&nbsp;<span class="ident" id="1451164">err</span>&nbsp;<span class="op" id="1451168">!=</span>&nbsp;<span class="ident" id="1451171">nil</span>&nbsp;<span class="op" id="1451175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451180">const</span>&nbsp;<span class="ident" id="1451186">size</span>&nbsp;<span class="op" id="1451191">=</span>&nbsp;<span class="num" id="1451193">64</span>&nbsp;<span class="op" id="1451196">&lt;&lt;</span>&nbsp;<span class="num" id="1451199">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451205">buf</span>&nbsp;<span class="op" id="1451209">:=</span>&nbsp;<span class="builtinfunc" id="1451212">make</span><span class="op" id="1451216">(</span><span class="op" id="1451217">[</span><span class="op" id="1451218">]</span><span class="builtintype" id="1451219">byte</span><span class="op" id="1451223">,</span>&nbsp;<span class="ident" id="1451225">size</span><span class="op" id="1451229">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451234">buf</span>&nbsp;<span class="op" id="1451238">=</span>&nbsp;<span class="ident" id="1451240">buf</span><span class="op" id="1451243">[</span><span class="op" id="1451244">:</span><span class="ident" id="1451245">runtime</span><span class="op" id="1451252">.</span><span class="ident" id="1451253">Stack</span><span class="op" id="1451258">(</span><span class="ident" id="1451259">buf</span><span class="op" id="1451262">,</span>&nbsp;<span class="builtintype" id="1451264">false</span><span class="op" id="1451269">)</span><span class="op" id="1451270">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451275">c</span><span class="op" id="1451276">.</span><span class="ident" id="1451277">server</span><span class="op" id="1451283">.</span><span class="ident" id="1451284">logf</span><span class="op" id="1451288">(</span><span class="string" id="1451289">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="1451321">,</span>&nbsp;<span class="ident" id="1451323">c</span><span class="op" id="1451324">.</span><span class="ident" id="1451325">remoteAddr</span><span class="op" id="1451335">,</span>&nbsp;<span class="ident" id="1451337">err</span><span class="op" id="1451340">,</span>&nbsp;<span class="ident" id="1451342">buf</span><span class="op" id="1451345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451353">if</span>&nbsp;<span class="op" id="1451356">!</span><span class="ident" id="1451357">c</span><span class="op" id="1451358">.</span><span class="ident" id="1451359">hijacked</span><span class="op" id="1451367">(</span><span class="op" id="1451368">)</span>&nbsp;<span class="op" id="1451370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451375">c</span><span class="op" id="1451376">.</span><span class="builtinfunc" id="1451377">close</span><span class="op" id="1451382">(</span><span class="op" id="1451383">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451388">c</span><span class="op" id="1451389">.</span><span class="ident" id="1451390">setState</span><span class="op" id="1451398">(</span><span class="ident" id="1451399">origConn</span><span class="op" id="1451407">,</span>&nbsp;<span class="ident" id="1451409">StateClosed</span><span class="op" id="1451420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451427">}</span><span class="op" id="1451428">(</span><span class="op" id="1451429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451433">if</span>&nbsp;<span class="ident" id="1451436">tlsConn</span><span class="op" id="1451443">,</span>&nbsp;<span class="ident" id="1451445">ok</span>&nbsp;<span class="op" id="1451448">:=</span>&nbsp;<span class="ident" id="1451451">c</span><span class="op" id="1451452">.</span><span class="ident" id="1451453">rwc</span><span class="op" id="1451456">.</span><span class="op" id="1451457">(</span><span class="op" id="1451458">*</span><span class="ident" id="1451459">tls</span><span class="op" id="1451462">.</span><span class="ident" id="1451463">Conn</span><span class="op" id="1451467">)</span><span class="op" id="1451468">;</span>&nbsp;<span class="ident" id="1451470">ok</span>&nbsp;<span class="op" id="1451473">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451477">if</span>&nbsp;<span class="ident" id="1451480">d</span>&nbsp;<span class="op" id="1451482">:=</span>&nbsp;<span class="ident" id="1451485">c</span><span class="op" id="1451486">.</span><span class="ident" id="1451487">server</span><span class="op" id="1451493">.</span><span class="ident" id="1451494">ReadTimeout</span><span class="op" id="1451505">;</span>&nbsp;<span class="ident" id="1451507">d</span>&nbsp;<span class="op" id="1451509">!=</span>&nbsp;<span class="num" id="1451512">0</span>&nbsp;<span class="op" id="1451514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451519">c</span><span class="op" id="1451520">.</span><span class="ident" id="1451521">rwc</span><span class="op" id="1451524">.</span><span class="ident" id="1451525">SetReadDeadline</span><span class="op" id="1451540">(</span><span class="ident" id="1451541">time</span><span class="op" id="1451545">.</span><span class="ident" id="1451546">Now</span><span class="op" id="1451549">(</span><span class="op" id="1451550">)</span><span class="op" id="1451551">.</span><span class="ident" id="1451552">Add</span><span class="op" id="1451555">(</span><span class="ident" id="1451556">d</span><span class="op" id="1451557">)</span><span class="op" id="1451558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451566">if</span>&nbsp;<span class="ident" id="1451569">d</span>&nbsp;<span class="op" id="1451571">:=</span>&nbsp;<span class="ident" id="1451574">c</span><span class="op" id="1451575">.</span><span class="ident" id="1451576">server</span><span class="op" id="1451582">.</span><span class="ident" id="1451583">WriteTimeout</span><span class="op" id="1451595">;</span>&nbsp;<span class="ident" id="1451597">d</span>&nbsp;<span class="op" id="1451599">!=</span>&nbsp;<span class="num" id="1451602">0</span>&nbsp;<span class="op" id="1451604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451609">c</span><span class="op" id="1451610">.</span><span class="ident" id="1451611">rwc</span><span class="op" id="1451614">.</span><span class="ident" id="1451615">SetWriteDeadline</span><span class="op" id="1451631">(</span><span class="ident" id="1451632">time</span><span class="op" id="1451636">.</span><span class="ident" id="1451637">Now</span><span class="op" id="1451640">(</span><span class="op" id="1451641">)</span><span class="op" id="1451642">.</span><span class="ident" id="1451643">Add</span><span class="op" id="1451646">(</span><span class="ident" id="1451647">d</span><span class="op" id="1451648">)</span><span class="op" id="1451649">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451657">if</span>&nbsp;<span class="ident" id="1451660">err</span>&nbsp;<span class="op" id="1451664">:=</span>&nbsp;<span class="ident" id="1451667">tlsConn</span><span class="op" id="1451674">.</span><span class="ident" id="1451675">Handshake</span><span class="op" id="1451684">(</span><span class="op" id="1451685">)</span><span class="op" id="1451686">;</span>&nbsp;<span class="ident" id="1451688">err</span>&nbsp;<span class="op" id="1451692">!=</span>&nbsp;<span class="ident" id="1451695">nil</span>&nbsp;<span class="op" id="1451699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451704">c</span><span class="op" id="1451705">.</span><span class="ident" id="1451706">server</span><span class="op" id="1451712">.</span><span class="ident" id="1451713">logf</span><span class="op" id="1451717">(</span><span class="string" id="1451718">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="1451757">,</span>&nbsp;<span class="ident" id="1451759">c</span><span class="op" id="1451760">.</span><span class="ident" id="1451761">rwc</span><span class="op" id="1451764">.</span><span class="ident" id="1451765">RemoteAddr</span><span class="op" id="1451775">(</span><span class="op" id="1451776">)</span><span class="op" id="1451777">,</span>&nbsp;<span class="ident" id="1451779">err</span><span class="op" id="1451782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451787">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451796">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451800">c</span><span class="op" id="1451801">.</span><span class="ident" id="1451802">tlsState</span>&nbsp;<span class="op" id="1451811">=</span>&nbsp;<span class="builtinfunc" id="1451813">new</span><span class="op" id="1451816">(</span><span class="ident" id="1451817">tls</span><span class="op" id="1451820">.</span><span class="ident" id="1451821">ConnectionState</span><span class="op" id="1451836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451840">*</span><span class="ident" id="1451841">c</span><span class="op" id="1451842">.</span><span class="ident" id="1451843">tlsState</span>&nbsp;<span class="op" id="1451852">=</span>&nbsp;<span class="ident" id="1451854">tlsConn</span><span class="op" id="1451861">.</span><span class="ident" id="1451862">ConnectionState</span><span class="op" id="1451877">(</span><span class="op" id="1451878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451882">if</span>&nbsp;<span class="ident" id="1451885">proto</span>&nbsp;<span class="op" id="1451891">:=</span>&nbsp;<span class="ident" id="1451894">c</span><span class="op" id="1451895">.</span><span class="ident" id="1451896">tlsState</span><span class="op" id="1451904">.</span><span class="ident" id="1451905">NegotiatedProtocol</span><span class="op" id="1451923">;</span>&nbsp;<span class="ident" id="1451925">validNPN</span><span class="op" id="1451933">(</span><span class="ident" id="1451934">proto</span><span class="op" id="1451939">)</span>&nbsp;<span class="op" id="1451941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451946">if</span>&nbsp;<span class="ident" id="1451949">fn</span>&nbsp;<span class="op" id="1451952">:=</span>&nbsp;<span class="ident" id="1451955">c</span><span class="op" id="1451956">.</span><span class="ident" id="1451957">server</span><span class="op" id="1451963">.</span><span class="ident" id="1451964">TLSNextProto</span><span class="op" id="1451976">[</span><span class="ident" id="1451977">proto</span><span class="op" id="1451982">]</span><span class="op" id="1451983">;</span>&nbsp;<span class="ident" id="1451985">fn</span>&nbsp;<span class="op" id="1451988">!=</span>&nbsp;<span class="ident" id="1451991">nil</span>&nbsp;<span class="op" id="1451995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452001">h</span>&nbsp;<span class="op" id="1452003">:=</span>&nbsp;<span class="ident" id="1452006">initNPNRequest</span><span class="op" id="1452020">{</span><span class="ident" id="1452021">tlsConn</span><span class="op" id="1452028">,</span>&nbsp;<span class="ident" id="1452030">serverHandler</span><span class="op" id="1452043">{</span><span class="ident" id="1452044">c</span><span class="op" id="1452045">.</span><span class="ident" id="1452046">server</span><span class="op" id="1452052">}</span><span class="op" id="1452053">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452059">fn</span><span class="op" id="1452061">(</span><span class="ident" id="1452062">c</span><span class="op" id="1452063">.</span><span class="ident" id="1452064">server</span><span class="op" id="1452070">,</span>&nbsp;<span class="ident" id="1452072">tlsConn</span><span class="op" id="1452079">,</span>&nbsp;<span class="ident" id="1452081">h</span><span class="op" id="1452082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452092">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452104">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452108">for</span>&nbsp;<span class="op" id="1452112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452116">w</span><span class="op" id="1452117">,</span>&nbsp;<span class="ident" id="1452119">err</span>&nbsp;<span class="op" id="1452123">:=</span>&nbsp;<span class="ident" id="1452126">c</span><span class="op" id="1452127">.</span><span class="ident" id="1452128">readRequest</span><span class="op" id="1452139">(</span><span class="op" id="1452140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452144">if</span>&nbsp;<span class="ident" id="1452147">c</span><span class="op" id="1452148">.</span><span class="ident" id="1452149">lr</span><span class="op" id="1452151">.</span><span class="ident" id="1452152">N</span>&nbsp;<span class="op" id="1452154">!=</span>&nbsp;<span class="ident" id="1452157">c</span><span class="op" id="1452158">.</span><span class="ident" id="1452159">server</span><span class="op" id="1452165">.</span><span class="ident" id="1452166">initialLimitedReaderSize</span><span class="op" id="1452190">(</span><span class="op" id="1452191">)</span>&nbsp;<span class="op" id="1452193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452198">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452253">c</span><span class="op" id="1452254">.</span><span class="ident" id="1452255">setState</span><span class="op" id="1452263">(</span><span class="ident" id="1452264">c</span><span class="op" id="1452265">.</span><span class="ident" id="1452266">rwc</span><span class="op" id="1452269">,</span>&nbsp;<span class="ident" id="1452271">StateActive</span><span class="op" id="1452282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452290">if</span>&nbsp;<span class="ident" id="1452293">err</span>&nbsp;<span class="op" id="1452297">!=</span>&nbsp;<span class="ident" id="1452300">nil</span>&nbsp;<span class="op" id="1452304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452309">if</span>&nbsp;<span class="ident" id="1452312">err</span>&nbsp;<span class="op" id="1452316">==</span>&nbsp;<span class="ident" id="1452319">errTooLarge</span>&nbsp;<span class="op" id="1452331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452337">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452380">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452414">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452455">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452496">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452533">io</span><span class="op" id="1452535">.</span><span class="ident" id="1452536">WriteString</span><span class="op" id="1452547">(</span><span class="ident" id="1452548">c</span><span class="op" id="1452549">.</span><span class="ident" id="1452550">rwc</span><span class="op" id="1452553">,</span>&nbsp;<span class="string" id="1452555">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="1452602">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452608">c</span><span class="op" id="1452609">.</span><span class="ident" id="1452610">closeWriteAndWait</span><span class="op" id="1452627">(</span><span class="op" id="1452628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452634">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452643">}</span>&nbsp;<span class="keyword" id="1452645">else</span>&nbsp;<span class="keyword" id="1452650">if</span>&nbsp;<span class="ident" id="1452653">err</span>&nbsp;<span class="op" id="1452657">==</span>&nbsp;<span class="ident" id="1452660">io</span><span class="op" id="1452662">.</span><span class="ident" id="1452663">EOF</span>&nbsp;<span class="op" id="1452667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452673">break</span>&nbsp;<span class="comment" id="1452679">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452697">}</span>&nbsp;<span class="keyword" id="1452699">else</span>&nbsp;<span class="keyword" id="1452704">if</span>&nbsp;<span class="ident" id="1452707">neterr</span><span class="op" id="1452713">,</span>&nbsp;<span class="ident" id="1452715">ok</span>&nbsp;<span class="op" id="1452718">:=</span>&nbsp;<span class="ident" id="1452721">err</span><span class="op" id="1452724">.</span><span class="op" id="1452725">(</span><span class="ident" id="1452726">net</span><span class="op" id="1452729">.</span><span class="ident" id="1452730">Error</span><span class="op" id="1452735">)</span><span class="op" id="1452736">;</span>&nbsp;<span class="ident" id="1452738">ok</span>&nbsp;<span class="op" id="1452741">&amp;&amp;</span>&nbsp;<span class="ident" id="1452744">neterr</span><span class="op" id="1452750">.</span><span class="ident" id="1452751">Timeout</span><span class="op" id="1452758">(</span><span class="op" id="1452759">)</span>&nbsp;<span class="op" id="1452761">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452767">break</span>&nbsp;<span class="comment" id="1452773">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452796">io</span><span class="op" id="1452798">.</span><span class="ident" id="1452799">WriteString</span><span class="op" id="1452810">(</span><span class="ident" id="1452811">c</span><span class="op" id="1452812">.</span><span class="ident" id="1452813">rwc</span><span class="op" id="1452816">,</span>&nbsp;<span class="string" id="1452818">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="1452852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452857">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452865">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452870">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452903">req</span>&nbsp;<span class="op" id="1452907">:=</span>&nbsp;<span class="ident" id="1452910">w</span><span class="op" id="1452911">.</span><span class="ident" id="1452912">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452918">if</span>&nbsp;<span class="ident" id="1452921">req</span><span class="op" id="1452924">.</span><span class="ident" id="1452925">expectsContinue</span><span class="op" id="1452940">(</span><span class="op" id="1452941">)</span>&nbsp;<span class="op" id="1452943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452948">if</span>&nbsp;<span class="ident" id="1452951">req</span><span class="op" id="1452954">.</span><span class="ident" id="1452955">ProtoAtLeast</span><span class="op" id="1452967">(</span><span class="num" id="1452968">1</span><span class="op" id="1452969">,</span>&nbsp;<span class="num" id="1452971">1</span><span class="op" id="1452972">)</span>&nbsp;<span class="op" id="1452974">&amp;&amp;</span>&nbsp;<span class="ident" id="1452977">req</span><span class="op" id="1452980">.</span><span class="ident" id="1452981">ContentLength</span>&nbsp;<span class="op" id="1452995">!=</span>&nbsp;<span class="num" id="1452998">0</span>&nbsp;<span class="op" id="1453000">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453006">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453074">req</span><span class="op" id="1453077">.</span><span class="ident" id="1453078">Body</span>&nbsp;<span class="op" id="1453083">=</span>&nbsp;<span class="op" id="1453085">&amp;</span><span class="ident" id="1453086">expectContinueReader</span><span class="op" id="1453106">{</span><span class="ident" id="1453107">readCloser</span><span class="op" id="1453117">:</span>&nbsp;<span class="ident" id="1453119">req</span><span class="op" id="1453122">.</span><span class="ident" id="1453123">Body</span><span class="op" id="1453127">,</span>&nbsp;<span class="ident" id="1453129">resp</span><span class="op" id="1453133">:</span>&nbsp;<span class="ident" id="1453135">w</span><span class="op" id="1453136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453146">req</span><span class="op" id="1453149">.</span><span class="ident" id="1453150">Header</span><span class="op" id="1453156">.</span><span class="ident" id="1453157">Del</span><span class="op" id="1453160">(</span><span class="string" id="1453161">&#34;Expect&#34;</span><span class="op" id="1453169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453173">}</span>&nbsp;<span class="keyword" id="1453175">else</span>&nbsp;<span class="keyword" id="1453180">if</span>&nbsp;<span class="ident" id="1453183">req</span><span class="op" id="1453186">.</span><span class="ident" id="1453187">Header</span><span class="op" id="1453193">.</span><span class="ident" id="1453194">get</span><span class="op" id="1453197">(</span><span class="string" id="1453198">&#34;Expect&#34;</span><span class="op" id="1453206">)</span>&nbsp;<span class="op" id="1453208">!=</span>&nbsp;<span class="string" id="1453211">&#34;&#34;</span>&nbsp;<span class="op" id="1453214">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453219">w</span><span class="op" id="1453220">.</span><span class="ident" id="1453221">sendExpectationFailed</span><span class="op" id="1453242">(</span><span class="op" id="1453243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453248">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453261">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453325">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453395">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453455">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453531">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453595">serverHandler</span><span class="op" id="1453608">{</span><span class="ident" id="1453609">c</span><span class="op" id="1453610">.</span><span class="ident" id="1453611">server</span><span class="op" id="1453617">}</span><span class="op" id="1453618">.</span><span class="ident" id="1453619">ServeHTTP</span><span class="op" id="1453628">(</span><span class="ident" id="1453629">w</span><span class="op" id="1453630">,</span>&nbsp;<span class="ident" id="1453632">w</span><span class="op" id="1453633">.</span><span class="ident" id="1453634">req</span><span class="op" id="1453637">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453641">if</span>&nbsp;<span class="ident" id="1453644">c</span><span class="op" id="1453645">.</span><span class="ident" id="1453646">hijacked</span><span class="op" id="1453654">(</span><span class="op" id="1453655">)</span>&nbsp;<span class="op" id="1453657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453662">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453675">w</span><span class="op" id="1453676">.</span><span class="ident" id="1453677">finishRequest</span><span class="op" id="1453690">(</span><span class="op" id="1453691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453695">if</span>&nbsp;<span class="ident" id="1453698">w</span><span class="op" id="1453699">.</span><span class="ident" id="1453700">closeAfterReply</span>&nbsp;<span class="op" id="1453716">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453721">if</span>&nbsp;<span class="ident" id="1453724">w</span><span class="op" id="1453725">.</span><span class="ident" id="1453726">requestBodyLimitHit</span>&nbsp;<span class="op" id="1453746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453752">c</span><span class="op" id="1453753">.</span><span class="ident" id="1453754">closeWriteAndWait</span><span class="op" id="1453771">(</span><span class="op" id="1453772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453782">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453790">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453794">c</span><span class="op" id="1453795">.</span><span class="ident" id="1453796">setState</span><span class="op" id="1453804">(</span><span class="ident" id="1453805">c</span><span class="op" id="1453806">.</span><span class="ident" id="1453807">rwc</span><span class="op" id="1453810">,</span>&nbsp;<span class="ident" id="1453812">StateIdle</span><span class="op" id="1453821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453824">}</span><br>
<span class="lineno"></span><span class="op" id="1453826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1453829">func</span>&nbsp;<span class="op" id="1453834">(</span><span class="ident" id="1453835">w</span>&nbsp;<span class="op" id="1453837">*</span><span class="ident" id="1453838">response</span><span class="op" id="1453846">)</span>&nbsp;<span class="ident" id="1453848">sendExpectationFailed</span><span class="op" id="1453869">(</span><span class="op" id="1453870">)</span>&nbsp;<span class="op" id="1453872">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453875">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453925">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453978">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454028">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454078">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454118">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454162">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454166">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454220">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454270">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454317">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454365">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454418">w</span><span class="op" id="1454419">.</span><span class="ident" id="1454420">Header</span><span class="op" id="1454426">(</span><span class="op" id="1454427">)</span><span class="op" id="1454428">.</span><span class="ident" id="1454429">Set</span><span class="op" id="1454432">(</span><span class="string" id="1454433">&#34;Connection&#34;</span><span class="op" id="1454445">,</span>&nbsp;<span class="string" id="1454447">&#34;close&#34;</span><span class="op" id="1454454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454457">w</span><span class="op" id="1454458">.</span><span class="ident" id="1454459">WriteHeader</span><span class="op" id="1454470">(</span><span class="ident" id="1454471">StatusExpectationFailed</span><span class="op" id="1454494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454497">w</span><span class="op" id="1454498">.</span><span class="ident" id="1454499">finishRequest</span><span class="op" id="1454512">(</span><span class="op" id="1454513">)</span><br>
<span class="lineno">1235</span><span class="op" id="1454515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1454518">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="1454605">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="1454624">func</span>&nbsp;<span class="op" id="1454629">(</span><span class="ident" id="1454630">w</span>&nbsp;<span class="op" id="1454632">*</span><span class="ident" id="1454633">response</span><span class="op" id="1454641">)</span>&nbsp;<span class="ident" id="1454643">Hijack</span><span class="op" id="1454649">(</span><span class="op" id="1454650">)</span>&nbsp;<span class="op" id="1454652">(</span><span class="ident" id="1454653">rwc</span>&nbsp;<span class="ident" id="1454657">net</span><span class="op" id="1454660">.</span><span class="ident" id="1454661">Conn</span><span class="op" id="1454665">,</span>&nbsp;<span class="ident" id="1454667">buf</span>&nbsp;<span class="op" id="1454671">*</span><span class="ident" id="1454672">bufio</span><span class="op" id="1454677">.</span><span class="ident" id="1454678">ReadWriter</span><span class="op" id="1454688">,</span>&nbsp;<span class="ident" id="1454690">err</span>&nbsp;<span class="builtintype" id="1454694">error</span><span class="op" id="1454699">)</span>&nbsp;<span class="op" id="1454701">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454704">if</span>&nbsp;<span class="ident" id="1454707">w</span><span class="op" id="1454708">.</span><span class="ident" id="1454709">wroteHeader</span>&nbsp;<span class="op" id="1454721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454725">w</span><span class="op" id="1454726">.</span><span class="ident" id="1454727">cw</span><span class="op" id="1454729">.</span><span class="ident" id="1454730">flush</span><span class="op" id="1454735">(</span><span class="op" id="1454736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454742">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454813">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454860">rwc</span><span class="op" id="1454863">,</span>&nbsp;<span class="ident" id="1454865">buf</span><span class="op" id="1454868">,</span>&nbsp;<span class="ident" id="1454870">err</span>&nbsp;<span class="op" id="1454874">=</span>&nbsp;<span class="ident" id="1454876">w</span><span class="op" id="1454877">.</span><span class="ident" id="1454878">conn</span><span class="op" id="1454882">.</span><span class="ident" id="1454883">hijack</span><span class="op" id="1454889">(</span><span class="op" id="1454890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454893">if</span>&nbsp;<span class="ident" id="1454896">err</span>&nbsp;<span class="op" id="1454900">==</span>&nbsp;<span class="ident" id="1454903">nil</span>&nbsp;<span class="op" id="1454907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454911">putBufioWriter</span><span class="op" id="1454925">(</span><span class="ident" id="1454926">w</span><span class="op" id="1454927">.</span><span class="ident" id="1454928">w</span><span class="op" id="1454929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454933">w</span><span class="op" id="1454934">.</span><span class="ident" id="1454935">w</span>&nbsp;<span class="op" id="1454937">=</span>&nbsp;<span class="ident" id="1454939">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454944">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454947">return</span>&nbsp;<span class="ident" id="1454954">rwc</span><span class="op" id="1454957">,</span>&nbsp;<span class="ident" id="1454959">buf</span><span class="op" id="1454962">,</span>&nbsp;<span class="ident" id="1454964">err</span><br>
<span class="lineno"></span><span class="op" id="1454968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1454971">func</span>&nbsp;<span class="op" id="1454976">(</span><span class="ident" id="1454977">w</span>&nbsp;<span class="op" id="1454979">*</span><span class="ident" id="1454980">response</span><span class="op" id="1454988">)</span>&nbsp;<span class="ident" id="1454990">CloseNotify</span><span class="op" id="1455001">(</span><span class="op" id="1455002">)</span>&nbsp;<span class="op" id="1455004">&lt;-</span><span class="keyword" id="1455006">chan</span>&nbsp;<span class="builtintype" id="1455011">bool</span>&nbsp;<span class="op" id="1455016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455019">return</span>&nbsp;<span class="ident" id="1455026">w</span><span class="op" id="1455027">.</span><span class="ident" id="1455028">conn</span><span class="op" id="1455032">.</span><span class="ident" id="1455033">closeNotify</span><span class="op" id="1455044">(</span><span class="op" id="1455045">)</span><br>
<span class="lineno">1255</span><span class="op" id="1455047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455050">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1455108">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="1455168">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="1455223">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="1455255">type</span>&nbsp;<span class="ident" id="1455260">HandlerFunc</span>&nbsp;<span class="keyword" id="1455272">func</span><span class="op" id="1455276">(</span><span class="ident" id="1455277">ResponseWriter</span><span class="op" id="1455291">,</span>&nbsp;<span class="op" id="1455293">*</span><span class="ident" id="1455294">Request</span><span class="op" id="1455301">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455304">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="1455332">func</span>&nbsp;<span class="op" id="1455337">(</span><span class="ident" id="1455338">f</span>&nbsp;<span class="ident" id="1455340">HandlerFunc</span><span class="op" id="1455351">)</span>&nbsp;<span class="ident" id="1455353">ServeHTTP</span><span class="op" id="1455362">(</span><span class="ident" id="1455363">w</span>&nbsp;<span class="ident" id="1455365">ResponseWriter</span><span class="op" id="1455379">,</span>&nbsp;<span class="ident" id="1455381">r</span>&nbsp;<span class="op" id="1455383">*</span><span class="ident" id="1455384">Request</span><span class="op" id="1455391">)</span>&nbsp;<span class="op" id="1455393">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455396">f</span><span class="op" id="1455397">(</span><span class="ident" id="1455398">w</span><span class="op" id="1455399">,</span>&nbsp;<span class="ident" id="1455401">r</span><span class="op" id="1455402">)</span><br>
<span class="lineno"></span><span class="op" id="1455404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455407">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="1455427">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="1455507">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="1455550">func</span>&nbsp;<span class="ident" id="1455555">Error</span><span class="op" id="1455560">(</span><span class="ident" id="1455561">w</span>&nbsp;<span class="ident" id="1455563">ResponseWriter</span><span class="op" id="1455577">,</span>&nbsp;<span class="builtintype" id="1455579">error</span>&nbsp;<span class="builtintype" id="1455585">string</span><span class="op" id="1455591">,</span>&nbsp;<span class="ident" id="1455593">code</span>&nbsp;<span class="builtintype" id="1455598">int</span><span class="op" id="1455601">)</span>&nbsp;<span class="op" id="1455603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455606">w</span><span class="op" id="1455607">.</span><span class="ident" id="1455608">Header</span><span class="op" id="1455614">(</span><span class="op" id="1455615">)</span><span class="op" id="1455616">.</span><span class="ident" id="1455617">Set</span><span class="op" id="1455620">(</span><span class="string" id="1455621">&#34;Content-Type&#34;</span><span class="op" id="1455635">,</span>&nbsp;<span class="string" id="1455637">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="1455664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455667">w</span><span class="op" id="1455668">.</span><span class="ident" id="1455669">WriteHeader</span><span class="op" id="1455680">(</span><span class="ident" id="1455681">code</span><span class="op" id="1455685">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455688">fmt</span><span class="op" id="1455691">.</span><span class="ident" id="1455692">Fprintln</span><span class="op" id="1455700">(</span><span class="ident" id="1455701">w</span><span class="op" id="1455702">,</span>&nbsp;<span class="builtintype" id="1455704">error</span><span class="op" id="1455709">)</span><br>
<span class="lineno"></span><span class="op" id="1455711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455714">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="1455783">func</span>&nbsp;<span class="ident" id="1455788">NotFound</span><span class="op" id="1455796">(</span><span class="ident" id="1455797">w</span>&nbsp;<span class="ident" id="1455799">ResponseWriter</span><span class="op" id="1455813">,</span>&nbsp;<span class="ident" id="1455815">r</span>&nbsp;<span class="op" id="1455817">*</span><span class="ident" id="1455818">Request</span><span class="op" id="1455825">)</span>&nbsp;<span class="op" id="1455827">{</span>&nbsp;<span class="ident" id="1455829">Error</span><span class="op" id="1455834">(</span><span class="ident" id="1455835">w</span><span class="op" id="1455836">,</span>&nbsp;<span class="string" id="1455838">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="1455858">,</span>&nbsp;<span class="ident" id="1455860">StatusNotFound</span><span class="op" id="1455874">)</span>&nbsp;<span class="op" id="1455876">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="1455879">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1455931">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="1456000">func</span>&nbsp;<span class="ident" id="1456005">NotFoundHandler</span><span class="op" id="1456020">(</span><span class="op" id="1456021">)</span>&nbsp;<span class="ident" id="1456023">Handler</span>&nbsp;<span class="op" id="1456031">{</span>&nbsp;<span class="keyword" id="1456033">return</span>&nbsp;<span class="ident" id="1456040">HandlerFunc</span><span class="op" id="1456051">(</span><span class="ident" id="1456052">NotFound</span><span class="op" id="1456060">)</span>&nbsp;<span class="op" id="1456062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="1456065">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="1456124">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="1456184">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1456237">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1456293">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="1456339">func</span>&nbsp;<span class="ident" id="1456344">StripPrefix</span><span class="op" id="1456355">(</span><span class="ident" id="1456356">prefix</span>&nbsp;<span class="builtintype" id="1456363">string</span><span class="op" id="1456369">,</span>&nbsp;<span class="ident" id="1456371">h</span>&nbsp;<span class="ident" id="1456373">Handler</span><span class="op" id="1456380">)</span>&nbsp;<span class="ident" id="1456382">Handler</span>&nbsp;<span class="op" id="1456390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456393">if</span>&nbsp;<span class="ident" id="1456396">prefix</span>&nbsp;<span class="op" id="1456403">==</span>&nbsp;<span class="string" id="1456406">&#34;&#34;</span>&nbsp;<span class="op" id="1456409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456413">return</span>&nbsp;<span class="ident" id="1456420">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456426">return</span>&nbsp;<span class="ident" id="1456433">HandlerFunc</span><span class="op" id="1456444">(</span><span class="keyword" id="1456445">func</span><span class="op" id="1456449">(</span><span class="ident" id="1456450">w</span>&nbsp;<span class="ident" id="1456452">ResponseWriter</span><span class="op" id="1456466">,</span>&nbsp;<span class="ident" id="1456468">r</span>&nbsp;<span class="op" id="1456470">*</span><span class="ident" id="1456471">Request</span><span class="op" id="1456478">)</span>&nbsp;<span class="op" id="1456480">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456484">if</span>&nbsp;<span class="ident" id="1456487">p</span>&nbsp;<span class="op" id="1456489">:=</span>&nbsp;<span class="ident" id="1456492">strings</span><span class="op" id="1456499">.</span><span class="ident" id="1456500">TrimPrefix</span><span class="op" id="1456510">(</span><span class="ident" id="1456511">r</span><span class="op" id="1456512">.</span><span class="ident" id="1456513">URL</span><span class="op" id="1456516">.</span><span class="ident" id="1456517">Path</span><span class="op" id="1456521">,</span>&nbsp;<span class="ident" id="1456523">prefix</span><span class="op" id="1456529">)</span><span class="op" id="1456530">;</span>&nbsp;<span class="builtinfunc" id="1456532">len</span><span class="op" id="1456535">(</span><span class="ident" id="1456536">p</span><span class="op" id="1456537">)</span>&nbsp;<span class="op" id="1456539">&lt;</span>&nbsp;<span class="builtinfunc" id="1456541">len</span><span class="op" id="1456544">(</span><span class="ident" id="1456545">r</span><span class="op" id="1456546">.</span><span class="ident" id="1456547">URL</span><span class="op" id="1456550">.</span><span class="ident" id="1456551">Path</span><span class="op" id="1456555">)</span>&nbsp;<span class="op" id="1456557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456562">r</span><span class="op" id="1456563">.</span><span class="ident" id="1456564">URL</span><span class="op" id="1456567">.</span><span class="ident" id="1456568">Path</span>&nbsp;<span class="op" id="1456573">=</span>&nbsp;<span class="ident" id="1456575">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456580">h</span><span class="op" id="1456581">.</span><span class="ident" id="1456582">ServeHTTP</span><span class="op" id="1456591">(</span><span class="ident" id="1456592">w</span><span class="op" id="1456593">,</span>&nbsp;<span class="ident" id="1456595">r</span><span class="op" id="1456596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456600">}</span>&nbsp;<span class="keyword" id="1456602">else</span>&nbsp;<span class="op" id="1456607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456612">NotFound</span><span class="op" id="1456620">(</span><span class="ident" id="1456621">w</span><span class="op" id="1456622">,</span>&nbsp;<span class="ident" id="1456624">r</span><span class="op" id="1456625">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456632">}</span><span class="op" id="1456633">)</span><br>
<span class="lineno"></span><span class="op" id="1456635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1456638">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="1456697">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="1456750">func</span>&nbsp;<span class="ident" id="1456755">Redirect</span><span class="op" id="1456763">(</span><span class="ident" id="1456764">w</span>&nbsp;<span class="ident" id="1456766">ResponseWriter</span><span class="op" id="1456780">,</span>&nbsp;<span class="ident" id="1456782">r</span>&nbsp;<span class="op" id="1456784">*</span><span class="ident" id="1456785">Request</span><span class="op" id="1456792">,</span>&nbsp;<span class="ident" id="1456794">urlStr</span>&nbsp;<span class="builtintype" id="1456801">string</span><span class="op" id="1456807">,</span>&nbsp;<span class="ident" id="1456809">code</span>&nbsp;<span class="builtintype" id="1456814">int</span><span class="op" id="1456817">)</span>&nbsp;<span class="op" id="1456819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456822">if</span>&nbsp;<span class="ident" id="1456825">u</span><span class="op" id="1456826">,</span>&nbsp;<span class="ident" id="1456828">err</span>&nbsp;<span class="op" id="1456832">:=</span>&nbsp;<span class="ident" id="1456835">url</span><span class="op" id="1456838">.</span><span class="ident" id="1456839">Parse</span><span class="op" id="1456844">(</span><span class="ident" id="1456845">urlStr</span><span class="op" id="1456851">)</span><span class="op" id="1456852">;</span>&nbsp;<span class="ident" id="1456854">err</span>&nbsp;<span class="op" id="1456858">==</span>&nbsp;<span class="ident" id="1456861">nil</span>&nbsp;<span class="op" id="1456865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456869">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456912">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456946">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456994">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457041">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457089">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457129">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457169">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457204">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457246">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457291">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457339">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457386">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457438">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457491">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457506">oldpath</span>&nbsp;<span class="op" id="1457514">:=</span>&nbsp;<span class="ident" id="1457517">r</span><span class="op" id="1457518">.</span><span class="ident" id="1457519">URL</span><span class="op" id="1457522">.</span><span class="ident" id="1457523">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457530">if</span>&nbsp;<span class="ident" id="1457533">oldpath</span>&nbsp;<span class="op" id="1457541">==</span>&nbsp;<span class="string" id="1457544">&#34;&#34;</span>&nbsp;<span class="op" id="1457547">{</span>&nbsp;<span class="comment" id="1457549">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457603">oldpath</span>&nbsp;<span class="op" id="1457611">=</span>&nbsp;<span class="string" id="1457613">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457623">if</span>&nbsp;<span class="ident" id="1457626">u</span><span class="op" id="1457627">.</span><span class="ident" id="1457628">Scheme</span>&nbsp;<span class="op" id="1457635">==</span>&nbsp;<span class="string" id="1457638">&#34;&#34;</span>&nbsp;<span class="op" id="1457641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457646">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457677">if</span>&nbsp;<span class="ident" id="1457680">urlStr</span>&nbsp;<span class="op" id="1457687">==</span>&nbsp;<span class="string" id="1457690">&#34;&#34;</span>&nbsp;<span class="op" id="1457693">||</span>&nbsp;<span class="ident" id="1457696">urlStr</span><span class="op" id="1457702">[</span><span class="num" id="1457703">0</span><span class="op" id="1457704">]</span>&nbsp;<span class="op" id="1457706">!=</span>&nbsp;<span class="string" id="1457709">&#39;/&#39;</span>&nbsp;<span class="op" id="1457713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457719">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457754">olddir</span><span class="op" id="1457760">,</span>&nbsp;<span class="ident" id="1457762">_</span>&nbsp;<span class="op" id="1457764">:=</span>&nbsp;<span class="ident" id="1457767">path</span><span class="op" id="1457771">.</span><span class="ident" id="1457772">Split</span><span class="op" id="1457777">(</span><span class="ident" id="1457778">oldpath</span><span class="op" id="1457785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457791">urlStr</span>&nbsp;<span class="op" id="1457798">=</span>&nbsp;<span class="ident" id="1457800">olddir</span>&nbsp;<span class="op" id="1457807">+</span>&nbsp;<span class="ident" id="1457809">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457819">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457825">var</span>&nbsp;<span class="ident" id="1457829">query</span>&nbsp;<span class="builtintype" id="1457835">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457845">if</span>&nbsp;<span class="ident" id="1457848">i</span>&nbsp;<span class="op" id="1457850">:=</span>&nbsp;<span class="ident" id="1457853">strings</span><span class="op" id="1457860">.</span><span class="ident" id="1457861">Index</span><span class="op" id="1457866">(</span><span class="ident" id="1457867">urlStr</span><span class="op" id="1457873">,</span>&nbsp;<span class="string" id="1457875">&#34;?&#34;</span><span class="op" id="1457878">)</span><span class="op" id="1457879">;</span>&nbsp;<span class="ident" id="1457881">i</span>&nbsp;<span class="op" id="1457883">!=</span>&nbsp;<span class="op" id="1457886">-</span><span class="num" id="1457887">1</span>&nbsp;<span class="op" id="1457889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457895">urlStr</span><span class="op" id="1457901">,</span>&nbsp;<span class="ident" id="1457903">query</span>&nbsp;<span class="op" id="1457909">=</span>&nbsp;<span class="ident" id="1457911">urlStr</span><span class="op" id="1457917">[</span><span class="op" id="1457918">:</span><span class="ident" id="1457919">i</span><span class="op" id="1457920">]</span><span class="op" id="1457921">,</span>&nbsp;<span class="ident" id="1457923">urlStr</span><span class="op" id="1457929">[</span><span class="ident" id="1457930">i</span><span class="op" id="1457931">:</span><span class="op" id="1457932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457937">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457943">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457986">trailing</span>&nbsp;<span class="op" id="1457995">:=</span>&nbsp;<span class="ident" id="1457998">strings</span><span class="op" id="1458005">.</span><span class="ident" id="1458006">HasSuffix</span><span class="op" id="1458015">(</span><span class="ident" id="1458016">urlStr</span><span class="op" id="1458022">,</span>&nbsp;<span class="string" id="1458024">&#34;/&#34;</span><span class="op" id="1458027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458032">urlStr</span>&nbsp;<span class="op" id="1458039">=</span>&nbsp;<span class="ident" id="1458041">path</span><span class="op" id="1458045">.</span><span class="ident" id="1458046">Clean</span><span class="op" id="1458051">(</span><span class="ident" id="1458052">urlStr</span><span class="op" id="1458058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458063">if</span>&nbsp;<span class="ident" id="1458066">trailing</span>&nbsp;<span class="op" id="1458075">&amp;&amp;</span>&nbsp;<span class="op" id="1458078">!</span><span class="ident" id="1458079">strings</span><span class="op" id="1458086">.</span><span class="ident" id="1458087">HasSuffix</span><span class="op" id="1458096">(</span><span class="ident" id="1458097">urlStr</span><span class="op" id="1458103">,</span>&nbsp;<span class="string" id="1458105">&#34;/&#34;</span><span class="op" id="1458108">)</span>&nbsp;<span class="op" id="1458110">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458116">urlStr</span>&nbsp;<span class="op" id="1458123">+=</span>&nbsp;<span class="string" id="1458126">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458138">urlStr</span>&nbsp;<span class="op" id="1458145">+=</span>&nbsp;<span class="ident" id="1458148">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458159">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458163">w</span><span class="op" id="1458164">.</span><span class="ident" id="1458165">Header</span><span class="op" id="1458171">(</span><span class="op" id="1458172">)</span><span class="op" id="1458173">.</span><span class="ident" id="1458174">Set</span><span class="op" id="1458177">(</span><span class="string" id="1458178">&#34;Location&#34;</span><span class="op" id="1458188">,</span>&nbsp;<span class="ident" id="1458190">urlStr</span><span class="op" id="1458196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458199">w</span><span class="op" id="1458200">.</span><span class="ident" id="1458201">WriteHeader</span><span class="op" id="1458212">(</span><span class="ident" id="1458213">code</span><span class="op" id="1458217">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458221">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458290">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458357">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458424">if</span>&nbsp;<span class="ident" id="1458427">r</span><span class="op" id="1458428">.</span><span class="ident" id="1458429">Method</span>&nbsp;<span class="op" id="1458436">==</span>&nbsp;<span class="string" id="1458439">&#34;GET&#34;</span>&nbsp;<span class="op" id="1458445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458449">note</span>&nbsp;<span class="op" id="1458454">:=</span>&nbsp;<span class="string" id="1458457">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="1458470">+</span>&nbsp;<span class="ident" id="1458472">htmlEscape</span><span class="op" id="1458482">(</span><span class="ident" id="1458483">urlStr</span><span class="op" id="1458489">)</span>&nbsp;<span class="op" id="1458491">+</span>&nbsp;<span class="string" id="1458493">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="1458499">+</span>&nbsp;<span class="ident" id="1458501">statusText</span><span class="op" id="1458511">[</span><span class="ident" id="1458512">code</span><span class="op" id="1458516">]</span>&nbsp;<span class="op" id="1458518">+</span>&nbsp;<span class="string" id="1458520">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458532">fmt</span><span class="op" id="1458535">.</span><span class="ident" id="1458536">Fprintln</span><span class="op" id="1458544">(</span><span class="ident" id="1458545">w</span><span class="op" id="1458546">,</span>&nbsp;<span class="ident" id="1458548">note</span><span class="op" id="1458552">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458555">}</span><br>
<span class="lineno"></span><span class="op" id="1458557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1458560">var</span>&nbsp;<span class="ident" id="1458564">htmlReplacer</span>&nbsp;<span class="op" id="1458577">=</span>&nbsp;<span class="ident" id="1458579">strings</span><span class="op" id="1458586">.</span><span class="ident" id="1458587">NewReplacer</span><span class="op" id="1458598">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1458601">&#34;&amp;&#34;</span><span class="op" id="1458604">,</span>&nbsp;<span class="string" id="1458606">&#34;&amp;amp;&#34;</span><span class="op" id="1458613">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1458616">&#34;&lt;&#34;</span><span class="op" id="1458619">,</span>&nbsp;<span class="string" id="1458621">&#34;&amp;lt;&#34;</span><span class="op" id="1458627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1458630">&#34;&gt;&#34;</span><span class="op" id="1458633">,</span>&nbsp;<span class="string" id="1458635">&#34;&amp;gt;&#34;</span><span class="op" id="1458641">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458644">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1458682">`&#34;`</span><span class="op" id="1458685">,</span>&nbsp;<span class="string" id="1458687">&#34;&amp;#34;&#34;</span><span class="op" id="1458694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458697">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1458772">&#34;&#39;&#34;</span><span class="op" id="1458775">,</span>&nbsp;<span class="string" id="1458777">&#34;&amp;#39;&#34;</span><span class="op" id="1458784">,</span><br>
<span class="lineno"></span><span class="op" id="1458786">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1458789">func</span>&nbsp;<span class="ident" id="1458794">htmlEscape</span><span class="op" id="1458804">(</span><span class="ident" id="1458805">s</span>&nbsp;<span class="builtintype" id="1458807">string</span><span class="op" id="1458813">)</span>&nbsp;<span class="builtintype" id="1458815">string</span>&nbsp;<span class="op" id="1458822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458825">return</span>&nbsp;<span class="ident" id="1458832">htmlReplacer</span><span class="op" id="1458844">.</span><span class="ident" id="1458845">Replace</span><span class="op" id="1458852">(</span><span class="ident" id="1458853">s</span><span class="op" id="1458854">)</span><br>
<span class="lineno">1375</span><span class="op" id="1458856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1458859">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="1458886">type</span>&nbsp;<span class="ident" id="1458891">redirectHandler</span>&nbsp;<span class="keyword" id="1458907">struct</span>&nbsp;<span class="op" id="1458914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458917">url</span>&nbsp;&nbsp;<span class="builtintype" id="1458922">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458930">code</span>&nbsp;<span class="builtintype" id="1458935">int</span><br>
<span class="lineno"></span><span class="op" id="1458939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1458942">func</span>&nbsp;<span class="op" id="1458947">(</span><span class="ident" id="1458948">rh</span>&nbsp;<span class="op" id="1458951">*</span><span class="ident" id="1458952">redirectHandler</span><span class="op" id="1458967">)</span>&nbsp;<span class="ident" id="1458969">ServeHTTP</span><span class="op" id="1458978">(</span><span class="ident" id="1458979">w</span>&nbsp;<span class="ident" id="1458981">ResponseWriter</span><span class="op" id="1458995">,</span>&nbsp;<span class="ident" id="1458997">r</span>&nbsp;<span class="op" id="1458999">*</span><span class="ident" id="1459000">Request</span><span class="op" id="1459007">)</span>&nbsp;<span class="op" id="1459009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459012">Redirect</span><span class="op" id="1459020">(</span><span class="ident" id="1459021">w</span><span class="op" id="1459022">,</span>&nbsp;<span class="ident" id="1459024">r</span><span class="op" id="1459025">,</span>&nbsp;<span class="ident" id="1459027">rh</span><span class="op" id="1459029">.</span><span class="ident" id="1459030">url</span><span class="op" id="1459033">,</span>&nbsp;<span class="ident" id="1459035">rh</span><span class="op" id="1459037">.</span><span class="ident" id="1459038">code</span><span class="op" id="1459042">)</span><br>
<span class="lineno">1385</span><span class="op" id="1459044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1459047">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="1459107">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="1459168">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="1459184">func</span>&nbsp;<span class="ident" id="1459189">RedirectHandler</span><span class="op" id="1459204">(</span><span class="ident" id="1459205">url</span>&nbsp;<span class="builtintype" id="1459209">string</span><span class="op" id="1459215">,</span>&nbsp;<span class="ident" id="1459217">code</span>&nbsp;<span class="builtintype" id="1459222">int</span><span class="op" id="1459225">)</span>&nbsp;<span class="ident" id="1459227">Handler</span>&nbsp;<span class="op" id="1459235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459238">return</span>&nbsp;<span class="op" id="1459245">&amp;</span><span class="ident" id="1459246">redirectHandler</span><span class="op" id="1459261">{</span><span class="ident" id="1459262">url</span><span class="op" id="1459265">,</span>&nbsp;<span class="ident" id="1459267">code</span><span class="op" id="1459271">}</span><br>
<span class="lineno"></span><span class="op" id="1459273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1459276">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="1459320">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="1459396">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1459451">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="1459484">//</span><br>
<span class="lineno"></span><span class="comment" id="1459487">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="1459546">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="1459612">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1459674">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1459730">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1459787">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="1459847">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1459906">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="1459929">//</span><br>
<span class="lineno"></span><span class="comment" id="1459932">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="1460003">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="1460072">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="1460120">//</span><br>
<span class="lineno"></span><span class="comment" id="1460123">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1460197">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="1460269">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="1460344">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="1460415">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="1460457">//</span><br>
<span class="lineno"></span><span class="comment" id="1460460">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="1460524">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="1460585">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="1460619">type</span>&nbsp;<span class="ident" id="1460624">ServeMux</span>&nbsp;<span class="keyword" id="1460633">struct</span>&nbsp;<span class="op" id="1460640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460643">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460649">sync</span><span class="op" id="1460653">.</span><span class="ident" id="1460654">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460663">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460669">map</span><span class="op" id="1460672">[</span><span class="builtintype" id="1460673">string</span><span class="op" id="1460679">]</span><span class="ident" id="1460680">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460690">hosts</span>&nbsp;<span class="builtintype" id="1460696">bool</span>&nbsp;<span class="comment" id="1460701">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="1460743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1460746">type</span>&nbsp;<span class="ident" id="1460751">muxEntry</span>&nbsp;<span class="keyword" id="1460760">struct</span>&nbsp;<span class="op" id="1460767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460770">explicit</span>&nbsp;<span class="builtintype" id="1460779">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460785">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460794">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460803">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="1460812">string</span><br>
<span class="lineno"></span><span class="op" id="1460819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1460822">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="1460875">func</span>&nbsp;<span class="ident" id="1460880">NewServeMux</span><span class="op" id="1460891">(</span><span class="op" id="1460892">)</span>&nbsp;<span class="op" id="1460894">*</span><span class="ident" id="1460895">ServeMux</span>&nbsp;<span class="op" id="1460904">{</span>&nbsp;<span class="keyword" id="1460906">return</span>&nbsp;<span class="op" id="1460913">&amp;</span><span class="ident" id="1460914">ServeMux</span><span class="op" id="1460922">{</span><span class="ident" id="1460923">m</span><span class="op" id="1460924">:</span>&nbsp;<span class="builtinfunc" id="1460926">make</span><span class="op" id="1460930">(</span><span class="keyword" id="1460931">map</span><span class="op" id="1460934">[</span><span class="builtintype" id="1460935">string</span><span class="op" id="1460941">]</span><span class="ident" id="1460942">muxEntry</span><span class="op" id="1460950">)</span><span class="op" id="1460951">}</span>&nbsp;<span class="op" id="1460953">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="1460956">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="1461014">var</span>&nbsp;<span class="ident" id="1461018">DefaultServeMux</span>&nbsp;<span class="op" id="1461034">=</span>&nbsp;<span class="ident" id="1461036">NewServeMux</span><span class="op" id="1461047">(</span><span class="op" id="1461048">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1461051">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="1461079">func</span>&nbsp;<span class="ident" id="1461084">pathMatch</span><span class="op" id="1461093">(</span><span class="ident" id="1461094">pattern</span><span class="op" id="1461101">,</span>&nbsp;<span class="ident" id="1461103">path</span>&nbsp;<span class="builtintype" id="1461108">string</span><span class="op" id="1461114">)</span>&nbsp;<span class="builtintype" id="1461116">bool</span>&nbsp;<span class="op" id="1461121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461124">if</span>&nbsp;<span class="builtinfunc" id="1461127">len</span><span class="op" id="1461130">(</span><span class="ident" id="1461131">pattern</span><span class="op" id="1461138">)</span>&nbsp;<span class="op" id="1461140">==</span>&nbsp;<span class="num" id="1461143">0</span>&nbsp;<span class="op" id="1461145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1461149">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461172">return</span>&nbsp;<span class="builtintype" id="1461179">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461186">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461189">n</span>&nbsp;<span class="op" id="1461191">:=</span>&nbsp;<span class="builtinfunc" id="1461194">len</span><span class="op" id="1461197">(</span><span class="ident" id="1461198">pattern</span><span class="op" id="1461205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461208">if</span>&nbsp;<span class="ident" id="1461211">pattern</span><span class="op" id="1461218">[</span><span class="ident" id="1461219">n</span><span class="op" id="1461220">-</span><span class="num" id="1461221">1</span><span class="op" id="1461222">]</span>&nbsp;<span class="op" id="1461224">!=</span>&nbsp;<span class="string" id="1461227">&#39;/&#39;</span>&nbsp;<span class="op" id="1461231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461235">return</span>&nbsp;<span class="ident" id="1461242">pattern</span>&nbsp;<span class="op" id="1461250">==</span>&nbsp;<span class="ident" id="1461253">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461262">return</span>&nbsp;<span class="builtinfunc" id="1461269">len</span><span class="op" id="1461272">(</span><span class="ident" id="1461273">path</span><span class="op" id="1461277">)</span>&nbsp;<span class="op" id="1461279">&gt;=</span>&nbsp;<span class="ident" id="1461282">n</span>&nbsp;<span class="op" id="1461284">&amp;&amp;</span>&nbsp;<span class="ident" id="1461287">path</span><span class="op" id="1461291">[</span><span class="num" id="1461292">0</span><span class="op" id="1461293">:</span><span class="ident" id="1461294">n</span><span class="op" id="1461295">]</span>&nbsp;<span class="op" id="1461297">==</span>&nbsp;<span class="ident" id="1461300">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="1461308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1461311">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="1461378">func</span>&nbsp;<span class="ident" id="1461383">cleanPath</span><span class="op" id="1461392">(</span><span class="ident" id="1461393">p</span>&nbsp;<span class="builtintype" id="1461395">string</span><span class="op" id="1461401">)</span>&nbsp;<span class="builtintype" id="1461403">string</span>&nbsp;<span class="op" id="1461410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461413">if</span>&nbsp;<span class="ident" id="1461416">p</span>&nbsp;<span class="op" id="1461418">==</span>&nbsp;<span class="string" id="1461421">&#34;&#34;</span>&nbsp;<span class="op" id="1461424">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461428">return</span>&nbsp;<span class="string" id="1461435">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461443">if</span>&nbsp;<span class="ident" id="1461446">p</span><span class="op" id="1461447">[</span><span class="num" id="1461448">0</span><span class="op" id="1461449">]</span>&nbsp;<span class="op" id="1461451">!=</span>&nbsp;<span class="string" id="1461454">&#39;/&#39;</span>&nbsp;<span class="op" id="1461458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461462">p</span>&nbsp;<span class="op" id="1461464">=</span>&nbsp;<span class="string" id="1461466">&#34;/&#34;</span>&nbsp;<span class="op" id="1461470">+</span>&nbsp;<span class="ident" id="1461472">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461475">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461478">np</span>&nbsp;<span class="op" id="1461481">:=</span>&nbsp;<span class="ident" id="1461484">path</span><span class="op" id="1461488">.</span><span class="ident" id="1461489">Clean</span><span class="op" id="1461494">(</span><span class="ident" id="1461495">p</span><span class="op" id="1461496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1461499">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1461554">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461600">if</span>&nbsp;<span class="ident" id="1461603">p</span><span class="op" id="1461604">[</span><span class="builtinfunc" id="1461605">len</span><span class="op" id="1461608">(</span><span class="ident" id="1461609">p</span><span class="op" id="1461610">)</span><span class="op" id="1461611">-</span><span class="num" id="1461612">1</span><span class="op" id="1461613">]</span>&nbsp;<span class="op" id="1461615">==</span>&nbsp;<span class="string" id="1461618">&#39;/&#39;</span>&nbsp;<span class="op" id="1461622">&amp;&amp;</span>&nbsp;<span class="ident" id="1461625">np</span>&nbsp;<span class="op" id="1461628">!=</span>&nbsp;<span class="string" id="1461631">&#34;/&#34;</span>&nbsp;<span class="op" id="1461635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461639">np</span>&nbsp;<span class="op" id="1461642">+=</span>&nbsp;<span class="string" id="1461645">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461653">return</span>&nbsp;<span class="ident" id="1461660">np</span><br>
<span class="lineno"></span><span class="op" id="1461663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1461666">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="1461721">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="1461761">func</span>&nbsp;<span class="op" id="1461766">(</span><span class="ident" id="1461767">mux</span>&nbsp;<span class="op" id="1461771">*</span><span class="ident" id="1461772">ServeMux</span><span class="op" id="1461780">)</span>&nbsp;<span class="ident" id="1461782">match</span><span class="op" id="1461787">(</span><span class="ident" id="1461788">path</span>&nbsp;<span class="builtintype" id="1461793">string</span><span class="op" id="1461799">)</span>&nbsp;<span class="op" id="1461801">(</span><span class="ident" id="1461802">h</span>&nbsp;<span class="ident" id="1461804">Handler</span><span class="op" id="1461811">,</span>&nbsp;<span class="ident" id="1461813">pattern</span>&nbsp;<span class="builtintype" id="1461821">string</span><span class="op" id="1461827">)</span>&nbsp;<span class="op" id="1461829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461832">var</span>&nbsp;<span class="ident" id="1461836">n</span>&nbsp;<span class="op" id="1461838">=</span>&nbsp;<span class="num" id="1461840">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461843">for</span>&nbsp;<span class="ident" id="1461847">k</span><span class="op" id="1461848">,</span>&nbsp;<span class="ident" id="1461850">v</span>&nbsp;<span class="op" id="1461852">:=</span>&nbsp;<span class="keyword" id="1461855">range</span>&nbsp;<span class="ident" id="1461861">mux</span><span class="op" id="1461864">.</span><span class="ident" id="1461865">m</span>&nbsp;<span class="op" id="1461867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461871">if</span>&nbsp;<span class="op" id="1461874">!</span><span class="ident" id="1461875">pathMatch</span><span class="op" id="1461884">(</span><span class="ident" id="1461885">k</span><span class="op" id="1461886">,</span>&nbsp;<span class="ident" id="1461888">path</span><span class="op" id="1461892">)</span>&nbsp;<span class="op" id="1461894">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461899">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461914">if</span>&nbsp;<span class="ident" id="1461917">h</span>&nbsp;<span class="op" id="1461919">==</span>&nbsp;<span class="ident" id="1461922">nil</span>&nbsp;<span class="op" id="1461926">||</span>&nbsp;<span class="builtinfunc" id="1461929">len</span><span class="op" id="1461932">(</span><span class="ident" id="1461933">k</span><span class="op" id="1461934">)</span>&nbsp;<span class="op" id="1461936">&gt;</span>&nbsp;<span class="ident" id="1461938">n</span>&nbsp;<span class="op" id="1461940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461945">n</span>&nbsp;<span class="op" id="1461947">=</span>&nbsp;<span class="builtinfunc" id="1461949">len</span><span class="op" id="1461952">(</span><span class="ident" id="1461953">k</span><span class="op" id="1461954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461959">h</span>&nbsp;<span class="op" id="1461961">=</span>&nbsp;<span class="ident" id="1461963">v</span><span class="op" id="1461964">.</span><span class="ident" id="1461965">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461970">pattern</span>&nbsp;<span class="op" id="1461978">=</span>&nbsp;<span class="ident" id="1461980">v</span><span class="op" id="1461981">.</span><span class="ident" id="1461982">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461998">return</span><br>
<span class="lineno"></span><span class="op" id="1462005">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="1462008">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="1462069">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1462135">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1462203">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="1462269">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="1462295">//</span><br>
<span class="lineno"></span><span class="comment" id="1462298">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1462362">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="1462424">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="1462485">//</span><br>
<span class="lineno"></span><span class="comment" id="1462488">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="1462554">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="1462624">func</span>&nbsp;<span class="op" id="1462629">(</span><span class="ident" id="1462630">mux</span>&nbsp;<span class="op" id="1462634">*</span><span class="ident" id="1462635">ServeMux</span><span class="op" id="1462643">)</span>&nbsp;<span class="ident" id="1462645">Handler</span><span class="op" id="1462652">(</span><span class="ident" id="1462653">r</span>&nbsp;<span class="op" id="1462655">*</span><span class="ident" id="1462656">Request</span><span class="op" id="1462663">)</span>&nbsp;<span class="op" id="1462665">(</span><span class="ident" id="1462666">h</span>&nbsp;<span class="ident" id="1462668">Handler</span><span class="op" id="1462675">,</span>&nbsp;<span class="ident" id="1462677">pattern</span>&nbsp;<span class="builtintype" id="1462685">string</span><span class="op" id="1462691">)</span>&nbsp;<span class="op" id="1462693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462696">if</span>&nbsp;<span class="ident" id="1462699">r</span><span class="op" id="1462700">.</span><span class="ident" id="1462701">Method</span>&nbsp;<span class="op" id="1462708">!=</span>&nbsp;<span class="string" id="1462711">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="1462721">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462725">if</span>&nbsp;<span class="ident" id="1462728">p</span>&nbsp;<span class="op" id="1462730">:=</span>&nbsp;<span class="ident" id="1462733">cleanPath</span><span class="op" id="1462742">(</span><span class="ident" id="1462743">r</span><span class="op" id="1462744">.</span><span class="ident" id="1462745">URL</span><span class="op" id="1462748">.</span><span class="ident" id="1462749">Path</span><span class="op" id="1462753">)</span><span class="op" id="1462754">;</span>&nbsp;<span class="ident" id="1462756">p</span>&nbsp;<span class="op" id="1462758">!=</span>&nbsp;<span class="ident" id="1462761">r</span><span class="op" id="1462762">.</span><span class="ident" id="1462763">URL</span><span class="op" id="1462766">.</span><span class="ident" id="1462767">Path</span>&nbsp;<span class="op" id="1462772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462777">_</span><span class="op" id="1462778">,</span>&nbsp;<span class="ident" id="1462780">pattern</span>&nbsp;<span class="op" id="1462788">=</span>&nbsp;<span class="ident" id="1462790">mux</span><span class="op" id="1462793">.</span><span class="ident" id="1462794">handler</span><span class="op" id="1462801">(</span><span class="ident" id="1462802">r</span><span class="op" id="1462803">.</span><span class="ident" id="1462804">Host</span><span class="op" id="1462808">,</span>&nbsp;<span class="ident" id="1462810">p</span><span class="op" id="1462811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462816">url</span>&nbsp;<span class="op" id="1462820">:=</span>&nbsp;<span class="op" id="1462823">*</span><span class="ident" id="1462824">r</span><span class="op" id="1462825">.</span><span class="ident" id="1462826">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462833">url</span><span class="op" id="1462836">.</span><span class="ident" id="1462837">Path</span>&nbsp;<span class="op" id="1462842">=</span>&nbsp;<span class="ident" id="1462844">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462849">return</span>&nbsp;<span class="ident" id="1462856">RedirectHandler</span><span class="op" id="1462871">(</span><span class="ident" id="1462872">url</span><span class="op" id="1462875">.</span><span class="ident" id="1462876">String</span><span class="op" id="1462882">(</span><span class="op" id="1462883">)</span><span class="op" id="1462884">,</span>&nbsp;<span class="ident" id="1462886">StatusMovedPermanently</span><span class="op" id="1462908">)</span><span class="op" id="1462909">,</span>&nbsp;<span class="ident" id="1462911">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462928">return</span>&nbsp;<span class="ident" id="1462935">mux</span><span class="op" id="1462938">.</span><span class="ident" id="1462939">handler</span><span class="op" id="1462946">(</span><span class="ident" id="1462947">r</span><span class="op" id="1462948">.</span><span class="ident" id="1462949">Host</span><span class="op" id="1462953">,</span>&nbsp;<span class="ident" id="1462955">r</span><span class="op" id="1462956">.</span><span class="ident" id="1462957">URL</span><span class="op" id="1462960">.</span><span class="ident" id="1462961">Path</span><span class="op" id="1462965">)</span><br>
<span class="lineno"></span><span class="op" id="1462967">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="1462970">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="1463020">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="1463094">func</span>&nbsp;<span class="op" id="1463099">(</span><span class="ident" id="1463100">mux</span>&nbsp;<span class="op" id="1463104">*</span><span class="ident" id="1463105">ServeMux</span><span class="op" id="1463113">)</span>&nbsp;<span class="ident" id="1463115">handler</span><span class="op" id="1463122">(</span><span class="ident" id="1463123">host</span><span class="op" id="1463127">,</span>&nbsp;<span class="ident" id="1463129">path</span>&nbsp;<span class="builtintype" id="1463134">string</span><span class="op" id="1463140">)</span>&nbsp;<span class="op" id="1463142">(</span><span class="ident" id="1463143">h</span>&nbsp;<span class="ident" id="1463145">Handler</span><span class="op" id="1463152">,</span>&nbsp;<span class="ident" id="1463154">pattern</span>&nbsp;<span class="builtintype" id="1463162">string</span><span class="op" id="1463168">)</span>&nbsp;<span class="op" id="1463170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463173">mux</span><span class="op" id="1463176">.</span><span class="ident" id="1463177">mu</span><span class="op" id="1463179">.</span><span class="ident" id="1463180">RLock</span><span class="op" id="1463185">(</span><span class="op" id="1463186">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463189">defer</span>&nbsp;<span class="ident" id="1463195">mux</span><span class="op" id="1463198">.</span><span class="ident" id="1463199">mu</span><span class="op" id="1463201">.</span><span class="ident" id="1463202">RUnlock</span><span class="op" id="1463209">(</span><span class="op" id="1463210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1463214">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463275">if</span>&nbsp;<span class="ident" id="1463278">mux</span><span class="op" id="1463281">.</span><span class="ident" id="1463282">hosts</span>&nbsp;<span class="op" id="1463288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463292">h</span><span class="op" id="1463293">,</span>&nbsp;<span class="ident" id="1463295">pattern</span>&nbsp;<span class="op" id="1463303">=</span>&nbsp;<span class="ident" id="1463305">mux</span><span class="op" id="1463308">.</span><span class="ident" id="1463309">match</span><span class="op" id="1463314">(</span><span class="ident" id="1463315">host</span>&nbsp;<span class="op" id="1463320">+</span>&nbsp;<span class="ident" id="1463322">path</span><span class="op" id="1463326">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463332">if</span>&nbsp;<span class="ident" id="1463335">h</span>&nbsp;<span class="op" id="1463337">==</span>&nbsp;<span class="ident" id="1463340">nil</span>&nbsp;<span class="op" id="1463344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463348">h</span><span class="op" id="1463349">,</span>&nbsp;<span class="ident" id="1463351">pattern</span>&nbsp;<span class="op" id="1463359">=</span>&nbsp;<span class="ident" id="1463361">mux</span><span class="op" id="1463364">.</span><span class="ident" id="1463365">match</span><span class="op" id="1463370">(</span><span class="ident" id="1463371">path</span><span class="op" id="1463375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463381">if</span>&nbsp;<span class="ident" id="1463384">h</span>&nbsp;<span class="op" id="1463386">==</span>&nbsp;<span class="ident" id="1463389">nil</span>&nbsp;<span class="op" id="1463393">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463397">h</span><span class="op" id="1463398">,</span>&nbsp;<span class="ident" id="1463400">pattern</span>&nbsp;<span class="op" id="1463408">=</span>&nbsp;<span class="ident" id="1463410">NotFoundHandler</span><span class="op" id="1463425">(</span><span class="op" id="1463426">)</span><span class="op" id="1463427">,</span>&nbsp;<span class="string" id="1463429">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463436">return</span><br>
<span class="lineno"></span><span class="op" id="1463443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="1463446">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="1463503">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="1463552">func</span>&nbsp;<span class="op" id="1463557">(</span><span class="ident" id="1463558">mux</span>&nbsp;<span class="op" id="1463562">*</span><span class="ident" id="1463563">ServeMux</span><span class="op" id="1463571">)</span>&nbsp;<span class="ident" id="1463573">ServeHTTP</span><span class="op" id="1463582">(</span><span class="ident" id="1463583">w</span>&nbsp;<span class="ident" id="1463585">ResponseWriter</span><span class="op" id="1463599">,</span>&nbsp;<span class="ident" id="1463601">r</span>&nbsp;<span class="op" id="1463603">*</span><span class="ident" id="1463604">Request</span><span class="op" id="1463611">)</span>&nbsp;<span class="op" id="1463613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463616">if</span>&nbsp;<span class="ident" id="1463619">r</span><span class="op" id="1463620">.</span><span class="ident" id="1463621">RequestURI</span>&nbsp;<span class="op" id="1463632">==</span>&nbsp;<span class="string" id="1463635">&#34;*&#34;</span>&nbsp;<span class="op" id="1463639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463643">if</span>&nbsp;<span class="ident" id="1463646">r</span><span class="op" id="1463647">.</span><span class="ident" id="1463648">ProtoAtLeast</span><span class="op" id="1463660">(</span><span class="num" id="1463661">1</span><span class="op" id="1463662">,</span>&nbsp;<span class="num" id="1463664">1</span><span class="op" id="1463665">)</span>&nbsp;<span class="op" id="1463667">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463672">w</span><span class="op" id="1463673">.</span><span class="ident" id="1463674">Header</span><span class="op" id="1463680">(</span><span class="op" id="1463681">)</span><span class="op" id="1463682">.</span><span class="ident" id="1463683">Set</span><span class="op" id="1463686">(</span><span class="string" id="1463687">&#34;Connection&#34;</span><span class="op" id="1463699">,</span>&nbsp;<span class="string" id="1463701">&#34;close&#34;</span><span class="op" id="1463708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463716">w</span><span class="op" id="1463717">.</span><span class="ident" id="1463718">WriteHeader</span><span class="op" id="1463729">(</span><span class="ident" id="1463730">StatusBadRequest</span><span class="op" id="1463746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463750">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463758">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463761">h</span><span class="op" id="1463762">,</span>&nbsp;<span class="ident" id="1463764">_</span>&nbsp;<span class="op" id="1463766">:=</span>&nbsp;<span class="ident" id="1463769">mux</span><span class="op" id="1463772">.</span><span class="ident" id="1463773">Handler</span><span class="op" id="1463780">(</span><span class="ident" id="1463781">r</span><span class="op" id="1463782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463785">h</span><span class="op" id="1463786">.</span><span class="ident" id="1463787">ServeHTTP</span><span class="op" id="1463796">(</span><span class="ident" id="1463797">w</span><span class="op" id="1463798">,</span>&nbsp;<span class="ident" id="1463800">r</span><span class="op" id="1463801">)</span><br>
<span class="lineno"></span><span class="op" id="1463803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1463806">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="1463861">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="1463920">func</span>&nbsp;<span class="op" id="1463925">(</span><span class="ident" id="1463926">mux</span>&nbsp;<span class="op" id="1463930">*</span><span class="ident" id="1463931">ServeMux</span><span class="op" id="1463939">)</span>&nbsp;<span class="ident" id="1463941">Handle</span><span class="op" id="1463947">(</span><span class="ident" id="1463948">pattern</span>&nbsp;<span class="builtintype" id="1463956">string</span><span class="op" id="1463962">,</span>&nbsp;<span class="ident" id="1463964">handler</span>&nbsp;<span class="ident" id="1463972">Handler</span><span class="op" id="1463979">)</span>&nbsp;<span class="op" id="1463981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463984">mux</span><span class="op" id="1463987">.</span><span class="ident" id="1463988">mu</span><span class="op" id="1463990">.</span><span class="ident" id="1463991">Lock</span><span class="op" id="1463995">(</span><span class="op" id="1463996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463999">defer</span>&nbsp;<span class="ident" id="1464005">mux</span><span class="op" id="1464008">.</span><span class="ident" id="1464009">mu</span><span class="op" id="1464011">.</span><span class="ident" id="1464012">Unlock</span><span class="op" id="1464018">(</span><span class="op" id="1464019">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464023">if</span>&nbsp;<span class="ident" id="1464026">pattern</span>&nbsp;<span class="op" id="1464034">==</span>&nbsp;<span class="string" id="1464037">&#34;&#34;</span>&nbsp;<span class="op" id="1464040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1464044">panic</span><span class="op" id="1464049">(</span><span class="string" id="1464050">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="1464075">+</span>&nbsp;<span class="ident" id="1464077">pattern</span><span class="op" id="1464084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464090">if</span>&nbsp;<span class="ident" id="1464093">handler</span>&nbsp;<span class="op" id="1464101">==</span>&nbsp;<span class="ident" id="1464104">nil</span>&nbsp;<span class="op" id="1464108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1464112">panic</span><span class="op" id="1464117">(</span><span class="string" id="1464118">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="1464137">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464143">if</span>&nbsp;<span class="ident" id="1464146">mux</span><span class="op" id="1464149">.</span><span class="ident" id="1464150">m</span><span class="op" id="1464151">[</span><span class="ident" id="1464152">pattern</span><span class="op" id="1464159">]</span><span class="op" id="1464160">.</span><span class="ident" id="1464161">explicit</span>&nbsp;<span class="op" id="1464170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1464174">panic</span><span class="op" id="1464179">(</span><span class="string" id="1464180">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="1464216">+</span>&nbsp;<span class="ident" id="1464218">pattern</span><span class="op" id="1464225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464232">mux</span><span class="op" id="1464235">.</span><span class="ident" id="1464236">m</span><span class="op" id="1464237">[</span><span class="ident" id="1464238">pattern</span><span class="op" id="1464245">]</span>&nbsp;<span class="op" id="1464247">=</span>&nbsp;<span class="ident" id="1464249">muxEntry</span><span class="op" id="1464257">{</span><span class="ident" id="1464258">explicit</span><span class="op" id="1464266">:</span>&nbsp;<span class="builtintype" id="1464268">true</span><span class="op" id="1464272">,</span>&nbsp;<span class="ident" id="1464274">h</span><span class="op" id="1464275">:</span>&nbsp;<span class="ident" id="1464277">handler</span><span class="op" id="1464284">,</span>&nbsp;<span class="ident" id="1464286">pattern</span><span class="op" id="1464293">:</span>&nbsp;<span class="ident" id="1464295">pattern</span><span class="op" id="1464302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464306">if</span>&nbsp;<span class="ident" id="1464309">pattern</span><span class="op" id="1464316">[</span><span class="num" id="1464317">0</span><span class="op" id="1464318">]</span>&nbsp;<span class="op" id="1464320">!=</span>&nbsp;<span class="string" id="1464323">&#39;/&#39;</span>&nbsp;<span class="op" id="1464327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464331">mux</span><span class="op" id="1464334">.</span><span class="ident" id="1464335">hosts</span>&nbsp;<span class="op" id="1464341">=</span>&nbsp;<span class="builtintype" id="1464343">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464349">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464353">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464375">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464450">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464504">n</span>&nbsp;<span class="op" id="1464506">:=</span>&nbsp;<span class="builtinfunc" id="1464509">len</span><span class="op" id="1464512">(</span><span class="ident" id="1464513">pattern</span><span class="op" id="1464520">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464523">if</span>&nbsp;<span class="ident" id="1464526">n</span>&nbsp;<span class="op" id="1464528">&gt;</span>&nbsp;<span class="num" id="1464530">0</span>&nbsp;<span class="op" id="1464532">&amp;&amp;</span>&nbsp;<span class="ident" id="1464535">pattern</span><span class="op" id="1464542">[</span><span class="ident" id="1464543">n</span><span class="op" id="1464544">-</span><span class="num" id="1464545">1</span><span class="op" id="1464546">]</span>&nbsp;<span class="op" id="1464548">==</span>&nbsp;<span class="string" id="1464551">&#39;/&#39;</span>&nbsp;<span class="op" id="1464555">&amp;&amp;</span>&nbsp;<span class="op" id="1464558">!</span><span class="ident" id="1464559">mux</span><span class="op" id="1464562">.</span><span class="ident" id="1464563">m</span><span class="op" id="1464564">[</span><span class="ident" id="1464565">pattern</span><span class="op" id="1464572">[</span><span class="num" id="1464573">0</span><span class="op" id="1464574">:</span><span class="ident" id="1464575">n</span><span class="op" id="1464576">-</span><span class="num" id="1464577">1</span><span class="op" id="1464578">]</span><span class="op" id="1464579">]</span><span class="op" id="1464580">.</span><span class="ident" id="1464581">explicit</span>&nbsp;<span class="op" id="1464590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464594">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464659">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464683">path</span>&nbsp;<span class="op" id="1464688">:=</span>&nbsp;<span class="ident" id="1464691">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464701">if</span>&nbsp;<span class="ident" id="1464704">pattern</span><span class="op" id="1464711">[</span><span class="num" id="1464712">0</span><span class="op" id="1464713">]</span>&nbsp;<span class="op" id="1464715">!=</span>&nbsp;<span class="string" id="1464718">&#39;/&#39;</span>&nbsp;<span class="op" id="1464722">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464727">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1464786">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464819">path</span>&nbsp;<span class="op" id="1464824">=</span>&nbsp;<span class="ident" id="1464826">pattern</span><span class="op" id="1464833">[</span><span class="ident" id="1464834">strings</span><span class="op" id="1464841">.</span><span class="ident" id="1464842">Index</span><span class="op" id="1464847">(</span><span class="ident" id="1464848">pattern</span><span class="op" id="1464855">,</span>&nbsp;<span class="string" id="1464857">&#34;/&#34;</span><span class="op" id="1464860">)</span><span class="op" id="1464861">:</span><span class="op" id="1464862">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464870">mux</span><span class="op" id="1464873">.</span><span class="ident" id="1464874">m</span><span class="op" id="1464875">[</span><span class="ident" id="1464876">pattern</span><span class="op" id="1464883">[</span><span class="num" id="1464884">0</span><span class="op" id="1464885">:</span><span class="ident" id="1464886">n</span><span class="op" id="1464887">-</span><span class="num" id="1464888">1</span><span class="op" id="1464889">]</span><span class="op" id="1464890">]</span>&nbsp;<span class="op" id="1464892">=</span>&nbsp;<span class="ident" id="1464894">muxEntry</span><span class="op" id="1464902">{</span><span class="ident" id="1464903">h</span><span class="op" id="1464904">:</span>&nbsp;<span class="ident" id="1464906">RedirectHandler</span><span class="op" id="1464921">(</span><span class="ident" id="1464922">path</span><span class="op" id="1464926">,</span>&nbsp;<span class="ident" id="1464928">StatusMovedPermanently</span><span class="op" id="1464950">)</span><span class="op" id="1464951">,</span>&nbsp;<span class="ident" id="1464953">pattern</span><span class="op" id="1464960">:</span>&nbsp;<span class="ident" id="1464962">pattern</span><span class="op" id="1464969">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464972">}</span><br>
<span class="lineno"></span><span class="op" id="1464974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1464977">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="1465045">func</span>&nbsp;<span class="op" id="1465050">(</span><span class="ident" id="1465051">mux</span>&nbsp;<span class="op" id="1465055">*</span><span class="ident" id="1465056">ServeMux</span><span class="op" id="1465064">)</span>&nbsp;<span class="ident" id="1465066">HandleFunc</span><span class="op" id="1465076">(</span><span class="ident" id="1465077">pattern</span>&nbsp;<span class="builtintype" id="1465085">string</span><span class="op" id="1465091">,</span>&nbsp;<span class="ident" id="1465093">handler</span>&nbsp;<span class="keyword" id="1465101">func</span><span class="op" id="1465105">(</span><span class="ident" id="1465106">ResponseWriter</span><span class="op" id="1465120">,</span>&nbsp;<span class="op" id="1465122">*</span><span class="ident" id="1465123">Request</span><span class="op" id="1465130">)</span><span class="op" id="1465131">)</span>&nbsp;<span class="op" id="1465133">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465136">mux</span><span class="op" id="1465139">.</span><span class="ident" id="1465140">Handle</span><span class="op" id="1465146">(</span><span class="ident" id="1465147">pattern</span><span class="op" id="1465154">,</span>&nbsp;<span class="ident" id="1465156">HandlerFunc</span><span class="op" id="1465167">(</span><span class="ident" id="1465168">handler</span><span class="op" id="1465175">)</span><span class="op" id="1465176">)</span><br>
<span class="lineno"></span><span class="op" id="1465178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1465181">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="1465235">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="1465262">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="1465331">func</span>&nbsp;<span class="ident" id="1465336">Handle</span><span class="op" id="1465342">(</span><span class="ident" id="1465343">pattern</span>&nbsp;<span class="builtintype" id="1465351">string</span><span class="op" id="1465357">,</span>&nbsp;<span class="ident" id="1465359">handler</span>&nbsp;<span class="ident" id="1465367">Handler</span><span class="op" id="1465374">)</span>&nbsp;<span class="op" id="1465376">{</span>&nbsp;<span class="ident" id="1465378">DefaultServeMux</span><span class="op" id="1465393">.</span><span class="ident" id="1465394">Handle</span><span class="op" id="1465400">(</span><span class="ident" id="1465401">pattern</span><span class="op" id="1465408">,</span>&nbsp;<span class="ident" id="1465410">handler</span><span class="op" id="1465417">)</span>&nbsp;<span class="op" id="1465419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1465422">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="1465489">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="1465516">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="1465585">func</span>&nbsp;<span class="ident" id="1465590">HandleFunc</span><span class="op" id="1465600">(</span><span class="ident" id="1465601">pattern</span>&nbsp;<span class="builtintype" id="1465609">string</span><span class="op" id="1465615">,</span>&nbsp;<span class="ident" id="1465617">handler</span>&nbsp;<span class="keyword" id="1465625">func</span><span class="op" id="1465629">(</span><span class="ident" id="1465630">ResponseWriter</span><span class="op" id="1465644">,</span>&nbsp;<span class="op" id="1465646">*</span><span class="ident" id="1465647">Request</span><span class="op" id="1465654">)</span><span class="op" id="1465655">)</span>&nbsp;<span class="op" id="1465657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465660">DefaultServeMux</span><span class="op" id="1465675">.</span><span class="ident" id="1465676">HandleFunc</span><span class="op" id="1465686">(</span><span class="ident" id="1465687">pattern</span><span class="op" id="1465694">,</span>&nbsp;<span class="ident" id="1465696">handler</span><span class="op" id="1465703">)</span><br>
<span class="lineno"></span><span class="op" id="1465705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="1465708">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="1465770">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1465840">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="1465897">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1465969">func</span>&nbsp;<span class="ident" id="1465974">Serve</span><span class="op" id="1465979">(</span><span class="ident" id="1465980">l</span>&nbsp;<span class="ident" id="1465982">net</span><span class="op" id="1465985">.</span><span class="ident" id="1465986">Listener</span><span class="op" id="1465994">,</span>&nbsp;<span class="ident" id="1465996">handler</span>&nbsp;<span class="ident" id="1466004">Handler</span><span class="op" id="1466011">)</span>&nbsp;<span class="builtintype" id="1466013">error</span>&nbsp;<span class="op" id="1466019">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466022">srv</span>&nbsp;<span class="op" id="1466026">:=</span>&nbsp;<span class="op" id="1466029">&amp;</span><span class="ident" id="1466030">Server</span><span class="op" id="1466036">{</span><span class="ident" id="1466037">Handler</span><span class="op" id="1466044">:</span>&nbsp;<span class="ident" id="1466046">handler</span><span class="op" id="1466053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466056">return</span>&nbsp;<span class="ident" id="1466063">srv</span><span class="op" id="1466066">.</span><span class="ident" id="1466067">Serve</span><span class="op" id="1466072">(</span><span class="ident" id="1466073">l</span><span class="op" id="1466074">)</span><br>
<span class="lineno"></span><span class="op" id="1466076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1466079">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="1466138">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="1466193">type</span>&nbsp;<span class="ident" id="1466198">Server</span>&nbsp;<span class="keyword" id="1466205">struct</span>&nbsp;<span class="op" id="1466212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466215">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1466230">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466244">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466291">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466306">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466320">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466371">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466386">time</span><span class="op" id="1466390">.</span><span class="ident" id="1466391">Duration</span>&nbsp;<span class="comment" id="1466400">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466459">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1466474">time</span><span class="op" id="1466478">.</span><span class="ident" id="1466479">Duration</span>&nbsp;<span class="comment" id="1466488">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466549">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="1466564">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466578">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466642">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466657">*</span><span class="ident" id="1466658">tls</span><span class="op" id="1466661">.</span><span class="ident" id="1466662">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1466671">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1466723">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1466785">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1466842">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1466906">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1466966">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467029">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467087">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467139">TLSNextProto</span>&nbsp;<span class="keyword" id="1467152">map</span><span class="op" id="1467155">[</span><span class="builtintype" id="1467156">string</span><span class="op" id="1467162">]</span><span class="keyword" id="1467163">func</span><span class="op" id="1467167">(</span><span class="op" id="1467168">*</span><span class="ident" id="1467169">Server</span><span class="op" id="1467175">,</span>&nbsp;<span class="op" id="1467177">*</span><span class="ident" id="1467178">tls</span><span class="op" id="1467181">.</span><span class="ident" id="1467182">Conn</span><span class="op" id="1467186">,</span>&nbsp;<span class="ident" id="1467188">Handler</span><span class="op" id="1467195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467199">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467261">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467320">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467377">ConnState</span>&nbsp;<span class="keyword" id="1467387">func</span><span class="op" id="1467391">(</span><span class="ident" id="1467392">net</span><span class="op" id="1467395">.</span><span class="ident" id="1467396">Conn</span><span class="op" id="1467400">,</span>&nbsp;<span class="ident" id="1467402">ConnState</span><span class="op" id="1467411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467415">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467478">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467533">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467593">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467614">ErrorLog</span>&nbsp;<span class="op" id="1467623">*</span><span class="ident" id="1467624">log</span><span class="op" id="1467627">.</span><span class="ident" id="1467628">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467637">disableKeepAlives</span>&nbsp;<span class="builtintype" id="1467655">int32</span>&nbsp;<span class="comment" id="1467661">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="1467685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1467688">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="1467760">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="1467812">type</span>&nbsp;<span class="ident" id="1467817">ConnState</span>&nbsp;<span class="builtintype" id="1467827">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="1467832">const</span>&nbsp;<span class="op" id="1467838">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467841">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467902">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467960">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468015">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468032">StateNew</span>&nbsp;<span class="ident" id="1468041">ConnState</span>&nbsp;<span class="op" id="1468051">=</span>&nbsp;<span class="ident" id="1468053">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468060">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468124">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468178">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468241">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468295">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468348">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468409">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468423">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468479">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468542">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468603">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468645">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468657">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468709">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468778">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468794">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468842">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468900">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468931">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="1468943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1468946">var</span>&nbsp;<span class="ident" id="1468950">stateName</span>&nbsp;<span class="op" id="1468960">=</span>&nbsp;<span class="keyword" id="1468962">map</span><span class="op" id="1468965">[</span><span class="ident" id="1468966">ConnState</span><span class="op" id="1468975">]</span><span class="builtintype" id="1468976">string</span><span class="op" id="1468982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468985">StateNew</span><span class="op" id="1468993">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1469000">&#34;new&#34;</span><span class="op" id="1469005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469008">StateActive</span><span class="op" id="1469019">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1469023">&#34;active&#34;</span><span class="op" id="1469031">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469034">StateIdle</span><span class="op" id="1469043">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1469049">&#34;idle&#34;</span><span class="op" id="1469055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469058">StateHijacked</span><span class="op" id="1469071">:</span>&nbsp;<span class="string" id="1469073">&#34;hijacked&#34;</span><span class="op" id="1469083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469086">StateClosed</span><span class="op" id="1469097">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1469101">&#34;closed&#34;</span><span class="op" id="1469109">,</span><br>
<span class="lineno"></span><span class="op" id="1469111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="1469114">func</span>&nbsp;<span class="op" id="1469119">(</span><span class="ident" id="1469120">c</span>&nbsp;<span class="ident" id="1469122">ConnState</span><span class="op" id="1469131">)</span>&nbsp;<span class="ident" id="1469133">String</span><span class="op" id="1469139">(</span><span class="op" id="1469140">)</span>&nbsp;<span class="builtintype" id="1469142">string</span>&nbsp;<span class="op" id="1469149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469152">return</span>&nbsp;<span class="ident" id="1469159">stateName</span><span class="op" id="1469168">[</span><span class="ident" id="1469169">c</span><span class="op" id="1469170">]</span><br>
<span class="lineno"></span><span class="op" id="1469172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1469175">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="1469236">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="1469294">type</span>&nbsp;<span class="ident" id="1469299">serverHandler</span>&nbsp;<span class="keyword" id="1469313">struct</span>&nbsp;<span class="op" id="1469320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469323">srv</span>&nbsp;<span class="op" id="1469327">*</span><span class="ident" id="1469328">Server</span><br>
<span class="lineno"></span><span class="op" id="1469335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="1469338">func</span>&nbsp;<span class="op" id="1469343">(</span><span class="ident" id="1469344">sh</span>&nbsp;<span class="ident" id="1469347">serverHandler</span><span class="op" id="1469360">)</span>&nbsp;<span class="ident" id="1469362">ServeHTTP</span><span class="op" id="1469371">(</span><span class="ident" id="1469372">rw</span>&nbsp;<span class="ident" id="1469375">ResponseWriter</span><span class="op" id="1469389">,</span>&nbsp;<span class="ident" id="1469391">req</span>&nbsp;<span class="op" id="1469395">*</span><span class="ident" id="1469396">Request</span><span class="op" id="1469403">)</span>&nbsp;<span class="op" id="1469405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469408">handler</span>&nbsp;<span class="op" id="1469416">:=</span>&nbsp;<span class="ident" id="1469419">sh</span><span class="op" id="1469421">.</span><span class="ident" id="1469422">srv</span><span class="op" id="1469425">.</span><span class="ident" id="1469426">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469435">if</span>&nbsp;<span class="ident" id="1469438">handler</span>&nbsp;<span class="op" id="1469446">==</span>&nbsp;<span class="ident" id="1469449">nil</span>&nbsp;<span class="op" id="1469453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469457">handler</span>&nbsp;<span class="op" id="1469465">=</span>&nbsp;<span class="ident" id="1469467">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469484">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469487">if</span>&nbsp;<span class="ident" id="1469490">req</span><span class="op" id="1469493">.</span><span class="ident" id="1469494">RequestURI</span>&nbsp;<span class="op" id="1469505">==</span>&nbsp;<span class="string" id="1469508">&#34;*&#34;</span>&nbsp;<span class="op" id="1469512">&amp;&amp;</span>&nbsp;<span class="ident" id="1469515">req</span><span class="op" id="1469518">.</span><span class="ident" id="1469519">Method</span>&nbsp;<span class="op" id="1469526">==</span>&nbsp;<span class="string" id="1469529">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="1469539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469543">handler</span>&nbsp;<span class="op" id="1469551">=</span>&nbsp;<span class="ident" id="1469553">globalOptionsHandler</span><span class="op" id="1469573">{</span><span class="op" id="1469574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469580">handler</span><span class="op" id="1469587">.</span><span class="ident" id="1469588">ServeHTTP</span><span class="op" id="1469597">(</span><span class="ident" id="1469598">rw</span><span class="op" id="1469600">,</span>&nbsp;<span class="ident" id="1469602">req</span><span class="op" id="1469605">)</span><br>
<span class="lineno"></span><span class="op" id="1469607">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="1469610">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1469681">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="1469744">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1469783">func</span>&nbsp;<span class="op" id="1469788">(</span><span class="ident" id="1469789">srv</span>&nbsp;<span class="op" id="1469793">*</span><span class="ident" id="1469794">Server</span><span class="op" id="1469800">)</span>&nbsp;<span class="ident" id="1469802">ListenAndServe</span><span class="op" id="1469816">(</span><span class="op" id="1469817">)</span>&nbsp;<span class="builtintype" id="1469819">error</span>&nbsp;<span class="op" id="1469825">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469828">addr</span>&nbsp;<span class="op" id="1469833">:=</span>&nbsp;<span class="ident" id="1469836">srv</span><span class="op" id="1469839">.</span><span class="ident" id="1469840">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469846">if</span>&nbsp;<span class="ident" id="1469849">addr</span>&nbsp;<span class="op" id="1469854">==</span>&nbsp;<span class="string" id="1469857">&#34;&#34;</span>&nbsp;<span class="op" id="1469860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469864">addr</span>&nbsp;<span class="op" id="1469869">=</span>&nbsp;<span class="string" id="1469871">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469883">ln</span><span class="op" id="1469885">,</span>&nbsp;<span class="ident" id="1469887">err</span>&nbsp;<span class="op" id="1469891">:=</span>&nbsp;<span class="ident" id="1469894">net</span><span class="op" id="1469897">.</span><span class="ident" id="1469898">Listen</span><span class="op" id="1469904">(</span><span class="string" id="1469905">&#34;tcp&#34;</span><span class="op" id="1469910">,</span>&nbsp;<span class="ident" id="1469912">addr</span><span class="op" id="1469916">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469919">if</span>&nbsp;<span class="ident" id="1469922">err</span>&nbsp;<span class="op" id="1469926">!=</span>&nbsp;<span class="ident" id="1469929">nil</span>&nbsp;<span class="op" id="1469933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469937">return</span>&nbsp;<span class="ident" id="1469944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469952">return</span>&nbsp;<span class="ident" id="1469959">srv</span><span class="op" id="1469962">.</span><span class="ident" id="1469963">Serve</span><span class="op" id="1469968">(</span><span class="ident" id="1469969">tcpKeepAliveListener</span><span class="op" id="1469989">{</span><span class="ident" id="1469990">ln</span><span class="op" id="1469992">.</span><span class="op" id="1469993">(</span><span class="op" id="1469994">*</span><span class="ident" id="1469995">net</span><span class="op" id="1469998">.</span><span class="ident" id="1469999">TCPListener</span><span class="op" id="1470010">)</span><span class="op" id="1470011">}</span><span class="op" id="1470012">)</span><br>
<span class="lineno"></span><span class="op" id="1470014">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="1470017">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1470085">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1470162">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="1470205">func</span>&nbsp;<span class="op" id="1470210">(</span><span class="ident" id="1470211">srv</span>&nbsp;<span class="op" id="1470215">*</span><span class="ident" id="1470216">Server</span><span class="op" id="1470222">)</span>&nbsp;<span class="ident" id="1470224">Serve</span><span class="op" id="1470229">(</span><span class="ident" id="1470230">l</span>&nbsp;<span class="ident" id="1470232">net</span><span class="op" id="1470235">.</span><span class="ident" id="1470236">Listener</span><span class="op" id="1470244">)</span>&nbsp;<span class="builtintype" id="1470246">error</span>&nbsp;<span class="op" id="1470252">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470255">defer</span>&nbsp;<span class="ident" id="1470261">l</span><span class="op" id="1470262">.</span><span class="ident" id="1470263">Close</span><span class="op" id="1470268">(</span><span class="op" id="1470269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470272">var</span>&nbsp;<span class="ident" id="1470276">tempDelay</span>&nbsp;<span class="ident" id="1470286">time</span><span class="op" id="1470290">.</span><span class="ident" id="1470291">Duration</span>&nbsp;<span class="comment" id="1470300">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470340">for</span>&nbsp;<span class="op" id="1470344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470348">rw</span><span class="op" id="1470350">,</span>&nbsp;<span class="ident" id="1470352">e</span>&nbsp;<span class="op" id="1470354">:=</span>&nbsp;<span class="ident" id="1470357">l</span><span class="op" id="1470358">.</span><span class="ident" id="1470359">Accept</span><span class="op" id="1470365">(</span><span class="op" id="1470366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470370">if</span>&nbsp;<span class="ident" id="1470373">e</span>&nbsp;<span class="op" id="1470375">!=</span>&nbsp;<span class="ident" id="1470378">nil</span>&nbsp;<span class="op" id="1470382">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470387">if</span>&nbsp;<span class="ident" id="1470390">ne</span><span class="op" id="1470392">,</span>&nbsp;<span class="ident" id="1470394">ok</span>&nbsp;<span class="op" id="1470397">:=</span>&nbsp;<span class="ident" id="1470400">e</span><span class="op" id="1470401">.</span><span class="op" id="1470402">(</span><span class="ident" id="1470403">net</span><span class="op" id="1470406">.</span><span class="ident" id="1470407">Error</span><span class="op" id="1470412">)</span><span class="op" id="1470413">;</span>&nbsp;<span class="ident" id="1470415">ok</span>&nbsp;<span class="op" id="1470418">&amp;&amp;</span>&nbsp;<span class="ident" id="1470421">ne</span><span class="op" id="1470423">.</span><span class="ident" id="1470424">Temporary</span><span class="op" id="1470433">(</span><span class="op" id="1470434">)</span>&nbsp;<span class="op" id="1470436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470442">if</span>&nbsp;<span class="ident" id="1470445">tempDelay</span>&nbsp;<span class="op" id="1470455">==</span>&nbsp;<span class="num" id="1470458">0</span>&nbsp;<span class="op" id="1470460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470467">tempDelay</span>&nbsp;<span class="op" id="1470477">=</span>&nbsp;<span class="num" id="1470479">5</span>&nbsp;<span class="op" id="1470481">*</span>&nbsp;<span class="ident" id="1470483">time</span><span class="op" id="1470487">.</span><span class="ident" id="1470488">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470504">}</span>&nbsp;<span class="keyword" id="1470506">else</span>&nbsp;<span class="op" id="1470511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470518">tempDelay</span>&nbsp;<span class="op" id="1470528">*=</span>&nbsp;<span class="num" id="1470531">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470543">if</span>&nbsp;<span class="ident" id="1470546">max</span>&nbsp;<span class="op" id="1470550">:=</span>&nbsp;<span class="num" id="1470553">1</span>&nbsp;<span class="op" id="1470555">*</span>&nbsp;<span class="ident" id="1470557">time</span><span class="op" id="1470561">.</span><span class="ident" id="1470562">Second</span><span class="op" id="1470568">;</span>&nbsp;<span class="ident" id="1470570">tempDelay</span>&nbsp;<span class="op" id="1470580">&gt;</span>&nbsp;<span class="ident" id="1470582">max</span>&nbsp;<span class="op" id="1470586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470593">tempDelay</span>&nbsp;<span class="op" id="1470603">=</span>&nbsp;<span class="ident" id="1470605">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470619">srv</span><span class="op" id="1470622">.</span><span class="ident" id="1470623">logf</span><span class="op" id="1470627">(</span><span class="string" id="1470628">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="1470668">,</span>&nbsp;<span class="ident" id="1470670">e</span><span class="op" id="1470671">,</span>&nbsp;<span class="ident" id="1470673">tempDelay</span><span class="op" id="1470682">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470688">time</span><span class="op" id="1470692">.</span><span class="ident" id="1470693">Sleep</span><span class="op" id="1470698">(</span><span class="ident" id="1470699">tempDelay</span><span class="op" id="1470708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470714">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470731">return</span>&nbsp;<span class="ident" id="1470738">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470742">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470746">tempDelay</span>&nbsp;<span class="op" id="1470756">=</span>&nbsp;<span class="num" id="1470758">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470762">c</span><span class="op" id="1470763">,</span>&nbsp;<span class="ident" id="1470765">err</span>&nbsp;<span class="op" id="1470769">:=</span>&nbsp;<span class="ident" id="1470772">srv</span><span class="op" id="1470775">.</span><span class="ident" id="1470776">newConn</span><span class="op" id="1470783">(</span><span class="ident" id="1470784">rw</span><span class="op" id="1470786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470790">if</span>&nbsp;<span class="ident" id="1470793">err</span>&nbsp;<span class="op" id="1470797">!=</span>&nbsp;<span class="ident" id="1470800">nil</span>&nbsp;<span class="op" id="1470804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470809">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470820">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470824">c</span><span class="op" id="1470825">.</span><span class="ident" id="1470826">setState</span><span class="op" id="1470834">(</span><span class="ident" id="1470835">c</span><span class="op" id="1470836">.</span><span class="ident" id="1470837">rwc</span><span class="op" id="1470840">,</span>&nbsp;<span class="ident" id="1470842">StateNew</span><span class="op" id="1470850">)</span>&nbsp;<span class="comment" id="1470852">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470881">go</span>&nbsp;<span class="ident" id="1470884">c</span><span class="op" id="1470885">.</span><span class="ident" id="1470886">serve</span><span class="op" id="1470891">(</span><span class="op" id="1470892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470895">}</span><br>
<span class="lineno"></span><span class="op" id="1470897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="1470900">func</span>&nbsp;<span class="op" id="1470905">(</span><span class="ident" id="1470906">s</span>&nbsp;<span class="op" id="1470908">*</span><span class="ident" id="1470909">Server</span><span class="op" id="1470915">)</span>&nbsp;<span class="ident" id="1470917">doKeepAlives</span><span class="op" id="1470929">(</span><span class="op" id="1470930">)</span>&nbsp;<span class="builtintype" id="1470932">bool</span>&nbsp;<span class="op" id="1470937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470940">return</span>&nbsp;<span class="ident" id="1470947">atomic</span><span class="op" id="1470953">.</span><span class="ident" id="1470954">LoadInt32</span><span class="op" id="1470963">(</span><span class="op" id="1470964">&amp;</span><span class="ident" id="1470965">s</span><span class="op" id="1470966">.</span><span class="ident" id="1470967">disableKeepAlives</span><span class="op" id="1470984">)</span>&nbsp;<span class="op" id="1470986">==</span>&nbsp;<span class="num" id="1470989">0</span><br>
<span class="lineno"></span><span class="op" id="1470991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1470994">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="1471065">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="1471122">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1471188">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="1471226">func</span>&nbsp;<span class="op" id="1471231">(</span><span class="ident" id="1471232">s</span>&nbsp;<span class="op" id="1471234">*</span><span class="ident" id="1471235">Server</span><span class="op" id="1471241">)</span>&nbsp;<span class="ident" id="1471243">SetKeepAlivesEnabled</span><span class="op" id="1471263">(</span><span class="ident" id="1471264">v</span>&nbsp;<span class="builtintype" id="1471266">bool</span><span class="op" id="1471270">)</span>&nbsp;<span class="op" id="1471272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471275">if</span>&nbsp;<span class="ident" id="1471278">v</span>&nbsp;<span class="op" id="1471280">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471284">atomic</span><span class="op" id="1471290">.</span><span class="ident" id="1471291">StoreInt32</span><span class="op" id="1471301">(</span><span class="op" id="1471302">&amp;</span><span class="ident" id="1471303">s</span><span class="op" id="1471304">.</span><span class="ident" id="1471305">disableKeepAlives</span><span class="op" id="1471322">,</span>&nbsp;<span class="num" id="1471324">0</span><span class="op" id="1471325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471328">}</span>&nbsp;<span class="keyword" id="1471330">else</span>&nbsp;<span class="op" id="1471335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471339">atomic</span><span class="op" id="1471345">.</span><span class="ident" id="1471346">StoreInt32</span><span class="op" id="1471356">(</span><span class="op" id="1471357">&amp;</span><span class="ident" id="1471358">s</span><span class="op" id="1471359">.</span><span class="ident" id="1471360">disableKeepAlives</span><span class="op" id="1471377">,</span>&nbsp;<span class="num" id="1471379">1</span><span class="op" id="1471380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471383">}</span><br>
<span class="lineno"></span><span class="op" id="1471385">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="1471388">func</span>&nbsp;<span class="op" id="1471393">(</span><span class="ident" id="1471394">s</span>&nbsp;<span class="op" id="1471396">*</span><span class="ident" id="1471397">Server</span><span class="op" id="1471403">)</span>&nbsp;<span class="ident" id="1471405">logf</span><span class="op" id="1471409">(</span><span class="ident" id="1471410">format</span>&nbsp;<span class="builtintype" id="1471417">string</span><span class="op" id="1471423">,</span>&nbsp;<span class="ident" id="1471425">args</span>&nbsp;<span class="op" id="1471430">...</span><span class="keyword" id="1471433">interface</span><span class="op" id="1471442">{</span><span class="op" id="1471443">}</span><span class="op" id="1471444">)</span>&nbsp;<span class="op" id="1471446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471449">if</span>&nbsp;<span class="ident" id="1471452">s</span><span class="op" id="1471453">.</span><span class="ident" id="1471454">ErrorLog</span>&nbsp;<span class="op" id="1471463">!=</span>&nbsp;<span class="ident" id="1471466">nil</span>&nbsp;<span class="op" id="1471470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471474">s</span><span class="op" id="1471475">.</span><span class="ident" id="1471476">ErrorLog</span><span class="op" id="1471484">.</span><span class="ident" id="1471485">Printf</span><span class="op" id="1471491">(</span><span class="ident" id="1471492">format</span><span class="op" id="1471498">,</span>&nbsp;<span class="ident" id="1471500">args</span><span class="op" id="1471504">...</span><span class="op" id="1471507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471510">}</span>&nbsp;<span class="keyword" id="1471512">else</span>&nbsp;<span class="op" id="1471517">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471521">log</span><span class="op" id="1471524">.</span><span class="ident" id="1471525">Printf</span><span class="op" id="1471531">(</span><span class="ident" id="1471532">format</span><span class="op" id="1471538">,</span>&nbsp;<span class="ident" id="1471540">args</span><span class="op" id="1471544">...</span><span class="op" id="1471547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471550">}</span><br>
<span class="lineno"></span><span class="op" id="1471552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1471555">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="1471613">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="1471669">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="1471724">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="1471770">//</span><br>
<span class="lineno"></span><span class="comment" id="1471773">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="1471805">//</span><br>
<span class="lineno"></span><span class="comment" id="1471808">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="1471824">//</span><br>
<span class="lineno"></span><span class="comment" id="1471827">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="1471839">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="1471848">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1471863">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1471873">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="1471878">//</span><br>
<span class="lineno"></span><span class="comment" id="1471881">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="1471915">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1471979">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1472020">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1472025">//</span><br>
<span class="lineno"></span><span class="comment" id="1472028">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="1472045">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="1472088">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="1472134">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1472154">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="1472194">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="1472200">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="1472205">func</span>&nbsp;<span class="ident" id="1472210">ListenAndServe</span><span class="op" id="1472224">(</span><span class="ident" id="1472225">addr</span>&nbsp;<span class="builtintype" id="1472230">string</span><span class="op" id="1472236">,</span>&nbsp;<span class="ident" id="1472238">handler</span>&nbsp;<span class="ident" id="1472246">Handler</span><span class="op" id="1472253">)</span>&nbsp;<span class="builtintype" id="1472255">error</span>&nbsp;<span class="op" id="1472261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472264">server</span>&nbsp;<span class="op" id="1472271">:=</span>&nbsp;<span class="op" id="1472274">&amp;</span><span class="ident" id="1472275">Server</span><span class="op" id="1472281">{</span><span class="ident" id="1472282">Addr</span><span class="op" id="1472286">:</span>&nbsp;<span class="ident" id="1472288">addr</span><span class="op" id="1472292">,</span>&nbsp;<span class="ident" id="1472294">Handler</span><span class="op" id="1472301">:</span>&nbsp;<span class="ident" id="1472303">handler</span><span class="op" id="1472310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472313">return</span>&nbsp;<span class="ident" id="1472320">server</span><span class="op" id="1472326">.</span><span class="ident" id="1472327">ListenAndServe</span><span class="op" id="1472341">(</span><span class="op" id="1472342">)</span><br>
<span class="lineno"></span><span class="op" id="1472344">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="1472347">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1472419">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1472498">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="1472574">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="1472656">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="1472721">//</span><br>
<span class="lineno"></span><span class="comment" id="1472724">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="1472756">//</span><br>
<span class="lineno"></span><span class="comment" id="1472759">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="1472771">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1472781">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="1472796">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="1472801">//</span><br>
<span class="lineno"></span><span class="comment" id="1472804">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="1472864">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1472913">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="1472965">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1472970">//</span><br>
<span class="lineno"></span><span class="comment" id="1472973">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="1472990">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="1473024">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1473099">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="1473171">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1473191">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="1473211">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1473217">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1473222">//</span><br>
<span class="lineno"></span><span class="comment" id="1473225">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="1473305">func</span>&nbsp;<span class="ident" id="1473310">ListenAndServeTLS</span><span class="op" id="1473327">(</span><span class="ident" id="1473328">addr</span>&nbsp;<span class="builtintype" id="1473333">string</span><span class="op" id="1473339">,</span>&nbsp;<span class="ident" id="1473341">certFile</span>&nbsp;<span class="builtintype" id="1473350">string</span><span class="op" id="1473356">,</span>&nbsp;<span class="ident" id="1473358">keyFile</span>&nbsp;<span class="builtintype" id="1473366">string</span><span class="op" id="1473372">,</span>&nbsp;<span class="ident" id="1473374">handler</span>&nbsp;<span class="ident" id="1473382">Handler</span><span class="op" id="1473389">)</span>&nbsp;<span class="builtintype" id="1473391">error</span>&nbsp;<span class="op" id="1473397">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473400">server</span>&nbsp;<span class="op" id="1473407">:=</span>&nbsp;<span class="op" id="1473410">&amp;</span><span class="ident" id="1473411">Server</span><span class="op" id="1473417">{</span><span class="ident" id="1473418">Addr</span><span class="op" id="1473422">:</span>&nbsp;<span class="ident" id="1473424">addr</span><span class="op" id="1473428">,</span>&nbsp;<span class="ident" id="1473430">Handler</span><span class="op" id="1473437">:</span>&nbsp;<span class="ident" id="1473439">handler</span><span class="op" id="1473446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473449">return</span>&nbsp;<span class="ident" id="1473456">server</span><span class="op" id="1473462">.</span><span class="ident" id="1473463">ListenAndServeTLS</span><span class="op" id="1473480">(</span><span class="ident" id="1473481">certFile</span><span class="op" id="1473489">,</span>&nbsp;<span class="ident" id="1473491">keyFile</span><span class="op" id="1473498">)</span><br>
<span class="lineno"></span><span class="op" id="1473500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1473503">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="1473572">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="1473640">//</span><br>
<span class="lineno"></span><span class="comment" id="1473643">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1473710">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1473776">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="1473843">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="1473908">//</span><br>
<span class="lineno"></span><span class="comment" id="1473911">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1473954">func</span>&nbsp;<span class="op" id="1473959">(</span><span class="ident" id="1473960">srv</span>&nbsp;<span class="op" id="1473964">*</span><span class="ident" id="1473965">Server</span><span class="op" id="1473971">)</span>&nbsp;<span class="ident" id="1473973">ListenAndServeTLS</span><span class="op" id="1473990">(</span><span class="ident" id="1473991">certFile</span><span class="op" id="1473999">,</span>&nbsp;<span class="ident" id="1474001">keyFile</span>&nbsp;<span class="builtintype" id="1474009">string</span><span class="op" id="1474015">)</span>&nbsp;<span class="builtintype" id="1474017">error</span>&nbsp;<span class="op" id="1474023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474026">addr</span>&nbsp;<span class="op" id="1474031">:=</span>&nbsp;<span class="ident" id="1474034">srv</span><span class="op" id="1474037">.</span><span class="ident" id="1474038">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474044">if</span>&nbsp;<span class="ident" id="1474047">addr</span>&nbsp;<span class="op" id="1474052">==</span>&nbsp;<span class="string" id="1474055">&#34;&#34;</span>&nbsp;<span class="op" id="1474058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474062">addr</span>&nbsp;<span class="op" id="1474067">=</span>&nbsp;<span class="string" id="1474069">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474082">config</span>&nbsp;<span class="op" id="1474089">:=</span>&nbsp;<span class="op" id="1474092">&amp;</span><span class="ident" id="1474093">tls</span><span class="op" id="1474096">.</span><span class="ident" id="1474097">Config</span><span class="op" id="1474103">{</span><span class="op" id="1474104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474107">if</span>&nbsp;<span class="ident" id="1474110">srv</span><span class="op" id="1474113">.</span><span class="ident" id="1474114">TLSConfig</span>&nbsp;<span class="op" id="1474124">!=</span>&nbsp;<span class="ident" id="1474127">nil</span>&nbsp;<span class="op" id="1474131">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474135">*</span><span class="ident" id="1474136">config</span>&nbsp;<span class="op" id="1474143">=</span>&nbsp;<span class="op" id="1474145">*</span><span class="ident" id="1474146">srv</span><span class="op" id="1474149">.</span><span class="ident" id="1474150">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474164">if</span>&nbsp;<span class="ident" id="1474167">config</span><span class="op" id="1474173">.</span><span class="ident" id="1474174">NextProtos</span>&nbsp;<span class="op" id="1474185">==</span>&nbsp;<span class="ident" id="1474188">nil</span>&nbsp;<span class="op" id="1474192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474196">config</span><span class="op" id="1474202">.</span><span class="ident" id="1474203">NextProtos</span>&nbsp;<span class="op" id="1474214">=</span>&nbsp;<span class="op" id="1474216">[</span><span class="op" id="1474217">]</span><span class="builtintype" id="1474218">string</span><span class="op" id="1474224">{</span><span class="string" id="1474225">&#34;http/1.1&#34;</span><span class="op" id="1474235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474238">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474242">var</span>&nbsp;<span class="ident" id="1474246">err</span>&nbsp;<span class="builtintype" id="1474250">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474257">config</span><span class="op" id="1474263">.</span><span class="ident" id="1474264">Certificates</span>&nbsp;<span class="op" id="1474277">=</span>&nbsp;<span class="builtinfunc" id="1474279">make</span><span class="op" id="1474283">(</span><span class="op" id="1474284">[</span><span class="op" id="1474285">]</span><span class="ident" id="1474286">tls</span><span class="op" id="1474289">.</span><span class="ident" id="1474290">Certificate</span><span class="op" id="1474301">,</span>&nbsp;<span class="num" id="1474303">1</span><span class="op" id="1474304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474307">config</span><span class="op" id="1474313">.</span><span class="ident" id="1474314">Certificates</span><span class="op" id="1474326">[</span><span class="num" id="1474327">0</span><span class="op" id="1474328">]</span><span class="op" id="1474329">,</span>&nbsp;<span class="ident" id="1474331">err</span>&nbsp;<span class="op" id="1474335">=</span>&nbsp;<span class="ident" id="1474337">tls</span><span class="op" id="1474340">.</span><span class="ident" id="1474341">LoadX509KeyPair</span><span class="op" id="1474356">(</span><span class="ident" id="1474357">certFile</span><span class="op" id="1474365">,</span>&nbsp;<span class="ident" id="1474367">keyFile</span><span class="op" id="1474374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474377">if</span>&nbsp;<span class="ident" id="1474380">err</span>&nbsp;<span class="op" id="1474384">!=</span>&nbsp;<span class="ident" id="1474387">nil</span>&nbsp;<span class="op" id="1474391">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474395">return</span>&nbsp;<span class="ident" id="1474402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474411">ln</span><span class="op" id="1474413">,</span>&nbsp;<span class="ident" id="1474415">err</span>&nbsp;<span class="op" id="1474419">:=</span>&nbsp;<span class="ident" id="1474422">net</span><span class="op" id="1474425">.</span><span class="ident" id="1474426">Listen</span><span class="op" id="1474432">(</span><span class="string" id="1474433">&#34;tcp&#34;</span><span class="op" id="1474438">,</span>&nbsp;<span class="ident" id="1474440">addr</span><span class="op" id="1474444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474447">if</span>&nbsp;<span class="ident" id="1474450">err</span>&nbsp;<span class="op" id="1474454">!=</span>&nbsp;<span class="ident" id="1474457">nil</span>&nbsp;<span class="op" id="1474461">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474465">return</span>&nbsp;<span class="ident" id="1474472">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474481">tlsListener</span>&nbsp;<span class="op" id="1474493">:=</span>&nbsp;<span class="ident" id="1474496">tls</span><span class="op" id="1474499">.</span><span class="ident" id="1474500">NewListener</span><span class="op" id="1474511">(</span><span class="ident" id="1474512">tcpKeepAliveListener</span><span class="op" id="1474532">{</span><span class="ident" id="1474533">ln</span><span class="op" id="1474535">.</span><span class="op" id="1474536">(</span><span class="op" id="1474537">*</span><span class="ident" id="1474538">net</span><span class="op" id="1474541">.</span><span class="ident" id="1474542">TCPListener</span><span class="op" id="1474553">)</span><span class="op" id="1474554">}</span><span class="op" id="1474555">,</span>&nbsp;<span class="ident" id="1474557">config</span><span class="op" id="1474563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474566">return</span>&nbsp;<span class="ident" id="1474573">srv</span><span class="op" id="1474576">.</span><span class="ident" id="1474577">Serve</span><span class="op" id="1474582">(</span><span class="ident" id="1474583">tlsListener</span><span class="op" id="1474594">)</span><br>
<span class="lineno">1880</span><span class="op" id="1474596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1474599">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="1474674">//</span><br>
<span class="lineno"></span><span class="comment" id="1474677">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="1474747">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1474818">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="1474888">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="1474951">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1475022">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="1475044">func</span>&nbsp;<span class="ident" id="1475049">TimeoutHandler</span><span class="op" id="1475063">(</span><span class="ident" id="1475064">h</span>&nbsp;<span class="ident" id="1475066">Handler</span><span class="op" id="1475073">,</span>&nbsp;<span class="ident" id="1475075">dt</span>&nbsp;<span class="ident" id="1475078">time</span><span class="op" id="1475082">.</span><span class="ident" id="1475083">Duration</span><span class="op" id="1475091">,</span>&nbsp;<span class="ident" id="1475093">msg</span>&nbsp;<span class="builtintype" id="1475097">string</span><span class="op" id="1475103">)</span>&nbsp;<span class="ident" id="1475105">Handler</span>&nbsp;<span class="op" id="1475113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475116">f</span>&nbsp;<span class="op" id="1475118">:=</span>&nbsp;<span class="keyword" id="1475121">func</span><span class="op" id="1475125">(</span><span class="op" id="1475126">)</span>&nbsp;<span class="op" id="1475128">&lt;-</span><span class="keyword" id="1475130">chan</span>&nbsp;<span class="ident" id="1475135">time</span><span class="op" id="1475139">.</span><span class="ident" id="1475140">Time</span>&nbsp;<span class="op" id="1475145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475149">return</span>&nbsp;<span class="ident" id="1475156">time</span><span class="op" id="1475160">.</span><span class="ident" id="1475161">After</span><span class="op" id="1475166">(</span><span class="ident" id="1475167">dt</span><span class="op" id="1475169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475175">return</span>&nbsp;<span class="op" id="1475182">&amp;</span><span class="ident" id="1475183">timeoutHandler</span><span class="op" id="1475197">{</span><span class="ident" id="1475198">h</span><span class="op" id="1475199">,</span>&nbsp;<span class="ident" id="1475201">f</span><span class="op" id="1475202">,</span>&nbsp;<span class="ident" id="1475204">msg</span><span class="op" id="1475207">}</span><br>
<span class="lineno">1895</span><span class="op" id="1475209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1475212">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="1475275">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="1475312">var</span>&nbsp;<span class="ident" id="1475316">ErrHandlerTimeout</span>&nbsp;<span class="op" id="1475334">=</span>&nbsp;<span class="ident" id="1475336">errors</span><span class="op" id="1475342">.</span><span class="ident" id="1475343">New</span><span class="op" id="1475346">(</span><span class="string" id="1475347">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="1475370">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="1475373">type</span>&nbsp;<span class="ident" id="1475378">timeoutHandler</span>&nbsp;<span class="keyword" id="1475393">struct</span>&nbsp;<span class="op" id="1475400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475403">handler</span>&nbsp;<span class="ident" id="1475411">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475420">timeout</span>&nbsp;<span class="keyword" id="1475428">func</span><span class="op" id="1475432">(</span><span class="op" id="1475433">)</span>&nbsp;<span class="op" id="1475435">&lt;-</span><span class="keyword" id="1475437">chan</span>&nbsp;<span class="ident" id="1475442">time</span><span class="op" id="1475446">.</span><span class="ident" id="1475447">Time</span>&nbsp;<span class="comment" id="1475452">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475492">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1475500">string</span><br>
<span class="lineno">1905</span><span class="op" id="1475507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1475510">func</span>&nbsp;<span class="op" id="1475515">(</span><span class="ident" id="1475516">h</span>&nbsp;<span class="op" id="1475518">*</span><span class="ident" id="1475519">timeoutHandler</span><span class="op" id="1475533">)</span>&nbsp;<span class="ident" id="1475535">errorBody</span><span class="op" id="1475544">(</span><span class="op" id="1475545">)</span>&nbsp;<span class="builtintype" id="1475547">string</span>&nbsp;<span class="op" id="1475554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475557">if</span>&nbsp;<span class="ident" id="1475560">h</span><span class="op" id="1475561">.</span><span class="ident" id="1475562">body</span>&nbsp;<span class="op" id="1475567">!=</span>&nbsp;<span class="string" id="1475570">&#34;&#34;</span>&nbsp;<span class="op" id="1475573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475577">return</span>&nbsp;<span class="ident" id="1475584">h</span><span class="op" id="1475585">.</span><span class="ident" id="1475586">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475595">return</span>&nbsp;<span class="string" id="1475602">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="1475682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1475685">func</span>&nbsp;<span class="op" id="1475690">(</span><span class="ident" id="1475691">h</span>&nbsp;<span class="op" id="1475693">*</span><span class="ident" id="1475694">timeoutHandler</span><span class="op" id="1475708">)</span>&nbsp;<span class="ident" id="1475710">ServeHTTP</span><span class="op" id="1475719">(</span><span class="ident" id="1475720">w</span>&nbsp;<span class="ident" id="1475722">ResponseWriter</span><span class="op" id="1475736">,</span>&nbsp;<span class="ident" id="1475738">r</span>&nbsp;<span class="op" id="1475740">*</span><span class="ident" id="1475741">Request</span><span class="op" id="1475748">)</span>&nbsp;<span class="op" id="1475750">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475753">done</span>&nbsp;<span class="op" id="1475758">:=</span>&nbsp;<span class="builtinfunc" id="1475761">make</span><span class="op" id="1475765">(</span><span class="keyword" id="1475766">chan</span>&nbsp;<span class="builtintype" id="1475771">bool</span><span class="op" id="1475775">,</span>&nbsp;<span class="num" id="1475777">1</span><span class="op" id="1475778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475781">tw</span>&nbsp;<span class="op" id="1475784">:=</span>&nbsp;<span class="op" id="1475787">&amp;</span><span class="ident" id="1475788">timeoutWriter</span><span class="op" id="1475801">{</span><span class="ident" id="1475802">w</span><span class="op" id="1475803">:</span>&nbsp;<span class="ident" id="1475805">w</span><span class="op" id="1475806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475809">go</span>&nbsp;<span class="keyword" id="1475812">func</span><span class="op" id="1475816">(</span><span class="op" id="1475817">)</span>&nbsp;<span class="op" id="1475819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475823">h</span><span class="op" id="1475824">.</span><span class="ident" id="1475825">handler</span><span class="op" id="1475832">.</span><span class="ident" id="1475833">ServeHTTP</span><span class="op" id="1475842">(</span><span class="ident" id="1475843">tw</span><span class="op" id="1475845">,</span>&nbsp;<span class="ident" id="1475847">r</span><span class="op" id="1475848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475852">done</span>&nbsp;<span class="op" id="1475857">&lt;-</span>&nbsp;<span class="builtintype" id="1475860">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475866">}</span><span class="op" id="1475867">(</span><span class="op" id="1475868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475871">select</span>&nbsp;<span class="op" id="1475878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475881">case</span>&nbsp;<span class="op" id="1475886">&lt;-</span><span class="ident" id="1475888">done</span><span class="op" id="1475892">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475896">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475904">case</span>&nbsp;<span class="op" id="1475909">&lt;-</span><span class="ident" id="1475911">h</span><span class="op" id="1475912">.</span><span class="ident" id="1475913">timeout</span><span class="op" id="1475920">(</span><span class="op" id="1475921">)</span><span class="op" id="1475922">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475926">tw</span><span class="op" id="1475928">.</span><span class="ident" id="1475929">mu</span><span class="op" id="1475931">.</span><span class="ident" id="1475932">Lock</span><span class="op" id="1475936">(</span><span class="op" id="1475937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475941">defer</span>&nbsp;<span class="ident" id="1475947">tw</span><span class="op" id="1475949">.</span><span class="ident" id="1475950">mu</span><span class="op" id="1475952">.</span><span class="ident" id="1475953">Unlock</span><span class="op" id="1475959">(</span><span class="op" id="1475960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475964">if</span>&nbsp;<span class="op" id="1475967">!</span><span class="ident" id="1475968">tw</span><span class="op" id="1475970">.</span><span class="ident" id="1475971">wroteHeader</span>&nbsp;<span class="op" id="1475983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475988">tw</span><span class="op" id="1475990">.</span><span class="ident" id="1475991">w</span><span class="op" id="1475992">.</span><span class="ident" id="1475993">WriteHeader</span><span class="op" id="1476004">(</span><span class="ident" id="1476005">StatusServiceUnavailable</span><span class="op" id="1476029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476034">tw</span><span class="op" id="1476036">.</span><span class="ident" id="1476037">w</span><span class="op" id="1476038">.</span><span class="ident" id="1476039">Write</span><span class="op" id="1476044">(</span><span class="op" id="1476045">[</span><span class="op" id="1476046">]</span><span class="builtintype" id="1476047">byte</span><span class="op" id="1476051">(</span><span class="ident" id="1476052">h</span><span class="op" id="1476053">.</span><span class="ident" id="1476054">errorBody</span><span class="op" id="1476063">(</span><span class="op" id="1476064">)</span><span class="op" id="1476065">)</span><span class="op" id="1476066">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476074">tw</span><span class="op" id="1476076">.</span><span class="ident" id="1476077">timedOut</span>&nbsp;<span class="op" id="1476086">=</span>&nbsp;<span class="builtintype" id="1476088">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476094">}</span><br>
<span class="lineno"></span><span class="op" id="1476096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="1476099">type</span>&nbsp;<span class="ident" id="1476104">timeoutWriter</span>&nbsp;<span class="keyword" id="1476118">struct</span>&nbsp;<span class="op" id="1476125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476128">w</span>&nbsp;<span class="ident" id="1476130">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476147">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476159">sync</span><span class="op" id="1476163">.</span><span class="ident" id="1476164">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476171">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1476183">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476189">wroteHeader</span>&nbsp;<span class="builtintype" id="1476201">bool</span><br>
<span class="lineno"></span><span class="op" id="1476206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1476209">func</span>&nbsp;<span class="op" id="1476214">(</span><span class="ident" id="1476215">tw</span>&nbsp;<span class="op" id="1476218">*</span><span class="ident" id="1476219">timeoutWriter</span><span class="op" id="1476232">)</span>&nbsp;<span class="ident" id="1476234">Header</span><span class="op" id="1476240">(</span><span class="op" id="1476241">)</span>&nbsp;<span class="ident" id="1476243">Header</span>&nbsp;<span class="op" id="1476250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476253">return</span>&nbsp;<span class="ident" id="1476260">tw</span><span class="op" id="1476262">.</span><span class="ident" id="1476263">w</span><span class="op" id="1476264">.</span><span class="ident" id="1476265">Header</span><span class="op" id="1476271">(</span><span class="op" id="1476272">)</span><br>
<span class="lineno">1945</span><span class="op" id="1476274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1476277">func</span>&nbsp;<span class="op" id="1476282">(</span><span class="ident" id="1476283">tw</span>&nbsp;<span class="op" id="1476286">*</span><span class="ident" id="1476287">timeoutWriter</span><span class="op" id="1476300">)</span>&nbsp;<span class="ident" id="1476302">Write</span><span class="op" id="1476307">(</span><span class="ident" id="1476308">p</span>&nbsp;<span class="op" id="1476310">[</span><span class="op" id="1476311">]</span><span class="builtintype" id="1476312">byte</span><span class="op" id="1476316">)</span>&nbsp;<span class="op" id="1476318">(</span><span class="builtintype" id="1476319">int</span><span class="op" id="1476322">,</span>&nbsp;<span class="builtintype" id="1476324">error</span><span class="op" id="1476329">)</span>&nbsp;<span class="op" id="1476331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476334">tw</span><span class="op" id="1476336">.</span><span class="ident" id="1476337">mu</span><span class="op" id="1476339">.</span><span class="ident" id="1476340">Lock</span><span class="op" id="1476344">(</span><span class="op" id="1476345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476348">defer</span>&nbsp;<span class="ident" id="1476354">tw</span><span class="op" id="1476356">.</span><span class="ident" id="1476357">mu</span><span class="op" id="1476359">.</span><span class="ident" id="1476360">Unlock</span><span class="op" id="1476366">(</span><span class="op" id="1476367">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476370">tw</span><span class="op" id="1476372">.</span><span class="ident" id="1476373">wroteHeader</span>&nbsp;<span class="op" id="1476385">=</span>&nbsp;<span class="builtintype" id="1476387">true</span>&nbsp;<span class="comment" id="1476392">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476416">if</span>&nbsp;<span class="ident" id="1476419">tw</span><span class="op" id="1476421">.</span><span class="ident" id="1476422">timedOut</span>&nbsp;<span class="op" id="1476431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476435">return</span>&nbsp;<span class="num" id="1476442">0</span><span class="op" id="1476443">,</span>&nbsp;<span class="ident" id="1476445">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476467">return</span>&nbsp;<span class="ident" id="1476474">tw</span><span class="op" id="1476476">.</span><span class="ident" id="1476477">w</span><span class="op" id="1476478">.</span><span class="ident" id="1476479">Write</span><span class="op" id="1476484">(</span><span class="ident" id="1476485">p</span><span class="op" id="1476486">)</span><br>
<span class="lineno">1955</span><span class="op" id="1476488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1476491">func</span>&nbsp;<span class="op" id="1476496">(</span><span class="ident" id="1476497">tw</span>&nbsp;<span class="op" id="1476500">*</span><span class="ident" id="1476501">timeoutWriter</span><span class="op" id="1476514">)</span>&nbsp;<span class="ident" id="1476516">WriteHeader</span><span class="op" id="1476527">(</span><span class="ident" id="1476528">code</span>&nbsp;<span class="builtintype" id="1476533">int</span><span class="op" id="1476536">)</span>&nbsp;<span class="op" id="1476538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476541">tw</span><span class="op" id="1476543">.</span><span class="ident" id="1476544">mu</span><span class="op" id="1476546">.</span><span class="ident" id="1476547">Lock</span><span class="op" id="1476551">(</span><span class="op" id="1476552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476555">defer</span>&nbsp;<span class="ident" id="1476561">tw</span><span class="op" id="1476563">.</span><span class="ident" id="1476564">mu</span><span class="op" id="1476566">.</span><span class="ident" id="1476567">Unlock</span><span class="op" id="1476573">(</span><span class="op" id="1476574">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476577">if</span>&nbsp;<span class="ident" id="1476580">tw</span><span class="op" id="1476582">.</span><span class="ident" id="1476583">timedOut</span>&nbsp;<span class="op" id="1476592">||</span>&nbsp;<span class="ident" id="1476595">tw</span><span class="op" id="1476597">.</span><span class="ident" id="1476598">wroteHeader</span>&nbsp;<span class="op" id="1476610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476625">tw</span><span class="op" id="1476627">.</span><span class="ident" id="1476628">wroteHeader</span>&nbsp;<span class="op" id="1476640">=</span>&nbsp;<span class="builtintype" id="1476642">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476648">tw</span><span class="op" id="1476650">.</span><span class="ident" id="1476651">w</span><span class="op" id="1476652">.</span><span class="ident" id="1476653">WriteHeader</span><span class="op" id="1476664">(</span><span class="ident" id="1476665">code</span><span class="op" id="1476669">)</span><br>
<span class="lineno">1965</span><span class="op" id="1476671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1476674">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="1476739">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="1476808">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="1476878">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="1476890">type</span>&nbsp;<span class="ident" id="1476895">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="1476916">struct</span>&nbsp;<span class="op" id="1476923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476926">*</span><span class="ident" id="1476927">net</span><span class="op" id="1476930">.</span><span class="ident" id="1476931">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="1476943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="1476946">func</span>&nbsp;<span class="op" id="1476951">(</span><span class="ident" id="1476952">ln</span>&nbsp;<span class="ident" id="1476955">tcpKeepAliveListener</span><span class="op" id="1476975">)</span>&nbsp;<span class="ident" id="1476977">Accept</span><span class="op" id="1476983">(</span><span class="op" id="1476984">)</span>&nbsp;<span class="op" id="1476986">(</span><span class="ident" id="1476987">c</span>&nbsp;<span class="ident" id="1476989">net</span><span class="op" id="1476992">.</span><span class="ident" id="1476993">Conn</span><span class="op" id="1476997">,</span>&nbsp;<span class="ident" id="1476999">err</span>&nbsp;<span class="builtintype" id="1477003">error</span><span class="op" id="1477008">)</span>&nbsp;<span class="op" id="1477010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477013">tc</span><span class="op" id="1477015">,</span>&nbsp;<span class="ident" id="1477017">err</span>&nbsp;<span class="op" id="1477021">:=</span>&nbsp;<span class="ident" id="1477024">ln</span><span class="op" id="1477026">.</span><span class="ident" id="1477027">AcceptTCP</span><span class="op" id="1477036">(</span><span class="op" id="1477037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477040">if</span>&nbsp;<span class="ident" id="1477043">err</span>&nbsp;<span class="op" id="1477047">!=</span>&nbsp;<span class="ident" id="1477050">nil</span>&nbsp;<span class="op" id="1477054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477058">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477066">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477069">tc</span><span class="op" id="1477071">.</span><span class="ident" id="1477072">SetKeepAlive</span><span class="op" id="1477084">(</span><span class="builtintype" id="1477085">true</span><span class="op" id="1477089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477092">tc</span><span class="op" id="1477094">.</span><span class="ident" id="1477095">SetKeepAlivePeriod</span><span class="op" id="1477113">(</span><span class="num" id="1477114">3</span>&nbsp;<span class="op" id="1477116">*</span>&nbsp;<span class="ident" id="1477118">time</span><span class="op" id="1477122">.</span><span class="ident" id="1477123">Minute</span><span class="op" id="1477129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477132">return</span>&nbsp;<span class="ident" id="1477139">tc</span><span class="op" id="1477141">,</span>&nbsp;<span class="ident" id="1477143">nil</span><br>
<span class="lineno"></span><span class="op" id="1477147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="1477150">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="1477208">type</span>&nbsp;<span class="ident" id="1477213">globalOptionsHandler</span>&nbsp;<span class="keyword" id="1477234">struct</span><span class="op" id="1477240">{</span><span class="op" id="1477241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1477244">func</span>&nbsp;<span class="op" id="1477249">(</span><span class="ident" id="1477250">globalOptionsHandler</span><span class="op" id="1477270">)</span>&nbsp;<span class="ident" id="1477272">ServeHTTP</span><span class="op" id="1477281">(</span><span class="ident" id="1477282">w</span>&nbsp;<span class="ident" id="1477284">ResponseWriter</span><span class="op" id="1477298">,</span>&nbsp;<span class="ident" id="1477300">r</span>&nbsp;<span class="op" id="1477302">*</span><span class="ident" id="1477303">Request</span><span class="op" id="1477310">)</span>&nbsp;<span class="op" id="1477312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477315">w</span><span class="op" id="1477316">.</span><span class="ident" id="1477317">Header</span><span class="op" id="1477323">(</span><span class="op" id="1477324">)</span><span class="op" id="1477325">.</span><span class="ident" id="1477326">Set</span><span class="op" id="1477329">(</span><span class="string" id="1477330">&#34;Content-Length&#34;</span><span class="op" id="1477346">,</span>&nbsp;<span class="string" id="1477348">&#34;0&#34;</span><span class="op" id="1477351">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477354">if</span>&nbsp;<span class="ident" id="1477357">r</span><span class="op" id="1477358">.</span><span class="ident" id="1477359">ContentLength</span>&nbsp;<span class="op" id="1477373">!=</span>&nbsp;<span class="num" id="1477376">0</span>&nbsp;<span class="op" id="1477378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477382">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477439">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477497">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477554">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477613">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477661">mb</span>&nbsp;<span class="op" id="1477664">:=</span>&nbsp;<span class="ident" id="1477667">MaxBytesReader</span><span class="op" id="1477681">(</span><span class="ident" id="1477682">w</span><span class="op" id="1477683">,</span>&nbsp;<span class="ident" id="1477685">r</span><span class="op" id="1477686">.</span><span class="ident" id="1477687">Body</span><span class="op" id="1477691">,</span>&nbsp;<span class="num" id="1477693">4</span><span class="op" id="1477694">&lt;&lt;</span><span class="num" id="1477696">10</span><span class="op" id="1477698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477702">io</span><span class="op" id="1477704">.</span><span class="ident" id="1477705">Copy</span><span class="op" id="1477709">(</span><span class="ident" id="1477710">ioutil</span><span class="op" id="1477716">.</span><span class="ident" id="1477717">Discard</span><span class="op" id="1477724">,</span>&nbsp;<span class="ident" id="1477726">mb</span><span class="op" id="1477728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477731">}</span><br>
<span class="lineno"></span><span class="op" id="1477733">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="1477736">type</span>&nbsp;<span class="ident" id="1477741">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="1477762">struct</span><span class="op" id="1477768">{</span><span class="op" id="1477769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1477772">func</span>&nbsp;<span class="op" id="1477777">(</span><span class="ident" id="1477778">eofReaderWithWriteTo</span><span class="op" id="1477798">)</span>&nbsp;<span class="ident" id="1477800">WriteTo</span><span class="op" id="1477807">(</span><span class="ident" id="1477808">io</span><span class="op" id="1477810">.</span><span class="ident" id="1477811">Writer</span><span class="op" id="1477817">)</span>&nbsp;<span class="op" id="1477819">(</span><span class="ident" id="1477820">int64</span><span class="op" id="1477825">,</span>&nbsp;<span class="builtintype" id="1477827">error</span><span class="op" id="1477832">)</span>&nbsp;<span class="op" id="1477834">{</span>&nbsp;<span class="keyword" id="1477836">return</span>&nbsp;<span class="num" id="1477843">0</span><span class="op" id="1477844">,</span>&nbsp;<span class="ident" id="1477846">nil</span>&nbsp;<span class="op" id="1477850">}</span><br>
<span class="lineno"></span><span class="keyword" id="1477852">func</span>&nbsp;<span class="op" id="1477857">(</span><span class="ident" id="1477858">eofReaderWithWriteTo</span><span class="op" id="1477878">)</span>&nbsp;<span class="ident" id="1477880">Read</span><span class="op" id="1477884">(</span><span class="op" id="1477885">[</span><span class="op" id="1477886">]</span><span class="builtintype" id="1477887">byte</span><span class="op" id="1477891">)</span>&nbsp;<span class="op" id="1477893">(</span><span class="builtintype" id="1477894">int</span><span class="op" id="1477897">,</span>&nbsp;<span class="builtintype" id="1477899">error</span><span class="op" id="1477904">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477914">{</span>&nbsp;<span class="keyword" id="1477916">return</span>&nbsp;<span class="num" id="1477923">0</span><span class="op" id="1477924">,</span>&nbsp;<span class="ident" id="1477926">io</span><span class="op" id="1477928">.</span><span class="ident" id="1477929">EOF</span>&nbsp;<span class="op" id="1477933">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="1477936">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="1478001">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1478060">var</span>&nbsp;<span class="ident" id="1478064">eofReader</span>&nbsp;<span class="op" id="1478074">=</span>&nbsp;<span class="op" id="1478076">&amp;</span><span class="keyword" id="1478077">struct</span>&nbsp;<span class="op" id="1478084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478087">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478109">io</span><span class="op" id="1478111">.</span><span class="ident" id="1478112">Closer</span><br>
<span class="lineno"></span><span class="op" id="1478119">}</span><span class="op" id="1478120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478123">eofReaderWithWriteTo</span><span class="op" id="1478143">{</span><span class="op" id="1478144">}</span><span class="op" id="1478145">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478148">ioutil</span><span class="op" id="1478154">.</span><span class="ident" id="1478155">NopCloser</span><span class="op" id="1478164">(</span><span class="ident" id="1478165">nil</span><span class="op" id="1478168">)</span><span class="op" id="1478169">,</span><br>
<span class="lineno"></span><span class="op" id="1478171">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="1478174">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1478242">var</span>&nbsp;<span class="ident" id="1478246">_</span>&nbsp;<span class="ident" id="1478248">io</span><span class="op" id="1478250">.</span><span class="ident" id="1478251">WriterTo</span>&nbsp;<span class="op" id="1478260">=</span>&nbsp;<span class="ident" id="1478262">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1478273">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="1478335">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="1478403">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="1478448">type</span>&nbsp;<span class="ident" id="1478453">initNPNRequest</span>&nbsp;<span class="keyword" id="1478468">struct</span>&nbsp;<span class="op" id="1478475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478478">c</span>&nbsp;<span class="op" id="1478480">*</span><span class="ident" id="1478481">tls</span><span class="op" id="1478484">.</span><span class="ident" id="1478485">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478491">h</span>&nbsp;<span class="ident" id="1478493">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="1478507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478510">func</span>&nbsp;<span class="op" id="1478515">(</span><span class="ident" id="1478516">h</span>&nbsp;<span class="ident" id="1478518">initNPNRequest</span><span class="op" id="1478532">)</span>&nbsp;<span class="ident" id="1478534">ServeHTTP</span><span class="op" id="1478543">(</span><span class="ident" id="1478544">rw</span>&nbsp;<span class="ident" id="1478547">ResponseWriter</span><span class="op" id="1478561">,</span>&nbsp;<span class="ident" id="1478563">req</span>&nbsp;<span class="op" id="1478567">*</span><span class="ident" id="1478568">Request</span><span class="op" id="1478575">)</span>&nbsp;<span class="op" id="1478577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478580">if</span>&nbsp;<span class="ident" id="1478583">req</span><span class="op" id="1478586">.</span><span class="ident" id="1478587">TLS</span>&nbsp;<span class="op" id="1478591">==</span>&nbsp;<span class="ident" id="1478594">nil</span>&nbsp;<span class="op" id="1478598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478602">req</span><span class="op" id="1478605">.</span><span class="ident" id="1478606">TLS</span>&nbsp;<span class="op" id="1478610">=</span>&nbsp;<span class="op" id="1478612">&amp;</span><span class="ident" id="1478613">tls</span><span class="op" id="1478616">.</span><span class="ident" id="1478617">ConnectionState</span><span class="op" id="1478632">{</span><span class="op" id="1478633">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478637">*</span><span class="ident" id="1478638">req</span><span class="op" id="1478641">.</span><span class="ident" id="1478642">TLS</span>&nbsp;<span class="op" id="1478646">=</span>&nbsp;<span class="ident" id="1478648">h</span><span class="op" id="1478649">.</span><span class="ident" id="1478650">c</span><span class="op" id="1478651">.</span><span class="ident" id="1478652">ConnectionState</span><span class="op" id="1478667">(</span><span class="op" id="1478668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478674">if</span>&nbsp;<span class="ident" id="1478677">req</span><span class="op" id="1478680">.</span><span class="ident" id="1478681">Body</span>&nbsp;<span class="op" id="1478686">==</span>&nbsp;<span class="ident" id="1478689">nil</span>&nbsp;<span class="op" id="1478693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478697">req</span><span class="op" id="1478700">.</span><span class="ident" id="1478701">Body</span>&nbsp;<span class="op" id="1478706">=</span>&nbsp;<span class="ident" id="1478708">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478719">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478722">if</span>&nbsp;<span class="ident" id="1478725">req</span><span class="op" id="1478728">.</span><span class="ident" id="1478729">RemoteAddr</span>&nbsp;<span class="op" id="1478740">==</span>&nbsp;<span class="string" id="1478743">&#34;&#34;</span>&nbsp;<span class="op" id="1478746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478750">req</span><span class="op" id="1478753">.</span><span class="ident" id="1478754">RemoteAddr</span>&nbsp;<span class="op" id="1478765">=</span>&nbsp;<span class="ident" id="1478767">h</span><span class="op" id="1478768">.</span><span class="ident" id="1478769">c</span><span class="op" id="1478770">.</span><span class="ident" id="1478771">RemoteAddr</span><span class="op" id="1478781">(</span><span class="op" id="1478782">)</span><span class="op" id="1478783">.</span><span class="ident" id="1478784">String</span><span class="op" id="1478790">(</span><span class="op" id="1478791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478797">h</span><span class="op" id="1478798">.</span><span class="ident" id="1478799">h</span><span class="op" id="1478800">.</span><span class="ident" id="1478801">ServeHTTP</span><span class="op" id="1478810">(</span><span class="ident" id="1478811">rw</span><span class="op" id="1478813">,</span>&nbsp;<span class="ident" id="1478815">req</span><span class="op" id="1478818">)</span><br>
<span class="lineno"></span><span class="op" id="1478820">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="1478823">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="1478861">type</span>&nbsp;<span class="ident" id="1478866">loggingConn</span>&nbsp;<span class="keyword" id="1478878">struct</span>&nbsp;<span class="op" id="1478885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478888">name</span>&nbsp;<span class="builtintype" id="1478893">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478901">net</span><span class="op" id="1478904">.</span><span class="ident" id="1478905">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="1478910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478913">var</span>&nbsp;<span class="op" id="1478917">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478920">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1478933">sync</span><span class="op" id="1478937">.</span><span class="ident" id="1478938">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478945">uniqNameNext</span>&nbsp;<span class="op" id="1478958">=</span>&nbsp;<span class="builtinfunc" id="1478960">make</span><span class="op" id="1478964">(</span><span class="keyword" id="1478965">map</span><span class="op" id="1478968">[</span><span class="builtintype" id="1478969">string</span><span class="op" id="1478975">]</span><span class="builtintype" id="1478976">int</span><span class="op" id="1478979">)</span><br>
<span class="lineno">2050</span><span class="op" id="1478981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478984">func</span>&nbsp;<span class="ident" id="1478989">newLoggingConn</span><span class="op" id="1479003">(</span><span class="ident" id="1479004">baseName</span>&nbsp;<span class="builtintype" id="1479013">string</span><span class="op" id="1479019">,</span>&nbsp;<span class="ident" id="1479021">c</span>&nbsp;<span class="ident" id="1479023">net</span><span class="op" id="1479026">.</span><span class="ident" id="1479027">Conn</span><span class="op" id="1479031">)</span>&nbsp;<span class="ident" id="1479033">net</span><span class="op" id="1479036">.</span><span class="ident" id="1479037">Conn</span>&nbsp;<span class="op" id="1479042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479045">uniqNameMu</span><span class="op" id="1479055">.</span><span class="ident" id="1479056">Lock</span><span class="op" id="1479060">(</span><span class="op" id="1479061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479064">defer</span>&nbsp;<span class="ident" id="1479070">uniqNameMu</span><span class="op" id="1479080">.</span><span class="ident" id="1479081">Unlock</span><span class="op" id="1479087">(</span><span class="op" id="1479088">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479091">uniqNameNext</span><span class="op" id="1479103">[</span><span class="ident" id="1479104">baseName</span><span class="op" id="1479112">]</span><span class="op" id="1479113">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479117">return</span>&nbsp;<span class="op" id="1479124">&amp;</span><span class="ident" id="1479125">loggingConn</span><span class="op" id="1479136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479140">name</span><span class="op" id="1479144">:</span>&nbsp;<span class="ident" id="1479146">fmt</span><span class="op" id="1479149">.</span><span class="ident" id="1479150">Sprintf</span><span class="op" id="1479157">(</span><span class="string" id="1479158">&#34;%s-%d&#34;</span><span class="op" id="1479165">,</span>&nbsp;<span class="ident" id="1479167">baseName</span><span class="op" id="1479175">,</span>&nbsp;<span class="ident" id="1479177">uniqNameNext</span><span class="op" id="1479189">[</span><span class="ident" id="1479190">baseName</span><span class="op" id="1479198">]</span><span class="op" id="1479199">)</span><span class="op" id="1479200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479204">Conn</span><span class="op" id="1479208">:</span>&nbsp;<span class="ident" id="1479210">c</span><span class="op" id="1479211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479214">}</span><br>
<span class="lineno">2060</span><span class="op" id="1479216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1479219">func</span>&nbsp;<span class="op" id="1479224">(</span><span class="ident" id="1479225">c</span>&nbsp;<span class="op" id="1479227">*</span><span class="ident" id="1479228">loggingConn</span><span class="op" id="1479239">)</span>&nbsp;<span class="ident" id="1479241">Write</span><span class="op" id="1479246">(</span><span class="ident" id="1479247">p</span>&nbsp;<span class="op" id="1479249">[</span><span class="op" id="1479250">]</span><span class="builtintype" id="1479251">byte</span><span class="op" id="1479255">)</span>&nbsp;<span class="op" id="1479257">(</span><span class="ident" id="1479258">n</span>&nbsp;<span class="builtintype" id="1479260">int</span><span class="op" id="1479263">,</span>&nbsp;<span class="ident" id="1479265">err</span>&nbsp;<span class="builtintype" id="1479269">error</span><span class="op" id="1479274">)</span>&nbsp;<span class="op" id="1479276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479279">log</span><span class="op" id="1479282">.</span><span class="ident" id="1479283">Printf</span><span class="op" id="1479289">(</span><span class="string" id="1479290">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="1479311">,</span>&nbsp;<span class="ident" id="1479313">c</span><span class="op" id="1479314">.</span><span class="ident" id="1479315">name</span><span class="op" id="1479319">,</span>&nbsp;<span class="builtinfunc" id="1479321">len</span><span class="op" id="1479324">(</span><span class="ident" id="1479325">p</span><span class="op" id="1479326">)</span><span class="op" id="1479327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479330">n</span><span class="op" id="1479331">,</span>&nbsp;<span class="ident" id="1479333">err</span>&nbsp;<span class="op" id="1479337">=</span>&nbsp;<span class="ident" id="1479339">c</span><span class="op" id="1479340">.</span><span class="ident" id="1479341">Conn</span><span class="op" id="1479345">.</span><span class="ident" id="1479346">Write</span><span class="op" id="1479351">(</span><span class="ident" id="1479352">p</span><span class="op" id="1479353">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479356">log</span><span class="op" id="1479359">.</span><span class="ident" id="1479360">Printf</span><span class="op" id="1479366">(</span><span class="string" id="1479367">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="1479390">,</span>&nbsp;<span class="ident" id="1479392">c</span><span class="op" id="1479393">.</span><span class="ident" id="1479394">name</span><span class="op" id="1479398">,</span>&nbsp;<span class="builtinfunc" id="1479400">len</span><span class="op" id="1479403">(</span><span class="ident" id="1479404">p</span><span class="op" id="1479405">)</span><span class="op" id="1479406">,</span>&nbsp;<span class="ident" id="1479408">n</span><span class="op" id="1479409">,</span>&nbsp;<span class="ident" id="1479411">err</span><span class="op" id="1479414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479417">return</span><br>
<span class="lineno"></span><span class="op" id="1479424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1479427">func</span>&nbsp;<span class="op" id="1479432">(</span><span class="ident" id="1479433">c</span>&nbsp;<span class="op" id="1479435">*</span><span class="ident" id="1479436">loggingConn</span><span class="op" id="1479447">)</span>&nbsp;<span class="ident" id="1479449">Read</span><span class="op" id="1479453">(</span><span class="ident" id="1479454">p</span>&nbsp;<span class="op" id="1479456">[</span><span class="op" id="1479457">]</span><span class="builtintype" id="1479458">byte</span><span class="op" id="1479462">)</span>&nbsp;<span class="op" id="1479464">(</span><span class="ident" id="1479465">n</span>&nbsp;<span class="builtintype" id="1479467">int</span><span class="op" id="1479470">,</span>&nbsp;<span class="ident" id="1479472">err</span>&nbsp;<span class="builtintype" id="1479476">error</span><span class="op" id="1479481">)</span>&nbsp;<span class="op" id="1479483">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479486">log</span><span class="op" id="1479489">.</span><span class="ident" id="1479490">Printf</span><span class="op" id="1479496">(</span><span class="string" id="1479497">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="1479517">,</span>&nbsp;<span class="ident" id="1479519">c</span><span class="op" id="1479520">.</span><span class="ident" id="1479521">name</span><span class="op" id="1479525">,</span>&nbsp;<span class="builtinfunc" id="1479527">len</span><span class="op" id="1479530">(</span><span class="ident" id="1479531">p</span><span class="op" id="1479532">)</span><span class="op" id="1479533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479536">n</span><span class="op" id="1479537">,</span>&nbsp;<span class="ident" id="1479539">err</span>&nbsp;<span class="op" id="1479543">=</span>&nbsp;<span class="ident" id="1479545">c</span><span class="op" id="1479546">.</span><span class="ident" id="1479547">Conn</span><span class="op" id="1479551">.</span><span class="ident" id="1479552">Read</span><span class="op" id="1479556">(</span><span class="ident" id="1479557">p</span><span class="op" id="1479558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479561">log</span><span class="op" id="1479564">.</span><span class="ident" id="1479565">Printf</span><span class="op" id="1479571">(</span><span class="string" id="1479572">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="1479594">,</span>&nbsp;<span class="ident" id="1479596">c</span><span class="op" id="1479597">.</span><span class="ident" id="1479598">name</span><span class="op" id="1479602">,</span>&nbsp;<span class="builtinfunc" id="1479604">len</span><span class="op" id="1479607">(</span><span class="ident" id="1479608">p</span><span class="op" id="1479609">)</span><span class="op" id="1479610">,</span>&nbsp;<span class="ident" id="1479612">n</span><span class="op" id="1479613">,</span>&nbsp;<span class="ident" id="1479615">err</span><span class="op" id="1479618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479621">return</span><br>
<span class="lineno"></span><span class="op" id="1479628">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="1479631">func</span>&nbsp;<span class="op" id="1479636">(</span><span class="ident" id="1479637">c</span>&nbsp;<span class="op" id="1479639">*</span><span class="ident" id="1479640">loggingConn</span><span class="op" id="1479651">)</span>&nbsp;<span class="ident" id="1479653">Close</span><span class="op" id="1479658">(</span><span class="op" id="1479659">)</span>&nbsp;<span class="op" id="1479661">(</span><span class="ident" id="1479662">err</span>&nbsp;<span class="builtintype" id="1479666">error</span><span class="op" id="1479671">)</span>&nbsp;<span class="op" id="1479673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479676">log</span><span class="op" id="1479679">.</span><span class="ident" id="1479680">Printf</span><span class="op" id="1479686">(</span><span class="string" id="1479687">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="1479705">,</span>&nbsp;<span class="ident" id="1479707">c</span><span class="op" id="1479708">.</span><span class="ident" id="1479709">name</span><span class="op" id="1479713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479716">err</span>&nbsp;<span class="op" id="1479720">=</span>&nbsp;<span class="ident" id="1479722">c</span><span class="op" id="1479723">.</span><span class="ident" id="1479724">Conn</span><span class="op" id="1479728">.</span><span class="ident" id="1479729">Close</span><span class="op" id="1479734">(</span><span class="op" id="1479735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479738">log</span><span class="op" id="1479741">.</span><span class="ident" id="1479742">Printf</span><span class="op" id="1479748">(</span><span class="string" id="1479749">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="1479766">,</span>&nbsp;<span class="ident" id="1479768">c</span><span class="op" id="1479769">.</span><span class="ident" id="1479770">name</span><span class="op" id="1479774">,</span>&nbsp;<span class="ident" id="1479776">err</span><span class="op" id="1479779">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479782">return</span><br>
<span class="lineno"></span><span class="op" id="1479789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1479792">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="1479872">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="1479939">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="1479998">type</span>&nbsp;<span class="ident" id="1480003">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="1480024">struct</span>&nbsp;<span class="op" id="1480031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480034">c</span>&nbsp;<span class="op" id="1480036">*</span><span class="ident" id="1480037">conn</span><br>
<span class="lineno"></span><span class="op" id="1480042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="1480045">func</span>&nbsp;<span class="op" id="1480050">(</span><span class="ident" id="1480051">w</span>&nbsp;<span class="ident" id="1480053">checkConnErrorWriter</span><span class="op" id="1480073">)</span>&nbsp;<span class="ident" id="1480075">Write</span><span class="op" id="1480080">(</span><span class="ident" id="1480081">p</span>&nbsp;<span class="op" id="1480083">[</span><span class="op" id="1480084">]</span><span class="builtintype" id="1480085">byte</span><span class="op" id="1480089">)</span>&nbsp;<span class="op" id="1480091">(</span><span class="ident" id="1480092">n</span>&nbsp;<span class="builtintype" id="1480094">int</span><span class="op" id="1480097">,</span>&nbsp;<span class="ident" id="1480099">err</span>&nbsp;<span class="builtintype" id="1480103">error</span><span class="op" id="1480108">)</span>&nbsp;<span class="op" id="1480110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480113">n</span><span class="op" id="1480114">,</span>&nbsp;<span class="ident" id="1480116">err</span>&nbsp;<span class="op" id="1480120">=</span>&nbsp;<span class="ident" id="1480122">w</span><span class="op" id="1480123">.</span><span class="ident" id="1480124">c</span><span class="op" id="1480125">.</span><span class="ident" id="1480126">w</span><span class="op" id="1480127">.</span><span class="ident" id="1480128">Write</span><span class="op" id="1480133">(</span><span class="ident" id="1480134">p</span><span class="op" id="1480135">)</span>&nbsp;<span class="comment" id="1480137">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480195">if</span>&nbsp;<span class="ident" id="1480198">err</span>&nbsp;<span class="op" id="1480202">!=</span>&nbsp;<span class="ident" id="1480205">nil</span>&nbsp;<span class="op" id="1480209">&amp;&amp;</span>&nbsp;<span class="ident" id="1480212">w</span><span class="op" id="1480213">.</span><span class="ident" id="1480214">c</span><span class="op" id="1480215">.</span><span class="ident" id="1480216">werr</span>&nbsp;<span class="op" id="1480221">==</span>&nbsp;<span class="ident" id="1480224">nil</span>&nbsp;<span class="op" id="1480228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480232">w</span><span class="op" id="1480233">.</span><span class="ident" id="1480234">c</span><span class="op" id="1480235">.</span><span class="ident" id="1480236">werr</span>&nbsp;<span class="op" id="1480241">=</span>&nbsp;<span class="ident" id="1480243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480248">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480251">return</span><br>
<span class="lineno"></span><span class="op" id="1480258">}</span>
</div>
</body>
</html>
