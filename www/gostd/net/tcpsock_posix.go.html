<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3399368">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3399424">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3399478">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3399529">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3399607">package</span>&nbsp;<span class="ident" id="3399615">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3399620">import</span>&nbsp;<span class="op" id="3399627">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399630">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399636">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399642">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3399653">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3399660">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3399663">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3399739">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3399816">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3399892">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3399966">func</span>&nbsp;<span class="ident" id="3399971">sockaddrToTCP</span><span class="op" id="3399984">(</span><span class="ident" id="3399985">sa</span>&nbsp;<span class="ident" id="3399988">syscall</span><span class="op" id="3399995">.</span><span class="ident" id="3399996">Sockaddr</span><span class="op" id="3400004">)</span>&nbsp;<span class="ident" id="3400006">Addr</span>&nbsp;<span class="op" id="3400011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400014">switch</span>&nbsp;<span class="ident" id="3400021">sa</span>&nbsp;<span class="op" id="3400024">:=</span>&nbsp;<span class="ident" id="3400027">sa</span><span class="op" id="3400029">.</span><span class="op" id="3400030">(</span><span class="keyword" id="3400031">type</span><span class="op" id="3400035">)</span>&nbsp;<span class="op" id="3400037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400040">case</span>&nbsp;<span class="op" id="3400045">*</span><span class="ident" id="3400046">syscall</span><span class="op" id="3400053">.</span><span class="ident" id="3400054">SockaddrInet4</span><span class="op" id="3400067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400071">return</span>&nbsp;<span class="op" id="3400078">&amp;</span><span class="ident" id="3400079">TCPAddr</span><span class="op" id="3400086">{</span><span class="ident" id="3400087">IP</span><span class="op" id="3400089">:</span>&nbsp;<span class="ident" id="3400091">sa</span><span class="op" id="3400093">.</span><span class="ident" id="3400094">Addr</span><span class="op" id="3400098">[</span><span class="num" id="3400099">0</span><span class="op" id="3400100">:</span><span class="op" id="3400101">]</span><span class="op" id="3400102">,</span>&nbsp;<span class="ident" id="3400104">Port</span><span class="op" id="3400108">:</span>&nbsp;<span class="ident" id="3400110">sa</span><span class="op" id="3400112">.</span><span class="ident" id="3400113">Port</span><span class="op" id="3400117">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400120">case</span>&nbsp;<span class="op" id="3400125">*</span><span class="ident" id="3400126">syscall</span><span class="op" id="3400133">.</span><span class="ident" id="3400134">SockaddrInet6</span><span class="op" id="3400147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400151">return</span>&nbsp;<span class="op" id="3400158">&amp;</span><span class="ident" id="3400159">TCPAddr</span><span class="op" id="3400166">{</span><span class="ident" id="3400167">IP</span><span class="op" id="3400169">:</span>&nbsp;<span class="ident" id="3400171">sa</span><span class="op" id="3400173">.</span><span class="ident" id="3400174">Addr</span><span class="op" id="3400178">[</span><span class="num" id="3400179">0</span><span class="op" id="3400180">:</span><span class="op" id="3400181">]</span><span class="op" id="3400182">,</span>&nbsp;<span class="ident" id="3400184">Port</span><span class="op" id="3400188">:</span>&nbsp;<span class="ident" id="3400190">sa</span><span class="op" id="3400192">.</span><span class="ident" id="3400193">Port</span><span class="op" id="3400197">,</span>&nbsp;<span class="ident" id="3400199">Zone</span><span class="op" id="3400203">:</span>&nbsp;<span class="ident" id="3400205">zoneToString</span><span class="op" id="3400217">(</span><span class="builtintype" id="3400218">int</span><span class="op" id="3400221">(</span><span class="ident" id="3400222">sa</span><span class="op" id="3400224">.</span><span class="ident" id="3400225">ZoneId</span><span class="op" id="3400231">)</span><span class="op" id="3400232">)</span><span class="op" id="3400233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3400236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400239">return</span>&nbsp;<span class="ident" id="3400246">nil</span><br>
<span class="lineno"></span><span class="op" id="3400250">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3400253">func</span>&nbsp;<span class="op" id="3400258">(</span><span class="ident" id="3400259">a</span>&nbsp;<span class="op" id="3400261">*</span><span class="ident" id="3400262">TCPAddr</span><span class="op" id="3400269">)</span>&nbsp;<span class="ident" id="3400271">family</span><span class="op" id="3400277">(</span><span class="op" id="3400278">)</span>&nbsp;<span class="builtintype" id="3400280">int</span>&nbsp;<span class="op" id="3400284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400287">if</span>&nbsp;<span class="ident" id="3400290">a</span>&nbsp;<span class="op" id="3400292">==</span>&nbsp;<span class="ident" id="3400295">nil</span>&nbsp;<span class="op" id="3400299">||</span>&nbsp;<span class="builtinfunc" id="3400302">len</span><span class="op" id="3400305">(</span><span class="ident" id="3400306">a</span><span class="op" id="3400307">.</span><span class="ident" id="3400308">IP</span><span class="op" id="3400310">)</span>&nbsp;<span class="op" id="3400312">&lt;=</span>&nbsp;<span class="ident" id="3400315">IPv4len</span>&nbsp;<span class="op" id="3400323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400327">return</span>&nbsp;<span class="ident" id="3400334">syscall</span><span class="op" id="3400341">.</span><span class="ident" id="3400342">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3400351">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400354">if</span>&nbsp;<span class="ident" id="3400357">a</span><span class="op" id="3400358">.</span><span class="ident" id="3400359">IP</span><span class="op" id="3400361">.</span><span class="ident" id="3400362">To4</span><span class="op" id="3400365">(</span><span class="op" id="3400366">)</span>&nbsp;<span class="op" id="3400368">!=</span>&nbsp;<span class="ident" id="3400371">nil</span>&nbsp;<span class="op" id="3400375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400379">return</span>&nbsp;<span class="ident" id="3400386">syscall</span><span class="op" id="3400393">.</span><span class="ident" id="3400394">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3400403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400406">return</span>&nbsp;<span class="ident" id="3400413">syscall</span><span class="op" id="3400420">.</span><span class="ident" id="3400421">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3400430">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3400433">func</span>&nbsp;<span class="op" id="3400438">(</span><span class="ident" id="3400439">a</span>&nbsp;<span class="op" id="3400441">*</span><span class="ident" id="3400442">TCPAddr</span><span class="op" id="3400449">)</span>&nbsp;<span class="ident" id="3400451">isWildcard</span><span class="op" id="3400461">(</span><span class="op" id="3400462">)</span>&nbsp;<span class="builtintype" id="3400464">bool</span>&nbsp;<span class="op" id="3400469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400472">if</span>&nbsp;<span class="ident" id="3400475">a</span>&nbsp;<span class="op" id="3400477">==</span>&nbsp;<span class="ident" id="3400480">nil</span>&nbsp;<span class="op" id="3400484">||</span>&nbsp;<span class="ident" id="3400487">a</span><span class="op" id="3400488">.</span><span class="ident" id="3400489">IP</span>&nbsp;<span class="op" id="3400492">==</span>&nbsp;<span class="ident" id="3400495">nil</span>&nbsp;<span class="op" id="3400499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400503">return</span>&nbsp;<span class="builtintype" id="3400510">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3400516">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400519">return</span>&nbsp;<span class="ident" id="3400526">a</span><span class="op" id="3400527">.</span><span class="ident" id="3400528">IP</span><span class="op" id="3400530">.</span><span class="ident" id="3400531">IsUnspecified</span><span class="op" id="3400544">(</span><span class="op" id="3400545">)</span><br>
<span class="lineno"></span><span class="op" id="3400547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3400550">func</span>&nbsp;<span class="op" id="3400555">(</span><span class="ident" id="3400556">a</span>&nbsp;<span class="op" id="3400558">*</span><span class="ident" id="3400559">TCPAddr</span><span class="op" id="3400566">)</span>&nbsp;<span class="ident" id="3400568">sockaddr</span><span class="op" id="3400576">(</span><span class="ident" id="3400577">family</span>&nbsp;<span class="builtintype" id="3400584">int</span><span class="op" id="3400587">)</span>&nbsp;<span class="op" id="3400589">(</span><span class="ident" id="3400590">syscall</span><span class="op" id="3400597">.</span><span class="ident" id="3400598">Sockaddr</span><span class="op" id="3400606">,</span>&nbsp;<span class="builtintype" id="3400608">error</span><span class="op" id="3400613">)</span>&nbsp;<span class="op" id="3400615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400618">if</span>&nbsp;<span class="ident" id="3400621">a</span>&nbsp;<span class="op" id="3400623">==</span>&nbsp;<span class="ident" id="3400626">nil</span>&nbsp;<span class="op" id="3400630">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400634">return</span>&nbsp;<span class="ident" id="3400641">nil</span><span class="op" id="3400644">,</span>&nbsp;<span class="ident" id="3400646">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3400651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400654">return</span>&nbsp;<span class="ident" id="3400661">ipToSockaddr</span><span class="op" id="3400673">(</span><span class="ident" id="3400674">family</span><span class="op" id="3400680">,</span>&nbsp;<span class="ident" id="3400682">a</span><span class="op" id="3400683">.</span><span class="ident" id="3400684">IP</span><span class="op" id="3400686">,</span>&nbsp;<span class="ident" id="3400688">a</span><span class="op" id="3400689">.</span><span class="ident" id="3400690">Port</span><span class="op" id="3400694">,</span>&nbsp;<span class="ident" id="3400696">a</span><span class="op" id="3400697">.</span><span class="ident" id="3400698">Zone</span><span class="op" id="3400702">)</span><br>
<span class="lineno"></span><span class="op" id="3400704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3400707">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3400777">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3400793">type</span>&nbsp;<span class="ident" id="3400798">TCPConn</span>&nbsp;<span class="keyword" id="3400806">struct</span>&nbsp;<span class="op" id="3400813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400816">conn</span><br>
<span class="lineno"></span><span class="op" id="3400821">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3400824">func</span>&nbsp;<span class="ident" id="3400829">newTCPConn</span><span class="op" id="3400839">(</span><span class="ident" id="3400840">fd</span>&nbsp;<span class="op" id="3400843">*</span><span class="ident" id="3400844">netFD</span><span class="op" id="3400849">)</span>&nbsp;<span class="op" id="3400851">*</span><span class="ident" id="3400852">TCPConn</span>&nbsp;<span class="op" id="3400860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400863">c</span>&nbsp;<span class="op" id="3400865">:=</span>&nbsp;<span class="op" id="3400868">&amp;</span><span class="ident" id="3400869">TCPConn</span><span class="op" id="3400876">{</span><span class="ident" id="3400877">conn</span><span class="op" id="3400881">{</span><span class="ident" id="3400882">fd</span><span class="op" id="3400884">}</span><span class="op" id="3400885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3400888">c</span><span class="op" id="3400889">.</span><span class="ident" id="3400890">SetNoDelay</span><span class="op" id="3400900">(</span><span class="builtintype" id="3400901">true</span><span class="op" id="3400905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3400908">return</span>&nbsp;<span class="ident" id="3400915">c</span><br>
<span class="lineno">65</span><span class="op" id="3400917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3400920">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3400978">func</span>&nbsp;<span class="op" id="3400983">(</span><span class="ident" id="3400984">c</span>&nbsp;<span class="op" id="3400986">*</span><span class="ident" id="3400987">TCPConn</span><span class="op" id="3400994">)</span>&nbsp;<span class="ident" id="3400996">ReadFrom</span><span class="op" id="3401004">(</span><span class="ident" id="3401005">r</span>&nbsp;<span class="ident" id="3401007">io</span><span class="op" id="3401009">.</span><span class="ident" id="3401010">Reader</span><span class="op" id="3401016">)</span>&nbsp;<span class="op" id="3401018">(</span><span class="ident" id="3401019">int64</span><span class="op" id="3401024">,</span>&nbsp;<span class="builtintype" id="3401026">error</span><span class="op" id="3401031">)</span>&nbsp;<span class="op" id="3401033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401036">if</span>&nbsp;<span class="ident" id="3401039">n</span><span class="op" id="3401040">,</span>&nbsp;<span class="ident" id="3401042">err</span><span class="op" id="3401045">,</span>&nbsp;<span class="ident" id="3401047">handled</span>&nbsp;<span class="op" id="3401055">:=</span>&nbsp;<span class="ident" id="3401058">sendFile</span><span class="op" id="3401066">(</span><span class="ident" id="3401067">c</span><span class="op" id="3401068">.</span><span class="ident" id="3401069">fd</span><span class="op" id="3401071">,</span>&nbsp;<span class="ident" id="3401073">r</span><span class="op" id="3401074">)</span><span class="op" id="3401075">;</span>&nbsp;<span class="ident" id="3401077">handled</span>&nbsp;<span class="op" id="3401085">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401089">return</span>&nbsp;<span class="ident" id="3401096">n</span><span class="op" id="3401097">,</span>&nbsp;<span class="ident" id="3401099">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3401104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401107">return</span>&nbsp;<span class="ident" id="3401114">genericReadFrom</span><span class="op" id="3401129">(</span><span class="ident" id="3401130">c</span><span class="op" id="3401131">,</span>&nbsp;<span class="ident" id="3401133">r</span><span class="op" id="3401134">)</span><br>
<span class="lineno"></span><span class="op" id="3401136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3401139">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3401203">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3401242">func</span>&nbsp;<span class="op" id="3401247">(</span><span class="ident" id="3401248">c</span>&nbsp;<span class="op" id="3401250">*</span><span class="ident" id="3401251">TCPConn</span><span class="op" id="3401258">)</span>&nbsp;<span class="ident" id="3401260">CloseRead</span><span class="op" id="3401269">(</span><span class="op" id="3401270">)</span>&nbsp;<span class="builtintype" id="3401272">error</span>&nbsp;<span class="op" id="3401278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401281">if</span>&nbsp;<span class="op" id="3401284">!</span><span class="ident" id="3401285">c</span><span class="op" id="3401286">.</span><span class="ident" id="3401287">ok</span><span class="op" id="3401289">(</span><span class="op" id="3401290">)</span>&nbsp;<span class="op" id="3401292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401296">return</span>&nbsp;<span class="ident" id="3401303">syscall</span><span class="op" id="3401310">.</span><span class="ident" id="3401311">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3401319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401322">return</span>&nbsp;<span class="ident" id="3401329">c</span><span class="op" id="3401330">.</span><span class="ident" id="3401331">fd</span><span class="op" id="3401333">.</span><span class="ident" id="3401334">closeRead</span><span class="op" id="3401343">(</span><span class="op" id="3401344">)</span><br>
<span class="lineno"></span><span class="op" id="3401346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3401349">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3401414">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3401453">func</span>&nbsp;<span class="op" id="3401458">(</span><span class="ident" id="3401459">c</span>&nbsp;<span class="op" id="3401461">*</span><span class="ident" id="3401462">TCPConn</span><span class="op" id="3401469">)</span>&nbsp;<span class="ident" id="3401471">CloseWrite</span><span class="op" id="3401481">(</span><span class="op" id="3401482">)</span>&nbsp;<span class="builtintype" id="3401484">error</span>&nbsp;<span class="op" id="3401490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401493">if</span>&nbsp;<span class="op" id="3401496">!</span><span class="ident" id="3401497">c</span><span class="op" id="3401498">.</span><span class="ident" id="3401499">ok</span><span class="op" id="3401501">(</span><span class="op" id="3401502">)</span>&nbsp;<span class="op" id="3401504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401508">return</span>&nbsp;<span class="ident" id="3401515">syscall</span><span class="op" id="3401522">.</span><span class="ident" id="3401523">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3401531">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3401534">return</span>&nbsp;<span class="ident" id="3401541">c</span><span class="op" id="3401542">.</span><span class="ident" id="3401543">fd</span><span class="op" id="3401545">.</span><span class="ident" id="3401546">closeWrite</span><span class="op" id="3401556">(</span><span class="op" id="3401557">)</span><br>
<span class="lineno"></span><span class="op" id="3401559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3401562">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3401630">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3401684">//</span><br>
<span class="lineno"></span><span class="comment" id="3401687">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3401758">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3401785">//</span><br>
<span class="lineno"></span><span class="comment" id="3401788">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3401848">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3401872">//</span><br>
<span class="lineno"></span><span class="comment" id="3401875">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3401945">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3402016">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3402049">func</span>&nbsp;<span class="op" id="3402054">(</span><span class="ident" id="3402055">c</span>&nbsp;<span class="op" id="3402057">*</span><span class="ident" id="3402058">TCPConn</span><span class="op" id="3402065">)</span>&nbsp;<span class="ident" id="3402067">SetLinger</span><span class="op" id="3402076">(</span><span class="ident" id="3402077">sec</span>&nbsp;<span class="builtintype" id="3402081">int</span><span class="op" id="3402084">)</span>&nbsp;<span class="builtintype" id="3402086">error</span>&nbsp;<span class="op" id="3402092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402095">if</span>&nbsp;<span class="op" id="3402098">!</span><span class="ident" id="3402099">c</span><span class="op" id="3402100">.</span><span class="ident" id="3402101">ok</span><span class="op" id="3402103">(</span><span class="op" id="3402104">)</span>&nbsp;<span class="op" id="3402106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402110">return</span>&nbsp;<span class="ident" id="3402117">syscall</span><span class="op" id="3402124">.</span><span class="ident" id="3402125">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3402133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402136">return</span>&nbsp;<span class="ident" id="3402143">setLinger</span><span class="op" id="3402152">(</span><span class="ident" id="3402153">c</span><span class="op" id="3402154">.</span><span class="ident" id="3402155">fd</span><span class="op" id="3402157">,</span>&nbsp;<span class="ident" id="3402159">sec</span><span class="op" id="3402162">)</span><br>
<span class="lineno">110</span><span class="op" id="3402164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3402167">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3402229">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3402270">func</span>&nbsp;<span class="op" id="3402275">(</span><span class="ident" id="3402276">c</span>&nbsp;<span class="op" id="3402278">*</span><span class="ident" id="3402279">TCPConn</span><span class="op" id="3402286">)</span>&nbsp;<span class="ident" id="3402288">SetKeepAlive</span><span class="op" id="3402300">(</span><span class="ident" id="3402301">keepalive</span>&nbsp;<span class="builtintype" id="3402311">bool</span><span class="op" id="3402315">)</span>&nbsp;<span class="builtintype" id="3402317">error</span>&nbsp;<span class="op" id="3402323">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402326">if</span>&nbsp;<span class="op" id="3402329">!</span><span class="ident" id="3402330">c</span><span class="op" id="3402331">.</span><span class="ident" id="3402332">ok</span><span class="op" id="3402334">(</span><span class="op" id="3402335">)</span>&nbsp;<span class="op" id="3402337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402341">return</span>&nbsp;<span class="ident" id="3402348">syscall</span><span class="op" id="3402355">.</span><span class="ident" id="3402356">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3402364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402367">return</span>&nbsp;<span class="ident" id="3402374">setKeepAlive</span><span class="op" id="3402386">(</span><span class="ident" id="3402387">c</span><span class="op" id="3402388">.</span><span class="ident" id="3402389">fd</span><span class="op" id="3402391">,</span>&nbsp;<span class="ident" id="3402393">keepalive</span><span class="op" id="3402402">)</span><br>
<span class="lineno"></span><span class="op" id="3402404">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3402407">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3402462">func</span>&nbsp;<span class="op" id="3402467">(</span><span class="ident" id="3402468">c</span>&nbsp;<span class="op" id="3402470">*</span><span class="ident" id="3402471">TCPConn</span><span class="op" id="3402478">)</span>&nbsp;<span class="ident" id="3402480">SetKeepAlivePeriod</span><span class="op" id="3402498">(</span><span class="ident" id="3402499">d</span>&nbsp;<span class="ident" id="3402501">time</span><span class="op" id="3402505">.</span><span class="ident" id="3402506">Duration</span><span class="op" id="3402514">)</span>&nbsp;<span class="builtintype" id="3402516">error</span>&nbsp;<span class="op" id="3402522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402525">if</span>&nbsp;<span class="op" id="3402528">!</span><span class="ident" id="3402529">c</span><span class="op" id="3402530">.</span><span class="ident" id="3402531">ok</span><span class="op" id="3402533">(</span><span class="op" id="3402534">)</span>&nbsp;<span class="op" id="3402536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402540">return</span>&nbsp;<span class="ident" id="3402547">syscall</span><span class="op" id="3402554">.</span><span class="ident" id="3402555">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3402563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402566">return</span>&nbsp;<span class="ident" id="3402573">setKeepAlivePeriod</span><span class="op" id="3402591">(</span><span class="ident" id="3402592">c</span><span class="op" id="3402593">.</span><span class="ident" id="3402594">fd</span><span class="op" id="3402596">,</span>&nbsp;<span class="ident" id="3402598">d</span><span class="op" id="3402599">)</span><br>
<span class="lineno"></span><span class="op" id="3402601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3402604">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3402669">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3402735">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3402804">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3402847">func</span>&nbsp;<span class="op" id="3402852">(</span><span class="ident" id="3402853">c</span>&nbsp;<span class="op" id="3402855">*</span><span class="ident" id="3402856">TCPConn</span><span class="op" id="3402863">)</span>&nbsp;<span class="ident" id="3402865">SetNoDelay</span><span class="op" id="3402875">(</span><span class="ident" id="3402876">noDelay</span>&nbsp;<span class="builtintype" id="3402884">bool</span><span class="op" id="3402888">)</span>&nbsp;<span class="builtintype" id="3402890">error</span>&nbsp;<span class="op" id="3402896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402899">if</span>&nbsp;<span class="op" id="3402902">!</span><span class="ident" id="3402903">c</span><span class="op" id="3402904">.</span><span class="ident" id="3402905">ok</span><span class="op" id="3402907">(</span><span class="op" id="3402908">)</span>&nbsp;<span class="op" id="3402910">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402914">return</span>&nbsp;<span class="ident" id="3402921">syscall</span><span class="op" id="3402928">.</span><span class="ident" id="3402929">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3402937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3402940">return</span>&nbsp;<span class="ident" id="3402947">setNoDelay</span><span class="op" id="3402957">(</span><span class="ident" id="3402958">c</span><span class="op" id="3402959">.</span><span class="ident" id="3402960">fd</span><span class="op" id="3402962">,</span>&nbsp;<span class="ident" id="3402964">noDelay</span><span class="op" id="3402971">)</span><br>
<span class="lineno"></span><span class="op" id="3402973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3402976">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3403044">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3403115">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3403164">func</span>&nbsp;<span class="ident" id="3403169">DialTCP</span><span class="op" id="3403176">(</span><span class="ident" id="3403177">net</span>&nbsp;<span class="builtintype" id="3403181">string</span><span class="op" id="3403187">,</span>&nbsp;<span class="ident" id="3403189">laddr</span><span class="op" id="3403194">,</span>&nbsp;<span class="ident" id="3403196">raddr</span>&nbsp;<span class="op" id="3403202">*</span><span class="ident" id="3403203">TCPAddr</span><span class="op" id="3403210">)</span>&nbsp;<span class="op" id="3403212">(</span><span class="op" id="3403213">*</span><span class="ident" id="3403214">TCPConn</span><span class="op" id="3403221">,</span>&nbsp;<span class="builtintype" id="3403223">error</span><span class="op" id="3403228">)</span>&nbsp;<span class="op" id="3403230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403233">switch</span>&nbsp;<span class="ident" id="3403240">net</span>&nbsp;<span class="op" id="3403244">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403247">case</span>&nbsp;<span class="string" id="3403252">&#34;tcp&#34;</span><span class="op" id="3403257">,</span>&nbsp;<span class="string" id="3403259">&#34;tcp4&#34;</span><span class="op" id="3403265">,</span>&nbsp;<span class="string" id="3403267">&#34;tcp6&#34;</span><span class="op" id="3403273">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403276">default</span><span class="op" id="3403283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403287">return</span>&nbsp;<span class="ident" id="3403294">nil</span><span class="op" id="3403297">,</span>&nbsp;<span class="op" id="3403299">&amp;</span><span class="ident" id="3403300">OpError</span><span class="op" id="3403307">{</span><span class="ident" id="3403308">Op</span><span class="op" id="3403310">:</span>&nbsp;<span class="string" id="3403312">&#34;dial&#34;</span><span class="op" id="3403318">,</span>&nbsp;<span class="ident" id="3403320">Net</span><span class="op" id="3403323">:</span>&nbsp;<span class="ident" id="3403325">net</span><span class="op" id="3403328">,</span>&nbsp;<span class="ident" id="3403330">Addr</span><span class="op" id="3403334">:</span>&nbsp;<span class="ident" id="3403336">raddr</span><span class="op" id="3403341">,</span>&nbsp;<span class="ident" id="3403343">Err</span><span class="op" id="3403346">:</span>&nbsp;<span class="ident" id="3403348">UnknownNetworkError</span><span class="op" id="3403367">(</span><span class="ident" id="3403368">net</span><span class="op" id="3403371">)</span><span class="op" id="3403372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3403375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403378">if</span>&nbsp;<span class="ident" id="3403381">raddr</span>&nbsp;<span class="op" id="3403387">==</span>&nbsp;<span class="ident" id="3403390">nil</span>&nbsp;<span class="op" id="3403394">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403398">return</span>&nbsp;<span class="ident" id="3403405">nil</span><span class="op" id="3403408">,</span>&nbsp;<span class="op" id="3403410">&amp;</span><span class="ident" id="3403411">OpError</span><span class="op" id="3403418">{</span><span class="ident" id="3403419">Op</span><span class="op" id="3403421">:</span>&nbsp;<span class="string" id="3403423">&#34;dial&#34;</span><span class="op" id="3403429">,</span>&nbsp;<span class="ident" id="3403431">Net</span><span class="op" id="3403434">:</span>&nbsp;<span class="ident" id="3403436">net</span><span class="op" id="3403439">,</span>&nbsp;<span class="ident" id="3403441">Addr</span><span class="op" id="3403445">:</span>&nbsp;<span class="ident" id="3403447">nil</span><span class="op" id="3403450">,</span>&nbsp;<span class="ident" id="3403452">Err</span><span class="op" id="3403455">:</span>&nbsp;<span class="ident" id="3403457">errMissingAddress</span><span class="op" id="3403474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3403477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3403480">return</span>&nbsp;<span class="ident" id="3403487">dialTCP</span><span class="op" id="3403494">(</span><span class="ident" id="3403495">net</span><span class="op" id="3403498">,</span>&nbsp;<span class="ident" id="3403500">laddr</span><span class="op" id="3403505">,</span>&nbsp;<span class="ident" id="3403507">raddr</span><span class="op" id="3403512">,</span>&nbsp;<span class="ident" id="3403514">noDeadline</span><span class="op" id="3403524">)</span><br>
<span class="lineno"></span><span class="op" id="3403526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3403529">func</span>&nbsp;<span class="ident" id="3403534">dialTCP</span><span class="op" id="3403541">(</span><span class="ident" id="3403542">net</span>&nbsp;<span class="builtintype" id="3403546">string</span><span class="op" id="3403552">,</span>&nbsp;<span class="ident" id="3403554">laddr</span><span class="op" id="3403559">,</span>&nbsp;<span class="ident" id="3403561">raddr</span>&nbsp;<span class="op" id="3403567">*</span><span class="ident" id="3403568">TCPAddr</span><span class="op" id="3403575">,</span>&nbsp;<span class="ident" id="3403577">deadline</span>&nbsp;<span class="ident" id="3403586">time</span><span class="op" id="3403590">.</span><span class="ident" id="3403591">Time</span><span class="op" id="3403595">)</span>&nbsp;<span class="op" id="3403597">(</span><span class="op" id="3403598">*</span><span class="ident" id="3403599">TCPConn</span><span class="op" id="3403606">,</span>&nbsp;<span class="builtintype" id="3403608">error</span><span class="op" id="3403613">)</span>&nbsp;<span class="op" id="3403615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3403618">fd</span><span class="op" id="3403620">,</span>&nbsp;<span class="ident" id="3403622">err</span>&nbsp;<span class="op" id="3403626">:=</span>&nbsp;<span class="ident" id="3403629">internetSocket</span><span class="op" id="3403643">(</span><span class="ident" id="3403644">net</span><span class="op" id="3403647">,</span>&nbsp;<span class="ident" id="3403649">laddr</span><span class="op" id="3403654">,</span>&nbsp;<span class="ident" id="3403656">raddr</span><span class="op" id="3403661">,</span>&nbsp;<span class="ident" id="3403663">deadline</span><span class="op" id="3403671">,</span>&nbsp;<span class="ident" id="3403673">syscall</span><span class="op" id="3403680">.</span><span class="ident" id="3403681">SOCK_STREAM</span><span class="op" id="3403692">,</span>&nbsp;<span class="num" id="3403694">0</span><span class="op" id="3403695">,</span>&nbsp;<span class="string" id="3403697">&#34;dial&#34;</span><span class="op" id="3403703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403707">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403781">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403849">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403924">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3403997">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404070">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404142">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404215">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404297">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404372">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404455">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404518">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404590">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404660">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404733">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404764">//&nbsp;&nbsp;&nbsp;&nbsphttp://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404797">//&nbsp;&nbsp;&nbsp;&nbsphttp://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404845">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404849">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3404927">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405005">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405078">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405102">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405106">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405174">for</span>&nbsp;<span class="ident" id="3405178">i</span>&nbsp;<span class="op" id="3405180">:=</span>&nbsp;<span class="num" id="3405183">0</span><span class="op" id="3405184">;</span>&nbsp;<span class="ident" id="3405186">i</span>&nbsp;<span class="op" id="3405188">&lt;</span>&nbsp;<span class="num" id="3405190">2</span>&nbsp;<span class="op" id="3405192">&amp;&amp;</span>&nbsp;<span class="op" id="3405195">(</span><span class="ident" id="3405196">laddr</span>&nbsp;<span class="op" id="3405202">==</span>&nbsp;<span class="ident" id="3405205">nil</span>&nbsp;<span class="op" id="3405209">||</span>&nbsp;<span class="ident" id="3405212">laddr</span><span class="op" id="3405217">.</span><span class="ident" id="3405218">Port</span>&nbsp;<span class="op" id="3405223">==</span>&nbsp;<span class="num" id="3405226">0</span><span class="op" id="3405227">)</span>&nbsp;<span class="op" id="3405229">&amp;&amp;</span>&nbsp;<span class="op" id="3405232">(</span><span class="ident" id="3405233">selfConnect</span><span class="op" id="3405244">(</span><span class="ident" id="3405245">fd</span><span class="op" id="3405247">,</span>&nbsp;<span class="ident" id="3405249">err</span><span class="op" id="3405252">)</span>&nbsp;<span class="op" id="3405254">||</span>&nbsp;<span class="ident" id="3405257">spuriousENOTAVAIL</span><span class="op" id="3405274">(</span><span class="ident" id="3405275">err</span><span class="op" id="3405278">)</span><span class="op" id="3405279">)</span><span class="op" id="3405280">;</span>&nbsp;<span class="ident" id="3405282">i</span><span class="op" id="3405283">++</span>&nbsp;<span class="op" id="3405286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405290">if</span>&nbsp;<span class="ident" id="3405293">err</span>&nbsp;<span class="op" id="3405297">==</span>&nbsp;<span class="ident" id="3405300">nil</span>&nbsp;<span class="op" id="3405304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405309">fd</span><span class="op" id="3405311">.</span><span class="ident" id="3405312">Close</span><span class="op" id="3405317">(</span><span class="op" id="3405318">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3405326">fd</span><span class="op" id="3405328">,</span>&nbsp;<span class="ident" id="3405330">err</span>&nbsp;<span class="op" id="3405334">=</span>&nbsp;<span class="ident" id="3405336">internetSocket</span><span class="op" id="3405350">(</span><span class="ident" id="3405351">net</span><span class="op" id="3405354">,</span>&nbsp;<span class="ident" id="3405356">laddr</span><span class="op" id="3405361">,</span>&nbsp;<span class="ident" id="3405363">raddr</span><span class="op" id="3405368">,</span>&nbsp;<span class="ident" id="3405370">deadline</span><span class="op" id="3405378">,</span>&nbsp;<span class="ident" id="3405380">syscall</span><span class="op" id="3405387">.</span><span class="ident" id="3405388">SOCK_STREAM</span><span class="op" id="3405399">,</span>&nbsp;<span class="num" id="3405401">0</span><span class="op" id="3405402">,</span>&nbsp;<span class="string" id="3405404">&#34;dial&#34;</span><span class="op" id="3405410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405417">if</span>&nbsp;<span class="ident" id="3405420">err</span>&nbsp;<span class="op" id="3405424">!=</span>&nbsp;<span class="ident" id="3405427">nil</span>&nbsp;<span class="op" id="3405431">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405435">return</span>&nbsp;<span class="ident" id="3405442">nil</span><span class="op" id="3405445">,</span>&nbsp;<span class="op" id="3405447">&amp;</span><span class="ident" id="3405448">OpError</span><span class="op" id="3405455">{</span><span class="ident" id="3405456">Op</span><span class="op" id="3405458">:</span>&nbsp;<span class="string" id="3405460">&#34;dial&#34;</span><span class="op" id="3405466">,</span>&nbsp;<span class="ident" id="3405468">Net</span><span class="op" id="3405471">:</span>&nbsp;<span class="ident" id="3405473">net</span><span class="op" id="3405476">,</span>&nbsp;<span class="ident" id="3405478">Addr</span><span class="op" id="3405482">:</span>&nbsp;<span class="ident" id="3405484">raddr</span><span class="op" id="3405489">,</span>&nbsp;<span class="ident" id="3405491">Err</span><span class="op" id="3405494">:</span>&nbsp;<span class="ident" id="3405496">err</span><span class="op" id="3405499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405505">return</span>&nbsp;<span class="ident" id="3405512">newTCPConn</span><span class="op" id="3405522">(</span><span class="ident" id="3405523">fd</span><span class="op" id="3405525">)</span><span class="op" id="3405526">,</span>&nbsp;<span class="ident" id="3405528">nil</span><br>
<span class="lineno"></span><span class="op" id="3405532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3405535">func</span>&nbsp;<span class="ident" id="3405540">selfConnect</span><span class="op" id="3405551">(</span><span class="ident" id="3405552">fd</span>&nbsp;<span class="op" id="3405555">*</span><span class="ident" id="3405556">netFD</span><span class="op" id="3405561">,</span>&nbsp;<span class="ident" id="3405563">err</span>&nbsp;<span class="builtintype" id="3405567">error</span><span class="op" id="3405572">)</span>&nbsp;<span class="builtintype" id="3405574">bool</span>&nbsp;<span class="op" id="3405579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405582">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405649">if</span>&nbsp;<span class="ident" id="3405652">err</span>&nbsp;<span class="op" id="3405656">!=</span>&nbsp;<span class="ident" id="3405659">nil</span>&nbsp;<span class="op" id="3405663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3405667">return</span>&nbsp;<span class="builtintype" id="3405674">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3405681">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405685">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405758">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405827">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405897">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3405970">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406037">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406106">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3406148">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406200">if</span>&nbsp;<span class="ident" id="3406203">fd</span><span class="op" id="3406205">.</span><span class="ident" id="3406206">laddr</span>&nbsp;<span class="op" id="3406212">==</span>&nbsp;<span class="ident" id="3406215">nil</span>&nbsp;<span class="op" id="3406219">||</span>&nbsp;<span class="ident" id="3406222">fd</span><span class="op" id="3406224">.</span><span class="ident" id="3406225">raddr</span>&nbsp;<span class="op" id="3406231">==</span>&nbsp;<span class="ident" id="3406234">nil</span>&nbsp;<span class="op" id="3406238">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406242">return</span>&nbsp;<span class="builtintype" id="3406249">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3406255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406258">l</span>&nbsp;<span class="op" id="3406260">:=</span>&nbsp;<span class="ident" id="3406263">fd</span><span class="op" id="3406265">.</span><span class="ident" id="3406266">laddr</span><span class="op" id="3406271">.</span><span class="op" id="3406272">(</span><span class="op" id="3406273">*</span><span class="ident" id="3406274">TCPAddr</span><span class="op" id="3406281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406284">r</span>&nbsp;<span class="op" id="3406286">:=</span>&nbsp;<span class="ident" id="3406289">fd</span><span class="op" id="3406291">.</span><span class="ident" id="3406292">raddr</span><span class="op" id="3406297">.</span><span class="op" id="3406298">(</span><span class="op" id="3406299">*</span><span class="ident" id="3406300">TCPAddr</span><span class="op" id="3406307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406310">return</span>&nbsp;<span class="ident" id="3406317">l</span><span class="op" id="3406318">.</span><span class="ident" id="3406319">Port</span>&nbsp;<span class="op" id="3406324">==</span>&nbsp;<span class="ident" id="3406327">r</span><span class="op" id="3406328">.</span><span class="ident" id="3406329">Port</span>&nbsp;<span class="op" id="3406334">&amp;&amp;</span>&nbsp;<span class="ident" id="3406337">l</span><span class="op" id="3406338">.</span><span class="ident" id="3406339">IP</span><span class="op" id="3406341">.</span><span class="ident" id="3406342">Equal</span><span class="op" id="3406347">(</span><span class="ident" id="3406348">r</span><span class="op" id="3406349">.</span><span class="ident" id="3406350">IP</span><span class="op" id="3406352">)</span><br>
<span class="lineno">215</span><span class="op" id="3406354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3406357">func</span>&nbsp;<span class="ident" id="3406362">spuriousENOTAVAIL</span><span class="op" id="3406379">(</span><span class="ident" id="3406380">err</span>&nbsp;<span class="builtintype" id="3406384">error</span><span class="op" id="3406389">)</span>&nbsp;<span class="builtintype" id="3406391">bool</span>&nbsp;<span class="op" id="3406396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406399">e</span><span class="op" id="3406400">,</span>&nbsp;<span class="ident" id="3406402">ok</span>&nbsp;<span class="op" id="3406405">:=</span>&nbsp;<span class="ident" id="3406408">err</span><span class="op" id="3406411">.</span><span class="op" id="3406412">(</span><span class="op" id="3406413">*</span><span class="ident" id="3406414">OpError</span><span class="op" id="3406421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406424">return</span>&nbsp;<span class="ident" id="3406431">ok</span>&nbsp;<span class="op" id="3406434">&amp;&amp;</span>&nbsp;<span class="ident" id="3406437">e</span><span class="op" id="3406438">.</span><span class="ident" id="3406439">Err</span>&nbsp;<span class="op" id="3406443">==</span>&nbsp;<span class="ident" id="3406446">syscall</span><span class="op" id="3406453">.</span><span class="ident" id="3406454">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3406468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3406471">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3406539">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3406598">type</span>&nbsp;<span class="ident" id="3406603">TCPListener</span>&nbsp;<span class="keyword" id="3406615">struct</span>&nbsp;<span class="op" id="3406622">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406625">fd</span>&nbsp;<span class="op" id="3406628">*</span><span class="ident" id="3406629">netFD</span><br>
<span class="lineno"></span><span class="op" id="3406635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3406638">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3406702">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3406717">func</span>&nbsp;<span class="op" id="3406722">(</span><span class="ident" id="3406723">l</span>&nbsp;<span class="op" id="3406725">*</span><span class="ident" id="3406726">TCPListener</span><span class="op" id="3406737">)</span>&nbsp;<span class="ident" id="3406739">AcceptTCP</span><span class="op" id="3406748">(</span><span class="op" id="3406749">)</span>&nbsp;<span class="op" id="3406751">(</span><span class="op" id="3406752">*</span><span class="ident" id="3406753">TCPConn</span><span class="op" id="3406760">,</span>&nbsp;<span class="builtintype" id="3406762">error</span><span class="op" id="3406767">)</span>&nbsp;<span class="op" id="3406769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406772">if</span>&nbsp;<span class="ident" id="3406775">l</span>&nbsp;<span class="op" id="3406777">==</span>&nbsp;<span class="ident" id="3406780">nil</span>&nbsp;<span class="op" id="3406784">||</span>&nbsp;<span class="ident" id="3406787">l</span><span class="op" id="3406788">.</span><span class="ident" id="3406789">fd</span>&nbsp;<span class="op" id="3406792">==</span>&nbsp;<span class="ident" id="3406795">nil</span>&nbsp;<span class="op" id="3406799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406803">return</span>&nbsp;<span class="ident" id="3406810">nil</span><span class="op" id="3406813">,</span>&nbsp;<span class="ident" id="3406815">syscall</span><span class="op" id="3406822">.</span><span class="ident" id="3406823">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3406831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3406834">fd</span><span class="op" id="3406836">,</span>&nbsp;<span class="ident" id="3406838">err</span>&nbsp;<span class="op" id="3406842">:=</span>&nbsp;<span class="ident" id="3406845">l</span><span class="op" id="3406846">.</span><span class="ident" id="3406847">fd</span><span class="op" id="3406849">.</span><span class="ident" id="3406850">accept</span><span class="op" id="3406856">(</span><span class="op" id="3406857">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406860">if</span>&nbsp;<span class="ident" id="3406863">err</span>&nbsp;<span class="op" id="3406867">!=</span>&nbsp;<span class="ident" id="3406870">nil</span>&nbsp;<span class="op" id="3406874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406878">return</span>&nbsp;<span class="ident" id="3406885">nil</span><span class="op" id="3406888">,</span>&nbsp;<span class="ident" id="3406890">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3406895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3406898">return</span>&nbsp;<span class="ident" id="3406905">newTCPConn</span><span class="op" id="3406915">(</span><span class="ident" id="3406916">fd</span><span class="op" id="3406918">)</span><span class="op" id="3406919">,</span>&nbsp;<span class="ident" id="3406921">nil</span><br>
<span class="lineno"></span><span class="op" id="3406925">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3406928">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3406997">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3407052">func</span>&nbsp;<span class="op" id="3407057">(</span><span class="ident" id="3407058">l</span>&nbsp;<span class="op" id="3407060">*</span><span class="ident" id="3407061">TCPListener</span><span class="op" id="3407072">)</span>&nbsp;<span class="ident" id="3407074">Accept</span><span class="op" id="3407080">(</span><span class="op" id="3407081">)</span>&nbsp;<span class="op" id="3407083">(</span><span class="ident" id="3407084">Conn</span><span class="op" id="3407088">,</span>&nbsp;<span class="builtintype" id="3407090">error</span><span class="op" id="3407095">)</span>&nbsp;<span class="op" id="3407097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3407100">c</span><span class="op" id="3407101">,</span>&nbsp;<span class="ident" id="3407103">err</span>&nbsp;<span class="op" id="3407107">:=</span>&nbsp;<span class="ident" id="3407110">l</span><span class="op" id="3407111">.</span><span class="ident" id="3407112">AcceptTCP</span><span class="op" id="3407121">(</span><span class="op" id="3407122">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407125">if</span>&nbsp;<span class="ident" id="3407128">err</span>&nbsp;<span class="op" id="3407132">!=</span>&nbsp;<span class="ident" id="3407135">nil</span>&nbsp;<span class="op" id="3407139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407143">return</span>&nbsp;<span class="ident" id="3407150">nil</span><span class="op" id="3407153">,</span>&nbsp;<span class="ident" id="3407155">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407163">return</span>&nbsp;<span class="ident" id="3407170">c</span><span class="op" id="3407171">,</span>&nbsp;<span class="ident" id="3407173">nil</span><br>
<span class="lineno"></span><span class="op" id="3407177">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3407180">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3407225">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3407273">func</span>&nbsp;<span class="op" id="3407278">(</span><span class="ident" id="3407279">l</span>&nbsp;<span class="op" id="3407281">*</span><span class="ident" id="3407282">TCPListener</span><span class="op" id="3407293">)</span>&nbsp;<span class="ident" id="3407295">Close</span><span class="op" id="3407300">(</span><span class="op" id="3407301">)</span>&nbsp;<span class="builtintype" id="3407303">error</span>&nbsp;<span class="op" id="3407309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407312">if</span>&nbsp;<span class="ident" id="3407315">l</span>&nbsp;<span class="op" id="3407317">==</span>&nbsp;<span class="ident" id="3407320">nil</span>&nbsp;<span class="op" id="3407324">||</span>&nbsp;<span class="ident" id="3407327">l</span><span class="op" id="3407328">.</span><span class="ident" id="3407329">fd</span>&nbsp;<span class="op" id="3407332">==</span>&nbsp;<span class="ident" id="3407335">nil</span>&nbsp;<span class="op" id="3407339">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407343">return</span>&nbsp;<span class="ident" id="3407350">syscall</span><span class="op" id="3407357">.</span><span class="ident" id="3407358">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407369">return</span>&nbsp;<span class="ident" id="3407376">l</span><span class="op" id="3407377">.</span><span class="ident" id="3407378">fd</span><span class="op" id="3407380">.</span><span class="ident" id="3407381">Close</span><span class="op" id="3407386">(</span><span class="op" id="3407387">)</span><br>
<span class="lineno"></span><span class="op" id="3407389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3407392">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3407452">func</span>&nbsp;<span class="op" id="3407457">(</span><span class="ident" id="3407458">l</span>&nbsp;<span class="op" id="3407460">*</span><span class="ident" id="3407461">TCPListener</span><span class="op" id="3407472">)</span>&nbsp;<span class="ident" id="3407474">Addr</span><span class="op" id="3407478">(</span><span class="op" id="3407479">)</span>&nbsp;<span class="ident" id="3407481">Addr</span>&nbsp;<span class="op" id="3407486">{</span>&nbsp;<span class="keyword" id="3407488">return</span>&nbsp;<span class="ident" id="3407495">l</span><span class="op" id="3407496">.</span><span class="ident" id="3407497">fd</span><span class="op" id="3407499">.</span><span class="ident" id="3407500">laddr</span>&nbsp;<span class="op" id="3407506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3407509">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3407572">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3407616">func</span>&nbsp;<span class="op" id="3407621">(</span><span class="ident" id="3407622">l</span>&nbsp;<span class="op" id="3407624">*</span><span class="ident" id="3407625">TCPListener</span><span class="op" id="3407636">)</span>&nbsp;<span class="ident" id="3407638">SetDeadline</span><span class="op" id="3407649">(</span><span class="ident" id="3407650">t</span>&nbsp;<span class="ident" id="3407652">time</span><span class="op" id="3407656">.</span><span class="ident" id="3407657">Time</span><span class="op" id="3407661">)</span>&nbsp;<span class="builtintype" id="3407663">error</span>&nbsp;<span class="op" id="3407669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407672">if</span>&nbsp;<span class="ident" id="3407675">l</span>&nbsp;<span class="op" id="3407677">==</span>&nbsp;<span class="ident" id="3407680">nil</span>&nbsp;<span class="op" id="3407684">||</span>&nbsp;<span class="ident" id="3407687">l</span><span class="op" id="3407688">.</span><span class="ident" id="3407689">fd</span>&nbsp;<span class="op" id="3407692">==</span>&nbsp;<span class="ident" id="3407695">nil</span>&nbsp;<span class="op" id="3407699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407703">return</span>&nbsp;<span class="ident" id="3407710">syscall</span><span class="op" id="3407717">.</span><span class="ident" id="3407718">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3407726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3407729">return</span>&nbsp;<span class="ident" id="3407736">l</span><span class="op" id="3407737">.</span><span class="ident" id="3407738">fd</span><span class="op" id="3407740">.</span><span class="ident" id="3407741">setDeadline</span><span class="op" id="3407752">(</span><span class="ident" id="3407753">t</span><span class="op" id="3407754">)</span><br>
<span class="lineno">270</span><span class="op" id="3407756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3407759">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3407825">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3407895">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3407960">//</span><br>
<span class="lineno"></span><span class="comment" id="3407963">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3408027">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3408093">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3408157">func</span>&nbsp;<span class="op" id="3408162">(</span><span class="ident" id="3408163">l</span>&nbsp;<span class="op" id="3408165">*</span><span class="ident" id="3408166">TCPListener</span><span class="op" id="3408177">)</span>&nbsp;<span class="ident" id="3408179">File</span><span class="op" id="3408183">(</span><span class="op" id="3408184">)</span>&nbsp;<span class="op" id="3408186">(</span><span class="ident" id="3408187">f</span>&nbsp;<span class="op" id="3408189">*</span><span class="ident" id="3408190">os</span><span class="op" id="3408192">.</span><span class="ident" id="3408193">File</span><span class="op" id="3408197">,</span>&nbsp;<span class="ident" id="3408199">err</span>&nbsp;<span class="builtintype" id="3408203">error</span><span class="op" id="3408208">)</span>&nbsp;<span class="op" id="3408210">{</span>&nbsp;<span class="keyword" id="3408212">return</span>&nbsp;<span class="ident" id="3408219">l</span><span class="op" id="3408220">.</span><span class="ident" id="3408221">fd</span><span class="op" id="3408223">.</span><span class="ident" id="3408224">dup</span><span class="op" id="3408227">(</span><span class="op" id="3408228">)</span>&nbsp;<span class="op" id="3408230">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3408233">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3408299">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3408367">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3408438">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3408508">func</span>&nbsp;<span class="ident" id="3408513">ListenTCP</span><span class="op" id="3408522">(</span><span class="ident" id="3408523">net</span>&nbsp;<span class="builtintype" id="3408527">string</span><span class="op" id="3408533">,</span>&nbsp;<span class="ident" id="3408535">laddr</span>&nbsp;<span class="op" id="3408541">*</span><span class="ident" id="3408542">TCPAddr</span><span class="op" id="3408549">)</span>&nbsp;<span class="op" id="3408551">(</span><span class="op" id="3408552">*</span><span class="ident" id="3408553">TCPListener</span><span class="op" id="3408564">,</span>&nbsp;<span class="builtintype" id="3408566">error</span><span class="op" id="3408571">)</span>&nbsp;<span class="op" id="3408573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408576">switch</span>&nbsp;<span class="ident" id="3408583">net</span>&nbsp;<span class="op" id="3408587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408590">case</span>&nbsp;<span class="string" id="3408595">&#34;tcp&#34;</span><span class="op" id="3408600">,</span>&nbsp;<span class="string" id="3408602">&#34;tcp4&#34;</span><span class="op" id="3408608">,</span>&nbsp;<span class="string" id="3408610">&#34;tcp6&#34;</span><span class="op" id="3408616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408619">default</span><span class="op" id="3408626">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408630">return</span>&nbsp;<span class="ident" id="3408637">nil</span><span class="op" id="3408640">,</span>&nbsp;<span class="op" id="3408642">&amp;</span><span class="ident" id="3408643">OpError</span><span class="op" id="3408650">{</span><span class="ident" id="3408651">Op</span><span class="op" id="3408653">:</span>&nbsp;<span class="string" id="3408655">&#34;listen&#34;</span><span class="op" id="3408663">,</span>&nbsp;<span class="ident" id="3408665">Net</span><span class="op" id="3408668">:</span>&nbsp;<span class="ident" id="3408670">net</span><span class="op" id="3408673">,</span>&nbsp;<span class="ident" id="3408675">Addr</span><span class="op" id="3408679">:</span>&nbsp;<span class="ident" id="3408681">laddr</span><span class="op" id="3408686">,</span>&nbsp;<span class="ident" id="3408688">Err</span><span class="op" id="3408691">:</span>&nbsp;<span class="ident" id="3408693">UnknownNetworkError</span><span class="op" id="3408712">(</span><span class="ident" id="3408713">net</span><span class="op" id="3408716">)</span><span class="op" id="3408717">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3408720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408723">if</span>&nbsp;<span class="ident" id="3408726">laddr</span>&nbsp;<span class="op" id="3408732">==</span>&nbsp;<span class="ident" id="3408735">nil</span>&nbsp;<span class="op" id="3408739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408743">laddr</span>&nbsp;<span class="op" id="3408749">=</span>&nbsp;<span class="op" id="3408751">&amp;</span><span class="ident" id="3408752">TCPAddr</span><span class="op" id="3408759">{</span><span class="op" id="3408760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3408763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3408766">fd</span><span class="op" id="3408768">,</span>&nbsp;<span class="ident" id="3408770">err</span>&nbsp;<span class="op" id="3408774">:=</span>&nbsp;<span class="ident" id="3408777">internetSocket</span><span class="op" id="3408791">(</span><span class="ident" id="3408792">net</span><span class="op" id="3408795">,</span>&nbsp;<span class="ident" id="3408797">laddr</span><span class="op" id="3408802">,</span>&nbsp;<span class="ident" id="3408804">nil</span><span class="op" id="3408807">,</span>&nbsp;<span class="ident" id="3408809">noDeadline</span><span class="op" id="3408819">,</span>&nbsp;<span class="ident" id="3408821">syscall</span><span class="op" id="3408828">.</span><span class="ident" id="3408829">SOCK_STREAM</span><span class="op" id="3408840">,</span>&nbsp;<span class="num" id="3408842">0</span><span class="op" id="3408843">,</span>&nbsp;<span class="string" id="3408845">&#34;listen&#34;</span><span class="op" id="3408853">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408856">if</span>&nbsp;<span class="ident" id="3408859">err</span>&nbsp;<span class="op" id="3408863">!=</span>&nbsp;<span class="ident" id="3408866">nil</span>&nbsp;<span class="op" id="3408870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408874">return</span>&nbsp;<span class="ident" id="3408881">nil</span><span class="op" id="3408884">,</span>&nbsp;<span class="op" id="3408886">&amp;</span><span class="ident" id="3408887">OpError</span><span class="op" id="3408894">{</span><span class="ident" id="3408895">Op</span><span class="op" id="3408897">:</span>&nbsp;<span class="string" id="3408899">&#34;listen&#34;</span><span class="op" id="3408907">,</span>&nbsp;<span class="ident" id="3408909">Net</span><span class="op" id="3408912">:</span>&nbsp;<span class="ident" id="3408914">net</span><span class="op" id="3408917">,</span>&nbsp;<span class="ident" id="3408919">Addr</span><span class="op" id="3408923">:</span>&nbsp;<span class="ident" id="3408925">laddr</span><span class="op" id="3408930">,</span>&nbsp;<span class="ident" id="3408932">Err</span><span class="op" id="3408935">:</span>&nbsp;<span class="ident" id="3408937">err</span><span class="op" id="3408940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3408943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3408946">return</span>&nbsp;<span class="op" id="3408953">&amp;</span><span class="ident" id="3408954">TCPListener</span><span class="op" id="3408965">{</span><span class="ident" id="3408966">fd</span><span class="op" id="3408968">}</span><span class="op" id="3408969">,</span>&nbsp;<span class="ident" id="3408971">nil</span><br>
<span class="lineno"></span><span class="op" id="3408975">}</span>
</div>
</body>
</html>
