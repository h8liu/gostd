<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1387934">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1387989">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1388043">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1388094">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1388164">package</span>&nbsp;<span class="ident" id="1388172">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1388177">import</span>&nbsp;<span class="op" id="1388184">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1388187">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1388193">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1388199">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1388210">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1388225">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1388236">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1388243">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1388246">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1388274">type</span>&nbsp;<span class="ident" id="1388279">netFD</span>&nbsp;<span class="keyword" id="1388285">struct</span>&nbsp;<span class="op" id="1388292">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1388295">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388370">fdmu</span>&nbsp;<span class="ident" id="1388375"><a href="/net/fd_mutex.go.html#1380501">fdMutex</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1388385">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388411">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1388423">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388428">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1388440">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388445">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1388457">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388462">isConnected</span>&nbsp;<span class="builtintype" id="1388474">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388480">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1388492">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388500">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1388512"><a href="/net/net.go.html#1465097">Addr</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388518">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1388530"><a href="/net/net.go.html#1465097">Addr</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1388537">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1388553">pd</span>&nbsp;<span class="ident" id="1388556"><a href="/net/fd_poll_runtime.go.html#1385688">pollDesc</a></span><br>
<span class="lineno"></span><span class="op" id="1388565">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1388568">func</span>&nbsp;<span class="ident" id="1388573">sysInit</span><span class="op" id="1388580">(</span><span class="op" id="1388581">)</span>&nbsp;<span class="op" id="1388583">{</span><br>
<span class="lineno"></span><span class="op" id="1388585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1388588">func</span>&nbsp;<span class="ident" id="1388593">dial</span><span class="op" id="1388597">(</span><span class="ident" id="1388598">network</span>&nbsp;<span class="builtintype" id="1388606">string</span><span class="op" id="1388612">,</span>&nbsp;<span class="ident" id="1388614">ra</span>&nbsp;<span class="ident" id="1388617"><a href="/net/net.go.html#1465097">Addr</a></span><span class="op" id="1388621">,</span>&nbsp;<span class="ident" id="1388623">dialer</span>&nbsp;<span class="keyword" id="1388630">func</span><span class="op" id="1388634">(</span><span class="ident" id="1388635"><a href="/net/fd_unix.go.html#1388236">time</a></span><span class="op" id="1388639">.</span><span class="ident" id="1388640">Time</span><span class="op" id="1388644">)</span>&nbsp;<span class="op" id="1388646">(</span><span class="ident" id="1388647"><a href="/net/net.go.html#1465335">Conn</a></span><span class="op" id="1388651">,</span>&nbsp;<span class="builtintype" id="1388653">error</span><span class="op" id="1388658">)</span><span class="op" id="1388659">,</span>&nbsp;<span class="ident" id="1388661">deadline</span>&nbsp;<span class="ident" id="1388670"><a href="/net/fd_unix.go.html#1388236">time</a></span><span class="op" id="1388674">.</span><span class="ident" id="1388675">Time</span><span class="op" id="1388679">)</span>&nbsp;<span class="op" id="1388681">(</span><span class="ident" id="1388682"><a href="/net/net.go.html#1465335">Conn</a></span><span class="op" id="1388686">,</span>&nbsp;<span class="builtintype" id="1388688">error</span><span class="op" id="1388693">)</span>&nbsp;<span class="op" id="1388695">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1388698">return</span>&nbsp;<span class="ident" id="1388705"><a href="/net/fd_unix.go.html#1388623">dialer</a></span><span class="op" id="1388711">(</span><span class="ident" id="1388712"><a href="/net/fd_unix.go.html#1388661">deadline</a></span><span class="op" id="1388720">)</span><br>
<span class="lineno"></span><span class="op" id="1388722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1388725">func</span>&nbsp;<span class="ident" id="1388730">newFD</span><span class="op" id="1388735">(</span><span class="ident" id="1388736">sysfd</span><span class="op" id="1388741">,</span>&nbsp;<span class="ident" id="1388743">family</span><span class="op" id="1388749">,</span>&nbsp;<span class="ident" id="1388751">sotype</span>&nbsp;<span class="builtintype" id="1388758">int</span><span class="op" id="1388761">,</span>&nbsp;<span class="ident" id="1388763">net</span>&nbsp;<span class="builtintype" id="1388767">string</span><span class="op" id="1388773">)</span>&nbsp;<span class="op" id="1388775">(</span><span class="op" id="1388776">*</span><span class="ident" id="1388777"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1388782">,</span>&nbsp;<span class="builtintype" id="1388784">error</span><span class="op" id="1388789">)</span>&nbsp;<span class="op" id="1388791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1388794">return</span>&nbsp;<span class="op" id="1388801">&amp;</span><span class="ident" id="1388802"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1388807">{</span><span class="ident" id="1388808">sysfd</span><span class="op" id="1388813">:</span>&nbsp;<span class="ident" id="1388815"><a href="/net/fd_unix.go.html#1388736">sysfd</a></span><span class="op" id="1388820">,</span>&nbsp;<span class="ident" id="1388822">family</span><span class="op" id="1388828">:</span>&nbsp;<span class="ident" id="1388830"><a href="/net/fd_unix.go.html#1388743">family</a></span><span class="op" id="1388836">,</span>&nbsp;<span class="ident" id="1388838">sotype</span><span class="op" id="1388844">:</span>&nbsp;<span class="ident" id="1388846"><a href="/net/fd_unix.go.html#1388751">sotype</a></span><span class="op" id="1388852">,</span>&nbsp;<span class="ident" id="1388854">net</span><span class="op" id="1388857">:</span>&nbsp;<span class="ident" id="1388859"><a href="/net/fd_unix.go.html#1388763">net</a></span><span class="op" id="1388862">}</span><span class="op" id="1388863">,</span>&nbsp;<span class="ident" id="1388865">nil</span><br>
<span class="lineno">45</span><span class="op" id="1388869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1388872">func</span>&nbsp;<span class="op" id="1388877">(</span><span class="ident" id="1388878">fd</span>&nbsp;<span class="op" id="1388881">*</span><span class="ident" id="1388882"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1388887">)</span>&nbsp;<span class="ident" id="1388889">init</span><span class="op" id="1388893">(</span><span class="op" id="1388894">)</span>&nbsp;<span class="builtintype" id="1388896">error</span>&nbsp;<span class="op" id="1388902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1388905">if</span>&nbsp;<span class="ident" id="1388908">err</span>&nbsp;<span class="op" id="1388912">:=</span>&nbsp;<span class="ident" id="1388915"><a href="/net/fd_unix.go.html#1388878">fd</a></span><span class="op" id="1388917">.</span><span class="ident" id="1388918">pd</span><span class="op" id="1388920">.</span><span class="ident" id="1388921">Init</span><span class="op" id="1388925">(</span><span class="ident" id="1388926"><a href="/net/fd_unix.go.html#1388878">fd</a></span><span class="op" id="1388928">)</span><span class="op" id="1388929">;</span>&nbsp;<span class="ident" id="1388931"><a href="/net/fd_unix.go.html#1388908">err</a></span>&nbsp;<span class="op" id="1388935">!=</span>&nbsp;<span class="ident" id="1388938">nil</span>&nbsp;<span class="op" id="1388942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1388946">return</span>&nbsp;<span class="ident" id="1388953"><a href="/net/fd_unix.go.html#1388908">err</a></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1388958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1388961">return</span>&nbsp;<span class="ident" id="1388968">nil</span><br>
<span class="lineno"></span><span class="op" id="1388972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1388975">func</span>&nbsp;<span class="op" id="1388980">(</span><span class="ident" id="1388981">fd</span>&nbsp;<span class="op" id="1388984">*</span><span class="ident" id="1388985"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1388990">)</span>&nbsp;<span class="ident" id="1388992">setAddr</span><span class="op" id="1388999">(</span><span class="ident" id="1389000">laddr</span><span class="op" id="1389005">,</span>&nbsp;<span class="ident" id="1389007">raddr</span>&nbsp;<span class="ident" id="1389013"><a href="/net/net.go.html#1465097">Addr</a></span><span class="op" id="1389017">)</span>&nbsp;<span class="op" id="1389019">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1389022"><a href="/net/fd_unix.go.html#1388981">fd</a></span><span class="op" id="1389024">.</span><span class="ident" id="1389025">laddr</span>&nbsp;<span class="op" id="1389031">=</span>&nbsp;<span class="ident" id="1389033"><a href="/net/fd_unix.go.html#1389000">laddr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1389040"><a href="/net/fd_unix.go.html#1388981">fd</a></span><span class="op" id="1389042">.</span><span class="ident" id="1389043">raddr</span>&nbsp;<span class="op" id="1389049">=</span>&nbsp;<span class="ident" id="1389051"><a href="/net/fd_unix.go.html#1389007">raddr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1389058"><a href="/net/fd_unix.go.html#1388199">runtime</a></span><span class="op" id="1389065">.</span><span class="ident" id="1389066">SetFinalizer</span><span class="op" id="1389078">(</span><span class="ident" id="1389079"><a href="/net/fd_unix.go.html#1388981">fd</a></span><span class="op" id="1389081">,</span>&nbsp;<span class="op" id="1389083">(</span><span class="op" id="1389084">*</span><span class="ident" id="1389085"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1389090">)</span><span class="op" id="1389091">.</span><span class="ident" id="1389092">Close</span><span class="op" id="1389097">)</span><br>
<span class="lineno"></span><span class="op" id="1389099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1389102">func</span>&nbsp;<span class="op" id="1389107">(</span><span class="ident" id="1389108">fd</span>&nbsp;<span class="op" id="1389111">*</span><span class="ident" id="1389112"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1389117">)</span>&nbsp;<span class="ident" id="1389119">name</span><span class="op" id="1389123">(</span><span class="op" id="1389124">)</span>&nbsp;<span class="builtintype" id="1389126">string</span>&nbsp;<span class="op" id="1389133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389136">var</span>&nbsp;<span class="ident" id="1389140">ls</span><span class="op" id="1389142">,</span>&nbsp;<span class="ident" id="1389144">rs</span>&nbsp;<span class="builtintype" id="1389147">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389155">if</span>&nbsp;<span class="ident" id="1389158"><a href="/net/fd_unix.go.html#1389108">fd</a></span><span class="op" id="1389160">.</span><span class="ident" id="1389161">laddr</span>&nbsp;<span class="op" id="1389167">!=</span>&nbsp;<span class="ident" id="1389170">nil</span>&nbsp;<span class="op" id="1389174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1389178"><a href="/net/fd_unix.go.html#1389140">ls</a></span>&nbsp;<span class="op" id="1389181">=</span>&nbsp;<span class="ident" id="1389183"><a href="/net/fd_unix.go.html#1389108">fd</a></span><span class="op" id="1389185">.</span><span class="ident" id="1389186">laddr</span><span class="op" id="1389191">.</span><span class="ident" id="1389192">String</span><span class="op" id="1389198">(</span><span class="op" id="1389199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1389202">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389205">if</span>&nbsp;<span class="ident" id="1389208"><a href="/net/fd_unix.go.html#1389108">fd</a></span><span class="op" id="1389210">.</span><span class="ident" id="1389211">raddr</span>&nbsp;<span class="op" id="1389217">!=</span>&nbsp;<span class="ident" id="1389220">nil</span>&nbsp;<span class="op" id="1389224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1389228"><a href="/net/fd_unix.go.html#1389144">rs</a></span>&nbsp;<span class="op" id="1389231">=</span>&nbsp;<span class="ident" id="1389233"><a href="/net/fd_unix.go.html#1389108">fd</a></span><span class="op" id="1389235">.</span><span class="ident" id="1389236">raddr</span><span class="op" id="1389241">.</span><span class="ident" id="1389242">String</span><span class="op" id="1389248">(</span><span class="op" id="1389249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1389252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389255">return</span>&nbsp;<span class="ident" id="1389262"><a href="/net/fd_unix.go.html#1389108">fd</a></span><span class="op" id="1389264">.</span><span class="ident" id="1389265">net</span>&nbsp;<span class="op" id="1389269">+</span>&nbsp;<span class="string" id="1389271">&#34;:&#34;</span>&nbsp;<span class="op" id="1389275">+</span>&nbsp;<span class="ident" id="1389277"><a href="/net/fd_unix.go.html#1389140">ls</a></span>&nbsp;<span class="op" id="1389280">+</span>&nbsp;<span class="string" id="1389282">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="1389287">+</span>&nbsp;<span class="ident" id="1389289"><a href="/net/fd_unix.go.html#1389144">rs</a></span><br>
<span class="lineno"></span><span class="op" id="1389292">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="1389295">func</span>&nbsp;<span class="op" id="1389300">(</span><span class="ident" id="1389301">fd</span>&nbsp;<span class="op" id="1389304">*</span><span class="ident" id="1389305"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1389310">)</span>&nbsp;<span class="ident" id="1389312">connect</span><span class="op" id="1389319">(</span><span class="ident" id="1389320">la</span><span class="op" id="1389322">,</span>&nbsp;<span class="ident" id="1389324">ra</span>&nbsp;<span class="ident" id="1389327"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389334">.</span><span class="ident" id="1389335">Sockaddr</span><span class="op" id="1389343">,</span>&nbsp;<span class="ident" id="1389345">deadline</span>&nbsp;<span class="ident" id="1389354"><a href="/net/fd_unix.go.html#1388236">time</a></span><span class="op" id="1389358">.</span><span class="ident" id="1389359">Time</span><span class="op" id="1389363">)</span>&nbsp;<span class="builtintype" id="1389365">error</span>&nbsp;<span class="op" id="1389371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389374">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389417">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389463">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389509">switch</span>&nbsp;<span class="ident" id="1389516">err</span>&nbsp;<span class="op" id="1389520">:=</span>&nbsp;<span class="ident" id="1389523"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389530">.</span><span class="ident" id="1389531">Connect</span><span class="op" id="1389538">(</span><span class="ident" id="1389539"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1389541">.</span><span class="ident" id="1389542">sysfd</span><span class="op" id="1389547">,</span>&nbsp;<span class="ident" id="1389549"><a href="/net/fd_unix.go.html#1389324">ra</a></span><span class="op" id="1389551">)</span><span class="op" id="1389552">;</span>&nbsp;<span class="ident" id="1389554"><a href="/net/fd_unix.go.html#1389516">err</a></span>&nbsp;<span class="op" id="1389558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389561">case</span>&nbsp;<span class="ident" id="1389566"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389573">.</span><span class="ident" id="1389574">EINPROGRESS</span><span class="op" id="1389585">,</span>&nbsp;<span class="ident" id="1389587"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389594">.</span><span class="ident" id="1389595">EALREADY</span><span class="op" id="1389603">,</span>&nbsp;<span class="ident" id="1389605"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389612">.</span><span class="ident" id="1389613">EINTR</span><span class="op" id="1389618">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389621">case</span>&nbsp;<span class="ident" id="1389626">nil</span><span class="op" id="1389629">,</span>&nbsp;<span class="ident" id="1389631"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389638">.</span><span class="ident" id="1389639">EISCONN</span><span class="op" id="1389646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389650">if</span>&nbsp;<span class="op" id="1389653">!</span><span class="ident" id="1389654"><a href="/net/fd_unix.go.html#1389345">deadline</a></span><span class="op" id="1389662">.</span><span class="ident" id="1389663">IsZero</span><span class="op" id="1389669">(</span><span class="op" id="1389670">)</span>&nbsp;<span class="op" id="1389672">&amp;&amp;</span>&nbsp;<span class="ident" id="1389675"><a href="/net/fd_unix.go.html#1389345">deadline</a></span><span class="op" id="1389683">.</span><span class="ident" id="1389684">Before</span><span class="op" id="1389690">(</span><span class="ident" id="1389691"><a href="/net/fd_unix.go.html#1388236">time</a></span><span class="op" id="1389695">.</span><span class="ident" id="1389696">Now</span><span class="op" id="1389699">(</span><span class="op" id="1389700">)</span><span class="op" id="1389701">)</span>&nbsp;<span class="op" id="1389703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389708">return</span>&nbsp;<span class="ident" id="1389715"><a href="/net/net.go.html#1472112">errTimeout</a></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1389728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389732">if</span>&nbsp;<span class="ident" id="1389735">err</span>&nbsp;<span class="op" id="1389739">:=</span>&nbsp;<span class="ident" id="1389742"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1389744">.</span><span class="ident" id="1389745">init</span><span class="op" id="1389749">(</span><span class="op" id="1389750">)</span><span class="op" id="1389751">;</span>&nbsp;<span class="ident" id="1389753"><a href="/net/fd_unix.go.html#1389735">err</a></span>&nbsp;<span class="op" id="1389757">!=</span>&nbsp;<span class="ident" id="1389760">nil</span>&nbsp;<span class="op" id="1389764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389769">return</span>&nbsp;<span class="ident" id="1389776"><a href="/net/fd_unix.go.html#1389735">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1389782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389786">return</span>&nbsp;<span class="ident" id="1389793">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1389798">case</span>&nbsp;<span class="ident" id="1389803"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1389810">.</span><span class="ident" id="1389811">EINVAL</span><span class="op" id="1389817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389821">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389873">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389926">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1389980">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390034">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390083">if</span>&nbsp;<span class="ident" id="1390086"><a href="/net/fd_unix.go.html#1388199">runtime</a></span><span class="op" id="1390093">.</span><span class="ident" id="1390094">GOOS</span>&nbsp;<span class="op" id="1390099">==</span>&nbsp;<span class="string" id="1390102">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1390112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390117">return</span>&nbsp;<span class="ident" id="1390124">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1390130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390134">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390147">default</span><span class="op" id="1390154">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390158">return</span>&nbsp;<span class="ident" id="1390165"><a href="/net/fd_unix.go.html#1389516">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1390170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390173">if</span>&nbsp;<span class="ident" id="1390176">err</span>&nbsp;<span class="op" id="1390180">:=</span>&nbsp;<span class="ident" id="1390183"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1390185">.</span><span class="ident" id="1390186">init</span><span class="op" id="1390190">(</span><span class="op" id="1390191">)</span><span class="op" id="1390192">;</span>&nbsp;<span class="ident" id="1390194"><a href="/net/fd_unix.go.html#1390176">err</a></span>&nbsp;<span class="op" id="1390198">!=</span>&nbsp;<span class="ident" id="1390201">nil</span>&nbsp;<span class="op" id="1390205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390209">return</span>&nbsp;<span class="ident" id="1390216"><a href="/net/fd_unix.go.html#1390176">err</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1390221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390224">if</span>&nbsp;<span class="op" id="1390227">!</span><span class="ident" id="1390228"><a href="/net/fd_unix.go.html#1389345">deadline</a></span><span class="op" id="1390236">.</span><span class="ident" id="1390237">IsZero</span><span class="op" id="1390243">(</span><span class="op" id="1390244">)</span>&nbsp;<span class="op" id="1390246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1390250"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1390252">.</span><span class="ident" id="1390253">setWriteDeadline</span><span class="op" id="1390269">(</span><span class="ident" id="1390270"><a href="/net/fd_unix.go.html#1389345">deadline</a></span><span class="op" id="1390278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390282">defer</span>&nbsp;<span class="ident" id="1390288"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1390290">.</span><span class="ident" id="1390291">setWriteDeadline</span><span class="op" id="1390307">(</span><span class="ident" id="1390308"><a href="/net/net.go.html#1473194">noDeadline</a></span><span class="op" id="1390318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1390321">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390324">for</span>&nbsp;<span class="op" id="1390328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390332">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390383">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390437">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390485">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390541">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390596">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390649">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1390702">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390716">if</span>&nbsp;<span class="ident" id="1390719">err</span>&nbsp;<span class="op" id="1390723">:=</span>&nbsp;<span class="ident" id="1390726"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1390728">.</span><span class="ident" id="1390729">pd</span><span class="op" id="1390731">.</span><span class="ident" id="1390732">WaitWrite</span><span class="op" id="1390741">(</span><span class="op" id="1390742">)</span><span class="op" id="1390743">;</span>&nbsp;<span class="ident" id="1390745"><a href="/net/fd_unix.go.html#1390719">err</a></span>&nbsp;<span class="op" id="1390749">!=</span>&nbsp;<span class="ident" id="1390752">nil</span>&nbsp;<span class="op" id="1390756">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390761">return</span>&nbsp;<span class="ident" id="1390768"><a href="/net/fd_unix.go.html#1390719">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1390774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1390778">nerr</span><span class="op" id="1390782">,</span>&nbsp;<span class="ident" id="1390784">err</span>&nbsp;<span class="op" id="1390788">:=</span>&nbsp;<span class="ident" id="1390791"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390798">.</span><span class="ident" id="1390799">GetsockoptInt</span><span class="op" id="1390812">(</span><span class="ident" id="1390813"><a href="/net/fd_unix.go.html#1389301">fd</a></span><span class="op" id="1390815">.</span><span class="ident" id="1390816">sysfd</span><span class="op" id="1390821">,</span>&nbsp;<span class="ident" id="1390823"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390830">.</span><span class="ident" id="1390831">SOL_SOCKET</span><span class="op" id="1390841">,</span>&nbsp;<span class="ident" id="1390843"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390850">.</span><span class="ident" id="1390851">SO_ERROR</span><span class="op" id="1390859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390863">if</span>&nbsp;<span class="ident" id="1390866"><a href="/net/fd_unix.go.html#1390784">err</a></span>&nbsp;<span class="op" id="1390870">!=</span>&nbsp;<span class="ident" id="1390873">nil</span>&nbsp;<span class="op" id="1390877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390882">return</span>&nbsp;<span class="ident" id="1390889"><a href="/net/fd_unix.go.html#1390784">err</a></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1390895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390899">switch</span>&nbsp;<span class="ident" id="1390906">err</span>&nbsp;<span class="op" id="1390910">:=</span>&nbsp;<span class="ident" id="1390913"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390920">.</span><span class="ident" id="1390921">Errno</span><span class="op" id="1390926">(</span><span class="ident" id="1390927"><a href="/net/fd_unix.go.html#1390778">nerr</a></span><span class="op" id="1390931">)</span><span class="op" id="1390932">;</span>&nbsp;<span class="ident" id="1390934"><a href="/net/fd_unix.go.html#1390906">err</a></span>&nbsp;<span class="op" id="1390938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1390942">case</span>&nbsp;<span class="ident" id="1390947"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390954">.</span><span class="ident" id="1390955">EINPROGRESS</span><span class="op" id="1390966">,</span>&nbsp;<span class="ident" id="1390968"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390975">.</span><span class="ident" id="1390976">EALREADY</span><span class="op" id="1390984">,</span>&nbsp;<span class="ident" id="1390986"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1390993">.</span><span class="ident" id="1390994">EINTR</span><span class="op" id="1390999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391003">case</span>&nbsp;<span class="ident" id="1391008"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1391015">.</span><span class="ident" id="1391016">Errno</span><span class="op" id="1391021">(</span><span class="num" id="1391022">0</span><span class="op" id="1391023">)</span><span class="op" id="1391024">,</span>&nbsp;<span class="ident" id="1391026"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1391033">.</span><span class="ident" id="1391034">EISCONN</span><span class="op" id="1391041">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391046">return</span>&nbsp;<span class="ident" id="1391053">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391059">default</span><span class="op" id="1391066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391071">return</span>&nbsp;<span class="ident" id="1391078"><a href="/net/fd_unix.go.html#1390906">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1391084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1391087">}</span><br>
<span class="lineno"></span><span class="op" id="1391089">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="1391092">func</span>&nbsp;<span class="op" id="1391097">(</span><span class="ident" id="1391098">fd</span>&nbsp;<span class="op" id="1391101">*</span><span class="ident" id="1391102"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1391107">)</span>&nbsp;<span class="ident" id="1391109">destroy</span><span class="op" id="1391116">(</span><span class="op" id="1391117">)</span>&nbsp;<span class="op" id="1391119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1391122">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1391196">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1391245"><a href="/net/fd_unix.go.html#1391098">fd</a></span><span class="op" id="1391247">.</span><span class="ident" id="1391248">pd</span><span class="op" id="1391250">.</span><span class="ident" id="1391251">Close</span><span class="op" id="1391256">(</span><span class="op" id="1391257">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1391260"><a href="/net/fd_unix.go.html#1400109">closesocket</a></span><span class="op" id="1391271">(</span><span class="ident" id="1391272"><a href="/net/fd_unix.go.html#1391098">fd</a></span><span class="op" id="1391274">.</span><span class="ident" id="1391275">sysfd</span><span class="op" id="1391280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1391283"><a href="/net/fd_unix.go.html#1391098">fd</a></span><span class="op" id="1391285">.</span><span class="ident" id="1391286">sysfd</span>&nbsp;<span class="op" id="1391292">=</span>&nbsp;<span class="op" id="1391294">-</span><span class="num" id="1391295">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1391298"><a href="/net/fd_unix.go.html#1388199">runtime</a></span><span class="op" id="1391305">.</span><span class="ident" id="1391306">SetFinalizer</span><span class="op" id="1391318">(</span><span class="ident" id="1391319"><a href="/net/fd_unix.go.html#1391098">fd</a></span><span class="op" id="1391321">,</span>&nbsp;<span class="ident" id="1391323">nil</span><span class="op" id="1391326">)</span><br>
<span class="lineno"></span><span class="op" id="1391328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="1391331">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="1391362">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1391408">func</span>&nbsp;<span class="op" id="1391413">(</span><span class="ident" id="1391414">fd</span>&nbsp;<span class="op" id="1391417">*</span><span class="ident" id="1391418"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1391423">)</span>&nbsp;<span class="ident" id="1391425">incref</span><span class="op" id="1391431">(</span><span class="op" id="1391432">)</span>&nbsp;<span class="builtintype" id="1391434">error</span>&nbsp;<span class="op" id="1391440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391443">if</span>&nbsp;<span class="op" id="1391446">!</span><span class="ident" id="1391447"><a href="/net/fd_unix.go.html#1391414">fd</a></span><span class="op" id="1391449">.</span><span class="ident" id="1391450">fdmu</span><span class="op" id="1391454">.</span><span class="ident" id="1391455">Incref</span><span class="op" id="1391461">(</span><span class="op" id="1391462">)</span>&nbsp;<span class="op" id="1391464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391468">return</span>&nbsp;<span class="ident" id="1391475"><a href="/net/net.go.html#1472157">errClosing</a></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1391487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391490">return</span>&nbsp;<span class="ident" id="1391497">nil</span><br>
<span class="lineno"></span><span class="op" id="1391501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1391504">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="1391576">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="1391615">func</span>&nbsp;<span class="op" id="1391620">(</span><span class="ident" id="1391621">fd</span>&nbsp;<span class="op" id="1391624">*</span><span class="ident" id="1391625"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1391630">)</span>&nbsp;<span class="ident" id="1391632">decref</span><span class="op" id="1391638">(</span><span class="op" id="1391639">)</span>&nbsp;<span class="op" id="1391641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391644">if</span>&nbsp;<span class="ident" id="1391647"><a href="/net/fd_unix.go.html#1391621">fd</a></span><span class="op" id="1391649">.</span><span class="ident" id="1391650">fdmu</span><span class="op" id="1391654">.</span><span class="ident" id="1391655">Decref</span><span class="op" id="1391661">(</span><span class="op" id="1391662">)</span>&nbsp;<span class="op" id="1391664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1391668"><a href="/net/fd_unix.go.html#1391621">fd</a></span><span class="op" id="1391670">.</span><span class="ident" id="1391671">destroy</span><span class="op" id="1391678">(</span><span class="op" id="1391679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1391682">}</span><br>
<span class="lineno">155</span><span class="op" id="1391684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1391687">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="1391739">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1391785">func</span>&nbsp;<span class="op" id="1391790">(</span><span class="ident" id="1391791">fd</span>&nbsp;<span class="op" id="1391794">*</span><span class="ident" id="1391795"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1391800">)</span>&nbsp;<span class="ident" id="1391802">readLock</span><span class="op" id="1391810">(</span><span class="op" id="1391811">)</span>&nbsp;<span class="builtintype" id="1391813">error</span>&nbsp;<span class="op" id="1391819">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391822">if</span>&nbsp;<span class="op" id="1391825">!</span><span class="ident" id="1391826"><a href="/net/fd_unix.go.html#1391791">fd</a></span><span class="op" id="1391828">.</span><span class="ident" id="1391829">fdmu</span><span class="op" id="1391833">.</span><span class="ident" id="1391834">RWLock</span><span class="op" id="1391840">(</span><span class="builtintype" id="1391841">true</span><span class="op" id="1391845">)</span>&nbsp;<span class="op" id="1391847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391851">return</span>&nbsp;<span class="ident" id="1391858"><a href="/net/net.go.html#1472157">errClosing</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1391870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391873">return</span>&nbsp;<span class="ident" id="1391880">nil</span><br>
<span class="lineno"></span><span class="op" id="1391884">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="1391887">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="1391944">func</span>&nbsp;<span class="op" id="1391949">(</span><span class="ident" id="1391950">fd</span>&nbsp;<span class="op" id="1391953">*</span><span class="ident" id="1391954"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1391959">)</span>&nbsp;<span class="ident" id="1391961">readUnlock</span><span class="op" id="1391971">(</span><span class="op" id="1391972">)</span>&nbsp;<span class="op" id="1391974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1391977">if</span>&nbsp;<span class="ident" id="1391980"><a href="/net/fd_unix.go.html#1391950">fd</a></span><span class="op" id="1391982">.</span><span class="ident" id="1391983">fdmu</span><span class="op" id="1391987">.</span><span class="ident" id="1391988">RWUnlock</span><span class="op" id="1391996">(</span><span class="builtintype" id="1391997">true</span><span class="op" id="1392001">)</span>&nbsp;<span class="op" id="1392003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392007"><a href="/net/fd_unix.go.html#1391950">fd</a></span><span class="op" id="1392009">.</span><span class="ident" id="1392010">destroy</span><span class="op" id="1392017">(</span><span class="op" id="1392018">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1392021">}</span><br>
<span class="lineno"></span><span class="op" id="1392023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1392026">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1392078">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="1392124">func</span>&nbsp;<span class="op" id="1392129">(</span><span class="ident" id="1392130">fd</span>&nbsp;<span class="op" id="1392133">*</span><span class="ident" id="1392134"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1392139">)</span>&nbsp;<span class="ident" id="1392141">writeLock</span><span class="op" id="1392150">(</span><span class="op" id="1392151">)</span>&nbsp;<span class="builtintype" id="1392153">error</span>&nbsp;<span class="op" id="1392159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392162">if</span>&nbsp;<span class="op" id="1392165">!</span><span class="ident" id="1392166"><a href="/net/fd_unix.go.html#1392130">fd</a></span><span class="op" id="1392168">.</span><span class="ident" id="1392169">fdmu</span><span class="op" id="1392173">.</span><span class="ident" id="1392174">RWLock</span><span class="op" id="1392180">(</span><span class="builtintype" id="1392181">false</span><span class="op" id="1392186">)</span>&nbsp;<span class="op" id="1392188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392192">return</span>&nbsp;<span class="ident" id="1392199"><a href="/net/net.go.html#1472157">errClosing</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1392211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392214">return</span>&nbsp;<span class="ident" id="1392221">nil</span><br>
<span class="lineno">180</span><span class="op" id="1392225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1392228">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="1392285">func</span>&nbsp;<span class="op" id="1392290">(</span><span class="ident" id="1392291">fd</span>&nbsp;<span class="op" id="1392294">*</span><span class="ident" id="1392295"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1392300">)</span>&nbsp;<span class="ident" id="1392302">writeUnlock</span><span class="op" id="1392313">(</span><span class="op" id="1392314">)</span>&nbsp;<span class="op" id="1392316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392319">if</span>&nbsp;<span class="ident" id="1392322"><a href="/net/fd_unix.go.html#1392291">fd</a></span><span class="op" id="1392324">.</span><span class="ident" id="1392325">fdmu</span><span class="op" id="1392329">.</span><span class="ident" id="1392330">RWUnlock</span><span class="op" id="1392338">(</span><span class="builtintype" id="1392339">false</span><span class="op" id="1392344">)</span>&nbsp;<span class="op" id="1392346">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392350"><a href="/net/fd_unix.go.html#1392291">fd</a></span><span class="op" id="1392352">.</span><span class="ident" id="1392353">destroy</span><span class="op" id="1392360">(</span><span class="op" id="1392361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1392364">}</span><br>
<span class="lineno"></span><span class="op" id="1392366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1392369">func</span>&nbsp;<span class="op" id="1392374">(</span><span class="ident" id="1392375">fd</span>&nbsp;<span class="op" id="1392378">*</span><span class="ident" id="1392379"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1392384">)</span>&nbsp;<span class="ident" id="1392386">Close</span><span class="op" id="1392391">(</span><span class="op" id="1392392">)</span>&nbsp;<span class="builtintype" id="1392394">error</span>&nbsp;<span class="op" id="1392400">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392403"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392405">.</span><span class="ident" id="1392406">pd</span><span class="op" id="1392408">.</span><span class="ident" id="1392409">Lock</span><span class="op" id="1392413">(</span><span class="op" id="1392414">)</span>&nbsp;<span class="comment" id="1392416">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392471">if</span>&nbsp;<span class="op" id="1392474">!</span><span class="ident" id="1392475"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392477">.</span><span class="ident" id="1392478">fdmu</span><span class="op" id="1392482">.</span><span class="ident" id="1392483">IncrefAndClose</span><span class="op" id="1392497">(</span><span class="op" id="1392498">)</span>&nbsp;<span class="op" id="1392500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392504"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392506">.</span><span class="ident" id="1392507">pd</span><span class="op" id="1392509">.</span><span class="ident" id="1392510">Unlock</span><span class="op" id="1392516">(</span><span class="op" id="1392517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392521">return</span>&nbsp;<span class="ident" id="1392528"><a href="/net/net.go.html#1472157">errClosing</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1392540">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1392543">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1392599">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1392655">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1392717">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1392780">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392842">doWakeup</span>&nbsp;<span class="op" id="1392851">:=</span>&nbsp;<span class="ident" id="1392854"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392856">.</span><span class="ident" id="1392857">pd</span><span class="op" id="1392859">.</span><span class="ident" id="1392860">Evict</span><span class="op" id="1392865">(</span><span class="op" id="1392866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392869"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392871">.</span><span class="ident" id="1392872">pd</span><span class="op" id="1392874">.</span><span class="ident" id="1392875">Unlock</span><span class="op" id="1392881">(</span><span class="op" id="1392882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392885"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392887">.</span><span class="ident" id="1392888">decref</span><span class="op" id="1392894">(</span><span class="op" id="1392895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392898">if</span>&nbsp;<span class="ident" id="1392901"><a href="/net/fd_unix.go.html#1392842">doWakeup</a></span>&nbsp;<span class="op" id="1392910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1392914"><a href="/net/fd_unix.go.html#1392375">fd</a></span><span class="op" id="1392916">.</span><span class="ident" id="1392917">pd</span><span class="op" id="1392919">.</span><span class="ident" id="1392920">Wakeup</span><span class="op" id="1392926">(</span><span class="op" id="1392927">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1392930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392933">return</span>&nbsp;<span class="ident" id="1392940">nil</span><br>
<span class="lineno"></span><span class="op" id="1392944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1392947">func</span>&nbsp;<span class="op" id="1392952">(</span><span class="ident" id="1392953">fd</span>&nbsp;<span class="op" id="1392956">*</span><span class="ident" id="1392957"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1392962">)</span>&nbsp;<span class="ident" id="1392964">shutdown</span><span class="op" id="1392972">(</span><span class="ident" id="1392973">how</span>&nbsp;<span class="builtintype" id="1392977">int</span><span class="op" id="1392980">)</span>&nbsp;<span class="builtintype" id="1392982">error</span>&nbsp;<span class="op" id="1392988">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1392991">if</span>&nbsp;<span class="ident" id="1392994">err</span>&nbsp;<span class="op" id="1392998">:=</span>&nbsp;<span class="ident" id="1393001"><a href="/net/fd_unix.go.html#1392953">fd</a></span><span class="op" id="1393003">.</span><span class="ident" id="1393004">incref</span><span class="op" id="1393010">(</span><span class="op" id="1393011">)</span><span class="op" id="1393012">;</span>&nbsp;<span class="ident" id="1393014"><a href="/net/fd_unix.go.html#1392994">err</a></span>&nbsp;<span class="op" id="1393018">!=</span>&nbsp;<span class="ident" id="1393021">nil</span>&nbsp;<span class="op" id="1393025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393029">return</span>&nbsp;<span class="ident" id="1393036"><a href="/net/fd_unix.go.html#1392994">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393044">defer</span>&nbsp;<span class="ident" id="1393050"><a href="/net/fd_unix.go.html#1392953">fd</a></span><span class="op" id="1393052">.</span><span class="ident" id="1393053">decref</span><span class="op" id="1393059">(</span><span class="op" id="1393060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1393063">err</span>&nbsp;<span class="op" id="1393067">:=</span>&nbsp;<span class="ident" id="1393070"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1393077">.</span><span class="ident" id="1393078">Shutdown</span><span class="op" id="1393086">(</span><span class="ident" id="1393087"><a href="/net/fd_unix.go.html#1392953">fd</a></span><span class="op" id="1393089">.</span><span class="ident" id="1393090">sysfd</span><span class="op" id="1393095">,</span>&nbsp;<span class="ident" id="1393097"><a href="/net/fd_unix.go.html#1392973">how</a></span><span class="op" id="1393100">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393103">if</span>&nbsp;<span class="ident" id="1393106"><a href="/net/fd_unix.go.html#1393063">err</a></span>&nbsp;<span class="op" id="1393110">!=</span>&nbsp;<span class="ident" id="1393113">nil</span>&nbsp;<span class="op" id="1393117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393121">return</span>&nbsp;<span class="op" id="1393128">&amp;</span><span class="ident" id="1393129"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1393136">{</span><span class="string" id="1393137">&#34;shutdown&#34;</span><span class="op" id="1393147">,</span>&nbsp;<span class="ident" id="1393149"><a href="/net/fd_unix.go.html#1392953">fd</a></span><span class="op" id="1393151">.</span><span class="ident" id="1393152">net</span><span class="op" id="1393155">,</span>&nbsp;<span class="ident" id="1393157"><a href="/net/fd_unix.go.html#1392953">fd</a></span><span class="op" id="1393159">.</span><span class="ident" id="1393160">laddr</span><span class="op" id="1393165">,</span>&nbsp;<span class="ident" id="1393167"><a href="/net/fd_unix.go.html#1393063">err</a></span><span class="op" id="1393170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393176">return</span>&nbsp;<span class="ident" id="1393183">nil</span><br>
<span class="lineno"></span><span class="op" id="1393187">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="1393190">func</span>&nbsp;<span class="op" id="1393195">(</span><span class="ident" id="1393196">fd</span>&nbsp;<span class="op" id="1393199">*</span><span class="ident" id="1393200"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1393205">)</span>&nbsp;<span class="ident" id="1393207">closeRead</span><span class="op" id="1393216">(</span><span class="op" id="1393217">)</span>&nbsp;<span class="builtintype" id="1393219">error</span>&nbsp;<span class="op" id="1393225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393228">return</span>&nbsp;<span class="ident" id="1393235"><a href="/net/fd_unix.go.html#1393196">fd</a></span><span class="op" id="1393237">.</span><span class="ident" id="1393238">shutdown</span><span class="op" id="1393246">(</span><span class="ident" id="1393247"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1393254">.</span><span class="ident" id="1393255">SHUT_RD</span><span class="op" id="1393262">)</span><br>
<span class="lineno"></span><span class="op" id="1393264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="1393267">func</span>&nbsp;<span class="op" id="1393272">(</span><span class="ident" id="1393273">fd</span>&nbsp;<span class="op" id="1393276">*</span><span class="ident" id="1393277"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1393282">)</span>&nbsp;<span class="ident" id="1393284">closeWrite</span><span class="op" id="1393294">(</span><span class="op" id="1393295">)</span>&nbsp;<span class="builtintype" id="1393297">error</span>&nbsp;<span class="op" id="1393303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393306">return</span>&nbsp;<span class="ident" id="1393313"><a href="/net/fd_unix.go.html#1393273">fd</a></span><span class="op" id="1393315">.</span><span class="ident" id="1393316">shutdown</span><span class="op" id="1393324">(</span><span class="ident" id="1393325"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1393332">.</span><span class="ident" id="1393333">SHUT_WR</span><span class="op" id="1393340">)</span><br>
<span class="lineno"></span><span class="op" id="1393342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1393345">func</span>&nbsp;<span class="op" id="1393350">(</span><span class="ident" id="1393351">fd</span>&nbsp;<span class="op" id="1393354">*</span><span class="ident" id="1393355"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1393360">)</span>&nbsp;<span class="ident" id="1393362">Read</span><span class="op" id="1393366">(</span><span class="ident" id="1393367">p</span>&nbsp;<span class="op" id="1393369">[</span><span class="op" id="1393370">]</span><span class="builtintype" id="1393371">byte</span><span class="op" id="1393375">)</span>&nbsp;<span class="op" id="1393377">(</span><span class="ident" id="1393378">n</span>&nbsp;<span class="builtintype" id="1393380">int</span><span class="op" id="1393383">,</span>&nbsp;<span class="ident" id="1393385">err</span>&nbsp;<span class="builtintype" id="1393389">error</span><span class="op" id="1393394">)</span>&nbsp;<span class="op" id="1393396">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393399">if</span>&nbsp;<span class="ident" id="1393402">err</span>&nbsp;<span class="op" id="1393406">:=</span>&nbsp;<span class="ident" id="1393409"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393411">.</span><span class="ident" id="1393412">readLock</span><span class="op" id="1393420">(</span><span class="op" id="1393421">)</span><span class="op" id="1393422">;</span>&nbsp;<span class="ident" id="1393424"><a href="/net/fd_unix.go.html#1393402">err</a></span>&nbsp;<span class="op" id="1393428">!=</span>&nbsp;<span class="ident" id="1393431">nil</span>&nbsp;<span class="op" id="1393435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393439">return</span>&nbsp;<span class="num" id="1393446">0</span><span class="op" id="1393447">,</span>&nbsp;<span class="ident" id="1393449"><a href="/net/fd_unix.go.html#1393402">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393457">defer</span>&nbsp;<span class="ident" id="1393463"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393465">.</span><span class="ident" id="1393466">readUnlock</span><span class="op" id="1393476">(</span><span class="op" id="1393477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393480">if</span>&nbsp;<span class="ident" id="1393483">err</span>&nbsp;<span class="op" id="1393487">:=</span>&nbsp;<span class="ident" id="1393490"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393492">.</span><span class="ident" id="1393493">pd</span><span class="op" id="1393495">.</span><span class="ident" id="1393496">PrepareRead</span><span class="op" id="1393507">(</span><span class="op" id="1393508">)</span><span class="op" id="1393509">;</span>&nbsp;<span class="ident" id="1393511"><a href="/net/fd_unix.go.html#1393483">err</a></span>&nbsp;<span class="op" id="1393515">!=</span>&nbsp;<span class="ident" id="1393518">nil</span>&nbsp;<span class="op" id="1393522">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393526">return</span>&nbsp;<span class="num" id="1393533">0</span><span class="op" id="1393534">,</span>&nbsp;<span class="op" id="1393536">&amp;</span><span class="ident" id="1393537"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1393544">{</span><span class="string" id="1393545">&#34;read&#34;</span><span class="op" id="1393551">,</span>&nbsp;<span class="ident" id="1393553"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393555">.</span><span class="ident" id="1393556">net</span><span class="op" id="1393559">,</span>&nbsp;<span class="ident" id="1393561"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393563">.</span><span class="ident" id="1393564">raddr</span><span class="op" id="1393569">,</span>&nbsp;<span class="ident" id="1393571"><a href="/net/fd_unix.go.html#1393483">err</a></span><span class="op" id="1393574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393580">for</span>&nbsp;<span class="op" id="1393584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1393588"><a href="/net/fd_unix.go.html#1393378">n</a></span><span class="op" id="1393589">,</span>&nbsp;<span class="ident" id="1393591"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393595">=</span>&nbsp;<span class="ident" id="1393597"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1393604">.</span><span class="ident" id="1393605">Read</span><span class="op" id="1393609">(</span><span class="builtintype" id="1393610">int</span><span class="op" id="1393613">(</span><span class="ident" id="1393614"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393616">.</span><span class="ident" id="1393617">sysfd</span><span class="op" id="1393622">)</span><span class="op" id="1393623">,</span>&nbsp;<span class="ident" id="1393625"><a href="/net/fd_unix.go.html#1393367">p</a></span><span class="op" id="1393626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393630">if</span>&nbsp;<span class="ident" id="1393633"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393637">!=</span>&nbsp;<span class="ident" id="1393640">nil</span>&nbsp;<span class="op" id="1393644">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1393649"><a href="/net/fd_unix.go.html#1393378">n</a></span>&nbsp;<span class="op" id="1393651">=</span>&nbsp;<span class="num" id="1393653">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393658">if</span>&nbsp;<span class="ident" id="1393661"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393665">==</span>&nbsp;<span class="ident" id="1393668"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1393675">.</span><span class="ident" id="1393676">EAGAIN</span>&nbsp;<span class="op" id="1393683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393689">if</span>&nbsp;<span class="ident" id="1393692"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393696">=</span>&nbsp;<span class="ident" id="1393698"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393700">.</span><span class="ident" id="1393701">pd</span><span class="op" id="1393703">.</span><span class="ident" id="1393704">WaitRead</span><span class="op" id="1393712">(</span><span class="op" id="1393713">)</span><span class="op" id="1393714">;</span>&nbsp;<span class="ident" id="1393716"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393720">==</span>&nbsp;<span class="ident" id="1393723">nil</span>&nbsp;<span class="op" id="1393727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393734">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393747">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1393760"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393764">=</span>&nbsp;<span class="ident" id="1393766"><a href="/net/fd_unix.go.html#1395175">chkReadErr</a></span><span class="op" id="1393776">(</span><span class="ident" id="1393777"><a href="/net/fd_unix.go.html#1393378">n</a></span><span class="op" id="1393778">,</span>&nbsp;<span class="ident" id="1393780"><a href="/net/fd_unix.go.html#1393385">err</a></span><span class="op" id="1393783">,</span>&nbsp;<span class="ident" id="1393785"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393791">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393798">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393801">if</span>&nbsp;<span class="ident" id="1393804"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393808">!=</span>&nbsp;<span class="ident" id="1393811">nil</span>&nbsp;<span class="op" id="1393815">&amp;&amp;</span>&nbsp;<span class="ident" id="1393818"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393822">!=</span>&nbsp;<span class="ident" id="1393825"><a href="/net/fd_unix.go.html#1388187">io</a></span><span class="op" id="1393827">.</span><span class="ident" id="1393828">EOF</span>&nbsp;<span class="op" id="1393832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1393836"><a href="/net/fd_unix.go.html#1393385">err</a></span>&nbsp;<span class="op" id="1393840">=</span>&nbsp;<span class="op" id="1393842">&amp;</span><span class="ident" id="1393843"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1393850">{</span><span class="string" id="1393851">&#34;read&#34;</span><span class="op" id="1393857">,</span>&nbsp;<span class="ident" id="1393859"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393861">.</span><span class="ident" id="1393862">net</span><span class="op" id="1393865">,</span>&nbsp;<span class="ident" id="1393867"><a href="/net/fd_unix.go.html#1393351">fd</a></span><span class="op" id="1393869">.</span><span class="ident" id="1393870">raddr</span><span class="op" id="1393875">,</span>&nbsp;<span class="ident" id="1393877"><a href="/net/fd_unix.go.html#1393385">err</a></span><span class="op" id="1393880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1393883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393886">return</span><br>
<span class="lineno"></span><span class="op" id="1393893">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="1393896">func</span>&nbsp;<span class="op" id="1393901">(</span><span class="ident" id="1393902">fd</span>&nbsp;<span class="op" id="1393905">*</span><span class="ident" id="1393906"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1393911">)</span>&nbsp;<span class="ident" id="1393913">readFrom</span><span class="op" id="1393921">(</span><span class="ident" id="1393922">p</span>&nbsp;<span class="op" id="1393924">[</span><span class="op" id="1393925">]</span><span class="builtintype" id="1393926">byte</span><span class="op" id="1393930">)</span>&nbsp;<span class="op" id="1393932">(</span><span class="ident" id="1393933">n</span>&nbsp;<span class="builtintype" id="1393935">int</span><span class="op" id="1393938">,</span>&nbsp;<span class="ident" id="1393940">sa</span>&nbsp;<span class="ident" id="1393943"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1393950">.</span><span class="ident" id="1393951">Sockaddr</span><span class="op" id="1393959">,</span>&nbsp;<span class="ident" id="1393961">err</span>&nbsp;<span class="builtintype" id="1393965">error</span><span class="op" id="1393970">)</span>&nbsp;<span class="op" id="1393972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1393975">if</span>&nbsp;<span class="ident" id="1393978">err</span>&nbsp;<span class="op" id="1393982">:=</span>&nbsp;<span class="ident" id="1393985"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1393987">.</span><span class="ident" id="1393988">readLock</span><span class="op" id="1393996">(</span><span class="op" id="1393997">)</span><span class="op" id="1393998">;</span>&nbsp;<span class="ident" id="1394000"><a href="/net/fd_unix.go.html#1393978">err</a></span>&nbsp;<span class="op" id="1394004">!=</span>&nbsp;<span class="ident" id="1394007">nil</span>&nbsp;<span class="op" id="1394011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394015">return</span>&nbsp;<span class="num" id="1394022">0</span><span class="op" id="1394023">,</span>&nbsp;<span class="ident" id="1394025">nil</span><span class="op" id="1394028">,</span>&nbsp;<span class="ident" id="1394030"><a href="/net/fd_unix.go.html#1393978">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394035">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394038">defer</span>&nbsp;<span class="ident" id="1394044"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394046">.</span><span class="ident" id="1394047">readUnlock</span><span class="op" id="1394057">(</span><span class="op" id="1394058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394061">if</span>&nbsp;<span class="ident" id="1394064">err</span>&nbsp;<span class="op" id="1394068">:=</span>&nbsp;<span class="ident" id="1394071"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394073">.</span><span class="ident" id="1394074">pd</span><span class="op" id="1394076">.</span><span class="ident" id="1394077">PrepareRead</span><span class="op" id="1394088">(</span><span class="op" id="1394089">)</span><span class="op" id="1394090">;</span>&nbsp;<span class="ident" id="1394092"><a href="/net/fd_unix.go.html#1394064">err</a></span>&nbsp;<span class="op" id="1394096">!=</span>&nbsp;<span class="ident" id="1394099">nil</span>&nbsp;<span class="op" id="1394103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394107">return</span>&nbsp;<span class="num" id="1394114">0</span><span class="op" id="1394115">,</span>&nbsp;<span class="ident" id="1394117">nil</span><span class="op" id="1394120">,</span>&nbsp;<span class="op" id="1394122">&amp;</span><span class="ident" id="1394123"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1394130">{</span><span class="string" id="1394131">&#34;read&#34;</span><span class="op" id="1394137">,</span>&nbsp;<span class="ident" id="1394139"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394141">.</span><span class="ident" id="1394142">net</span><span class="op" id="1394145">,</span>&nbsp;<span class="ident" id="1394147"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394149">.</span><span class="ident" id="1394150">laddr</span><span class="op" id="1394155">,</span>&nbsp;<span class="ident" id="1394157"><a href="/net/fd_unix.go.html#1394064">err</a></span><span class="op" id="1394160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394166">for</span>&nbsp;<span class="op" id="1394170">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1394174"><a href="/net/fd_unix.go.html#1393933">n</a></span><span class="op" id="1394175">,</span>&nbsp;<span class="ident" id="1394177"><a href="/net/fd_unix.go.html#1393940">sa</a></span><span class="op" id="1394179">,</span>&nbsp;<span class="ident" id="1394181"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394185">=</span>&nbsp;<span class="ident" id="1394187"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1394194">.</span><span class="ident" id="1394195">Recvfrom</span><span class="op" id="1394203">(</span><span class="ident" id="1394204"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394206">.</span><span class="ident" id="1394207">sysfd</span><span class="op" id="1394212">,</span>&nbsp;<span class="ident" id="1394214"><a href="/net/fd_unix.go.html#1393922">p</a></span><span class="op" id="1394215">,</span>&nbsp;<span class="num" id="1394217">0</span><span class="op" id="1394218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394222">if</span>&nbsp;<span class="ident" id="1394225"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394229">!=</span>&nbsp;<span class="ident" id="1394232">nil</span>&nbsp;<span class="op" id="1394236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1394241"><a href="/net/fd_unix.go.html#1393933">n</a></span>&nbsp;<span class="op" id="1394243">=</span>&nbsp;<span class="num" id="1394245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394250">if</span>&nbsp;<span class="ident" id="1394253"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394257">==</span>&nbsp;<span class="ident" id="1394260"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1394267">.</span><span class="ident" id="1394268">EAGAIN</span>&nbsp;<span class="op" id="1394275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394281">if</span>&nbsp;<span class="ident" id="1394284"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394288">=</span>&nbsp;<span class="ident" id="1394290"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394292">.</span><span class="ident" id="1394293">pd</span><span class="op" id="1394295">.</span><span class="ident" id="1394296">WaitRead</span><span class="op" id="1394304">(</span><span class="op" id="1394305">)</span><span class="op" id="1394306">;</span>&nbsp;<span class="ident" id="1394308"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394312">==</span>&nbsp;<span class="ident" id="1394315">nil</span>&nbsp;<span class="op" id="1394319">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394326">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1394352"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394356">=</span>&nbsp;<span class="ident" id="1394358"><a href="/net/fd_unix.go.html#1395175">chkReadErr</a></span><span class="op" id="1394368">(</span><span class="ident" id="1394369"><a href="/net/fd_unix.go.html#1393933">n</a></span><span class="op" id="1394370">,</span>&nbsp;<span class="ident" id="1394372"><a href="/net/fd_unix.go.html#1393961">err</a></span><span class="op" id="1394375">,</span>&nbsp;<span class="ident" id="1394377"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394379">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394383">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394393">if</span>&nbsp;<span class="ident" id="1394396"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394400">!=</span>&nbsp;<span class="ident" id="1394403">nil</span>&nbsp;<span class="op" id="1394407">&amp;&amp;</span>&nbsp;<span class="ident" id="1394410"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394414">!=</span>&nbsp;<span class="ident" id="1394417"><a href="/net/fd_unix.go.html#1388187">io</a></span><span class="op" id="1394419">.</span><span class="ident" id="1394420">EOF</span>&nbsp;<span class="op" id="1394424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1394428"><a href="/net/fd_unix.go.html#1393961">err</a></span>&nbsp;<span class="op" id="1394432">=</span>&nbsp;<span class="op" id="1394434">&amp;</span><span class="ident" id="1394435"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1394442">{</span><span class="string" id="1394443">&#34;read&#34;</span><span class="op" id="1394449">,</span>&nbsp;<span class="ident" id="1394451"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394453">.</span><span class="ident" id="1394454">net</span><span class="op" id="1394457">,</span>&nbsp;<span class="ident" id="1394459"><a href="/net/fd_unix.go.html#1393902">fd</a></span><span class="op" id="1394461">.</span><span class="ident" id="1394462">laddr</span><span class="op" id="1394467">,</span>&nbsp;<span class="ident" id="1394469"><a href="/net/fd_unix.go.html#1393961">err</a></span><span class="op" id="1394472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394475">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394478">return</span><br>
<span class="lineno"></span><span class="op" id="1394485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1394488">func</span>&nbsp;<span class="op" id="1394493">(</span><span class="ident" id="1394494">fd</span>&nbsp;<span class="op" id="1394497">*</span><span class="ident" id="1394498"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1394503">)</span>&nbsp;<span class="ident" id="1394505">readMsg</span><span class="op" id="1394512">(</span><span class="ident" id="1394513">p</span>&nbsp;<span class="op" id="1394515">[</span><span class="op" id="1394516">]</span><span class="builtintype" id="1394517">byte</span><span class="op" id="1394521">,</span>&nbsp;<span class="ident" id="1394523">oob</span>&nbsp;<span class="op" id="1394527">[</span><span class="op" id="1394528">]</span><span class="builtintype" id="1394529">byte</span><span class="op" id="1394533">)</span>&nbsp;<span class="op" id="1394535">(</span><span class="ident" id="1394536">n</span><span class="op" id="1394537">,</span>&nbsp;<span class="ident" id="1394539">oobn</span><span class="op" id="1394543">,</span>&nbsp;<span class="ident" id="1394545">flags</span>&nbsp;<span class="builtintype" id="1394551">int</span><span class="op" id="1394554">,</span>&nbsp;<span class="ident" id="1394556">sa</span>&nbsp;<span class="ident" id="1394559"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1394566">.</span><span class="ident" id="1394567">Sockaddr</span><span class="op" id="1394575">,</span>&nbsp;<span class="ident" id="1394577">err</span>&nbsp;<span class="builtintype" id="1394581">error</span><span class="op" id="1394586">)</span>&nbsp;<span class="op" id="1394588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394591">if</span>&nbsp;<span class="ident" id="1394594">err</span>&nbsp;<span class="op" id="1394598">:=</span>&nbsp;<span class="ident" id="1394601"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394603">.</span><span class="ident" id="1394604">readLock</span><span class="op" id="1394612">(</span><span class="op" id="1394613">)</span><span class="op" id="1394614">;</span>&nbsp;<span class="ident" id="1394616"><a href="/net/fd_unix.go.html#1394594">err</a></span>&nbsp;<span class="op" id="1394620">!=</span>&nbsp;<span class="ident" id="1394623">nil</span>&nbsp;<span class="op" id="1394627">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394631">return</span>&nbsp;<span class="num" id="1394638">0</span><span class="op" id="1394639">,</span>&nbsp;<span class="num" id="1394641">0</span><span class="op" id="1394642">,</span>&nbsp;<span class="num" id="1394644">0</span><span class="op" id="1394645">,</span>&nbsp;<span class="ident" id="1394647">nil</span><span class="op" id="1394650">,</span>&nbsp;<span class="ident" id="1394652"><a href="/net/fd_unix.go.html#1394594">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394660">defer</span>&nbsp;<span class="ident" id="1394666"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394668">.</span><span class="ident" id="1394669">readUnlock</span><span class="op" id="1394679">(</span><span class="op" id="1394680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394683">if</span>&nbsp;<span class="ident" id="1394686">err</span>&nbsp;<span class="op" id="1394690">:=</span>&nbsp;<span class="ident" id="1394693"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394695">.</span><span class="ident" id="1394696">pd</span><span class="op" id="1394698">.</span><span class="ident" id="1394699">PrepareRead</span><span class="op" id="1394710">(</span><span class="op" id="1394711">)</span><span class="op" id="1394712">;</span>&nbsp;<span class="ident" id="1394714"><a href="/net/fd_unix.go.html#1394686">err</a></span>&nbsp;<span class="op" id="1394718">!=</span>&nbsp;<span class="ident" id="1394721">nil</span>&nbsp;<span class="op" id="1394725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394729">return</span>&nbsp;<span class="num" id="1394736">0</span><span class="op" id="1394737">,</span>&nbsp;<span class="num" id="1394739">0</span><span class="op" id="1394740">,</span>&nbsp;<span class="num" id="1394742">0</span><span class="op" id="1394743">,</span>&nbsp;<span class="ident" id="1394745">nil</span><span class="op" id="1394748">,</span>&nbsp;<span class="op" id="1394750">&amp;</span><span class="ident" id="1394751"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1394758">{</span><span class="string" id="1394759">&#34;read&#34;</span><span class="op" id="1394765">,</span>&nbsp;<span class="ident" id="1394767"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394769">.</span><span class="ident" id="1394770">net</span><span class="op" id="1394773">,</span>&nbsp;<span class="ident" id="1394775"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394777">.</span><span class="ident" id="1394778">laddr</span><span class="op" id="1394783">,</span>&nbsp;<span class="ident" id="1394785"><a href="/net/fd_unix.go.html#1394686">err</a></span><span class="op" id="1394788">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1394791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394794">for</span>&nbsp;<span class="op" id="1394798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1394802"><a href="/net/fd_unix.go.html#1394536">n</a></span><span class="op" id="1394803">,</span>&nbsp;<span class="ident" id="1394805"><a href="/net/fd_unix.go.html#1394539">oobn</a></span><span class="op" id="1394809">,</span>&nbsp;<span class="ident" id="1394811"><a href="/net/fd_unix.go.html#1394545">flags</a></span><span class="op" id="1394816">,</span>&nbsp;<span class="ident" id="1394818"><a href="/net/fd_unix.go.html#1394556">sa</a></span><span class="op" id="1394820">,</span>&nbsp;<span class="ident" id="1394822"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1394826">=</span>&nbsp;<span class="ident" id="1394828"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1394835">.</span><span class="ident" id="1394836">Recvmsg</span><span class="op" id="1394843">(</span><span class="ident" id="1394844"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394846">.</span><span class="ident" id="1394847">sysfd</span><span class="op" id="1394852">,</span>&nbsp;<span class="ident" id="1394854"><a href="/net/fd_unix.go.html#1394513">p</a></span><span class="op" id="1394855">,</span>&nbsp;<span class="ident" id="1394857"><a href="/net/fd_unix.go.html#1394523">oob</a></span><span class="op" id="1394860">,</span>&nbsp;<span class="num" id="1394862">0</span><span class="op" id="1394863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394867">if</span>&nbsp;<span class="ident" id="1394870"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1394874">!=</span>&nbsp;<span class="ident" id="1394877">nil</span>&nbsp;<span class="op" id="1394881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1394886">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394932">if</span>&nbsp;<span class="ident" id="1394935"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1394939">==</span>&nbsp;<span class="ident" id="1394942"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1394949">.</span><span class="ident" id="1394950">EAGAIN</span>&nbsp;<span class="op" id="1394957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1394963">if</span>&nbsp;<span class="ident" id="1394966"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1394970">=</span>&nbsp;<span class="ident" id="1394972"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1394974">.</span><span class="ident" id="1394975">pd</span><span class="op" id="1394977">.</span><span class="ident" id="1394978">WaitRead</span><span class="op" id="1394986">(</span><span class="op" id="1394987">)</span><span class="op" id="1394988">;</span>&nbsp;<span class="ident" id="1394990"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1394994">==</span>&nbsp;<span class="ident" id="1394997">nil</span>&nbsp;<span class="op" id="1395001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395008">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395026">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395034"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1395038">=</span>&nbsp;<span class="ident" id="1395040"><a href="/net/fd_unix.go.html#1395175">chkReadErr</a></span><span class="op" id="1395050">(</span><span class="ident" id="1395051"><a href="/net/fd_unix.go.html#1394536">n</a></span><span class="op" id="1395052">,</span>&nbsp;<span class="ident" id="1395054"><a href="/net/fd_unix.go.html#1394577">err</a></span><span class="op" id="1395057">,</span>&nbsp;<span class="ident" id="1395059"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1395061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395065">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395075">if</span>&nbsp;<span class="ident" id="1395078"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1395082">!=</span>&nbsp;<span class="ident" id="1395085">nil</span>&nbsp;<span class="op" id="1395089">&amp;&amp;</span>&nbsp;<span class="ident" id="1395092"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1395096">!=</span>&nbsp;<span class="ident" id="1395099"><a href="/net/fd_unix.go.html#1388187">io</a></span><span class="op" id="1395101">.</span><span class="ident" id="1395102">EOF</span>&nbsp;<span class="op" id="1395106">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395110"><a href="/net/fd_unix.go.html#1394577">err</a></span>&nbsp;<span class="op" id="1395114">=</span>&nbsp;<span class="op" id="1395116">&amp;</span><span class="ident" id="1395117"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1395124">{</span><span class="string" id="1395125">&#34;read&#34;</span><span class="op" id="1395131">,</span>&nbsp;<span class="ident" id="1395133"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1395135">.</span><span class="ident" id="1395136">net</span><span class="op" id="1395139">,</span>&nbsp;<span class="ident" id="1395141"><a href="/net/fd_unix.go.html#1394494">fd</a></span><span class="op" id="1395143">.</span><span class="ident" id="1395144">laddr</span><span class="op" id="1395149">,</span>&nbsp;<span class="ident" id="1395151"><a href="/net/fd_unix.go.html#1394577">err</a></span><span class="op" id="1395154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395160">return</span><br>
<span class="lineno"></span><span class="op" id="1395167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="1395170">func</span>&nbsp;<span class="ident" id="1395175">chkReadErr</span><span class="op" id="1395185">(</span><span class="ident" id="1395186">n</span>&nbsp;<span class="builtintype" id="1395188">int</span><span class="op" id="1395191">,</span>&nbsp;<span class="ident" id="1395193">err</span>&nbsp;<span class="builtintype" id="1395197">error</span><span class="op" id="1395202">,</span>&nbsp;<span class="ident" id="1395204">fd</span>&nbsp;<span class="op" id="1395207">*</span><span class="ident" id="1395208"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1395213">)</span>&nbsp;<span class="builtintype" id="1395215">error</span>&nbsp;<span class="op" id="1395221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395224">if</span>&nbsp;<span class="ident" id="1395227"><a href="/net/fd_unix.go.html#1395186">n</a></span>&nbsp;<span class="op" id="1395229">==</span>&nbsp;<span class="num" id="1395232">0</span>&nbsp;<span class="op" id="1395234">&amp;&amp;</span>&nbsp;<span class="ident" id="1395237"><a href="/net/fd_unix.go.html#1395193">err</a></span>&nbsp;<span class="op" id="1395241">==</span>&nbsp;<span class="ident" id="1395244">nil</span>&nbsp;<span class="op" id="1395248">&amp;&amp;</span>&nbsp;<span class="ident" id="1395251"><a href="/net/fd_unix.go.html#1395204">fd</a></span><span class="op" id="1395253">.</span><span class="ident" id="1395254">sotype</span>&nbsp;<span class="op" id="1395261">!=</span>&nbsp;<span class="ident" id="1395264"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1395271">.</span><span class="ident" id="1395272">SOCK_DGRAM</span>&nbsp;<span class="op" id="1395283">&amp;&amp;</span>&nbsp;<span class="ident" id="1395286"><a href="/net/fd_unix.go.html#1395204">fd</a></span><span class="op" id="1395288">.</span><span class="ident" id="1395289">sotype</span>&nbsp;<span class="op" id="1395296">!=</span>&nbsp;<span class="ident" id="1395299"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1395306">.</span><span class="ident" id="1395307">SOCK_RAW</span>&nbsp;<span class="op" id="1395316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395320">return</span>&nbsp;<span class="ident" id="1395327"><a href="/net/fd_unix.go.html#1388187">io</a></span><span class="op" id="1395329">.</span><span class="ident" id="1395330">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395338">return</span>&nbsp;<span class="ident" id="1395345"><a href="/net/fd_unix.go.html#1395193">err</a></span><br>
<span class="lineno">315</span><span class="op" id="1395349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1395352">func</span>&nbsp;<span class="op" id="1395357">(</span><span class="ident" id="1395358">fd</span>&nbsp;<span class="op" id="1395361">*</span><span class="ident" id="1395362"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1395367">)</span>&nbsp;<span class="ident" id="1395369">Write</span><span class="op" id="1395374">(</span><span class="ident" id="1395375">p</span>&nbsp;<span class="op" id="1395377">[</span><span class="op" id="1395378">]</span><span class="builtintype" id="1395379">byte</span><span class="op" id="1395383">)</span>&nbsp;<span class="op" id="1395385">(</span><span class="ident" id="1395386">nn</span>&nbsp;<span class="builtintype" id="1395389">int</span><span class="op" id="1395392">,</span>&nbsp;<span class="ident" id="1395394">err</span>&nbsp;<span class="builtintype" id="1395398">error</span><span class="op" id="1395403">)</span>&nbsp;<span class="op" id="1395405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395408">if</span>&nbsp;<span class="ident" id="1395411">err</span>&nbsp;<span class="op" id="1395415">:=</span>&nbsp;<span class="ident" id="1395418"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395420">.</span><span class="ident" id="1395421">writeLock</span><span class="op" id="1395430">(</span><span class="op" id="1395431">)</span><span class="op" id="1395432">;</span>&nbsp;<span class="ident" id="1395434"><a href="/net/fd_unix.go.html#1395411">err</a></span>&nbsp;<span class="op" id="1395438">!=</span>&nbsp;<span class="ident" id="1395441">nil</span>&nbsp;<span class="op" id="1395445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395449">return</span>&nbsp;<span class="num" id="1395456">0</span><span class="op" id="1395457">,</span>&nbsp;<span class="ident" id="1395459"><a href="/net/fd_unix.go.html#1395411">err</a></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395467">defer</span>&nbsp;<span class="ident" id="1395473"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395475">.</span><span class="ident" id="1395476">writeUnlock</span><span class="op" id="1395487">(</span><span class="op" id="1395488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395491">if</span>&nbsp;<span class="ident" id="1395494">err</span>&nbsp;<span class="op" id="1395498">:=</span>&nbsp;<span class="ident" id="1395501"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395503">.</span><span class="ident" id="1395504">pd</span><span class="op" id="1395506">.</span><span class="ident" id="1395507">PrepareWrite</span><span class="op" id="1395519">(</span><span class="op" id="1395520">)</span><span class="op" id="1395521">;</span>&nbsp;<span class="ident" id="1395523"><a href="/net/fd_unix.go.html#1395494">err</a></span>&nbsp;<span class="op" id="1395527">!=</span>&nbsp;<span class="ident" id="1395530">nil</span>&nbsp;<span class="op" id="1395534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395538">return</span>&nbsp;<span class="num" id="1395545">0</span><span class="op" id="1395546">,</span>&nbsp;<span class="op" id="1395548">&amp;</span><span class="ident" id="1395549"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1395556">{</span><span class="string" id="1395557">&#34;write&#34;</span><span class="op" id="1395564">,</span>&nbsp;<span class="ident" id="1395566"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395568">.</span><span class="ident" id="1395569">net</span><span class="op" id="1395572">,</span>&nbsp;<span class="ident" id="1395574"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395576">.</span><span class="ident" id="1395577">raddr</span><span class="op" id="1395582">,</span>&nbsp;<span class="ident" id="1395584"><a href="/net/fd_unix.go.html#1395494">err</a></span><span class="op" id="1395587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395590">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395593">for</span>&nbsp;<span class="op" id="1395597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395601">var</span>&nbsp;<span class="ident" id="1395605">n</span>&nbsp;<span class="builtintype" id="1395607">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395613"><a href="/net/fd_unix.go.html#1395605">n</a></span><span class="op" id="1395614">,</span>&nbsp;<span class="ident" id="1395616"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395620">=</span>&nbsp;<span class="ident" id="1395622"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1395629">.</span><span class="ident" id="1395630">Write</span><span class="op" id="1395635">(</span><span class="builtintype" id="1395636">int</span><span class="op" id="1395639">(</span><span class="ident" id="1395640"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395642">.</span><span class="ident" id="1395643">sysfd</span><span class="op" id="1395648">)</span><span class="op" id="1395649">,</span>&nbsp;<span class="ident" id="1395651"><a href="/net/fd_unix.go.html#1395375">p</a></span><span class="op" id="1395652">[</span><span class="ident" id="1395653"><a href="/net/fd_unix.go.html#1395386">nn</a></span><span class="op" id="1395655">:</span><span class="op" id="1395656">]</span><span class="op" id="1395657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395661">if</span>&nbsp;<span class="ident" id="1395664"><a href="/net/fd_unix.go.html#1395605">n</a></span>&nbsp;<span class="op" id="1395666">&gt;</span>&nbsp;<span class="num" id="1395668">0</span>&nbsp;<span class="op" id="1395670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395675"><a href="/net/fd_unix.go.html#1395386">nn</a></span>&nbsp;<span class="op" id="1395678">+=</span>&nbsp;<span class="ident" id="1395681"><a href="/net/fd_unix.go.html#1395605">n</a></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395689">if</span>&nbsp;<span class="ident" id="1395692"><a href="/net/fd_unix.go.html#1395386">nn</a></span>&nbsp;<span class="op" id="1395695">==</span>&nbsp;<span class="builtinfunc" id="1395698">len</span><span class="op" id="1395701">(</span><span class="ident" id="1395702"><a href="/net/fd_unix.go.html#1395375">p</a></span><span class="op" id="1395703">)</span>&nbsp;<span class="op" id="1395705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395710">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395722">if</span>&nbsp;<span class="ident" id="1395725"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395729">==</span>&nbsp;<span class="ident" id="1395732"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1395739">.</span><span class="ident" id="1395740">EAGAIN</span>&nbsp;<span class="op" id="1395747">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395752">if</span>&nbsp;<span class="ident" id="1395755"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395759">=</span>&nbsp;<span class="ident" id="1395761"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395763">.</span><span class="ident" id="1395764">pd</span><span class="op" id="1395766">.</span><span class="ident" id="1395767">WaitWrite</span><span class="op" id="1395776">(</span><span class="op" id="1395777">)</span><span class="op" id="1395778">;</span>&nbsp;<span class="ident" id="1395780"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395784">==</span>&nbsp;<span class="ident" id="1395787">nil</span>&nbsp;<span class="op" id="1395791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395797">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395817">if</span>&nbsp;<span class="ident" id="1395820"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395824">!=</span>&nbsp;<span class="ident" id="1395827">nil</span>&nbsp;<span class="op" id="1395831">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395836"><a href="/net/fd_unix.go.html#1395605">n</a></span>&nbsp;<span class="op" id="1395838">=</span>&nbsp;<span class="num" id="1395840">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395845">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395857">if</span>&nbsp;<span class="ident" id="1395860"><a href="/net/fd_unix.go.html#1395605">n</a></span>&nbsp;<span class="op" id="1395862">==</span>&nbsp;<span class="num" id="1395865">0</span>&nbsp;<span class="op" id="1395867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395872"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395876">=</span>&nbsp;<span class="ident" id="1395878"><a href="/net/fd_unix.go.html#1388187">io</a></span><span class="op" id="1395880">.</span><span class="ident" id="1395881">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395901">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395915">if</span>&nbsp;<span class="ident" id="1395918"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395922">!=</span>&nbsp;<span class="ident" id="1395925">nil</span>&nbsp;<span class="op" id="1395929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395933"><a href="/net/fd_unix.go.html#1395394">err</a></span>&nbsp;<span class="op" id="1395937">=</span>&nbsp;<span class="op" id="1395939">&amp;</span><span class="ident" id="1395940"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1395947">{</span><span class="string" id="1395948">&#34;write&#34;</span><span class="op" id="1395955">,</span>&nbsp;<span class="ident" id="1395957"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395959">.</span><span class="ident" id="1395960">net</span><span class="op" id="1395963">,</span>&nbsp;<span class="ident" id="1395965"><a href="/net/fd_unix.go.html#1395358">fd</a></span><span class="op" id="1395967">.</span><span class="ident" id="1395968">raddr</span><span class="op" id="1395973">,</span>&nbsp;<span class="ident" id="1395975"><a href="/net/fd_unix.go.html#1395394">err</a></span><span class="op" id="1395978">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1395981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395984">return</span>&nbsp;<span class="ident" id="1395991"><a href="/net/fd_unix.go.html#1395386">nn</a></span><span class="op" id="1395993">,</span>&nbsp;<span class="ident" id="1395995"><a href="/net/fd_unix.go.html#1395394">err</a></span><br>
<span class="lineno"></span><span class="op" id="1395999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1396002">func</span>&nbsp;<span class="op" id="1396007">(</span><span class="ident" id="1396008">fd</span>&nbsp;<span class="op" id="1396011">*</span><span class="ident" id="1396012"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1396017">)</span>&nbsp;<span class="ident" id="1396019">writeTo</span><span class="op" id="1396026">(</span><span class="ident" id="1396027">p</span>&nbsp;<span class="op" id="1396029">[</span><span class="op" id="1396030">]</span><span class="builtintype" id="1396031">byte</span><span class="op" id="1396035">,</span>&nbsp;<span class="ident" id="1396037">sa</span>&nbsp;<span class="ident" id="1396040"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1396047">.</span><span class="ident" id="1396048">Sockaddr</span><span class="op" id="1396056">)</span>&nbsp;<span class="op" id="1396058">(</span><span class="ident" id="1396059">n</span>&nbsp;<span class="builtintype" id="1396061">int</span><span class="op" id="1396064">,</span>&nbsp;<span class="ident" id="1396066">err</span>&nbsp;<span class="builtintype" id="1396070">error</span><span class="op" id="1396075">)</span>&nbsp;<span class="op" id="1396077">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396080">if</span>&nbsp;<span class="ident" id="1396083">err</span>&nbsp;<span class="op" id="1396087">:=</span>&nbsp;<span class="ident" id="1396090"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396092">.</span><span class="ident" id="1396093">writeLock</span><span class="op" id="1396102">(</span><span class="op" id="1396103">)</span><span class="op" id="1396104">;</span>&nbsp;<span class="ident" id="1396106"><a href="/net/fd_unix.go.html#1396083">err</a></span>&nbsp;<span class="op" id="1396110">!=</span>&nbsp;<span class="ident" id="1396113">nil</span>&nbsp;<span class="op" id="1396117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396121">return</span>&nbsp;<span class="num" id="1396128">0</span><span class="op" id="1396129">,</span>&nbsp;<span class="ident" id="1396131"><a href="/net/fd_unix.go.html#1396083">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396139">defer</span>&nbsp;<span class="ident" id="1396145"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396147">.</span><span class="ident" id="1396148">writeUnlock</span><span class="op" id="1396159">(</span><span class="op" id="1396160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396163">if</span>&nbsp;<span class="ident" id="1396166">err</span>&nbsp;<span class="op" id="1396170">:=</span>&nbsp;<span class="ident" id="1396173"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396175">.</span><span class="ident" id="1396176">pd</span><span class="op" id="1396178">.</span><span class="ident" id="1396179">PrepareWrite</span><span class="op" id="1396191">(</span><span class="op" id="1396192">)</span><span class="op" id="1396193">;</span>&nbsp;<span class="ident" id="1396195"><a href="/net/fd_unix.go.html#1396166">err</a></span>&nbsp;<span class="op" id="1396199">!=</span>&nbsp;<span class="ident" id="1396202">nil</span>&nbsp;<span class="op" id="1396206">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396210">return</span>&nbsp;<span class="num" id="1396217">0</span><span class="op" id="1396218">,</span>&nbsp;<span class="op" id="1396220">&amp;</span><span class="ident" id="1396221"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1396228">{</span><span class="string" id="1396229">&#34;write&#34;</span><span class="op" id="1396236">,</span>&nbsp;<span class="ident" id="1396238"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396240">.</span><span class="ident" id="1396241">net</span><span class="op" id="1396244">,</span>&nbsp;<span class="ident" id="1396246"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396248">.</span><span class="ident" id="1396249">raddr</span><span class="op" id="1396254">,</span>&nbsp;<span class="ident" id="1396256"><a href="/net/fd_unix.go.html#1396166">err</a></span><span class="op" id="1396259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396265">for</span>&nbsp;<span class="op" id="1396269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396273"><a href="/net/fd_unix.go.html#1396066">err</a></span>&nbsp;<span class="op" id="1396277">=</span>&nbsp;<span class="ident" id="1396279"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1396286">.</span><span class="ident" id="1396287">Sendto</span><span class="op" id="1396293">(</span><span class="ident" id="1396294"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396296">.</span><span class="ident" id="1396297">sysfd</span><span class="op" id="1396302">,</span>&nbsp;<span class="ident" id="1396304"><a href="/net/fd_unix.go.html#1396027">p</a></span><span class="op" id="1396305">,</span>&nbsp;<span class="num" id="1396307">0</span><span class="op" id="1396308">,</span>&nbsp;<span class="ident" id="1396310"><a href="/net/fd_unix.go.html#1396037">sa</a></span><span class="op" id="1396312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396316">if</span>&nbsp;<span class="ident" id="1396319"><a href="/net/fd_unix.go.html#1396066">err</a></span>&nbsp;<span class="op" id="1396323">==</span>&nbsp;<span class="ident" id="1396326"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1396333">.</span><span class="ident" id="1396334">EAGAIN</span>&nbsp;<span class="op" id="1396341">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396346">if</span>&nbsp;<span class="ident" id="1396349"><a href="/net/fd_unix.go.html#1396066">err</a></span>&nbsp;<span class="op" id="1396353">=</span>&nbsp;<span class="ident" id="1396355"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396357">.</span><span class="ident" id="1396358">pd</span><span class="op" id="1396360">.</span><span class="ident" id="1396361">WaitWrite</span><span class="op" id="1396370">(</span><span class="op" id="1396371">)</span><span class="op" id="1396372">;</span>&nbsp;<span class="ident" id="1396374"><a href="/net/fd_unix.go.html#1396066">err</a></span>&nbsp;<span class="op" id="1396378">==</span>&nbsp;<span class="ident" id="1396381">nil</span>&nbsp;<span class="op" id="1396385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396391">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396411">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396421">if</span>&nbsp;<span class="ident" id="1396424"><a href="/net/fd_unix.go.html#1396066">err</a></span>&nbsp;<span class="op" id="1396428">==</span>&nbsp;<span class="ident" id="1396431">nil</span>&nbsp;<span class="op" id="1396435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396439"><a href="/net/fd_unix.go.html#1396059">n</a></span>&nbsp;<span class="op" id="1396441">=</span>&nbsp;<span class="builtinfunc" id="1396443">len</span><span class="op" id="1396446">(</span><span class="ident" id="1396447"><a href="/net/fd_unix.go.html#1396027">p</a></span><span class="op" id="1396448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396451">}</span>&nbsp;<span class="keyword" id="1396453">else</span>&nbsp;<span class="op" id="1396458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396462"><a href="/net/fd_unix.go.html#1396066">err</a></span>&nbsp;<span class="op" id="1396466">=</span>&nbsp;<span class="op" id="1396468">&amp;</span><span class="ident" id="1396469"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1396476">{</span><span class="string" id="1396477">&#34;write&#34;</span><span class="op" id="1396484">,</span>&nbsp;<span class="ident" id="1396486"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396488">.</span><span class="ident" id="1396489">net</span><span class="op" id="1396492">,</span>&nbsp;<span class="ident" id="1396494"><a href="/net/fd_unix.go.html#1396008">fd</a></span><span class="op" id="1396496">.</span><span class="ident" id="1396497">raddr</span><span class="op" id="1396502">,</span>&nbsp;<span class="ident" id="1396504"><a href="/net/fd_unix.go.html#1396066">err</a></span><span class="op" id="1396507">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396513">return</span><br>
<span class="lineno"></span><span class="op" id="1396520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1396523">func</span>&nbsp;<span class="op" id="1396528">(</span><span class="ident" id="1396529">fd</span>&nbsp;<span class="op" id="1396532">*</span><span class="ident" id="1396533"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1396538">)</span>&nbsp;<span class="ident" id="1396540">writeMsg</span><span class="op" id="1396548">(</span><span class="ident" id="1396549">p</span>&nbsp;<span class="op" id="1396551">[</span><span class="op" id="1396552">]</span><span class="builtintype" id="1396553">byte</span><span class="op" id="1396557">,</span>&nbsp;<span class="ident" id="1396559">oob</span>&nbsp;<span class="op" id="1396563">[</span><span class="op" id="1396564">]</span><span class="builtintype" id="1396565">byte</span><span class="op" id="1396569">,</span>&nbsp;<span class="ident" id="1396571">sa</span>&nbsp;<span class="ident" id="1396574"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1396581">.</span><span class="ident" id="1396582">Sockaddr</span><span class="op" id="1396590">)</span>&nbsp;<span class="op" id="1396592">(</span><span class="ident" id="1396593">n</span>&nbsp;<span class="builtintype" id="1396595">int</span><span class="op" id="1396598">,</span>&nbsp;<span class="ident" id="1396600">oobn</span>&nbsp;<span class="builtintype" id="1396605">int</span><span class="op" id="1396608">,</span>&nbsp;<span class="ident" id="1396610">err</span>&nbsp;<span class="builtintype" id="1396614">error</span><span class="op" id="1396619">)</span>&nbsp;<span class="op" id="1396621">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396624">if</span>&nbsp;<span class="ident" id="1396627">err</span>&nbsp;<span class="op" id="1396631">:=</span>&nbsp;<span class="ident" id="1396634"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396636">.</span><span class="ident" id="1396637">writeLock</span><span class="op" id="1396646">(</span><span class="op" id="1396647">)</span><span class="op" id="1396648">;</span>&nbsp;<span class="ident" id="1396650"><a href="/net/fd_unix.go.html#1396627">err</a></span>&nbsp;<span class="op" id="1396654">!=</span>&nbsp;<span class="ident" id="1396657">nil</span>&nbsp;<span class="op" id="1396661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396665">return</span>&nbsp;<span class="num" id="1396672">0</span><span class="op" id="1396673">,</span>&nbsp;<span class="num" id="1396675">0</span><span class="op" id="1396676">,</span>&nbsp;<span class="ident" id="1396678"><a href="/net/fd_unix.go.html#1396627">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396686">defer</span>&nbsp;<span class="ident" id="1396692"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396694">.</span><span class="ident" id="1396695">writeUnlock</span><span class="op" id="1396706">(</span><span class="op" id="1396707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396710">if</span>&nbsp;<span class="ident" id="1396713">err</span>&nbsp;<span class="op" id="1396717">:=</span>&nbsp;<span class="ident" id="1396720"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396722">.</span><span class="ident" id="1396723">pd</span><span class="op" id="1396725">.</span><span class="ident" id="1396726">PrepareWrite</span><span class="op" id="1396738">(</span><span class="op" id="1396739">)</span><span class="op" id="1396740">;</span>&nbsp;<span class="ident" id="1396742"><a href="/net/fd_unix.go.html#1396713">err</a></span>&nbsp;<span class="op" id="1396746">!=</span>&nbsp;<span class="ident" id="1396749">nil</span>&nbsp;<span class="op" id="1396753">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396757">return</span>&nbsp;<span class="num" id="1396764">0</span><span class="op" id="1396765">,</span>&nbsp;<span class="num" id="1396767">0</span><span class="op" id="1396768">,</span>&nbsp;<span class="op" id="1396770">&amp;</span><span class="ident" id="1396771"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1396778">{</span><span class="string" id="1396779">&#34;write&#34;</span><span class="op" id="1396786">,</span>&nbsp;<span class="ident" id="1396788"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396790">.</span><span class="ident" id="1396791">net</span><span class="op" id="1396794">,</span>&nbsp;<span class="ident" id="1396796"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396798">.</span><span class="ident" id="1396799">raddr</span><span class="op" id="1396804">,</span>&nbsp;<span class="ident" id="1396806"><a href="/net/fd_unix.go.html#1396713">err</a></span><span class="op" id="1396809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396815">for</span>&nbsp;<span class="op" id="1396819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396823"><a href="/net/fd_unix.go.html#1396593">n</a></span><span class="op" id="1396824">,</span>&nbsp;<span class="ident" id="1396826"><a href="/net/fd_unix.go.html#1396610">err</a></span>&nbsp;<span class="op" id="1396830">=</span>&nbsp;<span class="ident" id="1396832"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1396839">.</span><span class="ident" id="1396840">SendmsgN</span><span class="op" id="1396848">(</span><span class="ident" id="1396849"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396851">.</span><span class="ident" id="1396852">sysfd</span><span class="op" id="1396857">,</span>&nbsp;<span class="ident" id="1396859"><a href="/net/fd_unix.go.html#1396549">p</a></span><span class="op" id="1396860">,</span>&nbsp;<span class="ident" id="1396862"><a href="/net/fd_unix.go.html#1396559">oob</a></span><span class="op" id="1396865">,</span>&nbsp;<span class="ident" id="1396867"><a href="/net/fd_unix.go.html#1396571">sa</a></span><span class="op" id="1396869">,</span>&nbsp;<span class="num" id="1396871">0</span><span class="op" id="1396872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396876">if</span>&nbsp;<span class="ident" id="1396879"><a href="/net/fd_unix.go.html#1396610">err</a></span>&nbsp;<span class="op" id="1396883">==</span>&nbsp;<span class="ident" id="1396886"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1396893">.</span><span class="ident" id="1396894">EAGAIN</span>&nbsp;<span class="op" id="1396901">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396906">if</span>&nbsp;<span class="ident" id="1396909"><a href="/net/fd_unix.go.html#1396610">err</a></span>&nbsp;<span class="op" id="1396913">=</span>&nbsp;<span class="ident" id="1396915"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1396917">.</span><span class="ident" id="1396918">pd</span><span class="op" id="1396920">.</span><span class="ident" id="1396921">WaitWrite</span><span class="op" id="1396930">(</span><span class="op" id="1396931">)</span><span class="op" id="1396932">;</span>&nbsp;<span class="ident" id="1396934"><a href="/net/fd_unix.go.html#1396610">err</a></span>&nbsp;<span class="op" id="1396938">==</span>&nbsp;<span class="ident" id="1396941">nil</span>&nbsp;<span class="op" id="1396945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396951">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396971">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396981">if</span>&nbsp;<span class="ident" id="1396984"><a href="/net/fd_unix.go.html#1396610">err</a></span>&nbsp;<span class="op" id="1396988">==</span>&nbsp;<span class="ident" id="1396991">nil</span>&nbsp;<span class="op" id="1396995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396999"><a href="/net/fd_unix.go.html#1396600">oobn</a></span>&nbsp;<span class="op" id="1397004">=</span>&nbsp;<span class="builtinfunc" id="1397006">len</span><span class="op" id="1397009">(</span><span class="ident" id="1397010"><a href="/net/fd_unix.go.html#1396559">oob</a></span><span class="op" id="1397013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397016">}</span>&nbsp;<span class="keyword" id="1397018">else</span>&nbsp;<span class="op" id="1397023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397027"><a href="/net/fd_unix.go.html#1396610">err</a></span>&nbsp;<span class="op" id="1397031">=</span>&nbsp;<span class="op" id="1397033">&amp;</span><span class="ident" id="1397034"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1397041">{</span><span class="string" id="1397042">&#34;write&#34;</span><span class="op" id="1397049">,</span>&nbsp;<span class="ident" id="1397051"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1397053">.</span><span class="ident" id="1397054">net</span><span class="op" id="1397057">,</span>&nbsp;<span class="ident" id="1397059"><a href="/net/fd_unix.go.html#1396529">fd</a></span><span class="op" id="1397061">.</span><span class="ident" id="1397062">raddr</span><span class="op" id="1397067">,</span>&nbsp;<span class="ident" id="1397069"><a href="/net/fd_unix.go.html#1396610">err</a></span><span class="op" id="1397072">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397078">return</span><br>
<span class="lineno"></span><span class="op" id="1397085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1397088">func</span>&nbsp;<span class="op" id="1397093">(</span><span class="ident" id="1397094">fd</span>&nbsp;<span class="op" id="1397097">*</span><span class="ident" id="1397098"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1397103">)</span>&nbsp;<span class="ident" id="1397105">accept</span><span class="op" id="1397111">(</span><span class="op" id="1397112">)</span>&nbsp;<span class="op" id="1397114">(</span><span class="ident" id="1397115">netfd</span>&nbsp;<span class="op" id="1397121">*</span><span class="ident" id="1397122"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1397127">,</span>&nbsp;<span class="ident" id="1397129">err</span>&nbsp;<span class="builtintype" id="1397133">error</span><span class="op" id="1397138">)</span>&nbsp;<span class="op" id="1397140">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397143">if</span>&nbsp;<span class="ident" id="1397146">err</span>&nbsp;<span class="op" id="1397150">:=</span>&nbsp;<span class="ident" id="1397153"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397155">.</span><span class="ident" id="1397156">readLock</span><span class="op" id="1397164">(</span><span class="op" id="1397165">)</span><span class="op" id="1397166">;</span>&nbsp;<span class="ident" id="1397168"><a href="/net/fd_unix.go.html#1397146">err</a></span>&nbsp;<span class="op" id="1397172">!=</span>&nbsp;<span class="ident" id="1397175">nil</span>&nbsp;<span class="op" id="1397179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397183">return</span>&nbsp;<span class="ident" id="1397190">nil</span><span class="op" id="1397193">,</span>&nbsp;<span class="ident" id="1397195"><a href="/net/fd_unix.go.html#1397146">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397203">defer</span>&nbsp;<span class="ident" id="1397209"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397211">.</span><span class="ident" id="1397212">readUnlock</span><span class="op" id="1397222">(</span><span class="op" id="1397223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397227">var</span>&nbsp;<span class="ident" id="1397231">s</span>&nbsp;<span class="builtintype" id="1397233">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397238">var</span>&nbsp;<span class="ident" id="1397242">rsa</span>&nbsp;<span class="ident" id="1397246"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1397253">.</span><span class="ident" id="1397254">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397264">if</span>&nbsp;<span class="ident" id="1397267"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397271">=</span>&nbsp;<span class="ident" id="1397273"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397275">.</span><span class="ident" id="1397276">pd</span><span class="op" id="1397278">.</span><span class="ident" id="1397279">PrepareRead</span><span class="op" id="1397290">(</span><span class="op" id="1397291">)</span><span class="op" id="1397292">;</span>&nbsp;<span class="ident" id="1397294"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397298">!=</span>&nbsp;<span class="ident" id="1397301">nil</span>&nbsp;<span class="op" id="1397305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397309">return</span>&nbsp;<span class="ident" id="1397316">nil</span><span class="op" id="1397319">,</span>&nbsp;<span class="op" id="1397321">&amp;</span><span class="ident" id="1397322"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1397329">{</span><span class="string" id="1397330">&#34;accept&#34;</span><span class="op" id="1397338">,</span>&nbsp;<span class="ident" id="1397340"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397342">.</span><span class="ident" id="1397343">net</span><span class="op" id="1397346">,</span>&nbsp;<span class="ident" id="1397348"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397350">.</span><span class="ident" id="1397351">laddr</span><span class="op" id="1397356">,</span>&nbsp;<span class="ident" id="1397358"><a href="/net/fd_unix.go.html#1397129">err</a></span><span class="op" id="1397361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397364">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397367">for</span>&nbsp;<span class="op" id="1397371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397375"><a href="/net/fd_unix.go.html#1397231">s</a></span><span class="op" id="1397376">,</span>&nbsp;<span class="ident" id="1397378"><a href="/net/fd_unix.go.html#1397242">rsa</a></span><span class="op" id="1397381">,</span>&nbsp;<span class="ident" id="1397383"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397387">=</span>&nbsp;<span class="ident" id="1397389"><a href="/net/sock_cloexec.go.html#1489860">accept</a></span><span class="op" id="1397395">(</span><span class="ident" id="1397396"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397398">.</span><span class="ident" id="1397399">sysfd</span><span class="op" id="1397404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397408">if</span>&nbsp;<span class="ident" id="1397411"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397415">!=</span>&nbsp;<span class="ident" id="1397418">nil</span>&nbsp;<span class="op" id="1397422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397427">if</span>&nbsp;<span class="ident" id="1397430"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397434">==</span>&nbsp;<span class="ident" id="1397437"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1397444">.</span><span class="ident" id="1397445">EAGAIN</span>&nbsp;<span class="op" id="1397452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397458">if</span>&nbsp;<span class="ident" id="1397461"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397465">=</span>&nbsp;<span class="ident" id="1397467"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397469">.</span><span class="ident" id="1397470">pd</span><span class="op" id="1397472">.</span><span class="ident" id="1397473">WaitRead</span><span class="op" id="1397481">(</span><span class="op" id="1397482">)</span><span class="op" id="1397483">;</span>&nbsp;<span class="ident" id="1397485"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397489">==</span>&nbsp;<span class="ident" id="1397492">nil</span>&nbsp;<span class="op" id="1397496">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397503">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397521">}</span>&nbsp;<span class="keyword" id="1397523">else</span>&nbsp;<span class="keyword" id="1397528">if</span>&nbsp;<span class="ident" id="1397531"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397535">==</span>&nbsp;<span class="ident" id="1397538"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1397545">.</span><span class="ident" id="1397546">ECONNABORTED</span>&nbsp;<span class="op" id="1397559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1397565">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1397628">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397694">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397711">return</span>&nbsp;<span class="ident" id="1397718">nil</span><span class="op" id="1397721">,</span>&nbsp;<span class="op" id="1397723">&amp;</span><span class="ident" id="1397724"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1397731">{</span><span class="string" id="1397732">&#34;accept&#34;</span><span class="op" id="1397740">,</span>&nbsp;<span class="ident" id="1397742"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397744">.</span><span class="ident" id="1397745">net</span><span class="op" id="1397748">,</span>&nbsp;<span class="ident" id="1397750"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397752">.</span><span class="ident" id="1397753">laddr</span><span class="op" id="1397758">,</span>&nbsp;<span class="ident" id="1397760"><a href="/net/fd_unix.go.html#1397129">err</a></span><span class="op" id="1397763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397771">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397782">if</span>&nbsp;<span class="ident" id="1397785"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1397790">,</span>&nbsp;<span class="ident" id="1397792"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397796">=</span>&nbsp;<span class="ident" id="1397798"><a href="/net/fd_unix.go.html#1388730">newFD</a></span><span class="op" id="1397803">(</span><span class="ident" id="1397804"><a href="/net/fd_unix.go.html#1397231">s</a></span><span class="op" id="1397805">,</span>&nbsp;<span class="ident" id="1397807"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397809">.</span><span class="ident" id="1397810">family</span><span class="op" id="1397816">,</span>&nbsp;<span class="ident" id="1397818"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397820">.</span><span class="ident" id="1397821">sotype</span><span class="op" id="1397827">,</span>&nbsp;<span class="ident" id="1397829"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397831">.</span><span class="ident" id="1397832">net</span><span class="op" id="1397835">)</span><span class="op" id="1397836">;</span>&nbsp;<span class="ident" id="1397838"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397842">!=</span>&nbsp;<span class="ident" id="1397845">nil</span>&nbsp;<span class="op" id="1397849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397853"><a href="/net/fd_unix.go.html#1400109">closesocket</a></span><span class="op" id="1397864">(</span><span class="ident" id="1397865"><a href="/net/fd_unix.go.html#1397231">s</a></span><span class="op" id="1397866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397870">return</span>&nbsp;<span class="ident" id="1397877">nil</span><span class="op" id="1397880">,</span>&nbsp;<span class="ident" id="1397882"><a href="/net/fd_unix.go.html#1397129">err</a></span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397890">if</span>&nbsp;<span class="ident" id="1397893"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397897">=</span>&nbsp;<span class="ident" id="1397899"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1397904">.</span><span class="ident" id="1397905">init</span><span class="op" id="1397909">(</span><span class="op" id="1397910">)</span><span class="op" id="1397911">;</span>&nbsp;<span class="ident" id="1397913"><a href="/net/fd_unix.go.html#1397129">err</a></span>&nbsp;<span class="op" id="1397917">!=</span>&nbsp;<span class="ident" id="1397920">nil</span>&nbsp;<span class="op" id="1397924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397928"><a href="/net/fd_unix.go.html#1397094">fd</a></span><span class="op" id="1397930">.</span><span class="ident" id="1397931">Close</span><span class="op" id="1397936">(</span><span class="op" id="1397937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397941">return</span>&nbsp;<span class="ident" id="1397948">nil</span><span class="op" id="1397951">,</span>&nbsp;<span class="ident" id="1397953"><a href="/net/fd_unix.go.html#1397129">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1397958">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397961">lsa</span><span class="op" id="1397964">,</span>&nbsp;<span class="ident" id="1397966">_</span>&nbsp;<span class="op" id="1397968">:=</span>&nbsp;<span class="ident" id="1397971"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1397978">.</span><span class="ident" id="1397979">Getsockname</span><span class="op" id="1397990">(</span><span class="ident" id="1397991"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1397996">.</span><span class="ident" id="1397997">sysfd</span><span class="op" id="1398002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398005"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1398010">.</span><span class="ident" id="1398011">setAddr</span><span class="op" id="1398018">(</span><span class="ident" id="1398019"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1398024">.</span><span class="ident" id="1398025">addrFunc</span><span class="op" id="1398033">(</span><span class="op" id="1398034">)</span><span class="op" id="1398035">(</span><span class="ident" id="1398036"><a href="/net/fd_unix.go.html#1397961">lsa</a></span><span class="op" id="1398039">)</span><span class="op" id="1398040">,</span>&nbsp;<span class="ident" id="1398042"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1398047">.</span><span class="ident" id="1398048">addrFunc</span><span class="op" id="1398056">(</span><span class="op" id="1398057">)</span><span class="op" id="1398058">(</span><span class="ident" id="1398059"><a href="/net/fd_unix.go.html#1397242">rsa</a></span><span class="op" id="1398062">)</span><span class="op" id="1398063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398066">return</span>&nbsp;<span class="ident" id="1398073"><a href="/net/fd_unix.go.html#1397115">netfd</a></span><span class="op" id="1398078">,</span>&nbsp;<span class="ident" id="1398080">nil</span><br>
<span class="lineno"></span><span class="op" id="1398084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="1398087">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="1398154">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1398209">var</span>&nbsp;<span class="ident" id="1398213">tryDupCloexec</span>&nbsp;<span class="op" id="1398227">=</span>&nbsp;<span class="builtintype" id="1398229">int32</span><span class="op" id="1398234">(</span><span class="num" id="1398235">1</span><span class="op" id="1398236">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1398239">func</span>&nbsp;<span class="ident" id="1398244">dupCloseOnExec</span><span class="op" id="1398258">(</span><span class="ident" id="1398259">fd</span>&nbsp;<span class="builtintype" id="1398262">int</span><span class="op" id="1398265">)</span>&nbsp;<span class="op" id="1398267">(</span><span class="ident" id="1398268">newfd</span>&nbsp;<span class="builtintype" id="1398274">int</span><span class="op" id="1398277">,</span>&nbsp;<span class="ident" id="1398279">err</span>&nbsp;<span class="builtintype" id="1398283">error</span><span class="op" id="1398288">)</span>&nbsp;<span class="op" id="1398290">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398293">if</span>&nbsp;<span class="ident" id="1398296"><a href="/net/fd_unix.go.html#1388210">atomic</a></span><span class="op" id="1398302">.</span><span class="ident" id="1398303">LoadInt32</span><span class="op" id="1398312">(</span><span class="op" id="1398313">&amp;</span><span class="ident" id="1398314"><a href="/net/fd_unix.go.html#1398213">tryDupCloexec</a></span><span class="op" id="1398327">)</span>&nbsp;<span class="op" id="1398329">==</span>&nbsp;<span class="num" id="1398332">1</span>&nbsp;<span class="op" id="1398334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398338">r0</span><span class="op" id="1398340">,</span>&nbsp;<span class="ident" id="1398342">_</span><span class="op" id="1398343">,</span>&nbsp;<span class="ident" id="1398345">e1</span>&nbsp;<span class="op" id="1398348">:=</span>&nbsp;<span class="ident" id="1398351"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1398358">.</span><span class="ident" id="1398359">Syscall</span><span class="op" id="1398366">(</span><span class="ident" id="1398367"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1398374">.</span><span class="ident" id="1398375">SYS_FCNTL</span><span class="op" id="1398384">,</span>&nbsp;<span class="builtintype" id="1398386">uintptr</span><span class="op" id="1398393">(</span><span class="ident" id="1398394"><a href="/net/fd_unix.go.html#1398259">fd</a></span><span class="op" id="1398396">)</span><span class="op" id="1398397">,</span>&nbsp;<span class="ident" id="1398399"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1398406">.</span><span class="ident" id="1398407">F_DUPFD_CLOEXEC</span><span class="op" id="1398422">,</span>&nbsp;<span class="num" id="1398424">0</span><span class="op" id="1398425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398429">if</span>&nbsp;<span class="ident" id="1398432"><a href="/net/fd_unix.go.html#1388199">runtime</a></span><span class="op" id="1398439">.</span><span class="ident" id="1398440">GOOS</span>&nbsp;<span class="op" id="1398445">==</span>&nbsp;<span class="string" id="1398448">&#34;darwin&#34;</span>&nbsp;<span class="op" id="1398457">&amp;&amp;</span>&nbsp;<span class="ident" id="1398460"><a href="/net/fd_unix.go.html#1398345">e1</a></span>&nbsp;<span class="op" id="1398463">==</span>&nbsp;<span class="ident" id="1398466"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1398473">.</span><span class="ident" id="1398474">EBADF</span>&nbsp;<span class="op" id="1398480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398485">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398535">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398582">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398630">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398679">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398723">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398767">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398812">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398835">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398890">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398905"><a href="/net/fd_unix.go.html#1398345">e1</a></span>&nbsp;<span class="op" id="1398908">=</span>&nbsp;<span class="ident" id="1398910"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1398917">.</span><span class="ident" id="1398918">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398927">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398931">switch</span>&nbsp;<span class="ident" id="1398938"><a href="/net/fd_unix.go.html#1398345">e1</a></span>&nbsp;<span class="op" id="1398941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398945">case</span>&nbsp;<span class="num" id="1398950">0</span><span class="op" id="1398951">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398956">return</span>&nbsp;<span class="builtintype" id="1398963">int</span><span class="op" id="1398966">(</span><span class="ident" id="1398967"><a href="/net/fd_unix.go.html#1398338">r0</a></span><span class="op" id="1398969">)</span><span class="op" id="1398970">,</span>&nbsp;<span class="ident" id="1398972">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398978">case</span>&nbsp;<span class="ident" id="1398983"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1398990">.</span><span class="ident" id="1398991">EINVAL</span><span class="op" id="1398997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399002">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399050">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399069"><a href="/net/fd_unix.go.html#1388210">atomic</a></span><span class="op" id="1399075">.</span><span class="ident" id="1399076">StoreInt32</span><span class="op" id="1399086">(</span><span class="op" id="1399087">&amp;</span><span class="ident" id="1399088"><a href="/net/fd_unix.go.html#1398213">tryDupCloexec</a></span><span class="op" id="1399101">,</span>&nbsp;<span class="num" id="1399103">0</span><span class="op" id="1399104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399108">default</span><span class="op" id="1399115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399120">return</span>&nbsp;<span class="op" id="1399127">-</span><span class="num" id="1399128">1</span><span class="op" id="1399129">,</span>&nbsp;<span class="ident" id="1399131"><a href="/net/fd_unix.go.html#1398345">e1</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399136">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399142">return</span>&nbsp;<span class="ident" id="1399149"><a href="/net/fd_unix.go.html#1399294">dupCloseOnExecOld</a></span><span class="op" id="1399166">(</span><span class="ident" id="1399167"><a href="/net/fd_unix.go.html#1398259">fd</a></span><span class="op" id="1399169">)</span><br>
<span class="lineno"></span><span class="op" id="1399171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1399174">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="1399239">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="1399289">func</span>&nbsp;<span class="ident" id="1399294">dupCloseOnExecOld</span><span class="op" id="1399311">(</span><span class="ident" id="1399312">fd</span>&nbsp;<span class="builtintype" id="1399315">int</span><span class="op" id="1399318">)</span>&nbsp;<span class="op" id="1399320">(</span><span class="ident" id="1399321">newfd</span>&nbsp;<span class="builtintype" id="1399327">int</span><span class="op" id="1399330">,</span>&nbsp;<span class="ident" id="1399332">err</span>&nbsp;<span class="builtintype" id="1399336">error</span><span class="op" id="1399341">)</span>&nbsp;<span class="op" id="1399343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399346"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1399353">.</span><span class="ident" id="1399354">ForkLock</span><span class="op" id="1399362">.</span><span class="ident" id="1399363">RLock</span><span class="op" id="1399368">(</span><span class="op" id="1399369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399372">defer</span>&nbsp;<span class="ident" id="1399378"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1399385">.</span><span class="ident" id="1399386">ForkLock</span><span class="op" id="1399394">.</span><span class="ident" id="1399395">RUnlock</span><span class="op" id="1399402">(</span><span class="op" id="1399403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399406"><a href="/net/fd_unix.go.html#1399321">newfd</a></span><span class="op" id="1399411">,</span>&nbsp;<span class="ident" id="1399413"><a href="/net/fd_unix.go.html#1399332">err</a></span>&nbsp;<span class="op" id="1399417">=</span>&nbsp;<span class="ident" id="1399419"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1399426">.</span><span class="ident" id="1399427">Dup</span><span class="op" id="1399430">(</span><span class="ident" id="1399431"><a href="/net/fd_unix.go.html#1399312">fd</a></span><span class="op" id="1399433">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399436">if</span>&nbsp;<span class="ident" id="1399439"><a href="/net/fd_unix.go.html#1399332">err</a></span>&nbsp;<span class="op" id="1399443">!=</span>&nbsp;<span class="ident" id="1399446">nil</span>&nbsp;<span class="op" id="1399450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399454">return</span>&nbsp;<span class="op" id="1399461">-</span><span class="num" id="1399462">1</span><span class="op" id="1399463">,</span>&nbsp;<span class="ident" id="1399465"><a href="/net/fd_unix.go.html#1399332">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399473"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1399480">.</span><span class="ident" id="1399481">CloseOnExec</span><span class="op" id="1399492">(</span><span class="ident" id="1399493"><a href="/net/fd_unix.go.html#1399321">newfd</a></span><span class="op" id="1399498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399501">return</span><br>
<span class="lineno">490</span><span class="op" id="1399508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1399511">func</span>&nbsp;<span class="op" id="1399516">(</span><span class="ident" id="1399517">fd</span>&nbsp;<span class="op" id="1399520">*</span><span class="ident" id="1399521"><a href="/net/fd_unix.go.html#1388279">netFD</a></span><span class="op" id="1399526">)</span>&nbsp;<span class="ident" id="1399528">dup</span><span class="op" id="1399531">(</span><span class="op" id="1399532">)</span>&nbsp;<span class="op" id="1399534">(</span><span class="ident" id="1399535">f</span>&nbsp;<span class="op" id="1399537">*</span><span class="ident" id="1399538"><a href="/net/fd_unix.go.html#1388193">os</a></span><span class="op" id="1399540">.</span><span class="ident" id="1399541">File</span><span class="op" id="1399545">,</span>&nbsp;<span class="ident" id="1399547">err</span>&nbsp;<span class="builtintype" id="1399551">error</span><span class="op" id="1399556">)</span>&nbsp;<span class="op" id="1399558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399561">ns</span><span class="op" id="1399563">,</span>&nbsp;<span class="ident" id="1399565"><a href="/net/fd_unix.go.html#1399547">err</a></span>&nbsp;<span class="op" id="1399569">:=</span>&nbsp;<span class="ident" id="1399572"><a href="/net/fd_unix.go.html#1398244">dupCloseOnExec</a></span><span class="op" id="1399586">(</span><span class="ident" id="1399587"><a href="/net/fd_unix.go.html#1399517">fd</a></span><span class="op" id="1399589">.</span><span class="ident" id="1399590">sysfd</span><span class="op" id="1399595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399598">if</span>&nbsp;<span class="ident" id="1399601"><a href="/net/fd_unix.go.html#1399547">err</a></span>&nbsp;<span class="op" id="1399605">!=</span>&nbsp;<span class="ident" id="1399608">nil</span>&nbsp;<span class="op" id="1399612">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399616">return</span>&nbsp;<span class="ident" id="1399623">nil</span><span class="op" id="1399626">,</span>&nbsp;<span class="op" id="1399628">&amp;</span><span class="ident" id="1399629"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1399636">{</span><span class="string" id="1399637">&#34;dup&#34;</span><span class="op" id="1399642">,</span>&nbsp;<span class="ident" id="1399644"><a href="/net/fd_unix.go.html#1399517">fd</a></span><span class="op" id="1399646">.</span><span class="ident" id="1399647">net</span><span class="op" id="1399650">,</span>&nbsp;<span class="ident" id="1399652"><a href="/net/fd_unix.go.html#1399517">fd</a></span><span class="op" id="1399654">.</span><span class="ident" id="1399655">laddr</span><span class="op" id="1399660">,</span>&nbsp;<span class="ident" id="1399662"><a href="/net/fd_unix.go.html#1399547">err</a></span><span class="op" id="1399665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399672">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399741">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399804">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399878">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399934">if</span>&nbsp;<span class="ident" id="1399937"><a href="/net/fd_unix.go.html#1399547">err</a></span>&nbsp;<span class="op" id="1399941">=</span>&nbsp;<span class="ident" id="1399943"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1399950">.</span><span class="ident" id="1399951">SetNonblock</span><span class="op" id="1399962">(</span><span class="ident" id="1399963"><a href="/net/fd_unix.go.html#1399561">ns</a></span><span class="op" id="1399965">,</span>&nbsp;<span class="builtintype" id="1399967">false</span><span class="op" id="1399972">)</span><span class="op" id="1399973">;</span>&nbsp;<span class="ident" id="1399975"><a href="/net/fd_unix.go.html#1399547">err</a></span>&nbsp;<span class="op" id="1399979">!=</span>&nbsp;<span class="ident" id="1399982">nil</span>&nbsp;<span class="op" id="1399986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399990">return</span>&nbsp;<span class="ident" id="1399997">nil</span><span class="op" id="1400000">,</span>&nbsp;<span class="op" id="1400002">&amp;</span><span class="ident" id="1400003"><a href="/net/net.go.html#1472480">OpError</a></span><span class="op" id="1400010">{</span><span class="string" id="1400011">&#34;setnonblock&#34;</span><span class="op" id="1400024">,</span>&nbsp;<span class="ident" id="1400026"><a href="/net/fd_unix.go.html#1399517">fd</a></span><span class="op" id="1400028">.</span><span class="ident" id="1400029">net</span><span class="op" id="1400032">,</span>&nbsp;<span class="ident" id="1400034"><a href="/net/fd_unix.go.html#1399517">fd</a></span><span class="op" id="1400036">.</span><span class="ident" id="1400037">laddr</span><span class="op" id="1400042">,</span>&nbsp;<span class="ident" id="1400044"><a href="/net/fd_unix.go.html#1399547">err</a></span><span class="op" id="1400047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400050">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400054">return</span>&nbsp;<span class="ident" id="1400061"><a href="/net/fd_unix.go.html#1388193">os</a></span><span class="op" id="1400063">.</span><span class="ident" id="1400064">NewFile</span><span class="op" id="1400071">(</span><span class="builtintype" id="1400072">uintptr</span><span class="op" id="1400079">(</span><span class="ident" id="1400080"><a href="/net/fd_unix.go.html#1399561">ns</a></span><span class="op" id="1400082">)</span><span class="op" id="1400083">,</span>&nbsp;<span class="ident" id="1400085"><a href="/net/fd_unix.go.html#1399517">fd</a></span><span class="op" id="1400087">.</span><span class="ident" id="1400088">name</span><span class="op" id="1400092">(</span><span class="op" id="1400093">)</span><span class="op" id="1400094">)</span><span class="op" id="1400095">,</span>&nbsp;<span class="ident" id="1400097">nil</span><br>
<span class="lineno"></span><span class="op" id="1400101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1400104">func</span>&nbsp;<span class="ident" id="1400109">closesocket</span><span class="op" id="1400120">(</span><span class="ident" id="1400121">s</span>&nbsp;<span class="builtintype" id="1400123">int</span><span class="op" id="1400126">)</span>&nbsp;<span class="builtintype" id="1400128">error</span>&nbsp;<span class="op" id="1400134">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400137">return</span>&nbsp;<span class="ident" id="1400144"><a href="/net/fd_unix.go.html#1388225">syscall</a></span><span class="op" id="1400151">.</span><span class="ident" id="1400152">Close</span><span class="op" id="1400157">(</span><span class="ident" id="1400158"><a href="/net/fd_unix.go.html#1400121">s</a></span><span class="op" id="1400159">)</span><br>
<span class="lineno"></span><span class="op" id="1400161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1400164">func</span>&nbsp;<span class="ident" id="1400169">skipRawSocketTests</span><span class="op" id="1400187">(</span><span class="op" id="1400188">)</span>&nbsp;<span class="op" id="1400190">(</span><span class="ident" id="1400191">skip</span>&nbsp;<span class="builtintype" id="1400196">bool</span><span class="op" id="1400200">,</span>&nbsp;<span class="ident" id="1400202">skipmsg</span>&nbsp;<span class="builtintype" id="1400210">string</span><span class="op" id="1400216">,</span>&nbsp;<span class="ident" id="1400218">err</span>&nbsp;<span class="builtintype" id="1400222">error</span><span class="op" id="1400227">)</span>&nbsp;<span class="op" id="1400229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400232">if</span>&nbsp;<span class="ident" id="1400235"><a href="/net/fd_unix.go.html#1388193">os</a></span><span class="op" id="1400237">.</span><span class="ident" id="1400238">Getuid</span><span class="op" id="1400244">(</span><span class="op" id="1400245">)</span>&nbsp;<span class="op" id="1400247">!=</span>&nbsp;<span class="num" id="1400250">0</span>&nbsp;<span class="op" id="1400252">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400256">return</span>&nbsp;<span class="builtintype" id="1400263">true</span><span class="op" id="1400267">,</span>&nbsp;<span class="string" id="1400269">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="1400298">,</span>&nbsp;<span class="ident" id="1400300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400308">return</span>&nbsp;<span class="builtintype" id="1400315">false</span><span class="op" id="1400320">,</span>&nbsp;<span class="string" id="1400322">&#34;&#34;</span><span class="op" id="1400324">,</span>&nbsp;<span class="ident" id="1400326">nil</span><br>
<span class="lineno"></span><span class="op" id="1400330">}</span>
</div>
</body>
</html>
