<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2995130">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2995185">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2995239">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2995290">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2995327">package</span>&nbsp;<span class="ident" id="2995335">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2995341">import</span>&nbsp;<span class="op" id="2995348">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995351">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995361">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995368">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995374">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995382">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995400">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995417">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995428">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995434">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995442">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995459">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995470">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2995481">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="2995488">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="2995491">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="2995567">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="2995595">//</span><br>
<span class="lineno"></span><span class="comment" id="2995598">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="2995676">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="2995756">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="2995811">//</span><br>
<span class="lineno"></span><span class="comment" id="2995814">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="2995849">type</span>&nbsp;<span class="ident" id="2995854">Dir</span>&nbsp;<span class="builtintype" id="2995858">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="2995866">func</span>&nbsp;<span class="op" id="2995871">(</span><span class="ident" id="2995872">d</span>&nbsp;<span class="ident" id="2995874">Dir</span><span class="op" id="2995877">)</span>&nbsp;<span class="ident" id="2995879">Open</span><span class="op" id="2995883">(</span><span class="ident" id="2995884">name</span>&nbsp;<span class="builtintype" id="2995889">string</span><span class="op" id="2995895">)</span>&nbsp;<span class="op" id="2995897">(</span><span class="ident" id="2995898">File</span><span class="op" id="2995902">,</span>&nbsp;<span class="builtintype" id="2995904">error</span><span class="op" id="2995909">)</span>&nbsp;<span class="op" id="2995911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995914">if</span>&nbsp;<span class="ident" id="2995917">filepath</span><span class="op" id="2995925">.</span><span class="ident" id="2995926">Separator</span>&nbsp;<span class="op" id="2995936">!=</span>&nbsp;<span class="string" id="2995939">&#39;/&#39;</span>&nbsp;<span class="op" id="2995943">&amp;&amp;</span>&nbsp;<span class="ident" id="2995946">strings</span><span class="op" id="2995953">.</span><span class="ident" id="2995954">IndexRune</span><span class="op" id="2995963">(</span><span class="ident" id="2995964">name</span><span class="op" id="2995968">,</span>&nbsp;<span class="ident" id="2995970">filepath</span><span class="op" id="2995978">.</span><span class="ident" id="2995979">Separator</span><span class="op" id="2995988">)</span>&nbsp;<span class="op" id="2995990">&gt;=</span>&nbsp;<span class="num" id="2995993">0</span>&nbsp;<span class="op" id="2995995">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996000">strings</span><span class="op" id="2996007">.</span><span class="ident" id="2996008">Contains</span><span class="op" id="2996016">(</span><span class="ident" id="2996017">name</span><span class="op" id="2996021">,</span>&nbsp;<span class="string" id="2996023">&#34;\x00&#34;</span><span class="op" id="2996029">)</span>&nbsp;<span class="op" id="2996031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996035">return</span>&nbsp;<span class="ident" id="2996042">nil</span><span class="op" id="2996045">,</span>&nbsp;<span class="ident" id="2996047">errors</span><span class="op" id="2996053">.</span><span class="ident" id="2996054">New</span><span class="op" id="2996057">(</span><span class="string" id="2996058">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="2996096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996099">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996102">dir</span>&nbsp;<span class="op" id="2996106">:=</span>&nbsp;<span class="builtintype" id="2996109">string</span><span class="op" id="2996115">(</span><span class="ident" id="2996116">d</span><span class="op" id="2996117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996120">if</span>&nbsp;<span class="ident" id="2996123">dir</span>&nbsp;<span class="op" id="2996127">==</span>&nbsp;<span class="string" id="2996130">&#34;&#34;</span>&nbsp;<span class="op" id="2996133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996137">dir</span>&nbsp;<span class="op" id="2996141">=</span>&nbsp;<span class="string" id="2996143">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996151">f</span><span class="op" id="2996152">,</span>&nbsp;<span class="ident" id="2996154">err</span>&nbsp;<span class="op" id="2996158">:=</span>&nbsp;<span class="ident" id="2996161">os</span><span class="op" id="2996163">.</span><span class="ident" id="2996164">Open</span><span class="op" id="2996168">(</span><span class="ident" id="2996169">filepath</span><span class="op" id="2996177">.</span><span class="ident" id="2996178">Join</span><span class="op" id="2996182">(</span><span class="ident" id="2996183">dir</span><span class="op" id="2996186">,</span>&nbsp;<span class="ident" id="2996188">filepath</span><span class="op" id="2996196">.</span><span class="ident" id="2996197">FromSlash</span><span class="op" id="2996206">(</span><span class="ident" id="2996207">path</span><span class="op" id="2996211">.</span><span class="ident" id="2996212">Clean</span><span class="op" id="2996217">(</span><span class="string" id="2996218">&#34;/&#34;</span><span class="op" id="2996221">+</span><span class="ident" id="2996222">name</span><span class="op" id="2996226">)</span><span class="op" id="2996227">)</span><span class="op" id="2996228">)</span><span class="op" id="2996229">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996232">if</span>&nbsp;<span class="ident" id="2996235">err</span>&nbsp;<span class="op" id="2996239">!=</span>&nbsp;<span class="ident" id="2996242">nil</span>&nbsp;<span class="op" id="2996246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996250">return</span>&nbsp;<span class="ident" id="2996257">nil</span><span class="op" id="2996260">,</span>&nbsp;<span class="ident" id="2996262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996270">return</span>&nbsp;<span class="ident" id="2996277">f</span><span class="op" id="2996278">,</span>&nbsp;<span class="ident" id="2996280">nil</span><br>
<span class="lineno"></span><span class="op" id="2996284">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="2996287">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="2996353">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="2996421">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="2996484">type</span>&nbsp;<span class="ident" id="2996489">FileSystem</span>&nbsp;<span class="keyword" id="2996500">interface</span>&nbsp;<span class="op" id="2996510">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996513">Open</span><span class="op" id="2996517">(</span><span class="ident" id="2996518">name</span>&nbsp;<span class="builtintype" id="2996523">string</span><span class="op" id="2996529">)</span>&nbsp;<span class="op" id="2996531">(</span><span class="ident" id="2996532">File</span><span class="op" id="2996536">,</span>&nbsp;<span class="builtintype" id="2996538">error</span><span class="op" id="2996543">)</span><br>
<span class="lineno"></span><span class="op" id="2996545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2996548">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="2996611">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="2996655">//</span><br>
<span class="lineno"></span><span class="comment" id="2996658">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="2996721">type</span>&nbsp;<span class="ident" id="2996726">File</span>&nbsp;<span class="keyword" id="2996731">interface</span>&nbsp;<span class="op" id="2996741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996744">io</span><span class="op" id="2996746">.</span><span class="ident" id="2996747">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996755">io</span><span class="op" id="2996757">.</span><span class="ident" id="2996758">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996766">Readdir</span><span class="op" id="2996773">(</span><span class="ident" id="2996774">count</span>&nbsp;<span class="builtintype" id="2996780">int</span><span class="op" id="2996783">)</span>&nbsp;<span class="op" id="2996785">(</span><span class="op" id="2996786">[</span><span class="op" id="2996787">]</span><span class="ident" id="2996788">os</span><span class="op" id="2996790">.</span><span class="ident" id="2996791">FileInfo</span><span class="op" id="2996799">,</span>&nbsp;<span class="builtintype" id="2996801">error</span><span class="op" id="2996806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996809">Seek</span><span class="op" id="2996813">(</span><span class="ident" id="2996814">offset</span>&nbsp;<span class="ident" id="2996821">int64</span><span class="op" id="2996826">,</span>&nbsp;<span class="ident" id="2996828">whence</span>&nbsp;<span class="builtintype" id="2996835">int</span><span class="op" id="2996838">)</span>&nbsp;<span class="op" id="2996840">(</span><span class="ident" id="2996841">int64</span><span class="op" id="2996846">,</span>&nbsp;<span class="builtintype" id="2996848">error</span><span class="op" id="2996853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996856">Stat</span><span class="op" id="2996860">(</span><span class="op" id="2996861">)</span>&nbsp;<span class="op" id="2996863">(</span><span class="ident" id="2996864">os</span><span class="op" id="2996866">.</span><span class="ident" id="2996867">FileInfo</span><span class="op" id="2996875">,</span>&nbsp;<span class="builtintype" id="2996877">error</span><span class="op" id="2996882">)</span><br>
<span class="lineno"></span><span class="op" id="2996884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="2996887">func</span>&nbsp;<span class="ident" id="2996892">dirList</span><span class="op" id="2996899">(</span><span class="ident" id="2996900">w</span>&nbsp;<span class="ident" id="2996902">ResponseWriter</span><span class="op" id="2996916">,</span>&nbsp;<span class="ident" id="2996918">f</span>&nbsp;<span class="ident" id="2996920">File</span><span class="op" id="2996924">)</span>&nbsp;<span class="op" id="2996926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996929">w</span><span class="op" id="2996930">.</span><span class="ident" id="2996931">Header</span><span class="op" id="2996937">(</span><span class="op" id="2996938">)</span><span class="op" id="2996939">.</span><span class="ident" id="2996940">Set</span><span class="op" id="2996943">(</span><span class="string" id="2996944">&#34;Content-Type&#34;</span><span class="op" id="2996958">,</span>&nbsp;<span class="string" id="2996960">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="2996986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996989">fmt</span><span class="op" id="2996992">.</span><span class="ident" id="2996993">Fprintf</span><span class="op" id="2997000">(</span><span class="ident" id="2997001">w</span><span class="op" id="2997002">,</span>&nbsp;<span class="string" id="2997004">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="2997013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997016">for</span>&nbsp;<span class="op" id="2997020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997024">dirs</span><span class="op" id="2997028">,</span>&nbsp;<span class="ident" id="2997030">err</span>&nbsp;<span class="op" id="2997034">:=</span>&nbsp;<span class="ident" id="2997037">f</span><span class="op" id="2997038">.</span><span class="ident" id="2997039">Readdir</span><span class="op" id="2997046">(</span><span class="num" id="2997047">100</span><span class="op" id="2997050">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997054">if</span>&nbsp;<span class="ident" id="2997057">err</span>&nbsp;<span class="op" id="2997061">!=</span>&nbsp;<span class="ident" id="2997064">nil</span>&nbsp;<span class="op" id="2997068">||</span>&nbsp;<span class="builtinfunc" id="2997071">len</span><span class="op" id="2997074">(</span><span class="ident" id="2997075">dirs</span><span class="op" id="2997079">)</span>&nbsp;<span class="op" id="2997081">==</span>&nbsp;<span class="num" id="2997084">0</span>&nbsp;<span class="op" id="2997086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997091">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997103">for</span>&nbsp;<span class="ident" id="2997107">_</span><span class="op" id="2997108">,</span>&nbsp;<span class="ident" id="2997110">d</span>&nbsp;<span class="op" id="2997112">:=</span>&nbsp;<span class="keyword" id="2997115">range</span>&nbsp;<span class="ident" id="2997121">dirs</span>&nbsp;<span class="op" id="2997126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997131">name</span>&nbsp;<span class="op" id="2997136">:=</span>&nbsp;<span class="ident" id="2997139">d</span><span class="op" id="2997140">.</span><span class="ident" id="2997141">Name</span><span class="op" id="2997145">(</span><span class="op" id="2997146">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997151">if</span>&nbsp;<span class="ident" id="2997154">d</span><span class="op" id="2997155">.</span><span class="ident" id="2997156">IsDir</span><span class="op" id="2997161">(</span><span class="op" id="2997162">)</span>&nbsp;<span class="op" id="2997164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997170">name</span>&nbsp;<span class="op" id="2997175">+=</span>&nbsp;<span class="string" id="2997178">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2997190">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2997257">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2997323">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997349">url</span>&nbsp;<span class="op" id="2997353">:=</span>&nbsp;<span class="ident" id="2997356">url</span><span class="op" id="2997359">.</span><span class="ident" id="2997360">URL</span><span class="op" id="2997363">{</span><span class="ident" id="2997364">Path</span><span class="op" id="2997368">:</span>&nbsp;<span class="ident" id="2997370">name</span><span class="op" id="2997374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997379">fmt</span><span class="op" id="2997382">.</span><span class="ident" id="2997383">Fprintf</span><span class="op" id="2997390">(</span><span class="ident" id="2997391">w</span><span class="op" id="2997392">,</span>&nbsp;<span class="string" id="2997394">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="2997419">,</span>&nbsp;<span class="ident" id="2997421">url</span><span class="op" id="2997424">.</span><span class="ident" id="2997425">String</span><span class="op" id="2997431">(</span><span class="op" id="2997432">)</span><span class="op" id="2997433">,</span>&nbsp;<span class="ident" id="2997435">htmlReplacer</span><span class="op" id="2997447">.</span><span class="ident" id="2997448">Replace</span><span class="op" id="2997455">(</span><span class="ident" id="2997456">name</span><span class="op" id="2997460">)</span><span class="op" id="2997461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997468">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997471">fmt</span><span class="op" id="2997474">.</span><span class="ident" id="2997475">Fprintf</span><span class="op" id="2997482">(</span><span class="ident" id="2997483">w</span><span class="op" id="2997484">,</span>&nbsp;<span class="string" id="2997486">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="2997496">)</span><br>
<span class="lineno"></span><span class="op" id="2997498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2997501">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2997565">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="2997636">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2997707">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="2997746">//</span><br>
<span class="lineno"></span><span class="comment" id="2997749">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="2997815">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="2997881">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="2997952">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="2997992">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2998062">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="2998093">//</span><br>
<span class="lineno">105</span><span class="comment" id="2998096">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="2998162">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="2998231">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="2998296">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="2998344">//</span><br>
<span class="lineno">110</span><span class="comment" id="2998347">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="2998405">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2998464">//</span><br>
<span class="lineno"></span><span class="comment" id="2998467">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2998533">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="2998586">//</span><br>
<span class="lineno"></span><span class="comment" id="2998589">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="2998651">func</span>&nbsp;<span class="ident" id="2998656">ServeContent</span><span class="op" id="2998668">(</span><span class="ident" id="2998669">w</span>&nbsp;<span class="ident" id="2998671">ResponseWriter</span><span class="op" id="2998685">,</span>&nbsp;<span class="ident" id="2998687">req</span>&nbsp;<span class="op" id="2998691">*</span><span class="ident" id="2998692">Request</span><span class="op" id="2998699">,</span>&nbsp;<span class="ident" id="2998701">name</span>&nbsp;<span class="builtintype" id="2998706">string</span><span class="op" id="2998712">,</span>&nbsp;<span class="ident" id="2998714">modtime</span>&nbsp;<span class="ident" id="2998722">time</span><span class="op" id="2998726">.</span><span class="ident" id="2998727">Time</span><span class="op" id="2998731">,</span>&nbsp;<span class="ident" id="2998733">content</span>&nbsp;<span class="ident" id="2998741">io</span><span class="op" id="2998743">.</span><span class="ident" id="2998744">ReadSeeker</span><span class="op" id="2998754">)</span>&nbsp;<span class="op" id="2998756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2998759">sizeFunc</span>&nbsp;<span class="op" id="2998768">:=</span>&nbsp;<span class="keyword" id="2998771">func</span><span class="op" id="2998775">(</span><span class="op" id="2998776">)</span>&nbsp;<span class="op" id="2998778">(</span><span class="ident" id="2998779">int64</span><span class="op" id="2998784">,</span>&nbsp;<span class="builtintype" id="2998786">error</span><span class="op" id="2998791">)</span>&nbsp;<span class="op" id="2998793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2998797">size</span><span class="op" id="2998801">,</span>&nbsp;<span class="ident" id="2998803">err</span>&nbsp;<span class="op" id="2998807">:=</span>&nbsp;<span class="ident" id="2998810">content</span><span class="op" id="2998817">.</span><span class="ident" id="2998818">Seek</span><span class="op" id="2998822">(</span><span class="num" id="2998823">0</span><span class="op" id="2998824">,</span>&nbsp;<span class="ident" id="2998826">os</span><span class="op" id="2998828">.</span><span class="ident" id="2998829">SEEK_END</span><span class="op" id="2998837">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998841">if</span>&nbsp;<span class="ident" id="2998844">err</span>&nbsp;<span class="op" id="2998848">!=</span>&nbsp;<span class="ident" id="2998851">nil</span>&nbsp;<span class="op" id="2998855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998860">return</span>&nbsp;<span class="num" id="2998867">0</span><span class="op" id="2998868">,</span>&nbsp;<span class="ident" id="2998870">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2998882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2998886">_</span><span class="op" id="2998887">,</span>&nbsp;<span class="ident" id="2998889">err</span>&nbsp;<span class="op" id="2998893">=</span>&nbsp;<span class="ident" id="2998895">content</span><span class="op" id="2998902">.</span><span class="ident" id="2998903">Seek</span><span class="op" id="2998907">(</span><span class="num" id="2998908">0</span><span class="op" id="2998909">,</span>&nbsp;<span class="ident" id="2998911">os</span><span class="op" id="2998913">.</span><span class="ident" id="2998914">SEEK_SET</span><span class="op" id="2998922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998926">if</span>&nbsp;<span class="ident" id="2998929">err</span>&nbsp;<span class="op" id="2998933">!=</span>&nbsp;<span class="ident" id="2998936">nil</span>&nbsp;<span class="op" id="2998940">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998945">return</span>&nbsp;<span class="num" id="2998952">0</span><span class="op" id="2998953">,</span>&nbsp;<span class="ident" id="2998955">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2998967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998971">return</span>&nbsp;<span class="ident" id="2998978">size</span><span class="op" id="2998982">,</span>&nbsp;<span class="ident" id="2998984">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2998989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2998992">serveContent</span><span class="op" id="2999004">(</span><span class="ident" id="2999005">w</span><span class="op" id="2999006">,</span>&nbsp;<span class="ident" id="2999008">req</span><span class="op" id="2999011">,</span>&nbsp;<span class="ident" id="2999013">name</span><span class="op" id="2999017">,</span>&nbsp;<span class="ident" id="2999019">modtime</span><span class="op" id="2999026">,</span>&nbsp;<span class="ident" id="2999028">sizeFunc</span><span class="op" id="2999036">,</span>&nbsp;<span class="ident" id="2999038">content</span><span class="op" id="2999045">)</span><br>
<span class="lineno">130</span><span class="op" id="2999047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2999050">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="2999119">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="2999186">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="2999254">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="2999264">var</span>&nbsp;<span class="ident" id="2999268">errSeeker</span>&nbsp;<span class="op" id="2999278">=</span>&nbsp;<span class="ident" id="2999280">errors</span><span class="op" id="2999286">.</span><span class="ident" id="2999287">New</span><span class="op" id="2999290">(</span><span class="string" id="2999291">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="2999310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2999313">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="2999393">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="2999437">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="2999493">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="2999582">func</span>&nbsp;<span class="ident" id="2999587">serveContent</span><span class="op" id="2999599">(</span><span class="ident" id="2999600">w</span>&nbsp;<span class="ident" id="2999602">ResponseWriter</span><span class="op" id="2999616">,</span>&nbsp;<span class="ident" id="2999618">r</span>&nbsp;<span class="op" id="2999620">*</span><span class="ident" id="2999621">Request</span><span class="op" id="2999628">,</span>&nbsp;<span class="ident" id="2999630">name</span>&nbsp;<span class="builtintype" id="2999635">string</span><span class="op" id="2999641">,</span>&nbsp;<span class="ident" id="2999643">modtime</span>&nbsp;<span class="ident" id="2999651">time</span><span class="op" id="2999655">.</span><span class="ident" id="2999656">Time</span><span class="op" id="2999660">,</span>&nbsp;<span class="ident" id="2999662">sizeFunc</span>&nbsp;<span class="keyword" id="2999671">func</span><span class="op" id="2999675">(</span><span class="op" id="2999676">)</span>&nbsp;<span class="op" id="2999678">(</span><span class="ident" id="2999679">int64</span><span class="op" id="2999684">,</span>&nbsp;<span class="builtintype" id="2999686">error</span><span class="op" id="2999691">)</span><span class="op" id="2999692">,</span>&nbsp;<span class="ident" id="2999694">content</span>&nbsp;<span class="ident" id="2999702">io</span><span class="op" id="2999704">.</span><span class="ident" id="2999705">ReadSeeker</span><span class="op" id="2999715">)</span>&nbsp;<span class="op" id="2999717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2999720">if</span>&nbsp;<span class="ident" id="2999723">checkLastModified</span><span class="op" id="2999740">(</span><span class="ident" id="2999741">w</span><span class="op" id="2999742">,</span>&nbsp;<span class="ident" id="2999744">r</span><span class="op" id="2999745">,</span>&nbsp;<span class="ident" id="2999747">modtime</span><span class="op" id="2999754">)</span>&nbsp;<span class="op" id="2999756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2999760">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2999768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2999771">rangeReq</span><span class="op" id="2999779">,</span>&nbsp;<span class="ident" id="2999781">done</span>&nbsp;<span class="op" id="2999786">:=</span>&nbsp;<span class="ident" id="2999789">checkETag</span><span class="op" id="2999798">(</span><span class="ident" id="2999799">w</span><span class="op" id="2999800">,</span>&nbsp;<span class="ident" id="2999802">r</span><span class="op" id="2999803">,</span>&nbsp;<span class="ident" id="2999805">modtime</span><span class="op" id="2999812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2999815">if</span>&nbsp;<span class="ident" id="2999818">done</span>&nbsp;<span class="op" id="2999823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2999827">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2999835">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2999839">code</span>&nbsp;<span class="op" id="2999844">:=</span>&nbsp;<span class="ident" id="2999847">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2999858">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2999930">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2999998">ctypes</span><span class="op" id="3000004">,</span>&nbsp;<span class="ident" id="3000006">haveType</span>&nbsp;<span class="op" id="3000015">:=</span>&nbsp;<span class="ident" id="3000018">w</span><span class="op" id="3000019">.</span><span class="ident" id="3000020">Header</span><span class="op" id="3000026">(</span><span class="op" id="3000027">)</span><span class="op" id="3000028">[</span><span class="string" id="3000029">&#34;Content-Type&#34;</span><span class="op" id="3000043">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000046">var</span>&nbsp;<span class="ident" id="3000050">ctype</span>&nbsp;<span class="builtintype" id="3000056">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000064">if</span>&nbsp;<span class="op" id="3000067">!</span><span class="ident" id="3000068">haveType</span>&nbsp;<span class="op" id="3000077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000081">ctype</span>&nbsp;<span class="op" id="3000087">=</span>&nbsp;<span class="ident" id="3000089">mime</span><span class="op" id="3000093">.</span><span class="ident" id="3000094">TypeByExtension</span><span class="op" id="3000109">(</span><span class="ident" id="3000110">filepath</span><span class="op" id="3000118">.</span><span class="ident" id="3000119">Ext</span><span class="op" id="3000122">(</span><span class="ident" id="3000123">name</span><span class="op" id="3000127">)</span><span class="op" id="3000128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000132">if</span>&nbsp;<span class="ident" id="3000135">ctype</span>&nbsp;<span class="op" id="3000141">==</span>&nbsp;<span class="string" id="3000144">&#34;&#34;</span>&nbsp;<span class="op" id="3000147">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3000152">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000211">var</span>&nbsp;<span class="ident" id="3000215">buf</span>&nbsp;<span class="op" id="3000219">[</span><span class="ident" id="3000220">sniffLen</span><span class="op" id="3000228">]</span><span class="builtintype" id="3000229">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000237">n</span><span class="op" id="3000238">,</span>&nbsp;<span class="ident" id="3000240">_</span>&nbsp;<span class="op" id="3000242">:=</span>&nbsp;<span class="ident" id="3000245">io</span><span class="op" id="3000247">.</span><span class="ident" id="3000248">ReadFull</span><span class="op" id="3000256">(</span><span class="ident" id="3000257">content</span><span class="op" id="3000264">,</span>&nbsp;<span class="ident" id="3000266">buf</span><span class="op" id="3000269">[</span><span class="op" id="3000270">:</span><span class="op" id="3000271">]</span><span class="op" id="3000272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000277">ctype</span>&nbsp;<span class="op" id="3000283">=</span>&nbsp;<span class="ident" id="3000285">DetectContentType</span><span class="op" id="3000302">(</span><span class="ident" id="3000303">buf</span><span class="op" id="3000306">[</span><span class="op" id="3000307">:</span><span class="ident" id="3000308">n</span><span class="op" id="3000309">]</span><span class="op" id="3000310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000315">_</span><span class="op" id="3000316">,</span>&nbsp;<span class="ident" id="3000318">err</span>&nbsp;<span class="op" id="3000322">:=</span>&nbsp;<span class="ident" id="3000325">content</span><span class="op" id="3000332">.</span><span class="ident" id="3000333">Seek</span><span class="op" id="3000337">(</span><span class="num" id="3000338">0</span><span class="op" id="3000339">,</span>&nbsp;<span class="ident" id="3000341">os</span><span class="op" id="3000343">.</span><span class="ident" id="3000344">SEEK_SET</span><span class="op" id="3000352">)</span>&nbsp;<span class="comment" id="3000354">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000388">if</span>&nbsp;<span class="ident" id="3000391">err</span>&nbsp;<span class="op" id="3000395">!=</span>&nbsp;<span class="ident" id="3000398">nil</span>&nbsp;<span class="op" id="3000402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000408">Error</span><span class="op" id="3000413">(</span><span class="ident" id="3000414">w</span><span class="op" id="3000415">,</span>&nbsp;<span class="string" id="3000417">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3000436">,</span>&nbsp;<span class="ident" id="3000438">StatusInternalServerError</span><span class="op" id="3000463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000469">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3000479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3000483">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000487">w</span><span class="op" id="3000488">.</span><span class="ident" id="3000489">Header</span><span class="op" id="3000495">(</span><span class="op" id="3000496">)</span><span class="op" id="3000497">.</span><span class="ident" id="3000498">Set</span><span class="op" id="3000501">(</span><span class="string" id="3000502">&#34;Content-Type&#34;</span><span class="op" id="3000516">,</span>&nbsp;<span class="ident" id="3000518">ctype</span><span class="op" id="3000523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3000526">}</span>&nbsp;<span class="keyword" id="3000528">else</span>&nbsp;<span class="keyword" id="3000533">if</span>&nbsp;<span class="builtinfunc" id="3000536">len</span><span class="op" id="3000539">(</span><span class="ident" id="3000540">ctypes</span><span class="op" id="3000546">)</span>&nbsp;<span class="op" id="3000548">&gt;</span>&nbsp;<span class="num" id="3000550">0</span>&nbsp;<span class="op" id="3000552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000556">ctype</span>&nbsp;<span class="op" id="3000562">=</span>&nbsp;<span class="ident" id="3000564">ctypes</span><span class="op" id="3000570">[</span><span class="num" id="3000571">0</span><span class="op" id="3000572">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3000575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000579">size</span><span class="op" id="3000583">,</span>&nbsp;<span class="ident" id="3000585">err</span>&nbsp;<span class="op" id="3000589">:=</span>&nbsp;<span class="ident" id="3000592">sizeFunc</span><span class="op" id="3000600">(</span><span class="op" id="3000601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000604">if</span>&nbsp;<span class="ident" id="3000607">err</span>&nbsp;<span class="op" id="3000611">!=</span>&nbsp;<span class="ident" id="3000614">nil</span>&nbsp;<span class="op" id="3000618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000622">Error</span><span class="op" id="3000627">(</span><span class="ident" id="3000628">w</span><span class="op" id="3000629">,</span>&nbsp;<span class="ident" id="3000631">err</span><span class="op" id="3000634">.</span><span class="ident" id="3000635">Error</span><span class="op" id="3000640">(</span><span class="op" id="3000641">)</span><span class="op" id="3000642">,</span>&nbsp;<span class="ident" id="3000644">StatusInternalServerError</span><span class="op" id="3000669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000673">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3000681">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3000685">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000718">sendSize</span>&nbsp;<span class="op" id="3000727">:=</span>&nbsp;<span class="ident" id="3000730">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000736">var</span>&nbsp;<span class="ident" id="3000740">sendContent</span>&nbsp;<span class="ident" id="3000752">io</span><span class="op" id="3000754">.</span><span class="ident" id="3000755">Reader</span>&nbsp;<span class="op" id="3000762">=</span>&nbsp;<span class="ident" id="3000764">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000773">if</span>&nbsp;<span class="ident" id="3000776">size</span>&nbsp;<span class="op" id="3000781">&gt;=</span>&nbsp;<span class="num" id="3000784">0</span>&nbsp;<span class="op" id="3000786">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000790">ranges</span><span class="op" id="3000796">,</span>&nbsp;<span class="ident" id="3000798">err</span>&nbsp;<span class="op" id="3000802">:=</span>&nbsp;<span class="ident" id="3000805">parseRange</span><span class="op" id="3000815">(</span><span class="ident" id="3000816">rangeReq</span><span class="op" id="3000824">,</span>&nbsp;<span class="ident" id="3000826">size</span><span class="op" id="3000830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000834">if</span>&nbsp;<span class="ident" id="3000837">err</span>&nbsp;<span class="op" id="3000841">!=</span>&nbsp;<span class="ident" id="3000844">nil</span>&nbsp;<span class="op" id="3000848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3000853">Error</span><span class="op" id="3000858">(</span><span class="ident" id="3000859">w</span><span class="op" id="3000860">,</span>&nbsp;<span class="ident" id="3000862">err</span><span class="op" id="3000865">.</span><span class="ident" id="3000866">Error</span><span class="op" id="3000871">(</span><span class="op" id="3000872">)</span><span class="op" id="3000873">,</span>&nbsp;<span class="ident" id="3000875">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3000909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000914">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3000923">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3000927">if</span>&nbsp;<span class="ident" id="3000930">sumRangesSize</span><span class="op" id="3000943">(</span><span class="ident" id="3000944">ranges</span><span class="op" id="3000950">)</span>&nbsp;<span class="op" id="3000952">&gt;</span>&nbsp;<span class="ident" id="3000954">size</span>&nbsp;<span class="op" id="3000959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3000964">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001014">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001059">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001109">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001155">ranges</span>&nbsp;<span class="op" id="3001162">=</span>&nbsp;<span class="ident" id="3001164">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3001170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3001174">switch</span>&nbsp;<span class="op" id="3001181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3001185">case</span>&nbsp;<span class="builtinfunc" id="3001190">len</span><span class="op" id="3001193">(</span><span class="ident" id="3001194">ranges</span><span class="op" id="3001200">)</span>&nbsp;<span class="op" id="3001202">==</span>&nbsp;<span class="num" id="3001205">1</span><span class="op" id="3001206">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001211">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001242">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001303">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001359">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001415">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001470">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001523">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001579">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001607">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001617">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001675">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001733">ra</span>&nbsp;<span class="op" id="3001736">:=</span>&nbsp;<span class="ident" id="3001739">ranges</span><span class="op" id="3001745">[</span><span class="num" id="3001746">0</span><span class="op" id="3001747">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3001752">if</span>&nbsp;<span class="ident" id="3001755">_</span><span class="op" id="3001756">,</span>&nbsp;<span class="ident" id="3001758">err</span>&nbsp;<span class="op" id="3001762">:=</span>&nbsp;<span class="ident" id="3001765">content</span><span class="op" id="3001772">.</span><span class="ident" id="3001773">Seek</span><span class="op" id="3001777">(</span><span class="ident" id="3001778">ra</span><span class="op" id="3001780">.</span><span class="ident" id="3001781">start</span><span class="op" id="3001786">,</span>&nbsp;<span class="ident" id="3001788">os</span><span class="op" id="3001790">.</span><span class="ident" id="3001791">SEEK_SET</span><span class="op" id="3001799">)</span><span class="op" id="3001800">;</span>&nbsp;<span class="ident" id="3001802">err</span>&nbsp;<span class="op" id="3001806">!=</span>&nbsp;<span class="ident" id="3001809">nil</span>&nbsp;<span class="op" id="3001813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001819">Error</span><span class="op" id="3001824">(</span><span class="ident" id="3001825">w</span><span class="op" id="3001826">,</span>&nbsp;<span class="ident" id="3001828">err</span><span class="op" id="3001831">.</span><span class="ident" id="3001832">Error</span><span class="op" id="3001837">(</span><span class="op" id="3001838">)</span><span class="op" id="3001839">,</span>&nbsp;<span class="ident" id="3001841">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3001875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3001881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3001891">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001896">sendSize</span>&nbsp;<span class="op" id="3001905">=</span>&nbsp;<span class="ident" id="3001907">ra</span><span class="op" id="3001909">.</span><span class="ident" id="3001910">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001920">code</span>&nbsp;<span class="op" id="3001925">=</span>&nbsp;<span class="ident" id="3001927">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001951">w</span><span class="op" id="3001952">.</span><span class="ident" id="3001953">Header</span><span class="op" id="3001959">(</span><span class="op" id="3001960">)</span><span class="op" id="3001961">.</span><span class="ident" id="3001962">Set</span><span class="op" id="3001965">(</span><span class="string" id="3001966">&#34;Content-Range&#34;</span><span class="op" id="3001981">,</span>&nbsp;<span class="ident" id="3001983">ra</span><span class="op" id="3001985">.</span><span class="ident" id="3001986">contentRange</span><span class="op" id="3001998">(</span><span class="ident" id="3001999">size</span><span class="op" id="3002003">)</span><span class="op" id="3002004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002008">case</span>&nbsp;<span class="builtinfunc" id="3002013">len</span><span class="op" id="3002016">(</span><span class="ident" id="3002017">ranges</span><span class="op" id="3002023">)</span>&nbsp;<span class="op" id="3002025">&gt;</span>&nbsp;<span class="num" id="3002027">1</span><span class="op" id="3002028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002033">sendSize</span>&nbsp;<span class="op" id="3002042">=</span>&nbsp;<span class="ident" id="3002044">rangesMIMESize</span><span class="op" id="3002058">(</span><span class="ident" id="3002059">ranges</span><span class="op" id="3002065">,</span>&nbsp;<span class="ident" id="3002067">ctype</span><span class="op" id="3002072">,</span>&nbsp;<span class="ident" id="3002074">size</span><span class="op" id="3002078">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002083">code</span>&nbsp;<span class="op" id="3002088">=</span>&nbsp;<span class="ident" id="3002090">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002115">pr</span><span class="op" id="3002117">,</span>&nbsp;<span class="ident" id="3002119">pw</span>&nbsp;<span class="op" id="3002122">:=</span>&nbsp;<span class="ident" id="3002125">io</span><span class="op" id="3002127">.</span><span class="ident" id="3002128">Pipe</span><span class="op" id="3002132">(</span><span class="op" id="3002133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002138">mw</span>&nbsp;<span class="op" id="3002141">:=</span>&nbsp;<span class="ident" id="3002144">multipart</span><span class="op" id="3002153">.</span><span class="ident" id="3002154">NewWriter</span><span class="op" id="3002163">(</span><span class="ident" id="3002164">pw</span><span class="op" id="3002166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002171">w</span><span class="op" id="3002172">.</span><span class="ident" id="3002173">Header</span><span class="op" id="3002179">(</span><span class="op" id="3002180">)</span><span class="op" id="3002181">.</span><span class="ident" id="3002182">Set</span><span class="op" id="3002185">(</span><span class="string" id="3002186">&#34;Content-Type&#34;</span><span class="op" id="3002200">,</span>&nbsp;<span class="string" id="3002202">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="3002235">+</span><span class="ident" id="3002236">mw</span><span class="op" id="3002238">.</span><span class="ident" id="3002239">Boundary</span><span class="op" id="3002247">(</span><span class="op" id="3002248">)</span><span class="op" id="3002249">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002254">sendContent</span>&nbsp;<span class="op" id="3002266">=</span>&nbsp;<span class="ident" id="3002268">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002274">defer</span>&nbsp;<span class="ident" id="3002280">pr</span><span class="op" id="3002282">.</span><span class="ident" id="3002283">Close</span><span class="op" id="3002288">(</span><span class="op" id="3002289">)</span>&nbsp;<span class="comment" id="3002291">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002363">go</span>&nbsp;<span class="keyword" id="3002366">func</span><span class="op" id="3002370">(</span><span class="op" id="3002371">)</span>&nbsp;<span class="op" id="3002373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002379">for</span>&nbsp;<span class="ident" id="3002383">_</span><span class="op" id="3002384">,</span>&nbsp;<span class="ident" id="3002386">ra</span>&nbsp;<span class="op" id="3002389">:=</span>&nbsp;<span class="keyword" id="3002392">range</span>&nbsp;<span class="ident" id="3002398">ranges</span>&nbsp;<span class="op" id="3002405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002412">part</span><span class="op" id="3002416">,</span>&nbsp;<span class="ident" id="3002418">err</span>&nbsp;<span class="op" id="3002422">:=</span>&nbsp;<span class="ident" id="3002425">mw</span><span class="op" id="3002427">.</span><span class="ident" id="3002428">CreatePart</span><span class="op" id="3002438">(</span><span class="ident" id="3002439">ra</span><span class="op" id="3002441">.</span><span class="ident" id="3002442">mimeHeader</span><span class="op" id="3002452">(</span><span class="ident" id="3002453">ctype</span><span class="op" id="3002458">,</span>&nbsp;<span class="ident" id="3002460">size</span><span class="op" id="3002464">)</span><span class="op" id="3002465">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002472">if</span>&nbsp;<span class="ident" id="3002475">err</span>&nbsp;<span class="op" id="3002479">!=</span>&nbsp;<span class="ident" id="3002482">nil</span>&nbsp;<span class="op" id="3002486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002494">pw</span><span class="op" id="3002496">.</span><span class="ident" id="3002497">CloseWithError</span><span class="op" id="3002511">(</span><span class="ident" id="3002512">err</span><span class="op" id="3002515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002523">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002542">if</span>&nbsp;<span class="ident" id="3002545">_</span><span class="op" id="3002546">,</span>&nbsp;<span class="ident" id="3002548">err</span>&nbsp;<span class="op" id="3002552">:=</span>&nbsp;<span class="ident" id="3002555">content</span><span class="op" id="3002562">.</span><span class="ident" id="3002563">Seek</span><span class="op" id="3002567">(</span><span class="ident" id="3002568">ra</span><span class="op" id="3002570">.</span><span class="ident" id="3002571">start</span><span class="op" id="3002576">,</span>&nbsp;<span class="ident" id="3002578">os</span><span class="op" id="3002580">.</span><span class="ident" id="3002581">SEEK_SET</span><span class="op" id="3002589">)</span><span class="op" id="3002590">;</span>&nbsp;<span class="ident" id="3002592">err</span>&nbsp;<span class="op" id="3002596">!=</span>&nbsp;<span class="ident" id="3002599">nil</span>&nbsp;<span class="op" id="3002603">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002611">pw</span><span class="op" id="3002613">.</span><span class="ident" id="3002614">CloseWithError</span><span class="op" id="3002628">(</span><span class="ident" id="3002629">err</span><span class="op" id="3002632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002640">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002659">if</span>&nbsp;<span class="ident" id="3002662">_</span><span class="op" id="3002663">,</span>&nbsp;<span class="ident" id="3002665">err</span>&nbsp;<span class="op" id="3002669">:=</span>&nbsp;<span class="ident" id="3002672">io</span><span class="op" id="3002674">.</span><span class="ident" id="3002675">CopyN</span><span class="op" id="3002680">(</span><span class="ident" id="3002681">part</span><span class="op" id="3002685">,</span>&nbsp;<span class="ident" id="3002687">content</span><span class="op" id="3002694">,</span>&nbsp;<span class="ident" id="3002696">ra</span><span class="op" id="3002698">.</span><span class="ident" id="3002699">length</span><span class="op" id="3002705">)</span><span class="op" id="3002706">;</span>&nbsp;<span class="ident" id="3002708">err</span>&nbsp;<span class="op" id="3002712">!=</span>&nbsp;<span class="ident" id="3002715">nil</span>&nbsp;<span class="op" id="3002719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002727">pw</span><span class="op" id="3002729">.</span><span class="ident" id="3002730">CloseWithError</span><span class="op" id="3002744">(</span><span class="ident" id="3002745">err</span><span class="op" id="3002748">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002756">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002780">mw</span><span class="op" id="3002782">.</span><span class="ident" id="3002783">Close</span><span class="op" id="3002788">(</span><span class="op" id="3002789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002795">pw</span><span class="op" id="3002797">.</span><span class="ident" id="3002798">Close</span><span class="op" id="3002803">(</span><span class="op" id="3002804">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002809">}</span><span class="op" id="3002810">(</span><span class="op" id="3002811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002820">w</span><span class="op" id="3002821">.</span><span class="ident" id="3002822">Header</span><span class="op" id="3002828">(</span><span class="op" id="3002829">)</span><span class="op" id="3002830">.</span><span class="ident" id="3002831">Set</span><span class="op" id="3002834">(</span><span class="string" id="3002835">&#34;Accept-Ranges&#34;</span><span class="op" id="3002850">,</span>&nbsp;<span class="string" id="3002852">&#34;bytes&#34;</span><span class="op" id="3002859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002863">if</span>&nbsp;<span class="ident" id="3002866">w</span><span class="op" id="3002867">.</span><span class="ident" id="3002868">Header</span><span class="op" id="3002874">(</span><span class="op" id="3002875">)</span><span class="op" id="3002876">.</span><span class="ident" id="3002877">Get</span><span class="op" id="3002880">(</span><span class="string" id="3002881">&#34;Content-Encoding&#34;</span><span class="op" id="3002899">)</span>&nbsp;<span class="op" id="3002901">==</span>&nbsp;<span class="string" id="3002904">&#34;&#34;</span>&nbsp;<span class="op" id="3002907">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002912">w</span><span class="op" id="3002913">.</span><span class="ident" id="3002914">Header</span><span class="op" id="3002920">(</span><span class="op" id="3002921">)</span><span class="op" id="3002922">.</span><span class="ident" id="3002923">Set</span><span class="op" id="3002926">(</span><span class="string" id="3002927">&#34;Content-Length&#34;</span><span class="op" id="3002943">,</span>&nbsp;<span class="ident" id="3002945">strconv</span><span class="op" id="3002952">.</span><span class="ident" id="3002953">FormatInt</span><span class="op" id="3002962">(</span><span class="ident" id="3002963">sendSize</span><span class="op" id="3002971">,</span>&nbsp;<span class="num" id="3002973">10</span><span class="op" id="3002975">)</span><span class="op" id="3002976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002987">w</span><span class="op" id="3002988">.</span><span class="ident" id="3002989">WriteHeader</span><span class="op" id="3003000">(</span><span class="ident" id="3003001">code</span><span class="op" id="3003005">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003009">if</span>&nbsp;<span class="ident" id="3003012">r</span><span class="op" id="3003013">.</span><span class="ident" id="3003014">Method</span>&nbsp;<span class="op" id="3003021">!=</span>&nbsp;<span class="string" id="3003024">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3003031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3003035">io</span><span class="op" id="3003037">.</span><span class="ident" id="3003038">CopyN</span><span class="op" id="3003043">(</span><span class="ident" id="3003044">w</span><span class="op" id="3003045">,</span>&nbsp;<span class="ident" id="3003047">sendContent</span><span class="op" id="3003058">,</span>&nbsp;<span class="ident" id="3003060">sendSize</span><span class="op" id="3003068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003071">}</span><br>
<span class="lineno"></span><span class="op" id="3003073">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3003076">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="3003155">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="3003212">func</span>&nbsp;<span class="ident" id="3003217">checkLastModified</span><span class="op" id="3003234">(</span><span class="ident" id="3003235">w</span>&nbsp;<span class="ident" id="3003237">ResponseWriter</span><span class="op" id="3003251">,</span>&nbsp;<span class="ident" id="3003253">r</span>&nbsp;<span class="op" id="3003255">*</span><span class="ident" id="3003256">Request</span><span class="op" id="3003263">,</span>&nbsp;<span class="ident" id="3003265">modtime</span>&nbsp;<span class="ident" id="3003273">time</span><span class="op" id="3003277">.</span><span class="ident" id="3003278">Time</span><span class="op" id="3003282">)</span>&nbsp;<span class="builtintype" id="3003284">bool</span>&nbsp;<span class="op" id="3003289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003292">if</span>&nbsp;<span class="ident" id="3003295">modtime</span><span class="op" id="3003302">.</span><span class="ident" id="3003303">IsZero</span><span class="op" id="3003309">(</span><span class="op" id="3003310">)</span>&nbsp;<span class="op" id="3003312">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003316">return</span>&nbsp;<span class="builtintype" id="3003323">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003334">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003398">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003466">if</span>&nbsp;<span class="ident" id="3003469">t</span><span class="op" id="3003470">,</span>&nbsp;<span class="ident" id="3003472">err</span>&nbsp;<span class="op" id="3003476">:=</span>&nbsp;<span class="ident" id="3003479">time</span><span class="op" id="3003483">.</span><span class="ident" id="3003484">Parse</span><span class="op" id="3003489">(</span><span class="ident" id="3003490">TimeFormat</span><span class="op" id="3003500">,</span>&nbsp;<span class="ident" id="3003502">r</span><span class="op" id="3003503">.</span><span class="ident" id="3003504">Header</span><span class="op" id="3003510">.</span><span class="ident" id="3003511">Get</span><span class="op" id="3003514">(</span><span class="string" id="3003515">&#34;If-Modified-Since&#34;</span><span class="op" id="3003534">)</span><span class="op" id="3003535">)</span><span class="op" id="3003536">;</span>&nbsp;<span class="ident" id="3003538">err</span>&nbsp;<span class="op" id="3003542">==</span>&nbsp;<span class="ident" id="3003545">nil</span>&nbsp;<span class="op" id="3003549">&amp;&amp;</span>&nbsp;<span class="ident" id="3003552">modtime</span><span class="op" id="3003559">.</span><span class="ident" id="3003560">Before</span><span class="op" id="3003566">(</span><span class="ident" id="3003567">t</span><span class="op" id="3003568">.</span><span class="ident" id="3003569">Add</span><span class="op" id="3003572">(</span><span class="num" id="3003573">1</span><span class="op" id="3003574">*</span><span class="ident" id="3003575">time</span><span class="op" id="3003579">.</span><span class="ident" id="3003580">Second</span><span class="op" id="3003586">)</span><span class="op" id="3003587">)</span>&nbsp;<span class="op" id="3003589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3003593">h</span>&nbsp;<span class="op" id="3003595">:=</span>&nbsp;<span class="ident" id="3003598">w</span><span class="op" id="3003599">.</span><span class="ident" id="3003600">Header</span><span class="op" id="3003606">(</span><span class="op" id="3003607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3003611">delete</span><span class="op" id="3003617">(</span><span class="ident" id="3003618">h</span><span class="op" id="3003619">,</span>&nbsp;<span class="string" id="3003621">&#34;Content-Type&#34;</span><span class="op" id="3003635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3003639">delete</span><span class="op" id="3003645">(</span><span class="ident" id="3003646">h</span><span class="op" id="3003647">,</span>&nbsp;<span class="string" id="3003649">&#34;Content-Length&#34;</span><span class="op" id="3003665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3003669">w</span><span class="op" id="3003670">.</span><span class="ident" id="3003671">WriteHeader</span><span class="op" id="3003682">(</span><span class="ident" id="3003683">StatusNotModified</span><span class="op" id="3003700">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003704">return</span>&nbsp;<span class="builtintype" id="3003711">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3003720">w</span><span class="op" id="3003721">.</span><span class="ident" id="3003722">Header</span><span class="op" id="3003728">(</span><span class="op" id="3003729">)</span><span class="op" id="3003730">.</span><span class="ident" id="3003731">Set</span><span class="op" id="3003734">(</span><span class="string" id="3003735">&#34;Last-Modified&#34;</span><span class="op" id="3003750">,</span>&nbsp;<span class="ident" id="3003752">modtime</span><span class="op" id="3003759">.</span><span class="ident" id="3003760">UTC</span><span class="op" id="3003763">(</span><span class="op" id="3003764">)</span><span class="op" id="3003765">.</span><span class="ident" id="3003766">Format</span><span class="op" id="3003772">(</span><span class="ident" id="3003773">TimeFormat</span><span class="op" id="3003783">)</span><span class="op" id="3003784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003787">return</span>&nbsp;<span class="builtintype" id="3003794">false</span><br>
<span class="lineno"></span><span class="op" id="3003800">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3003803">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="3003862">//</span><br>
<span class="lineno"></span><span class="comment" id="3003865">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3003925">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="3003994">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="3004052">//</span><br>
<span class="lineno"></span><span class="comment" id="3004055">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3004126">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="3004174">func</span>&nbsp;<span class="ident" id="3004179">checkETag</span><span class="op" id="3004188">(</span><span class="ident" id="3004189">w</span>&nbsp;<span class="ident" id="3004191">ResponseWriter</span><span class="op" id="3004205">,</span>&nbsp;<span class="ident" id="3004207">r</span>&nbsp;<span class="op" id="3004209">*</span><span class="ident" id="3004210">Request</span><span class="op" id="3004217">,</span>&nbsp;<span class="ident" id="3004219">modtime</span>&nbsp;<span class="ident" id="3004227">time</span><span class="op" id="3004231">.</span><span class="ident" id="3004232">Time</span><span class="op" id="3004236">)</span>&nbsp;<span class="op" id="3004238">(</span><span class="ident" id="3004239">rangeReq</span>&nbsp;<span class="builtintype" id="3004248">string</span><span class="op" id="3004254">,</span>&nbsp;<span class="ident" id="3004256">done</span>&nbsp;<span class="builtintype" id="3004261">bool</span><span class="op" id="3004265">)</span>&nbsp;<span class="op" id="3004267">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004270">etag</span>&nbsp;<span class="op" id="3004275">:=</span>&nbsp;<span class="ident" id="3004278">w</span><span class="op" id="3004279">.</span><span class="ident" id="3004280">Header</span><span class="op" id="3004286">(</span><span class="op" id="3004287">)</span><span class="op" id="3004288">.</span><span class="ident" id="3004289">get</span><span class="op" id="3004292">(</span><span class="string" id="3004293">&#34;Etag&#34;</span><span class="op" id="3004299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004302">rangeReq</span>&nbsp;<span class="op" id="3004311">=</span>&nbsp;<span class="ident" id="3004313">r</span><span class="op" id="3004314">.</span><span class="ident" id="3004315">Header</span><span class="op" id="3004321">.</span><span class="ident" id="3004322">get</span><span class="op" id="3004325">(</span><span class="string" id="3004326">&#34;Range&#34;</span><span class="op" id="3004333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004337">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004406">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004436">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004519">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004538">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004573">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004636">if</span>&nbsp;<span class="ident" id="3004639">ir</span>&nbsp;<span class="op" id="3004642">:=</span>&nbsp;<span class="ident" id="3004645">r</span><span class="op" id="3004646">.</span><span class="ident" id="3004647">Header</span><span class="op" id="3004653">.</span><span class="ident" id="3004654">get</span><span class="op" id="3004657">(</span><span class="string" id="3004658">&#34;If-Range&#34;</span><span class="op" id="3004668">)</span><span class="op" id="3004669">;</span>&nbsp;<span class="ident" id="3004671">ir</span>&nbsp;<span class="op" id="3004674">!=</span>&nbsp;<span class="string" id="3004677">&#34;&#34;</span>&nbsp;<span class="op" id="3004680">&amp;&amp;</span>&nbsp;<span class="ident" id="3004683">ir</span>&nbsp;<span class="op" id="3004686">!=</span>&nbsp;<span class="ident" id="3004689">etag</span>&nbsp;<span class="op" id="3004694">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004698">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004770">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004820">timeMatches</span>&nbsp;<span class="op" id="3004832">:=</span>&nbsp;<span class="builtintype" id="3004835">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004843">if</span>&nbsp;<span class="op" id="3004846">!</span><span class="ident" id="3004847">modtime</span><span class="op" id="3004854">.</span><span class="ident" id="3004855">IsZero</span><span class="op" id="3004861">(</span><span class="op" id="3004862">)</span>&nbsp;<span class="op" id="3004864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004869">if</span>&nbsp;<span class="ident" id="3004872">t</span><span class="op" id="3004873">,</span>&nbsp;<span class="ident" id="3004875">err</span>&nbsp;<span class="op" id="3004879">:=</span>&nbsp;<span class="ident" id="3004882">ParseTime</span><span class="op" id="3004891">(</span><span class="ident" id="3004892">ir</span><span class="op" id="3004894">)</span><span class="op" id="3004895">;</span>&nbsp;<span class="ident" id="3004897">err</span>&nbsp;<span class="op" id="3004901">==</span>&nbsp;<span class="ident" id="3004904">nil</span>&nbsp;<span class="op" id="3004908">&amp;&amp;</span>&nbsp;<span class="ident" id="3004911">t</span><span class="op" id="3004912">.</span><span class="ident" id="3004913">Unix</span><span class="op" id="3004917">(</span><span class="op" id="3004918">)</span>&nbsp;<span class="op" id="3004920">==</span>&nbsp;<span class="ident" id="3004923">modtime</span><span class="op" id="3004930">.</span><span class="ident" id="3004931">Unix</span><span class="op" id="3004935">(</span><span class="op" id="3004936">)</span>&nbsp;<span class="op" id="3004938">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004944">timeMatches</span>&nbsp;<span class="op" id="3004956">=</span>&nbsp;<span class="builtintype" id="3004958">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004974">if</span>&nbsp;<span class="op" id="3004977">!</span><span class="ident" id="3004978">timeMatches</span>&nbsp;<span class="op" id="3004990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004995">rangeReq</span>&nbsp;<span class="op" id="3005004">=</span>&nbsp;<span class="string" id="3005006">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005018">if</span>&nbsp;<span class="ident" id="3005021">inm</span>&nbsp;<span class="op" id="3005025">:=</span>&nbsp;<span class="ident" id="3005028">r</span><span class="op" id="3005029">.</span><span class="ident" id="3005030">Header</span><span class="op" id="3005036">.</span><span class="ident" id="3005037">get</span><span class="op" id="3005040">(</span><span class="string" id="3005041">&#34;If-None-Match&#34;</span><span class="op" id="3005056">)</span><span class="op" id="3005057">;</span>&nbsp;<span class="ident" id="3005059">inm</span>&nbsp;<span class="op" id="3005063">!=</span>&nbsp;<span class="string" id="3005066">&#34;&#34;</span>&nbsp;<span class="op" id="3005069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005073">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005094">if</span>&nbsp;<span class="ident" id="3005097">etag</span>&nbsp;<span class="op" id="3005102">==</span>&nbsp;<span class="string" id="3005105">&#34;&#34;</span>&nbsp;<span class="op" id="3005108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005113">return</span>&nbsp;<span class="ident" id="3005120">rangeReq</span><span class="op" id="3005128">,</span>&nbsp;<span class="builtintype" id="3005130">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005143">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005205">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005258">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005318">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005378">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005433">if</span>&nbsp;<span class="ident" id="3005436">r</span><span class="op" id="3005437">.</span><span class="ident" id="3005438">Method</span>&nbsp;<span class="op" id="3005445">!=</span>&nbsp;<span class="string" id="3005448">&#34;GET&#34;</span>&nbsp;<span class="op" id="3005454">&amp;&amp;</span>&nbsp;<span class="ident" id="3005457">r</span><span class="op" id="3005458">.</span><span class="ident" id="3005459">Method</span>&nbsp;<span class="op" id="3005466">!=</span>&nbsp;<span class="string" id="3005469">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3005476">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005481">return</span>&nbsp;<span class="ident" id="3005488">rangeReq</span><span class="op" id="3005496">,</span>&nbsp;<span class="builtintype" id="3005498">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005511">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005577">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005644">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005672">if</span>&nbsp;<span class="ident" id="3005675">inm</span>&nbsp;<span class="op" id="3005679">==</span>&nbsp;<span class="ident" id="3005682">etag</span>&nbsp;<span class="op" id="3005687">||</span>&nbsp;<span class="ident" id="3005690">inm</span>&nbsp;<span class="op" id="3005694">==</span>&nbsp;<span class="string" id="3005697">&#34;*&#34;</span>&nbsp;<span class="op" id="3005701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005706">h</span>&nbsp;<span class="op" id="3005708">:=</span>&nbsp;<span class="ident" id="3005711">w</span><span class="op" id="3005712">.</span><span class="ident" id="3005713">Header</span><span class="op" id="3005719">(</span><span class="op" id="3005720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3005725">delete</span><span class="op" id="3005731">(</span><span class="ident" id="3005732">h</span><span class="op" id="3005733">,</span>&nbsp;<span class="string" id="3005735">&#34;Content-Type&#34;</span><span class="op" id="3005749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3005754">delete</span><span class="op" id="3005760">(</span><span class="ident" id="3005761">h</span><span class="op" id="3005762">,</span>&nbsp;<span class="string" id="3005764">&#34;Content-Length&#34;</span><span class="op" id="3005780">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005785">w</span><span class="op" id="3005786">.</span><span class="ident" id="3005787">WriteHeader</span><span class="op" id="3005798">(</span><span class="ident" id="3005799">StatusNotModified</span><span class="op" id="3005816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005821">return</span>&nbsp;<span class="string" id="3005828">&#34;&#34;</span><span class="op" id="3005830">,</span>&nbsp;<span class="builtintype" id="3005832">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005845">return</span>&nbsp;<span class="ident" id="3005852">rangeReq</span><span class="op" id="3005860">,</span>&nbsp;<span class="builtintype" id="3005862">false</span><br>
<span class="lineno">340</span><span class="op" id="3005868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3005871">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="3005921">func</span>&nbsp;<span class="ident" id="3005926">serveFile</span><span class="op" id="3005935">(</span><span class="ident" id="3005936">w</span>&nbsp;<span class="ident" id="3005938">ResponseWriter</span><span class="op" id="3005952">,</span>&nbsp;<span class="ident" id="3005954">r</span>&nbsp;<span class="op" id="3005956">*</span><span class="ident" id="3005957">Request</span><span class="op" id="3005964">,</span>&nbsp;<span class="ident" id="3005966">fs</span>&nbsp;<span class="ident" id="3005969">FileSystem</span><span class="op" id="3005979">,</span>&nbsp;<span class="ident" id="3005981">name</span>&nbsp;<span class="builtintype" id="3005986">string</span><span class="op" id="3005992">,</span>&nbsp;<span class="ident" id="3005994">redirect</span>&nbsp;<span class="builtintype" id="3006003">bool</span><span class="op" id="3006007">)</span>&nbsp;<span class="op" id="3006009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006012">const</span>&nbsp;<span class="ident" id="3006018">indexPage</span>&nbsp;<span class="op" id="3006028">=</span>&nbsp;<span class="string" id="3006030">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006046">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006082">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006150">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006205">if</span>&nbsp;<span class="ident" id="3006208">strings</span><span class="op" id="3006215">.</span><span class="ident" id="3006216">HasSuffix</span><span class="op" id="3006225">(</span><span class="ident" id="3006226">r</span><span class="op" id="3006227">.</span><span class="ident" id="3006228">URL</span><span class="op" id="3006231">.</span><span class="ident" id="3006232">Path</span><span class="op" id="3006236">,</span>&nbsp;<span class="ident" id="3006238">indexPage</span><span class="op" id="3006247">)</span>&nbsp;<span class="op" id="3006249">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006253">localRedirect</span><span class="op" id="3006266">(</span><span class="ident" id="3006267">w</span><span class="op" id="3006268">,</span>&nbsp;<span class="ident" id="3006270">r</span><span class="op" id="3006271">,</span>&nbsp;<span class="string" id="3006273">&#34;./&#34;</span><span class="op" id="3006277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006293">f</span><span class="op" id="3006294">,</span>&nbsp;<span class="ident" id="3006296">err</span>&nbsp;<span class="op" id="3006300">:=</span>&nbsp;<span class="ident" id="3006303">fs</span><span class="op" id="3006305">.</span><span class="ident" id="3006306">Open</span><span class="op" id="3006310">(</span><span class="ident" id="3006311">name</span><span class="op" id="3006315">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006318">if</span>&nbsp;<span class="ident" id="3006321">err</span>&nbsp;<span class="op" id="3006325">!=</span>&nbsp;<span class="ident" id="3006328">nil</span>&nbsp;<span class="op" id="3006332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006336">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006367">NotFound</span><span class="op" id="3006375">(</span><span class="ident" id="3006376">w</span><span class="op" id="3006377">,</span>&nbsp;<span class="ident" id="3006379">r</span><span class="op" id="3006380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006384">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006392">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006395">defer</span>&nbsp;<span class="ident" id="3006401">f</span><span class="op" id="3006402">.</span><span class="ident" id="3006403">Close</span><span class="op" id="3006408">(</span><span class="op" id="3006409">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006413">d</span><span class="op" id="3006414">,</span>&nbsp;<span class="ident" id="3006416">err1</span>&nbsp;<span class="op" id="3006421">:=</span>&nbsp;<span class="ident" id="3006424">f</span><span class="op" id="3006425">.</span><span class="ident" id="3006426">Stat</span><span class="op" id="3006430">(</span><span class="op" id="3006431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006434">if</span>&nbsp;<span class="ident" id="3006437">err1</span>&nbsp;<span class="op" id="3006442">!=</span>&nbsp;<span class="ident" id="3006445">nil</span>&nbsp;<span class="op" id="3006449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006453">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006484">NotFound</span><span class="op" id="3006492">(</span><span class="ident" id="3006493">w</span><span class="op" id="3006494">,</span>&nbsp;<span class="ident" id="3006496">r</span><span class="op" id="3006497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006501">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006513">if</span>&nbsp;<span class="ident" id="3006516">redirect</span>&nbsp;<span class="op" id="3006525">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006529">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006588">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006625">url</span>&nbsp;<span class="op" id="3006629">:=</span>&nbsp;<span class="ident" id="3006632">r</span><span class="op" id="3006633">.</span><span class="ident" id="3006634">URL</span><span class="op" id="3006637">.</span><span class="ident" id="3006638">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006645">if</span>&nbsp;<span class="ident" id="3006648">d</span><span class="op" id="3006649">.</span><span class="ident" id="3006650">IsDir</span><span class="op" id="3006655">(</span><span class="op" id="3006656">)</span>&nbsp;<span class="op" id="3006658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006663">if</span>&nbsp;<span class="ident" id="3006666">url</span><span class="op" id="3006669">[</span><span class="builtinfunc" id="3006670">len</span><span class="op" id="3006673">(</span><span class="ident" id="3006674">url</span><span class="op" id="3006677">)</span><span class="op" id="3006678">-</span><span class="num" id="3006679">1</span><span class="op" id="3006680">]</span>&nbsp;<span class="op" id="3006682">!=</span>&nbsp;<span class="string" id="3006685">&#39;/&#39;</span>&nbsp;<span class="op" id="3006689">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006695">localRedirect</span><span class="op" id="3006708">(</span><span class="ident" id="3006709">w</span><span class="op" id="3006710">,</span>&nbsp;<span class="ident" id="3006712">r</span><span class="op" id="3006713">,</span>&nbsp;<span class="ident" id="3006715">path</span><span class="op" id="3006719">.</span><span class="ident" id="3006720">Base</span><span class="op" id="3006724">(</span><span class="ident" id="3006725">url</span><span class="op" id="3006728">)</span><span class="op" id="3006729">+</span><span class="string" id="3006730">&#34;/&#34;</span><span class="op" id="3006733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006739">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006753">}</span>&nbsp;<span class="keyword" id="3006755">else</span>&nbsp;<span class="op" id="3006760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006765">if</span>&nbsp;<span class="ident" id="3006768">url</span><span class="op" id="3006771">[</span><span class="builtinfunc" id="3006772">len</span><span class="op" id="3006775">(</span><span class="ident" id="3006776">url</span><span class="op" id="3006779">)</span><span class="op" id="3006780">-</span><span class="num" id="3006781">1</span><span class="op" id="3006782">]</span>&nbsp;<span class="op" id="3006784">==</span>&nbsp;<span class="string" id="3006787">&#39;/&#39;</span>&nbsp;<span class="op" id="3006791">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006797">localRedirect</span><span class="op" id="3006810">(</span><span class="ident" id="3006811">w</span><span class="op" id="3006812">,</span>&nbsp;<span class="ident" id="3006814">r</span><span class="op" id="3006815">,</span>&nbsp;<span class="string" id="3006817">&#34;../&#34;</span><span class="op" id="3006822">+</span><span class="ident" id="3006823">path</span><span class="op" id="3006827">.</span><span class="ident" id="3006828">Base</span><span class="op" id="3006832">(</span><span class="ident" id="3006833">url</span><span class="op" id="3006836">)</span><span class="op" id="3006837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006843">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006860">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006864">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006921">if</span>&nbsp;<span class="ident" id="3006924">d</span><span class="op" id="3006925">.</span><span class="ident" id="3006926">IsDir</span><span class="op" id="3006931">(</span><span class="op" id="3006932">)</span>&nbsp;<span class="op" id="3006934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006938">index</span>&nbsp;<span class="op" id="3006944">:=</span>&nbsp;<span class="ident" id="3006947">strings</span><span class="op" id="3006954">.</span><span class="ident" id="3006955">TrimSuffix</span><span class="op" id="3006965">(</span><span class="ident" id="3006966">name</span><span class="op" id="3006970">,</span>&nbsp;<span class="string" id="3006972">&#34;/&#34;</span><span class="op" id="3006975">)</span>&nbsp;<span class="op" id="3006977">+</span>&nbsp;<span class="ident" id="3006979">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006991">ff</span><span class="op" id="3006993">,</span>&nbsp;<span class="ident" id="3006995">err</span>&nbsp;<span class="op" id="3006999">:=</span>&nbsp;<span class="ident" id="3007002">fs</span><span class="op" id="3007004">.</span><span class="ident" id="3007005">Open</span><span class="op" id="3007009">(</span><span class="ident" id="3007010">index</span><span class="op" id="3007015">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007019">if</span>&nbsp;<span class="ident" id="3007022">err</span>&nbsp;<span class="op" id="3007026">==</span>&nbsp;<span class="ident" id="3007029">nil</span>&nbsp;<span class="op" id="3007033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007038">defer</span>&nbsp;<span class="ident" id="3007044">ff</span><span class="op" id="3007046">.</span><span class="ident" id="3007047">Close</span><span class="op" id="3007052">(</span><span class="op" id="3007053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007058">dd</span><span class="op" id="3007060">,</span>&nbsp;<span class="ident" id="3007062">err</span>&nbsp;<span class="op" id="3007066">:=</span>&nbsp;<span class="ident" id="3007069">ff</span><span class="op" id="3007071">.</span><span class="ident" id="3007072">Stat</span><span class="op" id="3007076">(</span><span class="op" id="3007077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007082">if</span>&nbsp;<span class="ident" id="3007085">err</span>&nbsp;<span class="op" id="3007089">==</span>&nbsp;<span class="ident" id="3007092">nil</span>&nbsp;<span class="op" id="3007096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007102">name</span>&nbsp;<span class="op" id="3007107">=</span>&nbsp;<span class="ident" id="3007109">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007119">d</span>&nbsp;<span class="op" id="3007121">=</span>&nbsp;<span class="ident" id="3007123">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007130">f</span>&nbsp;<span class="op" id="3007132">=</span>&nbsp;<span class="ident" id="3007134">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007147">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3007151">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007210">if</span>&nbsp;<span class="ident" id="3007213">d</span><span class="op" id="3007214">.</span><span class="ident" id="3007215">IsDir</span><span class="op" id="3007220">(</span><span class="op" id="3007221">)</span>&nbsp;<span class="op" id="3007223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007227">if</span>&nbsp;<span class="ident" id="3007230">checkLastModified</span><span class="op" id="3007247">(</span><span class="ident" id="3007248">w</span><span class="op" id="3007249">,</span>&nbsp;<span class="ident" id="3007251">r</span><span class="op" id="3007252">,</span>&nbsp;<span class="ident" id="3007254">d</span><span class="op" id="3007255">.</span><span class="ident" id="3007256">ModTime</span><span class="op" id="3007263">(</span><span class="op" id="3007264">)</span><span class="op" id="3007265">)</span>&nbsp;<span class="op" id="3007267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007272">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007285">dirList</span><span class="op" id="3007292">(</span><span class="ident" id="3007293">w</span><span class="op" id="3007294">,</span>&nbsp;<span class="ident" id="3007296">f</span><span class="op" id="3007297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3007313">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007359">sizeFunc</span>&nbsp;<span class="op" id="3007368">:=</span>&nbsp;<span class="keyword" id="3007371">func</span><span class="op" id="3007375">(</span><span class="op" id="3007376">)</span>&nbsp;<span class="op" id="3007378">(</span><span class="ident" id="3007379">int64</span><span class="op" id="3007384">,</span>&nbsp;<span class="builtintype" id="3007386">error</span><span class="op" id="3007391">)</span>&nbsp;<span class="op" id="3007393">{</span>&nbsp;<span class="keyword" id="3007395">return</span>&nbsp;<span class="ident" id="3007402">d</span><span class="op" id="3007403">.</span><span class="ident" id="3007404">Size</span><span class="op" id="3007408">(</span><span class="op" id="3007409">)</span><span class="op" id="3007410">,</span>&nbsp;<span class="ident" id="3007412">nil</span>&nbsp;<span class="op" id="3007416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007419">serveContent</span><span class="op" id="3007431">(</span><span class="ident" id="3007432">w</span><span class="op" id="3007433">,</span>&nbsp;<span class="ident" id="3007435">r</span><span class="op" id="3007436">,</span>&nbsp;<span class="ident" id="3007438">d</span><span class="op" id="3007439">.</span><span class="ident" id="3007440">Name</span><span class="op" id="3007444">(</span><span class="op" id="3007445">)</span><span class="op" id="3007446">,</span>&nbsp;<span class="ident" id="3007448">d</span><span class="op" id="3007449">.</span><span class="ident" id="3007450">ModTime</span><span class="op" id="3007457">(</span><span class="op" id="3007458">)</span><span class="op" id="3007459">,</span>&nbsp;<span class="ident" id="3007461">sizeFunc</span><span class="op" id="3007469">,</span>&nbsp;<span class="ident" id="3007471">f</span><span class="op" id="3007472">)</span><br>
<span class="lineno"></span><span class="op" id="3007474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3007477">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3007530">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="3007606">func</span>&nbsp;<span class="ident" id="3007611">localRedirect</span><span class="op" id="3007624">(</span><span class="ident" id="3007625">w</span>&nbsp;<span class="ident" id="3007627">ResponseWriter</span><span class="op" id="3007641">,</span>&nbsp;<span class="ident" id="3007643">r</span>&nbsp;<span class="op" id="3007645">*</span><span class="ident" id="3007646">Request</span><span class="op" id="3007653">,</span>&nbsp;<span class="ident" id="3007655">newPath</span>&nbsp;<span class="builtintype" id="3007663">string</span><span class="op" id="3007669">)</span>&nbsp;<span class="op" id="3007671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007674">if</span>&nbsp;<span class="ident" id="3007677">q</span>&nbsp;<span class="op" id="3007679">:=</span>&nbsp;<span class="ident" id="3007682">r</span><span class="op" id="3007683">.</span><span class="ident" id="3007684">URL</span><span class="op" id="3007687">.</span><span class="ident" id="3007688">RawQuery</span><span class="op" id="3007696">;</span>&nbsp;<span class="ident" id="3007698">q</span>&nbsp;<span class="op" id="3007700">!=</span>&nbsp;<span class="string" id="3007703">&#34;&#34;</span>&nbsp;<span class="op" id="3007706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007710">newPath</span>&nbsp;<span class="op" id="3007718">+=</span>&nbsp;<span class="string" id="3007721">&#34;?&#34;</span>&nbsp;<span class="op" id="3007725">+</span>&nbsp;<span class="ident" id="3007727">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007733">w</span><span class="op" id="3007734">.</span><span class="ident" id="3007735">Header</span><span class="op" id="3007741">(</span><span class="op" id="3007742">)</span><span class="op" id="3007743">.</span><span class="ident" id="3007744">Set</span><span class="op" id="3007747">(</span><span class="string" id="3007748">&#34;Location&#34;</span><span class="op" id="3007758">,</span>&nbsp;<span class="ident" id="3007760">newPath</span><span class="op" id="3007767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007770">w</span><span class="op" id="3007771">.</span><span class="ident" id="3007772">WriteHeader</span><span class="op" id="3007783">(</span><span class="ident" id="3007784">StatusMovedPermanently</span><span class="op" id="3007806">)</span><br>
<span class="lineno"></span><span class="op" id="3007808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="3007811">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="3007897">func</span>&nbsp;<span class="ident" id="3007902">ServeFile</span><span class="op" id="3007911">(</span><span class="ident" id="3007912">w</span>&nbsp;<span class="ident" id="3007914">ResponseWriter</span><span class="op" id="3007928">,</span>&nbsp;<span class="ident" id="3007930">r</span>&nbsp;<span class="op" id="3007932">*</span><span class="ident" id="3007933">Request</span><span class="op" id="3007940">,</span>&nbsp;<span class="ident" id="3007942">name</span>&nbsp;<span class="builtintype" id="3007947">string</span><span class="op" id="3007953">)</span>&nbsp;<span class="op" id="3007955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007958">dir</span><span class="op" id="3007961">,</span>&nbsp;<span class="ident" id="3007963">file</span>&nbsp;<span class="op" id="3007968">:=</span>&nbsp;<span class="ident" id="3007971">filepath</span><span class="op" id="3007979">.</span><span class="ident" id="3007980">Split</span><span class="op" id="3007985">(</span><span class="ident" id="3007986">name</span><span class="op" id="3007990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007993">serveFile</span><span class="op" id="3008002">(</span><span class="ident" id="3008003">w</span><span class="op" id="3008004">,</span>&nbsp;<span class="ident" id="3008006">r</span><span class="op" id="3008007">,</span>&nbsp;<span class="ident" id="3008009">Dir</span><span class="op" id="3008012">(</span><span class="ident" id="3008013">dir</span><span class="op" id="3008016">)</span><span class="op" id="3008017">,</span>&nbsp;<span class="ident" id="3008019">file</span><span class="op" id="3008023">,</span>&nbsp;<span class="builtintype" id="3008025">false</span><span class="op" id="3008030">)</span><br>
<span class="lineno"></span><span class="op" id="3008032">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3008035">type</span>&nbsp;<span class="ident" id="3008040">fileHandler</span>&nbsp;<span class="keyword" id="3008052">struct</span>&nbsp;<span class="op" id="3008059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008062">root</span>&nbsp;<span class="ident" id="3008067">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="3008078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="3008081">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3008139">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="3008195">//</span><br>
<span class="lineno"></span><span class="comment" id="3008198">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="3008259">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="3008276">//</span><br>
<span class="lineno"></span><span class="comment" id="3008279">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="3008338">func</span>&nbsp;<span class="ident" id="3008343">FileServer</span><span class="op" id="3008353">(</span><span class="ident" id="3008354">root</span>&nbsp;<span class="ident" id="3008359">FileSystem</span><span class="op" id="3008369">)</span>&nbsp;<span class="ident" id="3008371">Handler</span>&nbsp;<span class="op" id="3008379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008382">return</span>&nbsp;<span class="op" id="3008389">&amp;</span><span class="ident" id="3008390">fileHandler</span><span class="op" id="3008401">{</span><span class="ident" id="3008402">root</span><span class="op" id="3008406">}</span><br>
<span class="lineno"></span><span class="op" id="3008408">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="3008411">func</span>&nbsp;<span class="op" id="3008416">(</span><span class="ident" id="3008417">f</span>&nbsp;<span class="op" id="3008419">*</span><span class="ident" id="3008420">fileHandler</span><span class="op" id="3008431">)</span>&nbsp;<span class="ident" id="3008433">ServeHTTP</span><span class="op" id="3008442">(</span><span class="ident" id="3008443">w</span>&nbsp;<span class="ident" id="3008445">ResponseWriter</span><span class="op" id="3008459">,</span>&nbsp;<span class="ident" id="3008461">r</span>&nbsp;<span class="op" id="3008463">*</span><span class="ident" id="3008464">Request</span><span class="op" id="3008471">)</span>&nbsp;<span class="op" id="3008473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008476">upath</span>&nbsp;<span class="op" id="3008482">:=</span>&nbsp;<span class="ident" id="3008485">r</span><span class="op" id="3008486">.</span><span class="ident" id="3008487">URL</span><span class="op" id="3008490">.</span><span class="ident" id="3008491">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008497">if</span>&nbsp;<span class="op" id="3008500">!</span><span class="ident" id="3008501">strings</span><span class="op" id="3008508">.</span><span class="ident" id="3008509">HasPrefix</span><span class="op" id="3008518">(</span><span class="ident" id="3008519">upath</span><span class="op" id="3008524">,</span>&nbsp;<span class="string" id="3008526">&#34;/&#34;</span><span class="op" id="3008529">)</span>&nbsp;<span class="op" id="3008531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008535">upath</span>&nbsp;<span class="op" id="3008541">=</span>&nbsp;<span class="string" id="3008543">&#34;/&#34;</span>&nbsp;<span class="op" id="3008547">+</span>&nbsp;<span class="ident" id="3008549">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008557">r</span><span class="op" id="3008558">.</span><span class="ident" id="3008559">URL</span><span class="op" id="3008562">.</span><span class="ident" id="3008563">Path</span>&nbsp;<span class="op" id="3008568">=</span>&nbsp;<span class="ident" id="3008570">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008580">serveFile</span><span class="op" id="3008589">(</span><span class="ident" id="3008590">w</span><span class="op" id="3008591">,</span>&nbsp;<span class="ident" id="3008593">r</span><span class="op" id="3008594">,</span>&nbsp;<span class="ident" id="3008596">f</span><span class="op" id="3008597">.</span><span class="ident" id="3008598">root</span><span class="op" id="3008602">,</span>&nbsp;<span class="ident" id="3008604">path</span><span class="op" id="3008608">.</span><span class="ident" id="3008609">Clean</span><span class="op" id="3008614">(</span><span class="ident" id="3008615">upath</span><span class="op" id="3008620">)</span><span class="op" id="3008621">,</span>&nbsp;<span class="builtintype" id="3008623">true</span><span class="op" id="3008627">)</span><br>
<span class="lineno"></span><span class="op" id="3008629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="3008632">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3008696">type</span>&nbsp;<span class="ident" id="3008701">httpRange</span>&nbsp;<span class="keyword" id="3008711">struct</span>&nbsp;<span class="op" id="3008718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008721">start</span><span class="op" id="3008726">,</span>&nbsp;<span class="ident" id="3008728">length</span>&nbsp;<span class="ident" id="3008735">int64</span><br>
<span class="lineno"></span><span class="op" id="3008741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="3008744">func</span>&nbsp;<span class="op" id="3008749">(</span><span class="ident" id="3008750">r</span>&nbsp;<span class="ident" id="3008752">httpRange</span><span class="op" id="3008761">)</span>&nbsp;<span class="ident" id="3008763">contentRange</span><span class="op" id="3008775">(</span><span class="ident" id="3008776">size</span>&nbsp;<span class="ident" id="3008781">int64</span><span class="op" id="3008786">)</span>&nbsp;<span class="builtintype" id="3008788">string</span>&nbsp;<span class="op" id="3008795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008798">return</span>&nbsp;<span class="ident" id="3008805">fmt</span><span class="op" id="3008808">.</span><span class="ident" id="3008809">Sprintf</span><span class="op" id="3008816">(</span><span class="string" id="3008817">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="3008833">,</span>&nbsp;<span class="ident" id="3008835">r</span><span class="op" id="3008836">.</span><span class="ident" id="3008837">start</span><span class="op" id="3008842">,</span>&nbsp;<span class="ident" id="3008844">r</span><span class="op" id="3008845">.</span><span class="ident" id="3008846">start</span><span class="op" id="3008851">+</span><span class="ident" id="3008852">r</span><span class="op" id="3008853">.</span><span class="ident" id="3008854">length</span><span class="op" id="3008860">-</span><span class="num" id="3008861">1</span><span class="op" id="3008862">,</span>&nbsp;<span class="ident" id="3008864">size</span><span class="op" id="3008868">)</span><br>
<span class="lineno"></span><span class="op" id="3008870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3008873">func</span>&nbsp;<span class="op" id="3008878">(</span><span class="ident" id="3008879">r</span>&nbsp;<span class="ident" id="3008881">httpRange</span><span class="op" id="3008890">)</span>&nbsp;<span class="ident" id="3008892">mimeHeader</span><span class="op" id="3008902">(</span><span class="ident" id="3008903">contentType</span>&nbsp;<span class="builtintype" id="3008915">string</span><span class="op" id="3008921">,</span>&nbsp;<span class="ident" id="3008923">size</span>&nbsp;<span class="ident" id="3008928">int64</span><span class="op" id="3008933">)</span>&nbsp;<span class="ident" id="3008935">textproto</span><span class="op" id="3008944">.</span><span class="ident" id="3008945">MIMEHeader</span>&nbsp;<span class="op" id="3008956">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008959">return</span>&nbsp;<span class="ident" id="3008966">textproto</span><span class="op" id="3008975">.</span><span class="ident" id="3008976">MIMEHeader</span><span class="op" id="3008986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3008990">&#34;Content-Range&#34;</span><span class="op" id="3009005">:</span>&nbsp;<span class="op" id="3009007">{</span><span class="ident" id="3009008">r</span><span class="op" id="3009009">.</span><span class="ident" id="3009010">contentRange</span><span class="op" id="3009022">(</span><span class="ident" id="3009023">size</span><span class="op" id="3009027">)</span><span class="op" id="3009028">}</span><span class="op" id="3009029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3009033">&#34;Content-Type&#34;</span><span class="op" id="3009047">:</span>&nbsp;&nbsp;<span class="op" id="3009050">{</span><span class="ident" id="3009051">contentType</span><span class="op" id="3009062">}</span><span class="op" id="3009063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009066">}</span><br>
<span class="lineno"></span><span class="op" id="3009068">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3009071">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="3009131">func</span>&nbsp;<span class="ident" id="3009136">parseRange</span><span class="op" id="3009146">(</span><span class="ident" id="3009147">s</span>&nbsp;<span class="builtintype" id="3009149">string</span><span class="op" id="3009155">,</span>&nbsp;<span class="ident" id="3009157">size</span>&nbsp;<span class="ident" id="3009162">int64</span><span class="op" id="3009167">)</span>&nbsp;<span class="op" id="3009169">(</span><span class="op" id="3009170">[</span><span class="op" id="3009171">]</span><span class="ident" id="3009172">httpRange</span><span class="op" id="3009181">,</span>&nbsp;<span class="builtintype" id="3009183">error</span><span class="op" id="3009188">)</span>&nbsp;<span class="op" id="3009190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009193">if</span>&nbsp;<span class="ident" id="3009196">s</span>&nbsp;<span class="op" id="3009198">==</span>&nbsp;<span class="string" id="3009201">&#34;&#34;</span>&nbsp;<span class="op" id="3009204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009208">return</span>&nbsp;<span class="ident" id="3009215">nil</span><span class="op" id="3009218">,</span>&nbsp;<span class="ident" id="3009220">nil</span>&nbsp;<span class="comment" id="3009224">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009250">const</span>&nbsp;<span class="ident" id="3009256">b</span>&nbsp;<span class="op" id="3009258">=</span>&nbsp;<span class="string" id="3009260">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009270">if</span>&nbsp;<span class="op" id="3009273">!</span><span class="ident" id="3009274">strings</span><span class="op" id="3009281">.</span><span class="ident" id="3009282">HasPrefix</span><span class="op" id="3009291">(</span><span class="ident" id="3009292">s</span><span class="op" id="3009293">,</span>&nbsp;<span class="ident" id="3009295">b</span><span class="op" id="3009296">)</span>&nbsp;<span class="op" id="3009298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009302">return</span>&nbsp;<span class="ident" id="3009309">nil</span><span class="op" id="3009312">,</span>&nbsp;<span class="ident" id="3009314">errors</span><span class="op" id="3009320">.</span><span class="ident" id="3009321">New</span><span class="op" id="3009324">(</span><span class="string" id="3009325">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3009340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009343">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009346">var</span>&nbsp;<span class="ident" id="3009350">ranges</span>&nbsp;<span class="op" id="3009357">[</span><span class="op" id="3009358">]</span><span class="ident" id="3009359">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009370">for</span>&nbsp;<span class="ident" id="3009374">_</span><span class="op" id="3009375">,</span>&nbsp;<span class="ident" id="3009377">ra</span>&nbsp;<span class="op" id="3009380">:=</span>&nbsp;<span class="keyword" id="3009383">range</span>&nbsp;<span class="ident" id="3009389">strings</span><span class="op" id="3009396">.</span><span class="ident" id="3009397">Split</span><span class="op" id="3009402">(</span><span class="ident" id="3009403">s</span><span class="op" id="3009404">[</span><span class="builtinfunc" id="3009405">len</span><span class="op" id="3009408">(</span><span class="ident" id="3009409">b</span><span class="op" id="3009410">)</span><span class="op" id="3009411">:</span><span class="op" id="3009412">]</span><span class="op" id="3009413">,</span>&nbsp;<span class="string" id="3009415">&#34;,&#34;</span><span class="op" id="3009418">)</span>&nbsp;<span class="op" id="3009420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009424">ra</span>&nbsp;<span class="op" id="3009427">=</span>&nbsp;<span class="ident" id="3009429">strings</span><span class="op" id="3009436">.</span><span class="ident" id="3009437">TrimSpace</span><span class="op" id="3009446">(</span><span class="ident" id="3009447">ra</span><span class="op" id="3009449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009453">if</span>&nbsp;<span class="ident" id="3009456">ra</span>&nbsp;<span class="op" id="3009459">==</span>&nbsp;<span class="string" id="3009462">&#34;&#34;</span>&nbsp;<span class="op" id="3009465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009470">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009485">i</span>&nbsp;<span class="op" id="3009487">:=</span>&nbsp;<span class="ident" id="3009490">strings</span><span class="op" id="3009497">.</span><span class="ident" id="3009498">Index</span><span class="op" id="3009503">(</span><span class="ident" id="3009504">ra</span><span class="op" id="3009506">,</span>&nbsp;<span class="string" id="3009508">&#34;-&#34;</span><span class="op" id="3009511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009515">if</span>&nbsp;<span class="ident" id="3009518">i</span>&nbsp;<span class="op" id="3009520">&lt;</span>&nbsp;<span class="num" id="3009522">0</span>&nbsp;<span class="op" id="3009524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009529">return</span>&nbsp;<span class="ident" id="3009536">nil</span><span class="op" id="3009539">,</span>&nbsp;<span class="ident" id="3009541">errors</span><span class="op" id="3009547">.</span><span class="ident" id="3009548">New</span><span class="op" id="3009551">(</span><span class="string" id="3009552">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3009567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009571">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009575">start</span><span class="op" id="3009580">,</span>&nbsp;<span class="ident" id="3009582">end</span>&nbsp;<span class="op" id="3009586">:=</span>&nbsp;<span class="ident" id="3009589">strings</span><span class="op" id="3009596">.</span><span class="ident" id="3009597">TrimSpace</span><span class="op" id="3009606">(</span><span class="ident" id="3009607">ra</span><span class="op" id="3009609">[</span><span class="op" id="3009610">:</span><span class="ident" id="3009611">i</span><span class="op" id="3009612">]</span><span class="op" id="3009613">)</span><span class="op" id="3009614">,</span>&nbsp;<span class="ident" id="3009616">strings</span><span class="op" id="3009623">.</span><span class="ident" id="3009624">TrimSpace</span><span class="op" id="3009633">(</span><span class="ident" id="3009634">ra</span><span class="op" id="3009636">[</span><span class="ident" id="3009637">i</span><span class="op" id="3009638">+</span><span class="num" id="3009639">1</span><span class="op" id="3009640">:</span><span class="op" id="3009641">]</span><span class="op" id="3009642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009646">var</span>&nbsp;<span class="ident" id="3009650">r</span>&nbsp;<span class="ident" id="3009652">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009664">if</span>&nbsp;<span class="ident" id="3009667">start</span>&nbsp;<span class="op" id="3009673">==</span>&nbsp;<span class="string" id="3009676">&#34;&#34;</span>&nbsp;<span class="op" id="3009679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3009684">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3009734">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009785">i</span><span class="op" id="3009786">,</span>&nbsp;<span class="ident" id="3009788">err</span>&nbsp;<span class="op" id="3009792">:=</span>&nbsp;<span class="ident" id="3009795">strconv</span><span class="op" id="3009802">.</span><span class="ident" id="3009803">ParseInt</span><span class="op" id="3009811">(</span><span class="ident" id="3009812">end</span><span class="op" id="3009815">,</span>&nbsp;<span class="num" id="3009817">10</span><span class="op" id="3009819">,</span>&nbsp;<span class="num" id="3009821">64</span><span class="op" id="3009823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009828">if</span>&nbsp;<span class="ident" id="3009831">err</span>&nbsp;<span class="op" id="3009835">!=</span>&nbsp;<span class="ident" id="3009838">nil</span>&nbsp;<span class="op" id="3009842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009848">return</span>&nbsp;<span class="ident" id="3009855">nil</span><span class="op" id="3009858">,</span>&nbsp;<span class="ident" id="3009860">errors</span><span class="op" id="3009866">.</span><span class="ident" id="3009867">New</span><span class="op" id="3009870">(</span><span class="string" id="3009871">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3009886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009896">if</span>&nbsp;<span class="ident" id="3009899">i</span>&nbsp;<span class="op" id="3009901">&gt;</span>&nbsp;<span class="ident" id="3009903">size</span>&nbsp;<span class="op" id="3009908">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009914">i</span>&nbsp;<span class="op" id="3009916">=</span>&nbsp;<span class="ident" id="3009918">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009931">r</span><span class="op" id="3009932">.</span><span class="ident" id="3009933">start</span>&nbsp;<span class="op" id="3009939">=</span>&nbsp;<span class="ident" id="3009941">size</span>&nbsp;<span class="op" id="3009946">-</span>&nbsp;<span class="ident" id="3009948">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009953">r</span><span class="op" id="3009954">.</span><span class="ident" id="3009955">length</span>&nbsp;<span class="op" id="3009962">=</span>&nbsp;<span class="ident" id="3009964">size</span>&nbsp;<span class="op" id="3009969">-</span>&nbsp;<span class="ident" id="3009971">r</span><span class="op" id="3009972">.</span><span class="ident" id="3009973">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009981">}</span>&nbsp;<span class="keyword" id="3009983">else</span>&nbsp;<span class="op" id="3009988">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009993">i</span><span class="op" id="3009994">,</span>&nbsp;<span class="ident" id="3009996">err</span>&nbsp;<span class="op" id="3010000">:=</span>&nbsp;<span class="ident" id="3010003">strconv</span><span class="op" id="3010010">.</span><span class="ident" id="3010011">ParseInt</span><span class="op" id="3010019">(</span><span class="ident" id="3010020">start</span><span class="op" id="3010025">,</span>&nbsp;<span class="num" id="3010027">10</span><span class="op" id="3010029">,</span>&nbsp;<span class="num" id="3010031">64</span><span class="op" id="3010033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010038">if</span>&nbsp;<span class="ident" id="3010041">err</span>&nbsp;<span class="op" id="3010045">!=</span>&nbsp;<span class="ident" id="3010048">nil</span>&nbsp;<span class="op" id="3010052">||</span>&nbsp;<span class="ident" id="3010055">i</span>&nbsp;<span class="op" id="3010057">&gt;</span>&nbsp;<span class="ident" id="3010059">size</span>&nbsp;<span class="op" id="3010064">||</span>&nbsp;<span class="ident" id="3010067">i</span>&nbsp;<span class="op" id="3010069">&lt;</span>&nbsp;<span class="num" id="3010071">0</span>&nbsp;<span class="op" id="3010073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010079">return</span>&nbsp;<span class="ident" id="3010086">nil</span><span class="op" id="3010089">,</span>&nbsp;<span class="ident" id="3010091">errors</span><span class="op" id="3010097">.</span><span class="ident" id="3010098">New</span><span class="op" id="3010101">(</span><span class="string" id="3010102">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3010117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010127">r</span><span class="op" id="3010128">.</span><span class="ident" id="3010129">start</span>&nbsp;<span class="op" id="3010135">=</span>&nbsp;<span class="ident" id="3010137">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010142">if</span>&nbsp;<span class="ident" id="3010145">end</span>&nbsp;<span class="op" id="3010149">==</span>&nbsp;<span class="string" id="3010152">&#34;&#34;</span>&nbsp;<span class="op" id="3010155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3010161">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010226">r</span><span class="op" id="3010227">.</span><span class="ident" id="3010228">length</span>&nbsp;<span class="op" id="3010235">=</span>&nbsp;<span class="ident" id="3010237">size</span>&nbsp;<span class="op" id="3010242">-</span>&nbsp;<span class="ident" id="3010244">r</span><span class="op" id="3010245">.</span><span class="ident" id="3010246">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010255">}</span>&nbsp;<span class="keyword" id="3010257">else</span>&nbsp;<span class="op" id="3010262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010268">i</span><span class="op" id="3010269">,</span>&nbsp;<span class="ident" id="3010271">err</span>&nbsp;<span class="op" id="3010275">:=</span>&nbsp;<span class="ident" id="3010278">strconv</span><span class="op" id="3010285">.</span><span class="ident" id="3010286">ParseInt</span><span class="op" id="3010294">(</span><span class="ident" id="3010295">end</span><span class="op" id="3010298">,</span>&nbsp;<span class="num" id="3010300">10</span><span class="op" id="3010302">,</span>&nbsp;<span class="num" id="3010304">64</span><span class="op" id="3010306">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010312">if</span>&nbsp;<span class="ident" id="3010315">err</span>&nbsp;<span class="op" id="3010319">!=</span>&nbsp;<span class="ident" id="3010322">nil</span>&nbsp;<span class="op" id="3010326">||</span>&nbsp;<span class="ident" id="3010329">r</span><span class="op" id="3010330">.</span><span class="ident" id="3010331">start</span>&nbsp;<span class="op" id="3010337">&gt;</span>&nbsp;<span class="ident" id="3010339">i</span>&nbsp;<span class="op" id="3010341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010348">return</span>&nbsp;<span class="ident" id="3010355">nil</span><span class="op" id="3010358">,</span>&nbsp;<span class="ident" id="3010360">errors</span><span class="op" id="3010366">.</span><span class="ident" id="3010367">New</span><span class="op" id="3010370">(</span><span class="string" id="3010371">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3010386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010398">if</span>&nbsp;<span class="ident" id="3010401">i</span>&nbsp;<span class="op" id="3010403">&gt;=</span>&nbsp;<span class="ident" id="3010406">size</span>&nbsp;<span class="op" id="3010411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010418">i</span>&nbsp;<span class="op" id="3010420">=</span>&nbsp;<span class="ident" id="3010422">size</span>&nbsp;<span class="op" id="3010427">-</span>&nbsp;<span class="num" id="3010429">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010441">r</span><span class="op" id="3010442">.</span><span class="ident" id="3010443">length</span>&nbsp;<span class="op" id="3010450">=</span>&nbsp;<span class="ident" id="3010452">i</span>&nbsp;<span class="op" id="3010454">-</span>&nbsp;<span class="ident" id="3010456">r</span><span class="op" id="3010457">.</span><span class="ident" id="3010458">start</span>&nbsp;<span class="op" id="3010464">+</span>&nbsp;<span class="num" id="3010466">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010479">ranges</span>&nbsp;<span class="op" id="3010486">=</span>&nbsp;<span class="builtinfunc" id="3010488">append</span><span class="op" id="3010494">(</span><span class="ident" id="3010495">ranges</span><span class="op" id="3010501">,</span>&nbsp;<span class="ident" id="3010503">r</span><span class="op" id="3010504">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010510">return</span>&nbsp;<span class="ident" id="3010517">ranges</span><span class="op" id="3010523">,</span>&nbsp;<span class="ident" id="3010525">nil</span><br>
<span class="lineno"></span><span class="op" id="3010529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3010532">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="3010597">type</span>&nbsp;<span class="ident" id="3010602">countingWriter</span>&nbsp;<span class="ident" id="3010617">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3010624">func</span>&nbsp;<span class="op" id="3010629">(</span><span class="ident" id="3010630">w</span>&nbsp;<span class="op" id="3010632">*</span><span class="ident" id="3010633">countingWriter</span><span class="op" id="3010647">)</span>&nbsp;<span class="ident" id="3010649">Write</span><span class="op" id="3010654">(</span><span class="ident" id="3010655">p</span>&nbsp;<span class="op" id="3010657">[</span><span class="op" id="3010658">]</span><span class="builtintype" id="3010659">byte</span><span class="op" id="3010663">)</span>&nbsp;<span class="op" id="3010665">(</span><span class="ident" id="3010666">n</span>&nbsp;<span class="builtintype" id="3010668">int</span><span class="op" id="3010671">,</span>&nbsp;<span class="ident" id="3010673">err</span>&nbsp;<span class="builtintype" id="3010677">error</span><span class="op" id="3010682">)</span>&nbsp;<span class="op" id="3010684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010687">*</span><span class="ident" id="3010688">w</span>&nbsp;<span class="op" id="3010690">+=</span>&nbsp;<span class="ident" id="3010693">countingWriter</span><span class="op" id="3010707">(</span><span class="builtinfunc" id="3010708">len</span><span class="op" id="3010711">(</span><span class="ident" id="3010712">p</span><span class="op" id="3010713">)</span><span class="op" id="3010714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010717">return</span>&nbsp;<span class="builtinfunc" id="3010724">len</span><span class="op" id="3010727">(</span><span class="ident" id="3010728">p</span><span class="op" id="3010729">)</span><span class="op" id="3010730">,</span>&nbsp;<span class="ident" id="3010732">nil</span><br>
<span class="lineno">535</span><span class="op" id="3010736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3010739">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3010808">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3010852">func</span>&nbsp;<span class="ident" id="3010857">rangesMIMESize</span><span class="op" id="3010871">(</span><span class="ident" id="3010872">ranges</span>&nbsp;<span class="op" id="3010879">[</span><span class="op" id="3010880">]</span><span class="ident" id="3010881">httpRange</span><span class="op" id="3010890">,</span>&nbsp;<span class="ident" id="3010892">contentType</span>&nbsp;<span class="builtintype" id="3010904">string</span><span class="op" id="3010910">,</span>&nbsp;<span class="ident" id="3010912">contentSize</span>&nbsp;<span class="ident" id="3010924">int64</span><span class="op" id="3010929">)</span>&nbsp;<span class="op" id="3010931">(</span><span class="ident" id="3010932">encSize</span>&nbsp;<span class="ident" id="3010940">int64</span><span class="op" id="3010945">)</span>&nbsp;<span class="op" id="3010947">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010950">var</span>&nbsp;<span class="ident" id="3010954">w</span>&nbsp;<span class="ident" id="3010956">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010972">mw</span>&nbsp;<span class="op" id="3010975">:=</span>&nbsp;<span class="ident" id="3010978">multipart</span><span class="op" id="3010987">.</span><span class="ident" id="3010988">NewWriter</span><span class="op" id="3010997">(</span><span class="op" id="3010998">&amp;</span><span class="ident" id="3010999">w</span><span class="op" id="3011000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011003">for</span>&nbsp;<span class="ident" id="3011007">_</span><span class="op" id="3011008">,</span>&nbsp;<span class="ident" id="3011010">ra</span>&nbsp;<span class="op" id="3011013">:=</span>&nbsp;<span class="keyword" id="3011016">range</span>&nbsp;<span class="ident" id="3011022">ranges</span>&nbsp;<span class="op" id="3011029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011033">mw</span><span class="op" id="3011035">.</span><span class="ident" id="3011036">CreatePart</span><span class="op" id="3011046">(</span><span class="ident" id="3011047">ra</span><span class="op" id="3011049">.</span><span class="ident" id="3011050">mimeHeader</span><span class="op" id="3011060">(</span><span class="ident" id="3011061">contentType</span><span class="op" id="3011072">,</span>&nbsp;<span class="ident" id="3011074">contentSize</span><span class="op" id="3011085">)</span><span class="op" id="3011086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011090">encSize</span>&nbsp;<span class="op" id="3011098">+=</span>&nbsp;<span class="ident" id="3011101">ra</span><span class="op" id="3011103">.</span><span class="ident" id="3011104">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011115">mw</span><span class="op" id="3011117">.</span><span class="ident" id="3011118">Close</span><span class="op" id="3011123">(</span><span class="op" id="3011124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011127">encSize</span>&nbsp;<span class="op" id="3011135">+=</span>&nbsp;<span class="ident" id="3011138">int64</span><span class="op" id="3011143">(</span><span class="ident" id="3011144">w</span><span class="op" id="3011145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011148">return</span><br>
<span class="lineno"></span><span class="op" id="3011155">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="3011158">func</span>&nbsp;<span class="ident" id="3011163">sumRangesSize</span><span class="op" id="3011176">(</span><span class="ident" id="3011177">ranges</span>&nbsp;<span class="op" id="3011184">[</span><span class="op" id="3011185">]</span><span class="ident" id="3011186">httpRange</span><span class="op" id="3011195">)</span>&nbsp;<span class="op" id="3011197">(</span><span class="ident" id="3011198">size</span>&nbsp;<span class="ident" id="3011203">int64</span><span class="op" id="3011208">)</span>&nbsp;<span class="op" id="3011210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011213">for</span>&nbsp;<span class="ident" id="3011217">_</span><span class="op" id="3011218">,</span>&nbsp;<span class="ident" id="3011220">ra</span>&nbsp;<span class="op" id="3011223">:=</span>&nbsp;<span class="keyword" id="3011226">range</span>&nbsp;<span class="ident" id="3011232">ranges</span>&nbsp;<span class="op" id="3011239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011243">size</span>&nbsp;<span class="op" id="3011248">+=</span>&nbsp;<span class="ident" id="3011251">ra</span><span class="op" id="3011253">.</span><span class="ident" id="3011254">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011262">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011265">return</span><br>
<span class="lineno"></span><span class="op" id="3011272">}</span>
</div>
</body>
</html>
