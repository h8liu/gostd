<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3118953">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3119009">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3119063">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3119114">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3119192">package</span>&nbsp;<span class="ident" id="3119200">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3119205">import</span>&nbsp;<span class="op" id="3119212">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3119215">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3119221">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3119227">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3119238">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3119245">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3119248">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3119324">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3119401">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3119477">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3119551">func</span>&nbsp;<span class="ident" id="3119556">sockaddrToTCP</span><span class="op" id="3119569">(</span><span class="ident" id="3119570">sa</span>&nbsp;<span class="ident" id="3119573">syscall</span><span class="op" id="3119580">.</span><span class="ident" id="3119581">Sockaddr</span><span class="op" id="3119589">)</span>&nbsp;<span class="ident" id="3119591">Addr</span>&nbsp;<span class="op" id="3119596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119599">switch</span>&nbsp;<span class="ident" id="3119606">sa</span>&nbsp;<span class="op" id="3119609">:=</span>&nbsp;<span class="ident" id="3119612">sa</span><span class="op" id="3119614">.</span><span class="op" id="3119615">(</span><span class="keyword" id="3119616">type</span><span class="op" id="3119620">)</span>&nbsp;<span class="op" id="3119622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119625">case</span>&nbsp;<span class="op" id="3119630">*</span><span class="ident" id="3119631">syscall</span><span class="op" id="3119638">.</span><span class="ident" id="3119639">SockaddrInet4</span><span class="op" id="3119652">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119656">return</span>&nbsp;<span class="op" id="3119663">&amp;</span><span class="ident" id="3119664">TCPAddr</span><span class="op" id="3119671">{</span><span class="ident" id="3119672">IP</span><span class="op" id="3119674">:</span>&nbsp;<span class="ident" id="3119676">sa</span><span class="op" id="3119678">.</span><span class="ident" id="3119679">Addr</span><span class="op" id="3119683">[</span><span class="num" id="3119684">0</span><span class="op" id="3119685">:</span><span class="op" id="3119686">]</span><span class="op" id="3119687">,</span>&nbsp;<span class="ident" id="3119689">Port</span><span class="op" id="3119693">:</span>&nbsp;<span class="ident" id="3119695">sa</span><span class="op" id="3119697">.</span><span class="ident" id="3119698">Port</span><span class="op" id="3119702">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119705">case</span>&nbsp;<span class="op" id="3119710">*</span><span class="ident" id="3119711">syscall</span><span class="op" id="3119718">.</span><span class="ident" id="3119719">SockaddrInet6</span><span class="op" id="3119732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119736">return</span>&nbsp;<span class="op" id="3119743">&amp;</span><span class="ident" id="3119744">TCPAddr</span><span class="op" id="3119751">{</span><span class="ident" id="3119752">IP</span><span class="op" id="3119754">:</span>&nbsp;<span class="ident" id="3119756">sa</span><span class="op" id="3119758">.</span><span class="ident" id="3119759">Addr</span><span class="op" id="3119763">[</span><span class="num" id="3119764">0</span><span class="op" id="3119765">:</span><span class="op" id="3119766">]</span><span class="op" id="3119767">,</span>&nbsp;<span class="ident" id="3119769">Port</span><span class="op" id="3119773">:</span>&nbsp;<span class="ident" id="3119775">sa</span><span class="op" id="3119777">.</span><span class="ident" id="3119778">Port</span><span class="op" id="3119782">,</span>&nbsp;<span class="ident" id="3119784">Zone</span><span class="op" id="3119788">:</span>&nbsp;<span class="ident" id="3119790">zoneToString</span><span class="op" id="3119802">(</span><span class="builtintype" id="3119803">int</span><span class="op" id="3119806">(</span><span class="ident" id="3119807">sa</span><span class="op" id="3119809">.</span><span class="ident" id="3119810">ZoneId</span><span class="op" id="3119816">)</span><span class="op" id="3119817">)</span><span class="op" id="3119818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3119821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119824">return</span>&nbsp;<span class="ident" id="3119831">nil</span><br>
<span class="lineno"></span><span class="op" id="3119835">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3119838">func</span>&nbsp;<span class="op" id="3119843">(</span><span class="ident" id="3119844">a</span>&nbsp;<span class="op" id="3119846">*</span><span class="ident" id="3119847">TCPAddr</span><span class="op" id="3119854">)</span>&nbsp;<span class="ident" id="3119856">family</span><span class="op" id="3119862">(</span><span class="op" id="3119863">)</span>&nbsp;<span class="builtintype" id="3119865">int</span>&nbsp;<span class="op" id="3119869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119872">if</span>&nbsp;<span class="ident" id="3119875">a</span>&nbsp;<span class="op" id="3119877">==</span>&nbsp;<span class="ident" id="3119880">nil</span>&nbsp;<span class="op" id="3119884">||</span>&nbsp;<span class="builtinfunc" id="3119887">len</span><span class="op" id="3119890">(</span><span class="ident" id="3119891">a</span><span class="op" id="3119892">.</span><span class="ident" id="3119893">IP</span><span class="op" id="3119895">)</span>&nbsp;<span class="op" id="3119897">&lt;=</span>&nbsp;<span class="ident" id="3119900">IPv4len</span>&nbsp;<span class="op" id="3119908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119912">return</span>&nbsp;<span class="ident" id="3119919">syscall</span><span class="op" id="3119926">.</span><span class="ident" id="3119927">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3119936">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119939">if</span>&nbsp;<span class="ident" id="3119942">a</span><span class="op" id="3119943">.</span><span class="ident" id="3119944">IP</span><span class="op" id="3119946">.</span><span class="ident" id="3119947">To4</span><span class="op" id="3119950">(</span><span class="op" id="3119951">)</span>&nbsp;<span class="op" id="3119953">!=</span>&nbsp;<span class="ident" id="3119956">nil</span>&nbsp;<span class="op" id="3119960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119964">return</span>&nbsp;<span class="ident" id="3119971">syscall</span><span class="op" id="3119978">.</span><span class="ident" id="3119979">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3119988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3119991">return</span>&nbsp;<span class="ident" id="3119998">syscall</span><span class="op" id="3120005">.</span><span class="ident" id="3120006">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3120015">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3120018">func</span>&nbsp;<span class="op" id="3120023">(</span><span class="ident" id="3120024">a</span>&nbsp;<span class="op" id="3120026">*</span><span class="ident" id="3120027">TCPAddr</span><span class="op" id="3120034">)</span>&nbsp;<span class="ident" id="3120036">isWildcard</span><span class="op" id="3120046">(</span><span class="op" id="3120047">)</span>&nbsp;<span class="builtintype" id="3120049">bool</span>&nbsp;<span class="op" id="3120054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120057">if</span>&nbsp;<span class="ident" id="3120060">a</span>&nbsp;<span class="op" id="3120062">==</span>&nbsp;<span class="ident" id="3120065">nil</span>&nbsp;<span class="op" id="3120069">||</span>&nbsp;<span class="ident" id="3120072">a</span><span class="op" id="3120073">.</span><span class="ident" id="3120074">IP</span>&nbsp;<span class="op" id="3120077">==</span>&nbsp;<span class="ident" id="3120080">nil</span>&nbsp;<span class="op" id="3120084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120088">return</span>&nbsp;<span class="builtintype" id="3120095">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3120101">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120104">return</span>&nbsp;<span class="ident" id="3120111">a</span><span class="op" id="3120112">.</span><span class="ident" id="3120113">IP</span><span class="op" id="3120115">.</span><span class="ident" id="3120116">IsUnspecified</span><span class="op" id="3120129">(</span><span class="op" id="3120130">)</span><br>
<span class="lineno"></span><span class="op" id="3120132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3120135">func</span>&nbsp;<span class="op" id="3120140">(</span><span class="ident" id="3120141">a</span>&nbsp;<span class="op" id="3120143">*</span><span class="ident" id="3120144">TCPAddr</span><span class="op" id="3120151">)</span>&nbsp;<span class="ident" id="3120153">sockaddr</span><span class="op" id="3120161">(</span><span class="ident" id="3120162">family</span>&nbsp;<span class="builtintype" id="3120169">int</span><span class="op" id="3120172">)</span>&nbsp;<span class="op" id="3120174">(</span><span class="ident" id="3120175">syscall</span><span class="op" id="3120182">.</span><span class="ident" id="3120183">Sockaddr</span><span class="op" id="3120191">,</span>&nbsp;<span class="builtintype" id="3120193">error</span><span class="op" id="3120198">)</span>&nbsp;<span class="op" id="3120200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120203">if</span>&nbsp;<span class="ident" id="3120206">a</span>&nbsp;<span class="op" id="3120208">==</span>&nbsp;<span class="ident" id="3120211">nil</span>&nbsp;<span class="op" id="3120215">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120219">return</span>&nbsp;<span class="ident" id="3120226">nil</span><span class="op" id="3120229">,</span>&nbsp;<span class="ident" id="3120231">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3120236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120239">return</span>&nbsp;<span class="ident" id="3120246">ipToSockaddr</span><span class="op" id="3120258">(</span><span class="ident" id="3120259">family</span><span class="op" id="3120265">,</span>&nbsp;<span class="ident" id="3120267">a</span><span class="op" id="3120268">.</span><span class="ident" id="3120269">IP</span><span class="op" id="3120271">,</span>&nbsp;<span class="ident" id="3120273">a</span><span class="op" id="3120274">.</span><span class="ident" id="3120275">Port</span><span class="op" id="3120279">,</span>&nbsp;<span class="ident" id="3120281">a</span><span class="op" id="3120282">.</span><span class="ident" id="3120283">Zone</span><span class="op" id="3120287">)</span><br>
<span class="lineno"></span><span class="op" id="3120289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3120292">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3120362">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3120378">type</span>&nbsp;<span class="ident" id="3120383">TCPConn</span>&nbsp;<span class="keyword" id="3120391">struct</span>&nbsp;<span class="op" id="3120398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3120401">conn</span><br>
<span class="lineno"></span><span class="op" id="3120406">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3120409">func</span>&nbsp;<span class="ident" id="3120414">newTCPConn</span><span class="op" id="3120424">(</span><span class="ident" id="3120425">fd</span>&nbsp;<span class="op" id="3120428">*</span><span class="ident" id="3120429">netFD</span><span class="op" id="3120434">)</span>&nbsp;<span class="op" id="3120436">*</span><span class="ident" id="3120437">TCPConn</span>&nbsp;<span class="op" id="3120445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3120448">c</span>&nbsp;<span class="op" id="3120450">:=</span>&nbsp;<span class="op" id="3120453">&amp;</span><span class="ident" id="3120454">TCPConn</span><span class="op" id="3120461">{</span><span class="ident" id="3120462">conn</span><span class="op" id="3120466">{</span><span class="ident" id="3120467">fd</span><span class="op" id="3120469">}</span><span class="op" id="3120470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3120473">c</span><span class="op" id="3120474">.</span><span class="ident" id="3120475">SetNoDelay</span><span class="op" id="3120485">(</span><span class="builtintype" id="3120486">true</span><span class="op" id="3120490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120493">return</span>&nbsp;<span class="ident" id="3120500">c</span><br>
<span class="lineno">65</span><span class="op" id="3120502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3120505">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3120563">func</span>&nbsp;<span class="op" id="3120568">(</span><span class="ident" id="3120569">c</span>&nbsp;<span class="op" id="3120571">*</span><span class="ident" id="3120572">TCPConn</span><span class="op" id="3120579">)</span>&nbsp;<span class="ident" id="3120581">ReadFrom</span><span class="op" id="3120589">(</span><span class="ident" id="3120590">r</span>&nbsp;<span class="ident" id="3120592">io</span><span class="op" id="3120594">.</span><span class="ident" id="3120595">Reader</span><span class="op" id="3120601">)</span>&nbsp;<span class="op" id="3120603">(</span><span class="ident" id="3120604">int64</span><span class="op" id="3120609">,</span>&nbsp;<span class="builtintype" id="3120611">error</span><span class="op" id="3120616">)</span>&nbsp;<span class="op" id="3120618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120621">if</span>&nbsp;<span class="ident" id="3120624">n</span><span class="op" id="3120625">,</span>&nbsp;<span class="ident" id="3120627">err</span><span class="op" id="3120630">,</span>&nbsp;<span class="ident" id="3120632">handled</span>&nbsp;<span class="op" id="3120640">:=</span>&nbsp;<span class="ident" id="3120643">sendFile</span><span class="op" id="3120651">(</span><span class="ident" id="3120652">c</span><span class="op" id="3120653">.</span><span class="ident" id="3120654">fd</span><span class="op" id="3120656">,</span>&nbsp;<span class="ident" id="3120658">r</span><span class="op" id="3120659">)</span><span class="op" id="3120660">;</span>&nbsp;<span class="ident" id="3120662">handled</span>&nbsp;<span class="op" id="3120670">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120674">return</span>&nbsp;<span class="ident" id="3120681">n</span><span class="op" id="3120682">,</span>&nbsp;<span class="ident" id="3120684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3120689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120692">return</span>&nbsp;<span class="ident" id="3120699">genericReadFrom</span><span class="op" id="3120714">(</span><span class="ident" id="3120715">c</span><span class="op" id="3120716">,</span>&nbsp;<span class="ident" id="3120718">r</span><span class="op" id="3120719">)</span><br>
<span class="lineno"></span><span class="op" id="3120721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3120724">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3120788">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3120827">func</span>&nbsp;<span class="op" id="3120832">(</span><span class="ident" id="3120833">c</span>&nbsp;<span class="op" id="3120835">*</span><span class="ident" id="3120836">TCPConn</span><span class="op" id="3120843">)</span>&nbsp;<span class="ident" id="3120845">CloseRead</span><span class="op" id="3120854">(</span><span class="op" id="3120855">)</span>&nbsp;<span class="builtintype" id="3120857">error</span>&nbsp;<span class="op" id="3120863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120866">if</span>&nbsp;<span class="op" id="3120869">!</span><span class="ident" id="3120870">c</span><span class="op" id="3120871">.</span><span class="ident" id="3120872">ok</span><span class="op" id="3120874">(</span><span class="op" id="3120875">)</span>&nbsp;<span class="op" id="3120877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120881">return</span>&nbsp;<span class="ident" id="3120888">syscall</span><span class="op" id="3120895">.</span><span class="ident" id="3120896">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3120904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3120907">return</span>&nbsp;<span class="ident" id="3120914">c</span><span class="op" id="3120915">.</span><span class="ident" id="3120916">fd</span><span class="op" id="3120918">.</span><span class="ident" id="3120919">closeRead</span><span class="op" id="3120928">(</span><span class="op" id="3120929">)</span><br>
<span class="lineno"></span><span class="op" id="3120931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3120934">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3120999">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3121038">func</span>&nbsp;<span class="op" id="3121043">(</span><span class="ident" id="3121044">c</span>&nbsp;<span class="op" id="3121046">*</span><span class="ident" id="3121047">TCPConn</span><span class="op" id="3121054">)</span>&nbsp;<span class="ident" id="3121056">CloseWrite</span><span class="op" id="3121066">(</span><span class="op" id="3121067">)</span>&nbsp;<span class="builtintype" id="3121069">error</span>&nbsp;<span class="op" id="3121075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121078">if</span>&nbsp;<span class="op" id="3121081">!</span><span class="ident" id="3121082">c</span><span class="op" id="3121083">.</span><span class="ident" id="3121084">ok</span><span class="op" id="3121086">(</span><span class="op" id="3121087">)</span>&nbsp;<span class="op" id="3121089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121093">return</span>&nbsp;<span class="ident" id="3121100">syscall</span><span class="op" id="3121107">.</span><span class="ident" id="3121108">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3121116">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121119">return</span>&nbsp;<span class="ident" id="3121126">c</span><span class="op" id="3121127">.</span><span class="ident" id="3121128">fd</span><span class="op" id="3121130">.</span><span class="ident" id="3121131">closeWrite</span><span class="op" id="3121141">(</span><span class="op" id="3121142">)</span><br>
<span class="lineno"></span><span class="op" id="3121144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3121147">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3121215">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3121269">//</span><br>
<span class="lineno"></span><span class="comment" id="3121272">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3121343">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3121370">//</span><br>
<span class="lineno"></span><span class="comment" id="3121373">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3121433">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3121457">//</span><br>
<span class="lineno"></span><span class="comment" id="3121460">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3121530">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3121601">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3121634">func</span>&nbsp;<span class="op" id="3121639">(</span><span class="ident" id="3121640">c</span>&nbsp;<span class="op" id="3121642">*</span><span class="ident" id="3121643">TCPConn</span><span class="op" id="3121650">)</span>&nbsp;<span class="ident" id="3121652">SetLinger</span><span class="op" id="3121661">(</span><span class="ident" id="3121662">sec</span>&nbsp;<span class="builtintype" id="3121666">int</span><span class="op" id="3121669">)</span>&nbsp;<span class="builtintype" id="3121671">error</span>&nbsp;<span class="op" id="3121677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121680">if</span>&nbsp;<span class="op" id="3121683">!</span><span class="ident" id="3121684">c</span><span class="op" id="3121685">.</span><span class="ident" id="3121686">ok</span><span class="op" id="3121688">(</span><span class="op" id="3121689">)</span>&nbsp;<span class="op" id="3121691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121695">return</span>&nbsp;<span class="ident" id="3121702">syscall</span><span class="op" id="3121709">.</span><span class="ident" id="3121710">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3121718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121721">return</span>&nbsp;<span class="ident" id="3121728">setLinger</span><span class="op" id="3121737">(</span><span class="ident" id="3121738">c</span><span class="op" id="3121739">.</span><span class="ident" id="3121740">fd</span><span class="op" id="3121742">,</span>&nbsp;<span class="ident" id="3121744">sec</span><span class="op" id="3121747">)</span><br>
<span class="lineno">110</span><span class="op" id="3121749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3121752">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3121814">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3121855">func</span>&nbsp;<span class="op" id="3121860">(</span><span class="ident" id="3121861">c</span>&nbsp;<span class="op" id="3121863">*</span><span class="ident" id="3121864">TCPConn</span><span class="op" id="3121871">)</span>&nbsp;<span class="ident" id="3121873">SetKeepAlive</span><span class="op" id="3121885">(</span><span class="ident" id="3121886">keepalive</span>&nbsp;<span class="builtintype" id="3121896">bool</span><span class="op" id="3121900">)</span>&nbsp;<span class="builtintype" id="3121902">error</span>&nbsp;<span class="op" id="3121908">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121911">if</span>&nbsp;<span class="op" id="3121914">!</span><span class="ident" id="3121915">c</span><span class="op" id="3121916">.</span><span class="ident" id="3121917">ok</span><span class="op" id="3121919">(</span><span class="op" id="3121920">)</span>&nbsp;<span class="op" id="3121922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121926">return</span>&nbsp;<span class="ident" id="3121933">syscall</span><span class="op" id="3121940">.</span><span class="ident" id="3121941">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3121949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3121952">return</span>&nbsp;<span class="ident" id="3121959">setKeepAlive</span><span class="op" id="3121971">(</span><span class="ident" id="3121972">c</span><span class="op" id="3121973">.</span><span class="ident" id="3121974">fd</span><span class="op" id="3121976">,</span>&nbsp;<span class="ident" id="3121978">keepalive</span><span class="op" id="3121987">)</span><br>
<span class="lineno"></span><span class="op" id="3121989">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3121992">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3122047">func</span>&nbsp;<span class="op" id="3122052">(</span><span class="ident" id="3122053">c</span>&nbsp;<span class="op" id="3122055">*</span><span class="ident" id="3122056">TCPConn</span><span class="op" id="3122063">)</span>&nbsp;<span class="ident" id="3122065">SetKeepAlivePeriod</span><span class="op" id="3122083">(</span><span class="ident" id="3122084">d</span>&nbsp;<span class="ident" id="3122086">time</span><span class="op" id="3122090">.</span><span class="ident" id="3122091">Duration</span><span class="op" id="3122099">)</span>&nbsp;<span class="builtintype" id="3122101">error</span>&nbsp;<span class="op" id="3122107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122110">if</span>&nbsp;<span class="op" id="3122113">!</span><span class="ident" id="3122114">c</span><span class="op" id="3122115">.</span><span class="ident" id="3122116">ok</span><span class="op" id="3122118">(</span><span class="op" id="3122119">)</span>&nbsp;<span class="op" id="3122121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122125">return</span>&nbsp;<span class="ident" id="3122132">syscall</span><span class="op" id="3122139">.</span><span class="ident" id="3122140">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3122148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122151">return</span>&nbsp;<span class="ident" id="3122158">setKeepAlivePeriod</span><span class="op" id="3122176">(</span><span class="ident" id="3122177">c</span><span class="op" id="3122178">.</span><span class="ident" id="3122179">fd</span><span class="op" id="3122181">,</span>&nbsp;<span class="ident" id="3122183">d</span><span class="op" id="3122184">)</span><br>
<span class="lineno"></span><span class="op" id="3122186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3122189">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3122254">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3122320">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3122389">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3122432">func</span>&nbsp;<span class="op" id="3122437">(</span><span class="ident" id="3122438">c</span>&nbsp;<span class="op" id="3122440">*</span><span class="ident" id="3122441">TCPConn</span><span class="op" id="3122448">)</span>&nbsp;<span class="ident" id="3122450">SetNoDelay</span><span class="op" id="3122460">(</span><span class="ident" id="3122461">noDelay</span>&nbsp;<span class="builtintype" id="3122469">bool</span><span class="op" id="3122473">)</span>&nbsp;<span class="builtintype" id="3122475">error</span>&nbsp;<span class="op" id="3122481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122484">if</span>&nbsp;<span class="op" id="3122487">!</span><span class="ident" id="3122488">c</span><span class="op" id="3122489">.</span><span class="ident" id="3122490">ok</span><span class="op" id="3122492">(</span><span class="op" id="3122493">)</span>&nbsp;<span class="op" id="3122495">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122499">return</span>&nbsp;<span class="ident" id="3122506">syscall</span><span class="op" id="3122513">.</span><span class="ident" id="3122514">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3122522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122525">return</span>&nbsp;<span class="ident" id="3122532">setNoDelay</span><span class="op" id="3122542">(</span><span class="ident" id="3122543">c</span><span class="op" id="3122544">.</span><span class="ident" id="3122545">fd</span><span class="op" id="3122547">,</span>&nbsp;<span class="ident" id="3122549">noDelay</span><span class="op" id="3122556">)</span><br>
<span class="lineno"></span><span class="op" id="3122558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3122561">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3122629">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3122700">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3122749">func</span>&nbsp;<span class="ident" id="3122754">DialTCP</span><span class="op" id="3122761">(</span><span class="ident" id="3122762">net</span>&nbsp;<span class="builtintype" id="3122766">string</span><span class="op" id="3122772">,</span>&nbsp;<span class="ident" id="3122774">laddr</span><span class="op" id="3122779">,</span>&nbsp;<span class="ident" id="3122781">raddr</span>&nbsp;<span class="op" id="3122787">*</span><span class="ident" id="3122788">TCPAddr</span><span class="op" id="3122795">)</span>&nbsp;<span class="op" id="3122797">(</span><span class="op" id="3122798">*</span><span class="ident" id="3122799">TCPConn</span><span class="op" id="3122806">,</span>&nbsp;<span class="builtintype" id="3122808">error</span><span class="op" id="3122813">)</span>&nbsp;<span class="op" id="3122815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122818">switch</span>&nbsp;<span class="ident" id="3122825">net</span>&nbsp;<span class="op" id="3122829">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122832">case</span>&nbsp;<span class="string" id="3122837">&#34;tcp&#34;</span><span class="op" id="3122842">,</span>&nbsp;<span class="string" id="3122844">&#34;tcp4&#34;</span><span class="op" id="3122850">,</span>&nbsp;<span class="string" id="3122852">&#34;tcp6&#34;</span><span class="op" id="3122858">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122861">default</span><span class="op" id="3122868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122872">return</span>&nbsp;<span class="ident" id="3122879">nil</span><span class="op" id="3122882">,</span>&nbsp;<span class="op" id="3122884">&amp;</span><span class="ident" id="3122885">OpError</span><span class="op" id="3122892">{</span><span class="ident" id="3122893">Op</span><span class="op" id="3122895">:</span>&nbsp;<span class="string" id="3122897">&#34;dial&#34;</span><span class="op" id="3122903">,</span>&nbsp;<span class="ident" id="3122905">Net</span><span class="op" id="3122908">:</span>&nbsp;<span class="ident" id="3122910">net</span><span class="op" id="3122913">,</span>&nbsp;<span class="ident" id="3122915">Addr</span><span class="op" id="3122919">:</span>&nbsp;<span class="ident" id="3122921">raddr</span><span class="op" id="3122926">,</span>&nbsp;<span class="ident" id="3122928">Err</span><span class="op" id="3122931">:</span>&nbsp;<span class="ident" id="3122933">UnknownNetworkError</span><span class="op" id="3122952">(</span><span class="ident" id="3122953">net</span><span class="op" id="3122956">)</span><span class="op" id="3122957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3122960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122963">if</span>&nbsp;<span class="ident" id="3122966">raddr</span>&nbsp;<span class="op" id="3122972">==</span>&nbsp;<span class="ident" id="3122975">nil</span>&nbsp;<span class="op" id="3122979">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3122983">return</span>&nbsp;<span class="ident" id="3122990">nil</span><span class="op" id="3122993">,</span>&nbsp;<span class="op" id="3122995">&amp;</span><span class="ident" id="3122996">OpError</span><span class="op" id="3123003">{</span><span class="ident" id="3123004">Op</span><span class="op" id="3123006">:</span>&nbsp;<span class="string" id="3123008">&#34;dial&#34;</span><span class="op" id="3123014">,</span>&nbsp;<span class="ident" id="3123016">Net</span><span class="op" id="3123019">:</span>&nbsp;<span class="ident" id="3123021">net</span><span class="op" id="3123024">,</span>&nbsp;<span class="ident" id="3123026">Addr</span><span class="op" id="3123030">:</span>&nbsp;<span class="ident" id="3123032">nil</span><span class="op" id="3123035">,</span>&nbsp;<span class="ident" id="3123037">Err</span><span class="op" id="3123040">:</span>&nbsp;<span class="ident" id="3123042">errMissingAddress</span><span class="op" id="3123059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3123062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3123065">return</span>&nbsp;<span class="ident" id="3123072">dialTCP</span><span class="op" id="3123079">(</span><span class="ident" id="3123080">net</span><span class="op" id="3123083">,</span>&nbsp;<span class="ident" id="3123085">laddr</span><span class="op" id="3123090">,</span>&nbsp;<span class="ident" id="3123092">raddr</span><span class="op" id="3123097">,</span>&nbsp;<span class="ident" id="3123099">noDeadline</span><span class="op" id="3123109">)</span><br>
<span class="lineno"></span><span class="op" id="3123111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3123114">func</span>&nbsp;<span class="ident" id="3123119">dialTCP</span><span class="op" id="3123126">(</span><span class="ident" id="3123127">net</span>&nbsp;<span class="builtintype" id="3123131">string</span><span class="op" id="3123137">,</span>&nbsp;<span class="ident" id="3123139">laddr</span><span class="op" id="3123144">,</span>&nbsp;<span class="ident" id="3123146">raddr</span>&nbsp;<span class="op" id="3123152">*</span><span class="ident" id="3123153">TCPAddr</span><span class="op" id="3123160">,</span>&nbsp;<span class="ident" id="3123162">deadline</span>&nbsp;<span class="ident" id="3123171">time</span><span class="op" id="3123175">.</span><span class="ident" id="3123176">Time</span><span class="op" id="3123180">)</span>&nbsp;<span class="op" id="3123182">(</span><span class="op" id="3123183">*</span><span class="ident" id="3123184">TCPConn</span><span class="op" id="3123191">,</span>&nbsp;<span class="builtintype" id="3123193">error</span><span class="op" id="3123198">)</span>&nbsp;<span class="op" id="3123200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3123203">fd</span><span class="op" id="3123205">,</span>&nbsp;<span class="ident" id="3123207">err</span>&nbsp;<span class="op" id="3123211">:=</span>&nbsp;<span class="ident" id="3123214">internetSocket</span><span class="op" id="3123228">(</span><span class="ident" id="3123229">net</span><span class="op" id="3123232">,</span>&nbsp;<span class="ident" id="3123234">laddr</span><span class="op" id="3123239">,</span>&nbsp;<span class="ident" id="3123241">raddr</span><span class="op" id="3123246">,</span>&nbsp;<span class="ident" id="3123248">deadline</span><span class="op" id="3123256">,</span>&nbsp;<span class="ident" id="3123258">syscall</span><span class="op" id="3123265">.</span><span class="ident" id="3123266">SOCK_STREAM</span><span class="op" id="3123277">,</span>&nbsp;<span class="num" id="3123279">0</span><span class="op" id="3123280">,</span>&nbsp;<span class="string" id="3123282">&#34;dial&#34;</span><span class="op" id="3123288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123292">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123366">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123434">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123509">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123582">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123655">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123727">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123800">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123882">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3123957">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124040">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124103">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124175">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124245">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124318">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124349">//&nbsp;&nbsp;&nbsp;&nbsphttp://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124382">//&nbsp;&nbsp;&nbsp;&nbsphttp://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124430">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124434">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124512">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124590">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124663">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124687">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3124691">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3124759">for</span>&nbsp;<span class="ident" id="3124763">i</span>&nbsp;<span class="op" id="3124765">:=</span>&nbsp;<span class="num" id="3124768">0</span><span class="op" id="3124769">;</span>&nbsp;<span class="ident" id="3124771">i</span>&nbsp;<span class="op" id="3124773">&lt;</span>&nbsp;<span class="num" id="3124775">2</span>&nbsp;<span class="op" id="3124777">&amp;&amp;</span>&nbsp;<span class="op" id="3124780">(</span><span class="ident" id="3124781">laddr</span>&nbsp;<span class="op" id="3124787">==</span>&nbsp;<span class="ident" id="3124790">nil</span>&nbsp;<span class="op" id="3124794">||</span>&nbsp;<span class="ident" id="3124797">laddr</span><span class="op" id="3124802">.</span><span class="ident" id="3124803">Port</span>&nbsp;<span class="op" id="3124808">==</span>&nbsp;<span class="num" id="3124811">0</span><span class="op" id="3124812">)</span>&nbsp;<span class="op" id="3124814">&amp;&amp;</span>&nbsp;<span class="op" id="3124817">(</span><span class="ident" id="3124818">selfConnect</span><span class="op" id="3124829">(</span><span class="ident" id="3124830">fd</span><span class="op" id="3124832">,</span>&nbsp;<span class="ident" id="3124834">err</span><span class="op" id="3124837">)</span>&nbsp;<span class="op" id="3124839">||</span>&nbsp;<span class="ident" id="3124842">spuriousENOTAVAIL</span><span class="op" id="3124859">(</span><span class="ident" id="3124860">err</span><span class="op" id="3124863">)</span><span class="op" id="3124864">)</span><span class="op" id="3124865">;</span>&nbsp;<span class="ident" id="3124867">i</span><span class="op" id="3124868">++</span>&nbsp;<span class="op" id="3124871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3124875">if</span>&nbsp;<span class="ident" id="3124878">err</span>&nbsp;<span class="op" id="3124882">==</span>&nbsp;<span class="ident" id="3124885">nil</span>&nbsp;<span class="op" id="3124889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3124894">fd</span><span class="op" id="3124896">.</span><span class="ident" id="3124897">Close</span><span class="op" id="3124902">(</span><span class="op" id="3124903">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3124907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3124911">fd</span><span class="op" id="3124913">,</span>&nbsp;<span class="ident" id="3124915">err</span>&nbsp;<span class="op" id="3124919">=</span>&nbsp;<span class="ident" id="3124921">internetSocket</span><span class="op" id="3124935">(</span><span class="ident" id="3124936">net</span><span class="op" id="3124939">,</span>&nbsp;<span class="ident" id="3124941">laddr</span><span class="op" id="3124946">,</span>&nbsp;<span class="ident" id="3124948">raddr</span><span class="op" id="3124953">,</span>&nbsp;<span class="ident" id="3124955">deadline</span><span class="op" id="3124963">,</span>&nbsp;<span class="ident" id="3124965">syscall</span><span class="op" id="3124972">.</span><span class="ident" id="3124973">SOCK_STREAM</span><span class="op" id="3124984">,</span>&nbsp;<span class="num" id="3124986">0</span><span class="op" id="3124987">,</span>&nbsp;<span class="string" id="3124989">&#34;dial&#34;</span><span class="op" id="3124995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3124998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125002">if</span>&nbsp;<span class="ident" id="3125005">err</span>&nbsp;<span class="op" id="3125009">!=</span>&nbsp;<span class="ident" id="3125012">nil</span>&nbsp;<span class="op" id="3125016">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125020">return</span>&nbsp;<span class="ident" id="3125027">nil</span><span class="op" id="3125030">,</span>&nbsp;<span class="op" id="3125032">&amp;</span><span class="ident" id="3125033">OpError</span><span class="op" id="3125040">{</span><span class="ident" id="3125041">Op</span><span class="op" id="3125043">:</span>&nbsp;<span class="string" id="3125045">&#34;dial&#34;</span><span class="op" id="3125051">,</span>&nbsp;<span class="ident" id="3125053">Net</span><span class="op" id="3125056">:</span>&nbsp;<span class="ident" id="3125058">net</span><span class="op" id="3125061">,</span>&nbsp;<span class="ident" id="3125063">Addr</span><span class="op" id="3125067">:</span>&nbsp;<span class="ident" id="3125069">raddr</span><span class="op" id="3125074">,</span>&nbsp;<span class="ident" id="3125076">Err</span><span class="op" id="3125079">:</span>&nbsp;<span class="ident" id="3125081">err</span><span class="op" id="3125084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3125087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125090">return</span>&nbsp;<span class="ident" id="3125097">newTCPConn</span><span class="op" id="3125107">(</span><span class="ident" id="3125108">fd</span><span class="op" id="3125110">)</span><span class="op" id="3125111">,</span>&nbsp;<span class="ident" id="3125113">nil</span><br>
<span class="lineno"></span><span class="op" id="3125117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3125120">func</span>&nbsp;<span class="ident" id="3125125">selfConnect</span><span class="op" id="3125136">(</span><span class="ident" id="3125137">fd</span>&nbsp;<span class="op" id="3125140">*</span><span class="ident" id="3125141">netFD</span><span class="op" id="3125146">,</span>&nbsp;<span class="ident" id="3125148">err</span>&nbsp;<span class="builtintype" id="3125152">error</span><span class="op" id="3125157">)</span>&nbsp;<span class="builtintype" id="3125159">bool</span>&nbsp;<span class="op" id="3125164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125167">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125234">if</span>&nbsp;<span class="ident" id="3125237">err</span>&nbsp;<span class="op" id="3125241">!=</span>&nbsp;<span class="ident" id="3125244">nil</span>&nbsp;<span class="op" id="3125248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125252">return</span>&nbsp;<span class="builtintype" id="3125259">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3125266">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125270">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125343">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125412">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125482">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125555">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125622">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125691">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3125733">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125785">if</span>&nbsp;<span class="ident" id="3125788">fd</span><span class="op" id="3125790">.</span><span class="ident" id="3125791">laddr</span>&nbsp;<span class="op" id="3125797">==</span>&nbsp;<span class="ident" id="3125800">nil</span>&nbsp;<span class="op" id="3125804">||</span>&nbsp;<span class="ident" id="3125807">fd</span><span class="op" id="3125809">.</span><span class="ident" id="3125810">raddr</span>&nbsp;<span class="op" id="3125816">==</span>&nbsp;<span class="ident" id="3125819">nil</span>&nbsp;<span class="op" id="3125823">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125827">return</span>&nbsp;<span class="builtintype" id="3125834">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3125840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125843">l</span>&nbsp;<span class="op" id="3125845">:=</span>&nbsp;<span class="ident" id="3125848">fd</span><span class="op" id="3125850">.</span><span class="ident" id="3125851">laddr</span><span class="op" id="3125856">.</span><span class="op" id="3125857">(</span><span class="op" id="3125858">*</span><span class="ident" id="3125859">TCPAddr</span><span class="op" id="3125866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125869">r</span>&nbsp;<span class="op" id="3125871">:=</span>&nbsp;<span class="ident" id="3125874">fd</span><span class="op" id="3125876">.</span><span class="ident" id="3125877">raddr</span><span class="op" id="3125882">.</span><span class="op" id="3125883">(</span><span class="op" id="3125884">*</span><span class="ident" id="3125885">TCPAddr</span><span class="op" id="3125892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3125895">return</span>&nbsp;<span class="ident" id="3125902">l</span><span class="op" id="3125903">.</span><span class="ident" id="3125904">Port</span>&nbsp;<span class="op" id="3125909">==</span>&nbsp;<span class="ident" id="3125912">r</span><span class="op" id="3125913">.</span><span class="ident" id="3125914">Port</span>&nbsp;<span class="op" id="3125919">&amp;&amp;</span>&nbsp;<span class="ident" id="3125922">l</span><span class="op" id="3125923">.</span><span class="ident" id="3125924">IP</span><span class="op" id="3125926">.</span><span class="ident" id="3125927">Equal</span><span class="op" id="3125932">(</span><span class="ident" id="3125933">r</span><span class="op" id="3125934">.</span><span class="ident" id="3125935">IP</span><span class="op" id="3125937">)</span><br>
<span class="lineno">215</span><span class="op" id="3125939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3125942">func</span>&nbsp;<span class="ident" id="3125947">spuriousENOTAVAIL</span><span class="op" id="3125964">(</span><span class="ident" id="3125965">err</span>&nbsp;<span class="builtintype" id="3125969">error</span><span class="op" id="3125974">)</span>&nbsp;<span class="builtintype" id="3125976">bool</span>&nbsp;<span class="op" id="3125981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125984">e</span><span class="op" id="3125985">,</span>&nbsp;<span class="ident" id="3125987">ok</span>&nbsp;<span class="op" id="3125990">:=</span>&nbsp;<span class="ident" id="3125993">err</span><span class="op" id="3125996">.</span><span class="op" id="3125997">(</span><span class="op" id="3125998">*</span><span class="ident" id="3125999">OpError</span><span class="op" id="3126006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126009">return</span>&nbsp;<span class="ident" id="3126016">ok</span>&nbsp;<span class="op" id="3126019">&amp;&amp;</span>&nbsp;<span class="ident" id="3126022">e</span><span class="op" id="3126023">.</span><span class="ident" id="3126024">Err</span>&nbsp;<span class="op" id="3126028">==</span>&nbsp;<span class="ident" id="3126031">syscall</span><span class="op" id="3126038">.</span><span class="ident" id="3126039">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3126053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3126056">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3126124">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3126183">type</span>&nbsp;<span class="ident" id="3126188">TCPListener</span>&nbsp;<span class="keyword" id="3126200">struct</span>&nbsp;<span class="op" id="3126207">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126210">fd</span>&nbsp;<span class="op" id="3126213">*</span><span class="ident" id="3126214">netFD</span><br>
<span class="lineno"></span><span class="op" id="3126220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3126223">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3126287">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3126302">func</span>&nbsp;<span class="op" id="3126307">(</span><span class="ident" id="3126308">l</span>&nbsp;<span class="op" id="3126310">*</span><span class="ident" id="3126311">TCPListener</span><span class="op" id="3126322">)</span>&nbsp;<span class="ident" id="3126324">AcceptTCP</span><span class="op" id="3126333">(</span><span class="op" id="3126334">)</span>&nbsp;<span class="op" id="3126336">(</span><span class="op" id="3126337">*</span><span class="ident" id="3126338">TCPConn</span><span class="op" id="3126345">,</span>&nbsp;<span class="builtintype" id="3126347">error</span><span class="op" id="3126352">)</span>&nbsp;<span class="op" id="3126354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126357">if</span>&nbsp;<span class="ident" id="3126360">l</span>&nbsp;<span class="op" id="3126362">==</span>&nbsp;<span class="ident" id="3126365">nil</span>&nbsp;<span class="op" id="3126369">||</span>&nbsp;<span class="ident" id="3126372">l</span><span class="op" id="3126373">.</span><span class="ident" id="3126374">fd</span>&nbsp;<span class="op" id="3126377">==</span>&nbsp;<span class="ident" id="3126380">nil</span>&nbsp;<span class="op" id="3126384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126388">return</span>&nbsp;<span class="ident" id="3126395">nil</span><span class="op" id="3126398">,</span>&nbsp;<span class="ident" id="3126400">syscall</span><span class="op" id="3126407">.</span><span class="ident" id="3126408">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126419">fd</span><span class="op" id="3126421">,</span>&nbsp;<span class="ident" id="3126423">err</span>&nbsp;<span class="op" id="3126427">:=</span>&nbsp;<span class="ident" id="3126430">l</span><span class="op" id="3126431">.</span><span class="ident" id="3126432">fd</span><span class="op" id="3126434">.</span><span class="ident" id="3126435">accept</span><span class="op" id="3126441">(</span><span class="op" id="3126442">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126445">if</span>&nbsp;<span class="ident" id="3126448">err</span>&nbsp;<span class="op" id="3126452">!=</span>&nbsp;<span class="ident" id="3126455">nil</span>&nbsp;<span class="op" id="3126459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126463">return</span>&nbsp;<span class="ident" id="3126470">nil</span><span class="op" id="3126473">,</span>&nbsp;<span class="ident" id="3126475">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126483">return</span>&nbsp;<span class="ident" id="3126490">newTCPConn</span><span class="op" id="3126500">(</span><span class="ident" id="3126501">fd</span><span class="op" id="3126503">)</span><span class="op" id="3126504">,</span>&nbsp;<span class="ident" id="3126506">nil</span><br>
<span class="lineno"></span><span class="op" id="3126510">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3126513">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3126582">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3126637">func</span>&nbsp;<span class="op" id="3126642">(</span><span class="ident" id="3126643">l</span>&nbsp;<span class="op" id="3126645">*</span><span class="ident" id="3126646">TCPListener</span><span class="op" id="3126657">)</span>&nbsp;<span class="ident" id="3126659">Accept</span><span class="op" id="3126665">(</span><span class="op" id="3126666">)</span>&nbsp;<span class="op" id="3126668">(</span><span class="ident" id="3126669">Conn</span><span class="op" id="3126673">,</span>&nbsp;<span class="builtintype" id="3126675">error</span><span class="op" id="3126680">)</span>&nbsp;<span class="op" id="3126682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126685">c</span><span class="op" id="3126686">,</span>&nbsp;<span class="ident" id="3126688">err</span>&nbsp;<span class="op" id="3126692">:=</span>&nbsp;<span class="ident" id="3126695">l</span><span class="op" id="3126696">.</span><span class="ident" id="3126697">AcceptTCP</span><span class="op" id="3126706">(</span><span class="op" id="3126707">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126710">if</span>&nbsp;<span class="ident" id="3126713">err</span>&nbsp;<span class="op" id="3126717">!=</span>&nbsp;<span class="ident" id="3126720">nil</span>&nbsp;<span class="op" id="3126724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126728">return</span>&nbsp;<span class="ident" id="3126735">nil</span><span class="op" id="3126738">,</span>&nbsp;<span class="ident" id="3126740">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126748">return</span>&nbsp;<span class="ident" id="3126755">c</span><span class="op" id="3126756">,</span>&nbsp;<span class="ident" id="3126758">nil</span><br>
<span class="lineno"></span><span class="op" id="3126762">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3126765">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3126810">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3126858">func</span>&nbsp;<span class="op" id="3126863">(</span><span class="ident" id="3126864">l</span>&nbsp;<span class="op" id="3126866">*</span><span class="ident" id="3126867">TCPListener</span><span class="op" id="3126878">)</span>&nbsp;<span class="ident" id="3126880">Close</span><span class="op" id="3126885">(</span><span class="op" id="3126886">)</span>&nbsp;<span class="builtintype" id="3126888">error</span>&nbsp;<span class="op" id="3126894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126897">if</span>&nbsp;<span class="ident" id="3126900">l</span>&nbsp;<span class="op" id="3126902">==</span>&nbsp;<span class="ident" id="3126905">nil</span>&nbsp;<span class="op" id="3126909">||</span>&nbsp;<span class="ident" id="3126912">l</span><span class="op" id="3126913">.</span><span class="ident" id="3126914">fd</span>&nbsp;<span class="op" id="3126917">==</span>&nbsp;<span class="ident" id="3126920">nil</span>&nbsp;<span class="op" id="3126924">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126928">return</span>&nbsp;<span class="ident" id="3126935">syscall</span><span class="op" id="3126942">.</span><span class="ident" id="3126943">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126954">return</span>&nbsp;<span class="ident" id="3126961">l</span><span class="op" id="3126962">.</span><span class="ident" id="3126963">fd</span><span class="op" id="3126965">.</span><span class="ident" id="3126966">Close</span><span class="op" id="3126971">(</span><span class="op" id="3126972">)</span><br>
<span class="lineno"></span><span class="op" id="3126974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3126977">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3127037">func</span>&nbsp;<span class="op" id="3127042">(</span><span class="ident" id="3127043">l</span>&nbsp;<span class="op" id="3127045">*</span><span class="ident" id="3127046">TCPListener</span><span class="op" id="3127057">)</span>&nbsp;<span class="ident" id="3127059">Addr</span><span class="op" id="3127063">(</span><span class="op" id="3127064">)</span>&nbsp;<span class="ident" id="3127066">Addr</span>&nbsp;<span class="op" id="3127071">{</span>&nbsp;<span class="keyword" id="3127073">return</span>&nbsp;<span class="ident" id="3127080">l</span><span class="op" id="3127081">.</span><span class="ident" id="3127082">fd</span><span class="op" id="3127084">.</span><span class="ident" id="3127085">laddr</span>&nbsp;<span class="op" id="3127091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3127094">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3127157">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3127201">func</span>&nbsp;<span class="op" id="3127206">(</span><span class="ident" id="3127207">l</span>&nbsp;<span class="op" id="3127209">*</span><span class="ident" id="3127210">TCPListener</span><span class="op" id="3127221">)</span>&nbsp;<span class="ident" id="3127223">SetDeadline</span><span class="op" id="3127234">(</span><span class="ident" id="3127235">t</span>&nbsp;<span class="ident" id="3127237">time</span><span class="op" id="3127241">.</span><span class="ident" id="3127242">Time</span><span class="op" id="3127246">)</span>&nbsp;<span class="builtintype" id="3127248">error</span>&nbsp;<span class="op" id="3127254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127257">if</span>&nbsp;<span class="ident" id="3127260">l</span>&nbsp;<span class="op" id="3127262">==</span>&nbsp;<span class="ident" id="3127265">nil</span>&nbsp;<span class="op" id="3127269">||</span>&nbsp;<span class="ident" id="3127272">l</span><span class="op" id="3127273">.</span><span class="ident" id="3127274">fd</span>&nbsp;<span class="op" id="3127277">==</span>&nbsp;<span class="ident" id="3127280">nil</span>&nbsp;<span class="op" id="3127284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127288">return</span>&nbsp;<span class="ident" id="3127295">syscall</span><span class="op" id="3127302">.</span><span class="ident" id="3127303">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3127311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127314">return</span>&nbsp;<span class="ident" id="3127321">l</span><span class="op" id="3127322">.</span><span class="ident" id="3127323">fd</span><span class="op" id="3127325">.</span><span class="ident" id="3127326">setDeadline</span><span class="op" id="3127337">(</span><span class="ident" id="3127338">t</span><span class="op" id="3127339">)</span><br>
<span class="lineno">270</span><span class="op" id="3127341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3127344">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3127410">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3127480">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3127545">//</span><br>
<span class="lineno"></span><span class="comment" id="3127548">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3127612">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3127678">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3127742">func</span>&nbsp;<span class="op" id="3127747">(</span><span class="ident" id="3127748">l</span>&nbsp;<span class="op" id="3127750">*</span><span class="ident" id="3127751">TCPListener</span><span class="op" id="3127762">)</span>&nbsp;<span class="ident" id="3127764">File</span><span class="op" id="3127768">(</span><span class="op" id="3127769">)</span>&nbsp;<span class="op" id="3127771">(</span><span class="ident" id="3127772">f</span>&nbsp;<span class="op" id="3127774">*</span><span class="ident" id="3127775">os</span><span class="op" id="3127777">.</span><span class="ident" id="3127778">File</span><span class="op" id="3127782">,</span>&nbsp;<span class="ident" id="3127784">err</span>&nbsp;<span class="builtintype" id="3127788">error</span><span class="op" id="3127793">)</span>&nbsp;<span class="op" id="3127795">{</span>&nbsp;<span class="keyword" id="3127797">return</span>&nbsp;<span class="ident" id="3127804">l</span><span class="op" id="3127805">.</span><span class="ident" id="3127806">fd</span><span class="op" id="3127808">.</span><span class="ident" id="3127809">dup</span><span class="op" id="3127812">(</span><span class="op" id="3127813">)</span>&nbsp;<span class="op" id="3127815">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3127818">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3127884">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3127952">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3128023">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3128093">func</span>&nbsp;<span class="ident" id="3128098">ListenTCP</span><span class="op" id="3128107">(</span><span class="ident" id="3128108">net</span>&nbsp;<span class="builtintype" id="3128112">string</span><span class="op" id="3128118">,</span>&nbsp;<span class="ident" id="3128120">laddr</span>&nbsp;<span class="op" id="3128126">*</span><span class="ident" id="3128127">TCPAddr</span><span class="op" id="3128134">)</span>&nbsp;<span class="op" id="3128136">(</span><span class="op" id="3128137">*</span><span class="ident" id="3128138">TCPListener</span><span class="op" id="3128149">,</span>&nbsp;<span class="builtintype" id="3128151">error</span><span class="op" id="3128156">)</span>&nbsp;<span class="op" id="3128158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128161">switch</span>&nbsp;<span class="ident" id="3128168">net</span>&nbsp;<span class="op" id="3128172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128175">case</span>&nbsp;<span class="string" id="3128180">&#34;tcp&#34;</span><span class="op" id="3128185">,</span>&nbsp;<span class="string" id="3128187">&#34;tcp4&#34;</span><span class="op" id="3128193">,</span>&nbsp;<span class="string" id="3128195">&#34;tcp6&#34;</span><span class="op" id="3128201">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128204">default</span><span class="op" id="3128211">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128215">return</span>&nbsp;<span class="ident" id="3128222">nil</span><span class="op" id="3128225">,</span>&nbsp;<span class="op" id="3128227">&amp;</span><span class="ident" id="3128228">OpError</span><span class="op" id="3128235">{</span><span class="ident" id="3128236">Op</span><span class="op" id="3128238">:</span>&nbsp;<span class="string" id="3128240">&#34;listen&#34;</span><span class="op" id="3128248">,</span>&nbsp;<span class="ident" id="3128250">Net</span><span class="op" id="3128253">:</span>&nbsp;<span class="ident" id="3128255">net</span><span class="op" id="3128258">,</span>&nbsp;<span class="ident" id="3128260">Addr</span><span class="op" id="3128264">:</span>&nbsp;<span class="ident" id="3128266">laddr</span><span class="op" id="3128271">,</span>&nbsp;<span class="ident" id="3128273">Err</span><span class="op" id="3128276">:</span>&nbsp;<span class="ident" id="3128278">UnknownNetworkError</span><span class="op" id="3128297">(</span><span class="ident" id="3128298">net</span><span class="op" id="3128301">)</span><span class="op" id="3128302">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128308">if</span>&nbsp;<span class="ident" id="3128311">laddr</span>&nbsp;<span class="op" id="3128317">==</span>&nbsp;<span class="ident" id="3128320">nil</span>&nbsp;<span class="op" id="3128324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128328">laddr</span>&nbsp;<span class="op" id="3128334">=</span>&nbsp;<span class="op" id="3128336">&amp;</span><span class="ident" id="3128337">TCPAddr</span><span class="op" id="3128344">{</span><span class="op" id="3128345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128351">fd</span><span class="op" id="3128353">,</span>&nbsp;<span class="ident" id="3128355">err</span>&nbsp;<span class="op" id="3128359">:=</span>&nbsp;<span class="ident" id="3128362">internetSocket</span><span class="op" id="3128376">(</span><span class="ident" id="3128377">net</span><span class="op" id="3128380">,</span>&nbsp;<span class="ident" id="3128382">laddr</span><span class="op" id="3128387">,</span>&nbsp;<span class="ident" id="3128389">nil</span><span class="op" id="3128392">,</span>&nbsp;<span class="ident" id="3128394">noDeadline</span><span class="op" id="3128404">,</span>&nbsp;<span class="ident" id="3128406">syscall</span><span class="op" id="3128413">.</span><span class="ident" id="3128414">SOCK_STREAM</span><span class="op" id="3128425">,</span>&nbsp;<span class="num" id="3128427">0</span><span class="op" id="3128428">,</span>&nbsp;<span class="string" id="3128430">&#34;listen&#34;</span><span class="op" id="3128438">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128441">if</span>&nbsp;<span class="ident" id="3128444">err</span>&nbsp;<span class="op" id="3128448">!=</span>&nbsp;<span class="ident" id="3128451">nil</span>&nbsp;<span class="op" id="3128455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128459">return</span>&nbsp;<span class="ident" id="3128466">nil</span><span class="op" id="3128469">,</span>&nbsp;<span class="op" id="3128471">&amp;</span><span class="ident" id="3128472">OpError</span><span class="op" id="3128479">{</span><span class="ident" id="3128480">Op</span><span class="op" id="3128482">:</span>&nbsp;<span class="string" id="3128484">&#34;listen&#34;</span><span class="op" id="3128492">,</span>&nbsp;<span class="ident" id="3128494">Net</span><span class="op" id="3128497">:</span>&nbsp;<span class="ident" id="3128499">net</span><span class="op" id="3128502">,</span>&nbsp;<span class="ident" id="3128504">Addr</span><span class="op" id="3128508">:</span>&nbsp;<span class="ident" id="3128510">laddr</span><span class="op" id="3128515">,</span>&nbsp;<span class="ident" id="3128517">Err</span><span class="op" id="3128520">:</span>&nbsp;<span class="ident" id="3128522">err</span><span class="op" id="3128525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128531">return</span>&nbsp;<span class="op" id="3128538">&amp;</span><span class="ident" id="3128539">TCPListener</span><span class="op" id="3128550">{</span><span class="ident" id="3128551">fd</span><span class="op" id="3128553">}</span><span class="op" id="3128554">,</span>&nbsp;<span class="ident" id="3128556">nil</span><br>
<span class="lineno"></span><span class="op" id="3128560">}</span>
</div>
</body>
</html>
