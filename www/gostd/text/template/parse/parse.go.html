<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html" class="current">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3634820">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3634875">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3634929">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3634980">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="3635058">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="3635137">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3635213">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3635242">package</span>&nbsp;<span class="ident" id="3635250">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3635257">import</span>&nbsp;<span class="op" id="3635264">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3635267">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3635276">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3635283">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3635294">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3635305">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3635315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3635318">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="3635377">type</span>&nbsp;<span class="ident" id="3635382">Tree</span>&nbsp;<span class="keyword" id="3635387">struct</span>&nbsp;<span class="op" id="3635394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635397">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3635407">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3635417">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635467">ParseName</span>&nbsp;<span class="builtintype" id="3635477">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3635487">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635558">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635568">*</span><span class="ident" id="3635569">ListNode</span>&nbsp;<span class="comment" id="3635578">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635610">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3635620">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3635630">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3635685">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635724">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635734">[</span><span class="op" id="3635735">]</span><span class="keyword" id="3635736">map</span><span class="op" id="3635739">[</span><span class="builtintype" id="3635740">string</span><span class="op" id="3635746">]</span><span class="keyword" id="3635747">interface</span><span class="op" id="3635756">{</span><span class="op" id="3635757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635760">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635770">*</span><span class="ident" id="3635771">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635778">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635788">[</span><span class="num" id="3635789">3</span><span class="op" id="3635790">]</span><span class="ident" id="3635791">item</span>&nbsp;<span class="comment" id="3635796">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635834">peekCount</span>&nbsp;<span class="builtintype" id="3635844">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3635849">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3635859">[</span><span class="op" id="3635860">]</span><span class="builtintype" id="3635861">string</span>&nbsp;<span class="comment" id="3635868">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="3635904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3635907">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="3635975">func</span>&nbsp;<span class="op" id="3635980">(</span><span class="ident" id="3635981">t</span>&nbsp;<span class="op" id="3635983">*</span><span class="ident" id="3635984">Tree</span><span class="op" id="3635988">)</span>&nbsp;<span class="ident" id="3635990">Copy</span><span class="op" id="3635994">(</span><span class="op" id="3635995">)</span>&nbsp;<span class="op" id="3635997">*</span><span class="ident" id="3635998">Tree</span>&nbsp;<span class="op" id="3636003">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636006">if</span>&nbsp;<span class="ident" id="3636009">t</span>&nbsp;<span class="op" id="3636011">==</span>&nbsp;<span class="builtintype" id="3636014">nil</span>&nbsp;<span class="op" id="3636018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636022">return</span>&nbsp;<span class="builtintype" id="3636029">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636037">return</span>&nbsp;<span class="op" id="3636044">&amp;</span><span class="ident" id="3636045">Tree</span><span class="op" id="3636049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636053">Name</span><span class="op" id="3636057">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636064">t</span><span class="op" id="3636065">.</span><span class="ident" id="3636066">Name</span><span class="op" id="3636070">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636074">ParseName</span><span class="op" id="3636083">:</span>&nbsp;<span class="ident" id="3636085">t</span><span class="op" id="3636086">.</span><span class="ident" id="3636087">ParseName</span><span class="op" id="3636096">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636100">Root</span><span class="op" id="3636104">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636111">t</span><span class="op" id="3636112">.</span><span class="ident" id="3636113">Root</span><span class="op" id="3636117">.</span><span class="ident" id="3636118">CopyList</span><span class="op" id="3636126">(</span><span class="op" id="3636127">)</span><span class="op" id="3636128">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636132">text</span><span class="op" id="3636136">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636143">t</span><span class="op" id="3636144">.</span><span class="ident" id="3636145">text</span><span class="op" id="3636149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636152">}</span><br>
<span class="lineno"></span><span class="op" id="3636154">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3636157">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3636237">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3636315">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3636393">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="3636434">func</span>&nbsp;<span class="ident" id="3636439">Parse</span><span class="op" id="3636444">(</span><span class="ident" id="3636445">name</span><span class="op" id="3636449">,</span>&nbsp;<span class="ident" id="3636451">text</span><span class="op" id="3636455">,</span>&nbsp;<span class="ident" id="3636457">leftDelim</span><span class="op" id="3636466">,</span>&nbsp;<span class="ident" id="3636468">rightDelim</span>&nbsp;<span class="builtintype" id="3636479">string</span><span class="op" id="3636485">,</span>&nbsp;<span class="ident" id="3636487">funcs</span>&nbsp;<span class="op" id="3636493">...</span><span class="keyword" id="3636496">map</span><span class="op" id="3636499">[</span><span class="builtintype" id="3636500">string</span><span class="op" id="3636506">]</span><span class="keyword" id="3636507">interface</span><span class="op" id="3636516">{</span><span class="op" id="3636517">}</span><span class="op" id="3636518">)</span>&nbsp;<span class="op" id="3636520">(</span><span class="ident" id="3636521">treeSet</span>&nbsp;<span class="keyword" id="3636529">map</span><span class="op" id="3636532">[</span><span class="builtintype" id="3636533">string</span><span class="op" id="3636539">]</span><span class="op" id="3636540">*</span><span class="ident" id="3636541">Tree</span><span class="op" id="3636545">,</span>&nbsp;<span class="ident" id="3636547">err</span>&nbsp;<span class="builtintype" id="3636551">error</span><span class="op" id="3636556">)</span>&nbsp;<span class="op" id="3636558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636561">treeSet</span>&nbsp;<span class="op" id="3636569">=</span>&nbsp;<span class="builtinfunc" id="3636571">make</span><span class="op" id="3636575">(</span><span class="keyword" id="3636576">map</span><span class="op" id="3636579">[</span><span class="builtintype" id="3636580">string</span><span class="op" id="3636586">]</span><span class="op" id="3636587">*</span><span class="ident" id="3636588">Tree</span><span class="op" id="3636592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636595">t</span>&nbsp;<span class="op" id="3636597">:=</span>&nbsp;<span class="ident" id="3636600">New</span><span class="op" id="3636603">(</span><span class="ident" id="3636604">name</span><span class="op" id="3636608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636611">t</span><span class="op" id="3636612">.</span><span class="ident" id="3636613">text</span>&nbsp;<span class="op" id="3636618">=</span>&nbsp;<span class="ident" id="3636620">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636626">_</span><span class="op" id="3636627">,</span>&nbsp;<span class="ident" id="3636629">err</span>&nbsp;<span class="op" id="3636633">=</span>&nbsp;<span class="ident" id="3636635">t</span><span class="op" id="3636636">.</span><span class="ident" id="3636637">Parse</span><span class="op" id="3636642">(</span><span class="ident" id="3636643">text</span><span class="op" id="3636647">,</span>&nbsp;<span class="ident" id="3636649">leftDelim</span><span class="op" id="3636658">,</span>&nbsp;<span class="ident" id="3636660">rightDelim</span><span class="op" id="3636670">,</span>&nbsp;<span class="ident" id="3636672">treeSet</span><span class="op" id="3636679">,</span>&nbsp;<span class="ident" id="3636681">funcs</span><span class="op" id="3636686">...</span><span class="op" id="3636689">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636692">return</span><br>
<span class="lineno"></span><span class="op" id="3636699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3636702">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3636734">func</span>&nbsp;<span class="op" id="3636739">(</span><span class="ident" id="3636740">t</span>&nbsp;<span class="op" id="3636742">*</span><span class="ident" id="3636743">Tree</span><span class="op" id="3636747">)</span>&nbsp;<span class="ident" id="3636749">next</span><span class="op" id="3636753">(</span><span class="op" id="3636754">)</span>&nbsp;<span class="ident" id="3636756">item</span>&nbsp;<span class="op" id="3636761">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636764">if</span>&nbsp;<span class="ident" id="3636767">t</span><span class="op" id="3636768">.</span><span class="ident" id="3636769">peekCount</span>&nbsp;<span class="op" id="3636779">&gt;</span>&nbsp;<span class="num" id="3636781">0</span>&nbsp;<span class="op" id="3636783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636787">t</span><span class="op" id="3636788">.</span><span class="ident" id="3636789">peekCount</span><span class="op" id="3636798">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636802">}</span>&nbsp;<span class="keyword" id="3636804">else</span>&nbsp;<span class="op" id="3636809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636813">t</span><span class="op" id="3636814">.</span><span class="ident" id="3636815">token</span><span class="op" id="3636820">[</span><span class="num" id="3636821">0</span><span class="op" id="3636822">]</span>&nbsp;<span class="op" id="3636824">=</span>&nbsp;<span class="ident" id="3636826">t</span><span class="op" id="3636827">.</span><span class="ident" id="3636828">lex</span><span class="op" id="3636831">.</span><span class="ident" id="3636832">nextItem</span><span class="op" id="3636840">(</span><span class="op" id="3636841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3636844">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3636847">return</span>&nbsp;<span class="ident" id="3636854">t</span><span class="op" id="3636855">.</span><span class="ident" id="3636856">token</span><span class="op" id="3636861">[</span><span class="ident" id="3636862">t</span><span class="op" id="3636863">.</span><span class="ident" id="3636864">peekCount</span><span class="op" id="3636873">]</span><br>
<span class="lineno"></span><span class="op" id="3636875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3636878">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3636925">func</span>&nbsp;<span class="op" id="3636930">(</span><span class="ident" id="3636931">t</span>&nbsp;<span class="op" id="3636933">*</span><span class="ident" id="3636934">Tree</span><span class="op" id="3636938">)</span>&nbsp;<span class="ident" id="3636940">backup</span><span class="op" id="3636946">(</span><span class="op" id="3636947">)</span>&nbsp;<span class="op" id="3636949">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3636952">t</span><span class="op" id="3636953">.</span><span class="ident" id="3636954">peekCount</span><span class="op" id="3636963">++</span><br>
<span class="lineno"></span><span class="op" id="3636966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3636969">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="3637018">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="3637056">func</span>&nbsp;<span class="op" id="3637061">(</span><span class="ident" id="3637062">t</span>&nbsp;<span class="op" id="3637064">*</span><span class="ident" id="3637065">Tree</span><span class="op" id="3637069">)</span>&nbsp;<span class="ident" id="3637071">backup2</span><span class="op" id="3637078">(</span><span class="ident" id="3637079">t1</span>&nbsp;<span class="ident" id="3637082">item</span><span class="op" id="3637086">)</span>&nbsp;<span class="op" id="3637088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637091">t</span><span class="op" id="3637092">.</span><span class="ident" id="3637093">token</span><span class="op" id="3637098">[</span><span class="num" id="3637099">1</span><span class="op" id="3637100">]</span>&nbsp;<span class="op" id="3637102">=</span>&nbsp;<span class="ident" id="3637104">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637108">t</span><span class="op" id="3637109">.</span><span class="ident" id="3637110">peekCount</span>&nbsp;<span class="op" id="3637120">=</span>&nbsp;<span class="num" id="3637122">2</span><br>
<span class="lineno"></span><span class="op" id="3637124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3637127">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="3637177">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="3637215">func</span>&nbsp;<span class="op" id="3637220">(</span><span class="ident" id="3637221">t</span>&nbsp;<span class="op" id="3637223">*</span><span class="ident" id="3637224">Tree</span><span class="op" id="3637228">)</span>&nbsp;<span class="ident" id="3637230">backup3</span><span class="op" id="3637237">(</span><span class="ident" id="3637238">t2</span><span class="op" id="3637240">,</span>&nbsp;<span class="ident" id="3637242">t1</span>&nbsp;<span class="ident" id="3637245">item</span><span class="op" id="3637249">)</span>&nbsp;<span class="op" id="3637251">{</span>&nbsp;<span class="comment" id="3637253">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637292">t</span><span class="op" id="3637293">.</span><span class="ident" id="3637294">token</span><span class="op" id="3637299">[</span><span class="num" id="3637300">1</span><span class="op" id="3637301">]</span>&nbsp;<span class="op" id="3637303">=</span>&nbsp;<span class="ident" id="3637305">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637309">t</span><span class="op" id="3637310">.</span><span class="ident" id="3637311">token</span><span class="op" id="3637316">[</span><span class="num" id="3637317">2</span><span class="op" id="3637318">]</span>&nbsp;<span class="op" id="3637320">=</span>&nbsp;<span class="ident" id="3637322">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637326">t</span><span class="op" id="3637327">.</span><span class="ident" id="3637328">peekCount</span>&nbsp;<span class="op" id="3637338">=</span>&nbsp;<span class="num" id="3637340">3</span><br>
<span class="lineno"></span><span class="op" id="3637342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3637345">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3637398">func</span>&nbsp;<span class="op" id="3637403">(</span><span class="ident" id="3637404">t</span>&nbsp;<span class="op" id="3637406">*</span><span class="ident" id="3637407">Tree</span><span class="op" id="3637411">)</span>&nbsp;<span class="ident" id="3637413">peek</span><span class="op" id="3637417">(</span><span class="op" id="3637418">)</span>&nbsp;<span class="ident" id="3637420">item</span>&nbsp;<span class="op" id="3637425">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637428">if</span>&nbsp;<span class="ident" id="3637431">t</span><span class="op" id="3637432">.</span><span class="ident" id="3637433">peekCount</span>&nbsp;<span class="op" id="3637443">&gt;</span>&nbsp;<span class="num" id="3637445">0</span>&nbsp;<span class="op" id="3637447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637451">return</span>&nbsp;<span class="ident" id="3637458">t</span><span class="op" id="3637459">.</span><span class="ident" id="3637460">token</span><span class="op" id="3637465">[</span><span class="ident" id="3637466">t</span><span class="op" id="3637467">.</span><span class="ident" id="3637468">peekCount</span><span class="op" id="3637477">-</span><span class="num" id="3637478">1</span><span class="op" id="3637479">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637485">t</span><span class="op" id="3637486">.</span><span class="ident" id="3637487">peekCount</span>&nbsp;<span class="op" id="3637497">=</span>&nbsp;<span class="num" id="3637499">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637502">t</span><span class="op" id="3637503">.</span><span class="ident" id="3637504">token</span><span class="op" id="3637509">[</span><span class="num" id="3637510">0</span><span class="op" id="3637511">]</span>&nbsp;<span class="op" id="3637513">=</span>&nbsp;<span class="ident" id="3637515">t</span><span class="op" id="3637516">.</span><span class="ident" id="3637517">lex</span><span class="op" id="3637520">.</span><span class="ident" id="3637521">nextItem</span><span class="op" id="3637529">(</span><span class="op" id="3637530">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637533">return</span>&nbsp;<span class="ident" id="3637540">t</span><span class="op" id="3637541">.</span><span class="ident" id="3637542">token</span><span class="op" id="3637547">[</span><span class="num" id="3637548">0</span><span class="op" id="3637549">]</span><br>
<span class="lineno"></span><span class="op" id="3637551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3637554">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3637604">func</span>&nbsp;<span class="op" id="3637609">(</span><span class="ident" id="3637610">t</span>&nbsp;<span class="op" id="3637612">*</span><span class="ident" id="3637613">Tree</span><span class="op" id="3637617">)</span>&nbsp;<span class="ident" id="3637619">nextNonSpace</span><span class="op" id="3637631">(</span><span class="op" id="3637632">)</span>&nbsp;<span class="op" id="3637634">(</span><span class="ident" id="3637635">token</span>&nbsp;<span class="ident" id="3637641">item</span><span class="op" id="3637645">)</span>&nbsp;<span class="op" id="3637647">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637650">for</span>&nbsp;<span class="op" id="3637654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637658">token</span>&nbsp;<span class="op" id="3637664">=</span>&nbsp;<span class="ident" id="3637666">t</span><span class="op" id="3637667">.</span><span class="ident" id="3637668">next</span><span class="op" id="3637672">(</span><span class="op" id="3637673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637677">if</span>&nbsp;<span class="ident" id="3637680">token</span><span class="op" id="3637685">.</span><span class="ident" id="3637686">typ</span>&nbsp;<span class="op" id="3637690">!=</span>&nbsp;<span class="ident" id="3637693">itemSpace</span>&nbsp;<span class="op" id="3637703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637708">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637716">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637722">return</span>&nbsp;<span class="ident" id="3637729">token</span><br>
<span class="lineno"></span><span class="op" id="3637735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3637738">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="3637809">func</span>&nbsp;<span class="op" id="3637814">(</span><span class="ident" id="3637815">t</span>&nbsp;<span class="op" id="3637817">*</span><span class="ident" id="3637818">Tree</span><span class="op" id="3637822">)</span>&nbsp;<span class="ident" id="3637824">peekNonSpace</span><span class="op" id="3637836">(</span><span class="op" id="3637837">)</span>&nbsp;<span class="op" id="3637839">(</span><span class="ident" id="3637840">token</span>&nbsp;<span class="ident" id="3637846">item</span><span class="op" id="3637850">)</span>&nbsp;<span class="op" id="3637852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637855">for</span>&nbsp;<span class="op" id="3637859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637863">token</span>&nbsp;<span class="op" id="3637869">=</span>&nbsp;<span class="ident" id="3637871">t</span><span class="op" id="3637872">.</span><span class="ident" id="3637873">next</span><span class="op" id="3637877">(</span><span class="op" id="3637878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637882">if</span>&nbsp;<span class="ident" id="3637885">token</span><span class="op" id="3637890">.</span><span class="ident" id="3637891">typ</span>&nbsp;<span class="op" id="3637895">!=</span>&nbsp;<span class="ident" id="3637898">itemSpace</span>&nbsp;<span class="op" id="3637908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637913">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3637924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3637927">t</span><span class="op" id="3637928">.</span><span class="ident" id="3637929">backup</span><span class="op" id="3637935">(</span><span class="op" id="3637936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3637939">return</span>&nbsp;<span class="ident" id="3637946">token</span><br>
<span class="lineno"></span><span class="op" id="3637952">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3637955">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3637968">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3638023">func</span>&nbsp;<span class="ident" id="3638028">New</span><span class="op" id="3638031">(</span><span class="ident" id="3638032">name</span>&nbsp;<span class="builtintype" id="3638037">string</span><span class="op" id="3638043">,</span>&nbsp;<span class="ident" id="3638045">funcs</span>&nbsp;<span class="op" id="3638051">...</span><span class="keyword" id="3638054">map</span><span class="op" id="3638057">[</span><span class="builtintype" id="3638058">string</span><span class="op" id="3638064">]</span><span class="keyword" id="3638065">interface</span><span class="op" id="3638074">{</span><span class="op" id="3638075">}</span><span class="op" id="3638076">)</span>&nbsp;<span class="op" id="3638078">*</span><span class="ident" id="3638079">Tree</span>&nbsp;<span class="op" id="3638084">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638087">return</span>&nbsp;<span class="op" id="3638094">&amp;</span><span class="ident" id="3638095">Tree</span><span class="op" id="3638099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638103">Name</span><span class="op" id="3638107">:</span>&nbsp;&nbsp;<span class="ident" id="3638110">name</span><span class="op" id="3638114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638118">funcs</span><span class="op" id="3638123">:</span>&nbsp;<span class="ident" id="3638125">funcs</span><span class="op" id="3638130">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638133">}</span><br>
<span class="lineno"></span><span class="op" id="3638135">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3638138">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="3638234">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="3638321">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="3638353">func</span>&nbsp;<span class="op" id="3638358">(</span><span class="ident" id="3638359">t</span>&nbsp;<span class="op" id="3638361">*</span><span class="ident" id="3638362">Tree</span><span class="op" id="3638366">)</span>&nbsp;<span class="ident" id="3638368">ErrorContext</span><span class="op" id="3638380">(</span><span class="ident" id="3638381">n</span>&nbsp;<span class="ident" id="3638383">Node</span><span class="op" id="3638387">)</span>&nbsp;<span class="op" id="3638389">(</span><span class="ident" id="3638390">location</span><span class="op" id="3638398">,</span>&nbsp;<span class="ident" id="3638400">context</span>&nbsp;<span class="builtintype" id="3638408">string</span><span class="op" id="3638414">)</span>&nbsp;<span class="op" id="3638416">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638419">pos</span>&nbsp;<span class="op" id="3638423">:=</span>&nbsp;<span class="builtintype" id="3638426">int</span><span class="op" id="3638429">(</span><span class="ident" id="3638430">n</span><span class="op" id="3638431">.</span><span class="ident" id="3638432">Position</span><span class="op" id="3638440">(</span><span class="op" id="3638441">)</span><span class="op" id="3638442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638445">tree</span>&nbsp;<span class="op" id="3638450">:=</span>&nbsp;<span class="ident" id="3638453">n</span><span class="op" id="3638454">.</span><span class="ident" id="3638455">tree</span><span class="op" id="3638459">(</span><span class="op" id="3638460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638463">if</span>&nbsp;<span class="ident" id="3638466">tree</span>&nbsp;<span class="op" id="3638471">==</span>&nbsp;<span class="builtintype" id="3638474">nil</span>&nbsp;<span class="op" id="3638478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638482">tree</span>&nbsp;<span class="op" id="3638487">=</span>&nbsp;<span class="ident" id="3638489">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638492">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638495">text</span>&nbsp;<span class="op" id="3638500">:=</span>&nbsp;<span class="ident" id="3638503">tree</span><span class="op" id="3638507">.</span><span class="ident" id="3638508">text</span><span class="op" id="3638512">[</span><span class="op" id="3638513">:</span><span class="ident" id="3638514">pos</span><span class="op" id="3638517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638520">byteNum</span>&nbsp;<span class="op" id="3638528">:=</span>&nbsp;<span class="ident" id="3638531">strings</span><span class="op" id="3638538">.</span><span class="ident" id="3638539">LastIndex</span><span class="op" id="3638548">(</span><span class="ident" id="3638549">text</span><span class="op" id="3638553">,</span>&nbsp;<span class="string" id="3638555">&#34;\n&#34;</span><span class="op" id="3638559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638562">if</span>&nbsp;<span class="ident" id="3638565">byteNum</span>&nbsp;<span class="op" id="3638573">==</span>&nbsp;<span class="op" id="3638576">-</span><span class="num" id="3638577">1</span>&nbsp;<span class="op" id="3638579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638583">byteNum</span>&nbsp;<span class="op" id="3638591">=</span>&nbsp;<span class="ident" id="3638593">pos</span>&nbsp;<span class="comment" id="3638597">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638616">}</span>&nbsp;<span class="keyword" id="3638618">else</span>&nbsp;<span class="op" id="3638623">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638627">byteNum</span><span class="op" id="3638634">++</span>&nbsp;<span class="comment" id="3638637">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638661">byteNum</span>&nbsp;<span class="op" id="3638669">=</span>&nbsp;<span class="ident" id="3638671">pos</span>&nbsp;<span class="op" id="3638675">-</span>&nbsp;<span class="ident" id="3638677">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638689">lineNum</span>&nbsp;<span class="op" id="3638697">:=</span>&nbsp;<span class="num" id="3638700">1</span>&nbsp;<span class="op" id="3638702">+</span>&nbsp;<span class="ident" id="3638704">strings</span><span class="op" id="3638711">.</span><span class="ident" id="3638712">Count</span><span class="op" id="3638717">(</span><span class="ident" id="3638718">text</span><span class="op" id="3638722">,</span>&nbsp;<span class="string" id="3638724">&#34;\n&#34;</span><span class="op" id="3638728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638731">context</span>&nbsp;<span class="op" id="3638739">=</span>&nbsp;<span class="ident" id="3638741">n</span><span class="op" id="3638742">.</span><span class="ident" id="3638743">String</span><span class="op" id="3638749">(</span><span class="op" id="3638750">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638753">if</span>&nbsp;<span class="builtinfunc" id="3638756">len</span><span class="op" id="3638759">(</span><span class="ident" id="3638760">context</span><span class="op" id="3638767">)</span>&nbsp;<span class="op" id="3638769">&gt;</span>&nbsp;<span class="num" id="3638771">20</span>&nbsp;<span class="op" id="3638774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3638778">context</span>&nbsp;<span class="op" id="3638786">=</span>&nbsp;<span class="ident" id="3638788">fmt</span><span class="op" id="3638791">.</span><span class="ident" id="3638792">Sprintf</span><span class="op" id="3638799">(</span><span class="string" id="3638800">&#34;%.20s...&#34;</span><span class="op" id="3638810">,</span>&nbsp;<span class="ident" id="3638812">context</span><span class="op" id="3638819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3638822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3638825">return</span>&nbsp;<span class="ident" id="3638832">fmt</span><span class="op" id="3638835">.</span><span class="ident" id="3638836">Sprintf</span><span class="op" id="3638843">(</span><span class="string" id="3638844">&#34;%s:%d:%d&#34;</span><span class="op" id="3638854">,</span>&nbsp;<span class="ident" id="3638856">tree</span><span class="op" id="3638860">.</span><span class="ident" id="3638861">ParseName</span><span class="op" id="3638870">,</span>&nbsp;<span class="ident" id="3638872">lineNum</span><span class="op" id="3638879">,</span>&nbsp;<span class="ident" id="3638881">byteNum</span><span class="op" id="3638888">)</span><span class="op" id="3638889">,</span>&nbsp;<span class="ident" id="3638891">context</span><br>
<span class="lineno"></span><span class="op" id="3638899">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3638902">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3638957">func</span>&nbsp;<span class="op" id="3638962">(</span><span class="ident" id="3638963">t</span>&nbsp;<span class="op" id="3638965">*</span><span class="ident" id="3638966">Tree</span><span class="op" id="3638970">)</span>&nbsp;<span class="ident" id="3638972">errorf</span><span class="op" id="3638978">(</span><span class="ident" id="3638979">format</span>&nbsp;<span class="builtintype" id="3638986">string</span><span class="op" id="3638992">,</span>&nbsp;<span class="ident" id="3638994">args</span>&nbsp;<span class="op" id="3638999">...</span><span class="keyword" id="3639002">interface</span><span class="op" id="3639011">{</span><span class="op" id="3639012">}</span><span class="op" id="3639013">)</span>&nbsp;<span class="op" id="3639015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639018">t</span><span class="op" id="3639019">.</span><span class="ident" id="3639020">Root</span>&nbsp;<span class="op" id="3639025">=</span>&nbsp;<span class="builtintype" id="3639027">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639032">format</span>&nbsp;<span class="op" id="3639039">=</span>&nbsp;<span class="ident" id="3639041">fmt</span><span class="op" id="3639044">.</span><span class="ident" id="3639045">Sprintf</span><span class="op" id="3639052">(</span><span class="string" id="3639053">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="3639074">,</span>&nbsp;<span class="ident" id="3639076">t</span><span class="op" id="3639077">.</span><span class="ident" id="3639078">ParseName</span><span class="op" id="3639087">,</span>&nbsp;<span class="ident" id="3639089">t</span><span class="op" id="3639090">.</span><span class="ident" id="3639091">lex</span><span class="op" id="3639094">.</span><span class="ident" id="3639095">lineNumber</span><span class="op" id="3639105">(</span><span class="op" id="3639106">)</span><span class="op" id="3639107">,</span>&nbsp;<span class="ident" id="3639109">format</span><span class="op" id="3639115">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3639118">panic</span><span class="op" id="3639123">(</span><span class="ident" id="3639124">fmt</span><span class="op" id="3639127">.</span><span class="ident" id="3639128">Errorf</span><span class="op" id="3639134">(</span><span class="ident" id="3639135">format</span><span class="op" id="3639141">,</span>&nbsp;<span class="ident" id="3639143">args</span><span class="op" id="3639147">...</span><span class="op" id="3639150">)</span><span class="op" id="3639151">)</span><br>
<span class="lineno"></span><span class="op" id="3639153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3639156">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3639188">func</span>&nbsp;<span class="op" id="3639193">(</span><span class="ident" id="3639194">t</span>&nbsp;<span class="op" id="3639196">*</span><span class="ident" id="3639197">Tree</span><span class="op" id="3639201">)</span>&nbsp;<span class="builtintype" id="3639203">error</span><span class="op" id="3639208">(</span><span class="ident" id="3639209">err</span>&nbsp;<span class="builtintype" id="3639213">error</span><span class="op" id="3639218">)</span>&nbsp;<span class="op" id="3639220">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639223">t</span><span class="op" id="3639224">.</span><span class="ident" id="3639225">errorf</span><span class="op" id="3639231">(</span><span class="string" id="3639232">&#34;%s&#34;</span><span class="op" id="3639236">,</span>&nbsp;<span class="ident" id="3639238">err</span><span class="op" id="3639241">)</span><br>
<span class="lineno"></span><span class="op" id="3639243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3639246">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3639321">func</span>&nbsp;<span class="op" id="3639326">(</span><span class="ident" id="3639327">t</span>&nbsp;<span class="op" id="3639329">*</span><span class="ident" id="3639330">Tree</span><span class="op" id="3639334">)</span>&nbsp;<span class="ident" id="3639336">expect</span><span class="op" id="3639342">(</span><span class="ident" id="3639343">expected</span>&nbsp;<span class="ident" id="3639352">itemType</span><span class="op" id="3639360">,</span>&nbsp;<span class="ident" id="3639362">context</span>&nbsp;<span class="builtintype" id="3639370">string</span><span class="op" id="3639376">)</span>&nbsp;<span class="ident" id="3639378">item</span>&nbsp;<span class="op" id="3639383">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639386">token</span>&nbsp;<span class="op" id="3639392">:=</span>&nbsp;<span class="ident" id="3639395">t</span><span class="op" id="3639396">.</span><span class="ident" id="3639397">nextNonSpace</span><span class="op" id="3639409">(</span><span class="op" id="3639410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639413">if</span>&nbsp;<span class="ident" id="3639416">token</span><span class="op" id="3639421">.</span><span class="ident" id="3639422">typ</span>&nbsp;<span class="op" id="3639426">!=</span>&nbsp;<span class="ident" id="3639429">expected</span>&nbsp;<span class="op" id="3639438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639442">t</span><span class="op" id="3639443">.</span><span class="ident" id="3639444">unexpected</span><span class="op" id="3639454">(</span><span class="ident" id="3639455">token</span><span class="op" id="3639460">,</span>&nbsp;<span class="ident" id="3639462">context</span><span class="op" id="3639469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639475">return</span>&nbsp;<span class="ident" id="3639482">token</span><br>
<span class="lineno">175</span><span class="op" id="3639488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3639491">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="3639579">func</span>&nbsp;<span class="op" id="3639584">(</span><span class="ident" id="3639585">t</span>&nbsp;<span class="op" id="3639587">*</span><span class="ident" id="3639588">Tree</span><span class="op" id="3639592">)</span>&nbsp;<span class="ident" id="3639594">expectOneOf</span><span class="op" id="3639605">(</span><span class="ident" id="3639606">expected1</span><span class="op" id="3639615">,</span>&nbsp;<span class="ident" id="3639617">expected2</span>&nbsp;<span class="ident" id="3639627">itemType</span><span class="op" id="3639635">,</span>&nbsp;<span class="ident" id="3639637">context</span>&nbsp;<span class="builtintype" id="3639645">string</span><span class="op" id="3639651">)</span>&nbsp;<span class="ident" id="3639653">item</span>&nbsp;<span class="op" id="3639658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639661">token</span>&nbsp;<span class="op" id="3639667">:=</span>&nbsp;<span class="ident" id="3639670">t</span><span class="op" id="3639671">.</span><span class="ident" id="3639672">nextNonSpace</span><span class="op" id="3639684">(</span><span class="op" id="3639685">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639688">if</span>&nbsp;<span class="ident" id="3639691">token</span><span class="op" id="3639696">.</span><span class="ident" id="3639697">typ</span>&nbsp;<span class="op" id="3639701">!=</span>&nbsp;<span class="ident" id="3639704">expected1</span>&nbsp;<span class="op" id="3639714">&amp;&amp;</span>&nbsp;<span class="ident" id="3639717">token</span><span class="op" id="3639722">.</span><span class="ident" id="3639723">typ</span>&nbsp;<span class="op" id="3639727">!=</span>&nbsp;<span class="ident" id="3639730">expected2</span>&nbsp;<span class="op" id="3639740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639744">t</span><span class="op" id="3639745">.</span><span class="ident" id="3639746">unexpected</span><span class="op" id="3639756">(</span><span class="ident" id="3639757">token</span><span class="op" id="3639762">,</span>&nbsp;<span class="ident" id="3639764">context</span><span class="op" id="3639771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3639774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3639777">return</span>&nbsp;<span class="ident" id="3639784">token</span><br>
<span class="lineno"></span><span class="op" id="3639790">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="3639793">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3639860">func</span>&nbsp;<span class="op" id="3639865">(</span><span class="ident" id="3639866">t</span>&nbsp;<span class="op" id="3639868">*</span><span class="ident" id="3639869">Tree</span><span class="op" id="3639873">)</span>&nbsp;<span class="ident" id="3639875">unexpected</span><span class="op" id="3639885">(</span><span class="ident" id="3639886">token</span>&nbsp;<span class="ident" id="3639892">item</span><span class="op" id="3639896">,</span>&nbsp;<span class="ident" id="3639898">context</span>&nbsp;<span class="builtintype" id="3639906">string</span><span class="op" id="3639912">)</span>&nbsp;<span class="op" id="3639914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3639917">t</span><span class="op" id="3639918">.</span><span class="ident" id="3639919">errorf</span><span class="op" id="3639925">(</span><span class="string" id="3639926">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3639947">,</span>&nbsp;<span class="ident" id="3639949">token</span><span class="op" id="3639954">,</span>&nbsp;<span class="ident" id="3639956">context</span><span class="op" id="3639963">)</span><br>
<span class="lineno"></span><span class="op" id="3639965">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3639968">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="3640054">func</span>&nbsp;<span class="op" id="3640059">(</span><span class="ident" id="3640060">t</span>&nbsp;<span class="op" id="3640062">*</span><span class="ident" id="3640063">Tree</span><span class="op" id="3640067">)</span>&nbsp;<span class="builtinfunc" id="3640069">recover</span><span class="op" id="3640076">(</span><span class="ident" id="3640077">errp</span>&nbsp;<span class="op" id="3640082">*</span><span class="builtintype" id="3640083">error</span><span class="op" id="3640088">)</span>&nbsp;<span class="op" id="3640090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640093">e</span>&nbsp;<span class="op" id="3640095">:=</span>&nbsp;<span class="builtinfunc" id="3640098">recover</span><span class="op" id="3640105">(</span><span class="op" id="3640106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640109">if</span>&nbsp;<span class="ident" id="3640112">e</span>&nbsp;<span class="op" id="3640114">!=</span>&nbsp;<span class="builtintype" id="3640117">nil</span>&nbsp;<span class="op" id="3640121">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640125">if</span>&nbsp;<span class="ident" id="3640128">_</span><span class="op" id="3640129">,</span>&nbsp;<span class="ident" id="3640131">ok</span>&nbsp;<span class="op" id="3640134">:=</span>&nbsp;<span class="ident" id="3640137">e</span><span class="op" id="3640138">.</span><span class="op" id="3640139">(</span><span class="ident" id="3640140">runtime</span><span class="op" id="3640147">.</span><span class="ident" id="3640148">Error</span><span class="op" id="3640153">)</span><span class="op" id="3640154">;</span>&nbsp;<span class="ident" id="3640156">ok</span>&nbsp;<span class="op" id="3640159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3640164">panic</span><span class="op" id="3640169">(</span><span class="ident" id="3640170">e</span><span class="op" id="3640171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640179">if</span>&nbsp;<span class="ident" id="3640182">t</span>&nbsp;<span class="op" id="3640184">!=</span>&nbsp;<span class="builtintype" id="3640187">nil</span>&nbsp;<span class="op" id="3640191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640196">t</span><span class="op" id="3640197">.</span><span class="ident" id="3640198">stopParse</span><span class="op" id="3640207">(</span><span class="op" id="3640208">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640216">*</span><span class="ident" id="3640217">errp</span>&nbsp;<span class="op" id="3640222">=</span>&nbsp;<span class="ident" id="3640224">e</span><span class="op" id="3640225">.</span><span class="op" id="3640226">(</span><span class="builtintype" id="3640227">error</span><span class="op" id="3640232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3640235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640238">return</span><br>
<span class="lineno"></span><span class="op" id="3640245">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="3640248">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="3640303">func</span>&nbsp;<span class="op" id="3640308">(</span><span class="ident" id="3640309">t</span>&nbsp;<span class="op" id="3640311">*</span><span class="ident" id="3640312">Tree</span><span class="op" id="3640316">)</span>&nbsp;<span class="ident" id="3640318">startParse</span><span class="op" id="3640328">(</span><span class="ident" id="3640329">funcs</span>&nbsp;<span class="op" id="3640335">[</span><span class="op" id="3640336">]</span><span class="keyword" id="3640337">map</span><span class="op" id="3640340">[</span><span class="builtintype" id="3640341">string</span><span class="op" id="3640347">]</span><span class="keyword" id="3640348">interface</span><span class="op" id="3640357">{</span><span class="op" id="3640358">}</span><span class="op" id="3640359">,</span>&nbsp;<span class="ident" id="3640361">lex</span>&nbsp;<span class="op" id="3640365">*</span><span class="ident" id="3640366">lexer</span><span class="op" id="3640371">)</span>&nbsp;<span class="op" id="3640373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640376">t</span><span class="op" id="3640377">.</span><span class="ident" id="3640378">Root</span>&nbsp;<span class="op" id="3640383">=</span>&nbsp;<span class="builtintype" id="3640385">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640390">t</span><span class="op" id="3640391">.</span><span class="ident" id="3640392">lex</span>&nbsp;<span class="op" id="3640396">=</span>&nbsp;<span class="ident" id="3640398">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640403">t</span><span class="op" id="3640404">.</span><span class="ident" id="3640405">vars</span>&nbsp;<span class="op" id="3640410">=</span>&nbsp;<span class="op" id="3640412">[</span><span class="op" id="3640413">]</span><span class="builtintype" id="3640414">string</span><span class="op" id="3640420">{</span><span class="string" id="3640421">&#34;$&#34;</span><span class="op" id="3640424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640427">t</span><span class="op" id="3640428">.</span><span class="ident" id="3640429">funcs</span>&nbsp;<span class="op" id="3640435">=</span>&nbsp;<span class="ident" id="3640437">funcs</span><br>
<span class="lineno"></span><span class="op" id="3640443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3640446">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="3640479">func</span>&nbsp;<span class="op" id="3640484">(</span><span class="ident" id="3640485">t</span>&nbsp;<span class="op" id="3640487">*</span><span class="ident" id="3640488">Tree</span><span class="op" id="3640492">)</span>&nbsp;<span class="ident" id="3640494">stopParse</span><span class="op" id="3640503">(</span><span class="op" id="3640504">)</span>&nbsp;<span class="op" id="3640506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640509">t</span><span class="op" id="3640510">.</span><span class="ident" id="3640511">lex</span>&nbsp;<span class="op" id="3640515">=</span>&nbsp;<span class="builtintype" id="3640517">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640522">t</span><span class="op" id="3640523">.</span><span class="ident" id="3640524">vars</span>&nbsp;<span class="op" id="3640529">=</span>&nbsp;<span class="builtintype" id="3640531">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640536">t</span><span class="op" id="3640537">.</span><span class="ident" id="3640538">funcs</span>&nbsp;<span class="op" id="3640544">=</span>&nbsp;<span class="builtintype" id="3640546">nil</span><br>
<span class="lineno"></span><span class="op" id="3640550">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3640553">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3640633">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3640712">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3640790">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="3640810">func</span>&nbsp;<span class="op" id="3640815">(</span><span class="ident" id="3640816">t</span>&nbsp;<span class="op" id="3640818">*</span><span class="ident" id="3640819">Tree</span><span class="op" id="3640823">)</span>&nbsp;<span class="ident" id="3640825">Parse</span><span class="op" id="3640830">(</span><span class="ident" id="3640831">text</span><span class="op" id="3640835">,</span>&nbsp;<span class="ident" id="3640837">leftDelim</span><span class="op" id="3640846">,</span>&nbsp;<span class="ident" id="3640848">rightDelim</span>&nbsp;<span class="builtintype" id="3640859">string</span><span class="op" id="3640865">,</span>&nbsp;<span class="ident" id="3640867">treeSet</span>&nbsp;<span class="keyword" id="3640875">map</span><span class="op" id="3640878">[</span><span class="builtintype" id="3640879">string</span><span class="op" id="3640885">]</span><span class="op" id="3640886">*</span><span class="ident" id="3640887">Tree</span><span class="op" id="3640891">,</span>&nbsp;<span class="ident" id="3640893">funcs</span>&nbsp;<span class="op" id="3640899">...</span><span class="keyword" id="3640902">map</span><span class="op" id="3640905">[</span><span class="builtintype" id="3640906">string</span><span class="op" id="3640912">]</span><span class="keyword" id="3640913">interface</span><span class="op" id="3640922">{</span><span class="op" id="3640923">}</span><span class="op" id="3640924">)</span>&nbsp;<span class="op" id="3640926">(</span><span class="ident" id="3640927">tree</span>&nbsp;<span class="op" id="3640932">*</span><span class="ident" id="3640933">Tree</span><span class="op" id="3640937">,</span>&nbsp;<span class="ident" id="3640939">err</span>&nbsp;<span class="builtintype" id="3640943">error</span><span class="op" id="3640948">)</span>&nbsp;<span class="op" id="3640950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3640953">defer</span>&nbsp;<span class="ident" id="3640959">t</span><span class="op" id="3640960">.</span><span class="builtinfunc" id="3640961">recover</span><span class="op" id="3640968">(</span><span class="op" id="3640969">&amp;</span><span class="ident" id="3640970">err</span><span class="op" id="3640973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640976">t</span><span class="op" id="3640977">.</span><span class="ident" id="3640978">ParseName</span>&nbsp;<span class="op" id="3640988">=</span>&nbsp;<span class="ident" id="3640990">t</span><span class="op" id="3640991">.</span><span class="ident" id="3640992">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3640998">t</span><span class="op" id="3640999">.</span><span class="ident" id="3641000">startParse</span><span class="op" id="3641010">(</span><span class="ident" id="3641011">funcs</span><span class="op" id="3641016">,</span>&nbsp;<span class="ident" id="3641018">lex</span><span class="op" id="3641021">(</span><span class="ident" id="3641022">t</span><span class="op" id="3641023">.</span><span class="ident" id="3641024">Name</span><span class="op" id="3641028">,</span>&nbsp;<span class="ident" id="3641030">text</span><span class="op" id="3641034">,</span>&nbsp;<span class="ident" id="3641036">leftDelim</span><span class="op" id="3641045">,</span>&nbsp;<span class="ident" id="3641047">rightDelim</span><span class="op" id="3641057">)</span><span class="op" id="3641058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641061">t</span><span class="op" id="3641062">.</span><span class="ident" id="3641063">text</span>&nbsp;<span class="op" id="3641068">=</span>&nbsp;<span class="ident" id="3641070">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641076">t</span><span class="op" id="3641077">.</span><span class="ident" id="3641078">parse</span><span class="op" id="3641083">(</span><span class="ident" id="3641084">treeSet</span><span class="op" id="3641091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641094">t</span><span class="op" id="3641095">.</span><span class="ident" id="3641096">add</span><span class="op" id="3641099">(</span><span class="ident" id="3641100">treeSet</span><span class="op" id="3641107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641110">t</span><span class="op" id="3641111">.</span><span class="ident" id="3641112">stopParse</span><span class="op" id="3641121">(</span><span class="op" id="3641122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641125">return</span>&nbsp;<span class="ident" id="3641132">t</span><span class="op" id="3641133">,</span>&nbsp;<span class="builtintype" id="3641135">nil</span><br>
<span class="lineno"></span><span class="op" id="3641139">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3641142">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="3641175">func</span>&nbsp;<span class="op" id="3641180">(</span><span class="ident" id="3641181">t</span>&nbsp;<span class="op" id="3641183">*</span><span class="ident" id="3641184">Tree</span><span class="op" id="3641188">)</span>&nbsp;<span class="ident" id="3641190">add</span><span class="op" id="3641193">(</span><span class="ident" id="3641194">treeSet</span>&nbsp;<span class="keyword" id="3641202">map</span><span class="op" id="3641205">[</span><span class="builtintype" id="3641206">string</span><span class="op" id="3641212">]</span><span class="op" id="3641213">*</span><span class="ident" id="3641214">Tree</span><span class="op" id="3641218">)</span>&nbsp;<span class="op" id="3641220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641223">tree</span>&nbsp;<span class="op" id="3641228">:=</span>&nbsp;<span class="ident" id="3641231">treeSet</span><span class="op" id="3641238">[</span><span class="ident" id="3641239">t</span><span class="op" id="3641240">.</span><span class="ident" id="3641241">Name</span><span class="op" id="3641245">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641248">if</span>&nbsp;<span class="ident" id="3641251">tree</span>&nbsp;<span class="op" id="3641256">==</span>&nbsp;<span class="builtintype" id="3641259">nil</span>&nbsp;<span class="op" id="3641263">||</span>&nbsp;<span class="ident" id="3641266">IsEmptyTree</span><span class="op" id="3641277">(</span><span class="ident" id="3641278">tree</span><span class="op" id="3641282">.</span><span class="ident" id="3641283">Root</span><span class="op" id="3641287">)</span>&nbsp;<span class="op" id="3641289">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641293">treeSet</span><span class="op" id="3641300">[</span><span class="ident" id="3641301">t</span><span class="op" id="3641302">.</span><span class="ident" id="3641303">Name</span><span class="op" id="3641307">]</span>&nbsp;<span class="op" id="3641309">=</span>&nbsp;<span class="ident" id="3641311">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641315">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641326">if</span>&nbsp;<span class="op" id="3641329">!</span><span class="ident" id="3641330">IsEmptyTree</span><span class="op" id="3641341">(</span><span class="ident" id="3641342">t</span><span class="op" id="3641343">.</span><span class="ident" id="3641344">Root</span><span class="op" id="3641348">)</span>&nbsp;<span class="op" id="3641350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641354">t</span><span class="op" id="3641355">.</span><span class="ident" id="3641356">errorf</span><span class="op" id="3641362">(</span><span class="string" id="3641363">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3641409">,</span>&nbsp;<span class="ident" id="3641411">t</span><span class="op" id="3641412">.</span><span class="ident" id="3641413">Name</span><span class="op" id="3641417">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641420">}</span><br>
<span class="lineno"></span><span class="op" id="3641422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3641425">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="3641507">func</span>&nbsp;<span class="ident" id="3641512">IsEmptyTree</span><span class="op" id="3641523">(</span><span class="ident" id="3641524">n</span>&nbsp;<span class="ident" id="3641526">Node</span><span class="op" id="3641530">)</span>&nbsp;<span class="builtintype" id="3641532">bool</span>&nbsp;<span class="op" id="3641537">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641540">switch</span>&nbsp;<span class="ident" id="3641547">n</span>&nbsp;<span class="op" id="3641549">:=</span>&nbsp;<span class="ident" id="3641552">n</span><span class="op" id="3641553">.</span><span class="op" id="3641554">(</span><span class="keyword" id="3641555">type</span><span class="op" id="3641559">)</span>&nbsp;<span class="op" id="3641561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641564">case</span>&nbsp;<span class="builtintype" id="3641569">nil</span><span class="op" id="3641572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641576">return</span>&nbsp;<span class="builtintype" id="3641583">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641589">case</span>&nbsp;<span class="op" id="3641594">*</span><span class="ident" id="3641595">ActionNode</span><span class="op" id="3641605">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641608">case</span>&nbsp;<span class="op" id="3641613">*</span><span class="ident" id="3641614">IfNode</span><span class="op" id="3641620">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641623">case</span>&nbsp;<span class="op" id="3641628">*</span><span class="ident" id="3641629">ListNode</span><span class="op" id="3641637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641641">for</span>&nbsp;<span class="ident" id="3641645">_</span><span class="op" id="3641646">,</span>&nbsp;<span class="ident" id="3641648">node</span>&nbsp;<span class="op" id="3641653">:=</span>&nbsp;<span class="keyword" id="3641656">range</span>&nbsp;<span class="ident" id="3641662">n</span><span class="op" id="3641663">.</span><span class="ident" id="3641664">Nodes</span>&nbsp;<span class="op" id="3641670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641675">if</span>&nbsp;<span class="op" id="3641678">!</span><span class="ident" id="3641679">IsEmptyTree</span><span class="op" id="3641690">(</span><span class="ident" id="3641691">node</span><span class="op" id="3641695">)</span>&nbsp;<span class="op" id="3641697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641703">return</span>&nbsp;<span class="builtintype" id="3641710">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641719">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641727">return</span>&nbsp;<span class="builtintype" id="3641734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641740">case</span>&nbsp;<span class="op" id="3641745">*</span><span class="ident" id="3641746">RangeNode</span><span class="op" id="3641755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641758">case</span>&nbsp;<span class="op" id="3641763">*</span><span class="ident" id="3641764">TemplateNode</span><span class="op" id="3641776">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641779">case</span>&nbsp;<span class="op" id="3641784">*</span><span class="ident" id="3641785">TextNode</span><span class="op" id="3641793">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641797">return</span>&nbsp;<span class="builtinfunc" id="3641804">len</span><span class="op" id="3641807">(</span><span class="ident" id="3641808">bytes</span><span class="op" id="3641813">.</span><span class="ident" id="3641814">TrimSpace</span><span class="op" id="3641823">(</span><span class="ident" id="3641824">n</span><span class="op" id="3641825">.</span><span class="ident" id="3641826">Text</span><span class="op" id="3641830">)</span><span class="op" id="3641831">)</span>&nbsp;<span class="op" id="3641833">==</span>&nbsp;<span class="num" id="3641836">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641839">case</span>&nbsp;<span class="op" id="3641844">*</span><span class="ident" id="3641845">WithNode</span><span class="op" id="3641853">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641856">default</span><span class="op" id="3641863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3641867">panic</span><span class="op" id="3641872">(</span><span class="string" id="3641873">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="3641890">+</span>&nbsp;<span class="ident" id="3641892">n</span><span class="op" id="3641893">.</span><span class="ident" id="3641894">String</span><span class="op" id="3641900">(</span><span class="op" id="3641901">)</span><span class="op" id="3641902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641905">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3641908">return</span>&nbsp;<span class="builtintype" id="3641915">false</span><br>
<span class="lineno"></span><span class="op" id="3641921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3641924">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3641994">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="3642051">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3642070">func</span>&nbsp;<span class="op" id="3642075">(</span><span class="ident" id="3642076">t</span>&nbsp;<span class="op" id="3642078">*</span><span class="ident" id="3642079">Tree</span><span class="op" id="3642083">)</span>&nbsp;<span class="ident" id="3642085">parse</span><span class="op" id="3642090">(</span><span class="ident" id="3642091">treeSet</span>&nbsp;<span class="keyword" id="3642099">map</span><span class="op" id="3642102">[</span><span class="builtintype" id="3642103">string</span><span class="op" id="3642109">]</span><span class="op" id="3642110">*</span><span class="ident" id="3642111">Tree</span><span class="op" id="3642115">)</span>&nbsp;<span class="op" id="3642117">(</span><span class="ident" id="3642118">next</span>&nbsp;<span class="ident" id="3642123">Node</span><span class="op" id="3642127">)</span>&nbsp;<span class="op" id="3642129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642132">t</span><span class="op" id="3642133">.</span><span class="ident" id="3642134">Root</span>&nbsp;<span class="op" id="3642139">=</span>&nbsp;<span class="ident" id="3642141">t</span><span class="op" id="3642142">.</span><span class="ident" id="3642143">newList</span><span class="op" id="3642150">(</span><span class="ident" id="3642151">t</span><span class="op" id="3642152">.</span><span class="ident" id="3642153">peek</span><span class="op" id="3642157">(</span><span class="op" id="3642158">)</span><span class="op" id="3642159">.</span><span class="ident" id="3642160">pos</span><span class="op" id="3642163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642166">for</span>&nbsp;<span class="ident" id="3642170">t</span><span class="op" id="3642171">.</span><span class="ident" id="3642172">peek</span><span class="op" id="3642176">(</span><span class="op" id="3642177">)</span><span class="op" id="3642178">.</span><span class="ident" id="3642179">typ</span>&nbsp;<span class="op" id="3642183">!=</span>&nbsp;<span class="ident" id="3642186">itemEOF</span>&nbsp;<span class="op" id="3642194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642198">if</span>&nbsp;<span class="ident" id="3642201">t</span><span class="op" id="3642202">.</span><span class="ident" id="3642203">peek</span><span class="op" id="3642207">(</span><span class="op" id="3642208">)</span><span class="op" id="3642209">.</span><span class="ident" id="3642210">typ</span>&nbsp;<span class="op" id="3642214">==</span>&nbsp;<span class="ident" id="3642217">itemLeftDelim</span>&nbsp;<span class="op" id="3642231">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642236">delim</span>&nbsp;<span class="op" id="3642242">:=</span>&nbsp;<span class="ident" id="3642245">t</span><span class="op" id="3642246">.</span><span class="ident" id="3642247">next</span><span class="op" id="3642251">(</span><span class="op" id="3642252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642257">if</span>&nbsp;<span class="ident" id="3642260">t</span><span class="op" id="3642261">.</span><span class="ident" id="3642262">nextNonSpace</span><span class="op" id="3642274">(</span><span class="op" id="3642275">)</span><span class="op" id="3642276">.</span><span class="ident" id="3642277">typ</span>&nbsp;<span class="op" id="3642281">==</span>&nbsp;<span class="ident" id="3642284">itemDefine</span>&nbsp;<span class="op" id="3642295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642301">newT</span>&nbsp;<span class="op" id="3642306">:=</span>&nbsp;<span class="ident" id="3642309">New</span><span class="op" id="3642312">(</span><span class="string" id="3642313">&#34;definition&#34;</span><span class="op" id="3642325">)</span>&nbsp;<span class="comment" id="3642327">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642372">newT</span><span class="op" id="3642376">.</span><span class="ident" id="3642377">text</span>&nbsp;<span class="op" id="3642382">=</span>&nbsp;<span class="ident" id="3642384">t</span><span class="op" id="3642385">.</span><span class="ident" id="3642386">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642395">newT</span><span class="op" id="3642399">.</span><span class="ident" id="3642400">ParseName</span>&nbsp;<span class="op" id="3642410">=</span>&nbsp;<span class="ident" id="3642412">t</span><span class="op" id="3642413">.</span><span class="ident" id="3642414">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642428">newT</span><span class="op" id="3642432">.</span><span class="ident" id="3642433">startParse</span><span class="op" id="3642443">(</span><span class="ident" id="3642444">t</span><span class="op" id="3642445">.</span><span class="ident" id="3642446">funcs</span><span class="op" id="3642451">,</span>&nbsp;<span class="ident" id="3642453">t</span><span class="op" id="3642454">.</span><span class="ident" id="3642455">lex</span><span class="op" id="3642458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642464">newT</span><span class="op" id="3642468">.</span><span class="ident" id="3642469">parseDefinition</span><span class="op" id="3642484">(</span><span class="ident" id="3642485">treeSet</span><span class="op" id="3642492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642498">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3642510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642515">t</span><span class="op" id="3642516">.</span><span class="ident" id="3642517">backup2</span><span class="op" id="3642524">(</span><span class="ident" id="3642525">delim</span><span class="op" id="3642530">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3642534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642538">n</span>&nbsp;<span class="op" id="3642540">:=</span>&nbsp;<span class="ident" id="3642543">t</span><span class="op" id="3642544">.</span><span class="ident" id="3642545">textOrAction</span><span class="op" id="3642557">(</span><span class="op" id="3642558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642562">if</span>&nbsp;<span class="ident" id="3642565">n</span><span class="op" id="3642566">.</span><span class="ident" id="3642567">Type</span><span class="op" id="3642571">(</span><span class="op" id="3642572">)</span>&nbsp;<span class="op" id="3642574">==</span>&nbsp;<span class="ident" id="3642577">nodeEnd</span>&nbsp;<span class="op" id="3642585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642590">t</span><span class="op" id="3642591">.</span><span class="ident" id="3642592">errorf</span><span class="op" id="3642598">(</span><span class="string" id="3642599">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="3642614">,</span>&nbsp;<span class="ident" id="3642616">n</span><span class="op" id="3642617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3642621">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642625">t</span><span class="op" id="3642626">.</span><span class="ident" id="3642627">Root</span><span class="op" id="3642631">.</span><span class="builtinfunc" id="3642632">append</span><span class="op" id="3642638">(</span><span class="ident" id="3642639">n</span><span class="op" id="3642640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3642643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642646">return</span>&nbsp;<span class="builtintype" id="3642653">nil</span><br>
<span class="lineno"></span><span class="op" id="3642657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="3642660">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3642736">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="3642817">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="3642834">func</span>&nbsp;<span class="op" id="3642839">(</span><span class="ident" id="3642840">t</span>&nbsp;<span class="op" id="3642842">*</span><span class="ident" id="3642843">Tree</span><span class="op" id="3642847">)</span>&nbsp;<span class="ident" id="3642849">parseDefinition</span><span class="op" id="3642864">(</span><span class="ident" id="3642865">treeSet</span>&nbsp;<span class="keyword" id="3642873">map</span><span class="op" id="3642876">[</span><span class="builtintype" id="3642877">string</span><span class="op" id="3642883">]</span><span class="op" id="3642884">*</span><span class="ident" id="3642885">Tree</span><span class="op" id="3642889">)</span>&nbsp;<span class="op" id="3642891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642894">const</span>&nbsp;<span class="ident" id="3642900">context</span>&nbsp;<span class="op" id="3642908">=</span>&nbsp;<span class="string" id="3642910">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642927">name</span>&nbsp;<span class="op" id="3642932">:=</span>&nbsp;<span class="ident" id="3642935">t</span><span class="op" id="3642936">.</span><span class="ident" id="3642937">expectOneOf</span><span class="op" id="3642948">(</span><span class="ident" id="3642949">itemString</span><span class="op" id="3642959">,</span>&nbsp;<span class="ident" id="3642961">itemRawString</span><span class="op" id="3642974">,</span>&nbsp;<span class="ident" id="3642976">context</span><span class="op" id="3642983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642986">var</span>&nbsp;<span class="ident" id="3642990">err</span>&nbsp;<span class="builtintype" id="3642994">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643001">t</span><span class="op" id="3643002">.</span><span class="ident" id="3643003">Name</span><span class="op" id="3643007">,</span>&nbsp;<span class="ident" id="3643009">err</span>&nbsp;<span class="op" id="3643013">=</span>&nbsp;<span class="ident" id="3643015">strconv</span><span class="op" id="3643022">.</span><span class="ident" id="3643023">Unquote</span><span class="op" id="3643030">(</span><span class="ident" id="3643031">name</span><span class="op" id="3643035">.</span><span class="ident" id="3643036">val</span><span class="op" id="3643039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643042">if</span>&nbsp;<span class="ident" id="3643045">err</span>&nbsp;<span class="op" id="3643049">!=</span>&nbsp;<span class="builtintype" id="3643052">nil</span>&nbsp;<span class="op" id="3643056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643060">t</span><span class="op" id="3643061">.</span><span class="builtintype" id="3643062">error</span><span class="op" id="3643067">(</span><span class="ident" id="3643068">err</span><span class="op" id="3643071">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3643074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643077">t</span><span class="op" id="3643078">.</span><span class="ident" id="3643079">expect</span><span class="op" id="3643085">(</span><span class="ident" id="3643086">itemRightDelim</span><span class="op" id="3643100">,</span>&nbsp;<span class="ident" id="3643102">context</span><span class="op" id="3643109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643112">var</span>&nbsp;<span class="ident" id="3643116">end</span>&nbsp;<span class="ident" id="3643120">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643126">t</span><span class="op" id="3643127">.</span><span class="ident" id="3643128">Root</span><span class="op" id="3643132">,</span>&nbsp;<span class="ident" id="3643134">end</span>&nbsp;<span class="op" id="3643138">=</span>&nbsp;<span class="ident" id="3643140">t</span><span class="op" id="3643141">.</span><span class="ident" id="3643142">itemList</span><span class="op" id="3643150">(</span><span class="op" id="3643151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643154">if</span>&nbsp;<span class="ident" id="3643157">end</span><span class="op" id="3643160">.</span><span class="ident" id="3643161">Type</span><span class="op" id="3643165">(</span><span class="op" id="3643166">)</span>&nbsp;<span class="op" id="3643168">!=</span>&nbsp;<span class="ident" id="3643171">nodeEnd</span>&nbsp;<span class="op" id="3643179">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643183">t</span><span class="op" id="3643184">.</span><span class="ident" id="3643185">errorf</span><span class="op" id="3643191">(</span><span class="string" id="3643192">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3643213">,</span>&nbsp;<span class="ident" id="3643215">end</span><span class="op" id="3643218">,</span>&nbsp;<span class="ident" id="3643220">context</span><span class="op" id="3643227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3643230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643233">t</span><span class="op" id="3643234">.</span><span class="ident" id="3643235">add</span><span class="op" id="3643238">(</span><span class="ident" id="3643239">treeSet</span><span class="op" id="3643246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643249">t</span><span class="op" id="3643250">.</span><span class="ident" id="3643251">stopParse</span><span class="op" id="3643260">(</span><span class="op" id="3643261">)</span><br>
<span class="lineno"></span><span class="op" id="3643263">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="3643266">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="3643279">//&nbsp;&nbsp;&nbsp;&nbsp;textOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="3643296">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="3643355">func</span>&nbsp;<span class="op" id="3643360">(</span><span class="ident" id="3643361">t</span>&nbsp;<span class="op" id="3643363">*</span><span class="ident" id="3643364">Tree</span><span class="op" id="3643368">)</span>&nbsp;<span class="ident" id="3643370">itemList</span><span class="op" id="3643378">(</span><span class="op" id="3643379">)</span>&nbsp;<span class="op" id="3643381">(</span><span class="ident" id="3643382">list</span>&nbsp;<span class="op" id="3643387">*</span><span class="ident" id="3643388">ListNode</span><span class="op" id="3643396">,</span>&nbsp;<span class="ident" id="3643398">next</span>&nbsp;<span class="ident" id="3643403">Node</span><span class="op" id="3643407">)</span>&nbsp;<span class="op" id="3643409">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643412">list</span>&nbsp;<span class="op" id="3643417">=</span>&nbsp;<span class="ident" id="3643419">t</span><span class="op" id="3643420">.</span><span class="ident" id="3643421">newList</span><span class="op" id="3643428">(</span><span class="ident" id="3643429">t</span><span class="op" id="3643430">.</span><span class="ident" id="3643431">peekNonSpace</span><span class="op" id="3643443">(</span><span class="op" id="3643444">)</span><span class="op" id="3643445">.</span><span class="ident" id="3643446">pos</span><span class="op" id="3643449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643452">for</span>&nbsp;<span class="ident" id="3643456">t</span><span class="op" id="3643457">.</span><span class="ident" id="3643458">peekNonSpace</span><span class="op" id="3643470">(</span><span class="op" id="3643471">)</span><span class="op" id="3643472">.</span><span class="ident" id="3643473">typ</span>&nbsp;<span class="op" id="3643477">!=</span>&nbsp;<span class="ident" id="3643480">itemEOF</span>&nbsp;<span class="op" id="3643488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643492">n</span>&nbsp;<span class="op" id="3643494">:=</span>&nbsp;<span class="ident" id="3643497">t</span><span class="op" id="3643498">.</span><span class="ident" id="3643499">textOrAction</span><span class="op" id="3643511">(</span><span class="op" id="3643512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643516">switch</span>&nbsp;<span class="ident" id="3643523">n</span><span class="op" id="3643524">.</span><span class="ident" id="3643525">Type</span><span class="op" id="3643529">(</span><span class="op" id="3643530">)</span>&nbsp;<span class="op" id="3643532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643536">case</span>&nbsp;<span class="ident" id="3643541">nodeEnd</span><span class="op" id="3643548">,</span>&nbsp;<span class="ident" id="3643550">nodeElse</span><span class="op" id="3643558">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643563">return</span>&nbsp;<span class="ident" id="3643570">list</span><span class="op" id="3643574">,</span>&nbsp;<span class="ident" id="3643576">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3643580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643584">list</span><span class="op" id="3643588">.</span><span class="builtinfunc" id="3643589">append</span><span class="op" id="3643595">(</span><span class="ident" id="3643596">n</span><span class="op" id="3643597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3643600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643603">t</span><span class="op" id="3643604">.</span><span class="ident" id="3643605">errorf</span><span class="op" id="3643611">(</span><span class="string" id="3643612">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="3643628">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643631">return</span><br>
<span class="lineno"></span><span class="op" id="3643638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3643641">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="3643658">//&nbsp;&nbsp;&nbsp;&nbsp;text&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="3643675">func</span>&nbsp;<span class="op" id="3643680">(</span><span class="ident" id="3643681">t</span>&nbsp;<span class="op" id="3643683">*</span><span class="ident" id="3643684">Tree</span><span class="op" id="3643688">)</span>&nbsp;<span class="ident" id="3643690">textOrAction</span><span class="op" id="3643702">(</span><span class="op" id="3643703">)</span>&nbsp;<span class="ident" id="3643705">Node</span>&nbsp;<span class="op" id="3643710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643713">switch</span>&nbsp;<span class="ident" id="3643720">token</span>&nbsp;<span class="op" id="3643726">:=</span>&nbsp;<span class="ident" id="3643729">t</span><span class="op" id="3643730">.</span><span class="ident" id="3643731">nextNonSpace</span><span class="op" id="3643743">(</span><span class="op" id="3643744">)</span><span class="op" id="3643745">;</span>&nbsp;<span class="ident" id="3643747">token</span><span class="op" id="3643752">.</span><span class="ident" id="3643753">typ</span>&nbsp;<span class="op" id="3643757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643760">case</span>&nbsp;<span class="ident" id="3643765">itemText</span><span class="op" id="3643773">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643777">return</span>&nbsp;<span class="ident" id="3643784">t</span><span class="op" id="3643785">.</span><span class="ident" id="3643786">newText</span><span class="op" id="3643793">(</span><span class="ident" id="3643794">token</span><span class="op" id="3643799">.</span><span class="ident" id="3643800">pos</span><span class="op" id="3643803">,</span>&nbsp;<span class="ident" id="3643805">token</span><span class="op" id="3643810">.</span><span class="ident" id="3643811">val</span><span class="op" id="3643814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643817">case</span>&nbsp;<span class="ident" id="3643822">itemLeftDelim</span><span class="op" id="3643835">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643839">return</span>&nbsp;<span class="ident" id="3643846">t</span><span class="op" id="3643847">.</span><span class="ident" id="3643848">action</span><span class="op" id="3643854">(</span><span class="op" id="3643855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643858">default</span><span class="op" id="3643865">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643869">t</span><span class="op" id="3643870">.</span><span class="ident" id="3643871">unexpected</span><span class="op" id="3643881">(</span><span class="ident" id="3643882">token</span><span class="op" id="3643887">,</span>&nbsp;<span class="string" id="3643889">&#34;input&#34;</span><span class="op" id="3643896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3643899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3643902">return</span>&nbsp;<span class="builtintype" id="3643909">nil</span><br>
<span class="lineno">350</span><span class="op" id="3643913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3643916">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="3643927">//&nbsp;&nbsp;&nbsp;&nbsp;control</span><br>
<span class="lineno"></span><span class="comment" id="3643938">//&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="3643964">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="3644004">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="3644052">func</span>&nbsp;<span class="op" id="3644057">(</span><span class="ident" id="3644058">t</span>&nbsp;<span class="op" id="3644060">*</span><span class="ident" id="3644061">Tree</span><span class="op" id="3644065">)</span>&nbsp;<span class="ident" id="3644067">action</span><span class="op" id="3644073">(</span><span class="op" id="3644074">)</span>&nbsp;<span class="op" id="3644076">(</span><span class="ident" id="3644077">n</span>&nbsp;<span class="ident" id="3644079">Node</span><span class="op" id="3644083">)</span>&nbsp;<span class="op" id="3644085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644088">switch</span>&nbsp;<span class="ident" id="3644095">token</span>&nbsp;<span class="op" id="3644101">:=</span>&nbsp;<span class="ident" id="3644104">t</span><span class="op" id="3644105">.</span><span class="ident" id="3644106">nextNonSpace</span><span class="op" id="3644118">(</span><span class="op" id="3644119">)</span><span class="op" id="3644120">;</span>&nbsp;<span class="ident" id="3644122">token</span><span class="op" id="3644127">.</span><span class="ident" id="3644128">typ</span>&nbsp;<span class="op" id="3644132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644135">case</span>&nbsp;<span class="ident" id="3644140">itemElse</span><span class="op" id="3644148">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644152">return</span>&nbsp;<span class="ident" id="3644159">t</span><span class="op" id="3644160">.</span><span class="ident" id="3644161">elseControl</span><span class="op" id="3644172">(</span><span class="op" id="3644173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644176">case</span>&nbsp;<span class="ident" id="3644181">itemEnd</span><span class="op" id="3644188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644192">return</span>&nbsp;<span class="ident" id="3644199">t</span><span class="op" id="3644200">.</span><span class="ident" id="3644201">endControl</span><span class="op" id="3644211">(</span><span class="op" id="3644212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644215">case</span>&nbsp;<span class="ident" id="3644220">itemIf</span><span class="op" id="3644226">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644230">return</span>&nbsp;<span class="ident" id="3644237">t</span><span class="op" id="3644238">.</span><span class="ident" id="3644239">ifControl</span><span class="op" id="3644248">(</span><span class="op" id="3644249">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644252">case</span>&nbsp;<span class="ident" id="3644257">itemRange</span><span class="op" id="3644266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644270">return</span>&nbsp;<span class="ident" id="3644277">t</span><span class="op" id="3644278">.</span><span class="ident" id="3644279">rangeControl</span><span class="op" id="3644291">(</span><span class="op" id="3644292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644295">case</span>&nbsp;<span class="ident" id="3644300">itemTemplate</span><span class="op" id="3644312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644316">return</span>&nbsp;<span class="ident" id="3644323">t</span><span class="op" id="3644324">.</span><span class="ident" id="3644325">templateControl</span><span class="op" id="3644340">(</span><span class="op" id="3644341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644344">case</span>&nbsp;<span class="ident" id="3644349">itemWith</span><span class="op" id="3644357">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644361">return</span>&nbsp;<span class="ident" id="3644368">t</span><span class="op" id="3644369">.</span><span class="ident" id="3644370">withControl</span><span class="op" id="3644381">(</span><span class="op" id="3644382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3644385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644388">t</span><span class="op" id="3644389">.</span><span class="ident" id="3644390">backup</span><span class="op" id="3644396">(</span><span class="op" id="3644397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644400">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644452">return</span>&nbsp;<span class="ident" id="3644459">t</span><span class="op" id="3644460">.</span><span class="ident" id="3644461">newAction</span><span class="op" id="3644470">(</span><span class="ident" id="3644471">t</span><span class="op" id="3644472">.</span><span class="ident" id="3644473">peek</span><span class="op" id="3644477">(</span><span class="op" id="3644478">)</span><span class="op" id="3644479">.</span><span class="ident" id="3644480">pos</span><span class="op" id="3644483">,</span>&nbsp;<span class="ident" id="3644485">t</span><span class="op" id="3644486">.</span><span class="ident" id="3644487">lex</span><span class="op" id="3644490">.</span><span class="ident" id="3644491">lineNumber</span><span class="op" id="3644501">(</span><span class="op" id="3644502">)</span><span class="op" id="3644503">,</span>&nbsp;<span class="ident" id="3644505">t</span><span class="op" id="3644506">.</span><span class="ident" id="3644507">pipeline</span><span class="op" id="3644515">(</span><span class="string" id="3644516">&#34;command&#34;</span><span class="op" id="3644525">)</span><span class="op" id="3644526">)</span><br>
<span class="lineno">375</span><span class="op" id="3644528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3644531">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="3644544">//&nbsp;&nbsp;&nbsp;&nbsp;declarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="3644584">func</span>&nbsp;<span class="op" id="3644589">(</span><span class="ident" id="3644590">t</span>&nbsp;<span class="op" id="3644592">*</span><span class="ident" id="3644593">Tree</span><span class="op" id="3644597">)</span>&nbsp;<span class="ident" id="3644599">pipeline</span><span class="op" id="3644607">(</span><span class="ident" id="3644608">context</span>&nbsp;<span class="builtintype" id="3644616">string</span><span class="op" id="3644622">)</span>&nbsp;<span class="op" id="3644624">(</span><span class="ident" id="3644625">pipe</span>&nbsp;<span class="op" id="3644630">*</span><span class="ident" id="3644631">PipeNode</span><span class="op" id="3644639">)</span>&nbsp;<span class="op" id="3644641">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644644">var</span>&nbsp;<span class="ident" id="3644648">decl</span>&nbsp;<span class="op" id="3644653">[</span><span class="op" id="3644654">]</span><span class="op" id="3644655">*</span><span class="ident" id="3644656">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644670">pos</span>&nbsp;<span class="op" id="3644674">:=</span>&nbsp;<span class="ident" id="3644677">t</span><span class="op" id="3644678">.</span><span class="ident" id="3644679">peekNonSpace</span><span class="op" id="3644691">(</span><span class="op" id="3644692">)</span><span class="op" id="3644693">.</span><span class="ident" id="3644694">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644699">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644727">for</span>&nbsp;<span class="op" id="3644731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3644735">if</span>&nbsp;<span class="ident" id="3644738">v</span>&nbsp;<span class="op" id="3644740">:=</span>&nbsp;<span class="ident" id="3644743">t</span><span class="op" id="3644744">.</span><span class="ident" id="3644745">peekNonSpace</span><span class="op" id="3644757">(</span><span class="op" id="3644758">)</span><span class="op" id="3644759">;</span>&nbsp;<span class="ident" id="3644761">v</span><span class="op" id="3644762">.</span><span class="ident" id="3644763">typ</span>&nbsp;<span class="op" id="3644767">==</span>&nbsp;<span class="ident" id="3644770">itemVariable</span>&nbsp;<span class="op" id="3644783">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644788">t</span><span class="op" id="3644789">.</span><span class="ident" id="3644790">next</span><span class="op" id="3644794">(</span><span class="op" id="3644795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644800">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644881">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644964">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3645037">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645105">tokenAfterVariable</span>&nbsp;<span class="op" id="3645124">:=</span>&nbsp;<span class="ident" id="3645127">t</span><span class="op" id="3645128">.</span><span class="ident" id="3645129">peek</span><span class="op" id="3645133">(</span><span class="op" id="3645134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645139">if</span>&nbsp;<span class="ident" id="3645142">next</span>&nbsp;<span class="op" id="3645147">:=</span>&nbsp;<span class="ident" id="3645150">t</span><span class="op" id="3645151">.</span><span class="ident" id="3645152">peekNonSpace</span><span class="op" id="3645164">(</span><span class="op" id="3645165">)</span><span class="op" id="3645166">;</span>&nbsp;<span class="ident" id="3645168">next</span><span class="op" id="3645172">.</span><span class="ident" id="3645173">typ</span>&nbsp;<span class="op" id="3645177">==</span>&nbsp;<span class="ident" id="3645180">itemColonEquals</span>&nbsp;<span class="op" id="3645196">||</span>&nbsp;<span class="op" id="3645199">(</span><span class="ident" id="3645200">next</span><span class="op" id="3645204">.</span><span class="ident" id="3645205">typ</span>&nbsp;<span class="op" id="3645209">==</span>&nbsp;<span class="ident" id="3645212">itemChar</span>&nbsp;<span class="op" id="3645221">&amp;&amp;</span>&nbsp;<span class="ident" id="3645224">next</span><span class="op" id="3645228">.</span><span class="ident" id="3645229">val</span>&nbsp;<span class="op" id="3645233">==</span>&nbsp;<span class="string" id="3645236">&#34;,&#34;</span><span class="op" id="3645239">)</span>&nbsp;<span class="op" id="3645241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645247">t</span><span class="op" id="3645248">.</span><span class="ident" id="3645249">nextNonSpace</span><span class="op" id="3645261">(</span><span class="op" id="3645262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645268">variable</span>&nbsp;<span class="op" id="3645277">:=</span>&nbsp;<span class="ident" id="3645280">t</span><span class="op" id="3645281">.</span><span class="ident" id="3645282">newVariable</span><span class="op" id="3645293">(</span><span class="ident" id="3645294">v</span><span class="op" id="3645295">.</span><span class="ident" id="3645296">pos</span><span class="op" id="3645299">,</span>&nbsp;<span class="ident" id="3645301">v</span><span class="op" id="3645302">.</span><span class="ident" id="3645303">val</span><span class="op" id="3645306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645312">decl</span>&nbsp;<span class="op" id="3645317">=</span>&nbsp;<span class="builtinfunc" id="3645319">append</span><span class="op" id="3645325">(</span><span class="ident" id="3645326">decl</span><span class="op" id="3645330">,</span>&nbsp;<span class="ident" id="3645332">variable</span><span class="op" id="3645340">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645346">t</span><span class="op" id="3645347">.</span><span class="ident" id="3645348">vars</span>&nbsp;<span class="op" id="3645353">=</span>&nbsp;<span class="builtinfunc" id="3645355">append</span><span class="op" id="3645361">(</span><span class="ident" id="3645362">t</span><span class="op" id="3645363">.</span><span class="ident" id="3645364">vars</span><span class="op" id="3645368">,</span>&nbsp;<span class="ident" id="3645370">v</span><span class="op" id="3645371">.</span><span class="ident" id="3645372">val</span><span class="op" id="3645375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645381">if</span>&nbsp;<span class="ident" id="3645384">next</span><span class="op" id="3645388">.</span><span class="ident" id="3645389">typ</span>&nbsp;<span class="op" id="3645393">==</span>&nbsp;<span class="ident" id="3645396">itemChar</span>&nbsp;<span class="op" id="3645405">&amp;&amp;</span>&nbsp;<span class="ident" id="3645408">next</span><span class="op" id="3645412">.</span><span class="ident" id="3645413">val</span>&nbsp;<span class="op" id="3645417">==</span>&nbsp;<span class="string" id="3645420">&#34;,&#34;</span>&nbsp;<span class="op" id="3645424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645431">if</span>&nbsp;<span class="ident" id="3645434">context</span>&nbsp;<span class="op" id="3645442">==</span>&nbsp;<span class="string" id="3645445">&#34;range&#34;</span>&nbsp;<span class="op" id="3645453">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3645456">len</span><span class="op" id="3645459">(</span><span class="ident" id="3645460">decl</span><span class="op" id="3645464">)</span>&nbsp;<span class="op" id="3645466">&lt;</span>&nbsp;<span class="num" id="3645468">2</span>&nbsp;<span class="op" id="3645470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645478">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645492">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645499">t</span><span class="op" id="3645500">.</span><span class="ident" id="3645501">errorf</span><span class="op" id="3645507">(</span><span class="string" id="3645508">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3645537">,</span>&nbsp;<span class="ident" id="3645539">context</span><span class="op" id="3645546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645557">}</span>&nbsp;<span class="keyword" id="3645559">else</span>&nbsp;<span class="keyword" id="3645564">if</span>&nbsp;<span class="ident" id="3645567">tokenAfterVariable</span><span class="op" id="3645585">.</span><span class="ident" id="3645586">typ</span>&nbsp;<span class="op" id="3645590">==</span>&nbsp;<span class="ident" id="3645593">itemSpace</span>&nbsp;<span class="op" id="3645603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645609">t</span><span class="op" id="3645610">.</span><span class="ident" id="3645611">backup3</span><span class="op" id="3645618">(</span><span class="ident" id="3645619">v</span><span class="op" id="3645620">,</span>&nbsp;<span class="ident" id="3645622">tokenAfterVariable</span><span class="op" id="3645640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645645">}</span>&nbsp;<span class="keyword" id="3645647">else</span>&nbsp;<span class="op" id="3645652">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645658">t</span><span class="op" id="3645659">.</span><span class="ident" id="3645660">backup2</span><span class="op" id="3645667">(</span><span class="ident" id="3645668">v</span><span class="op" id="3645669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645682">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645689">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645692">pipe</span>&nbsp;<span class="op" id="3645697">=</span>&nbsp;<span class="ident" id="3645699">t</span><span class="op" id="3645700">.</span><span class="ident" id="3645701">newPipeline</span><span class="op" id="3645712">(</span><span class="ident" id="3645713">pos</span><span class="op" id="3645716">,</span>&nbsp;<span class="ident" id="3645718">t</span><span class="op" id="3645719">.</span><span class="ident" id="3645720">lex</span><span class="op" id="3645723">.</span><span class="ident" id="3645724">lineNumber</span><span class="op" id="3645734">(</span><span class="op" id="3645735">)</span><span class="op" id="3645736">,</span>&nbsp;<span class="ident" id="3645738">decl</span><span class="op" id="3645742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645745">for</span>&nbsp;<span class="op" id="3645749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645753">switch</span>&nbsp;<span class="ident" id="3645760">token</span>&nbsp;<span class="op" id="3645766">:=</span>&nbsp;<span class="ident" id="3645769">t</span><span class="op" id="3645770">.</span><span class="ident" id="3645771">nextNonSpace</span><span class="op" id="3645783">(</span><span class="op" id="3645784">)</span><span class="op" id="3645785">;</span>&nbsp;<span class="ident" id="3645787">token</span><span class="op" id="3645792">.</span><span class="ident" id="3645793">typ</span>&nbsp;<span class="op" id="3645797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645801">case</span>&nbsp;<span class="ident" id="3645806">itemRightDelim</span><span class="op" id="3645820">,</span>&nbsp;<span class="ident" id="3645822">itemRightParen</span><span class="op" id="3645836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645841">if</span>&nbsp;<span class="builtinfunc" id="3645844">len</span><span class="op" id="3645847">(</span><span class="ident" id="3645848">pipe</span><span class="op" id="3645852">.</span><span class="ident" id="3645853">Cmds</span><span class="op" id="3645857">)</span>&nbsp;<span class="op" id="3645859">==</span>&nbsp;<span class="num" id="3645862">0</span>&nbsp;<span class="op" id="3645864">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645870">t</span><span class="op" id="3645871">.</span><span class="ident" id="3645872">errorf</span><span class="op" id="3645878">(</span><span class="string" id="3645879">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="3645901">,</span>&nbsp;<span class="ident" id="3645903">context</span><span class="op" id="3645910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645920">if</span>&nbsp;<span class="ident" id="3645923">token</span><span class="op" id="3645928">.</span><span class="ident" id="3645929">typ</span>&nbsp;<span class="op" id="3645933">==</span>&nbsp;<span class="ident" id="3645936">itemRightParen</span>&nbsp;<span class="op" id="3645951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645957">t</span><span class="op" id="3645958">.</span><span class="ident" id="3645959">backup</span><span class="op" id="3645965">(</span><span class="op" id="3645966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645971">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645976">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645985">case</span>&nbsp;<span class="ident" id="3645990">itemBool</span><span class="op" id="3645998">,</span>&nbsp;<span class="ident" id="3646000">itemCharConstant</span><span class="op" id="3646016">,</span>&nbsp;<span class="ident" id="3646018">itemComplex</span><span class="op" id="3646029">,</span>&nbsp;<span class="ident" id="3646031">itemDot</span><span class="op" id="3646038">,</span>&nbsp;<span class="ident" id="3646040">itemField</span><span class="op" id="3646049">,</span>&nbsp;<span class="ident" id="3646051">itemIdentifier</span><span class="op" id="3646065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646070">itemNumber</span><span class="op" id="3646080">,</span>&nbsp;<span class="ident" id="3646082">itemNil</span><span class="op" id="3646089">,</span>&nbsp;<span class="ident" id="3646091">itemRawString</span><span class="op" id="3646104">,</span>&nbsp;<span class="ident" id="3646106">itemString</span><span class="op" id="3646116">,</span>&nbsp;<span class="ident" id="3646118">itemVariable</span><span class="op" id="3646130">,</span>&nbsp;<span class="ident" id="3646132">itemLeftParen</span><span class="op" id="3646145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646150">t</span><span class="op" id="3646151">.</span><span class="ident" id="3646152">backup</span><span class="op" id="3646158">(</span><span class="op" id="3646159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646164">pipe</span><span class="op" id="3646168">.</span><span class="builtinfunc" id="3646169">append</span><span class="op" id="3646175">(</span><span class="ident" id="3646176">t</span><span class="op" id="3646177">.</span><span class="ident" id="3646178">command</span><span class="op" id="3646185">(</span><span class="op" id="3646186">)</span><span class="op" id="3646187">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646191">default</span><span class="op" id="3646198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646203">t</span><span class="op" id="3646204">.</span><span class="ident" id="3646205">unexpected</span><span class="op" id="3646215">(</span><span class="ident" id="3646216">token</span><span class="op" id="3646221">,</span>&nbsp;<span class="ident" id="3646223">context</span><span class="op" id="3646230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646237">}</span><br>
<span class="lineno"></span><span class="op" id="3646239">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3646242">func</span>&nbsp;<span class="op" id="3646247">(</span><span class="ident" id="3646248">t</span>&nbsp;<span class="op" id="3646250">*</span><span class="ident" id="3646251">Tree</span><span class="op" id="3646255">)</span>&nbsp;<span class="ident" id="3646257">parseControl</span><span class="op" id="3646269">(</span><span class="ident" id="3646270">allowElseIf</span>&nbsp;<span class="builtintype" id="3646282">bool</span><span class="op" id="3646286">,</span>&nbsp;<span class="ident" id="3646288">context</span>&nbsp;<span class="builtintype" id="3646296">string</span><span class="op" id="3646302">)</span>&nbsp;<span class="op" id="3646304">(</span><span class="ident" id="3646305">pos</span>&nbsp;<span class="ident" id="3646309">Pos</span><span class="op" id="3646312">,</span>&nbsp;<span class="ident" id="3646314">line</span>&nbsp;<span class="builtintype" id="3646319">int</span><span class="op" id="3646322">,</span>&nbsp;<span class="ident" id="3646324">pipe</span>&nbsp;<span class="op" id="3646329">*</span><span class="ident" id="3646330">PipeNode</span><span class="op" id="3646338">,</span>&nbsp;<span class="ident" id="3646340">list</span><span class="op" id="3646344">,</span>&nbsp;<span class="ident" id="3646346">elseList</span>&nbsp;<span class="op" id="3646355">*</span><span class="ident" id="3646356">ListNode</span><span class="op" id="3646364">)</span>&nbsp;<span class="op" id="3646366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646369">defer</span>&nbsp;<span class="ident" id="3646375">t</span><span class="op" id="3646376">.</span><span class="ident" id="3646377">popVars</span><span class="op" id="3646384">(</span><span class="builtinfunc" id="3646385">len</span><span class="op" id="3646388">(</span><span class="ident" id="3646389">t</span><span class="op" id="3646390">.</span><span class="ident" id="3646391">vars</span><span class="op" id="3646395">)</span><span class="op" id="3646396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646399">line</span>&nbsp;<span class="op" id="3646404">=</span>&nbsp;<span class="ident" id="3646406">t</span><span class="op" id="3646407">.</span><span class="ident" id="3646408">lex</span><span class="op" id="3646411">.</span><span class="ident" id="3646412">lineNumber</span><span class="op" id="3646422">(</span><span class="op" id="3646423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646426">pipe</span>&nbsp;<span class="op" id="3646431">=</span>&nbsp;<span class="ident" id="3646433">t</span><span class="op" id="3646434">.</span><span class="ident" id="3646435">pipeline</span><span class="op" id="3646443">(</span><span class="ident" id="3646444">context</span><span class="op" id="3646451">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646454">var</span>&nbsp;<span class="ident" id="3646458">next</span>&nbsp;<span class="ident" id="3646463">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646469">list</span><span class="op" id="3646473">,</span>&nbsp;<span class="ident" id="3646475">next</span>&nbsp;<span class="op" id="3646480">=</span>&nbsp;<span class="ident" id="3646482">t</span><span class="op" id="3646483">.</span><span class="ident" id="3646484">itemList</span><span class="op" id="3646492">(</span><span class="op" id="3646493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646496">switch</span>&nbsp;<span class="ident" id="3646503">next</span><span class="op" id="3646507">.</span><span class="ident" id="3646508">Type</span><span class="op" id="3646512">(</span><span class="op" id="3646513">)</span>&nbsp;<span class="op" id="3646515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646518">case</span>&nbsp;<span class="ident" id="3646523">nodeEnd</span><span class="op" id="3646530">:</span>&nbsp;<span class="comment" id="3646532">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646540">case</span>&nbsp;<span class="ident" id="3646545">nodeElse</span><span class="op" id="3646553">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646557">if</span>&nbsp;<span class="ident" id="3646560">allowElseIf</span>&nbsp;<span class="op" id="3646572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646577">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646661">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646728">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646765">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646774">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646822">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646908">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646980">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647035">if</span>&nbsp;<span class="ident" id="3647038">t</span><span class="op" id="3647039">.</span><span class="ident" id="3647040">peek</span><span class="op" id="3647044">(</span><span class="op" id="3647045">)</span><span class="op" id="3647046">.</span><span class="ident" id="3647047">typ</span>&nbsp;<span class="op" id="3647051">==</span>&nbsp;<span class="ident" id="3647054">itemIf</span>&nbsp;<span class="op" id="3647061">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647067">t</span><span class="op" id="3647068">.</span><span class="ident" id="3647069">next</span><span class="op" id="3647073">(</span><span class="op" id="3647074">)</span>&nbsp;<span class="comment" id="3647076">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647107">elseList</span>&nbsp;<span class="op" id="3647116">=</span>&nbsp;<span class="ident" id="3647118">t</span><span class="op" id="3647119">.</span><span class="ident" id="3647120">newList</span><span class="op" id="3647127">(</span><span class="ident" id="3647128">next</span><span class="op" id="3647132">.</span><span class="ident" id="3647133">Position</span><span class="op" id="3647141">(</span><span class="op" id="3647142">)</span><span class="op" id="3647143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647149">elseList</span><span class="op" id="3647157">.</span><span class="builtinfunc" id="3647158">append</span><span class="op" id="3647164">(</span><span class="ident" id="3647165">t</span><span class="op" id="3647166">.</span><span class="ident" id="3647167">ifControl</span><span class="op" id="3647176">(</span><span class="op" id="3647177">)</span><span class="op" id="3647178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3647184">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647249">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647266">elseList</span><span class="op" id="3647274">,</span>&nbsp;<span class="ident" id="3647276">next</span>&nbsp;<span class="op" id="3647281">=</span>&nbsp;<span class="ident" id="3647283">t</span><span class="op" id="3647284">.</span><span class="ident" id="3647285">itemList</span><span class="op" id="3647293">(</span><span class="op" id="3647294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647298">if</span>&nbsp;<span class="ident" id="3647301">next</span><span class="op" id="3647305">.</span><span class="ident" id="3647306">Type</span><span class="op" id="3647310">(</span><span class="op" id="3647311">)</span>&nbsp;<span class="op" id="3647313">!=</span>&nbsp;<span class="ident" id="3647316">nodeEnd</span>&nbsp;<span class="op" id="3647324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647329">t</span><span class="op" id="3647330">.</span><span class="ident" id="3647331">errorf</span><span class="op" id="3647337">(</span><span class="string" id="3647338">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="3647362">,</span>&nbsp;<span class="ident" id="3647364">next</span><span class="op" id="3647368">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647378">return</span>&nbsp;<span class="ident" id="3647385">pipe</span><span class="op" id="3647389">.</span><span class="ident" id="3647390">Position</span><span class="op" id="3647398">(</span><span class="op" id="3647399">)</span><span class="op" id="3647400">,</span>&nbsp;<span class="ident" id="3647402">line</span><span class="op" id="3647406">,</span>&nbsp;<span class="ident" id="3647408">pipe</span><span class="op" id="3647412">,</span>&nbsp;<span class="ident" id="3647414">list</span><span class="op" id="3647418">,</span>&nbsp;<span class="ident" id="3647420">elseList</span><br>
<span class="lineno"></span><span class="op" id="3647429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="3647432">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="3647439">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3647475">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3647529">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3647552">func</span>&nbsp;<span class="op" id="3647557">(</span><span class="ident" id="3647558">t</span>&nbsp;<span class="op" id="3647560">*</span><span class="ident" id="3647561">Tree</span><span class="op" id="3647565">)</span>&nbsp;<span class="ident" id="3647567">ifControl</span><span class="op" id="3647576">(</span><span class="op" id="3647577">)</span>&nbsp;<span class="ident" id="3647579">Node</span>&nbsp;<span class="op" id="3647584">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647587">return</span>&nbsp;<span class="ident" id="3647594">t</span><span class="op" id="3647595">.</span><span class="ident" id="3647596">newIf</span><span class="op" id="3647601">(</span><span class="ident" id="3647602">t</span><span class="op" id="3647603">.</span><span class="ident" id="3647604">parseControl</span><span class="op" id="3647616">(</span><span class="builtintype" id="3647617">true</span><span class="op" id="3647621">,</span>&nbsp;<span class="string" id="3647623">&#34;if&#34;</span><span class="op" id="3647627">)</span><span class="op" id="3647628">)</span><br>
<span class="lineno"></span><span class="op" id="3647630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3647633">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="3647643">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="3647682">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3647739">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3647765">func</span>&nbsp;<span class="op" id="3647770">(</span><span class="ident" id="3647771">t</span>&nbsp;<span class="op" id="3647773">*</span><span class="ident" id="3647774">Tree</span><span class="op" id="3647778">)</span>&nbsp;<span class="ident" id="3647780">rangeControl</span><span class="op" id="3647792">(</span><span class="op" id="3647793">)</span>&nbsp;<span class="ident" id="3647795">Node</span>&nbsp;<span class="op" id="3647800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647803">return</span>&nbsp;<span class="ident" id="3647810">t</span><span class="op" id="3647811">.</span><span class="ident" id="3647812">newRange</span><span class="op" id="3647820">(</span><span class="ident" id="3647821">t</span><span class="op" id="3647822">.</span><span class="ident" id="3647823">parseControl</span><span class="op" id="3647835">(</span><span class="builtintype" id="3647836">false</span><span class="op" id="3647841">,</span>&nbsp;<span class="string" id="3647843">&#34;range&#34;</span><span class="op" id="3647850">)</span><span class="op" id="3647851">)</span><br>
<span class="lineno"></span><span class="op" id="3647853">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3647856">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="3647865">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3647903">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3647959">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="3647982">func</span>&nbsp;<span class="op" id="3647987">(</span><span class="ident" id="3647988">t</span>&nbsp;<span class="op" id="3647990">*</span><span class="ident" id="3647991">Tree</span><span class="op" id="3647995">)</span>&nbsp;<span class="ident" id="3647997">withControl</span><span class="op" id="3648008">(</span><span class="op" id="3648009">)</span>&nbsp;<span class="ident" id="3648011">Node</span>&nbsp;<span class="op" id="3648016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648019">return</span>&nbsp;<span class="ident" id="3648026">t</span><span class="op" id="3648027">.</span><span class="ident" id="3648028">newWith</span><span class="op" id="3648035">(</span><span class="ident" id="3648036">t</span><span class="op" id="3648037">.</span><span class="ident" id="3648038">parseControl</span><span class="op" id="3648050">(</span><span class="builtintype" id="3648051">false</span><span class="op" id="3648056">,</span>&nbsp;<span class="string" id="3648058">&#34;with&#34;</span><span class="op" id="3648064">)</span><span class="op" id="3648065">)</span><br>
<span class="lineno"></span><span class="op" id="3648067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3648070">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="3648078">//&nbsp;&nbsp;&nbsp;&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3648089">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3648113">func</span>&nbsp;<span class="op" id="3648118">(</span><span class="ident" id="3648119">t</span>&nbsp;<span class="op" id="3648121">*</span><span class="ident" id="3648122">Tree</span><span class="op" id="3648126">)</span>&nbsp;<span class="ident" id="3648128">endControl</span><span class="op" id="3648138">(</span><span class="op" id="3648139">)</span>&nbsp;<span class="ident" id="3648141">Node</span>&nbsp;<span class="op" id="3648146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648149">return</span>&nbsp;<span class="ident" id="3648156">t</span><span class="op" id="3648157">.</span><span class="ident" id="3648158">newEnd</span><span class="op" id="3648164">(</span><span class="ident" id="3648165">t</span><span class="op" id="3648166">.</span><span class="ident" id="3648167">expect</span><span class="op" id="3648173">(</span><span class="ident" id="3648174">itemRightDelim</span><span class="op" id="3648188">,</span>&nbsp;<span class="string" id="3648190">&#34;end&#34;</span><span class="op" id="3648195">)</span><span class="op" id="3648196">.</span><span class="ident" id="3648197">pos</span><span class="op" id="3648200">)</span><br>
<span class="lineno"></span><span class="op" id="3648202">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="3648205">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="3648214">//&nbsp;&nbsp;&nbsp;&nbsp;{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="3648226">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3648251">func</span>&nbsp;<span class="op" id="3648256">(</span><span class="ident" id="3648257">t</span>&nbsp;<span class="op" id="3648259">*</span><span class="ident" id="3648260">Tree</span><span class="op" id="3648264">)</span>&nbsp;<span class="ident" id="3648266">elseControl</span><span class="op" id="3648277">(</span><span class="op" id="3648278">)</span>&nbsp;<span class="ident" id="3648280">Node</span>&nbsp;<span class="op" id="3648285">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3648288">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648320">peek</span>&nbsp;<span class="op" id="3648325">:=</span>&nbsp;<span class="ident" id="3648328">t</span><span class="op" id="3648329">.</span><span class="ident" id="3648330">peekNonSpace</span><span class="op" id="3648342">(</span><span class="op" id="3648343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648346">if</span>&nbsp;<span class="ident" id="3648349">peek</span><span class="op" id="3648353">.</span><span class="ident" id="3648354">typ</span>&nbsp;<span class="op" id="3648358">==</span>&nbsp;<span class="ident" id="3648361">itemIf</span>&nbsp;<span class="op" id="3648368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3648372">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648449">return</span>&nbsp;<span class="ident" id="3648456">t</span><span class="op" id="3648457">.</span><span class="ident" id="3648458">newElse</span><span class="op" id="3648465">(</span><span class="ident" id="3648466">peek</span><span class="op" id="3648470">.</span><span class="ident" id="3648471">pos</span><span class="op" id="3648474">,</span>&nbsp;<span class="ident" id="3648476">t</span><span class="op" id="3648477">.</span><span class="ident" id="3648478">lex</span><span class="op" id="3648481">.</span><span class="ident" id="3648482">lineNumber</span><span class="op" id="3648492">(</span><span class="op" id="3648493">)</span><span class="op" id="3648494">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3648497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648500">return</span>&nbsp;<span class="ident" id="3648507">t</span><span class="op" id="3648508">.</span><span class="ident" id="3648509">newElse</span><span class="op" id="3648516">(</span><span class="ident" id="3648517">t</span><span class="op" id="3648518">.</span><span class="ident" id="3648519">expect</span><span class="op" id="3648525">(</span><span class="ident" id="3648526">itemRightDelim</span><span class="op" id="3648540">,</span>&nbsp;<span class="string" id="3648542">&#34;else&#34;</span><span class="op" id="3648548">)</span><span class="op" id="3648549">.</span><span class="ident" id="3648550">pos</span><span class="op" id="3648553">,</span>&nbsp;<span class="ident" id="3648555">t</span><span class="op" id="3648556">.</span><span class="ident" id="3648557">lex</span><span class="op" id="3648560">.</span><span class="ident" id="3648561">lineNumber</span><span class="op" id="3648571">(</span><span class="op" id="3648572">)</span><span class="op" id="3648573">)</span><br>
<span class="lineno"></span><span class="op" id="3648575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3648578">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="3648591">//&nbsp;&nbsp;&nbsp;&nbsp;{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="3648628">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="3648703">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3648719">func</span>&nbsp;<span class="op" id="3648724">(</span><span class="ident" id="3648725">t</span>&nbsp;<span class="op" id="3648727">*</span><span class="ident" id="3648728">Tree</span><span class="op" id="3648732">)</span>&nbsp;<span class="ident" id="3648734">templateControl</span><span class="op" id="3648749">(</span><span class="op" id="3648750">)</span>&nbsp;<span class="ident" id="3648752">Node</span>&nbsp;<span class="op" id="3648757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648760">var</span>&nbsp;<span class="ident" id="3648764">name</span>&nbsp;<span class="builtintype" id="3648769">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648777">token</span>&nbsp;<span class="op" id="3648783">:=</span>&nbsp;<span class="ident" id="3648786">t</span><span class="op" id="3648787">.</span><span class="ident" id="3648788">nextNonSpace</span><span class="op" id="3648800">(</span><span class="op" id="3648801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648804">switch</span>&nbsp;<span class="ident" id="3648811">token</span><span class="op" id="3648816">.</span><span class="ident" id="3648817">typ</span>&nbsp;<span class="op" id="3648821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648824">case</span>&nbsp;<span class="ident" id="3648829">itemString</span><span class="op" id="3648839">,</span>&nbsp;<span class="ident" id="3648841">itemRawString</span><span class="op" id="3648854">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648858">s</span><span class="op" id="3648859">,</span>&nbsp;<span class="ident" id="3648861">err</span>&nbsp;<span class="op" id="3648865">:=</span>&nbsp;<span class="ident" id="3648868">strconv</span><span class="op" id="3648875">.</span><span class="ident" id="3648876">Unquote</span><span class="op" id="3648883">(</span><span class="ident" id="3648884">token</span><span class="op" id="3648889">.</span><span class="ident" id="3648890">val</span><span class="op" id="3648893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648897">if</span>&nbsp;<span class="ident" id="3648900">err</span>&nbsp;<span class="op" id="3648904">!=</span>&nbsp;<span class="builtintype" id="3648907">nil</span>&nbsp;<span class="op" id="3648911">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648916">t</span><span class="op" id="3648917">.</span><span class="builtintype" id="3648918">error</span><span class="op" id="3648923">(</span><span class="ident" id="3648924">err</span><span class="op" id="3648927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3648931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648935">name</span>&nbsp;<span class="op" id="3648940">=</span>&nbsp;<span class="ident" id="3648942">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648945">default</span><span class="op" id="3648952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648956">t</span><span class="op" id="3648957">.</span><span class="ident" id="3648958">unexpected</span><span class="op" id="3648968">(</span><span class="ident" id="3648969">token</span><span class="op" id="3648974">,</span>&nbsp;<span class="string" id="3648976">&#34;template&nbsp;invocation&#34;</span><span class="op" id="3648997">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649003">var</span>&nbsp;<span class="ident" id="3649007">pipe</span>&nbsp;<span class="op" id="3649012">*</span><span class="ident" id="3649013">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649023">if</span>&nbsp;<span class="ident" id="3649026">t</span><span class="op" id="3649027">.</span><span class="ident" id="3649028">nextNonSpace</span><span class="op" id="3649040">(</span><span class="op" id="3649041">)</span><span class="op" id="3649042">.</span><span class="ident" id="3649043">typ</span>&nbsp;<span class="op" id="3649047">!=</span>&nbsp;<span class="ident" id="3649050">itemRightDelim</span>&nbsp;<span class="op" id="3649065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649069">t</span><span class="op" id="3649070">.</span><span class="ident" id="3649071">backup</span><span class="op" id="3649077">(</span><span class="op" id="3649078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3649082">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649135">pipe</span>&nbsp;<span class="op" id="3649140">=</span>&nbsp;<span class="ident" id="3649142">t</span><span class="op" id="3649143">.</span><span class="ident" id="3649144">pipeline</span><span class="op" id="3649152">(</span><span class="string" id="3649153">&#34;template&#34;</span><span class="op" id="3649163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649169">return</span>&nbsp;<span class="ident" id="3649176">t</span><span class="op" id="3649177">.</span><span class="ident" id="3649178">newTemplate</span><span class="op" id="3649189">(</span><span class="ident" id="3649190">token</span><span class="op" id="3649195">.</span><span class="ident" id="3649196">pos</span><span class="op" id="3649199">,</span>&nbsp;<span class="ident" id="3649201">t</span><span class="op" id="3649202">.</span><span class="ident" id="3649203">lex</span><span class="op" id="3649206">.</span><span class="ident" id="3649207">lineNumber</span><span class="op" id="3649217">(</span><span class="op" id="3649218">)</span><span class="op" id="3649219">,</span>&nbsp;<span class="ident" id="3649221">name</span><span class="op" id="3649225">,</span>&nbsp;<span class="ident" id="3649227">pipe</span><span class="op" id="3649231">)</span><br>
<span class="lineno"></span><span class="op" id="3649233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="3649236">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="3649248">//&nbsp;&nbsp;&nbsp;&nbsp;operand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="3649276">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3649352">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="3649436">func</span>&nbsp;<span class="op" id="3649441">(</span><span class="ident" id="3649442">t</span>&nbsp;<span class="op" id="3649444">*</span><span class="ident" id="3649445">Tree</span><span class="op" id="3649449">)</span>&nbsp;<span class="ident" id="3649451">command</span><span class="op" id="3649458">(</span><span class="op" id="3649459">)</span>&nbsp;<span class="op" id="3649461">*</span><span class="ident" id="3649462">CommandNode</span>&nbsp;<span class="op" id="3649474">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649477">cmd</span>&nbsp;<span class="op" id="3649481">:=</span>&nbsp;<span class="ident" id="3649484">t</span><span class="op" id="3649485">.</span><span class="ident" id="3649486">newCommand</span><span class="op" id="3649496">(</span><span class="ident" id="3649497">t</span><span class="op" id="3649498">.</span><span class="ident" id="3649499">peekNonSpace</span><span class="op" id="3649511">(</span><span class="op" id="3649512">)</span><span class="op" id="3649513">.</span><span class="ident" id="3649514">pos</span><span class="op" id="3649517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649520">for</span>&nbsp;<span class="op" id="3649524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649528">t</span><span class="op" id="3649529">.</span><span class="ident" id="3649530">peekNonSpace</span><span class="op" id="3649542">(</span><span class="op" id="3649543">)</span>&nbsp;<span class="comment" id="3649545">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649571">operand</span>&nbsp;<span class="op" id="3649579">:=</span>&nbsp;<span class="ident" id="3649582">t</span><span class="op" id="3649583">.</span><span class="ident" id="3649584">operand</span><span class="op" id="3649591">(</span><span class="op" id="3649592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649596">if</span>&nbsp;<span class="ident" id="3649599">operand</span>&nbsp;<span class="op" id="3649607">!=</span>&nbsp;<span class="builtintype" id="3649610">nil</span>&nbsp;<span class="op" id="3649614">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649619">cmd</span><span class="op" id="3649622">.</span><span class="builtinfunc" id="3649623">append</span><span class="op" id="3649629">(</span><span class="ident" id="3649630">operand</span><span class="op" id="3649637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649645">switch</span>&nbsp;<span class="ident" id="3649652">token</span>&nbsp;<span class="op" id="3649658">:=</span>&nbsp;<span class="ident" id="3649661">t</span><span class="op" id="3649662">.</span><span class="ident" id="3649663">next</span><span class="op" id="3649667">(</span><span class="op" id="3649668">)</span><span class="op" id="3649669">;</span>&nbsp;<span class="ident" id="3649671">token</span><span class="op" id="3649676">.</span><span class="ident" id="3649677">typ</span>&nbsp;<span class="op" id="3649681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649685">case</span>&nbsp;<span class="ident" id="3649690">itemSpace</span><span class="op" id="3649699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649704">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649715">case</span>&nbsp;<span class="ident" id="3649720">itemError</span><span class="op" id="3649729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649734">t</span><span class="op" id="3649735">.</span><span class="ident" id="3649736">errorf</span><span class="op" id="3649742">(</span><span class="string" id="3649743">&#34;%s&#34;</span><span class="op" id="3649747">,</span>&nbsp;<span class="ident" id="3649749">token</span><span class="op" id="3649754">.</span><span class="ident" id="3649755">val</span><span class="op" id="3649758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649762">case</span>&nbsp;<span class="ident" id="3649767">itemRightDelim</span><span class="op" id="3649781">,</span>&nbsp;<span class="ident" id="3649783">itemRightParen</span><span class="op" id="3649797">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649802">t</span><span class="op" id="3649803">.</span><span class="ident" id="3649804">backup</span><span class="op" id="3649810">(</span><span class="op" id="3649811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649815">case</span>&nbsp;<span class="ident" id="3649820">itemPipe</span><span class="op" id="3649828">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649832">default</span><span class="op" id="3649839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649844">t</span><span class="op" id="3649845">.</span><span class="ident" id="3649846">errorf</span><span class="op" id="3649852">(</span><span class="string" id="3649853">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="3649895">,</span>&nbsp;<span class="ident" id="3649897">token</span><span class="op" id="3649902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649910">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649917">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649920">if</span>&nbsp;<span class="builtinfunc" id="3649923">len</span><span class="op" id="3649926">(</span><span class="ident" id="3649927">cmd</span><span class="op" id="3649930">.</span><span class="ident" id="3649931">Args</span><span class="op" id="3649935">)</span>&nbsp;<span class="op" id="3649937">==</span>&nbsp;<span class="num" id="3649940">0</span>&nbsp;<span class="op" id="3649942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649946">t</span><span class="op" id="3649947">.</span><span class="ident" id="3649948">errorf</span><span class="op" id="3649954">(</span><span class="string" id="3649955">&#34;empty&nbsp;command&#34;</span><span class="op" id="3649970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649976">return</span>&nbsp;<span class="ident" id="3649983">cmd</span><br>
<span class="lineno"></span><span class="op" id="3649987">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="3649990">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="3650002">//&nbsp;&nbsp;&nbsp;&nbsp;term&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="3650018">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="3650077">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="3650124">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="3650179">func</span>&nbsp;<span class="op" id="3650184">(</span><span class="ident" id="3650185">t</span>&nbsp;<span class="op" id="3650187">*</span><span class="ident" id="3650188">Tree</span><span class="op" id="3650192">)</span>&nbsp;<span class="ident" id="3650194">operand</span><span class="op" id="3650201">(</span><span class="op" id="3650202">)</span>&nbsp;<span class="ident" id="3650204">Node</span>&nbsp;<span class="op" id="3650209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650212">node</span>&nbsp;<span class="op" id="3650217">:=</span>&nbsp;<span class="ident" id="3650220">t</span><span class="op" id="3650221">.</span><span class="ident" id="3650222">term</span><span class="op" id="3650226">(</span><span class="op" id="3650227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650230">if</span>&nbsp;<span class="ident" id="3650233">node</span>&nbsp;<span class="op" id="3650238">==</span>&nbsp;<span class="builtintype" id="3650241">nil</span>&nbsp;<span class="op" id="3650245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650249">return</span>&nbsp;<span class="builtintype" id="3650256">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650264">if</span>&nbsp;<span class="ident" id="3650267">t</span><span class="op" id="3650268">.</span><span class="ident" id="3650269">peek</span><span class="op" id="3650273">(</span><span class="op" id="3650274">)</span><span class="op" id="3650275">.</span><span class="ident" id="3650276">typ</span>&nbsp;<span class="op" id="3650280">==</span>&nbsp;<span class="ident" id="3650283">itemField</span>&nbsp;<span class="op" id="3650293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650297">chain</span>&nbsp;<span class="op" id="3650303">:=</span>&nbsp;<span class="ident" id="3650306">t</span><span class="op" id="3650307">.</span><span class="ident" id="3650308">newChain</span><span class="op" id="3650316">(</span><span class="ident" id="3650317">t</span><span class="op" id="3650318">.</span><span class="ident" id="3650319">peek</span><span class="op" id="3650323">(</span><span class="op" id="3650324">)</span><span class="op" id="3650325">.</span><span class="ident" id="3650326">pos</span><span class="op" id="3650329">,</span>&nbsp;<span class="ident" id="3650331">node</span><span class="op" id="3650335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650339">for</span>&nbsp;<span class="ident" id="3650343">t</span><span class="op" id="3650344">.</span><span class="ident" id="3650345">peek</span><span class="op" id="3650349">(</span><span class="op" id="3650350">)</span><span class="op" id="3650351">.</span><span class="ident" id="3650352">typ</span>&nbsp;<span class="op" id="3650356">==</span>&nbsp;<span class="ident" id="3650359">itemField</span>&nbsp;<span class="op" id="3650369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650374">chain</span><span class="op" id="3650379">.</span><span class="ident" id="3650380">Add</span><span class="op" id="3650383">(</span><span class="ident" id="3650384">t</span><span class="op" id="3650385">.</span><span class="ident" id="3650386">next</span><span class="op" id="3650390">(</span><span class="op" id="3650391">)</span><span class="op" id="3650392">.</span><span class="ident" id="3650393">val</span><span class="op" id="3650396">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3650404">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3650475">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3650535">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3650572">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650620">switch</span>&nbsp;<span class="ident" id="3650627">node</span><span class="op" id="3650631">.</span><span class="ident" id="3650632">Type</span><span class="op" id="3650636">(</span><span class="op" id="3650637">)</span>&nbsp;<span class="op" id="3650639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650643">case</span>&nbsp;<span class="ident" id="3650648">NodeField</span><span class="op" id="3650657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650662">node</span>&nbsp;<span class="op" id="3650667">=</span>&nbsp;<span class="ident" id="3650669">t</span><span class="op" id="3650670">.</span><span class="ident" id="3650671">newField</span><span class="op" id="3650679">(</span><span class="ident" id="3650680">chain</span><span class="op" id="3650685">.</span><span class="ident" id="3650686">Position</span><span class="op" id="3650694">(</span><span class="op" id="3650695">)</span><span class="op" id="3650696">,</span>&nbsp;<span class="ident" id="3650698">chain</span><span class="op" id="3650703">.</span><span class="ident" id="3650704">String</span><span class="op" id="3650710">(</span><span class="op" id="3650711">)</span><span class="op" id="3650712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650716">case</span>&nbsp;<span class="ident" id="3650721">NodeVariable</span><span class="op" id="3650733">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650738">node</span>&nbsp;<span class="op" id="3650743">=</span>&nbsp;<span class="ident" id="3650745">t</span><span class="op" id="3650746">.</span><span class="ident" id="3650747">newVariable</span><span class="op" id="3650758">(</span><span class="ident" id="3650759">chain</span><span class="op" id="3650764">.</span><span class="ident" id="3650765">Position</span><span class="op" id="3650773">(</span><span class="op" id="3650774">)</span><span class="op" id="3650775">,</span>&nbsp;<span class="ident" id="3650777">chain</span><span class="op" id="3650782">.</span><span class="ident" id="3650783">String</span><span class="op" id="3650789">(</span><span class="op" id="3650790">)</span><span class="op" id="3650791">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650795">default</span><span class="op" id="3650802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650807">node</span>&nbsp;<span class="op" id="3650812">=</span>&nbsp;<span class="ident" id="3650814">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650828">return</span>&nbsp;<span class="ident" id="3650835">node</span><br>
<span class="lineno">595</span><span class="op" id="3650840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3650843">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="3650852">//&nbsp;&nbsp;&nbsp;&nbsp;literal&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="3650894">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="3650919">//&nbsp;&nbsp;&nbsp;&nbsp;.</span><br>
<span class="lineno"></span><span class="comment" id="3650924">//&nbsp;&nbsp;&nbsp;&nbsp;.Field</span><br>
<span class="lineno"></span><span class="comment" id="3650934">//&nbsp;&nbsp;&nbsp;&nbsp;$</span><br>
<span class="lineno"></span><span class="comment" id="3650939">//&nbsp;&nbsp;&nbsp;&nbsp;&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="3650959">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="3650995">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="3651046">func</span>&nbsp;<span class="op" id="3651051">(</span><span class="ident" id="3651052">t</span>&nbsp;<span class="op" id="3651054">*</span><span class="ident" id="3651055">Tree</span><span class="op" id="3651059">)</span>&nbsp;<span class="ident" id="3651061">term</span><span class="op" id="3651065">(</span><span class="op" id="3651066">)</span>&nbsp;<span class="ident" id="3651068">Node</span>&nbsp;<span class="op" id="3651073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651076">switch</span>&nbsp;<span class="ident" id="3651083">token</span>&nbsp;<span class="op" id="3651089">:=</span>&nbsp;<span class="ident" id="3651092">t</span><span class="op" id="3651093">.</span><span class="ident" id="3651094">nextNonSpace</span><span class="op" id="3651106">(</span><span class="op" id="3651107">)</span><span class="op" id="3651108">;</span>&nbsp;<span class="ident" id="3651110">token</span><span class="op" id="3651115">.</span><span class="ident" id="3651116">typ</span>&nbsp;<span class="op" id="3651120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651123">case</span>&nbsp;<span class="ident" id="3651128">itemError</span><span class="op" id="3651137">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651141">t</span><span class="op" id="3651142">.</span><span class="ident" id="3651143">errorf</span><span class="op" id="3651149">(</span><span class="string" id="3651150">&#34;%s&#34;</span><span class="op" id="3651154">,</span>&nbsp;<span class="ident" id="3651156">token</span><span class="op" id="3651161">.</span><span class="ident" id="3651162">val</span><span class="op" id="3651165">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651168">case</span>&nbsp;<span class="ident" id="3651173">itemIdentifier</span><span class="op" id="3651187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651191">if</span>&nbsp;<span class="op" id="3651194">!</span><span class="ident" id="3651195">t</span><span class="op" id="3651196">.</span><span class="ident" id="3651197">hasFunction</span><span class="op" id="3651208">(</span><span class="ident" id="3651209">token</span><span class="op" id="3651214">.</span><span class="ident" id="3651215">val</span><span class="op" id="3651218">)</span>&nbsp;<span class="op" id="3651220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651225">t</span><span class="op" id="3651226">.</span><span class="ident" id="3651227">errorf</span><span class="op" id="3651233">(</span><span class="string" id="3651234">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="3651259">,</span>&nbsp;<span class="ident" id="3651261">token</span><span class="op" id="3651266">.</span><span class="ident" id="3651267">val</span><span class="op" id="3651270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651278">return</span>&nbsp;<span class="ident" id="3651285">NewIdentifier</span><span class="op" id="3651298">(</span><span class="ident" id="3651299">token</span><span class="op" id="3651304">.</span><span class="ident" id="3651305">val</span><span class="op" id="3651308">)</span><span class="op" id="3651309">.</span><span class="ident" id="3651310">SetTree</span><span class="op" id="3651317">(</span><span class="ident" id="3651318">t</span><span class="op" id="3651319">)</span><span class="op" id="3651320">.</span><span class="ident" id="3651321">SetPos</span><span class="op" id="3651327">(</span><span class="ident" id="3651328">token</span><span class="op" id="3651333">.</span><span class="ident" id="3651334">pos</span><span class="op" id="3651337">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651340">case</span>&nbsp;<span class="ident" id="3651345">itemDot</span><span class="op" id="3651352">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651356">return</span>&nbsp;<span class="ident" id="3651363">t</span><span class="op" id="3651364">.</span><span class="ident" id="3651365">newDot</span><span class="op" id="3651371">(</span><span class="ident" id="3651372">token</span><span class="op" id="3651377">.</span><span class="ident" id="3651378">pos</span><span class="op" id="3651381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651384">case</span>&nbsp;<span class="ident" id="3651389">itemNil</span><span class="op" id="3651396">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651400">return</span>&nbsp;<span class="ident" id="3651407">t</span><span class="op" id="3651408">.</span><span class="ident" id="3651409">newNil</span><span class="op" id="3651415">(</span><span class="ident" id="3651416">token</span><span class="op" id="3651421">.</span><span class="ident" id="3651422">pos</span><span class="op" id="3651425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651428">case</span>&nbsp;<span class="ident" id="3651433">itemVariable</span><span class="op" id="3651445">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651449">return</span>&nbsp;<span class="ident" id="3651456">t</span><span class="op" id="3651457">.</span><span class="ident" id="3651458">useVar</span><span class="op" id="3651464">(</span><span class="ident" id="3651465">token</span><span class="op" id="3651470">.</span><span class="ident" id="3651471">pos</span><span class="op" id="3651474">,</span>&nbsp;<span class="ident" id="3651476">token</span><span class="op" id="3651481">.</span><span class="ident" id="3651482">val</span><span class="op" id="3651485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651488">case</span>&nbsp;<span class="ident" id="3651493">itemField</span><span class="op" id="3651502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651506">return</span>&nbsp;<span class="ident" id="3651513">t</span><span class="op" id="3651514">.</span><span class="ident" id="3651515">newField</span><span class="op" id="3651523">(</span><span class="ident" id="3651524">token</span><span class="op" id="3651529">.</span><span class="ident" id="3651530">pos</span><span class="op" id="3651533">,</span>&nbsp;<span class="ident" id="3651535">token</span><span class="op" id="3651540">.</span><span class="ident" id="3651541">val</span><span class="op" id="3651544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651547">case</span>&nbsp;<span class="ident" id="3651552">itemBool</span><span class="op" id="3651560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651564">return</span>&nbsp;<span class="ident" id="3651571">t</span><span class="op" id="3651572">.</span><span class="ident" id="3651573">newBool</span><span class="op" id="3651580">(</span><span class="ident" id="3651581">token</span><span class="op" id="3651586">.</span><span class="ident" id="3651587">pos</span><span class="op" id="3651590">,</span>&nbsp;<span class="ident" id="3651592">token</span><span class="op" id="3651597">.</span><span class="ident" id="3651598">val</span>&nbsp;<span class="op" id="3651602">==</span>&nbsp;<span class="string" id="3651605">&#34;true&#34;</span><span class="op" id="3651611">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651614">case</span>&nbsp;<span class="ident" id="3651619">itemCharConstant</span><span class="op" id="3651635">,</span>&nbsp;<span class="ident" id="3651637">itemComplex</span><span class="op" id="3651648">,</span>&nbsp;<span class="ident" id="3651650">itemNumber</span><span class="op" id="3651660">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651664">number</span><span class="op" id="3651670">,</span>&nbsp;<span class="ident" id="3651672">err</span>&nbsp;<span class="op" id="3651676">:=</span>&nbsp;<span class="ident" id="3651679">t</span><span class="op" id="3651680">.</span><span class="ident" id="3651681">newNumber</span><span class="op" id="3651690">(</span><span class="ident" id="3651691">token</span><span class="op" id="3651696">.</span><span class="ident" id="3651697">pos</span><span class="op" id="3651700">,</span>&nbsp;<span class="ident" id="3651702">token</span><span class="op" id="3651707">.</span><span class="ident" id="3651708">val</span><span class="op" id="3651711">,</span>&nbsp;<span class="ident" id="3651713">token</span><span class="op" id="3651718">.</span><span class="ident" id="3651719">typ</span><span class="op" id="3651722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651726">if</span>&nbsp;<span class="ident" id="3651729">err</span>&nbsp;<span class="op" id="3651733">!=</span>&nbsp;<span class="builtintype" id="3651736">nil</span>&nbsp;<span class="op" id="3651740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651745">t</span><span class="op" id="3651746">.</span><span class="builtintype" id="3651747">error</span><span class="op" id="3651752">(</span><span class="ident" id="3651753">err</span><span class="op" id="3651756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651760">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651764">return</span>&nbsp;<span class="ident" id="3651771">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651779">case</span>&nbsp;<span class="ident" id="3651784">itemLeftParen</span><span class="op" id="3651797">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651801">pipe</span>&nbsp;<span class="op" id="3651806">:=</span>&nbsp;<span class="ident" id="3651809">t</span><span class="op" id="3651810">.</span><span class="ident" id="3651811">pipeline</span><span class="op" id="3651819">(</span><span class="string" id="3651820">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="3651844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651848">if</span>&nbsp;<span class="ident" id="3651851">token</span>&nbsp;<span class="op" id="3651857">:=</span>&nbsp;<span class="ident" id="3651860">t</span><span class="op" id="3651861">.</span><span class="ident" id="3651862">next</span><span class="op" id="3651866">(</span><span class="op" id="3651867">)</span><span class="op" id="3651868">;</span>&nbsp;<span class="ident" id="3651870">token</span><span class="op" id="3651875">.</span><span class="ident" id="3651876">typ</span>&nbsp;<span class="op" id="3651880">!=</span>&nbsp;<span class="ident" id="3651883">itemRightParen</span>&nbsp;<span class="op" id="3651898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651903">t</span><span class="op" id="3651904">.</span><span class="ident" id="3651905">errorf</span><span class="op" id="3651911">(</span><span class="string" id="3651912">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="3651949">,</span>&nbsp;<span class="ident" id="3651951">token</span><span class="op" id="3651956">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651964">return</span>&nbsp;<span class="ident" id="3651971">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651977">case</span>&nbsp;<span class="ident" id="3651982">itemString</span><span class="op" id="3651992">,</span>&nbsp;<span class="ident" id="3651994">itemRawString</span><span class="op" id="3652007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652011">s</span><span class="op" id="3652012">,</span>&nbsp;<span class="ident" id="3652014">err</span>&nbsp;<span class="op" id="3652018">:=</span>&nbsp;<span class="ident" id="3652021">strconv</span><span class="op" id="3652028">.</span><span class="ident" id="3652029">Unquote</span><span class="op" id="3652036">(</span><span class="ident" id="3652037">token</span><span class="op" id="3652042">.</span><span class="ident" id="3652043">val</span><span class="op" id="3652046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652050">if</span>&nbsp;<span class="ident" id="3652053">err</span>&nbsp;<span class="op" id="3652057">!=</span>&nbsp;<span class="builtintype" id="3652060">nil</span>&nbsp;<span class="op" id="3652064">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652069">t</span><span class="op" id="3652070">.</span><span class="builtintype" id="3652071">error</span><span class="op" id="3652076">(</span><span class="ident" id="3652077">err</span><span class="op" id="3652080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652088">return</span>&nbsp;<span class="ident" id="3652095">t</span><span class="op" id="3652096">.</span><span class="ident" id="3652097">newString</span><span class="op" id="3652106">(</span><span class="ident" id="3652107">token</span><span class="op" id="3652112">.</span><span class="ident" id="3652113">pos</span><span class="op" id="3652116">,</span>&nbsp;<span class="ident" id="3652118">token</span><span class="op" id="3652123">.</span><span class="ident" id="3652124">val</span><span class="op" id="3652127">,</span>&nbsp;<span class="ident" id="3652129">s</span><span class="op" id="3652130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652136">t</span><span class="op" id="3652137">.</span><span class="ident" id="3652138">backup</span><span class="op" id="3652144">(</span><span class="op" id="3652145">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652148">return</span>&nbsp;<span class="builtintype" id="3652155">nil</span><br>
<span class="lineno"></span><span class="op" id="3652159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3652162">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="3652231">func</span>&nbsp;<span class="op" id="3652236">(</span><span class="ident" id="3652237">t</span>&nbsp;<span class="op" id="3652239">*</span><span class="ident" id="3652240">Tree</span><span class="op" id="3652244">)</span>&nbsp;<span class="ident" id="3652246">hasFunction</span><span class="op" id="3652257">(</span><span class="ident" id="3652258">name</span>&nbsp;<span class="builtintype" id="3652263">string</span><span class="op" id="3652269">)</span>&nbsp;<span class="builtintype" id="3652271">bool</span>&nbsp;<span class="op" id="3652276">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652279">for</span>&nbsp;<span class="ident" id="3652283">_</span><span class="op" id="3652284">,</span>&nbsp;<span class="ident" id="3652286">funcMap</span>&nbsp;<span class="op" id="3652294">:=</span>&nbsp;<span class="keyword" id="3652297">range</span>&nbsp;<span class="ident" id="3652303">t</span><span class="op" id="3652304">.</span><span class="ident" id="3652305">funcs</span>&nbsp;<span class="op" id="3652311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652315">if</span>&nbsp;<span class="ident" id="3652318">funcMap</span>&nbsp;<span class="op" id="3652326">==</span>&nbsp;<span class="builtintype" id="3652329">nil</span>&nbsp;<span class="op" id="3652333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652338">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652353">if</span>&nbsp;<span class="ident" id="3652356">funcMap</span><span class="op" id="3652363">[</span><span class="ident" id="3652364">name</span><span class="op" id="3652368">]</span>&nbsp;<span class="op" id="3652370">!=</span>&nbsp;<span class="builtintype" id="3652373">nil</span>&nbsp;<span class="op" id="3652377">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652382">return</span>&nbsp;<span class="builtintype" id="3652389">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652402">return</span>&nbsp;<span class="builtintype" id="3652409">false</span><br>
<span class="lineno"></span><span class="op" id="3652415">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="3652418">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="3652477">func</span>&nbsp;<span class="op" id="3652482">(</span><span class="ident" id="3652483">t</span>&nbsp;<span class="op" id="3652485">*</span><span class="ident" id="3652486">Tree</span><span class="op" id="3652490">)</span>&nbsp;<span class="ident" id="3652492">popVars</span><span class="op" id="3652499">(</span><span class="ident" id="3652500">n</span>&nbsp;<span class="builtintype" id="3652502">int</span><span class="op" id="3652505">)</span>&nbsp;<span class="op" id="3652507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652510">t</span><span class="op" id="3652511">.</span><span class="ident" id="3652512">vars</span>&nbsp;<span class="op" id="3652517">=</span>&nbsp;<span class="ident" id="3652519">t</span><span class="op" id="3652520">.</span><span class="ident" id="3652521">vars</span><span class="op" id="3652525">[</span><span class="op" id="3652526">:</span><span class="ident" id="3652527">n</span><span class="op" id="3652528">]</span><br>
<span class="lineno"></span><span class="op" id="3652530">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3652533">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3652601">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3652629">func</span>&nbsp;<span class="op" id="3652634">(</span><span class="ident" id="3652635">t</span>&nbsp;<span class="op" id="3652637">*</span><span class="ident" id="3652638">Tree</span><span class="op" id="3652642">)</span>&nbsp;<span class="ident" id="3652644">useVar</span><span class="op" id="3652650">(</span><span class="ident" id="3652651">pos</span>&nbsp;<span class="ident" id="3652655">Pos</span><span class="op" id="3652658">,</span>&nbsp;<span class="ident" id="3652660">name</span>&nbsp;<span class="builtintype" id="3652665">string</span><span class="op" id="3652671">)</span>&nbsp;<span class="ident" id="3652673">Node</span>&nbsp;<span class="op" id="3652678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652681">v</span>&nbsp;<span class="op" id="3652683">:=</span>&nbsp;<span class="ident" id="3652686">t</span><span class="op" id="3652687">.</span><span class="ident" id="3652688">newVariable</span><span class="op" id="3652699">(</span><span class="ident" id="3652700">pos</span><span class="op" id="3652703">,</span>&nbsp;<span class="ident" id="3652705">name</span><span class="op" id="3652709">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652712">for</span>&nbsp;<span class="ident" id="3652716">_</span><span class="op" id="3652717">,</span>&nbsp;<span class="ident" id="3652719">varName</span>&nbsp;<span class="op" id="3652727">:=</span>&nbsp;<span class="keyword" id="3652730">range</span>&nbsp;<span class="ident" id="3652736">t</span><span class="op" id="3652737">.</span><span class="ident" id="3652738">vars</span>&nbsp;<span class="op" id="3652743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652747">if</span>&nbsp;<span class="ident" id="3652750">varName</span>&nbsp;<span class="op" id="3652758">==</span>&nbsp;<span class="ident" id="3652761">v</span><span class="op" id="3652762">.</span><span class="ident" id="3652763">Ident</span><span class="op" id="3652768">[</span><span class="num" id="3652769">0</span><span class="op" id="3652770">]</span>&nbsp;<span class="op" id="3652772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652777">return</span>&nbsp;<span class="ident" id="3652784">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652791">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652794">t</span><span class="op" id="3652795">.</span><span class="ident" id="3652796">errorf</span><span class="op" id="3652802">(</span><span class="string" id="3652803">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="3652826">,</span>&nbsp;<span class="ident" id="3652828">v</span><span class="op" id="3652829">.</span><span class="ident" id="3652830">Ident</span><span class="op" id="3652835">[</span><span class="num" id="3652836">0</span><span class="op" id="3652837">]</span><span class="op" id="3652838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652841">return</span>&nbsp;<span class="builtintype" id="3652848">nil</span><br>
<span class="lineno"></span><span class="op" id="3652852">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
