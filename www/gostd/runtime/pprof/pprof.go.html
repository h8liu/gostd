<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html" class="current">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5700457">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5700513">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5700567">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5700618">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="5700688">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="5700724">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="5700765">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="5700812">package</span>&nbsp;<span class="ident" id="5700820">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5700827">import</span>&nbsp;<span class="op" id="5700834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700837">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700846">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700855">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700862">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700868">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700879">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700887">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700898">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5700906">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="5700923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5700926">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="5700998">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5701048">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="5701120">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="5701188">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="5701260">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="5701339">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5701366">//</span><br>
<span class="lineno"></span><span class="comment" id="5701369">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="5701447">//</span><br>
<span class="lineno"></span><span class="comment" id="5701450">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="5701517">//</span><br>
<span class="lineno"></span><span class="comment" id="5701520">//&nbsp;&nbsp;&nbsp;&nbsp;goroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5701577">//&nbsp;&nbsp;&nbsp;&nbsp;heap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="5701630">//&nbsp;&nbsp;&nbsp;&nbsp;threadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="5701704">//&nbsp;&nbsp;&nbsp;&nbsp;block&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="5701786">//</span><br>
<span class="lineno"></span><span class="comment" id="5701789">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="5701863">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="5701893">//</span><br>
<span class="lineno"></span><span class="comment" id="5701896">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="5701969">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="5702041">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="5702081">//</span><br>
<span class="lineno"></span><span class="keyword" id="5702084">type</span>&nbsp;<span class="ident" id="5702089">Profile</span>&nbsp;<span class="keyword" id="5702097">struct</span>&nbsp;<span class="op" id="5702104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702107">name</span>&nbsp;&nbsp;<span class="builtintype" id="5702113">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702121">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702127">sync</span><span class="op" id="5702131">.</span><span class="ident" id="5702132">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702139">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5702145">map</span><span class="op" id="5702148">[</span><span class="keyword" id="5702149">interface</span><span class="op" id="5702158">{</span><span class="op" id="5702159">}</span><span class="op" id="5702160">]</span><span class="op" id="5702161">[</span><span class="op" id="5702162">]</span><span class="builtintype" id="5702163">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702172">count</span>&nbsp;<span class="keyword" id="5702178">func</span><span class="op" id="5702182">(</span><span class="op" id="5702183">)</span>&nbsp;<span class="builtintype" id="5702185">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702190">write</span>&nbsp;<span class="keyword" id="5702196">func</span><span class="op" id="5702200">(</span><span class="ident" id="5702201">io</span><span class="op" id="5702203">.</span><span class="ident" id="5702204">Writer</span><span class="op" id="5702210">,</span>&nbsp;<span class="builtintype" id="5702212">int</span><span class="op" id="5702215">)</span>&nbsp;<span class="builtintype" id="5702217">error</span><br>
<span class="lineno"></span><span class="op" id="5702223">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="5702226">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="5702271">var</span>&nbsp;<span class="ident" id="5702275">profiles</span>&nbsp;<span class="keyword" id="5702284">struct</span>&nbsp;<span class="op" id="5702291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702294">mu</span>&nbsp;<span class="ident" id="5702297">sync</span><span class="op" id="5702301">.</span><span class="ident" id="5702302">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702309">m</span>&nbsp;&nbsp;<span class="keyword" id="5702312">map</span><span class="op" id="5702315">[</span><span class="builtintype" id="5702316">string</span><span class="op" id="5702322">]</span><span class="op" id="5702323">*</span><span class="ident" id="5702324">Profile</span><br>
<span class="lineno">60</span><span class="op" id="5702332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5702335">var</span>&nbsp;<span class="ident" id="5702339">goroutineProfile</span>&nbsp;<span class="op" id="5702356">=</span>&nbsp;<span class="op" id="5702358">&amp;</span><span class="ident" id="5702359">Profile</span><span class="op" id="5702366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702369">name</span><span class="op" id="5702373">:</span>&nbsp;&nbsp;<span class="string" id="5702376">&#34;goroutine&#34;</span><span class="op" id="5702387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702390">count</span><span class="op" id="5702395">:</span>&nbsp;<span class="ident" id="5702397">countGoroutine</span><span class="op" id="5702411">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702414">write</span><span class="op" id="5702419">:</span>&nbsp;<span class="ident" id="5702421">writeGoroutine</span><span class="op" id="5702435">,</span><br>
<span class="lineno"></span><span class="op" id="5702437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5702440">var</span>&nbsp;<span class="ident" id="5702444">threadcreateProfile</span>&nbsp;<span class="op" id="5702464">=</span>&nbsp;<span class="op" id="5702466">&amp;</span><span class="ident" id="5702467">Profile</span><span class="op" id="5702474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702477">name</span><span class="op" id="5702481">:</span>&nbsp;&nbsp;<span class="string" id="5702484">&#34;threadcreate&#34;</span><span class="op" id="5702498">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702501">count</span><span class="op" id="5702506">:</span>&nbsp;<span class="ident" id="5702508">countThreadCreate</span><span class="op" id="5702525">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702528">write</span><span class="op" id="5702533">:</span>&nbsp;<span class="ident" id="5702535">writeThreadCreate</span><span class="op" id="5702552">,</span><br>
<span class="lineno"></span><span class="op" id="5702554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5702557">var</span>&nbsp;<span class="ident" id="5702561">heapProfile</span>&nbsp;<span class="op" id="5702573">=</span>&nbsp;<span class="op" id="5702575">&amp;</span><span class="ident" id="5702576">Profile</span><span class="op" id="5702583">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702586">name</span><span class="op" id="5702590">:</span>&nbsp;&nbsp;<span class="string" id="5702593">&#34;heap&#34;</span><span class="op" id="5702599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702602">count</span><span class="op" id="5702607">:</span>&nbsp;<span class="ident" id="5702609">countHeap</span><span class="op" id="5702618">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702621">write</span><span class="op" id="5702626">:</span>&nbsp;<span class="ident" id="5702628">writeHeap</span><span class="op" id="5702637">,</span><br>
<span class="lineno"></span><span class="op" id="5702639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5702642">var</span>&nbsp;<span class="ident" id="5702646">blockProfile</span>&nbsp;<span class="op" id="5702659">=</span>&nbsp;<span class="op" id="5702661">&amp;</span><span class="ident" id="5702662">Profile</span><span class="op" id="5702669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702672">name</span><span class="op" id="5702676">:</span>&nbsp;&nbsp;<span class="string" id="5702679">&#34;block&#34;</span><span class="op" id="5702686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702689">count</span><span class="op" id="5702694">:</span>&nbsp;<span class="ident" id="5702696">countBlock</span><span class="op" id="5702706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702709">write</span><span class="op" id="5702714">:</span>&nbsp;<span class="ident" id="5702716">writeBlock</span><span class="op" id="5702726">,</span><br>
<span class="lineno"></span><span class="op" id="5702728">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5702731">func</span>&nbsp;<span class="ident" id="5702736">lockProfiles</span><span class="op" id="5702748">(</span><span class="op" id="5702749">)</span>&nbsp;<span class="op" id="5702751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702754">profiles</span><span class="op" id="5702762">.</span><span class="ident" id="5702763">mu</span><span class="op" id="5702765">.</span><span class="ident" id="5702766">Lock</span><span class="op" id="5702770">(</span><span class="op" id="5702771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5702774">if</span>&nbsp;<span class="ident" id="5702777">profiles</span><span class="op" id="5702785">.</span><span class="ident" id="5702786">m</span>&nbsp;<span class="op" id="5702788">==</span>&nbsp;<span class="ident" id="5702791">nil</span>&nbsp;<span class="op" id="5702795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5702799">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702831">profiles</span><span class="op" id="5702839">.</span><span class="ident" id="5702840">m</span>&nbsp;<span class="op" id="5702842">=</span>&nbsp;<span class="keyword" id="5702844">map</span><span class="op" id="5702847">[</span><span class="builtintype" id="5702848">string</span><span class="op" id="5702854">]</span><span class="op" id="5702855">*</span><span class="ident" id="5702856">Profile</span><span class="op" id="5702863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5702868">&#34;goroutine&#34;</span><span class="op" id="5702879">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702884">goroutineProfile</span><span class="op" id="5702900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5702905">&#34;threadcreate&#34;</span><span class="op" id="5702919">:</span>&nbsp;<span class="ident" id="5702921">threadcreateProfile</span><span class="op" id="5702940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5702945">&#34;heap&#34;</span><span class="op" id="5702951">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702961">heapProfile</span><span class="op" id="5702972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5702977">&#34;block&#34;</span><span class="op" id="5702984">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5702993">blockProfile</span><span class="op" id="5703005">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5703009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5703012">}</span><br>
<span class="lineno"></span><span class="op" id="5703014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5703017">func</span>&nbsp;<span class="ident" id="5703022">unlockProfiles</span><span class="op" id="5703036">(</span><span class="op" id="5703037">)</span>&nbsp;<span class="op" id="5703039">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703042">profiles</span><span class="op" id="5703050">.</span><span class="ident" id="5703051">mu</span><span class="op" id="5703053">.</span><span class="ident" id="5703054">Unlock</span><span class="op" id="5703060">(</span><span class="op" id="5703061">)</span><br>
<span class="lineno"></span><span class="op" id="5703063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5703066">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5703123">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="5703189">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5703251">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5703293">func</span>&nbsp;<span class="ident" id="5703298">NewProfile</span><span class="op" id="5703308">(</span><span class="ident" id="5703309">name</span>&nbsp;<span class="builtintype" id="5703314">string</span><span class="op" id="5703320">)</span>&nbsp;<span class="op" id="5703322">*</span><span class="ident" id="5703323">Profile</span>&nbsp;<span class="op" id="5703331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703334">lockProfiles</span><span class="op" id="5703346">(</span><span class="op" id="5703347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703350">defer</span>&nbsp;<span class="ident" id="5703356">unlockProfiles</span><span class="op" id="5703370">(</span><span class="op" id="5703371">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703374">if</span>&nbsp;<span class="ident" id="5703377">name</span>&nbsp;<span class="op" id="5703382">==</span>&nbsp;<span class="string" id="5703385">&#34;&#34;</span>&nbsp;<span class="op" id="5703388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5703392">panic</span><span class="op" id="5703397">(</span><span class="string" id="5703398">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="5703433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5703436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703439">if</span>&nbsp;<span class="ident" id="5703442">profiles</span><span class="op" id="5703450">.</span><span class="ident" id="5703451">m</span><span class="op" id="5703452">[</span><span class="ident" id="5703453">name</span><span class="op" id="5703457">]</span>&nbsp;<span class="op" id="5703459">!=</span>&nbsp;<span class="ident" id="5703462">nil</span>&nbsp;<span class="op" id="5703466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5703470">panic</span><span class="op" id="5703475">(</span><span class="string" id="5703476">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="5703518">+</span>&nbsp;<span class="ident" id="5703520">name</span><span class="op" id="5703524">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5703527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703530">p</span>&nbsp;<span class="op" id="5703532">:=</span>&nbsp;<span class="op" id="5703535">&amp;</span><span class="ident" id="5703536">Profile</span><span class="op" id="5703543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703547">name</span><span class="op" id="5703551">:</span>&nbsp;<span class="ident" id="5703553">name</span><span class="op" id="5703557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703561">m</span><span class="op" id="5703562">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703567">map</span><span class="op" id="5703570">[</span><span class="keyword" id="5703571">interface</span><span class="op" id="5703580">{</span><span class="op" id="5703581">}</span><span class="op" id="5703582">]</span><span class="op" id="5703583">[</span><span class="op" id="5703584">]</span><span class="builtintype" id="5703585">uintptr</span><span class="op" id="5703592">{</span><span class="op" id="5703593">}</span><span class="op" id="5703594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5703597">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703600">profiles</span><span class="op" id="5703608">.</span><span class="ident" id="5703609">m</span><span class="op" id="5703610">[</span><span class="ident" id="5703611">name</span><span class="op" id="5703615">]</span>&nbsp;<span class="op" id="5703617">=</span>&nbsp;<span class="ident" id="5703619">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703622">return</span>&nbsp;<span class="ident" id="5703629">p</span><br>
<span class="lineno"></span><span class="op" id="5703631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5703634">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="5703719">func</span>&nbsp;<span class="ident" id="5703724">Lookup</span><span class="op" id="5703730">(</span><span class="ident" id="5703731">name</span>&nbsp;<span class="builtintype" id="5703736">string</span><span class="op" id="5703742">)</span>&nbsp;<span class="op" id="5703744">*</span><span class="ident" id="5703745">Profile</span>&nbsp;<span class="op" id="5703753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703756">lockProfiles</span><span class="op" id="5703768">(</span><span class="op" id="5703769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703772">defer</span>&nbsp;<span class="ident" id="5703778">unlockProfiles</span><span class="op" id="5703792">(</span><span class="op" id="5703793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703796">return</span>&nbsp;<span class="ident" id="5703803">profiles</span><span class="op" id="5703811">.</span><span class="ident" id="5703812">m</span><span class="op" id="5703813">[</span><span class="ident" id="5703814">name</span><span class="op" id="5703818">]</span><br>
<span class="lineno"></span><span class="op" id="5703820">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5703823">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5703894">func</span>&nbsp;<span class="ident" id="5703899">Profiles</span><span class="op" id="5703907">(</span><span class="op" id="5703908">)</span>&nbsp;<span class="op" id="5703910">[</span><span class="op" id="5703911">]</span><span class="op" id="5703912">*</span><span class="ident" id="5703913">Profile</span>&nbsp;<span class="op" id="5703921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5703924">lockProfiles</span><span class="op" id="5703936">(</span><span class="op" id="5703937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703940">defer</span>&nbsp;<span class="ident" id="5703946">unlockProfiles</span><span class="op" id="5703960">(</span><span class="op" id="5703961">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703965">var</span>&nbsp;<span class="ident" id="5703969">all</span>&nbsp;<span class="op" id="5703973">[</span><span class="op" id="5703974">]</span><span class="op" id="5703975">*</span><span class="ident" id="5703976">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5703985">for</span>&nbsp;<span class="ident" id="5703989">_</span><span class="op" id="5703990">,</span>&nbsp;<span class="ident" id="5703992">p</span>&nbsp;<span class="op" id="5703994">:=</span>&nbsp;<span class="keyword" id="5703997">range</span>&nbsp;<span class="ident" id="5704003">profiles</span><span class="op" id="5704011">.</span><span class="ident" id="5704012">m</span>&nbsp;<span class="op" id="5704014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5704018">all</span>&nbsp;<span class="op" id="5704022">=</span>&nbsp;<span class="builtinfunc" id="5704024">append</span><span class="op" id="5704030">(</span><span class="ident" id="5704031">all</span><span class="op" id="5704034">,</span>&nbsp;<span class="ident" id="5704036">p</span><span class="op" id="5704037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5704040">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5704044">sort</span><span class="op" id="5704048">.</span><span class="ident" id="5704049">Sort</span><span class="op" id="5704053">(</span><span class="ident" id="5704054">byName</span><span class="op" id="5704060">(</span><span class="ident" id="5704061">all</span><span class="op" id="5704064">)</span><span class="op" id="5704065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5704068">return</span>&nbsp;<span class="ident" id="5704075">all</span><br>
<span class="lineno"></span><span class="op" id="5704079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5704082">type</span>&nbsp;<span class="ident" id="5704087">byName</span>&nbsp;<span class="op" id="5704094">[</span><span class="op" id="5704095">]</span><span class="op" id="5704096">*</span><span class="ident" id="5704097">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5704106">func</span>&nbsp;<span class="op" id="5704111">(</span><span class="ident" id="5704112">x</span>&nbsp;<span class="ident" id="5704114">byName</span><span class="op" id="5704120">)</span>&nbsp;<span class="ident" id="5704122">Len</span><span class="op" id="5704125">(</span><span class="op" id="5704126">)</span>&nbsp;<span class="builtintype" id="5704128">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5704142">{</span>&nbsp;<span class="keyword" id="5704144">return</span>&nbsp;<span class="builtinfunc" id="5704151">len</span><span class="op" id="5704154">(</span><span class="ident" id="5704155">x</span><span class="op" id="5704156">)</span>&nbsp;<span class="op" id="5704158">}</span><br>
<span class="lineno"></span><span class="keyword" id="5704160">func</span>&nbsp;<span class="op" id="5704165">(</span><span class="ident" id="5704166">x</span>&nbsp;<span class="ident" id="5704168">byName</span><span class="op" id="5704174">)</span>&nbsp;<span class="ident" id="5704176">Swap</span><span class="op" id="5704180">(</span><span class="ident" id="5704181">i</span><span class="op" id="5704182">,</span>&nbsp;<span class="ident" id="5704184">j</span>&nbsp;<span class="builtintype" id="5704186">int</span><span class="op" id="5704189">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5704196">{</span>&nbsp;<span class="ident" id="5704198">x</span><span class="op" id="5704199">[</span><span class="ident" id="5704200">i</span><span class="op" id="5704201">]</span><span class="op" id="5704202">,</span>&nbsp;<span class="ident" id="5704204">x</span><span class="op" id="5704205">[</span><span class="ident" id="5704206">j</span><span class="op" id="5704207">]</span>&nbsp;<span class="op" id="5704209">=</span>&nbsp;<span class="ident" id="5704211">x</span><span class="op" id="5704212">[</span><span class="ident" id="5704213">j</span><span class="op" id="5704214">]</span><span class="op" id="5704215">,</span>&nbsp;<span class="ident" id="5704217">x</span><span class="op" id="5704218">[</span><span class="ident" id="5704219">i</span><span class="op" id="5704220">]</span>&nbsp;<span class="op" id="5704222">}</span><br>
<span class="lineno"></span><span class="keyword" id="5704224">func</span>&nbsp;<span class="op" id="5704229">(</span><span class="ident" id="5704230">x</span>&nbsp;<span class="ident" id="5704232">byName</span><span class="op" id="5704238">)</span>&nbsp;<span class="ident" id="5704240">Less</span><span class="op" id="5704244">(</span><span class="ident" id="5704245">i</span><span class="op" id="5704246">,</span>&nbsp;<span class="ident" id="5704248">j</span>&nbsp;<span class="builtintype" id="5704250">int</span><span class="op" id="5704253">)</span>&nbsp;<span class="builtintype" id="5704255">bool</span>&nbsp;<span class="op" id="5704260">{</span>&nbsp;<span class="keyword" id="5704262">return</span>&nbsp;<span class="ident" id="5704269">x</span><span class="op" id="5704270">[</span><span class="ident" id="5704271">i</span><span class="op" id="5704272">]</span><span class="op" id="5704273">.</span><span class="ident" id="5704274">name</span>&nbsp;<span class="op" id="5704279">&lt;</span>&nbsp;<span class="ident" id="5704281">x</span><span class="op" id="5704282">[</span><span class="ident" id="5704283">j</span><span class="op" id="5704284">]</span><span class="op" id="5704285">.</span><span class="ident" id="5704286">name</span>&nbsp;<span class="op" id="5704291">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="5704294">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5704386">func</span>&nbsp;<span class="op" id="5704391">(</span><span class="ident" id="5704392">p</span>&nbsp;<span class="op" id="5704394">*</span><span class="ident" id="5704395">Profile</span><span class="op" id="5704402">)</span>&nbsp;<span class="ident" id="5704404">Name</span><span class="op" id="5704408">(</span><span class="op" id="5704409">)</span>&nbsp;<span class="builtintype" id="5704411">string</span>&nbsp;<span class="op" id="5704418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5704421">return</span>&nbsp;<span class="ident" id="5704428">p</span><span class="op" id="5704429">.</span><span class="ident" id="5704430">name</span><br>
<span class="lineno"></span><span class="op" id="5704435">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5704438">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5704512">func</span>&nbsp;<span class="op" id="5704517">(</span><span class="ident" id="5704518">p</span>&nbsp;<span class="op" id="5704520">*</span><span class="ident" id="5704521">Profile</span><span class="op" id="5704528">)</span>&nbsp;<span class="ident" id="5704530">Count</span><span class="op" id="5704535">(</span><span class="op" id="5704536">)</span>&nbsp;<span class="builtintype" id="5704538">int</span>&nbsp;<span class="op" id="5704542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5704545">p</span><span class="op" id="5704546">.</span><span class="ident" id="5704547">mu</span><span class="op" id="5704549">.</span><span class="ident" id="5704550">Lock</span><span class="op" id="5704554">(</span><span class="op" id="5704555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5704558">defer</span>&nbsp;<span class="ident" id="5704564">p</span><span class="op" id="5704565">.</span><span class="ident" id="5704566">mu</span><span class="op" id="5704568">.</span><span class="ident" id="5704569">Unlock</span><span class="op" id="5704575">(</span><span class="op" id="5704576">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5704579">if</span>&nbsp;<span class="ident" id="5704582">p</span><span class="op" id="5704583">.</span><span class="ident" id="5704584">count</span>&nbsp;<span class="op" id="5704590">!=</span>&nbsp;<span class="ident" id="5704593">nil</span>&nbsp;<span class="op" id="5704597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5704601">return</span>&nbsp;<span class="ident" id="5704608">p</span><span class="op" id="5704609">.</span><span class="ident" id="5704610">count</span><span class="op" id="5704615">(</span><span class="op" id="5704616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5704619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5704622">return</span>&nbsp;<span class="builtinfunc" id="5704629">len</span><span class="op" id="5704632">(</span><span class="ident" id="5704633">p</span><span class="op" id="5704634">.</span><span class="ident" id="5704635">m</span><span class="op" id="5704636">)</span><br>
<span class="lineno"></span><span class="op" id="5704638">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5704641">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="5704720">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5704797">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="5704868">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="5704950">//</span><br>
<span class="lineno"></span><span class="comment" id="5704953">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="5705021">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5705094">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5705157">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="5705177">//</span><br>
<span class="lineno"></span><span class="comment" id="5705180">//&nbsp;&nbsp;&nbsp;&nbsp;Add</span><br>
<span class="lineno"></span><span class="comment" id="5705187">//&nbsp;&nbsp;&nbsp;&nbsp;called&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="5705216">//&nbsp;&nbsp;&nbsp;&nbsp;called&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="5705241">//&nbsp;&nbsp;&nbsp;&nbsp;called&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="5705266">//</span><br>
<span class="lineno"></span><span class="comment" id="5705269">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="5705351">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="5705435">//</span><br>
<span class="lineno"></span><span class="keyword" id="5705438">func</span>&nbsp;<span class="op" id="5705443">(</span><span class="ident" id="5705444">p</span>&nbsp;<span class="op" id="5705446">*</span><span class="ident" id="5705447">Profile</span><span class="op" id="5705454">)</span>&nbsp;<span class="ident" id="5705456">Add</span><span class="op" id="5705459">(</span><span class="ident" id="5705460">value</span>&nbsp;<span class="keyword" id="5705466">interface</span><span class="op" id="5705475">{</span><span class="op" id="5705476">}</span><span class="op" id="5705477">,</span>&nbsp;<span class="ident" id="5705479">skip</span>&nbsp;<span class="builtintype" id="5705484">int</span><span class="op" id="5705487">)</span>&nbsp;<span class="op" id="5705489">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5705492">if</span>&nbsp;<span class="ident" id="5705495">p</span><span class="op" id="5705496">.</span><span class="ident" id="5705497">name</span>&nbsp;<span class="op" id="5705502">==</span>&nbsp;<span class="string" id="5705505">&#34;&#34;</span>&nbsp;<span class="op" id="5705508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5705512">panic</span><span class="op" id="5705517">(</span><span class="string" id="5705518">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="5705555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5705558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5705561">if</span>&nbsp;<span class="ident" id="5705564">p</span><span class="op" id="5705565">.</span><span class="ident" id="5705566">write</span>&nbsp;<span class="op" id="5705572">!=</span>&nbsp;<span class="ident" id="5705575">nil</span>&nbsp;<span class="op" id="5705579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5705583">panic</span><span class="op" id="5705588">(</span><span class="string" id="5705589">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="5705630">+</span>&nbsp;<span class="ident" id="5705632">p</span><span class="op" id="5705633">.</span><span class="ident" id="5705634">name</span><span class="op" id="5705638">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5705641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5705645">stk</span>&nbsp;<span class="op" id="5705649">:=</span>&nbsp;<span class="builtinfunc" id="5705652">make</span><span class="op" id="5705656">(</span><span class="op" id="5705657">[</span><span class="op" id="5705658">]</span><span class="builtintype" id="5705659">uintptr</span><span class="op" id="5705666">,</span>&nbsp;<span class="num" id="5705668">32</span><span class="op" id="5705670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5705673">n</span>&nbsp;<span class="op" id="5705675">:=</span>&nbsp;<span class="ident" id="5705678">runtime</span><span class="op" id="5705685">.</span><span class="ident" id="5705686">Callers</span><span class="op" id="5705693">(</span><span class="ident" id="5705694">skip</span><span class="op" id="5705698">+</span><span class="num" id="5705699">1</span><span class="op" id="5705700">,</span>&nbsp;<span class="ident" id="5705702">stk</span><span class="op" id="5705705">[</span><span class="op" id="5705706">:</span><span class="op" id="5705707">]</span><span class="op" id="5705708">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5705712">p</span><span class="op" id="5705713">.</span><span class="ident" id="5705714">mu</span><span class="op" id="5705716">.</span><span class="ident" id="5705717">Lock</span><span class="op" id="5705721">(</span><span class="op" id="5705722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5705725">defer</span>&nbsp;<span class="ident" id="5705731">p</span><span class="op" id="5705732">.</span><span class="ident" id="5705733">mu</span><span class="op" id="5705735">.</span><span class="ident" id="5705736">Unlock</span><span class="op" id="5705742">(</span><span class="op" id="5705743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5705746">if</span>&nbsp;<span class="ident" id="5705749">p</span><span class="op" id="5705750">.</span><span class="ident" id="5705751">m</span><span class="op" id="5705752">[</span><span class="ident" id="5705753">value</span><span class="op" id="5705758">]</span>&nbsp;<span class="op" id="5705760">!=</span>&nbsp;<span class="ident" id="5705763">nil</span>&nbsp;<span class="op" id="5705767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5705771">panic</span><span class="op" id="5705776">(</span><span class="string" id="5705777">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="5705816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5705819">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5705822">p</span><span class="op" id="5705823">.</span><span class="ident" id="5705824">m</span><span class="op" id="5705825">[</span><span class="ident" id="5705826">value</span><span class="op" id="5705831">]</span>&nbsp;<span class="op" id="5705833">=</span>&nbsp;<span class="ident" id="5705835">stk</span><span class="op" id="5705838">[</span><span class="op" id="5705839">:</span><span class="ident" id="5705840">n</span><span class="op" id="5705841">]</span><br>
<span class="lineno"></span><span class="op" id="5705843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5705846">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="5705924">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="5705977">func</span>&nbsp;<span class="op" id="5705982">(</span><span class="ident" id="5705983">p</span>&nbsp;<span class="op" id="5705985">*</span><span class="ident" id="5705986">Profile</span><span class="op" id="5705993">)</span>&nbsp;<span class="ident" id="5705995">Remove</span><span class="op" id="5706001">(</span><span class="ident" id="5706002">value</span>&nbsp;<span class="keyword" id="5706008">interface</span><span class="op" id="5706017">{</span><span class="op" id="5706018">}</span><span class="op" id="5706019">)</span>&nbsp;<span class="op" id="5706021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5706024">p</span><span class="op" id="5706025">.</span><span class="ident" id="5706026">mu</span><span class="op" id="5706028">.</span><span class="ident" id="5706029">Lock</span><span class="op" id="5706033">(</span><span class="op" id="5706034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5706037">defer</span>&nbsp;<span class="ident" id="5706043">p</span><span class="op" id="5706044">.</span><span class="ident" id="5706045">mu</span><span class="op" id="5706047">.</span><span class="ident" id="5706048">Unlock</span><span class="op" id="5706054">(</span><span class="op" id="5706055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5706058">delete</span><span class="op" id="5706064">(</span><span class="ident" id="5706065">p</span><span class="op" id="5706066">.</span><span class="ident" id="5706067">m</span><span class="op" id="5706068">,</span>&nbsp;<span class="ident" id="5706070">value</span><span class="op" id="5706075">)</span><br>
<span class="lineno"></span><span class="op" id="5706077">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="5706080">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5706146">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5706211">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5706246">//</span><br>
<span class="lineno">215</span><span class="comment" id="5706249">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="5706299">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="5706374">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="5706447">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="5706525">//</span><br>
<span class="lineno">220</span><span class="comment" id="5706528">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="5706597">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5706669">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5706739">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5706782">func</span>&nbsp;<span class="op" id="5706787">(</span><span class="ident" id="5706788">p</span>&nbsp;<span class="op" id="5706790">*</span><span class="ident" id="5706791">Profile</span><span class="op" id="5706798">)</span>&nbsp;<span class="ident" id="5706800">WriteTo</span><span class="op" id="5706807">(</span><span class="ident" id="5706808">w</span>&nbsp;<span class="ident" id="5706810">io</span><span class="op" id="5706812">.</span><span class="ident" id="5706813">Writer</span><span class="op" id="5706819">,</span>&nbsp;<span class="ident" id="5706821">debug</span>&nbsp;<span class="builtintype" id="5706827">int</span><span class="op" id="5706830">)</span>&nbsp;<span class="builtintype" id="5706832">error</span>&nbsp;<span class="op" id="5706838">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5706841">if</span>&nbsp;<span class="ident" id="5706844">p</span><span class="op" id="5706845">.</span><span class="ident" id="5706846">name</span>&nbsp;<span class="op" id="5706851">==</span>&nbsp;<span class="string" id="5706854">&#34;&#34;</span>&nbsp;<span class="op" id="5706857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5706861">panic</span><span class="op" id="5706866">(</span><span class="string" id="5706867">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="5706895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5706898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5706901">if</span>&nbsp;<span class="ident" id="5706904">p</span><span class="op" id="5706905">.</span><span class="ident" id="5706906">write</span>&nbsp;<span class="op" id="5706912">!=</span>&nbsp;<span class="ident" id="5706915">nil</span>&nbsp;<span class="op" id="5706919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5706923">return</span>&nbsp;<span class="ident" id="5706930">p</span><span class="op" id="5706931">.</span><span class="ident" id="5706932">write</span><span class="op" id="5706937">(</span><span class="ident" id="5706938">w</span><span class="op" id="5706939">,</span>&nbsp;<span class="ident" id="5706941">debug</span><span class="op" id="5706946">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5706949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5706953">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707023">var</span>&nbsp;<span class="ident" id="5707027">all</span>&nbsp;<span class="op" id="5707031">[</span><span class="op" id="5707032">]</span><span class="op" id="5707033">[</span><span class="op" id="5707034">]</span><span class="builtintype" id="5707035">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707044">p</span><span class="op" id="5707045">.</span><span class="ident" id="5707046">mu</span><span class="op" id="5707048">.</span><span class="ident" id="5707049">Lock</span><span class="op" id="5707053">(</span><span class="op" id="5707054">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707057">for</span>&nbsp;<span class="ident" id="5707061">_</span><span class="op" id="5707062">,</span>&nbsp;<span class="ident" id="5707064">stk</span>&nbsp;<span class="op" id="5707068">:=</span>&nbsp;<span class="keyword" id="5707071">range</span>&nbsp;<span class="ident" id="5707077">p</span><span class="op" id="5707078">.</span><span class="ident" id="5707079">m</span>&nbsp;<span class="op" id="5707081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707085">all</span>&nbsp;<span class="op" id="5707089">=</span>&nbsp;<span class="builtinfunc" id="5707091">append</span><span class="op" id="5707097">(</span><span class="ident" id="5707098">all</span><span class="op" id="5707101">,</span>&nbsp;<span class="ident" id="5707103">stk</span><span class="op" id="5707106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5707109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707112">p</span><span class="op" id="5707113">.</span><span class="ident" id="5707114">mu</span><span class="op" id="5707116">.</span><span class="ident" id="5707117">Unlock</span><span class="op" id="5707123">(</span><span class="op" id="5707124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5707128">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707191">sort</span><span class="op" id="5707195">.</span><span class="ident" id="5707196">Sort</span><span class="op" id="5707200">(</span><span class="ident" id="5707201">stackProfile</span><span class="op" id="5707213">(</span><span class="ident" id="5707214">all</span><span class="op" id="5707217">)</span><span class="op" id="5707218">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707222">return</span>&nbsp;<span class="ident" id="5707229">printCountProfile</span><span class="op" id="5707246">(</span><span class="ident" id="5707247">w</span><span class="op" id="5707248">,</span>&nbsp;<span class="ident" id="5707250">debug</span><span class="op" id="5707255">,</span>&nbsp;<span class="ident" id="5707257">p</span><span class="op" id="5707258">.</span><span class="ident" id="5707259">name</span><span class="op" id="5707263">,</span>&nbsp;<span class="ident" id="5707265">stackProfile</span><span class="op" id="5707277">(</span><span class="ident" id="5707278">all</span><span class="op" id="5707281">)</span><span class="op" id="5707282">)</span><br>
<span class="lineno"></span><span class="op" id="5707284">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="5707287">type</span>&nbsp;<span class="ident" id="5707292">stackProfile</span>&nbsp;<span class="op" id="5707305">[</span><span class="op" id="5707306">]</span><span class="op" id="5707307">[</span><span class="op" id="5707308">]</span><span class="builtintype" id="5707309">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5707318">func</span>&nbsp;<span class="op" id="5707323">(</span><span class="ident" id="5707324">x</span>&nbsp;<span class="ident" id="5707326">stackProfile</span><span class="op" id="5707338">)</span>&nbsp;<span class="ident" id="5707340">Len</span><span class="op" id="5707343">(</span><span class="op" id="5707344">)</span>&nbsp;<span class="builtintype" id="5707346">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5707363">{</span>&nbsp;<span class="keyword" id="5707365">return</span>&nbsp;<span class="builtinfunc" id="5707372">len</span><span class="op" id="5707375">(</span><span class="ident" id="5707376">x</span><span class="op" id="5707377">)</span>&nbsp;<span class="op" id="5707379">}</span><br>
<span class="lineno"></span><span class="keyword" id="5707381">func</span>&nbsp;<span class="op" id="5707386">(</span><span class="ident" id="5707387">x</span>&nbsp;<span class="ident" id="5707389">stackProfile</span><span class="op" id="5707401">)</span>&nbsp;<span class="ident" id="5707403">Stack</span><span class="op" id="5707408">(</span><span class="ident" id="5707409">i</span>&nbsp;<span class="builtintype" id="5707411">int</span><span class="op" id="5707414">)</span>&nbsp;<span class="op" id="5707416">[</span><span class="op" id="5707417">]</span><span class="builtintype" id="5707418">uintptr</span>&nbsp;<span class="op" id="5707426">{</span>&nbsp;<span class="keyword" id="5707428">return</span>&nbsp;<span class="ident" id="5707435">x</span><span class="op" id="5707436">[</span><span class="ident" id="5707437">i</span><span class="op" id="5707438">]</span>&nbsp;<span class="op" id="5707440">}</span><br>
<span class="lineno">250</span><span class="keyword" id="5707442">func</span>&nbsp;<span class="op" id="5707447">(</span><span class="ident" id="5707448">x</span>&nbsp;<span class="ident" id="5707450">stackProfile</span><span class="op" id="5707462">)</span>&nbsp;<span class="ident" id="5707464">Swap</span><span class="op" id="5707468">(</span><span class="ident" id="5707469">i</span><span class="op" id="5707470">,</span>&nbsp;<span class="ident" id="5707472">j</span>&nbsp;<span class="builtintype" id="5707474">int</span><span class="op" id="5707477">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5707487">{</span>&nbsp;<span class="ident" id="5707489">x</span><span class="op" id="5707490">[</span><span class="ident" id="5707491">i</span><span class="op" id="5707492">]</span><span class="op" id="5707493">,</span>&nbsp;<span class="ident" id="5707495">x</span><span class="op" id="5707496">[</span><span class="ident" id="5707497">j</span><span class="op" id="5707498">]</span>&nbsp;<span class="op" id="5707500">=</span>&nbsp;<span class="ident" id="5707502">x</span><span class="op" id="5707503">[</span><span class="ident" id="5707504">j</span><span class="op" id="5707505">]</span><span class="op" id="5707506">,</span>&nbsp;<span class="ident" id="5707508">x</span><span class="op" id="5707509">[</span><span class="ident" id="5707510">i</span><span class="op" id="5707511">]</span>&nbsp;<span class="op" id="5707513">}</span><br>
<span class="lineno"></span><span class="keyword" id="5707515">func</span>&nbsp;<span class="op" id="5707520">(</span><span class="ident" id="5707521">x</span>&nbsp;<span class="ident" id="5707523">stackProfile</span><span class="op" id="5707535">)</span>&nbsp;<span class="ident" id="5707537">Less</span><span class="op" id="5707541">(</span><span class="ident" id="5707542">i</span><span class="op" id="5707543">,</span>&nbsp;<span class="ident" id="5707545">j</span>&nbsp;<span class="builtintype" id="5707547">int</span><span class="op" id="5707550">)</span>&nbsp;<span class="builtintype" id="5707552">bool</span>&nbsp;<span class="op" id="5707557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707560">t</span><span class="op" id="5707561">,</span>&nbsp;<span class="ident" id="5707563">u</span>&nbsp;<span class="op" id="5707565">:=</span>&nbsp;<span class="ident" id="5707568">x</span><span class="op" id="5707569">[</span><span class="ident" id="5707570">i</span><span class="op" id="5707571">]</span><span class="op" id="5707572">,</span>&nbsp;<span class="ident" id="5707574">x</span><span class="op" id="5707575">[</span><span class="ident" id="5707576">j</span><span class="op" id="5707577">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707580">for</span>&nbsp;<span class="ident" id="5707584">k</span>&nbsp;<span class="op" id="5707586">:=</span>&nbsp;<span class="num" id="5707589">0</span><span class="op" id="5707590">;</span>&nbsp;<span class="ident" id="5707592">k</span>&nbsp;<span class="op" id="5707594">&lt;</span>&nbsp;<span class="builtinfunc" id="5707596">len</span><span class="op" id="5707599">(</span><span class="ident" id="5707600">t</span><span class="op" id="5707601">)</span>&nbsp;<span class="op" id="5707603">&amp;&amp;</span>&nbsp;<span class="ident" id="5707606">k</span>&nbsp;<span class="op" id="5707608">&lt;</span>&nbsp;<span class="builtinfunc" id="5707610">len</span><span class="op" id="5707613">(</span><span class="ident" id="5707614">u</span><span class="op" id="5707615">)</span><span class="op" id="5707616">;</span>&nbsp;<span class="ident" id="5707618">k</span><span class="op" id="5707619">++</span>&nbsp;<span class="op" id="5707622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707626">if</span>&nbsp;<span class="ident" id="5707629">t</span><span class="op" id="5707630">[</span><span class="ident" id="5707631">k</span><span class="op" id="5707632">]</span>&nbsp;<span class="op" id="5707634">!=</span>&nbsp;<span class="ident" id="5707637">u</span><span class="op" id="5707638">[</span><span class="ident" id="5707639">k</span><span class="op" id="5707640">]</span>&nbsp;<span class="op" id="5707642">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707647">return</span>&nbsp;<span class="ident" id="5707654">t</span><span class="op" id="5707655">[</span><span class="ident" id="5707656">k</span><span class="op" id="5707657">]</span>&nbsp;<span class="op" id="5707659">&lt;</span>&nbsp;<span class="ident" id="5707661">u</span><span class="op" id="5707662">[</span><span class="ident" id="5707663">k</span><span class="op" id="5707664">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5707668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5707671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5707674">return</span>&nbsp;<span class="builtinfunc" id="5707681">len</span><span class="op" id="5707684">(</span><span class="ident" id="5707685">t</span><span class="op" id="5707686">)</span>&nbsp;<span class="op" id="5707688">&lt;</span>&nbsp;<span class="builtinfunc" id="5707690">len</span><span class="op" id="5707693">(</span><span class="ident" id="5707694">u</span><span class="op" id="5707695">)</span><br>
<span class="lineno"></span><span class="op" id="5707697">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5707700">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="5707767">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="5707831">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5707901">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="5707935">type</span>&nbsp;<span class="ident" id="5707940">countProfile</span>&nbsp;<span class="keyword" id="5707953">interface</span>&nbsp;<span class="op" id="5707963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707966">Len</span><span class="op" id="5707969">(</span><span class="op" id="5707970">)</span>&nbsp;<span class="builtintype" id="5707972">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5707977">Stack</span><span class="op" id="5707982">(</span><span class="ident" id="5707983">i</span>&nbsp;<span class="builtintype" id="5707985">int</span><span class="op" id="5707988">)</span>&nbsp;<span class="op" id="5707990">[</span><span class="op" id="5707991">]</span><span class="builtintype" id="5707992">uintptr</span><br>
<span class="lineno"></span><span class="op" id="5708000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5708003">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="5708076">func</span>&nbsp;<span class="ident" id="5708081">printCountProfile</span><span class="op" id="5708098">(</span><span class="ident" id="5708099">w</span>&nbsp;<span class="ident" id="5708101">io</span><span class="op" id="5708103">.</span><span class="ident" id="5708104">Writer</span><span class="op" id="5708110">,</span>&nbsp;<span class="ident" id="5708112">debug</span>&nbsp;<span class="builtintype" id="5708118">int</span><span class="op" id="5708121">,</span>&nbsp;<span class="ident" id="5708123">name</span>&nbsp;<span class="builtintype" id="5708128">string</span><span class="op" id="5708134">,</span>&nbsp;<span class="ident" id="5708136">p</span>&nbsp;<span class="ident" id="5708138">countProfile</span><span class="op" id="5708150">)</span>&nbsp;<span class="builtintype" id="5708152">error</span>&nbsp;<span class="op" id="5708158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708161">b</span>&nbsp;<span class="op" id="5708163">:=</span>&nbsp;<span class="ident" id="5708166">bufio</span><span class="op" id="5708171">.</span><span class="ident" id="5708172">NewWriter</span><span class="op" id="5708181">(</span><span class="ident" id="5708182">w</span><span class="op" id="5708183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708186">var</span>&nbsp;<span class="ident" id="5708190">tw</span>&nbsp;<span class="op" id="5708193">*</span><span class="ident" id="5708194">tabwriter</span><span class="op" id="5708203">.</span><span class="ident" id="5708204">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708212">w</span>&nbsp;<span class="op" id="5708214">=</span>&nbsp;<span class="ident" id="5708216">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708219">if</span>&nbsp;<span class="ident" id="5708222">debug</span>&nbsp;<span class="op" id="5708228">&gt;</span>&nbsp;<span class="num" id="5708230">0</span>&nbsp;<span class="op" id="5708232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708236">tw</span>&nbsp;<span class="op" id="5708239">=</span>&nbsp;<span class="ident" id="5708241">tabwriter</span><span class="op" id="5708250">.</span><span class="ident" id="5708251">NewWriter</span><span class="op" id="5708260">(</span><span class="ident" id="5708261">w</span><span class="op" id="5708262">,</span>&nbsp;<span class="num" id="5708264">1</span><span class="op" id="5708265">,</span>&nbsp;<span class="num" id="5708267">8</span><span class="op" id="5708268">,</span>&nbsp;<span class="num" id="5708270">1</span><span class="op" id="5708271">,</span>&nbsp;<span class="string" id="5708273">&#39;\t&#39;</span><span class="op" id="5708277">,</span>&nbsp;<span class="num" id="5708279">0</span><span class="op" id="5708280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708284">w</span>&nbsp;<span class="op" id="5708286">=</span>&nbsp;<span class="ident" id="5708288">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708296">fmt</span><span class="op" id="5708299">.</span><span class="ident" id="5708300">Fprintf</span><span class="op" id="5708307">(</span><span class="ident" id="5708308">w</span><span class="op" id="5708309">,</span>&nbsp;<span class="string" id="5708311">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="5708335">,</span>&nbsp;<span class="ident" id="5708337">name</span><span class="op" id="5708341">,</span>&nbsp;<span class="ident" id="5708343">p</span><span class="op" id="5708344">.</span><span class="ident" id="5708345">Len</span><span class="op" id="5708348">(</span><span class="op" id="5708349">)</span><span class="op" id="5708350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5708354">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708385">var</span>&nbsp;<span class="ident" id="5708389">buf</span>&nbsp;<span class="ident" id="5708393">bytes</span><span class="op" id="5708398">.</span><span class="ident" id="5708399">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708407">key</span>&nbsp;<span class="op" id="5708411">:=</span>&nbsp;<span class="keyword" id="5708414">func</span><span class="op" id="5708418">(</span><span class="ident" id="5708419">stk</span>&nbsp;<span class="op" id="5708423">[</span><span class="op" id="5708424">]</span><span class="builtintype" id="5708425">uintptr</span><span class="op" id="5708432">)</span>&nbsp;<span class="builtintype" id="5708434">string</span>&nbsp;<span class="op" id="5708441">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708445">buf</span><span class="op" id="5708448">.</span><span class="ident" id="5708449">Reset</span><span class="op" id="5708454">(</span><span class="op" id="5708455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708459">fmt</span><span class="op" id="5708462">.</span><span class="ident" id="5708463">Fprintf</span><span class="op" id="5708470">(</span><span class="op" id="5708471">&amp;</span><span class="ident" id="5708472">buf</span><span class="op" id="5708475">,</span>&nbsp;<span class="string" id="5708477">&#34;@&#34;</span><span class="op" id="5708480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708484">for</span>&nbsp;<span class="ident" id="5708488">_</span><span class="op" id="5708489">,</span>&nbsp;<span class="ident" id="5708491">pc</span>&nbsp;<span class="op" id="5708494">:=</span>&nbsp;<span class="keyword" id="5708497">range</span>&nbsp;<span class="ident" id="5708503">stk</span>&nbsp;<span class="op" id="5708507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708512">fmt</span><span class="op" id="5708515">.</span><span class="ident" id="5708516">Fprintf</span><span class="op" id="5708523">(</span><span class="op" id="5708524">&amp;</span><span class="ident" id="5708525">buf</span><span class="op" id="5708528">,</span>&nbsp;<span class="string" id="5708530">&#34;&nbsp;%#x&#34;</span><span class="op" id="5708536">,</span>&nbsp;<span class="ident" id="5708538">pc</span><span class="op" id="5708540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708544">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708548">return</span>&nbsp;<span class="ident" id="5708555">buf</span><span class="op" id="5708558">.</span><span class="ident" id="5708559">String</span><span class="op" id="5708565">(</span><span class="op" id="5708566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708572">m</span>&nbsp;<span class="op" id="5708574">:=</span>&nbsp;<span class="keyword" id="5708577">map</span><span class="op" id="5708580">[</span><span class="builtintype" id="5708581">string</span><span class="op" id="5708587">]</span><span class="builtintype" id="5708588">int</span><span class="op" id="5708591">{</span><span class="op" id="5708592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708595">n</span>&nbsp;<span class="op" id="5708597">:=</span>&nbsp;<span class="ident" id="5708600">p</span><span class="op" id="5708601">.</span><span class="ident" id="5708602">Len</span><span class="op" id="5708605">(</span><span class="op" id="5708606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708609">for</span>&nbsp;<span class="ident" id="5708613">i</span>&nbsp;<span class="op" id="5708615">:=</span>&nbsp;<span class="num" id="5708618">0</span><span class="op" id="5708619">;</span>&nbsp;<span class="ident" id="5708621">i</span>&nbsp;<span class="op" id="5708623">&lt;</span>&nbsp;<span class="ident" id="5708625">n</span><span class="op" id="5708626">;</span>&nbsp;<span class="ident" id="5708628">i</span><span class="op" id="5708629">++</span>&nbsp;<span class="op" id="5708632">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708636">m</span><span class="op" id="5708637">[</span><span class="ident" id="5708638">key</span><span class="op" id="5708641">(</span><span class="ident" id="5708642">p</span><span class="op" id="5708643">.</span><span class="ident" id="5708644">Stack</span><span class="op" id="5708649">(</span><span class="ident" id="5708650">i</span><span class="op" id="5708651">)</span><span class="op" id="5708652">)</span><span class="op" id="5708653">]</span><span class="op" id="5708654">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5708662">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708733">for</span>&nbsp;<span class="ident" id="5708737">i</span>&nbsp;<span class="op" id="5708739">:=</span>&nbsp;<span class="num" id="5708742">0</span><span class="op" id="5708743">;</span>&nbsp;<span class="ident" id="5708745">i</span>&nbsp;<span class="op" id="5708747">&lt;</span>&nbsp;<span class="ident" id="5708749">n</span><span class="op" id="5708750">;</span>&nbsp;<span class="ident" id="5708752">i</span><span class="op" id="5708753">++</span>&nbsp;<span class="op" id="5708756">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708760">stk</span>&nbsp;<span class="op" id="5708764">:=</span>&nbsp;<span class="ident" id="5708767">p</span><span class="op" id="5708768">.</span><span class="ident" id="5708769">Stack</span><span class="op" id="5708774">(</span><span class="ident" id="5708775">i</span><span class="op" id="5708776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708780">s</span>&nbsp;<span class="op" id="5708782">:=</span>&nbsp;<span class="ident" id="5708785">key</span><span class="op" id="5708788">(</span><span class="ident" id="5708789">stk</span><span class="op" id="5708792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708796">if</span>&nbsp;<span class="ident" id="5708799">count</span>&nbsp;<span class="op" id="5708805">:=</span>&nbsp;<span class="ident" id="5708808">m</span><span class="op" id="5708809">[</span><span class="ident" id="5708810">s</span><span class="op" id="5708811">]</span><span class="op" id="5708812">;</span>&nbsp;<span class="ident" id="5708814">count</span>&nbsp;<span class="op" id="5708820">!=</span>&nbsp;<span class="num" id="5708823">0</span>&nbsp;<span class="op" id="5708825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708830">fmt</span><span class="op" id="5708833">.</span><span class="ident" id="5708834">Fprintf</span><span class="op" id="5708841">(</span><span class="ident" id="5708842">w</span><span class="op" id="5708843">,</span>&nbsp;<span class="string" id="5708845">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5708854">,</span>&nbsp;<span class="ident" id="5708856">count</span><span class="op" id="5708861">,</span>&nbsp;<span class="ident" id="5708863">s</span><span class="op" id="5708864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708869">if</span>&nbsp;<span class="ident" id="5708872">debug</span>&nbsp;<span class="op" id="5708878">&gt;</span>&nbsp;<span class="num" id="5708880">0</span>&nbsp;<span class="op" id="5708882">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708888">printStackRecord</span><span class="op" id="5708904">(</span><span class="ident" id="5708905">w</span><span class="op" id="5708906">,</span>&nbsp;<span class="ident" id="5708908">stk</span><span class="op" id="5708911">,</span>&nbsp;<span class="builtintype" id="5708913">false</span><span class="op" id="5708918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5708928">delete</span><span class="op" id="5708934">(</span><span class="ident" id="5708935">m</span><span class="op" id="5708936">,</span>&nbsp;<span class="ident" id="5708938">s</span><span class="op" id="5708939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708946">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708950">if</span>&nbsp;<span class="ident" id="5708953">tw</span>&nbsp;<span class="op" id="5708956">!=</span>&nbsp;<span class="ident" id="5708959">nil</span>&nbsp;<span class="op" id="5708963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5708967">tw</span><span class="op" id="5708969">.</span><span class="ident" id="5708970">Flush</span><span class="op" id="5708975">(</span><span class="op" id="5708976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5708979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5708982">return</span>&nbsp;<span class="ident" id="5708989">b</span><span class="op" id="5708990">.</span><span class="ident" id="5708991">Flush</span><span class="op" id="5708996">(</span><span class="op" id="5708997">)</span><br>
<span class="lineno">315</span><span class="op" id="5708999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5709002">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="5709068">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="5709097">func</span>&nbsp;<span class="ident" id="5709102">printStackRecord</span><span class="op" id="5709118">(</span><span class="ident" id="5709119">w</span>&nbsp;<span class="ident" id="5709121">io</span><span class="op" id="5709123">.</span><span class="ident" id="5709124">Writer</span><span class="op" id="5709130">,</span>&nbsp;<span class="ident" id="5709132">stk</span>&nbsp;<span class="op" id="5709136">[</span><span class="op" id="5709137">]</span><span class="builtintype" id="5709138">uintptr</span><span class="op" id="5709145">,</span>&nbsp;<span class="ident" id="5709147">allFrames</span>&nbsp;<span class="builtintype" id="5709157">bool</span><span class="op" id="5709161">)</span>&nbsp;<span class="op" id="5709163">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709166">show</span>&nbsp;<span class="op" id="5709171">:=</span>&nbsp;<span class="ident" id="5709174">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709185">wasPanic</span>&nbsp;<span class="op" id="5709194">:=</span>&nbsp;<span class="builtintype" id="5709197">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5709204">for</span>&nbsp;<span class="ident" id="5709208">i</span><span class="op" id="5709209">,</span>&nbsp;<span class="ident" id="5709211">pc</span>&nbsp;<span class="op" id="5709214">:=</span>&nbsp;<span class="keyword" id="5709217">range</span>&nbsp;<span class="ident" id="5709223">stk</span>&nbsp;<span class="op" id="5709227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709231">f</span>&nbsp;<span class="op" id="5709233">:=</span>&nbsp;<span class="ident" id="5709236">runtime</span><span class="op" id="5709243">.</span><span class="ident" id="5709244">FuncForPC</span><span class="op" id="5709253">(</span><span class="ident" id="5709254">pc</span><span class="op" id="5709256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5709260">if</span>&nbsp;<span class="ident" id="5709263">f</span>&nbsp;<span class="op" id="5709265">==</span>&nbsp;<span class="ident" id="5709268">nil</span>&nbsp;<span class="op" id="5709272">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709277">show</span>&nbsp;<span class="op" id="5709282">=</span>&nbsp;<span class="builtintype" id="5709284">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709292">fmt</span><span class="op" id="5709295">.</span><span class="ident" id="5709296">Fprintf</span><span class="op" id="5709303">(</span><span class="ident" id="5709304">w</span><span class="op" id="5709305">,</span>&nbsp;<span class="string" id="5709307">&#34;#\t%#x\n&#34;</span><span class="op" id="5709317">,</span>&nbsp;<span class="ident" id="5709319">pc</span><span class="op" id="5709321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709326">wasPanic</span>&nbsp;<span class="op" id="5709335">=</span>&nbsp;<span class="builtintype" id="5709337">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709345">}</span>&nbsp;<span class="keyword" id="5709347">else</span>&nbsp;<span class="op" id="5709352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709357">tracepc</span>&nbsp;<span class="op" id="5709365">:=</span>&nbsp;<span class="ident" id="5709368">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5709374">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5709409">if</span>&nbsp;<span class="ident" id="5709412">i</span>&nbsp;<span class="op" id="5709414">&gt;</span>&nbsp;<span class="num" id="5709416">0</span>&nbsp;<span class="op" id="5709418">&amp;&amp;</span>&nbsp;<span class="ident" id="5709421">pc</span>&nbsp;<span class="op" id="5709424">&gt;</span>&nbsp;<span class="ident" id="5709426">f</span><span class="op" id="5709427">.</span><span class="ident" id="5709428">Entry</span><span class="op" id="5709433">(</span><span class="op" id="5709434">)</span>&nbsp;<span class="op" id="5709436">&amp;&amp;</span>&nbsp;<span class="op" id="5709439">!</span><span class="ident" id="5709440">wasPanic</span>&nbsp;<span class="op" id="5709449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5709455">if</span>&nbsp;<span class="ident" id="5709458">runtime</span><span class="op" id="5709465">.</span><span class="ident" id="5709466">GOARCH</span>&nbsp;<span class="op" id="5709473">==</span>&nbsp;<span class="string" id="5709476">&#34;386&#34;</span>&nbsp;<span class="op" id="5709482">||</span>&nbsp;<span class="ident" id="5709485">runtime</span><span class="op" id="5709492">.</span><span class="ident" id="5709493">GOARCH</span>&nbsp;<span class="op" id="5709500">==</span>&nbsp;<span class="string" id="5709503">&#34;amd64&#34;</span>&nbsp;<span class="op" id="5709511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709518">tracepc</span><span class="op" id="5709525">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709532">}</span>&nbsp;<span class="keyword" id="5709534">else</span>&nbsp;<span class="op" id="5709539">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709546">tracepc</span>&nbsp;<span class="op" id="5709554">-=</span>&nbsp;<span class="num" id="5709557">4</span>&nbsp;<span class="comment" id="5709559">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709585">file</span><span class="op" id="5709589">,</span>&nbsp;<span class="ident" id="5709591">line</span>&nbsp;<span class="op" id="5709596">:=</span>&nbsp;<span class="ident" id="5709599">f</span><span class="op" id="5709600">.</span><span class="ident" id="5709601">FileLine</span><span class="op" id="5709609">(</span><span class="ident" id="5709610">tracepc</span><span class="op" id="5709617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709622">name</span>&nbsp;<span class="op" id="5709627">:=</span>&nbsp;<span class="ident" id="5709630">f</span><span class="op" id="5709631">.</span><span class="ident" id="5709632">Name</span><span class="op" id="5709636">(</span><span class="op" id="5709637">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5709642">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5709712">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709763">wasPanic</span>&nbsp;<span class="op" id="5709772">=</span>&nbsp;<span class="ident" id="5709774">name</span>&nbsp;<span class="op" id="5709779">==</span>&nbsp;<span class="string" id="5709782">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5709801">if</span>&nbsp;<span class="ident" id="5709804">name</span>&nbsp;<span class="op" id="5709809">==</span>&nbsp;<span class="string" id="5709812">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="5709829">||</span>&nbsp;<span class="op" id="5709832">!</span><span class="ident" id="5709833">show</span>&nbsp;<span class="op" id="5709838">&amp;&amp;</span>&nbsp;<span class="ident" id="5709841">strings</span><span class="op" id="5709848">.</span><span class="ident" id="5709849">HasPrefix</span><span class="op" id="5709858">(</span><span class="ident" id="5709859">name</span><span class="op" id="5709863">,</span>&nbsp;<span class="string" id="5709865">&#34;runtime.&#34;</span><span class="op" id="5709875">)</span>&nbsp;<span class="op" id="5709877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5709883">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709900">show</span>&nbsp;<span class="op" id="5709905">=</span>&nbsp;<span class="builtintype" id="5709907">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5709915">fmt</span><span class="op" id="5709918">.</span><span class="ident" id="5709919">Fprintf</span><span class="op" id="5709926">(</span><span class="ident" id="5709927">w</span><span class="op" id="5709928">,</span>&nbsp;<span class="string" id="5709930">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="5709955">,</span>&nbsp;<span class="ident" id="5709957">pc</span><span class="op" id="5709959">,</span>&nbsp;<span class="ident" id="5709961">name</span><span class="op" id="5709965">,</span>&nbsp;<span class="ident" id="5709967">pc</span><span class="op" id="5709969">-</span><span class="ident" id="5709970">f</span><span class="op" id="5709971">.</span><span class="ident" id="5709972">Entry</span><span class="op" id="5709977">(</span><span class="op" id="5709978">)</span><span class="op" id="5709979">,</span>&nbsp;<span class="ident" id="5709981">file</span><span class="op" id="5709985">,</span>&nbsp;<span class="ident" id="5709987">line</span><span class="op" id="5709991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5709998">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5710001">if</span>&nbsp;<span class="op" id="5710004">!</span><span class="ident" id="5710005">show</span>&nbsp;<span class="op" id="5710010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5710014">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5710058">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5710104">printStackRecord</span><span class="op" id="5710120">(</span><span class="ident" id="5710121">w</span><span class="op" id="5710122">,</span>&nbsp;<span class="ident" id="5710124">stk</span><span class="op" id="5710127">,</span>&nbsp;<span class="builtintype" id="5710129">true</span><span class="op" id="5710133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5710137">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5710145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5710148">fmt</span><span class="op" id="5710151">.</span><span class="ident" id="5710152">Fprintf</span><span class="op" id="5710159">(</span><span class="ident" id="5710160">w</span><span class="op" id="5710161">,</span>&nbsp;<span class="string" id="5710163">&#34;\n&#34;</span><span class="op" id="5710167">)</span><br>
<span class="lineno"></span><span class="op" id="5710169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710172">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5710206">type</span>&nbsp;<span class="ident" id="5710211">byInUseBytes</span>&nbsp;<span class="op" id="5710224">[</span><span class="op" id="5710225">]</span><span class="ident" id="5710226">runtime</span><span class="op" id="5710233">.</span><span class="ident" id="5710234">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5710252">func</span>&nbsp;<span class="op" id="5710257">(</span><span class="ident" id="5710258">x</span>&nbsp;<span class="ident" id="5710260">byInUseBytes</span><span class="op" id="5710272">)</span>&nbsp;<span class="ident" id="5710274">Len</span><span class="op" id="5710277">(</span><span class="op" id="5710278">)</span>&nbsp;<span class="builtintype" id="5710280">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5710294">{</span>&nbsp;<span class="keyword" id="5710296">return</span>&nbsp;<span class="builtinfunc" id="5710303">len</span><span class="op" id="5710306">(</span><span class="ident" id="5710307">x</span><span class="op" id="5710308">)</span>&nbsp;<span class="op" id="5710310">}</span><br>
<span class="lineno"></span><span class="keyword" id="5710312">func</span>&nbsp;<span class="op" id="5710317">(</span><span class="ident" id="5710318">x</span>&nbsp;<span class="ident" id="5710320">byInUseBytes</span><span class="op" id="5710332">)</span>&nbsp;<span class="ident" id="5710334">Swap</span><span class="op" id="5710338">(</span><span class="ident" id="5710339">i</span><span class="op" id="5710340">,</span>&nbsp;<span class="ident" id="5710342">j</span>&nbsp;<span class="builtintype" id="5710344">int</span><span class="op" id="5710347">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5710354">{</span>&nbsp;<span class="ident" id="5710356">x</span><span class="op" id="5710357">[</span><span class="ident" id="5710358">i</span><span class="op" id="5710359">]</span><span class="op" id="5710360">,</span>&nbsp;<span class="ident" id="5710362">x</span><span class="op" id="5710363">[</span><span class="ident" id="5710364">j</span><span class="op" id="5710365">]</span>&nbsp;<span class="op" id="5710367">=</span>&nbsp;<span class="ident" id="5710369">x</span><span class="op" id="5710370">[</span><span class="ident" id="5710371">j</span><span class="op" id="5710372">]</span><span class="op" id="5710373">,</span>&nbsp;<span class="ident" id="5710375">x</span><span class="op" id="5710376">[</span><span class="ident" id="5710377">i</span><span class="op" id="5710378">]</span>&nbsp;<span class="op" id="5710380">}</span><br>
<span class="lineno">365</span><span class="keyword" id="5710382">func</span>&nbsp;<span class="op" id="5710387">(</span><span class="ident" id="5710388">x</span>&nbsp;<span class="ident" id="5710390">byInUseBytes</span><span class="op" id="5710402">)</span>&nbsp;<span class="ident" id="5710404">Less</span><span class="op" id="5710408">(</span><span class="ident" id="5710409">i</span><span class="op" id="5710410">,</span>&nbsp;<span class="ident" id="5710412">j</span>&nbsp;<span class="builtintype" id="5710414">int</span><span class="op" id="5710417">)</span>&nbsp;<span class="builtintype" id="5710419">bool</span>&nbsp;<span class="op" id="5710424">{</span>&nbsp;<span class="keyword" id="5710426">return</span>&nbsp;<span class="ident" id="5710433">x</span><span class="op" id="5710434">[</span><span class="ident" id="5710435">i</span><span class="op" id="5710436">]</span><span class="op" id="5710437">.</span><span class="ident" id="5710438">InUseBytes</span><span class="op" id="5710448">(</span><span class="op" id="5710449">)</span>&nbsp;<span class="op" id="5710451">&gt;</span>&nbsp;<span class="ident" id="5710453">x</span><span class="op" id="5710454">[</span><span class="ident" id="5710455">j</span><span class="op" id="5710456">]</span><span class="op" id="5710457">.</span><span class="ident" id="5710458">InUseBytes</span><span class="op" id="5710468">(</span><span class="op" id="5710469">)</span>&nbsp;<span class="op" id="5710471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710474">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="5710541">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="5710589">func</span>&nbsp;<span class="ident" id="5710594">WriteHeapProfile</span><span class="op" id="5710610">(</span><span class="ident" id="5710611">w</span>&nbsp;<span class="ident" id="5710613">io</span><span class="op" id="5710615">.</span><span class="ident" id="5710616">Writer</span><span class="op" id="5710622">)</span>&nbsp;<span class="builtintype" id="5710624">error</span>&nbsp;<span class="op" id="5710630">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5710633">return</span>&nbsp;<span class="ident" id="5710640">writeHeap</span><span class="op" id="5710649">(</span><span class="ident" id="5710650">w</span><span class="op" id="5710651">,</span>&nbsp;<span class="num" id="5710653">0</span><span class="op" id="5710654">)</span><br>
<span class="lineno"></span><span class="op" id="5710656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710659">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5710723">func</span>&nbsp;<span class="ident" id="5710728">countHeap</span><span class="op" id="5710737">(</span><span class="op" id="5710738">)</span>&nbsp;<span class="builtintype" id="5710740">int</span>&nbsp;<span class="op" id="5710744">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5710747">n</span><span class="op" id="5710748">,</span>&nbsp;<span class="ident" id="5710750">_</span>&nbsp;<span class="op" id="5710752">:=</span>&nbsp;<span class="ident" id="5710755">runtime</span><span class="op" id="5710762">.</span><span class="ident" id="5710763">MemProfile</span><span class="op" id="5710773">(</span><span class="ident" id="5710774">nil</span><span class="op" id="5710777">,</span>&nbsp;<span class="builtintype" id="5710779">true</span><span class="op" id="5710783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5710786">return</span>&nbsp;<span class="ident" id="5710793">n</span><br>
<span class="lineno"></span><span class="op" id="5710795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5710798">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="5710857">func</span>&nbsp;<span class="ident" id="5710862">writeHeap</span><span class="op" id="5710871">(</span><span class="ident" id="5710872">w</span>&nbsp;<span class="ident" id="5710874">io</span><span class="op" id="5710876">.</span><span class="ident" id="5710877">Writer</span><span class="op" id="5710883">,</span>&nbsp;<span class="ident" id="5710885">debug</span>&nbsp;<span class="builtintype" id="5710891">int</span><span class="op" id="5710894">)</span>&nbsp;<span class="builtintype" id="5710896">error</span>&nbsp;<span class="op" id="5710902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5710905">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5710970">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711020">//&nbsp;There&#39;s&nbsp;a&nbsp;racemore&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711077">//&nbsp;the&nbsp;two&nbsp;callsso&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711140">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711186">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711253">var</span>&nbsp;<span class="ident" id="5711257">p</span>&nbsp;<span class="op" id="5711259">[</span><span class="op" id="5711260">]</span><span class="ident" id="5711261">runtime</span><span class="op" id="5711268">.</span><span class="ident" id="5711269">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711287">n</span><span class="op" id="5711288">,</span>&nbsp;<span class="ident" id="5711290">ok</span>&nbsp;<span class="op" id="5711293">:=</span>&nbsp;<span class="ident" id="5711296">runtime</span><span class="op" id="5711303">.</span><span class="ident" id="5711304">MemProfile</span><span class="op" id="5711314">(</span><span class="ident" id="5711315">nil</span><span class="op" id="5711318">,</span>&nbsp;<span class="builtintype" id="5711320">true</span><span class="op" id="5711324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711327">for</span>&nbsp;<span class="op" id="5711331">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711335">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711385">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711433">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711468">p</span>&nbsp;<span class="op" id="5711470">=</span>&nbsp;<span class="builtinfunc" id="5711472">make</span><span class="op" id="5711476">(</span><span class="op" id="5711477">[</span><span class="op" id="5711478">]</span><span class="ident" id="5711479">runtime</span><span class="op" id="5711486">.</span><span class="ident" id="5711487">MemProfileRecord</span><span class="op" id="5711503">,</span>&nbsp;<span class="ident" id="5711505">n</span><span class="op" id="5711506">+</span><span class="num" id="5711507">50</span><span class="op" id="5711509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711513">n</span><span class="op" id="5711514">,</span>&nbsp;<span class="ident" id="5711516">ok</span>&nbsp;<span class="op" id="5711519">=</span>&nbsp;<span class="ident" id="5711521">runtime</span><span class="op" id="5711528">.</span><span class="ident" id="5711529">MemProfile</span><span class="op" id="5711539">(</span><span class="ident" id="5711540">p</span><span class="op" id="5711541">,</span>&nbsp;<span class="builtintype" id="5711543">true</span><span class="op" id="5711547">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711551">if</span>&nbsp;<span class="ident" id="5711554">ok</span>&nbsp;<span class="op" id="5711557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711562">p</span>&nbsp;<span class="op" id="5711564">=</span>&nbsp;<span class="ident" id="5711566">p</span><span class="op" id="5711567">[</span><span class="num" id="5711568">0</span><span class="op" id="5711569">:</span><span class="ident" id="5711570">n</span><span class="op" id="5711571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711576">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5711584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5711588">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5711617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711621">sort</span><span class="op" id="5711625">.</span><span class="ident" id="5711626">Sort</span><span class="op" id="5711630">(</span><span class="ident" id="5711631">byInUseBytes</span><span class="op" id="5711643">(</span><span class="ident" id="5711644">p</span><span class="op" id="5711645">)</span><span class="op" id="5711646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711650">b</span>&nbsp;<span class="op" id="5711652">:=</span>&nbsp;<span class="ident" id="5711655">bufio</span><span class="op" id="5711660">.</span><span class="ident" id="5711661">NewWriter</span><span class="op" id="5711670">(</span><span class="ident" id="5711671">w</span><span class="op" id="5711672">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711675">var</span>&nbsp;<span class="ident" id="5711679">tw</span>&nbsp;<span class="op" id="5711682">*</span><span class="ident" id="5711683">tabwriter</span><span class="op" id="5711692">.</span><span class="ident" id="5711693">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711701">w</span>&nbsp;<span class="op" id="5711703">=</span>&nbsp;<span class="ident" id="5711705">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711708">if</span>&nbsp;<span class="ident" id="5711711">debug</span>&nbsp;<span class="op" id="5711717">&gt;</span>&nbsp;<span class="num" id="5711719">0</span>&nbsp;<span class="op" id="5711721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711725">tw</span>&nbsp;<span class="op" id="5711728">=</span>&nbsp;<span class="ident" id="5711730">tabwriter</span><span class="op" id="5711739">.</span><span class="ident" id="5711740">NewWriter</span><span class="op" id="5711749">(</span><span class="ident" id="5711750">w</span><span class="op" id="5711751">,</span>&nbsp;<span class="num" id="5711753">1</span><span class="op" id="5711754">,</span>&nbsp;<span class="num" id="5711756">8</span><span class="op" id="5711757">,</span>&nbsp;<span class="num" id="5711759">1</span><span class="op" id="5711760">,</span>&nbsp;<span class="string" id="5711762">&#39;\t&#39;</span><span class="op" id="5711766">,</span>&nbsp;<span class="num" id="5711768">0</span><span class="op" id="5711769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711773">w</span>&nbsp;<span class="op" id="5711775">=</span>&nbsp;<span class="ident" id="5711777">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5711781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711785">var</span>&nbsp;<span class="ident" id="5711789">total</span>&nbsp;<span class="ident" id="5711795">runtime</span><span class="op" id="5711802">.</span><span class="ident" id="5711803">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5711821">for</span>&nbsp;<span class="ident" id="5711825">i</span>&nbsp;<span class="op" id="5711827">:=</span>&nbsp;<span class="keyword" id="5711830">range</span>&nbsp;<span class="ident" id="5711836">p</span>&nbsp;<span class="op" id="5711838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711842">r</span>&nbsp;<span class="op" id="5711844">:=</span>&nbsp;<span class="op" id="5711847">&amp;</span><span class="ident" id="5711848">p</span><span class="op" id="5711849">[</span><span class="ident" id="5711850">i</span><span class="op" id="5711851">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711855">total</span><span class="op" id="5711860">.</span><span class="ident" id="5711861">AllocBytes</span>&nbsp;<span class="op" id="5711872">+=</span>&nbsp;<span class="ident" id="5711875">r</span><span class="op" id="5711876">.</span><span class="ident" id="5711877">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711890">total</span><span class="op" id="5711895">.</span><span class="ident" id="5711896">AllocObjects</span>&nbsp;<span class="op" id="5711909">+=</span>&nbsp;<span class="ident" id="5711912">r</span><span class="op" id="5711913">.</span><span class="ident" id="5711914">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711929">total</span><span class="op" id="5711934">.</span><span class="ident" id="5711935">FreeBytes</span>&nbsp;<span class="op" id="5711945">+=</span>&nbsp;<span class="ident" id="5711948">r</span><span class="op" id="5711949">.</span><span class="ident" id="5711950">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5711962">total</span><span class="op" id="5711967">.</span><span class="ident" id="5711968">FreeObjects</span>&nbsp;<span class="op" id="5711980">+=</span>&nbsp;<span class="ident" id="5711983">r</span><span class="op" id="5711984">.</span><span class="ident" id="5711985">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5711998">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5712002">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5712067">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5712142">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712187">fmt</span><span class="op" id="5712190">.</span><span class="ident" id="5712191">Fprintf</span><span class="op" id="5712198">(</span><span class="ident" id="5712199">w</span><span class="op" id="5712200">,</span>&nbsp;<span class="string" id="5712202">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="5712245">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712249">total</span><span class="op" id="5712254">.</span><span class="ident" id="5712255">InUseObjects</span><span class="op" id="5712267">(</span><span class="op" id="5712268">)</span><span class="op" id="5712269">,</span>&nbsp;<span class="ident" id="5712271">total</span><span class="op" id="5712276">.</span><span class="ident" id="5712277">InUseBytes</span><span class="op" id="5712287">(</span><span class="op" id="5712288">)</span><span class="op" id="5712289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712293">total</span><span class="op" id="5712298">.</span><span class="ident" id="5712299">AllocObjects</span><span class="op" id="5712311">,</span>&nbsp;<span class="ident" id="5712313">total</span><span class="op" id="5712318">.</span><span class="ident" id="5712319">AllocBytes</span><span class="op" id="5712329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5712333">2</span><span class="op" id="5712334">*</span><span class="ident" id="5712335">runtime</span><span class="op" id="5712342">.</span><span class="ident" id="5712343">MemProfileRate</span><span class="op" id="5712357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5712361">for</span>&nbsp;<span class="ident" id="5712365">i</span>&nbsp;<span class="op" id="5712367">:=</span>&nbsp;<span class="keyword" id="5712370">range</span>&nbsp;<span class="ident" id="5712376">p</span>&nbsp;<span class="op" id="5712378">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712382">r</span>&nbsp;<span class="op" id="5712384">:=</span>&nbsp;<span class="op" id="5712387">&amp;</span><span class="ident" id="5712388">p</span><span class="op" id="5712389">[</span><span class="ident" id="5712390">i</span><span class="op" id="5712391">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712395">fmt</span><span class="op" id="5712398">.</span><span class="ident" id="5712399">Fprintf</span><span class="op" id="5712406">(</span><span class="ident" id="5712407">w</span><span class="op" id="5712408">,</span>&nbsp;<span class="string" id="5712410">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="5712429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712434">r</span><span class="op" id="5712435">.</span><span class="ident" id="5712436">InUseObjects</span><span class="op" id="5712448">(</span><span class="op" id="5712449">)</span><span class="op" id="5712450">,</span>&nbsp;<span class="ident" id="5712452">r</span><span class="op" id="5712453">.</span><span class="ident" id="5712454">InUseBytes</span><span class="op" id="5712464">(</span><span class="op" id="5712465">)</span><span class="op" id="5712466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712471">r</span><span class="op" id="5712472">.</span><span class="ident" id="5712473">AllocObjects</span><span class="op" id="5712485">,</span>&nbsp;<span class="ident" id="5712487">r</span><span class="op" id="5712488">.</span><span class="ident" id="5712489">AllocBytes</span><span class="op" id="5712499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5712503">for</span>&nbsp;<span class="ident" id="5712507">_</span><span class="op" id="5712508">,</span>&nbsp;<span class="ident" id="5712510">pc</span>&nbsp;<span class="op" id="5712513">:=</span>&nbsp;<span class="keyword" id="5712516">range</span>&nbsp;<span class="ident" id="5712522">r</span><span class="op" id="5712523">.</span><span class="ident" id="5712524">Stack</span><span class="op" id="5712529">(</span><span class="op" id="5712530">)</span>&nbsp;<span class="op" id="5712532">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712537">fmt</span><span class="op" id="5712540">.</span><span class="ident" id="5712541">Fprintf</span><span class="op" id="5712548">(</span><span class="ident" id="5712549">w</span><span class="op" id="5712550">,</span>&nbsp;<span class="string" id="5712552">&#34;&nbsp;%#x&#34;</span><span class="op" id="5712558">,</span>&nbsp;<span class="ident" id="5712560">pc</span><span class="op" id="5712562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5712566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712570">fmt</span><span class="op" id="5712573">.</span><span class="ident" id="5712574">Fprintf</span><span class="op" id="5712581">(</span><span class="ident" id="5712582">w</span><span class="op" id="5712583">,</span>&nbsp;<span class="string" id="5712585">&#34;\n&#34;</span><span class="op" id="5712589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5712593">if</span>&nbsp;<span class="ident" id="5712596">debug</span>&nbsp;<span class="op" id="5712602">&gt;</span>&nbsp;<span class="num" id="5712604">0</span>&nbsp;<span class="op" id="5712606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712611">printStackRecord</span><span class="op" id="5712627">(</span><span class="ident" id="5712628">w</span><span class="op" id="5712629">,</span>&nbsp;<span class="ident" id="5712631">r</span><span class="op" id="5712632">.</span><span class="ident" id="5712633">Stack</span><span class="op" id="5712638">(</span><span class="op" id="5712639">)</span><span class="op" id="5712640">,</span>&nbsp;<span class="builtintype" id="5712642">false</span><span class="op" id="5712647">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5712651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5712654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5712658">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5712694">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5712739">if</span>&nbsp;<span class="ident" id="5712742">debug</span>&nbsp;<span class="op" id="5712748">&gt;</span>&nbsp;<span class="num" id="5712750">0</span>&nbsp;<span class="op" id="5712752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712756">s</span>&nbsp;<span class="op" id="5712758">:=</span>&nbsp;<span class="builtinfunc" id="5712761">new</span><span class="op" id="5712764">(</span><span class="ident" id="5712765">runtime</span><span class="op" id="5712772">.</span><span class="ident" id="5712773">MemStats</span><span class="op" id="5712781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712785">runtime</span><span class="op" id="5712792">.</span><span class="ident" id="5712793">ReadMemStats</span><span class="op" id="5712805">(</span><span class="ident" id="5712806">s</span><span class="op" id="5712807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712811">fmt</span><span class="op" id="5712814">.</span><span class="ident" id="5712815">Fprintf</span><span class="op" id="5712822">(</span><span class="ident" id="5712823">w</span><span class="op" id="5712824">,</span>&nbsp;<span class="string" id="5712826">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="5712850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712854">fmt</span><span class="op" id="5712857">.</span><span class="ident" id="5712858">Fprintf</span><span class="op" id="5712865">(</span><span class="ident" id="5712866">w</span><span class="op" id="5712867">,</span>&nbsp;<span class="string" id="5712869">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5712885">,</span>&nbsp;<span class="ident" id="5712887">s</span><span class="op" id="5712888">.</span><span class="ident" id="5712889">Alloc</span><span class="op" id="5712894">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712898">fmt</span><span class="op" id="5712901">.</span><span class="ident" id="5712902">Fprintf</span><span class="op" id="5712909">(</span><span class="ident" id="5712910">w</span><span class="op" id="5712911">,</span>&nbsp;<span class="string" id="5712913">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5712934">,</span>&nbsp;<span class="ident" id="5712936">s</span><span class="op" id="5712937">.</span><span class="ident" id="5712938">TotalAlloc</span><span class="op" id="5712948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712952">fmt</span><span class="op" id="5712955">.</span><span class="ident" id="5712956">Fprintf</span><span class="op" id="5712963">(</span><span class="ident" id="5712964">w</span><span class="op" id="5712965">,</span>&nbsp;<span class="string" id="5712967">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5712981">,</span>&nbsp;<span class="ident" id="5712983">s</span><span class="op" id="5712984">.</span><span class="ident" id="5712985">Sys</span><span class="op" id="5712988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5712992">fmt</span><span class="op" id="5712995">.</span><span class="ident" id="5712996">Fprintf</span><span class="op" id="5713003">(</span><span class="ident" id="5713004">w</span><span class="op" id="5713005">,</span>&nbsp;<span class="string" id="5713007">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713025">,</span>&nbsp;<span class="ident" id="5713027">s</span><span class="op" id="5713028">.</span><span class="ident" id="5713029">Lookups</span><span class="op" id="5713036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713040">fmt</span><span class="op" id="5713043">.</span><span class="ident" id="5713044">Fprintf</span><span class="op" id="5713051">(</span><span class="ident" id="5713052">w</span><span class="op" id="5713053">,</span>&nbsp;<span class="string" id="5713055">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713073">,</span>&nbsp;<span class="ident" id="5713075">s</span><span class="op" id="5713076">.</span><span class="ident" id="5713077">Mallocs</span><span class="op" id="5713084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713088">fmt</span><span class="op" id="5713091">.</span><span class="ident" id="5713092">Fprintf</span><span class="op" id="5713099">(</span><span class="ident" id="5713100">w</span><span class="op" id="5713101">,</span>&nbsp;<span class="string" id="5713103">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713119">,</span>&nbsp;<span class="ident" id="5713121">s</span><span class="op" id="5713122">.</span><span class="ident" id="5713123">Frees</span><span class="op" id="5713128">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713133">fmt</span><span class="op" id="5713136">.</span><span class="ident" id="5713137">Fprintf</span><span class="op" id="5713144">(</span><span class="ident" id="5713145">w</span><span class="op" id="5713146">,</span>&nbsp;<span class="string" id="5713148">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713168">,</span>&nbsp;<span class="ident" id="5713170">s</span><span class="op" id="5713171">.</span><span class="ident" id="5713172">HeapAlloc</span><span class="op" id="5713181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713185">fmt</span><span class="op" id="5713188">.</span><span class="ident" id="5713189">Fprintf</span><span class="op" id="5713196">(</span><span class="ident" id="5713197">w</span><span class="op" id="5713198">,</span>&nbsp;<span class="string" id="5713200">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713218">,</span>&nbsp;<span class="ident" id="5713220">s</span><span class="op" id="5713221">.</span><span class="ident" id="5713222">HeapSys</span><span class="op" id="5713229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713233">fmt</span><span class="op" id="5713236">.</span><span class="ident" id="5713237">Fprintf</span><span class="op" id="5713244">(</span><span class="ident" id="5713245">w</span><span class="op" id="5713246">,</span>&nbsp;<span class="string" id="5713248">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713267">,</span>&nbsp;<span class="ident" id="5713269">s</span><span class="op" id="5713270">.</span><span class="ident" id="5713271">HeapIdle</span><span class="op" id="5713279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713283">fmt</span><span class="op" id="5713286">.</span><span class="ident" id="5713287">Fprintf</span><span class="op" id="5713294">(</span><span class="ident" id="5713295">w</span><span class="op" id="5713296">,</span>&nbsp;<span class="string" id="5713298">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713318">,</span>&nbsp;<span class="ident" id="5713320">s</span><span class="op" id="5713321">.</span><span class="ident" id="5713322">HeapInuse</span><span class="op" id="5713331">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713335">fmt</span><span class="op" id="5713338">.</span><span class="ident" id="5713339">Fprintf</span><span class="op" id="5713346">(</span><span class="ident" id="5713347">w</span><span class="op" id="5713348">,</span>&nbsp;<span class="string" id="5713350">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713373">,</span>&nbsp;<span class="ident" id="5713375">s</span><span class="op" id="5713376">.</span><span class="ident" id="5713377">HeapReleased</span><span class="op" id="5713389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713393">fmt</span><span class="op" id="5713396">.</span><span class="ident" id="5713397">Fprintf</span><span class="op" id="5713404">(</span><span class="ident" id="5713405">w</span><span class="op" id="5713406">,</span>&nbsp;<span class="string" id="5713408">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713430">,</span>&nbsp;<span class="ident" id="5713432">s</span><span class="op" id="5713433">.</span><span class="ident" id="5713434">HeapObjects</span><span class="op" id="5713445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713450">fmt</span><span class="op" id="5713453">.</span><span class="ident" id="5713454">Fprintf</span><span class="op" id="5713461">(</span><span class="ident" id="5713462">w</span><span class="op" id="5713463">,</span>&nbsp;<span class="string" id="5713465">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5713486">,</span>&nbsp;<span class="ident" id="5713488">s</span><span class="op" id="5713489">.</span><span class="ident" id="5713490">StackInuse</span><span class="op" id="5713500">,</span>&nbsp;<span class="ident" id="5713502">s</span><span class="op" id="5713503">.</span><span class="ident" id="5713504">StackSys</span><span class="op" id="5713512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713516">fmt</span><span class="op" id="5713519">.</span><span class="ident" id="5713520">Fprintf</span><span class="op" id="5713527">(</span><span class="ident" id="5713528">w</span><span class="op" id="5713529">,</span>&nbsp;<span class="string" id="5713531">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5713552">,</span>&nbsp;<span class="ident" id="5713554">s</span><span class="op" id="5713555">.</span><span class="ident" id="5713556">MSpanInuse</span><span class="op" id="5713566">,</span>&nbsp;<span class="ident" id="5713568">s</span><span class="op" id="5713569">.</span><span class="ident" id="5713570">MSpanSys</span><span class="op" id="5713578">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713582">fmt</span><span class="op" id="5713585">.</span><span class="ident" id="5713586">Fprintf</span><span class="op" id="5713593">(</span><span class="ident" id="5713594">w</span><span class="op" id="5713595">,</span>&nbsp;<span class="string" id="5713597">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="5713619">,</span>&nbsp;<span class="ident" id="5713621">s</span><span class="op" id="5713622">.</span><span class="ident" id="5713623">MCacheInuse</span><span class="op" id="5713634">,</span>&nbsp;<span class="ident" id="5713636">s</span><span class="op" id="5713637">.</span><span class="ident" id="5713638">MCacheSys</span><span class="op" id="5713647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713651">fmt</span><span class="op" id="5713654">.</span><span class="ident" id="5713655">Fprintf</span><span class="op" id="5713662">(</span><span class="ident" id="5713663">w</span><span class="op" id="5713664">,</span>&nbsp;<span class="string" id="5713666">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713688">,</span>&nbsp;<span class="ident" id="5713690">s</span><span class="op" id="5713691">.</span><span class="ident" id="5713692">BuckHashSys</span><span class="op" id="5713703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713708">fmt</span><span class="op" id="5713711">.</span><span class="ident" id="5713712">Fprintf</span><span class="op" id="5713719">(</span><span class="ident" id="5713720">w</span><span class="op" id="5713721">,</span>&nbsp;<span class="string" id="5713723">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713740">,</span>&nbsp;<span class="ident" id="5713742">s</span><span class="op" id="5713743">.</span><span class="ident" id="5713744">NextGC</span><span class="op" id="5713750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713754">fmt</span><span class="op" id="5713757">.</span><span class="ident" id="5713758">Fprintf</span><span class="op" id="5713765">(</span><span class="ident" id="5713766">w</span><span class="op" id="5713767">,</span>&nbsp;<span class="string" id="5713769">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713787">,</span>&nbsp;<span class="ident" id="5713789">s</span><span class="op" id="5713790">.</span><span class="ident" id="5713791">PauseNs</span><span class="op" id="5713798">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713802">fmt</span><span class="op" id="5713805">.</span><span class="ident" id="5713806">Fprintf</span><span class="op" id="5713813">(</span><span class="ident" id="5713814">w</span><span class="op" id="5713815">,</span>&nbsp;<span class="string" id="5713817">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="5713833">,</span>&nbsp;<span class="ident" id="5713835">s</span><span class="op" id="5713836">.</span><span class="ident" id="5713837">NumGC</span><span class="op" id="5713842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713846">fmt</span><span class="op" id="5713849">.</span><span class="ident" id="5713850">Fprintf</span><span class="op" id="5713857">(</span><span class="ident" id="5713858">w</span><span class="op" id="5713859">,</span>&nbsp;<span class="string" id="5713861">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5713880">,</span>&nbsp;<span class="ident" id="5713882">s</span><span class="op" id="5713883">.</span><span class="ident" id="5713884">EnableGC</span><span class="op" id="5713892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713896">fmt</span><span class="op" id="5713899">.</span><span class="ident" id="5713900">Fprintf</span><span class="op" id="5713907">(</span><span class="ident" id="5713908">w</span><span class="op" id="5713909">,</span>&nbsp;<span class="string" id="5713911">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="5713929">,</span>&nbsp;<span class="ident" id="5713931">s</span><span class="op" id="5713932">.</span><span class="ident" id="5713933">DebugGC</span><span class="op" id="5713940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5713943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5713947">if</span>&nbsp;<span class="ident" id="5713950">tw</span>&nbsp;<span class="op" id="5713953">!=</span>&nbsp;<span class="ident" id="5713956">nil</span>&nbsp;<span class="op" id="5713960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5713964">tw</span><span class="op" id="5713966">.</span><span class="ident" id="5713967">Flush</span><span class="op" id="5713972">(</span><span class="op" id="5713973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5713976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5713979">return</span>&nbsp;<span class="ident" id="5713986">b</span><span class="op" id="5713987">.</span><span class="ident" id="5713988">Flush</span><span class="op" id="5713993">(</span><span class="op" id="5713994">)</span><br>
<span class="lineno"></span><span class="op" id="5713996">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5713999">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="5714073">func</span>&nbsp;<span class="ident" id="5714078">countThreadCreate</span><span class="op" id="5714095">(</span><span class="op" id="5714096">)</span>&nbsp;<span class="builtintype" id="5714098">int</span>&nbsp;<span class="op" id="5714102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5714105">n</span><span class="op" id="5714106">,</span>&nbsp;<span class="ident" id="5714108">_</span>&nbsp;<span class="op" id="5714110">:=</span>&nbsp;<span class="ident" id="5714113">runtime</span><span class="op" id="5714120">.</span><span class="ident" id="5714121">ThreadCreateProfile</span><span class="op" id="5714140">(</span><span class="ident" id="5714141">nil</span><span class="op" id="5714144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5714147">return</span>&nbsp;<span class="ident" id="5714154">n</span><br>
<span class="lineno">485</span><span class="op" id="5714156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5714159">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5714233">func</span>&nbsp;<span class="ident" id="5714238">writeThreadCreate</span><span class="op" id="5714255">(</span><span class="ident" id="5714256">w</span>&nbsp;<span class="ident" id="5714258">io</span><span class="op" id="5714260">.</span><span class="ident" id="5714261">Writer</span><span class="op" id="5714267">,</span>&nbsp;<span class="ident" id="5714269">debug</span>&nbsp;<span class="builtintype" id="5714275">int</span><span class="op" id="5714278">)</span>&nbsp;<span class="builtintype" id="5714280">error</span>&nbsp;<span class="op" id="5714286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5714289">return</span>&nbsp;<span class="ident" id="5714296">writeRuntimeProfile</span><span class="op" id="5714315">(</span><span class="ident" id="5714316">w</span><span class="op" id="5714317">,</span>&nbsp;<span class="ident" id="5714319">debug</span><span class="op" id="5714324">,</span>&nbsp;<span class="string" id="5714326">&#34;threadcreate&#34;</span><span class="op" id="5714340">,</span>&nbsp;<span class="ident" id="5714342">runtime</span><span class="op" id="5714349">.</span><span class="ident" id="5714350">ThreadCreateProfile</span><span class="op" id="5714369">)</span><br>
<span class="lineno">490</span><span class="op" id="5714371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5714374">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="5714426">func</span>&nbsp;<span class="ident" id="5714431">countGoroutine</span><span class="op" id="5714445">(</span><span class="op" id="5714446">)</span>&nbsp;<span class="builtintype" id="5714448">int</span>&nbsp;<span class="op" id="5714452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5714455">return</span>&nbsp;<span class="ident" id="5714462">runtime</span><span class="op" id="5714469">.</span><span class="ident" id="5714470">NumGoroutine</span><span class="op" id="5714482">(</span><span class="op" id="5714483">)</span><br>
<span class="lineno">495</span><span class="op" id="5714485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5714488">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5714556">func</span>&nbsp;<span class="ident" id="5714561">writeGoroutine</span><span class="op" id="5714575">(</span><span class="ident" id="5714576">w</span>&nbsp;<span class="ident" id="5714578">io</span><span class="op" id="5714580">.</span><span class="ident" id="5714581">Writer</span><span class="op" id="5714587">,</span>&nbsp;<span class="ident" id="5714589">debug</span>&nbsp;<span class="builtintype" id="5714595">int</span><span class="op" id="5714598">)</span>&nbsp;<span class="builtintype" id="5714600">error</span>&nbsp;<span class="op" id="5714606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5714609">if</span>&nbsp;<span class="ident" id="5714612">debug</span>&nbsp;<span class="op" id="5714618">&gt;=</span>&nbsp;<span class="num" id="5714621">2</span>&nbsp;<span class="op" id="5714623">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5714627">return</span>&nbsp;<span class="ident" id="5714634">writeGoroutineStacks</span><span class="op" id="5714654">(</span><span class="ident" id="5714655">w</span><span class="op" id="5714656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5714659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5714662">return</span>&nbsp;<span class="ident" id="5714669">writeRuntimeProfile</span><span class="op" id="5714688">(</span><span class="ident" id="5714689">w</span><span class="op" id="5714690">,</span>&nbsp;<span class="ident" id="5714692">debug</span><span class="op" id="5714697">,</span>&nbsp;<span class="string" id="5714699">&#34;goroutine&#34;</span><span class="op" id="5714710">,</span>&nbsp;<span class="ident" id="5714712">runtime</span><span class="op" id="5714719">.</span><span class="ident" id="5714720">GoroutineProfile</span><span class="op" id="5714736">)</span><br>
<span class="lineno"></span><span class="op" id="5714738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="5714741">func</span>&nbsp;<span class="ident" id="5714746">writeGoroutineStacks</span><span class="op" id="5714766">(</span><span class="ident" id="5714767">w</span>&nbsp;<span class="ident" id="5714769">io</span><span class="op" id="5714771">.</span><span class="ident" id="5714772">Writer</span><span class="op" id="5714778">)</span>&nbsp;<span class="builtintype" id="5714780">error</span>&nbsp;<span class="op" id="5714786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5714789">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5714849">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5714931">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5714993">buf</span>&nbsp;<span class="op" id="5714997">:=</span>&nbsp;<span class="builtinfunc" id="5715000">make</span><span class="op" id="5715004">(</span><span class="op" id="5715005">[</span><span class="op" id="5715006">]</span><span class="builtintype" id="5715007">byte</span><span class="op" id="5715011">,</span>&nbsp;<span class="num" id="5715013">1</span><span class="op" id="5715014">&lt;&lt;</span><span class="num" id="5715016">20</span><span class="op" id="5715018">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715021">for</span>&nbsp;<span class="ident" id="5715025">i</span>&nbsp;<span class="op" id="5715027">:=</span>&nbsp;<span class="num" id="5715030">0</span><span class="op" id="5715031">;</span>&nbsp;<span class="op" id="5715033">;</span>&nbsp;<span class="ident" id="5715035">i</span><span class="op" id="5715036">++</span>&nbsp;<span class="op" id="5715039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715043">n</span>&nbsp;<span class="op" id="5715045">:=</span>&nbsp;<span class="ident" id="5715048">runtime</span><span class="op" id="5715055">.</span><span class="ident" id="5715056">Stack</span><span class="op" id="5715061">(</span><span class="ident" id="5715062">buf</span><span class="op" id="5715065">,</span>&nbsp;<span class="builtintype" id="5715067">true</span><span class="op" id="5715071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715075">if</span>&nbsp;<span class="ident" id="5715078">n</span>&nbsp;<span class="op" id="5715080">&lt;</span>&nbsp;<span class="builtinfunc" id="5715082">len</span><span class="op" id="5715085">(</span><span class="ident" id="5715086">buf</span><span class="op" id="5715089">)</span>&nbsp;<span class="op" id="5715091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715096">buf</span>&nbsp;<span class="op" id="5715100">=</span>&nbsp;<span class="ident" id="5715102">buf</span><span class="op" id="5715105">[</span><span class="op" id="5715106">:</span><span class="ident" id="5715107">n</span><span class="op" id="5715108">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715113">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5715121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715125">if</span>&nbsp;<span class="builtinfunc" id="5715128">len</span><span class="op" id="5715131">(</span><span class="ident" id="5715132">buf</span><span class="op" id="5715135">)</span>&nbsp;<span class="op" id="5715137">&gt;=</span>&nbsp;<span class="num" id="5715140">64</span><span class="op" id="5715142">&lt;&lt;</span><span class="num" id="5715144">20</span>&nbsp;<span class="op" id="5715147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715152">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715185">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5715193">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715197">buf</span>&nbsp;<span class="op" id="5715201">=</span>&nbsp;<span class="builtinfunc" id="5715203">make</span><span class="op" id="5715207">(</span><span class="op" id="5715208">[</span><span class="op" id="5715209">]</span><span class="builtintype" id="5715210">byte</span><span class="op" id="5715214">,</span>&nbsp;<span class="num" id="5715216">2</span><span class="op" id="5715217">*</span><span class="builtinfunc" id="5715218">len</span><span class="op" id="5715221">(</span><span class="ident" id="5715222">buf</span><span class="op" id="5715225">)</span><span class="op" id="5715226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5715229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715232">_</span><span class="op" id="5715233">,</span>&nbsp;<span class="ident" id="5715235">err</span>&nbsp;<span class="op" id="5715239">:=</span>&nbsp;<span class="ident" id="5715242">w</span><span class="op" id="5715243">.</span><span class="ident" id="5715244">Write</span><span class="op" id="5715249">(</span><span class="ident" id="5715250">buf</span><span class="op" id="5715253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715256">return</span>&nbsp;<span class="ident" id="5715263">err</span><br>
<span class="lineno"></span><span class="op" id="5715267">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="5715270">func</span>&nbsp;<span class="ident" id="5715275">writeRuntimeProfile</span><span class="op" id="5715294">(</span><span class="ident" id="5715295">w</span>&nbsp;<span class="ident" id="5715297">io</span><span class="op" id="5715299">.</span><span class="ident" id="5715300">Writer</span><span class="op" id="5715306">,</span>&nbsp;<span class="ident" id="5715308">debug</span>&nbsp;<span class="builtintype" id="5715314">int</span><span class="op" id="5715317">,</span>&nbsp;<span class="ident" id="5715319">name</span>&nbsp;<span class="builtintype" id="5715324">string</span><span class="op" id="5715330">,</span>&nbsp;<span class="ident" id="5715332">fetch</span>&nbsp;<span class="keyword" id="5715338">func</span><span class="op" id="5715342">(</span><span class="op" id="5715343">[</span><span class="op" id="5715344">]</span><span class="ident" id="5715345">runtime</span><span class="op" id="5715352">.</span><span class="ident" id="5715353">StackRecord</span><span class="op" id="5715364">)</span>&nbsp;<span class="op" id="5715366">(</span><span class="builtintype" id="5715367">int</span><span class="op" id="5715370">,</span>&nbsp;<span class="builtintype" id="5715372">bool</span><span class="op" id="5715376">)</span><span class="op" id="5715377">)</span>&nbsp;<span class="builtintype" id="5715379">error</span>&nbsp;<span class="op" id="5715385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715388">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715442">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715492">//&nbsp;There&#39;s&nbsp;a&nbsp;racemore&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715549">//&nbsp;the&nbsp;two&nbsp;callsso&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715612">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715658">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715725">var</span>&nbsp;<span class="ident" id="5715729">p</span>&nbsp;<span class="op" id="5715731">[</span><span class="op" id="5715732">]</span><span class="ident" id="5715733">runtime</span><span class="op" id="5715740">.</span><span class="ident" id="5715741">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715754">n</span><span class="op" id="5715755">,</span>&nbsp;<span class="ident" id="5715757">ok</span>&nbsp;<span class="op" id="5715760">:=</span>&nbsp;<span class="ident" id="5715763">fetch</span><span class="op" id="5715768">(</span><span class="ident" id="5715769">nil</span><span class="op" id="5715772">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715775">for</span>&nbsp;<span class="op" id="5715779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715783">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715833">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5715881">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715919">p</span>&nbsp;<span class="op" id="5715921">=</span>&nbsp;<span class="builtinfunc" id="5715923">make</span><span class="op" id="5715927">(</span><span class="op" id="5715928">[</span><span class="op" id="5715929">]</span><span class="ident" id="5715930">runtime</span><span class="op" id="5715937">.</span><span class="ident" id="5715938">StackRecord</span><span class="op" id="5715949">,</span>&nbsp;<span class="ident" id="5715951">n</span><span class="op" id="5715952">+</span><span class="num" id="5715953">10</span><span class="op" id="5715955">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715959">n</span><span class="op" id="5715960">,</span>&nbsp;<span class="ident" id="5715962">ok</span>&nbsp;<span class="op" id="5715965">=</span>&nbsp;<span class="ident" id="5715967">fetch</span><span class="op" id="5715972">(</span><span class="ident" id="5715973">p</span><span class="op" id="5715974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5715978">if</span>&nbsp;<span class="ident" id="5715981">ok</span>&nbsp;<span class="op" id="5715984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5715989">p</span>&nbsp;<span class="op" id="5715991">=</span>&nbsp;<span class="ident" id="5715993">p</span><span class="op" id="5715994">[</span><span class="num" id="5715995">0</span><span class="op" id="5715996">:</span><span class="ident" id="5715997">n</span><span class="op" id="5715998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5716003">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5716011">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716015">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5716044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5716048">return</span>&nbsp;<span class="ident" id="5716055">printCountProfile</span><span class="op" id="5716072">(</span><span class="ident" id="5716073">w</span><span class="op" id="5716074">,</span>&nbsp;<span class="ident" id="5716076">debug</span><span class="op" id="5716081">,</span>&nbsp;<span class="ident" id="5716083">name</span><span class="op" id="5716087">,</span>&nbsp;<span class="ident" id="5716089">runtimeProfile</span><span class="op" id="5716103">(</span><span class="ident" id="5716104">p</span><span class="op" id="5716105">)</span><span class="op" id="5716106">)</span><br>
<span class="lineno"></span><span class="op" id="5716108">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="5716111">type</span>&nbsp;<span class="ident" id="5716116">runtimeProfile</span>&nbsp;<span class="op" id="5716131">[</span><span class="op" id="5716132">]</span><span class="ident" id="5716133">runtime</span><span class="op" id="5716140">.</span><span class="ident" id="5716141">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5716154">func</span>&nbsp;<span class="op" id="5716159">(</span><span class="ident" id="5716160">p</span>&nbsp;<span class="ident" id="5716162">runtimeProfile</span><span class="op" id="5716176">)</span>&nbsp;<span class="ident" id="5716178">Len</span><span class="op" id="5716181">(</span><span class="op" id="5716182">)</span>&nbsp;<span class="builtintype" id="5716184">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5716201">{</span>&nbsp;<span class="keyword" id="5716203">return</span>&nbsp;<span class="builtinfunc" id="5716210">len</span><span class="op" id="5716213">(</span><span class="ident" id="5716214">p</span><span class="op" id="5716215">)</span>&nbsp;<span class="op" id="5716217">}</span><br>
<span class="lineno"></span><span class="keyword" id="5716219">func</span>&nbsp;<span class="op" id="5716224">(</span><span class="ident" id="5716225">p</span>&nbsp;<span class="ident" id="5716227">runtimeProfile</span><span class="op" id="5716241">)</span>&nbsp;<span class="ident" id="5716243">Stack</span><span class="op" id="5716248">(</span><span class="ident" id="5716249">i</span>&nbsp;<span class="builtintype" id="5716251">int</span><span class="op" id="5716254">)</span>&nbsp;<span class="op" id="5716256">[</span><span class="op" id="5716257">]</span><span class="builtintype" id="5716258">uintptr</span>&nbsp;<span class="op" id="5716266">{</span>&nbsp;<span class="keyword" id="5716268">return</span>&nbsp;<span class="ident" id="5716275">p</span><span class="op" id="5716276">[</span><span class="ident" id="5716277">i</span><span class="op" id="5716278">]</span><span class="op" id="5716279">.</span><span class="ident" id="5716280">Stack</span><span class="op" id="5716285">(</span><span class="op" id="5716286">)</span>&nbsp;<span class="op" id="5716288">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="5716291">var</span>&nbsp;<span class="ident" id="5716295">cpu</span>&nbsp;<span class="keyword" id="5716299">struct</span>&nbsp;<span class="op" id="5716306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5716309">sync</span><span class="op" id="5716313">.</span><span class="ident" id="5716314">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5716321">profiling</span>&nbsp;<span class="builtintype" id="5716331">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5716337">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5716347">chan</span>&nbsp;<span class="builtintype" id="5716352">bool</span><br>
<span class="lineno">560</span><span class="op" id="5716357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5716360">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="5716426">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5716493">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="5716562">func</span>&nbsp;<span class="ident" id="5716567">StartCPUProfile</span><span class="op" id="5716582">(</span><span class="ident" id="5716583">w</span>&nbsp;<span class="ident" id="5716585">io</span><span class="op" id="5716587">.</span><span class="ident" id="5716588">Writer</span><span class="op" id="5716594">)</span>&nbsp;<span class="builtintype" id="5716596">error</span>&nbsp;<span class="op" id="5716602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716605">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716663">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716724">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716781">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716839">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716899">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5716956">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5717011">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5717071">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717130">const</span>&nbsp;<span class="ident" id="5717136">hz</span>&nbsp;<span class="op" id="5717139">=</span>&nbsp;<span class="num" id="5717141">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717147">cpu</span><span class="op" id="5717150">.</span><span class="ident" id="5717151">Lock</span><span class="op" id="5717155">(</span><span class="op" id="5717156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717159">defer</span>&nbsp;<span class="ident" id="5717165">cpu</span><span class="op" id="5717168">.</span><span class="ident" id="5717169">Unlock</span><span class="op" id="5717175">(</span><span class="op" id="5717176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717179">if</span>&nbsp;<span class="ident" id="5717182">cpu</span><span class="op" id="5717185">.</span><span class="ident" id="5717186">done</span>&nbsp;<span class="op" id="5717191">==</span>&nbsp;<span class="ident" id="5717194">nil</span>&nbsp;<span class="op" id="5717198">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717202">cpu</span><span class="op" id="5717205">.</span><span class="ident" id="5717206">done</span>&nbsp;<span class="op" id="5717211">=</span>&nbsp;<span class="builtinfunc" id="5717213">make</span><span class="op" id="5717217">(</span><span class="keyword" id="5717218">chan</span>&nbsp;<span class="builtintype" id="5717223">bool</span><span class="op" id="5717227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5717233">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717251">if</span>&nbsp;<span class="ident" id="5717254">cpu</span><span class="op" id="5717257">.</span><span class="ident" id="5717258">profiling</span>&nbsp;<span class="op" id="5717268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717272">return</span>&nbsp;<span class="ident" id="5717279">fmt</span><span class="op" id="5717282">.</span><span class="ident" id="5717283">Errorf</span><span class="op" id="5717289">(</span><span class="string" id="5717290">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="5717320">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717326">cpu</span><span class="op" id="5717329">.</span><span class="ident" id="5717330">profiling</span>&nbsp;<span class="op" id="5717340">=</span>&nbsp;<span class="builtintype" id="5717342">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717348">runtime</span><span class="op" id="5717355">.</span><span class="ident" id="5717356">SetCPUProfileRate</span><span class="op" id="5717373">(</span><span class="ident" id="5717374">hz</span><span class="op" id="5717376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717379">go</span>&nbsp;<span class="ident" id="5717382">profileWriter</span><span class="op" id="5717395">(</span><span class="ident" id="5717396">w</span><span class="op" id="5717397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717400">return</span>&nbsp;<span class="ident" id="5717407">nil</span><br>
<span class="lineno">590</span><span class="op" id="5717411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5717414">func</span>&nbsp;<span class="ident" id="5717419">profileWriter</span><span class="op" id="5717432">(</span><span class="ident" id="5717433">w</span>&nbsp;<span class="ident" id="5717435">io</span><span class="op" id="5717437">.</span><span class="ident" id="5717438">Writer</span><span class="op" id="5717444">)</span>&nbsp;<span class="op" id="5717446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717449">for</span>&nbsp;<span class="op" id="5717453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717457">data</span>&nbsp;<span class="op" id="5717462">:=</span>&nbsp;<span class="ident" id="5717465">runtime</span><span class="op" id="5717472">.</span><span class="ident" id="5717473">CPUProfile</span><span class="op" id="5717483">(</span><span class="op" id="5717484">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717488">if</span>&nbsp;<span class="ident" id="5717491">data</span>&nbsp;<span class="op" id="5717496">==</span>&nbsp;<span class="ident" id="5717499">nil</span>&nbsp;<span class="op" id="5717503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717508">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717520">w</span><span class="op" id="5717521">.</span><span class="ident" id="5717522">Write</span><span class="op" id="5717527">(</span><span class="ident" id="5717528">data</span><span class="op" id="5717532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717535">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717538">cpu</span><span class="op" id="5717541">.</span><span class="ident" id="5717542">done</span>&nbsp;<span class="op" id="5717547">&lt;-</span>&nbsp;<span class="builtintype" id="5717550">true</span><br>
<span class="lineno"></span><span class="op" id="5717555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5717558">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="5717615">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="5717675">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5717702">func</span>&nbsp;<span class="ident" id="5717707">StopCPUProfile</span><span class="op" id="5717721">(</span><span class="op" id="5717722">)</span>&nbsp;<span class="op" id="5717724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717727">cpu</span><span class="op" id="5717730">.</span><span class="ident" id="5717731">Lock</span><span class="op" id="5717735">(</span><span class="op" id="5717736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717739">defer</span>&nbsp;<span class="ident" id="5717745">cpu</span><span class="op" id="5717748">.</span><span class="ident" id="5717749">Unlock</span><span class="op" id="5717755">(</span><span class="op" id="5717756">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717760">if</span>&nbsp;<span class="op" id="5717763">!</span><span class="ident" id="5717764">cpu</span><span class="op" id="5717767">.</span><span class="ident" id="5717768">profiling</span>&nbsp;<span class="op" id="5717778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5717782">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717793">cpu</span><span class="op" id="5717796">.</span><span class="ident" id="5717797">profiling</span>&nbsp;<span class="op" id="5717807">=</span>&nbsp;<span class="builtintype" id="5717809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5717816">runtime</span><span class="op" id="5717823">.</span><span class="ident" id="5717824">SetCPUProfileRate</span><span class="op" id="5717841">(</span><span class="num" id="5717842">0</span><span class="op" id="5717843">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717846">&lt;-</span><span class="ident" id="5717848">cpu</span><span class="op" id="5717851">.</span><span class="ident" id="5717852">done</span><br>
<span class="lineno"></span><span class="op" id="5717857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5717860">type</span>&nbsp;<span class="ident" id="5717865">byCycles</span>&nbsp;<span class="op" id="5717874">[</span><span class="op" id="5717875">]</span><span class="ident" id="5717876">runtime</span><span class="op" id="5717883">.</span><span class="ident" id="5717884">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="5717904">func</span>&nbsp;<span class="op" id="5717909">(</span><span class="ident" id="5717910">x</span>&nbsp;<span class="ident" id="5717912">byCycles</span><span class="op" id="5717920">)</span>&nbsp;<span class="ident" id="5717922">Len</span><span class="op" id="5717925">(</span><span class="op" id="5717926">)</span>&nbsp;<span class="builtintype" id="5717928">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717942">{</span>&nbsp;<span class="keyword" id="5717944">return</span>&nbsp;<span class="builtinfunc" id="5717951">len</span><span class="op" id="5717954">(</span><span class="ident" id="5717955">x</span><span class="op" id="5717956">)</span>&nbsp;<span class="op" id="5717958">}</span><br>
<span class="lineno"></span><span class="keyword" id="5717960">func</span>&nbsp;<span class="op" id="5717965">(</span><span class="ident" id="5717966">x</span>&nbsp;<span class="ident" id="5717968">byCycles</span><span class="op" id="5717976">)</span>&nbsp;<span class="ident" id="5717978">Swap</span><span class="op" id="5717982">(</span><span class="ident" id="5717983">i</span><span class="op" id="5717984">,</span>&nbsp;<span class="ident" id="5717986">j</span>&nbsp;<span class="builtintype" id="5717988">int</span><span class="op" id="5717991">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5717998">{</span>&nbsp;<span class="ident" id="5718000">x</span><span class="op" id="5718001">[</span><span class="ident" id="5718002">i</span><span class="op" id="5718003">]</span><span class="op" id="5718004">,</span>&nbsp;<span class="ident" id="5718006">x</span><span class="op" id="5718007">[</span><span class="ident" id="5718008">j</span><span class="op" id="5718009">]</span>&nbsp;<span class="op" id="5718011">=</span>&nbsp;<span class="ident" id="5718013">x</span><span class="op" id="5718014">[</span><span class="ident" id="5718015">j</span><span class="op" id="5718016">]</span><span class="op" id="5718017">,</span>&nbsp;<span class="ident" id="5718019">x</span><span class="op" id="5718020">[</span><span class="ident" id="5718021">i</span><span class="op" id="5718022">]</span>&nbsp;<span class="op" id="5718024">}</span><br>
<span class="lineno"></span><span class="keyword" id="5718026">func</span>&nbsp;<span class="op" id="5718031">(</span><span class="ident" id="5718032">x</span>&nbsp;<span class="ident" id="5718034">byCycles</span><span class="op" id="5718042">)</span>&nbsp;<span class="ident" id="5718044">Less</span><span class="op" id="5718048">(</span><span class="ident" id="5718049">i</span><span class="op" id="5718050">,</span>&nbsp;<span class="ident" id="5718052">j</span>&nbsp;<span class="builtintype" id="5718054">int</span><span class="op" id="5718057">)</span>&nbsp;<span class="builtintype" id="5718059">bool</span>&nbsp;<span class="op" id="5718064">{</span>&nbsp;<span class="keyword" id="5718066">return</span>&nbsp;<span class="ident" id="5718073">x</span><span class="op" id="5718074">[</span><span class="ident" id="5718075">i</span><span class="op" id="5718076">]</span><span class="op" id="5718077">.</span><span class="ident" id="5718078">Cycles</span>&nbsp;<span class="op" id="5718085">&gt;</span>&nbsp;<span class="ident" id="5718087">x</span><span class="op" id="5718088">[</span><span class="ident" id="5718089">j</span><span class="op" id="5718090">]</span><span class="op" id="5718091">.</span><span class="ident" id="5718092">Cycles</span>&nbsp;<span class="op" id="5718099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5718102">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="5718171">func</span>&nbsp;<span class="ident" id="5718176">countBlock</span><span class="op" id="5718186">(</span><span class="op" id="5718187">)</span>&nbsp;<span class="builtintype" id="5718189">int</span>&nbsp;<span class="op" id="5718193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718196">n</span><span class="op" id="5718197">,</span>&nbsp;<span class="ident" id="5718199">_</span>&nbsp;<span class="op" id="5718201">:=</span>&nbsp;<span class="ident" id="5718204">runtime</span><span class="op" id="5718211">.</span><span class="ident" id="5718212">BlockProfile</span><span class="op" id="5718224">(</span><span class="ident" id="5718225">nil</span><span class="op" id="5718228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718231">return</span>&nbsp;<span class="ident" id="5718238">n</span><br>
<span class="lineno"></span><span class="op" id="5718240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="5718243">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="5718299">func</span>&nbsp;<span class="ident" id="5718304">writeBlock</span><span class="op" id="5718314">(</span><span class="ident" id="5718315">w</span>&nbsp;<span class="ident" id="5718317">io</span><span class="op" id="5718319">.</span><span class="ident" id="5718320">Writer</span><span class="op" id="5718326">,</span>&nbsp;<span class="ident" id="5718328">debug</span>&nbsp;<span class="builtintype" id="5718334">int</span><span class="op" id="5718337">)</span>&nbsp;<span class="builtintype" id="5718339">error</span>&nbsp;<span class="op" id="5718345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718348">var</span>&nbsp;<span class="ident" id="5718352">p</span>&nbsp;<span class="op" id="5718354">[</span><span class="op" id="5718355">]</span><span class="ident" id="5718356">runtime</span><span class="op" id="5718363">.</span><span class="ident" id="5718364">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718384">n</span><span class="op" id="5718385">,</span>&nbsp;<span class="ident" id="5718387">ok</span>&nbsp;<span class="op" id="5718390">:=</span>&nbsp;<span class="ident" id="5718393">runtime</span><span class="op" id="5718400">.</span><span class="ident" id="5718401">BlockProfile</span><span class="op" id="5718413">(</span><span class="ident" id="5718414">nil</span><span class="op" id="5718417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718420">for</span>&nbsp;<span class="op" id="5718424">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718428">p</span>&nbsp;<span class="op" id="5718430">=</span>&nbsp;<span class="builtinfunc" id="5718432">make</span><span class="op" id="5718436">(</span><span class="op" id="5718437">[</span><span class="op" id="5718438">]</span><span class="ident" id="5718439">runtime</span><span class="op" id="5718446">.</span><span class="ident" id="5718447">BlockProfileRecord</span><span class="op" id="5718465">,</span>&nbsp;<span class="ident" id="5718467">n</span><span class="op" id="5718468">+</span><span class="num" id="5718469">50</span><span class="op" id="5718471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718475">n</span><span class="op" id="5718476">,</span>&nbsp;<span class="ident" id="5718478">ok</span>&nbsp;<span class="op" id="5718481">=</span>&nbsp;<span class="ident" id="5718483">runtime</span><span class="op" id="5718490">.</span><span class="ident" id="5718491">BlockProfile</span><span class="op" id="5718503">(</span><span class="ident" id="5718504">p</span><span class="op" id="5718505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718509">if</span>&nbsp;<span class="ident" id="5718512">ok</span>&nbsp;<span class="op" id="5718515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718520">p</span>&nbsp;<span class="op" id="5718522">=</span>&nbsp;<span class="ident" id="5718524">p</span><span class="op" id="5718525">[</span><span class="op" id="5718526">:</span><span class="ident" id="5718527">n</span><span class="op" id="5718528">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718533">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5718541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5718544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718548">sort</span><span class="op" id="5718552">.</span><span class="ident" id="5718553">Sort</span><span class="op" id="5718557">(</span><span class="ident" id="5718558">byCycles</span><span class="op" id="5718566">(</span><span class="ident" id="5718567">p</span><span class="op" id="5718568">)</span><span class="op" id="5718569">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718573">b</span>&nbsp;<span class="op" id="5718575">:=</span>&nbsp;<span class="ident" id="5718578">bufio</span><span class="op" id="5718583">.</span><span class="ident" id="5718584">NewWriter</span><span class="op" id="5718593">(</span><span class="ident" id="5718594">w</span><span class="op" id="5718595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718598">var</span>&nbsp;<span class="ident" id="5718602">tw</span>&nbsp;<span class="op" id="5718605">*</span><span class="ident" id="5718606">tabwriter</span><span class="op" id="5718615">.</span><span class="ident" id="5718616">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718624">w</span>&nbsp;<span class="op" id="5718626">=</span>&nbsp;<span class="ident" id="5718628">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718631">if</span>&nbsp;<span class="ident" id="5718634">debug</span>&nbsp;<span class="op" id="5718640">&gt;</span>&nbsp;<span class="num" id="5718642">0</span>&nbsp;<span class="op" id="5718644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718648">tw</span>&nbsp;<span class="op" id="5718651">=</span>&nbsp;<span class="ident" id="5718653">tabwriter</span><span class="op" id="5718662">.</span><span class="ident" id="5718663">NewWriter</span><span class="op" id="5718672">(</span><span class="ident" id="5718673">w</span><span class="op" id="5718674">,</span>&nbsp;<span class="num" id="5718676">1</span><span class="op" id="5718677">,</span>&nbsp;<span class="num" id="5718679">8</span><span class="op" id="5718680">,</span>&nbsp;<span class="num" id="5718682">1</span><span class="op" id="5718683">,</span>&nbsp;<span class="string" id="5718685">&#39;\t&#39;</span><span class="op" id="5718689">,</span>&nbsp;<span class="num" id="5718691">0</span><span class="op" id="5718692">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718696">w</span>&nbsp;<span class="op" id="5718698">=</span>&nbsp;<span class="ident" id="5718700">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5718704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718708">fmt</span><span class="op" id="5718711">.</span><span class="ident" id="5718712">Fprintf</span><span class="op" id="5718719">(</span><span class="ident" id="5718720">w</span><span class="op" id="5718721">,</span>&nbsp;<span class="string" id="5718723">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="5718742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718745">fmt</span><span class="op" id="5718748">.</span><span class="ident" id="5718749">Fprintf</span><span class="op" id="5718756">(</span><span class="ident" id="5718757">w</span><span class="op" id="5718758">,</span>&nbsp;<span class="string" id="5718760">&#34;cycles/second=%v\n&#34;</span><span class="op" id="5718780">,</span>&nbsp;<span class="ident" id="5718782">runtime_cyclesPerSecond</span><span class="op" id="5718805">(</span><span class="op" id="5718806">)</span><span class="op" id="5718807">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718810">for</span>&nbsp;<span class="ident" id="5718814">i</span>&nbsp;<span class="op" id="5718816">:=</span>&nbsp;<span class="keyword" id="5718819">range</span>&nbsp;<span class="ident" id="5718825">p</span>&nbsp;<span class="op" id="5718827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718831">r</span>&nbsp;<span class="op" id="5718833">:=</span>&nbsp;<span class="op" id="5718836">&amp;</span><span class="ident" id="5718837">p</span><span class="op" id="5718838">[</span><span class="ident" id="5718839">i</span><span class="op" id="5718840">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718844">fmt</span><span class="op" id="5718847">.</span><span class="ident" id="5718848">Fprintf</span><span class="op" id="5718855">(</span><span class="ident" id="5718856">w</span><span class="op" id="5718857">,</span>&nbsp;<span class="string" id="5718859">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="5718868">,</span>&nbsp;<span class="ident" id="5718870">r</span><span class="op" id="5718871">.</span><span class="ident" id="5718872">Cycles</span><span class="op" id="5718878">,</span>&nbsp;<span class="ident" id="5718880">r</span><span class="op" id="5718881">.</span><span class="ident" id="5718882">Count</span><span class="op" id="5718887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718891">for</span>&nbsp;<span class="ident" id="5718895">_</span><span class="op" id="5718896">,</span>&nbsp;<span class="ident" id="5718898">pc</span>&nbsp;<span class="op" id="5718901">:=</span>&nbsp;<span class="keyword" id="5718904">range</span>&nbsp;<span class="ident" id="5718910">r</span><span class="op" id="5718911">.</span><span class="ident" id="5718912">Stack</span><span class="op" id="5718917">(</span><span class="op" id="5718918">)</span>&nbsp;<span class="op" id="5718920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718925">fmt</span><span class="op" id="5718928">.</span><span class="ident" id="5718929">Fprintf</span><span class="op" id="5718936">(</span><span class="ident" id="5718937">w</span><span class="op" id="5718938">,</span>&nbsp;<span class="string" id="5718940">&#34;&nbsp;%#x&#34;</span><span class="op" id="5718946">,</span>&nbsp;<span class="ident" id="5718948">pc</span><span class="op" id="5718950">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5718954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718958">fmt</span><span class="op" id="5718961">.</span><span class="ident" id="5718962">Fprint</span><span class="op" id="5718968">(</span><span class="ident" id="5718969">w</span><span class="op" id="5718970">,</span>&nbsp;<span class="string" id="5718972">&#34;\n&#34;</span><span class="op" id="5718976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5718980">if</span>&nbsp;<span class="ident" id="5718983">debug</span>&nbsp;<span class="op" id="5718989">&gt;</span>&nbsp;<span class="num" id="5718991">0</span>&nbsp;<span class="op" id="5718993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5718998">printStackRecord</span><span class="op" id="5719014">(</span><span class="ident" id="5719015">w</span><span class="op" id="5719016">,</span>&nbsp;<span class="ident" id="5719018">r</span><span class="op" id="5719019">.</span><span class="ident" id="5719020">Stack</span><span class="op" id="5719025">(</span><span class="op" id="5719026">)</span><span class="op" id="5719027">,</span>&nbsp;<span class="builtintype" id="5719029">true</span><span class="op" id="5719033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5719037">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5719040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5719044">if</span>&nbsp;<span class="ident" id="5719047">tw</span>&nbsp;<span class="op" id="5719050">!=</span>&nbsp;<span class="ident" id="5719053">nil</span>&nbsp;<span class="op" id="5719057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5719061">tw</span><span class="op" id="5719063">.</span><span class="ident" id="5719064">Flush</span><span class="op" id="5719069">(</span><span class="op" id="5719070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5719073">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5719076">return</span>&nbsp;<span class="ident" id="5719083">b</span><span class="op" id="5719084">.</span><span class="ident" id="5719085">Flush</span><span class="op" id="5719090">(</span><span class="op" id="5719091">)</span><br>
<span class="lineno"></span><span class="op" id="5719093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5719096">func</span>&nbsp;<span class="ident" id="5719101">runtime_cyclesPerSecond</span><span class="op" id="5719124">(</span><span class="op" id="5719125">)</span>&nbsp;<span class="ident" id="5719127">int64</span>
</div>
</body>
</html>
