<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html" class="current">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4268598">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4268653">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4268707">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4268757">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="4268761">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4268954">package</span>&nbsp;<span class="ident" id="4268962">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4268973">import</span>&nbsp;<span class="op" id="4268980">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268983">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268992">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4269001">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4269008">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4269014">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4269027">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4269035">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="4269051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4269054">var</span>&nbsp;<span class="ident" id="4269058">emptyParams</span>&nbsp;<span class="op" id="4269070">=</span>&nbsp;<span class="builtinfunc" id="4269072">make</span><span class="op" id="4269076">(</span><span class="keyword" id="4269077">map</span><span class="op" id="4269080">[</span><span class="builtintype" id="4269081">string</span><span class="op" id="4269087">]</span><span class="builtintype" id="4269088">string</span><span class="op" id="4269094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4269097">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="4269153">type</span>&nbsp;<span class="ident" id="4269158">Part</span>&nbsp;<span class="keyword" id="4269163">struct</span>&nbsp;<span class="op" id="4269170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269173">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269238">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269300">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269353">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269357">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269422">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269484">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269547">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269570">Header</span>&nbsp;<span class="ident" id="4269577">textproto</span><span class="op" id="4269586">.</span><span class="ident" id="4269587">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269600">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269610">*</span><span class="ident" id="4269611">bytes</span><span class="op" id="4269616">.</span><span class="ident" id="4269617">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269625">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269635">*</span><span class="ident" id="4269636">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269644">bytesRead</span>&nbsp;<span class="builtintype" id="4269654">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269660">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4269678">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269686">dispositionParams</span>&nbsp;<span class="keyword" id="4269704">map</span><span class="op" id="4269707">[</span><span class="builtintype" id="4269708">string</span><span class="op" id="4269714">]</span><span class="builtintype" id="4269715">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269724">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269785">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269832">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269862">r</span>&nbsp;<span class="ident" id="4269864">io</span><span class="op" id="4269866">.</span><span class="ident" id="4269867">Reader</span><br>
<span class="lineno">50</span><span class="op" id="4269874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4269877">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="4269947">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4270011">func</span>&nbsp;<span class="op" id="4270016">(</span><span class="ident" id="4270017">p</span>&nbsp;<span class="op" id="4270019">*</span><span class="ident" id="4270020">Part</span><span class="op" id="4270024">)</span>&nbsp;<span class="ident" id="4270026">FormName</span><span class="op" id="4270034">(</span><span class="op" id="4270035">)</span>&nbsp;<span class="builtintype" id="4270037">string</span>&nbsp;<span class="op" id="4270044">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4270047">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4270109">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270150">if</span>&nbsp;<span class="ident" id="4270153">p</span><span class="op" id="4270154">.</span><span class="ident" id="4270155">dispositionParams</span>&nbsp;<span class="op" id="4270173">==</span>&nbsp;<span class="builtintype" id="4270176">nil</span>&nbsp;<span class="op" id="4270180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270184">p</span><span class="op" id="4270185">.</span><span class="ident" id="4270186">parseContentDisposition</span><span class="op" id="4270209">(</span><span class="op" id="4270210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270213">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270216">if</span>&nbsp;<span class="ident" id="4270219">p</span><span class="op" id="4270220">.</span><span class="ident" id="4270221">disposition</span>&nbsp;<span class="op" id="4270233">!=</span>&nbsp;<span class="string" id="4270236">&#34;form-data&#34;</span>&nbsp;<span class="op" id="4270248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270252">return</span>&nbsp;<span class="string" id="4270259">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270266">return</span>&nbsp;<span class="ident" id="4270273">p</span><span class="op" id="4270274">.</span><span class="ident" id="4270275">dispositionParams</span><span class="op" id="4270292">[</span><span class="string" id="4270293">&#34;name&#34;</span><span class="op" id="4270299">]</span><br>
<span class="lineno"></span><span class="op" id="4270301">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="4270304">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4270361">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4270392">func</span>&nbsp;<span class="op" id="4270397">(</span><span class="ident" id="4270398">p</span>&nbsp;<span class="op" id="4270400">*</span><span class="ident" id="4270401">Part</span><span class="op" id="4270405">)</span>&nbsp;<span class="ident" id="4270407">FileName</span><span class="op" id="4270415">(</span><span class="op" id="4270416">)</span>&nbsp;<span class="builtintype" id="4270418">string</span>&nbsp;<span class="op" id="4270425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270428">if</span>&nbsp;<span class="ident" id="4270431">p</span><span class="op" id="4270432">.</span><span class="ident" id="4270433">dispositionParams</span>&nbsp;<span class="op" id="4270451">==</span>&nbsp;<span class="builtintype" id="4270454">nil</span>&nbsp;<span class="op" id="4270458">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270462">p</span><span class="op" id="4270463">.</span><span class="ident" id="4270464">parseContentDisposition</span><span class="op" id="4270487">(</span><span class="op" id="4270488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270494">return</span>&nbsp;<span class="ident" id="4270501">p</span><span class="op" id="4270502">.</span><span class="ident" id="4270503">dispositionParams</span><span class="op" id="4270520">[</span><span class="string" id="4270521">&#34;filename&#34;</span><span class="op" id="4270531">]</span><br>
<span class="lineno"></span><span class="op" id="4270533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="4270536">func</span>&nbsp;<span class="op" id="4270541">(</span><span class="ident" id="4270542">p</span>&nbsp;<span class="op" id="4270544">*</span><span class="ident" id="4270545">Part</span><span class="op" id="4270549">)</span>&nbsp;<span class="ident" id="4270551">parseContentDisposition</span><span class="op" id="4270574">(</span><span class="op" id="4270575">)</span>&nbsp;<span class="op" id="4270577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270580">v</span>&nbsp;<span class="op" id="4270582">:=</span>&nbsp;<span class="ident" id="4270585">p</span><span class="op" id="4270586">.</span><span class="ident" id="4270587">Header</span><span class="op" id="4270593">.</span><span class="ident" id="4270594">Get</span><span class="op" id="4270597">(</span><span class="string" id="4270598">&#34;Content-Disposition&#34;</span><span class="op" id="4270619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270622">var</span>&nbsp;<span class="ident" id="4270626">err</span>&nbsp;<span class="builtintype" id="4270630">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270637">p</span><span class="op" id="4270638">.</span><span class="ident" id="4270639">disposition</span><span class="op" id="4270650">,</span>&nbsp;<span class="ident" id="4270652">p</span><span class="op" id="4270653">.</span><span class="ident" id="4270654">dispositionParams</span><span class="op" id="4270671">,</span>&nbsp;<span class="ident" id="4270673">err</span>&nbsp;<span class="op" id="4270677">=</span>&nbsp;<span class="ident" id="4270679">mime</span><span class="op" id="4270683">.</span><span class="ident" id="4270684">ParseMediaType</span><span class="op" id="4270698">(</span><span class="ident" id="4270699">v</span><span class="op" id="4270700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270703">if</span>&nbsp;<span class="ident" id="4270706">err</span>&nbsp;<span class="op" id="4270710">!=</span>&nbsp;<span class="builtintype" id="4270713">nil</span>&nbsp;<span class="op" id="4270717">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270721">p</span><span class="op" id="4270722">.</span><span class="ident" id="4270723">dispositionParams</span>&nbsp;<span class="op" id="4270741">=</span>&nbsp;<span class="ident" id="4270743">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270756">}</span><br>
<span class="lineno"></span><span class="op" id="4270758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4270761">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="4270830">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="4270854">//</span><br>
<span class="lineno"></span><span class="comment" id="4270857">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4270926">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4270993">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="4271016">func</span>&nbsp;<span class="ident" id="4271021">NewReader</span><span class="op" id="4271030">(</span><span class="ident" id="4271031">r</span>&nbsp;<span class="ident" id="4271033">io</span><span class="op" id="4271035">.</span><span class="ident" id="4271036">Reader</span><span class="op" id="4271042">,</span>&nbsp;<span class="ident" id="4271044">boundary</span>&nbsp;<span class="builtintype" id="4271053">string</span><span class="op" id="4271059">)</span>&nbsp;<span class="op" id="4271061">*</span><span class="ident" id="4271062">Reader</span>&nbsp;<span class="op" id="4271069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271072">b</span>&nbsp;<span class="op" id="4271074">:=</span>&nbsp;<span class="op" id="4271077">[</span><span class="op" id="4271078">]</span><span class="builtintype" id="4271079">byte</span><span class="op" id="4271083">(</span><span class="string" id="4271084">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="4271093">+</span>&nbsp;<span class="ident" id="4271095">boundary</span>&nbsp;<span class="op" id="4271104">+</span>&nbsp;<span class="string" id="4271106">&#34;--&#34;</span><span class="op" id="4271110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271113">return</span>&nbsp;<span class="op" id="4271120">&amp;</span><span class="ident" id="4271121">Reader</span><span class="op" id="4271127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271131">bufReader</span><span class="op" id="4271140">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271149">bufio</span><span class="op" id="4271154">.</span><span class="ident" id="4271155">NewReader</span><span class="op" id="4271164">(</span><span class="ident" id="4271165">r</span><span class="op" id="4271166">)</span><span class="op" id="4271167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271171">nl</span><span class="op" id="4271173">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271189">b</span><span class="op" id="4271190">[</span><span class="op" id="4271191">:</span><span class="num" id="4271192">2</span><span class="op" id="4271193">]</span><span class="op" id="4271194">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271198">nlDashBoundary</span><span class="op" id="4271212">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4271216">b</span><span class="op" id="4271217">[</span><span class="op" id="4271218">:</span><span class="builtinfunc" id="4271219">len</span><span class="op" id="4271222">(</span><span class="ident" id="4271223">b</span><span class="op" id="4271224">)</span><span class="op" id="4271225">-</span><span class="num" id="4271226">2</span><span class="op" id="4271227">]</span><span class="op" id="4271228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271232">dashBoundaryDash</span><span class="op" id="4271248">:</span>&nbsp;<span class="ident" id="4271250">b</span><span class="op" id="4271251">[</span><span class="num" id="4271252">2</span><span class="op" id="4271253">:</span><span class="op" id="4271254">]</span><span class="op" id="4271255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271259">dashBoundary</span><span class="op" id="4271271">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271277">b</span><span class="op" id="4271278">[</span><span class="num" id="4271279">2</span>&nbsp;<span class="op" id="4271281">:</span>&nbsp;<span class="builtinfunc" id="4271283">len</span><span class="op" id="4271286">(</span><span class="ident" id="4271287">b</span><span class="op" id="4271288">)</span><span class="op" id="4271289">-</span><span class="num" id="4271290">2</span><span class="op" id="4271291">]</span><span class="op" id="4271292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271295">}</span><br>
<span class="lineno"></span><span class="op" id="4271297">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="4271300">func</span>&nbsp;<span class="ident" id="4271305">newPart</span><span class="op" id="4271312">(</span><span class="ident" id="4271313">mr</span>&nbsp;<span class="op" id="4271316">*</span><span class="ident" id="4271317">Reader</span><span class="op" id="4271323">)</span>&nbsp;<span class="op" id="4271325">(</span><span class="op" id="4271326">*</span><span class="ident" id="4271327">Part</span><span class="op" id="4271331">,</span>&nbsp;<span class="builtintype" id="4271333">error</span><span class="op" id="4271338">)</span>&nbsp;<span class="op" id="4271340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271343">bp</span>&nbsp;<span class="op" id="4271346">:=</span>&nbsp;<span class="op" id="4271349">&amp;</span><span class="ident" id="4271350">Part</span><span class="op" id="4271354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271358">Header</span><span class="op" id="4271364">:</span>&nbsp;<span class="builtinfunc" id="4271366">make</span><span class="op" id="4271370">(</span><span class="keyword" id="4271371">map</span><span class="op" id="4271374">[</span><span class="builtintype" id="4271375">string</span><span class="op" id="4271381">]</span><span class="op" id="4271382">[</span><span class="op" id="4271383">]</span><span class="builtintype" id="4271384">string</span><span class="op" id="4271390">)</span><span class="op" id="4271391">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271395">mr</span><span class="op" id="4271397">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271403">mr</span><span class="op" id="4271405">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271409">buffer</span><span class="op" id="4271415">:</span>&nbsp;<span class="builtinfunc" id="4271417">new</span><span class="op" id="4271420">(</span><span class="ident" id="4271421">bytes</span><span class="op" id="4271426">.</span><span class="ident" id="4271427">Buffer</span><span class="op" id="4271433">)</span><span class="op" id="4271434">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271440">if</span>&nbsp;<span class="ident" id="4271443">err</span>&nbsp;<span class="op" id="4271447">:=</span>&nbsp;<span class="ident" id="4271450">bp</span><span class="op" id="4271452">.</span><span class="ident" id="4271453">populateHeaders</span><span class="op" id="4271468">(</span><span class="op" id="4271469">)</span><span class="op" id="4271470">;</span>&nbsp;<span class="ident" id="4271472">err</span>&nbsp;<span class="op" id="4271476">!=</span>&nbsp;<span class="builtintype" id="4271479">nil</span>&nbsp;<span class="op" id="4271483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271487">return</span>&nbsp;<span class="builtintype" id="4271494">nil</span><span class="op" id="4271497">,</span>&nbsp;<span class="ident" id="4271499">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271504">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271507">bp</span><span class="op" id="4271509">.</span><span class="ident" id="4271510">r</span>&nbsp;<span class="op" id="4271512">=</span>&nbsp;<span class="ident" id="4271514">partReader</span><span class="op" id="4271524">{</span><span class="ident" id="4271525">bp</span><span class="op" id="4271527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271530">const</span>&nbsp;<span class="ident" id="4271536">cte</span>&nbsp;<span class="op" id="4271540">=</span>&nbsp;<span class="string" id="4271542">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271571">if</span>&nbsp;<span class="ident" id="4271574">bp</span><span class="op" id="4271576">.</span><span class="ident" id="4271577">Header</span><span class="op" id="4271583">.</span><span class="ident" id="4271584">Get</span><span class="op" id="4271587">(</span><span class="ident" id="4271588">cte</span><span class="op" id="4271591">)</span>&nbsp;<span class="op" id="4271593">==</span>&nbsp;<span class="string" id="4271596">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="4271615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271619">bp</span><span class="op" id="4271621">.</span><span class="ident" id="4271622">Header</span><span class="op" id="4271628">.</span><span class="ident" id="4271629">Del</span><span class="op" id="4271632">(</span><span class="ident" id="4271633">cte</span><span class="op" id="4271636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271640">bp</span><span class="op" id="4271642">.</span><span class="ident" id="4271643">r</span>&nbsp;<span class="op" id="4271645">=</span>&nbsp;<span class="ident" id="4271647">newQuotedPrintableReader</span><span class="op" id="4271671">(</span><span class="ident" id="4271672">bp</span><span class="op" id="4271674">.</span><span class="ident" id="4271675">r</span><span class="op" id="4271676">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271682">return</span>&nbsp;<span class="ident" id="4271689">bp</span><span class="op" id="4271691">,</span>&nbsp;<span class="builtintype" id="4271693">nil</span><br>
<span class="lineno"></span><span class="op" id="4271697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4271700">func</span>&nbsp;<span class="op" id="4271705">(</span><span class="ident" id="4271706">bp</span>&nbsp;<span class="op" id="4271709">*</span><span class="ident" id="4271710">Part</span><span class="op" id="4271714">)</span>&nbsp;<span class="ident" id="4271716">populateHeaders</span><span class="op" id="4271731">(</span><span class="op" id="4271732">)</span>&nbsp;<span class="builtintype" id="4271734">error</span>&nbsp;<span class="op" id="4271740">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271743">r</span>&nbsp;<span class="op" id="4271745">:=</span>&nbsp;<span class="ident" id="4271748">textproto</span><span class="op" id="4271757">.</span><span class="ident" id="4271758">NewReader</span><span class="op" id="4271767">(</span><span class="ident" id="4271768">bp</span><span class="op" id="4271770">.</span><span class="ident" id="4271771">mr</span><span class="op" id="4271773">.</span><span class="ident" id="4271774">bufReader</span><span class="op" id="4271783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271786">header</span><span class="op" id="4271792">,</span>&nbsp;<span class="ident" id="4271794">err</span>&nbsp;<span class="op" id="4271798">:=</span>&nbsp;<span class="ident" id="4271801">r</span><span class="op" id="4271802">.</span><span class="ident" id="4271803">ReadMIMEHeader</span><span class="op" id="4271817">(</span><span class="op" id="4271818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271821">if</span>&nbsp;<span class="ident" id="4271824">err</span>&nbsp;<span class="op" id="4271828">==</span>&nbsp;<span class="builtintype" id="4271831">nil</span>&nbsp;<span class="op" id="4271835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271839">bp</span><span class="op" id="4271841">.</span><span class="ident" id="4271842">Header</span>&nbsp;<span class="op" id="4271849">=</span>&nbsp;<span class="ident" id="4271851">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271859">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271862">return</span>&nbsp;<span class="ident" id="4271869">err</span><br>
<span class="lineno"></span><span class="op" id="4271873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4271876">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4271943">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="4271973">func</span>&nbsp;<span class="op" id="4271978">(</span><span class="ident" id="4271979">p</span>&nbsp;<span class="op" id="4271981">*</span><span class="ident" id="4271982">Part</span><span class="op" id="4271986">)</span>&nbsp;<span class="ident" id="4271988">Read</span><span class="op" id="4271992">(</span><span class="ident" id="4271993">d</span>&nbsp;<span class="op" id="4271995">[</span><span class="op" id="4271996">]</span><span class="builtintype" id="4271997">byte</span><span class="op" id="4272001">)</span>&nbsp;<span class="op" id="4272003">(</span><span class="ident" id="4272004">n</span>&nbsp;<span class="builtintype" id="4272006">int</span><span class="op" id="4272009">,</span>&nbsp;<span class="ident" id="4272011">err</span>&nbsp;<span class="builtintype" id="4272015">error</span><span class="op" id="4272020">)</span>&nbsp;<span class="op" id="4272022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272025">return</span>&nbsp;<span class="ident" id="4272032">p</span><span class="op" id="4272033">.</span><span class="ident" id="4272034">r</span><span class="op" id="4272035">.</span><span class="ident" id="4272036">Read</span><span class="op" id="4272040">(</span><span class="ident" id="4272041">d</span><span class="op" id="4272042">)</span><br>
<span class="lineno"></span><span class="op" id="4272044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4272047">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="4272121">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="4272185">type</span>&nbsp;<span class="ident" id="4272190">partReader</span>&nbsp;<span class="keyword" id="4272201">struct</span>&nbsp;<span class="op" id="4272208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272211">p</span>&nbsp;<span class="op" id="4272213">*</span><span class="ident" id="4272214">Part</span><br>
<span class="lineno"></span><span class="op" id="4272219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="4272222">func</span>&nbsp;<span class="op" id="4272227">(</span><span class="ident" id="4272228">pr</span>&nbsp;<span class="ident" id="4272231">partReader</span><span class="op" id="4272241">)</span>&nbsp;<span class="ident" id="4272243">Read</span><span class="op" id="4272247">(</span><span class="ident" id="4272248">d</span>&nbsp;<span class="op" id="4272250">[</span><span class="op" id="4272251">]</span><span class="builtintype" id="4272252">byte</span><span class="op" id="4272256">)</span>&nbsp;<span class="op" id="4272258">(</span><span class="ident" id="4272259">n</span>&nbsp;<span class="builtintype" id="4272261">int</span><span class="op" id="4272264">,</span>&nbsp;<span class="ident" id="4272266">err</span>&nbsp;<span class="builtintype" id="4272270">error</span><span class="op" id="4272275">)</span>&nbsp;<span class="op" id="4272277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272280">p</span>&nbsp;<span class="op" id="4272282">:=</span>&nbsp;<span class="ident" id="4272285">pr</span><span class="op" id="4272287">.</span><span class="ident" id="4272288">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272291">defer</span>&nbsp;<span class="keyword" id="4272297">func</span><span class="op" id="4272301">(</span><span class="op" id="4272302">)</span>&nbsp;<span class="op" id="4272304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272308">p</span><span class="op" id="4272309">.</span><span class="ident" id="4272310">bytesRead</span>&nbsp;<span class="op" id="4272320">+=</span>&nbsp;<span class="ident" id="4272323">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272326">}</span><span class="op" id="4272327">(</span><span class="op" id="4272328">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272331">if</span>&nbsp;<span class="ident" id="4272334">p</span><span class="op" id="4272335">.</span><span class="ident" id="4272336">buffer</span><span class="op" id="4272342">.</span><span class="ident" id="4272343">Len</span><span class="op" id="4272346">(</span><span class="op" id="4272347">)</span>&nbsp;<span class="op" id="4272349">&gt;=</span>&nbsp;<span class="builtinfunc" id="4272352">len</span><span class="op" id="4272355">(</span><span class="ident" id="4272356">d</span><span class="op" id="4272357">)</span>&nbsp;<span class="op" id="4272359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272363">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272423">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272484">return</span>&nbsp;<span class="ident" id="4272491">p</span><span class="op" id="4272492">.</span><span class="ident" id="4272493">buffer</span><span class="op" id="4272499">.</span><span class="ident" id="4272500">Read</span><span class="op" id="4272504">(</span><span class="ident" id="4272505">d</span><span class="op" id="4272506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272509">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272512">peek</span><span class="op" id="4272516">,</span>&nbsp;<span class="ident" id="4272518">err</span>&nbsp;<span class="op" id="4272522">:=</span>&nbsp;<span class="ident" id="4272525">p</span><span class="op" id="4272526">.</span><span class="ident" id="4272527">mr</span><span class="op" id="4272529">.</span><span class="ident" id="4272530">bufReader</span><span class="op" id="4272539">.</span><span class="ident" id="4272540">Peek</span><span class="op" id="4272544">(</span><span class="num" id="4272545">4096</span><span class="op" id="4272549">)</span>&nbsp;<span class="comment" id="4272551">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272597">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272657">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272720">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272780">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272840">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272865">if</span>&nbsp;<span class="ident" id="4272868">p</span><span class="op" id="4272869">.</span><span class="ident" id="4272870">bytesRead</span>&nbsp;<span class="op" id="4272880">==</span>&nbsp;<span class="num" id="4272883">0</span>&nbsp;<span class="op" id="4272885">&amp;&amp;</span>&nbsp;<span class="ident" id="4272888">p</span><span class="op" id="4272889">.</span><span class="ident" id="4272890">mr</span><span class="op" id="4272892">.</span><span class="ident" id="4272893">peekBufferIsEmptyPart</span><span class="op" id="4272914">(</span><span class="ident" id="4272915">peek</span><span class="op" id="4272919">)</span>&nbsp;<span class="op" id="4272921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272925">return</span>&nbsp;<span class="num" id="4272932">0</span><span class="op" id="4272933">,</span>&nbsp;<span class="ident" id="4272935">io</span><span class="op" id="4272937">.</span><span class="ident" id="4272938">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272943">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272946">unexpectedEOF</span>&nbsp;<span class="op" id="4272960">:=</span>&nbsp;<span class="ident" id="4272963">err</span>&nbsp;<span class="op" id="4272967">==</span>&nbsp;<span class="ident" id="4272970">io</span><span class="op" id="4272972">.</span><span class="ident" id="4272973">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272978">if</span>&nbsp;<span class="ident" id="4272981">err</span>&nbsp;<span class="op" id="4272985">!=</span>&nbsp;<span class="builtintype" id="4272988">nil</span>&nbsp;<span class="op" id="4272992">&amp;&amp;</span>&nbsp;<span class="op" id="4272995">!</span><span class="ident" id="4272996">unexpectedEOF</span>&nbsp;<span class="op" id="4273010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273014">return</span>&nbsp;<span class="num" id="4273021">0</span><span class="op" id="4273022">,</span>&nbsp;<span class="ident" id="4273024">fmt</span><span class="op" id="4273027">.</span><span class="ident" id="4273028">Errorf</span><span class="op" id="4273034">(</span><span class="string" id="4273035">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="4273061">,</span>&nbsp;<span class="ident" id="4273063">err</span><span class="op" id="4273066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273072">if</span>&nbsp;<span class="ident" id="4273075">peek</span>&nbsp;<span class="op" id="4273080">==</span>&nbsp;<span class="builtintype" id="4273083">nil</span>&nbsp;<span class="op" id="4273087">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4273091">panic</span><span class="op" id="4273096">(</span><span class="string" id="4273097">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="4273111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273118">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273177">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273241">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273300">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273312">nCopy</span>&nbsp;<span class="op" id="4273318">:=</span>&nbsp;<span class="num" id="4273321">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273324">foundBoundary</span>&nbsp;<span class="op" id="4273338">:=</span>&nbsp;<span class="builtintype" id="4273341">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273348">if</span>&nbsp;<span class="ident" id="4273351">idx</span>&nbsp;<span class="op" id="4273355">:=</span>&nbsp;<span class="ident" id="4273358">bytes</span><span class="op" id="4273363">.</span><span class="ident" id="4273364">Index</span><span class="op" id="4273369">(</span><span class="ident" id="4273370">peek</span><span class="op" id="4273374">,</span>&nbsp;<span class="ident" id="4273376">p</span><span class="op" id="4273377">.</span><span class="ident" id="4273378">mr</span><span class="op" id="4273380">.</span><span class="ident" id="4273381">nlDashBoundary</span><span class="op" id="4273395">)</span><span class="op" id="4273396">;</span>&nbsp;<span class="ident" id="4273398">idx</span>&nbsp;<span class="op" id="4273402">!=</span>&nbsp;<span class="op" id="4273405">-</span><span class="num" id="4273406">1</span>&nbsp;<span class="op" id="4273408">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273412">nCopy</span>&nbsp;<span class="op" id="4273418">=</span>&nbsp;<span class="ident" id="4273420">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273426">foundBoundary</span>&nbsp;<span class="op" id="4273440">=</span>&nbsp;<span class="builtintype" id="4273442">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273448">}</span>&nbsp;<span class="keyword" id="4273450">else</span>&nbsp;<span class="keyword" id="4273455">if</span>&nbsp;<span class="ident" id="4273458">safeCount</span>&nbsp;<span class="op" id="4273468">:=</span>&nbsp;<span class="builtinfunc" id="4273471">len</span><span class="op" id="4273474">(</span><span class="ident" id="4273475">peek</span><span class="op" id="4273479">)</span>&nbsp;<span class="op" id="4273481">-</span>&nbsp;<span class="builtinfunc" id="4273483">len</span><span class="op" id="4273486">(</span><span class="ident" id="4273487">p</span><span class="op" id="4273488">.</span><span class="ident" id="4273489">mr</span><span class="op" id="4273491">.</span><span class="ident" id="4273492">nlDashBoundary</span><span class="op" id="4273506">)</span><span class="op" id="4273507">;</span>&nbsp;<span class="ident" id="4273509">safeCount</span>&nbsp;<span class="op" id="4273519">&gt;</span>&nbsp;<span class="num" id="4273521">0</span>&nbsp;<span class="op" id="4273523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273527">nCopy</span>&nbsp;<span class="op" id="4273533">=</span>&nbsp;<span class="ident" id="4273535">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273546">}</span>&nbsp;<span class="keyword" id="4273548">else</span>&nbsp;<span class="keyword" id="4273553">if</span>&nbsp;<span class="ident" id="4273556">unexpectedEOF</span>&nbsp;<span class="op" id="4273570">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273574">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273628">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273685">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273728">return</span>&nbsp;<span class="num" id="4273735">0</span><span class="op" id="4273736">,</span>&nbsp;<span class="ident" id="4273738">io</span><span class="op" id="4273740">.</span><span class="ident" id="4273741">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273759">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273762">if</span>&nbsp;<span class="ident" id="4273765">nCopy</span>&nbsp;<span class="op" id="4273771">&gt;</span>&nbsp;<span class="num" id="4273773">0</span>&nbsp;<span class="op" id="4273775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273779">if</span>&nbsp;<span class="ident" id="4273782">_</span><span class="op" id="4273783">,</span>&nbsp;<span class="ident" id="4273785">err</span>&nbsp;<span class="op" id="4273789">:=</span>&nbsp;<span class="ident" id="4273792">io</span><span class="op" id="4273794">.</span><span class="ident" id="4273795">CopyN</span><span class="op" id="4273800">(</span><span class="ident" id="4273801">p</span><span class="op" id="4273802">.</span><span class="ident" id="4273803">buffer</span><span class="op" id="4273809">,</span>&nbsp;<span class="ident" id="4273811">p</span><span class="op" id="4273812">.</span><span class="ident" id="4273813">mr</span><span class="op" id="4273815">.</span><span class="ident" id="4273816">bufReader</span><span class="op" id="4273825">,</span>&nbsp;<span class="ident" id="4273827">int64</span><span class="op" id="4273832">(</span><span class="ident" id="4273833">nCopy</span><span class="op" id="4273838">)</span><span class="op" id="4273839">)</span><span class="op" id="4273840">;</span>&nbsp;<span class="ident" id="4273842">err</span>&nbsp;<span class="op" id="4273846">!=</span>&nbsp;<span class="builtintype" id="4273849">nil</span>&nbsp;<span class="op" id="4273853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273858">return</span>&nbsp;<span class="num" id="4273865">0</span><span class="op" id="4273866">,</span>&nbsp;<span class="ident" id="4273868">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273877">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273880">n</span><span class="op" id="4273881">,</span>&nbsp;<span class="ident" id="4273883">err</span>&nbsp;<span class="op" id="4273887">=</span>&nbsp;<span class="ident" id="4273889">p</span><span class="op" id="4273890">.</span><span class="ident" id="4273891">buffer</span><span class="op" id="4273897">.</span><span class="ident" id="4273898">Read</span><span class="op" id="4273902">(</span><span class="ident" id="4273903">d</span><span class="op" id="4273904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273907">if</span>&nbsp;<span class="ident" id="4273910">err</span>&nbsp;<span class="op" id="4273914">==</span>&nbsp;<span class="ident" id="4273917">io</span><span class="op" id="4273919">.</span><span class="ident" id="4273920">EOF</span>&nbsp;<span class="op" id="4273924">&amp;&amp;</span>&nbsp;<span class="op" id="4273927">!</span><span class="ident" id="4273928">foundBoundary</span>&nbsp;<span class="op" id="4273942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273946">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4274003">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274059">err</span>&nbsp;<span class="op" id="4274063">=</span>&nbsp;<span class="builtintype" id="4274065">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274073">return</span><br>
<span class="lineno"></span><span class="op" id="4274080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4274083">func</span>&nbsp;<span class="op" id="4274088">(</span><span class="ident" id="4274089">p</span>&nbsp;<span class="op" id="4274091">*</span><span class="ident" id="4274092">Part</span><span class="op" id="4274096">)</span>&nbsp;<span class="ident" id="4274098">Close</span><span class="op" id="4274103">(</span><span class="op" id="4274104">)</span>&nbsp;<span class="builtintype" id="4274106">error</span>&nbsp;<span class="op" id="4274112">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274115">io</span><span class="op" id="4274117">.</span><span class="ident" id="4274118">Copy</span><span class="op" id="4274122">(</span><span class="ident" id="4274123">ioutil</span><span class="op" id="4274129">.</span><span class="ident" id="4274130">Discard</span><span class="op" id="4274137">,</span>&nbsp;<span class="ident" id="4274139">p</span><span class="op" id="4274140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274143">return</span>&nbsp;<span class="builtintype" id="4274150">nil</span><br>
<span class="lineno"></span><span class="op" id="4274154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4274157">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="4274219">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="4274288">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="4274308">type</span>&nbsp;<span class="ident" id="4274313">Reader</span>&nbsp;<span class="keyword" id="4274320">struct</span>&nbsp;<span class="op" id="4274327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274330">bufReader</span>&nbsp;<span class="op" id="4274340">*</span><span class="ident" id="4274341">bufio</span><span class="op" id="4274346">.</span><span class="ident" id="4274347">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274356">currentPart</span>&nbsp;<span class="op" id="4274368">*</span><span class="ident" id="4274369">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274375">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4274387">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274393">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274410">[</span><span class="op" id="4274411">]</span><span class="builtintype" id="4274412">byte</span>&nbsp;<span class="comment" id="4274417">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274475">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4274492">[</span><span class="op" id="4274493">]</span><span class="builtintype" id="4274494">byte</span>&nbsp;<span class="comment" id="4274499">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274521">dashBoundaryDash</span>&nbsp;<span class="op" id="4274538">[</span><span class="op" id="4274539">]</span><span class="builtintype" id="4274540">byte</span>&nbsp;<span class="comment" id="4274545">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274564">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274581">[</span><span class="op" id="4274582">]</span><span class="builtintype" id="4274583">byte</span>&nbsp;<span class="comment" id="4274588">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="4274604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4274607">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="4274671">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4274734">func</span>&nbsp;<span class="op" id="4274739">(</span><span class="ident" id="4274740">r</span>&nbsp;<span class="op" id="4274742">*</span><span class="ident" id="4274743">Reader</span><span class="op" id="4274749">)</span>&nbsp;<span class="ident" id="4274751">NextPart</span><span class="op" id="4274759">(</span><span class="op" id="4274760">)</span>&nbsp;<span class="op" id="4274762">(</span><span class="op" id="4274763">*</span><span class="ident" id="4274764">Part</span><span class="op" id="4274768">,</span>&nbsp;<span class="builtintype" id="4274770">error</span><span class="op" id="4274775">)</span>&nbsp;<span class="op" id="4274777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274780">if</span>&nbsp;<span class="ident" id="4274783">r</span><span class="op" id="4274784">.</span><span class="ident" id="4274785">currentPart</span>&nbsp;<span class="op" id="4274797">!=</span>&nbsp;<span class="builtintype" id="4274800">nil</span>&nbsp;<span class="op" id="4274804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274808">r</span><span class="op" id="4274809">.</span><span class="ident" id="4274810">currentPart</span><span class="op" id="4274821">.</span><span class="ident" id="4274822">Close</span><span class="op" id="4274827">(</span><span class="op" id="4274828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274831">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274835">expectNewPart</span>&nbsp;<span class="op" id="4274849">:=</span>&nbsp;<span class="builtintype" id="4274852">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274859">for</span>&nbsp;<span class="op" id="4274863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274867">line</span><span class="op" id="4274871">,</span>&nbsp;<span class="ident" id="4274873">err</span>&nbsp;<span class="op" id="4274877">:=</span>&nbsp;<span class="ident" id="4274880">r</span><span class="op" id="4274881">.</span><span class="ident" id="4274882">bufReader</span><span class="op" id="4274891">.</span><span class="ident" id="4274892">ReadSlice</span><span class="op" id="4274901">(</span><span class="string" id="4274902">&#39;\n&#39;</span><span class="op" id="4274906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274910">if</span>&nbsp;<span class="ident" id="4274913">err</span>&nbsp;<span class="op" id="4274917">==</span>&nbsp;<span class="ident" id="4274920">io</span><span class="op" id="4274922">.</span><span class="ident" id="4274923">EOF</span>&nbsp;<span class="op" id="4274927">&amp;&amp;</span>&nbsp;<span class="ident" id="4274930">r</span><span class="op" id="4274931">.</span><span class="ident" id="4274932">isFinalBoundary</span><span class="op" id="4274947">(</span><span class="ident" id="4274948">line</span><span class="op" id="4274952">)</span>&nbsp;<span class="op" id="4274954">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4274959">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275014">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275068">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275125">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275184">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275209">return</span>&nbsp;<span class="builtintype" id="4275216">nil</span><span class="op" id="4275219">,</span>&nbsp;<span class="ident" id="4275221">io</span><span class="op" id="4275223">.</span><span class="ident" id="4275224">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275234">if</span>&nbsp;<span class="ident" id="4275237">err</span>&nbsp;<span class="op" id="4275241">!=</span>&nbsp;<span class="builtintype" id="4275244">nil</span>&nbsp;<span class="op" id="4275248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275253">return</span>&nbsp;<span class="builtintype" id="4275260">nil</span><span class="op" id="4275263">,</span>&nbsp;<span class="ident" id="4275265">fmt</span><span class="op" id="4275268">.</span><span class="ident" id="4275269">Errorf</span><span class="op" id="4275275">(</span><span class="string" id="4275276">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="4275301">,</span>&nbsp;<span class="ident" id="4275303">err</span><span class="op" id="4275306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275310">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275315">if</span>&nbsp;<span class="ident" id="4275318">r</span><span class="op" id="4275319">.</span><span class="ident" id="4275320">isBoundaryDelimiterLine</span><span class="op" id="4275343">(</span><span class="ident" id="4275344">line</span><span class="op" id="4275348">)</span>&nbsp;<span class="op" id="4275350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275355">r</span><span class="op" id="4275356">.</span><span class="ident" id="4275357">partsRead</span><span class="op" id="4275366">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275372">bp</span><span class="op" id="4275374">,</span>&nbsp;<span class="ident" id="4275376">err</span>&nbsp;<span class="op" id="4275380">:=</span>&nbsp;<span class="ident" id="4275383">newPart</span><span class="op" id="4275390">(</span><span class="ident" id="4275391">r</span><span class="op" id="4275392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275397">if</span>&nbsp;<span class="ident" id="4275400">err</span>&nbsp;<span class="op" id="4275404">!=</span>&nbsp;<span class="builtintype" id="4275407">nil</span>&nbsp;<span class="op" id="4275411">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275417">return</span>&nbsp;<span class="builtintype" id="4275424">nil</span><span class="op" id="4275427">,</span>&nbsp;<span class="ident" id="4275429">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275441">r</span><span class="op" id="4275442">.</span><span class="ident" id="4275443">currentPart</span>&nbsp;<span class="op" id="4275455">=</span>&nbsp;<span class="ident" id="4275457">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275463">return</span>&nbsp;<span class="ident" id="4275470">bp</span><span class="op" id="4275472">,</span>&nbsp;<span class="builtintype" id="4275474">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275480">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275485">if</span>&nbsp;<span class="ident" id="4275488">r</span><span class="op" id="4275489">.</span><span class="ident" id="4275490">isFinalBoundary</span><span class="op" id="4275505">(</span><span class="ident" id="4275506">line</span><span class="op" id="4275510">)</span>&nbsp;<span class="op" id="4275512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275517">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275536">return</span>&nbsp;<span class="builtintype" id="4275543">nil</span><span class="op" id="4275546">,</span>&nbsp;<span class="ident" id="4275548">io</span><span class="op" id="4275550">.</span><span class="ident" id="4275551">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275557">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275562">if</span>&nbsp;<span class="ident" id="4275565">expectNewPart</span>&nbsp;<span class="op" id="4275579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275584">return</span>&nbsp;<span class="builtintype" id="4275591">nil</span><span class="op" id="4275594">,</span>&nbsp;<span class="ident" id="4275596">fmt</span><span class="op" id="4275599">.</span><span class="ident" id="4275600">Errorf</span><span class="op" id="4275606">(</span><span class="string" id="4275607">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="4275653">,</span>&nbsp;<span class="builtintype" id="4275655">string</span><span class="op" id="4275661">(</span><span class="ident" id="4275662">line</span><span class="op" id="4275666">)</span><span class="op" id="4275667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275676">if</span>&nbsp;<span class="ident" id="4275679">r</span><span class="op" id="4275680">.</span><span class="ident" id="4275681">partsRead</span>&nbsp;<span class="op" id="4275691">==</span>&nbsp;<span class="num" id="4275694">0</span>&nbsp;<span class="op" id="4275696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275701">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275717">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275733">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275787">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275843">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275898">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275917">if</span>&nbsp;<span class="ident" id="4275920">bytes</span><span class="op" id="4275925">.</span><span class="ident" id="4275926">Equal</span><span class="op" id="4275931">(</span><span class="ident" id="4275932">line</span><span class="op" id="4275936">,</span>&nbsp;<span class="ident" id="4275938">r</span><span class="op" id="4275939">.</span><span class="ident" id="4275940">nl</span><span class="op" id="4275942">)</span>&nbsp;<span class="op" id="4275944">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275949">expectNewPart</span>&nbsp;<span class="op" id="4275963">=</span>&nbsp;<span class="builtintype" id="4275965">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275973">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275989">return</span>&nbsp;<span class="builtintype" id="4275996">nil</span><span class="op" id="4275999">,</span>&nbsp;<span class="ident" id="4276001">fmt</span><span class="op" id="4276004">.</span><span class="ident" id="4276005">Errorf</span><span class="op" id="4276011">(</span><span class="string" id="4276012">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="4276054">,</span>&nbsp;<span class="ident" id="4276056">line</span><span class="op" id="4276060">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276063">}</span><br>
<span class="lineno"></span><span class="op" id="4276065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4276068">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4276135">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="4276174">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="4276218">func</span>&nbsp;<span class="op" id="4276223">(</span><span class="ident" id="4276224">mr</span>&nbsp;<span class="op" id="4276227">*</span><span class="ident" id="4276228">Reader</span><span class="op" id="4276234">)</span>&nbsp;<span class="ident" id="4276236">isFinalBoundary</span><span class="op" id="4276251">(</span><span class="ident" id="4276252">line</span>&nbsp;<span class="op" id="4276257">[</span><span class="op" id="4276258">]</span><span class="builtintype" id="4276259">byte</span><span class="op" id="4276263">)</span>&nbsp;<span class="builtintype" id="4276265">bool</span>&nbsp;<span class="op" id="4276270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276273">if</span>&nbsp;<span class="op" id="4276276">!</span><span class="ident" id="4276277">bytes</span><span class="op" id="4276282">.</span><span class="ident" id="4276283">HasPrefix</span><span class="op" id="4276292">(</span><span class="ident" id="4276293">line</span><span class="op" id="4276297">,</span>&nbsp;<span class="ident" id="4276299">mr</span><span class="op" id="4276301">.</span><span class="ident" id="4276302">dashBoundaryDash</span><span class="op" id="4276318">)</span>&nbsp;<span class="op" id="4276320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276324">return</span>&nbsp;<span class="builtintype" id="4276331">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276338">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276341">rest</span>&nbsp;<span class="op" id="4276346">:=</span>&nbsp;<span class="ident" id="4276349">line</span><span class="op" id="4276353">[</span><span class="builtinfunc" id="4276354">len</span><span class="op" id="4276357">(</span><span class="ident" id="4276358">mr</span><span class="op" id="4276360">.</span><span class="ident" id="4276361">dashBoundaryDash</span><span class="op" id="4276377">)</span><span class="op" id="4276378">:</span><span class="op" id="4276379">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276382">rest</span>&nbsp;<span class="op" id="4276387">=</span>&nbsp;<span class="ident" id="4276389">skipLWSPChar</span><span class="op" id="4276401">(</span><span class="ident" id="4276402">rest</span><span class="op" id="4276406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276409">return</span>&nbsp;<span class="builtinfunc" id="4276416">len</span><span class="op" id="4276419">(</span><span class="ident" id="4276420">rest</span><span class="op" id="4276424">)</span>&nbsp;<span class="op" id="4276426">==</span>&nbsp;<span class="num" id="4276429">0</span>&nbsp;<span class="op" id="4276431">||</span>&nbsp;<span class="ident" id="4276434">bytes</span><span class="op" id="4276439">.</span><span class="ident" id="4276440">Equal</span><span class="op" id="4276445">(</span><span class="ident" id="4276446">rest</span><span class="op" id="4276450">,</span>&nbsp;<span class="ident" id="4276452">mr</span><span class="op" id="4276454">.</span><span class="ident" id="4276455">nl</span><span class="op" id="4276457">)</span><br>
<span class="lineno"></span><span class="op" id="4276459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="4276462">func</span>&nbsp;<span class="op" id="4276467">(</span><span class="ident" id="4276468">mr</span>&nbsp;<span class="op" id="4276471">*</span><span class="ident" id="4276472">Reader</span><span class="op" id="4276478">)</span>&nbsp;<span class="ident" id="4276480">isBoundaryDelimiterLine</span><span class="op" id="4276503">(</span><span class="ident" id="4276504">line</span>&nbsp;<span class="op" id="4276509">[</span><span class="op" id="4276510">]</span><span class="builtintype" id="4276511">byte</span><span class="op" id="4276515">)</span>&nbsp;<span class="op" id="4276517">(</span><span class="ident" id="4276518">ret</span>&nbsp;<span class="builtintype" id="4276522">bool</span><span class="op" id="4276526">)</span>&nbsp;<span class="op" id="4276528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276531">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276582">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276642">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276699">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276758">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276822">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276864">if</span>&nbsp;<span class="op" id="4276867">!</span><span class="ident" id="4276868">bytes</span><span class="op" id="4276873">.</span><span class="ident" id="4276874">HasPrefix</span><span class="op" id="4276883">(</span><span class="ident" id="4276884">line</span><span class="op" id="4276888">,</span>&nbsp;<span class="ident" id="4276890">mr</span><span class="op" id="4276892">.</span><span class="ident" id="4276893">dashBoundary</span><span class="op" id="4276905">)</span>&nbsp;<span class="op" id="4276907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276911">return</span>&nbsp;<span class="builtintype" id="4276918">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276925">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276928">rest</span>&nbsp;<span class="op" id="4276933">:=</span>&nbsp;<span class="ident" id="4276936">line</span><span class="op" id="4276940">[</span><span class="builtinfunc" id="4276941">len</span><span class="op" id="4276944">(</span><span class="ident" id="4276945">mr</span><span class="op" id="4276947">.</span><span class="ident" id="4276948">dashBoundary</span><span class="op" id="4276960">)</span><span class="op" id="4276961">:</span><span class="op" id="4276962">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276965">rest</span>&nbsp;<span class="op" id="4276970">=</span>&nbsp;<span class="ident" id="4276972">skipLWSPChar</span><span class="op" id="4276984">(</span><span class="ident" id="4276985">rest</span><span class="op" id="4276989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276993">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4277063">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4277134">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4277162">if</span>&nbsp;<span class="ident" id="4277165">mr</span><span class="op" id="4277167">.</span><span class="ident" id="4277168">partsRead</span>&nbsp;<span class="op" id="4277178">==</span>&nbsp;<span class="num" id="4277181">0</span>&nbsp;<span class="op" id="4277183">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4277186">len</span><span class="op" id="4277189">(</span><span class="ident" id="4277190">rest</span><span class="op" id="4277194">)</span>&nbsp;<span class="op" id="4277196">==</span>&nbsp;<span class="num" id="4277199">1</span>&nbsp;<span class="op" id="4277201">&amp;&amp;</span>&nbsp;<span class="ident" id="4277204">rest</span><span class="op" id="4277208">[</span><span class="num" id="4277209">0</span><span class="op" id="4277210">]</span>&nbsp;<span class="op" id="4277212">==</span>&nbsp;<span class="string" id="4277215">&#39;\n&#39;</span>&nbsp;<span class="op" id="4277220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277224">mr</span><span class="op" id="4277226">.</span><span class="ident" id="4277227">nl</span>&nbsp;<span class="op" id="4277230">=</span>&nbsp;<span class="ident" id="4277232">mr</span><span class="op" id="4277234">.</span><span class="ident" id="4277235">nl</span><span class="op" id="4277237">[</span><span class="num" id="4277238">1</span><span class="op" id="4277239">:</span><span class="op" id="4277240">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277244">mr</span><span class="op" id="4277246">.</span><span class="ident" id="4277247">nlDashBoundary</span>&nbsp;<span class="op" id="4277262">=</span>&nbsp;<span class="ident" id="4277264">mr</span><span class="op" id="4277266">.</span><span class="ident" id="4277267">nlDashBoundary</span><span class="op" id="4277281">[</span><span class="num" id="4277282">1</span><span class="op" id="4277283">:</span><span class="op" id="4277284">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4277287">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4277290">return</span>&nbsp;<span class="ident" id="4277297">bytes</span><span class="op" id="4277302">.</span><span class="ident" id="4277303">Equal</span><span class="op" id="4277308">(</span><span class="ident" id="4277309">rest</span><span class="op" id="4277313">,</span>&nbsp;<span class="ident" id="4277315">mr</span><span class="op" id="4277317">.</span><span class="ident" id="4277318">nl</span><span class="op" id="4277320">)</span><br>
<span class="lineno"></span><span class="op" id="4277322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4277325">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="4277390">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="4277457">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="4277528">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4277593">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="4277605">//</span><br>
<span class="lineno"></span><span class="comment" id="4277608">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="4277678">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="4277746">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4277814">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4277858">func</span>&nbsp;<span class="op" id="4277863">(</span><span class="ident" id="4277864">mr</span>&nbsp;<span class="op" id="4277867">*</span><span class="ident" id="4277868">Reader</span><span class="op" id="4277874">)</span>&nbsp;<span class="ident" id="4277876">peekBufferIsEmptyPart</span><span class="op" id="4277897">(</span><span class="ident" id="4277898">peek</span>&nbsp;<span class="op" id="4277903">[</span><span class="op" id="4277904">]</span><span class="builtintype" id="4277905">byte</span><span class="op" id="4277909">)</span>&nbsp;<span class="builtintype" id="4277911">bool</span>&nbsp;<span class="op" id="4277916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4277919">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4277942">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278004">if</span>&nbsp;<span class="ident" id="4278007">bytes</span><span class="op" id="4278012">.</span><span class="ident" id="4278013">HasPrefix</span><span class="op" id="4278022">(</span><span class="ident" id="4278023">peek</span><span class="op" id="4278027">,</span>&nbsp;<span class="ident" id="4278029">mr</span><span class="op" id="4278031">.</span><span class="ident" id="4278032">dashBoundaryDash</span><span class="op" id="4278048">)</span>&nbsp;<span class="op" id="4278050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278054">rest</span>&nbsp;<span class="op" id="4278059">:=</span>&nbsp;<span class="ident" id="4278062">peek</span><span class="op" id="4278066">[</span><span class="builtinfunc" id="4278067">len</span><span class="op" id="4278070">(</span><span class="ident" id="4278071">mr</span><span class="op" id="4278073">.</span><span class="ident" id="4278074">dashBoundaryDash</span><span class="op" id="4278090">)</span><span class="op" id="4278091">:</span><span class="op" id="4278092">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278096">rest</span>&nbsp;<span class="op" id="4278101">=</span>&nbsp;<span class="ident" id="4278103">skipLWSPChar</span><span class="op" id="4278115">(</span><span class="ident" id="4278116">rest</span><span class="op" id="4278120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278124">return</span>&nbsp;<span class="ident" id="4278131">bytes</span><span class="op" id="4278136">.</span><span class="ident" id="4278137">HasPrefix</span><span class="op" id="4278146">(</span><span class="ident" id="4278147">rest</span><span class="op" id="4278151">,</span>&nbsp;<span class="ident" id="4278153">mr</span><span class="op" id="4278155">.</span><span class="ident" id="4278156">nl</span><span class="op" id="4278158">)</span>&nbsp;<span class="op" id="4278160">||</span>&nbsp;<span class="builtinfunc" id="4278163">len</span><span class="op" id="4278166">(</span><span class="ident" id="4278167">rest</span><span class="op" id="4278171">)</span>&nbsp;<span class="op" id="4278173">==</span>&nbsp;<span class="num" id="4278176">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278182">if</span>&nbsp;<span class="op" id="4278185">!</span><span class="ident" id="4278186">bytes</span><span class="op" id="4278191">.</span><span class="ident" id="4278192">HasPrefix</span><span class="op" id="4278201">(</span><span class="ident" id="4278202">peek</span><span class="op" id="4278206">,</span>&nbsp;<span class="ident" id="4278208">mr</span><span class="op" id="4278210">.</span><span class="ident" id="4278211">dashBoundary</span><span class="op" id="4278223">)</span>&nbsp;<span class="op" id="4278225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278229">return</span>&nbsp;<span class="builtintype" id="4278236">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278246">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278291">rest</span>&nbsp;<span class="op" id="4278296">:=</span>&nbsp;<span class="ident" id="4278299">peek</span><span class="op" id="4278303">[</span><span class="builtinfunc" id="4278304">len</span><span class="op" id="4278307">(</span><span class="ident" id="4278308">mr</span><span class="op" id="4278310">.</span><span class="ident" id="4278311">dashBoundary</span><span class="op" id="4278323">)</span><span class="op" id="4278324">:</span><span class="op" id="4278325">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278328">rest</span>&nbsp;<span class="op" id="4278333">=</span>&nbsp;<span class="ident" id="4278335">skipLWSPChar</span><span class="op" id="4278347">(</span><span class="ident" id="4278348">rest</span><span class="op" id="4278352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278355">return</span>&nbsp;<span class="ident" id="4278362">bytes</span><span class="op" id="4278367">.</span><span class="ident" id="4278368">HasPrefix</span><span class="op" id="4278377">(</span><span class="ident" id="4278378">rest</span><span class="op" id="4278382">,</span>&nbsp;<span class="ident" id="4278384">mr</span><span class="op" id="4278386">.</span><span class="ident" id="4278387">nl</span><span class="op" id="4278389">)</span><br>
<span class="lineno"></span><span class="op" id="4278391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="4278394">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="4278458">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="4278478">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="4278509">func</span>&nbsp;<span class="ident" id="4278514">skipLWSPChar</span><span class="op" id="4278526">(</span><span class="ident" id="4278527">b</span>&nbsp;<span class="op" id="4278529">[</span><span class="op" id="4278530">]</span><span class="builtintype" id="4278531">byte</span><span class="op" id="4278535">)</span>&nbsp;<span class="op" id="4278537">[</span><span class="op" id="4278538">]</span><span class="builtintype" id="4278539">byte</span>&nbsp;<span class="op" id="4278544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278547">for</span>&nbsp;<span class="builtinfunc" id="4278551">len</span><span class="op" id="4278554">(</span><span class="ident" id="4278555">b</span><span class="op" id="4278556">)</span>&nbsp;<span class="op" id="4278558">&gt;</span>&nbsp;<span class="num" id="4278560">0</span>&nbsp;<span class="op" id="4278562">&amp;&amp;</span>&nbsp;<span class="op" id="4278565">(</span><span class="ident" id="4278566">b</span><span class="op" id="4278567">[</span><span class="num" id="4278568">0</span><span class="op" id="4278569">]</span>&nbsp;<span class="op" id="4278571">==</span>&nbsp;<span class="string" id="4278574">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4278578">||</span>&nbsp;<span class="ident" id="4278581">b</span><span class="op" id="4278582">[</span><span class="num" id="4278583">0</span><span class="op" id="4278584">]</span>&nbsp;<span class="op" id="4278586">==</span>&nbsp;<span class="string" id="4278589">&#39;\t&#39;</span><span class="op" id="4278593">)</span>&nbsp;<span class="op" id="4278595">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278599">b</span>&nbsp;<span class="op" id="4278601">=</span>&nbsp;<span class="ident" id="4278603">b</span><span class="op" id="4278604">[</span><span class="num" id="4278605">1</span><span class="op" id="4278606">:</span><span class="op" id="4278607">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278613">return</span>&nbsp;<span class="ident" id="4278620">b</span><br>
<span class="lineno"></span><span class="op" id="4278622">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
