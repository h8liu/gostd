<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6801951">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6802006">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6802060">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6802111">package</span>&nbsp;<span class="ident" id="6802119">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6802129">import</span>&nbsp;<span class="op" id="6802136">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802139">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802148">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802157">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802164">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802170">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802183">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6802194">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6802204">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6802207">func</span>&nbsp;<span class="ident" id="6802212">TestChunk</span><span class="op" id="6802221">(</span><span class="ident" id="6802222">t</span>&nbsp;<span class="op" id="6802224">*</span><span class="ident" id="6802225">testing</span><span class="op" id="6802232">.</span><span class="ident" id="6802233">T</span><span class="op" id="6802234">)</span>&nbsp;<span class="op" id="6802236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802239">var</span>&nbsp;<span class="ident" id="6802243">b</span>&nbsp;<span class="ident" id="6802245">bytes</span><span class="op" id="6802250">.</span><span class="ident" id="6802251">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802260">w</span>&nbsp;<span class="op" id="6802262">:=</span>&nbsp;<span class="ident" id="6802265">NewChunkedWriter</span><span class="op" id="6802281">(</span><span class="op" id="6802282">&amp;</span><span class="ident" id="6802283">b</span><span class="op" id="6802284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802287">const</span>&nbsp;<span class="ident" id="6802293">chunk1</span>&nbsp;<span class="op" id="6802300">=</span>&nbsp;<span class="string" id="6802302">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802313">const</span>&nbsp;<span class="ident" id="6802319">chunk2</span>&nbsp;<span class="op" id="6802326">=</span>&nbsp;<span class="string" id="6802328">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802355">w</span><span class="op" id="6802356">.</span><span class="ident" id="6802357">Write</span><span class="op" id="6802362">(</span><span class="op" id="6802363">[</span><span class="op" id="6802364">]</span><span class="builtintype" id="6802365">byte</span><span class="op" id="6802369">(</span><span class="ident" id="6802370">chunk1</span><span class="op" id="6802376">)</span><span class="op" id="6802377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802380">w</span><span class="op" id="6802381">.</span><span class="ident" id="6802382">Write</span><span class="op" id="6802387">(</span><span class="op" id="6802388">[</span><span class="op" id="6802389">]</span><span class="builtintype" id="6802390">byte</span><span class="op" id="6802394">(</span><span class="ident" id="6802395">chunk2</span><span class="op" id="6802401">)</span><span class="op" id="6802402">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802405">w</span><span class="op" id="6802406">.</span><span class="ident" id="6802407">Close</span><span class="op" id="6802412">(</span><span class="op" id="6802413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802417">if</span>&nbsp;<span class="ident" id="6802420">g</span><span class="op" id="6802421">,</span>&nbsp;<span class="ident" id="6802423">e</span>&nbsp;<span class="op" id="6802425">:=</span>&nbsp;<span class="ident" id="6802428">b</span><span class="op" id="6802429">.</span><span class="ident" id="6802430">String</span><span class="op" id="6802436">(</span><span class="op" id="6802437">)</span><span class="op" id="6802438">,</span>&nbsp;<span class="string" id="6802440">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="6802496">;</span>&nbsp;<span class="ident" id="6802498">g</span>&nbsp;<span class="op" id="6802500">!=</span>&nbsp;<span class="ident" id="6802503">e</span>&nbsp;<span class="op" id="6802505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802509">t</span><span class="op" id="6802510">.</span><span class="ident" id="6802511">Fatalf</span><span class="op" id="6802517">(</span><span class="string" id="6802518">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6802550">,</span>&nbsp;<span class="ident" id="6802552">g</span><span class="op" id="6802553">,</span>&nbsp;<span class="ident" id="6802555">e</span><span class="op" id="6802556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6802559">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802563">r</span>&nbsp;<span class="op" id="6802565">:=</span>&nbsp;<span class="ident" id="6802568">NewChunkedReader</span><span class="op" id="6802584">(</span><span class="op" id="6802585">&amp;</span><span class="ident" id="6802586">b</span><span class="op" id="6802587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802590">data</span><span class="op" id="6802594">,</span>&nbsp;<span class="ident" id="6802596">err</span>&nbsp;<span class="op" id="6802600">:=</span>&nbsp;<span class="ident" id="6802603">ioutil</span><span class="op" id="6802609">.</span><span class="ident" id="6802610">ReadAll</span><span class="op" id="6802617">(</span><span class="ident" id="6802618">r</span><span class="op" id="6802619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802622">if</span>&nbsp;<span class="ident" id="6802625">err</span>&nbsp;<span class="op" id="6802629">!=</span>&nbsp;<span class="ident" id="6802632">nil</span>&nbsp;<span class="op" id="6802636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802640">t</span><span class="op" id="6802641">.</span><span class="ident" id="6802642">Logf</span><span class="op" id="6802646">(</span><span class="string" id="6802647">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="6802659">,</span>&nbsp;<span class="ident" id="6802661">data</span><span class="op" id="6802665">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802669">t</span><span class="op" id="6802670">.</span><span class="ident" id="6802671">Fatalf</span><span class="op" id="6802677">(</span><span class="string" id="6802678">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="6802703">,</span>&nbsp;<span class="ident" id="6802705">err</span><span class="op" id="6802708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6802711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802714">if</span>&nbsp;<span class="ident" id="6802717">g</span><span class="op" id="6802718">,</span>&nbsp;<span class="ident" id="6802720">e</span>&nbsp;<span class="op" id="6802722">:=</span>&nbsp;<span class="builtintype" id="6802725">string</span><span class="op" id="6802731">(</span><span class="ident" id="6802732">data</span><span class="op" id="6802736">)</span><span class="op" id="6802737">,</span>&nbsp;<span class="ident" id="6802739">chunk1</span><span class="op" id="6802745">+</span><span class="ident" id="6802746">chunk2</span><span class="op" id="6802752">;</span>&nbsp;<span class="ident" id="6802754">g</span>&nbsp;<span class="op" id="6802756">!=</span>&nbsp;<span class="ident" id="6802759">e</span>&nbsp;<span class="op" id="6802761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802765">t</span><span class="op" id="6802766">.</span><span class="ident" id="6802767">Errorf</span><span class="op" id="6802773">(</span><span class="string" id="6802774">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6802805">,</span>&nbsp;<span class="ident" id="6802807">g</span><span class="op" id="6802808">,</span>&nbsp;<span class="ident" id="6802810">e</span><span class="op" id="6802811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6802814">}</span><br>
<span class="lineno">40</span><span class="op" id="6802816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6802819">func</span>&nbsp;<span class="ident" id="6802824">TestChunkReadMultiple</span><span class="op" id="6802845">(</span><span class="ident" id="6802846">t</span>&nbsp;<span class="op" id="6802848">*</span><span class="ident" id="6802849">testing</span><span class="op" id="6802856">.</span><span class="ident" id="6802857">T</span><span class="op" id="6802858">)</span>&nbsp;<span class="op" id="6802860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6802863">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6802909">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6802913">var</span>&nbsp;<span class="ident" id="6802917">b</span>&nbsp;<span class="ident" id="6802919">bytes</span><span class="op" id="6802924">.</span><span class="ident" id="6802925">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802934">w</span>&nbsp;<span class="op" id="6802936">:=</span>&nbsp;<span class="ident" id="6802939">NewChunkedWriter</span><span class="op" id="6802955">(</span><span class="op" id="6802956">&amp;</span><span class="ident" id="6802957">b</span><span class="op" id="6802958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802962">w</span><span class="op" id="6802963">.</span><span class="ident" id="6802964">Write</span><span class="op" id="6802969">(</span><span class="op" id="6802970">[</span><span class="op" id="6802971">]</span><span class="builtintype" id="6802972">byte</span><span class="op" id="6802976">(</span><span class="string" id="6802977">&#34;foo&#34;</span><span class="op" id="6802982">)</span><span class="op" id="6802983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6802987">w</span><span class="op" id="6802988">.</span><span class="ident" id="6802989">Write</span><span class="op" id="6802994">(</span><span class="op" id="6802995">[</span><span class="op" id="6802996">]</span><span class="builtintype" id="6802997">byte</span><span class="op" id="6803001">(</span><span class="string" id="6803002">&#34;bar&#34;</span><span class="op" id="6803007">)</span><span class="op" id="6803008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803012">w</span><span class="op" id="6803013">.</span><span class="ident" id="6803014">Close</span><span class="op" id="6803019">(</span><span class="op" id="6803020">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803025">r</span>&nbsp;<span class="op" id="6803027">:=</span>&nbsp;<span class="ident" id="6803030">NewChunkedReader</span><span class="op" id="6803046">(</span><span class="op" id="6803047">&amp;</span><span class="ident" id="6803048">b</span><span class="op" id="6803049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803053">buf</span>&nbsp;<span class="op" id="6803057">:=</span>&nbsp;<span class="builtinfunc" id="6803060">make</span><span class="op" id="6803064">(</span><span class="op" id="6803065">[</span><span class="op" id="6803066">]</span><span class="builtintype" id="6803067">byte</span><span class="op" id="6803071">,</span>&nbsp;<span class="num" id="6803073">10</span><span class="op" id="6803075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803079">n</span><span class="op" id="6803080">,</span>&nbsp;<span class="ident" id="6803082">err</span>&nbsp;<span class="op" id="6803086">:=</span>&nbsp;<span class="ident" id="6803089">r</span><span class="op" id="6803090">.</span><span class="ident" id="6803091">Read</span><span class="op" id="6803095">(</span><span class="ident" id="6803096">buf</span><span class="op" id="6803099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6803103">if</span>&nbsp;<span class="ident" id="6803106">n</span>&nbsp;<span class="op" id="6803108">!=</span>&nbsp;<span class="num" id="6803111">6</span>&nbsp;<span class="op" id="6803113">||</span>&nbsp;<span class="ident" id="6803116">err</span>&nbsp;<span class="op" id="6803120">!=</span>&nbsp;<span class="ident" id="6803123">io</span><span class="op" id="6803125">.</span><span class="ident" id="6803126">EOF</span>&nbsp;<span class="op" id="6803130">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803135">t</span><span class="op" id="6803136">.</span><span class="ident" id="6803137">Errorf</span><span class="op" id="6803143">(</span><span class="string" id="6803144">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="6803172">,</span>&nbsp;<span class="ident" id="6803174">n</span><span class="op" id="6803175">,</span>&nbsp;<span class="ident" id="6803177">err</span><span class="op" id="6803180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6803184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803188">buf</span>&nbsp;<span class="op" id="6803192">=</span>&nbsp;<span class="ident" id="6803194">buf</span><span class="op" id="6803197">[</span><span class="op" id="6803198">:</span><span class="ident" id="6803199">n</span><span class="op" id="6803200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6803204">if</span>&nbsp;<span class="builtintype" id="6803207">string</span><span class="op" id="6803213">(</span><span class="ident" id="6803214">buf</span><span class="op" id="6803217">)</span>&nbsp;<span class="op" id="6803219">!=</span>&nbsp;<span class="string" id="6803222">&#34;foobar&#34;</span>&nbsp;<span class="op" id="6803231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803236">t</span><span class="op" id="6803237">.</span><span class="ident" id="6803238">Errorf</span><span class="op" id="6803244">(</span><span class="string" id="6803245">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6803265">,</span>&nbsp;<span class="ident" id="6803267">buf</span><span class="op" id="6803270">,</span>&nbsp;<span class="string" id="6803272">&#34;foobar&#34;</span><span class="op" id="6803280">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6803284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6803287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6803291">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6803369">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6803429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6803433">var</span>&nbsp;<span class="ident" id="6803437">b</span>&nbsp;<span class="ident" id="6803439">bytes</span><span class="op" id="6803444">.</span><span class="ident" id="6803445">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803454">w</span>&nbsp;<span class="op" id="6803456">:=</span>&nbsp;<span class="ident" id="6803459">NewChunkedWriter</span><span class="op" id="6803475">(</span><span class="op" id="6803476">&amp;</span><span class="ident" id="6803477">b</span><span class="op" id="6803478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6803482">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6803558">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6803625">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6803700">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6803763">const</span>&nbsp;<span class="ident" id="6803769">fillBufChunk</span>&nbsp;<span class="op" id="6803782">=</span>&nbsp;<span class="string" id="6803784">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6803800">const</span>&nbsp;<span class="ident" id="6803806">shortChunk</span>&nbsp;<span class="op" id="6803817">=</span>&nbsp;<span class="string" id="6803819">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803827">w</span><span class="op" id="6803828">.</span><span class="ident" id="6803829">Write</span><span class="op" id="6803834">(</span><span class="op" id="6803835">[</span><span class="op" id="6803836">]</span><span class="builtintype" id="6803837">byte</span><span class="op" id="6803841">(</span><span class="ident" id="6803842">fillBufChunk</span><span class="op" id="6803854">)</span><span class="op" id="6803855">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803859">w</span><span class="op" id="6803860">.</span><span class="ident" id="6803861">Write</span><span class="op" id="6803866">(</span><span class="op" id="6803867">[</span><span class="op" id="6803868">]</span><span class="builtintype" id="6803869">byte</span><span class="op" id="6803873">(</span><span class="ident" id="6803874">shortChunk</span><span class="op" id="6803884">)</span><span class="op" id="6803885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803889">w</span><span class="op" id="6803890">.</span><span class="ident" id="6803891">Close</span><span class="op" id="6803896">(</span><span class="op" id="6803897">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803902">r</span>&nbsp;<span class="op" id="6803904">:=</span>&nbsp;<span class="ident" id="6803907">NewChunkedReader</span><span class="op" id="6803923">(</span><span class="ident" id="6803924">bufio</span><span class="op" id="6803929">.</span><span class="ident" id="6803930">NewReaderSize</span><span class="op" id="6803943">(</span><span class="op" id="6803944">&amp;</span><span class="ident" id="6803945">b</span><span class="op" id="6803946">,</span>&nbsp;<span class="num" id="6803948">16</span><span class="op" id="6803950">)</span><span class="op" id="6803951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6803955">buf</span>&nbsp;<span class="op" id="6803959">:=</span>&nbsp;<span class="builtinfunc" id="6803962">make</span><span class="op" id="6803966">(</span><span class="op" id="6803967">[</span><span class="op" id="6803968">]</span><span class="builtintype" id="6803969">byte</span><span class="op" id="6803973">,</span>&nbsp;<span class="builtinfunc" id="6803975">len</span><span class="op" id="6803978">(</span><span class="ident" id="6803979">fillBufChunk</span><span class="op" id="6803991">)</span><span class="op" id="6803992">+</span><span class="builtinfunc" id="6803993">len</span><span class="op" id="6803996">(</span><span class="ident" id="6803997">shortChunk</span><span class="op" id="6804007">)</span><span class="op" id="6804008">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804012">n</span><span class="op" id="6804013">,</span>&nbsp;<span class="ident" id="6804015">err</span>&nbsp;<span class="op" id="6804019">:=</span>&nbsp;<span class="ident" id="6804022">r</span><span class="op" id="6804023">.</span><span class="ident" id="6804024">Read</span><span class="op" id="6804028">(</span><span class="ident" id="6804029">buf</span><span class="op" id="6804032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804036">if</span>&nbsp;<span class="ident" id="6804039">n</span>&nbsp;<span class="op" id="6804041">!=</span>&nbsp;<span class="builtinfunc" id="6804044">len</span><span class="op" id="6804047">(</span><span class="ident" id="6804048">fillBufChunk</span><span class="op" id="6804060">)</span>&nbsp;<span class="op" id="6804062">||</span>&nbsp;<span class="ident" id="6804065">err</span>&nbsp;<span class="op" id="6804069">!=</span>&nbsp;<span class="ident" id="6804072">nil</span>&nbsp;<span class="op" id="6804076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804081">t</span><span class="op" id="6804082">.</span><span class="ident" id="6804083">Errorf</span><span class="op" id="6804089">(</span><span class="string" id="6804090">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="6804119">,</span>&nbsp;<span class="ident" id="6804121">n</span><span class="op" id="6804122">,</span>&nbsp;<span class="ident" id="6804124">err</span><span class="op" id="6804127">,</span>&nbsp;<span class="builtinfunc" id="6804129">len</span><span class="op" id="6804132">(</span><span class="ident" id="6804133">fillBufChunk</span><span class="op" id="6804145">)</span><span class="op" id="6804146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804154">buf</span>&nbsp;<span class="op" id="6804158">=</span>&nbsp;<span class="ident" id="6804160">buf</span><span class="op" id="6804163">[</span><span class="op" id="6804164">:</span><span class="ident" id="6804165">n</span><span class="op" id="6804166">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804170">if</span>&nbsp;<span class="builtintype" id="6804173">string</span><span class="op" id="6804179">(</span><span class="ident" id="6804180">buf</span><span class="op" id="6804183">)</span>&nbsp;<span class="op" id="6804185">!=</span>&nbsp;<span class="ident" id="6804188">fillBufChunk</span>&nbsp;<span class="op" id="6804201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804206">t</span><span class="op" id="6804207">.</span><span class="ident" id="6804208">Errorf</span><span class="op" id="6804214">(</span><span class="string" id="6804215">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6804235">,</span>&nbsp;<span class="ident" id="6804237">buf</span><span class="op" id="6804240">,</span>&nbsp;<span class="ident" id="6804242">fillBufChunk</span><span class="op" id="6804254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804263">n</span><span class="op" id="6804264">,</span>&nbsp;<span class="ident" id="6804266">err</span>&nbsp;<span class="op" id="6804270">=</span>&nbsp;<span class="ident" id="6804272">r</span><span class="op" id="6804273">.</span><span class="ident" id="6804274">Read</span><span class="op" id="6804278">(</span><span class="ident" id="6804279">buf</span><span class="op" id="6804282">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804286">if</span>&nbsp;<span class="ident" id="6804289">n</span>&nbsp;<span class="op" id="6804291">!=</span>&nbsp;<span class="builtinfunc" id="6804294">len</span><span class="op" id="6804297">(</span><span class="ident" id="6804298">shortChunk</span><span class="op" id="6804308">)</span>&nbsp;<span class="op" id="6804310">||</span>&nbsp;<span class="ident" id="6804313">err</span>&nbsp;<span class="op" id="6804317">!=</span>&nbsp;<span class="ident" id="6804320">io</span><span class="op" id="6804322">.</span><span class="ident" id="6804323">EOF</span>&nbsp;<span class="op" id="6804327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804332">t</span><span class="op" id="6804333">.</span><span class="ident" id="6804334">Errorf</span><span class="op" id="6804340">(</span><span class="string" id="6804341">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="6804370">,</span>&nbsp;<span class="ident" id="6804372">n</span><span class="op" id="6804373">,</span>&nbsp;<span class="ident" id="6804375">err</span><span class="op" id="6804378">,</span>&nbsp;<span class="builtinfunc" id="6804380">len</span><span class="op" id="6804383">(</span><span class="ident" id="6804384">shortChunk</span><span class="op" id="6804394">)</span><span class="op" id="6804395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6804406">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804489">r</span>&nbsp;<span class="op" id="6804491">:=</span>&nbsp;<span class="ident" id="6804494">NewChunkedReader</span><span class="op" id="6804510">(</span><span class="ident" id="6804511">bufio</span><span class="op" id="6804516">.</span><span class="ident" id="6804517">NewReader</span><span class="op" id="6804526">(</span><span class="ident" id="6804527">strings</span><span class="op" id="6804534">.</span><span class="ident" id="6804535">NewReader</span><span class="op" id="6804544">(</span><span class="string" id="6804545">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="6804564">)</span><span class="op" id="6804565">)</span><span class="op" id="6804566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804570">buf</span>&nbsp;<span class="op" id="6804574">:=</span>&nbsp;<span class="builtinfunc" id="6804577">make</span><span class="op" id="6804581">(</span><span class="op" id="6804582">[</span><span class="op" id="6804583">]</span><span class="builtintype" id="6804584">byte</span><span class="op" id="6804588">,</span>&nbsp;<span class="num" id="6804590">3</span><span class="op" id="6804591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804595">n</span><span class="op" id="6804596">,</span>&nbsp;<span class="ident" id="6804598">err</span>&nbsp;<span class="op" id="6804602">:=</span>&nbsp;<span class="ident" id="6804605">r</span><span class="op" id="6804606">.</span><span class="ident" id="6804607">Read</span><span class="op" id="6804611">(</span><span class="ident" id="6804612">buf</span><span class="op" id="6804615">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804619">if</span>&nbsp;<span class="ident" id="6804622">n</span>&nbsp;<span class="op" id="6804624">!=</span>&nbsp;<span class="num" id="6804627">3</span>&nbsp;<span class="op" id="6804629">||</span>&nbsp;<span class="ident" id="6804632">err</span>&nbsp;<span class="op" id="6804636">!=</span>&nbsp;<span class="ident" id="6804639">io</span><span class="op" id="6804641">.</span><span class="ident" id="6804642">EOF</span>&nbsp;<span class="op" id="6804646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804651">t</span><span class="op" id="6804652">.</span><span class="ident" id="6804653">Errorf</span><span class="op" id="6804659">(</span><span class="string" id="6804660">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="6804688">,</span>&nbsp;<span class="ident" id="6804690">n</span><span class="op" id="6804691">,</span>&nbsp;<span class="ident" id="6804693">err</span><span class="op" id="6804696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804704">if</span>&nbsp;<span class="builtintype" id="6804707">string</span><span class="op" id="6804713">(</span><span class="ident" id="6804714">buf</span><span class="op" id="6804717">)</span>&nbsp;<span class="op" id="6804719">!=</span>&nbsp;<span class="string" id="6804722">&#34;foo&#34;</span>&nbsp;<span class="op" id="6804728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804733">t</span><span class="op" id="6804734">.</span><span class="ident" id="6804735">Errorf</span><span class="op" id="6804741">(</span><span class="string" id="6804742">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="6804762">,</span>&nbsp;<span class="ident" id="6804764">buf</span><span class="op" id="6804767">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804774">}</span><br>
<span class="lineno"></span><span class="op" id="6804776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6804779">func</span>&nbsp;<span class="ident" id="6804784">TestChunkReaderAllocs</span><span class="op" id="6804805">(</span><span class="ident" id="6804806">t</span>&nbsp;<span class="op" id="6804808">*</span><span class="ident" id="6804809">testing</span><span class="op" id="6804816">.</span><span class="ident" id="6804817">T</span><span class="op" id="6804818">)</span>&nbsp;<span class="op" id="6804820">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804823">if</span>&nbsp;<span class="ident" id="6804826">testing</span><span class="op" id="6804833">.</span><span class="ident" id="6804834">Short</span><span class="op" id="6804839">(</span><span class="op" id="6804840">)</span>&nbsp;<span class="op" id="6804842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804846">t</span><span class="op" id="6804847">.</span><span class="ident" id="6804848">Skip</span><span class="op" id="6804852">(</span><span class="string" id="6804853">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6804877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6804880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6804883">var</span>&nbsp;<span class="ident" id="6804887">buf</span>&nbsp;<span class="ident" id="6804891">bytes</span><span class="op" id="6804896">.</span><span class="ident" id="6804897">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804905">w</span>&nbsp;<span class="op" id="6804907">:=</span>&nbsp;<span class="ident" id="6804910">NewChunkedWriter</span><span class="op" id="6804926">(</span><span class="op" id="6804927">&amp;</span><span class="ident" id="6804928">buf</span><span class="op" id="6804931">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6804934">a</span><span class="op" id="6804935">,</span>&nbsp;<span class="ident" id="6804937">b</span><span class="op" id="6804938">,</span>&nbsp;<span class="ident" id="6804940">c</span>&nbsp;<span class="op" id="6804942">:=</span>&nbsp;<span class="op" id="6804945">[</span><span class="op" id="6804946">]</span><span class="builtintype" id="6804947">byte</span><span class="op" id="6804951">(</span><span class="string" id="6804952">&#34;aaaaaa&#34;</span><span class="op" id="6804960">)</span><span class="op" id="6804961">,</span>&nbsp;<span class="op" id="6804963">[</span><span class="op" id="6804964">]</span><span class="builtintype" id="6804965">byte</span><span class="op" id="6804969">(</span><span class="string" id="6804970">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="6804984">)</span><span class="op" id="6804985">,</span>&nbsp;<span class="op" id="6804987">[</span><span class="op" id="6804988">]</span><span class="builtintype" id="6804989">byte</span><span class="op" id="6804993">(</span><span class="string" id="6804994">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="6805020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805023">w</span><span class="op" id="6805024">.</span><span class="ident" id="6805025">Write</span><span class="op" id="6805030">(</span><span class="ident" id="6805031">a</span><span class="op" id="6805032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805035">w</span><span class="op" id="6805036">.</span><span class="ident" id="6805037">Write</span><span class="op" id="6805042">(</span><span class="ident" id="6805043">b</span><span class="op" id="6805044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805047">w</span><span class="op" id="6805048">.</span><span class="ident" id="6805049">Write</span><span class="op" id="6805054">(</span><span class="ident" id="6805055">c</span><span class="op" id="6805056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805059">w</span><span class="op" id="6805060">.</span><span class="ident" id="6805061">Close</span><span class="op" id="6805066">(</span><span class="op" id="6805067">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805071">readBuf</span>&nbsp;<span class="op" id="6805079">:=</span>&nbsp;<span class="builtinfunc" id="6805082">make</span><span class="op" id="6805086">(</span><span class="op" id="6805087">[</span><span class="op" id="6805088">]</span><span class="builtintype" id="6805089">byte</span><span class="op" id="6805093">,</span>&nbsp;<span class="builtinfunc" id="6805095">len</span><span class="op" id="6805098">(</span><span class="ident" id="6805099">a</span><span class="op" id="6805100">)</span><span class="op" id="6805101">+</span><span class="builtinfunc" id="6805102">len</span><span class="op" id="6805105">(</span><span class="ident" id="6805106">b</span><span class="op" id="6805107">)</span><span class="op" id="6805108">+</span><span class="builtinfunc" id="6805109">len</span><span class="op" id="6805112">(</span><span class="ident" id="6805113">c</span><span class="op" id="6805114">)</span><span class="op" id="6805115">+</span><span class="num" id="6805116">1</span><span class="op" id="6805117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805120">byter</span>&nbsp;<span class="op" id="6805126">:=</span>&nbsp;<span class="ident" id="6805129">bytes</span><span class="op" id="6805134">.</span><span class="ident" id="6805135">NewReader</span><span class="op" id="6805144">(</span><span class="ident" id="6805145">buf</span><span class="op" id="6805148">.</span><span class="ident" id="6805149">Bytes</span><span class="op" id="6805154">(</span><span class="op" id="6805155">)</span><span class="op" id="6805156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805159">bufr</span>&nbsp;<span class="op" id="6805164">:=</span>&nbsp;<span class="ident" id="6805167">bufio</span><span class="op" id="6805172">.</span><span class="ident" id="6805173">NewReader</span><span class="op" id="6805182">(</span><span class="ident" id="6805183">byter</span><span class="op" id="6805188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805191">mallocs</span>&nbsp;<span class="op" id="6805199">:=</span>&nbsp;<span class="ident" id="6805202">testing</span><span class="op" id="6805209">.</span><span class="ident" id="6805210">AllocsPerRun</span><span class="op" id="6805222">(</span><span class="num" id="6805223">100</span><span class="op" id="6805226">,</span>&nbsp;<span class="keyword" id="6805228">func</span><span class="op" id="6805232">(</span><span class="op" id="6805233">)</span>&nbsp;<span class="op" id="6805235">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805239">byter</span><span class="op" id="6805244">.</span><span class="ident" id="6805245">Seek</span><span class="op" id="6805249">(</span><span class="num" id="6805250">0</span><span class="op" id="6805251">,</span>&nbsp;<span class="num" id="6805253">0</span><span class="op" id="6805254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805258">bufr</span><span class="op" id="6805262">.</span><span class="ident" id="6805263">Reset</span><span class="op" id="6805268">(</span><span class="ident" id="6805269">byter</span><span class="op" id="6805274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805278">r</span>&nbsp;<span class="op" id="6805280">:=</span>&nbsp;<span class="ident" id="6805283">NewChunkedReader</span><span class="op" id="6805299">(</span><span class="ident" id="6805300">bufr</span><span class="op" id="6805304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805308">n</span><span class="op" id="6805309">,</span>&nbsp;<span class="ident" id="6805311">err</span>&nbsp;<span class="op" id="6805315">:=</span>&nbsp;<span class="ident" id="6805318">io</span><span class="op" id="6805320">.</span><span class="ident" id="6805321">ReadFull</span><span class="op" id="6805329">(</span><span class="ident" id="6805330">r</span><span class="op" id="6805331">,</span>&nbsp;<span class="ident" id="6805333">readBuf</span><span class="op" id="6805340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805344">if</span>&nbsp;<span class="ident" id="6805347">n</span>&nbsp;<span class="op" id="6805349">!=</span>&nbsp;<span class="builtinfunc" id="6805352">len</span><span class="op" id="6805355">(</span><span class="ident" id="6805356">readBuf</span><span class="op" id="6805363">)</span><span class="op" id="6805364">-</span><span class="num" id="6805365">1</span>&nbsp;<span class="op" id="6805367">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805372">t</span><span class="op" id="6805373">.</span><span class="ident" id="6805374">Fatalf</span><span class="op" id="6805380">(</span><span class="string" id="6805381">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6805405">,</span>&nbsp;<span class="ident" id="6805407">n</span><span class="op" id="6805408">,</span>&nbsp;<span class="builtinfunc" id="6805410">len</span><span class="op" id="6805413">(</span><span class="ident" id="6805414">readBuf</span><span class="op" id="6805421">)</span><span class="op" id="6805422">-</span><span class="num" id="6805423">1</span><span class="op" id="6805424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805432">if</span>&nbsp;<span class="ident" id="6805435">err</span>&nbsp;<span class="op" id="6805439">!=</span>&nbsp;<span class="ident" id="6805442">io</span><span class="op" id="6805444">.</span><span class="ident" id="6805445">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6805462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805467">t</span><span class="op" id="6805468">.</span><span class="ident" id="6805469">Fatalf</span><span class="op" id="6805475">(</span><span class="string" id="6805476">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="6805516">,</span>&nbsp;<span class="ident" id="6805518">err</span><span class="op" id="6805521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805525">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805528">}</span><span class="op" id="6805529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805532">if</span>&nbsp;<span class="ident" id="6805535">mallocs</span>&nbsp;<span class="op" id="6805543">&gt;</span>&nbsp;<span class="num" id="6805545">1.5</span>&nbsp;<span class="op" id="6805549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805553">t</span><span class="op" id="6805554">.</span><span class="ident" id="6805555">Errorf</span><span class="op" id="6805561">(</span><span class="string" id="6805562">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6805584">,</span>&nbsp;<span class="ident" id="6805586">mallocs</span><span class="op" id="6805593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805596">}</span><br>
<span class="lineno"></span><span class="op" id="6805598">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6805601">func</span>&nbsp;<span class="ident" id="6805606">TestParseHexUint</span><span class="op" id="6805622">(</span><span class="ident" id="6805623">t</span>&nbsp;<span class="op" id="6805625">*</span><span class="ident" id="6805626">testing</span><span class="op" id="6805633">.</span><span class="ident" id="6805634">T</span><span class="op" id="6805635">)</span>&nbsp;<span class="op" id="6805637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805640">for</span>&nbsp;<span class="ident" id="6805644">i</span>&nbsp;<span class="op" id="6805646">:=</span>&nbsp;<span class="ident" id="6805649">uint64</span><span class="op" id="6805655">(</span><span class="num" id="6805656">0</span><span class="op" id="6805657">)</span><span class="op" id="6805658">;</span>&nbsp;<span class="ident" id="6805660">i</span>&nbsp;<span class="op" id="6805662">&lt;=</span>&nbsp;<span class="num" id="6805665">1234</span><span class="op" id="6805669">;</span>&nbsp;<span class="ident" id="6805671">i</span><span class="op" id="6805672">++</span>&nbsp;<span class="op" id="6805675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805679">line</span>&nbsp;<span class="op" id="6805684">:=</span>&nbsp;<span class="op" id="6805687">[</span><span class="op" id="6805688">]</span><span class="builtintype" id="6805689">byte</span><span class="op" id="6805693">(</span><span class="ident" id="6805694">fmt</span><span class="op" id="6805697">.</span><span class="ident" id="6805698">Sprintf</span><span class="op" id="6805705">(</span><span class="string" id="6805706">&#34;%x&#34;</span><span class="op" id="6805710">,</span>&nbsp;<span class="ident" id="6805712">i</span><span class="op" id="6805713">)</span><span class="op" id="6805714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805718">got</span><span class="op" id="6805721">,</span>&nbsp;<span class="ident" id="6805723">err</span>&nbsp;<span class="op" id="6805727">:=</span>&nbsp;<span class="ident" id="6805730">parseHexUint</span><span class="op" id="6805742">(</span><span class="ident" id="6805743">line</span><span class="op" id="6805747">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805751">if</span>&nbsp;<span class="ident" id="6805754">err</span>&nbsp;<span class="op" id="6805758">!=</span>&nbsp;<span class="ident" id="6805761">nil</span>&nbsp;<span class="op" id="6805765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805770">t</span><span class="op" id="6805771">.</span><span class="ident" id="6805772">Fatalf</span><span class="op" id="6805778">(</span><span class="string" id="6805779">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6805790">,</span>&nbsp;<span class="ident" id="6805792">i</span><span class="op" id="6805793">,</span>&nbsp;<span class="ident" id="6805795">err</span><span class="op" id="6805798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805806">if</span>&nbsp;<span class="ident" id="6805809">got</span>&nbsp;<span class="op" id="6805813">!=</span>&nbsp;<span class="ident" id="6805816">i</span>&nbsp;<span class="op" id="6805818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805823">t</span><span class="op" id="6805824">.</span><span class="ident" id="6805825">Errorf</span><span class="op" id="6805831">(</span><span class="string" id="6805832">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6805860">,</span>&nbsp;<span class="ident" id="6805862">line</span><span class="op" id="6805866">,</span>&nbsp;<span class="ident" id="6805868">got</span><span class="op" id="6805871">,</span>&nbsp;<span class="ident" id="6805873">i</span><span class="op" id="6805874">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805884">_</span><span class="op" id="6805885">,</span>&nbsp;<span class="ident" id="6805887">err</span>&nbsp;<span class="op" id="6805891">:=</span>&nbsp;<span class="ident" id="6805894">parseHexUint</span><span class="op" id="6805906">(</span><span class="op" id="6805907">[</span><span class="op" id="6805908">]</span><span class="builtintype" id="6805909">byte</span><span class="op" id="6805913">(</span><span class="string" id="6805914">&#34;bogus&#34;</span><span class="op" id="6805921">)</span><span class="op" id="6805922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6805925">if</span>&nbsp;<span class="ident" id="6805928">err</span>&nbsp;<span class="op" id="6805932">==</span>&nbsp;<span class="ident" id="6805935">nil</span>&nbsp;<span class="op" id="6805939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6805943">t</span><span class="op" id="6805944">.</span><span class="ident" id="6805945">Error</span><span class="op" id="6805950">(</span><span class="string" id="6805951">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="6805982">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6805985">}</span><br>
<span class="lineno"></span><span class="op" id="6805987">}</span>
</div>
</body>
</html>
