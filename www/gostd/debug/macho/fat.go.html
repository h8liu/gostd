<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6423624">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6423680">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6423734">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6423785">package</span>&nbsp;<span class="ident" id="6423793">macho</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6423800">import</span>&nbsp;<span class="op" id="6423807">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423810">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423829">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423836">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6423842">&#34;os&#34;</span><br>
<span class="lineno"></span><span class="op" id="6423847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6423850">//&nbsp;A&nbsp;FatFile&nbsp;is&nbsp;a&nbsp;Mach-O&nbsp;universal&nbsp;binary&nbsp;that&nbsp;contains&nbsp;at&nbsp;least&nbsp;one&nbsp;architecture.</span><br>
<span class="lineno">15</span><span class="keyword" id="6423933">type</span>&nbsp;<span class="ident" id="6423938">FatFile</span>&nbsp;<span class="keyword" id="6423946">struct</span>&nbsp;<span class="op" id="6423953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423956">Magic</span>&nbsp;&nbsp;<span class="builtintype" id="6423963">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423971">Arches</span>&nbsp;<span class="op" id="6423978">[</span><span class="op" id="6423979">]</span><span class="ident" id="6423980">FatArch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6423989">closer</span>&nbsp;<span class="ident" id="6423996">io</span><span class="op" id="6423998">.</span><span class="ident" id="6423999">Closer</span><br>
<span class="lineno"></span><span class="op" id="6424006">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6424009">//&nbsp;A&nbsp;FatArchHeader&nbsp;represents&nbsp;a&nbsp;fat&nbsp;header&nbsp;for&nbsp;a&nbsp;specific&nbsp;image&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="keyword" id="6424087">type</span>&nbsp;<span class="ident" id="6424092">FatArchHeader</span>&nbsp;<span class="keyword" id="6424106">struct</span>&nbsp;<span class="op" id="6424113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424116">Cpu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6424123">Cpu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424128">SubCpu</span>&nbsp;<span class="builtintype" id="6424135">uint32</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424143">Offset</span>&nbsp;<span class="builtintype" id="6424150">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424158">Size</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6424165">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424173">Align</span>&nbsp;&nbsp;<span class="builtintype" id="6424180">uint32</span><br>
<span class="lineno"></span><span class="op" id="6424187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="6424190">const</span>&nbsp;<span class="ident" id="6424196">fatArchHeaderSize</span>&nbsp;<span class="op" id="6424214">=</span>&nbsp;<span class="num" id="6424216">5</span>&nbsp;<span class="op" id="6424218">*</span>&nbsp;<span class="num" id="6424220">4</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6424223">//&nbsp;A&nbsp;FatArch&nbsp;is&nbsp;a&nbsp;Mach-O&nbsp;File&nbsp;inside&nbsp;a&nbsp;FatFile.</span><br>
<span class="lineno"></span><span class="keyword" id="6424271">type</span>&nbsp;<span class="ident" id="6424276">FatArch</span>&nbsp;<span class="keyword" id="6424284">struct</span>&nbsp;<span class="op" id="6424291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424294">FatArchHeader</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6424309">*</span><span class="ident" id="6424310">File</span><br>
<span class="lineno"></span><span class="op" id="6424315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6424318">//&nbsp;ErrNotFat&nbsp;is&nbsp;returned&nbsp;from&nbsp;NewFatFile&nbsp;or&nbsp;OpenFat&nbsp;when&nbsp;the&nbsp;file&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6424393">//&nbsp;universal&nbsp;binary&nbsp;but&nbsp;may&nbsp;be&nbsp;a&nbsp;thin&nbsp;binary,&nbsp;based&nbsp;on&nbsp;its&nbsp;magic&nbsp;number.</span><br>
<span class="lineno">40</span><span class="keyword" id="6424466">var</span>&nbsp;<span class="ident" id="6424470">ErrNotFat</span>&nbsp;<span class="op" id="6424480">=</span>&nbsp;<span class="op" id="6424482">&amp;</span><span class="ident" id="6424483">FormatError</span><span class="op" id="6424494">{</span><span class="num" id="6424495">0</span><span class="op" id="6424496">,</span>&nbsp;<span class="string" id="6424498">&#34;not&nbsp;a&nbsp;fat&nbsp;Mach-O&nbsp;file&#34;</span><span class="op" id="6424521">,</span>&nbsp;<span class="ident" id="6424523">nil</span><span class="op" id="6424526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6424529">//&nbsp;NewFatFile&nbsp;creates&nbsp;a&nbsp;new&nbsp;FatFile&nbsp;for&nbsp;accessing&nbsp;all&nbsp;the&nbsp;Mach-O&nbsp;images&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6424606">//&nbsp;universal&nbsp;binary.&nbsp;The&nbsp;Mach-O&nbsp;binary&nbsp;is&nbsp;expected&nbsp;to&nbsp;start&nbsp;at&nbsp;position&nbsp;0&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6424683">//&nbsp;the&nbsp;ReaderAt.</span><br>
<span class="lineno">45</span><span class="keyword" id="6424700">func</span>&nbsp;<span class="ident" id="6424705">NewFatFile</span><span class="op" id="6424715">(</span><span class="ident" id="6424716">r</span>&nbsp;<span class="ident" id="6424718">io</span><span class="op" id="6424720">.</span><span class="ident" id="6424721">ReaderAt</span><span class="op" id="6424729">)</span>&nbsp;<span class="op" id="6424731">(</span><span class="op" id="6424732">*</span><span class="ident" id="6424733">FatFile</span><span class="op" id="6424740">,</span>&nbsp;<span class="builtintype" id="6424742">error</span><span class="op" id="6424747">)</span>&nbsp;<span class="op" id="6424749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6424752">var</span>&nbsp;<span class="ident" id="6424756">ff</span>&nbsp;<span class="ident" id="6424759">FatFile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424768">sr</span>&nbsp;<span class="op" id="6424771">:=</span>&nbsp;<span class="ident" id="6424774">io</span><span class="op" id="6424776">.</span><span class="ident" id="6424777">NewSectionReader</span><span class="op" id="6424793">(</span><span class="ident" id="6424794">r</span><span class="op" id="6424795">,</span>&nbsp;<span class="num" id="6424797">0</span><span class="op" id="6424798">,</span>&nbsp;<span class="num" id="6424800">1</span><span class="op" id="6424801">&lt;&lt;</span><span class="num" id="6424803">63</span><span class="op" id="6424805">-</span><span class="num" id="6424806">1</span><span class="op" id="6424807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6424811">//&nbsp;Read&nbsp;the&nbsp;fat_header&nbsp;struct,&nbsp;which&nbsp;is&nbsp;always&nbsp;in&nbsp;big&nbsp;endian.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6424874">//&nbsp;Start&nbsp;with&nbsp;the&nbsp;magic&nbsp;number.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6424907">err</span>&nbsp;<span class="op" id="6424911">:=</span>&nbsp;<span class="ident" id="6424914">binary</span><span class="op" id="6424920">.</span><span class="ident" id="6424921">Read</span><span class="op" id="6424925">(</span><span class="ident" id="6424926">sr</span><span class="op" id="6424928">,</span>&nbsp;<span class="ident" id="6424930">binary</span><span class="op" id="6424936">.</span><span class="ident" id="6424937">BigEndian</span><span class="op" id="6424946">,</span>&nbsp;<span class="op" id="6424948">&amp;</span><span class="ident" id="6424949">ff</span><span class="op" id="6424951">.</span><span class="ident" id="6424952">Magic</span><span class="op" id="6424957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6424960">if</span>&nbsp;<span class="ident" id="6424963">err</span>&nbsp;<span class="op" id="6424967">!=</span>&nbsp;<span class="ident" id="6424970">nil</span>&nbsp;<span class="op" id="6424974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6424978">return</span>&nbsp;<span class="ident" id="6424985">nil</span><span class="op" id="6424988">,</span>&nbsp;<span class="op" id="6424990">&amp;</span><span class="ident" id="6424991">FormatError</span><span class="op" id="6425002">{</span><span class="num" id="6425003">0</span><span class="op" id="6425004">,</span>&nbsp;<span class="string" id="6425006">&#34;error&nbsp;reading&nbsp;magic&nbsp;number&#34;</span><span class="op" id="6425034">,</span>&nbsp;<span class="ident" id="6425036">nil</span><span class="op" id="6425039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425042">}</span>&nbsp;<span class="keyword" id="6425044">else</span>&nbsp;<span class="keyword" id="6425049">if</span>&nbsp;<span class="ident" id="6425052">ff</span><span class="op" id="6425054">.</span><span class="ident" id="6425055">Magic</span>&nbsp;<span class="op" id="6425061">!=</span>&nbsp;<span class="ident" id="6425064">MagicFat</span>&nbsp;<span class="op" id="6425073">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6425077">//&nbsp;See&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;Mach-O&nbsp;file&nbsp;via&nbsp;its&nbsp;magic&nbsp;number.&nbsp;The&nbsp;magic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6425143">//&nbsp;must&nbsp;be&nbsp;converted&nbsp;to&nbsp;little&nbsp;endian&nbsp;first&nbsp;though.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425197">var</span>&nbsp;<span class="ident" id="6425201">buf</span>&nbsp;<span class="op" id="6425205">[</span><span class="num" id="6425206">4</span><span class="op" id="6425207">]</span><span class="builtintype" id="6425208">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425215">binary</span><span class="op" id="6425221">.</span><span class="ident" id="6425222">BigEndian</span><span class="op" id="6425231">.</span><span class="ident" id="6425232">PutUint32</span><span class="op" id="6425241">(</span><span class="ident" id="6425242">buf</span><span class="op" id="6425245">[</span><span class="op" id="6425246">:</span><span class="op" id="6425247">]</span><span class="op" id="6425248">,</span>&nbsp;<span class="ident" id="6425250">ff</span><span class="op" id="6425252">.</span><span class="ident" id="6425253">Magic</span><span class="op" id="6425258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425262">leMagic</span>&nbsp;<span class="op" id="6425270">:=</span>&nbsp;<span class="ident" id="6425273">binary</span><span class="op" id="6425279">.</span><span class="ident" id="6425280">LittleEndian</span><span class="op" id="6425292">.</span><span class="ident" id="6425293">Uint32</span><span class="op" id="6425299">(</span><span class="ident" id="6425300">buf</span><span class="op" id="6425303">[</span><span class="op" id="6425304">:</span><span class="op" id="6425305">]</span><span class="op" id="6425306">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425310">if</span>&nbsp;<span class="ident" id="6425313">leMagic</span>&nbsp;<span class="op" id="6425321">==</span>&nbsp;<span class="ident" id="6425324">Magic32</span>&nbsp;<span class="op" id="6425332">||</span>&nbsp;<span class="ident" id="6425335">leMagic</span>&nbsp;<span class="op" id="6425343">==</span>&nbsp;<span class="ident" id="6425346">Magic64</span>&nbsp;<span class="op" id="6425354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425359">return</span>&nbsp;<span class="ident" id="6425366">nil</span><span class="op" id="6425369">,</span>&nbsp;<span class="ident" id="6425371">ErrNotFat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425383">}</span>&nbsp;<span class="keyword" id="6425385">else</span>&nbsp;<span class="op" id="6425390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425395">return</span>&nbsp;<span class="ident" id="6425402">nil</span><span class="op" id="6425405">,</span>&nbsp;<span class="op" id="6425407">&amp;</span><span class="ident" id="6425408">FormatError</span><span class="op" id="6425419">{</span><span class="num" id="6425420">0</span><span class="op" id="6425421">,</span>&nbsp;<span class="string" id="6425423">&#34;invalid&nbsp;magic&nbsp;number&#34;</span><span class="op" id="6425445">,</span>&nbsp;<span class="ident" id="6425447">nil</span><span class="op" id="6425450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425454">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425460">offset</span>&nbsp;<span class="op" id="6425467">:=</span>&nbsp;<span class="ident" id="6425470">int64</span><span class="op" id="6425475">(</span><span class="num" id="6425476">4</span><span class="op" id="6425477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6425481">//&nbsp;Read&nbsp;the&nbsp;number&nbsp;of&nbsp;FatArchHeaders&nbsp;that&nbsp;come&nbsp;after&nbsp;the&nbsp;fat_header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425551">var</span>&nbsp;<span class="ident" id="6425555">narch</span>&nbsp;<span class="builtintype" id="6425561">uint32</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425569">err</span>&nbsp;<span class="op" id="6425573">=</span>&nbsp;<span class="ident" id="6425575">binary</span><span class="op" id="6425581">.</span><span class="ident" id="6425582">Read</span><span class="op" id="6425586">(</span><span class="ident" id="6425587">sr</span><span class="op" id="6425589">,</span>&nbsp;<span class="ident" id="6425591">binary</span><span class="op" id="6425597">.</span><span class="ident" id="6425598">BigEndian</span><span class="op" id="6425607">,</span>&nbsp;<span class="op" id="6425609">&amp;</span><span class="ident" id="6425610">narch</span><span class="op" id="6425615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425618">if</span>&nbsp;<span class="ident" id="6425621">err</span>&nbsp;<span class="op" id="6425625">!=</span>&nbsp;<span class="ident" id="6425628">nil</span>&nbsp;<span class="op" id="6425632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425636">return</span>&nbsp;<span class="ident" id="6425643">nil</span><span class="op" id="6425646">,</span>&nbsp;<span class="op" id="6425648">&amp;</span><span class="ident" id="6425649">FormatError</span><span class="op" id="6425660">{</span><span class="ident" id="6425661">offset</span><span class="op" id="6425667">,</span>&nbsp;<span class="string" id="6425669">&#34;invalid&nbsp;fat_header&#34;</span><span class="op" id="6425689">,</span>&nbsp;<span class="ident" id="6425691">nil</span><span class="op" id="6425694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425700">offset</span>&nbsp;<span class="op" id="6425707">+=</span>&nbsp;<span class="num" id="6425710">4</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425714">if</span>&nbsp;<span class="ident" id="6425717">narch</span>&nbsp;<span class="op" id="6425723">&lt;</span>&nbsp;<span class="num" id="6425725">1</span>&nbsp;<span class="op" id="6425727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6425731">return</span>&nbsp;<span class="ident" id="6425738">nil</span><span class="op" id="6425741">,</span>&nbsp;<span class="op" id="6425743">&amp;</span><span class="ident" id="6425744">FormatError</span><span class="op" id="6425755">{</span><span class="ident" id="6425756">offset</span><span class="op" id="6425762">,</span>&nbsp;<span class="string" id="6425764">&#34;file&nbsp;contains&nbsp;no&nbsp;images&#34;</span><span class="op" id="6425789">,</span>&nbsp;<span class="ident" id="6425791">nil</span><span class="op" id="6425794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6425797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6425801">//&nbsp;Combine&nbsp;the&nbsp;Cpu&nbsp;and&nbsp;SubCpu&nbsp;(both&nbsp;uint32)&nbsp;into&nbsp;a&nbsp;uint64&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6425873">//&nbsp;there&nbsp;are&nbsp;not&nbsp;duplicate&nbsp;architectures.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6425916">seenArches</span>&nbsp;<span class="op" id="6425927">:=</span>&nbsp;<span class="builtinfunc" id="6425930">make</span><span class="op" id="6425934">(</span><span class="keyword" id="6425935">map</span><span class="op" id="6425938">[</span><span class="ident" id="6425939">uint64</span><span class="op" id="6425945">]</span><span class="builtintype" id="6425946">bool</span><span class="op" id="6425950">,</span>&nbsp;<span class="ident" id="6425952">narch</span><span class="op" id="6425957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6425960">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;all&nbsp;images&nbsp;are&nbsp;for&nbsp;the&nbsp;same&nbsp;MH_&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426017">var</span>&nbsp;<span class="ident" id="6426021">machoType</span>&nbsp;<span class="ident" id="6426031">Type</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6426038">//&nbsp;Following&nbsp;the&nbsp;fat_header&nbsp;comes&nbsp;narch&nbsp;fat_arch&nbsp;structs&nbsp;that&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6426107">//&nbsp;Mach-O&nbsp;images&nbsp;further&nbsp;in&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426146">ff</span><span class="op" id="6426148">.</span><span class="ident" id="6426149">Arches</span>&nbsp;<span class="op" id="6426156">=</span>&nbsp;<span class="builtinfunc" id="6426158">make</span><span class="op" id="6426162">(</span><span class="op" id="6426163">[</span><span class="op" id="6426164">]</span><span class="ident" id="6426165">FatArch</span><span class="op" id="6426172">,</span>&nbsp;<span class="ident" id="6426174">narch</span><span class="op" id="6426179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426182">for</span>&nbsp;<span class="ident" id="6426186">i</span>&nbsp;<span class="op" id="6426188">:=</span>&nbsp;<span class="builtintype" id="6426191">uint32</span><span class="op" id="6426197">(</span><span class="num" id="6426198">0</span><span class="op" id="6426199">)</span><span class="op" id="6426200">;</span>&nbsp;<span class="ident" id="6426202">i</span>&nbsp;<span class="op" id="6426204">&lt;</span>&nbsp;<span class="ident" id="6426206">narch</span><span class="op" id="6426211">;</span>&nbsp;<span class="ident" id="6426213">i</span><span class="op" id="6426214">++</span>&nbsp;<span class="op" id="6426217">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426221">fa</span>&nbsp;<span class="op" id="6426224">:=</span>&nbsp;<span class="op" id="6426227">&amp;</span><span class="ident" id="6426228">ff</span><span class="op" id="6426230">.</span><span class="ident" id="6426231">Arches</span><span class="op" id="6426237">[</span><span class="ident" id="6426238">i</span><span class="op" id="6426239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426243">err</span>&nbsp;<span class="op" id="6426247">=</span>&nbsp;<span class="ident" id="6426249">binary</span><span class="op" id="6426255">.</span><span class="ident" id="6426256">Read</span><span class="op" id="6426260">(</span><span class="ident" id="6426261">sr</span><span class="op" id="6426263">,</span>&nbsp;<span class="ident" id="6426265">binary</span><span class="op" id="6426271">.</span><span class="ident" id="6426272">BigEndian</span><span class="op" id="6426281">,</span>&nbsp;<span class="op" id="6426283">&amp;</span><span class="ident" id="6426284">fa</span><span class="op" id="6426286">.</span><span class="ident" id="6426287">FatArchHeader</span><span class="op" id="6426300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426304">if</span>&nbsp;<span class="ident" id="6426307">err</span>&nbsp;<span class="op" id="6426311">!=</span>&nbsp;<span class="ident" id="6426314">nil</span>&nbsp;<span class="op" id="6426318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426323">return</span>&nbsp;<span class="ident" id="6426330">nil</span><span class="op" id="6426333">,</span>&nbsp;<span class="op" id="6426335">&amp;</span><span class="ident" id="6426336">FormatError</span><span class="op" id="6426347">{</span><span class="ident" id="6426348">offset</span><span class="op" id="6426354">,</span>&nbsp;<span class="string" id="6426356">&#34;invalid&nbsp;fat_arch&nbsp;header&#34;</span><span class="op" id="6426381">,</span>&nbsp;<span class="ident" id="6426383">nil</span><span class="op" id="6426386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426390">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426394">offset</span>&nbsp;<span class="op" id="6426401">+=</span>&nbsp;<span class="ident" id="6426404">fatArchHeaderSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426425">fr</span>&nbsp;<span class="op" id="6426428">:=</span>&nbsp;<span class="ident" id="6426431">io</span><span class="op" id="6426433">.</span><span class="ident" id="6426434">NewSectionReader</span><span class="op" id="6426450">(</span><span class="ident" id="6426451">r</span><span class="op" id="6426452">,</span>&nbsp;<span class="ident" id="6426454">int64</span><span class="op" id="6426459">(</span><span class="ident" id="6426460">fa</span><span class="op" id="6426462">.</span><span class="ident" id="6426463">Offset</span><span class="op" id="6426469">)</span><span class="op" id="6426470">,</span>&nbsp;<span class="ident" id="6426472">int64</span><span class="op" id="6426477">(</span><span class="ident" id="6426478">fa</span><span class="op" id="6426480">.</span><span class="ident" id="6426481">Size</span><span class="op" id="6426485">)</span><span class="op" id="6426486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426490">fa</span><span class="op" id="6426492">.</span><span class="ident" id="6426493">File</span><span class="op" id="6426497">,</span>&nbsp;<span class="ident" id="6426499">err</span>&nbsp;<span class="op" id="6426503">=</span>&nbsp;<span class="ident" id="6426505">NewFile</span><span class="op" id="6426512">(</span><span class="ident" id="6426513">fr</span><span class="op" id="6426515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426519">if</span>&nbsp;<span class="ident" id="6426522">err</span>&nbsp;<span class="op" id="6426526">!=</span>&nbsp;<span class="ident" id="6426529">nil</span>&nbsp;<span class="op" id="6426533">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426538">return</span>&nbsp;<span class="ident" id="6426545">nil</span><span class="op" id="6426548">,</span>&nbsp;<span class="ident" id="6426550">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6426561">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;architecture&nbsp;for&nbsp;this&nbsp;image&nbsp;is&nbsp;not&nbsp;duplicate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426626">seenArch</span>&nbsp;<span class="op" id="6426635">:=</span>&nbsp;<span class="op" id="6426638">(</span><span class="ident" id="6426639">uint64</span><span class="op" id="6426645">(</span><span class="ident" id="6426646">fa</span><span class="op" id="6426648">.</span><span class="ident" id="6426649">Cpu</span><span class="op" id="6426652">)</span>&nbsp;<span class="op" id="6426654">&lt;&lt;</span>&nbsp;<span class="num" id="6426657">32</span><span class="op" id="6426659">)</span>&nbsp;<span class="op" id="6426661">|</span>&nbsp;<span class="ident" id="6426663">uint64</span><span class="op" id="6426669">(</span><span class="ident" id="6426670">fa</span><span class="op" id="6426672">.</span><span class="ident" id="6426673">SubCpu</span><span class="op" id="6426679">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426683">if</span>&nbsp;<span class="ident" id="6426686">o</span><span class="op" id="6426687">,</span>&nbsp;<span class="ident" id="6426689">k</span>&nbsp;<span class="op" id="6426691">:=</span>&nbsp;<span class="ident" id="6426694">seenArches</span><span class="op" id="6426704">[</span><span class="ident" id="6426705">seenArch</span><span class="op" id="6426713">]</span><span class="op" id="6426714">;</span>&nbsp;<span class="ident" id="6426716">o</span>&nbsp;<span class="op" id="6426718">||</span>&nbsp;<span class="ident" id="6426721">k</span>&nbsp;<span class="op" id="6426723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426728">return</span>&nbsp;<span class="ident" id="6426735">nil</span><span class="op" id="6426738">,</span>&nbsp;<span class="op" id="6426740">&amp;</span><span class="ident" id="6426741">FormatError</span><span class="op" id="6426752">{</span><span class="ident" id="6426753">offset</span><span class="op" id="6426759">,</span>&nbsp;<span class="ident" id="6426761">fmt</span><span class="op" id="6426764">.</span><span class="ident" id="6426765">Sprintf</span><span class="op" id="6426772">(</span><span class="string" id="6426773">&#34;duplicate&nbsp;architecture&nbsp;cpu=%v,&nbsp;subcpu=%#x&#34;</span><span class="op" id="6426816">,</span>&nbsp;<span class="ident" id="6426818">fa</span><span class="op" id="6426820">.</span><span class="ident" id="6426821">Cpu</span><span class="op" id="6426824">,</span>&nbsp;<span class="ident" id="6426826">fa</span><span class="op" id="6426828">.</span><span class="ident" id="6426829">SubCpu</span><span class="op" id="6426835">)</span><span class="op" id="6426836">,</span>&nbsp;<span class="ident" id="6426838">nil</span><span class="op" id="6426841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426849">seenArches</span><span class="op" id="6426859">[</span><span class="ident" id="6426860">seenArch</span><span class="op" id="6426868">]</span>&nbsp;<span class="op" id="6426870">=</span>&nbsp;<span class="builtintype" id="6426872">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6426880">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;Mach-O&nbsp;type&nbsp;matches&nbsp;that&nbsp;of&nbsp;the&nbsp;first&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426944">if</span>&nbsp;<span class="ident" id="6426947">i</span>&nbsp;<span class="op" id="6426949">==</span>&nbsp;<span class="num" id="6426952">0</span>&nbsp;<span class="op" id="6426954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6426959">machoType</span>&nbsp;<span class="op" id="6426969">=</span>&nbsp;<span class="ident" id="6426971">fa</span><span class="op" id="6426973">.</span><span class="ident" id="6426974">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6426981">}</span>&nbsp;<span class="keyword" id="6426983">else</span>&nbsp;<span class="op" id="6426988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6426993">if</span>&nbsp;<span class="ident" id="6426996">fa</span><span class="op" id="6426998">.</span><span class="ident" id="6426999">Type</span>&nbsp;<span class="op" id="6427004">!=</span>&nbsp;<span class="ident" id="6427007">machoType</span>&nbsp;<span class="op" id="6427017">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427023">return</span>&nbsp;<span class="ident" id="6427030">nil</span><span class="op" id="6427033">,</span>&nbsp;<span class="op" id="6427035">&amp;</span><span class="ident" id="6427036">FormatError</span><span class="op" id="6427047">{</span><span class="ident" id="6427048">offset</span><span class="op" id="6427054">,</span>&nbsp;<span class="ident" id="6427056">fmt</span><span class="op" id="6427059">.</span><span class="ident" id="6427060">Sprintf</span><span class="op" id="6427067">(</span><span class="string" id="6427068">&#34;Mach-O&nbsp;type&nbsp;for&nbsp;architecture&nbsp;#%d&nbsp;(type=%#x)&nbsp;does&nbsp;not&nbsp;match&nbsp;first&nbsp;(type=%#x)&#34;</span><span class="op" id="6427145">,</span>&nbsp;<span class="ident" id="6427147">i</span><span class="op" id="6427148">,</span>&nbsp;<span class="ident" id="6427150">fa</span><span class="op" id="6427152">.</span><span class="ident" id="6427153">Type</span><span class="op" id="6427157">,</span>&nbsp;<span class="ident" id="6427159">machoType</span><span class="op" id="6427168">)</span><span class="op" id="6427169">,</span>&nbsp;<span class="ident" id="6427171">nil</span><span class="op" id="6427174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427190">return</span>&nbsp;<span class="op" id="6427197">&amp;</span><span class="ident" id="6427198">ff</span><span class="op" id="6427200">,</span>&nbsp;<span class="ident" id="6427202">nil</span><br>
<span class="lineno"></span><span class="op" id="6427206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6427209">//&nbsp;OpenFat&nbsp;opens&nbsp;the&nbsp;named&nbsp;file&nbsp;using&nbsp;os.Open&nbsp;and&nbsp;prepares&nbsp;it&nbsp;for&nbsp;use&nbsp;as&nbsp;a&nbsp;Mach-O</span><br>
<span class="lineno"></span><span class="comment" id="6427291">//&nbsp;universal&nbsp;binary.</span><br>
<span class="lineno">125</span><span class="keyword" id="6427312">func</span>&nbsp;<span class="ident" id="6427317">OpenFat</span><span class="op" id="6427324">(</span><span class="ident" id="6427325">name</span>&nbsp;<span class="builtintype" id="6427330">string</span><span class="op" id="6427336">)</span>&nbsp;<span class="op" id="6427338">(</span><span class="ident" id="6427339">ff</span>&nbsp;<span class="op" id="6427342">*</span><span class="ident" id="6427343">FatFile</span><span class="op" id="6427350">,</span>&nbsp;<span class="ident" id="6427352">err</span>&nbsp;<span class="builtintype" id="6427356">error</span><span class="op" id="6427361">)</span>&nbsp;<span class="op" id="6427363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427366">f</span><span class="op" id="6427367">,</span>&nbsp;<span class="ident" id="6427369">err</span>&nbsp;<span class="op" id="6427373">:=</span>&nbsp;<span class="ident" id="6427376">os</span><span class="op" id="6427378">.</span><span class="ident" id="6427379">Open</span><span class="op" id="6427383">(</span><span class="ident" id="6427384">name</span><span class="op" id="6427388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427391">if</span>&nbsp;<span class="ident" id="6427394">err</span>&nbsp;<span class="op" id="6427398">!=</span>&nbsp;<span class="ident" id="6427401">nil</span>&nbsp;<span class="op" id="6427405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427409">return</span>&nbsp;<span class="ident" id="6427416">nil</span><span class="op" id="6427419">,</span>&nbsp;<span class="ident" id="6427421">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427426">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427429">ff</span><span class="op" id="6427431">,</span>&nbsp;<span class="ident" id="6427433">err</span>&nbsp;<span class="op" id="6427437">=</span>&nbsp;<span class="ident" id="6427439">NewFatFile</span><span class="op" id="6427449">(</span><span class="ident" id="6427450">f</span><span class="op" id="6427451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427454">if</span>&nbsp;<span class="ident" id="6427457">err</span>&nbsp;<span class="op" id="6427461">!=</span>&nbsp;<span class="ident" id="6427464">nil</span>&nbsp;<span class="op" id="6427468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427472">f</span><span class="op" id="6427473">.</span><span class="ident" id="6427474">Close</span><span class="op" id="6427479">(</span><span class="op" id="6427480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427484">return</span>&nbsp;<span class="ident" id="6427491">nil</span><span class="op" id="6427494">,</span>&nbsp;<span class="ident" id="6427496">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427501">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427504">ff</span><span class="op" id="6427506">.</span><span class="ident" id="6427507">closer</span>&nbsp;<span class="op" id="6427514">=</span>&nbsp;<span class="ident" id="6427516">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427519">return</span><br>
<span class="lineno"></span><span class="op" id="6427526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6427529">func</span>&nbsp;<span class="op" id="6427534">(</span><span class="ident" id="6427535">ff</span>&nbsp;<span class="op" id="6427538">*</span><span class="ident" id="6427539">FatFile</span><span class="op" id="6427546">)</span>&nbsp;<span class="ident" id="6427548">Close</span><span class="op" id="6427553">(</span><span class="op" id="6427554">)</span>&nbsp;<span class="builtintype" id="6427556">error</span>&nbsp;<span class="op" id="6427562">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427565">var</span>&nbsp;<span class="ident" id="6427569">err</span>&nbsp;<span class="builtintype" id="6427573">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427580">if</span>&nbsp;<span class="ident" id="6427583">ff</span><span class="op" id="6427585">.</span><span class="ident" id="6427586">closer</span>&nbsp;<span class="op" id="6427593">!=</span>&nbsp;<span class="ident" id="6427596">nil</span>&nbsp;<span class="op" id="6427600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427604">err</span>&nbsp;<span class="op" id="6427608">=</span>&nbsp;<span class="ident" id="6427610">ff</span><span class="op" id="6427612">.</span><span class="ident" id="6427613">closer</span><span class="op" id="6427619">.</span><span class="ident" id="6427620">Close</span><span class="op" id="6427625">(</span><span class="op" id="6427626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6427630">ff</span><span class="op" id="6427632">.</span><span class="ident" id="6427633">closer</span>&nbsp;<span class="op" id="6427640">=</span>&nbsp;<span class="ident" id="6427642">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6427647">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6427650">return</span>&nbsp;<span class="ident" id="6427657">err</span><br>
<span class="lineno"></span><span class="op" id="6427661">}</span>
</div>
</body>
</html>
