<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8043993">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8044048">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8044102">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8044153">package</span>&nbsp;<span class="ident" id="8044161">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8044167">import</span>&nbsp;<span class="op" id="8044174">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044177">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044186">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044195">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044209">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044224">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044230">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044237">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044254">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044265">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8044276">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8044283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8044286">type</span>&nbsp;<span class="ident" id="8044291">authTest</span>&nbsp;<span class="keyword" id="8044300">struct</span>&nbsp;<span class="op" id="8044307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044310">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044321">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044327">challenges</span>&nbsp;<span class="op" id="8044338">[</span><span class="op" id="8044339">]</span><span class="builtintype" id="8044340">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044348">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8044359">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044367">responses</span>&nbsp;&nbsp;<span class="op" id="8044378">[</span><span class="op" id="8044379">]</span><span class="builtintype" id="8044380">string</span><br>
<span class="lineno">25</span><span class="op" id="8044387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8044390">var</span>&nbsp;<span class="ident" id="8044394">authTests</span>&nbsp;<span class="op" id="8044404">=</span>&nbsp;<span class="op" id="8044406">[</span><span class="op" id="8044407">]</span><span class="ident" id="8044408">authTest</span><span class="op" id="8044416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044419">{</span><span class="ident" id="8044420">PlainAuth</span><span class="op" id="8044429">(</span><span class="string" id="8044430">&#34;&#34;</span><span class="op" id="8044432">,</span>&nbsp;<span class="string" id="8044434">&#34;user&#34;</span><span class="op" id="8044440">,</span>&nbsp;<span class="string" id="8044442">&#34;pass&#34;</span><span class="op" id="8044448">,</span>&nbsp;<span class="string" id="8044450">&#34;testserver&#34;</span><span class="op" id="8044462">)</span><span class="op" id="8044463">,</span>&nbsp;<span class="op" id="8044465">[</span><span class="op" id="8044466">]</span><span class="builtintype" id="8044467">string</span><span class="op" id="8044473">{</span><span class="op" id="8044474">}</span><span class="op" id="8044475">,</span>&nbsp;<span class="string" id="8044477">&#34;PLAIN&#34;</span><span class="op" id="8044484">,</span>&nbsp;<span class="op" id="8044486">[</span><span class="op" id="8044487">]</span><span class="builtintype" id="8044488">string</span><span class="op" id="8044494">{</span><span class="string" id="8044495">&#34;\x00user\x00pass&#34;</span><span class="op" id="8044513">}</span><span class="op" id="8044514">}</span><span class="op" id="8044515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044518">{</span><span class="ident" id="8044519">PlainAuth</span><span class="op" id="8044528">(</span><span class="string" id="8044529">&#34;foo&#34;</span><span class="op" id="8044534">,</span>&nbsp;<span class="string" id="8044536">&#34;bar&#34;</span><span class="op" id="8044541">,</span>&nbsp;<span class="string" id="8044543">&#34;baz&#34;</span><span class="op" id="8044548">,</span>&nbsp;<span class="string" id="8044550">&#34;testserver&#34;</span><span class="op" id="8044562">)</span><span class="op" id="8044563">,</span>&nbsp;<span class="op" id="8044565">[</span><span class="op" id="8044566">]</span><span class="builtintype" id="8044567">string</span><span class="op" id="8044573">{</span><span class="op" id="8044574">}</span><span class="op" id="8044575">,</span>&nbsp;<span class="string" id="8044577">&#34;PLAIN&#34;</span><span class="op" id="8044584">,</span>&nbsp;<span class="op" id="8044586">[</span><span class="op" id="8044587">]</span><span class="builtintype" id="8044588">string</span><span class="op" id="8044594">{</span><span class="string" id="8044595">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="8044614">}</span><span class="op" id="8044615">}</span><span class="op" id="8044616">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044619">{</span><span class="ident" id="8044620">CRAMMD5Auth</span><span class="op" id="8044631">(</span><span class="string" id="8044632">&#34;user&#34;</span><span class="op" id="8044638">,</span>&nbsp;<span class="string" id="8044640">&#34;pass&#34;</span><span class="op" id="8044646">)</span><span class="op" id="8044647">,</span>&nbsp;<span class="op" id="8044649">[</span><span class="op" id="8044650">]</span><span class="builtintype" id="8044651">string</span><span class="op" id="8044657">{</span><span class="string" id="8044658">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="8044690">}</span><span class="op" id="8044691">,</span>&nbsp;<span class="string" id="8044693">&#34;CRAM-MD5&#34;</span><span class="op" id="8044703">,</span>&nbsp;<span class="op" id="8044705">[</span><span class="op" id="8044706">]</span><span class="builtintype" id="8044707">string</span><span class="op" id="8044713">{</span><span class="string" id="8044714">&#34;&#34;</span><span class="op" id="8044716">,</span>&nbsp;<span class="string" id="8044718">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="8044757">}</span><span class="op" id="8044758">}</span><span class="op" id="8044759">,</span><br>
<span class="lineno"></span><span class="op" id="8044761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8044764">func</span>&nbsp;<span class="ident" id="8044769">TestAuth</span><span class="op" id="8044777">(</span><span class="ident" id="8044778">t</span>&nbsp;<span class="op" id="8044780">*</span><span class="ident" id="8044781">testing</span><span class="op" id="8044788">.</span><span class="ident" id="8044789">T</span><span class="op" id="8044790">)</span>&nbsp;<span class="op" id="8044792">{</span><br>
<span class="lineno"></span><span class="ident" id="8044794">testLoop</span><span class="op" id="8044802">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044805">for</span>&nbsp;<span class="ident" id="8044809">i</span><span class="op" id="8044810">,</span>&nbsp;<span class="ident" id="8044812">test</span>&nbsp;<span class="op" id="8044817">:=</span>&nbsp;<span class="keyword" id="8044820">range</span>&nbsp;<span class="ident" id="8044826">authTests</span>&nbsp;<span class="op" id="8044836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044840">name</span><span class="op" id="8044844">,</span>&nbsp;<span class="ident" id="8044846">resp</span><span class="op" id="8044850">,</span>&nbsp;<span class="ident" id="8044852">err</span>&nbsp;<span class="op" id="8044856">:=</span>&nbsp;<span class="ident" id="8044859">test</span><span class="op" id="8044863">.</span><span class="ident" id="8044864">auth</span><span class="op" id="8044868">.</span><span class="ident" id="8044869">Start</span><span class="op" id="8044874">(</span><span class="op" id="8044875">&amp;</span><span class="ident" id="8044876">ServerInfo</span><span class="op" id="8044886">{</span><span class="string" id="8044887">&#34;testserver&#34;</span><span class="op" id="8044899">,</span>&nbsp;<span class="ident" id="8044901">true</span><span class="op" id="8044905">,</span>&nbsp;<span class="ident" id="8044907">nil</span><span class="op" id="8044910">}</span><span class="op" id="8044911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044915">if</span>&nbsp;<span class="ident" id="8044918">name</span>&nbsp;<span class="op" id="8044923">!=</span>&nbsp;<span class="ident" id="8044926">test</span><span class="op" id="8044930">.</span><span class="ident" id="8044931">name</span>&nbsp;<span class="op" id="8044936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044941">t</span><span class="op" id="8044942">.</span><span class="ident" id="8044943">Errorf</span><span class="op" id="8044949">(</span><span class="string" id="8044950">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8044980">,</span>&nbsp;<span class="ident" id="8044982">i</span><span class="op" id="8044983">,</span>&nbsp;<span class="ident" id="8044985">name</span><span class="op" id="8044989">,</span>&nbsp;<span class="ident" id="8044991">test</span><span class="op" id="8044995">.</span><span class="ident" id="8044996">name</span><span class="op" id="8045000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045004">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045008">if</span>&nbsp;<span class="op" id="8045011">!</span><span class="ident" id="8045012">bytes</span><span class="op" id="8045017">.</span><span class="ident" id="8045018">Equal</span><span class="op" id="8045023">(</span><span class="ident" id="8045024">resp</span><span class="op" id="8045028">,</span>&nbsp;<span class="op" id="8045030">[</span><span class="op" id="8045031">]</span><span class="builtintype" id="8045032">byte</span><span class="op" id="8045036">(</span><span class="ident" id="8045037">test</span><span class="op" id="8045041">.</span><span class="ident" id="8045042">responses</span><span class="op" id="8045051">[</span><span class="num" id="8045052">0</span><span class="op" id="8045053">]</span><span class="op" id="8045054">)</span><span class="op" id="8045055">)</span>&nbsp;<span class="op" id="8045057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045062">t</span><span class="op" id="8045063">.</span><span class="ident" id="8045064">Errorf</span><span class="op" id="8045070">(</span><span class="string" id="8045071">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8045105">,</span>&nbsp;<span class="ident" id="8045107">i</span><span class="op" id="8045108">,</span>&nbsp;<span class="ident" id="8045110">resp</span><span class="op" id="8045114">,</span>&nbsp;<span class="ident" id="8045116">test</span><span class="op" id="8045120">.</span><span class="ident" id="8045121">responses</span><span class="op" id="8045130">[</span><span class="num" id="8045131">0</span><span class="op" id="8045132">]</span><span class="op" id="8045133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045141">if</span>&nbsp;<span class="ident" id="8045144">err</span>&nbsp;<span class="op" id="8045148">!=</span>&nbsp;<span class="ident" id="8045151">nil</span>&nbsp;<span class="op" id="8045155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045160">t</span><span class="op" id="8045161">.</span><span class="ident" id="8045162">Errorf</span><span class="op" id="8045168">(</span><span class="string" id="8045169">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8045184">,</span>&nbsp;<span class="ident" id="8045186">i</span><span class="op" id="8045187">,</span>&nbsp;<span class="ident" id="8045189">err</span><span class="op" id="8045192">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045200">for</span>&nbsp;<span class="ident" id="8045204">j</span>&nbsp;<span class="op" id="8045206">:=</span>&nbsp;<span class="keyword" id="8045209">range</span>&nbsp;<span class="ident" id="8045215">test</span><span class="op" id="8045219">.</span><span class="ident" id="8045220">challenges</span>&nbsp;<span class="op" id="8045231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045236">challenge</span>&nbsp;<span class="op" id="8045246">:=</span>&nbsp;<span class="op" id="8045249">[</span><span class="op" id="8045250">]</span><span class="builtintype" id="8045251">byte</span><span class="op" id="8045255">(</span><span class="ident" id="8045256">test</span><span class="op" id="8045260">.</span><span class="ident" id="8045261">challenges</span><span class="op" id="8045271">[</span><span class="ident" id="8045272">j</span><span class="op" id="8045273">]</span><span class="op" id="8045274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045279">expected</span>&nbsp;<span class="op" id="8045288">:=</span>&nbsp;<span class="op" id="8045291">[</span><span class="op" id="8045292">]</span><span class="builtintype" id="8045293">byte</span><span class="op" id="8045297">(</span><span class="ident" id="8045298">test</span><span class="op" id="8045302">.</span><span class="ident" id="8045303">responses</span><span class="op" id="8045312">[</span><span class="ident" id="8045313">j</span><span class="op" id="8045314">+</span><span class="num" id="8045315">1</span><span class="op" id="8045316">]</span><span class="op" id="8045317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045322">resp</span><span class="op" id="8045326">,</span>&nbsp;<span class="ident" id="8045328">err</span>&nbsp;<span class="op" id="8045332">:=</span>&nbsp;<span class="ident" id="8045335">test</span><span class="op" id="8045339">.</span><span class="ident" id="8045340">auth</span><span class="op" id="8045344">.</span><span class="ident" id="8045345">Next</span><span class="op" id="8045349">(</span><span class="ident" id="8045350">challenge</span><span class="op" id="8045359">,</span>&nbsp;<span class="ident" id="8045361">true</span><span class="op" id="8045365">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045370">if</span>&nbsp;<span class="ident" id="8045373">err</span>&nbsp;<span class="op" id="8045377">!=</span>&nbsp;<span class="ident" id="8045380">nil</span>&nbsp;<span class="op" id="8045384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045390">t</span><span class="op" id="8045391">.</span><span class="ident" id="8045392">Errorf</span><span class="op" id="8045398">(</span><span class="string" id="8045399">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8045414">,</span>&nbsp;<span class="ident" id="8045416">i</span><span class="op" id="8045417">,</span>&nbsp;<span class="ident" id="8045419">err</span><span class="op" id="8045422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045428">continue</span>&nbsp;<span class="ident" id="8045437">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045454">if</span>&nbsp;<span class="op" id="8045457">!</span><span class="ident" id="8045458">bytes</span><span class="op" id="8045463">.</span><span class="ident" id="8045464">Equal</span><span class="op" id="8045469">(</span><span class="ident" id="8045470">resp</span><span class="op" id="8045474">,</span>&nbsp;<span class="ident" id="8045476">expected</span><span class="op" id="8045484">)</span>&nbsp;<span class="op" id="8045486">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045492">t</span><span class="op" id="8045493">.</span><span class="ident" id="8045494">Errorf</span><span class="op" id="8045500">(</span><span class="string" id="8045501">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8045526">,</span>&nbsp;<span class="ident" id="8045528">i</span><span class="op" id="8045529">,</span>&nbsp;<span class="ident" id="8045531">resp</span><span class="op" id="8045535">,</span>&nbsp;<span class="ident" id="8045537">expected</span><span class="op" id="8045545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045551">continue</span>&nbsp;<span class="ident" id="8045560">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045579">}</span><br>
<span class="lineno">60</span><span class="op" id="8045581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8045584">func</span>&nbsp;<span class="ident" id="8045589">TestAuthPlain</span><span class="op" id="8045602">(</span><span class="ident" id="8045603">t</span>&nbsp;<span class="op" id="8045605">*</span><span class="ident" id="8045606">testing</span><span class="op" id="8045613">.</span><span class="ident" id="8045614">T</span><span class="op" id="8045615">)</span>&nbsp;<span class="op" id="8045617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045620">auth</span>&nbsp;<span class="op" id="8045625">:=</span>&nbsp;<span class="ident" id="8045628">PlainAuth</span><span class="op" id="8045637">(</span><span class="string" id="8045638">&#34;foo&#34;</span><span class="op" id="8045643">,</span>&nbsp;<span class="string" id="8045645">&#34;bar&#34;</span><span class="op" id="8045650">,</span>&nbsp;<span class="string" id="8045652">&#34;baz&#34;</span><span class="op" id="8045657">,</span>&nbsp;<span class="string" id="8045659">&#34;servername&#34;</span><span class="op" id="8045671">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045675">tests</span>&nbsp;<span class="op" id="8045681">:=</span>&nbsp;<span class="op" id="8045684">[</span><span class="op" id="8045685">]</span><span class="keyword" id="8045686">struct</span>&nbsp;<span class="op" id="8045693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045697">server</span>&nbsp;<span class="op" id="8045704">*</span><span class="ident" id="8045705">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045718">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8045725">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045733">}</span><span class="op" id="8045734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045738">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045743">server</span><span class="op" id="8045749">:</span>&nbsp;<span class="op" id="8045751">&amp;</span><span class="ident" id="8045752">ServerInfo</span><span class="op" id="8045762">{</span><span class="ident" id="8045763">Name</span><span class="op" id="8045767">:</span>&nbsp;<span class="string" id="8045769">&#34;servername&#34;</span><span class="op" id="8045781">,</span>&nbsp;<span class="ident" id="8045783">TLS</span><span class="op" id="8045786">:</span>&nbsp;<span class="ident" id="8045788">true</span><span class="op" id="8045792">}</span><span class="op" id="8045793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045797">}</span><span class="op" id="8045798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8045807">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045852">server</span><span class="op" id="8045858">:</span>&nbsp;<span class="op" id="8045860">&amp;</span><span class="ident" id="8045861">ServerInfo</span><span class="op" id="8045871">{</span><span class="ident" id="8045872">Name</span><span class="op" id="8045876">:</span>&nbsp;<span class="string" id="8045878">&#34;servername&#34;</span><span class="op" id="8045890">,</span>&nbsp;<span class="ident" id="8045892">Auth</span><span class="op" id="8045896">:</span>&nbsp;<span class="op" id="8045898">[</span><span class="op" id="8045899">]</span><span class="builtintype" id="8045900">string</span><span class="op" id="8045906">{</span><span class="string" id="8045907">&#34;PLAIN&#34;</span><span class="op" id="8045914">}</span><span class="op" id="8045915">}</span><span class="op" id="8045916">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045920">}</span><span class="op" id="8045921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045930">server</span><span class="op" id="8045936">:</span>&nbsp;<span class="op" id="8045938">&amp;</span><span class="ident" id="8045939">ServerInfo</span><span class="op" id="8045949">{</span><span class="ident" id="8045950">Name</span><span class="op" id="8045954">:</span>&nbsp;<span class="string" id="8045956">&#34;servername&#34;</span><span class="op" id="8045968">,</span>&nbsp;<span class="ident" id="8045970">Auth</span><span class="op" id="8045974">:</span>&nbsp;<span class="op" id="8045976">[</span><span class="op" id="8045977">]</span><span class="builtintype" id="8045978">string</span><span class="op" id="8045984">{</span><span class="string" id="8045985">&#34;CRAM-MD5&#34;</span><span class="op" id="8045995">}</span><span class="op" id="8045996">}</span><span class="op" id="8045997">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046002">err</span><span class="op" id="8046005">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8046010">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="8046034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046038">}</span><span class="op" id="8046039">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046048">server</span><span class="op" id="8046054">:</span>&nbsp;<span class="op" id="8046056">&amp;</span><span class="ident" id="8046057">ServerInfo</span><span class="op" id="8046067">{</span><span class="ident" id="8046068">Name</span><span class="op" id="8046072">:</span>&nbsp;<span class="string" id="8046074">&#34;attacker&#34;</span><span class="op" id="8046084">,</span>&nbsp;<span class="ident" id="8046086">TLS</span><span class="op" id="8046089">:</span>&nbsp;<span class="ident" id="8046091">true</span><span class="op" id="8046095">}</span><span class="op" id="8046096">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046101">err</span><span class="op" id="8046104">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8046109">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="8046126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046130">}</span><span class="op" id="8046131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046134">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046137">for</span>&nbsp;<span class="ident" id="8046141">i</span><span class="op" id="8046142">,</span>&nbsp;<span class="ident" id="8046144">tt</span>&nbsp;<span class="op" id="8046147">:=</span>&nbsp;<span class="keyword" id="8046150">range</span>&nbsp;<span class="ident" id="8046156">tests</span>&nbsp;<span class="op" id="8046162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046166">_</span><span class="op" id="8046167">,</span>&nbsp;<span class="ident" id="8046169">_</span><span class="op" id="8046170">,</span>&nbsp;<span class="ident" id="8046172">err</span>&nbsp;<span class="op" id="8046176">:=</span>&nbsp;<span class="ident" id="8046179">auth</span><span class="op" id="8046183">.</span><span class="ident" id="8046184">Start</span><span class="op" id="8046189">(</span><span class="ident" id="8046190">tt</span><span class="op" id="8046192">.</span><span class="ident" id="8046193">server</span><span class="op" id="8046199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046203">got</span>&nbsp;<span class="op" id="8046207">:=</span>&nbsp;<span class="string" id="8046210">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046215">if</span>&nbsp;<span class="ident" id="8046218">err</span>&nbsp;<span class="op" id="8046222">!=</span>&nbsp;<span class="ident" id="8046225">nil</span>&nbsp;<span class="op" id="8046229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046234">got</span>&nbsp;<span class="op" id="8046238">=</span>&nbsp;<span class="ident" id="8046240">err</span><span class="op" id="8046243">.</span><span class="ident" id="8046244">Error</span><span class="op" id="8046249">(</span><span class="op" id="8046250">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046258">if</span>&nbsp;<span class="ident" id="8046261">got</span>&nbsp;<span class="op" id="8046265">!=</span>&nbsp;<span class="ident" id="8046268">tt</span><span class="op" id="8046270">.</span><span class="ident" id="8046271">err</span>&nbsp;<span class="op" id="8046275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046280">t</span><span class="op" id="8046281">.</span><span class="ident" id="8046282">Errorf</span><span class="op" id="8046288">(</span><span class="string" id="8046289">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8046318">,</span>&nbsp;<span class="ident" id="8046320">i</span><span class="op" id="8046321">,</span>&nbsp;<span class="ident" id="8046323">got</span><span class="op" id="8046326">,</span>&nbsp;<span class="ident" id="8046328">tt</span><span class="op" id="8046330">.</span><span class="ident" id="8046331">err</span><span class="op" id="8046334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046341">}</span><br>
<span class="lineno">95</span><span class="op" id="8046343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8046346">type</span>&nbsp;<span class="ident" id="8046351">faker</span>&nbsp;<span class="keyword" id="8046357">struct</span>&nbsp;<span class="op" id="8046364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046367">io</span><span class="op" id="8046369">.</span><span class="ident" id="8046370">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="8046381">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8046384">func</span>&nbsp;<span class="op" id="8046389">(</span><span class="ident" id="8046390">f</span>&nbsp;<span class="ident" id="8046392">faker</span><span class="op" id="8046397">)</span>&nbsp;<span class="ident" id="8046399">Close</span><span class="op" id="8046404">(</span><span class="op" id="8046405">)</span>&nbsp;<span class="builtintype" id="8046407">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046433">{</span>&nbsp;<span class="keyword" id="8046435">return</span>&nbsp;<span class="ident" id="8046442">nil</span>&nbsp;<span class="op" id="8046446">}</span><br>
<span class="lineno"></span><span class="keyword" id="8046448">func</span>&nbsp;<span class="op" id="8046453">(</span><span class="ident" id="8046454">f</span>&nbsp;<span class="ident" id="8046456">faker</span><span class="op" id="8046461">)</span>&nbsp;<span class="ident" id="8046463">LocalAddr</span><span class="op" id="8046472">(</span><span class="op" id="8046473">)</span>&nbsp;<span class="ident" id="8046475">net</span><span class="op" id="8046478">.</span><span class="ident" id="8046479">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046497">{</span>&nbsp;<span class="keyword" id="8046499">return</span>&nbsp;<span class="ident" id="8046506">nil</span>&nbsp;<span class="op" id="8046510">}</span><br>
<span class="lineno"></span><span class="keyword" id="8046512">func</span>&nbsp;<span class="op" id="8046517">(</span><span class="ident" id="8046518">f</span>&nbsp;<span class="ident" id="8046520">faker</span><span class="op" id="8046525">)</span>&nbsp;<span class="ident" id="8046527">RemoteAddr</span><span class="op" id="8046537">(</span><span class="op" id="8046538">)</span>&nbsp;<span class="ident" id="8046540">net</span><span class="op" id="8046543">.</span><span class="ident" id="8046544">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046561">{</span>&nbsp;<span class="keyword" id="8046563">return</span>&nbsp;<span class="ident" id="8046570">nil</span>&nbsp;<span class="op" id="8046574">}</span><br>
<span class="lineno"></span><span class="keyword" id="8046576">func</span>&nbsp;<span class="op" id="8046581">(</span><span class="ident" id="8046582">f</span>&nbsp;<span class="ident" id="8046584">faker</span><span class="op" id="8046589">)</span>&nbsp;<span class="ident" id="8046591">SetDeadline</span><span class="op" id="8046602">(</span><span class="ident" id="8046603">time</span><span class="op" id="8046607">.</span><span class="ident" id="8046608">Time</span><span class="op" id="8046612">)</span>&nbsp;<span class="builtintype" id="8046614">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046625">{</span>&nbsp;<span class="keyword" id="8046627">return</span>&nbsp;<span class="ident" id="8046634">nil</span>&nbsp;<span class="op" id="8046638">}</span><br>
<span class="lineno">105</span><span class="keyword" id="8046640">func</span>&nbsp;<span class="op" id="8046645">(</span><span class="ident" id="8046646">f</span>&nbsp;<span class="ident" id="8046648">faker</span><span class="op" id="8046653">)</span>&nbsp;<span class="ident" id="8046655">SetReadDeadline</span><span class="op" id="8046670">(</span><span class="ident" id="8046671">time</span><span class="op" id="8046675">.</span><span class="ident" id="8046676">Time</span><span class="op" id="8046680">)</span>&nbsp;<span class="builtintype" id="8046682">error</span>&nbsp;&nbsp;<span class="op" id="8046689">{</span>&nbsp;<span class="keyword" id="8046691">return</span>&nbsp;<span class="ident" id="8046698">nil</span>&nbsp;<span class="op" id="8046702">}</span><br>
<span class="lineno"></span><span class="keyword" id="8046704">func</span>&nbsp;<span class="op" id="8046709">(</span><span class="ident" id="8046710">f</span>&nbsp;<span class="ident" id="8046712">faker</span><span class="op" id="8046717">)</span>&nbsp;<span class="ident" id="8046719">SetWriteDeadline</span><span class="op" id="8046735">(</span><span class="ident" id="8046736">time</span><span class="op" id="8046740">.</span><span class="ident" id="8046741">Time</span><span class="op" id="8046745">)</span>&nbsp;<span class="builtintype" id="8046747">error</span>&nbsp;<span class="op" id="8046753">{</span>&nbsp;<span class="keyword" id="8046755">return</span>&nbsp;<span class="ident" id="8046762">nil</span>&nbsp;<span class="op" id="8046766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8046769">func</span>&nbsp;<span class="ident" id="8046774">TestBasic</span><span class="op" id="8046783">(</span><span class="ident" id="8046784">t</span>&nbsp;<span class="op" id="8046786">*</span><span class="ident" id="8046787">testing</span><span class="op" id="8046794">.</span><span class="ident" id="8046795">T</span><span class="op" id="8046796">)</span>&nbsp;<span class="op" id="8046798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046801">server</span>&nbsp;<span class="op" id="8046808">:=</span>&nbsp;<span class="ident" id="8046811">strings</span><span class="op" id="8046818">.</span><span class="ident" id="8046819">Join</span><span class="op" id="8046823">(</span><span class="ident" id="8046824">strings</span><span class="op" id="8046831">.</span><span class="ident" id="8046832">Split</span><span class="op" id="8046837">(</span><span class="ident" id="8046838">basicServer</span><span class="op" id="8046849">,</span>&nbsp;<span class="string" id="8046851">&#34;\n&#34;</span><span class="op" id="8046855">)</span><span class="op" id="8046856">,</span>&nbsp;<span class="string" id="8046858">&#34;\r\n&#34;</span><span class="op" id="8046864">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046867">client</span>&nbsp;<span class="op" id="8046874">:=</span>&nbsp;<span class="ident" id="8046877">strings</span><span class="op" id="8046884">.</span><span class="ident" id="8046885">Join</span><span class="op" id="8046889">(</span><span class="ident" id="8046890">strings</span><span class="op" id="8046897">.</span><span class="ident" id="8046898">Split</span><span class="op" id="8046903">(</span><span class="ident" id="8046904">basicClient</span><span class="op" id="8046915">,</span>&nbsp;<span class="string" id="8046917">&#34;\n&#34;</span><span class="op" id="8046921">)</span><span class="op" id="8046922">,</span>&nbsp;<span class="string" id="8046924">&#34;\r\n&#34;</span><span class="op" id="8046930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046934">var</span>&nbsp;<span class="ident" id="8046938">cmdbuf</span>&nbsp;<span class="ident" id="8046945">bytes</span><span class="op" id="8046950">.</span><span class="ident" id="8046951">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046959">bcmdbuf</span>&nbsp;<span class="op" id="8046967">:=</span>&nbsp;<span class="ident" id="8046970">bufio</span><span class="op" id="8046975">.</span><span class="ident" id="8046976">NewWriter</span><span class="op" id="8046985">(</span><span class="op" id="8046986">&amp;</span><span class="ident" id="8046987">cmdbuf</span><span class="op" id="8046993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046996">var</span>&nbsp;<span class="ident" id="8047000">fake</span>&nbsp;<span class="ident" id="8047005">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047012">fake</span><span class="op" id="8047016">.</span><span class="ident" id="8047017">ReadWriter</span>&nbsp;<span class="op" id="8047028">=</span>&nbsp;<span class="ident" id="8047030">bufio</span><span class="op" id="8047035">.</span><span class="ident" id="8047036">NewReadWriter</span><span class="op" id="8047049">(</span><span class="ident" id="8047050">bufio</span><span class="op" id="8047055">.</span><span class="ident" id="8047056">NewReader</span><span class="op" id="8047065">(</span><span class="ident" id="8047066">strings</span><span class="op" id="8047073">.</span><span class="ident" id="8047074">NewReader</span><span class="op" id="8047083">(</span><span class="ident" id="8047084">server</span><span class="op" id="8047090">)</span><span class="op" id="8047091">)</span><span class="op" id="8047092">,</span>&nbsp;<span class="ident" id="8047094">bcmdbuf</span><span class="op" id="8047101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047104">c</span>&nbsp;<span class="op" id="8047106">:=</span>&nbsp;<span class="op" id="8047109">&amp;</span><span class="ident" id="8047110">Client</span><span class="op" id="8047116">{</span><span class="ident" id="8047117">Text</span><span class="op" id="8047121">:</span>&nbsp;<span class="ident" id="8047123">textproto</span><span class="op" id="8047132">.</span><span class="ident" id="8047133">NewConn</span><span class="op" id="8047140">(</span><span class="ident" id="8047141">fake</span><span class="op" id="8047145">)</span><span class="op" id="8047146">,</span>&nbsp;<span class="ident" id="8047148">localName</span><span class="op" id="8047157">:</span>&nbsp;<span class="string" id="8047159">&#34;localhost&#34;</span><span class="op" id="8047170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047174">if</span>&nbsp;<span class="ident" id="8047177">err</span>&nbsp;<span class="op" id="8047181">:=</span>&nbsp;<span class="ident" id="8047184">c</span><span class="op" id="8047185">.</span><span class="ident" id="8047186">helo</span><span class="op" id="8047190">(</span><span class="op" id="8047191">)</span><span class="op" id="8047192">;</span>&nbsp;<span class="ident" id="8047194">err</span>&nbsp;<span class="op" id="8047198">!=</span>&nbsp;<span class="ident" id="8047201">nil</span>&nbsp;<span class="op" id="8047205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047209">t</span><span class="op" id="8047210">.</span><span class="ident" id="8047211">Fatalf</span><span class="op" id="8047217">(</span><span class="string" id="8047218">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8047235">,</span>&nbsp;<span class="ident" id="8047237">err</span><span class="op" id="8047240">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047246">if</span>&nbsp;<span class="ident" id="8047249">err</span>&nbsp;<span class="op" id="8047253">:=</span>&nbsp;<span class="ident" id="8047256">c</span><span class="op" id="8047257">.</span><span class="ident" id="8047258">ehlo</span><span class="op" id="8047262">(</span><span class="op" id="8047263">)</span><span class="op" id="8047264">;</span>&nbsp;<span class="ident" id="8047266">err</span>&nbsp;<span class="op" id="8047270">==</span>&nbsp;<span class="ident" id="8047273">nil</span>&nbsp;<span class="op" id="8047277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047281">t</span><span class="op" id="8047282">.</span><span class="ident" id="8047283">Fatalf</span><span class="op" id="8047289">(</span><span class="string" id="8047290">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="8047319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047325">if</span>&nbsp;<span class="ident" id="8047328">err</span>&nbsp;<span class="op" id="8047332">:=</span>&nbsp;<span class="ident" id="8047335">c</span><span class="op" id="8047336">.</span><span class="ident" id="8047337">ehlo</span><span class="op" id="8047341">(</span><span class="op" id="8047342">)</span><span class="op" id="8047343">;</span>&nbsp;<span class="ident" id="8047345">err</span>&nbsp;<span class="op" id="8047349">!=</span>&nbsp;<span class="ident" id="8047352">nil</span>&nbsp;<span class="op" id="8047356">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047360">t</span><span class="op" id="8047361">.</span><span class="ident" id="8047362">Fatalf</span><span class="op" id="8047368">(</span><span class="string" id="8047369">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8047393">,</span>&nbsp;<span class="ident" id="8047395">err</span><span class="op" id="8047398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047405">c</span><span class="op" id="8047406">.</span><span class="ident" id="8047407">didHello</span>&nbsp;<span class="op" id="8047416">=</span>&nbsp;<span class="ident" id="8047418">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047424">if</span>&nbsp;<span class="ident" id="8047427">ok</span><span class="op" id="8047429">,</span>&nbsp;<span class="ident" id="8047431">args</span>&nbsp;<span class="op" id="8047436">:=</span>&nbsp;<span class="ident" id="8047439">c</span><span class="op" id="8047440">.</span><span class="ident" id="8047441">Extension</span><span class="op" id="8047450">(</span><span class="string" id="8047451">&#34;aUtH&#34;</span><span class="op" id="8047457">)</span><span class="op" id="8047458">;</span>&nbsp;<span class="op" id="8047460">!</span><span class="ident" id="8047461">ok</span>&nbsp;<span class="op" id="8047464">||</span>&nbsp;<span class="ident" id="8047467">args</span>&nbsp;<span class="op" id="8047472">!=</span>&nbsp;<span class="string" id="8047475">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8047489">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047493">t</span><span class="op" id="8047494">.</span><span class="ident" id="8047495">Fatalf</span><span class="op" id="8047501">(</span><span class="string" id="8047502">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8047527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047533">if</span>&nbsp;<span class="ident" id="8047536">ok</span><span class="op" id="8047538">,</span>&nbsp;<span class="ident" id="8047540">_</span>&nbsp;<span class="op" id="8047542">:=</span>&nbsp;<span class="ident" id="8047545">c</span><span class="op" id="8047546">.</span><span class="ident" id="8047547">Extension</span><span class="op" id="8047556">(</span><span class="string" id="8047557">&#34;DSN&#34;</span><span class="op" id="8047562">)</span><span class="op" id="8047563">;</span>&nbsp;<span class="ident" id="8047565">ok</span>&nbsp;<span class="op" id="8047568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047572">t</span><span class="op" id="8047573">.</span><span class="ident" id="8047574">Fatalf</span><span class="op" id="8047580">(</span><span class="string" id="8047581">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8047604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047607">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047611">if</span>&nbsp;<span class="ident" id="8047614">err</span>&nbsp;<span class="op" id="8047618">:=</span>&nbsp;<span class="ident" id="8047621">c</span><span class="op" id="8047622">.</span><span class="ident" id="8047623">Mail</span><span class="op" id="8047627">(</span><span class="string" id="8047628">&#34;user@gmail.com&#34;</span><span class="op" id="8047644">)</span><span class="op" id="8047645">;</span>&nbsp;<span class="ident" id="8047647">err</span>&nbsp;<span class="op" id="8047651">==</span>&nbsp;<span class="ident" id="8047654">nil</span>&nbsp;<span class="op" id="8047658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047662">t</span><span class="op" id="8047663">.</span><span class="ident" id="8047664">Fatalf</span><span class="op" id="8047670">(</span><span class="string" id="8047671">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="8047707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047714">if</span>&nbsp;<span class="ident" id="8047717">err</span>&nbsp;<span class="op" id="8047721">:=</span>&nbsp;<span class="ident" id="8047724">c</span><span class="op" id="8047725">.</span><span class="ident" id="8047726">Verify</span><span class="op" id="8047732">(</span><span class="string" id="8047733">&#34;user1@gmail.com&#34;</span><span class="op" id="8047750">)</span><span class="op" id="8047751">;</span>&nbsp;<span class="ident" id="8047753">err</span>&nbsp;<span class="op" id="8047757">==</span>&nbsp;<span class="ident" id="8047760">nil</span>&nbsp;<span class="op" id="8047764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047768">t</span><span class="op" id="8047769">.</span><span class="ident" id="8047770">Fatalf</span><span class="op" id="8047776">(</span><span class="string" id="8047777">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="8047815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8047821">if</span>&nbsp;<span class="ident" id="8047824">err</span>&nbsp;<span class="op" id="8047828">:=</span>&nbsp;<span class="ident" id="8047831">c</span><span class="op" id="8047832">.</span><span class="ident" id="8047833">Verify</span><span class="op" id="8047839">(</span><span class="string" id="8047840">&#34;user2@gmail.com&#34;</span><span class="op" id="8047857">)</span><span class="op" id="8047858">;</span>&nbsp;<span class="ident" id="8047860">err</span>&nbsp;<span class="op" id="8047864">!=</span>&nbsp;<span class="ident" id="8047867">nil</span>&nbsp;<span class="op" id="8047871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047875">t</span><span class="op" id="8047876">.</span><span class="ident" id="8047877">Fatalf</span><span class="op" id="8047883">(</span><span class="string" id="8047884">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="8047928">,</span>&nbsp;<span class="ident" id="8047930">err</span><span class="op" id="8047933">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8047936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8047940">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8047986">c</span><span class="op" id="8047987">.</span><span class="ident" id="8047988">tls</span>&nbsp;<span class="op" id="8047992">=</span>&nbsp;<span class="ident" id="8047994">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048000">c</span><span class="op" id="8048001">.</span><span class="ident" id="8048002">serverName</span>&nbsp;<span class="op" id="8048013">=</span>&nbsp;<span class="string" id="8048015">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048034">if</span>&nbsp;<span class="ident" id="8048037">err</span>&nbsp;<span class="op" id="8048041">:=</span>&nbsp;<span class="ident" id="8048044">c</span><span class="op" id="8048045">.</span><span class="ident" id="8048046">Auth</span><span class="op" id="8048050">(</span><span class="ident" id="8048051">PlainAuth</span><span class="op" id="8048060">(</span><span class="string" id="8048061">&#34;&#34;</span><span class="op" id="8048063">,</span>&nbsp;<span class="string" id="8048065">&#34;user&#34;</span><span class="op" id="8048071">,</span>&nbsp;<span class="string" id="8048073">&#34;pass&#34;</span><span class="op" id="8048079">,</span>&nbsp;<span class="string" id="8048081">&#34;smtp.google.com&#34;</span><span class="op" id="8048098">)</span><span class="op" id="8048099">)</span><span class="op" id="8048100">;</span>&nbsp;<span class="ident" id="8048102">err</span>&nbsp;<span class="op" id="8048106">!=</span>&nbsp;<span class="ident" id="8048109">nil</span>&nbsp;<span class="op" id="8048113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048117">t</span><span class="op" id="8048118">.</span><span class="ident" id="8048119">Fatalf</span><span class="op" id="8048125">(</span><span class="string" id="8048126">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8048143">,</span>&nbsp;<span class="ident" id="8048145">err</span><span class="op" id="8048148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048155">if</span>&nbsp;<span class="ident" id="8048158">err</span>&nbsp;<span class="op" id="8048162">:=</span>&nbsp;<span class="ident" id="8048165">c</span><span class="op" id="8048166">.</span><span class="ident" id="8048167">Mail</span><span class="op" id="8048171">(</span><span class="string" id="8048172">&#34;user@gmail.com&#34;</span><span class="op" id="8048188">)</span><span class="op" id="8048189">;</span>&nbsp;<span class="ident" id="8048191">err</span>&nbsp;<span class="op" id="8048195">!=</span>&nbsp;<span class="ident" id="8048198">nil</span>&nbsp;<span class="op" id="8048202">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048206">t</span><span class="op" id="8048207">.</span><span class="ident" id="8048208">Fatalf</span><span class="op" id="8048214">(</span><span class="string" id="8048215">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8048232">,</span>&nbsp;<span class="ident" id="8048234">err</span><span class="op" id="8048237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048243">if</span>&nbsp;<span class="ident" id="8048246">err</span>&nbsp;<span class="op" id="8048250">:=</span>&nbsp;<span class="ident" id="8048253">c</span><span class="op" id="8048254">.</span><span class="ident" id="8048255">Rcpt</span><span class="op" id="8048259">(</span><span class="string" id="8048260">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="8048290">)</span><span class="op" id="8048291">;</span>&nbsp;<span class="ident" id="8048293">err</span>&nbsp;<span class="op" id="8048297">!=</span>&nbsp;<span class="ident" id="8048300">nil</span>&nbsp;<span class="op" id="8048304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048308">t</span><span class="op" id="8048309">.</span><span class="ident" id="8048310">Fatalf</span><span class="op" id="8048316">(</span><span class="string" id="8048317">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8048334">,</span>&nbsp;<span class="ident" id="8048336">err</span><span class="op" id="8048339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048342">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048345">msg</span>&nbsp;<span class="op" id="8048349">:=</span>&nbsp;<span class="string" id="8048352">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048469">w</span><span class="op" id="8048470">,</span>&nbsp;<span class="ident" id="8048472">err</span>&nbsp;<span class="op" id="8048476">:=</span>&nbsp;<span class="ident" id="8048479">c</span><span class="op" id="8048480">.</span><span class="ident" id="8048481">Data</span><span class="op" id="8048485">(</span><span class="op" id="8048486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048489">if</span>&nbsp;<span class="ident" id="8048492">err</span>&nbsp;<span class="op" id="8048496">!=</span>&nbsp;<span class="ident" id="8048499">nil</span>&nbsp;<span class="op" id="8048503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048507">t</span><span class="op" id="8048508">.</span><span class="ident" id="8048509">Fatalf</span><span class="op" id="8048515">(</span><span class="string" id="8048516">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8048533">,</span>&nbsp;<span class="ident" id="8048535">err</span><span class="op" id="8048538">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048544">if</span>&nbsp;<span class="ident" id="8048547">_</span><span class="op" id="8048548">,</span>&nbsp;<span class="ident" id="8048550">err</span>&nbsp;<span class="op" id="8048554">:=</span>&nbsp;<span class="ident" id="8048557">w</span><span class="op" id="8048558">.</span><span class="ident" id="8048559">Write</span><span class="op" id="8048564">(</span><span class="op" id="8048565">[</span><span class="op" id="8048566">]</span><span class="builtintype" id="8048567">byte</span><span class="op" id="8048571">(</span><span class="ident" id="8048572">msg</span><span class="op" id="8048575">)</span><span class="op" id="8048576">)</span><span class="op" id="8048577">;</span>&nbsp;<span class="ident" id="8048579">err</span>&nbsp;<span class="op" id="8048583">!=</span>&nbsp;<span class="ident" id="8048586">nil</span>&nbsp;<span class="op" id="8048590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048594">t</span><span class="op" id="8048595">.</span><span class="ident" id="8048596">Fatalf</span><span class="op" id="8048602">(</span><span class="string" id="8048603">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8048626">,</span>&nbsp;<span class="ident" id="8048628">err</span><span class="op" id="8048631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048637">if</span>&nbsp;<span class="ident" id="8048640">err</span>&nbsp;<span class="op" id="8048644">:=</span>&nbsp;<span class="ident" id="8048647">w</span><span class="op" id="8048648">.</span><span class="ident" id="8048649">Close</span><span class="op" id="8048654">(</span><span class="op" id="8048655">)</span><span class="op" id="8048656">;</span>&nbsp;<span class="ident" id="8048658">err</span>&nbsp;<span class="op" id="8048662">!=</span>&nbsp;<span class="ident" id="8048665">nil</span>&nbsp;<span class="op" id="8048669">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048673">t</span><span class="op" id="8048674">.</span><span class="ident" id="8048675">Fatalf</span><span class="op" id="8048681">(</span><span class="string" id="8048682">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="8048705">,</span>&nbsp;<span class="ident" id="8048707">err</span><span class="op" id="8048710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048717">if</span>&nbsp;<span class="ident" id="8048720">err</span>&nbsp;<span class="op" id="8048724">:=</span>&nbsp;<span class="ident" id="8048727">c</span><span class="op" id="8048728">.</span><span class="ident" id="8048729">Quit</span><span class="op" id="8048733">(</span><span class="op" id="8048734">)</span><span class="op" id="8048735">;</span>&nbsp;<span class="ident" id="8048737">err</span>&nbsp;<span class="op" id="8048741">!=</span>&nbsp;<span class="ident" id="8048744">nil</span>&nbsp;<span class="op" id="8048748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048752">t</span><span class="op" id="8048753">.</span><span class="ident" id="8048754">Fatalf</span><span class="op" id="8048760">(</span><span class="string" id="8048761">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8048778">,</span>&nbsp;<span class="ident" id="8048780">err</span><span class="op" id="8048783">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048790">bcmdbuf</span><span class="op" id="8048797">.</span><span class="ident" id="8048798">Flush</span><span class="op" id="8048803">(</span><span class="op" id="8048804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048807">actualcmds</span>&nbsp;<span class="op" id="8048818">:=</span>&nbsp;<span class="ident" id="8048821">cmdbuf</span><span class="op" id="8048827">.</span><span class="ident" id="8048828">String</span><span class="op" id="8048834">(</span><span class="op" id="8048835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8048838">if</span>&nbsp;<span class="ident" id="8048841">client</span>&nbsp;<span class="op" id="8048848">!=</span>&nbsp;<span class="ident" id="8048851">actualcmds</span>&nbsp;<span class="op" id="8048862">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8048866">t</span><span class="op" id="8048867">.</span><span class="ident" id="8048868">Fatalf</span><span class="op" id="8048874">(</span><span class="string" id="8048875">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8048900">,</span>&nbsp;<span class="ident" id="8048902">actualcmds</span><span class="op" id="8048912">,</span>&nbsp;<span class="ident" id="8048914">client</span><span class="op" id="8048920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8048923">}</span><br>
<span class="lineno"></span><span class="op" id="8048925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8048928">var</span>&nbsp;<span class="ident" id="8048932">basicServer</span>&nbsp;<span class="op" id="8048944">=</span>&nbsp;<span class="string" id="8048946">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8049254">var</span>&nbsp;<span class="ident" id="8049258">basicClient</span>&nbsp;<span class="op" id="8049270">=</span>&nbsp;<span class="string" id="8049272">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8049639">func</span>&nbsp;<span class="ident" id="8049644">TestNewClient</span><span class="op" id="8049657">(</span><span class="ident" id="8049658">t</span>&nbsp;<span class="op" id="8049660">*</span><span class="ident" id="8049661">testing</span><span class="op" id="8049668">.</span><span class="ident" id="8049669">T</span><span class="op" id="8049670">)</span>&nbsp;<span class="op" id="8049672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8049675">server</span>&nbsp;<span class="op" id="8049682">:=</span>&nbsp;<span class="ident" id="8049685">strings</span><span class="op" id="8049692">.</span><span class="ident" id="8049693">Join</span><span class="op" id="8049697">(</span><span class="ident" id="8049698">strings</span><span class="op" id="8049705">.</span><span class="ident" id="8049706">Split</span><span class="op" id="8049711">(</span><span class="ident" id="8049712">newClientServer</span><span class="op" id="8049727">,</span>&nbsp;<span class="string" id="8049729">&#34;\n&#34;</span><span class="op" id="8049733">)</span><span class="op" id="8049734">,</span>&nbsp;<span class="string" id="8049736">&#34;\r\n&#34;</span><span class="op" id="8049742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8049745">client</span>&nbsp;<span class="op" id="8049752">:=</span>&nbsp;<span class="ident" id="8049755">strings</span><span class="op" id="8049762">.</span><span class="ident" id="8049763">Join</span><span class="op" id="8049767">(</span><span class="ident" id="8049768">strings</span><span class="op" id="8049775">.</span><span class="ident" id="8049776">Split</span><span class="op" id="8049781">(</span><span class="ident" id="8049782">newClientClient</span><span class="op" id="8049797">,</span>&nbsp;<span class="string" id="8049799">&#34;\n&#34;</span><span class="op" id="8049803">)</span><span class="op" id="8049804">,</span>&nbsp;<span class="string" id="8049806">&#34;\r\n&#34;</span><span class="op" id="8049812">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8049816">var</span>&nbsp;<span class="ident" id="8049820">cmdbuf</span>&nbsp;<span class="ident" id="8049827">bytes</span><span class="op" id="8049832">.</span><span class="ident" id="8049833">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8049841">bcmdbuf</span>&nbsp;<span class="op" id="8049849">:=</span>&nbsp;<span class="ident" id="8049852">bufio</span><span class="op" id="8049857">.</span><span class="ident" id="8049858">NewWriter</span><span class="op" id="8049867">(</span><span class="op" id="8049868">&amp;</span><span class="ident" id="8049869">cmdbuf</span><span class="op" id="8049875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8049878">out</span>&nbsp;<span class="op" id="8049882">:=</span>&nbsp;<span class="keyword" id="8049885">func</span><span class="op" id="8049889">(</span><span class="op" id="8049890">)</span>&nbsp;<span class="builtintype" id="8049892">string</span>&nbsp;<span class="op" id="8049899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8049903">bcmdbuf</span><span class="op" id="8049910">.</span><span class="ident" id="8049911">Flush</span><span class="op" id="8049916">(</span><span class="op" id="8049917">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8049921">return</span>&nbsp;<span class="ident" id="8049928">cmdbuf</span><span class="op" id="8049934">.</span><span class="ident" id="8049935">String</span><span class="op" id="8049941">(</span><span class="op" id="8049942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8049945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8049948">var</span>&nbsp;<span class="ident" id="8049952">fake</span>&nbsp;<span class="ident" id="8049957">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8049964">fake</span><span class="op" id="8049968">.</span><span class="ident" id="8049969">ReadWriter</span>&nbsp;<span class="op" id="8049980">=</span>&nbsp;<span class="ident" id="8049982">bufio</span><span class="op" id="8049987">.</span><span class="ident" id="8049988">NewReadWriter</span><span class="op" id="8050001">(</span><span class="ident" id="8050002">bufio</span><span class="op" id="8050007">.</span><span class="ident" id="8050008">NewReader</span><span class="op" id="8050017">(</span><span class="ident" id="8050018">strings</span><span class="op" id="8050025">.</span><span class="ident" id="8050026">NewReader</span><span class="op" id="8050035">(</span><span class="ident" id="8050036">server</span><span class="op" id="8050042">)</span><span class="op" id="8050043">)</span><span class="op" id="8050044">,</span>&nbsp;<span class="ident" id="8050046">bcmdbuf</span><span class="op" id="8050053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050056">c</span><span class="op" id="8050057">,</span>&nbsp;<span class="ident" id="8050059">err</span>&nbsp;<span class="op" id="8050063">:=</span>&nbsp;<span class="ident" id="8050066">NewClient</span><span class="op" id="8050075">(</span><span class="ident" id="8050076">fake</span><span class="op" id="8050080">,</span>&nbsp;<span class="string" id="8050082">&#34;fake.host&#34;</span><span class="op" id="8050093">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050096">if</span>&nbsp;<span class="ident" id="8050099">err</span>&nbsp;<span class="op" id="8050103">!=</span>&nbsp;<span class="ident" id="8050106">nil</span>&nbsp;<span class="op" id="8050110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050114">t</span><span class="op" id="8050115">.</span><span class="ident" id="8050116">Fatalf</span><span class="op" id="8050122">(</span><span class="string" id="8050123">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="8050150">,</span>&nbsp;<span class="ident" id="8050152">err</span><span class="op" id="8050155">,</span>&nbsp;<span class="ident" id="8050157">out</span><span class="op" id="8050160">(</span><span class="op" id="8050161">)</span><span class="op" id="8050162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8050165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050168">defer</span>&nbsp;<span class="ident" id="8050174">c</span><span class="op" id="8050175">.</span><span class="ident" id="8050176">Close</span><span class="op" id="8050181">(</span><span class="op" id="8050182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050185">if</span>&nbsp;<span class="ident" id="8050188">ok</span><span class="op" id="8050190">,</span>&nbsp;<span class="ident" id="8050192">args</span>&nbsp;<span class="op" id="8050197">:=</span>&nbsp;<span class="ident" id="8050200">c</span><span class="op" id="8050201">.</span><span class="ident" id="8050202">Extension</span><span class="op" id="8050211">(</span><span class="string" id="8050212">&#34;aUtH&#34;</span><span class="op" id="8050218">)</span><span class="op" id="8050219">;</span>&nbsp;<span class="op" id="8050221">!</span><span class="ident" id="8050222">ok</span>&nbsp;<span class="op" id="8050225">||</span>&nbsp;<span class="ident" id="8050228">args</span>&nbsp;<span class="op" id="8050233">!=</span>&nbsp;<span class="string" id="8050236">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8050250">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050254">t</span><span class="op" id="8050255">.</span><span class="ident" id="8050256">Fatalf</span><span class="op" id="8050262">(</span><span class="string" id="8050263">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8050288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8050291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050294">if</span>&nbsp;<span class="ident" id="8050297">ok</span><span class="op" id="8050299">,</span>&nbsp;<span class="ident" id="8050301">_</span>&nbsp;<span class="op" id="8050303">:=</span>&nbsp;<span class="ident" id="8050306">c</span><span class="op" id="8050307">.</span><span class="ident" id="8050308">Extension</span><span class="op" id="8050317">(</span><span class="string" id="8050318">&#34;DSN&#34;</span><span class="op" id="8050323">)</span><span class="op" id="8050324">;</span>&nbsp;<span class="ident" id="8050326">ok</span>&nbsp;<span class="op" id="8050329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050333">t</span><span class="op" id="8050334">.</span><span class="ident" id="8050335">Fatalf</span><span class="op" id="8050341">(</span><span class="string" id="8050342">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8050365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8050368">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050371">if</span>&nbsp;<span class="ident" id="8050374">err</span>&nbsp;<span class="op" id="8050378">:=</span>&nbsp;<span class="ident" id="8050381">c</span><span class="op" id="8050382">.</span><span class="ident" id="8050383">Quit</span><span class="op" id="8050387">(</span><span class="op" id="8050388">)</span><span class="op" id="8050389">;</span>&nbsp;<span class="ident" id="8050391">err</span>&nbsp;<span class="op" id="8050395">!=</span>&nbsp;<span class="ident" id="8050398">nil</span>&nbsp;<span class="op" id="8050402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050406">t</span><span class="op" id="8050407">.</span><span class="ident" id="8050408">Fatalf</span><span class="op" id="8050414">(</span><span class="string" id="8050415">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8050432">,</span>&nbsp;<span class="ident" id="8050434">err</span><span class="op" id="8050437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8050440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050444">actualcmds</span>&nbsp;<span class="op" id="8050455">:=</span>&nbsp;<span class="ident" id="8050458">out</span><span class="op" id="8050461">(</span><span class="op" id="8050462">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050465">if</span>&nbsp;<span class="ident" id="8050468">client</span>&nbsp;<span class="op" id="8050475">!=</span>&nbsp;<span class="ident" id="8050478">actualcmds</span>&nbsp;<span class="op" id="8050489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050493">t</span><span class="op" id="8050494">.</span><span class="ident" id="8050495">Fatalf</span><span class="op" id="8050501">(</span><span class="string" id="8050502">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8050527">,</span>&nbsp;<span class="ident" id="8050529">actualcmds</span><span class="op" id="8050539">,</span>&nbsp;<span class="ident" id="8050541">client</span><span class="op" id="8050547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8050550">}</span><br>
<span class="lineno"></span><span class="op" id="8050552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="8050555">var</span>&nbsp;<span class="ident" id="8050559">newClientServer</span>&nbsp;<span class="op" id="8050575">=</span>&nbsp;<span class="string" id="8050577">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8050690">var</span>&nbsp;<span class="ident" id="8050694">newClientClient</span>&nbsp;<span class="op" id="8050710">=</span>&nbsp;<span class="string" id="8050712">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8050736">func</span>&nbsp;<span class="ident" id="8050741">TestNewClient2</span><span class="op" id="8050755">(</span><span class="ident" id="8050756">t</span>&nbsp;<span class="op" id="8050758">*</span><span class="ident" id="8050759">testing</span><span class="op" id="8050766">.</span><span class="ident" id="8050767">T</span><span class="op" id="8050768">)</span>&nbsp;<span class="op" id="8050770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050773">server</span>&nbsp;<span class="op" id="8050780">:=</span>&nbsp;<span class="ident" id="8050783">strings</span><span class="op" id="8050790">.</span><span class="ident" id="8050791">Join</span><span class="op" id="8050795">(</span><span class="ident" id="8050796">strings</span><span class="op" id="8050803">.</span><span class="ident" id="8050804">Split</span><span class="op" id="8050809">(</span><span class="ident" id="8050810">newClient2Server</span><span class="op" id="8050826">,</span>&nbsp;<span class="string" id="8050828">&#34;\n&#34;</span><span class="op" id="8050832">)</span><span class="op" id="8050833">,</span>&nbsp;<span class="string" id="8050835">&#34;\r\n&#34;</span><span class="op" id="8050841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050844">client</span>&nbsp;<span class="op" id="8050851">:=</span>&nbsp;<span class="ident" id="8050854">strings</span><span class="op" id="8050861">.</span><span class="ident" id="8050862">Join</span><span class="op" id="8050866">(</span><span class="ident" id="8050867">strings</span><span class="op" id="8050874">.</span><span class="ident" id="8050875">Split</span><span class="op" id="8050880">(</span><span class="ident" id="8050881">newClient2Client</span><span class="op" id="8050897">,</span>&nbsp;<span class="string" id="8050899">&#34;\n&#34;</span><span class="op" id="8050903">)</span><span class="op" id="8050904">,</span>&nbsp;<span class="string" id="8050906">&#34;\r\n&#34;</span><span class="op" id="8050912">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050916">var</span>&nbsp;<span class="ident" id="8050920">cmdbuf</span>&nbsp;<span class="ident" id="8050927">bytes</span><span class="op" id="8050932">.</span><span class="ident" id="8050933">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050941">bcmdbuf</span>&nbsp;<span class="op" id="8050949">:=</span>&nbsp;<span class="ident" id="8050952">bufio</span><span class="op" id="8050957">.</span><span class="ident" id="8050958">NewWriter</span><span class="op" id="8050967">(</span><span class="op" id="8050968">&amp;</span><span class="ident" id="8050969">cmdbuf</span><span class="op" id="8050975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8050978">var</span>&nbsp;<span class="ident" id="8050982">fake</span>&nbsp;<span class="ident" id="8050987">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8050994">fake</span><span class="op" id="8050998">.</span><span class="ident" id="8050999">ReadWriter</span>&nbsp;<span class="op" id="8051010">=</span>&nbsp;<span class="ident" id="8051012">bufio</span><span class="op" id="8051017">.</span><span class="ident" id="8051018">NewReadWriter</span><span class="op" id="8051031">(</span><span class="ident" id="8051032">bufio</span><span class="op" id="8051037">.</span><span class="ident" id="8051038">NewReader</span><span class="op" id="8051047">(</span><span class="ident" id="8051048">strings</span><span class="op" id="8051055">.</span><span class="ident" id="8051056">NewReader</span><span class="op" id="8051065">(</span><span class="ident" id="8051066">server</span><span class="op" id="8051072">)</span><span class="op" id="8051073">)</span><span class="op" id="8051074">,</span>&nbsp;<span class="ident" id="8051076">bcmdbuf</span><span class="op" id="8051083">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051086">c</span><span class="op" id="8051087">,</span>&nbsp;<span class="ident" id="8051089">err</span>&nbsp;<span class="op" id="8051093">:=</span>&nbsp;<span class="ident" id="8051096">NewClient</span><span class="op" id="8051105">(</span><span class="ident" id="8051106">fake</span><span class="op" id="8051110">,</span>&nbsp;<span class="string" id="8051112">&#34;fake.host&#34;</span><span class="op" id="8051123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051126">if</span>&nbsp;<span class="ident" id="8051129">err</span>&nbsp;<span class="op" id="8051133">!=</span>&nbsp;<span class="ident" id="8051136">nil</span>&nbsp;<span class="op" id="8051140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051144">t</span><span class="op" id="8051145">.</span><span class="ident" id="8051146">Fatalf</span><span class="op" id="8051152">(</span><span class="string" id="8051153">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8051168">,</span>&nbsp;<span class="ident" id="8051170">err</span><span class="op" id="8051173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8051176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051179">defer</span>&nbsp;<span class="ident" id="8051185">c</span><span class="op" id="8051186">.</span><span class="ident" id="8051187">Close</span><span class="op" id="8051192">(</span><span class="op" id="8051193">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051196">if</span>&nbsp;<span class="ident" id="8051199">ok</span><span class="op" id="8051201">,</span>&nbsp;<span class="ident" id="8051203">_</span>&nbsp;<span class="op" id="8051205">:=</span>&nbsp;<span class="ident" id="8051208">c</span><span class="op" id="8051209">.</span><span class="ident" id="8051210">Extension</span><span class="op" id="8051219">(</span><span class="string" id="8051220">&#34;DSN&#34;</span><span class="op" id="8051225">)</span><span class="op" id="8051226">;</span>&nbsp;<span class="ident" id="8051228">ok</span>&nbsp;<span class="op" id="8051231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051235">t</span><span class="op" id="8051236">.</span><span class="ident" id="8051237">Fatalf</span><span class="op" id="8051243">(</span><span class="string" id="8051244">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8051267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8051270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051273">if</span>&nbsp;<span class="ident" id="8051276">err</span>&nbsp;<span class="op" id="8051280">:=</span>&nbsp;<span class="ident" id="8051283">c</span><span class="op" id="8051284">.</span><span class="ident" id="8051285">Quit</span><span class="op" id="8051289">(</span><span class="op" id="8051290">)</span><span class="op" id="8051291">;</span>&nbsp;<span class="ident" id="8051293">err</span>&nbsp;<span class="op" id="8051297">!=</span>&nbsp;<span class="ident" id="8051300">nil</span>&nbsp;<span class="op" id="8051304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051308">t</span><span class="op" id="8051309">.</span><span class="ident" id="8051310">Fatalf</span><span class="op" id="8051316">(</span><span class="string" id="8051317">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8051334">,</span>&nbsp;<span class="ident" id="8051336">err</span><span class="op" id="8051339">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8051342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051346">bcmdbuf</span><span class="op" id="8051353">.</span><span class="ident" id="8051354">Flush</span><span class="op" id="8051359">(</span><span class="op" id="8051360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051363">actualcmds</span>&nbsp;<span class="op" id="8051374">:=</span>&nbsp;<span class="ident" id="8051377">cmdbuf</span><span class="op" id="8051383">.</span><span class="ident" id="8051384">String</span><span class="op" id="8051390">(</span><span class="op" id="8051391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051394">if</span>&nbsp;<span class="ident" id="8051397">client</span>&nbsp;<span class="op" id="8051404">!=</span>&nbsp;<span class="ident" id="8051407">actualcmds</span>&nbsp;<span class="op" id="8051418">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051422">t</span><span class="op" id="8051423">.</span><span class="ident" id="8051424">Fatalf</span><span class="op" id="8051430">(</span><span class="string" id="8051431">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8051456">,</span>&nbsp;<span class="ident" id="8051458">actualcmds</span><span class="op" id="8051468">,</span>&nbsp;<span class="ident" id="8051470">client</span><span class="op" id="8051476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8051479">}</span><br>
<span class="lineno"></span><span class="op" id="8051481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8051484">var</span>&nbsp;<span class="ident" id="8051488">newClient2Server</span>&nbsp;<span class="op" id="8051505">=</span>&nbsp;<span class="string" id="8051507">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8051628">var</span>&nbsp;<span class="ident" id="8051632">newClient2Client</span>&nbsp;<span class="op" id="8051649">=</span>&nbsp;<span class="string" id="8051651">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8051690">func</span>&nbsp;<span class="ident" id="8051695">TestHello</span><span class="op" id="8051704">(</span><span class="ident" id="8051705">t</span>&nbsp;<span class="op" id="8051707">*</span><span class="ident" id="8051708">testing</span><span class="op" id="8051715">.</span><span class="ident" id="8051716">T</span><span class="op" id="8051717">)</span>&nbsp;<span class="op" id="8051719">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051723">if</span>&nbsp;<span class="builtinfunc" id="8051726">len</span><span class="op" id="8051729">(</span><span class="ident" id="8051730">helloServer</span><span class="op" id="8051741">)</span>&nbsp;<span class="op" id="8051743">!=</span>&nbsp;<span class="builtinfunc" id="8051746">len</span><span class="op" id="8051749">(</span><span class="ident" id="8051750">helloClient</span><span class="op" id="8051761">)</span>&nbsp;<span class="op" id="8051763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051767">t</span><span class="op" id="8051768">.</span><span class="ident" id="8051769">Fatalf</span><span class="op" id="8051775">(</span><span class="string" id="8051776">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="8051815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8051818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8051822">for</span>&nbsp;<span class="ident" id="8051826">i</span>&nbsp;<span class="op" id="8051828">:=</span>&nbsp;<span class="num" id="8051831">0</span><span class="op" id="8051832">;</span>&nbsp;<span class="ident" id="8051834">i</span>&nbsp;<span class="op" id="8051836">&lt;</span>&nbsp;<span class="builtinfunc" id="8051838">len</span><span class="op" id="8051841">(</span><span class="ident" id="8051842">helloServer</span><span class="op" id="8051853">)</span><span class="op" id="8051854">;</span>&nbsp;<span class="ident" id="8051856">i</span><span class="op" id="8051857">++</span>&nbsp;<span class="op" id="8051860">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051864">server</span>&nbsp;<span class="op" id="8051871">:=</span>&nbsp;<span class="ident" id="8051874">strings</span><span class="op" id="8051881">.</span><span class="ident" id="8051882">Join</span><span class="op" id="8051886">(</span><span class="ident" id="8051887">strings</span><span class="op" id="8051894">.</span><span class="ident" id="8051895">Split</span><span class="op" id="8051900">(</span><span class="ident" id="8051901">baseHelloServer</span><span class="op" id="8051916">+</span><span class="ident" id="8051917">helloServer</span><span class="op" id="8051928">[</span><span class="ident" id="8051929">i</span><span class="op" id="8051930">]</span><span class="op" id="8051931">,</span>&nbsp;<span class="string" id="8051933">&#34;\n&#34;</span><span class="op" id="8051937">)</span><span class="op" id="8051938">,</span>&nbsp;<span class="string" id="8051940">&#34;\r\n&#34;</span><span class="op" id="8051946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8051950">client</span>&nbsp;<span class="op" id="8051957">:=</span>&nbsp;<span class="ident" id="8051960">strings</span><span class="op" id="8051967">.</span><span class="ident" id="8051968">Join</span><span class="op" id="8051972">(</span><span class="ident" id="8051973">strings</span><span class="op" id="8051980">.</span><span class="ident" id="8051981">Split</span><span class="op" id="8051986">(</span><span class="ident" id="8051987">baseHelloClient</span><span class="op" id="8052002">+</span><span class="ident" id="8052003">helloClient</span><span class="op" id="8052014">[</span><span class="ident" id="8052015">i</span><span class="op" id="8052016">]</span><span class="op" id="8052017">,</span>&nbsp;<span class="string" id="8052019">&#34;\n&#34;</span><span class="op" id="8052023">)</span><span class="op" id="8052024">,</span>&nbsp;<span class="string" id="8052026">&#34;\r\n&#34;</span><span class="op" id="8052032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052036">var</span>&nbsp;<span class="ident" id="8052040">cmdbuf</span>&nbsp;<span class="ident" id="8052047">bytes</span><span class="op" id="8052052">.</span><span class="ident" id="8052053">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052062">bcmdbuf</span>&nbsp;<span class="op" id="8052070">:=</span>&nbsp;<span class="ident" id="8052073">bufio</span><span class="op" id="8052078">.</span><span class="ident" id="8052079">NewWriter</span><span class="op" id="8052088">(</span><span class="op" id="8052089">&amp;</span><span class="ident" id="8052090">cmdbuf</span><span class="op" id="8052096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052100">var</span>&nbsp;<span class="ident" id="8052104">fake</span>&nbsp;<span class="ident" id="8052109">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052117">fake</span><span class="op" id="8052121">.</span><span class="ident" id="8052122">ReadWriter</span>&nbsp;<span class="op" id="8052133">=</span>&nbsp;<span class="ident" id="8052135">bufio</span><span class="op" id="8052140">.</span><span class="ident" id="8052141">NewReadWriter</span><span class="op" id="8052154">(</span><span class="ident" id="8052155">bufio</span><span class="op" id="8052160">.</span><span class="ident" id="8052161">NewReader</span><span class="op" id="8052170">(</span><span class="ident" id="8052171">strings</span><span class="op" id="8052178">.</span><span class="ident" id="8052179">NewReader</span><span class="op" id="8052188">(</span><span class="ident" id="8052189">server</span><span class="op" id="8052195">)</span><span class="op" id="8052196">)</span><span class="op" id="8052197">,</span>&nbsp;<span class="ident" id="8052199">bcmdbuf</span><span class="op" id="8052206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052210">c</span><span class="op" id="8052211">,</span>&nbsp;<span class="ident" id="8052213">err</span>&nbsp;<span class="op" id="8052217">:=</span>&nbsp;<span class="ident" id="8052220">NewClient</span><span class="op" id="8052229">(</span><span class="ident" id="8052230">fake</span><span class="op" id="8052234">,</span>&nbsp;<span class="string" id="8052236">&#34;fake.host&#34;</span><span class="op" id="8052247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052251">if</span>&nbsp;<span class="ident" id="8052254">err</span>&nbsp;<span class="op" id="8052258">!=</span>&nbsp;<span class="ident" id="8052261">nil</span>&nbsp;<span class="op" id="8052265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052270">t</span><span class="op" id="8052271">.</span><span class="ident" id="8052272">Fatalf</span><span class="op" id="8052278">(</span><span class="string" id="8052279">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8052294">,</span>&nbsp;<span class="ident" id="8052296">err</span><span class="op" id="8052299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8052303">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052307">defer</span>&nbsp;<span class="ident" id="8052313">c</span><span class="op" id="8052314">.</span><span class="ident" id="8052315">Close</span><span class="op" id="8052320">(</span><span class="op" id="8052321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052325">c</span><span class="op" id="8052326">.</span><span class="ident" id="8052327">localName</span>&nbsp;<span class="op" id="8052337">=</span>&nbsp;<span class="string" id="8052339">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052354">err</span>&nbsp;<span class="op" id="8052358">=</span>&nbsp;<span class="ident" id="8052360">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052367">switch</span>&nbsp;<span class="ident" id="8052374">i</span>&nbsp;<span class="op" id="8052376">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052380">case</span>&nbsp;<span class="num" id="8052385">0</span><span class="op" id="8052386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052391">err</span>&nbsp;<span class="op" id="8052395">=</span>&nbsp;<span class="ident" id="8052397">c</span><span class="op" id="8052398">.</span><span class="ident" id="8052399">Hello</span><span class="op" id="8052404">(</span><span class="string" id="8052405">&#34;customhost&#34;</span><span class="op" id="8052417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052421">case</span>&nbsp;<span class="num" id="8052426">1</span><span class="op" id="8052427">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052432">err</span>&nbsp;<span class="op" id="8052436">=</span>&nbsp;<span class="ident" id="8052438">c</span><span class="op" id="8052439">.</span><span class="ident" id="8052440">StartTLS</span><span class="op" id="8052448">(</span><span class="ident" id="8052449">nil</span><span class="op" id="8052452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052457">if</span>&nbsp;<span class="ident" id="8052460">err</span><span class="op" id="8052463">.</span><span class="ident" id="8052464">Error</span><span class="op" id="8052469">(</span><span class="op" id="8052470">)</span>&nbsp;<span class="op" id="8052472">==</span>&nbsp;<span class="string" id="8052475">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="8052497">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052503">err</span>&nbsp;<span class="op" id="8052507">=</span>&nbsp;<span class="ident" id="8052509">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8052516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052520">case</span>&nbsp;<span class="num" id="8052525">2</span><span class="op" id="8052526">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052531">err</span>&nbsp;<span class="op" id="8052535">=</span>&nbsp;<span class="ident" id="8052537">c</span><span class="op" id="8052538">.</span><span class="ident" id="8052539">Verify</span><span class="op" id="8052545">(</span><span class="string" id="8052546">&#34;test@example.com&#34;</span><span class="op" id="8052564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052568">case</span>&nbsp;<span class="num" id="8052573">3</span><span class="op" id="8052574">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052579">c</span><span class="op" id="8052580">.</span><span class="ident" id="8052581">tls</span>&nbsp;<span class="op" id="8052585">=</span>&nbsp;<span class="ident" id="8052587">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052595">c</span><span class="op" id="8052596">.</span><span class="ident" id="8052597">serverName</span>&nbsp;<span class="op" id="8052608">=</span>&nbsp;<span class="string" id="8052610">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052631">err</span>&nbsp;<span class="op" id="8052635">=</span>&nbsp;<span class="ident" id="8052637">c</span><span class="op" id="8052638">.</span><span class="ident" id="8052639">Auth</span><span class="op" id="8052643">(</span><span class="ident" id="8052644">PlainAuth</span><span class="op" id="8052653">(</span><span class="string" id="8052654">&#34;&#34;</span><span class="op" id="8052656">,</span>&nbsp;<span class="string" id="8052658">&#34;user&#34;</span><span class="op" id="8052664">,</span>&nbsp;<span class="string" id="8052666">&#34;pass&#34;</span><span class="op" id="8052672">,</span>&nbsp;<span class="string" id="8052674">&#34;smtp.google.com&#34;</span><span class="op" id="8052691">)</span><span class="op" id="8052692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052696">case</span>&nbsp;<span class="num" id="8052701">4</span><span class="op" id="8052702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052707">err</span>&nbsp;<span class="op" id="8052711">=</span>&nbsp;<span class="ident" id="8052713">c</span><span class="op" id="8052714">.</span><span class="ident" id="8052715">Mail</span><span class="op" id="8052719">(</span><span class="string" id="8052720">&#34;test@example.com&#34;</span><span class="op" id="8052738">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052742">case</span>&nbsp;<span class="num" id="8052747">5</span><span class="op" id="8052748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052753">ok</span><span class="op" id="8052755">,</span>&nbsp;<span class="ident" id="8052757">_</span>&nbsp;<span class="op" id="8052759">:=</span>&nbsp;<span class="ident" id="8052762">c</span><span class="op" id="8052763">.</span><span class="ident" id="8052764">Extension</span><span class="op" id="8052773">(</span><span class="string" id="8052774">&#34;feature&#34;</span><span class="op" id="8052783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052788">if</span>&nbsp;<span class="ident" id="8052791">ok</span>&nbsp;<span class="op" id="8052794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052800">t</span><span class="op" id="8052801">.</span><span class="ident" id="8052802">Errorf</span><span class="op" id="8052808">(</span><span class="string" id="8052809">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="8052847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8052852">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052856">case</span>&nbsp;<span class="num" id="8052861">6</span><span class="op" id="8052862">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052867">err</span>&nbsp;<span class="op" id="8052871">=</span>&nbsp;<span class="ident" id="8052873">c</span><span class="op" id="8052874">.</span><span class="ident" id="8052875">Reset</span><span class="op" id="8052880">(</span><span class="op" id="8052881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052885">case</span>&nbsp;<span class="num" id="8052890">7</span><span class="op" id="8052891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052896">err</span>&nbsp;<span class="op" id="8052900">=</span>&nbsp;<span class="ident" id="8052902">c</span><span class="op" id="8052903">.</span><span class="ident" id="8052904">Quit</span><span class="op" id="8052908">(</span><span class="op" id="8052909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052913">case</span>&nbsp;<span class="num" id="8052918">8</span><span class="op" id="8052919">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052924">err</span>&nbsp;<span class="op" id="8052928">=</span>&nbsp;<span class="ident" id="8052930">c</span><span class="op" id="8052931">.</span><span class="ident" id="8052932">Verify</span><span class="op" id="8052938">(</span><span class="string" id="8052939">&#34;test@example.com&#34;</span><span class="op" id="8052957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8052962">if</span>&nbsp;<span class="ident" id="8052965">err</span>&nbsp;<span class="op" id="8052969">!=</span>&nbsp;<span class="ident" id="8052972">nil</span>&nbsp;<span class="op" id="8052976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8052982">err</span>&nbsp;<span class="op" id="8052986">=</span>&nbsp;<span class="ident" id="8052988">c</span><span class="op" id="8052989">.</span><span class="ident" id="8052990">Hello</span><span class="op" id="8052995">(</span><span class="string" id="8052996">&#34;customhost&#34;</span><span class="op" id="8053008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8053014">if</span>&nbsp;<span class="ident" id="8053017">err</span>&nbsp;<span class="op" id="8053021">!=</span>&nbsp;<span class="ident" id="8053024">nil</span>&nbsp;<span class="op" id="8053028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053035">t</span><span class="op" id="8053036">.</span><span class="ident" id="8053037">Errorf</span><span class="op" id="8053043">(</span><span class="string" id="8053044">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="8053066">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8053072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8053077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8053081">default</span><span class="op" id="8053088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053093">t</span><span class="op" id="8053094">.</span><span class="ident" id="8053095">Fatalf</span><span class="op" id="8053101">(</span><span class="string" id="8053102">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="8053121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8053125">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8053130">if</span>&nbsp;<span class="ident" id="8053133">err</span>&nbsp;<span class="op" id="8053137">!=</span>&nbsp;<span class="ident" id="8053140">nil</span>&nbsp;<span class="op" id="8053144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053149">t</span><span class="op" id="8053150">.</span><span class="ident" id="8053151">Errorf</span><span class="op" id="8053157">(</span><span class="string" id="8053158">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8053181">,</span>&nbsp;<span class="ident" id="8053183">i</span><span class="op" id="8053184">,</span>&nbsp;<span class="ident" id="8053186">err</span><span class="op" id="8053189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8053193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053198">bcmdbuf</span><span class="op" id="8053205">.</span><span class="ident" id="8053206">Flush</span><span class="op" id="8053211">(</span><span class="op" id="8053212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053216">actualcmds</span>&nbsp;<span class="op" id="8053227">:=</span>&nbsp;<span class="ident" id="8053230">cmdbuf</span><span class="op" id="8053236">.</span><span class="ident" id="8053237">String</span><span class="op" id="8053243">(</span><span class="op" id="8053244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8053248">if</span>&nbsp;<span class="ident" id="8053251">client</span>&nbsp;<span class="op" id="8053258">!=</span>&nbsp;<span class="ident" id="8053261">actualcmds</span>&nbsp;<span class="op" id="8053272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053277">t</span><span class="op" id="8053278">.</span><span class="ident" id="8053279">Errorf</span><span class="op" id="8053285">(</span><span class="string" id="8053286">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8053311">,</span>&nbsp;<span class="ident" id="8053313">actualcmds</span><span class="op" id="8053323">,</span>&nbsp;<span class="ident" id="8053325">client</span><span class="op" id="8053331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8053335">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8053338">}</span><br>
<span class="lineno"></span><span class="op" id="8053340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8053343">var</span>&nbsp;<span class="ident" id="8053347">baseHelloServer</span>&nbsp;<span class="op" id="8053363">=</span>&nbsp;<span class="string" id="8053365">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8053439">var</span>&nbsp;<span class="ident" id="8053443">helloServer</span>&nbsp;<span class="op" id="8053455">=</span>&nbsp;<span class="op" id="8053457">[</span><span class="op" id="8053458">]</span><span class="builtintype" id="8053459">string</span><span class="op" id="8053465">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053468">&#34;&#34;</span><span class="op" id="8053470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053473">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="8053496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053499">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="8053520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053523">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="8053539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053542">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8053559">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053562">&#34;&#34;</span><span class="op" id="8053564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053567">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="8053583">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053586">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="8053601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053604">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8053621">,</span><br>
<span class="lineno"></span><span class="op" id="8053623">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="8053626">var</span>&nbsp;<span class="ident" id="8053630">baseHelloClient</span>&nbsp;<span class="op" id="8053646">=</span>&nbsp;<span class="string" id="8053648">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="8053684">var</span>&nbsp;<span class="ident" id="8053688">helloClient</span>&nbsp;<span class="op" id="8053700">=</span>&nbsp;<span class="op" id="8053702">[</span><span class="op" id="8053703">]</span><span class="builtintype" id="8053704">string</span><span class="op" id="8053710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053713">&#34;&#34;</span><span class="op" id="8053715">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053718">&#34;STARTTLS\n&#34;</span><span class="op" id="8053730">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053733">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8053758">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053761">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="8053792">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053795">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="8053827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053830">&#34;&#34;</span><span class="op" id="8053832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053835">&#34;RSET\n&#34;</span><span class="op" id="8053843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053846">&#34;QUIT\n&#34;</span><span class="op" id="8053854">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8053857">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8053882">,</span><br>
<span class="lineno">415</span><span class="op" id="8053884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8053887">func</span>&nbsp;<span class="ident" id="8053892">TestSendMail</span><span class="op" id="8053904">(</span><span class="ident" id="8053905">t</span>&nbsp;<span class="op" id="8053907">*</span><span class="ident" id="8053908">testing</span><span class="op" id="8053915">.</span><span class="ident" id="8053916">T</span><span class="op" id="8053917">)</span>&nbsp;<span class="op" id="8053919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053922">server</span>&nbsp;<span class="op" id="8053929">:=</span>&nbsp;<span class="ident" id="8053932">strings</span><span class="op" id="8053939">.</span><span class="ident" id="8053940">Join</span><span class="op" id="8053944">(</span><span class="ident" id="8053945">strings</span><span class="op" id="8053952">.</span><span class="ident" id="8053953">Split</span><span class="op" id="8053958">(</span><span class="ident" id="8053959">sendMailServer</span><span class="op" id="8053973">,</span>&nbsp;<span class="string" id="8053975">&#34;\n&#34;</span><span class="op" id="8053979">)</span><span class="op" id="8053980">,</span>&nbsp;<span class="string" id="8053982">&#34;\r\n&#34;</span><span class="op" id="8053988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8053991">client</span>&nbsp;<span class="op" id="8053998">:=</span>&nbsp;<span class="ident" id="8054001">strings</span><span class="op" id="8054008">.</span><span class="ident" id="8054009">Join</span><span class="op" id="8054013">(</span><span class="ident" id="8054014">strings</span><span class="op" id="8054021">.</span><span class="ident" id="8054022">Split</span><span class="op" id="8054027">(</span><span class="ident" id="8054028">sendMailClient</span><span class="op" id="8054042">,</span>&nbsp;<span class="string" id="8054044">&#34;\n&#34;</span><span class="op" id="8054048">)</span><span class="op" id="8054049">,</span>&nbsp;<span class="string" id="8054051">&#34;\r\n&#34;</span><span class="op" id="8054057">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054060">var</span>&nbsp;<span class="ident" id="8054064">cmdbuf</span>&nbsp;<span class="ident" id="8054071">bytes</span><span class="op" id="8054076">.</span><span class="ident" id="8054077">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054085">bcmdbuf</span>&nbsp;<span class="op" id="8054093">:=</span>&nbsp;<span class="ident" id="8054096">bufio</span><span class="op" id="8054101">.</span><span class="ident" id="8054102">NewWriter</span><span class="op" id="8054111">(</span><span class="op" id="8054112">&amp;</span><span class="ident" id="8054113">cmdbuf</span><span class="op" id="8054119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054122">l</span><span class="op" id="8054123">,</span>&nbsp;<span class="ident" id="8054125">err</span>&nbsp;<span class="op" id="8054129">:=</span>&nbsp;<span class="ident" id="8054132">net</span><span class="op" id="8054135">.</span><span class="ident" id="8054136">Listen</span><span class="op" id="8054142">(</span><span class="string" id="8054143">&#34;tcp&#34;</span><span class="op" id="8054148">,</span>&nbsp;<span class="string" id="8054150">&#34;127.0.0.1:0&#34;</span><span class="op" id="8054163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054166">if</span>&nbsp;<span class="ident" id="8054169">err</span>&nbsp;<span class="op" id="8054173">!=</span>&nbsp;<span class="ident" id="8054176">nil</span>&nbsp;<span class="op" id="8054180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054184">t</span><span class="op" id="8054185">.</span><span class="ident" id="8054186">Fatalf</span><span class="op" id="8054192">(</span><span class="string" id="8054193">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="8054227">,</span>&nbsp;<span class="ident" id="8054229">err</span><span class="op" id="8054232">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8054235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054238">defer</span>&nbsp;<span class="ident" id="8054244">l</span><span class="op" id="8054245">.</span><span class="ident" id="8054246">Close</span><span class="op" id="8054251">(</span><span class="op" id="8054252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8054256">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054289">var</span>&nbsp;<span class="ident" id="8054293">done</span>&nbsp;<span class="op" id="8054298">=</span>&nbsp;<span class="builtinfunc" id="8054300">make</span><span class="op" id="8054304">(</span><span class="keyword" id="8054305">chan</span>&nbsp;<span class="keyword" id="8054310">struct</span><span class="op" id="8054316">{</span><span class="op" id="8054317">}</span><span class="op" id="8054318">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054321">go</span>&nbsp;<span class="keyword" id="8054324">func</span><span class="op" id="8054328">(</span><span class="ident" id="8054329">data</span>&nbsp;<span class="op" id="8054334">[</span><span class="op" id="8054335">]</span><span class="builtintype" id="8054336">string</span><span class="op" id="8054342">)</span>&nbsp;<span class="op" id="8054344">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054349">defer</span>&nbsp;<span class="builtinfunc" id="8054355">close</span><span class="op" id="8054360">(</span><span class="ident" id="8054361">done</span><span class="op" id="8054365">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054370">conn</span><span class="op" id="8054374">,</span>&nbsp;<span class="ident" id="8054376">err</span>&nbsp;<span class="op" id="8054380">:=</span>&nbsp;<span class="ident" id="8054383">l</span><span class="op" id="8054384">.</span><span class="ident" id="8054385">Accept</span><span class="op" id="8054391">(</span><span class="op" id="8054392">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054396">if</span>&nbsp;<span class="ident" id="8054399">err</span>&nbsp;<span class="op" id="8054403">!=</span>&nbsp;<span class="ident" id="8054406">nil</span>&nbsp;<span class="op" id="8054410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054415">t</span><span class="op" id="8054416">.</span><span class="ident" id="8054417">Errorf</span><span class="op" id="8054423">(</span><span class="string" id="8054424">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8054442">,</span>&nbsp;<span class="ident" id="8054444">err</span><span class="op" id="8054447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054452">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8054461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054465">defer</span>&nbsp;<span class="ident" id="8054471">conn</span><span class="op" id="8054475">.</span><span class="ident" id="8054476">Close</span><span class="op" id="8054481">(</span><span class="op" id="8054482">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054487">tc</span>&nbsp;<span class="op" id="8054490">:=</span>&nbsp;<span class="ident" id="8054493">textproto</span><span class="op" id="8054502">.</span><span class="ident" id="8054503">NewConn</span><span class="op" id="8054510">(</span><span class="ident" id="8054511">conn</span><span class="op" id="8054515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054519">for</span>&nbsp;<span class="ident" id="8054523">i</span>&nbsp;<span class="op" id="8054525">:=</span>&nbsp;<span class="num" id="8054528">0</span><span class="op" id="8054529">;</span>&nbsp;<span class="ident" id="8054531">i</span>&nbsp;<span class="op" id="8054533">&lt;</span>&nbsp;<span class="builtinfunc" id="8054535">len</span><span class="op" id="8054538">(</span><span class="ident" id="8054539">data</span><span class="op" id="8054543">)</span>&nbsp;<span class="op" id="8054545">&amp;&amp;</span>&nbsp;<span class="ident" id="8054548">data</span><span class="op" id="8054552">[</span><span class="ident" id="8054553">i</span><span class="op" id="8054554">]</span>&nbsp;<span class="op" id="8054556">!=</span>&nbsp;<span class="string" id="8054559">&#34;&#34;</span><span class="op" id="8054561">;</span>&nbsp;<span class="ident" id="8054563">i</span><span class="op" id="8054564">++</span>&nbsp;<span class="op" id="8054567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054572">tc</span><span class="op" id="8054574">.</span><span class="ident" id="8054575">PrintfLine</span><span class="op" id="8054585">(</span><span class="ident" id="8054586">data</span><span class="op" id="8054590">[</span><span class="ident" id="8054591">i</span><span class="op" id="8054592">]</span><span class="op" id="8054593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054598">for</span>&nbsp;<span class="builtinfunc" id="8054602">len</span><span class="op" id="8054605">(</span><span class="ident" id="8054606">data</span><span class="op" id="8054610">[</span><span class="ident" id="8054611">i</span><span class="op" id="8054612">]</span><span class="op" id="8054613">)</span>&nbsp;<span class="op" id="8054615">&gt;=</span>&nbsp;<span class="num" id="8054618">4</span>&nbsp;<span class="op" id="8054620">&amp;&amp;</span>&nbsp;<span class="ident" id="8054623">data</span><span class="op" id="8054627">[</span><span class="ident" id="8054628">i</span><span class="op" id="8054629">]</span><span class="op" id="8054630">[</span><span class="num" id="8054631">3</span><span class="op" id="8054632">]</span>&nbsp;<span class="op" id="8054634">==</span>&nbsp;<span class="string" id="8054637">&#39;-&#39;</span>&nbsp;<span class="op" id="8054641">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054647">i</span><span class="op" id="8054648">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054655">tc</span><span class="op" id="8054657">.</span><span class="ident" id="8054658">PrintfLine</span><span class="op" id="8054668">(</span><span class="ident" id="8054669">data</span><span class="op" id="8054673">[</span><span class="ident" id="8054674">i</span><span class="op" id="8054675">]</span><span class="op" id="8054676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8054681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054686">if</span>&nbsp;<span class="ident" id="8054689">data</span><span class="op" id="8054693">[</span><span class="ident" id="8054694">i</span><span class="op" id="8054695">]</span>&nbsp;<span class="op" id="8054697">==</span>&nbsp;<span class="string" id="8054700">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="8054714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054720">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8054730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054735">read</span>&nbsp;<span class="op" id="8054740">:=</span>&nbsp;<span class="ident" id="8054743">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054752">for</span>&nbsp;<span class="op" id="8054756">!</span><span class="ident" id="8054757">read</span>&nbsp;<span class="op" id="8054762">||</span>&nbsp;<span class="ident" id="8054765">data</span><span class="op" id="8054769">[</span><span class="ident" id="8054770">i</span><span class="op" id="8054771">]</span>&nbsp;<span class="op" id="8054773">==</span>&nbsp;<span class="string" id="8054776">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8054791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054797">msg</span><span class="op" id="8054800">,</span>&nbsp;<span class="ident" id="8054802">err</span>&nbsp;<span class="op" id="8054806">:=</span>&nbsp;<span class="ident" id="8054809">tc</span><span class="op" id="8054811">.</span><span class="ident" id="8054812">ReadLine</span><span class="op" id="8054820">(</span><span class="op" id="8054821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054827">bcmdbuf</span><span class="op" id="8054834">.</span><span class="ident" id="8054835">Write</span><span class="op" id="8054840">(</span><span class="op" id="8054841">[</span><span class="op" id="8054842">]</span><span class="builtintype" id="8054843">byte</span><span class="op" id="8054847">(</span><span class="ident" id="8054848">msg</span>&nbsp;<span class="op" id="8054852">+</span>&nbsp;<span class="string" id="8054854">&#34;\r\n&#34;</span><span class="op" id="8054860">)</span><span class="op" id="8054861">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054867">read</span>&nbsp;<span class="op" id="8054872">=</span>&nbsp;<span class="ident" id="8054874">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054883">if</span>&nbsp;<span class="ident" id="8054886">err</span>&nbsp;<span class="op" id="8054890">!=</span>&nbsp;<span class="ident" id="8054893">nil</span>&nbsp;<span class="op" id="8054897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8054904">t</span><span class="op" id="8054905">.</span><span class="ident" id="8054906">Errorf</span><span class="op" id="8054912">(</span><span class="string" id="8054913">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8054929">,</span>&nbsp;<span class="ident" id="8054931">err</span><span class="op" id="8054934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054941">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8054952">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8054958">if</span>&nbsp;<span class="ident" id="8054961">data</span><span class="op" id="8054965">[</span><span class="ident" id="8054966">i</span><span class="op" id="8054967">]</span>&nbsp;<span class="op" id="8054969">==</span>&nbsp;<span class="string" id="8054972">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8054987">&amp;&amp;</span>&nbsp;<span class="ident" id="8054990">msg</span>&nbsp;<span class="op" id="8054994">==</span>&nbsp;<span class="string" id="8054997">&#34;.&#34;</span>&nbsp;<span class="op" id="8055001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8055008">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055027">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055030">}</span><span class="op" id="8055031">(</span><span class="ident" id="8055032">strings</span><span class="op" id="8055039">.</span><span class="ident" id="8055040">Split</span><span class="op" id="8055045">(</span><span class="ident" id="8055046">server</span><span class="op" id="8055052">,</span>&nbsp;<span class="string" id="8055054">&#34;\r\n&#34;</span><span class="op" id="8055060">)</span><span class="op" id="8055061">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055065">err</span>&nbsp;<span class="op" id="8055069">=</span>&nbsp;<span class="ident" id="8055071">SendMail</span><span class="op" id="8055079">(</span><span class="ident" id="8055080">l</span><span class="op" id="8055081">.</span><span class="ident" id="8055082">Addr</span><span class="op" id="8055086">(</span><span class="op" id="8055087">)</span><span class="op" id="8055088">.</span><span class="ident" id="8055089">String</span><span class="op" id="8055095">(</span><span class="op" id="8055096">)</span><span class="op" id="8055097">,</span>&nbsp;<span class="ident" id="8055099">nil</span><span class="op" id="8055102">,</span>&nbsp;<span class="string" id="8055104">&#34;test@example.com&#34;</span><span class="op" id="8055122">,</span>&nbsp;<span class="op" id="8055124">[</span><span class="op" id="8055125">]</span><span class="builtintype" id="8055126">string</span><span class="op" id="8055132">{</span><span class="string" id="8055133">&#34;other@example.com&#34;</span><span class="op" id="8055152">}</span><span class="op" id="8055153">,</span>&nbsp;<span class="op" id="8055155">[</span><span class="op" id="8055156">]</span><span class="builtintype" id="8055157">byte</span><span class="op" id="8055161">(</span><span class="ident" id="8055162">strings</span><span class="op" id="8055169">.</span><span class="ident" id="8055170">Replace</span><span class="op" id="8055177">(</span><span class="string" id="8055178">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="8055277">,</span>&nbsp;<span class="string" id="8055279">&#34;\n&#34;</span><span class="op" id="8055283">,</span>&nbsp;<span class="string" id="8055285">&#34;\r\n&#34;</span><span class="op" id="8055291">,</span>&nbsp;<span class="op" id="8055293">-</span><span class="num" id="8055294">1</span><span class="op" id="8055295">)</span><span class="op" id="8055296">)</span><span class="op" id="8055297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8055301">if</span>&nbsp;<span class="ident" id="8055304">err</span>&nbsp;<span class="op" id="8055308">!=</span>&nbsp;<span class="ident" id="8055311">nil</span>&nbsp;<span class="op" id="8055315">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055319">t</span><span class="op" id="8055320">.</span><span class="ident" id="8055321">Errorf</span><span class="op" id="8055327">(</span><span class="string" id="8055328">&#34;%v&#34;</span><span class="op" id="8055332">,</span>&nbsp;<span class="ident" id="8055334">err</span><span class="op" id="8055337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055344">&lt;-</span><span class="ident" id="8055346">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055352">bcmdbuf</span><span class="op" id="8055359">.</span><span class="ident" id="8055360">Flush</span><span class="op" id="8055365">(</span><span class="op" id="8055366">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055369">actualcmds</span>&nbsp;<span class="op" id="8055380">:=</span>&nbsp;<span class="ident" id="8055383">cmdbuf</span><span class="op" id="8055389">.</span><span class="ident" id="8055390">String</span><span class="op" id="8055396">(</span><span class="op" id="8055397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8055400">if</span>&nbsp;<span class="ident" id="8055403">client</span>&nbsp;<span class="op" id="8055410">!=</span>&nbsp;<span class="ident" id="8055413">actualcmds</span>&nbsp;<span class="op" id="8055424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055428">t</span><span class="op" id="8055429">.</span><span class="ident" id="8055430">Errorf</span><span class="op" id="8055436">(</span><span class="string" id="8055437">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8055462">,</span>&nbsp;<span class="ident" id="8055464">actualcmds</span><span class="op" id="8055474">,</span>&nbsp;<span class="ident" id="8055476">client</span><span class="op" id="8055482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8055485">}</span><br>
<span class="lineno"></span><span class="op" id="8055487">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="8055490">var</span>&nbsp;<span class="ident" id="8055494">sendMailServer</span>&nbsp;<span class="op" id="8055509">=</span>&nbsp;<span class="string" id="8055511">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="8055640">var</span>&nbsp;<span class="ident" id="8055644">sendMailClient</span>&nbsp;<span class="op" id="8055659">=</span>&nbsp;<span class="string" id="8055661">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="8055861">func</span>&nbsp;<span class="ident" id="8055866">TestAuthFailed</span><span class="op" id="8055880">(</span><span class="ident" id="8055881">t</span>&nbsp;<span class="op" id="8055883">*</span><span class="ident" id="8055884">testing</span><span class="op" id="8055891">.</span><span class="ident" id="8055892">T</span><span class="op" id="8055893">)</span>&nbsp;<span class="op" id="8055895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055898">server</span>&nbsp;<span class="op" id="8055905">:=</span>&nbsp;<span class="ident" id="8055908">strings</span><span class="op" id="8055915">.</span><span class="ident" id="8055916">Join</span><span class="op" id="8055920">(</span><span class="ident" id="8055921">strings</span><span class="op" id="8055928">.</span><span class="ident" id="8055929">Split</span><span class="op" id="8055934">(</span><span class="ident" id="8055935">authFailedServer</span><span class="op" id="8055951">,</span>&nbsp;<span class="string" id="8055953">&#34;\n&#34;</span><span class="op" id="8055957">)</span><span class="op" id="8055958">,</span>&nbsp;<span class="string" id="8055960">&#34;\r\n&#34;</span><span class="op" id="8055966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8055969">client</span>&nbsp;<span class="op" id="8055976">:=</span>&nbsp;<span class="ident" id="8055979">strings</span><span class="op" id="8055986">.</span><span class="ident" id="8055987">Join</span><span class="op" id="8055991">(</span><span class="ident" id="8055992">strings</span><span class="op" id="8055999">.</span><span class="ident" id="8056000">Split</span><span class="op" id="8056005">(</span><span class="ident" id="8056006">authFailedClient</span><span class="op" id="8056022">,</span>&nbsp;<span class="string" id="8056024">&#34;\n&#34;</span><span class="op" id="8056028">)</span><span class="op" id="8056029">,</span>&nbsp;<span class="string" id="8056031">&#34;\r\n&#34;</span><span class="op" id="8056037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8056040">var</span>&nbsp;<span class="ident" id="8056044">cmdbuf</span>&nbsp;<span class="ident" id="8056051">bytes</span><span class="op" id="8056056">.</span><span class="ident" id="8056057">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056065">bcmdbuf</span>&nbsp;<span class="op" id="8056073">:=</span>&nbsp;<span class="ident" id="8056076">bufio</span><span class="op" id="8056081">.</span><span class="ident" id="8056082">NewWriter</span><span class="op" id="8056091">(</span><span class="op" id="8056092">&amp;</span><span class="ident" id="8056093">cmdbuf</span><span class="op" id="8056099">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8056102">var</span>&nbsp;<span class="ident" id="8056106">fake</span>&nbsp;<span class="ident" id="8056111">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056118">fake</span><span class="op" id="8056122">.</span><span class="ident" id="8056123">ReadWriter</span>&nbsp;<span class="op" id="8056134">=</span>&nbsp;<span class="ident" id="8056136">bufio</span><span class="op" id="8056141">.</span><span class="ident" id="8056142">NewReadWriter</span><span class="op" id="8056155">(</span><span class="ident" id="8056156">bufio</span><span class="op" id="8056161">.</span><span class="ident" id="8056162">NewReader</span><span class="op" id="8056171">(</span><span class="ident" id="8056172">strings</span><span class="op" id="8056179">.</span><span class="ident" id="8056180">NewReader</span><span class="op" id="8056189">(</span><span class="ident" id="8056190">server</span><span class="op" id="8056196">)</span><span class="op" id="8056197">)</span><span class="op" id="8056198">,</span>&nbsp;<span class="ident" id="8056200">bcmdbuf</span><span class="op" id="8056207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056210">c</span><span class="op" id="8056211">,</span>&nbsp;<span class="ident" id="8056213">err</span>&nbsp;<span class="op" id="8056217">:=</span>&nbsp;<span class="ident" id="8056220">NewClient</span><span class="op" id="8056229">(</span><span class="ident" id="8056230">fake</span><span class="op" id="8056234">,</span>&nbsp;<span class="string" id="8056236">&#34;fake.host&#34;</span><span class="op" id="8056247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8056250">if</span>&nbsp;<span class="ident" id="8056253">err</span>&nbsp;<span class="op" id="8056257">!=</span>&nbsp;<span class="ident" id="8056260">nil</span>&nbsp;<span class="op" id="8056264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056268">t</span><span class="op" id="8056269">.</span><span class="ident" id="8056270">Fatalf</span><span class="op" id="8056276">(</span><span class="string" id="8056277">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8056292">,</span>&nbsp;<span class="ident" id="8056294">err</span><span class="op" id="8056297">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8056300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8056303">defer</span>&nbsp;<span class="ident" id="8056309">c</span><span class="op" id="8056310">.</span><span class="ident" id="8056311">Close</span><span class="op" id="8056316">(</span><span class="op" id="8056317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056321">c</span><span class="op" id="8056322">.</span><span class="ident" id="8056323">tls</span>&nbsp;<span class="op" id="8056327">=</span>&nbsp;<span class="ident" id="8056329">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056335">c</span><span class="op" id="8056336">.</span><span class="ident" id="8056337">serverName</span>&nbsp;<span class="op" id="8056348">=</span>&nbsp;<span class="string" id="8056350">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056369">err</span>&nbsp;<span class="op" id="8056373">=</span>&nbsp;<span class="ident" id="8056375">c</span><span class="op" id="8056376">.</span><span class="ident" id="8056377">Auth</span><span class="op" id="8056381">(</span><span class="ident" id="8056382">PlainAuth</span><span class="op" id="8056391">(</span><span class="string" id="8056392">&#34;&#34;</span><span class="op" id="8056394">,</span>&nbsp;<span class="string" id="8056396">&#34;user&#34;</span><span class="op" id="8056402">,</span>&nbsp;<span class="string" id="8056404">&#34;pass&#34;</span><span class="op" id="8056410">,</span>&nbsp;<span class="string" id="8056412">&#34;smtp.google.com&#34;</span><span class="op" id="8056429">)</span><span class="op" id="8056430">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8056434">if</span>&nbsp;<span class="ident" id="8056437">err</span>&nbsp;<span class="op" id="8056441">==</span>&nbsp;<span class="ident" id="8056444">nil</span>&nbsp;<span class="op" id="8056448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056452">t</span><span class="op" id="8056453">.</span><span class="ident" id="8056454">Error</span><span class="op" id="8056459">(</span><span class="string" id="8056460">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="8056492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8056495">}</span>&nbsp;<span class="keyword" id="8056497">else</span>&nbsp;<span class="keyword" id="8056502">if</span>&nbsp;<span class="ident" id="8056505">err</span><span class="op" id="8056508">.</span><span class="ident" id="8056509">Error</span><span class="op" id="8056514">(</span><span class="op" id="8056515">)</span>&nbsp;<span class="op" id="8056517">!=</span>&nbsp;<span class="string" id="8056520">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="8056574">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056578">t</span><span class="op" id="8056579">.</span><span class="ident" id="8056580">Errorf</span><span class="op" id="8056586">(</span><span class="string" id="8056587">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="8056618">,</span>&nbsp;<span class="ident" id="8056620">err</span><span class="op" id="8056623">,</span>&nbsp;<span class="string" id="8056625">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="8056678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8056681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056685">bcmdbuf</span><span class="op" id="8056692">.</span><span class="ident" id="8056693">Flush</span><span class="op" id="8056698">(</span><span class="op" id="8056699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056702">actualcmds</span>&nbsp;<span class="op" id="8056713">:=</span>&nbsp;<span class="ident" id="8056716">cmdbuf</span><span class="op" id="8056722">.</span><span class="ident" id="8056723">String</span><span class="op" id="8056729">(</span><span class="op" id="8056730">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8056733">if</span>&nbsp;<span class="ident" id="8056736">client</span>&nbsp;<span class="op" id="8056743">!=</span>&nbsp;<span class="ident" id="8056746">actualcmds</span>&nbsp;<span class="op" id="8056757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8056761">t</span><span class="op" id="8056762">.</span><span class="ident" id="8056763">Errorf</span><span class="op" id="8056769">(</span><span class="string" id="8056770">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8056795">,</span>&nbsp;<span class="ident" id="8056797">actualcmds</span><span class="op" id="8056807">,</span>&nbsp;<span class="ident" id="8056809">client</span><span class="op" id="8056815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8056818">}</span><br>
<span class="lineno"></span><span class="op" id="8056820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="8056823">var</span>&nbsp;<span class="ident" id="8056827">authFailedServer</span>&nbsp;<span class="op" id="8056844">=</span>&nbsp;<span class="string" id="8056846">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8056988">var</span>&nbsp;<span class="ident" id="8056992">authFailedClient</span>&nbsp;<span class="op" id="8057009">=</span>&nbsp;<span class="string" id="8057011">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8057065">func</span>&nbsp;<span class="ident" id="8057070">TestTLSClient</span><span class="op" id="8057083">(</span><span class="ident" id="8057084">t</span>&nbsp;<span class="op" id="8057086">*</span><span class="ident" id="8057087">testing</span><span class="op" id="8057094">.</span><span class="ident" id="8057095">T</span><span class="op" id="8057096">)</span>&nbsp;<span class="op" id="8057098">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057101">ln</span>&nbsp;<span class="op" id="8057104">:=</span>&nbsp;<span class="ident" id="8057107">newLocalListener</span><span class="op" id="8057123">(</span><span class="ident" id="8057124">t</span><span class="op" id="8057125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057128">defer</span>&nbsp;<span class="ident" id="8057134">ln</span><span class="op" id="8057136">.</span><span class="ident" id="8057137">Close</span><span class="op" id="8057142">(</span><span class="op" id="8057143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057146">errc</span>&nbsp;<span class="op" id="8057151">:=</span>&nbsp;<span class="builtinfunc" id="8057154">make</span><span class="op" id="8057158">(</span><span class="keyword" id="8057159">chan</span>&nbsp;<span class="builtintype" id="8057164">error</span><span class="op" id="8057169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057172">go</span>&nbsp;<span class="keyword" id="8057175">func</span><span class="op" id="8057179">(</span><span class="op" id="8057180">)</span>&nbsp;<span class="op" id="8057182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057186">errc</span>&nbsp;<span class="op" id="8057191">&lt;-</span>&nbsp;<span class="ident" id="8057194">sendMail</span><span class="op" id="8057202">(</span><span class="ident" id="8057203">ln</span><span class="op" id="8057205">.</span><span class="ident" id="8057206">Addr</span><span class="op" id="8057210">(</span><span class="op" id="8057211">)</span><span class="op" id="8057212">.</span><span class="ident" id="8057213">String</span><span class="op" id="8057219">(</span><span class="op" id="8057220">)</span><span class="op" id="8057221">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8057224">}</span><span class="op" id="8057225">(</span><span class="op" id="8057226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057229">conn</span><span class="op" id="8057233">,</span>&nbsp;<span class="ident" id="8057235">err</span>&nbsp;<span class="op" id="8057239">:=</span>&nbsp;<span class="ident" id="8057242">ln</span><span class="op" id="8057244">.</span><span class="ident" id="8057245">Accept</span><span class="op" id="8057251">(</span><span class="op" id="8057252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057255">if</span>&nbsp;<span class="ident" id="8057258">err</span>&nbsp;<span class="op" id="8057262">!=</span>&nbsp;<span class="ident" id="8057265">nil</span>&nbsp;<span class="op" id="8057269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057273">t</span><span class="op" id="8057274">.</span><span class="ident" id="8057275">Fatalf</span><span class="op" id="8057281">(</span><span class="string" id="8057282">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8057315">,</span>&nbsp;<span class="ident" id="8057317">err</span><span class="op" id="8057320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8057323">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057326">defer</span>&nbsp;<span class="ident" id="8057332">conn</span><span class="op" id="8057336">.</span><span class="ident" id="8057337">Close</span><span class="op" id="8057342">(</span><span class="op" id="8057343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057346">if</span>&nbsp;<span class="ident" id="8057349">err</span>&nbsp;<span class="op" id="8057353">:=</span>&nbsp;<span class="ident" id="8057356">serverHandle</span><span class="op" id="8057368">(</span><span class="ident" id="8057369">conn</span><span class="op" id="8057373">,</span>&nbsp;<span class="ident" id="8057375">t</span><span class="op" id="8057376">)</span><span class="op" id="8057377">;</span>&nbsp;<span class="ident" id="8057379">err</span>&nbsp;<span class="op" id="8057383">!=</span>&nbsp;<span class="ident" id="8057386">nil</span>&nbsp;<span class="op" id="8057390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057394">t</span><span class="op" id="8057395">.</span><span class="ident" id="8057396">Fatalf</span><span class="op" id="8057402">(</span><span class="string" id="8057403">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8057436">,</span>&nbsp;<span class="ident" id="8057438">err</span><span class="op" id="8057441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8057444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057447">if</span>&nbsp;<span class="ident" id="8057450">err</span>&nbsp;<span class="op" id="8057454">:=</span>&nbsp;<span class="op" id="8057457">&lt;-</span><span class="ident" id="8057459">errc</span><span class="op" id="8057463">;</span>&nbsp;<span class="ident" id="8057465">err</span>&nbsp;<span class="op" id="8057469">!=</span>&nbsp;<span class="ident" id="8057472">nil</span>&nbsp;<span class="op" id="8057476">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057480">t</span><span class="op" id="8057481">.</span><span class="ident" id="8057482">Fatalf</span><span class="op" id="8057488">(</span><span class="string" id="8057489">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8057507">,</span>&nbsp;<span class="ident" id="8057509">err</span><span class="op" id="8057512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8057515">}</span><br>
<span class="lineno"></span><span class="op" id="8057517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8057520">func</span>&nbsp;<span class="ident" id="8057525">newLocalListener</span><span class="op" id="8057541">(</span><span class="ident" id="8057542">t</span>&nbsp;<span class="op" id="8057544">*</span><span class="ident" id="8057545">testing</span><span class="op" id="8057552">.</span><span class="ident" id="8057553">T</span><span class="op" id="8057554">)</span>&nbsp;<span class="ident" id="8057556">net</span><span class="op" id="8057559">.</span><span class="ident" id="8057560">Listener</span>&nbsp;<span class="op" id="8057569">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057572">ln</span><span class="op" id="8057574">,</span>&nbsp;<span class="ident" id="8057576">err</span>&nbsp;<span class="op" id="8057580">:=</span>&nbsp;<span class="ident" id="8057583">net</span><span class="op" id="8057586">.</span><span class="ident" id="8057587">Listen</span><span class="op" id="8057593">(</span><span class="string" id="8057594">&#34;tcp&#34;</span><span class="op" id="8057599">,</span>&nbsp;<span class="string" id="8057601">&#34;127.0.0.1:0&#34;</span><span class="op" id="8057614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057617">if</span>&nbsp;<span class="ident" id="8057620">err</span>&nbsp;<span class="op" id="8057624">!=</span>&nbsp;<span class="ident" id="8057627">nil</span>&nbsp;<span class="op" id="8057631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057635">ln</span><span class="op" id="8057637">,</span>&nbsp;<span class="ident" id="8057639">err</span>&nbsp;<span class="op" id="8057643">=</span>&nbsp;<span class="ident" id="8057645">net</span><span class="op" id="8057648">.</span><span class="ident" id="8057649">Listen</span><span class="op" id="8057655">(</span><span class="string" id="8057656">&#34;tcp6&#34;</span><span class="op" id="8057662">,</span>&nbsp;<span class="string" id="8057664">&#34;[::1]:0&#34;</span><span class="op" id="8057673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8057676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057679">if</span>&nbsp;<span class="ident" id="8057682">err</span>&nbsp;<span class="op" id="8057686">!=</span>&nbsp;<span class="ident" id="8057689">nil</span>&nbsp;<span class="op" id="8057693">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057697">t</span><span class="op" id="8057698">.</span><span class="ident" id="8057699">Fatal</span><span class="op" id="8057704">(</span><span class="ident" id="8057705">err</span><span class="op" id="8057708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8057711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8057714">return</span>&nbsp;<span class="ident" id="8057721">ln</span><br>
<span class="lineno"></span><span class="op" id="8057724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="8057727">type</span>&nbsp;<span class="ident" id="8057732">smtpSender</span>&nbsp;<span class="keyword" id="8057743">struct</span>&nbsp;<span class="op" id="8057750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057753">w</span>&nbsp;<span class="ident" id="8057755">io</span><span class="op" id="8057757">.</span><span class="ident" id="8057758">Writer</span><br>
<span class="lineno"></span><span class="op" id="8057765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8057768">func</span>&nbsp;<span class="op" id="8057773">(</span><span class="ident" id="8057774">s</span>&nbsp;<span class="ident" id="8057776">smtpSender</span><span class="op" id="8057786">)</span>&nbsp;<span class="ident" id="8057788">send</span><span class="op" id="8057792">(</span><span class="ident" id="8057793">f</span>&nbsp;<span class="builtintype" id="8057795">string</span><span class="op" id="8057801">)</span>&nbsp;<span class="op" id="8057803">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057806">s</span><span class="op" id="8057807">.</span><span class="ident" id="8057808">w</span><span class="op" id="8057809">.</span><span class="ident" id="8057810">Write</span><span class="op" id="8057815">(</span><span class="op" id="8057816">[</span><span class="op" id="8057817">]</span><span class="builtintype" id="8057818">byte</span><span class="op" id="8057822">(</span><span class="ident" id="8057823">f</span>&nbsp;<span class="op" id="8057825">+</span>&nbsp;<span class="string" id="8057827">&#34;\r\n&#34;</span><span class="op" id="8057833">)</span><span class="op" id="8057834">)</span><br>
<span class="lineno"></span><span class="op" id="8057836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8057839">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="8057905">func</span>&nbsp;<span class="ident" id="8057910">serverHandle</span><span class="op" id="8057922">(</span><span class="ident" id="8057923">c</span>&nbsp;<span class="ident" id="8057925">net</span><span class="op" id="8057928">.</span><span class="ident" id="8057929">Conn</span><span class="op" id="8057933">,</span>&nbsp;<span class="ident" id="8057935">t</span>&nbsp;<span class="op" id="8057937">*</span><span class="ident" id="8057938">testing</span><span class="op" id="8057945">.</span><span class="ident" id="8057946">T</span><span class="op" id="8057947">)</span>&nbsp;<span class="builtintype" id="8057949">error</span>&nbsp;<span class="op" id="8057955">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057958">send</span>&nbsp;<span class="op" id="8057963">:=</span>&nbsp;<span class="ident" id="8057966">smtpSender</span><span class="op" id="8057976">{</span><span class="ident" id="8057977">c</span><span class="op" id="8057978">}</span><span class="op" id="8057979">.</span><span class="ident" id="8057980">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8057986">send</span><span class="op" id="8057990">(</span><span class="string" id="8057991">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="8058026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058029">s</span>&nbsp;<span class="op" id="8058031">:=</span>&nbsp;<span class="ident" id="8058034">bufio</span><span class="op" id="8058039">.</span><span class="ident" id="8058040">NewScanner</span><span class="op" id="8058050">(</span><span class="ident" id="8058051">c</span><span class="op" id="8058052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058055">for</span>&nbsp;<span class="ident" id="8058059">s</span><span class="op" id="8058060">.</span><span class="ident" id="8058061">Scan</span><span class="op" id="8058065">(</span><span class="op" id="8058066">)</span>&nbsp;<span class="op" id="8058068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058072">switch</span>&nbsp;<span class="ident" id="8058079">s</span><span class="op" id="8058080">.</span><span class="ident" id="8058081">Text</span><span class="op" id="8058085">(</span><span class="op" id="8058086">)</span>&nbsp;<span class="op" id="8058088">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058092">case</span>&nbsp;<span class="string" id="8058097">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8058113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058118">send</span><span class="op" id="8058122">(</span><span class="string" id="8058123">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="8058173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058178">send</span><span class="op" id="8058182">(</span><span class="string" id="8058183">&#34;250-STARTTLS&#34;</span><span class="op" id="8058197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058202">send</span><span class="op" id="8058206">(</span><span class="string" id="8058207">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8058215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058219">case</span>&nbsp;<span class="string" id="8058224">&#34;STARTTLS&#34;</span><span class="op" id="8058234">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058239">send</span><span class="op" id="8058243">(</span><span class="string" id="8058244">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="8058258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058263">keypair</span><span class="op" id="8058270">,</span>&nbsp;<span class="ident" id="8058272">err</span>&nbsp;<span class="op" id="8058276">:=</span>&nbsp;<span class="ident" id="8058279">tls</span><span class="op" id="8058282">.</span><span class="ident" id="8058283">X509KeyPair</span><span class="op" id="8058294">(</span><span class="ident" id="8058295">localhostCert</span><span class="op" id="8058308">,</span>&nbsp;<span class="ident" id="8058310">localhostKey</span><span class="op" id="8058322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058327">if</span>&nbsp;<span class="ident" id="8058330">err</span>&nbsp;<span class="op" id="8058334">!=</span>&nbsp;<span class="ident" id="8058337">nil</span>&nbsp;<span class="op" id="8058341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058347">return</span>&nbsp;<span class="ident" id="8058354">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8058361">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058366">config</span>&nbsp;<span class="op" id="8058373">:=</span>&nbsp;<span class="op" id="8058376">&amp;</span><span class="ident" id="8058377">tls</span><span class="op" id="8058380">.</span><span class="ident" id="8058381">Config</span><span class="op" id="8058387">{</span><span class="ident" id="8058388">Certificates</span><span class="op" id="8058400">:</span>&nbsp;<span class="op" id="8058402">[</span><span class="op" id="8058403">]</span><span class="ident" id="8058404">tls</span><span class="op" id="8058407">.</span><span class="ident" id="8058408">Certificate</span><span class="op" id="8058419">{</span><span class="ident" id="8058420">keypair</span><span class="op" id="8058427">}</span><span class="op" id="8058428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058433">c</span>&nbsp;<span class="op" id="8058435">=</span>&nbsp;<span class="ident" id="8058437">tls</span><span class="op" id="8058440">.</span><span class="ident" id="8058441">Server</span><span class="op" id="8058447">(</span><span class="ident" id="8058448">c</span><span class="op" id="8058449">,</span>&nbsp;<span class="ident" id="8058451">config</span><span class="op" id="8058457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058462">defer</span>&nbsp;<span class="ident" id="8058468">c</span><span class="op" id="8058469">.</span><span class="ident" id="8058470">Close</span><span class="op" id="8058475">(</span><span class="op" id="8058476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058481">return</span>&nbsp;<span class="ident" id="8058488">serverHandleTLS</span><span class="op" id="8058503">(</span><span class="ident" id="8058504">c</span><span class="op" id="8058505">,</span>&nbsp;<span class="ident" id="8058507">t</span><span class="op" id="8058508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058512">default</span><span class="op" id="8058519">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058524">t</span><span class="op" id="8058525">.</span><span class="ident" id="8058526">Fatalf</span><span class="op" id="8058532">(</span><span class="string" id="8058533">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="8058559">,</span>&nbsp;<span class="ident" id="8058561">s</span><span class="op" id="8058562">.</span><span class="ident" id="8058563">Text</span><span class="op" id="8058567">(</span><span class="op" id="8058568">)</span><span class="op" id="8058569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8058573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8058576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058579">return</span>&nbsp;<span class="ident" id="8058586">s</span><span class="op" id="8058587">.</span><span class="ident" id="8058588">Err</span><span class="op" id="8058591">(</span><span class="op" id="8058592">)</span><br>
<span class="lineno"></span><span class="op" id="8058594">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="8058597">func</span>&nbsp;<span class="ident" id="8058602">serverHandleTLS</span><span class="op" id="8058617">(</span><span class="ident" id="8058618">c</span>&nbsp;<span class="ident" id="8058620">net</span><span class="op" id="8058623">.</span><span class="ident" id="8058624">Conn</span><span class="op" id="8058628">,</span>&nbsp;<span class="ident" id="8058630">t</span>&nbsp;<span class="op" id="8058632">*</span><span class="ident" id="8058633">testing</span><span class="op" id="8058640">.</span><span class="ident" id="8058641">T</span><span class="op" id="8058642">)</span>&nbsp;<span class="builtintype" id="8058644">error</span>&nbsp;<span class="op" id="8058650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058653">send</span>&nbsp;<span class="op" id="8058658">:=</span>&nbsp;<span class="ident" id="8058661">smtpSender</span><span class="op" id="8058671">{</span><span class="ident" id="8058672">c</span><span class="op" id="8058673">}</span><span class="op" id="8058674">.</span><span class="ident" id="8058675">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058681">s</span>&nbsp;<span class="op" id="8058683">:=</span>&nbsp;<span class="ident" id="8058686">bufio</span><span class="op" id="8058691">.</span><span class="ident" id="8058692">NewScanner</span><span class="op" id="8058702">(</span><span class="ident" id="8058703">c</span><span class="op" id="8058704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058707">for</span>&nbsp;<span class="ident" id="8058711">s</span><span class="op" id="8058712">.</span><span class="ident" id="8058713">Scan</span><span class="op" id="8058717">(</span><span class="op" id="8058718">)</span>&nbsp;<span class="op" id="8058720">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058724">switch</span>&nbsp;<span class="ident" id="8058731">s</span><span class="op" id="8058732">.</span><span class="ident" id="8058733">Text</span><span class="op" id="8058737">(</span><span class="op" id="8058738">)</span>&nbsp;<span class="op" id="8058740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058744">case</span>&nbsp;<span class="string" id="8058749">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8058765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058770">send</span><span class="op" id="8058774">(</span><span class="string" id="8058775">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8058783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058787">case</span>&nbsp;<span class="string" id="8058792">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="8058822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058827">send</span><span class="op" id="8058831">(</span><span class="string" id="8058832">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8058840">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058844">case</span>&nbsp;<span class="string" id="8058849">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="8058877">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058882">send</span><span class="op" id="8058886">(</span><span class="string" id="8058887">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8058895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058899">case</span>&nbsp;<span class="string" id="8058904">&#34;DATA&#34;</span><span class="op" id="8058910">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058915">send</span><span class="op" id="8058919">(</span><span class="string" id="8058920">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="8058956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8058961">send</span><span class="op" id="8058965">(</span><span class="string" id="8058966">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8058974">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8058978">case</span>&nbsp;<span class="string" id="8058983">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="8058998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059002">case</span>&nbsp;<span class="string" id="8059007">&#34;&#34;</span><span class="op" id="8059009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059013">case</span>&nbsp;<span class="string" id="8059018">&#34;howdy!&#34;</span><span class="op" id="8059026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059030">case</span>&nbsp;<span class="string" id="8059035">&#34;.&#34;</span><span class="op" id="8059038">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059042">case</span>&nbsp;<span class="string" id="8059047">&#34;QUIT&#34;</span><span class="op" id="8059053">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059058">send</span><span class="op" id="8059062">(</span><span class="string" id="8059063">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="8059115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059120">return</span>&nbsp;<span class="ident" id="8059127">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059133">default</span><span class="op" id="8059140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059145">t</span><span class="op" id="8059146">.</span><span class="ident" id="8059147">Fatalf</span><span class="op" id="8059153">(</span><span class="string" id="8059154">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="8059191">,</span>&nbsp;<span class="ident" id="8059193">s</span><span class="op" id="8059194">.</span><span class="ident" id="8059195">Text</span><span class="op" id="8059199">(</span><span class="op" id="8059200">)</span><span class="op" id="8059201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8059205">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8059208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059211">return</span>&nbsp;<span class="ident" id="8059218">s</span><span class="op" id="8059219">.</span><span class="ident" id="8059220">Err</span><span class="op" id="8059223">(</span><span class="op" id="8059224">)</span><br>
<span class="lineno"></span><span class="op" id="8059226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8059229">func</span>&nbsp;<span class="ident" id="8059234">init</span><span class="op" id="8059238">(</span><span class="op" id="8059239">)</span>&nbsp;<span class="op" id="8059241">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059244">testRootCAs</span>&nbsp;<span class="op" id="8059256">:=</span>&nbsp;<span class="ident" id="8059259">x509</span><span class="op" id="8059263">.</span><span class="ident" id="8059264">NewCertPool</span><span class="op" id="8059275">(</span><span class="op" id="8059276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059279">testRootCAs</span><span class="op" id="8059290">.</span><span class="ident" id="8059291">AppendCertsFromPEM</span><span class="op" id="8059309">(</span><span class="ident" id="8059310">localhostCert</span><span class="op" id="8059323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059326">testHookStartTLS</span>&nbsp;<span class="op" id="8059343">=</span>&nbsp;<span class="keyword" id="8059345">func</span><span class="op" id="8059349">(</span><span class="ident" id="8059350">config</span>&nbsp;<span class="op" id="8059357">*</span><span class="ident" id="8059358">tls</span><span class="op" id="8059361">.</span><span class="ident" id="8059362">Config</span><span class="op" id="8059368">)</span>&nbsp;<span class="op" id="8059370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059374">config</span><span class="op" id="8059380">.</span><span class="ident" id="8059381">RootCAs</span>&nbsp;<span class="op" id="8059389">=</span>&nbsp;<span class="ident" id="8059391">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8059404">}</span><br>
<span class="lineno">655</span><span class="op" id="8059406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8059409">func</span>&nbsp;<span class="ident" id="8059414">sendMail</span><span class="op" id="8059422">(</span><span class="ident" id="8059423">hostPort</span>&nbsp;<span class="builtintype" id="8059432">string</span><span class="op" id="8059438">)</span>&nbsp;<span class="builtintype" id="8059440">error</span>&nbsp;<span class="op" id="8059446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059449">host</span><span class="op" id="8059453">,</span>&nbsp;<span class="ident" id="8059455">_</span><span class="op" id="8059456">,</span>&nbsp;<span class="ident" id="8059458">err</span>&nbsp;<span class="op" id="8059462">:=</span>&nbsp;<span class="ident" id="8059465">net</span><span class="op" id="8059468">.</span><span class="ident" id="8059469">SplitHostPort</span><span class="op" id="8059482">(</span><span class="ident" id="8059483">hostPort</span><span class="op" id="8059491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059494">if</span>&nbsp;<span class="ident" id="8059497">err</span>&nbsp;<span class="op" id="8059501">!=</span>&nbsp;<span class="ident" id="8059504">nil</span>&nbsp;<span class="op" id="8059508">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059512">return</span>&nbsp;<span class="ident" id="8059519">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8059524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059527">auth</span>&nbsp;<span class="op" id="8059532">:=</span>&nbsp;<span class="ident" id="8059535">PlainAuth</span><span class="op" id="8059544">(</span><span class="string" id="8059545">&#34;&#34;</span><span class="op" id="8059547">,</span>&nbsp;<span class="string" id="8059549">&#34;&#34;</span><span class="op" id="8059551">,</span>&nbsp;<span class="string" id="8059553">&#34;&#34;</span><span class="op" id="8059555">,</span>&nbsp;<span class="ident" id="8059557">host</span><span class="op" id="8059561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059564">from</span>&nbsp;<span class="op" id="8059569">:=</span>&nbsp;<span class="string" id="8059572">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8059592">to</span>&nbsp;<span class="op" id="8059595">:=</span>&nbsp;<span class="op" id="8059598">[</span><span class="op" id="8059599">]</span><span class="builtintype" id="8059600">string</span><span class="op" id="8059606">{</span><span class="string" id="8059607">&#34;joe2@example.com&#34;</span><span class="op" id="8059625">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8059628">return</span>&nbsp;<span class="ident" id="8059635">SendMail</span><span class="op" id="8059643">(</span><span class="ident" id="8059644">hostPort</span><span class="op" id="8059652">,</span>&nbsp;<span class="ident" id="8059654">auth</span><span class="op" id="8059658">,</span>&nbsp;<span class="ident" id="8059660">from</span><span class="op" id="8059664">,</span>&nbsp;<span class="ident" id="8059666">to</span><span class="op" id="8059668">,</span>&nbsp;<span class="op" id="8059670">[</span><span class="op" id="8059671">]</span><span class="builtintype" id="8059672">byte</span><span class="op" id="8059676">(</span><span class="string" id="8059677">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="8059702">)</span><span class="op" id="8059703">)</span><br>
<span class="lineno"></span><span class="op" id="8059705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8059708">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="8059743">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="8059799">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="8059872">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="8059891">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="8059925">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="8060061">var</span>&nbsp;<span class="ident" id="8060065">localhostCert</span>&nbsp;<span class="op" id="8060079">=</span>&nbsp;<span class="op" id="8060081">[</span><span class="op" id="8060082">]</span><span class="builtintype" id="8060083">byte</span><span class="op" id="8060087">(</span><span class="string" id="8060088">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="8060659">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="8060662">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="8060716">var</span>&nbsp;<span class="ident" id="8060720">localhostKey</span>&nbsp;<span class="op" id="8060733">=</span>&nbsp;<span class="op" id="8060735">[</span><span class="op" id="8060736">]</span><span class="builtintype" id="8060737">byte</span><span class="op" id="8060741">(</span><span class="string" id="8060742">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="8061240">)</span>
</div>
</body>
</html>
