<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2567293">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2567348">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2567402">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2567453">package</span>&nbsp;<span class="ident" id="2567461">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2567466">import</span>&nbsp;<span class="string" id="2567473">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2567488">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="2567542">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="2567598">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="2567637">type</span>&nbsp;<span class="ident" id="2567642">fdMutex</span>&nbsp;<span class="keyword" id="2567650">struct</span>&nbsp;<span class="op" id="2567657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2567660">state</span>&nbsp;<span class="ident" id="2567666">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2567674">rsema</span>&nbsp;<span class="builtintype" id="2567680">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2567688">wsema</span>&nbsp;<span class="builtintype" id="2567694">uint32</span><br>
<span class="lineno"></span><span class="op" id="2567701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2567704">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2567746">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="2567831">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2567868">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2567906">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="2567965">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="2568014">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="2568064">const</span>&nbsp;<span class="op" id="2568070">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568073">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="2568086">=</span>&nbsp;<span class="num" id="2568088">1</span>&nbsp;<span class="op" id="2568090">&lt;&lt;</span>&nbsp;<span class="num" id="2568093">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568096">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2568109">=</span>&nbsp;<span class="num" id="2568111">1</span>&nbsp;<span class="op" id="2568113">&lt;&lt;</span>&nbsp;<span class="num" id="2568116">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568119">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2568132">=</span>&nbsp;<span class="num" id="2568134">1</span>&nbsp;<span class="op" id="2568136">&lt;&lt;</span>&nbsp;<span class="num" id="2568139">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568142">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2568155">=</span>&nbsp;<span class="num" id="2568157">1</span>&nbsp;<span class="op" id="2568159">&lt;&lt;</span>&nbsp;<span class="num" id="2568162">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568165">mutexRefMask</span>&nbsp;<span class="op" id="2568178">=</span>&nbsp;<span class="op" id="2568180">(</span><span class="num" id="2568181">1</span><span class="op" id="2568182">&lt;&lt;</span><span class="num" id="2568184">20</span>&nbsp;<span class="op" id="2568187">-</span>&nbsp;<span class="num" id="2568189">1</span><span class="op" id="2568190">)</span>&nbsp;<span class="op" id="2568192">&lt;&lt;</span>&nbsp;<span class="num" id="2568195">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568198">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2568211">=</span>&nbsp;<span class="num" id="2568213">1</span>&nbsp;<span class="op" id="2568215">&lt;&lt;</span>&nbsp;<span class="num" id="2568218">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568222">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2568235">=</span>&nbsp;<span class="op" id="2568237">(</span><span class="num" id="2568238">1</span><span class="op" id="2568239">&lt;&lt;</span><span class="num" id="2568241">20</span>&nbsp;<span class="op" id="2568244">-</span>&nbsp;<span class="num" id="2568246">1</span><span class="op" id="2568247">)</span>&nbsp;<span class="op" id="2568249">&lt;&lt;</span>&nbsp;<span class="num" id="2568252">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568256">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2568269">=</span>&nbsp;<span class="num" id="2568271">1</span>&nbsp;<span class="op" id="2568273">&lt;&lt;</span>&nbsp;<span class="num" id="2568276">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568280">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2568293">=</span>&nbsp;<span class="op" id="2568295">(</span><span class="num" id="2568296">1</span><span class="op" id="2568297">&lt;&lt;</span><span class="num" id="2568299">20</span>&nbsp;<span class="op" id="2568302">-</span>&nbsp;<span class="num" id="2568304">1</span><span class="op" id="2568305">)</span>&nbsp;<span class="op" id="2568307">&lt;&lt;</span>&nbsp;<span class="num" id="2568310">43</span><br>
<span class="lineno">35</span><span class="op" id="2568313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2568316">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="2568372">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="2568431">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="2568512">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="2568589">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="2568662">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="2568712">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="2568763">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="2568807">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2568894">func</span>&nbsp;<span class="op" id="2568899">(</span><span class="ident" id="2568900">mu</span>&nbsp;<span class="op" id="2568903">*</span><span class="ident" id="2568904"><a href="/net/fd_mutex.go.html#2567642">fdMutex</a></span><span class="op" id="2568911">)</span>&nbsp;<span class="ident" id="2568913">Incref</span><span class="op" id="2568919">(</span><span class="op" id="2568920">)</span>&nbsp;<span class="builtintype" id="2568922">bool</span>&nbsp;<span class="op" id="2568927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2568930">for</span>&nbsp;<span class="op" id="2568934">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2568938">old</span>&nbsp;<span class="op" id="2568942">:=</span>&nbsp;<span class="ident" id="2568945"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2568951">.</span><span class="ident" id="2568952">LoadUint64</span><span class="op" id="2568962">(</span><span class="op" id="2568963">&amp;</span><span class="ident" id="2568964"><a href="/net/fd_mutex.go.html#2568900">mu</a></span><span class="op" id="2568966">.</span><span class="ident" id="2568967">state</span><span class="op" id="2568972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2568976">if</span>&nbsp;<span class="ident" id="2568979"><a href="/net/fd_mutex.go.html#2568938">old</a></span><span class="op" id="2568982">&amp;</span><span class="ident" id="2568983"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span>&nbsp;<span class="op" id="2568995">!=</span>&nbsp;<span class="num" id="2568998">0</span>&nbsp;<span class="op" id="2569000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569005">return</span>&nbsp;<span class="ident" id="2569012">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2569024">new</span>&nbsp;<span class="op" id="2569028">:=</span>&nbsp;<span class="ident" id="2569031"><a href="/net/fd_mutex.go.html#2568938">old</a></span>&nbsp;<span class="op" id="2569035">+</span>&nbsp;<span class="ident" id="2569037"><a href="/net/fd_mutex.go.html#2568142">mutexRef</a></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569048">if</span>&nbsp;<span class="builtinfunc" id="2569051"><a href="/net/fd_mutex.go.html#2569024">new</a></span><span class="op" id="2569054">&amp;</span><span class="ident" id="2569055"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span>&nbsp;<span class="op" id="2569068">==</span>&nbsp;<span class="num" id="2569071">0</span>&nbsp;<span class="op" id="2569073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2569078">panic</span><span class="op" id="2569083">(</span><span class="string" id="2569084">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2569111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569119">if</span>&nbsp;<span class="ident" id="2569122"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2569128">.</span><span class="ident" id="2569129">CompareAndSwapUint64</span><span class="op" id="2569149">(</span><span class="op" id="2569150">&amp;</span><span class="ident" id="2569151"><a href="/net/fd_mutex.go.html#2568900">mu</a></span><span class="op" id="2569153">.</span><span class="ident" id="2569154">state</span><span class="op" id="2569159">,</span>&nbsp;<span class="ident" id="2569161"><a href="/net/fd_mutex.go.html#2568938">old</a></span><span class="op" id="2569164">,</span>&nbsp;<span class="builtinfunc" id="2569166"><a href="/net/fd_mutex.go.html#2569024">new</a></span><span class="op" id="2569169">)</span>&nbsp;<span class="op" id="2569171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569176">return</span>&nbsp;<span class="ident" id="2569183">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569193">}</span><br>
<span class="lineno"></span><span class="op" id="2569195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2569198">func</span>&nbsp;<span class="op" id="2569203">(</span><span class="ident" id="2569204">mu</span>&nbsp;<span class="op" id="2569207">*</span><span class="ident" id="2569208"><a href="/net/fd_mutex.go.html#2567642">fdMutex</a></span><span class="op" id="2569215">)</span>&nbsp;<span class="ident" id="2569217">IncrefAndClose</span><span class="op" id="2569231">(</span><span class="op" id="2569232">)</span>&nbsp;<span class="builtintype" id="2569234">bool</span>&nbsp;<span class="op" id="2569239">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569242">for</span>&nbsp;<span class="op" id="2569246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2569250">old</span>&nbsp;<span class="op" id="2569254">:=</span>&nbsp;<span class="ident" id="2569257"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2569263">.</span><span class="ident" id="2569264">LoadUint64</span><span class="op" id="2569274">(</span><span class="op" id="2569275">&amp;</span><span class="ident" id="2569276"><a href="/net/fd_mutex.go.html#2569204">mu</a></span><span class="op" id="2569278">.</span><span class="ident" id="2569279">state</span><span class="op" id="2569284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569288">if</span>&nbsp;<span class="ident" id="2569291"><a href="/net/fd_mutex.go.html#2569250">old</a></span><span class="op" id="2569294">&amp;</span><span class="ident" id="2569295"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span>&nbsp;<span class="op" id="2569307">!=</span>&nbsp;<span class="num" id="2569310">0</span>&nbsp;<span class="op" id="2569312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569317">return</span>&nbsp;<span class="ident" id="2569324">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569332">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2569336">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2569381">new</span>&nbsp;<span class="op" id="2569385">:=</span>&nbsp;<span class="op" id="2569388">(</span><span class="ident" id="2569389"><a href="/net/fd_mutex.go.html#2569250">old</a></span>&nbsp;<span class="op" id="2569393">|</span>&nbsp;<span class="ident" id="2569395"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span><span class="op" id="2569406">)</span>&nbsp;<span class="op" id="2569408">+</span>&nbsp;<span class="ident" id="2569410"><a href="/net/fd_mutex.go.html#2568142">mutexRef</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569421">if</span>&nbsp;<span class="builtinfunc" id="2569424"><a href="/net/fd_mutex.go.html#2569381">new</a></span><span class="op" id="2569427">&amp;</span><span class="ident" id="2569428"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span>&nbsp;<span class="op" id="2569441">==</span>&nbsp;<span class="num" id="2569444">0</span>&nbsp;<span class="op" id="2569446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2569451">panic</span><span class="op" id="2569456">(</span><span class="string" id="2569457">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2569484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569488">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2569492">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2569532"><a href="/net/fd_mutex.go.html#2569381">new</a></span>&nbsp;<span class="op" id="2569536">&amp;^=</span>&nbsp;<span class="ident" id="2569540"><a href="/net/fd_mutex.go.html#2568222">mutexRMask</a></span>&nbsp;<span class="op" id="2569551">|</span>&nbsp;<span class="ident" id="2569553"><a href="/net/fd_mutex.go.html#2568280">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569566">if</span>&nbsp;<span class="ident" id="2569569"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2569575">.</span><span class="ident" id="2569576">CompareAndSwapUint64</span><span class="op" id="2569596">(</span><span class="op" id="2569597">&amp;</span><span class="ident" id="2569598"><a href="/net/fd_mutex.go.html#2569204">mu</a></span><span class="op" id="2569600">.</span><span class="ident" id="2569601">state</span><span class="op" id="2569606">,</span>&nbsp;<span class="ident" id="2569608"><a href="/net/fd_mutex.go.html#2569250">old</a></span><span class="op" id="2569611">,</span>&nbsp;<span class="builtinfunc" id="2569613"><a href="/net/fd_mutex.go.html#2569381">new</a></span><span class="op" id="2569616">)</span>&nbsp;<span class="op" id="2569618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2569623">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2569662">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569712">for</span>&nbsp;<span class="ident" id="2569716"><a href="/net/fd_mutex.go.html#2569250">old</a></span><span class="op" id="2569719">&amp;</span><span class="ident" id="2569720"><a href="/net/fd_mutex.go.html#2568222">mutexRMask</a></span>&nbsp;<span class="op" id="2569731">!=</span>&nbsp;<span class="num" id="2569734">0</span>&nbsp;<span class="op" id="2569736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2569742"><a href="/net/fd_mutex.go.html#2569250">old</a></span>&nbsp;<span class="op" id="2569746">-=</span>&nbsp;<span class="ident" id="2569749"><a href="/net/fd_mutex.go.html#2568198">mutexRWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2569764"><a href="/net/fd_mutex.go.html#2572030">runtime_Semrelease</a></span><span class="op" id="2569782">(</span><span class="op" id="2569783">&amp;</span><span class="ident" id="2569784"><a href="/net/fd_mutex.go.html#2569204">mu</a></span><span class="op" id="2569786">.</span><span class="ident" id="2569787">rsema</span><span class="op" id="2569792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569802">for</span>&nbsp;<span class="ident" id="2569806"><a href="/net/fd_mutex.go.html#2569250">old</a></span><span class="op" id="2569809">&amp;</span><span class="ident" id="2569810"><a href="/net/fd_mutex.go.html#2568280">mutexWMask</a></span>&nbsp;<span class="op" id="2569821">!=</span>&nbsp;<span class="num" id="2569824">0</span>&nbsp;<span class="op" id="2569826">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2569832"><a href="/net/fd_mutex.go.html#2569250">old</a></span>&nbsp;<span class="op" id="2569836">-=</span>&nbsp;<span class="ident" id="2569839"><a href="/net/fd_mutex.go.html#2568256">mutexWWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2569854"><a href="/net/fd_mutex.go.html#2572030">runtime_Semrelease</a></span><span class="op" id="2569872">(</span><span class="op" id="2569873">&amp;</span><span class="ident" id="2569874"><a href="/net/fd_mutex.go.html#2569204">mu</a></span><span class="op" id="2569876">.</span><span class="ident" id="2569877">wsema</span><span class="op" id="2569882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569892">return</span>&nbsp;<span class="ident" id="2569899">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569906">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2569909">}</span><br>
<span class="lineno"></span><span class="op" id="2569911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2569914">func</span>&nbsp;<span class="op" id="2569919">(</span><span class="ident" id="2569920">mu</span>&nbsp;<span class="op" id="2569923">*</span><span class="ident" id="2569924"><a href="/net/fd_mutex.go.html#2567642">fdMutex</a></span><span class="op" id="2569931">)</span>&nbsp;<span class="ident" id="2569933">Decref</span><span class="op" id="2569939">(</span><span class="op" id="2569940">)</span>&nbsp;<span class="builtintype" id="2569942">bool</span>&nbsp;<span class="op" id="2569947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569950">for</span>&nbsp;<span class="op" id="2569954">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2569958">old</span>&nbsp;<span class="op" id="2569962">:=</span>&nbsp;<span class="ident" id="2569965"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2569971">.</span><span class="ident" id="2569972">LoadUint64</span><span class="op" id="2569982">(</span><span class="op" id="2569983">&amp;</span><span class="ident" id="2569984"><a href="/net/fd_mutex.go.html#2569920">mu</a></span><span class="op" id="2569986">.</span><span class="ident" id="2569987">state</span><span class="op" id="2569992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2569996">if</span>&nbsp;<span class="ident" id="2569999"><a href="/net/fd_mutex.go.html#2569958">old</a></span><span class="op" id="2570002">&amp;</span><span class="ident" id="2570003"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span>&nbsp;<span class="op" id="2570016">==</span>&nbsp;<span class="num" id="2570019">0</span>&nbsp;<span class="op" id="2570021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2570026">panic</span><span class="op" id="2570031">(</span><span class="string" id="2570032">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2570059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2570067">new</span>&nbsp;<span class="op" id="2570071">:=</span>&nbsp;<span class="ident" id="2570074"><a href="/net/fd_mutex.go.html#2569958">old</a></span>&nbsp;<span class="op" id="2570078">-</span>&nbsp;<span class="ident" id="2570080"><a href="/net/fd_mutex.go.html#2568142">mutexRef</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570091">if</span>&nbsp;<span class="ident" id="2570094"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2570100">.</span><span class="ident" id="2570101">CompareAndSwapUint64</span><span class="op" id="2570121">(</span><span class="op" id="2570122">&amp;</span><span class="ident" id="2570123"><a href="/net/fd_mutex.go.html#2569920">mu</a></span><span class="op" id="2570125">.</span><span class="ident" id="2570126">state</span><span class="op" id="2570131">,</span>&nbsp;<span class="ident" id="2570133"><a href="/net/fd_mutex.go.html#2569958">old</a></span><span class="op" id="2570136">,</span>&nbsp;<span class="builtinfunc" id="2570138"><a href="/net/fd_mutex.go.html#2570067">new</a></span><span class="op" id="2570141">)</span>&nbsp;<span class="op" id="2570143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570148">return</span>&nbsp;<span class="builtinfunc" id="2570155"><a href="/net/fd_mutex.go.html#2570067">new</a></span><span class="op" id="2570158">&amp;</span><span class="op" id="2570159">(</span><span class="ident" id="2570160"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span><span class="op" id="2570171">|</span><span class="ident" id="2570172"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span><span class="op" id="2570184">)</span>&nbsp;<span class="op" id="2570186">==</span>&nbsp;<span class="ident" id="2570189"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570206">}</span><br>
<span class="lineno"></span><span class="op" id="2570208">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="2570211">func</span>&nbsp;<span class="op" id="2570216">(</span><span class="ident" id="2570217">mu</span>&nbsp;<span class="op" id="2570220">*</span><span class="ident" id="2570221"><a href="/net/fd_mutex.go.html#2567642">fdMutex</a></span><span class="op" id="2570228">)</span>&nbsp;<span class="ident" id="2570230">RWLock</span><span class="op" id="2570236">(</span><span class="ident" id="2570237">read</span>&nbsp;<span class="builtintype" id="2570242">bool</span><span class="op" id="2570246">)</span>&nbsp;<span class="builtintype" id="2570248">bool</span>&nbsp;<span class="op" id="2570253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570256">var</span>&nbsp;<span class="ident" id="2570260">mutexBit</span><span class="op" id="2570268">,</span>&nbsp;<span class="ident" id="2570270">mutexWait</span><span class="op" id="2570279">,</span>&nbsp;<span class="ident" id="2570281">mutexMask</span>&nbsp;<span class="ident" id="2570291">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570299">var</span>&nbsp;<span class="ident" id="2570303">mutexSema</span>&nbsp;<span class="op" id="2570313">*</span><span class="builtintype" id="2570314">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570322">if</span>&nbsp;<span class="ident" id="2570325"><a href="/net/fd_mutex.go.html#2570237">read</a></span>&nbsp;<span class="op" id="2570330">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570334"><a href="/net/fd_mutex.go.html#2570260">mutexBit</a></span>&nbsp;<span class="op" id="2570343">=</span>&nbsp;<span class="ident" id="2570345"><a href="/net/fd_mutex.go.html#2568096">mutexRLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570358"><a href="/net/fd_mutex.go.html#2570270">mutexWait</a></span>&nbsp;<span class="op" id="2570368">=</span>&nbsp;<span class="ident" id="2570370"><a href="/net/fd_mutex.go.html#2568198">mutexRWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570383"><a href="/net/fd_mutex.go.html#2570281">mutexMask</a></span>&nbsp;<span class="op" id="2570393">=</span>&nbsp;<span class="ident" id="2570395"><a href="/net/fd_mutex.go.html#2568222">mutexRMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570408"><a href="/net/fd_mutex.go.html#2570303">mutexSema</a></span>&nbsp;<span class="op" id="2570418">=</span>&nbsp;<span class="op" id="2570420">&amp;</span><span class="ident" id="2570421"><a href="/net/fd_mutex.go.html#2570217">mu</a></span><span class="op" id="2570423">.</span><span class="ident" id="2570424">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570431">}</span>&nbsp;<span class="keyword" id="2570433">else</span>&nbsp;<span class="op" id="2570438">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570442"><a href="/net/fd_mutex.go.html#2570260">mutexBit</a></span>&nbsp;<span class="op" id="2570451">=</span>&nbsp;<span class="ident" id="2570453"><a href="/net/fd_mutex.go.html#2568119">mutexWLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570466"><a href="/net/fd_mutex.go.html#2570270">mutexWait</a></span>&nbsp;<span class="op" id="2570476">=</span>&nbsp;<span class="ident" id="2570478"><a href="/net/fd_mutex.go.html#2568256">mutexWWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570491"><a href="/net/fd_mutex.go.html#2570281">mutexMask</a></span>&nbsp;<span class="op" id="2570501">=</span>&nbsp;<span class="ident" id="2570503"><a href="/net/fd_mutex.go.html#2568280">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570516"><a href="/net/fd_mutex.go.html#2570303">mutexSema</a></span>&nbsp;<span class="op" id="2570526">=</span>&nbsp;<span class="op" id="2570528">&amp;</span><span class="ident" id="2570529"><a href="/net/fd_mutex.go.html#2570217">mu</a></span><span class="op" id="2570531">.</span><span class="ident" id="2570532">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570539">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570542">for</span>&nbsp;<span class="op" id="2570546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2570550">old</span>&nbsp;<span class="op" id="2570554">:=</span>&nbsp;<span class="ident" id="2570557"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2570563">.</span><span class="ident" id="2570564">LoadUint64</span><span class="op" id="2570574">(</span><span class="op" id="2570575">&amp;</span><span class="ident" id="2570576"><a href="/net/fd_mutex.go.html#2570217">mu</a></span><span class="op" id="2570578">.</span><span class="ident" id="2570579">state</span><span class="op" id="2570584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570588">if</span>&nbsp;<span class="ident" id="2570591"><a href="/net/fd_mutex.go.html#2570550">old</a></span><span class="op" id="2570594">&amp;</span><span class="ident" id="2570595"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span>&nbsp;<span class="op" id="2570607">!=</span>&nbsp;<span class="num" id="2570610">0</span>&nbsp;<span class="op" id="2570612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570617">return</span>&nbsp;<span class="ident" id="2570624">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570632">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570636">var</span>&nbsp;<span class="builtinfunc" id="2570640">new</span>&nbsp;<span class="ident" id="2570644">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570653">if</span>&nbsp;<span class="ident" id="2570656"><a href="/net/fd_mutex.go.html#2570550">old</a></span><span class="op" id="2570659">&amp;</span><span class="ident" id="2570660"><a href="/net/fd_mutex.go.html#2570260">mutexBit</a></span>&nbsp;<span class="op" id="2570669">==</span>&nbsp;<span class="num" id="2570672">0</span>&nbsp;<span class="op" id="2570674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2570679">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2570711"><a href="/net/fd_mutex.go.html#2570640">new</a></span>&nbsp;<span class="op" id="2570715">=</span>&nbsp;<span class="op" id="2570717">(</span><span class="ident" id="2570718"><a href="/net/fd_mutex.go.html#2570550">old</a></span>&nbsp;<span class="op" id="2570722">|</span>&nbsp;<span class="ident" id="2570724"><a href="/net/fd_mutex.go.html#2570260">mutexBit</a></span><span class="op" id="2570732">)</span>&nbsp;<span class="op" id="2570734">+</span>&nbsp;<span class="ident" id="2570736"><a href="/net/fd_mutex.go.html#2568142">mutexRef</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570748">if</span>&nbsp;<span class="builtinfunc" id="2570751"><a href="/net/fd_mutex.go.html#2570640">new</a></span><span class="op" id="2570754">&amp;</span><span class="ident" id="2570755"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span>&nbsp;<span class="op" id="2570768">==</span>&nbsp;<span class="num" id="2570771">0</span>&nbsp;<span class="op" id="2570773">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2570779">panic</span><span class="op" id="2570784">(</span><span class="string" id="2570785">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2570812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570821">}</span>&nbsp;<span class="keyword" id="2570823">else</span>&nbsp;<span class="op" id="2570828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2570833">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2570854"><a href="/net/fd_mutex.go.html#2570640">new</a></span>&nbsp;<span class="op" id="2570858">=</span>&nbsp;<span class="ident" id="2570860"><a href="/net/fd_mutex.go.html#2570550">old</a></span>&nbsp;<span class="op" id="2570864">+</span>&nbsp;<span class="ident" id="2570866"><a href="/net/fd_mutex.go.html#2570270">mutexWait</a></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570879">if</span>&nbsp;<span class="builtinfunc" id="2570882"><a href="/net/fd_mutex.go.html#2570640">new</a></span><span class="op" id="2570885">&amp;</span><span class="ident" id="2570886"><a href="/net/fd_mutex.go.html#2570281">mutexMask</a></span>&nbsp;<span class="op" id="2570896">==</span>&nbsp;<span class="num" id="2570899">0</span>&nbsp;<span class="op" id="2570901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2570907">panic</span><span class="op" id="2570912">(</span><span class="string" id="2570913">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2570940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2570949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2570953">if</span>&nbsp;<span class="ident" id="2570956"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2570962">.</span><span class="ident" id="2570963">CompareAndSwapUint64</span><span class="op" id="2570983">(</span><span class="op" id="2570984">&amp;</span><span class="ident" id="2570985"><a href="/net/fd_mutex.go.html#2570217">mu</a></span><span class="op" id="2570987">.</span><span class="ident" id="2570988">state</span><span class="op" id="2570993">,</span>&nbsp;<span class="ident" id="2570995"><a href="/net/fd_mutex.go.html#2570550">old</a></span><span class="op" id="2570998">,</span>&nbsp;<span class="builtinfunc" id="2571000"><a href="/net/fd_mutex.go.html#2570640">new</a></span><span class="op" id="2571003">)</span>&nbsp;<span class="op" id="2571005">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571010">if</span>&nbsp;<span class="ident" id="2571013"><a href="/net/fd_mutex.go.html#2570550">old</a></span><span class="op" id="2571016">&amp;</span><span class="ident" id="2571017"><a href="/net/fd_mutex.go.html#2570260">mutexBit</a></span>&nbsp;<span class="op" id="2571026">==</span>&nbsp;<span class="num" id="2571029">0</span>&nbsp;<span class="op" id="2571031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571037">return</span>&nbsp;<span class="ident" id="2571044">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571057"><a href="/net/fd_mutex.go.html#2571992">runtime_Semacquire</a></span><span class="op" id="2571075">(</span><span class="ident" id="2571076"><a href="/net/fd_mutex.go.html#2570303">mutexSema</a></span><span class="op" id="2571085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2571090">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571138">}</span><br>
<span class="lineno"></span><span class="op" id="2571140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2571143">func</span>&nbsp;<span class="op" id="2571148">(</span><span class="ident" id="2571149">mu</span>&nbsp;<span class="op" id="2571152">*</span><span class="ident" id="2571153"><a href="/net/fd_mutex.go.html#2567642">fdMutex</a></span><span class="op" id="2571160">)</span>&nbsp;<span class="ident" id="2571162">RWUnlock</span><span class="op" id="2571170">(</span><span class="ident" id="2571171">read</span>&nbsp;<span class="builtintype" id="2571176">bool</span><span class="op" id="2571180">)</span>&nbsp;<span class="builtintype" id="2571182">bool</span>&nbsp;<span class="op" id="2571187">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571190">var</span>&nbsp;<span class="ident" id="2571194">mutexBit</span><span class="op" id="2571202">,</span>&nbsp;<span class="ident" id="2571204">mutexWait</span><span class="op" id="2571213">,</span>&nbsp;<span class="ident" id="2571215">mutexMask</span>&nbsp;<span class="ident" id="2571225">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571233">var</span>&nbsp;<span class="ident" id="2571237">mutexSema</span>&nbsp;<span class="op" id="2571247">*</span><span class="builtintype" id="2571248">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571256">if</span>&nbsp;<span class="ident" id="2571259"><a href="/net/fd_mutex.go.html#2571171">read</a></span>&nbsp;<span class="op" id="2571264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571268"><a href="/net/fd_mutex.go.html#2571194">mutexBit</a></span>&nbsp;<span class="op" id="2571277">=</span>&nbsp;<span class="ident" id="2571279"><a href="/net/fd_mutex.go.html#2568096">mutexRLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571292"><a href="/net/fd_mutex.go.html#2571204">mutexWait</a></span>&nbsp;<span class="op" id="2571302">=</span>&nbsp;<span class="ident" id="2571304"><a href="/net/fd_mutex.go.html#2568198">mutexRWait</a></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571317"><a href="/net/fd_mutex.go.html#2571215">mutexMask</a></span>&nbsp;<span class="op" id="2571327">=</span>&nbsp;<span class="ident" id="2571329"><a href="/net/fd_mutex.go.html#2568222">mutexRMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571342"><a href="/net/fd_mutex.go.html#2571237">mutexSema</a></span>&nbsp;<span class="op" id="2571352">=</span>&nbsp;<span class="op" id="2571354">&amp;</span><span class="ident" id="2571355"><a href="/net/fd_mutex.go.html#2571149">mu</a></span><span class="op" id="2571357">.</span><span class="ident" id="2571358">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571365">}</span>&nbsp;<span class="keyword" id="2571367">else</span>&nbsp;<span class="op" id="2571372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571376"><a href="/net/fd_mutex.go.html#2571194">mutexBit</a></span>&nbsp;<span class="op" id="2571385">=</span>&nbsp;<span class="ident" id="2571387"><a href="/net/fd_mutex.go.html#2568119">mutexWLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571400"><a href="/net/fd_mutex.go.html#2571204">mutexWait</a></span>&nbsp;<span class="op" id="2571410">=</span>&nbsp;<span class="ident" id="2571412"><a href="/net/fd_mutex.go.html#2568256">mutexWWait</a></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571425"><a href="/net/fd_mutex.go.html#2571215">mutexMask</a></span>&nbsp;<span class="op" id="2571435">=</span>&nbsp;<span class="ident" id="2571437"><a href="/net/fd_mutex.go.html#2568280">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571450"><a href="/net/fd_mutex.go.html#2571237">mutexSema</a></span>&nbsp;<span class="op" id="2571460">=</span>&nbsp;<span class="op" id="2571462">&amp;</span><span class="ident" id="2571463"><a href="/net/fd_mutex.go.html#2571149">mu</a></span><span class="op" id="2571465">.</span><span class="ident" id="2571466">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571476">for</span>&nbsp;<span class="op" id="2571480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571484">old</span>&nbsp;<span class="op" id="2571488">:=</span>&nbsp;<span class="ident" id="2571491"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2571497">.</span><span class="ident" id="2571498">LoadUint64</span><span class="op" id="2571508">(</span><span class="op" id="2571509">&amp;</span><span class="ident" id="2571510"><a href="/net/fd_mutex.go.html#2571149">mu</a></span><span class="op" id="2571512">.</span><span class="ident" id="2571513">state</span><span class="op" id="2571518">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571522">if</span>&nbsp;<span class="ident" id="2571525"><a href="/net/fd_mutex.go.html#2571484">old</a></span><span class="op" id="2571528">&amp;</span><span class="ident" id="2571529"><a href="/net/fd_mutex.go.html#2571194">mutexBit</a></span>&nbsp;<span class="op" id="2571538">==</span>&nbsp;<span class="num" id="2571541">0</span>&nbsp;<span class="op" id="2571543">||</span>&nbsp;<span class="ident" id="2571546"><a href="/net/fd_mutex.go.html#2571484">old</a></span><span class="op" id="2571549">&amp;</span><span class="ident" id="2571550"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span>&nbsp;<span class="op" id="2571563">==</span>&nbsp;<span class="num" id="2571566">0</span>&nbsp;<span class="op" id="2571568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2571573">panic</span><span class="op" id="2571578">(</span><span class="string" id="2571579">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2571606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2571614">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2571678">new</span>&nbsp;<span class="op" id="2571682">:=</span>&nbsp;<span class="op" id="2571685">(</span><span class="ident" id="2571686"><a href="/net/fd_mutex.go.html#2571484">old</a></span>&nbsp;<span class="op" id="2571690">&amp;^</span>&nbsp;<span class="ident" id="2571693"><a href="/net/fd_mutex.go.html#2571194">mutexBit</a></span><span class="op" id="2571701">)</span>&nbsp;<span class="op" id="2571703">-</span>&nbsp;<span class="ident" id="2571705"><a href="/net/fd_mutex.go.html#2568142">mutexRef</a></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571716">if</span>&nbsp;<span class="ident" id="2571719"><a href="/net/fd_mutex.go.html#2571484">old</a></span><span class="op" id="2571722">&amp;</span><span class="ident" id="2571723"><a href="/net/fd_mutex.go.html#2571215">mutexMask</a></span>&nbsp;<span class="op" id="2571733">!=</span>&nbsp;<span class="num" id="2571736">0</span>&nbsp;<span class="op" id="2571738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2571743"><a href="/net/fd_mutex.go.html#2571678">new</a></span>&nbsp;<span class="op" id="2571747">-=</span>&nbsp;<span class="ident" id="2571750"><a href="/net/fd_mutex.go.html#2571204">mutexWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571766">if</span>&nbsp;<span class="ident" id="2571769"><a href="/net/fd_mutex.go.html#2567473">atomic</a></span><span class="op" id="2571775">.</span><span class="ident" id="2571776">CompareAndSwapUint64</span><span class="op" id="2571796">(</span><span class="op" id="2571797">&amp;</span><span class="ident" id="2571798"><a href="/net/fd_mutex.go.html#2571149">mu</a></span><span class="op" id="2571800">.</span><span class="ident" id="2571801">state</span><span class="op" id="2571806">,</span>&nbsp;<span class="ident" id="2571808"><a href="/net/fd_mutex.go.html#2571484">old</a></span><span class="op" id="2571811">,</span>&nbsp;<span class="builtinfunc" id="2571813"><a href="/net/fd_mutex.go.html#2571678">new</a></span><span class="op" id="2571816">)</span>&nbsp;<span class="op" id="2571818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571823">if</span>&nbsp;<span class="ident" id="2571826"><a href="/net/fd_mutex.go.html#2571484">old</a></span><span class="op" id="2571829">&amp;</span><span class="ident" id="2571830"><a href="/net/fd_mutex.go.html#2571215">mutexMask</a></span>&nbsp;<span class="op" id="2571840">!=</span>&nbsp;<span class="num" id="2571843">0</span>&nbsp;<span class="op" id="2571845">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2571851"><a href="/net/fd_mutex.go.html#2572030">runtime_Semrelease</a></span><span class="op" id="2571869">(</span><span class="ident" id="2571870"><a href="/net/fd_mutex.go.html#2571237">mutexSema</a></span><span class="op" id="2571879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2571889">return</span>&nbsp;<span class="builtinfunc" id="2571896"><a href="/net/fd_mutex.go.html#2571678">new</a></span><span class="op" id="2571899">&amp;</span><span class="op" id="2571900">(</span><span class="ident" id="2571901"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span><span class="op" id="2571912">|</span><span class="ident" id="2571913"><a href="/net/fd_mutex.go.html#2568165">mutexRefMask</a></span><span class="op" id="2571925">)</span>&nbsp;<span class="op" id="2571927">==</span>&nbsp;<span class="ident" id="2571930"><a href="/net/fd_mutex.go.html#2568073">mutexClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2571947">}</span><br>
<span class="lineno">180</span><span class="op" id="2571949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2571952">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2571987">func</span>&nbsp;<span class="ident" id="2571992">runtime_Semacquire</span><span class="op" id="2572010">(</span><span class="ident" id="2572011">sema</span>&nbsp;<span class="op" id="2572016">*</span><span class="builtintype" id="2572017">uint32</span><span class="op" id="2572023">)</span><br>
<span class="lineno"></span><span class="keyword" id="2572025">func</span>&nbsp;<span class="ident" id="2572030">runtime_Semrelease</span><span class="op" id="2572048">(</span><span class="ident" id="2572049">sema</span>&nbsp;<span class="op" id="2572054">*</span><span class="builtintype" id="2572055">uint32</span><span class="op" id="2572061">)</span>
</div>
</body>
</html>
