<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2195745">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2195800">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2195854">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2195905">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2195922">package</span>&nbsp;<span class="ident" id="2195930">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2195939">import</span>&nbsp;<span class="op" id="2195946">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2195949">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2195958">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2195961">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2196051">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2196078">type</span>&nbsp;<span class="ident" id="2196083">SysProcIDMap</span>&nbsp;<span class="keyword" id="2196096">struct</span>&nbsp;<span class="op" id="2196103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196106">ContainerID</span>&nbsp;<span class="builtintype" id="2196118">int</span>&nbsp;<span class="comment" id="2196122">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196140">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196152">int</span>&nbsp;<span class="comment" id="2196156">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196169">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196181">int</span>&nbsp;<span class="comment" id="2196185">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2196194">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2196197">type</span>&nbsp;<span class="ident" id="2196202">SysProcAttr</span>&nbsp;<span class="keyword" id="2196214">struct</span>&nbsp;<span class="op" id="2196221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196224">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196236">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196251">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196263">Credential</span>&nbsp;&nbsp;<span class="op" id="2196275">*</span><span class="ident" id="2196276">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196290">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196306">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196318">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196333">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196353">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196365">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196380">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196400">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196412">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196427">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196478">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196490">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196505">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196580">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196592">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196607">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196649">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2196661">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196676">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196712">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2196724">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196739">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196810">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2196822">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2196837">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196876">UidMappings</span>&nbsp;<span class="op" id="2196888">[</span><span class="op" id="2196889">]</span><span class="ident" id="2196890">SysProcIDMap</span>&nbsp;<span class="comment" id="2196903">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196945">GidMappings</span>&nbsp;<span class="op" id="2196957">[</span><span class="op" id="2196958">]</span><span class="ident" id="2196959">SysProcIDMap</span>&nbsp;<span class="comment" id="2196972">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2197014">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2197017">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2197052">func</span>&nbsp;<span class="ident" id="2197057">runtime_BeforeFork</span><span class="op" id="2197075">(</span><span class="op" id="2197076">)</span><br>
<span class="lineno"></span><span class="keyword" id="2197078">func</span>&nbsp;<span class="ident" id="2197083">runtime_AfterFork</span><span class="op" id="2197100">(</span><span class="op" id="2197101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2197104">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2197176">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2197234">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2197301">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2197368">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2197436">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2197500">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2197561">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2197623">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2197664">func</span>&nbsp;<span class="ident" id="2197669">forkAndExecInChild</span><span class="op" id="2197687">(</span><span class="ident" id="2197688">argv0</span>&nbsp;<span class="op" id="2197694">*</span><span class="builtintype" id="2197695">byte</span><span class="op" id="2197699">,</span>&nbsp;<span class="ident" id="2197701">argv</span><span class="op" id="2197705">,</span>&nbsp;<span class="ident" id="2197707">envv</span>&nbsp;<span class="op" id="2197712">[</span><span class="op" id="2197713">]</span><span class="op" id="2197714">*</span><span class="builtintype" id="2197715">byte</span><span class="op" id="2197719">,</span>&nbsp;<span class="ident" id="2197721">chroot</span><span class="op" id="2197727">,</span>&nbsp;<span class="ident" id="2197729">dir</span>&nbsp;<span class="op" id="2197733">*</span><span class="builtintype" id="2197734">byte</span><span class="op" id="2197738">,</span>&nbsp;<span class="ident" id="2197740">attr</span>&nbsp;<span class="op" id="2197745">*</span><span class="ident" id="2197746">ProcAttr</span><span class="op" id="2197754">,</span>&nbsp;<span class="ident" id="2197756">sys</span>&nbsp;<span class="op" id="2197760">*</span><span class="ident" id="2197761">SysProcAttr</span><span class="op" id="2197772">,</span>&nbsp;<span class="ident" id="2197774">pipe</span>&nbsp;<span class="builtintype" id="2197779">int</span><span class="op" id="2197782">)</span>&nbsp;<span class="op" id="2197784">(</span><span class="ident" id="2197785">pid</span>&nbsp;<span class="builtintype" id="2197789">int</span><span class="op" id="2197792">,</span>&nbsp;<span class="ident" id="2197794">err</span>&nbsp;<span class="ident" id="2197798">Errno</span><span class="op" id="2197803">)</span>&nbsp;<span class="op" id="2197805">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2197808">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2197853">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197908">var</span>&nbsp;<span class="op" id="2197912">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197916">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2197923">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197933">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2197940">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197948">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2197955">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197963">nextfd</span>&nbsp;<span class="builtintype" id="2197970">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197976">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2197983">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197989">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2197996">[</span><span class="num" id="2197997">2</span><span class="op" id="2197998">]</span><span class="builtintype" id="2197999">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198004">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198008">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198063">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198127">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198186">fd</span>&nbsp;<span class="op" id="2198189">:=</span>&nbsp;<span class="builtinfunc" id="2198192">make</span><span class="op" id="2198196">(</span><span class="op" id="2198197">[</span><span class="op" id="2198198">]</span><span class="builtintype" id="2198199">int</span><span class="op" id="2198202">,</span>&nbsp;<span class="builtinfunc" id="2198204">len</span><span class="op" id="2198207">(</span><span class="ident" id="2198208">attr</span><span class="op" id="2198212">.</span><span class="ident" id="2198213">Files</span><span class="op" id="2198218">)</span><span class="op" id="2198219">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198222">nextfd</span>&nbsp;<span class="op" id="2198229">=</span>&nbsp;<span class="builtinfunc" id="2198231">len</span><span class="op" id="2198234">(</span><span class="ident" id="2198235">attr</span><span class="op" id="2198239">.</span><span class="ident" id="2198240">Files</span><span class="op" id="2198245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198248">for</span>&nbsp;<span class="ident" id="2198252">i</span><span class="op" id="2198253">,</span>&nbsp;<span class="ident" id="2198255">ufd</span>&nbsp;<span class="op" id="2198259">:=</span>&nbsp;<span class="keyword" id="2198262">range</span>&nbsp;<span class="ident" id="2198268">attr</span><span class="op" id="2198272">.</span><span class="ident" id="2198273">Files</span>&nbsp;<span class="op" id="2198279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198283">if</span>&nbsp;<span class="ident" id="2198286">nextfd</span>&nbsp;<span class="op" id="2198293">&lt;</span>&nbsp;<span class="builtintype" id="2198295">int</span><span class="op" id="2198298">(</span><span class="ident" id="2198299">ufd</span><span class="op" id="2198302">)</span>&nbsp;<span class="op" id="2198304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198309">nextfd</span>&nbsp;<span class="op" id="2198316">=</span>&nbsp;<span class="builtintype" id="2198318">int</span><span class="op" id="2198321">(</span><span class="ident" id="2198322">ufd</span><span class="op" id="2198325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198329">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198333">fd</span><span class="op" id="2198335">[</span><span class="ident" id="2198336">i</span><span class="op" id="2198337">]</span>&nbsp;<span class="op" id="2198339">=</span>&nbsp;<span class="builtintype" id="2198341">int</span><span class="op" id="2198344">(</span><span class="ident" id="2198345">ufd</span><span class="op" id="2198348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198354">nextfd</span><span class="op" id="2198360">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198365">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198429">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198485">if</span>&nbsp;<span class="ident" id="2198488">sys</span><span class="op" id="2198491">.</span><span class="ident" id="2198492">UidMappings</span>&nbsp;<span class="op" id="2198504">!=</span>&nbsp;<span class="ident" id="2198507">nil</span>&nbsp;<span class="op" id="2198511">||</span>&nbsp;<span class="ident" id="2198514">sys</span><span class="op" id="2198517">.</span><span class="ident" id="2198518">GidMappings</span>&nbsp;<span class="op" id="2198530">!=</span>&nbsp;<span class="ident" id="2198533">nil</span>&nbsp;<span class="op" id="2198537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198541">if</span>&nbsp;<span class="ident" id="2198544">err</span>&nbsp;<span class="op" id="2198548">:=</span>&nbsp;<span class="ident" id="2198551">forkExecPipe</span><span class="op" id="2198563">(</span><span class="ident" id="2198564">p</span><span class="op" id="2198565">[</span><span class="op" id="2198566">:</span><span class="op" id="2198567">]</span><span class="op" id="2198568">)</span><span class="op" id="2198569">;</span>&nbsp;<span class="ident" id="2198571">err</span>&nbsp;<span class="op" id="2198575">!=</span>&nbsp;<span class="ident" id="2198578">nil</span>&nbsp;<span class="op" id="2198582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198587">return</span>&nbsp;<span class="num" id="2198594">0</span><span class="op" id="2198595">,</span>&nbsp;<span class="ident" id="2198597">err</span><span class="op" id="2198600">.</span><span class="op" id="2198601">(</span><span class="ident" id="2198602">Errno</span><span class="op" id="2198607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198611">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198618">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198642">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198701">runtime_BeforeFork</span><span class="op" id="2198719">(</span><span class="op" id="2198720">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198723">r1</span><span class="op" id="2198725">,</span>&nbsp;<span class="ident" id="2198727">_</span><span class="op" id="2198728">,</span>&nbsp;<span class="ident" id="2198730">err1</span>&nbsp;<span class="op" id="2198735">=</span>&nbsp;<span class="ident" id="2198737">RawSyscall6</span><span class="op" id="2198748">(</span><span class="ident" id="2198749">SYS_CLONE</span><span class="op" id="2198758">,</span>&nbsp;<span class="builtintype" id="2198760">uintptr</span><span class="op" id="2198767">(</span><span class="ident" id="2198768">SIGCHLD</span><span class="op" id="2198775">)</span><span class="op" id="2198776">|</span><span class="ident" id="2198777">sys</span><span class="op" id="2198780">.</span><span class="ident" id="2198781">Cloneflags</span><span class="op" id="2198791">,</span>&nbsp;<span class="num" id="2198793">0</span><span class="op" id="2198794">,</span>&nbsp;<span class="num" id="2198796">0</span><span class="op" id="2198797">,</span>&nbsp;<span class="num" id="2198799">0</span><span class="op" id="2198800">,</span>&nbsp;<span class="num" id="2198802">0</span><span class="op" id="2198803">,</span>&nbsp;<span class="num" id="2198805">0</span><span class="op" id="2198806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198809">if</span>&nbsp;<span class="ident" id="2198812">err1</span>&nbsp;<span class="op" id="2198817">!=</span>&nbsp;<span class="num" id="2198820">0</span>&nbsp;<span class="op" id="2198822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198826">runtime_AfterFork</span><span class="op" id="2198843">(</span><span class="op" id="2198844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198848">return</span>&nbsp;<span class="num" id="2198855">0</span><span class="op" id="2198856">,</span>&nbsp;<span class="ident" id="2198858">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198864">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198868">if</span>&nbsp;<span class="ident" id="2198871">r1</span>&nbsp;<span class="op" id="2198874">!=</span>&nbsp;<span class="num" id="2198877">0</span>&nbsp;<span class="op" id="2198879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2198883">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198907">runtime_AfterFork</span><span class="op" id="2198924">(</span><span class="op" id="2198925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198929">pid</span>&nbsp;<span class="op" id="2198933">=</span>&nbsp;<span class="builtintype" id="2198935">int</span><span class="op" id="2198938">(</span><span class="ident" id="2198939">r1</span><span class="op" id="2198941">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198946">if</span>&nbsp;<span class="ident" id="2198949">sys</span><span class="op" id="2198952">.</span><span class="ident" id="2198953">UidMappings</span>&nbsp;<span class="op" id="2198965">!=</span>&nbsp;<span class="ident" id="2198968">nil</span>&nbsp;<span class="op" id="2198972">||</span>&nbsp;<span class="ident" id="2198975">sys</span><span class="op" id="2198978">.</span><span class="ident" id="2198979">GidMappings</span>&nbsp;<span class="op" id="2198991">!=</span>&nbsp;<span class="ident" id="2198994">nil</span>&nbsp;<span class="op" id="2198998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199003">Close</span><span class="op" id="2199008">(</span><span class="ident" id="2199009">p</span><span class="op" id="2199010">[</span><span class="num" id="2199011">0</span><span class="op" id="2199012">]</span><span class="op" id="2199013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199018">err</span>&nbsp;<span class="op" id="2199022">:=</span>&nbsp;<span class="ident" id="2199025">writeUidGidMappings</span><span class="op" id="2199044">(</span><span class="ident" id="2199045">pid</span><span class="op" id="2199048">,</span>&nbsp;<span class="ident" id="2199050">sys</span><span class="op" id="2199053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199058">if</span>&nbsp;<span class="ident" id="2199061">err</span>&nbsp;<span class="op" id="2199065">!=</span>&nbsp;<span class="ident" id="2199068">nil</span>&nbsp;<span class="op" id="2199072">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199078">err2</span>&nbsp;<span class="op" id="2199083">=</span>&nbsp;<span class="ident" id="2199085">err</span><span class="op" id="2199088">.</span><span class="op" id="2199089">(</span><span class="ident" id="2199090">Errno</span><span class="op" id="2199095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199105">RawSyscall</span><span class="op" id="2199115">(</span><span class="ident" id="2199116">SYS_WRITE</span><span class="op" id="2199125">,</span>&nbsp;<span class="builtintype" id="2199127">uintptr</span><span class="op" id="2199134">(</span><span class="ident" id="2199135">p</span><span class="op" id="2199136">[</span><span class="num" id="2199137">1</span><span class="op" id="2199138">]</span><span class="op" id="2199139">)</span><span class="op" id="2199140">,</span>&nbsp;<span class="builtintype" id="2199142">uintptr</span><span class="op" id="2199149">(</span><span class="ident" id="2199150">unsafe</span><span class="op" id="2199156">.</span><span class="ident" id="2199157">Pointer</span><span class="op" id="2199164">(</span><span class="op" id="2199165">&amp;</span><span class="ident" id="2199166">err2</span><span class="op" id="2199170">)</span><span class="op" id="2199171">)</span><span class="op" id="2199172">,</span>&nbsp;<span class="ident" id="2199174">unsafe</span><span class="op" id="2199180">.</span><span class="ident" id="2199181">Sizeof</span><span class="op" id="2199187">(</span><span class="ident" id="2199188">err2</span><span class="op" id="2199192">)</span><span class="op" id="2199193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199198">Close</span><span class="op" id="2199203">(</span><span class="ident" id="2199204">p</span><span class="op" id="2199205">[</span><span class="num" id="2199206">1</span><span class="op" id="2199207">]</span><span class="op" id="2199208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199212">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199217">return</span>&nbsp;<span class="ident" id="2199224">pid</span><span class="op" id="2199227">,</span>&nbsp;<span class="num" id="2199229">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2199236">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2199271">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199325">if</span>&nbsp;<span class="ident" id="2199328">sys</span><span class="op" id="2199331">.</span><span class="ident" id="2199332">UidMappings</span>&nbsp;<span class="op" id="2199344">!=</span>&nbsp;<span class="ident" id="2199347">nil</span>&nbsp;<span class="op" id="2199351">||</span>&nbsp;<span class="ident" id="2199354">sys</span><span class="op" id="2199357">.</span><span class="ident" id="2199358">GidMappings</span>&nbsp;<span class="op" id="2199370">!=</span>&nbsp;<span class="ident" id="2199373">nil</span>&nbsp;<span class="op" id="2199377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199381">if</span>&nbsp;<span class="ident" id="2199384">_</span><span class="op" id="2199385">,</span>&nbsp;<span class="ident" id="2199387">_</span><span class="op" id="2199388">,</span>&nbsp;<span class="ident" id="2199390">err1</span>&nbsp;<span class="op" id="2199395">=</span>&nbsp;<span class="ident" id="2199397">RawSyscall</span><span class="op" id="2199407">(</span><span class="ident" id="2199408">SYS_CLOSE</span><span class="op" id="2199417">,</span>&nbsp;<span class="builtintype" id="2199419">uintptr</span><span class="op" id="2199426">(</span><span class="ident" id="2199427">p</span><span class="op" id="2199428">[</span><span class="num" id="2199429">1</span><span class="op" id="2199430">]</span><span class="op" id="2199431">)</span><span class="op" id="2199432">,</span>&nbsp;<span class="num" id="2199434">0</span><span class="op" id="2199435">,</span>&nbsp;<span class="num" id="2199437">0</span><span class="op" id="2199438">)</span><span class="op" id="2199439">;</span>&nbsp;<span class="ident" id="2199441">err1</span>&nbsp;<span class="op" id="2199446">!=</span>&nbsp;<span class="num" id="2199449">0</span>&nbsp;<span class="op" id="2199451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199456">goto</span>&nbsp;<span class="ident" id="2199461">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199478">r1</span><span class="op" id="2199480">,</span>&nbsp;<span class="ident" id="2199482">_</span><span class="op" id="2199483">,</span>&nbsp;<span class="ident" id="2199485">err1</span>&nbsp;<span class="op" id="2199490">=</span>&nbsp;<span class="ident" id="2199492">RawSyscall</span><span class="op" id="2199502">(</span><span class="ident" id="2199503">SYS_READ</span><span class="op" id="2199511">,</span>&nbsp;<span class="builtintype" id="2199513">uintptr</span><span class="op" id="2199520">(</span><span class="ident" id="2199521">p</span><span class="op" id="2199522">[</span><span class="num" id="2199523">0</span><span class="op" id="2199524">]</span><span class="op" id="2199525">)</span><span class="op" id="2199526">,</span>&nbsp;<span class="builtintype" id="2199528">uintptr</span><span class="op" id="2199535">(</span><span class="ident" id="2199536">unsafe</span><span class="op" id="2199542">.</span><span class="ident" id="2199543">Pointer</span><span class="op" id="2199550">(</span><span class="op" id="2199551">&amp;</span><span class="ident" id="2199552">err2</span><span class="op" id="2199556">)</span><span class="op" id="2199557">)</span><span class="op" id="2199558">,</span>&nbsp;<span class="ident" id="2199560">unsafe</span><span class="op" id="2199566">.</span><span class="ident" id="2199567">Sizeof</span><span class="op" id="2199573">(</span><span class="ident" id="2199574">err2</span><span class="op" id="2199578">)</span><span class="op" id="2199579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199583">if</span>&nbsp;<span class="ident" id="2199586">err1</span>&nbsp;<span class="op" id="2199591">!=</span>&nbsp;<span class="num" id="2199594">0</span>&nbsp;<span class="op" id="2199596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199601">goto</span>&nbsp;<span class="ident" id="2199606">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199619">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199623">if</span>&nbsp;<span class="ident" id="2199626">r1</span>&nbsp;<span class="op" id="2199629">!=</span>&nbsp;<span class="ident" id="2199632">unsafe</span><span class="op" id="2199638">.</span><span class="ident" id="2199639">Sizeof</span><span class="op" id="2199645">(</span><span class="ident" id="2199646">err2</span><span class="op" id="2199650">)</span>&nbsp;<span class="op" id="2199652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199657">err1</span>&nbsp;<span class="op" id="2199662">=</span>&nbsp;<span class="ident" id="2199664">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199674">goto</span>&nbsp;<span class="ident" id="2199679">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199696">if</span>&nbsp;<span class="ident" id="2199699">err2</span>&nbsp;<span class="op" id="2199704">!=</span>&nbsp;<span class="num" id="2199707">0</span>&nbsp;<span class="op" id="2199709">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199714">err1</span>&nbsp;<span class="op" id="2199719">=</span>&nbsp;<span class="ident" id="2199721">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199729">goto</span>&nbsp;<span class="ident" id="2199734">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2199754">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199778">if</span>&nbsp;<span class="ident" id="2199781">sys</span><span class="op" id="2199784">.</span><span class="ident" id="2199785">Pdeathsig</span>&nbsp;<span class="op" id="2199795">!=</span>&nbsp;<span class="num" id="2199798">0</span>&nbsp;<span class="op" id="2199800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199804">_</span><span class="op" id="2199805">,</span>&nbsp;<span class="ident" id="2199807">_</span><span class="op" id="2199808">,</span>&nbsp;<span class="ident" id="2199810">err1</span>&nbsp;<span class="op" id="2199815">=</span>&nbsp;<span class="ident" id="2199817">RawSyscall6</span><span class="op" id="2199828">(</span><span class="ident" id="2199829">SYS_PRCTL</span><span class="op" id="2199838">,</span>&nbsp;<span class="ident" id="2199840">PR_SET_PDEATHSIG</span><span class="op" id="2199856">,</span>&nbsp;<span class="builtintype" id="2199858">uintptr</span><span class="op" id="2199865">(</span><span class="ident" id="2199866">sys</span><span class="op" id="2199869">.</span><span class="ident" id="2199870">Pdeathsig</span><span class="op" id="2199879">)</span><span class="op" id="2199880">,</span>&nbsp;<span class="num" id="2199882">0</span><span class="op" id="2199883">,</span>&nbsp;<span class="num" id="2199885">0</span><span class="op" id="2199886">,</span>&nbsp;<span class="num" id="2199888">0</span><span class="op" id="2199889">,</span>&nbsp;<span class="num" id="2199891">0</span><span class="op" id="2199892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199896">if</span>&nbsp;<span class="ident" id="2199899">err1</span>&nbsp;<span class="op" id="2199904">!=</span>&nbsp;<span class="num" id="2199907">0</span>&nbsp;<span class="op" id="2199909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199914">goto</span>&nbsp;<span class="ident" id="2199919">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2199937">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200000">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200062">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200082">r1</span><span class="op" id="2200084">,</span>&nbsp;<span class="ident" id="2200086">_</span><span class="op" id="2200087">,</span>&nbsp;<span class="ident" id="2200089">_</span>&nbsp;<span class="op" id="2200091">=</span>&nbsp;<span class="ident" id="2200093">RawSyscall</span><span class="op" id="2200103">(</span><span class="ident" id="2200104">SYS_GETPPID</span><span class="op" id="2200115">,</span>&nbsp;<span class="num" id="2200117">0</span><span class="op" id="2200118">,</span>&nbsp;<span class="num" id="2200120">0</span><span class="op" id="2200121">,</span>&nbsp;<span class="num" id="2200123">0</span><span class="op" id="2200124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200128">if</span>&nbsp;<span class="ident" id="2200131">r1</span>&nbsp;<span class="op" id="2200134">==</span>&nbsp;<span class="num" id="2200137">1</span>&nbsp;<span class="op" id="2200139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200144">pid</span><span class="op" id="2200147">,</span>&nbsp;<span class="ident" id="2200149">_</span><span class="op" id="2200150">,</span>&nbsp;<span class="ident" id="2200152">_</span>&nbsp;<span class="op" id="2200154">:=</span>&nbsp;<span class="ident" id="2200157">RawSyscall</span><span class="op" id="2200167">(</span><span class="ident" id="2200168">SYS_GETPID</span><span class="op" id="2200178">,</span>&nbsp;<span class="num" id="2200180">0</span><span class="op" id="2200181">,</span>&nbsp;<span class="num" id="2200183">0</span><span class="op" id="2200184">,</span>&nbsp;<span class="num" id="2200186">0</span><span class="op" id="2200187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200192">_</span><span class="op" id="2200193">,</span>&nbsp;<span class="ident" id="2200195">_</span><span class="op" id="2200196">,</span>&nbsp;<span class="ident" id="2200198">err1</span>&nbsp;<span class="op" id="2200203">:=</span>&nbsp;<span class="ident" id="2200206">RawSyscall</span><span class="op" id="2200216">(</span><span class="ident" id="2200217">SYS_KILL</span><span class="op" id="2200225">,</span>&nbsp;<span class="ident" id="2200227">pid</span><span class="op" id="2200230">,</span>&nbsp;<span class="builtintype" id="2200232">uintptr</span><span class="op" id="2200239">(</span><span class="ident" id="2200240">sys</span><span class="op" id="2200243">.</span><span class="ident" id="2200244">Pdeathsig</span><span class="op" id="2200253">)</span><span class="op" id="2200254">,</span>&nbsp;<span class="num" id="2200256">0</span><span class="op" id="2200257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200262">if</span>&nbsp;<span class="ident" id="2200265">err1</span>&nbsp;<span class="op" id="2200270">!=</span>&nbsp;<span class="num" id="2200273">0</span>&nbsp;<span class="op" id="2200275">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200281">goto</span>&nbsp;<span class="ident" id="2200286">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200311">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200344">if</span>&nbsp;<span class="ident" id="2200347">sys</span><span class="op" id="2200350">.</span><span class="ident" id="2200351">Ptrace</span>&nbsp;<span class="op" id="2200358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200362">_</span><span class="op" id="2200363">,</span>&nbsp;<span class="ident" id="2200365">_</span><span class="op" id="2200366">,</span>&nbsp;<span class="ident" id="2200368">err1</span>&nbsp;<span class="op" id="2200373">=</span>&nbsp;<span class="ident" id="2200375">RawSyscall</span><span class="op" id="2200385">(</span><span class="ident" id="2200386">SYS_PTRACE</span><span class="op" id="2200396">,</span>&nbsp;<span class="builtintype" id="2200398">uintptr</span><span class="op" id="2200405">(</span><span class="ident" id="2200406">PTRACE_TRACEME</span><span class="op" id="2200420">)</span><span class="op" id="2200421">,</span>&nbsp;<span class="num" id="2200423">0</span><span class="op" id="2200424">,</span>&nbsp;<span class="num" id="2200426">0</span><span class="op" id="2200427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200431">if</span>&nbsp;<span class="ident" id="2200434">err1</span>&nbsp;<span class="op" id="2200439">!=</span>&nbsp;<span class="num" id="2200442">0</span>&nbsp;<span class="op" id="2200444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200449">goto</span>&nbsp;<span class="ident" id="2200454">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200474">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200489">if</span>&nbsp;<span class="ident" id="2200492">sys</span><span class="op" id="2200495">.</span><span class="ident" id="2200496">Setsid</span>&nbsp;<span class="op" id="2200503">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200507">_</span><span class="op" id="2200508">,</span>&nbsp;<span class="ident" id="2200510">_</span><span class="op" id="2200511">,</span>&nbsp;<span class="ident" id="2200513">err1</span>&nbsp;<span class="op" id="2200518">=</span>&nbsp;<span class="ident" id="2200520">RawSyscall</span><span class="op" id="2200530">(</span><span class="ident" id="2200531">SYS_SETSID</span><span class="op" id="2200541">,</span>&nbsp;<span class="num" id="2200543">0</span><span class="op" id="2200544">,</span>&nbsp;<span class="num" id="2200546">0</span><span class="op" id="2200547">,</span>&nbsp;<span class="num" id="2200549">0</span><span class="op" id="2200550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200554">if</span>&nbsp;<span class="ident" id="2200557">err1</span>&nbsp;<span class="op" id="2200562">!=</span>&nbsp;<span class="num" id="2200565">0</span>&nbsp;<span class="op" id="2200567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200572">goto</span>&nbsp;<span class="ident" id="2200577">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200593">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200597">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200619">if</span>&nbsp;<span class="ident" id="2200622">sys</span><span class="op" id="2200625">.</span><span class="ident" id="2200626">Setpgid</span>&nbsp;<span class="op" id="2200634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200638">_</span><span class="op" id="2200639">,</span>&nbsp;<span class="ident" id="2200641">_</span><span class="op" id="2200642">,</span>&nbsp;<span class="ident" id="2200644">err1</span>&nbsp;<span class="op" id="2200649">=</span>&nbsp;<span class="ident" id="2200651">RawSyscall</span><span class="op" id="2200661">(</span><span class="ident" id="2200662">SYS_SETPGID</span><span class="op" id="2200673">,</span>&nbsp;<span class="num" id="2200675">0</span><span class="op" id="2200676">,</span>&nbsp;<span class="num" id="2200678">0</span><span class="op" id="2200679">,</span>&nbsp;<span class="num" id="2200681">0</span><span class="op" id="2200682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200686">if</span>&nbsp;<span class="ident" id="2200689">err1</span>&nbsp;<span class="op" id="2200694">!=</span>&nbsp;<span class="num" id="2200697">0</span>&nbsp;<span class="op" id="2200699">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200704">goto</span>&nbsp;<span class="ident" id="2200709">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200729">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200740">if</span>&nbsp;<span class="ident" id="2200743">chroot</span>&nbsp;<span class="op" id="2200750">!=</span>&nbsp;<span class="ident" id="2200753">nil</span>&nbsp;<span class="op" id="2200757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200761">_</span><span class="op" id="2200762">,</span>&nbsp;<span class="ident" id="2200764">_</span><span class="op" id="2200765">,</span>&nbsp;<span class="ident" id="2200767">err1</span>&nbsp;<span class="op" id="2200772">=</span>&nbsp;<span class="ident" id="2200774">RawSyscall</span><span class="op" id="2200784">(</span><span class="ident" id="2200785">SYS_CHROOT</span><span class="op" id="2200795">,</span>&nbsp;<span class="builtintype" id="2200797">uintptr</span><span class="op" id="2200804">(</span><span class="ident" id="2200805">unsafe</span><span class="op" id="2200811">.</span><span class="ident" id="2200812">Pointer</span><span class="op" id="2200819">(</span><span class="ident" id="2200820">chroot</span><span class="op" id="2200826">)</span><span class="op" id="2200827">)</span><span class="op" id="2200828">,</span>&nbsp;<span class="num" id="2200830">0</span><span class="op" id="2200831">,</span>&nbsp;<span class="num" id="2200833">0</span><span class="op" id="2200834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200838">if</span>&nbsp;<span class="ident" id="2200841">err1</span>&nbsp;<span class="op" id="2200846">!=</span>&nbsp;<span class="num" id="2200849">0</span>&nbsp;<span class="op" id="2200851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200856">goto</span>&nbsp;<span class="ident" id="2200861">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200874">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200881">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200901">if</span>&nbsp;<span class="ident" id="2200904">cred</span>&nbsp;<span class="op" id="2200909">:=</span>&nbsp;<span class="ident" id="2200912">sys</span><span class="op" id="2200915">.</span><span class="ident" id="2200916">Credential</span><span class="op" id="2200926">;</span>&nbsp;<span class="ident" id="2200928">cred</span>&nbsp;<span class="op" id="2200933">!=</span>&nbsp;<span class="ident" id="2200936">nil</span>&nbsp;<span class="op" id="2200940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200944">ngroups</span>&nbsp;<span class="op" id="2200952">:=</span>&nbsp;<span class="builtintype" id="2200955">uintptr</span><span class="op" id="2200962">(</span><span class="builtinfunc" id="2200963">len</span><span class="op" id="2200966">(</span><span class="ident" id="2200967">cred</span><span class="op" id="2200971">.</span><span class="ident" id="2200972">Groups</span><span class="op" id="2200978">)</span><span class="op" id="2200979">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200983">var</span>&nbsp;<span class="ident" id="2200987">groups</span>&nbsp;<span class="ident" id="2200994">unsafe</span><span class="op" id="2201000">.</span><span class="ident" id="2201001">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201011">if</span>&nbsp;<span class="ident" id="2201014">ngroups</span>&nbsp;<span class="op" id="2201022">&gt;</span>&nbsp;<span class="num" id="2201024">0</span>&nbsp;<span class="op" id="2201026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201031">groups</span>&nbsp;<span class="op" id="2201038">=</span>&nbsp;<span class="ident" id="2201040">unsafe</span><span class="op" id="2201046">.</span><span class="ident" id="2201047">Pointer</span><span class="op" id="2201054">(</span><span class="op" id="2201055">&amp;</span><span class="ident" id="2201056">cred</span><span class="op" id="2201060">.</span><span class="ident" id="2201061">Groups</span><span class="op" id="2201067">[</span><span class="num" id="2201068">0</span><span class="op" id="2201069">]</span><span class="op" id="2201070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201078">_</span><span class="op" id="2201079">,</span>&nbsp;<span class="ident" id="2201081">_</span><span class="op" id="2201082">,</span>&nbsp;<span class="ident" id="2201084">err1</span>&nbsp;<span class="op" id="2201089">=</span>&nbsp;<span class="ident" id="2201091">RawSyscall</span><span class="op" id="2201101">(</span><span class="ident" id="2201102">SYS_SETGROUPS</span><span class="op" id="2201115">,</span>&nbsp;<span class="ident" id="2201117">ngroups</span><span class="op" id="2201124">,</span>&nbsp;<span class="builtintype" id="2201126">uintptr</span><span class="op" id="2201133">(</span><span class="ident" id="2201134">groups</span><span class="op" id="2201140">)</span><span class="op" id="2201141">,</span>&nbsp;<span class="num" id="2201143">0</span><span class="op" id="2201144">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201148">if</span>&nbsp;<span class="ident" id="2201151">err1</span>&nbsp;<span class="op" id="2201156">!=</span>&nbsp;<span class="num" id="2201159">0</span>&nbsp;<span class="op" id="2201161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201166">goto</span>&nbsp;<span class="ident" id="2201171">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201188">_</span><span class="op" id="2201189">,</span>&nbsp;<span class="ident" id="2201191">_</span><span class="op" id="2201192">,</span>&nbsp;<span class="ident" id="2201194">err1</span>&nbsp;<span class="op" id="2201199">=</span>&nbsp;<span class="ident" id="2201201">RawSyscall</span><span class="op" id="2201211">(</span><span class="ident" id="2201212">SYS_SETGID</span><span class="op" id="2201222">,</span>&nbsp;<span class="builtintype" id="2201224">uintptr</span><span class="op" id="2201231">(</span><span class="ident" id="2201232">cred</span><span class="op" id="2201236">.</span><span class="ident" id="2201237">Gid</span><span class="op" id="2201240">)</span><span class="op" id="2201241">,</span>&nbsp;<span class="num" id="2201243">0</span><span class="op" id="2201244">,</span>&nbsp;<span class="num" id="2201246">0</span><span class="op" id="2201247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201251">if</span>&nbsp;<span class="ident" id="2201254">err1</span>&nbsp;<span class="op" id="2201259">!=</span>&nbsp;<span class="num" id="2201262">0</span>&nbsp;<span class="op" id="2201264">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201269">goto</span>&nbsp;<span class="ident" id="2201274">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201291">_</span><span class="op" id="2201292">,</span>&nbsp;<span class="ident" id="2201294">_</span><span class="op" id="2201295">,</span>&nbsp;<span class="ident" id="2201297">err1</span>&nbsp;<span class="op" id="2201302">=</span>&nbsp;<span class="ident" id="2201304">RawSyscall</span><span class="op" id="2201314">(</span><span class="ident" id="2201315">SYS_SETUID</span><span class="op" id="2201325">,</span>&nbsp;<span class="builtintype" id="2201327">uintptr</span><span class="op" id="2201334">(</span><span class="ident" id="2201335">cred</span><span class="op" id="2201339">.</span><span class="ident" id="2201340">Uid</span><span class="op" id="2201343">)</span><span class="op" id="2201344">,</span>&nbsp;<span class="num" id="2201346">0</span><span class="op" id="2201347">,</span>&nbsp;<span class="num" id="2201349">0</span><span class="op" id="2201350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201354">if</span>&nbsp;<span class="ident" id="2201357">err1</span>&nbsp;<span class="op" id="2201362">!=</span>&nbsp;<span class="num" id="2201365">0</span>&nbsp;<span class="op" id="2201367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201372">goto</span>&nbsp;<span class="ident" id="2201377">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2201397">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201407">if</span>&nbsp;<span class="ident" id="2201410">dir</span>&nbsp;<span class="op" id="2201414">!=</span>&nbsp;<span class="ident" id="2201417">nil</span>&nbsp;<span class="op" id="2201421">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201425">_</span><span class="op" id="2201426">,</span>&nbsp;<span class="ident" id="2201428">_</span><span class="op" id="2201429">,</span>&nbsp;<span class="ident" id="2201431">err1</span>&nbsp;<span class="op" id="2201436">=</span>&nbsp;<span class="ident" id="2201438">RawSyscall</span><span class="op" id="2201448">(</span><span class="ident" id="2201449">SYS_CHDIR</span><span class="op" id="2201458">,</span>&nbsp;<span class="builtintype" id="2201460">uintptr</span><span class="op" id="2201467">(</span><span class="ident" id="2201468">unsafe</span><span class="op" id="2201474">.</span><span class="ident" id="2201475">Pointer</span><span class="op" id="2201482">(</span><span class="ident" id="2201483">dir</span><span class="op" id="2201486">)</span><span class="op" id="2201487">)</span><span class="op" id="2201488">,</span>&nbsp;<span class="num" id="2201490">0</span><span class="op" id="2201491">,</span>&nbsp;<span class="num" id="2201493">0</span><span class="op" id="2201494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201498">if</span>&nbsp;<span class="ident" id="2201501">err1</span>&nbsp;<span class="op" id="2201506">!=</span>&nbsp;<span class="num" id="2201509">0</span>&nbsp;<span class="op" id="2201511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201516">goto</span>&nbsp;<span class="ident" id="2201521">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201537">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2201541">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2201604">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201660">if</span>&nbsp;<span class="ident" id="2201663">pipe</span>&nbsp;<span class="op" id="2201668">&lt;</span>&nbsp;<span class="ident" id="2201670">nextfd</span>&nbsp;<span class="op" id="2201677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201681">_</span><span class="op" id="2201682">,</span>&nbsp;<span class="ident" id="2201684">_</span><span class="op" id="2201685">,</span>&nbsp;<span class="ident" id="2201687">err1</span>&nbsp;<span class="op" id="2201692">=</span>&nbsp;<span class="ident" id="2201694">RawSyscall</span><span class="op" id="2201704">(</span><span class="ident" id="2201705">SYS_DUP2</span><span class="op" id="2201713">,</span>&nbsp;<span class="builtintype" id="2201715">uintptr</span><span class="op" id="2201722">(</span><span class="ident" id="2201723">pipe</span><span class="op" id="2201727">)</span><span class="op" id="2201728">,</span>&nbsp;<span class="builtintype" id="2201730">uintptr</span><span class="op" id="2201737">(</span><span class="ident" id="2201738">nextfd</span><span class="op" id="2201744">)</span><span class="op" id="2201745">,</span>&nbsp;<span class="num" id="2201747">0</span><span class="op" id="2201748">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201752">if</span>&nbsp;<span class="ident" id="2201755">err1</span>&nbsp;<span class="op" id="2201760">!=</span>&nbsp;<span class="num" id="2201763">0</span>&nbsp;<span class="op" id="2201765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201770">goto</span>&nbsp;<span class="ident" id="2201775">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201792">RawSyscall</span><span class="op" id="2201802">(</span><span class="ident" id="2201803">SYS_FCNTL</span><span class="op" id="2201812">,</span>&nbsp;<span class="builtintype" id="2201814">uintptr</span><span class="op" id="2201821">(</span><span class="ident" id="2201822">nextfd</span><span class="op" id="2201828">)</span><span class="op" id="2201829">,</span>&nbsp;<span class="ident" id="2201831">F_SETFD</span><span class="op" id="2201838">,</span>&nbsp;<span class="ident" id="2201840">FD_CLOEXEC</span><span class="op" id="2201850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201854">pipe</span>&nbsp;<span class="op" id="2201859">=</span>&nbsp;<span class="ident" id="2201861">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201870">nextfd</span><span class="op" id="2201876">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2201880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201883">for</span>&nbsp;<span class="ident" id="2201887">i</span>&nbsp;<span class="op" id="2201889">=</span>&nbsp;<span class="num" id="2201891">0</span><span class="op" id="2201892">;</span>&nbsp;<span class="ident" id="2201894">i</span>&nbsp;<span class="op" id="2201896">&lt;</span>&nbsp;<span class="builtinfunc" id="2201898">len</span><span class="op" id="2201901">(</span><span class="ident" id="2201902">fd</span><span class="op" id="2201904">)</span><span class="op" id="2201905">;</span>&nbsp;<span class="ident" id="2201907">i</span><span class="op" id="2201908">++</span>&nbsp;<span class="op" id="2201911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2201915">if</span>&nbsp;<span class="ident" id="2201918">fd</span><span class="op" id="2201920">[</span><span class="ident" id="2201921">i</span><span class="op" id="2201922">]</span>&nbsp;<span class="op" id="2201924">&gt;=</span>&nbsp;<span class="num" id="2201927">0</span>&nbsp;<span class="op" id="2201929">&amp;&amp;</span>&nbsp;<span class="ident" id="2201932">fd</span><span class="op" id="2201934">[</span><span class="ident" id="2201935">i</span><span class="op" id="2201936">]</span>&nbsp;<span class="op" id="2201938">&lt;</span>&nbsp;<span class="builtintype" id="2201940">int</span><span class="op" id="2201943">(</span><span class="ident" id="2201944">i</span><span class="op" id="2201945">)</span>&nbsp;<span class="op" id="2201947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2201952">_</span><span class="op" id="2201953">,</span>&nbsp;<span class="ident" id="2201955">_</span><span class="op" id="2201956">,</span>&nbsp;<span class="ident" id="2201958">err1</span>&nbsp;<span class="op" id="2201963">=</span>&nbsp;<span class="ident" id="2201965">RawSyscall</span><span class="op" id="2201975">(</span><span class="ident" id="2201976">SYS_DUP2</span><span class="op" id="2201984">,</span>&nbsp;<span class="builtintype" id="2201986">uintptr</span><span class="op" id="2201993">(</span><span class="ident" id="2201994">fd</span><span class="op" id="2201996">[</span><span class="ident" id="2201997">i</span><span class="op" id="2201998">]</span><span class="op" id="2201999">)</span><span class="op" id="2202000">,</span>&nbsp;<span class="builtintype" id="2202002">uintptr</span><span class="op" id="2202009">(</span><span class="ident" id="2202010">nextfd</span><span class="op" id="2202016">)</span><span class="op" id="2202017">,</span>&nbsp;<span class="num" id="2202019">0</span><span class="op" id="2202020">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202025">if</span>&nbsp;<span class="ident" id="2202028">err1</span>&nbsp;<span class="op" id="2202033">!=</span>&nbsp;<span class="num" id="2202036">0</span>&nbsp;<span class="op" id="2202038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202044">goto</span>&nbsp;<span class="ident" id="2202049">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202068">RawSyscall</span><span class="op" id="2202078">(</span><span class="ident" id="2202079">SYS_FCNTL</span><span class="op" id="2202088">,</span>&nbsp;<span class="builtintype" id="2202090">uintptr</span><span class="op" id="2202097">(</span><span class="ident" id="2202098">nextfd</span><span class="op" id="2202104">)</span><span class="op" id="2202105">,</span>&nbsp;<span class="ident" id="2202107">F_SETFD</span><span class="op" id="2202114">,</span>&nbsp;<span class="ident" id="2202116">FD_CLOEXEC</span><span class="op" id="2202126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202131">fd</span><span class="op" id="2202133">[</span><span class="ident" id="2202134">i</span><span class="op" id="2202135">]</span>&nbsp;<span class="op" id="2202137">=</span>&nbsp;<span class="ident" id="2202139">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202149">nextfd</span><span class="op" id="2202155">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202161">if</span>&nbsp;<span class="ident" id="2202164">nextfd</span>&nbsp;<span class="op" id="2202171">==</span>&nbsp;<span class="ident" id="2202174">pipe</span>&nbsp;<span class="op" id="2202179">{</span>&nbsp;<span class="comment" id="2202181">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202208">nextfd</span><span class="op" id="2202214">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202224">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202231">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202266">for</span>&nbsp;<span class="ident" id="2202270">i</span>&nbsp;<span class="op" id="2202272">=</span>&nbsp;<span class="num" id="2202274">0</span><span class="op" id="2202275">;</span>&nbsp;<span class="ident" id="2202277">i</span>&nbsp;<span class="op" id="2202279">&lt;</span>&nbsp;<span class="builtinfunc" id="2202281">len</span><span class="op" id="2202284">(</span><span class="ident" id="2202285">fd</span><span class="op" id="2202287">)</span><span class="op" id="2202288">;</span>&nbsp;<span class="ident" id="2202290">i</span><span class="op" id="2202291">++</span>&nbsp;<span class="op" id="2202294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202298">if</span>&nbsp;<span class="ident" id="2202301">fd</span><span class="op" id="2202303">[</span><span class="ident" id="2202304">i</span><span class="op" id="2202305">]</span>&nbsp;<span class="op" id="2202307">==</span>&nbsp;<span class="op" id="2202310">-</span><span class="num" id="2202311">1</span>&nbsp;<span class="op" id="2202313">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202318">RawSyscall</span><span class="op" id="2202328">(</span><span class="ident" id="2202329">SYS_CLOSE</span><span class="op" id="2202338">,</span>&nbsp;<span class="builtintype" id="2202340">uintptr</span><span class="op" id="2202347">(</span><span class="ident" id="2202348">i</span><span class="op" id="2202349">)</span><span class="op" id="2202350">,</span>&nbsp;<span class="num" id="2202352">0</span><span class="op" id="2202353">,</span>&nbsp;<span class="num" id="2202355">0</span><span class="op" id="2202356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202361">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202376">if</span>&nbsp;<span class="ident" id="2202379">fd</span><span class="op" id="2202381">[</span><span class="ident" id="2202382">i</span><span class="op" id="2202383">]</span>&nbsp;<span class="op" id="2202385">==</span>&nbsp;<span class="builtintype" id="2202388">int</span><span class="op" id="2202391">(</span><span class="ident" id="2202392">i</span><span class="op" id="2202393">)</span>&nbsp;<span class="op" id="2202395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202400">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202458">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202495">_</span><span class="op" id="2202496">,</span>&nbsp;<span class="ident" id="2202498">_</span><span class="op" id="2202499">,</span>&nbsp;<span class="ident" id="2202501">err1</span>&nbsp;<span class="op" id="2202506">=</span>&nbsp;<span class="ident" id="2202508">RawSyscall</span><span class="op" id="2202518">(</span><span class="ident" id="2202519">SYS_FCNTL</span><span class="op" id="2202528">,</span>&nbsp;<span class="builtintype" id="2202530">uintptr</span><span class="op" id="2202537">(</span><span class="ident" id="2202538">fd</span><span class="op" id="2202540">[</span><span class="ident" id="2202541">i</span><span class="op" id="2202542">]</span><span class="op" id="2202543">)</span><span class="op" id="2202544">,</span>&nbsp;<span class="ident" id="2202546">F_SETFD</span><span class="op" id="2202553">,</span>&nbsp;<span class="num" id="2202555">0</span><span class="op" id="2202556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202561">if</span>&nbsp;<span class="ident" id="2202564">err1</span>&nbsp;<span class="op" id="2202569">!=</span>&nbsp;<span class="num" id="2202572">0</span>&nbsp;<span class="op" id="2202574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202580">goto</span>&nbsp;<span class="ident" id="2202585">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202599">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202604">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202619">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202665">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2202701">_</span><span class="op" id="2202702">,</span>&nbsp;<span class="ident" id="2202704">_</span><span class="op" id="2202705">,</span>&nbsp;<span class="ident" id="2202707">err1</span>&nbsp;<span class="op" id="2202712">=</span>&nbsp;<span class="ident" id="2202714">RawSyscall</span><span class="op" id="2202724">(</span><span class="ident" id="2202725">SYS_DUP2</span><span class="op" id="2202733">,</span>&nbsp;<span class="builtintype" id="2202735">uintptr</span><span class="op" id="2202742">(</span><span class="ident" id="2202743">fd</span><span class="op" id="2202745">[</span><span class="ident" id="2202746">i</span><span class="op" id="2202747">]</span><span class="op" id="2202748">)</span><span class="op" id="2202749">,</span>&nbsp;<span class="builtintype" id="2202751">uintptr</span><span class="op" id="2202758">(</span><span class="ident" id="2202759">i</span><span class="op" id="2202760">)</span><span class="op" id="2202761">,</span>&nbsp;<span class="num" id="2202763">0</span><span class="op" id="2202764">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202768">if</span>&nbsp;<span class="ident" id="2202771">err1</span>&nbsp;<span class="op" id="2202776">!=</span>&nbsp;<span class="num" id="2202779">0</span>&nbsp;<span class="op" id="2202781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2202786">goto</span>&nbsp;<span class="ident" id="2202791">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2202807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202811">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202868">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202930">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2202985">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203016">for</span>&nbsp;<span class="ident" id="2203020">i</span>&nbsp;<span class="op" id="2203022">=</span>&nbsp;<span class="builtinfunc" id="2203024">len</span><span class="op" id="2203027">(</span><span class="ident" id="2203028">fd</span><span class="op" id="2203030">)</span><span class="op" id="2203031">;</span>&nbsp;<span class="ident" id="2203033">i</span>&nbsp;<span class="op" id="2203035">&lt;</span>&nbsp;<span class="num" id="2203037">3</span><span class="op" id="2203038">;</span>&nbsp;<span class="ident" id="2203040">i</span><span class="op" id="2203041">++</span>&nbsp;<span class="op" id="2203044">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203048">RawSyscall</span><span class="op" id="2203058">(</span><span class="ident" id="2203059">SYS_CLOSE</span><span class="op" id="2203068">,</span>&nbsp;<span class="builtintype" id="2203070">uintptr</span><span class="op" id="2203077">(</span><span class="ident" id="2203078">i</span><span class="op" id="2203079">)</span><span class="op" id="2203080">,</span>&nbsp;<span class="num" id="2203082">0</span><span class="op" id="2203083">,</span>&nbsp;<span class="num" id="2203085">0</span><span class="op" id="2203086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2203089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2203093">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203118">if</span>&nbsp;<span class="ident" id="2203121">sys</span><span class="op" id="2203124">.</span><span class="ident" id="2203125">Noctty</span>&nbsp;<span class="op" id="2203132">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203136">_</span><span class="op" id="2203137">,</span>&nbsp;<span class="ident" id="2203139">_</span><span class="op" id="2203140">,</span>&nbsp;<span class="ident" id="2203142">err1</span>&nbsp;<span class="op" id="2203147">=</span>&nbsp;<span class="ident" id="2203149">RawSyscall</span><span class="op" id="2203159">(</span><span class="ident" id="2203160">SYS_IOCTL</span><span class="op" id="2203169">,</span>&nbsp;<span class="num" id="2203171">0</span><span class="op" id="2203172">,</span>&nbsp;<span class="builtintype" id="2203174">uintptr</span><span class="op" id="2203181">(</span><span class="ident" id="2203182">TIOCNOTTY</span><span class="op" id="2203191">)</span><span class="op" id="2203192">,</span>&nbsp;<span class="num" id="2203194">0</span><span class="op" id="2203195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203199">if</span>&nbsp;<span class="ident" id="2203202">err1</span>&nbsp;<span class="op" id="2203207">!=</span>&nbsp;<span class="num" id="2203210">0</span>&nbsp;<span class="op" id="2203212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203217">goto</span>&nbsp;<span class="ident" id="2203222">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2203235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2203238">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2203242">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203278">if</span>&nbsp;<span class="ident" id="2203281">sys</span><span class="op" id="2203284">.</span><span class="ident" id="2203285">Setctty</span>&nbsp;<span class="op" id="2203293">&amp;&amp;</span>&nbsp;<span class="ident" id="2203296">sys</span><span class="op" id="2203299">.</span><span class="ident" id="2203300">Ctty</span>&nbsp;<span class="op" id="2203305">&gt;=</span>&nbsp;<span class="num" id="2203308">0</span>&nbsp;<span class="op" id="2203310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203314">_</span><span class="op" id="2203315">,</span>&nbsp;<span class="ident" id="2203317">_</span><span class="op" id="2203318">,</span>&nbsp;<span class="ident" id="2203320">err1</span>&nbsp;<span class="op" id="2203325">=</span>&nbsp;<span class="ident" id="2203327">RawSyscall</span><span class="op" id="2203337">(</span><span class="ident" id="2203338">SYS_IOCTL</span><span class="op" id="2203347">,</span>&nbsp;<span class="builtintype" id="2203349">uintptr</span><span class="op" id="2203356">(</span><span class="ident" id="2203357">sys</span><span class="op" id="2203360">.</span><span class="ident" id="2203361">Ctty</span><span class="op" id="2203365">)</span><span class="op" id="2203366">,</span>&nbsp;<span class="builtintype" id="2203368">uintptr</span><span class="op" id="2203375">(</span><span class="ident" id="2203376">TIOCSCTTY</span><span class="op" id="2203385">)</span><span class="op" id="2203386">,</span>&nbsp;<span class="num" id="2203388">0</span><span class="op" id="2203389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203393">if</span>&nbsp;<span class="ident" id="2203396">err1</span>&nbsp;<span class="op" id="2203401">!=</span>&nbsp;<span class="num" id="2203404">0</span>&nbsp;<span class="op" id="2203406">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203411">goto</span>&nbsp;<span class="ident" id="2203416">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2203429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2203432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2203436">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203454">_</span><span class="op" id="2203455">,</span>&nbsp;<span class="ident" id="2203457">_</span><span class="op" id="2203458">,</span>&nbsp;<span class="ident" id="2203460">err1</span>&nbsp;<span class="op" id="2203465">=</span>&nbsp;<span class="ident" id="2203467">RawSyscall</span><span class="op" id="2203477">(</span><span class="ident" id="2203478">SYS_EXECVE</span><span class="op" id="2203488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2203492">uintptr</span><span class="op" id="2203499">(</span><span class="ident" id="2203500">unsafe</span><span class="op" id="2203506">.</span><span class="ident" id="2203507">Pointer</span><span class="op" id="2203514">(</span><span class="ident" id="2203515">argv0</span><span class="op" id="2203520">)</span><span class="op" id="2203521">)</span><span class="op" id="2203522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2203526">uintptr</span><span class="op" id="2203533">(</span><span class="ident" id="2203534">unsafe</span><span class="op" id="2203540">.</span><span class="ident" id="2203541">Pointer</span><span class="op" id="2203548">(</span><span class="op" id="2203549">&amp;</span><span class="ident" id="2203550">argv</span><span class="op" id="2203554">[</span><span class="num" id="2203555">0</span><span class="op" id="2203556">]</span><span class="op" id="2203557">)</span><span class="op" id="2203558">)</span><span class="op" id="2203559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2203563">uintptr</span><span class="op" id="2203570">(</span><span class="ident" id="2203571">unsafe</span><span class="op" id="2203577">.</span><span class="ident" id="2203578">Pointer</span><span class="op" id="2203585">(</span><span class="op" id="2203586">&amp;</span><span class="ident" id="2203587">envv</span><span class="op" id="2203591">[</span><span class="num" id="2203592">0</span><span class="op" id="2203593">]</span><span class="op" id="2203594">)</span><span class="op" id="2203595">)</span><span class="op" id="2203596">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2203599">childerror</span><span class="op" id="2203609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2203612">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203640">RawSyscall</span><span class="op" id="2203650">(</span><span class="ident" id="2203651">SYS_WRITE</span><span class="op" id="2203660">,</span>&nbsp;<span class="builtintype" id="2203662">uintptr</span><span class="op" id="2203669">(</span><span class="ident" id="2203670">pipe</span><span class="op" id="2203674">)</span><span class="op" id="2203675">,</span>&nbsp;<span class="builtintype" id="2203677">uintptr</span><span class="op" id="2203684">(</span><span class="ident" id="2203685">unsafe</span><span class="op" id="2203691">.</span><span class="ident" id="2203692">Pointer</span><span class="op" id="2203699">(</span><span class="op" id="2203700">&amp;</span><span class="ident" id="2203701">err1</span><span class="op" id="2203705">)</span><span class="op" id="2203706">)</span><span class="op" id="2203707">,</span>&nbsp;<span class="ident" id="2203709">unsafe</span><span class="op" id="2203715">.</span><span class="ident" id="2203716">Sizeof</span><span class="op" id="2203722">(</span><span class="ident" id="2203723">err1</span><span class="op" id="2203727">)</span><span class="op" id="2203728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2203731">for</span>&nbsp;<span class="op" id="2203735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203739">RawSyscall</span><span class="op" id="2203749">(</span><span class="ident" id="2203750">SYS_EXIT</span><span class="op" id="2203758">,</span>&nbsp;<span class="num" id="2203760">253</span><span class="op" id="2203763">,</span>&nbsp;<span class="num" id="2203765">0</span><span class="op" id="2203766">,</span>&nbsp;<span class="num" id="2203768">0</span><span class="op" id="2203769">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2203772">}</span><br>
<span class="lineno"></span><span class="op" id="2203774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2203777">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2203844">func</span>&nbsp;<span class="ident" id="2203849">forkExecPipe</span><span class="op" id="2203861">(</span><span class="ident" id="2203862">p</span>&nbsp;<span class="op" id="2203864">[</span><span class="op" id="2203865">]</span><span class="builtintype" id="2203866">int</span><span class="op" id="2203869">)</span>&nbsp;<span class="op" id="2203871">(</span><span class="ident" id="2203872">err</span>&nbsp;<span class="builtintype" id="2203876">error</span><span class="op" id="2203881">)</span>&nbsp;<span class="op" id="2203883">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2203886">err</span>&nbsp;<span class="op" id="2203890">=</span>&nbsp;<span class="ident" id="2203892">Pipe2</span><span class="op" id="2203897">(</span><span class="ident" id="2203898">p</span><span class="op" id="2203899">,</span>&nbsp;<span class="ident" id="2203901">O_CLOEXEC</span><span class="op" id="2203910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2203913">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2203988">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204018">if</span>&nbsp;<span class="ident" id="2204021">err</span>&nbsp;<span class="op" id="2204025">==</span>&nbsp;<span class="ident" id="2204028">ENOSYS</span>&nbsp;<span class="op" id="2204035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204039">if</span>&nbsp;<span class="ident" id="2204042">err</span>&nbsp;<span class="op" id="2204046">=</span>&nbsp;<span class="ident" id="2204048">Pipe</span><span class="op" id="2204052">(</span><span class="ident" id="2204053">p</span><span class="op" id="2204054">)</span><span class="op" id="2204055">;</span>&nbsp;<span class="ident" id="2204057">err</span>&nbsp;<span class="op" id="2204061">!=</span>&nbsp;<span class="ident" id="2204064">nil</span>&nbsp;<span class="op" id="2204068">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204073">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204086">if</span>&nbsp;<span class="ident" id="2204089">_</span><span class="op" id="2204090">,</span>&nbsp;<span class="ident" id="2204092">err</span>&nbsp;<span class="op" id="2204096">=</span>&nbsp;<span class="ident" id="2204098">fcntl</span><span class="op" id="2204103">(</span><span class="ident" id="2204104">p</span><span class="op" id="2204105">[</span><span class="num" id="2204106">0</span><span class="op" id="2204107">]</span><span class="op" id="2204108">,</span>&nbsp;<span class="ident" id="2204110">F_SETFD</span><span class="op" id="2204117">,</span>&nbsp;<span class="ident" id="2204119">FD_CLOEXEC</span><span class="op" id="2204129">)</span><span class="op" id="2204130">;</span>&nbsp;<span class="ident" id="2204132">err</span>&nbsp;<span class="op" id="2204136">!=</span>&nbsp;<span class="ident" id="2204139">nil</span>&nbsp;<span class="op" id="2204143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204148">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204157">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204161">_</span><span class="op" id="2204162">,</span>&nbsp;<span class="ident" id="2204164">err</span>&nbsp;<span class="op" id="2204168">=</span>&nbsp;<span class="ident" id="2204170">fcntl</span><span class="op" id="2204175">(</span><span class="ident" id="2204176">p</span><span class="op" id="2204177">[</span><span class="num" id="2204178">1</span><span class="op" id="2204179">]</span><span class="op" id="2204180">,</span>&nbsp;<span class="ident" id="2204182">F_SETFD</span><span class="op" id="2204189">,</span>&nbsp;<span class="ident" id="2204191">FD_CLOEXEC</span><span class="op" id="2204201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204207">return</span><br>
<span class="lineno"></span><span class="op" id="2204214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2204217">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2204314">func</span>&nbsp;<span class="ident" id="2204319">writeIDMappings</span><span class="op" id="2204334">(</span><span class="ident" id="2204335">path</span>&nbsp;<span class="builtintype" id="2204340">string</span><span class="op" id="2204346">,</span>&nbsp;<span class="ident" id="2204348">idMap</span>&nbsp;<span class="op" id="2204354">[</span><span class="op" id="2204355">]</span><span class="ident" id="2204356">SysProcIDMap</span><span class="op" id="2204368">)</span>&nbsp;<span class="builtintype" id="2204370">error</span>&nbsp;<span class="op" id="2204376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204379">fd</span><span class="op" id="2204381">,</span>&nbsp;<span class="ident" id="2204383">err</span>&nbsp;<span class="op" id="2204387">:=</span>&nbsp;<span class="ident" id="2204390">Open</span><span class="op" id="2204394">(</span><span class="ident" id="2204395">path</span><span class="op" id="2204399">,</span>&nbsp;<span class="ident" id="2204401">O_RDWR</span><span class="op" id="2204407">,</span>&nbsp;<span class="num" id="2204409">0</span><span class="op" id="2204410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204413">if</span>&nbsp;<span class="ident" id="2204416">err</span>&nbsp;<span class="op" id="2204420">!=</span>&nbsp;<span class="ident" id="2204423">nil</span>&nbsp;<span class="op" id="2204427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204431">return</span>&nbsp;<span class="ident" id="2204438">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204447">data</span>&nbsp;<span class="op" id="2204452">:=</span>&nbsp;<span class="string" id="2204455">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204459">for</span>&nbsp;<span class="ident" id="2204463">_</span><span class="op" id="2204464">,</span>&nbsp;<span class="ident" id="2204466">im</span>&nbsp;<span class="op" id="2204469">:=</span>&nbsp;<span class="keyword" id="2204472">range</span>&nbsp;<span class="ident" id="2204478">idMap</span>&nbsp;<span class="op" id="2204484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204488">data</span>&nbsp;<span class="op" id="2204493">=</span>&nbsp;<span class="ident" id="2204495">data</span>&nbsp;<span class="op" id="2204500">+</span>&nbsp;<span class="ident" id="2204502">itoa</span><span class="op" id="2204506">(</span><span class="ident" id="2204507">im</span><span class="op" id="2204509">.</span><span class="ident" id="2204510">ContainerID</span><span class="op" id="2204521">)</span>&nbsp;<span class="op" id="2204523">+</span>&nbsp;<span class="string" id="2204525">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2204529">+</span>&nbsp;<span class="ident" id="2204531">itoa</span><span class="op" id="2204535">(</span><span class="ident" id="2204536">im</span><span class="op" id="2204538">.</span><span class="ident" id="2204539">HostID</span><span class="op" id="2204545">)</span>&nbsp;<span class="op" id="2204547">+</span>&nbsp;<span class="string" id="2204549">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2204553">+</span>&nbsp;<span class="ident" id="2204555">itoa</span><span class="op" id="2204559">(</span><span class="ident" id="2204560">im</span><span class="op" id="2204562">.</span><span class="ident" id="2204563">Size</span><span class="op" id="2204567">)</span>&nbsp;<span class="op" id="2204569">+</span>&nbsp;<span class="string" id="2204571">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204581">bytes</span><span class="op" id="2204586">,</span>&nbsp;<span class="ident" id="2204588">err</span>&nbsp;<span class="op" id="2204592">:=</span>&nbsp;<span class="ident" id="2204595">ByteSliceFromString</span><span class="op" id="2204614">(</span><span class="ident" id="2204615">data</span><span class="op" id="2204619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204622">if</span>&nbsp;<span class="ident" id="2204625">err</span>&nbsp;<span class="op" id="2204629">!=</span>&nbsp;<span class="ident" id="2204632">nil</span>&nbsp;<span class="op" id="2204636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204640">Close</span><span class="op" id="2204645">(</span><span class="ident" id="2204646">fd</span><span class="op" id="2204648">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204652">return</span>&nbsp;<span class="ident" id="2204659">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204668">if</span>&nbsp;<span class="ident" id="2204671">_</span><span class="op" id="2204672">,</span>&nbsp;<span class="ident" id="2204674">err</span>&nbsp;<span class="op" id="2204678">:=</span>&nbsp;<span class="ident" id="2204681">Write</span><span class="op" id="2204686">(</span><span class="ident" id="2204687">fd</span><span class="op" id="2204689">,</span>&nbsp;<span class="ident" id="2204691">bytes</span><span class="op" id="2204696">)</span><span class="op" id="2204697">;</span>&nbsp;<span class="ident" id="2204699">err</span>&nbsp;<span class="op" id="2204703">!=</span>&nbsp;<span class="ident" id="2204706">nil</span>&nbsp;<span class="op" id="2204710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2204714">Close</span><span class="op" id="2204719">(</span><span class="ident" id="2204720">fd</span><span class="op" id="2204722">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204726">return</span>&nbsp;<span class="ident" id="2204733">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204742">if</span>&nbsp;<span class="ident" id="2204745">err</span>&nbsp;<span class="op" id="2204749">:=</span>&nbsp;<span class="ident" id="2204752">Close</span><span class="op" id="2204757">(</span><span class="ident" id="2204758">fd</span><span class="op" id="2204760">)</span><span class="op" id="2204761">;</span>&nbsp;<span class="ident" id="2204763">err</span>&nbsp;<span class="op" id="2204767">!=</span>&nbsp;<span class="ident" id="2204770">nil</span>&nbsp;<span class="op" id="2204774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204778">return</span>&nbsp;<span class="ident" id="2204785">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2204790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2204794">return</span>&nbsp;<span class="ident" id="2204801">nil</span><br>
<span class="lineno"></span><span class="op" id="2204805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2204808">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2204888">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2204947">func</span>&nbsp;<span class="ident" id="2204952">writeUidGidMappings</span><span class="op" id="2204971">(</span><span class="ident" id="2204972">pid</span>&nbsp;<span class="builtintype" id="2204976">int</span><span class="op" id="2204979">,</span>&nbsp;<span class="ident" id="2204981">sys</span>&nbsp;<span class="op" id="2204985">*</span><span class="ident" id="2204986">SysProcAttr</span><span class="op" id="2204997">)</span>&nbsp;<span class="builtintype" id="2204999">error</span>&nbsp;<span class="op" id="2205005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205008">if</span>&nbsp;<span class="ident" id="2205011">sys</span><span class="op" id="2205014">.</span><span class="ident" id="2205015">UidMappings</span>&nbsp;<span class="op" id="2205027">!=</span>&nbsp;<span class="ident" id="2205030">nil</span>&nbsp;<span class="op" id="2205034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2205038">uidf</span>&nbsp;<span class="op" id="2205043">:=</span>&nbsp;<span class="string" id="2205046">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2205055">+</span>&nbsp;<span class="ident" id="2205057">itoa</span><span class="op" id="2205061">(</span><span class="ident" id="2205062">pid</span><span class="op" id="2205065">)</span>&nbsp;<span class="op" id="2205067">+</span>&nbsp;<span class="string" id="2205069">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205082">if</span>&nbsp;<span class="ident" id="2205085">err</span>&nbsp;<span class="op" id="2205089">:=</span>&nbsp;<span class="ident" id="2205092">writeIDMappings</span><span class="op" id="2205107">(</span><span class="ident" id="2205108">uidf</span><span class="op" id="2205112">,</span>&nbsp;<span class="ident" id="2205114">sys</span><span class="op" id="2205117">.</span><span class="ident" id="2205118">UidMappings</span><span class="op" id="2205129">)</span><span class="op" id="2205130">;</span>&nbsp;<span class="ident" id="2205132">err</span>&nbsp;<span class="op" id="2205136">!=</span>&nbsp;<span class="ident" id="2205139">nil</span>&nbsp;<span class="op" id="2205143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205148">return</span>&nbsp;<span class="ident" id="2205155">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2205161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2205164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205168">if</span>&nbsp;<span class="ident" id="2205171">sys</span><span class="op" id="2205174">.</span><span class="ident" id="2205175">GidMappings</span>&nbsp;<span class="op" id="2205187">!=</span>&nbsp;<span class="ident" id="2205190">nil</span>&nbsp;<span class="op" id="2205194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2205198">gidf</span>&nbsp;<span class="op" id="2205203">:=</span>&nbsp;<span class="string" id="2205206">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2205215">+</span>&nbsp;<span class="ident" id="2205217">itoa</span><span class="op" id="2205221">(</span><span class="ident" id="2205222">pid</span><span class="op" id="2205225">)</span>&nbsp;<span class="op" id="2205227">+</span>&nbsp;<span class="string" id="2205229">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205242">if</span>&nbsp;<span class="ident" id="2205245">err</span>&nbsp;<span class="op" id="2205249">:=</span>&nbsp;<span class="ident" id="2205252">writeIDMappings</span><span class="op" id="2205267">(</span><span class="ident" id="2205268">gidf</span><span class="op" id="2205272">,</span>&nbsp;<span class="ident" id="2205274">sys</span><span class="op" id="2205277">.</span><span class="ident" id="2205278">GidMappings</span><span class="op" id="2205289">)</span><span class="op" id="2205290">;</span>&nbsp;<span class="ident" id="2205292">err</span>&nbsp;<span class="op" id="2205296">!=</span>&nbsp;<span class="ident" id="2205299">nil</span>&nbsp;<span class="op" id="2205303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205308">return</span>&nbsp;<span class="ident" id="2205315">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2205321">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2205324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2205328">return</span>&nbsp;<span class="ident" id="2205335">nil</span><br>
<span class="lineno"></span><span class="op" id="2205339">}</span>
</div>
</body>
</html>
