<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4310685">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4310740">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4310794">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4310845">//&nbsp;Package&nbsp;lzw&nbsp;implements&nbsp;the&nbsp;Lempel-Ziv-Welch&nbsp;compressed&nbsp;data&nbsp;format,</span><br>
<span class="lineno"></span><span class="comment" id="4310916">//&nbsp;described&nbsp;in&nbsp;T.&nbsp;A.&nbsp;Welch,&nbsp;``A&nbsp;Technique&nbsp;for&nbsp;High-Performance&nbsp;Data</span><br>
<span class="lineno"></span><span class="comment" id="4310985">//&nbsp;Compression&#39;&#39;,&nbsp;Computer,&nbsp;17(6)&nbsp;(June&nbsp;1984),&nbsp;pp&nbsp;8-19.</span><br>
<span class="lineno"></span><span class="comment" id="4311041">//</span><br>
<span class="lineno"></span><span class="comment" id="4311044">//&nbsp;In&nbsp;particular,&nbsp;it&nbsp;implements&nbsp;LZW&nbsp;as&nbsp;used&nbsp;by&nbsp;the&nbsp;GIF&nbsp;and&nbsp;PDF&nbsp;file</span><br>
<span class="lineno">10</span><span class="comment" id="4311112">//&nbsp;formats,&nbsp;which&nbsp;means&nbsp;variable-width&nbsp;codes&nbsp;up&nbsp;to&nbsp;12&nbsp;bits&nbsp;and&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4311185">//&nbsp;two&nbsp;non-literal&nbsp;codes&nbsp;are&nbsp;a&nbsp;clear&nbsp;code&nbsp;and&nbsp;an&nbsp;EOF&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="4311244">//</span><br>
<span class="lineno"></span><span class="comment" id="4311247">//&nbsp;The&nbsp;TIFF&nbsp;file&nbsp;format&nbsp;uses&nbsp;a&nbsp;similar&nbsp;but&nbsp;incompatible&nbsp;version&nbsp;of&nbsp;the&nbsp;LZW</span><br>
<span class="lineno"></span><span class="comment" id="4311322">//&nbsp;algorithm.&nbsp;See&nbsp;the&nbsp;golang.org/x/image/tiff/lzw&nbsp;package&nbsp;for&nbsp;an</span><br>
<span class="lineno">15</span><span class="comment" id="4311387">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="4311406">package</span>&nbsp;<span class="ident" id="4311414">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4311419">//&nbsp;TODO(nigeltao):&nbsp;check&nbsp;that&nbsp;PDF&nbsp;uses&nbsp;LZW&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;GIF,</span><br>
<span class="lineno"></span><span class="comment" id="4311486">//&nbsp;modulo&nbsp;LSB/MSB&nbsp;packing&nbsp;order.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4311520">import</span>&nbsp;<span class="op" id="4311527">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4311530">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4311539">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4311549">&#34;fmt&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4311556">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4311561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4311564">//&nbsp;Order&nbsp;specifies&nbsp;the&nbsp;bit&nbsp;ordering&nbsp;in&nbsp;an&nbsp;LZW&nbsp;data&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="4311623">type</span>&nbsp;<span class="ident" id="4311628">Order</span>&nbsp;<span class="builtintype" id="4311634">int</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4311639">const</span>&nbsp;<span class="op" id="4311645">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4311648">//&nbsp;LSB&nbsp;means&nbsp;Least&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;GIF&nbsp;file&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311724">LSB</span>&nbsp;<span class="ident" id="4311728">Order</span>&nbsp;<span class="op" id="4311734">=</span>&nbsp;<span class="ident" id="4311736">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4311742">//&nbsp;MSB&nbsp;means&nbsp;Most&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;TIFF&nbsp;and&nbsp;PDF</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4311813">//&nbsp;file&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311831">MSB</span><br>
<span class="lineno"></span><span class="op" id="4311835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4311838">const</span>&nbsp;<span class="op" id="4311844">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311847">maxWidth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4311866">=</span>&nbsp;<span class="num" id="4311868">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311872">decoderInvalidCode</span>&nbsp;<span class="op" id="4311891">=</span>&nbsp;<span class="num" id="4311893">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311901">flushBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4311920">=</span>&nbsp;<span class="num" id="4311922">1</span>&nbsp;<span class="op" id="4311924">&lt;&lt;</span>&nbsp;<span class="ident" id="4311927">maxWidth</span><br>
<span class="lineno"></span><span class="op" id="4311936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4311939">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;state&nbsp;from&nbsp;which&nbsp;the&nbsp;readXxx&nbsp;method&nbsp;converts&nbsp;a&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="4312009">//&nbsp;stream&nbsp;into&nbsp;a&nbsp;code&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="4312039">type</span>&nbsp;<span class="ident" id="4312044">decoder</span>&nbsp;<span class="keyword" id="4312052">struct</span>&nbsp;<span class="op" id="4312059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312062">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4312071">io</span><span class="op" id="4312073">.</span><span class="ident" id="4312074">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312086">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4312095">uint32</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312103">nBits</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4312112">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312118">width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4312127">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312133">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4312142">func</span><span class="op" id="4312146">(</span><span class="op" id="4312147">*</span><span class="ident" id="4312148">decoder</span><span class="op" id="4312155">)</span>&nbsp;<span class="op" id="4312157">(</span><span class="builtintype" id="4312158">uint16</span><span class="op" id="4312164">,</span>&nbsp;<span class="builtintype" id="4312166">error</span><span class="op" id="4312171">)</span>&nbsp;<span class="comment" id="4312173">//&nbsp;readLSB&nbsp;or&nbsp;readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312196">litWidth</span>&nbsp;<span class="builtintype" id="4312205">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4312236">//&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312271">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4312280">error</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312288">//&nbsp;The&nbsp;first&nbsp;1&lt;&lt;litWidth&nbsp;codes&nbsp;are&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312339">//&nbsp;The&nbsp;next&nbsp;two&nbsp;codes&nbsp;mean&nbsp;clear&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312382">//&nbsp;Other&nbsp;valid&nbsp;codes&nbsp;are&nbsp;in&nbsp;the&nbsp;range&nbsp;[lo,&nbsp;hi]&nbsp;where&nbsp;lo&nbsp;:=&nbsp;clear&nbsp;+&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312453">//&nbsp;with&nbsp;the&nbsp;upper&nbsp;bound&nbsp;incrementing&nbsp;on&nbsp;each&nbsp;code&nbsp;seen.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312510">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312573">//&nbsp;last&nbsp;is&nbsp;the&nbsp;most&nbsp;recently&nbsp;seen&nbsp;code,&nbsp;or&nbsp;decoderInvalidCode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312637">clear</span><span class="op" id="4312642">,</span>&nbsp;<span class="ident" id="4312644">eof</span><span class="op" id="4312647">,</span>&nbsp;<span class="ident" id="4312649">hi</span><span class="op" id="4312651">,</span>&nbsp;<span class="ident" id="4312653">overflow</span><span class="op" id="4312661">,</span>&nbsp;<span class="ident" id="4312663">last</span>&nbsp;<span class="builtintype" id="4312668">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312677">//&nbsp;Each&nbsp;code&nbsp;c&nbsp;in&nbsp;[lo,&nbsp;hi]&nbsp;expands&nbsp;to&nbsp;two&nbsp;or&nbsp;more&nbsp;bytes.&nbsp;For&nbsp;c&nbsp;!=&nbsp;hi:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312748">//&nbsp;&nbsp;&nbsp;suffix[c]&nbsp;is&nbsp;the&nbsp;last&nbsp;of&nbsp;these&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312792">//&nbsp;&nbsp;&nbsp;prefix[c]&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;all&nbsp;but&nbsp;the&nbsp;last&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312847">//&nbsp;&nbsp;&nbsp;This&nbsp;code&nbsp;can&nbsp;either&nbsp;be&nbsp;a&nbsp;literal&nbsp;code&nbsp;or&nbsp;another&nbsp;code&nbsp;in&nbsp;[lo,&nbsp;c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4312920">//&nbsp;The&nbsp;c&nbsp;==&nbsp;hi&nbsp;case&nbsp;is&nbsp;a&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312960">suffix</span>&nbsp;<span class="op" id="4312967">[</span><span class="num" id="4312968">1</span>&nbsp;<span class="op" id="4312970">&lt;&lt;</span>&nbsp;<span class="ident" id="4312973">maxWidth</span><span class="op" id="4312981">]</span><span class="builtintype" id="4312982">uint8</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312989">prefix</span>&nbsp;<span class="op" id="4312996">[</span><span class="num" id="4312997">1</span>&nbsp;<span class="op" id="4312999">&lt;&lt;</span>&nbsp;<span class="ident" id="4313002">maxWidth</span><span class="op" id="4313010">]</span><span class="builtintype" id="4313011">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313020">//&nbsp;output&nbsp;is&nbsp;the&nbsp;temporary&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313063">//&nbsp;Literal&nbsp;codes&nbsp;are&nbsp;accumulated&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313127">//&nbsp;Non-literal&nbsp;codes&nbsp;decode&nbsp;to&nbsp;a&nbsp;sequence&nbsp;of&nbsp;suffixes&nbsp;that&nbsp;are&nbsp;first</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313197">//&nbsp;written&nbsp;right-to-left&nbsp;from&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer&nbsp;before&nbsp;being&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313270">//&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313302">//&nbsp;It&nbsp;is&nbsp;flushed&nbsp;when&nbsp;it&nbsp;contains&nbsp;&gt;=&nbsp;1&lt;&lt;maxWidth&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313359">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;always&nbsp;room&nbsp;to&nbsp;decode&nbsp;an&nbsp;entire&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313418">output</span>&nbsp;<span class="op" id="4313425">[</span><span class="num" id="4313426">2</span>&nbsp;<span class="op" id="4313428">*</span>&nbsp;<span class="num" id="4313430">1</span>&nbsp;<span class="op" id="4313432">&lt;&lt;</span>&nbsp;<span class="ident" id="4313435">maxWidth</span><span class="op" id="4313443">]</span><span class="builtintype" id="4313444">byte</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313450">o</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4313457">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4313464">//&nbsp;write&nbsp;index&nbsp;into&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313492">toRead</span>&nbsp;<span class="op" id="4313499">[</span><span class="op" id="4313500">]</span><span class="builtintype" id="4313501">byte</span>&nbsp;<span class="comment" id="4313506">//&nbsp;bytes&nbsp;to&nbsp;return&nbsp;from&nbsp;Read</span><br>
<span class="lineno"></span><span class="op" id="4313535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4313538">//&nbsp;readLSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno">85</span><span class="keyword" id="4313612">func</span>&nbsp;<span class="op" id="4313617">(</span><span class="ident" id="4313618">d</span>&nbsp;<span class="op" id="4313620">*</span><span class="ident" id="4313621">decoder</span><span class="op" id="4313628">)</span>&nbsp;<span class="ident" id="4313630">readLSB</span><span class="op" id="4313637">(</span><span class="op" id="4313638">)</span>&nbsp;<span class="op" id="4313640">(</span><span class="builtintype" id="4313641">uint16</span><span class="op" id="4313647">,</span>&nbsp;<span class="builtintype" id="4313649">error</span><span class="op" id="4313654">)</span>&nbsp;<span class="op" id="4313656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313659">for</span>&nbsp;<span class="ident" id="4313663">d</span><span class="op" id="4313664">.</span><span class="ident" id="4313665">nBits</span>&nbsp;<span class="op" id="4313671">&lt;</span>&nbsp;<span class="ident" id="4313673">d</span><span class="op" id="4313674">.</span><span class="ident" id="4313675">width</span>&nbsp;<span class="op" id="4313681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313685">x</span><span class="op" id="4313686">,</span>&nbsp;<span class="ident" id="4313688">err</span>&nbsp;<span class="op" id="4313692">:=</span>&nbsp;<span class="ident" id="4313695">d</span><span class="op" id="4313696">.</span><span class="ident" id="4313697">r</span><span class="op" id="4313698">.</span><span class="ident" id="4313699">ReadByte</span><span class="op" id="4313707">(</span><span class="op" id="4313708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313712">if</span>&nbsp;<span class="ident" id="4313715">err</span>&nbsp;<span class="op" id="4313719">!=</span>&nbsp;<span class="ident" id="4313722">nil</span>&nbsp;<span class="op" id="4313726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313731">return</span>&nbsp;<span class="num" id="4313738">0</span><span class="op" id="4313739">,</span>&nbsp;<span class="ident" id="4313741">err</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4313747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313751">d</span><span class="op" id="4313752">.</span><span class="ident" id="4313753">bits</span>&nbsp;<span class="op" id="4313758">|=</span>&nbsp;<span class="builtintype" id="4313761">uint32</span><span class="op" id="4313767">(</span><span class="ident" id="4313768">x</span><span class="op" id="4313769">)</span>&nbsp;<span class="op" id="4313771">&lt;&lt;</span>&nbsp;<span class="ident" id="4313774">d</span><span class="op" id="4313775">.</span><span class="ident" id="4313776">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313784">d</span><span class="op" id="4313785">.</span><span class="ident" id="4313786">nBits</span>&nbsp;<span class="op" id="4313792">+=</span>&nbsp;<span class="num" id="4313795">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4313798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313801">code</span>&nbsp;<span class="op" id="4313806">:=</span>&nbsp;<span class="builtintype" id="4313809">uint16</span><span class="op" id="4313815">(</span><span class="ident" id="4313816">d</span><span class="op" id="4313817">.</span><span class="ident" id="4313818">bits</span>&nbsp;<span class="op" id="4313823">&amp;</span>&nbsp;<span class="op" id="4313825">(</span><span class="num" id="4313826">1</span><span class="op" id="4313827">&lt;&lt;</span><span class="ident" id="4313829">d</span><span class="op" id="4313830">.</span><span class="ident" id="4313831">width</span>&nbsp;<span class="op" id="4313837">-</span>&nbsp;<span class="num" id="4313839">1</span><span class="op" id="4313840">)</span><span class="op" id="4313841">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313844">d</span><span class="op" id="4313845">.</span><span class="ident" id="4313846">bits</span>&nbsp;<span class="op" id="4313851">&gt;&gt;=</span>&nbsp;<span class="ident" id="4313855">d</span><span class="op" id="4313856">.</span><span class="ident" id="4313857">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4313864">d</span><span class="op" id="4313865">.</span><span class="ident" id="4313866">nBits</span>&nbsp;<span class="op" id="4313872">-=</span>&nbsp;<span class="ident" id="4313875">d</span><span class="op" id="4313876">.</span><span class="ident" id="4313877">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313884">return</span>&nbsp;<span class="ident" id="4313891">code</span><span class="op" id="4313895">,</span>&nbsp;<span class="ident" id="4313897">nil</span><br>
<span class="lineno"></span><span class="op" id="4313901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4313904">//&nbsp;readMSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4313977">func</span>&nbsp;<span class="op" id="4313982">(</span><span class="ident" id="4313983">d</span>&nbsp;<span class="op" id="4313985">*</span><span class="ident" id="4313986">decoder</span><span class="op" id="4313993">)</span>&nbsp;<span class="ident" id="4313995">readMSB</span><span class="op" id="4314002">(</span><span class="op" id="4314003">)</span>&nbsp;<span class="op" id="4314005">(</span><span class="builtintype" id="4314006">uint16</span><span class="op" id="4314012">,</span>&nbsp;<span class="builtintype" id="4314014">error</span><span class="op" id="4314019">)</span>&nbsp;<span class="op" id="4314021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314024">for</span>&nbsp;<span class="ident" id="4314028">d</span><span class="op" id="4314029">.</span><span class="ident" id="4314030">nBits</span>&nbsp;<span class="op" id="4314036">&lt;</span>&nbsp;<span class="ident" id="4314038">d</span><span class="op" id="4314039">.</span><span class="ident" id="4314040">width</span>&nbsp;<span class="op" id="4314046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314050">x</span><span class="op" id="4314051">,</span>&nbsp;<span class="ident" id="4314053">err</span>&nbsp;<span class="op" id="4314057">:=</span>&nbsp;<span class="ident" id="4314060">d</span><span class="op" id="4314061">.</span><span class="ident" id="4314062">r</span><span class="op" id="4314063">.</span><span class="ident" id="4314064">ReadByte</span><span class="op" id="4314072">(</span><span class="op" id="4314073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314077">if</span>&nbsp;<span class="ident" id="4314080">err</span>&nbsp;<span class="op" id="4314084">!=</span>&nbsp;<span class="ident" id="4314087">nil</span>&nbsp;<span class="op" id="4314091">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314096">return</span>&nbsp;<span class="num" id="4314103">0</span><span class="op" id="4314104">,</span>&nbsp;<span class="ident" id="4314106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314116">d</span><span class="op" id="4314117">.</span><span class="ident" id="4314118">bits</span>&nbsp;<span class="op" id="4314123">|=</span>&nbsp;<span class="builtintype" id="4314126">uint32</span><span class="op" id="4314132">(</span><span class="ident" id="4314133">x</span><span class="op" id="4314134">)</span>&nbsp;<span class="op" id="4314136">&lt;&lt;</span>&nbsp;<span class="op" id="4314139">(</span><span class="num" id="4314140">24</span>&nbsp;<span class="op" id="4314143">-</span>&nbsp;<span class="ident" id="4314145">d</span><span class="op" id="4314146">.</span><span class="ident" id="4314147">nBits</span><span class="op" id="4314152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314156">d</span><span class="op" id="4314157">.</span><span class="ident" id="4314158">nBits</span>&nbsp;<span class="op" id="4314164">+=</span>&nbsp;<span class="num" id="4314167">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314170">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314173">code</span>&nbsp;<span class="op" id="4314178">:=</span>&nbsp;<span class="builtintype" id="4314181">uint16</span><span class="op" id="4314187">(</span><span class="ident" id="4314188">d</span><span class="op" id="4314189">.</span><span class="ident" id="4314190">bits</span>&nbsp;<span class="op" id="4314195">&gt;&gt;</span>&nbsp;<span class="op" id="4314198">(</span><span class="num" id="4314199">32</span>&nbsp;<span class="op" id="4314202">-</span>&nbsp;<span class="ident" id="4314204">d</span><span class="op" id="4314205">.</span><span class="ident" id="4314206">width</span><span class="op" id="4314211">)</span><span class="op" id="4314212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314215">d</span><span class="op" id="4314216">.</span><span class="ident" id="4314217">bits</span>&nbsp;<span class="op" id="4314222">&lt;&lt;=</span>&nbsp;<span class="ident" id="4314226">d</span><span class="op" id="4314227">.</span><span class="ident" id="4314228">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314235">d</span><span class="op" id="4314236">.</span><span class="ident" id="4314237">nBits</span>&nbsp;<span class="op" id="4314243">-=</span>&nbsp;<span class="ident" id="4314246">d</span><span class="op" id="4314247">.</span><span class="ident" id="4314248">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314255">return</span>&nbsp;<span class="ident" id="4314262">code</span><span class="op" id="4314266">,</span>&nbsp;<span class="ident" id="4314268">nil</span><br>
<span class="lineno"></span><span class="op" id="4314272">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="4314275">func</span>&nbsp;<span class="op" id="4314280">(</span><span class="ident" id="4314281">d</span>&nbsp;<span class="op" id="4314283">*</span><span class="ident" id="4314284">decoder</span><span class="op" id="4314291">)</span>&nbsp;<span class="ident" id="4314293">Read</span><span class="op" id="4314297">(</span><span class="ident" id="4314298">b</span>&nbsp;<span class="op" id="4314300">[</span><span class="op" id="4314301">]</span><span class="builtintype" id="4314302">byte</span><span class="op" id="4314306">)</span>&nbsp;<span class="op" id="4314308">(</span><span class="builtintype" id="4314309">int</span><span class="op" id="4314312">,</span>&nbsp;<span class="builtintype" id="4314314">error</span><span class="op" id="4314319">)</span>&nbsp;<span class="op" id="4314321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314324">for</span>&nbsp;<span class="op" id="4314328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314332">if</span>&nbsp;<span class="builtinfunc" id="4314335">len</span><span class="op" id="4314338">(</span><span class="ident" id="4314339">d</span><span class="op" id="4314340">.</span><span class="ident" id="4314341">toRead</span><span class="op" id="4314347">)</span>&nbsp;<span class="op" id="4314349">&gt;</span>&nbsp;<span class="num" id="4314351">0</span>&nbsp;<span class="op" id="4314353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314358">n</span>&nbsp;<span class="op" id="4314360">:=</span>&nbsp;<span class="builtinfunc" id="4314363">copy</span><span class="op" id="4314367">(</span><span class="ident" id="4314368">b</span><span class="op" id="4314369">,</span>&nbsp;<span class="ident" id="4314371">d</span><span class="op" id="4314372">.</span><span class="ident" id="4314373">toRead</span><span class="op" id="4314379">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314384">d</span><span class="op" id="4314385">.</span><span class="ident" id="4314386">toRead</span>&nbsp;<span class="op" id="4314393">=</span>&nbsp;<span class="ident" id="4314395">d</span><span class="op" id="4314396">.</span><span class="ident" id="4314397">toRead</span><span class="op" id="4314403">[</span><span class="ident" id="4314404">n</span><span class="op" id="4314405">:</span><span class="op" id="4314406">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314411">return</span>&nbsp;<span class="ident" id="4314418">n</span><span class="op" id="4314419">,</span>&nbsp;<span class="ident" id="4314421">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314431">if</span>&nbsp;<span class="ident" id="4314434">d</span><span class="op" id="4314435">.</span><span class="ident" id="4314436">err</span>&nbsp;<span class="op" id="4314440">!=</span>&nbsp;<span class="ident" id="4314443">nil</span>&nbsp;<span class="op" id="4314447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314452">return</span>&nbsp;<span class="num" id="4314459">0</span><span class="op" id="4314460">,</span>&nbsp;<span class="ident" id="4314462">d</span><span class="op" id="4314463">.</span><span class="ident" id="4314464">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314474">d</span><span class="op" id="4314475">.</span><span class="ident" id="4314476">decode</span><span class="op" id="4314482">(</span><span class="op" id="4314483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314486">}</span><br>
<span class="lineno"></span><span class="op" id="4314488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="4314491">//&nbsp;decode&nbsp;decompresses&nbsp;bytes&nbsp;from&nbsp;r&nbsp;and&nbsp;leaves&nbsp;them&nbsp;in&nbsp;d.toRead.</span><br>
<span class="lineno"></span><span class="comment" id="4314556">//&nbsp;read&nbsp;specifies&nbsp;how&nbsp;to&nbsp;decode&nbsp;bytes&nbsp;into&nbsp;codes.</span><br>
<span class="lineno"></span><span class="comment" id="4314606">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span><span class="keyword" id="4314657">func</span>&nbsp;<span class="op" id="4314662">(</span><span class="ident" id="4314663">d</span>&nbsp;<span class="op" id="4314665">*</span><span class="ident" id="4314666">decoder</span><span class="op" id="4314673">)</span>&nbsp;<span class="ident" id="4314675">decode</span><span class="op" id="4314681">(</span><span class="op" id="4314682">)</span>&nbsp;<span class="op" id="4314684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4314687">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;code&nbsp;stream,&nbsp;converting&nbsp;codes&nbsp;into&nbsp;decompressed&nbsp;bytes.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314760">for</span>&nbsp;<span class="op" id="4314764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314768">code</span><span class="op" id="4314772">,</span>&nbsp;<span class="ident" id="4314774">err</span>&nbsp;<span class="op" id="4314778">:=</span>&nbsp;<span class="ident" id="4314781">d</span><span class="op" id="4314782">.</span><span class="ident" id="4314783">read</span><span class="op" id="4314787">(</span><span class="ident" id="4314788">d</span><span class="op" id="4314789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314793">if</span>&nbsp;<span class="ident" id="4314796">err</span>&nbsp;<span class="op" id="4314800">!=</span>&nbsp;<span class="ident" id="4314803">nil</span>&nbsp;<span class="op" id="4314807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314812">if</span>&nbsp;<span class="ident" id="4314815">err</span>&nbsp;<span class="op" id="4314819">==</span>&nbsp;<span class="ident" id="4314822">io</span><span class="op" id="4314824">.</span><span class="ident" id="4314825">EOF</span>&nbsp;<span class="op" id="4314829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314835">err</span>&nbsp;<span class="op" id="4314839">=</span>&nbsp;<span class="ident" id="4314841">io</span><span class="op" id="4314843">.</span><span class="ident" id="4314844">ErrUnexpectedEOF</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314869">d</span><span class="op" id="4314870">.</span><span class="ident" id="4314871">err</span>&nbsp;<span class="op" id="4314875">=</span>&nbsp;<span class="ident" id="4314877">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314884">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314897">switch</span>&nbsp;<span class="op" id="4314904">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4314908">case</span>&nbsp;<span class="ident" id="4314913">code</span>&nbsp;<span class="op" id="4314918">&lt;</span>&nbsp;<span class="ident" id="4314920">d</span><span class="op" id="4314921">.</span><span class="ident" id="4314922">clear</span><span class="op" id="4314927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4314932">//&nbsp;We&nbsp;have&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314962">d</span><span class="op" id="4314963">.</span><span class="ident" id="4314964">output</span><span class="op" id="4314970">[</span><span class="ident" id="4314971">d</span><span class="op" id="4314972">.</span><span class="ident" id="4314973">o</span><span class="op" id="4314974">]</span>&nbsp;<span class="op" id="4314976">=</span>&nbsp;<span class="builtintype" id="4314978">uint8</span><span class="op" id="4314983">(</span><span class="ident" id="4314984">code</span><span class="op" id="4314988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314993">d</span><span class="op" id="4314994">.</span><span class="ident" id="4314995">o</span><span class="op" id="4314996">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315002">if</span>&nbsp;<span class="ident" id="4315005">d</span><span class="op" id="4315006">.</span><span class="ident" id="4315007">last</span>&nbsp;<span class="op" id="4315012">!=</span>&nbsp;<span class="ident" id="4315015">decoderInvalidCode</span>&nbsp;<span class="op" id="4315034">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4315040">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315081">d</span><span class="op" id="4315082">.</span><span class="ident" id="4315083">suffix</span><span class="op" id="4315089">[</span><span class="ident" id="4315090">d</span><span class="op" id="4315091">.</span><span class="ident" id="4315092">hi</span><span class="op" id="4315094">]</span>&nbsp;<span class="op" id="4315096">=</span>&nbsp;<span class="builtintype" id="4315098">uint8</span><span class="op" id="4315103">(</span><span class="ident" id="4315104">code</span><span class="op" id="4315108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315114">d</span><span class="op" id="4315115">.</span><span class="ident" id="4315116">prefix</span><span class="op" id="4315122">[</span><span class="ident" id="4315123">d</span><span class="op" id="4315124">.</span><span class="ident" id="4315125">hi</span><span class="op" id="4315127">]</span>&nbsp;<span class="op" id="4315129">=</span>&nbsp;<span class="ident" id="4315131">d</span><span class="op" id="4315132">.</span><span class="ident" id="4315133">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4315141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315145">case</span>&nbsp;<span class="ident" id="4315150">code</span>&nbsp;<span class="op" id="4315155">==</span>&nbsp;<span class="ident" id="4315158">d</span><span class="op" id="4315159">.</span><span class="ident" id="4315160">clear</span><span class="op" id="4315165">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315170">d</span><span class="op" id="4315171">.</span><span class="ident" id="4315172">width</span>&nbsp;<span class="op" id="4315178">=</span>&nbsp;<span class="num" id="4315180">1</span>&nbsp;<span class="op" id="4315182">+</span>&nbsp;<span class="builtintype" id="4315184">uint</span><span class="op" id="4315188">(</span><span class="ident" id="4315189">d</span><span class="op" id="4315190">.</span><span class="ident" id="4315191">litWidth</span><span class="op" id="4315199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315204">d</span><span class="op" id="4315205">.</span><span class="ident" id="4315206">hi</span>&nbsp;<span class="op" id="4315209">=</span>&nbsp;<span class="ident" id="4315211">d</span><span class="op" id="4315212">.</span><span class="ident" id="4315213">eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315220">d</span><span class="op" id="4315221">.</span><span class="ident" id="4315222">overflow</span>&nbsp;<span class="op" id="4315231">=</span>&nbsp;<span class="num" id="4315233">1</span>&nbsp;<span class="op" id="4315235">&lt;&lt;</span>&nbsp;<span class="ident" id="4315238">d</span><span class="op" id="4315239">.</span><span class="ident" id="4315240">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315249">d</span><span class="op" id="4315250">.</span><span class="ident" id="4315251">last</span>&nbsp;<span class="op" id="4315256">=</span>&nbsp;<span class="ident" id="4315258">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315280">continue</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315291">case</span>&nbsp;<span class="ident" id="4315296">code</span>&nbsp;<span class="op" id="4315301">==</span>&nbsp;<span class="ident" id="4315304">d</span><span class="op" id="4315305">.</span><span class="ident" id="4315306">eof</span><span class="op" id="4315309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315314">d</span><span class="op" id="4315315">.</span><span class="ident" id="4315316">flush</span><span class="op" id="4315321">(</span><span class="op" id="4315322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315327">d</span><span class="op" id="4315328">.</span><span class="ident" id="4315329">err</span>&nbsp;<span class="op" id="4315333">=</span>&nbsp;<span class="ident" id="4315335">io</span><span class="op" id="4315337">.</span><span class="ident" id="4315338">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315345">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315354">case</span>&nbsp;<span class="ident" id="4315359">code</span>&nbsp;<span class="op" id="4315364">&lt;=</span>&nbsp;<span class="ident" id="4315367">d</span><span class="op" id="4315368">.</span><span class="ident" id="4315369">hi</span><span class="op" id="4315371">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315376">c</span><span class="op" id="4315377">,</span>&nbsp;<span class="ident" id="4315379">i</span>&nbsp;<span class="op" id="4315381">:=</span>&nbsp;<span class="ident" id="4315384">code</span><span class="op" id="4315388">,</span>&nbsp;<span class="builtinfunc" id="4315390">len</span><span class="op" id="4315393">(</span><span class="ident" id="4315394">d</span><span class="op" id="4315395">.</span><span class="ident" id="4315396">output</span><span class="op" id="4315402">)</span><span class="op" id="4315403">-</span><span class="num" id="4315404">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315409">if</span>&nbsp;<span class="ident" id="4315412">code</span>&nbsp;<span class="op" id="4315417">==</span>&nbsp;<span class="ident" id="4315420">d</span><span class="op" id="4315421">.</span><span class="ident" id="4315422">hi</span>&nbsp;<span class="op" id="4315425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4315431">//&nbsp;code&nbsp;==&nbsp;hi&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;which&nbsp;expands&nbsp;to&nbsp;the&nbsp;last&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4315503">//&nbsp;followed&nbsp;by&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;last&nbsp;expansion.&nbsp;To&nbsp;find&nbsp;the&nbsp;head,&nbsp;we&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4315580">//&nbsp;the&nbsp;prefix&nbsp;chain&nbsp;until&nbsp;we&nbsp;find&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315634">c</span>&nbsp;<span class="op" id="4315636">=</span>&nbsp;<span class="ident" id="4315638">d</span><span class="op" id="4315639">.</span><span class="ident" id="4315640">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315649">for</span>&nbsp;<span class="ident" id="4315653">c</span>&nbsp;<span class="op" id="4315655">&gt;=</span>&nbsp;<span class="ident" id="4315658">d</span><span class="op" id="4315659">.</span><span class="ident" id="4315660">clear</span>&nbsp;<span class="op" id="4315666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315673">c</span>&nbsp;<span class="op" id="4315675">=</span>&nbsp;<span class="ident" id="4315677">d</span><span class="op" id="4315678">.</span><span class="ident" id="4315679">prefix</span><span class="op" id="4315685">[</span><span class="ident" id="4315686">c</span><span class="op" id="4315687">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4315693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315699">d</span><span class="op" id="4315700">.</span><span class="ident" id="4315701">output</span><span class="op" id="4315707">[</span><span class="ident" id="4315708">i</span><span class="op" id="4315709">]</span>&nbsp;<span class="op" id="4315711">=</span>&nbsp;<span class="builtintype" id="4315713">uint8</span><span class="op" id="4315718">(</span><span class="ident" id="4315719">c</span><span class="op" id="4315720">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315726">i</span><span class="op" id="4315727">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315734">c</span>&nbsp;<span class="op" id="4315736">=</span>&nbsp;<span class="ident" id="4315738">d</span><span class="op" id="4315739">.</span><span class="ident" id="4315740">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4315748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4315753">//&nbsp;Copy&nbsp;the&nbsp;suffix&nbsp;chain&nbsp;into&nbsp;output&nbsp;and&nbsp;then&nbsp;write&nbsp;that&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315819">for</span>&nbsp;<span class="ident" id="4315823">c</span>&nbsp;<span class="op" id="4315825">&gt;=</span>&nbsp;<span class="ident" id="4315828">d</span><span class="op" id="4315829">.</span><span class="ident" id="4315830">clear</span>&nbsp;<span class="op" id="4315836">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315842">d</span><span class="op" id="4315843">.</span><span class="ident" id="4315844">output</span><span class="op" id="4315850">[</span><span class="ident" id="4315851">i</span><span class="op" id="4315852">]</span>&nbsp;<span class="op" id="4315854">=</span>&nbsp;<span class="ident" id="4315856">d</span><span class="op" id="4315857">.</span><span class="ident" id="4315858">suffix</span><span class="op" id="4315864">[</span><span class="ident" id="4315865">c</span><span class="op" id="4315866">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315872">i</span><span class="op" id="4315873">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315880">c</span>&nbsp;<span class="op" id="4315882">=</span>&nbsp;<span class="ident" id="4315884">d</span><span class="op" id="4315885">.</span><span class="ident" id="4315886">prefix</span><span class="op" id="4315892">[</span><span class="ident" id="4315893">c</span><span class="op" id="4315894">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4315899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315904">d</span><span class="op" id="4315905">.</span><span class="ident" id="4315906">output</span><span class="op" id="4315912">[</span><span class="ident" id="4315913">i</span><span class="op" id="4315914">]</span>&nbsp;<span class="op" id="4315916">=</span>&nbsp;<span class="builtintype" id="4315918">uint8</span><span class="op" id="4315923">(</span><span class="ident" id="4315924">c</span><span class="op" id="4315925">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4315930">d</span><span class="op" id="4315931">.</span><span class="ident" id="4315932">o</span>&nbsp;<span class="op" id="4315934">+=</span>&nbsp;<span class="builtinfunc" id="4315937">copy</span><span class="op" id="4315941">(</span><span class="ident" id="4315942">d</span><span class="op" id="4315943">.</span><span class="ident" id="4315944">output</span><span class="op" id="4315950">[</span><span class="ident" id="4315951">d</span><span class="op" id="4315952">.</span><span class="ident" id="4315953">o</span><span class="op" id="4315954">:</span><span class="op" id="4315955">]</span><span class="op" id="4315956">,</span>&nbsp;<span class="ident" id="4315958">d</span><span class="op" id="4315959">.</span><span class="ident" id="4315960">output</span><span class="op" id="4315966">[</span><span class="ident" id="4315967">i</span><span class="op" id="4315968">:</span><span class="op" id="4315969">]</span><span class="op" id="4315970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4315975">if</span>&nbsp;<span class="ident" id="4315978">d</span><span class="op" id="4315979">.</span><span class="ident" id="4315980">last</span>&nbsp;<span class="op" id="4315985">!=</span>&nbsp;<span class="ident" id="4315988">decoderInvalidCode</span>&nbsp;<span class="op" id="4316007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4316013">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316054">d</span><span class="op" id="4316055">.</span><span class="ident" id="4316056">suffix</span><span class="op" id="4316062">[</span><span class="ident" id="4316063">d</span><span class="op" id="4316064">.</span><span class="ident" id="4316065">hi</span><span class="op" id="4316067">]</span>&nbsp;<span class="op" id="4316069">=</span>&nbsp;<span class="builtintype" id="4316071">uint8</span><span class="op" id="4316076">(</span><span class="ident" id="4316077">c</span><span class="op" id="4316078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316084">d</span><span class="op" id="4316085">.</span><span class="ident" id="4316086">prefix</span><span class="op" id="4316092">[</span><span class="ident" id="4316093">d</span><span class="op" id="4316094">.</span><span class="ident" id="4316095">hi</span><span class="op" id="4316097">]</span>&nbsp;<span class="op" id="4316099">=</span>&nbsp;<span class="ident" id="4316101">d</span><span class="op" id="4316102">.</span><span class="ident" id="4316103">last</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316115">default</span><span class="op" id="4316122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316127">d</span><span class="op" id="4316128">.</span><span class="ident" id="4316129">err</span>&nbsp;<span class="op" id="4316133">=</span>&nbsp;<span class="ident" id="4316135">errors</span><span class="op" id="4316141">.</span><span class="ident" id="4316142">New</span><span class="op" id="4316145">(</span><span class="string" id="4316146">&#34;lzw:&nbsp;invalid&nbsp;code&#34;</span><span class="op" id="4316165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316170">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316179">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316183">d</span><span class="op" id="4316184">.</span><span class="ident" id="4316185">last</span><span class="op" id="4316189">,</span>&nbsp;<span class="ident" id="4316191">d</span><span class="op" id="4316192">.</span><span class="ident" id="4316193">hi</span>&nbsp;<span class="op" id="4316196">=</span>&nbsp;<span class="ident" id="4316198">code</span><span class="op" id="4316202">,</span>&nbsp;<span class="ident" id="4316204">d</span><span class="op" id="4316205">.</span><span class="ident" id="4316206">hi</span><span class="op" id="4316208">+</span><span class="num" id="4316209">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316213">if</span>&nbsp;<span class="ident" id="4316216">d</span><span class="op" id="4316217">.</span><span class="ident" id="4316218">hi</span>&nbsp;<span class="op" id="4316221">&gt;=</span>&nbsp;<span class="ident" id="4316224">d</span><span class="op" id="4316225">.</span><span class="ident" id="4316226">overflow</span>&nbsp;<span class="op" id="4316235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316240">if</span>&nbsp;<span class="ident" id="4316243">d</span><span class="op" id="4316244">.</span><span class="ident" id="4316245">width</span>&nbsp;<span class="op" id="4316251">==</span>&nbsp;<span class="ident" id="4316254">maxWidth</span>&nbsp;<span class="op" id="4316263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316269">d</span><span class="op" id="4316270">.</span><span class="ident" id="4316271">last</span>&nbsp;<span class="op" id="4316276">=</span>&nbsp;<span class="ident" id="4316278">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316300">}</span>&nbsp;<span class="keyword" id="4316302">else</span>&nbsp;<span class="op" id="4316307">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316313">d</span><span class="op" id="4316314">.</span><span class="ident" id="4316315">width</span><span class="op" id="4316320">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316327">d</span><span class="op" id="4316328">.</span><span class="ident" id="4316329">overflow</span>&nbsp;<span class="op" id="4316338">&lt;&lt;=</span>&nbsp;<span class="num" id="4316342">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316355">if</span>&nbsp;<span class="ident" id="4316358">d</span><span class="op" id="4316359">.</span><span class="ident" id="4316360">o</span>&nbsp;<span class="op" id="4316362">&gt;=</span>&nbsp;<span class="ident" id="4316365">flushBuffer</span>&nbsp;<span class="op" id="4316377">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316382">d</span><span class="op" id="4316383">.</span><span class="ident" id="4316384">flush</span><span class="op" id="4316389">(</span><span class="op" id="4316390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316395">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4316407">}</span><br>
<span class="lineno"></span><span class="op" id="4316409">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="4316412">func</span>&nbsp;<span class="op" id="4316417">(</span><span class="ident" id="4316418">d</span>&nbsp;<span class="op" id="4316420">*</span><span class="ident" id="4316421">decoder</span><span class="op" id="4316428">)</span>&nbsp;<span class="ident" id="4316430">flush</span><span class="op" id="4316435">(</span><span class="op" id="4316436">)</span>&nbsp;<span class="op" id="4316438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316441">d</span><span class="op" id="4316442">.</span><span class="ident" id="4316443">toRead</span>&nbsp;<span class="op" id="4316450">=</span>&nbsp;<span class="ident" id="4316452">d</span><span class="op" id="4316453">.</span><span class="ident" id="4316454">output</span><span class="op" id="4316460">[</span><span class="op" id="4316461">:</span><span class="ident" id="4316462">d</span><span class="op" id="4316463">.</span><span class="ident" id="4316464">o</span><span class="op" id="4316465">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316468">d</span><span class="op" id="4316469">.</span><span class="ident" id="4316470">o</span>&nbsp;<span class="op" id="4316472">=</span>&nbsp;<span class="num" id="4316474">0</span><br>
<span class="lineno"></span><span class="op" id="4316476">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="4316479">var</span>&nbsp;<span class="ident" id="4316483">errClosed</span>&nbsp;<span class="op" id="4316493">=</span>&nbsp;<span class="ident" id="4316495">errors</span><span class="op" id="4316501">.</span><span class="ident" id="4316502">New</span><span class="op" id="4316505">(</span><span class="string" id="4316506">&#34;compress/lzw:&nbsp;reader/writer&nbsp;is&nbsp;closed&#34;</span><span class="op" id="4316545">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4316548">func</span>&nbsp;<span class="op" id="4316553">(</span><span class="ident" id="4316554">d</span>&nbsp;<span class="op" id="4316556">*</span><span class="ident" id="4316557">decoder</span><span class="op" id="4316564">)</span>&nbsp;<span class="ident" id="4316566">Close</span><span class="op" id="4316571">(</span><span class="op" id="4316572">)</span>&nbsp;<span class="builtintype" id="4316574">error</span>&nbsp;<span class="op" id="4316580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4316583">d</span><span class="op" id="4316584">.</span><span class="ident" id="4316585">err</span>&nbsp;<span class="op" id="4316589">=</span>&nbsp;<span class="ident" id="4316591">errClosed</span>&nbsp;<span class="comment" id="4316601">//&nbsp;in&nbsp;case&nbsp;any&nbsp;Reads&nbsp;come&nbsp;along</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4316634">return</span>&nbsp;<span class="ident" id="4316641">nil</span><br>
<span class="lineno"></span><span class="op" id="4316645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4316648">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.ReadCloser.</span><br>
<span class="lineno"></span><span class="comment" id="4316690">//&nbsp;Reads&nbsp;from&nbsp;the&nbsp;returned&nbsp;io.ReadCloser&nbsp;read&nbsp;and&nbsp;decompress&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">225</span><span class="comment" id="4316764">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="4316811">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="4316873">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;ReadCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4316947">//&nbsp;finished&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="4316968">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno">230</span><span class="comment" id="4317041">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="4317076">func</span>&nbsp;<span class="ident" id="4317081">NewReader</span><span class="op" id="4317090">(</span><span class="ident" id="4317091">r</span>&nbsp;<span class="ident" id="4317093">io</span><span class="op" id="4317095">.</span><span class="ident" id="4317096">Reader</span><span class="op" id="4317102">,</span>&nbsp;<span class="ident" id="4317104">order</span>&nbsp;<span class="ident" id="4317110">Order</span><span class="op" id="4317115">,</span>&nbsp;<span class="ident" id="4317117">litWidth</span>&nbsp;<span class="builtintype" id="4317126">int</span><span class="op" id="4317129">)</span>&nbsp;<span class="ident" id="4317131">io</span><span class="op" id="4317133">.</span><span class="ident" id="4317134">ReadCloser</span>&nbsp;<span class="op" id="4317145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317148">d</span>&nbsp;<span class="op" id="4317150">:=</span>&nbsp;<span class="builtinfunc" id="4317153">new</span><span class="op" id="4317156">(</span><span class="ident" id="4317157">decoder</span><span class="op" id="4317164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317167">switch</span>&nbsp;<span class="ident" id="4317174">order</span>&nbsp;<span class="op" id="4317180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317183">case</span>&nbsp;<span class="ident" id="4317188">LSB</span><span class="op" id="4317191">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317195">d</span><span class="op" id="4317196">.</span><span class="ident" id="4317197">read</span>&nbsp;<span class="op" id="4317202">=</span>&nbsp;<span class="op" id="4317204">(</span><span class="op" id="4317205">*</span><span class="ident" id="4317206">decoder</span><span class="op" id="4317213">)</span><span class="op" id="4317214">.</span><span class="ident" id="4317215">readLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317224">case</span>&nbsp;<span class="ident" id="4317229">MSB</span><span class="op" id="4317232">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317236">d</span><span class="op" id="4317237">.</span><span class="ident" id="4317238">read</span>&nbsp;<span class="op" id="4317243">=</span>&nbsp;<span class="op" id="4317245">(</span><span class="op" id="4317246">*</span><span class="ident" id="4317247">decoder</span><span class="op" id="4317254">)</span><span class="op" id="4317255">.</span><span class="ident" id="4317256">readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317265">default</span><span class="op" id="4317272">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317276">d</span><span class="op" id="4317277">.</span><span class="ident" id="4317278">err</span>&nbsp;<span class="op" id="4317282">=</span>&nbsp;<span class="ident" id="4317284">errors</span><span class="op" id="4317290">.</span><span class="ident" id="4317291">New</span><span class="op" id="4317294">(</span><span class="string" id="4317295">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="4317315">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317319">return</span>&nbsp;<span class="ident" id="4317326">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4317329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317332">if</span>&nbsp;<span class="ident" id="4317335">litWidth</span>&nbsp;<span class="op" id="4317344">&lt;</span>&nbsp;<span class="num" id="4317346">2</span>&nbsp;<span class="op" id="4317348">||</span>&nbsp;<span class="num" id="4317351">8</span>&nbsp;<span class="op" id="4317353">&lt;</span>&nbsp;<span class="ident" id="4317355">litWidth</span>&nbsp;<span class="op" id="4317364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317368">d</span><span class="op" id="4317369">.</span><span class="ident" id="4317370">err</span>&nbsp;<span class="op" id="4317374">=</span>&nbsp;<span class="ident" id="4317376">fmt</span><span class="op" id="4317379">.</span><span class="ident" id="4317380">Errorf</span><span class="op" id="4317386">(</span><span class="string" id="4317387">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4317418">,</span>&nbsp;<span class="ident" id="4317420">litWidth</span><span class="op" id="4317428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317432">return</span>&nbsp;<span class="ident" id="4317439">d</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4317442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317445">if</span>&nbsp;<span class="ident" id="4317448">br</span><span class="op" id="4317450">,</span>&nbsp;<span class="ident" id="4317452">ok</span>&nbsp;<span class="op" id="4317455">:=</span>&nbsp;<span class="ident" id="4317458">r</span><span class="op" id="4317459">.</span><span class="op" id="4317460">(</span><span class="ident" id="4317461">io</span><span class="op" id="4317463">.</span><span class="ident" id="4317464">ByteReader</span><span class="op" id="4317474">)</span><span class="op" id="4317475">;</span>&nbsp;<span class="ident" id="4317477">ok</span>&nbsp;<span class="op" id="4317480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317484">d</span><span class="op" id="4317485">.</span><span class="ident" id="4317486">r</span>&nbsp;<span class="op" id="4317488">=</span>&nbsp;<span class="ident" id="4317490">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4317494">}</span>&nbsp;<span class="keyword" id="4317496">else</span>&nbsp;<span class="op" id="4317501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317505">d</span><span class="op" id="4317506">.</span><span class="ident" id="4317507">r</span>&nbsp;<span class="op" id="4317509">=</span>&nbsp;<span class="ident" id="4317511">bufio</span><span class="op" id="4317516">.</span><span class="ident" id="4317517">NewReader</span><span class="op" id="4317526">(</span><span class="ident" id="4317527">r</span><span class="op" id="4317528">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4317531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317534">d</span><span class="op" id="4317535">.</span><span class="ident" id="4317536">litWidth</span>&nbsp;<span class="op" id="4317545">=</span>&nbsp;<span class="ident" id="4317547">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317557">d</span><span class="op" id="4317558">.</span><span class="ident" id="4317559">width</span>&nbsp;<span class="op" id="4317565">=</span>&nbsp;<span class="num" id="4317567">1</span>&nbsp;<span class="op" id="4317569">+</span>&nbsp;<span class="builtintype" id="4317571">uint</span><span class="op" id="4317575">(</span><span class="ident" id="4317576">litWidth</span><span class="op" id="4317584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317587">d</span><span class="op" id="4317588">.</span><span class="ident" id="4317589">clear</span>&nbsp;<span class="op" id="4317595">=</span>&nbsp;<span class="builtintype" id="4317597">uint16</span><span class="op" id="4317603">(</span><span class="num" id="4317604">1</span><span class="op" id="4317605">)</span>&nbsp;<span class="op" id="4317607">&lt;&lt;</span>&nbsp;<span class="builtintype" id="4317610">uint</span><span class="op" id="4317614">(</span><span class="ident" id="4317615">litWidth</span><span class="op" id="4317623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317626">d</span><span class="op" id="4317627">.</span><span class="ident" id="4317628">eof</span><span class="op" id="4317631">,</span>&nbsp;<span class="ident" id="4317633">d</span><span class="op" id="4317634">.</span><span class="ident" id="4317635">hi</span>&nbsp;<span class="op" id="4317638">=</span>&nbsp;<span class="ident" id="4317640">d</span><span class="op" id="4317641">.</span><span class="ident" id="4317642">clear</span><span class="op" id="4317647">+</span><span class="num" id="4317648">1</span><span class="op" id="4317649">,</span>&nbsp;<span class="ident" id="4317651">d</span><span class="op" id="4317652">.</span><span class="ident" id="4317653">clear</span><span class="op" id="4317658">+</span><span class="num" id="4317659">1</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317662">d</span><span class="op" id="4317663">.</span><span class="ident" id="4317664">overflow</span>&nbsp;<span class="op" id="4317673">=</span>&nbsp;<span class="builtintype" id="4317675">uint16</span><span class="op" id="4317681">(</span><span class="num" id="4317682">1</span><span class="op" id="4317683">)</span>&nbsp;<span class="op" id="4317685">&lt;&lt;</span>&nbsp;<span class="ident" id="4317688">d</span><span class="op" id="4317689">.</span><span class="ident" id="4317690">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4317697">d</span><span class="op" id="4317698">.</span><span class="ident" id="4317699">last</span>&nbsp;<span class="op" id="4317704">=</span>&nbsp;<span class="ident" id="4317706">decoderInvalidCode</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4317727">return</span>&nbsp;<span class="ident" id="4317734">d</span><br>
<span class="lineno"></span><span class="op" id="4317736">}</span>
</div>
</body>
</html>
