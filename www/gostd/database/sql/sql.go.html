<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html" class="current">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6344481">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6344536">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6344590">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6344641">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="6344710">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="6344724">//</span><br>
<span class="lineno"></span><span class="comment" id="6344727">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6344798">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="6344859">//</span><br>
<span class="lineno"></span><span class="comment" id="6344862">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6344911">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="6344943">package</span>&nbsp;<span class="ident" id="6344951">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6344956">import</span>&nbsp;<span class="op" id="6344963">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6344966">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6344989">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6344999">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6345006">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6345012">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6345023">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6345031">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6345038">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6345041">var</span>&nbsp;<span class="ident" id="6345045">drivers</span>&nbsp;<span class="op" id="6345053">=</span>&nbsp;<span class="builtinfunc" id="6345055">make</span><span class="op" id="6345059">(</span><span class="keyword" id="6345060">map</span><span class="op" id="6345063">[</span><span class="builtintype" id="6345064">string</span><span class="op" id="6345070">]</span><span class="ident" id="6345071">driver</span><span class="op" id="6345077">.</span><span class="ident" id="6345078">Driver</span><span class="op" id="6345084">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6345087">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="6345155">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="6345226">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="6345240">func</span>&nbsp;<span class="ident" id="6345245">Register</span><span class="op" id="6345253">(</span><span class="ident" id="6345254">name</span>&nbsp;<span class="builtintype" id="6345259">string</span><span class="op" id="6345265">,</span>&nbsp;<span class="ident" id="6345267">driver</span>&nbsp;<span class="ident" id="6345274">driver</span><span class="op" id="6345280">.</span><span class="ident" id="6345281">Driver</span><span class="op" id="6345287">)</span>&nbsp;<span class="op" id="6345289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345292">if</span>&nbsp;<span class="ident" id="6345295">driver</span>&nbsp;<span class="op" id="6345302">==</span>&nbsp;<span class="builtintype" id="6345305">nil</span>&nbsp;<span class="op" id="6345309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6345313">panic</span><span class="op" id="6345318">(</span><span class="string" id="6345319">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="6345348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345354">if</span>&nbsp;<span class="ident" id="6345357">_</span><span class="op" id="6345358">,</span>&nbsp;<span class="ident" id="6345360">dup</span>&nbsp;<span class="op" id="6345364">:=</span>&nbsp;<span class="ident" id="6345367">drivers</span><span class="op" id="6345374">[</span><span class="ident" id="6345375">name</span><span class="op" id="6345379">]</span><span class="op" id="6345380">;</span>&nbsp;<span class="ident" id="6345382">dup</span>&nbsp;<span class="op" id="6345386">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6345390">panic</span><span class="op" id="6345395">(</span><span class="string" id="6345396">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="6345437">+</span>&nbsp;<span class="ident" id="6345439">name</span><span class="op" id="6345443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345449">drivers</span><span class="op" id="6345456">[</span><span class="ident" id="6345457">name</span><span class="op" id="6345461">]</span>&nbsp;<span class="op" id="6345463">=</span>&nbsp;<span class="ident" id="6345465">driver</span><br>
<span class="lineno"></span><span class="op" id="6345472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6345475">func</span>&nbsp;<span class="ident" id="6345480">unregisterAllDrivers</span><span class="op" id="6345500">(</span><span class="op" id="6345501">)</span>&nbsp;<span class="op" id="6345503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345506">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345521">drivers</span>&nbsp;<span class="op" id="6345529">=</span>&nbsp;<span class="builtinfunc" id="6345531">make</span><span class="op" id="6345535">(</span><span class="keyword" id="6345536">map</span><span class="op" id="6345539">[</span><span class="builtintype" id="6345540">string</span><span class="op" id="6345546">]</span><span class="ident" id="6345547">driver</span><span class="op" id="6345553">.</span><span class="ident" id="6345554">Driver</span><span class="op" id="6345560">)</span><br>
<span class="lineno"></span><span class="op" id="6345562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6345565">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="6345638">func</span>&nbsp;<span class="ident" id="6345643">Drivers</span><span class="op" id="6345650">(</span><span class="op" id="6345651">)</span>&nbsp;<span class="op" id="6345653">[</span><span class="op" id="6345654">]</span><span class="builtintype" id="6345655">string</span>&nbsp;<span class="op" id="6345662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345665">var</span>&nbsp;<span class="ident" id="6345669">list</span>&nbsp;<span class="op" id="6345674">[</span><span class="op" id="6345675">]</span><span class="builtintype" id="6345676">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345684">for</span>&nbsp;<span class="ident" id="6345688">name</span>&nbsp;<span class="op" id="6345693">:=</span>&nbsp;<span class="keyword" id="6345696">range</span>&nbsp;<span class="ident" id="6345702">drivers</span>&nbsp;<span class="op" id="6345710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345714">list</span>&nbsp;<span class="op" id="6345719">=</span>&nbsp;<span class="builtinfunc" id="6345721">append</span><span class="op" id="6345727">(</span><span class="ident" id="6345728">list</span><span class="op" id="6345732">,</span>&nbsp;<span class="ident" id="6345734">name</span><span class="op" id="6345738">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345744">sort</span><span class="op" id="6345748">.</span><span class="ident" id="6345749">Strings</span><span class="op" id="6345756">(</span><span class="ident" id="6345757">list</span><span class="op" id="6345761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345764">return</span>&nbsp;<span class="ident" id="6345771">list</span><br>
<span class="lineno"></span><span class="op" id="6345776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="6345779">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6345849">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="6345921">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6345975">type</span>&nbsp;<span class="ident" id="6345980">RawBytes</span>&nbsp;<span class="op" id="6345989">[</span><span class="op" id="6345990">]</span><span class="builtintype" id="6345991">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6345997">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6346049">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6346099">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="6346140">//</span><br>
<span class="lineno"></span><span class="comment" id="6346143">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="6346164">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="6346235">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6346243">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6346260">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="6346283">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="6346296">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6346317">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6346323">//</span><br>
<span class="lineno"></span><span class="keyword" id="6346326">type</span>&nbsp;<span class="ident" id="6346331">NullString</span>&nbsp;<span class="keyword" id="6346342">struct</span>&nbsp;<span class="op" id="6346349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346352">String</span>&nbsp;<span class="builtintype" id="6346359">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346367">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="6346374">bool</span>&nbsp;<span class="comment" id="6346379">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6346418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6346421">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6346463">func</span>&nbsp;<span class="op" id="6346468">(</span><span class="ident" id="6346469">ns</span>&nbsp;<span class="op" id="6346472">*</span><span class="ident" id="6346473">NullString</span><span class="op" id="6346483">)</span>&nbsp;<span class="ident" id="6346485">Scan</span><span class="op" id="6346489">(</span><span class="ident" id="6346490">value</span>&nbsp;<span class="keyword" id="6346496">interface</span><span class="op" id="6346505">{</span><span class="op" id="6346506">}</span><span class="op" id="6346507">)</span>&nbsp;<span class="builtintype" id="6346509">error</span>&nbsp;<span class="op" id="6346515">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346518">if</span>&nbsp;<span class="ident" id="6346521">value</span>&nbsp;<span class="op" id="6346527">==</span>&nbsp;<span class="builtintype" id="6346530">nil</span>&nbsp;<span class="op" id="6346534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346538">ns</span><span class="op" id="6346540">.</span><span class="ident" id="6346541">String</span><span class="op" id="6346547">,</span>&nbsp;<span class="ident" id="6346549">ns</span><span class="op" id="6346551">.</span><span class="ident" id="6346552">Valid</span>&nbsp;<span class="op" id="6346558">=</span>&nbsp;<span class="string" id="6346560">&#34;&#34;</span><span class="op" id="6346562">,</span>&nbsp;<span class="builtintype" id="6346564">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346572">return</span>&nbsp;<span class="builtintype" id="6346579">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346587">ns</span><span class="op" id="6346589">.</span><span class="ident" id="6346590">Valid</span>&nbsp;<span class="op" id="6346596">=</span>&nbsp;<span class="builtintype" id="6346598">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346604">return</span>&nbsp;<span class="ident" id="6346611">convertAssign</span><span class="op" id="6346624">(</span><span class="op" id="6346625">&amp;</span><span class="ident" id="6346626">ns</span><span class="op" id="6346628">.</span><span class="ident" id="6346629">String</span><span class="op" id="6346635">,</span>&nbsp;<span class="ident" id="6346637">value</span><span class="op" id="6346642">)</span><br>
<span class="lineno"></span><span class="op" id="6346644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6346647">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6346696">func</span>&nbsp;<span class="op" id="6346701">(</span><span class="ident" id="6346702">ns</span>&nbsp;<span class="ident" id="6346705">NullString</span><span class="op" id="6346715">)</span>&nbsp;<span class="ident" id="6346717">Value</span><span class="op" id="6346722">(</span><span class="op" id="6346723">)</span>&nbsp;<span class="op" id="6346725">(</span><span class="ident" id="6346726">driver</span><span class="op" id="6346732">.</span><span class="ident" id="6346733">Value</span><span class="op" id="6346738">,</span>&nbsp;<span class="builtintype" id="6346740">error</span><span class="op" id="6346745">)</span>&nbsp;<span class="op" id="6346747">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346750">if</span>&nbsp;<span class="op" id="6346753">!</span><span class="ident" id="6346754">ns</span><span class="op" id="6346756">.</span><span class="ident" id="6346757">Valid</span>&nbsp;<span class="op" id="6346763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346767">return</span>&nbsp;<span class="builtintype" id="6346774">nil</span><span class="op" id="6346777">,</span>&nbsp;<span class="builtintype" id="6346779">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346787">return</span>&nbsp;<span class="ident" id="6346794">ns</span><span class="op" id="6346796">.</span><span class="ident" id="6346797">String</span><span class="op" id="6346803">,</span>&nbsp;<span class="builtintype" id="6346805">nil</span><br>
<span class="lineno"></span><span class="op" id="6346809">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="6346812">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6346863">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6346912">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6346976">type</span>&nbsp;<span class="ident" id="6346981">NullInt64</span>&nbsp;<span class="keyword" id="6346991">struct</span>&nbsp;<span class="op" id="6346998">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347001">Int64</span>&nbsp;<span class="ident" id="6347007">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347014">Valid</span>&nbsp;<span class="builtintype" id="6347020">bool</span>&nbsp;<span class="comment" id="6347025">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6347063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6347066">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="6347108">func</span>&nbsp;<span class="op" id="6347113">(</span><span class="ident" id="6347114">n</span>&nbsp;<span class="op" id="6347116">*</span><span class="ident" id="6347117">NullInt64</span><span class="op" id="6347126">)</span>&nbsp;<span class="ident" id="6347128">Scan</span><span class="op" id="6347132">(</span><span class="ident" id="6347133">value</span>&nbsp;<span class="keyword" id="6347139">interface</span><span class="op" id="6347148">{</span><span class="op" id="6347149">}</span><span class="op" id="6347150">)</span>&nbsp;<span class="builtintype" id="6347152">error</span>&nbsp;<span class="op" id="6347158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347161">if</span>&nbsp;<span class="ident" id="6347164">value</span>&nbsp;<span class="op" id="6347170">==</span>&nbsp;<span class="builtintype" id="6347173">nil</span>&nbsp;<span class="op" id="6347177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347181">n</span><span class="op" id="6347182">.</span><span class="ident" id="6347183">Int64</span><span class="op" id="6347188">,</span>&nbsp;<span class="ident" id="6347190">n</span><span class="op" id="6347191">.</span><span class="ident" id="6347192">Valid</span>&nbsp;<span class="op" id="6347198">=</span>&nbsp;<span class="num" id="6347200">0</span><span class="op" id="6347201">,</span>&nbsp;<span class="builtintype" id="6347203">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347211">return</span>&nbsp;<span class="builtintype" id="6347218">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347223">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347226">n</span><span class="op" id="6347227">.</span><span class="ident" id="6347228">Valid</span>&nbsp;<span class="op" id="6347234">=</span>&nbsp;<span class="builtintype" id="6347236">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347242">return</span>&nbsp;<span class="ident" id="6347249">convertAssign</span><span class="op" id="6347262">(</span><span class="op" id="6347263">&amp;</span><span class="ident" id="6347264">n</span><span class="op" id="6347265">.</span><span class="ident" id="6347266">Int64</span><span class="op" id="6347271">,</span>&nbsp;<span class="ident" id="6347273">value</span><span class="op" id="6347278">)</span><br>
<span class="lineno"></span><span class="op" id="6347280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6347283">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="6347332">func</span>&nbsp;<span class="op" id="6347337">(</span><span class="ident" id="6347338">n</span>&nbsp;<span class="ident" id="6347340">NullInt64</span><span class="op" id="6347349">)</span>&nbsp;<span class="ident" id="6347351">Value</span><span class="op" id="6347356">(</span><span class="op" id="6347357">)</span>&nbsp;<span class="op" id="6347359">(</span><span class="ident" id="6347360">driver</span><span class="op" id="6347366">.</span><span class="ident" id="6347367">Value</span><span class="op" id="6347372">,</span>&nbsp;<span class="builtintype" id="6347374">error</span><span class="op" id="6347379">)</span>&nbsp;<span class="op" id="6347381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347384">if</span>&nbsp;<span class="op" id="6347387">!</span><span class="ident" id="6347388">n</span><span class="op" id="6347389">.</span><span class="ident" id="6347390">Valid</span>&nbsp;<span class="op" id="6347396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347400">return</span>&nbsp;<span class="builtintype" id="6347407">nil</span><span class="op" id="6347410">,</span>&nbsp;<span class="builtintype" id="6347412">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347420">return</span>&nbsp;<span class="ident" id="6347427">n</span><span class="op" id="6347428">.</span><span class="ident" id="6347429">Int64</span><span class="op" id="6347434">,</span>&nbsp;<span class="builtintype" id="6347436">nil</span><br>
<span class="lineno">120</span><span class="op" id="6347440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6347443">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6347497">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6347548">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="6347612">type</span>&nbsp;<span class="ident" id="6347617">NullFloat64</span>&nbsp;<span class="keyword" id="6347629">struct</span>&nbsp;<span class="op" id="6347636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347639">Float64</span>&nbsp;<span class="builtintype" id="6347647">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347656">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6347664">bool</span>&nbsp;<span class="comment" id="6347669">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6347709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6347712">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6347754">func</span>&nbsp;<span class="op" id="6347759">(</span><span class="ident" id="6347760">n</span>&nbsp;<span class="op" id="6347762">*</span><span class="ident" id="6347763">NullFloat64</span><span class="op" id="6347774">)</span>&nbsp;<span class="ident" id="6347776">Scan</span><span class="op" id="6347780">(</span><span class="ident" id="6347781">value</span>&nbsp;<span class="keyword" id="6347787">interface</span><span class="op" id="6347796">{</span><span class="op" id="6347797">}</span><span class="op" id="6347798">)</span>&nbsp;<span class="builtintype" id="6347800">error</span>&nbsp;<span class="op" id="6347806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347809">if</span>&nbsp;<span class="ident" id="6347812">value</span>&nbsp;<span class="op" id="6347818">==</span>&nbsp;<span class="builtintype" id="6347821">nil</span>&nbsp;<span class="op" id="6347825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347829">n</span><span class="op" id="6347830">.</span><span class="ident" id="6347831">Float64</span><span class="op" id="6347838">,</span>&nbsp;<span class="ident" id="6347840">n</span><span class="op" id="6347841">.</span><span class="ident" id="6347842">Valid</span>&nbsp;<span class="op" id="6347848">=</span>&nbsp;<span class="num" id="6347850">0</span><span class="op" id="6347851">,</span>&nbsp;<span class="builtintype" id="6347853">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347861">return</span>&nbsp;<span class="builtintype" id="6347868">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347876">n</span><span class="op" id="6347877">.</span><span class="ident" id="6347878">Valid</span>&nbsp;<span class="op" id="6347884">=</span>&nbsp;<span class="builtintype" id="6347886">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347892">return</span>&nbsp;<span class="ident" id="6347899">convertAssign</span><span class="op" id="6347912">(</span><span class="op" id="6347913">&amp;</span><span class="ident" id="6347914">n</span><span class="op" id="6347915">.</span><span class="ident" id="6347916">Float64</span><span class="op" id="6347923">,</span>&nbsp;<span class="ident" id="6347925">value</span><span class="op" id="6347930">)</span><br>
<span class="lineno"></span><span class="op" id="6347932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="6347935">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6347984">func</span>&nbsp;<span class="op" id="6347989">(</span><span class="ident" id="6347990">n</span>&nbsp;<span class="ident" id="6347992">NullFloat64</span><span class="op" id="6348003">)</span>&nbsp;<span class="ident" id="6348005">Value</span><span class="op" id="6348010">(</span><span class="op" id="6348011">)</span>&nbsp;<span class="op" id="6348013">(</span><span class="ident" id="6348014">driver</span><span class="op" id="6348020">.</span><span class="ident" id="6348021">Value</span><span class="op" id="6348026">,</span>&nbsp;<span class="builtintype" id="6348028">error</span><span class="op" id="6348033">)</span>&nbsp;<span class="op" id="6348035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348038">if</span>&nbsp;<span class="op" id="6348041">!</span><span class="ident" id="6348042">n</span><span class="op" id="6348043">.</span><span class="ident" id="6348044">Valid</span>&nbsp;<span class="op" id="6348050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348054">return</span>&nbsp;<span class="builtintype" id="6348061">nil</span><span class="op" id="6348064">,</span>&nbsp;<span class="builtintype" id="6348066">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348071">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348074">return</span>&nbsp;<span class="ident" id="6348081">n</span><span class="op" id="6348082">.</span><span class="ident" id="6348083">Float64</span><span class="op" id="6348090">,</span>&nbsp;<span class="builtintype" id="6348092">nil</span><br>
<span class="lineno"></span><span class="op" id="6348096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348099">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6348147">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="6348195">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6348259">type</span>&nbsp;<span class="ident" id="6348264">NullBool</span>&nbsp;<span class="keyword" id="6348273">struct</span>&nbsp;<span class="op" id="6348280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348283">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="6348289">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348295">Valid</span>&nbsp;<span class="builtintype" id="6348301">bool</span>&nbsp;<span class="comment" id="6348306">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6348343">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6348346">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6348388">func</span>&nbsp;<span class="op" id="6348393">(</span><span class="ident" id="6348394">n</span>&nbsp;<span class="op" id="6348396">*</span><span class="ident" id="6348397">NullBool</span><span class="op" id="6348405">)</span>&nbsp;<span class="ident" id="6348407">Scan</span><span class="op" id="6348411">(</span><span class="ident" id="6348412">value</span>&nbsp;<span class="keyword" id="6348418">interface</span><span class="op" id="6348427">{</span><span class="op" id="6348428">}</span><span class="op" id="6348429">)</span>&nbsp;<span class="builtintype" id="6348431">error</span>&nbsp;<span class="op" id="6348437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348440">if</span>&nbsp;<span class="ident" id="6348443">value</span>&nbsp;<span class="op" id="6348449">==</span>&nbsp;<span class="builtintype" id="6348452">nil</span>&nbsp;<span class="op" id="6348456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348460">n</span><span class="op" id="6348461">.</span><span class="ident" id="6348462">Bool</span><span class="op" id="6348466">,</span>&nbsp;<span class="ident" id="6348468">n</span><span class="op" id="6348469">.</span><span class="ident" id="6348470">Valid</span>&nbsp;<span class="op" id="6348476">=</span>&nbsp;<span class="builtintype" id="6348478">false</span><span class="op" id="6348483">,</span>&nbsp;<span class="builtintype" id="6348485">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348493">return</span>&nbsp;<span class="builtintype" id="6348500">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348508">n</span><span class="op" id="6348509">.</span><span class="ident" id="6348510">Valid</span>&nbsp;<span class="op" id="6348516">=</span>&nbsp;<span class="builtintype" id="6348518">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348524">return</span>&nbsp;<span class="ident" id="6348531">convertAssign</span><span class="op" id="6348544">(</span><span class="op" id="6348545">&amp;</span><span class="ident" id="6348546">n</span><span class="op" id="6348547">.</span><span class="ident" id="6348548">Bool</span><span class="op" id="6348552">,</span>&nbsp;<span class="ident" id="6348554">value</span><span class="op" id="6348559">)</span><br>
<span class="lineno"></span><span class="op" id="6348561">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="6348564">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6348613">func</span>&nbsp;<span class="op" id="6348618">(</span><span class="ident" id="6348619">n</span>&nbsp;<span class="ident" id="6348621">NullBool</span><span class="op" id="6348629">)</span>&nbsp;<span class="ident" id="6348631">Value</span><span class="op" id="6348636">(</span><span class="op" id="6348637">)</span>&nbsp;<span class="op" id="6348639">(</span><span class="ident" id="6348640">driver</span><span class="op" id="6348646">.</span><span class="ident" id="6348647">Value</span><span class="op" id="6348652">,</span>&nbsp;<span class="builtintype" id="6348654">error</span><span class="op" id="6348659">)</span>&nbsp;<span class="op" id="6348661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348664">if</span>&nbsp;<span class="op" id="6348667">!</span><span class="ident" id="6348668">n</span><span class="op" id="6348669">.</span><span class="ident" id="6348670">Valid</span>&nbsp;<span class="op" id="6348676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348680">return</span>&nbsp;<span class="builtintype" id="6348687">nil</span><span class="op" id="6348690">,</span>&nbsp;<span class="builtintype" id="6348692">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348700">return</span>&nbsp;<span class="ident" id="6348707">n</span><span class="op" id="6348708">.</span><span class="ident" id="6348709">Bool</span><span class="op" id="6348713">,</span>&nbsp;<span class="builtintype" id="6348715">nil</span><br>
<span class="lineno"></span><span class="op" id="6348719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348722">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="6348763">type</span>&nbsp;<span class="ident" id="6348768">Scanner</span>&nbsp;<span class="keyword" id="6348776">interface</span>&nbsp;<span class="op" id="6348786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348789">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348838">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348842">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348903">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348921">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348925">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348938">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348953">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348965">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348979">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348993">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349010">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349039">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349043">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349106">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349139">Scan</span><span class="op" id="6349143">(</span><span class="ident" id="6349144">src</span>&nbsp;<span class="keyword" id="6349148">interface</span><span class="op" id="6349157">{</span><span class="op" id="6349158">}</span><span class="op" id="6349159">)</span>&nbsp;<span class="builtintype" id="6349161">error</span><br>
<span class="lineno"></span><span class="op" id="6349167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6349170">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="6349234">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="6349305">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="6349340">var</span>&nbsp;<span class="ident" id="6349344">ErrNoRows</span>&nbsp;<span class="op" id="6349354">=</span>&nbsp;<span class="ident" id="6349356">errors</span><span class="op" id="6349362">.</span><span class="ident" id="6349363">New</span><span class="op" id="6349366">(</span><span class="string" id="6349367">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="6349395">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6349398">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="6349461">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="6349529">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="6349544">//</span><br>
<span class="lineno"></span><span class="comment" id="6349547">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6349614">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="6349685">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="6349755">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6349818">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6349881">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="6349942">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="6350012">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="6350055">type</span>&nbsp;<span class="ident" id="6350060">DB</span>&nbsp;<span class="keyword" id="6350063">struct</span>&nbsp;<span class="op" id="6350070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350073">driver</span>&nbsp;<span class="ident" id="6350080">driver</span><span class="op" id="6350086">.</span><span class="ident" id="6350087">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350095">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6350102">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350111">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350124">sync</span><span class="op" id="6350128">.</span><span class="ident" id="6350129">Mutex</span>&nbsp;<span class="comment" id="6350135">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350165">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350178">[</span><span class="op" id="6350179">]</span><span class="op" id="6350180">*</span><span class="ident" id="6350181">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350193">connRequests</span>&nbsp;<span class="op" id="6350206">[</span><span class="op" id="6350207">]</span><span class="keyword" id="6350208">chan</span>&nbsp;<span class="ident" id="6350213">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350226">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6350239">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350244">pendingOpens</span>&nbsp;<span class="builtintype" id="6350257">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350262">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350310">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350376">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350455">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350528">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350551">openerCh</span>&nbsp;<span class="keyword" id="6350560">chan</span>&nbsp;<span class="keyword" id="6350565">struct</span><span class="op" id="6350571">{</span><span class="op" id="6350572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350575">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6350584">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350590">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350599">map</span><span class="op" id="6350602">[</span><span class="ident" id="6350603">finalCloser</span><span class="op" id="6350614">]</span><span class="ident" id="6350615">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350623">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="6350632">map</span><span class="op" id="6350635">[</span><span class="op" id="6350636">*</span><span class="ident" id="6350637">driverConn</span><span class="op" id="6350647">]</span><span class="builtintype" id="6350648">string</span>&nbsp;<span class="comment" id="6350655">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350701">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="6350710">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350733">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350786">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="6350795">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350818">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="6350842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350845">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6350896">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="6350965">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="6351030">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="6351047">type</span>&nbsp;<span class="ident" id="6351052">driverConn</span>&nbsp;<span class="keyword" id="6351063">struct</span>&nbsp;<span class="op" id="6351070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351073">db</span>&nbsp;<span class="op" id="6351076">*</span><span class="ident" id="6351077">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351082">sync</span><span class="op" id="6351086">.</span><span class="ident" id="6351087">Mutex</span>&nbsp;&nbsp;<span class="comment" id="6351094">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351115">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351127">driver</span><span class="op" id="6351133">.</span><span class="ident" id="6351134">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351140">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6351152">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351158">finalClosed</span>&nbsp;<span class="builtintype" id="6351170">bool</span>&nbsp;<span class="comment" id="6351175">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351204">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351216">map</span><span class="op" id="6351219">[</span><span class="ident" id="6351220">driver</span><span class="op" id="6351226">.</span><span class="ident" id="6351227">Stmt</span><span class="op" id="6351231">]</span><span class="builtintype" id="6351232">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351239">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351260">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6351271">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351277">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351288">[</span><span class="op" id="6351289">]</span><span class="keyword" id="6351290">func</span><span class="op" id="6351294">(</span><span class="op" id="6351295">)</span>&nbsp;<span class="comment" id="6351297">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351355">dbmuClosed</span>&nbsp;<span class="builtintype" id="6351366">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351375">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="6351431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6351434">func</span>&nbsp;<span class="op" id="6351439">(</span><span class="ident" id="6351440">dc</span>&nbsp;<span class="op" id="6351443">*</span><span class="ident" id="6351444">driverConn</span><span class="op" id="6351454">)</span>&nbsp;<span class="ident" id="6351456">releaseConn</span><span class="op" id="6351467">(</span><span class="ident" id="6351468">err</span>&nbsp;<span class="builtintype" id="6351472">error</span><span class="op" id="6351477">)</span>&nbsp;<span class="op" id="6351479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351482">dc</span><span class="op" id="6351484">.</span><span class="ident" id="6351485">db</span><span class="op" id="6351487">.</span><span class="ident" id="6351488">putConn</span><span class="op" id="6351495">(</span><span class="ident" id="6351496">dc</span><span class="op" id="6351498">,</span>&nbsp;<span class="ident" id="6351500">err</span><span class="op" id="6351503">)</span><br>
<span class="lineno"></span><span class="op" id="6351505">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6351508">func</span>&nbsp;<span class="op" id="6351513">(</span><span class="ident" id="6351514">dc</span>&nbsp;<span class="op" id="6351517">*</span><span class="ident" id="6351518">driverConn</span><span class="op" id="6351528">)</span>&nbsp;<span class="ident" id="6351530">removeOpenStmt</span><span class="op" id="6351544">(</span><span class="ident" id="6351545">si</span>&nbsp;<span class="ident" id="6351548">driver</span><span class="op" id="6351554">.</span><span class="ident" id="6351555">Stmt</span><span class="op" id="6351559">)</span>&nbsp;<span class="op" id="6351561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351564">dc</span><span class="op" id="6351566">.</span><span class="ident" id="6351567">Lock</span><span class="op" id="6351571">(</span><span class="op" id="6351572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351575">defer</span>&nbsp;<span class="ident" id="6351581">dc</span><span class="op" id="6351583">.</span><span class="ident" id="6351584">Unlock</span><span class="op" id="6351590">(</span><span class="op" id="6351591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6351594">delete</span><span class="op" id="6351600">(</span><span class="ident" id="6351601">dc</span><span class="op" id="6351603">.</span><span class="ident" id="6351604">openStmt</span><span class="op" id="6351612">,</span>&nbsp;<span class="ident" id="6351614">si</span><span class="op" id="6351616">)</span><br>
<span class="lineno">260</span><span class="op" id="6351618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6351621">func</span>&nbsp;<span class="op" id="6351626">(</span><span class="ident" id="6351627">dc</span>&nbsp;<span class="op" id="6351630">*</span><span class="ident" id="6351631">driverConn</span><span class="op" id="6351641">)</span>&nbsp;<span class="ident" id="6351643">prepareLocked</span><span class="op" id="6351656">(</span><span class="ident" id="6351657">query</span>&nbsp;<span class="builtintype" id="6351663">string</span><span class="op" id="6351669">)</span>&nbsp;<span class="op" id="6351671">(</span><span class="ident" id="6351672">driver</span><span class="op" id="6351678">.</span><span class="ident" id="6351679">Stmt</span><span class="op" id="6351683">,</span>&nbsp;<span class="builtintype" id="6351685">error</span><span class="op" id="6351690">)</span>&nbsp;<span class="op" id="6351692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351695">si</span><span class="op" id="6351697">,</span>&nbsp;<span class="ident" id="6351699">err</span>&nbsp;<span class="op" id="6351703">:=</span>&nbsp;<span class="ident" id="6351706">dc</span><span class="op" id="6351708">.</span><span class="ident" id="6351709">ci</span><span class="op" id="6351711">.</span><span class="ident" id="6351712">Prepare</span><span class="op" id="6351719">(</span><span class="ident" id="6351720">query</span><span class="op" id="6351725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351728">if</span>&nbsp;<span class="ident" id="6351731">err</span>&nbsp;<span class="op" id="6351735">==</span>&nbsp;<span class="builtintype" id="6351738">nil</span>&nbsp;<span class="op" id="6351742">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351746">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351813">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351843">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351848">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351905">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351968">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352025">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352030">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352086">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352135">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352180">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352224">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352273">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352319">if</span>&nbsp;<span class="ident" id="6352322">dc</span><span class="op" id="6352324">.</span><span class="ident" id="6352325">openStmt</span>&nbsp;<span class="op" id="6352334">==</span>&nbsp;<span class="builtintype" id="6352337">nil</span>&nbsp;<span class="op" id="6352341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352346">dc</span><span class="op" id="6352348">.</span><span class="ident" id="6352349">openStmt</span>&nbsp;<span class="op" id="6352358">=</span>&nbsp;<span class="builtinfunc" id="6352360">make</span><span class="op" id="6352364">(</span><span class="keyword" id="6352365">map</span><span class="op" id="6352368">[</span><span class="ident" id="6352369">driver</span><span class="op" id="6352375">.</span><span class="ident" id="6352376">Stmt</span><span class="op" id="6352380">]</span><span class="builtintype" id="6352381">bool</span><span class="op" id="6352385">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352393">dc</span><span class="op" id="6352395">.</span><span class="ident" id="6352396">openStmt</span><span class="op" id="6352404">[</span><span class="ident" id="6352405">si</span><span class="op" id="6352407">]</span>&nbsp;<span class="op" id="6352409">=</span>&nbsp;<span class="builtintype" id="6352411">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352420">return</span>&nbsp;<span class="ident" id="6352427">si</span><span class="op" id="6352429">,</span>&nbsp;<span class="ident" id="6352431">err</span><br>
<span class="lineno"></span><span class="op" id="6352435">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="6352438">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6352468">func</span>&nbsp;<span class="op" id="6352473">(</span><span class="ident" id="6352474">dc</span>&nbsp;<span class="op" id="6352477">*</span><span class="ident" id="6352478">driverConn</span><span class="op" id="6352488">)</span>&nbsp;<span class="ident" id="6352490">closeDBLocked</span><span class="op" id="6352503">(</span><span class="op" id="6352504">)</span>&nbsp;<span class="keyword" id="6352506">func</span><span class="op" id="6352510">(</span><span class="op" id="6352511">)</span>&nbsp;<span class="builtintype" id="6352513">error</span>&nbsp;<span class="op" id="6352519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352522">dc</span><span class="op" id="6352524">.</span><span class="ident" id="6352525">Lock</span><span class="op" id="6352529">(</span><span class="op" id="6352530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352533">defer</span>&nbsp;<span class="ident" id="6352539">dc</span><span class="op" id="6352541">.</span><span class="ident" id="6352542">Unlock</span><span class="op" id="6352548">(</span><span class="op" id="6352549">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352552">if</span>&nbsp;<span class="ident" id="6352555">dc</span><span class="op" id="6352557">.</span><span class="ident" id="6352558">closed</span>&nbsp;<span class="op" id="6352565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352569">return</span>&nbsp;<span class="keyword" id="6352576">func</span><span class="op" id="6352580">(</span><span class="op" id="6352581">)</span>&nbsp;<span class="builtintype" id="6352583">error</span>&nbsp;<span class="op" id="6352589">{</span>&nbsp;<span class="keyword" id="6352591">return</span>&nbsp;<span class="ident" id="6352598">errors</span><span class="op" id="6352604">.</span><span class="ident" id="6352605">New</span><span class="op" id="6352608">(</span><span class="string" id="6352609">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6352642">)</span>&nbsp;<span class="op" id="6352644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352650">dc</span><span class="op" id="6352652">.</span><span class="ident" id="6352653">closed</span>&nbsp;<span class="op" id="6352660">=</span>&nbsp;<span class="builtintype" id="6352662">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352668">return</span>&nbsp;<span class="ident" id="6352675">dc</span><span class="op" id="6352677">.</span><span class="ident" id="6352678">db</span><span class="op" id="6352680">.</span><span class="ident" id="6352681">removeDepLocked</span><span class="op" id="6352696">(</span><span class="ident" id="6352697">dc</span><span class="op" id="6352699">,</span>&nbsp;<span class="ident" id="6352701">dc</span><span class="op" id="6352703">)</span><br>
<span class="lineno">295</span><span class="op" id="6352705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6352708">func</span>&nbsp;<span class="op" id="6352713">(</span><span class="ident" id="6352714">dc</span>&nbsp;<span class="op" id="6352717">*</span><span class="ident" id="6352718">driverConn</span><span class="op" id="6352728">)</span>&nbsp;<span class="ident" id="6352730">Close</span><span class="op" id="6352735">(</span><span class="op" id="6352736">)</span>&nbsp;<span class="builtintype" id="6352738">error</span>&nbsp;<span class="op" id="6352744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352747">dc</span><span class="op" id="6352749">.</span><span class="ident" id="6352750">Lock</span><span class="op" id="6352754">(</span><span class="op" id="6352755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352758">if</span>&nbsp;<span class="ident" id="6352761">dc</span><span class="op" id="6352763">.</span><span class="ident" id="6352764">closed</span>&nbsp;<span class="op" id="6352771">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352775">dc</span><span class="op" id="6352777">.</span><span class="ident" id="6352778">Unlock</span><span class="op" id="6352784">(</span><span class="op" id="6352785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352789">return</span>&nbsp;<span class="ident" id="6352796">errors</span><span class="op" id="6352802">.</span><span class="ident" id="6352803">New</span><span class="op" id="6352806">(</span><span class="string" id="6352807">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6352840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352846">dc</span><span class="op" id="6352848">.</span><span class="ident" id="6352849">closed</span>&nbsp;<span class="op" id="6352856">=</span>&nbsp;<span class="builtintype" id="6352858">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352864">dc</span><span class="op" id="6352866">.</span><span class="ident" id="6352867">Unlock</span><span class="op" id="6352873">(</span><span class="op" id="6352874">)</span>&nbsp;<span class="comment" id="6352876">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352936">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352989">dc</span><span class="op" id="6352991">.</span><span class="ident" id="6352992">db</span><span class="op" id="6352994">.</span><span class="ident" id="6352995">mu</span><span class="op" id="6352997">.</span><span class="ident" id="6352998">Lock</span><span class="op" id="6353002">(</span><span class="op" id="6353003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353006">dc</span><span class="op" id="6353008">.</span><span class="ident" id="6353009">dbmuClosed</span>&nbsp;<span class="op" id="6353020">=</span>&nbsp;<span class="builtintype" id="6353022">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353028">fn</span>&nbsp;<span class="op" id="6353031">:=</span>&nbsp;<span class="ident" id="6353034">dc</span><span class="op" id="6353036">.</span><span class="ident" id="6353037">db</span><span class="op" id="6353039">.</span><span class="ident" id="6353040">removeDepLocked</span><span class="op" id="6353055">(</span><span class="ident" id="6353056">dc</span><span class="op" id="6353058">,</span>&nbsp;<span class="ident" id="6353060">dc</span><span class="op" id="6353062">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353065">dc</span><span class="op" id="6353067">.</span><span class="ident" id="6353068">db</span><span class="op" id="6353070">.</span><span class="ident" id="6353071">mu</span><span class="op" id="6353073">.</span><span class="ident" id="6353074">Unlock</span><span class="op" id="6353080">(</span><span class="op" id="6353081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353084">return</span>&nbsp;<span class="ident" id="6353091">fn</span><span class="op" id="6353093">(</span><span class="op" id="6353094">)</span><br>
<span class="lineno"></span><span class="op" id="6353096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6353099">func</span>&nbsp;<span class="op" id="6353104">(</span><span class="ident" id="6353105">dc</span>&nbsp;<span class="op" id="6353108">*</span><span class="ident" id="6353109">driverConn</span><span class="op" id="6353119">)</span>&nbsp;<span class="ident" id="6353121">finalClose</span><span class="op" id="6353131">(</span><span class="op" id="6353132">)</span>&nbsp;<span class="builtintype" id="6353134">error</span>&nbsp;<span class="op" id="6353140">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353143">dc</span><span class="op" id="6353145">.</span><span class="ident" id="6353146">Lock</span><span class="op" id="6353150">(</span><span class="op" id="6353151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353155">for</span>&nbsp;<span class="ident" id="6353159">si</span>&nbsp;<span class="op" id="6353162">:=</span>&nbsp;<span class="keyword" id="6353165">range</span>&nbsp;<span class="ident" id="6353171">dc</span><span class="op" id="6353173">.</span><span class="ident" id="6353174">openStmt</span>&nbsp;<span class="op" id="6353183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353187">si</span><span class="op" id="6353189">.</span><span class="ident" id="6353190">Close</span><span class="op" id="6353195">(</span><span class="op" id="6353196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353199">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353202">dc</span><span class="op" id="6353204">.</span><span class="ident" id="6353205">openStmt</span>&nbsp;<span class="op" id="6353214">=</span>&nbsp;<span class="builtintype" id="6353216">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353222">err</span>&nbsp;<span class="op" id="6353226">:=</span>&nbsp;<span class="ident" id="6353229">dc</span><span class="op" id="6353231">.</span><span class="ident" id="6353232">ci</span><span class="op" id="6353234">.</span><span class="ident" id="6353235">Close</span><span class="op" id="6353240">(</span><span class="op" id="6353241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353244">dc</span><span class="op" id="6353246">.</span><span class="ident" id="6353247">ci</span>&nbsp;<span class="op" id="6353250">=</span>&nbsp;<span class="builtintype" id="6353252">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353257">dc</span><span class="op" id="6353259">.</span><span class="ident" id="6353260">finalClosed</span>&nbsp;<span class="op" id="6353272">=</span>&nbsp;<span class="builtintype" id="6353274">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353280">dc</span><span class="op" id="6353282">.</span><span class="ident" id="6353283">Unlock</span><span class="op" id="6353289">(</span><span class="op" id="6353290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353294">dc</span><span class="op" id="6353296">.</span><span class="ident" id="6353297">db</span><span class="op" id="6353299">.</span><span class="ident" id="6353300">mu</span><span class="op" id="6353302">.</span><span class="ident" id="6353303">Lock</span><span class="op" id="6353307">(</span><span class="op" id="6353308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353311">dc</span><span class="op" id="6353313">.</span><span class="ident" id="6353314">db</span><span class="op" id="6353316">.</span><span class="ident" id="6353317">numOpen</span><span class="op" id="6353324">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353328">dc</span><span class="op" id="6353330">.</span><span class="ident" id="6353331">db</span><span class="op" id="6353333">.</span><span class="ident" id="6353334">maybeOpenNewConnections</span><span class="op" id="6353357">(</span><span class="op" id="6353358">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353361">dc</span><span class="op" id="6353363">.</span><span class="ident" id="6353364">db</span><span class="op" id="6353366">.</span><span class="ident" id="6353367">mu</span><span class="op" id="6353369">.</span><span class="ident" id="6353370">Unlock</span><span class="op" id="6353376">(</span><span class="op" id="6353377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353381">return</span>&nbsp;<span class="ident" id="6353388">err</span><br>
<span class="lineno"></span><span class="op" id="6353392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="6353395">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6353443">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6353510">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="6353532">type</span>&nbsp;<span class="ident" id="6353537">driverStmt</span>&nbsp;<span class="keyword" id="6353548">struct</span>&nbsp;<span class="op" id="6353555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353558">sync</span><span class="op" id="6353562">.</span><span class="ident" id="6353563">Locker</span>&nbsp;<span class="comment" id="6353570">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353590">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353602">driver</span><span class="op" id="6353608">.</span><span class="ident" id="6353609">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6353614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6353617">func</span>&nbsp;<span class="op" id="6353622">(</span><span class="ident" id="6353623">ds</span>&nbsp;<span class="op" id="6353626">*</span><span class="ident" id="6353627">driverStmt</span><span class="op" id="6353637">)</span>&nbsp;<span class="ident" id="6353639">Close</span><span class="op" id="6353644">(</span><span class="op" id="6353645">)</span>&nbsp;<span class="builtintype" id="6353647">error</span>&nbsp;<span class="op" id="6353653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353656">ds</span><span class="op" id="6353658">.</span><span class="ident" id="6353659">Lock</span><span class="op" id="6353663">(</span><span class="op" id="6353664">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353667">defer</span>&nbsp;<span class="ident" id="6353673">ds</span><span class="op" id="6353675">.</span><span class="ident" id="6353676">Unlock</span><span class="op" id="6353682">(</span><span class="op" id="6353683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353686">return</span>&nbsp;<span class="ident" id="6353693">ds</span><span class="op" id="6353695">.</span><span class="ident" id="6353696">si</span><span class="op" id="6353698">.</span><span class="ident" id="6353699">Close</span><span class="op" id="6353704">(</span><span class="op" id="6353705">)</span><br>
<span class="lineno"></span><span class="op" id="6353707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6353710">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="6353764">type</span>&nbsp;<span class="ident" id="6353769">depSet</span>&nbsp;<span class="keyword" id="6353776">map</span><span class="op" id="6353779">[</span><span class="keyword" id="6353780">interface</span><span class="op" id="6353789">{</span><span class="op" id="6353790">}</span><span class="op" id="6353791">]</span><span class="builtintype" id="6353792">bool</span>&nbsp;<span class="comment" id="6353797">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6353819">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="6353884">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="6353918">type</span>&nbsp;<span class="ident" id="6353923">finalCloser</span>&nbsp;<span class="keyword" id="6353935">interface</span>&nbsp;<span class="op" id="6353945">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353948">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354011">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354068">finalClose</span><span class="op" id="6354078">(</span><span class="op" id="6354079">)</span>&nbsp;<span class="builtintype" id="6354081">error</span><br>
<span class="lineno"></span><span class="op" id="6354087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="6354090">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6354161">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="6354229">func</span>&nbsp;<span class="op" id="6354234">(</span><span class="ident" id="6354235">db</span>&nbsp;<span class="op" id="6354238">*</span><span class="ident" id="6354239">DB</span><span class="op" id="6354241">)</span>&nbsp;<span class="ident" id="6354243">addDep</span><span class="op" id="6354249">(</span><span class="ident" id="6354250">x</span>&nbsp;<span class="ident" id="6354252">finalCloser</span><span class="op" id="6354263">,</span>&nbsp;<span class="ident" id="6354265">dep</span>&nbsp;<span class="keyword" id="6354269">interface</span><span class="op" id="6354278">{</span><span class="op" id="6354279">}</span><span class="op" id="6354280">)</span>&nbsp;<span class="op" id="6354282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6354285">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354349">db</span><span class="op" id="6354351">.</span><span class="ident" id="6354352">mu</span><span class="op" id="6354354">.</span><span class="ident" id="6354355">Lock</span><span class="op" id="6354359">(</span><span class="op" id="6354360">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354363">defer</span>&nbsp;<span class="ident" id="6354369">db</span><span class="op" id="6354371">.</span><span class="ident" id="6354372">mu</span><span class="op" id="6354374">.</span><span class="ident" id="6354375">Unlock</span><span class="op" id="6354381">(</span><span class="op" id="6354382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354385">db</span><span class="op" id="6354387">.</span><span class="ident" id="6354388">addDepLocked</span><span class="op" id="6354400">(</span><span class="ident" id="6354401">x</span><span class="op" id="6354402">,</span>&nbsp;<span class="ident" id="6354404">dep</span><span class="op" id="6354407">)</span><br>
<span class="lineno"></span><span class="op" id="6354409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6354412">func</span>&nbsp;<span class="op" id="6354417">(</span><span class="ident" id="6354418">db</span>&nbsp;<span class="op" id="6354421">*</span><span class="ident" id="6354422">DB</span><span class="op" id="6354424">)</span>&nbsp;<span class="ident" id="6354426">addDepLocked</span><span class="op" id="6354438">(</span><span class="ident" id="6354439">x</span>&nbsp;<span class="ident" id="6354441">finalCloser</span><span class="op" id="6354452">,</span>&nbsp;<span class="ident" id="6354454">dep</span>&nbsp;<span class="keyword" id="6354458">interface</span><span class="op" id="6354467">{</span><span class="op" id="6354468">}</span><span class="op" id="6354469">)</span>&nbsp;<span class="op" id="6354471">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354474">if</span>&nbsp;<span class="ident" id="6354477">db</span><span class="op" id="6354479">.</span><span class="ident" id="6354480">dep</span>&nbsp;<span class="op" id="6354484">==</span>&nbsp;<span class="builtintype" id="6354487">nil</span>&nbsp;<span class="op" id="6354491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354495">db</span><span class="op" id="6354497">.</span><span class="ident" id="6354498">dep</span>&nbsp;<span class="op" id="6354502">=</span>&nbsp;<span class="builtinfunc" id="6354504">make</span><span class="op" id="6354508">(</span><span class="keyword" id="6354509">map</span><span class="op" id="6354512">[</span><span class="ident" id="6354513">finalCloser</span><span class="op" id="6354524">]</span><span class="ident" id="6354525">depSet</span><span class="op" id="6354531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354537">xdep</span>&nbsp;<span class="op" id="6354542">:=</span>&nbsp;<span class="ident" id="6354545">db</span><span class="op" id="6354547">.</span><span class="ident" id="6354548">dep</span><span class="op" id="6354551">[</span><span class="ident" id="6354552">x</span><span class="op" id="6354553">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354556">if</span>&nbsp;<span class="ident" id="6354559">xdep</span>&nbsp;<span class="op" id="6354564">==</span>&nbsp;<span class="builtintype" id="6354567">nil</span>&nbsp;<span class="op" id="6354571">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354575">xdep</span>&nbsp;<span class="op" id="6354580">=</span>&nbsp;<span class="builtinfunc" id="6354582">make</span><span class="op" id="6354586">(</span><span class="ident" id="6354587">depSet</span><span class="op" id="6354593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354597">db</span><span class="op" id="6354599">.</span><span class="ident" id="6354600">dep</span><span class="op" id="6354603">[</span><span class="ident" id="6354604">x</span><span class="op" id="6354605">]</span>&nbsp;<span class="op" id="6354607">=</span>&nbsp;<span class="ident" id="6354609">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6354615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354618">xdep</span><span class="op" id="6354622">[</span><span class="ident" id="6354623">dep</span><span class="op" id="6354626">]</span>&nbsp;<span class="op" id="6354628">=</span>&nbsp;<span class="builtintype" id="6354630">true</span><br>
<span class="lineno"></span><span class="op" id="6354635">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6354638">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="6354690">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="6354739">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6354809">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="6354857">func</span>&nbsp;<span class="op" id="6354862">(</span><span class="ident" id="6354863">db</span>&nbsp;<span class="op" id="6354866">*</span><span class="ident" id="6354867">DB</span><span class="op" id="6354869">)</span>&nbsp;<span class="ident" id="6354871">removeDep</span><span class="op" id="6354880">(</span><span class="ident" id="6354881">x</span>&nbsp;<span class="ident" id="6354883">finalCloser</span><span class="op" id="6354894">,</span>&nbsp;<span class="ident" id="6354896">dep</span>&nbsp;<span class="keyword" id="6354900">interface</span><span class="op" id="6354909">{</span><span class="op" id="6354910">}</span><span class="op" id="6354911">)</span>&nbsp;<span class="builtintype" id="6354913">error</span>&nbsp;<span class="op" id="6354919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354922">db</span><span class="op" id="6354924">.</span><span class="ident" id="6354925">mu</span><span class="op" id="6354927">.</span><span class="ident" id="6354928">Lock</span><span class="op" id="6354932">(</span><span class="op" id="6354933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354936">fn</span>&nbsp;<span class="op" id="6354939">:=</span>&nbsp;<span class="ident" id="6354942">db</span><span class="op" id="6354944">.</span><span class="ident" id="6354945">removeDepLocked</span><span class="op" id="6354960">(</span><span class="ident" id="6354961">x</span><span class="op" id="6354962">,</span>&nbsp;<span class="ident" id="6354964">dep</span><span class="op" id="6354967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6354970">db</span><span class="op" id="6354972">.</span><span class="ident" id="6354973">mu</span><span class="op" id="6354975">.</span><span class="ident" id="6354976">Unlock</span><span class="op" id="6354982">(</span><span class="op" id="6354983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6354986">return</span>&nbsp;<span class="ident" id="6354993">fn</span><span class="op" id="6354995">(</span><span class="op" id="6354996">)</span><br>
<span class="lineno">390</span><span class="op" id="6354998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6355001">func</span>&nbsp;<span class="op" id="6355006">(</span><span class="ident" id="6355007">db</span>&nbsp;<span class="op" id="6355010">*</span><span class="ident" id="6355011">DB</span><span class="op" id="6355013">)</span>&nbsp;<span class="ident" id="6355015">removeDepLocked</span><span class="op" id="6355030">(</span><span class="ident" id="6355031">x</span>&nbsp;<span class="ident" id="6355033">finalCloser</span><span class="op" id="6355044">,</span>&nbsp;<span class="ident" id="6355046">dep</span>&nbsp;<span class="keyword" id="6355050">interface</span><span class="op" id="6355059">{</span><span class="op" id="6355060">}</span><span class="op" id="6355061">)</span>&nbsp;<span class="keyword" id="6355063">func</span><span class="op" id="6355067">(</span><span class="op" id="6355068">)</span>&nbsp;<span class="builtintype" id="6355070">error</span>&nbsp;<span class="op" id="6355076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355079">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355147">xdep</span><span class="op" id="6355151">,</span>&nbsp;<span class="ident" id="6355153">ok</span>&nbsp;<span class="op" id="6355156">:=</span>&nbsp;<span class="ident" id="6355159">db</span><span class="op" id="6355161">.</span><span class="ident" id="6355162">dep</span><span class="op" id="6355165">[</span><span class="ident" id="6355166">x</span><span class="op" id="6355167">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355170">if</span>&nbsp;<span class="op" id="6355173">!</span><span class="ident" id="6355174">ok</span>&nbsp;<span class="op" id="6355177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6355181">panic</span><span class="op" id="6355186">(</span><span class="ident" id="6355187">fmt</span><span class="op" id="6355190">.</span><span class="ident" id="6355191">Sprintf</span><span class="op" id="6355198">(</span><span class="string" id="6355199">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="6355235">,</span>&nbsp;<span class="ident" id="6355237">x</span><span class="op" id="6355238">)</span><span class="op" id="6355239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6355242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6355246">l0</span>&nbsp;<span class="op" id="6355249">:=</span>&nbsp;<span class="builtinfunc" id="6355252">len</span><span class="op" id="6355255">(</span><span class="ident" id="6355256">xdep</span><span class="op" id="6355260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6355263">delete</span><span class="op" id="6355269">(</span><span class="ident" id="6355270">xdep</span><span class="op" id="6355274">,</span>&nbsp;<span class="ident" id="6355276">dep</span><span class="op" id="6355279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355283">switch</span>&nbsp;<span class="builtinfunc" id="6355290">len</span><span class="op" id="6355293">(</span><span class="ident" id="6355294">xdep</span><span class="op" id="6355298">)</span>&nbsp;<span class="op" id="6355300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355303">case</span>&nbsp;<span class="ident" id="6355308">l0</span><span class="op" id="6355310">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355314">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6355354">panic</span><span class="op" id="6355359">(</span><span class="ident" id="6355360">fmt</span><span class="op" id="6355363">.</span><span class="ident" id="6355364">Sprintf</span><span class="op" id="6355371">(</span><span class="string" id="6355372">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="6355409">,</span>&nbsp;<span class="ident" id="6355411">dep</span><span class="op" id="6355414">,</span>&nbsp;<span class="ident" id="6355416">x</span><span class="op" id="6355417">)</span><span class="op" id="6355418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355421">case</span>&nbsp;<span class="num" id="6355426">0</span><span class="op" id="6355427">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355431">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6355458">delete</span><span class="op" id="6355464">(</span><span class="ident" id="6355465">db</span><span class="op" id="6355467">.</span><span class="ident" id="6355468">dep</span><span class="op" id="6355471">,</span>&nbsp;<span class="ident" id="6355473">x</span><span class="op" id="6355474">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355478">return</span>&nbsp;<span class="ident" id="6355485">x</span><span class="op" id="6355486">.</span><span class="ident" id="6355487">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355499">default</span><span class="op" id="6355506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6355510">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6355536">return</span>&nbsp;<span class="keyword" id="6355543">func</span><span class="op" id="6355547">(</span><span class="op" id="6355548">)</span>&nbsp;<span class="builtintype" id="6355550">error</span>&nbsp;<span class="op" id="6355556">{</span>&nbsp;<span class="keyword" id="6355558">return</span>&nbsp;<span class="builtintype" id="6355565">nil</span>&nbsp;<span class="op" id="6355569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6355572">}</span><br>
<span class="lineno">415</span><span class="op" id="6355574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6355577">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="6355649">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6355711">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="6355775">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="6355852">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6355928">var</span>&nbsp;<span class="ident" id="6355932">connectionRequestQueueSize</span>&nbsp;<span class="op" id="6355959">=</span>&nbsp;<span class="num" id="6355961">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6355970">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="6356039">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6356109">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="6356154">//</span><br>
<span class="lineno"></span><span class="comment" id="6356157">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6356225">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="6356297">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6356367">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="6356401">//</span><br>
<span class="lineno"></span><span class="comment" id="6356404">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6356474">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="6356545">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="6356554">//</span><br>
<span class="lineno"></span><span class="comment" id="6356557">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="6356626">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="6356692">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="6356758">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="6356773">func</span>&nbsp;<span class="ident" id="6356778">Open</span><span class="op" id="6356782">(</span><span class="ident" id="6356783">driverName</span><span class="op" id="6356793">,</span>&nbsp;<span class="ident" id="6356795">dataSourceName</span>&nbsp;<span class="builtintype" id="6356810">string</span><span class="op" id="6356816">)</span>&nbsp;<span class="op" id="6356818">(</span><span class="op" id="6356819">*</span><span class="ident" id="6356820">DB</span><span class="op" id="6356822">,</span>&nbsp;<span class="builtintype" id="6356824">error</span><span class="op" id="6356829">)</span>&nbsp;<span class="op" id="6356831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356834">driveri</span><span class="op" id="6356841">,</span>&nbsp;<span class="ident" id="6356843">ok</span>&nbsp;<span class="op" id="6356846">:=</span>&nbsp;<span class="ident" id="6356849">drivers</span><span class="op" id="6356856">[</span><span class="ident" id="6356857">driverName</span><span class="op" id="6356867">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356870">if</span>&nbsp;<span class="op" id="6356873">!</span><span class="ident" id="6356874">ok</span>&nbsp;<span class="op" id="6356877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6356881">return</span>&nbsp;<span class="builtintype" id="6356888">nil</span><span class="op" id="6356891">,</span>&nbsp;<span class="ident" id="6356893">fmt</span><span class="op" id="6356896">.</span><span class="ident" id="6356897">Errorf</span><span class="op" id="6356903">(</span><span class="string" id="6356904">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="6356948">,</span>&nbsp;<span class="ident" id="6356950">driverName</span><span class="op" id="6356960">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6356963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356966">db</span>&nbsp;<span class="op" id="6356969">:=</span>&nbsp;<span class="op" id="6356972">&amp;</span><span class="ident" id="6356973">DB</span><span class="op" id="6356975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6356979">driver</span><span class="op" id="6356985">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6356989">driveri</span><span class="op" id="6356996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357000">dsn</span><span class="op" id="6357003">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357010">dataSourceName</span><span class="op" id="6357024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357028">openerCh</span><span class="op" id="6357036">:</span>&nbsp;<span class="builtinfunc" id="6357038">make</span><span class="op" id="6357042">(</span><span class="keyword" id="6357043">chan</span>&nbsp;<span class="keyword" id="6357048">struct</span><span class="op" id="6357054">{</span><span class="op" id="6357055">}</span><span class="op" id="6357056">,</span>&nbsp;<span class="ident" id="6357058">connectionRequestQueueSize</span><span class="op" id="6357084">)</span><span class="op" id="6357085">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357089">lastPut</span><span class="op" id="6357096">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6357099">make</span><span class="op" id="6357103">(</span><span class="keyword" id="6357104">map</span><span class="op" id="6357107">[</span><span class="op" id="6357108">*</span><span class="ident" id="6357109">driverConn</span><span class="op" id="6357119">]</span><span class="builtintype" id="6357120">string</span><span class="op" id="6357126">)</span><span class="op" id="6357127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357133">go</span>&nbsp;<span class="ident" id="6357136">db</span><span class="op" id="6357138">.</span><span class="ident" id="6357139">connectionOpener</span><span class="op" id="6357155">(</span><span class="op" id="6357156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357159">return</span>&nbsp;<span class="ident" id="6357166">db</span><span class="op" id="6357168">,</span>&nbsp;<span class="builtintype" id="6357170">nil</span><br>
<span class="lineno"></span><span class="op" id="6357174">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="6357177">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="6357239">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="6357282">func</span>&nbsp;<span class="op" id="6357287">(</span><span class="ident" id="6357288">db</span>&nbsp;<span class="op" id="6357291">*</span><span class="ident" id="6357292">DB</span><span class="op" id="6357294">)</span>&nbsp;<span class="ident" id="6357296">Ping</span><span class="op" id="6357300">(</span><span class="op" id="6357301">)</span>&nbsp;<span class="builtintype" id="6357303">error</span>&nbsp;<span class="op" id="6357309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357312">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357375">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6357434">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357448">dc</span><span class="op" id="6357450">,</span>&nbsp;<span class="ident" id="6357452">err</span>&nbsp;<span class="op" id="6357456">:=</span>&nbsp;<span class="ident" id="6357459">db</span><span class="op" id="6357461">.</span><span class="ident" id="6357462">conn</span><span class="op" id="6357466">(</span><span class="op" id="6357467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357470">if</span>&nbsp;<span class="ident" id="6357473">err</span>&nbsp;<span class="op" id="6357477">!=</span>&nbsp;<span class="builtintype" id="6357480">nil</span>&nbsp;<span class="op" id="6357484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357488">return</span>&nbsp;<span class="ident" id="6357495">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357503">db</span><span class="op" id="6357505">.</span><span class="ident" id="6357506">putConn</span><span class="op" id="6357513">(</span><span class="ident" id="6357514">dc</span><span class="op" id="6357516">,</span>&nbsp;<span class="builtintype" id="6357518">nil</span><span class="op" id="6357521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357524">return</span>&nbsp;<span class="builtintype" id="6357531">nil</span><br>
<span class="lineno"></span><span class="op" id="6357535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="6357538">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="6357598">//</span><br>
<span class="lineno"></span><span class="comment" id="6357601">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6357662">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6357712">func</span>&nbsp;<span class="op" id="6357717">(</span><span class="ident" id="6357718">db</span>&nbsp;<span class="op" id="6357721">*</span><span class="ident" id="6357722">DB</span><span class="op" id="6357724">)</span>&nbsp;<span class="ident" id="6357726">Close</span><span class="op" id="6357731">(</span><span class="op" id="6357732">)</span>&nbsp;<span class="builtintype" id="6357734">error</span>&nbsp;<span class="op" id="6357740">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357743">db</span><span class="op" id="6357745">.</span><span class="ident" id="6357746">mu</span><span class="op" id="6357748">.</span><span class="ident" id="6357749">Lock</span><span class="op" id="6357753">(</span><span class="op" id="6357754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357757">if</span>&nbsp;<span class="ident" id="6357760">db</span><span class="op" id="6357762">.</span><span class="ident" id="6357763">closed</span>&nbsp;<span class="op" id="6357770">{</span>&nbsp;<span class="comment" id="6357772">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357802">db</span><span class="op" id="6357804">.</span><span class="ident" id="6357805">mu</span><span class="op" id="6357807">.</span><span class="ident" id="6357808">Unlock</span><span class="op" id="6357814">(</span><span class="op" id="6357815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357819">return</span>&nbsp;<span class="builtintype" id="6357826">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357831">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6357834">close</span><span class="op" id="6357839">(</span><span class="ident" id="6357840">db</span><span class="op" id="6357842">.</span><span class="ident" id="6357843">openerCh</span><span class="op" id="6357851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357854">var</span>&nbsp;<span class="ident" id="6357858">err</span>&nbsp;<span class="builtintype" id="6357862">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357869">fns</span>&nbsp;<span class="op" id="6357873">:=</span>&nbsp;<span class="builtinfunc" id="6357876">make</span><span class="op" id="6357880">(</span><span class="op" id="6357881">[</span><span class="op" id="6357882">]</span><span class="keyword" id="6357883">func</span><span class="op" id="6357887">(</span><span class="op" id="6357888">)</span>&nbsp;<span class="builtintype" id="6357890">error</span><span class="op" id="6357895">,</span>&nbsp;<span class="num" id="6357897">0</span><span class="op" id="6357898">,</span>&nbsp;<span class="builtinfunc" id="6357900">len</span><span class="op" id="6357903">(</span><span class="ident" id="6357904">db</span><span class="op" id="6357906">.</span><span class="ident" id="6357907">freeConn</span><span class="op" id="6357915">)</span><span class="op" id="6357916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6357919">for</span>&nbsp;<span class="ident" id="6357923">_</span><span class="op" id="6357924">,</span>&nbsp;<span class="ident" id="6357926">dc</span>&nbsp;<span class="op" id="6357929">:=</span>&nbsp;<span class="keyword" id="6357932">range</span>&nbsp;<span class="ident" id="6357938">db</span><span class="op" id="6357940">.</span><span class="ident" id="6357941">freeConn</span>&nbsp;<span class="op" id="6357950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357954">fns</span>&nbsp;<span class="op" id="6357958">=</span>&nbsp;<span class="builtinfunc" id="6357960">append</span><span class="op" id="6357966">(</span><span class="ident" id="6357967">fns</span><span class="op" id="6357970">,</span>&nbsp;<span class="ident" id="6357972">dc</span><span class="op" id="6357974">.</span><span class="ident" id="6357975">closeDBLocked</span><span class="op" id="6357988">(</span><span class="op" id="6357989">)</span><span class="op" id="6357990">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6357993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6357996">db</span><span class="op" id="6357998">.</span><span class="ident" id="6357999">freeConn</span>&nbsp;<span class="op" id="6358008">=</span>&nbsp;<span class="builtintype" id="6358010">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358015">db</span><span class="op" id="6358017">.</span><span class="ident" id="6358018">closed</span>&nbsp;<span class="op" id="6358025">=</span>&nbsp;<span class="builtintype" id="6358027">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358033">for</span>&nbsp;<span class="ident" id="6358037">_</span><span class="op" id="6358038">,</span>&nbsp;<span class="ident" id="6358040">req</span>&nbsp;<span class="op" id="6358044">:=</span>&nbsp;<span class="keyword" id="6358047">range</span>&nbsp;<span class="ident" id="6358053">db</span><span class="op" id="6358055">.</span><span class="ident" id="6358056">connRequests</span>&nbsp;<span class="op" id="6358069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6358073">close</span><span class="op" id="6358078">(</span><span class="ident" id="6358079">req</span><span class="op" id="6358082">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358088">db</span><span class="op" id="6358090">.</span><span class="ident" id="6358091">mu</span><span class="op" id="6358093">.</span><span class="ident" id="6358094">Unlock</span><span class="op" id="6358100">(</span><span class="op" id="6358101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358104">for</span>&nbsp;<span class="ident" id="6358108">_</span><span class="op" id="6358109">,</span>&nbsp;<span class="ident" id="6358111">fn</span>&nbsp;<span class="op" id="6358114">:=</span>&nbsp;<span class="keyword" id="6358117">range</span>&nbsp;<span class="ident" id="6358123">fns</span>&nbsp;<span class="op" id="6358127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358131">err1</span>&nbsp;<span class="op" id="6358136">:=</span>&nbsp;<span class="ident" id="6358139">fn</span><span class="op" id="6358141">(</span><span class="op" id="6358142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358146">if</span>&nbsp;<span class="ident" id="6358149">err1</span>&nbsp;<span class="op" id="6358154">!=</span>&nbsp;<span class="builtintype" id="6358157">nil</span>&nbsp;<span class="op" id="6358161">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358166">err</span>&nbsp;<span class="op" id="6358170">=</span>&nbsp;<span class="ident" id="6358172">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358185">return</span>&nbsp;<span class="ident" id="6358192">err</span><br>
<span class="lineno"></span><span class="op" id="6358196">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6358199">const</span>&nbsp;<span class="ident" id="6358205">defaultMaxIdleConns</span>&nbsp;<span class="op" id="6358225">=</span>&nbsp;<span class="num" id="6358227">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6358230">func</span>&nbsp;<span class="op" id="6358235">(</span><span class="ident" id="6358236">db</span>&nbsp;<span class="op" id="6358239">*</span><span class="ident" id="6358240">DB</span><span class="op" id="6358242">)</span>&nbsp;<span class="ident" id="6358244">maxIdleConnsLocked</span><span class="op" id="6358262">(</span><span class="op" id="6358263">)</span>&nbsp;<span class="builtintype" id="6358265">int</span>&nbsp;<span class="op" id="6358269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358272">n</span>&nbsp;<span class="op" id="6358274">:=</span>&nbsp;<span class="ident" id="6358277">db</span><span class="op" id="6358279">.</span><span class="ident" id="6358280">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358289">switch</span>&nbsp;<span class="op" id="6358296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358299">case</span>&nbsp;<span class="ident" id="6358304">n</span>&nbsp;<span class="op" id="6358306">==</span>&nbsp;<span class="num" id="6358309">0</span><span class="op" id="6358310">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358314">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358388">return</span>&nbsp;<span class="ident" id="6358395">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358416">case</span>&nbsp;<span class="ident" id="6358421">n</span>&nbsp;<span class="op" id="6358423">&lt;</span>&nbsp;<span class="num" id="6358425">0</span><span class="op" id="6358426">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358430">return</span>&nbsp;<span class="num" id="6358437">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358440">default</span><span class="op" id="6358447">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358451">return</span>&nbsp;<span class="ident" id="6358458">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358461">}</span><br>
<span class="lineno"></span><span class="op" id="6358463">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="6358466">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6358536">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="6358556">//</span><br>
<span class="lineno"></span><span class="comment" id="6358559">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="6358631">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6358708">//</span><br>
<span class="lineno"></span><span class="comment" id="6358711">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="6358759">func</span>&nbsp;<span class="op" id="6358764">(</span><span class="ident" id="6358765">db</span>&nbsp;<span class="op" id="6358768">*</span><span class="ident" id="6358769">DB</span><span class="op" id="6358771">)</span>&nbsp;<span class="ident" id="6358773">SetMaxIdleConns</span><span class="op" id="6358788">(</span><span class="ident" id="6358789">n</span>&nbsp;<span class="builtintype" id="6358791">int</span><span class="op" id="6358794">)</span>&nbsp;<span class="op" id="6358796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358799">db</span><span class="op" id="6358801">.</span><span class="ident" id="6358802">mu</span><span class="op" id="6358804">.</span><span class="ident" id="6358805">Lock</span><span class="op" id="6358809">(</span><span class="op" id="6358810">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358813">if</span>&nbsp;<span class="ident" id="6358816">n</span>&nbsp;<span class="op" id="6358818">&gt;</span>&nbsp;<span class="num" id="6358820">0</span>&nbsp;<span class="op" id="6358822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358826">db</span><span class="op" id="6358828">.</span><span class="ident" id="6358829">maxIdle</span>&nbsp;<span class="op" id="6358837">=</span>&nbsp;<span class="ident" id="6358839">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358842">}</span>&nbsp;<span class="keyword" id="6358844">else</span>&nbsp;<span class="op" id="6358849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358853">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6358879">db</span><span class="op" id="6358881">.</span><span class="ident" id="6358882">maxIdle</span>&nbsp;<span class="op" id="6358890">=</span>&nbsp;<span class="op" id="6358892">-</span><span class="num" id="6358893">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6358896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6358899">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6358944">if</span>&nbsp;<span class="ident" id="6358947">db</span><span class="op" id="6358949">.</span><span class="ident" id="6358950">maxOpen</span>&nbsp;<span class="op" id="6358958">&gt;</span>&nbsp;<span class="num" id="6358960">0</span>&nbsp;<span class="op" id="6358962">&amp;&amp;</span>&nbsp;<span class="ident" id="6358965">db</span><span class="op" id="6358967">.</span><span class="ident" id="6358968">maxIdleConnsLocked</span><span class="op" id="6358986">(</span><span class="op" id="6358987">)</span>&nbsp;<span class="op" id="6358989">&gt;</span>&nbsp;<span class="ident" id="6358991">db</span><span class="op" id="6358993">.</span><span class="ident" id="6358994">maxOpen</span>&nbsp;<span class="op" id="6359002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359006">db</span><span class="op" id="6359008">.</span><span class="ident" id="6359009">maxIdle</span>&nbsp;<span class="op" id="6359017">=</span>&nbsp;<span class="ident" id="6359019">db</span><span class="op" id="6359021">.</span><span class="ident" id="6359022">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359031">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359034">var</span>&nbsp;<span class="ident" id="6359038">closing</span>&nbsp;<span class="op" id="6359046">[</span><span class="op" id="6359047">]</span><span class="op" id="6359048">*</span><span class="ident" id="6359049">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359061">idleCount</span>&nbsp;<span class="op" id="6359071">:=</span>&nbsp;<span class="builtinfunc" id="6359074">len</span><span class="op" id="6359077">(</span><span class="ident" id="6359078">db</span><span class="op" id="6359080">.</span><span class="ident" id="6359081">freeConn</span><span class="op" id="6359089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359092">maxIdle</span>&nbsp;<span class="op" id="6359100">:=</span>&nbsp;<span class="ident" id="6359103">db</span><span class="op" id="6359105">.</span><span class="ident" id="6359106">maxIdleConnsLocked</span><span class="op" id="6359124">(</span><span class="op" id="6359125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359128">if</span>&nbsp;<span class="ident" id="6359131">idleCount</span>&nbsp;<span class="op" id="6359141">&gt;</span>&nbsp;<span class="ident" id="6359143">maxIdle</span>&nbsp;<span class="op" id="6359151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359155">closing</span>&nbsp;<span class="op" id="6359163">=</span>&nbsp;<span class="ident" id="6359165">db</span><span class="op" id="6359167">.</span><span class="ident" id="6359168">freeConn</span><span class="op" id="6359176">[</span><span class="ident" id="6359177">maxIdle</span><span class="op" id="6359184">:</span><span class="op" id="6359185">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359189">db</span><span class="op" id="6359191">.</span><span class="ident" id="6359192">freeConn</span>&nbsp;<span class="op" id="6359201">=</span>&nbsp;<span class="ident" id="6359203">db</span><span class="op" id="6359205">.</span><span class="ident" id="6359206">freeConn</span><span class="op" id="6359214">[</span><span class="op" id="6359215">:</span><span class="ident" id="6359216">maxIdle</span><span class="op" id="6359223">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359229">db</span><span class="op" id="6359231">.</span><span class="ident" id="6359232">mu</span><span class="op" id="6359234">.</span><span class="ident" id="6359235">Unlock</span><span class="op" id="6359241">(</span><span class="op" id="6359242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359245">for</span>&nbsp;<span class="ident" id="6359249">_</span><span class="op" id="6359250">,</span>&nbsp;<span class="ident" id="6359252">c</span>&nbsp;<span class="op" id="6359254">:=</span>&nbsp;<span class="keyword" id="6359257">range</span>&nbsp;<span class="ident" id="6359263">closing</span>&nbsp;<span class="op" id="6359271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359275">c</span><span class="op" id="6359276">.</span><span class="ident" id="6359277">Close</span><span class="op" id="6359282">(</span><span class="op" id="6359283">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359286">}</span><br>
<span class="lineno"></span><span class="op" id="6359288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6359291">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="6359371">//</span><br>
<span class="lineno">550</span><span class="comment" id="6359374">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="6359449">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6359517">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6359539">//</span><br>
<span class="lineno"></span><span class="comment" id="6359542">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="6359614">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="6359647">func</span>&nbsp;<span class="op" id="6359652">(</span><span class="ident" id="6359653">db</span>&nbsp;<span class="op" id="6359656">*</span><span class="ident" id="6359657">DB</span><span class="op" id="6359659">)</span>&nbsp;<span class="ident" id="6359661">SetMaxOpenConns</span><span class="op" id="6359676">(</span><span class="ident" id="6359677">n</span>&nbsp;<span class="builtintype" id="6359679">int</span><span class="op" id="6359682">)</span>&nbsp;<span class="op" id="6359684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359687">db</span><span class="op" id="6359689">.</span><span class="ident" id="6359690">mu</span><span class="op" id="6359692">.</span><span class="ident" id="6359693">Lock</span><span class="op" id="6359697">(</span><span class="op" id="6359698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359701">db</span><span class="op" id="6359703">.</span><span class="ident" id="6359704">maxOpen</span>&nbsp;<span class="op" id="6359712">=</span>&nbsp;<span class="ident" id="6359714">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359717">if</span>&nbsp;<span class="ident" id="6359720">n</span>&nbsp;<span class="op" id="6359722">&lt;</span>&nbsp;<span class="num" id="6359724">0</span>&nbsp;<span class="op" id="6359726">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359730">db</span><span class="op" id="6359732">.</span><span class="ident" id="6359733">maxOpen</span>&nbsp;<span class="op" id="6359741">=</span>&nbsp;<span class="num" id="6359743">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359749">syncMaxIdle</span>&nbsp;<span class="op" id="6359761">:=</span>&nbsp;<span class="ident" id="6359764">db</span><span class="op" id="6359766">.</span><span class="ident" id="6359767">maxOpen</span>&nbsp;<span class="op" id="6359775">&gt;</span>&nbsp;<span class="num" id="6359777">0</span>&nbsp;<span class="op" id="6359779">&amp;&amp;</span>&nbsp;<span class="ident" id="6359782">db</span><span class="op" id="6359784">.</span><span class="ident" id="6359785">maxIdleConnsLocked</span><span class="op" id="6359803">(</span><span class="op" id="6359804">)</span>&nbsp;<span class="op" id="6359806">&gt;</span>&nbsp;<span class="ident" id="6359808">db</span><span class="op" id="6359810">.</span><span class="ident" id="6359811">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359820">db</span><span class="op" id="6359822">.</span><span class="ident" id="6359823">mu</span><span class="op" id="6359825">.</span><span class="ident" id="6359826">Unlock</span><span class="op" id="6359832">(</span><span class="op" id="6359833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6359836">if</span>&nbsp;<span class="ident" id="6359839">syncMaxIdle</span>&nbsp;<span class="op" id="6359851">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6359855">db</span><span class="op" id="6359857">.</span><span class="ident" id="6359858">SetMaxIdleConns</span><span class="op" id="6359873">(</span><span class="ident" id="6359874">n</span><span class="op" id="6359875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6359878">}</span><br>
<span class="lineno"></span><span class="op" id="6359880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6359883">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="6359911">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="6359986">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="6360045">func</span>&nbsp;<span class="op" id="6360050">(</span><span class="ident" id="6360051">db</span>&nbsp;<span class="op" id="6360054">*</span><span class="ident" id="6360055">DB</span><span class="op" id="6360057">)</span>&nbsp;<span class="ident" id="6360059">maybeOpenNewConnections</span><span class="op" id="6360082">(</span><span class="op" id="6360083">)</span>&nbsp;<span class="op" id="6360085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360088">numRequests</span>&nbsp;<span class="op" id="6360100">:=</span>&nbsp;<span class="builtinfunc" id="6360103">len</span><span class="op" id="6360106">(</span><span class="ident" id="6360107">db</span><span class="op" id="6360109">.</span><span class="ident" id="6360110">connRequests</span><span class="op" id="6360122">)</span>&nbsp;<span class="op" id="6360124">-</span>&nbsp;<span class="ident" id="6360126">db</span><span class="op" id="6360128">.</span><span class="ident" id="6360129">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360143">if</span>&nbsp;<span class="ident" id="6360146">db</span><span class="op" id="6360148">.</span><span class="ident" id="6360149">maxOpen</span>&nbsp;<span class="op" id="6360157">&gt;</span>&nbsp;<span class="num" id="6360159">0</span>&nbsp;<span class="op" id="6360161">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360165">numCanOpen</span>&nbsp;<span class="op" id="6360176">:=</span>&nbsp;<span class="ident" id="6360179">db</span><span class="op" id="6360181">.</span><span class="ident" id="6360182">maxOpen</span>&nbsp;<span class="op" id="6360190">-</span>&nbsp;<span class="op" id="6360192">(</span><span class="ident" id="6360193">db</span><span class="op" id="6360195">.</span><span class="ident" id="6360196">numOpen</span>&nbsp;<span class="op" id="6360204">+</span>&nbsp;<span class="ident" id="6360206">db</span><span class="op" id="6360208">.</span><span class="ident" id="6360209">pendingOpens</span><span class="op" id="6360221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360225">if</span>&nbsp;<span class="ident" id="6360228">numRequests</span>&nbsp;<span class="op" id="6360240">&gt;</span>&nbsp;<span class="ident" id="6360242">numCanOpen</span>&nbsp;<span class="op" id="6360253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360258">numRequests</span>&nbsp;<span class="op" id="6360270">=</span>&nbsp;<span class="ident" id="6360272">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360288">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360291">for</span>&nbsp;<span class="ident" id="6360295">numRequests</span>&nbsp;<span class="op" id="6360307">&gt;</span>&nbsp;<span class="num" id="6360309">0</span>&nbsp;<span class="op" id="6360311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360315">db</span><span class="op" id="6360317">.</span><span class="ident" id="6360318">pendingOpens</span><span class="op" id="6360330">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360335">numRequests</span><span class="op" id="6360346">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360351">db</span><span class="op" id="6360353">.</span><span class="ident" id="6360354">openerCh</span>&nbsp;<span class="op" id="6360363">&lt;-</span>&nbsp;<span class="keyword" id="6360366">struct</span><span class="op" id="6360372">{</span><span class="op" id="6360373">}</span><span class="op" id="6360374">{</span><span class="op" id="6360375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360378">}</span><br>
<span class="lineno">585</span><span class="op" id="6360380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360383">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="6360454">func</span>&nbsp;<span class="op" id="6360459">(</span><span class="ident" id="6360460">db</span>&nbsp;<span class="op" id="6360463">*</span><span class="ident" id="6360464">DB</span><span class="op" id="6360466">)</span>&nbsp;<span class="ident" id="6360468">connectionOpener</span><span class="op" id="6360484">(</span><span class="op" id="6360485">)</span>&nbsp;<span class="op" id="6360487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360490">for</span>&nbsp;<span class="keyword" id="6360494">range</span>&nbsp;<span class="ident" id="6360500">db</span><span class="op" id="6360502">.</span><span class="ident" id="6360503">openerCh</span>&nbsp;<span class="op" id="6360512">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360516">db</span><span class="op" id="6360518">.</span><span class="ident" id="6360519">openNewConnection</span><span class="op" id="6360536">(</span><span class="op" id="6360537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360540">}</span><br>
<span class="lineno"></span><span class="op" id="6360542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360545">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="6360572">func</span>&nbsp;<span class="op" id="6360577">(</span><span class="ident" id="6360578">db</span>&nbsp;<span class="op" id="6360581">*</span><span class="ident" id="6360582">DB</span><span class="op" id="6360584">)</span>&nbsp;<span class="ident" id="6360586">openNewConnection</span><span class="op" id="6360603">(</span><span class="op" id="6360604">)</span>&nbsp;<span class="op" id="6360606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360609">ci</span><span class="op" id="6360611">,</span>&nbsp;<span class="ident" id="6360613">err</span>&nbsp;<span class="op" id="6360617">:=</span>&nbsp;<span class="ident" id="6360620">db</span><span class="op" id="6360622">.</span><span class="ident" id="6360623">driver</span><span class="op" id="6360629">.</span><span class="ident" id="6360630">Open</span><span class="op" id="6360634">(</span><span class="ident" id="6360635">db</span><span class="op" id="6360637">.</span><span class="ident" id="6360638">dsn</span><span class="op" id="6360641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360644">db</span><span class="op" id="6360646">.</span><span class="ident" id="6360647">mu</span><span class="op" id="6360649">.</span><span class="ident" id="6360650">Lock</span><span class="op" id="6360654">(</span><span class="op" id="6360655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360658">defer</span>&nbsp;<span class="ident" id="6360664">db</span><span class="op" id="6360666">.</span><span class="ident" id="6360667">mu</span><span class="op" id="6360669">.</span><span class="ident" id="6360670">Unlock</span><span class="op" id="6360676">(</span><span class="op" id="6360677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360680">if</span>&nbsp;<span class="ident" id="6360683">db</span><span class="op" id="6360685">.</span><span class="ident" id="6360686">closed</span>&nbsp;<span class="op" id="6360693">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360697">if</span>&nbsp;<span class="ident" id="6360700">err</span>&nbsp;<span class="op" id="6360704">==</span>&nbsp;<span class="builtintype" id="6360707">nil</span>&nbsp;<span class="op" id="6360711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360716">ci</span><span class="op" id="6360718">.</span><span class="ident" id="6360719">Close</span><span class="op" id="6360724">(</span><span class="op" id="6360725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360733">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360741">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360744">db</span><span class="op" id="6360746">.</span><span class="ident" id="6360747">pendingOpens</span><span class="op" id="6360759">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360763">if</span>&nbsp;<span class="ident" id="6360766">err</span>&nbsp;<span class="op" id="6360770">!=</span>&nbsp;<span class="builtintype" id="6360773">nil</span>&nbsp;<span class="op" id="6360777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360781">db</span><span class="op" id="6360783">.</span><span class="ident" id="6360784">putConnDBLocked</span><span class="op" id="6360799">(</span><span class="builtintype" id="6360800">nil</span><span class="op" id="6360803">,</span>&nbsp;<span class="ident" id="6360805">err</span><span class="op" id="6360808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360812">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360820">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360823">dc</span>&nbsp;<span class="op" id="6360826">:=</span>&nbsp;<span class="op" id="6360829">&amp;</span><span class="ident" id="6360830">driverConn</span><span class="op" id="6360840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360844">db</span><span class="op" id="6360846">:</span>&nbsp;<span class="ident" id="6360848">db</span><span class="op" id="6360850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360854">ci</span><span class="op" id="6360856">:</span>&nbsp;<span class="ident" id="6360858">ci</span><span class="op" id="6360860">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6360866">if</span>&nbsp;<span class="ident" id="6360869">db</span><span class="op" id="6360871">.</span><span class="ident" id="6360872">putConnDBLocked</span><span class="op" id="6360887">(</span><span class="ident" id="6360888">dc</span><span class="op" id="6360890">,</span>&nbsp;<span class="ident" id="6360892">err</span><span class="op" id="6360895">)</span>&nbsp;<span class="op" id="6360897">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360901">db</span><span class="op" id="6360903">.</span><span class="ident" id="6360904">addDepLocked</span><span class="op" id="6360916">(</span><span class="ident" id="6360917">dc</span><span class="op" id="6360919">,</span>&nbsp;<span class="ident" id="6360921">dc</span><span class="op" id="6360923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360927">db</span><span class="op" id="6360929">.</span><span class="ident" id="6360930">numOpen</span><span class="op" id="6360937">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360941">}</span>&nbsp;<span class="keyword" id="6360943">else</span>&nbsp;<span class="op" id="6360948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6360952">ci</span><span class="op" id="6360954">.</span><span class="ident" id="6360955">Close</span><span class="op" id="6360960">(</span><span class="op" id="6360961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360964">}</span><br>
<span class="lineno">620</span><span class="op" id="6360966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360969">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6361028">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="6361097">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="6361158">type</span>&nbsp;<span class="ident" id="6361163">connRequest</span>&nbsp;<span class="keyword" id="6361175">struct</span>&nbsp;<span class="op" id="6361182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361185">conn</span>&nbsp;<span class="op" id="6361190">*</span><span class="ident" id="6361191">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361203">err</span>&nbsp;&nbsp;<span class="builtintype" id="6361208">error</span><br>
<span class="lineno"></span><span class="op" id="6361214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="6361217">var</span>&nbsp;<span class="ident" id="6361221">errDBClosed</span>&nbsp;<span class="op" id="6361233">=</span>&nbsp;<span class="ident" id="6361235">errors</span><span class="op" id="6361241">.</span><span class="ident" id="6361242">New</span><span class="op" id="6361245">(</span><span class="string" id="6361246">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6361271">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6361274">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="6361327">func</span>&nbsp;<span class="op" id="6361332">(</span><span class="ident" id="6361333">db</span>&nbsp;<span class="op" id="6361336">*</span><span class="ident" id="6361337">DB</span><span class="op" id="6361339">)</span>&nbsp;<span class="ident" id="6361341">conn</span><span class="op" id="6361345">(</span><span class="op" id="6361346">)</span>&nbsp;<span class="op" id="6361348">(</span><span class="op" id="6361349">*</span><span class="ident" id="6361350">driverConn</span><span class="op" id="6361360">,</span>&nbsp;<span class="builtintype" id="6361362">error</span><span class="op" id="6361367">)</span>&nbsp;<span class="op" id="6361369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361372">db</span><span class="op" id="6361374">.</span><span class="ident" id="6361375">mu</span><span class="op" id="6361377">.</span><span class="ident" id="6361378">Lock</span><span class="op" id="6361382">(</span><span class="op" id="6361383">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361386">if</span>&nbsp;<span class="ident" id="6361389">db</span><span class="op" id="6361391">.</span><span class="ident" id="6361392">closed</span>&nbsp;<span class="op" id="6361399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361403">db</span><span class="op" id="6361405">.</span><span class="ident" id="6361406">mu</span><span class="op" id="6361408">.</span><span class="ident" id="6361409">Unlock</span><span class="op" id="6361415">(</span><span class="op" id="6361416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361420">return</span>&nbsp;<span class="builtintype" id="6361427">nil</span><span class="op" id="6361430">,</span>&nbsp;<span class="ident" id="6361432">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6361445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361449">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361524">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361587">if</span>&nbsp;<span class="ident" id="6361590">db</span><span class="op" id="6361592">.</span><span class="ident" id="6361593">maxOpen</span>&nbsp;<span class="op" id="6361601">&gt;</span>&nbsp;<span class="num" id="6361603">0</span>&nbsp;<span class="op" id="6361605">&amp;&amp;</span>&nbsp;<span class="ident" id="6361608">db</span><span class="op" id="6361610">.</span><span class="ident" id="6361611">numOpen</span>&nbsp;<span class="op" id="6361619">&gt;=</span>&nbsp;<span class="ident" id="6361622">db</span><span class="op" id="6361624">.</span><span class="ident" id="6361625">maxOpen</span>&nbsp;<span class="op" id="6361633">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6361636">len</span><span class="op" id="6361639">(</span><span class="ident" id="6361640">db</span><span class="op" id="6361642">.</span><span class="ident" id="6361643">freeConn</span><span class="op" id="6361651">)</span>&nbsp;<span class="op" id="6361653">==</span>&nbsp;<span class="num" id="6361656">0</span>&nbsp;<span class="op" id="6361658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361662">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6361723">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361797">req</span>&nbsp;<span class="op" id="6361801">:=</span>&nbsp;<span class="builtinfunc" id="6361804">make</span><span class="op" id="6361808">(</span><span class="keyword" id="6361809">chan</span>&nbsp;<span class="ident" id="6361814">connRequest</span><span class="op" id="6361825">,</span>&nbsp;<span class="num" id="6361827">1</span><span class="op" id="6361828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361832">db</span><span class="op" id="6361834">.</span><span class="ident" id="6361835">connRequests</span>&nbsp;<span class="op" id="6361848">=</span>&nbsp;<span class="builtinfunc" id="6361850">append</span><span class="op" id="6361856">(</span><span class="ident" id="6361857">db</span><span class="op" id="6361859">.</span><span class="ident" id="6361860">connRequests</span><span class="op" id="6361872">,</span>&nbsp;<span class="ident" id="6361874">req</span><span class="op" id="6361877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361881">db</span><span class="op" id="6361883">.</span><span class="ident" id="6361884">maybeOpenNewConnections</span><span class="op" id="6361907">(</span><span class="op" id="6361908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361912">db</span><span class="op" id="6361914">.</span><span class="ident" id="6361915">mu</span><span class="op" id="6361917">.</span><span class="ident" id="6361918">Unlock</span><span class="op" id="6361924">(</span><span class="op" id="6361925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6361929">ret</span>&nbsp;<span class="op" id="6361933">:=</span>&nbsp;<span class="op" id="6361936">&lt;-</span><span class="ident" id="6361938">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361944">return</span>&nbsp;<span class="ident" id="6361951">ret</span><span class="op" id="6361954">.</span><span class="ident" id="6361955">conn</span><span class="op" id="6361959">,</span>&nbsp;<span class="ident" id="6361961">ret</span><span class="op" id="6361964">.</span><span class="ident" id="6361965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6361970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6361974">if</span>&nbsp;<span class="ident" id="6361977">c</span>&nbsp;<span class="op" id="6361979">:=</span>&nbsp;<span class="builtinfunc" id="6361982">len</span><span class="op" id="6361985">(</span><span class="ident" id="6361986">db</span><span class="op" id="6361988">.</span><span class="ident" id="6361989">freeConn</span><span class="op" id="6361997">)</span><span class="op" id="6361998">;</span>&nbsp;<span class="ident" id="6362000">c</span>&nbsp;<span class="op" id="6362002">&gt;</span>&nbsp;<span class="num" id="6362004">0</span>&nbsp;<span class="op" id="6362006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362010">conn</span>&nbsp;<span class="op" id="6362015">:=</span>&nbsp;<span class="ident" id="6362018">db</span><span class="op" id="6362020">.</span><span class="ident" id="6362021">freeConn</span><span class="op" id="6362029">[</span><span class="num" id="6362030">0</span><span class="op" id="6362031">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6362035">copy</span><span class="op" id="6362039">(</span><span class="ident" id="6362040">db</span><span class="op" id="6362042">.</span><span class="ident" id="6362043">freeConn</span><span class="op" id="6362051">,</span>&nbsp;<span class="ident" id="6362053">db</span><span class="op" id="6362055">.</span><span class="ident" id="6362056">freeConn</span><span class="op" id="6362064">[</span><span class="num" id="6362065">1</span><span class="op" id="6362066">:</span><span class="op" id="6362067">]</span><span class="op" id="6362068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362072">db</span><span class="op" id="6362074">.</span><span class="ident" id="6362075">freeConn</span>&nbsp;<span class="op" id="6362084">=</span>&nbsp;<span class="ident" id="6362086">db</span><span class="op" id="6362088">.</span><span class="ident" id="6362089">freeConn</span><span class="op" id="6362097">[</span><span class="op" id="6362098">:</span><span class="ident" id="6362099">c</span><span class="op" id="6362100">-</span><span class="num" id="6362101">1</span><span class="op" id="6362102">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362106">conn</span><span class="op" id="6362110">.</span><span class="ident" id="6362111">inUse</span>&nbsp;<span class="op" id="6362117">=</span>&nbsp;<span class="builtintype" id="6362119">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362126">db</span><span class="op" id="6362128">.</span><span class="ident" id="6362129">mu</span><span class="op" id="6362131">.</span><span class="ident" id="6362132">Unlock</span><span class="op" id="6362138">(</span><span class="op" id="6362139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362143">return</span>&nbsp;<span class="ident" id="6362150">conn</span><span class="op" id="6362154">,</span>&nbsp;<span class="builtintype" id="6362156">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362165">db</span><span class="op" id="6362167">.</span><span class="ident" id="6362168">numOpen</span><span class="op" id="6362175">++</span>&nbsp;<span class="comment" id="6362178">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362197">db</span><span class="op" id="6362199">.</span><span class="ident" id="6362200">mu</span><span class="op" id="6362202">.</span><span class="ident" id="6362203">Unlock</span><span class="op" id="6362209">(</span><span class="op" id="6362210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362213">ci</span><span class="op" id="6362215">,</span>&nbsp;<span class="ident" id="6362217">err</span>&nbsp;<span class="op" id="6362221">:=</span>&nbsp;<span class="ident" id="6362224">db</span><span class="op" id="6362226">.</span><span class="ident" id="6362227">driver</span><span class="op" id="6362233">.</span><span class="ident" id="6362234">Open</span><span class="op" id="6362238">(</span><span class="ident" id="6362239">db</span><span class="op" id="6362241">.</span><span class="ident" id="6362242">dsn</span><span class="op" id="6362245">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362248">if</span>&nbsp;<span class="ident" id="6362251">err</span>&nbsp;<span class="op" id="6362255">!=</span>&nbsp;<span class="builtintype" id="6362258">nil</span>&nbsp;<span class="op" id="6362262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362266">db</span><span class="op" id="6362268">.</span><span class="ident" id="6362269">mu</span><span class="op" id="6362271">.</span><span class="ident" id="6362272">Lock</span><span class="op" id="6362276">(</span><span class="op" id="6362277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362281">db</span><span class="op" id="6362283">.</span><span class="ident" id="6362284">numOpen</span><span class="op" id="6362291">--</span>&nbsp;<span class="comment" id="6362294">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362328">db</span><span class="op" id="6362330">.</span><span class="ident" id="6362331">mu</span><span class="op" id="6362333">.</span><span class="ident" id="6362334">Unlock</span><span class="op" id="6362340">(</span><span class="op" id="6362341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362345">return</span>&nbsp;<span class="builtintype" id="6362352">nil</span><span class="op" id="6362355">,</span>&nbsp;<span class="ident" id="6362357">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362365">db</span><span class="op" id="6362367">.</span><span class="ident" id="6362368">mu</span><span class="op" id="6362370">.</span><span class="ident" id="6362371">Lock</span><span class="op" id="6362375">(</span><span class="op" id="6362376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362379">dc</span>&nbsp;<span class="op" id="6362382">:=</span>&nbsp;<span class="op" id="6362385">&amp;</span><span class="ident" id="6362386">driverConn</span><span class="op" id="6362396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362400">db</span><span class="op" id="6362402">:</span>&nbsp;<span class="ident" id="6362404">db</span><span class="op" id="6362406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362410">ci</span><span class="op" id="6362412">:</span>&nbsp;<span class="ident" id="6362414">ci</span><span class="op" id="6362416">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6362419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362422">db</span><span class="op" id="6362424">.</span><span class="ident" id="6362425">addDepLocked</span><span class="op" id="6362437">(</span><span class="ident" id="6362438">dc</span><span class="op" id="6362440">,</span>&nbsp;<span class="ident" id="6362442">dc</span><span class="op" id="6362444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362447">dc</span><span class="op" id="6362449">.</span><span class="ident" id="6362450">inUse</span>&nbsp;<span class="op" id="6362456">=</span>&nbsp;<span class="builtintype" id="6362458">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362464">db</span><span class="op" id="6362466">.</span><span class="ident" id="6362467">mu</span><span class="op" id="6362469">.</span><span class="ident" id="6362470">Unlock</span><span class="op" id="6362476">(</span><span class="op" id="6362477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6362480">return</span>&nbsp;<span class="ident" id="6362487">dc</span><span class="op" id="6362489">,</span>&nbsp;<span class="builtintype" id="6362491">nil</span><br>
<span class="lineno">680</span><span class="op" id="6362495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6362498">var</span>&nbsp;<span class="op" id="6362502">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362505">errConnClosed</span>&nbsp;<span class="op" id="6362519">=</span>&nbsp;<span class="ident" id="6362521">errors</span><span class="op" id="6362527">.</span><span class="ident" id="6362528">New</span><span class="op" id="6362531">(</span><span class="string" id="6362532">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6362587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362590">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6362604">=</span>&nbsp;<span class="ident" id="6362606">errors</span><span class="op" id="6362612">.</span><span class="ident" id="6362613">New</span><span class="op" id="6362616">(</span><span class="string" id="6362617">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="6362670">)</span><br>
<span class="lineno">685</span><span class="op" id="6362672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6362675">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6362747">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="6362764">//</span><br>
<span class="lineno">690</span><span class="comment" id="6362767">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6362843">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6362883">//</span><br>
<span class="lineno"></span><span class="comment" id="6362886">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="6362943">func</span>&nbsp;<span class="op" id="6362948">(</span><span class="ident" id="6362949">db</span>&nbsp;<span class="op" id="6362952">*</span><span class="ident" id="6362953">DB</span><span class="op" id="6362955">)</span>&nbsp;<span class="ident" id="6362957">connIfFree</span><span class="op" id="6362967">(</span><span class="ident" id="6362968">wanted</span>&nbsp;<span class="op" id="6362975">*</span><span class="ident" id="6362976">driverConn</span><span class="op" id="6362986">)</span>&nbsp;<span class="op" id="6362988">(</span><span class="op" id="6362989">*</span><span class="ident" id="6362990">driverConn</span><span class="op" id="6363000">,</span>&nbsp;<span class="builtintype" id="6363002">error</span><span class="op" id="6363007">)</span>&nbsp;<span class="op" id="6363009">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363012">db</span><span class="op" id="6363014">.</span><span class="ident" id="6363015">mu</span><span class="op" id="6363017">.</span><span class="ident" id="6363018">Lock</span><span class="op" id="6363022">(</span><span class="op" id="6363023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363026">defer</span>&nbsp;<span class="ident" id="6363032">db</span><span class="op" id="6363034">.</span><span class="ident" id="6363035">mu</span><span class="op" id="6363037">.</span><span class="ident" id="6363038">Unlock</span><span class="op" id="6363044">(</span><span class="op" id="6363045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363048">if</span>&nbsp;<span class="ident" id="6363051">wanted</span><span class="op" id="6363057">.</span><span class="ident" id="6363058">dbmuClosed</span>&nbsp;<span class="op" id="6363069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363073">return</span>&nbsp;<span class="builtintype" id="6363080">nil</span><span class="op" id="6363083">,</span>&nbsp;<span class="ident" id="6363085">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363100">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363103">if</span>&nbsp;<span class="ident" id="6363106">wanted</span><span class="op" id="6363112">.</span><span class="ident" id="6363113">inUse</span>&nbsp;<span class="op" id="6363119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363123">return</span>&nbsp;<span class="builtintype" id="6363130">nil</span><span class="op" id="6363133">,</span>&nbsp;<span class="ident" id="6363135">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363151">idx</span>&nbsp;<span class="op" id="6363155">:=</span>&nbsp;<span class="op" id="6363158">-</span><span class="num" id="6363159">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363162">for</span>&nbsp;<span class="ident" id="6363166">ii</span><span class="op" id="6363168">,</span>&nbsp;<span class="ident" id="6363170">v</span>&nbsp;<span class="op" id="6363172">:=</span>&nbsp;<span class="keyword" id="6363175">range</span>&nbsp;<span class="ident" id="6363181">db</span><span class="op" id="6363183">.</span><span class="ident" id="6363184">freeConn</span>&nbsp;<span class="op" id="6363193">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363197">if</span>&nbsp;<span class="ident" id="6363200">v</span>&nbsp;<span class="op" id="6363202">==</span>&nbsp;<span class="ident" id="6363205">wanted</span>&nbsp;<span class="op" id="6363212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363217">idx</span>&nbsp;<span class="op" id="6363221">=</span>&nbsp;<span class="ident" id="6363223">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363229">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363240">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363243">if</span>&nbsp;<span class="ident" id="6363246">idx</span>&nbsp;<span class="op" id="6363250">&gt;=</span>&nbsp;<span class="num" id="6363253">0</span>&nbsp;<span class="op" id="6363255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363259">db</span><span class="op" id="6363261">.</span><span class="ident" id="6363262">freeConn</span>&nbsp;<span class="op" id="6363271">=</span>&nbsp;<span class="builtinfunc" id="6363273">append</span><span class="op" id="6363279">(</span><span class="ident" id="6363280">db</span><span class="op" id="6363282">.</span><span class="ident" id="6363283">freeConn</span><span class="op" id="6363291">[</span><span class="op" id="6363292">:</span><span class="ident" id="6363293">idx</span><span class="op" id="6363296">]</span><span class="op" id="6363297">,</span>&nbsp;<span class="ident" id="6363299">db</span><span class="op" id="6363301">.</span><span class="ident" id="6363302">freeConn</span><span class="op" id="6363310">[</span><span class="ident" id="6363311">idx</span><span class="op" id="6363314">+</span><span class="num" id="6363315">1</span><span class="op" id="6363316">:</span><span class="op" id="6363317">]</span><span class="op" id="6363318">...</span><span class="op" id="6363321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363325">wanted</span><span class="op" id="6363331">.</span><span class="ident" id="6363332">inUse</span>&nbsp;<span class="op" id="6363338">=</span>&nbsp;<span class="builtintype" id="6363340">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363347">return</span>&nbsp;<span class="ident" id="6363354">wanted</span><span class="op" id="6363360">,</span>&nbsp;<span class="builtintype" id="6363362">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363367">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363370">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363440">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363517">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363586">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6363606">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6363652">return</span>&nbsp;<span class="builtintype" id="6363659">nil</span><span class="op" id="6363662">,</span>&nbsp;<span class="ident" id="6363664">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="6363676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6363679">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="6363717">var</span>&nbsp;<span class="ident" id="6363721">putConnHook</span>&nbsp;<span class="keyword" id="6363733">func</span><span class="op" id="6363737">(</span><span class="op" id="6363738">*</span><span class="ident" id="6363739">DB</span><span class="op" id="6363741">,</span>&nbsp;<span class="op" id="6363743">*</span><span class="ident" id="6363744">driverConn</span><span class="op" id="6363754">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="6363757">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="6363829">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6363901">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6363920">func</span>&nbsp;<span class="op" id="6363925">(</span><span class="ident" id="6363926">db</span>&nbsp;<span class="op" id="6363929">*</span><span class="ident" id="6363930">DB</span><span class="op" id="6363932">)</span>&nbsp;<span class="ident" id="6363934">noteUnusedDriverStatement</span><span class="op" id="6363959">(</span><span class="ident" id="6363960">c</span>&nbsp;<span class="op" id="6363962">*</span><span class="ident" id="6363963">driverConn</span><span class="op" id="6363973">,</span>&nbsp;<span class="ident" id="6363975">si</span>&nbsp;<span class="ident" id="6363978">driver</span><span class="op" id="6363984">.</span><span class="ident" id="6363985">Stmt</span><span class="op" id="6363989">)</span>&nbsp;<span class="op" id="6363991">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6363994">db</span><span class="op" id="6363996">.</span><span class="ident" id="6363997">mu</span><span class="op" id="6363999">.</span><span class="ident" id="6364000">Lock</span><span class="op" id="6364004">(</span><span class="op" id="6364005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364008">defer</span>&nbsp;<span class="ident" id="6364014">db</span><span class="op" id="6364016">.</span><span class="ident" id="6364017">mu</span><span class="op" id="6364019">.</span><span class="ident" id="6364020">Unlock</span><span class="op" id="6364026">(</span><span class="op" id="6364027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364030">if</span>&nbsp;<span class="ident" id="6364033">c</span><span class="op" id="6364034">.</span><span class="ident" id="6364035">inUse</span>&nbsp;<span class="op" id="6364041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364045">c</span><span class="op" id="6364046">.</span><span class="ident" id="6364047">onPut</span>&nbsp;<span class="op" id="6364053">=</span>&nbsp;<span class="builtinfunc" id="6364055">append</span><span class="op" id="6364061">(</span><span class="ident" id="6364062">c</span><span class="op" id="6364063">.</span><span class="ident" id="6364064">onPut</span><span class="op" id="6364069">,</span>&nbsp;<span class="keyword" id="6364071">func</span><span class="op" id="6364075">(</span><span class="op" id="6364076">)</span>&nbsp;<span class="op" id="6364078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364083">si</span><span class="op" id="6364085">.</span><span class="ident" id="6364086">Close</span><span class="op" id="6364091">(</span><span class="op" id="6364092">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364096">}</span><span class="op" id="6364097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364100">}</span>&nbsp;<span class="keyword" id="6364102">else</span>&nbsp;<span class="op" id="6364107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364111">c</span><span class="op" id="6364112">.</span><span class="ident" id="6364113">Lock</span><span class="op" id="6364117">(</span><span class="op" id="6364118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364122">defer</span>&nbsp;<span class="ident" id="6364128">c</span><span class="op" id="6364129">.</span><span class="ident" id="6364130">Unlock</span><span class="op" id="6364136">(</span><span class="op" id="6364137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364141">if</span>&nbsp;<span class="op" id="6364144">!</span><span class="ident" id="6364145">c</span><span class="op" id="6364146">.</span><span class="ident" id="6364147">finalClosed</span>&nbsp;<span class="op" id="6364159">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364164">si</span><span class="op" id="6364166">.</span><span class="ident" id="6364167">Close</span><span class="op" id="6364172">(</span><span class="op" id="6364173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364180">}</span><br>
<span class="lineno"></span><span class="op" id="6364182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="6364185">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="6364257">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="6364299">const</span>&nbsp;<span class="ident" id="6364305">debugGetPut</span>&nbsp;<span class="op" id="6364317">=</span>&nbsp;<span class="builtintype" id="6364319">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6364326">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="6364378">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6364448">func</span>&nbsp;<span class="op" id="6364453">(</span><span class="ident" id="6364454">db</span>&nbsp;<span class="op" id="6364457">*</span><span class="ident" id="6364458">DB</span><span class="op" id="6364460">)</span>&nbsp;<span class="ident" id="6364462">putConn</span><span class="op" id="6364469">(</span><span class="ident" id="6364470">dc</span>&nbsp;<span class="op" id="6364473">*</span><span class="ident" id="6364474">driverConn</span><span class="op" id="6364484">,</span>&nbsp;<span class="ident" id="6364486">err</span>&nbsp;<span class="builtintype" id="6364490">error</span><span class="op" id="6364495">)</span>&nbsp;<span class="op" id="6364497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364500">db</span><span class="op" id="6364502">.</span><span class="ident" id="6364503">mu</span><span class="op" id="6364505">.</span><span class="ident" id="6364506">Lock</span><span class="op" id="6364510">(</span><span class="op" id="6364511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364514">if</span>&nbsp;<span class="op" id="6364517">!</span><span class="ident" id="6364518">dc</span><span class="op" id="6364520">.</span><span class="ident" id="6364521">inUse</span>&nbsp;<span class="op" id="6364527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364531">if</span>&nbsp;<span class="ident" id="6364534">debugGetPut</span>&nbsp;<span class="op" id="6364546">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364551">fmt</span><span class="op" id="6364554">.</span><span class="ident" id="6364555">Printf</span><span class="op" id="6364561">(</span><span class="string" id="6364562">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="6364613">,</span>&nbsp;<span class="ident" id="6364615">dc</span><span class="op" id="6364617">,</span>&nbsp;<span class="ident" id="6364619">stack</span><span class="op" id="6364624">(</span><span class="op" id="6364625">)</span><span class="op" id="6364626">,</span>&nbsp;<span class="ident" id="6364628">db</span><span class="op" id="6364630">.</span><span class="ident" id="6364631">lastPut</span><span class="op" id="6364638">[</span><span class="ident" id="6364639">dc</span><span class="op" id="6364641">]</span><span class="op" id="6364642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6364650">panic</span><span class="op" id="6364655">(</span><span class="string" id="6364656">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="6364701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364707">if</span>&nbsp;<span class="ident" id="6364710">debugGetPut</span>&nbsp;<span class="op" id="6364722">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364726">db</span><span class="op" id="6364728">.</span><span class="ident" id="6364729">lastPut</span><span class="op" id="6364736">[</span><span class="ident" id="6364737">dc</span><span class="op" id="6364739">]</span>&nbsp;<span class="op" id="6364741">=</span>&nbsp;<span class="ident" id="6364743">stack</span><span class="op" id="6364748">(</span><span class="op" id="6364749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364755">dc</span><span class="op" id="6364757">.</span><span class="ident" id="6364758">inUse</span>&nbsp;<span class="op" id="6364764">=</span>&nbsp;<span class="builtintype" id="6364766">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364774">for</span>&nbsp;<span class="ident" id="6364778">_</span><span class="op" id="6364779">,</span>&nbsp;<span class="ident" id="6364781">fn</span>&nbsp;<span class="op" id="6364784">:=</span>&nbsp;<span class="keyword" id="6364787">range</span>&nbsp;<span class="ident" id="6364793">dc</span><span class="op" id="6364795">.</span><span class="ident" id="6364796">onPut</span>&nbsp;<span class="op" id="6364802">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364806">fn</span><span class="op" id="6364808">(</span><span class="op" id="6364809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6364812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6364815">dc</span><span class="op" id="6364817">.</span><span class="ident" id="6364818">onPut</span>&nbsp;<span class="op" id="6364824">=</span>&nbsp;<span class="builtintype" id="6364826">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6364832">if</span>&nbsp;<span class="ident" id="6364835">err</span>&nbsp;<span class="op" id="6364839">==</span>&nbsp;<span class="ident" id="6364842">driver</span><span class="op" id="6364848">.</span><span class="ident" id="6364849">ErrBadConn</span>&nbsp;<span class="op" id="6364860">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6364864">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6364898">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6364969">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6365038">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365062">db</span><span class="op" id="6365064">.</span><span class="ident" id="6365065">maybeOpenNewConnections</span><span class="op" id="6365088">(</span><span class="op" id="6365089">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365093">db</span><span class="op" id="6365095">.</span><span class="ident" id="6365096">mu</span><span class="op" id="6365098">.</span><span class="ident" id="6365099">Unlock</span><span class="op" id="6365105">(</span><span class="op" id="6365106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365110">dc</span><span class="op" id="6365112">.</span><span class="ident" id="6365113">Close</span><span class="op" id="6365118">(</span><span class="op" id="6365119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6365123">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6365131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6365134">if</span>&nbsp;<span class="ident" id="6365137">putConnHook</span>&nbsp;<span class="op" id="6365149">!=</span>&nbsp;<span class="builtintype" id="6365152">nil</span>&nbsp;<span class="op" id="6365156">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365160">putConnHook</span><span class="op" id="6365171">(</span><span class="ident" id="6365172">db</span><span class="op" id="6365174">,</span>&nbsp;<span class="ident" id="6365176">dc</span><span class="op" id="6365178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6365181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365184">added</span>&nbsp;<span class="op" id="6365190">:=</span>&nbsp;<span class="ident" id="6365193">db</span><span class="op" id="6365195">.</span><span class="ident" id="6365196">putConnDBLocked</span><span class="op" id="6365211">(</span><span class="ident" id="6365212">dc</span><span class="op" id="6365214">,</span>&nbsp;<span class="builtintype" id="6365216">nil</span><span class="op" id="6365219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365222">db</span><span class="op" id="6365224">.</span><span class="ident" id="6365225">mu</span><span class="op" id="6365227">.</span><span class="ident" id="6365228">Unlock</span><span class="op" id="6365234">(</span><span class="op" id="6365235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6365239">if</span>&nbsp;<span class="op" id="6365242">!</span><span class="ident" id="6365243">added</span>&nbsp;<span class="op" id="6365249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365253">dc</span><span class="op" id="6365255">.</span><span class="ident" id="6365256">Close</span><span class="op" id="6365261">(</span><span class="op" id="6365262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6365265">}</span><br>
<span class="lineno"></span><span class="op" id="6365267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="6365270">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="6365350">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="6365370">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6365444">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6365518">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="6365560">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="6365606">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="6365652">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6365723">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6365793">func</span>&nbsp;<span class="op" id="6365798">(</span><span class="ident" id="6365799">db</span>&nbsp;<span class="op" id="6365802">*</span><span class="ident" id="6365803">DB</span><span class="op" id="6365805">)</span>&nbsp;<span class="ident" id="6365807">putConnDBLocked</span><span class="op" id="6365822">(</span><span class="ident" id="6365823">dc</span>&nbsp;<span class="op" id="6365826">*</span><span class="ident" id="6365827">driverConn</span><span class="op" id="6365837">,</span>&nbsp;<span class="ident" id="6365839">err</span>&nbsp;<span class="builtintype" id="6365843">error</span><span class="op" id="6365848">)</span>&nbsp;<span class="builtintype" id="6365850">bool</span>&nbsp;<span class="op" id="6365855">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6365858">if</span>&nbsp;<span class="ident" id="6365861">c</span>&nbsp;<span class="op" id="6365863">:=</span>&nbsp;<span class="builtinfunc" id="6365866">len</span><span class="op" id="6365869">(</span><span class="ident" id="6365870">db</span><span class="op" id="6365872">.</span><span class="ident" id="6365873">connRequests</span><span class="op" id="6365885">)</span><span class="op" id="6365886">;</span>&nbsp;<span class="ident" id="6365888">c</span>&nbsp;<span class="op" id="6365890">&gt;</span>&nbsp;<span class="num" id="6365892">0</span>&nbsp;<span class="op" id="6365894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6365898">req</span>&nbsp;<span class="op" id="6365902">:=</span>&nbsp;<span class="ident" id="6365905">db</span><span class="op" id="6365907">.</span><span class="ident" id="6365908">connRequests</span><span class="op" id="6365920">[</span><span class="num" id="6365921">0</span><span class="op" id="6365922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6365926">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6365992">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6366046">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6366076">copy</span><span class="op" id="6366080">(</span><span class="ident" id="6366081">db</span><span class="op" id="6366083">.</span><span class="ident" id="6366084">connRequests</span><span class="op" id="6366096">,</span>&nbsp;<span class="ident" id="6366098">db</span><span class="op" id="6366100">.</span><span class="ident" id="6366101">connRequests</span><span class="op" id="6366113">[</span><span class="num" id="6366114">1</span><span class="op" id="6366115">:</span><span class="op" id="6366116">]</span><span class="op" id="6366117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366121">db</span><span class="op" id="6366123">.</span><span class="ident" id="6366124">connRequests</span>&nbsp;<span class="op" id="6366137">=</span>&nbsp;<span class="ident" id="6366139">db</span><span class="op" id="6366141">.</span><span class="ident" id="6366142">connRequests</span><span class="op" id="6366154">[</span><span class="op" id="6366155">:</span><span class="ident" id="6366156">c</span><span class="op" id="6366157">-</span><span class="num" id="6366158">1</span><span class="op" id="6366159">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366163">if</span>&nbsp;<span class="ident" id="6366166">err</span>&nbsp;<span class="op" id="6366170">==</span>&nbsp;<span class="builtintype" id="6366173">nil</span>&nbsp;<span class="op" id="6366177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366182">dc</span><span class="op" id="6366184">.</span><span class="ident" id="6366185">inUse</span>&nbsp;<span class="op" id="6366191">=</span>&nbsp;<span class="builtintype" id="6366193">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6366200">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366204">req</span>&nbsp;<span class="op" id="6366208">&lt;-</span>&nbsp;<span class="ident" id="6366211">connRequest</span><span class="op" id="6366222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366227">conn</span><span class="op" id="6366231">:</span>&nbsp;<span class="ident" id="6366233">dc</span><span class="op" id="6366235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366240">err</span><span class="op" id="6366243">:</span>&nbsp;&nbsp;<span class="ident" id="6366246">err</span><span class="op" id="6366249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6366253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366257">return</span>&nbsp;<span class="builtintype" id="6366264">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6366270">}</span>&nbsp;<span class="keyword" id="6366272">else</span>&nbsp;<span class="keyword" id="6366277">if</span>&nbsp;<span class="ident" id="6366280">err</span>&nbsp;<span class="op" id="6366284">==</span>&nbsp;<span class="builtintype" id="6366287">nil</span>&nbsp;<span class="op" id="6366291">&amp;&amp;</span>&nbsp;<span class="op" id="6366294">!</span><span class="ident" id="6366295">db</span><span class="op" id="6366297">.</span><span class="ident" id="6366298">closed</span>&nbsp;<span class="op" id="6366305">&amp;&amp;</span>&nbsp;<span class="ident" id="6366308">db</span><span class="op" id="6366310">.</span><span class="ident" id="6366311">maxIdleConnsLocked</span><span class="op" id="6366329">(</span><span class="op" id="6366330">)</span>&nbsp;<span class="op" id="6366332">&gt;</span>&nbsp;<span class="builtinfunc" id="6366334">len</span><span class="op" id="6366337">(</span><span class="ident" id="6366338">db</span><span class="op" id="6366340">.</span><span class="ident" id="6366341">freeConn</span><span class="op" id="6366349">)</span>&nbsp;<span class="op" id="6366351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366355">db</span><span class="op" id="6366357">.</span><span class="ident" id="6366358">freeConn</span>&nbsp;<span class="op" id="6366367">=</span>&nbsp;<span class="builtinfunc" id="6366369">append</span><span class="op" id="6366375">(</span><span class="ident" id="6366376">db</span><span class="op" id="6366378">.</span><span class="ident" id="6366379">freeConn</span><span class="op" id="6366387">,</span>&nbsp;<span class="ident" id="6366389">dc</span><span class="op" id="6366391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366395">return</span>&nbsp;<span class="builtintype" id="6366402">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6366408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366411">return</span>&nbsp;<span class="builtintype" id="6366418">false</span><br>
<span class="lineno">820</span><span class="op" id="6366424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6366427">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6366503">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6366555">const</span>&nbsp;<span class="ident" id="6366561">maxBadConnRetries</span>&nbsp;<span class="op" id="6366579">=</span>&nbsp;<span class="num" id="6366581">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="6366585">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="6366658">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6366725">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6366748">func</span>&nbsp;<span class="op" id="6366753">(</span><span class="ident" id="6366754">db</span>&nbsp;<span class="op" id="6366757">*</span><span class="ident" id="6366758">DB</span><span class="op" id="6366760">)</span>&nbsp;<span class="ident" id="6366762">Prepare</span><span class="op" id="6366769">(</span><span class="ident" id="6366770">query</span>&nbsp;<span class="builtintype" id="6366776">string</span><span class="op" id="6366782">)</span>&nbsp;<span class="op" id="6366784">(</span><span class="op" id="6366785">*</span><span class="ident" id="6366786">Stmt</span><span class="op" id="6366790">,</span>&nbsp;<span class="builtintype" id="6366792">error</span><span class="op" id="6366797">)</span>&nbsp;<span class="op" id="6366799">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366802">var</span>&nbsp;<span class="ident" id="6366806">stmt</span>&nbsp;<span class="op" id="6366811">*</span><span class="ident" id="6366812">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366818">var</span>&nbsp;<span class="ident" id="6366822">err</span>&nbsp;<span class="builtintype" id="6366826">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366833">for</span>&nbsp;<span class="ident" id="6366837">i</span>&nbsp;<span class="op" id="6366839">:=</span>&nbsp;<span class="num" id="6366842">0</span><span class="op" id="6366843">;</span>&nbsp;<span class="ident" id="6366845">i</span>&nbsp;<span class="op" id="6366847">&lt;</span>&nbsp;<span class="ident" id="6366849">maxBadConnRetries</span><span class="op" id="6366866">;</span>&nbsp;<span class="ident" id="6366868">i</span><span class="op" id="6366869">++</span>&nbsp;<span class="op" id="6366872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6366876">stmt</span><span class="op" id="6366880">,</span>&nbsp;<span class="ident" id="6366882">err</span>&nbsp;<span class="op" id="6366886">=</span>&nbsp;<span class="ident" id="6366888">db</span><span class="op" id="6366890">.</span><span class="ident" id="6366891">prepare</span><span class="op" id="6366898">(</span><span class="ident" id="6366899">query</span><span class="op" id="6366904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366908">if</span>&nbsp;<span class="ident" id="6366911">err</span>&nbsp;<span class="op" id="6366915">!=</span>&nbsp;<span class="ident" id="6366918">driver</span><span class="op" id="6366924">.</span><span class="ident" id="6366925">ErrBadConn</span>&nbsp;<span class="op" id="6366936">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366941">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6366949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6366952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6366955">return</span>&nbsp;<span class="ident" id="6366962">stmt</span><span class="op" id="6366966">,</span>&nbsp;<span class="ident" id="6366968">err</span><br>
<span class="lineno"></span><span class="op" id="6366972">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="6366975">func</span>&nbsp;<span class="op" id="6366980">(</span><span class="ident" id="6366981">db</span>&nbsp;<span class="op" id="6366984">*</span><span class="ident" id="6366985">DB</span><span class="op" id="6366987">)</span>&nbsp;<span class="ident" id="6366989">prepare</span><span class="op" id="6366996">(</span><span class="ident" id="6366997">query</span>&nbsp;<span class="builtintype" id="6367003">string</span><span class="op" id="6367009">)</span>&nbsp;<span class="op" id="6367011">(</span><span class="op" id="6367012">*</span><span class="ident" id="6367013">Stmt</span><span class="op" id="6367017">,</span>&nbsp;<span class="builtintype" id="6367019">error</span><span class="op" id="6367024">)</span>&nbsp;<span class="op" id="6367026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6367029">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6367079">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6367139">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6367195">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6367255">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6367318">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367379">dc</span><span class="op" id="6367381">,</span>&nbsp;<span class="ident" id="6367383">err</span>&nbsp;<span class="op" id="6367387">:=</span>&nbsp;<span class="ident" id="6367390">db</span><span class="op" id="6367392">.</span><span class="ident" id="6367393">conn</span><span class="op" id="6367397">(</span><span class="op" id="6367398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367401">if</span>&nbsp;<span class="ident" id="6367404">err</span>&nbsp;<span class="op" id="6367408">!=</span>&nbsp;<span class="builtintype" id="6367411">nil</span>&nbsp;<span class="op" id="6367415">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367419">return</span>&nbsp;<span class="builtintype" id="6367426">nil</span><span class="op" id="6367429">,</span>&nbsp;<span class="ident" id="6367431">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6367436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367439">dc</span><span class="op" id="6367441">.</span><span class="ident" id="6367442">Lock</span><span class="op" id="6367446">(</span><span class="op" id="6367447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367450">si</span><span class="op" id="6367452">,</span>&nbsp;<span class="ident" id="6367454">err</span>&nbsp;<span class="op" id="6367458">:=</span>&nbsp;<span class="ident" id="6367461">dc</span><span class="op" id="6367463">.</span><span class="ident" id="6367464">prepareLocked</span><span class="op" id="6367477">(</span><span class="ident" id="6367478">query</span><span class="op" id="6367483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367486">dc</span><span class="op" id="6367488">.</span><span class="ident" id="6367489">Unlock</span><span class="op" id="6367495">(</span><span class="op" id="6367496">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367499">if</span>&nbsp;<span class="ident" id="6367502">err</span>&nbsp;<span class="op" id="6367506">!=</span>&nbsp;<span class="builtintype" id="6367509">nil</span>&nbsp;<span class="op" id="6367513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367517">db</span><span class="op" id="6367519">.</span><span class="ident" id="6367520">putConn</span><span class="op" id="6367527">(</span><span class="ident" id="6367528">dc</span><span class="op" id="6367530">,</span>&nbsp;<span class="ident" id="6367532">err</span><span class="op" id="6367535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367539">return</span>&nbsp;<span class="builtintype" id="6367546">nil</span><span class="op" id="6367549">,</span>&nbsp;<span class="ident" id="6367551">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6367556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367559">stmt</span>&nbsp;<span class="op" id="6367564">:=</span>&nbsp;<span class="op" id="6367567">&amp;</span><span class="ident" id="6367568">Stmt</span><span class="op" id="6367572">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367576">db</span><span class="op" id="6367578">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367583">db</span><span class="op" id="6367585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367589">query</span><span class="op" id="6367594">:</span>&nbsp;<span class="ident" id="6367596">query</span><span class="op" id="6367601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367605">css</span><span class="op" id="6367608">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6367612">[</span><span class="op" id="6367613">]</span><span class="ident" id="6367614">connStmt</span><span class="op" id="6367622">{</span><span class="op" id="6367623">{</span><span class="ident" id="6367624">dc</span><span class="op" id="6367626">,</span>&nbsp;<span class="ident" id="6367628">si</span><span class="op" id="6367630">}</span><span class="op" id="6367631">}</span><span class="op" id="6367632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6367635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367638">db</span><span class="op" id="6367640">.</span><span class="ident" id="6367641">addDep</span><span class="op" id="6367647">(</span><span class="ident" id="6367648">stmt</span><span class="op" id="6367652">,</span>&nbsp;<span class="ident" id="6367654">stmt</span><span class="op" id="6367658">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367661">db</span><span class="op" id="6367663">.</span><span class="ident" id="6367664">putConn</span><span class="op" id="6367671">(</span><span class="ident" id="6367672">dc</span><span class="op" id="6367674">,</span>&nbsp;<span class="builtintype" id="6367676">nil</span><span class="op" id="6367679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367682">return</span>&nbsp;<span class="ident" id="6367689">stmt</span><span class="op" id="6367693">,</span>&nbsp;<span class="builtintype" id="6367695">nil</span><br>
<span class="lineno"></span><span class="op" id="6367699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6367702">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="6367755">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="6367816">func</span>&nbsp;<span class="op" id="6367821">(</span><span class="ident" id="6367822">db</span>&nbsp;<span class="op" id="6367825">*</span><span class="ident" id="6367826">DB</span><span class="op" id="6367828">)</span>&nbsp;<span class="ident" id="6367830">Exec</span><span class="op" id="6367834">(</span><span class="ident" id="6367835">query</span>&nbsp;<span class="builtintype" id="6367841">string</span><span class="op" id="6367847">,</span>&nbsp;<span class="ident" id="6367849">args</span>&nbsp;<span class="op" id="6367854">...</span><span class="keyword" id="6367857">interface</span><span class="op" id="6367866">{</span><span class="op" id="6367867">}</span><span class="op" id="6367868">)</span>&nbsp;<span class="op" id="6367870">(</span><span class="ident" id="6367871">Result</span><span class="op" id="6367877">,</span>&nbsp;<span class="builtintype" id="6367879">error</span><span class="op" id="6367884">)</span>&nbsp;<span class="op" id="6367886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367889">var</span>&nbsp;<span class="ident" id="6367893">res</span>&nbsp;<span class="ident" id="6367897">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367905">var</span>&nbsp;<span class="ident" id="6367909">err</span>&nbsp;<span class="builtintype" id="6367913">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367920">for</span>&nbsp;<span class="ident" id="6367924">i</span>&nbsp;<span class="op" id="6367926">:=</span>&nbsp;<span class="num" id="6367929">0</span><span class="op" id="6367930">;</span>&nbsp;<span class="ident" id="6367932">i</span>&nbsp;<span class="op" id="6367934">&lt;</span>&nbsp;<span class="ident" id="6367936">maxBadConnRetries</span><span class="op" id="6367953">;</span>&nbsp;<span class="ident" id="6367955">i</span><span class="op" id="6367956">++</span>&nbsp;<span class="op" id="6367959">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6367963">res</span><span class="op" id="6367966">,</span>&nbsp;<span class="ident" id="6367968">err</span>&nbsp;<span class="op" id="6367972">=</span>&nbsp;<span class="ident" id="6367974">db</span><span class="op" id="6367976">.</span><span class="ident" id="6367977">exec</span><span class="op" id="6367981">(</span><span class="ident" id="6367982">query</span><span class="op" id="6367987">,</span>&nbsp;<span class="ident" id="6367989">args</span><span class="op" id="6367993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6367997">if</span>&nbsp;<span class="ident" id="6368000">err</span>&nbsp;<span class="op" id="6368004">!=</span>&nbsp;<span class="ident" id="6368007">driver</span><span class="op" id="6368013">.</span><span class="ident" id="6368014">ErrBadConn</span>&nbsp;<span class="op" id="6368025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368030">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368041">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368044">return</span>&nbsp;<span class="ident" id="6368051">res</span><span class="op" id="6368054">,</span>&nbsp;<span class="ident" id="6368056">err</span><br>
<span class="lineno"></span><span class="op" id="6368060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6368063">func</span>&nbsp;<span class="op" id="6368068">(</span><span class="ident" id="6368069">db</span>&nbsp;<span class="op" id="6368072">*</span><span class="ident" id="6368073">DB</span><span class="op" id="6368075">)</span>&nbsp;<span class="ident" id="6368077">exec</span><span class="op" id="6368081">(</span><span class="ident" id="6368082">query</span>&nbsp;<span class="builtintype" id="6368088">string</span><span class="op" id="6368094">,</span>&nbsp;<span class="ident" id="6368096">args</span>&nbsp;<span class="op" id="6368101">[</span><span class="op" id="6368102">]</span><span class="keyword" id="6368103">interface</span><span class="op" id="6368112">{</span><span class="op" id="6368113">}</span><span class="op" id="6368114">)</span>&nbsp;<span class="op" id="6368116">(</span><span class="ident" id="6368117">res</span>&nbsp;<span class="ident" id="6368121">Result</span><span class="op" id="6368127">,</span>&nbsp;<span class="ident" id="6368129">err</span>&nbsp;<span class="builtintype" id="6368133">error</span><span class="op" id="6368138">)</span>&nbsp;<span class="op" id="6368140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368143">dc</span><span class="op" id="6368145">,</span>&nbsp;<span class="ident" id="6368147">err</span>&nbsp;<span class="op" id="6368151">:=</span>&nbsp;<span class="ident" id="6368154">db</span><span class="op" id="6368156">.</span><span class="ident" id="6368157">conn</span><span class="op" id="6368161">(</span><span class="op" id="6368162">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368165">if</span>&nbsp;<span class="ident" id="6368168">err</span>&nbsp;<span class="op" id="6368172">!=</span>&nbsp;<span class="builtintype" id="6368175">nil</span>&nbsp;<span class="op" id="6368179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368183">return</span>&nbsp;<span class="builtintype" id="6368190">nil</span><span class="op" id="6368193">,</span>&nbsp;<span class="ident" id="6368195">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368203">defer</span>&nbsp;<span class="keyword" id="6368209">func</span><span class="op" id="6368213">(</span><span class="op" id="6368214">)</span>&nbsp;<span class="op" id="6368216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368220">db</span><span class="op" id="6368222">.</span><span class="ident" id="6368223">putConn</span><span class="op" id="6368230">(</span><span class="ident" id="6368231">dc</span><span class="op" id="6368233">,</span>&nbsp;<span class="ident" id="6368235">err</span><span class="op" id="6368238">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368241">}</span><span class="op" id="6368242">(</span><span class="op" id="6368243">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368247">if</span>&nbsp;<span class="ident" id="6368250">execer</span><span class="op" id="6368256">,</span>&nbsp;<span class="ident" id="6368258">ok</span>&nbsp;<span class="op" id="6368261">:=</span>&nbsp;<span class="ident" id="6368264">dc</span><span class="op" id="6368266">.</span><span class="ident" id="6368267">ci</span><span class="op" id="6368269">.</span><span class="op" id="6368270">(</span><span class="ident" id="6368271">driver</span><span class="op" id="6368277">.</span><span class="ident" id="6368278">Execer</span><span class="op" id="6368284">)</span><span class="op" id="6368285">;</span>&nbsp;<span class="ident" id="6368287">ok</span>&nbsp;<span class="op" id="6368290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368294">dargs</span><span class="op" id="6368299">,</span>&nbsp;<span class="ident" id="6368301">err</span>&nbsp;<span class="op" id="6368305">:=</span>&nbsp;<span class="ident" id="6368308">driverArgs</span><span class="op" id="6368318">(</span><span class="builtintype" id="6368319">nil</span><span class="op" id="6368322">,</span>&nbsp;<span class="ident" id="6368324">args</span><span class="op" id="6368328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368332">if</span>&nbsp;<span class="ident" id="6368335">err</span>&nbsp;<span class="op" id="6368339">!=</span>&nbsp;<span class="builtintype" id="6368342">nil</span>&nbsp;<span class="op" id="6368346">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368351">return</span>&nbsp;<span class="builtintype" id="6368358">nil</span><span class="op" id="6368361">,</span>&nbsp;<span class="ident" id="6368363">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368373">dc</span><span class="op" id="6368375">.</span><span class="ident" id="6368376">Lock</span><span class="op" id="6368380">(</span><span class="op" id="6368381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368385">resi</span><span class="op" id="6368389">,</span>&nbsp;<span class="ident" id="6368391">err</span>&nbsp;<span class="op" id="6368395">:=</span>&nbsp;<span class="ident" id="6368398">execer</span><span class="op" id="6368404">.</span><span class="ident" id="6368405">Exec</span><span class="op" id="6368409">(</span><span class="ident" id="6368410">query</span><span class="op" id="6368415">,</span>&nbsp;<span class="ident" id="6368417">dargs</span><span class="op" id="6368422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368426">dc</span><span class="op" id="6368428">.</span><span class="ident" id="6368429">Unlock</span><span class="op" id="6368435">(</span><span class="op" id="6368436">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368440">if</span>&nbsp;<span class="ident" id="6368443">err</span>&nbsp;<span class="op" id="6368447">!=</span>&nbsp;<span class="ident" id="6368450">driver</span><span class="op" id="6368456">.</span><span class="ident" id="6368457">ErrSkip</span>&nbsp;<span class="op" id="6368465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368470">if</span>&nbsp;<span class="ident" id="6368473">err</span>&nbsp;<span class="op" id="6368477">!=</span>&nbsp;<span class="builtintype" id="6368480">nil</span>&nbsp;<span class="op" id="6368484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368490">return</span>&nbsp;<span class="builtintype" id="6368497">nil</span><span class="op" id="6368500">,</span>&nbsp;<span class="ident" id="6368502">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368514">return</span>&nbsp;<span class="ident" id="6368521">driverResult</span><span class="op" id="6368533">{</span><span class="ident" id="6368534">dc</span><span class="op" id="6368536">,</span>&nbsp;<span class="ident" id="6368538">resi</span><span class="op" id="6368542">}</span><span class="op" id="6368543">,</span>&nbsp;<span class="builtintype" id="6368545">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368558">dc</span><span class="op" id="6368560">.</span><span class="ident" id="6368561">Lock</span><span class="op" id="6368565">(</span><span class="op" id="6368566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368569">si</span><span class="op" id="6368571">,</span>&nbsp;<span class="ident" id="6368573">err</span>&nbsp;<span class="op" id="6368577">:=</span>&nbsp;<span class="ident" id="6368580">dc</span><span class="op" id="6368582">.</span><span class="ident" id="6368583">ci</span><span class="op" id="6368585">.</span><span class="ident" id="6368586">Prepare</span><span class="op" id="6368593">(</span><span class="ident" id="6368594">query</span><span class="op" id="6368599">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6368602">dc</span><span class="op" id="6368604">.</span><span class="ident" id="6368605">Unlock</span><span class="op" id="6368611">(</span><span class="op" id="6368612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368615">if</span>&nbsp;<span class="ident" id="6368618">err</span>&nbsp;<span class="op" id="6368622">!=</span>&nbsp;<span class="builtintype" id="6368625">nil</span>&nbsp;<span class="op" id="6368629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368633">return</span>&nbsp;<span class="builtintype" id="6368640">nil</span><span class="op" id="6368643">,</span>&nbsp;<span class="ident" id="6368645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6368650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368653">defer</span>&nbsp;<span class="ident" id="6368659">withLock</span><span class="op" id="6368667">(</span><span class="ident" id="6368668">dc</span><span class="op" id="6368670">,</span>&nbsp;<span class="keyword" id="6368672">func</span><span class="op" id="6368676">(</span><span class="op" id="6368677">)</span>&nbsp;<span class="op" id="6368679">{</span>&nbsp;<span class="ident" id="6368681">si</span><span class="op" id="6368683">.</span><span class="ident" id="6368684">Close</span><span class="op" id="6368689">(</span><span class="op" id="6368690">)</span>&nbsp;<span class="op" id="6368692">}</span><span class="op" id="6368693">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368696">return</span>&nbsp;<span class="ident" id="6368703">resultFromStatement</span><span class="op" id="6368722">(</span><span class="ident" id="6368723">driverStmt</span><span class="op" id="6368733">{</span><span class="ident" id="6368734">dc</span><span class="op" id="6368736">,</span>&nbsp;<span class="ident" id="6368738">si</span><span class="op" id="6368740">}</span><span class="op" id="6368741">,</span>&nbsp;<span class="ident" id="6368743">args</span><span class="op" id="6368747">...</span><span class="op" id="6368750">)</span><br>
<span class="lineno"></span><span class="op" id="6368752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6368755">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="6368820">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="6368881">func</span>&nbsp;<span class="op" id="6368886">(</span><span class="ident" id="6368887">db</span>&nbsp;<span class="op" id="6368890">*</span><span class="ident" id="6368891">DB</span><span class="op" id="6368893">)</span>&nbsp;<span class="ident" id="6368895">Query</span><span class="op" id="6368900">(</span><span class="ident" id="6368901">query</span>&nbsp;<span class="builtintype" id="6368907">string</span><span class="op" id="6368913">,</span>&nbsp;<span class="ident" id="6368915">args</span>&nbsp;<span class="op" id="6368920">...</span><span class="keyword" id="6368923">interface</span><span class="op" id="6368932">{</span><span class="op" id="6368933">}</span><span class="op" id="6368934">)</span>&nbsp;<span class="op" id="6368936">(</span><span class="op" id="6368937">*</span><span class="ident" id="6368938">Rows</span><span class="op" id="6368942">,</span>&nbsp;<span class="builtintype" id="6368944">error</span><span class="op" id="6368949">)</span>&nbsp;<span class="op" id="6368951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368954">var</span>&nbsp;<span class="ident" id="6368958">rows</span>&nbsp;<span class="op" id="6368963">*</span><span class="ident" id="6368964">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368970">var</span>&nbsp;<span class="ident" id="6368974">err</span>&nbsp;<span class="builtintype" id="6368978">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6368985">for</span>&nbsp;<span class="ident" id="6368989">i</span>&nbsp;<span class="op" id="6368991">:=</span>&nbsp;<span class="num" id="6368994">0</span><span class="op" id="6368995">;</span>&nbsp;<span class="ident" id="6368997">i</span>&nbsp;<span class="op" id="6368999">&lt;</span>&nbsp;<span class="ident" id="6369001">maxBadConnRetries</span><span class="op" id="6369018">;</span>&nbsp;<span class="ident" id="6369020">i</span><span class="op" id="6369021">++</span>&nbsp;<span class="op" id="6369024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369028">rows</span><span class="op" id="6369032">,</span>&nbsp;<span class="ident" id="6369034">err</span>&nbsp;<span class="op" id="6369038">=</span>&nbsp;<span class="ident" id="6369040">db</span><span class="op" id="6369042">.</span><span class="ident" id="6369043">query</span><span class="op" id="6369048">(</span><span class="ident" id="6369049">query</span><span class="op" id="6369054">,</span>&nbsp;<span class="ident" id="6369056">args</span><span class="op" id="6369060">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369064">if</span>&nbsp;<span class="ident" id="6369067">err</span>&nbsp;<span class="op" id="6369071">!=</span>&nbsp;<span class="ident" id="6369074">driver</span><span class="op" id="6369080">.</span><span class="ident" id="6369081">ErrBadConn</span>&nbsp;<span class="op" id="6369092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369097">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369111">return</span>&nbsp;<span class="ident" id="6369118">rows</span><span class="op" id="6369122">,</span>&nbsp;<span class="ident" id="6369124">err</span><br>
<span class="lineno">930</span><span class="op" id="6369128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6369131">func</span>&nbsp;<span class="op" id="6369136">(</span><span class="ident" id="6369137">db</span>&nbsp;<span class="op" id="6369140">*</span><span class="ident" id="6369141">DB</span><span class="op" id="6369143">)</span>&nbsp;<span class="ident" id="6369145">query</span><span class="op" id="6369150">(</span><span class="ident" id="6369151">query</span>&nbsp;<span class="builtintype" id="6369157">string</span><span class="op" id="6369163">,</span>&nbsp;<span class="ident" id="6369165">args</span>&nbsp;<span class="op" id="6369170">[</span><span class="op" id="6369171">]</span><span class="keyword" id="6369172">interface</span><span class="op" id="6369181">{</span><span class="op" id="6369182">}</span><span class="op" id="6369183">)</span>&nbsp;<span class="op" id="6369185">(</span><span class="op" id="6369186">*</span><span class="ident" id="6369187">Rows</span><span class="op" id="6369191">,</span>&nbsp;<span class="builtintype" id="6369193">error</span><span class="op" id="6369198">)</span>&nbsp;<span class="op" id="6369200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369203">ci</span><span class="op" id="6369205">,</span>&nbsp;<span class="ident" id="6369207">err</span>&nbsp;<span class="op" id="6369211">:=</span>&nbsp;<span class="ident" id="6369214">db</span><span class="op" id="6369216">.</span><span class="ident" id="6369217">conn</span><span class="op" id="6369221">(</span><span class="op" id="6369222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369225">if</span>&nbsp;<span class="ident" id="6369228">err</span>&nbsp;<span class="op" id="6369232">!=</span>&nbsp;<span class="builtintype" id="6369235">nil</span>&nbsp;<span class="op" id="6369239">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369243">return</span>&nbsp;<span class="builtintype" id="6369250">nil</span><span class="op" id="6369253">,</span>&nbsp;<span class="ident" id="6369255">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369264">return</span>&nbsp;<span class="ident" id="6369271">db</span><span class="op" id="6369273">.</span><span class="ident" id="6369274">queryConn</span><span class="op" id="6369283">(</span><span class="ident" id="6369284">ci</span><span class="op" id="6369286">,</span>&nbsp;<span class="ident" id="6369288">ci</span><span class="op" id="6369290">.</span><span class="ident" id="6369291">releaseConn</span><span class="op" id="6369302">,</span>&nbsp;<span class="ident" id="6369304">query</span><span class="op" id="6369309">,</span>&nbsp;<span class="ident" id="6369311">args</span><span class="op" id="6369315">)</span><br>
<span class="lineno"></span><span class="op" id="6369317">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="6369320">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="6369375">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="6369436">func</span>&nbsp;<span class="op" id="6369441">(</span><span class="ident" id="6369442">db</span>&nbsp;<span class="op" id="6369445">*</span><span class="ident" id="6369446">DB</span><span class="op" id="6369448">)</span>&nbsp;<span class="ident" id="6369450">queryConn</span><span class="op" id="6369459">(</span><span class="ident" id="6369460">dc</span>&nbsp;<span class="op" id="6369463">*</span><span class="ident" id="6369464">driverConn</span><span class="op" id="6369474">,</span>&nbsp;<span class="ident" id="6369476">releaseConn</span>&nbsp;<span class="keyword" id="6369488">func</span><span class="op" id="6369492">(</span><span class="builtintype" id="6369493">error</span><span class="op" id="6369498">)</span><span class="op" id="6369499">,</span>&nbsp;<span class="ident" id="6369501">query</span>&nbsp;<span class="builtintype" id="6369507">string</span><span class="op" id="6369513">,</span>&nbsp;<span class="ident" id="6369515">args</span>&nbsp;<span class="op" id="6369520">[</span><span class="op" id="6369521">]</span><span class="keyword" id="6369522">interface</span><span class="op" id="6369531">{</span><span class="op" id="6369532">}</span><span class="op" id="6369533">)</span>&nbsp;<span class="op" id="6369535">(</span><span class="op" id="6369536">*</span><span class="ident" id="6369537">Rows</span><span class="op" id="6369541">,</span>&nbsp;<span class="builtintype" id="6369543">error</span><span class="op" id="6369548">)</span>&nbsp;<span class="op" id="6369550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369553">if</span>&nbsp;<span class="ident" id="6369556">queryer</span><span class="op" id="6369563">,</span>&nbsp;<span class="ident" id="6369565">ok</span>&nbsp;<span class="op" id="6369568">:=</span>&nbsp;<span class="ident" id="6369571">dc</span><span class="op" id="6369573">.</span><span class="ident" id="6369574">ci</span><span class="op" id="6369576">.</span><span class="op" id="6369577">(</span><span class="ident" id="6369578">driver</span><span class="op" id="6369584">.</span><span class="ident" id="6369585">Queryer</span><span class="op" id="6369592">)</span><span class="op" id="6369593">;</span>&nbsp;<span class="ident" id="6369595">ok</span>&nbsp;<span class="op" id="6369598">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369602">dargs</span><span class="op" id="6369607">,</span>&nbsp;<span class="ident" id="6369609">err</span>&nbsp;<span class="op" id="6369613">:=</span>&nbsp;<span class="ident" id="6369616">driverArgs</span><span class="op" id="6369626">(</span><span class="builtintype" id="6369627">nil</span><span class="op" id="6369630">,</span>&nbsp;<span class="ident" id="6369632">args</span><span class="op" id="6369636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369640">if</span>&nbsp;<span class="ident" id="6369643">err</span>&nbsp;<span class="op" id="6369647">!=</span>&nbsp;<span class="builtintype" id="6369650">nil</span>&nbsp;<span class="op" id="6369654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369659">releaseConn</span><span class="op" id="6369670">(</span><span class="ident" id="6369671">err</span><span class="op" id="6369674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369679">return</span>&nbsp;<span class="builtintype" id="6369686">nil</span><span class="op" id="6369689">,</span>&nbsp;<span class="ident" id="6369691">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369697">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369701">dc</span><span class="op" id="6369703">.</span><span class="ident" id="6369704">Lock</span><span class="op" id="6369708">(</span><span class="op" id="6369709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369713">rowsi</span><span class="op" id="6369718">,</span>&nbsp;<span class="ident" id="6369720">err</span>&nbsp;<span class="op" id="6369724">:=</span>&nbsp;<span class="ident" id="6369727">queryer</span><span class="op" id="6369734">.</span><span class="ident" id="6369735">Query</span><span class="op" id="6369740">(</span><span class="ident" id="6369741">query</span><span class="op" id="6369746">,</span>&nbsp;<span class="ident" id="6369748">dargs</span><span class="op" id="6369753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369757">dc</span><span class="op" id="6369759">.</span><span class="ident" id="6369760">Unlock</span><span class="op" id="6369766">(</span><span class="op" id="6369767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369771">if</span>&nbsp;<span class="ident" id="6369774">err</span>&nbsp;<span class="op" id="6369778">!=</span>&nbsp;<span class="ident" id="6369781">driver</span><span class="op" id="6369787">.</span><span class="ident" id="6369788">ErrSkip</span>&nbsp;<span class="op" id="6369796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369801">if</span>&nbsp;<span class="ident" id="6369804">err</span>&nbsp;<span class="op" id="6369808">!=</span>&nbsp;<span class="builtintype" id="6369811">nil</span>&nbsp;<span class="op" id="6369815">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369821">releaseConn</span><span class="op" id="6369832">(</span><span class="ident" id="6369833">err</span><span class="op" id="6369836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6369842">return</span>&nbsp;<span class="builtintype" id="6369849">nil</span><span class="op" id="6369852">,</span>&nbsp;<span class="ident" id="6369854">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6369861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369866">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6369927">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369951">rows</span>&nbsp;<span class="op" id="6369956">:=</span>&nbsp;<span class="op" id="6369959">&amp;</span><span class="ident" id="6369960">Rows</span><span class="op" id="6369964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369970">dc</span><span class="op" id="6369972">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369983">dc</span><span class="op" id="6369985">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6369991">releaseConn</span><span class="op" id="6370002">:</span>&nbsp;<span class="ident" id="6370004">releaseConn</span><span class="op" id="6370015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370021">rowsi</span><span class="op" id="6370026">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370034">rowsi</span><span class="op" id="6370039">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6370044">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370049">return</span>&nbsp;<span class="ident" id="6370056">rows</span><span class="op" id="6370060">,</span>&nbsp;<span class="builtintype" id="6370062">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6370068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6370071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370075">dc</span><span class="op" id="6370077">.</span><span class="ident" id="6370078">Lock</span><span class="op" id="6370082">(</span><span class="op" id="6370083">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370086">si</span><span class="op" id="6370088">,</span>&nbsp;<span class="ident" id="6370090">err</span>&nbsp;<span class="op" id="6370094">:=</span>&nbsp;<span class="ident" id="6370097">dc</span><span class="op" id="6370099">.</span><span class="ident" id="6370100">ci</span><span class="op" id="6370102">.</span><span class="ident" id="6370103">Prepare</span><span class="op" id="6370110">(</span><span class="ident" id="6370111">query</span><span class="op" id="6370116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370119">dc</span><span class="op" id="6370121">.</span><span class="ident" id="6370122">Unlock</span><span class="op" id="6370128">(</span><span class="op" id="6370129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370132">if</span>&nbsp;<span class="ident" id="6370135">err</span>&nbsp;<span class="op" id="6370139">!=</span>&nbsp;<span class="builtintype" id="6370142">nil</span>&nbsp;<span class="op" id="6370146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370150">releaseConn</span><span class="op" id="6370161">(</span><span class="ident" id="6370162">err</span><span class="op" id="6370165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370169">return</span>&nbsp;<span class="builtintype" id="6370176">nil</span><span class="op" id="6370179">,</span>&nbsp;<span class="ident" id="6370181">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6370186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370190">ds</span>&nbsp;<span class="op" id="6370193">:=</span>&nbsp;<span class="ident" id="6370196">driverStmt</span><span class="op" id="6370206">{</span><span class="ident" id="6370207">dc</span><span class="op" id="6370209">,</span>&nbsp;<span class="ident" id="6370211">si</span><span class="op" id="6370213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370216">rowsi</span><span class="op" id="6370221">,</span>&nbsp;<span class="ident" id="6370223">err</span>&nbsp;<span class="op" id="6370227">:=</span>&nbsp;<span class="ident" id="6370230">rowsiFromStatement</span><span class="op" id="6370248">(</span><span class="ident" id="6370249">ds</span><span class="op" id="6370251">,</span>&nbsp;<span class="ident" id="6370253">args</span><span class="op" id="6370257">...</span><span class="op" id="6370260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370263">if</span>&nbsp;<span class="ident" id="6370266">err</span>&nbsp;<span class="op" id="6370270">!=</span>&nbsp;<span class="builtintype" id="6370273">nil</span>&nbsp;<span class="op" id="6370277">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370281">dc</span><span class="op" id="6370283">.</span><span class="ident" id="6370284">Lock</span><span class="op" id="6370288">(</span><span class="op" id="6370289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370293">si</span><span class="op" id="6370295">.</span><span class="ident" id="6370296">Close</span><span class="op" id="6370301">(</span><span class="op" id="6370302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370306">dc</span><span class="op" id="6370308">.</span><span class="ident" id="6370309">Unlock</span><span class="op" id="6370315">(</span><span class="op" id="6370316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370320">releaseConn</span><span class="op" id="6370331">(</span><span class="ident" id="6370332">err</span><span class="op" id="6370335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370339">return</span>&nbsp;<span class="builtintype" id="6370346">nil</span><span class="op" id="6370349">,</span>&nbsp;<span class="ident" id="6370351">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6370356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6370360">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6370419">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370441">rows</span>&nbsp;<span class="op" id="6370446">:=</span>&nbsp;<span class="op" id="6370449">&amp;</span><span class="ident" id="6370450">Rows</span><span class="op" id="6370454">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370458">dc</span><span class="op" id="6370460">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370471">dc</span><span class="op" id="6370473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370477">releaseConn</span><span class="op" id="6370488">:</span>&nbsp;<span class="ident" id="6370490">releaseConn</span><span class="op" id="6370501">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370505">rowsi</span><span class="op" id="6370510">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370518">rowsi</span><span class="op" id="6370523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370527">closeStmt</span><span class="op" id="6370536">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6370540">si</span><span class="op" id="6370542">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6370545">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370548">return</span>&nbsp;<span class="ident" id="6370555">rows</span><span class="op" id="6370559">,</span>&nbsp;<span class="builtintype" id="6370561">nil</span><br>
<span class="lineno"></span><span class="op" id="6370565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6370568">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6370641">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="6370710">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="6370742">func</span>&nbsp;<span class="op" id="6370747">(</span><span class="ident" id="6370748">db</span>&nbsp;<span class="op" id="6370751">*</span><span class="ident" id="6370752">DB</span><span class="op" id="6370754">)</span>&nbsp;<span class="ident" id="6370756">QueryRow</span><span class="op" id="6370764">(</span><span class="ident" id="6370765">query</span>&nbsp;<span class="builtintype" id="6370771">string</span><span class="op" id="6370777">,</span>&nbsp;<span class="ident" id="6370779">args</span>&nbsp;<span class="op" id="6370784">...</span><span class="keyword" id="6370787">interface</span><span class="op" id="6370796">{</span><span class="op" id="6370797">}</span><span class="op" id="6370798">)</span>&nbsp;<span class="op" id="6370800">*</span><span class="ident" id="6370801">Row</span>&nbsp;<span class="op" id="6370805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6370808">rows</span><span class="op" id="6370812">,</span>&nbsp;<span class="ident" id="6370814">err</span>&nbsp;<span class="op" id="6370818">:=</span>&nbsp;<span class="ident" id="6370821">db</span><span class="op" id="6370823">.</span><span class="ident" id="6370824">Query</span><span class="op" id="6370829">(</span><span class="ident" id="6370830">query</span><span class="op" id="6370835">,</span>&nbsp;<span class="ident" id="6370837">args</span><span class="op" id="6370841">...</span><span class="op" id="6370844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6370847">return</span>&nbsp;<span class="op" id="6370854">&amp;</span><span class="ident" id="6370855">Row</span><span class="op" id="6370858">{</span><span class="ident" id="6370859">rows</span><span class="op" id="6370863">:</span>&nbsp;<span class="ident" id="6370865">rows</span><span class="op" id="6370869">,</span>&nbsp;<span class="ident" id="6370871">err</span><span class="op" id="6370874">:</span>&nbsp;<span class="ident" id="6370876">err</span><span class="op" id="6370879">}</span><br>
<span class="lineno"></span><span class="op" id="6370881">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="6370884">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6370951">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="6370966">func</span>&nbsp;<span class="op" id="6370971">(</span><span class="ident" id="6370972">db</span>&nbsp;<span class="op" id="6370975">*</span><span class="ident" id="6370976">DB</span><span class="op" id="6370978">)</span>&nbsp;<span class="ident" id="6370980">Begin</span><span class="op" id="6370985">(</span><span class="op" id="6370986">)</span>&nbsp;<span class="op" id="6370988">(</span><span class="op" id="6370989">*</span><span class="ident" id="6370990">Tx</span><span class="op" id="6370992">,</span>&nbsp;<span class="builtintype" id="6370994">error</span><span class="op" id="6370999">)</span>&nbsp;<span class="op" id="6371001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371004">var</span>&nbsp;<span class="ident" id="6371008">tx</span>&nbsp;<span class="op" id="6371011">*</span><span class="ident" id="6371012">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371016">var</span>&nbsp;<span class="ident" id="6371020">err</span>&nbsp;<span class="builtintype" id="6371024">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371031">for</span>&nbsp;<span class="ident" id="6371035">i</span>&nbsp;<span class="op" id="6371037">:=</span>&nbsp;<span class="num" id="6371040">0</span><span class="op" id="6371041">;</span>&nbsp;<span class="ident" id="6371043">i</span>&nbsp;<span class="op" id="6371045">&lt;</span>&nbsp;<span class="ident" id="6371047">maxBadConnRetries</span><span class="op" id="6371064">;</span>&nbsp;<span class="ident" id="6371066">i</span><span class="op" id="6371067">++</span>&nbsp;<span class="op" id="6371070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371074">tx</span><span class="op" id="6371076">,</span>&nbsp;<span class="ident" id="6371078">err</span>&nbsp;<span class="op" id="6371082">=</span>&nbsp;<span class="ident" id="6371084">db</span><span class="op" id="6371086">.</span><span class="ident" id="6371087">begin</span><span class="op" id="6371092">(</span><span class="op" id="6371093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371097">if</span>&nbsp;<span class="ident" id="6371100">err</span>&nbsp;<span class="op" id="6371104">!=</span>&nbsp;<span class="ident" id="6371107">driver</span><span class="op" id="6371113">.</span><span class="ident" id="6371114">ErrBadConn</span>&nbsp;<span class="op" id="6371125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371130">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6371138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6371141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371144">return</span>&nbsp;<span class="ident" id="6371151">tx</span><span class="op" id="6371153">,</span>&nbsp;<span class="ident" id="6371155">err</span><br>
<span class="lineno"></span><span class="op" id="6371159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="6371162">func</span>&nbsp;<span class="op" id="6371167">(</span><span class="ident" id="6371168">db</span>&nbsp;<span class="op" id="6371171">*</span><span class="ident" id="6371172">DB</span><span class="op" id="6371174">)</span>&nbsp;<span class="ident" id="6371176">begin</span><span class="op" id="6371181">(</span><span class="op" id="6371182">)</span>&nbsp;<span class="op" id="6371184">(</span><span class="ident" id="6371185">tx</span>&nbsp;<span class="op" id="6371188">*</span><span class="ident" id="6371189">Tx</span><span class="op" id="6371191">,</span>&nbsp;<span class="ident" id="6371193">err</span>&nbsp;<span class="builtintype" id="6371197">error</span><span class="op" id="6371202">)</span>&nbsp;<span class="op" id="6371204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371207">dc</span><span class="op" id="6371209">,</span>&nbsp;<span class="ident" id="6371211">err</span>&nbsp;<span class="op" id="6371215">:=</span>&nbsp;<span class="ident" id="6371218">db</span><span class="op" id="6371220">.</span><span class="ident" id="6371221">conn</span><span class="op" id="6371225">(</span><span class="op" id="6371226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371229">if</span>&nbsp;<span class="ident" id="6371232">err</span>&nbsp;<span class="op" id="6371236">!=</span>&nbsp;<span class="builtintype" id="6371239">nil</span>&nbsp;<span class="op" id="6371243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371247">return</span>&nbsp;<span class="builtintype" id="6371254">nil</span><span class="op" id="6371257">,</span>&nbsp;<span class="ident" id="6371259">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6371264">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371267">dc</span><span class="op" id="6371269">.</span><span class="ident" id="6371270">Lock</span><span class="op" id="6371274">(</span><span class="op" id="6371275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371278">txi</span><span class="op" id="6371281">,</span>&nbsp;<span class="ident" id="6371283">err</span>&nbsp;<span class="op" id="6371287">:=</span>&nbsp;<span class="ident" id="6371290">dc</span><span class="op" id="6371292">.</span><span class="ident" id="6371293">ci</span><span class="op" id="6371295">.</span><span class="ident" id="6371296">Begin</span><span class="op" id="6371301">(</span><span class="op" id="6371302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371305">dc</span><span class="op" id="6371307">.</span><span class="ident" id="6371308">Unlock</span><span class="op" id="6371314">(</span><span class="op" id="6371315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371318">if</span>&nbsp;<span class="ident" id="6371321">err</span>&nbsp;<span class="op" id="6371325">!=</span>&nbsp;<span class="builtintype" id="6371328">nil</span>&nbsp;<span class="op" id="6371332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371336">db</span><span class="op" id="6371338">.</span><span class="ident" id="6371339">putConn</span><span class="op" id="6371346">(</span><span class="ident" id="6371347">dc</span><span class="op" id="6371349">,</span>&nbsp;<span class="ident" id="6371351">err</span><span class="op" id="6371354">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371358">return</span>&nbsp;<span class="builtintype" id="6371365">nil</span><span class="op" id="6371368">,</span>&nbsp;<span class="ident" id="6371370">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6371375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371378">return</span>&nbsp;<span class="op" id="6371385">&amp;</span><span class="ident" id="6371386">Tx</span><span class="op" id="6371388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371392">db</span><span class="op" id="6371394">:</span>&nbsp;&nbsp;<span class="ident" id="6371397">db</span><span class="op" id="6371399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371403">dc</span><span class="op" id="6371405">:</span>&nbsp;&nbsp;<span class="ident" id="6371408">dc</span><span class="op" id="6371410">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371414">txi</span><span class="op" id="6371417">:</span>&nbsp;<span class="ident" id="6371419">txi</span><span class="op" id="6371422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6371425">}</span><span class="op" id="6371426">,</span>&nbsp;<span class="builtintype" id="6371428">nil</span><br>
<span class="lineno"></span><span class="op" id="6371432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6371435">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="6371487">func</span>&nbsp;<span class="op" id="6371492">(</span><span class="ident" id="6371493">db</span>&nbsp;<span class="op" id="6371496">*</span><span class="ident" id="6371497">DB</span><span class="op" id="6371499">)</span>&nbsp;<span class="ident" id="6371501">Driver</span><span class="op" id="6371507">(</span><span class="op" id="6371508">)</span>&nbsp;<span class="ident" id="6371510">driver</span><span class="op" id="6371516">.</span><span class="ident" id="6371517">Driver</span>&nbsp;<span class="op" id="6371524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6371527">return</span>&nbsp;<span class="ident" id="6371534">db</span><span class="op" id="6371536">.</span><span class="ident" id="6371537">driver</span><br>
<span class="lineno"></span><span class="op" id="6371544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6371547">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="6371593">//</span><br>
<span class="lineno"></span><span class="comment" id="6371596">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="6371657">//</span><br>
<span class="lineno"></span><span class="comment" id="6371660">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6371721">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="6371757">type</span>&nbsp;<span class="ident" id="6371762">Tx</span>&nbsp;<span class="keyword" id="6371765">struct</span>&nbsp;<span class="op" id="6371772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371775">db</span>&nbsp;<span class="op" id="6371778">*</span><span class="ident" id="6371779">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6371784">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6371853">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371885">dc</span>&nbsp;&nbsp;<span class="op" id="6371889">*</span><span class="ident" id="6371890">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6371902">txi</span>&nbsp;<span class="ident" id="6371906">driver</span><span class="op" id="6371912">.</span><span class="ident" id="6371913">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6371918">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6371982">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6372035">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372050">done</span>&nbsp;<span class="builtintype" id="6372055">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6372062">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6372139">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372190">stmts</span>&nbsp;<span class="keyword" id="6372196">struct</span>&nbsp;<span class="op" id="6372203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372207">sync</span><span class="op" id="6372211">.</span><span class="ident" id="6372212">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372220">v</span>&nbsp;<span class="op" id="6372222">[</span><span class="op" id="6372223">]</span><span class="op" id="6372224">*</span><span class="ident" id="6372225">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372231">}</span><br>
<span class="lineno"></span><span class="op" id="6372233">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="6372236">var</span>&nbsp;<span class="ident" id="6372240">ErrTxDone</span>&nbsp;<span class="op" id="6372250">=</span>&nbsp;<span class="ident" id="6372252">errors</span><span class="op" id="6372258">.</span><span class="ident" id="6372259">New</span><span class="op" id="6372262">(</span><span class="string" id="6372263">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="6372323">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372326">func</span>&nbsp;<span class="op" id="6372331">(</span><span class="ident" id="6372332">tx</span>&nbsp;<span class="op" id="6372335">*</span><span class="ident" id="6372336">Tx</span><span class="op" id="6372338">)</span>&nbsp;<span class="builtinfunc" id="6372340">close</span><span class="op" id="6372345">(</span><span class="op" id="6372346">)</span>&nbsp;<span class="op" id="6372348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372351">if</span>&nbsp;<span class="ident" id="6372354">tx</span><span class="op" id="6372356">.</span><span class="ident" id="6372357">done</span>&nbsp;<span class="op" id="6372362">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6372366">panic</span><span class="op" id="6372371">(</span><span class="string" id="6372372">&#34;double&nbsp;close&#34;</span><span class="op" id="6372386">)</span>&nbsp;<span class="comment" id="6372388">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372410">tx</span><span class="op" id="6372412">.</span><span class="ident" id="6372413">done</span>&nbsp;<span class="op" id="6372418">=</span>&nbsp;<span class="builtintype" id="6372420">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372426">tx</span><span class="op" id="6372428">.</span><span class="ident" id="6372429">db</span><span class="op" id="6372431">.</span><span class="ident" id="6372432">putConn</span><span class="op" id="6372439">(</span><span class="ident" id="6372440">tx</span><span class="op" id="6372442">.</span><span class="ident" id="6372443">dc</span><span class="op" id="6372445">,</span>&nbsp;<span class="builtintype" id="6372447">nil</span><span class="op" id="6372450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372453">tx</span><span class="op" id="6372455">.</span><span class="ident" id="6372456">dc</span>&nbsp;<span class="op" id="6372459">=</span>&nbsp;<span class="builtintype" id="6372461">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372466">tx</span><span class="op" id="6372468">.</span><span class="ident" id="6372469">txi</span>&nbsp;<span class="op" id="6372473">=</span>&nbsp;<span class="builtintype" id="6372475">nil</span><br>
<span class="lineno"></span><span class="op" id="6372479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372482">func</span>&nbsp;<span class="op" id="6372487">(</span><span class="ident" id="6372488">tx</span>&nbsp;<span class="op" id="6372491">*</span><span class="ident" id="6372492">Tx</span><span class="op" id="6372494">)</span>&nbsp;<span class="ident" id="6372496">grabConn</span><span class="op" id="6372504">(</span><span class="op" id="6372505">)</span>&nbsp;<span class="op" id="6372507">(</span><span class="op" id="6372508">*</span><span class="ident" id="6372509">driverConn</span><span class="op" id="6372519">,</span>&nbsp;<span class="builtintype" id="6372521">error</span><span class="op" id="6372526">)</span>&nbsp;<span class="op" id="6372528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372531">if</span>&nbsp;<span class="ident" id="6372534">tx</span><span class="op" id="6372536">.</span><span class="ident" id="6372537">done</span>&nbsp;<span class="op" id="6372542">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372546">return</span>&nbsp;<span class="builtintype" id="6372553">nil</span><span class="op" id="6372556">,</span>&nbsp;<span class="ident" id="6372558">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372572">return</span>&nbsp;<span class="ident" id="6372579">tx</span><span class="op" id="6372581">.</span><span class="ident" id="6372582">dc</span><span class="op" id="6372584">,</span>&nbsp;<span class="builtintype" id="6372586">nil</span><br>
<span class="lineno"></span><span class="op" id="6372590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="6372593">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="6372644">func</span>&nbsp;<span class="op" id="6372649">(</span><span class="ident" id="6372650">tx</span>&nbsp;<span class="op" id="6372653">*</span><span class="ident" id="6372654">Tx</span><span class="op" id="6372656">)</span>&nbsp;<span class="ident" id="6372658">closePrepared</span><span class="op" id="6372671">(</span><span class="op" id="6372672">)</span>&nbsp;<span class="op" id="6372674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372677">tx</span><span class="op" id="6372679">.</span><span class="ident" id="6372680">stmts</span><span class="op" id="6372685">.</span><span class="ident" id="6372686">Lock</span><span class="op" id="6372690">(</span><span class="op" id="6372691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372694">for</span>&nbsp;<span class="ident" id="6372698">_</span><span class="op" id="6372699">,</span>&nbsp;<span class="ident" id="6372701">stmt</span>&nbsp;<span class="op" id="6372706">:=</span>&nbsp;<span class="keyword" id="6372709">range</span>&nbsp;<span class="ident" id="6372715">tx</span><span class="op" id="6372717">.</span><span class="ident" id="6372718">stmts</span><span class="op" id="6372723">.</span><span class="ident" id="6372724">v</span>&nbsp;<span class="op" id="6372726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372730">stmt</span><span class="op" id="6372734">.</span><span class="ident" id="6372735">Close</span><span class="op" id="6372740">(</span><span class="op" id="6372741">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372747">tx</span><span class="op" id="6372749">.</span><span class="ident" id="6372750">stmts</span><span class="op" id="6372755">.</span><span class="ident" id="6372756">Unlock</span><span class="op" id="6372762">(</span><span class="op" id="6372763">)</span><br>
<span class="lineno"></span><span class="op" id="6372765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6372768">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="6372803">func</span>&nbsp;<span class="op" id="6372808">(</span><span class="ident" id="6372809">tx</span>&nbsp;<span class="op" id="6372812">*</span><span class="ident" id="6372813">Tx</span><span class="op" id="6372815">)</span>&nbsp;<span class="ident" id="6372817">Commit</span><span class="op" id="6372823">(</span><span class="op" id="6372824">)</span>&nbsp;<span class="builtintype" id="6372826">error</span>&nbsp;<span class="op" id="6372832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372835">if</span>&nbsp;<span class="ident" id="6372838">tx</span><span class="op" id="6372840">.</span><span class="ident" id="6372841">done</span>&nbsp;<span class="op" id="6372846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372850">return</span>&nbsp;<span class="ident" id="6372857">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372871">defer</span>&nbsp;<span class="ident" id="6372877">tx</span><span class="op" id="6372879">.</span><span class="builtinfunc" id="6372880">close</span><span class="op" id="6372885">(</span><span class="op" id="6372886">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372889">tx</span><span class="op" id="6372891">.</span><span class="ident" id="6372892">dc</span><span class="op" id="6372894">.</span><span class="ident" id="6372895">Lock</span><span class="op" id="6372899">(</span><span class="op" id="6372900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372903">err</span>&nbsp;<span class="op" id="6372907">:=</span>&nbsp;<span class="ident" id="6372910">tx</span><span class="op" id="6372912">.</span><span class="ident" id="6372913">txi</span><span class="op" id="6372916">.</span><span class="ident" id="6372917">Commit</span><span class="op" id="6372923">(</span><span class="op" id="6372924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372927">tx</span><span class="op" id="6372929">.</span><span class="ident" id="6372930">dc</span><span class="op" id="6372932">.</span><span class="ident" id="6372933">Unlock</span><span class="op" id="6372939">(</span><span class="op" id="6372940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372943">if</span>&nbsp;<span class="ident" id="6372946">err</span>&nbsp;<span class="op" id="6372950">!=</span>&nbsp;<span class="ident" id="6372953">driver</span><span class="op" id="6372959">.</span><span class="ident" id="6372960">ErrBadConn</span>&nbsp;<span class="op" id="6372971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372975">tx</span><span class="op" id="6372977">.</span><span class="ident" id="6372978">closePrepared</span><span class="op" id="6372991">(</span><span class="op" id="6372992">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6372998">return</span>&nbsp;<span class="ident" id="6373005">err</span><br>
<span class="lineno"></span><span class="op" id="6373009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6373012">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="6373048">func</span>&nbsp;<span class="op" id="6373053">(</span><span class="ident" id="6373054">tx</span>&nbsp;<span class="op" id="6373057">*</span><span class="ident" id="6373058">Tx</span><span class="op" id="6373060">)</span>&nbsp;<span class="ident" id="6373062">Rollback</span><span class="op" id="6373070">(</span><span class="op" id="6373071">)</span>&nbsp;<span class="builtintype" id="6373073">error</span>&nbsp;<span class="op" id="6373079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6373082">if</span>&nbsp;<span class="ident" id="6373085">tx</span><span class="op" id="6373087">.</span><span class="ident" id="6373088">done</span>&nbsp;<span class="op" id="6373093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6373097">return</span>&nbsp;<span class="ident" id="6373104">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6373115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6373118">defer</span>&nbsp;<span class="ident" id="6373124">tx</span><span class="op" id="6373126">.</span><span class="builtinfunc" id="6373127">close</span><span class="op" id="6373132">(</span><span class="op" id="6373133">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6373136">tx</span><span class="op" id="6373138">.</span><span class="ident" id="6373139">dc</span><span class="op" id="6373141">.</span><span class="ident" id="6373142">Lock</span><span class="op" id="6373146">(</span><span class="op" id="6373147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6373150">err</span>&nbsp;<span class="op" id="6373154">:=</span>&nbsp;<span class="ident" id="6373157">tx</span><span class="op" id="6373159">.</span><span class="ident" id="6373160">txi</span><span class="op" id="6373163">.</span><span class="ident" id="6373164">Rollback</span><span class="op" id="6373172">(</span><span class="op" id="6373173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6373176">tx</span><span class="op" id="6373178">.</span><span class="ident" id="6373179">dc</span><span class="op" id="6373181">.</span><span class="ident" id="6373182">Unlock</span><span class="op" id="6373188">(</span><span class="op" id="6373189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6373192">if</span>&nbsp;<span class="ident" id="6373195">err</span>&nbsp;<span class="op" id="6373199">!=</span>&nbsp;<span class="ident" id="6373202">driver</span><span class="op" id="6373208">.</span><span class="ident" id="6373209">ErrBadConn</span>&nbsp;<span class="op" id="6373220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6373224">tx</span><span class="op" id="6373226">.</span><span class="ident" id="6373227">closePrepared</span><span class="op" id="6373240">(</span><span class="op" id="6373241">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6373244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6373247">return</span>&nbsp;<span class="ident" id="6373254">err</span><br>
<span class="lineno"></span><span class="op" id="6373258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6373261">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="6373331">//</span><br>
<span class="lineno"></span><span class="comment" id="6373334">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="6373410">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="6373477">//</span><br>
<span class="lineno"></span><span class="comment" id="6373480">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="6373555">func</span>&nbsp;<span class="op" id="6373560">(</span><span class="ident" id="6373561">tx</span>&nbsp;<span class="op" id="6373564">*</span><span class="ident" id="6373565">Tx</span><span class="op" id="6373567">)</span>&nbsp;<span class="ident" id="6373569">Prepare</span><span class="op" id="6373576">(</span><span class="ident" id="6373577">query</span>&nbsp;<span class="builtintype" id="6373583">string</span><span class="op" id="6373589">)</span>&nbsp;<span class="op" id="6373591">(</span><span class="op" id="6373592">*</span><span class="ident" id="6373593">Stmt</span><span class="op" id="6373597">,</span>&nbsp;<span class="builtintype" id="6373599">error</span><span class="op" id="6373604">)</span>&nbsp;<span class="op" id="6373606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373609">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373672">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373730">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373794">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373857">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373913">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6373974">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6374036">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6374095">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6374155">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6374215">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6374274">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6374338">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374379">dc</span><span class="op" id="6374381">,</span>&nbsp;<span class="ident" id="6374383">err</span>&nbsp;<span class="op" id="6374387">:=</span>&nbsp;<span class="ident" id="6374390">tx</span><span class="op" id="6374392">.</span><span class="ident" id="6374393">grabConn</span><span class="op" id="6374401">(</span><span class="op" id="6374402">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6374405">if</span>&nbsp;<span class="ident" id="6374408">err</span>&nbsp;<span class="op" id="6374412">!=</span>&nbsp;<span class="builtintype" id="6374415">nil</span>&nbsp;<span class="op" id="6374419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6374423">return</span>&nbsp;<span class="builtintype" id="6374430">nil</span><span class="op" id="6374433">,</span>&nbsp;<span class="ident" id="6374435">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6374440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374444">dc</span><span class="op" id="6374446">.</span><span class="ident" id="6374447">Lock</span><span class="op" id="6374451">(</span><span class="op" id="6374452">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374455">si</span><span class="op" id="6374457">,</span>&nbsp;<span class="ident" id="6374459">err</span>&nbsp;<span class="op" id="6374463">:=</span>&nbsp;<span class="ident" id="6374466">dc</span><span class="op" id="6374468">.</span><span class="ident" id="6374469">ci</span><span class="op" id="6374471">.</span><span class="ident" id="6374472">Prepare</span><span class="op" id="6374479">(</span><span class="ident" id="6374480">query</span><span class="op" id="6374485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374488">dc</span><span class="op" id="6374490">.</span><span class="ident" id="6374491">Unlock</span><span class="op" id="6374497">(</span><span class="op" id="6374498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6374501">if</span>&nbsp;<span class="ident" id="6374504">err</span>&nbsp;<span class="op" id="6374508">!=</span>&nbsp;<span class="builtintype" id="6374511">nil</span>&nbsp;<span class="op" id="6374515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6374519">return</span>&nbsp;<span class="builtintype" id="6374526">nil</span><span class="op" id="6374529">,</span>&nbsp;<span class="ident" id="6374531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6374536">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374540">stmt</span>&nbsp;<span class="op" id="6374545">:=</span>&nbsp;<span class="op" id="6374548">&amp;</span><span class="ident" id="6374549">Stmt</span><span class="op" id="6374553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374557">db</span><span class="op" id="6374559">:</span>&nbsp;<span class="ident" id="6374561">tx</span><span class="op" id="6374563">.</span><span class="ident" id="6374564">db</span><span class="op" id="6374566">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374570">tx</span><span class="op" id="6374572">:</span>&nbsp;<span class="ident" id="6374574">tx</span><span class="op" id="6374576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374580">txsi</span><span class="op" id="6374584">:</span>&nbsp;<span class="op" id="6374586">&amp;</span><span class="ident" id="6374587">driverStmt</span><span class="op" id="6374597">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374602">Locker</span><span class="op" id="6374608">:</span>&nbsp;<span class="ident" id="6374610">dc</span><span class="op" id="6374612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374617">si</span><span class="op" id="6374619">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374625">si</span><span class="op" id="6374627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6374631">}</span><span class="op" id="6374632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374636">query</span><span class="op" id="6374641">:</span>&nbsp;<span class="ident" id="6374643">query</span><span class="op" id="6374648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6374651">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374654">tx</span><span class="op" id="6374656">.</span><span class="ident" id="6374657">stmts</span><span class="op" id="6374662">.</span><span class="ident" id="6374663">Lock</span><span class="op" id="6374667">(</span><span class="op" id="6374668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374671">tx</span><span class="op" id="6374673">.</span><span class="ident" id="6374674">stmts</span><span class="op" id="6374679">.</span><span class="ident" id="6374680">v</span>&nbsp;<span class="op" id="6374682">=</span>&nbsp;<span class="builtinfunc" id="6374684">append</span><span class="op" id="6374690">(</span><span class="ident" id="6374691">tx</span><span class="op" id="6374693">.</span><span class="ident" id="6374694">stmts</span><span class="op" id="6374699">.</span><span class="ident" id="6374700">v</span><span class="op" id="6374701">,</span>&nbsp;<span class="ident" id="6374703">stmt</span><span class="op" id="6374707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374710">tx</span><span class="op" id="6374712">.</span><span class="ident" id="6374713">stmts</span><span class="op" id="6374718">.</span><span class="ident" id="6374719">Unlock</span><span class="op" id="6374725">(</span><span class="op" id="6374726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6374729">return</span>&nbsp;<span class="ident" id="6374736">stmt</span><span class="op" id="6374740">,</span>&nbsp;<span class="builtintype" id="6374742">nil</span><br>
<span class="lineno"></span><span class="op" id="6374746">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="6374749">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="6374812">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="6374838">//</span><br>
<span class="lineno"></span><span class="comment" id="6374841">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="6374853">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6374935">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6374943">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="6374969">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6374977">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="6375037">func</span>&nbsp;<span class="op" id="6375042">(</span><span class="ident" id="6375043">tx</span>&nbsp;<span class="op" id="6375046">*</span><span class="ident" id="6375047">Tx</span><span class="op" id="6375049">)</span>&nbsp;<span class="ident" id="6375051">Stmt</span><span class="op" id="6375055">(</span><span class="ident" id="6375056">stmt</span>&nbsp;<span class="op" id="6375061">*</span><span class="ident" id="6375062">Stmt</span><span class="op" id="6375066">)</span>&nbsp;<span class="op" id="6375068">*</span><span class="ident" id="6375069">Stmt</span>&nbsp;<span class="op" id="6375074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6375077">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6375139">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6375202">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6375257">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6375312">if</span>&nbsp;<span class="ident" id="6375315">tx</span><span class="op" id="6375317">.</span><span class="ident" id="6375318">db</span>&nbsp;<span class="op" id="6375321">!=</span>&nbsp;<span class="ident" id="6375324">stmt</span><span class="op" id="6375328">.</span><span class="ident" id="6375329">db</span>&nbsp;<span class="op" id="6375332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6375336">return</span>&nbsp;<span class="op" id="6375343">&amp;</span><span class="ident" id="6375344">Stmt</span><span class="op" id="6375348">{</span><span class="ident" id="6375349">stickyErr</span><span class="op" id="6375358">:</span>&nbsp;<span class="ident" id="6375360">errors</span><span class="op" id="6375366">.</span><span class="ident" id="6375367">New</span><span class="op" id="6375370">(</span><span class="string" id="6375371">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="6375425">)</span><span class="op" id="6375426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6375429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375432">dc</span><span class="op" id="6375434">,</span>&nbsp;<span class="ident" id="6375436">err</span>&nbsp;<span class="op" id="6375440">:=</span>&nbsp;<span class="ident" id="6375443">tx</span><span class="op" id="6375445">.</span><span class="ident" id="6375446">grabConn</span><span class="op" id="6375454">(</span><span class="op" id="6375455">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6375458">if</span>&nbsp;<span class="ident" id="6375461">err</span>&nbsp;<span class="op" id="6375465">!=</span>&nbsp;<span class="builtintype" id="6375468">nil</span>&nbsp;<span class="op" id="6375472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6375476">return</span>&nbsp;<span class="op" id="6375483">&amp;</span><span class="ident" id="6375484">Stmt</span><span class="op" id="6375488">{</span><span class="ident" id="6375489">stickyErr</span><span class="op" id="6375498">:</span>&nbsp;<span class="ident" id="6375500">err</span><span class="op" id="6375503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6375506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375509">dc</span><span class="op" id="6375511">.</span><span class="ident" id="6375512">Lock</span><span class="op" id="6375516">(</span><span class="op" id="6375517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375520">si</span><span class="op" id="6375522">,</span>&nbsp;<span class="ident" id="6375524">err</span>&nbsp;<span class="op" id="6375528">:=</span>&nbsp;<span class="ident" id="6375531">dc</span><span class="op" id="6375533">.</span><span class="ident" id="6375534">ci</span><span class="op" id="6375536">.</span><span class="ident" id="6375537">Prepare</span><span class="op" id="6375544">(</span><span class="ident" id="6375545">stmt</span><span class="op" id="6375549">.</span><span class="ident" id="6375550">query</span><span class="op" id="6375555">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375558">dc</span><span class="op" id="6375560">.</span><span class="ident" id="6375561">Unlock</span><span class="op" id="6375567">(</span><span class="op" id="6375568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375571">txs</span>&nbsp;<span class="op" id="6375575">:=</span>&nbsp;<span class="op" id="6375578">&amp;</span><span class="ident" id="6375579">Stmt</span><span class="op" id="6375583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375587">db</span><span class="op" id="6375589">:</span>&nbsp;<span class="ident" id="6375591">tx</span><span class="op" id="6375593">.</span><span class="ident" id="6375594">db</span><span class="op" id="6375596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375600">tx</span><span class="op" id="6375602">:</span>&nbsp;<span class="ident" id="6375604">tx</span><span class="op" id="6375606">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375610">txsi</span><span class="op" id="6375614">:</span>&nbsp;<span class="op" id="6375616">&amp;</span><span class="ident" id="6375617">driverStmt</span><span class="op" id="6375627">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375632">Locker</span><span class="op" id="6375638">:</span>&nbsp;<span class="ident" id="6375640">dc</span><span class="op" id="6375642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375647">si</span><span class="op" id="6375649">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375655">si</span><span class="op" id="6375657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6375661">}</span><span class="op" id="6375662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375666">query</span><span class="op" id="6375671">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375677">stmt</span><span class="op" id="6375681">.</span><span class="ident" id="6375682">query</span><span class="op" id="6375687">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375691">stickyErr</span><span class="op" id="6375700">:</span>&nbsp;<span class="ident" id="6375702">err</span><span class="op" id="6375705">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6375708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375711">tx</span><span class="op" id="6375713">.</span><span class="ident" id="6375714">stmts</span><span class="op" id="6375719">.</span><span class="ident" id="6375720">Lock</span><span class="op" id="6375724">(</span><span class="op" id="6375725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375728">tx</span><span class="op" id="6375730">.</span><span class="ident" id="6375731">stmts</span><span class="op" id="6375736">.</span><span class="ident" id="6375737">v</span>&nbsp;<span class="op" id="6375739">=</span>&nbsp;<span class="builtinfunc" id="6375741">append</span><span class="op" id="6375747">(</span><span class="ident" id="6375748">tx</span><span class="op" id="6375750">.</span><span class="ident" id="6375751">stmts</span><span class="op" id="6375756">.</span><span class="ident" id="6375757">v</span><span class="op" id="6375758">,</span>&nbsp;<span class="ident" id="6375760">txs</span><span class="op" id="6375763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375766">tx</span><span class="op" id="6375768">.</span><span class="ident" id="6375769">stmts</span><span class="op" id="6375774">.</span><span class="ident" id="6375775">Unlock</span><span class="op" id="6375781">(</span><span class="op" id="6375782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6375785">return</span>&nbsp;<span class="ident" id="6375792">txs</span><br>
<span class="lineno">1215</span><span class="op" id="6375796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6375799">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="6375850">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="6375888">func</span>&nbsp;<span class="op" id="6375893">(</span><span class="ident" id="6375894">tx</span>&nbsp;<span class="op" id="6375897">*</span><span class="ident" id="6375898">Tx</span><span class="op" id="6375900">)</span>&nbsp;<span class="ident" id="6375902">Exec</span><span class="op" id="6375906">(</span><span class="ident" id="6375907">query</span>&nbsp;<span class="builtintype" id="6375913">string</span><span class="op" id="6375919">,</span>&nbsp;<span class="ident" id="6375921">args</span>&nbsp;<span class="op" id="6375926">...</span><span class="keyword" id="6375929">interface</span><span class="op" id="6375938">{</span><span class="op" id="6375939">}</span><span class="op" id="6375940">)</span>&nbsp;<span class="op" id="6375942">(</span><span class="ident" id="6375943">Result</span><span class="op" id="6375949">,</span>&nbsp;<span class="builtintype" id="6375951">error</span><span class="op" id="6375956">)</span>&nbsp;<span class="op" id="6375958">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375961">dc</span><span class="op" id="6375963">,</span>&nbsp;<span class="ident" id="6375965">err</span>&nbsp;<span class="op" id="6375969">:=</span>&nbsp;<span class="ident" id="6375972">tx</span><span class="op" id="6375974">.</span><span class="ident" id="6375975">grabConn</span><span class="op" id="6375983">(</span><span class="op" id="6375984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6375987">if</span>&nbsp;<span class="ident" id="6375990">err</span>&nbsp;<span class="op" id="6375994">!=</span>&nbsp;<span class="builtintype" id="6375997">nil</span>&nbsp;<span class="op" id="6376001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376005">return</span>&nbsp;<span class="builtintype" id="6376012">nil</span><span class="op" id="6376015">,</span>&nbsp;<span class="ident" id="6376017">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376026">if</span>&nbsp;<span class="ident" id="6376029">execer</span><span class="op" id="6376035">,</span>&nbsp;<span class="ident" id="6376037">ok</span>&nbsp;<span class="op" id="6376040">:=</span>&nbsp;<span class="ident" id="6376043">dc</span><span class="op" id="6376045">.</span><span class="ident" id="6376046">ci</span><span class="op" id="6376048">.</span><span class="op" id="6376049">(</span><span class="ident" id="6376050">driver</span><span class="op" id="6376056">.</span><span class="ident" id="6376057">Execer</span><span class="op" id="6376063">)</span><span class="op" id="6376064">;</span>&nbsp;<span class="ident" id="6376066">ok</span>&nbsp;<span class="op" id="6376069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376073">dargs</span><span class="op" id="6376078">,</span>&nbsp;<span class="ident" id="6376080">err</span>&nbsp;<span class="op" id="6376084">:=</span>&nbsp;<span class="ident" id="6376087">driverArgs</span><span class="op" id="6376097">(</span><span class="builtintype" id="6376098">nil</span><span class="op" id="6376101">,</span>&nbsp;<span class="ident" id="6376103">args</span><span class="op" id="6376107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376111">if</span>&nbsp;<span class="ident" id="6376114">err</span>&nbsp;<span class="op" id="6376118">!=</span>&nbsp;<span class="builtintype" id="6376121">nil</span>&nbsp;<span class="op" id="6376125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376130">return</span>&nbsp;<span class="builtintype" id="6376137">nil</span><span class="op" id="6376140">,</span>&nbsp;<span class="ident" id="6376142">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376148">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376152">dc</span><span class="op" id="6376154">.</span><span class="ident" id="6376155">Lock</span><span class="op" id="6376159">(</span><span class="op" id="6376160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376164">resi</span><span class="op" id="6376168">,</span>&nbsp;<span class="ident" id="6376170">err</span>&nbsp;<span class="op" id="6376174">:=</span>&nbsp;<span class="ident" id="6376177">execer</span><span class="op" id="6376183">.</span><span class="ident" id="6376184">Exec</span><span class="op" id="6376188">(</span><span class="ident" id="6376189">query</span><span class="op" id="6376194">,</span>&nbsp;<span class="ident" id="6376196">dargs</span><span class="op" id="6376201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376205">dc</span><span class="op" id="6376207">.</span><span class="ident" id="6376208">Unlock</span><span class="op" id="6376214">(</span><span class="op" id="6376215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376219">if</span>&nbsp;<span class="ident" id="6376222">err</span>&nbsp;<span class="op" id="6376226">==</span>&nbsp;<span class="builtintype" id="6376229">nil</span>&nbsp;<span class="op" id="6376233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376238">return</span>&nbsp;<span class="ident" id="6376245">driverResult</span><span class="op" id="6376257">{</span><span class="ident" id="6376258">dc</span><span class="op" id="6376260">,</span>&nbsp;<span class="ident" id="6376262">resi</span><span class="op" id="6376266">}</span><span class="op" id="6376267">,</span>&nbsp;<span class="builtintype" id="6376269">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376279">if</span>&nbsp;<span class="ident" id="6376282">err</span>&nbsp;<span class="op" id="6376286">!=</span>&nbsp;<span class="ident" id="6376289">driver</span><span class="op" id="6376295">.</span><span class="ident" id="6376296">ErrSkip</span>&nbsp;<span class="op" id="6376304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376309">return</span>&nbsp;<span class="builtintype" id="6376316">nil</span><span class="op" id="6376319">,</span>&nbsp;<span class="ident" id="6376321">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376330">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376334">dc</span><span class="op" id="6376336">.</span><span class="ident" id="6376337">Lock</span><span class="op" id="6376341">(</span><span class="op" id="6376342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376345">si</span><span class="op" id="6376347">,</span>&nbsp;<span class="ident" id="6376349">err</span>&nbsp;<span class="op" id="6376353">:=</span>&nbsp;<span class="ident" id="6376356">dc</span><span class="op" id="6376358">.</span><span class="ident" id="6376359">ci</span><span class="op" id="6376361">.</span><span class="ident" id="6376362">Prepare</span><span class="op" id="6376369">(</span><span class="ident" id="6376370">query</span><span class="op" id="6376375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376378">dc</span><span class="op" id="6376380">.</span><span class="ident" id="6376381">Unlock</span><span class="op" id="6376387">(</span><span class="op" id="6376388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376391">if</span>&nbsp;<span class="ident" id="6376394">err</span>&nbsp;<span class="op" id="6376398">!=</span>&nbsp;<span class="builtintype" id="6376401">nil</span>&nbsp;<span class="op" id="6376405">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376409">return</span>&nbsp;<span class="builtintype" id="6376416">nil</span><span class="op" id="6376419">,</span>&nbsp;<span class="ident" id="6376421">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376429">defer</span>&nbsp;<span class="ident" id="6376435">withLock</span><span class="op" id="6376443">(</span><span class="ident" id="6376444">dc</span><span class="op" id="6376446">,</span>&nbsp;<span class="keyword" id="6376448">func</span><span class="op" id="6376452">(</span><span class="op" id="6376453">)</span>&nbsp;<span class="op" id="6376455">{</span>&nbsp;<span class="ident" id="6376457">si</span><span class="op" id="6376459">.</span><span class="ident" id="6376460">Close</span><span class="op" id="6376465">(</span><span class="op" id="6376466">)</span>&nbsp;<span class="op" id="6376468">}</span><span class="op" id="6376469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376473">return</span>&nbsp;<span class="ident" id="6376480">resultFromStatement</span><span class="op" id="6376499">(</span><span class="ident" id="6376500">driverStmt</span><span class="op" id="6376510">{</span><span class="ident" id="6376511">dc</span><span class="op" id="6376513">,</span>&nbsp;<span class="ident" id="6376515">si</span><span class="op" id="6376517">}</span><span class="op" id="6376518">,</span>&nbsp;<span class="ident" id="6376520">args</span><span class="op" id="6376524">...</span><span class="op" id="6376527">)</span><br>
<span class="lineno">1250</span><span class="op" id="6376529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6376532">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="6376597">func</span>&nbsp;<span class="op" id="6376602">(</span><span class="ident" id="6376603">tx</span>&nbsp;<span class="op" id="6376606">*</span><span class="ident" id="6376607">Tx</span><span class="op" id="6376609">)</span>&nbsp;<span class="ident" id="6376611">Query</span><span class="op" id="6376616">(</span><span class="ident" id="6376617">query</span>&nbsp;<span class="builtintype" id="6376623">string</span><span class="op" id="6376629">,</span>&nbsp;<span class="ident" id="6376631">args</span>&nbsp;<span class="op" id="6376636">...</span><span class="keyword" id="6376639">interface</span><span class="op" id="6376648">{</span><span class="op" id="6376649">}</span><span class="op" id="6376650">)</span>&nbsp;<span class="op" id="6376652">(</span><span class="op" id="6376653">*</span><span class="ident" id="6376654">Rows</span><span class="op" id="6376658">,</span>&nbsp;<span class="builtintype" id="6376660">error</span><span class="op" id="6376665">)</span>&nbsp;<span class="op" id="6376667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376670">dc</span><span class="op" id="6376672">,</span>&nbsp;<span class="ident" id="6376674">err</span>&nbsp;<span class="op" id="6376678">:=</span>&nbsp;<span class="ident" id="6376681">tx</span><span class="op" id="6376683">.</span><span class="ident" id="6376684">grabConn</span><span class="op" id="6376692">(</span><span class="op" id="6376693">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376696">if</span>&nbsp;<span class="ident" id="6376699">err</span>&nbsp;<span class="op" id="6376703">!=</span>&nbsp;<span class="builtintype" id="6376706">nil</span>&nbsp;<span class="op" id="6376710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376714">return</span>&nbsp;<span class="builtintype" id="6376721">nil</span><span class="op" id="6376724">,</span>&nbsp;<span class="ident" id="6376726">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376734">releaseConn</span>&nbsp;<span class="op" id="6376746">:=</span>&nbsp;<span class="keyword" id="6376749">func</span><span class="op" id="6376753">(</span><span class="builtintype" id="6376754">error</span><span class="op" id="6376759">)</span>&nbsp;<span class="op" id="6376761">{</span><span class="op" id="6376762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6376765">return</span>&nbsp;<span class="ident" id="6376772">tx</span><span class="op" id="6376774">.</span><span class="ident" id="6376775">db</span><span class="op" id="6376777">.</span><span class="ident" id="6376778">queryConn</span><span class="op" id="6376787">(</span><span class="ident" id="6376788">dc</span><span class="op" id="6376790">,</span>&nbsp;<span class="ident" id="6376792">releaseConn</span><span class="op" id="6376803">,</span>&nbsp;<span class="ident" id="6376805">query</span><span class="op" id="6376810">,</span>&nbsp;<span class="ident" id="6376812">args</span><span class="op" id="6376816">)</span><br>
<span class="lineno">1260</span><span class="op" id="6376818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6376821">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6376894">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6376963">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="6376995">func</span>&nbsp;<span class="op" id="6377000">(</span><span class="ident" id="6377001">tx</span>&nbsp;<span class="op" id="6377004">*</span><span class="ident" id="6377005">Tx</span><span class="op" id="6377007">)</span>&nbsp;<span class="ident" id="6377009">QueryRow</span><span class="op" id="6377017">(</span><span class="ident" id="6377018">query</span>&nbsp;<span class="builtintype" id="6377024">string</span><span class="op" id="6377030">,</span>&nbsp;<span class="ident" id="6377032">args</span>&nbsp;<span class="op" id="6377037">...</span><span class="keyword" id="6377040">interface</span><span class="op" id="6377049">{</span><span class="op" id="6377050">}</span><span class="op" id="6377051">)</span>&nbsp;<span class="op" id="6377053">*</span><span class="ident" id="6377054">Row</span>&nbsp;<span class="op" id="6377058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377061">rows</span><span class="op" id="6377065">,</span>&nbsp;<span class="ident" id="6377067">err</span>&nbsp;<span class="op" id="6377071">:=</span>&nbsp;<span class="ident" id="6377074">tx</span><span class="op" id="6377076">.</span><span class="ident" id="6377077">Query</span><span class="op" id="6377082">(</span><span class="ident" id="6377083">query</span><span class="op" id="6377088">,</span>&nbsp;<span class="ident" id="6377090">args</span><span class="op" id="6377094">...</span><span class="op" id="6377097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6377100">return</span>&nbsp;<span class="op" id="6377107">&amp;</span><span class="ident" id="6377108">Row</span><span class="op" id="6377111">{</span><span class="ident" id="6377112">rows</span><span class="op" id="6377116">:</span>&nbsp;<span class="ident" id="6377118">rows</span><span class="op" id="6377122">,</span>&nbsp;<span class="ident" id="6377124">err</span><span class="op" id="6377127">:</span>&nbsp;<span class="ident" id="6377129">err</span><span class="op" id="6377132">}</span><br>
<span class="lineno"></span><span class="op" id="6377134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="6377137">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6377201">type</span>&nbsp;<span class="ident" id="6377206">connStmt</span>&nbsp;<span class="keyword" id="6377215">struct</span>&nbsp;<span class="op" id="6377222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377225">dc</span>&nbsp;<span class="op" id="6377228">*</span><span class="ident" id="6377229">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377241">si</span>&nbsp;<span class="ident" id="6377244">driver</span><span class="op" id="6377250">.</span><span class="ident" id="6377251">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6377256">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="6377259">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6377348">type</span>&nbsp;<span class="ident" id="6377353">Stmt</span>&nbsp;<span class="keyword" id="6377358">struct</span>&nbsp;<span class="op" id="6377365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377368">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377383">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6377393">*</span><span class="ident" id="6377394">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377400">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377423">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6377433">string</span>&nbsp;<span class="comment" id="6377440">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377466">stickyErr</span>&nbsp;<span class="builtintype" id="6377476">error</span>&nbsp;&nbsp;<span class="comment" id="6377483">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377542">closemu</span>&nbsp;<span class="ident" id="6377550">sync</span><span class="op" id="6377554">.</span><span class="ident" id="6377555">RWMutex</span>&nbsp;<span class="comment" id="6377563">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377619">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377659">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6377664">*</span><span class="ident" id="6377665">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377669">txsi</span>&nbsp;<span class="op" id="6377674">*</span><span class="ident" id="6377675">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377688">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377695">sync</span><span class="op" id="6377699">.</span><span class="ident" id="6377700">Mutex</span>&nbsp;<span class="comment" id="6377706">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377742">closed</span>&nbsp;<span class="builtintype" id="6377749">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377756">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377816">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377876">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6377929">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6377982">css</span>&nbsp;<span class="op" id="6377986">[</span><span class="op" id="6377987">]</span><span class="ident" id="6377988">connStmt</span><br>
<span class="lineno"></span><span class="op" id="6377997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6378000">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="6378067">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6378128">func</span>&nbsp;<span class="op" id="6378133">(</span><span class="ident" id="6378134">s</span>&nbsp;<span class="op" id="6378136">*</span><span class="ident" id="6378137">Stmt</span><span class="op" id="6378141">)</span>&nbsp;<span class="ident" id="6378143">Exec</span><span class="op" id="6378147">(</span><span class="ident" id="6378148">args</span>&nbsp;<span class="op" id="6378153">...</span><span class="keyword" id="6378156">interface</span><span class="op" id="6378165">{</span><span class="op" id="6378166">}</span><span class="op" id="6378167">)</span>&nbsp;<span class="op" id="6378169">(</span><span class="ident" id="6378170">Result</span><span class="op" id="6378176">,</span>&nbsp;<span class="builtintype" id="6378178">error</span><span class="op" id="6378183">)</span>&nbsp;<span class="op" id="6378185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378188">s</span><span class="op" id="6378189">.</span><span class="ident" id="6378190">closemu</span><span class="op" id="6378197">.</span><span class="ident" id="6378198">RLock</span><span class="op" id="6378203">(</span><span class="op" id="6378204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378207">defer</span>&nbsp;<span class="ident" id="6378213">s</span><span class="op" id="6378214">.</span><span class="ident" id="6378215">closemu</span><span class="op" id="6378222">.</span><span class="ident" id="6378223">RUnlock</span><span class="op" id="6378230">(</span><span class="op" id="6378231">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378235">var</span>&nbsp;<span class="ident" id="6378239">res</span>&nbsp;<span class="ident" id="6378243">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378251">for</span>&nbsp;<span class="ident" id="6378255">i</span>&nbsp;<span class="op" id="6378257">:=</span>&nbsp;<span class="num" id="6378260">0</span><span class="op" id="6378261">;</span>&nbsp;<span class="ident" id="6378263">i</span>&nbsp;<span class="op" id="6378265">&lt;</span>&nbsp;<span class="ident" id="6378267">maxBadConnRetries</span><span class="op" id="6378284">;</span>&nbsp;<span class="ident" id="6378286">i</span><span class="op" id="6378287">++</span>&nbsp;<span class="op" id="6378290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378294">dc</span><span class="op" id="6378296">,</span>&nbsp;<span class="ident" id="6378298">releaseConn</span><span class="op" id="6378309">,</span>&nbsp;<span class="ident" id="6378311">si</span><span class="op" id="6378313">,</span>&nbsp;<span class="ident" id="6378315">err</span>&nbsp;<span class="op" id="6378319">:=</span>&nbsp;<span class="ident" id="6378322">s</span><span class="op" id="6378323">.</span><span class="ident" id="6378324">connStmt</span><span class="op" id="6378332">(</span><span class="op" id="6378333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378337">if</span>&nbsp;<span class="ident" id="6378340">err</span>&nbsp;<span class="op" id="6378344">!=</span>&nbsp;<span class="builtintype" id="6378347">nil</span>&nbsp;<span class="op" id="6378351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378356">if</span>&nbsp;<span class="ident" id="6378359">err</span>&nbsp;<span class="op" id="6378363">==</span>&nbsp;<span class="ident" id="6378366">driver</span><span class="op" id="6378372">.</span><span class="ident" id="6378373">ErrBadConn</span>&nbsp;<span class="op" id="6378384">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378390">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6378402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378407">return</span>&nbsp;<span class="builtintype" id="6378414">nil</span><span class="op" id="6378417">,</span>&nbsp;<span class="ident" id="6378419">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6378425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378430">res</span><span class="op" id="6378433">,</span>&nbsp;<span class="ident" id="6378435">err</span>&nbsp;<span class="op" id="6378439">=</span>&nbsp;<span class="ident" id="6378441">resultFromStatement</span><span class="op" id="6378460">(</span><span class="ident" id="6378461">driverStmt</span><span class="op" id="6378471">{</span><span class="ident" id="6378472">dc</span><span class="op" id="6378474">,</span>&nbsp;<span class="ident" id="6378476">si</span><span class="op" id="6378478">}</span><span class="op" id="6378479">,</span>&nbsp;<span class="ident" id="6378481">args</span><span class="op" id="6378485">...</span><span class="op" id="6378488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378492">releaseConn</span><span class="op" id="6378503">(</span><span class="ident" id="6378504">err</span><span class="op" id="6378507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378511">if</span>&nbsp;<span class="ident" id="6378514">err</span>&nbsp;<span class="op" id="6378518">!=</span>&nbsp;<span class="ident" id="6378521">driver</span><span class="op" id="6378527">.</span><span class="ident" id="6378528">ErrBadConn</span>&nbsp;<span class="op" id="6378539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378544">return</span>&nbsp;<span class="ident" id="6378551">res</span><span class="op" id="6378554">,</span>&nbsp;<span class="ident" id="6378556">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6378562">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6378565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378568">return</span>&nbsp;<span class="builtintype" id="6378575">nil</span><span class="op" id="6378578">,</span>&nbsp;<span class="ident" id="6378580">driver</span><span class="op" id="6378586">.</span><span class="ident" id="6378587">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6378598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6378601">func</span>&nbsp;<span class="ident" id="6378606">resultFromStatement</span><span class="op" id="6378625">(</span><span class="ident" id="6378626">ds</span>&nbsp;<span class="ident" id="6378629">driverStmt</span><span class="op" id="6378639">,</span>&nbsp;<span class="ident" id="6378641">args</span>&nbsp;<span class="op" id="6378646">...</span><span class="keyword" id="6378649">interface</span><span class="op" id="6378658">{</span><span class="op" id="6378659">}</span><span class="op" id="6378660">)</span>&nbsp;<span class="op" id="6378662">(</span><span class="ident" id="6378663">Result</span><span class="op" id="6378669">,</span>&nbsp;<span class="builtintype" id="6378671">error</span><span class="op" id="6378676">)</span>&nbsp;<span class="op" id="6378678">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378681">ds</span><span class="op" id="6378683">.</span><span class="ident" id="6378684">Lock</span><span class="op" id="6378688">(</span><span class="op" id="6378689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378692">want</span>&nbsp;<span class="op" id="6378697">:=</span>&nbsp;<span class="ident" id="6378700">ds</span><span class="op" id="6378702">.</span><span class="ident" id="6378703">si</span><span class="op" id="6378705">.</span><span class="ident" id="6378706">NumInput</span><span class="op" id="6378714">(</span><span class="op" id="6378715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6378718">ds</span><span class="op" id="6378720">.</span><span class="ident" id="6378721">Unlock</span><span class="op" id="6378727">(</span><span class="op" id="6378728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6378732">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6378796">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6378870">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378899">if</span>&nbsp;<span class="ident" id="6378902">want</span>&nbsp;<span class="op" id="6378907">!=</span>&nbsp;<span class="op" id="6378910">-</span><span class="num" id="6378911">1</span>&nbsp;<span class="op" id="6378913">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6378916">len</span><span class="op" id="6378919">(</span><span class="ident" id="6378920">args</span><span class="op" id="6378924">)</span>&nbsp;<span class="op" id="6378926">!=</span>&nbsp;<span class="ident" id="6378929">want</span>&nbsp;<span class="op" id="6378934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6378938">return</span>&nbsp;<span class="builtintype" id="6378945">nil</span><span class="op" id="6378948">,</span>&nbsp;<span class="ident" id="6378950">fmt</span><span class="op" id="6378953">.</span><span class="ident" id="6378954">Errorf</span><span class="op" id="6378960">(</span><span class="string" id="6378961">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6378997">,</span>&nbsp;<span class="ident" id="6378999">want</span><span class="op" id="6379003">,</span>&nbsp;<span class="builtinfunc" id="6379005">len</span><span class="op" id="6379008">(</span><span class="ident" id="6379009">args</span><span class="op" id="6379013">)</span><span class="op" id="6379014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379017">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379021">dargs</span><span class="op" id="6379026">,</span>&nbsp;<span class="ident" id="6379028">err</span>&nbsp;<span class="op" id="6379032">:=</span>&nbsp;<span class="ident" id="6379035">driverArgs</span><span class="op" id="6379045">(</span><span class="op" id="6379046">&amp;</span><span class="ident" id="6379047">ds</span><span class="op" id="6379049">,</span>&nbsp;<span class="ident" id="6379051">args</span><span class="op" id="6379055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379058">if</span>&nbsp;<span class="ident" id="6379061">err</span>&nbsp;<span class="op" id="6379065">!=</span>&nbsp;<span class="builtintype" id="6379068">nil</span>&nbsp;<span class="op" id="6379072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379076">return</span>&nbsp;<span class="builtintype" id="6379083">nil</span><span class="op" id="6379086">,</span>&nbsp;<span class="ident" id="6379088">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379093">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379097">ds</span><span class="op" id="6379099">.</span><span class="ident" id="6379100">Lock</span><span class="op" id="6379104">(</span><span class="op" id="6379105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379108">resi</span><span class="op" id="6379112">,</span>&nbsp;<span class="ident" id="6379114">err</span>&nbsp;<span class="op" id="6379118">:=</span>&nbsp;<span class="ident" id="6379121">ds</span><span class="op" id="6379123">.</span><span class="ident" id="6379124">si</span><span class="op" id="6379126">.</span><span class="ident" id="6379127">Exec</span><span class="op" id="6379131">(</span><span class="ident" id="6379132">dargs</span><span class="op" id="6379137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379140">ds</span><span class="op" id="6379142">.</span><span class="ident" id="6379143">Unlock</span><span class="op" id="6379149">(</span><span class="op" id="6379150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379153">if</span>&nbsp;<span class="ident" id="6379156">err</span>&nbsp;<span class="op" id="6379160">!=</span>&nbsp;<span class="builtintype" id="6379163">nil</span>&nbsp;<span class="op" id="6379167">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379171">return</span>&nbsp;<span class="builtintype" id="6379178">nil</span><span class="op" id="6379181">,</span>&nbsp;<span class="ident" id="6379183">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379191">return</span>&nbsp;<span class="ident" id="6379198">driverResult</span><span class="op" id="6379210">{</span><span class="ident" id="6379211">ds</span><span class="op" id="6379213">.</span><span class="ident" id="6379214">Locker</span><span class="op" id="6379220">,</span>&nbsp;<span class="ident" id="6379222">resi</span><span class="op" id="6379226">}</span><span class="op" id="6379227">,</span>&nbsp;<span class="builtintype" id="6379229">nil</span><br>
<span class="lineno"></span><span class="op" id="6379233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="6379236">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6379305">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6379371">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6379410">func</span>&nbsp;<span class="op" id="6379415">(</span><span class="ident" id="6379416">s</span>&nbsp;<span class="op" id="6379418">*</span><span class="ident" id="6379419">Stmt</span><span class="op" id="6379423">)</span>&nbsp;<span class="ident" id="6379425">connStmt</span><span class="op" id="6379433">(</span><span class="op" id="6379434">)</span>&nbsp;<span class="op" id="6379436">(</span><span class="ident" id="6379437">ci</span>&nbsp;<span class="op" id="6379440">*</span><span class="ident" id="6379441">driverConn</span><span class="op" id="6379451">,</span>&nbsp;<span class="ident" id="6379453">releaseConn</span>&nbsp;<span class="keyword" id="6379465">func</span><span class="op" id="6379469">(</span><span class="builtintype" id="6379470">error</span><span class="op" id="6379475">)</span><span class="op" id="6379476">,</span>&nbsp;<span class="ident" id="6379478">si</span>&nbsp;<span class="ident" id="6379481">driver</span><span class="op" id="6379487">.</span><span class="ident" id="6379488">Stmt</span><span class="op" id="6379492">,</span>&nbsp;<span class="ident" id="6379494">err</span>&nbsp;<span class="builtintype" id="6379498">error</span><span class="op" id="6379503">)</span>&nbsp;<span class="op" id="6379505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379508">if</span>&nbsp;<span class="ident" id="6379511">err</span>&nbsp;<span class="op" id="6379515">=</span>&nbsp;<span class="ident" id="6379517">s</span><span class="op" id="6379518">.</span><span class="ident" id="6379519">stickyErr</span><span class="op" id="6379528">;</span>&nbsp;<span class="ident" id="6379530">err</span>&nbsp;<span class="op" id="6379534">!=</span>&nbsp;<span class="builtintype" id="6379537">nil</span>&nbsp;<span class="op" id="6379541">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379545">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379556">s</span><span class="op" id="6379557">.</span><span class="ident" id="6379558">mu</span><span class="op" id="6379560">.</span><span class="ident" id="6379561">Lock</span><span class="op" id="6379565">(</span><span class="op" id="6379566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379569">if</span>&nbsp;<span class="ident" id="6379572">s</span><span class="op" id="6379573">.</span><span class="ident" id="6379574">closed</span>&nbsp;<span class="op" id="6379581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379585">s</span><span class="op" id="6379586">.</span><span class="ident" id="6379587">mu</span><span class="op" id="6379589">.</span><span class="ident" id="6379590">Unlock</span><span class="op" id="6379596">(</span><span class="op" id="6379597">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379601">err</span>&nbsp;<span class="op" id="6379605">=</span>&nbsp;<span class="ident" id="6379607">errors</span><span class="op" id="6379613">.</span><span class="ident" id="6379614">New</span><span class="op" id="6379617">(</span><span class="string" id="6379618">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6379644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379648">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6379660">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6379720">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379752">if</span>&nbsp;<span class="ident" id="6379755">s</span><span class="op" id="6379756">.</span><span class="ident" id="6379757">tx</span>&nbsp;<span class="op" id="6379760">!=</span>&nbsp;<span class="builtintype" id="6379763">nil</span>&nbsp;<span class="op" id="6379767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379771">s</span><span class="op" id="6379772">.</span><span class="ident" id="6379773">mu</span><span class="op" id="6379775">.</span><span class="ident" id="6379776">Unlock</span><span class="op" id="6379782">(</span><span class="op" id="6379783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379787">ci</span><span class="op" id="6379789">,</span>&nbsp;<span class="ident" id="6379791">err</span>&nbsp;<span class="op" id="6379795">=</span>&nbsp;<span class="ident" id="6379797">s</span><span class="op" id="6379798">.</span><span class="ident" id="6379799">tx</span><span class="op" id="6379801">.</span><span class="ident" id="6379802">grabConn</span><span class="op" id="6379810">(</span><span class="op" id="6379811">)</span>&nbsp;<span class="comment" id="6379813">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379854">if</span>&nbsp;<span class="ident" id="6379857">err</span>&nbsp;<span class="op" id="6379861">!=</span>&nbsp;<span class="builtintype" id="6379864">nil</span>&nbsp;<span class="op" id="6379868">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379873">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379886">releaseConn</span>&nbsp;<span class="op" id="6379898">=</span>&nbsp;<span class="keyword" id="6379900">func</span><span class="op" id="6379904">(</span><span class="builtintype" id="6379905">error</span><span class="op" id="6379910">)</span>&nbsp;<span class="op" id="6379912">{</span><span class="op" id="6379913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379917">return</span>&nbsp;<span class="ident" id="6379924">ci</span><span class="op" id="6379926">,</span>&nbsp;<span class="ident" id="6379928">releaseConn</span><span class="op" id="6379939">,</span>&nbsp;<span class="ident" id="6379941">s</span><span class="op" id="6379942">.</span><span class="ident" id="6379943">txsi</span><span class="op" id="6379947">.</span><span class="ident" id="6379948">si</span><span class="op" id="6379950">,</span>&nbsp;<span class="builtintype" id="6379952">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6379957">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6379961">for</span>&nbsp;<span class="ident" id="6379965">i</span>&nbsp;<span class="op" id="6379967">:=</span>&nbsp;<span class="num" id="6379970">0</span><span class="op" id="6379971">;</span>&nbsp;<span class="ident" id="6379973">i</span>&nbsp;<span class="op" id="6379975">&lt;</span>&nbsp;<span class="builtinfunc" id="6379977">len</span><span class="op" id="6379980">(</span><span class="ident" id="6379981">s</span><span class="op" id="6379982">.</span><span class="ident" id="6379983">css</span><span class="op" id="6379986">)</span><span class="op" id="6379987">;</span>&nbsp;<span class="ident" id="6379989">i</span><span class="op" id="6379990">++</span>&nbsp;<span class="op" id="6379993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6379997">v</span>&nbsp;<span class="op" id="6379999">:=</span>&nbsp;<span class="ident" id="6380002">s</span><span class="op" id="6380003">.</span><span class="ident" id="6380004">css</span><span class="op" id="6380007">[</span><span class="ident" id="6380008">i</span><span class="op" id="6380009">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380013">_</span><span class="op" id="6380014">,</span>&nbsp;<span class="ident" id="6380016">err</span>&nbsp;<span class="op" id="6380020">:=</span>&nbsp;<span class="ident" id="6380023">s</span><span class="op" id="6380024">.</span><span class="ident" id="6380025">db</span><span class="op" id="6380027">.</span><span class="ident" id="6380028">connIfFree</span><span class="op" id="6380038">(</span><span class="ident" id="6380039">v</span><span class="op" id="6380040">.</span><span class="ident" id="6380041">dc</span><span class="op" id="6380043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380047">if</span>&nbsp;<span class="ident" id="6380050">err</span>&nbsp;<span class="op" id="6380054">==</span>&nbsp;<span class="builtintype" id="6380057">nil</span>&nbsp;<span class="op" id="6380061">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380066">s</span><span class="op" id="6380067">.</span><span class="ident" id="6380068">mu</span><span class="op" id="6380070">.</span><span class="ident" id="6380071">Unlock</span><span class="op" id="6380077">(</span><span class="op" id="6380078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380083">return</span>&nbsp;<span class="ident" id="6380090">v</span><span class="op" id="6380091">.</span><span class="ident" id="6380092">dc</span><span class="op" id="6380094">,</span>&nbsp;<span class="ident" id="6380096">v</span><span class="op" id="6380097">.</span><span class="ident" id="6380098">dc</span><span class="op" id="6380100">.</span><span class="ident" id="6380101">releaseConn</span><span class="op" id="6380112">,</span>&nbsp;<span class="ident" id="6380114">v</span><span class="op" id="6380115">.</span><span class="ident" id="6380116">si</span><span class="op" id="6380118">,</span>&nbsp;<span class="builtintype" id="6380120">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6380126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380130">if</span>&nbsp;<span class="ident" id="6380133">err</span>&nbsp;<span class="op" id="6380137">==</span>&nbsp;<span class="ident" id="6380140">errConnClosed</span>&nbsp;<span class="op" id="6380154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380159">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380208">s</span><span class="op" id="6380209">.</span><span class="ident" id="6380210">css</span><span class="op" id="6380213">[</span><span class="ident" id="6380214">i</span><span class="op" id="6380215">]</span>&nbsp;<span class="op" id="6380217">=</span>&nbsp;<span class="ident" id="6380219">s</span><span class="op" id="6380220">.</span><span class="ident" id="6380221">css</span><span class="op" id="6380224">[</span><span class="builtinfunc" id="6380225">len</span><span class="op" id="6380228">(</span><span class="ident" id="6380229">s</span><span class="op" id="6380230">.</span><span class="ident" id="6380231">css</span><span class="op" id="6380234">)</span><span class="op" id="6380235">-</span><span class="num" id="6380236">1</span><span class="op" id="6380237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380242">s</span><span class="op" id="6380243">.</span><span class="ident" id="6380244">css</span>&nbsp;<span class="op" id="6380248">=</span>&nbsp;<span class="ident" id="6380250">s</span><span class="op" id="6380251">.</span><span class="ident" id="6380252">css</span><span class="op" id="6380255">[</span><span class="op" id="6380256">:</span><span class="builtinfunc" id="6380257">len</span><span class="op" id="6380260">(</span><span class="ident" id="6380261">s</span><span class="op" id="6380262">.</span><span class="ident" id="6380263">css</span><span class="op" id="6380266">)</span><span class="op" id="6380267">-</span><span class="num" id="6380268">1</span><span class="op" id="6380269">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380274">i</span><span class="op" id="6380275">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6380280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6380284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380287">s</span><span class="op" id="6380288">.</span><span class="ident" id="6380289">mu</span><span class="op" id="6380291">.</span><span class="ident" id="6380292">Unlock</span><span class="op" id="6380298">(</span><span class="op" id="6380299">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380303">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380380">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380454">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380467">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380471">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380540">dc</span><span class="op" id="6380542">,</span>&nbsp;<span class="ident" id="6380544">err</span>&nbsp;<span class="op" id="6380548">:=</span>&nbsp;<span class="ident" id="6380551">s</span><span class="op" id="6380552">.</span><span class="ident" id="6380553">db</span><span class="op" id="6380555">.</span><span class="ident" id="6380556">conn</span><span class="op" id="6380560">(</span><span class="op" id="6380561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380564">if</span>&nbsp;<span class="ident" id="6380567">err</span>&nbsp;<span class="op" id="6380571">!=</span>&nbsp;<span class="builtintype" id="6380574">nil</span>&nbsp;<span class="op" id="6380578">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380582">return</span>&nbsp;<span class="builtintype" id="6380589">nil</span><span class="op" id="6380592">,</span>&nbsp;<span class="builtintype" id="6380594">nil</span><span class="op" id="6380597">,</span>&nbsp;<span class="builtintype" id="6380599">nil</span><span class="op" id="6380602">,</span>&nbsp;<span class="ident" id="6380604">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6380609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380613">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380681">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380741">s</span><span class="op" id="6380742">.</span><span class="ident" id="6380743">mu</span><span class="op" id="6380745">.</span><span class="ident" id="6380746">Lock</span><span class="op" id="6380750">(</span><span class="op" id="6380751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380754">for</span>&nbsp;<span class="ident" id="6380758">_</span><span class="op" id="6380759">,</span>&nbsp;<span class="ident" id="6380761">v</span>&nbsp;<span class="op" id="6380763">:=</span>&nbsp;<span class="keyword" id="6380766">range</span>&nbsp;<span class="ident" id="6380772">s</span><span class="op" id="6380773">.</span><span class="ident" id="6380774">css</span>&nbsp;<span class="op" id="6380778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380782">if</span>&nbsp;<span class="ident" id="6380785">v</span><span class="op" id="6380786">.</span><span class="ident" id="6380787">dc</span>&nbsp;<span class="op" id="6380790">==</span>&nbsp;<span class="ident" id="6380793">dc</span>&nbsp;<span class="op" id="6380796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380801">s</span><span class="op" id="6380802">.</span><span class="ident" id="6380803">mu</span><span class="op" id="6380805">.</span><span class="ident" id="6380806">Unlock</span><span class="op" id="6380812">(</span><span class="op" id="6380813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380818">return</span>&nbsp;<span class="ident" id="6380825">dc</span><span class="op" id="6380827">,</span>&nbsp;<span class="ident" id="6380829">dc</span><span class="op" id="6380831">.</span><span class="ident" id="6380832">releaseConn</span><span class="op" id="6380843">,</span>&nbsp;<span class="ident" id="6380845">v</span><span class="op" id="6380846">.</span><span class="ident" id="6380847">si</span><span class="op" id="6380849">,</span>&nbsp;<span class="builtintype" id="6380851">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6380857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6380860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380863">s</span><span class="op" id="6380864">.</span><span class="ident" id="6380865">mu</span><span class="op" id="6380867">.</span><span class="ident" id="6380868">Unlock</span><span class="op" id="6380874">(</span><span class="op" id="6380875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6380879">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380944">dc</span><span class="op" id="6380946">.</span><span class="ident" id="6380947">Lock</span><span class="op" id="6380951">(</span><span class="op" id="6380952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380955">si</span><span class="op" id="6380957">,</span>&nbsp;<span class="ident" id="6380959">err</span>&nbsp;<span class="op" id="6380963">=</span>&nbsp;<span class="ident" id="6380965">dc</span><span class="op" id="6380967">.</span><span class="ident" id="6380968">prepareLocked</span><span class="op" id="6380981">(</span><span class="ident" id="6380982">s</span><span class="op" id="6380983">.</span><span class="ident" id="6380984">query</span><span class="op" id="6380989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380992">dc</span><span class="op" id="6380994">.</span><span class="ident" id="6380995">Unlock</span><span class="op" id="6381001">(</span><span class="op" id="6381002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381005">if</span>&nbsp;<span class="ident" id="6381008">err</span>&nbsp;<span class="op" id="6381012">!=</span>&nbsp;<span class="builtintype" id="6381015">nil</span>&nbsp;<span class="op" id="6381019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381023">s</span><span class="op" id="6381024">.</span><span class="ident" id="6381025">db</span><span class="op" id="6381027">.</span><span class="ident" id="6381028">putConn</span><span class="op" id="6381035">(</span><span class="ident" id="6381036">dc</span><span class="op" id="6381038">,</span>&nbsp;<span class="ident" id="6381040">err</span><span class="op" id="6381043">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381047">return</span>&nbsp;<span class="builtintype" id="6381054">nil</span><span class="op" id="6381057">,</span>&nbsp;<span class="builtintype" id="6381059">nil</span><span class="op" id="6381062">,</span>&nbsp;<span class="builtintype" id="6381064">nil</span><span class="op" id="6381067">,</span>&nbsp;<span class="ident" id="6381069">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381077">s</span><span class="op" id="6381078">.</span><span class="ident" id="6381079">mu</span><span class="op" id="6381081">.</span><span class="ident" id="6381082">Lock</span><span class="op" id="6381086">(</span><span class="op" id="6381087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381090">cs</span>&nbsp;<span class="op" id="6381093">:=</span>&nbsp;<span class="ident" id="6381096">connStmt</span><span class="op" id="6381104">{</span><span class="ident" id="6381105">dc</span><span class="op" id="6381107">,</span>&nbsp;<span class="ident" id="6381109">si</span><span class="op" id="6381111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381114">s</span><span class="op" id="6381115">.</span><span class="ident" id="6381116">css</span>&nbsp;<span class="op" id="6381120">=</span>&nbsp;<span class="builtinfunc" id="6381122">append</span><span class="op" id="6381128">(</span><span class="ident" id="6381129">s</span><span class="op" id="6381130">.</span><span class="ident" id="6381131">css</span><span class="op" id="6381134">,</span>&nbsp;<span class="ident" id="6381136">cs</span><span class="op" id="6381138">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381141">s</span><span class="op" id="6381142">.</span><span class="ident" id="6381143">mu</span><span class="op" id="6381145">.</span><span class="ident" id="6381146">Unlock</span><span class="op" id="6381152">(</span><span class="op" id="6381153">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381157">return</span>&nbsp;<span class="ident" id="6381164">dc</span><span class="op" id="6381166">,</span>&nbsp;<span class="ident" id="6381168">dc</span><span class="op" id="6381170">.</span><span class="ident" id="6381171">releaseConn</span><span class="op" id="6381182">,</span>&nbsp;<span class="ident" id="6381184">si</span><span class="op" id="6381186">,</span>&nbsp;<span class="builtintype" id="6381188">nil</span><br>
<span class="lineno"></span><span class="op" id="6381192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="6381195">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="6381265">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="6381310">func</span>&nbsp;<span class="op" id="6381315">(</span><span class="ident" id="6381316">s</span>&nbsp;<span class="op" id="6381318">*</span><span class="ident" id="6381319">Stmt</span><span class="op" id="6381323">)</span>&nbsp;<span class="ident" id="6381325">Query</span><span class="op" id="6381330">(</span><span class="ident" id="6381331">args</span>&nbsp;<span class="op" id="6381336">...</span><span class="keyword" id="6381339">interface</span><span class="op" id="6381348">{</span><span class="op" id="6381349">}</span><span class="op" id="6381350">)</span>&nbsp;<span class="op" id="6381352">(</span><span class="op" id="6381353">*</span><span class="ident" id="6381354">Rows</span><span class="op" id="6381358">,</span>&nbsp;<span class="builtintype" id="6381360">error</span><span class="op" id="6381365">)</span>&nbsp;<span class="op" id="6381367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381370">s</span><span class="op" id="6381371">.</span><span class="ident" id="6381372">closemu</span><span class="op" id="6381379">.</span><span class="ident" id="6381380">RLock</span><span class="op" id="6381385">(</span><span class="op" id="6381386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381389">defer</span>&nbsp;<span class="ident" id="6381395">s</span><span class="op" id="6381396">.</span><span class="ident" id="6381397">closemu</span><span class="op" id="6381404">.</span><span class="ident" id="6381405">RUnlock</span><span class="op" id="6381412">(</span><span class="op" id="6381413">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381417">var</span>&nbsp;<span class="ident" id="6381421">rowsi</span>&nbsp;<span class="ident" id="6381427">driver</span><span class="op" id="6381433">.</span><span class="ident" id="6381434">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381440">for</span>&nbsp;<span class="ident" id="6381444">i</span>&nbsp;<span class="op" id="6381446">:=</span>&nbsp;<span class="num" id="6381449">0</span><span class="op" id="6381450">;</span>&nbsp;<span class="ident" id="6381452">i</span>&nbsp;<span class="op" id="6381454">&lt;</span>&nbsp;<span class="ident" id="6381456">maxBadConnRetries</span><span class="op" id="6381473">;</span>&nbsp;<span class="ident" id="6381475">i</span><span class="op" id="6381476">++</span>&nbsp;<span class="op" id="6381479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381483">dc</span><span class="op" id="6381485">,</span>&nbsp;<span class="ident" id="6381487">releaseConn</span><span class="op" id="6381498">,</span>&nbsp;<span class="ident" id="6381500">si</span><span class="op" id="6381502">,</span>&nbsp;<span class="ident" id="6381504">err</span>&nbsp;<span class="op" id="6381508">:=</span>&nbsp;<span class="ident" id="6381511">s</span><span class="op" id="6381512">.</span><span class="ident" id="6381513">connStmt</span><span class="op" id="6381521">(</span><span class="op" id="6381522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381526">if</span>&nbsp;<span class="ident" id="6381529">err</span>&nbsp;<span class="op" id="6381533">!=</span>&nbsp;<span class="builtintype" id="6381536">nil</span>&nbsp;<span class="op" id="6381540">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381545">if</span>&nbsp;<span class="ident" id="6381548">err</span>&nbsp;<span class="op" id="6381552">==</span>&nbsp;<span class="ident" id="6381555">driver</span><span class="op" id="6381561">.</span><span class="ident" id="6381562">ErrBadConn</span>&nbsp;<span class="op" id="6381573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381579">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381596">return</span>&nbsp;<span class="builtintype" id="6381603">nil</span><span class="op" id="6381606">,</span>&nbsp;<span class="ident" id="6381608">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381614">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381619">rowsi</span><span class="op" id="6381624">,</span>&nbsp;<span class="ident" id="6381626">err</span>&nbsp;<span class="op" id="6381630">=</span>&nbsp;<span class="ident" id="6381632">rowsiFromStatement</span><span class="op" id="6381650">(</span><span class="ident" id="6381651">driverStmt</span><span class="op" id="6381661">{</span><span class="ident" id="6381662">dc</span><span class="op" id="6381664">,</span>&nbsp;<span class="ident" id="6381666">si</span><span class="op" id="6381668">}</span><span class="op" id="6381669">,</span>&nbsp;<span class="ident" id="6381671">args</span><span class="op" id="6381675">...</span><span class="op" id="6381678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381682">if</span>&nbsp;<span class="ident" id="6381685">err</span>&nbsp;<span class="op" id="6381689">==</span>&nbsp;<span class="builtintype" id="6381692">nil</span>&nbsp;<span class="op" id="6381696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6381701">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6381762">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381786">rows</span>&nbsp;<span class="op" id="6381791">:=</span>&nbsp;<span class="op" id="6381794">&amp;</span><span class="ident" id="6381795">Rows</span><span class="op" id="6381799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381805">dc</span><span class="op" id="6381807">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381812">dc</span><span class="op" id="6381814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381820">rowsi</span><span class="op" id="6381825">:</span>&nbsp;<span class="ident" id="6381827">rowsi</span><span class="op" id="6381832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6381838">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381866">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381871">s</span><span class="op" id="6381872">.</span><span class="ident" id="6381873">db</span><span class="op" id="6381875">.</span><span class="ident" id="6381876">addDep</span><span class="op" id="6381882">(</span><span class="ident" id="6381883">s</span><span class="op" id="6381884">,</span>&nbsp;<span class="ident" id="6381886">rows</span><span class="op" id="6381890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381895">rows</span><span class="op" id="6381899">.</span><span class="ident" id="6381900">releaseConn</span>&nbsp;<span class="op" id="6381912">=</span>&nbsp;<span class="keyword" id="6381914">func</span><span class="op" id="6381918">(</span><span class="ident" id="6381919">err</span>&nbsp;<span class="builtintype" id="6381923">error</span><span class="op" id="6381928">)</span>&nbsp;<span class="op" id="6381930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381936">releaseConn</span><span class="op" id="6381947">(</span><span class="ident" id="6381948">err</span><span class="op" id="6381951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381957">s</span><span class="op" id="6381958">.</span><span class="ident" id="6381959">db</span><span class="op" id="6381961">.</span><span class="ident" id="6381962">removeDep</span><span class="op" id="6381971">(</span><span class="ident" id="6381972">s</span><span class="op" id="6381973">,</span>&nbsp;<span class="ident" id="6381975">rows</span><span class="op" id="6381979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381984">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381989">return</span>&nbsp;<span class="ident" id="6381996">rows</span><span class="op" id="6382000">,</span>&nbsp;<span class="builtintype" id="6382002">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382013">releaseConn</span><span class="op" id="6382024">(</span><span class="ident" id="6382025">err</span><span class="op" id="6382028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382032">if</span>&nbsp;<span class="ident" id="6382035">err</span>&nbsp;<span class="op" id="6382039">!=</span>&nbsp;<span class="ident" id="6382042">driver</span><span class="op" id="6382048">.</span><span class="ident" id="6382049">ErrBadConn</span>&nbsp;<span class="op" id="6382060">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382065">return</span>&nbsp;<span class="builtintype" id="6382072">nil</span><span class="op" id="6382075">,</span>&nbsp;<span class="ident" id="6382077">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382089">return</span>&nbsp;<span class="builtintype" id="6382096">nil</span><span class="op" id="6382099">,</span>&nbsp;<span class="ident" id="6382101">driver</span><span class="op" id="6382107">.</span><span class="ident" id="6382108">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6382119">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="6382122">func</span>&nbsp;<span class="ident" id="6382127">rowsiFromStatement</span><span class="op" id="6382145">(</span><span class="ident" id="6382146">ds</span>&nbsp;<span class="ident" id="6382149">driverStmt</span><span class="op" id="6382159">,</span>&nbsp;<span class="ident" id="6382161">args</span>&nbsp;<span class="op" id="6382166">...</span><span class="keyword" id="6382169">interface</span><span class="op" id="6382178">{</span><span class="op" id="6382179">}</span><span class="op" id="6382180">)</span>&nbsp;<span class="op" id="6382182">(</span><span class="ident" id="6382183">driver</span><span class="op" id="6382189">.</span><span class="ident" id="6382190">Rows</span><span class="op" id="6382194">,</span>&nbsp;<span class="builtintype" id="6382196">error</span><span class="op" id="6382201">)</span>&nbsp;<span class="op" id="6382203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382206">ds</span><span class="op" id="6382208">.</span><span class="ident" id="6382209">Lock</span><span class="op" id="6382213">(</span><span class="op" id="6382214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382217">want</span>&nbsp;<span class="op" id="6382222">:=</span>&nbsp;<span class="ident" id="6382225">ds</span><span class="op" id="6382227">.</span><span class="ident" id="6382228">si</span><span class="op" id="6382230">.</span><span class="ident" id="6382231">NumInput</span><span class="op" id="6382239">(</span><span class="op" id="6382240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382243">ds</span><span class="op" id="6382245">.</span><span class="ident" id="6382246">Unlock</span><span class="op" id="6382252">(</span><span class="op" id="6382253">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382257">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382321">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382395">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382424">if</span>&nbsp;<span class="ident" id="6382427">want</span>&nbsp;<span class="op" id="6382432">!=</span>&nbsp;<span class="op" id="6382435">-</span><span class="num" id="6382436">1</span>&nbsp;<span class="op" id="6382438">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6382441">len</span><span class="op" id="6382444">(</span><span class="ident" id="6382445">args</span><span class="op" id="6382449">)</span>&nbsp;<span class="op" id="6382451">!=</span>&nbsp;<span class="ident" id="6382454">want</span>&nbsp;<span class="op" id="6382459">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382463">return</span>&nbsp;<span class="builtintype" id="6382470">nil</span><span class="op" id="6382473">,</span>&nbsp;<span class="ident" id="6382475">fmt</span><span class="op" id="6382478">.</span><span class="ident" id="6382479">Errorf</span><span class="op" id="6382485">(</span><span class="string" id="6382486">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6382528">,</span>&nbsp;<span class="ident" id="6382530">want</span><span class="op" id="6382534">,</span>&nbsp;<span class="builtinfunc" id="6382536">len</span><span class="op" id="6382539">(</span><span class="ident" id="6382540">args</span><span class="op" id="6382544">)</span><span class="op" id="6382545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382552">dargs</span><span class="op" id="6382557">,</span>&nbsp;<span class="ident" id="6382559">err</span>&nbsp;<span class="op" id="6382563">:=</span>&nbsp;<span class="ident" id="6382566">driverArgs</span><span class="op" id="6382576">(</span><span class="op" id="6382577">&amp;</span><span class="ident" id="6382578">ds</span><span class="op" id="6382580">,</span>&nbsp;<span class="ident" id="6382582">args</span><span class="op" id="6382586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382589">if</span>&nbsp;<span class="ident" id="6382592">err</span>&nbsp;<span class="op" id="6382596">!=</span>&nbsp;<span class="builtintype" id="6382599">nil</span>&nbsp;<span class="op" id="6382603">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382607">return</span>&nbsp;<span class="builtintype" id="6382614">nil</span><span class="op" id="6382617">,</span>&nbsp;<span class="ident" id="6382619">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382628">ds</span><span class="op" id="6382630">.</span><span class="ident" id="6382631">Lock</span><span class="op" id="6382635">(</span><span class="op" id="6382636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382639">rowsi</span><span class="op" id="6382644">,</span>&nbsp;<span class="ident" id="6382646">err</span>&nbsp;<span class="op" id="6382650">:=</span>&nbsp;<span class="ident" id="6382653">ds</span><span class="op" id="6382655">.</span><span class="ident" id="6382656">si</span><span class="op" id="6382658">.</span><span class="ident" id="6382659">Query</span><span class="op" id="6382664">(</span><span class="ident" id="6382665">dargs</span><span class="op" id="6382670">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382673">ds</span><span class="op" id="6382675">.</span><span class="ident" id="6382676">Unlock</span><span class="op" id="6382682">(</span><span class="op" id="6382683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382686">if</span>&nbsp;<span class="ident" id="6382689">err</span>&nbsp;<span class="op" id="6382693">!=</span>&nbsp;<span class="builtintype" id="6382696">nil</span>&nbsp;<span class="op" id="6382700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382704">return</span>&nbsp;<span class="builtintype" id="6382711">nil</span><span class="op" id="6382714">,</span>&nbsp;<span class="ident" id="6382716">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382724">return</span>&nbsp;<span class="ident" id="6382731">rowsi</span><span class="op" id="6382736">,</span>&nbsp;<span class="builtintype" id="6382738">nil</span><br>
<span class="lineno">1495</span><span class="op" id="6382742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6382745">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="6382819">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6382896">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="6382976">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="6383048">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="6383120">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="6383133">//</span><br>
<span class="lineno"></span><span class="comment" id="6383136">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="6383154">//</span><br>
<span class="lineno"></span><span class="comment" id="6383157">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6383177">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="6383230">func</span>&nbsp;<span class="op" id="6383235">(</span><span class="ident" id="6383236">s</span>&nbsp;<span class="op" id="6383238">*</span><span class="ident" id="6383239">Stmt</span><span class="op" id="6383243">)</span>&nbsp;<span class="ident" id="6383245">QueryRow</span><span class="op" id="6383253">(</span><span class="ident" id="6383254">args</span>&nbsp;<span class="op" id="6383259">...</span><span class="keyword" id="6383262">interface</span><span class="op" id="6383271">{</span><span class="op" id="6383272">}</span><span class="op" id="6383273">)</span>&nbsp;<span class="op" id="6383275">*</span><span class="ident" id="6383276">Row</span>&nbsp;<span class="op" id="6383280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383283">rows</span><span class="op" id="6383287">,</span>&nbsp;<span class="ident" id="6383289">err</span>&nbsp;<span class="op" id="6383293">:=</span>&nbsp;<span class="ident" id="6383296">s</span><span class="op" id="6383297">.</span><span class="ident" id="6383298">Query</span><span class="op" id="6383303">(</span><span class="ident" id="6383304">args</span><span class="op" id="6383308">...</span><span class="op" id="6383311">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383314">if</span>&nbsp;<span class="ident" id="6383317">err</span>&nbsp;<span class="op" id="6383321">!=</span>&nbsp;<span class="builtintype" id="6383324">nil</span>&nbsp;<span class="op" id="6383328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383332">return</span>&nbsp;<span class="op" id="6383339">&amp;</span><span class="ident" id="6383340">Row</span><span class="op" id="6383343">{</span><span class="ident" id="6383344">err</span><span class="op" id="6383347">:</span>&nbsp;<span class="ident" id="6383349">err</span><span class="op" id="6383352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383358">return</span>&nbsp;<span class="op" id="6383365">&amp;</span><span class="ident" id="6383366">Row</span><span class="op" id="6383369">{</span><span class="ident" id="6383370">rows</span><span class="op" id="6383374">:</span>&nbsp;<span class="ident" id="6383376">rows</span><span class="op" id="6383380">}</span><br>
<span class="lineno"></span><span class="op" id="6383382">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="6383385">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6383416">func</span>&nbsp;<span class="op" id="6383421">(</span><span class="ident" id="6383422">s</span>&nbsp;<span class="op" id="6383424">*</span><span class="ident" id="6383425">Stmt</span><span class="op" id="6383429">)</span>&nbsp;<span class="ident" id="6383431">Close</span><span class="op" id="6383436">(</span><span class="op" id="6383437">)</span>&nbsp;<span class="builtintype" id="6383439">error</span>&nbsp;<span class="op" id="6383445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383448">s</span><span class="op" id="6383449">.</span><span class="ident" id="6383450">closemu</span><span class="op" id="6383457">.</span><span class="ident" id="6383458">Lock</span><span class="op" id="6383462">(</span><span class="op" id="6383463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383466">defer</span>&nbsp;<span class="ident" id="6383472">s</span><span class="op" id="6383473">.</span><span class="ident" id="6383474">closemu</span><span class="op" id="6383481">.</span><span class="ident" id="6383482">Unlock</span><span class="op" id="6383488">(</span><span class="op" id="6383489">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383493">if</span>&nbsp;<span class="ident" id="6383496">s</span><span class="op" id="6383497">.</span><span class="ident" id="6383498">stickyErr</span>&nbsp;<span class="op" id="6383508">!=</span>&nbsp;<span class="builtintype" id="6383511">nil</span>&nbsp;<span class="op" id="6383515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383519">return</span>&nbsp;<span class="ident" id="6383526">s</span><span class="op" id="6383527">.</span><span class="ident" id="6383528">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383542">s</span><span class="op" id="6383543">.</span><span class="ident" id="6383544">mu</span><span class="op" id="6383546">.</span><span class="ident" id="6383547">Lock</span><span class="op" id="6383551">(</span><span class="op" id="6383552">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383555">if</span>&nbsp;<span class="ident" id="6383558">s</span><span class="op" id="6383559">.</span><span class="ident" id="6383560">closed</span>&nbsp;<span class="op" id="6383567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383571">s</span><span class="op" id="6383572">.</span><span class="ident" id="6383573">mu</span><span class="op" id="6383575">.</span><span class="ident" id="6383576">Unlock</span><span class="op" id="6383582">(</span><span class="op" id="6383583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383587">return</span>&nbsp;<span class="builtintype" id="6383594">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383602">s</span><span class="op" id="6383603">.</span><span class="ident" id="6383604">closed</span>&nbsp;<span class="op" id="6383611">=</span>&nbsp;<span class="builtintype" id="6383613">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383620">if</span>&nbsp;<span class="ident" id="6383623">s</span><span class="op" id="6383624">.</span><span class="ident" id="6383625">tx</span>&nbsp;<span class="op" id="6383628">!=</span>&nbsp;<span class="builtintype" id="6383631">nil</span>&nbsp;<span class="op" id="6383635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383639">s</span><span class="op" id="6383640">.</span><span class="ident" id="6383641">txsi</span><span class="op" id="6383645">.</span><span class="ident" id="6383646">Close</span><span class="op" id="6383651">(</span><span class="op" id="6383652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383656">s</span><span class="op" id="6383657">.</span><span class="ident" id="6383658">mu</span><span class="op" id="6383660">.</span><span class="ident" id="6383661">Unlock</span><span class="op" id="6383667">(</span><span class="op" id="6383668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383672">return</span>&nbsp;<span class="builtintype" id="6383679">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383687">s</span><span class="op" id="6383688">.</span><span class="ident" id="6383689">mu</span><span class="op" id="6383691">.</span><span class="ident" id="6383692">Unlock</span><span class="op" id="6383698">(</span><span class="op" id="6383699">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383703">return</span>&nbsp;<span class="ident" id="6383710">s</span><span class="op" id="6383711">.</span><span class="ident" id="6383712">db</span><span class="op" id="6383714">.</span><span class="ident" id="6383715">removeDep</span><span class="op" id="6383724">(</span><span class="ident" id="6383725">s</span><span class="op" id="6383726">,</span>&nbsp;<span class="ident" id="6383728">s</span><span class="op" id="6383729">)</span><br>
<span class="lineno"></span><span class="op" id="6383731">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="6383734">func</span>&nbsp;<span class="op" id="6383739">(</span><span class="ident" id="6383740">s</span>&nbsp;<span class="op" id="6383742">*</span><span class="ident" id="6383743">Stmt</span><span class="op" id="6383747">)</span>&nbsp;<span class="ident" id="6383749">finalClose</span><span class="op" id="6383759">(</span><span class="op" id="6383760">)</span>&nbsp;<span class="builtintype" id="6383762">error</span>&nbsp;<span class="op" id="6383768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383771">s</span><span class="op" id="6383772">.</span><span class="ident" id="6383773">mu</span><span class="op" id="6383775">.</span><span class="ident" id="6383776">Lock</span><span class="op" id="6383780">(</span><span class="op" id="6383781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383784">defer</span>&nbsp;<span class="ident" id="6383790">s</span><span class="op" id="6383791">.</span><span class="ident" id="6383792">mu</span><span class="op" id="6383794">.</span><span class="ident" id="6383795">Unlock</span><span class="op" id="6383801">(</span><span class="op" id="6383802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383805">if</span>&nbsp;<span class="ident" id="6383808">s</span><span class="op" id="6383809">.</span><span class="ident" id="6383810">css</span>&nbsp;<span class="op" id="6383814">!=</span>&nbsp;<span class="builtintype" id="6383817">nil</span>&nbsp;<span class="op" id="6383821">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383825">for</span>&nbsp;<span class="ident" id="6383829">_</span><span class="op" id="6383830">,</span>&nbsp;<span class="ident" id="6383832">v</span>&nbsp;<span class="op" id="6383834">:=</span>&nbsp;<span class="keyword" id="6383837">range</span>&nbsp;<span class="ident" id="6383843">s</span><span class="op" id="6383844">.</span><span class="ident" id="6383845">css</span>&nbsp;<span class="op" id="6383849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383854">s</span><span class="op" id="6383855">.</span><span class="ident" id="6383856">db</span><span class="op" id="6383858">.</span><span class="ident" id="6383859">noteUnusedDriverStatement</span><span class="op" id="6383884">(</span><span class="ident" id="6383885">v</span><span class="op" id="6383886">.</span><span class="ident" id="6383887">dc</span><span class="op" id="6383889">,</span>&nbsp;<span class="ident" id="6383891">v</span><span class="op" id="6383892">.</span><span class="ident" id="6383893">si</span><span class="op" id="6383895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383900">v</span><span class="op" id="6383901">.</span><span class="ident" id="6383902">dc</span><span class="op" id="6383904">.</span><span class="ident" id="6383905">removeOpenStmt</span><span class="op" id="6383919">(</span><span class="ident" id="6383920">v</span><span class="op" id="6383921">.</span><span class="ident" id="6383922">si</span><span class="op" id="6383924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383932">s</span><span class="op" id="6383933">.</span><span class="ident" id="6383934">css</span>&nbsp;<span class="op" id="6383938">=</span>&nbsp;<span class="builtintype" id="6383940">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383948">return</span>&nbsp;<span class="builtintype" id="6383955">nil</span><br>
<span class="lineno"></span><span class="op" id="6383959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6383962">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="6384035">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="6384095">//</span><br>
<span class="lineno"></span><span class="comment" id="6384098">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6384141">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6384152">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="6384178">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6384203">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="6384225">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6384252">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="6384291">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="6384306">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6384315">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="6384385">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="6384396">type</span>&nbsp;<span class="ident" id="6384401">Rows</span>&nbsp;<span class="keyword" id="6384406">struct</span>&nbsp;<span class="op" id="6384413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384416">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6384428">*</span><span class="ident" id="6384429">driverConn</span>&nbsp;<span class="comment" id="6384440">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384496">releaseConn</span>&nbsp;<span class="keyword" id="6384508">func</span><span class="op" id="6384512">(</span><span class="builtintype" id="6384513">error</span><span class="op" id="6384518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384521">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384533">driver</span><span class="op" id="6384539">.</span><span class="ident" id="6384540">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384547">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6384557">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384563">lastcols</span>&nbsp;&nbsp;<span class="op" id="6384573">[</span><span class="op" id="6384574">]</span><span class="ident" id="6384575">driver</span><span class="op" id="6384581">.</span><span class="ident" id="6384582">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384589">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6384599">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6384611">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384646">closeStmt</span>&nbsp;<span class="ident" id="6384656">driver</span><span class="op" id="6384662">.</span><span class="ident" id="6384663">Stmt</span>&nbsp;<span class="comment" id="6384668">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="6384711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6384714">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="6384789">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6384869">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="6384949">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="6384967">//</span><br>
<span class="lineno"></span><span class="comment" id="6384970">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="6385049">func</span>&nbsp;<span class="op" id="6385054">(</span><span class="ident" id="6385055">rs</span>&nbsp;<span class="op" id="6385058">*</span><span class="ident" id="6385059">Rows</span><span class="op" id="6385063">)</span>&nbsp;<span class="ident" id="6385065">Next</span><span class="op" id="6385069">(</span><span class="op" id="6385070">)</span>&nbsp;<span class="builtintype" id="6385072">bool</span>&nbsp;<span class="op" id="6385077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385080">if</span>&nbsp;<span class="ident" id="6385083">rs</span><span class="op" id="6385085">.</span><span class="ident" id="6385086">closed</span>&nbsp;<span class="op" id="6385093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385097">return</span>&nbsp;<span class="builtintype" id="6385104">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385114">if</span>&nbsp;<span class="ident" id="6385117">rs</span><span class="op" id="6385119">.</span><span class="ident" id="6385120">lastcols</span>&nbsp;<span class="op" id="6385129">==</span>&nbsp;<span class="builtintype" id="6385132">nil</span>&nbsp;<span class="op" id="6385136">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385140">rs</span><span class="op" id="6385142">.</span><span class="ident" id="6385143">lastcols</span>&nbsp;<span class="op" id="6385152">=</span>&nbsp;<span class="builtinfunc" id="6385154">make</span><span class="op" id="6385158">(</span><span class="op" id="6385159">[</span><span class="op" id="6385160">]</span><span class="ident" id="6385161">driver</span><span class="op" id="6385167">.</span><span class="ident" id="6385168">Value</span><span class="op" id="6385173">,</span>&nbsp;<span class="builtinfunc" id="6385175">len</span><span class="op" id="6385178">(</span><span class="ident" id="6385179">rs</span><span class="op" id="6385181">.</span><span class="ident" id="6385182">rowsi</span><span class="op" id="6385187">.</span><span class="ident" id="6385188">Columns</span><span class="op" id="6385195">(</span><span class="op" id="6385196">)</span><span class="op" id="6385197">)</span><span class="op" id="6385198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385204">rs</span><span class="op" id="6385206">.</span><span class="ident" id="6385207">lasterr</span>&nbsp;<span class="op" id="6385215">=</span>&nbsp;<span class="ident" id="6385217">rs</span><span class="op" id="6385219">.</span><span class="ident" id="6385220">rowsi</span><span class="op" id="6385225">.</span><span class="ident" id="6385226">Next</span><span class="op" id="6385230">(</span><span class="ident" id="6385231">rs</span><span class="op" id="6385233">.</span><span class="ident" id="6385234">lastcols</span><span class="op" id="6385242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385245">if</span>&nbsp;<span class="ident" id="6385248">rs</span><span class="op" id="6385250">.</span><span class="ident" id="6385251">lasterr</span>&nbsp;<span class="op" id="6385259">!=</span>&nbsp;<span class="builtintype" id="6385262">nil</span>&nbsp;<span class="op" id="6385266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385270">rs</span><span class="op" id="6385272">.</span><span class="ident" id="6385273">Close</span><span class="op" id="6385278">(</span><span class="op" id="6385279">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385283">return</span>&nbsp;<span class="builtintype" id="6385290">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385300">return</span>&nbsp;<span class="builtintype" id="6385307">true</span><br>
<span class="lineno"></span><span class="op" id="6385312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="6385315">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="6385388">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6385446">func</span>&nbsp;<span class="op" id="6385451">(</span><span class="ident" id="6385452">rs</span>&nbsp;<span class="op" id="6385455">*</span><span class="ident" id="6385456">Rows</span><span class="op" id="6385460">)</span>&nbsp;<span class="ident" id="6385462">Err</span><span class="op" id="6385465">(</span><span class="op" id="6385466">)</span>&nbsp;<span class="builtintype" id="6385468">error</span>&nbsp;<span class="op" id="6385474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385477">if</span>&nbsp;<span class="ident" id="6385480">rs</span><span class="op" id="6385482">.</span><span class="ident" id="6385483">lasterr</span>&nbsp;<span class="op" id="6385491">==</span>&nbsp;<span class="ident" id="6385494">io</span><span class="op" id="6385496">.</span><span class="ident" id="6385497">EOF</span>&nbsp;<span class="op" id="6385501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385505">return</span>&nbsp;<span class="builtintype" id="6385512">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385520">return</span>&nbsp;<span class="ident" id="6385527">rs</span><span class="op" id="6385529">.</span><span class="ident" id="6385530">lasterr</span><br>
<span class="lineno"></span><span class="op" id="6385538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6385541">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="6385578">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="6385645">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6385698">func</span>&nbsp;<span class="op" id="6385703">(</span><span class="ident" id="6385704">rs</span>&nbsp;<span class="op" id="6385707">*</span><span class="ident" id="6385708">Rows</span><span class="op" id="6385712">)</span>&nbsp;<span class="ident" id="6385714">Columns</span><span class="op" id="6385721">(</span><span class="op" id="6385722">)</span>&nbsp;<span class="op" id="6385724">(</span><span class="op" id="6385725">[</span><span class="op" id="6385726">]</span><span class="builtintype" id="6385727">string</span><span class="op" id="6385733">,</span>&nbsp;<span class="builtintype" id="6385735">error</span><span class="op" id="6385740">)</span>&nbsp;<span class="op" id="6385742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385745">if</span>&nbsp;<span class="ident" id="6385748">rs</span><span class="op" id="6385750">.</span><span class="ident" id="6385751">closed</span>&nbsp;<span class="op" id="6385758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385762">return</span>&nbsp;<span class="builtintype" id="6385769">nil</span><span class="op" id="6385772">,</span>&nbsp;<span class="ident" id="6385774">errors</span><span class="op" id="6385780">.</span><span class="ident" id="6385781">New</span><span class="op" id="6385784">(</span><span class="string" id="6385785">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6385807">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385813">if</span>&nbsp;<span class="ident" id="6385816">rs</span><span class="op" id="6385818">.</span><span class="ident" id="6385819">rowsi</span>&nbsp;<span class="op" id="6385825">==</span>&nbsp;<span class="builtintype" id="6385828">nil</span>&nbsp;<span class="op" id="6385832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385836">return</span>&nbsp;<span class="builtintype" id="6385843">nil</span><span class="op" id="6385846">,</span>&nbsp;<span class="ident" id="6385848">errors</span><span class="op" id="6385854">.</span><span class="ident" id="6385855">New</span><span class="op" id="6385858">(</span><span class="string" id="6385859">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="6385883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385889">return</span>&nbsp;<span class="ident" id="6385896">rs</span><span class="op" id="6385898">.</span><span class="ident" id="6385899">rowsi</span><span class="op" id="6385904">.</span><span class="ident" id="6385905">Columns</span><span class="op" id="6385912">(</span><span class="op" id="6385913">)</span><span class="op" id="6385914">,</span>&nbsp;<span class="builtintype" id="6385916">nil</span><br>
<span class="lineno">1620</span><span class="op" id="6385920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6385923">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="6385993">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="6386008">//</span><br>
<span class="lineno">1625</span><span class="comment" id="6386011">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="6386082">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="6386152">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="6386223">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6386291">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="6386332">//</span><br>
<span class="lineno"></span><span class="comment" id="6386335">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6386398">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6386468">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="6386537">func</span>&nbsp;<span class="op" id="6386542">(</span><span class="ident" id="6386543">rs</span>&nbsp;<span class="op" id="6386546">*</span><span class="ident" id="6386547">Rows</span><span class="op" id="6386551">)</span>&nbsp;<span class="ident" id="6386553">Scan</span><span class="op" id="6386557">(</span><span class="ident" id="6386558">dest</span>&nbsp;<span class="op" id="6386563">...</span><span class="keyword" id="6386566">interface</span><span class="op" id="6386575">{</span><span class="op" id="6386576">}</span><span class="op" id="6386577">)</span>&nbsp;<span class="builtintype" id="6386579">error</span>&nbsp;<span class="op" id="6386585">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386588">if</span>&nbsp;<span class="ident" id="6386591">rs</span><span class="op" id="6386593">.</span><span class="ident" id="6386594">closed</span>&nbsp;<span class="op" id="6386601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386605">return</span>&nbsp;<span class="ident" id="6386612">errors</span><span class="op" id="6386618">.</span><span class="ident" id="6386619">New</span><span class="op" id="6386622">(</span><span class="string" id="6386623">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6386645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6386648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386651">if</span>&nbsp;<span class="ident" id="6386654">rs</span><span class="op" id="6386656">.</span><span class="ident" id="6386657">lastcols</span>&nbsp;<span class="op" id="6386666">==</span>&nbsp;<span class="builtintype" id="6386669">nil</span>&nbsp;<span class="op" id="6386673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386677">return</span>&nbsp;<span class="ident" id="6386684">errors</span><span class="op" id="6386690">.</span><span class="ident" id="6386691">New</span><span class="op" id="6386694">(</span><span class="string" id="6386695">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="6386734">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6386737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386740">if</span>&nbsp;<span class="builtinfunc" id="6386743">len</span><span class="op" id="6386746">(</span><span class="ident" id="6386747">dest</span><span class="op" id="6386751">)</span>&nbsp;<span class="op" id="6386753">!=</span>&nbsp;<span class="builtinfunc" id="6386756">len</span><span class="op" id="6386759">(</span><span class="ident" id="6386760">rs</span><span class="op" id="6386762">.</span><span class="ident" id="6386763">lastcols</span><span class="op" id="6386771">)</span>&nbsp;<span class="op" id="6386773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386777">return</span>&nbsp;<span class="ident" id="6386784">fmt</span><span class="op" id="6386787">.</span><span class="ident" id="6386788">Errorf</span><span class="op" id="6386794">(</span><span class="string" id="6386795">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="6386851">,</span>&nbsp;<span class="builtinfunc" id="6386853">len</span><span class="op" id="6386856">(</span><span class="ident" id="6386857">rs</span><span class="op" id="6386859">.</span><span class="ident" id="6386860">lastcols</span><span class="op" id="6386868">)</span><span class="op" id="6386869">,</span>&nbsp;<span class="builtinfunc" id="6386871">len</span><span class="op" id="6386874">(</span><span class="ident" id="6386875">dest</span><span class="op" id="6386879">)</span><span class="op" id="6386880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6386883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386886">for</span>&nbsp;<span class="ident" id="6386890">i</span><span class="op" id="6386891">,</span>&nbsp;<span class="ident" id="6386893">sv</span>&nbsp;<span class="op" id="6386896">:=</span>&nbsp;<span class="keyword" id="6386899">range</span>&nbsp;<span class="ident" id="6386905">rs</span><span class="op" id="6386907">.</span><span class="ident" id="6386908">lastcols</span>&nbsp;<span class="op" id="6386917">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6386921">err</span>&nbsp;<span class="op" id="6386925">:=</span>&nbsp;<span class="ident" id="6386928">convertAssign</span><span class="op" id="6386941">(</span><span class="ident" id="6386942">dest</span><span class="op" id="6386946">[</span><span class="ident" id="6386947">i</span><span class="op" id="6386948">]</span><span class="op" id="6386949">,</span>&nbsp;<span class="ident" id="6386951">sv</span><span class="op" id="6386953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386957">if</span>&nbsp;<span class="ident" id="6386960">err</span>&nbsp;<span class="op" id="6386964">!=</span>&nbsp;<span class="builtintype" id="6386967">nil</span>&nbsp;<span class="op" id="6386971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6386976">return</span>&nbsp;<span class="ident" id="6386983">fmt</span><span class="op" id="6386986">.</span><span class="ident" id="6386987">Errorf</span><span class="op" id="6386993">(</span><span class="string" id="6386994">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6387034">,</span>&nbsp;<span class="ident" id="6387036">i</span><span class="op" id="6387037">,</span>&nbsp;<span class="ident" id="6387039">err</span><span class="op" id="6387042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6387046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6387049">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6387052">return</span>&nbsp;<span class="builtintype" id="6387059">nil</span><br>
<span class="lineno"></span><span class="op" id="6387063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6387066">var</span>&nbsp;<span class="ident" id="6387070">rowsCloseHook</span>&nbsp;<span class="keyword" id="6387084">func</span><span class="op" id="6387088">(</span><span class="op" id="6387089">*</span><span class="ident" id="6387090">Rows</span><span class="op" id="6387094">,</span>&nbsp;<span class="op" id="6387096">*</span><span class="builtintype" id="6387097">error</span><span class="op" id="6387102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="6387105">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6387179">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6387256">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="6387333">func</span>&nbsp;<span class="op" id="6387338">(</span><span class="ident" id="6387339">rs</span>&nbsp;<span class="op" id="6387342">*</span><span class="ident" id="6387343">Rows</span><span class="op" id="6387347">)</span>&nbsp;<span class="ident" id="6387349">Close</span><span class="op" id="6387354">(</span><span class="op" id="6387355">)</span>&nbsp;<span class="builtintype" id="6387357">error</span>&nbsp;<span class="op" id="6387363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6387366">if</span>&nbsp;<span class="ident" id="6387369">rs</span><span class="op" id="6387371">.</span><span class="ident" id="6387372">closed</span>&nbsp;<span class="op" id="6387379">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6387383">return</span>&nbsp;<span class="builtintype" id="6387390">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6387395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387398">rs</span><span class="op" id="6387400">.</span><span class="ident" id="6387401">closed</span>&nbsp;<span class="op" id="6387408">=</span>&nbsp;<span class="builtintype" id="6387410">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387416">err</span>&nbsp;<span class="op" id="6387420">:=</span>&nbsp;<span class="ident" id="6387423">rs</span><span class="op" id="6387425">.</span><span class="ident" id="6387426">rowsi</span><span class="op" id="6387431">.</span><span class="ident" id="6387432">Close</span><span class="op" id="6387437">(</span><span class="op" id="6387438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6387441">if</span>&nbsp;<span class="ident" id="6387444">fn</span>&nbsp;<span class="op" id="6387447">:=</span>&nbsp;<span class="ident" id="6387450">rowsCloseHook</span><span class="op" id="6387463">;</span>&nbsp;<span class="ident" id="6387465">fn</span>&nbsp;<span class="op" id="6387468">!=</span>&nbsp;<span class="builtintype" id="6387471">nil</span>&nbsp;<span class="op" id="6387475">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387479">fn</span><span class="op" id="6387481">(</span><span class="ident" id="6387482">rs</span><span class="op" id="6387484">,</span>&nbsp;<span class="op" id="6387486">&amp;</span><span class="ident" id="6387487">err</span><span class="op" id="6387490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6387493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6387496">if</span>&nbsp;<span class="ident" id="6387499">rs</span><span class="op" id="6387501">.</span><span class="ident" id="6387502">closeStmt</span>&nbsp;<span class="op" id="6387512">!=</span>&nbsp;<span class="builtintype" id="6387515">nil</span>&nbsp;<span class="op" id="6387519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387523">rs</span><span class="op" id="6387525">.</span><span class="ident" id="6387526">closeStmt</span><span class="op" id="6387535">.</span><span class="ident" id="6387536">Close</span><span class="op" id="6387541">(</span><span class="op" id="6387542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6387545">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387548">rs</span><span class="op" id="6387550">.</span><span class="ident" id="6387551">releaseConn</span><span class="op" id="6387562">(</span><span class="ident" id="6387563">err</span><span class="op" id="6387566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6387569">return</span>&nbsp;<span class="ident" id="6387576">err</span><br>
<span class="lineno"></span><span class="op" id="6387580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6387583">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="6387648">type</span>&nbsp;<span class="ident" id="6387653">Row</span>&nbsp;<span class="keyword" id="6387657">struct</span>&nbsp;<span class="op" id="6387664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6387667">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387705">err</span>&nbsp;&nbsp;<span class="builtintype" id="6387710">error</span>&nbsp;<span class="comment" id="6387716">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6387753">rows</span>&nbsp;<span class="op" id="6387758">*</span><span class="ident" id="6387759">Rows</span><br>
<span class="lineno"></span><span class="op" id="6387764">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="6387767">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="6387831">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="6387895">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="6387964">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="6388002">func</span>&nbsp;<span class="op" id="6388007">(</span><span class="ident" id="6388008">r</span>&nbsp;<span class="op" id="6388010">*</span><span class="ident" id="6388011">Row</span><span class="op" id="6388014">)</span>&nbsp;<span class="ident" id="6388016">Scan</span><span class="op" id="6388020">(</span><span class="ident" id="6388021">dest</span>&nbsp;<span class="op" id="6388026">...</span><span class="keyword" id="6388029">interface</span><span class="op" id="6388038">{</span><span class="op" id="6388039">}</span><span class="op" id="6388040">)</span>&nbsp;<span class="builtintype" id="6388042">error</span>&nbsp;<span class="op" id="6388048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388051">if</span>&nbsp;<span class="ident" id="6388054">r</span><span class="op" id="6388055">.</span><span class="ident" id="6388056">err</span>&nbsp;<span class="op" id="6388060">!=</span>&nbsp;<span class="builtintype" id="6388063">nil</span>&nbsp;<span class="op" id="6388067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388071">return</span>&nbsp;<span class="ident" id="6388078">r</span><span class="op" id="6388079">.</span><span class="ident" id="6388080">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6388085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388089">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388150">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388202">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388258">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388320">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388384">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388445">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388509">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388570">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388626">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388688">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388749">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6388812">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388828">defer</span>&nbsp;<span class="ident" id="6388834">r</span><span class="op" id="6388835">.</span><span class="ident" id="6388836">rows</span><span class="op" id="6388840">.</span><span class="ident" id="6388841">Close</span><span class="op" id="6388846">(</span><span class="op" id="6388847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388850">for</span>&nbsp;<span class="ident" id="6388854">_</span><span class="op" id="6388855">,</span>&nbsp;<span class="ident" id="6388857">dp</span>&nbsp;<span class="op" id="6388860">:=</span>&nbsp;<span class="keyword" id="6388863">range</span>&nbsp;<span class="ident" id="6388869">dest</span>&nbsp;<span class="op" id="6388874">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388878">if</span>&nbsp;<span class="ident" id="6388881">_</span><span class="op" id="6388882">,</span>&nbsp;<span class="ident" id="6388884">ok</span>&nbsp;<span class="op" id="6388887">:=</span>&nbsp;<span class="ident" id="6388890">dp</span><span class="op" id="6388892">.</span><span class="op" id="6388893">(</span><span class="op" id="6388894">*</span><span class="ident" id="6388895">RawBytes</span><span class="op" id="6388903">)</span><span class="op" id="6388904">;</span>&nbsp;<span class="ident" id="6388906">ok</span>&nbsp;<span class="op" id="6388909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388914">return</span>&nbsp;<span class="ident" id="6388921">errors</span><span class="op" id="6388927">.</span><span class="ident" id="6388928">New</span><span class="op" id="6388931">(</span><span class="string" id="6388932">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="6388973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6388977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6388980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6388984">if</span>&nbsp;<span class="op" id="6388987">!</span><span class="ident" id="6388988">r</span><span class="op" id="6388989">.</span><span class="ident" id="6388990">rows</span><span class="op" id="6388994">.</span><span class="ident" id="6388995">Next</span><span class="op" id="6388999">(</span><span class="op" id="6389000">)</span>&nbsp;<span class="op" id="6389002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389006">if</span>&nbsp;<span class="ident" id="6389009">err</span>&nbsp;<span class="op" id="6389013">:=</span>&nbsp;<span class="ident" id="6389016">r</span><span class="op" id="6389017">.</span><span class="ident" id="6389018">rows</span><span class="op" id="6389022">.</span><span class="ident" id="6389023">Err</span><span class="op" id="6389026">(</span><span class="op" id="6389027">)</span><span class="op" id="6389028">;</span>&nbsp;<span class="ident" id="6389030">err</span>&nbsp;<span class="op" id="6389034">!=</span>&nbsp;<span class="builtintype" id="6389037">nil</span>&nbsp;<span class="op" id="6389041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389046">return</span>&nbsp;<span class="ident" id="6389053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6389059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389063">return</span>&nbsp;<span class="ident" id="6389070">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6389081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389084">err</span>&nbsp;<span class="op" id="6389088">:=</span>&nbsp;<span class="ident" id="6389091">r</span><span class="op" id="6389092">.</span><span class="ident" id="6389093">rows</span><span class="op" id="6389097">.</span><span class="ident" id="6389098">Scan</span><span class="op" id="6389102">(</span><span class="ident" id="6389103">dest</span><span class="op" id="6389107">...</span><span class="op" id="6389110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389113">if</span>&nbsp;<span class="ident" id="6389116">err</span>&nbsp;<span class="op" id="6389120">!=</span>&nbsp;<span class="builtintype" id="6389123">nil</span>&nbsp;<span class="op" id="6389127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389131">return</span>&nbsp;<span class="ident" id="6389138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6389143">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389146">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389217">if</span>&nbsp;<span class="ident" id="6389220">err</span>&nbsp;<span class="op" id="6389224">:=</span>&nbsp;<span class="ident" id="6389227">r</span><span class="op" id="6389228">.</span><span class="ident" id="6389229">rows</span><span class="op" id="6389233">.</span><span class="ident" id="6389234">Close</span><span class="op" id="6389239">(</span><span class="op" id="6389240">)</span><span class="op" id="6389241">;</span>&nbsp;<span class="ident" id="6389243">err</span>&nbsp;<span class="op" id="6389247">!=</span>&nbsp;<span class="builtintype" id="6389250">nil</span>&nbsp;<span class="op" id="6389254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389258">return</span>&nbsp;<span class="ident" id="6389265">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6389270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6389274">return</span>&nbsp;<span class="builtintype" id="6389281">nil</span><br>
<span class="lineno"></span><span class="op" id="6389285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6389288">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="6389336">type</span>&nbsp;<span class="ident" id="6389341">Result</span>&nbsp;<span class="keyword" id="6389348">interface</span>&nbsp;<span class="op" id="6389358">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389361">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389424">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389485">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389547">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389606">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389629">LastInsertId</span><span class="op" id="6389641">(</span><span class="op" id="6389642">)</span>&nbsp;<span class="op" id="6389644">(</span><span class="ident" id="6389645">int64</span><span class="op" id="6389650">,</span>&nbsp;<span class="builtintype" id="6389652">error</span><span class="op" id="6389657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389661">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389720">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6389782">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389811">RowsAffected</span><span class="op" id="6389823">(</span><span class="op" id="6389824">)</span>&nbsp;<span class="op" id="6389826">(</span><span class="ident" id="6389827">int64</span><span class="op" id="6389832">,</span>&nbsp;<span class="builtintype" id="6389834">error</span><span class="op" id="6389839">)</span><br>
<span class="lineno"></span><span class="op" id="6389841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6389844">type</span>&nbsp;<span class="ident" id="6389849">driverResult</span>&nbsp;<span class="keyword" id="6389862">struct</span>&nbsp;<span class="op" id="6389869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389872">sync</span><span class="op" id="6389876">.</span><span class="ident" id="6389877">Locker</span>&nbsp;<span class="comment" id="6389884">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389904">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389916">driver</span><span class="op" id="6389922">.</span><span class="ident" id="6389923">Result</span><br>
<span class="lineno"></span><span class="op" id="6389930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6389933">func</span>&nbsp;<span class="op" id="6389938">(</span><span class="ident" id="6389939">dr</span>&nbsp;<span class="ident" id="6389942">driverResult</span><span class="op" id="6389954">)</span>&nbsp;<span class="ident" id="6389956">LastInsertId</span><span class="op" id="6389968">(</span><span class="op" id="6389969">)</span>&nbsp;<span class="op" id="6389971">(</span><span class="ident" id="6389972">int64</span><span class="op" id="6389977">,</span>&nbsp;<span class="builtintype" id="6389979">error</span><span class="op" id="6389984">)</span>&nbsp;<span class="op" id="6389986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6389989">dr</span><span class="op" id="6389991">.</span><span class="ident" id="6389992">Lock</span><span class="op" id="6389996">(</span><span class="op" id="6389997">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6390000">defer</span>&nbsp;<span class="ident" id="6390006">dr</span><span class="op" id="6390008">.</span><span class="ident" id="6390009">Unlock</span><span class="op" id="6390015">(</span><span class="op" id="6390016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6390019">return</span>&nbsp;<span class="ident" id="6390026">dr</span><span class="op" id="6390028">.</span><span class="ident" id="6390029">resi</span><span class="op" id="6390033">.</span><span class="ident" id="6390034">LastInsertId</span><span class="op" id="6390046">(</span><span class="op" id="6390047">)</span><br>
<span class="lineno"></span><span class="op" id="6390049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6390052">func</span>&nbsp;<span class="op" id="6390057">(</span><span class="ident" id="6390058">dr</span>&nbsp;<span class="ident" id="6390061">driverResult</span><span class="op" id="6390073">)</span>&nbsp;<span class="ident" id="6390075">RowsAffected</span><span class="op" id="6390087">(</span><span class="op" id="6390088">)</span>&nbsp;<span class="op" id="6390090">(</span><span class="ident" id="6390091">int64</span><span class="op" id="6390096">,</span>&nbsp;<span class="builtintype" id="6390098">error</span><span class="op" id="6390103">)</span>&nbsp;<span class="op" id="6390105">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6390108">dr</span><span class="op" id="6390110">.</span><span class="ident" id="6390111">Lock</span><span class="op" id="6390115">(</span><span class="op" id="6390116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6390119">defer</span>&nbsp;<span class="ident" id="6390125">dr</span><span class="op" id="6390127">.</span><span class="ident" id="6390128">Unlock</span><span class="op" id="6390134">(</span><span class="op" id="6390135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6390138">return</span>&nbsp;<span class="ident" id="6390145">dr</span><span class="op" id="6390147">.</span><span class="ident" id="6390148">resi</span><span class="op" id="6390152">.</span><span class="ident" id="6390153">RowsAffected</span><span class="op" id="6390165">(</span><span class="op" id="6390166">)</span><br>
<span class="lineno"></span><span class="op" id="6390168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="6390171">func</span>&nbsp;<span class="ident" id="6390176">stack</span><span class="op" id="6390181">(</span><span class="op" id="6390182">)</span>&nbsp;<span class="builtintype" id="6390184">string</span>&nbsp;<span class="op" id="6390191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6390194">var</span>&nbsp;<span class="ident" id="6390198">buf</span>&nbsp;<span class="op" id="6390202">[</span><span class="num" id="6390203">2</span>&nbsp;<span class="op" id="6390205">&lt;&lt;</span>&nbsp;<span class="num" id="6390208">10</span><span class="op" id="6390210">]</span><span class="builtintype" id="6390211">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6390217">return</span>&nbsp;<span class="builtintype" id="6390224">string</span><span class="op" id="6390230">(</span><span class="ident" id="6390231">buf</span><span class="op" id="6390234">[</span><span class="op" id="6390235">:</span><span class="ident" id="6390236">runtime</span><span class="op" id="6390243">.</span><span class="ident" id="6390244">Stack</span><span class="op" id="6390249">(</span><span class="ident" id="6390250">buf</span><span class="op" id="6390253">[</span><span class="op" id="6390254">:</span><span class="op" id="6390255">]</span><span class="op" id="6390256">,</span>&nbsp;<span class="builtintype" id="6390258">false</span><span class="op" id="6390263">)</span><span class="op" id="6390264">]</span><span class="op" id="6390265">)</span><br>
<span class="lineno"></span><span class="op" id="6390267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="6390270">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="6390305">func</span>&nbsp;<span class="ident" id="6390310">withLock</span><span class="op" id="6390318">(</span><span class="ident" id="6390319">lk</span>&nbsp;<span class="ident" id="6390322">sync</span><span class="op" id="6390326">.</span><span class="ident" id="6390327">Locker</span><span class="op" id="6390333">,</span>&nbsp;<span class="ident" id="6390335">fn</span>&nbsp;<span class="keyword" id="6390338">func</span><span class="op" id="6390342">(</span><span class="op" id="6390343">)</span><span class="op" id="6390344">)</span>&nbsp;<span class="op" id="6390346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6390349">lk</span><span class="op" id="6390351">.</span><span class="ident" id="6390352">Lock</span><span class="op" id="6390356">(</span><span class="op" id="6390357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6390360">fn</span><span class="op" id="6390362">(</span><span class="op" id="6390363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6390366">lk</span><span class="op" id="6390368">.</span><span class="ident" id="6390369">Unlock</span><span class="op" id="6390375">(</span><span class="op" id="6390376">)</span><br>
<span class="lineno">1770</span><span class="op" id="6390378">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
