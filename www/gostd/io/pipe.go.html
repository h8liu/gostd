<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>io</h2>
<ul>
<li><a href="/gostd/io/io.go.html">io.go</a></li>
<li><a href="/gostd/io/io_test.go.html">io_test.go</a></li>
<li><a href="/gostd/io/multi.go.html">multi.go</a></li>
<li><a href="/gostd/io/multi_test.go.html">multi_test.go</a></li>
<li><a href="/gostd/io/pipe.go.html" class="current">pipe.go</a></li>
<li><a href="/gostd/io/pipe_test.go.html">pipe_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1395291">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1395346">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1395400">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1395451">//&nbsp;Pipe&nbsp;adapter&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1395506">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1395544">package</span>&nbsp;<span class="ident" id="1395552">io</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1395556">import</span>&nbsp;<span class="op" id="1395563">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1395566">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1395576">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="1395583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1395586">//&nbsp;ErrClosedPipe&nbsp;is&nbsp;the&nbsp;error&nbsp;used&nbsp;for&nbsp;read&nbsp;or&nbsp;write&nbsp;operations&nbsp;on&nbsp;a&nbsp;closed&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1395668">var</span>&nbsp;<span class="ident" id="1395672">ErrClosedPipe</span>&nbsp;<span class="op" id="1395686">=</span>&nbsp;<span class="ident" id="1395688">errors</span><span class="op" id="1395694">.</span><span class="ident" id="1395695">New</span><span class="op" id="1395698">(</span><span class="string" id="1395699">&#34;io:&nbsp;read/write&nbsp;on&nbsp;closed&nbsp;pipe&#34;</span><span class="op" id="1395730">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1395733">type</span>&nbsp;<span class="ident" id="1395738">pipeResult</span>&nbsp;<span class="keyword" id="1395749">struct</span>&nbsp;<span class="op" id="1395756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395759">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1395763">int</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395768">err</span>&nbsp;<span class="builtintype" id="1395772">error</span><br>
<span class="lineno"></span><span class="op" id="1395778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1395781">//&nbsp;A&nbsp;pipe&nbsp;is&nbsp;the&nbsp;shared&nbsp;pipe&nbsp;structure&nbsp;underlying&nbsp;PipeReader&nbsp;and&nbsp;PipeWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1395858">type</span>&nbsp;<span class="ident" id="1395863">pipe</span>&nbsp;<span class="keyword" id="1395868">struct</span>&nbsp;<span class="op" id="1395875">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395878">rl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395884">sync</span><span class="op" id="1395888">.</span><span class="ident" id="1395889">Mutex</span>&nbsp;<span class="comment" id="1395895">//&nbsp;gates&nbsp;readers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395927">wl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395933">sync</span><span class="op" id="1395937">.</span><span class="ident" id="1395938">Mutex</span>&nbsp;<span class="comment" id="1395944">//&nbsp;gates&nbsp;writers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395976">l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1395982">sync</span><span class="op" id="1395986">.</span><span class="ident" id="1395987">Mutex</span>&nbsp;<span class="comment" id="1395993">//&nbsp;protects&nbsp;remaining&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396023">data</span>&nbsp;&nbsp;<span class="op" id="1396029">[</span><span class="op" id="1396030">]</span><span class="builtintype" id="1396031">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396040">//&nbsp;data&nbsp;remaining&nbsp;in&nbsp;pending&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396076">rwait</span>&nbsp;<span class="ident" id="1396082">sync</span><span class="op" id="1396086">.</span><span class="ident" id="1396087">Cond</span>&nbsp;&nbsp;<span class="comment" id="1396093">//&nbsp;waiting&nbsp;reader</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396112">wwait</span>&nbsp;<span class="ident" id="1396118">sync</span><span class="op" id="1396122">.</span><span class="ident" id="1396123">Cond</span>&nbsp;&nbsp;<span class="comment" id="1396129">//&nbsp;waiting&nbsp;writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396148">rerr</span>&nbsp;&nbsp;<span class="builtintype" id="1396154">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396165">//&nbsp;if&nbsp;reader&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396208">werr</span>&nbsp;&nbsp;<span class="builtintype" id="1396214">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396225">//&nbsp;if&nbsp;writer&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;reads</span><br>
<span class="lineno"></span><span class="op" id="1396266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1396269">func</span>&nbsp;<span class="op" id="1396274">(</span><span class="ident" id="1396275">p</span>&nbsp;<span class="op" id="1396277">*</span><span class="ident" id="1396278">pipe</span><span class="op" id="1396282">)</span>&nbsp;<span class="ident" id="1396284">read</span><span class="op" id="1396288">(</span><span class="ident" id="1396289">b</span>&nbsp;<span class="op" id="1396291">[</span><span class="op" id="1396292">]</span><span class="builtintype" id="1396293">byte</span><span class="op" id="1396297">)</span>&nbsp;<span class="op" id="1396299">(</span><span class="ident" id="1396300">n</span>&nbsp;<span class="builtintype" id="1396302">int</span><span class="op" id="1396305">,</span>&nbsp;<span class="ident" id="1396307">err</span>&nbsp;<span class="builtintype" id="1396311">error</span><span class="op" id="1396316">)</span>&nbsp;<span class="op" id="1396318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396321">//&nbsp;One&nbsp;reader&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396347">p</span><span class="op" id="1396348">.</span><span class="ident" id="1396349">rl</span><span class="op" id="1396351">.</span><span class="ident" id="1396352">Lock</span><span class="op" id="1396356">(</span><span class="op" id="1396357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396360">defer</span>&nbsp;<span class="ident" id="1396366">p</span><span class="op" id="1396367">.</span><span class="ident" id="1396368">rl</span><span class="op" id="1396370">.</span><span class="ident" id="1396371">Unlock</span><span class="op" id="1396377">(</span><span class="op" id="1396378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396382">p</span><span class="op" id="1396383">.</span><span class="ident" id="1396384">l</span><span class="op" id="1396385">.</span><span class="ident" id="1396386">Lock</span><span class="op" id="1396390">(</span><span class="op" id="1396391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396394">defer</span>&nbsp;<span class="ident" id="1396400">p</span><span class="op" id="1396401">.</span><span class="ident" id="1396402">l</span><span class="op" id="1396403">.</span><span class="ident" id="1396404">Unlock</span><span class="op" id="1396410">(</span><span class="op" id="1396411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396414">for</span>&nbsp;<span class="op" id="1396418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396422">if</span>&nbsp;<span class="ident" id="1396425">p</span><span class="op" id="1396426">.</span><span class="ident" id="1396427">rerr</span>&nbsp;<span class="op" id="1396432">!=</span>&nbsp;<span class="builtintype" id="1396435">nil</span>&nbsp;<span class="op" id="1396439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396444">return</span>&nbsp;<span class="num" id="1396451">0</span><span class="op" id="1396452">,</span>&nbsp;<span class="ident" id="1396454">ErrClosedPipe</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396474">if</span>&nbsp;<span class="ident" id="1396477">p</span><span class="op" id="1396478">.</span><span class="ident" id="1396479">data</span>&nbsp;<span class="op" id="1396484">!=</span>&nbsp;<span class="builtintype" id="1396487">nil</span>&nbsp;<span class="op" id="1396491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396496">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396508">if</span>&nbsp;<span class="ident" id="1396511">p</span><span class="op" id="1396512">.</span><span class="ident" id="1396513">werr</span>&nbsp;<span class="op" id="1396518">!=</span>&nbsp;<span class="builtintype" id="1396521">nil</span>&nbsp;<span class="op" id="1396525">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396530">return</span>&nbsp;<span class="num" id="1396537">0</span><span class="op" id="1396538">,</span>&nbsp;<span class="ident" id="1396540">p</span><span class="op" id="1396541">.</span><span class="ident" id="1396542">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396553">p</span><span class="op" id="1396554">.</span><span class="ident" id="1396555">rwait</span><span class="op" id="1396560">.</span><span class="ident" id="1396561">Wait</span><span class="op" id="1396565">(</span><span class="op" id="1396566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396572">n</span>&nbsp;<span class="op" id="1396574">=</span>&nbsp;<span class="builtinfunc" id="1396576">copy</span><span class="op" id="1396580">(</span><span class="ident" id="1396581">b</span><span class="op" id="1396582">,</span>&nbsp;<span class="ident" id="1396584">p</span><span class="op" id="1396585">.</span><span class="ident" id="1396586">data</span><span class="op" id="1396590">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396593">p</span><span class="op" id="1396594">.</span><span class="ident" id="1396595">data</span>&nbsp;<span class="op" id="1396600">=</span>&nbsp;<span class="ident" id="1396602">p</span><span class="op" id="1396603">.</span><span class="ident" id="1396604">data</span><span class="op" id="1396608">[</span><span class="ident" id="1396609">n</span><span class="op" id="1396610">:</span><span class="op" id="1396611">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396614">if</span>&nbsp;<span class="builtinfunc" id="1396617">len</span><span class="op" id="1396620">(</span><span class="ident" id="1396621">p</span><span class="op" id="1396622">.</span><span class="ident" id="1396623">data</span><span class="op" id="1396627">)</span>&nbsp;<span class="op" id="1396629">==</span>&nbsp;<span class="num" id="1396632">0</span>&nbsp;<span class="op" id="1396634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396638">p</span><span class="op" id="1396639">.</span><span class="ident" id="1396640">data</span>&nbsp;<span class="op" id="1396645">=</span>&nbsp;<span class="builtintype" id="1396647">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396653">p</span><span class="op" id="1396654">.</span><span class="ident" id="1396655">wwait</span><span class="op" id="1396660">.</span><span class="ident" id="1396661">Signal</span><span class="op" id="1396667">(</span><span class="op" id="1396668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396671">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396674">return</span><br>
<span class="lineno"></span><span class="op" id="1396681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1396684">var</span>&nbsp;<span class="ident" id="1396688">zero</span>&nbsp;<span class="op" id="1396693">[</span><span class="num" id="1396694">0</span><span class="op" id="1396695">]</span><span class="builtintype" id="1396696">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="1396702">func</span>&nbsp;<span class="op" id="1396707">(</span><span class="ident" id="1396708">p</span>&nbsp;<span class="op" id="1396710">*</span><span class="ident" id="1396711">pipe</span><span class="op" id="1396715">)</span>&nbsp;<span class="ident" id="1396717">write</span><span class="op" id="1396722">(</span><span class="ident" id="1396723">b</span>&nbsp;<span class="op" id="1396725">[</span><span class="op" id="1396726">]</span><span class="builtintype" id="1396727">byte</span><span class="op" id="1396731">)</span>&nbsp;<span class="op" id="1396733">(</span><span class="ident" id="1396734">n</span>&nbsp;<span class="builtintype" id="1396736">int</span><span class="op" id="1396739">,</span>&nbsp;<span class="ident" id="1396741">err</span>&nbsp;<span class="builtintype" id="1396745">error</span><span class="op" id="1396750">)</span>&nbsp;<span class="op" id="1396752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396755">//&nbsp;pipe&nbsp;uses&nbsp;nil&nbsp;to&nbsp;mean&nbsp;not&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396795">if</span>&nbsp;<span class="ident" id="1396798">b</span>&nbsp;<span class="op" id="1396800">==</span>&nbsp;<span class="builtintype" id="1396803">nil</span>&nbsp;<span class="op" id="1396807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396811">b</span>&nbsp;<span class="op" id="1396813">=</span>&nbsp;<span class="ident" id="1396815">zero</span><span class="op" id="1396819">[</span><span class="op" id="1396820">:</span><span class="op" id="1396821">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396824">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1396828">//&nbsp;One&nbsp;writer&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396854">p</span><span class="op" id="1396855">.</span><span class="ident" id="1396856">wl</span><span class="op" id="1396858">.</span><span class="ident" id="1396859">Lock</span><span class="op" id="1396863">(</span><span class="op" id="1396864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396867">defer</span>&nbsp;<span class="ident" id="1396873">p</span><span class="op" id="1396874">.</span><span class="ident" id="1396875">wl</span><span class="op" id="1396877">.</span><span class="ident" id="1396878">Unlock</span><span class="op" id="1396884">(</span><span class="op" id="1396885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396889">p</span><span class="op" id="1396890">.</span><span class="ident" id="1396891">l</span><span class="op" id="1396892">.</span><span class="ident" id="1396893">Lock</span><span class="op" id="1396897">(</span><span class="op" id="1396898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396901">defer</span>&nbsp;<span class="ident" id="1396907">p</span><span class="op" id="1396908">.</span><span class="ident" id="1396909">l</span><span class="op" id="1396910">.</span><span class="ident" id="1396911">Unlock</span><span class="op" id="1396917">(</span><span class="op" id="1396918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396921">if</span>&nbsp;<span class="ident" id="1396924">p</span><span class="op" id="1396925">.</span><span class="ident" id="1396926">werr</span>&nbsp;<span class="op" id="1396931">!=</span>&nbsp;<span class="builtintype" id="1396934">nil</span>&nbsp;<span class="op" id="1396938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396942">err</span>&nbsp;<span class="op" id="1396946">=</span>&nbsp;<span class="ident" id="1396948">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1396964">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1396972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396975">p</span><span class="op" id="1396976">.</span><span class="ident" id="1396977">data</span>&nbsp;<span class="op" id="1396982">=</span>&nbsp;<span class="ident" id="1396984">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1396987">p</span><span class="op" id="1396988">.</span><span class="ident" id="1396989">rwait</span><span class="op" id="1396994">.</span><span class="ident" id="1396995">Signal</span><span class="op" id="1397001">(</span><span class="op" id="1397002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397005">for</span>&nbsp;<span class="op" id="1397009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397013">if</span>&nbsp;<span class="ident" id="1397016">p</span><span class="op" id="1397017">.</span><span class="ident" id="1397018">data</span>&nbsp;<span class="op" id="1397023">==</span>&nbsp;<span class="builtintype" id="1397026">nil</span>&nbsp;<span class="op" id="1397030">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397035">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397047">if</span>&nbsp;<span class="ident" id="1397050">p</span><span class="op" id="1397051">.</span><span class="ident" id="1397052">rerr</span>&nbsp;<span class="op" id="1397057">!=</span>&nbsp;<span class="builtintype" id="1397060">nil</span>&nbsp;<span class="op" id="1397064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397069">err</span>&nbsp;<span class="op" id="1397073">=</span>&nbsp;<span class="ident" id="1397075">p</span><span class="op" id="1397076">.</span><span class="ident" id="1397077">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397085">break</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397097">if</span>&nbsp;<span class="ident" id="1397100">p</span><span class="op" id="1397101">.</span><span class="ident" id="1397102">werr</span>&nbsp;<span class="op" id="1397107">!=</span>&nbsp;<span class="builtintype" id="1397110">nil</span>&nbsp;<span class="op" id="1397114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397119">err</span>&nbsp;<span class="op" id="1397123">=</span>&nbsp;<span class="ident" id="1397125">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397145">p</span><span class="op" id="1397146">.</span><span class="ident" id="1397147">wwait</span><span class="op" id="1397152">.</span><span class="ident" id="1397153">Wait</span><span class="op" id="1397157">(</span><span class="op" id="1397158">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397164">n</span>&nbsp;<span class="op" id="1397166">=</span>&nbsp;<span class="builtinfunc" id="1397168">len</span><span class="op" id="1397171">(</span><span class="ident" id="1397172">b</span><span class="op" id="1397173">)</span>&nbsp;<span class="op" id="1397175">-</span>&nbsp;<span class="builtinfunc" id="1397177">len</span><span class="op" id="1397180">(</span><span class="ident" id="1397181">p</span><span class="op" id="1397182">.</span><span class="ident" id="1397183">data</span><span class="op" id="1397187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397190">p</span><span class="op" id="1397191">.</span><span class="ident" id="1397192">data</span>&nbsp;<span class="op" id="1397197">=</span>&nbsp;<span class="builtintype" id="1397199">nil</span>&nbsp;<span class="comment" id="1397203">//&nbsp;in&nbsp;case&nbsp;of&nbsp;rerr&nbsp;or&nbsp;werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397231">return</span><br>
<span class="lineno"></span><span class="op" id="1397238">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1397241">func</span>&nbsp;<span class="op" id="1397246">(</span><span class="ident" id="1397247">p</span>&nbsp;<span class="op" id="1397249">*</span><span class="ident" id="1397250">pipe</span><span class="op" id="1397254">)</span>&nbsp;<span class="ident" id="1397256">rclose</span><span class="op" id="1397262">(</span><span class="ident" id="1397263">err</span>&nbsp;<span class="builtintype" id="1397267">error</span><span class="op" id="1397272">)</span>&nbsp;<span class="op" id="1397274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397277">if</span>&nbsp;<span class="ident" id="1397280">err</span>&nbsp;<span class="op" id="1397284">==</span>&nbsp;<span class="builtintype" id="1397287">nil</span>&nbsp;<span class="op" id="1397291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397295">err</span>&nbsp;<span class="op" id="1397299">=</span>&nbsp;<span class="ident" id="1397301">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397316">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397319">p</span><span class="op" id="1397320">.</span><span class="ident" id="1397321">l</span><span class="op" id="1397322">.</span><span class="ident" id="1397323">Lock</span><span class="op" id="1397327">(</span><span class="op" id="1397328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397331">defer</span>&nbsp;<span class="ident" id="1397337">p</span><span class="op" id="1397338">.</span><span class="ident" id="1397339">l</span><span class="op" id="1397340">.</span><span class="ident" id="1397341">Unlock</span><span class="op" id="1397347">(</span><span class="op" id="1397348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397351">p</span><span class="op" id="1397352">.</span><span class="ident" id="1397353">rerr</span>&nbsp;<span class="op" id="1397358">=</span>&nbsp;<span class="ident" id="1397360">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397365">p</span><span class="op" id="1397366">.</span><span class="ident" id="1397367">rwait</span><span class="op" id="1397372">.</span><span class="ident" id="1397373">Signal</span><span class="op" id="1397379">(</span><span class="op" id="1397380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397383">p</span><span class="op" id="1397384">.</span><span class="ident" id="1397385">wwait</span><span class="op" id="1397390">.</span><span class="ident" id="1397391">Signal</span><span class="op" id="1397397">(</span><span class="op" id="1397398">)</span><br>
<span class="lineno">110</span><span class="op" id="1397400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1397403">func</span>&nbsp;<span class="op" id="1397408">(</span><span class="ident" id="1397409">p</span>&nbsp;<span class="op" id="1397411">*</span><span class="ident" id="1397412">pipe</span><span class="op" id="1397416">)</span>&nbsp;<span class="ident" id="1397418">wclose</span><span class="op" id="1397424">(</span><span class="ident" id="1397425">err</span>&nbsp;<span class="builtintype" id="1397429">error</span><span class="op" id="1397434">)</span>&nbsp;<span class="op" id="1397436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397439">if</span>&nbsp;<span class="ident" id="1397442">err</span>&nbsp;<span class="op" id="1397446">==</span>&nbsp;<span class="builtintype" id="1397449">nil</span>&nbsp;<span class="op" id="1397453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397457">err</span>&nbsp;<span class="op" id="1397461">=</span>&nbsp;<span class="ident" id="1397463">EOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1397468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397471">p</span><span class="op" id="1397472">.</span><span class="ident" id="1397473">l</span><span class="op" id="1397474">.</span><span class="ident" id="1397475">Lock</span><span class="op" id="1397479">(</span><span class="op" id="1397480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397483">defer</span>&nbsp;<span class="ident" id="1397489">p</span><span class="op" id="1397490">.</span><span class="ident" id="1397491">l</span><span class="op" id="1397492">.</span><span class="ident" id="1397493">Unlock</span><span class="op" id="1397499">(</span><span class="op" id="1397500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397503">p</span><span class="op" id="1397504">.</span><span class="ident" id="1397505">werr</span>&nbsp;<span class="op" id="1397510">=</span>&nbsp;<span class="ident" id="1397512">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397517">p</span><span class="op" id="1397518">.</span><span class="ident" id="1397519">rwait</span><span class="op" id="1397524">.</span><span class="ident" id="1397525">Signal</span><span class="op" id="1397531">(</span><span class="op" id="1397532">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397535">p</span><span class="op" id="1397536">.</span><span class="ident" id="1397537">wwait</span><span class="op" id="1397542">.</span><span class="ident" id="1397543">Signal</span><span class="op" id="1397549">(</span><span class="op" id="1397550">)</span><br>
<span class="lineno"></span><span class="op" id="1397552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1397555">//&nbsp;A&nbsp;PipeReader&nbsp;is&nbsp;the&nbsp;read&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1397599">type</span>&nbsp;<span class="ident" id="1397604">PipeReader</span>&nbsp;<span class="keyword" id="1397615">struct</span>&nbsp;<span class="op" id="1397622">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1397625">p</span>&nbsp;<span class="op" id="1397627">*</span><span class="ident" id="1397628">pipe</span><br>
<span class="lineno"></span><span class="op" id="1397633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1397636">//&nbsp;Read&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Read&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1397684">//&nbsp;it&nbsp;reads&nbsp;data&nbsp;from&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;a&nbsp;writer</span><br>
<span class="lineno">130</span><span class="comment" id="1397740">//&nbsp;arrives&nbsp;or&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1397779">//&nbsp;If&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1397838">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1397880">func</span>&nbsp;<span class="op" id="1397885">(</span><span class="ident" id="1397886">r</span>&nbsp;<span class="op" id="1397888">*</span><span class="ident" id="1397889">PipeReader</span><span class="op" id="1397899">)</span>&nbsp;<span class="ident" id="1397901">Read</span><span class="op" id="1397905">(</span><span class="ident" id="1397906">data</span>&nbsp;<span class="op" id="1397911">[</span><span class="op" id="1397912">]</span><span class="builtintype" id="1397913">byte</span><span class="op" id="1397917">)</span>&nbsp;<span class="op" id="1397919">(</span><span class="ident" id="1397920">n</span>&nbsp;<span class="builtintype" id="1397922">int</span><span class="op" id="1397925">,</span>&nbsp;<span class="ident" id="1397927">err</span>&nbsp;<span class="builtintype" id="1397931">error</span><span class="op" id="1397936">)</span>&nbsp;<span class="op" id="1397938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1397941">return</span>&nbsp;<span class="ident" id="1397948">r</span><span class="op" id="1397949">.</span><span class="ident" id="1397950">p</span><span class="op" id="1397951">.</span><span class="ident" id="1397952">read</span><span class="op" id="1397956">(</span><span class="ident" id="1397957">data</span><span class="op" id="1397961">)</span><br>
<span class="lineno">135</span><span class="op" id="1397963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1397966">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1398019">//&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;ErrClosedPipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1398082">func</span>&nbsp;<span class="op" id="1398087">(</span><span class="ident" id="1398088">r</span>&nbsp;<span class="op" id="1398090">*</span><span class="ident" id="1398091">PipeReader</span><span class="op" id="1398101">)</span>&nbsp;<span class="ident" id="1398103">Close</span><span class="op" id="1398108">(</span><span class="op" id="1398109">)</span>&nbsp;<span class="builtintype" id="1398111">error</span>&nbsp;<span class="op" id="1398117">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398120">return</span>&nbsp;<span class="ident" id="1398127">r</span><span class="op" id="1398128">.</span><span class="ident" id="1398129">CloseWithError</span><span class="op" id="1398143">(</span><span class="builtintype" id="1398144">nil</span><span class="op" id="1398147">)</span><br>
<span class="lineno"></span><span class="op" id="1398149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1398152">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes</span><br>
<span class="lineno"></span><span class="comment" id="1398207">//&nbsp;to&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno">145</span><span class="keyword" id="1398267">func</span>&nbsp;<span class="op" id="1398272">(</span><span class="ident" id="1398273">r</span>&nbsp;<span class="op" id="1398275">*</span><span class="ident" id="1398276">PipeReader</span><span class="op" id="1398286">)</span>&nbsp;<span class="ident" id="1398288">CloseWithError</span><span class="op" id="1398302">(</span><span class="ident" id="1398303">err</span>&nbsp;<span class="builtintype" id="1398307">error</span><span class="op" id="1398312">)</span>&nbsp;<span class="builtintype" id="1398314">error</span>&nbsp;<span class="op" id="1398320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398323">r</span><span class="op" id="1398324">.</span><span class="ident" id="1398325">p</span><span class="op" id="1398326">.</span><span class="ident" id="1398327">rclose</span><span class="op" id="1398333">(</span><span class="ident" id="1398334">err</span><span class="op" id="1398337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398340">return</span>&nbsp;<span class="builtintype" id="1398347">nil</span><br>
<span class="lineno"></span><span class="op" id="1398351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1398354">//&nbsp;A&nbsp;PipeWriter&nbsp;is&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1398399">type</span>&nbsp;<span class="ident" id="1398404">PipeWriter</span>&nbsp;<span class="keyword" id="1398415">struct</span>&nbsp;<span class="op" id="1398422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1398425">p</span>&nbsp;<span class="op" id="1398427">*</span><span class="ident" id="1398428">pipe</span><br>
<span class="lineno"></span><span class="op" id="1398433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="1398436">//&nbsp;Write&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Write&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1398486">//&nbsp;it&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1398540">//&nbsp;have&nbsp;consumed&nbsp;all&nbsp;the&nbsp;data&nbsp;or&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1398597">//&nbsp;If&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;err&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1398653">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;ErrClosedPipe.</span><br>
<span class="lineno">160</span><span class="keyword" id="1398705">func</span>&nbsp;<span class="op" id="1398710">(</span><span class="ident" id="1398711">w</span>&nbsp;<span class="op" id="1398713">*</span><span class="ident" id="1398714">PipeWriter</span><span class="op" id="1398724">)</span>&nbsp;<span class="ident" id="1398726">Write</span><span class="op" id="1398731">(</span><span class="ident" id="1398732">data</span>&nbsp;<span class="op" id="1398737">[</span><span class="op" id="1398738">]</span><span class="builtintype" id="1398739">byte</span><span class="op" id="1398743">)</span>&nbsp;<span class="op" id="1398745">(</span><span class="ident" id="1398746">n</span>&nbsp;<span class="builtintype" id="1398748">int</span><span class="op" id="1398751">,</span>&nbsp;<span class="ident" id="1398753">err</span>&nbsp;<span class="builtintype" id="1398757">error</span><span class="op" id="1398762">)</span>&nbsp;<span class="op" id="1398764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398767">return</span>&nbsp;<span class="ident" id="1398774">w</span><span class="op" id="1398775">.</span><span class="ident" id="1398776">p</span><span class="op" id="1398777">.</span><span class="ident" id="1398778">write</span><span class="op" id="1398783">(</span><span class="ident" id="1398784">data</span><span class="op" id="1398788">)</span><br>
<span class="lineno"></span><span class="op" id="1398790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1398793">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno">165</span><span class="comment" id="1398847">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1398902">func</span>&nbsp;<span class="op" id="1398907">(</span><span class="ident" id="1398908">w</span>&nbsp;<span class="op" id="1398910">*</span><span class="ident" id="1398911">PipeWriter</span><span class="op" id="1398921">)</span>&nbsp;<span class="ident" id="1398923">Close</span><span class="op" id="1398928">(</span><span class="op" id="1398929">)</span>&nbsp;<span class="builtintype" id="1398931">error</span>&nbsp;<span class="op" id="1398937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1398940">return</span>&nbsp;<span class="ident" id="1398947">w</span><span class="op" id="1398948">.</span><span class="ident" id="1398949">CloseWithError</span><span class="op" id="1398963">(</span><span class="builtintype" id="1398964">nil</span><span class="op" id="1398967">)</span><br>
<span class="lineno"></span><span class="op" id="1398969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="1398972">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1399035">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno"></span><span class="keyword" id="1399100">func</span>&nbsp;<span class="op" id="1399105">(</span><span class="ident" id="1399106">w</span>&nbsp;<span class="op" id="1399108">*</span><span class="ident" id="1399109">PipeWriter</span><span class="op" id="1399119">)</span>&nbsp;<span class="ident" id="1399121">CloseWithError</span><span class="op" id="1399135">(</span><span class="ident" id="1399136">err</span>&nbsp;<span class="builtintype" id="1399140">error</span><span class="op" id="1399145">)</span>&nbsp;<span class="builtintype" id="1399147">error</span>&nbsp;<span class="op" id="1399153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399156">w</span><span class="op" id="1399157">.</span><span class="ident" id="1399158">p</span><span class="op" id="1399159">.</span><span class="ident" id="1399160">wclose</span><span class="op" id="1399166">(</span><span class="ident" id="1399167">err</span><span class="op" id="1399170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399173">return</span>&nbsp;<span class="builtintype" id="1399180">nil</span><br>
<span class="lineno">175</span><span class="op" id="1399184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1399187">//&nbsp;Pipe&nbsp;creates&nbsp;a&nbsp;synchronous&nbsp;in-memory&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="1399233">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1399290">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno">180</span><span class="comment" id="1399327">//&nbsp;Reads&nbsp;on&nbsp;one&nbsp;end&nbsp;are&nbsp;matched&nbsp;with&nbsp;writes&nbsp;on&nbsp;the&nbsp;other,</span><br>
<span class="lineno"></span><span class="comment" id="1399385">//&nbsp;copying&nbsp;data&nbsp;directly&nbsp;between&nbsp;the&nbsp;two;&nbsp;there&nbsp;is&nbsp;no&nbsp;internal&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="comment" id="1399459">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;Read&nbsp;and&nbsp;Write&nbsp;in&nbsp;parallel&nbsp;with&nbsp;each&nbsp;other&nbsp;or&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1399532">//&nbsp;Close.&nbsp;Close&nbsp;will&nbsp;complete&nbsp;once&nbsp;pending&nbsp;I/O&nbsp;is&nbsp;done.&nbsp;Parallel&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1399606">//&nbsp;Read,&nbsp;and&nbsp;parallel&nbsp;calls&nbsp;to&nbsp;Write,&nbsp;are&nbsp;also&nbsp;safe:</span><br>
<span class="lineno">185</span><span class="comment" id="1399659">//&nbsp;the&nbsp;individual&nbsp;calls&nbsp;will&nbsp;be&nbsp;gated&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="keyword" id="1399711">func</span>&nbsp;<span class="ident" id="1399716">Pipe</span><span class="op" id="1399720">(</span><span class="op" id="1399721">)</span>&nbsp;<span class="op" id="1399723">(</span><span class="op" id="1399724">*</span><span class="ident" id="1399725">PipeReader</span><span class="op" id="1399735">,</span>&nbsp;<span class="op" id="1399737">*</span><span class="ident" id="1399738">PipeWriter</span><span class="op" id="1399748">)</span>&nbsp;<span class="op" id="1399750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399753">p</span>&nbsp;<span class="op" id="1399755">:=</span>&nbsp;<span class="builtinfunc" id="1399758">new</span><span class="op" id="1399761">(</span><span class="ident" id="1399762">pipe</span><span class="op" id="1399766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399769">p</span><span class="op" id="1399770">.</span><span class="ident" id="1399771">rwait</span><span class="op" id="1399776">.</span><span class="ident" id="1399777">L</span>&nbsp;<span class="op" id="1399779">=</span>&nbsp;<span class="op" id="1399781">&amp;</span><span class="ident" id="1399782">p</span><span class="op" id="1399783">.</span><span class="ident" id="1399784">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399787">p</span><span class="op" id="1399788">.</span><span class="ident" id="1399789">wwait</span><span class="op" id="1399794">.</span><span class="ident" id="1399795">L</span>&nbsp;<span class="op" id="1399797">=</span>&nbsp;<span class="op" id="1399799">&amp;</span><span class="ident" id="1399800">p</span><span class="op" id="1399801">.</span><span class="ident" id="1399802">l</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399805">r</span>&nbsp;<span class="op" id="1399807">:=</span>&nbsp;<span class="op" id="1399810">&amp;</span><span class="ident" id="1399811">PipeReader</span><span class="op" id="1399821">{</span><span class="ident" id="1399822">p</span><span class="op" id="1399823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1399826">w</span>&nbsp;<span class="op" id="1399828">:=</span>&nbsp;<span class="op" id="1399831">&amp;</span><span class="ident" id="1399832">PipeWriter</span><span class="op" id="1399842">{</span><span class="ident" id="1399843">p</span><span class="op" id="1399844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1399847">return</span>&nbsp;<span class="ident" id="1399854">r</span><span class="op" id="1399855">,</span>&nbsp;<span class="ident" id="1399857">w</span><br>
<span class="lineno"></span><span class="op" id="1399859">}</span>
</div>
</body>
</html>
