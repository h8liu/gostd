<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3273931">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3273986">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3274040">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3274091">package</span>&nbsp;<span class="ident" id="3274099">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3274104">import</span>&nbsp;<span class="string" id="3274111">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3274126">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3274180">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3274236">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3274275">type</span>&nbsp;<span class="ident" id="3274280">fdMutex</span>&nbsp;<span class="keyword" id="3274288">struct</span>&nbsp;<span class="op" id="3274295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274298">state</span>&nbsp;<span class="ident" id="3274304">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274312">rsema</span>&nbsp;<span class="builtintype" id="3274318">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274326">wsema</span>&nbsp;<span class="builtintype" id="3274332">uint32</span><br>
<span class="lineno"></span><span class="op" id="3274339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3274342">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3274384">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3274469">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3274506">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3274544">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3274603">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3274652">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3274702">const</span>&nbsp;<span class="op" id="3274708">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274711">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3274724">=</span>&nbsp;<span class="num" id="3274726">1</span>&nbsp;<span class="op" id="3274728">&lt;&lt;</span>&nbsp;<span class="num" id="3274731">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274734">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3274747">=</span>&nbsp;<span class="num" id="3274749">1</span>&nbsp;<span class="op" id="3274751">&lt;&lt;</span>&nbsp;<span class="num" id="3274754">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274757">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3274770">=</span>&nbsp;<span class="num" id="3274772">1</span>&nbsp;<span class="op" id="3274774">&lt;&lt;</span>&nbsp;<span class="num" id="3274777">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274780">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3274793">=</span>&nbsp;<span class="num" id="3274795">1</span>&nbsp;<span class="op" id="3274797">&lt;&lt;</span>&nbsp;<span class="num" id="3274800">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274803">mutexRefMask</span>&nbsp;<span class="op" id="3274816">=</span>&nbsp;<span class="op" id="3274818">(</span><span class="num" id="3274819">1</span><span class="op" id="3274820">&lt;&lt;</span><span class="num" id="3274822">20</span>&nbsp;<span class="op" id="3274825">-</span>&nbsp;<span class="num" id="3274827">1</span><span class="op" id="3274828">)</span>&nbsp;<span class="op" id="3274830">&lt;&lt;</span>&nbsp;<span class="num" id="3274833">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274836">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3274849">=</span>&nbsp;<span class="num" id="3274851">1</span>&nbsp;<span class="op" id="3274853">&lt;&lt;</span>&nbsp;<span class="num" id="3274856">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274860">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3274873">=</span>&nbsp;<span class="op" id="3274875">(</span><span class="num" id="3274876">1</span><span class="op" id="3274877">&lt;&lt;</span><span class="num" id="3274879">20</span>&nbsp;<span class="op" id="3274882">-</span>&nbsp;<span class="num" id="3274884">1</span><span class="op" id="3274885">)</span>&nbsp;<span class="op" id="3274887">&lt;&lt;</span>&nbsp;<span class="num" id="3274890">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274894">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3274907">=</span>&nbsp;<span class="num" id="3274909">1</span>&nbsp;<span class="op" id="3274911">&lt;&lt;</span>&nbsp;<span class="num" id="3274914">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274918">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3274931">=</span>&nbsp;<span class="op" id="3274933">(</span><span class="num" id="3274934">1</span><span class="op" id="3274935">&lt;&lt;</span><span class="num" id="3274937">20</span>&nbsp;<span class="op" id="3274940">-</span>&nbsp;<span class="num" id="3274942">1</span><span class="op" id="3274943">)</span>&nbsp;<span class="op" id="3274945">&lt;&lt;</span>&nbsp;<span class="num" id="3274948">43</span><br>
<span class="lineno">35</span><span class="op" id="3274951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3274954">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3275010">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3275069">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3275150">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3275227">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3275300">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3275350">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3275401">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3275445">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3275532">func</span>&nbsp;<span class="op" id="3275537">(</span><span class="ident" id="3275538">mu</span>&nbsp;<span class="op" id="3275541">*</span><span class="ident" id="3275542">fdMutex</span><span class="op" id="3275549">)</span>&nbsp;<span class="ident" id="3275551">Incref</span><span class="op" id="3275557">(</span><span class="op" id="3275558">)</span>&nbsp;<span class="builtintype" id="3275560">bool</span>&nbsp;<span class="op" id="3275565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275568">for</span>&nbsp;<span class="op" id="3275572">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275576">old</span>&nbsp;<span class="op" id="3275580">:=</span>&nbsp;<span class="ident" id="3275583">atomic</span><span class="op" id="3275589">.</span><span class="ident" id="3275590">LoadUint64</span><span class="op" id="3275600">(</span><span class="op" id="3275601">&amp;</span><span class="ident" id="3275602">mu</span><span class="op" id="3275604">.</span><span class="ident" id="3275605">state</span><span class="op" id="3275610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275614">if</span>&nbsp;<span class="ident" id="3275617">old</span><span class="op" id="3275620">&amp;</span><span class="ident" id="3275621">mutexClosed</span>&nbsp;<span class="op" id="3275633">!=</span>&nbsp;<span class="num" id="3275636">0</span>&nbsp;<span class="op" id="3275638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275643">return</span>&nbsp;<span class="builtintype" id="3275650">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3275662">new</span>&nbsp;<span class="op" id="3275666">:=</span>&nbsp;<span class="ident" id="3275669">old</span>&nbsp;<span class="op" id="3275673">+</span>&nbsp;<span class="ident" id="3275675">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275686">if</span>&nbsp;<span class="builtinfunc" id="3275689">new</span><span class="op" id="3275692">&amp;</span><span class="ident" id="3275693">mutexRefMask</span>&nbsp;<span class="op" id="3275706">==</span>&nbsp;<span class="num" id="3275709">0</span>&nbsp;<span class="op" id="3275711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3275716">panic</span><span class="op" id="3275721">(</span><span class="string" id="3275722">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3275749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275757">if</span>&nbsp;<span class="ident" id="3275760">atomic</span><span class="op" id="3275766">.</span><span class="ident" id="3275767">CompareAndSwapUint64</span><span class="op" id="3275787">(</span><span class="op" id="3275788">&amp;</span><span class="ident" id="3275789">mu</span><span class="op" id="3275791">.</span><span class="ident" id="3275792">state</span><span class="op" id="3275797">,</span>&nbsp;<span class="ident" id="3275799">old</span><span class="op" id="3275802">,</span>&nbsp;<span class="builtinfunc" id="3275804">new</span><span class="op" id="3275807">)</span>&nbsp;<span class="op" id="3275809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275814">return</span>&nbsp;<span class="builtintype" id="3275821">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275831">}</span><br>
<span class="lineno"></span><span class="op" id="3275833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3275836">func</span>&nbsp;<span class="op" id="3275841">(</span><span class="ident" id="3275842">mu</span>&nbsp;<span class="op" id="3275845">*</span><span class="ident" id="3275846">fdMutex</span><span class="op" id="3275853">)</span>&nbsp;<span class="ident" id="3275855">IncrefAndClose</span><span class="op" id="3275869">(</span><span class="op" id="3275870">)</span>&nbsp;<span class="builtintype" id="3275872">bool</span>&nbsp;<span class="op" id="3275877">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275880">for</span>&nbsp;<span class="op" id="3275884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275888">old</span>&nbsp;<span class="op" id="3275892">:=</span>&nbsp;<span class="ident" id="3275895">atomic</span><span class="op" id="3275901">.</span><span class="ident" id="3275902">LoadUint64</span><span class="op" id="3275912">(</span><span class="op" id="3275913">&amp;</span><span class="ident" id="3275914">mu</span><span class="op" id="3275916">.</span><span class="ident" id="3275917">state</span><span class="op" id="3275922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275926">if</span>&nbsp;<span class="ident" id="3275929">old</span><span class="op" id="3275932">&amp;</span><span class="ident" id="3275933">mutexClosed</span>&nbsp;<span class="op" id="3275945">!=</span>&nbsp;<span class="num" id="3275948">0</span>&nbsp;<span class="op" id="3275950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275955">return</span>&nbsp;<span class="builtintype" id="3275962">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275970">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3275974">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3276019">new</span>&nbsp;<span class="op" id="3276023">:=</span>&nbsp;<span class="op" id="3276026">(</span><span class="ident" id="3276027">old</span>&nbsp;<span class="op" id="3276031">|</span>&nbsp;<span class="ident" id="3276033">mutexClosed</span><span class="op" id="3276044">)</span>&nbsp;<span class="op" id="3276046">+</span>&nbsp;<span class="ident" id="3276048">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276059">if</span>&nbsp;<span class="builtinfunc" id="3276062">new</span><span class="op" id="3276065">&amp;</span><span class="ident" id="3276066">mutexRefMask</span>&nbsp;<span class="op" id="3276079">==</span>&nbsp;<span class="num" id="3276082">0</span>&nbsp;<span class="op" id="3276084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3276089">panic</span><span class="op" id="3276094">(</span><span class="string" id="3276095">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3276122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276126">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3276130">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3276170">new</span>&nbsp;<span class="op" id="3276174">&amp;^=</span>&nbsp;<span class="ident" id="3276178">mutexRMask</span>&nbsp;<span class="op" id="3276189">|</span>&nbsp;<span class="ident" id="3276191">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276204">if</span>&nbsp;<span class="ident" id="3276207">atomic</span><span class="op" id="3276213">.</span><span class="ident" id="3276214">CompareAndSwapUint64</span><span class="op" id="3276234">(</span><span class="op" id="3276235">&amp;</span><span class="ident" id="3276236">mu</span><span class="op" id="3276238">.</span><span class="ident" id="3276239">state</span><span class="op" id="3276244">,</span>&nbsp;<span class="ident" id="3276246">old</span><span class="op" id="3276249">,</span>&nbsp;<span class="builtinfunc" id="3276251">new</span><span class="op" id="3276254">)</span>&nbsp;<span class="op" id="3276256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3276261">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3276300">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276350">for</span>&nbsp;<span class="ident" id="3276354">old</span><span class="op" id="3276357">&amp;</span><span class="ident" id="3276358">mutexRMask</span>&nbsp;<span class="op" id="3276369">!=</span>&nbsp;<span class="num" id="3276372">0</span>&nbsp;<span class="op" id="3276374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276380">old</span>&nbsp;<span class="op" id="3276384">-=</span>&nbsp;<span class="ident" id="3276387">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276402">runtime_Semrelease</span><span class="op" id="3276420">(</span><span class="op" id="3276421">&amp;</span><span class="ident" id="3276422">mu</span><span class="op" id="3276424">.</span><span class="ident" id="3276425">rsema</span><span class="op" id="3276430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276440">for</span>&nbsp;<span class="ident" id="3276444">old</span><span class="op" id="3276447">&amp;</span><span class="ident" id="3276448">mutexWMask</span>&nbsp;<span class="op" id="3276459">!=</span>&nbsp;<span class="num" id="3276462">0</span>&nbsp;<span class="op" id="3276464">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276470">old</span>&nbsp;<span class="op" id="3276474">-=</span>&nbsp;<span class="ident" id="3276477">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276492">runtime_Semrelease</span><span class="op" id="3276510">(</span><span class="op" id="3276511">&amp;</span><span class="ident" id="3276512">mu</span><span class="op" id="3276514">.</span><span class="ident" id="3276515">wsema</span><span class="op" id="3276520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276530">return</span>&nbsp;<span class="builtintype" id="3276537">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276544">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276547">}</span><br>
<span class="lineno"></span><span class="op" id="3276549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3276552">func</span>&nbsp;<span class="op" id="3276557">(</span><span class="ident" id="3276558">mu</span>&nbsp;<span class="op" id="3276561">*</span><span class="ident" id="3276562">fdMutex</span><span class="op" id="3276569">)</span>&nbsp;<span class="ident" id="3276571">Decref</span><span class="op" id="3276577">(</span><span class="op" id="3276578">)</span>&nbsp;<span class="builtintype" id="3276580">bool</span>&nbsp;<span class="op" id="3276585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276588">for</span>&nbsp;<span class="op" id="3276592">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276596">old</span>&nbsp;<span class="op" id="3276600">:=</span>&nbsp;<span class="ident" id="3276603">atomic</span><span class="op" id="3276609">.</span><span class="ident" id="3276610">LoadUint64</span><span class="op" id="3276620">(</span><span class="op" id="3276621">&amp;</span><span class="ident" id="3276622">mu</span><span class="op" id="3276624">.</span><span class="ident" id="3276625">state</span><span class="op" id="3276630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276634">if</span>&nbsp;<span class="ident" id="3276637">old</span><span class="op" id="3276640">&amp;</span><span class="ident" id="3276641">mutexRefMask</span>&nbsp;<span class="op" id="3276654">==</span>&nbsp;<span class="num" id="3276657">0</span>&nbsp;<span class="op" id="3276659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3276664">panic</span><span class="op" id="3276669">(</span><span class="string" id="3276670">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3276697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3276705">new</span>&nbsp;<span class="op" id="3276709">:=</span>&nbsp;<span class="ident" id="3276712">old</span>&nbsp;<span class="op" id="3276716">-</span>&nbsp;<span class="ident" id="3276718">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276729">if</span>&nbsp;<span class="ident" id="3276732">atomic</span><span class="op" id="3276738">.</span><span class="ident" id="3276739">CompareAndSwapUint64</span><span class="op" id="3276759">(</span><span class="op" id="3276760">&amp;</span><span class="ident" id="3276761">mu</span><span class="op" id="3276763">.</span><span class="ident" id="3276764">state</span><span class="op" id="3276769">,</span>&nbsp;<span class="ident" id="3276771">old</span><span class="op" id="3276774">,</span>&nbsp;<span class="builtinfunc" id="3276776">new</span><span class="op" id="3276779">)</span>&nbsp;<span class="op" id="3276781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276786">return</span>&nbsp;<span class="builtinfunc" id="3276793">new</span><span class="op" id="3276796">&amp;</span><span class="op" id="3276797">(</span><span class="ident" id="3276798">mutexClosed</span><span class="op" id="3276809">|</span><span class="ident" id="3276810">mutexRefMask</span><span class="op" id="3276822">)</span>&nbsp;<span class="op" id="3276824">==</span>&nbsp;<span class="ident" id="3276827">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276844">}</span><br>
<span class="lineno"></span><span class="op" id="3276846">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3276849">func</span>&nbsp;<span class="op" id="3276854">(</span><span class="ident" id="3276855">mu</span>&nbsp;<span class="op" id="3276858">*</span><span class="ident" id="3276859">fdMutex</span><span class="op" id="3276866">)</span>&nbsp;<span class="ident" id="3276868">RWLock</span><span class="op" id="3276874">(</span><span class="ident" id="3276875">read</span>&nbsp;<span class="builtintype" id="3276880">bool</span><span class="op" id="3276884">)</span>&nbsp;<span class="builtintype" id="3276886">bool</span>&nbsp;<span class="op" id="3276891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276894">var</span>&nbsp;<span class="ident" id="3276898">mutexBit</span><span class="op" id="3276906">,</span>&nbsp;<span class="ident" id="3276908">mutexWait</span><span class="op" id="3276917">,</span>&nbsp;<span class="ident" id="3276919">mutexMask</span>&nbsp;<span class="ident" id="3276929">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276937">var</span>&nbsp;<span class="ident" id="3276941">mutexSema</span>&nbsp;<span class="op" id="3276951">*</span><span class="builtintype" id="3276952">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276960">if</span>&nbsp;<span class="ident" id="3276963">read</span>&nbsp;<span class="op" id="3276968">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276972">mutexBit</span>&nbsp;<span class="op" id="3276981">=</span>&nbsp;<span class="ident" id="3276983">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276996">mutexWait</span>&nbsp;<span class="op" id="3277006">=</span>&nbsp;<span class="ident" id="3277008">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277021">mutexMask</span>&nbsp;<span class="op" id="3277031">=</span>&nbsp;<span class="ident" id="3277033">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277046">mutexSema</span>&nbsp;<span class="op" id="3277056">=</span>&nbsp;<span class="op" id="3277058">&amp;</span><span class="ident" id="3277059">mu</span><span class="op" id="3277061">.</span><span class="ident" id="3277062">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277069">}</span>&nbsp;<span class="keyword" id="3277071">else</span>&nbsp;<span class="op" id="3277076">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277080">mutexBit</span>&nbsp;<span class="op" id="3277089">=</span>&nbsp;<span class="ident" id="3277091">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277104">mutexWait</span>&nbsp;<span class="op" id="3277114">=</span>&nbsp;<span class="ident" id="3277116">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277129">mutexMask</span>&nbsp;<span class="op" id="3277139">=</span>&nbsp;<span class="ident" id="3277141">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277154">mutexSema</span>&nbsp;<span class="op" id="3277164">=</span>&nbsp;<span class="op" id="3277166">&amp;</span><span class="ident" id="3277167">mu</span><span class="op" id="3277169">.</span><span class="ident" id="3277170">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277177">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277180">for</span>&nbsp;<span class="op" id="3277184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277188">old</span>&nbsp;<span class="op" id="3277192">:=</span>&nbsp;<span class="ident" id="3277195">atomic</span><span class="op" id="3277201">.</span><span class="ident" id="3277202">LoadUint64</span><span class="op" id="3277212">(</span><span class="op" id="3277213">&amp;</span><span class="ident" id="3277214">mu</span><span class="op" id="3277216">.</span><span class="ident" id="3277217">state</span><span class="op" id="3277222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277226">if</span>&nbsp;<span class="ident" id="3277229">old</span><span class="op" id="3277232">&amp;</span><span class="ident" id="3277233">mutexClosed</span>&nbsp;<span class="op" id="3277245">!=</span>&nbsp;<span class="num" id="3277248">0</span>&nbsp;<span class="op" id="3277250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277255">return</span>&nbsp;<span class="builtintype" id="3277262">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277270">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277274">var</span>&nbsp;<span class="builtinfunc" id="3277278">new</span>&nbsp;<span class="ident" id="3277282">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277291">if</span>&nbsp;<span class="ident" id="3277294">old</span><span class="op" id="3277297">&amp;</span><span class="ident" id="3277298">mutexBit</span>&nbsp;<span class="op" id="3277307">==</span>&nbsp;<span class="num" id="3277310">0</span>&nbsp;<span class="op" id="3277312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3277317">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3277349">new</span>&nbsp;<span class="op" id="3277353">=</span>&nbsp;<span class="op" id="3277355">(</span><span class="ident" id="3277356">old</span>&nbsp;<span class="op" id="3277360">|</span>&nbsp;<span class="ident" id="3277362">mutexBit</span><span class="op" id="3277370">)</span>&nbsp;<span class="op" id="3277372">+</span>&nbsp;<span class="ident" id="3277374">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277386">if</span>&nbsp;<span class="builtinfunc" id="3277389">new</span><span class="op" id="3277392">&amp;</span><span class="ident" id="3277393">mutexRefMask</span>&nbsp;<span class="op" id="3277406">==</span>&nbsp;<span class="num" id="3277409">0</span>&nbsp;<span class="op" id="3277411">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3277417">panic</span><span class="op" id="3277422">(</span><span class="string" id="3277423">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3277450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277459">}</span>&nbsp;<span class="keyword" id="3277461">else</span>&nbsp;<span class="op" id="3277466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3277471">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3277492">new</span>&nbsp;<span class="op" id="3277496">=</span>&nbsp;<span class="ident" id="3277498">old</span>&nbsp;<span class="op" id="3277502">+</span>&nbsp;<span class="ident" id="3277504">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277517">if</span>&nbsp;<span class="builtinfunc" id="3277520">new</span><span class="op" id="3277523">&amp;</span><span class="ident" id="3277524">mutexMask</span>&nbsp;<span class="op" id="3277534">==</span>&nbsp;<span class="num" id="3277537">0</span>&nbsp;<span class="op" id="3277539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3277545">panic</span><span class="op" id="3277550">(</span><span class="string" id="3277551">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3277578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277591">if</span>&nbsp;<span class="ident" id="3277594">atomic</span><span class="op" id="3277600">.</span><span class="ident" id="3277601">CompareAndSwapUint64</span><span class="op" id="3277621">(</span><span class="op" id="3277622">&amp;</span><span class="ident" id="3277623">mu</span><span class="op" id="3277625">.</span><span class="ident" id="3277626">state</span><span class="op" id="3277631">,</span>&nbsp;<span class="ident" id="3277633">old</span><span class="op" id="3277636">,</span>&nbsp;<span class="builtinfunc" id="3277638">new</span><span class="op" id="3277641">)</span>&nbsp;<span class="op" id="3277643">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277648">if</span>&nbsp;<span class="ident" id="3277651">old</span><span class="op" id="3277654">&amp;</span><span class="ident" id="3277655">mutexBit</span>&nbsp;<span class="op" id="3277664">==</span>&nbsp;<span class="num" id="3277667">0</span>&nbsp;<span class="op" id="3277669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277675">return</span>&nbsp;<span class="builtintype" id="3277682">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277695">runtime_Semacquire</span><span class="op" id="3277713">(</span><span class="ident" id="3277714">mutexSema</span><span class="op" id="3277723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3277728">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277776">}</span><br>
<span class="lineno"></span><span class="op" id="3277778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3277781">func</span>&nbsp;<span class="op" id="3277786">(</span><span class="ident" id="3277787">mu</span>&nbsp;<span class="op" id="3277790">*</span><span class="ident" id="3277791">fdMutex</span><span class="op" id="3277798">)</span>&nbsp;<span class="ident" id="3277800">RWUnlock</span><span class="op" id="3277808">(</span><span class="ident" id="3277809">read</span>&nbsp;<span class="builtintype" id="3277814">bool</span><span class="op" id="3277818">)</span>&nbsp;<span class="builtintype" id="3277820">bool</span>&nbsp;<span class="op" id="3277825">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277828">var</span>&nbsp;<span class="ident" id="3277832">mutexBit</span><span class="op" id="3277840">,</span>&nbsp;<span class="ident" id="3277842">mutexWait</span><span class="op" id="3277851">,</span>&nbsp;<span class="ident" id="3277853">mutexMask</span>&nbsp;<span class="ident" id="3277863">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277871">var</span>&nbsp;<span class="ident" id="3277875">mutexSema</span>&nbsp;<span class="op" id="3277885">*</span><span class="builtintype" id="3277886">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277894">if</span>&nbsp;<span class="ident" id="3277897">read</span>&nbsp;<span class="op" id="3277902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277906">mutexBit</span>&nbsp;<span class="op" id="3277915">=</span>&nbsp;<span class="ident" id="3277917">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277930">mutexWait</span>&nbsp;<span class="op" id="3277940">=</span>&nbsp;<span class="ident" id="3277942">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277955">mutexMask</span>&nbsp;<span class="op" id="3277965">=</span>&nbsp;<span class="ident" id="3277967">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277980">mutexSema</span>&nbsp;<span class="op" id="3277990">=</span>&nbsp;<span class="op" id="3277992">&amp;</span><span class="ident" id="3277993">mu</span><span class="op" id="3277995">.</span><span class="ident" id="3277996">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278003">}</span>&nbsp;<span class="keyword" id="3278005">else</span>&nbsp;<span class="op" id="3278010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278014">mutexBit</span>&nbsp;<span class="op" id="3278023">=</span>&nbsp;<span class="ident" id="3278025">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278038">mutexWait</span>&nbsp;<span class="op" id="3278048">=</span>&nbsp;<span class="ident" id="3278050">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278063">mutexMask</span>&nbsp;<span class="op" id="3278073">=</span>&nbsp;<span class="ident" id="3278075">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278088">mutexSema</span>&nbsp;<span class="op" id="3278098">=</span>&nbsp;<span class="op" id="3278100">&amp;</span><span class="ident" id="3278101">mu</span><span class="op" id="3278103">.</span><span class="ident" id="3278104">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278114">for</span>&nbsp;<span class="op" id="3278118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278122">old</span>&nbsp;<span class="op" id="3278126">:=</span>&nbsp;<span class="ident" id="3278129">atomic</span><span class="op" id="3278135">.</span><span class="ident" id="3278136">LoadUint64</span><span class="op" id="3278146">(</span><span class="op" id="3278147">&amp;</span><span class="ident" id="3278148">mu</span><span class="op" id="3278150">.</span><span class="ident" id="3278151">state</span><span class="op" id="3278156">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278160">if</span>&nbsp;<span class="ident" id="3278163">old</span><span class="op" id="3278166">&amp;</span><span class="ident" id="3278167">mutexBit</span>&nbsp;<span class="op" id="3278176">==</span>&nbsp;<span class="num" id="3278179">0</span>&nbsp;<span class="op" id="3278181">||</span>&nbsp;<span class="ident" id="3278184">old</span><span class="op" id="3278187">&amp;</span><span class="ident" id="3278188">mutexRefMask</span>&nbsp;<span class="op" id="3278201">==</span>&nbsp;<span class="num" id="3278204">0</span>&nbsp;<span class="op" id="3278206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3278211">panic</span><span class="op" id="3278216">(</span><span class="string" id="3278217">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3278244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3278252">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3278316">new</span>&nbsp;<span class="op" id="3278320">:=</span>&nbsp;<span class="op" id="3278323">(</span><span class="ident" id="3278324">old</span>&nbsp;<span class="op" id="3278328">&amp;^</span>&nbsp;<span class="ident" id="3278331">mutexBit</span><span class="op" id="3278339">)</span>&nbsp;<span class="op" id="3278341">-</span>&nbsp;<span class="ident" id="3278343">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278354">if</span>&nbsp;<span class="ident" id="3278357">old</span><span class="op" id="3278360">&amp;</span><span class="ident" id="3278361">mutexMask</span>&nbsp;<span class="op" id="3278371">!=</span>&nbsp;<span class="num" id="3278374">0</span>&nbsp;<span class="op" id="3278376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3278381">new</span>&nbsp;<span class="op" id="3278385">-=</span>&nbsp;<span class="ident" id="3278388">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278404">if</span>&nbsp;<span class="ident" id="3278407">atomic</span><span class="op" id="3278413">.</span><span class="ident" id="3278414">CompareAndSwapUint64</span><span class="op" id="3278434">(</span><span class="op" id="3278435">&amp;</span><span class="ident" id="3278436">mu</span><span class="op" id="3278438">.</span><span class="ident" id="3278439">state</span><span class="op" id="3278444">,</span>&nbsp;<span class="ident" id="3278446">old</span><span class="op" id="3278449">,</span>&nbsp;<span class="builtinfunc" id="3278451">new</span><span class="op" id="3278454">)</span>&nbsp;<span class="op" id="3278456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278461">if</span>&nbsp;<span class="ident" id="3278464">old</span><span class="op" id="3278467">&amp;</span><span class="ident" id="3278468">mutexMask</span>&nbsp;<span class="op" id="3278478">!=</span>&nbsp;<span class="num" id="3278481">0</span>&nbsp;<span class="op" id="3278483">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278489">runtime_Semrelease</span><span class="op" id="3278507">(</span><span class="ident" id="3278508">mutexSema</span><span class="op" id="3278517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278527">return</span>&nbsp;<span class="builtinfunc" id="3278534">new</span><span class="op" id="3278537">&amp;</span><span class="op" id="3278538">(</span><span class="ident" id="3278539">mutexClosed</span><span class="op" id="3278550">|</span><span class="ident" id="3278551">mutexRefMask</span><span class="op" id="3278563">)</span>&nbsp;<span class="op" id="3278565">==</span>&nbsp;<span class="ident" id="3278568">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278585">}</span><br>
<span class="lineno">180</span><span class="op" id="3278587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3278590">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3278625">func</span>&nbsp;<span class="ident" id="3278630">runtime_Semacquire</span><span class="op" id="3278648">(</span><span class="ident" id="3278649">sema</span>&nbsp;<span class="op" id="3278654">*</span><span class="builtintype" id="3278655">uint32</span><span class="op" id="3278661">)</span><br>
<span class="lineno"></span><span class="keyword" id="3278663">func</span>&nbsp;<span class="ident" id="3278668">runtime_Semrelease</span><span class="op" id="3278686">(</span><span class="ident" id="3278687">sema</span>&nbsp;<span class="op" id="3278692">*</span><span class="builtintype" id="3278693">uint32</span><span class="op" id="3278699">)</span>
</div>
</body>
</html>
