<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3236599">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3236654">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3236708">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3236759">package</span>&nbsp;<span class="ident" id="3236767">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3236772">import</span>&nbsp;<span class="string" id="3236779">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3236794">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3236848">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3236904">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3236943">type</span>&nbsp;<span class="ident" id="3236948">fdMutex</span>&nbsp;<span class="keyword" id="3236956">struct</span>&nbsp;<span class="op" id="3236963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3236966">state</span>&nbsp;<span class="ident" id="3236972">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3236980">rsema</span>&nbsp;<span class="builtintype" id="3236986">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3236994">wsema</span>&nbsp;<span class="builtintype" id="3237000">uint32</span><br>
<span class="lineno"></span><span class="op" id="3237007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3237010">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3237052">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3237137">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3237174">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3237212">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3237271">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3237320">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3237370">const</span>&nbsp;<span class="op" id="3237376">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237379">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3237392">=</span>&nbsp;<span class="num" id="3237394">1</span>&nbsp;<span class="op" id="3237396">&lt;&lt;</span>&nbsp;<span class="num" id="3237399">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237402">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3237415">=</span>&nbsp;<span class="num" id="3237417">1</span>&nbsp;<span class="op" id="3237419">&lt;&lt;</span>&nbsp;<span class="num" id="3237422">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237425">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3237438">=</span>&nbsp;<span class="num" id="3237440">1</span>&nbsp;<span class="op" id="3237442">&lt;&lt;</span>&nbsp;<span class="num" id="3237445">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237448">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3237461">=</span>&nbsp;<span class="num" id="3237463">1</span>&nbsp;<span class="op" id="3237465">&lt;&lt;</span>&nbsp;<span class="num" id="3237468">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237471">mutexRefMask</span>&nbsp;<span class="op" id="3237484">=</span>&nbsp;<span class="op" id="3237486">(</span><span class="num" id="3237487">1</span><span class="op" id="3237488">&lt;&lt;</span><span class="num" id="3237490">20</span>&nbsp;<span class="op" id="3237493">-</span>&nbsp;<span class="num" id="3237495">1</span><span class="op" id="3237496">)</span>&nbsp;<span class="op" id="3237498">&lt;&lt;</span>&nbsp;<span class="num" id="3237501">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237504">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3237517">=</span>&nbsp;<span class="num" id="3237519">1</span>&nbsp;<span class="op" id="3237521">&lt;&lt;</span>&nbsp;<span class="num" id="3237524">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237528">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3237541">=</span>&nbsp;<span class="op" id="3237543">(</span><span class="num" id="3237544">1</span><span class="op" id="3237545">&lt;&lt;</span><span class="num" id="3237547">20</span>&nbsp;<span class="op" id="3237550">-</span>&nbsp;<span class="num" id="3237552">1</span><span class="op" id="3237553">)</span>&nbsp;<span class="op" id="3237555">&lt;&lt;</span>&nbsp;<span class="num" id="3237558">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237562">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3237575">=</span>&nbsp;<span class="num" id="3237577">1</span>&nbsp;<span class="op" id="3237579">&lt;&lt;</span>&nbsp;<span class="num" id="3237582">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3237586">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3237599">=</span>&nbsp;<span class="op" id="3237601">(</span><span class="num" id="3237602">1</span><span class="op" id="3237603">&lt;&lt;</span><span class="num" id="3237605">20</span>&nbsp;<span class="op" id="3237608">-</span>&nbsp;<span class="num" id="3237610">1</span><span class="op" id="3237611">)</span>&nbsp;<span class="op" id="3237613">&lt;&lt;</span>&nbsp;<span class="num" id="3237616">43</span><br>
<span class="lineno">35</span><span class="op" id="3237619">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3237622">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3237678">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3237737">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3237818">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3237895">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3237968">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3238018">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3238069">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3238113">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3238200">func</span>&nbsp;<span class="op" id="3238205">(</span><span class="ident" id="3238206">mu</span>&nbsp;<span class="op" id="3238209">*</span><span class="ident" id="3238210">fdMutex</span><span class="op" id="3238217">)</span>&nbsp;<span class="ident" id="3238219">Incref</span><span class="op" id="3238225">(</span><span class="op" id="3238226">)</span>&nbsp;<span class="builtintype" id="3238228">bool</span>&nbsp;<span class="op" id="3238233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238236">for</span>&nbsp;<span class="op" id="3238240">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3238244">old</span>&nbsp;<span class="op" id="3238248">:=</span>&nbsp;<span class="ident" id="3238251">atomic</span><span class="op" id="3238257">.</span><span class="ident" id="3238258">LoadUint64</span><span class="op" id="3238268">(</span><span class="op" id="3238269">&amp;</span><span class="ident" id="3238270">mu</span><span class="op" id="3238272">.</span><span class="ident" id="3238273">state</span><span class="op" id="3238278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238282">if</span>&nbsp;<span class="ident" id="3238285">old</span><span class="op" id="3238288">&amp;</span><span class="ident" id="3238289">mutexClosed</span>&nbsp;<span class="op" id="3238301">!=</span>&nbsp;<span class="num" id="3238304">0</span>&nbsp;<span class="op" id="3238306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238311">return</span>&nbsp;<span class="builtintype" id="3238318">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3238326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3238330">new</span>&nbsp;<span class="op" id="3238334">:=</span>&nbsp;<span class="ident" id="3238337">old</span>&nbsp;<span class="op" id="3238341">+</span>&nbsp;<span class="ident" id="3238343">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238354">if</span>&nbsp;<span class="builtinfunc" id="3238357">new</span><span class="op" id="3238360">&amp;</span><span class="ident" id="3238361">mutexRefMask</span>&nbsp;<span class="op" id="3238374">==</span>&nbsp;<span class="num" id="3238377">0</span>&nbsp;<span class="op" id="3238379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3238384">panic</span><span class="op" id="3238389">(</span><span class="string" id="3238390">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3238417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3238421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238425">if</span>&nbsp;<span class="ident" id="3238428">atomic</span><span class="op" id="3238434">.</span><span class="ident" id="3238435">CompareAndSwapUint64</span><span class="op" id="3238455">(</span><span class="op" id="3238456">&amp;</span><span class="ident" id="3238457">mu</span><span class="op" id="3238459">.</span><span class="ident" id="3238460">state</span><span class="op" id="3238465">,</span>&nbsp;<span class="ident" id="3238467">old</span><span class="op" id="3238470">,</span>&nbsp;<span class="builtinfunc" id="3238472">new</span><span class="op" id="3238475">)</span>&nbsp;<span class="op" id="3238477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238482">return</span>&nbsp;<span class="builtintype" id="3238489">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3238496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3238499">}</span><br>
<span class="lineno"></span><span class="op" id="3238501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3238504">func</span>&nbsp;<span class="op" id="3238509">(</span><span class="ident" id="3238510">mu</span>&nbsp;<span class="op" id="3238513">*</span><span class="ident" id="3238514">fdMutex</span><span class="op" id="3238521">)</span>&nbsp;<span class="ident" id="3238523">IncrefAndClose</span><span class="op" id="3238537">(</span><span class="op" id="3238538">)</span>&nbsp;<span class="builtintype" id="3238540">bool</span>&nbsp;<span class="op" id="3238545">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238548">for</span>&nbsp;<span class="op" id="3238552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3238556">old</span>&nbsp;<span class="op" id="3238560">:=</span>&nbsp;<span class="ident" id="3238563">atomic</span><span class="op" id="3238569">.</span><span class="ident" id="3238570">LoadUint64</span><span class="op" id="3238580">(</span><span class="op" id="3238581">&amp;</span><span class="ident" id="3238582">mu</span><span class="op" id="3238584">.</span><span class="ident" id="3238585">state</span><span class="op" id="3238590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238594">if</span>&nbsp;<span class="ident" id="3238597">old</span><span class="op" id="3238600">&amp;</span><span class="ident" id="3238601">mutexClosed</span>&nbsp;<span class="op" id="3238613">!=</span>&nbsp;<span class="num" id="3238616">0</span>&nbsp;<span class="op" id="3238618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238623">return</span>&nbsp;<span class="builtintype" id="3238630">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3238638">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3238642">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3238687">new</span>&nbsp;<span class="op" id="3238691">:=</span>&nbsp;<span class="op" id="3238694">(</span><span class="ident" id="3238695">old</span>&nbsp;<span class="op" id="3238699">|</span>&nbsp;<span class="ident" id="3238701">mutexClosed</span><span class="op" id="3238712">)</span>&nbsp;<span class="op" id="3238714">+</span>&nbsp;<span class="ident" id="3238716">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238727">if</span>&nbsp;<span class="builtinfunc" id="3238730">new</span><span class="op" id="3238733">&amp;</span><span class="ident" id="3238734">mutexRefMask</span>&nbsp;<span class="op" id="3238747">==</span>&nbsp;<span class="num" id="3238750">0</span>&nbsp;<span class="op" id="3238752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3238757">panic</span><span class="op" id="3238762">(</span><span class="string" id="3238763">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3238790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3238794">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3238798">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3238838">new</span>&nbsp;<span class="op" id="3238842">&amp;^=</span>&nbsp;<span class="ident" id="3238846">mutexRMask</span>&nbsp;<span class="op" id="3238857">|</span>&nbsp;<span class="ident" id="3238859">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238872">if</span>&nbsp;<span class="ident" id="3238875">atomic</span><span class="op" id="3238881">.</span><span class="ident" id="3238882">CompareAndSwapUint64</span><span class="op" id="3238902">(</span><span class="op" id="3238903">&amp;</span><span class="ident" id="3238904">mu</span><span class="op" id="3238906">.</span><span class="ident" id="3238907">state</span><span class="op" id="3238912">,</span>&nbsp;<span class="ident" id="3238914">old</span><span class="op" id="3238917">,</span>&nbsp;<span class="builtinfunc" id="3238919">new</span><span class="op" id="3238922">)</span>&nbsp;<span class="op" id="3238924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3238929">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3238968">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239018">for</span>&nbsp;<span class="ident" id="3239022">old</span><span class="op" id="3239025">&amp;</span><span class="ident" id="3239026">mutexRMask</span>&nbsp;<span class="op" id="3239037">!=</span>&nbsp;<span class="num" id="3239040">0</span>&nbsp;<span class="op" id="3239042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239048">old</span>&nbsp;<span class="op" id="3239052">-=</span>&nbsp;<span class="ident" id="3239055">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239070">runtime_Semrelease</span><span class="op" id="3239088">(</span><span class="op" id="3239089">&amp;</span><span class="ident" id="3239090">mu</span><span class="op" id="3239092">.</span><span class="ident" id="3239093">rsema</span><span class="op" id="3239098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239108">for</span>&nbsp;<span class="ident" id="3239112">old</span><span class="op" id="3239115">&amp;</span><span class="ident" id="3239116">mutexWMask</span>&nbsp;<span class="op" id="3239127">!=</span>&nbsp;<span class="num" id="3239130">0</span>&nbsp;<span class="op" id="3239132">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239138">old</span>&nbsp;<span class="op" id="3239142">-=</span>&nbsp;<span class="ident" id="3239145">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239160">runtime_Semrelease</span><span class="op" id="3239178">(</span><span class="op" id="3239179">&amp;</span><span class="ident" id="3239180">mu</span><span class="op" id="3239182">.</span><span class="ident" id="3239183">wsema</span><span class="op" id="3239188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239198">return</span>&nbsp;<span class="builtintype" id="3239205">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239212">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239215">}</span><br>
<span class="lineno"></span><span class="op" id="3239217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3239220">func</span>&nbsp;<span class="op" id="3239225">(</span><span class="ident" id="3239226">mu</span>&nbsp;<span class="op" id="3239229">*</span><span class="ident" id="3239230">fdMutex</span><span class="op" id="3239237">)</span>&nbsp;<span class="ident" id="3239239">Decref</span><span class="op" id="3239245">(</span><span class="op" id="3239246">)</span>&nbsp;<span class="builtintype" id="3239248">bool</span>&nbsp;<span class="op" id="3239253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239256">for</span>&nbsp;<span class="op" id="3239260">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239264">old</span>&nbsp;<span class="op" id="3239268">:=</span>&nbsp;<span class="ident" id="3239271">atomic</span><span class="op" id="3239277">.</span><span class="ident" id="3239278">LoadUint64</span><span class="op" id="3239288">(</span><span class="op" id="3239289">&amp;</span><span class="ident" id="3239290">mu</span><span class="op" id="3239292">.</span><span class="ident" id="3239293">state</span><span class="op" id="3239298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239302">if</span>&nbsp;<span class="ident" id="3239305">old</span><span class="op" id="3239308">&amp;</span><span class="ident" id="3239309">mutexRefMask</span>&nbsp;<span class="op" id="3239322">==</span>&nbsp;<span class="num" id="3239325">0</span>&nbsp;<span class="op" id="3239327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3239332">panic</span><span class="op" id="3239337">(</span><span class="string" id="3239338">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3239365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3239373">new</span>&nbsp;<span class="op" id="3239377">:=</span>&nbsp;<span class="ident" id="3239380">old</span>&nbsp;<span class="op" id="3239384">-</span>&nbsp;<span class="ident" id="3239386">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239397">if</span>&nbsp;<span class="ident" id="3239400">atomic</span><span class="op" id="3239406">.</span><span class="ident" id="3239407">CompareAndSwapUint64</span><span class="op" id="3239427">(</span><span class="op" id="3239428">&amp;</span><span class="ident" id="3239429">mu</span><span class="op" id="3239431">.</span><span class="ident" id="3239432">state</span><span class="op" id="3239437">,</span>&nbsp;<span class="ident" id="3239439">old</span><span class="op" id="3239442">,</span>&nbsp;<span class="builtinfunc" id="3239444">new</span><span class="op" id="3239447">)</span>&nbsp;<span class="op" id="3239449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239454">return</span>&nbsp;<span class="builtinfunc" id="3239461">new</span><span class="op" id="3239464">&amp;</span><span class="op" id="3239465">(</span><span class="ident" id="3239466">mutexClosed</span><span class="op" id="3239477">|</span><span class="ident" id="3239478">mutexRefMask</span><span class="op" id="3239490">)</span>&nbsp;<span class="op" id="3239492">==</span>&nbsp;<span class="ident" id="3239495">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239512">}</span><br>
<span class="lineno"></span><span class="op" id="3239514">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3239517">func</span>&nbsp;<span class="op" id="3239522">(</span><span class="ident" id="3239523">mu</span>&nbsp;<span class="op" id="3239526">*</span><span class="ident" id="3239527">fdMutex</span><span class="op" id="3239534">)</span>&nbsp;<span class="ident" id="3239536">RWLock</span><span class="op" id="3239542">(</span><span class="ident" id="3239543">read</span>&nbsp;<span class="builtintype" id="3239548">bool</span><span class="op" id="3239552">)</span>&nbsp;<span class="builtintype" id="3239554">bool</span>&nbsp;<span class="op" id="3239559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239562">var</span>&nbsp;<span class="ident" id="3239566">mutexBit</span><span class="op" id="3239574">,</span>&nbsp;<span class="ident" id="3239576">mutexWait</span><span class="op" id="3239585">,</span>&nbsp;<span class="ident" id="3239587">mutexMask</span>&nbsp;<span class="ident" id="3239597">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239605">var</span>&nbsp;<span class="ident" id="3239609">mutexSema</span>&nbsp;<span class="op" id="3239619">*</span><span class="builtintype" id="3239620">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239628">if</span>&nbsp;<span class="ident" id="3239631">read</span>&nbsp;<span class="op" id="3239636">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239640">mutexBit</span>&nbsp;<span class="op" id="3239649">=</span>&nbsp;<span class="ident" id="3239651">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239664">mutexWait</span>&nbsp;<span class="op" id="3239674">=</span>&nbsp;<span class="ident" id="3239676">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239689">mutexMask</span>&nbsp;<span class="op" id="3239699">=</span>&nbsp;<span class="ident" id="3239701">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239714">mutexSema</span>&nbsp;<span class="op" id="3239724">=</span>&nbsp;<span class="op" id="3239726">&amp;</span><span class="ident" id="3239727">mu</span><span class="op" id="3239729">.</span><span class="ident" id="3239730">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239737">}</span>&nbsp;<span class="keyword" id="3239739">else</span>&nbsp;<span class="op" id="3239744">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239748">mutexBit</span>&nbsp;<span class="op" id="3239757">=</span>&nbsp;<span class="ident" id="3239759">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239772">mutexWait</span>&nbsp;<span class="op" id="3239782">=</span>&nbsp;<span class="ident" id="3239784">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239797">mutexMask</span>&nbsp;<span class="op" id="3239807">=</span>&nbsp;<span class="ident" id="3239809">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239822">mutexSema</span>&nbsp;<span class="op" id="3239832">=</span>&nbsp;<span class="op" id="3239834">&amp;</span><span class="ident" id="3239835">mu</span><span class="op" id="3239837">.</span><span class="ident" id="3239838">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239845">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239848">for</span>&nbsp;<span class="op" id="3239852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239856">old</span>&nbsp;<span class="op" id="3239860">:=</span>&nbsp;<span class="ident" id="3239863">atomic</span><span class="op" id="3239869">.</span><span class="ident" id="3239870">LoadUint64</span><span class="op" id="3239880">(</span><span class="op" id="3239881">&amp;</span><span class="ident" id="3239882">mu</span><span class="op" id="3239884">.</span><span class="ident" id="3239885">state</span><span class="op" id="3239890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239894">if</span>&nbsp;<span class="ident" id="3239897">old</span><span class="op" id="3239900">&amp;</span><span class="ident" id="3239901">mutexClosed</span>&nbsp;<span class="op" id="3239913">!=</span>&nbsp;<span class="num" id="3239916">0</span>&nbsp;<span class="op" id="3239918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239923">return</span>&nbsp;<span class="builtintype" id="3239930">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3239938">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239942">var</span>&nbsp;<span class="builtinfunc" id="3239946">new</span>&nbsp;<span class="ident" id="3239950">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3239959">if</span>&nbsp;<span class="ident" id="3239962">old</span><span class="op" id="3239965">&amp;</span><span class="ident" id="3239966">mutexBit</span>&nbsp;<span class="op" id="3239975">==</span>&nbsp;<span class="num" id="3239978">0</span>&nbsp;<span class="op" id="3239980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3239985">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3240017">new</span>&nbsp;<span class="op" id="3240021">=</span>&nbsp;<span class="op" id="3240023">(</span><span class="ident" id="3240024">old</span>&nbsp;<span class="op" id="3240028">|</span>&nbsp;<span class="ident" id="3240030">mutexBit</span><span class="op" id="3240038">)</span>&nbsp;<span class="op" id="3240040">+</span>&nbsp;<span class="ident" id="3240042">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240054">if</span>&nbsp;<span class="builtinfunc" id="3240057">new</span><span class="op" id="3240060">&amp;</span><span class="ident" id="3240061">mutexRefMask</span>&nbsp;<span class="op" id="3240074">==</span>&nbsp;<span class="num" id="3240077">0</span>&nbsp;<span class="op" id="3240079">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3240085">panic</span><span class="op" id="3240090">(</span><span class="string" id="3240091">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3240118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240127">}</span>&nbsp;<span class="keyword" id="3240129">else</span>&nbsp;<span class="op" id="3240134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3240139">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3240160">new</span>&nbsp;<span class="op" id="3240164">=</span>&nbsp;<span class="ident" id="3240166">old</span>&nbsp;<span class="op" id="3240170">+</span>&nbsp;<span class="ident" id="3240172">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240185">if</span>&nbsp;<span class="builtinfunc" id="3240188">new</span><span class="op" id="3240191">&amp;</span><span class="ident" id="3240192">mutexMask</span>&nbsp;<span class="op" id="3240202">==</span>&nbsp;<span class="num" id="3240205">0</span>&nbsp;<span class="op" id="3240207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3240213">panic</span><span class="op" id="3240218">(</span><span class="string" id="3240219">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3240246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240259">if</span>&nbsp;<span class="ident" id="3240262">atomic</span><span class="op" id="3240268">.</span><span class="ident" id="3240269">CompareAndSwapUint64</span><span class="op" id="3240289">(</span><span class="op" id="3240290">&amp;</span><span class="ident" id="3240291">mu</span><span class="op" id="3240293">.</span><span class="ident" id="3240294">state</span><span class="op" id="3240299">,</span>&nbsp;<span class="ident" id="3240301">old</span><span class="op" id="3240304">,</span>&nbsp;<span class="builtinfunc" id="3240306">new</span><span class="op" id="3240309">)</span>&nbsp;<span class="op" id="3240311">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240316">if</span>&nbsp;<span class="ident" id="3240319">old</span><span class="op" id="3240322">&amp;</span><span class="ident" id="3240323">mutexBit</span>&nbsp;<span class="op" id="3240332">==</span>&nbsp;<span class="num" id="3240335">0</span>&nbsp;<span class="op" id="3240337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240343">return</span>&nbsp;<span class="builtintype" id="3240350">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240363">runtime_Semacquire</span><span class="op" id="3240381">(</span><span class="ident" id="3240382">mutexSema</span><span class="op" id="3240391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3240396">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240444">}</span><br>
<span class="lineno"></span><span class="op" id="3240446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3240449">func</span>&nbsp;<span class="op" id="3240454">(</span><span class="ident" id="3240455">mu</span>&nbsp;<span class="op" id="3240458">*</span><span class="ident" id="3240459">fdMutex</span><span class="op" id="3240466">)</span>&nbsp;<span class="ident" id="3240468">RWUnlock</span><span class="op" id="3240476">(</span><span class="ident" id="3240477">read</span>&nbsp;<span class="builtintype" id="3240482">bool</span><span class="op" id="3240486">)</span>&nbsp;<span class="builtintype" id="3240488">bool</span>&nbsp;<span class="op" id="3240493">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240496">var</span>&nbsp;<span class="ident" id="3240500">mutexBit</span><span class="op" id="3240508">,</span>&nbsp;<span class="ident" id="3240510">mutexWait</span><span class="op" id="3240519">,</span>&nbsp;<span class="ident" id="3240521">mutexMask</span>&nbsp;<span class="ident" id="3240531">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240539">var</span>&nbsp;<span class="ident" id="3240543">mutexSema</span>&nbsp;<span class="op" id="3240553">*</span><span class="builtintype" id="3240554">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240562">if</span>&nbsp;<span class="ident" id="3240565">read</span>&nbsp;<span class="op" id="3240570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240574">mutexBit</span>&nbsp;<span class="op" id="3240583">=</span>&nbsp;<span class="ident" id="3240585">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240598">mutexWait</span>&nbsp;<span class="op" id="3240608">=</span>&nbsp;<span class="ident" id="3240610">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240623">mutexMask</span>&nbsp;<span class="op" id="3240633">=</span>&nbsp;<span class="ident" id="3240635">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240648">mutexSema</span>&nbsp;<span class="op" id="3240658">=</span>&nbsp;<span class="op" id="3240660">&amp;</span><span class="ident" id="3240661">mu</span><span class="op" id="3240663">.</span><span class="ident" id="3240664">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240671">}</span>&nbsp;<span class="keyword" id="3240673">else</span>&nbsp;<span class="op" id="3240678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240682">mutexBit</span>&nbsp;<span class="op" id="3240691">=</span>&nbsp;<span class="ident" id="3240693">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240706">mutexWait</span>&nbsp;<span class="op" id="3240716">=</span>&nbsp;<span class="ident" id="3240718">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240731">mutexMask</span>&nbsp;<span class="op" id="3240741">=</span>&nbsp;<span class="ident" id="3240743">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240756">mutexSema</span>&nbsp;<span class="op" id="3240766">=</span>&nbsp;<span class="op" id="3240768">&amp;</span><span class="ident" id="3240769">mu</span><span class="op" id="3240771">.</span><span class="ident" id="3240772">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240782">for</span>&nbsp;<span class="op" id="3240786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3240790">old</span>&nbsp;<span class="op" id="3240794">:=</span>&nbsp;<span class="ident" id="3240797">atomic</span><span class="op" id="3240803">.</span><span class="ident" id="3240804">LoadUint64</span><span class="op" id="3240814">(</span><span class="op" id="3240815">&amp;</span><span class="ident" id="3240816">mu</span><span class="op" id="3240818">.</span><span class="ident" id="3240819">state</span><span class="op" id="3240824">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3240828">if</span>&nbsp;<span class="ident" id="3240831">old</span><span class="op" id="3240834">&amp;</span><span class="ident" id="3240835">mutexBit</span>&nbsp;<span class="op" id="3240844">==</span>&nbsp;<span class="num" id="3240847">0</span>&nbsp;<span class="op" id="3240849">||</span>&nbsp;<span class="ident" id="3240852">old</span><span class="op" id="3240855">&amp;</span><span class="ident" id="3240856">mutexRefMask</span>&nbsp;<span class="op" id="3240869">==</span>&nbsp;<span class="num" id="3240872">0</span>&nbsp;<span class="op" id="3240874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3240879">panic</span><span class="op" id="3240884">(</span><span class="string" id="3240885">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3240912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3240916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3240920">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3240984">new</span>&nbsp;<span class="op" id="3240988">:=</span>&nbsp;<span class="op" id="3240991">(</span><span class="ident" id="3240992">old</span>&nbsp;<span class="op" id="3240996">&amp;^</span>&nbsp;<span class="ident" id="3240999">mutexBit</span><span class="op" id="3241007">)</span>&nbsp;<span class="op" id="3241009">-</span>&nbsp;<span class="ident" id="3241011">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3241022">if</span>&nbsp;<span class="ident" id="3241025">old</span><span class="op" id="3241028">&amp;</span><span class="ident" id="3241029">mutexMask</span>&nbsp;<span class="op" id="3241039">!=</span>&nbsp;<span class="num" id="3241042">0</span>&nbsp;<span class="op" id="3241044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3241049">new</span>&nbsp;<span class="op" id="3241053">-=</span>&nbsp;<span class="ident" id="3241056">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3241068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3241072">if</span>&nbsp;<span class="ident" id="3241075">atomic</span><span class="op" id="3241081">.</span><span class="ident" id="3241082">CompareAndSwapUint64</span><span class="op" id="3241102">(</span><span class="op" id="3241103">&amp;</span><span class="ident" id="3241104">mu</span><span class="op" id="3241106">.</span><span class="ident" id="3241107">state</span><span class="op" id="3241112">,</span>&nbsp;<span class="ident" id="3241114">old</span><span class="op" id="3241117">,</span>&nbsp;<span class="builtinfunc" id="3241119">new</span><span class="op" id="3241122">)</span>&nbsp;<span class="op" id="3241124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3241129">if</span>&nbsp;<span class="ident" id="3241132">old</span><span class="op" id="3241135">&amp;</span><span class="ident" id="3241136">mutexMask</span>&nbsp;<span class="op" id="3241146">!=</span>&nbsp;<span class="num" id="3241149">0</span>&nbsp;<span class="op" id="3241151">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3241157">runtime_Semrelease</span><span class="op" id="3241175">(</span><span class="ident" id="3241176">mutexSema</span><span class="op" id="3241185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3241190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3241195">return</span>&nbsp;<span class="builtinfunc" id="3241202">new</span><span class="op" id="3241205">&amp;</span><span class="op" id="3241206">(</span><span class="ident" id="3241207">mutexClosed</span><span class="op" id="3241218">|</span><span class="ident" id="3241219">mutexRefMask</span><span class="op" id="3241231">)</span>&nbsp;<span class="op" id="3241233">==</span>&nbsp;<span class="ident" id="3241236">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3241250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3241253">}</span><br>
<span class="lineno">180</span><span class="op" id="3241255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3241258">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3241293">func</span>&nbsp;<span class="ident" id="3241298">runtime_Semacquire</span><span class="op" id="3241316">(</span><span class="ident" id="3241317">sema</span>&nbsp;<span class="op" id="3241322">*</span><span class="builtintype" id="3241323">uint32</span><span class="op" id="3241329">)</span><br>
<span class="lineno"></span><span class="keyword" id="3241331">func</span>&nbsp;<span class="ident" id="3241336">runtime_Semrelease</span><span class="op" id="3241354">(</span><span class="ident" id="3241355">sema</span>&nbsp;<span class="op" id="3241360">*</span><span class="builtintype" id="3241361">uint32</span><span class="op" id="3241367">)</span>
</div>
</body>
</html>
