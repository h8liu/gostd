<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3430508">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3430564">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3430618">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3430669">package</span>&nbsp;<span class="ident" id="3430677">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3430682">import</span>&nbsp;<span class="string" id="3430689">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3430697">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3430755">type</span>&nbsp;<span class="ident" id="3430760">call</span>&nbsp;<span class="keyword" id="3430765">struct</span>&nbsp;<span class="op" id="3430772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430775">wg</span>&nbsp;<span class="ident" id="3430778">sync</span><span class="op" id="3430782">.</span><span class="ident" id="3430783">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430795">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430858">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430909">val</span>&nbsp;<span class="keyword" id="3430913">interface</span><span class="op" id="3430922">{</span><span class="op" id="3430923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430926">err</span>&nbsp;<span class="builtintype" id="3430930">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430938">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430998">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3431060">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431105">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3431111">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431116">chans</span>&nbsp;<span class="op" id="3431122">[</span><span class="op" id="3431123">]</span><span class="keyword" id="3431124">chan</span><span class="op" id="3431128">&lt;-</span>&nbsp;<span class="ident" id="3431131">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3431150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3431153">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3431221">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3431288">type</span>&nbsp;<span class="ident" id="3431293">singleflight</span>&nbsp;<span class="keyword" id="3431306">struct</span>&nbsp;<span class="op" id="3431313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431316">mu</span>&nbsp;<span class="ident" id="3431319">sync</span><span class="op" id="3431323">.</span><span class="ident" id="3431324">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3431336">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431351">m</span>&nbsp;&nbsp;<span class="keyword" id="3431354">map</span><span class="op" id="3431357">[</span><span class="builtintype" id="3431358">string</span><span class="op" id="3431364">]</span><span class="op" id="3431365">*</span><span class="ident" id="3431366">call</span>&nbsp;<span class="comment" id="3431371">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3431393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3431396">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3431465">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3431482">type</span>&nbsp;<span class="ident" id="3431487">singleflightResult</span>&nbsp;<span class="keyword" id="3431506">struct</span>&nbsp;<span class="op" id="3431513">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431516">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3431523">interface</span><span class="op" id="3431532">{</span><span class="op" id="3431533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431536">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3431543">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431550">shared</span>&nbsp;<span class="builtintype" id="3431557">bool</span><br>
<span class="lineno"></span><span class="op" id="3431562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3431565">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3431634">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3431700">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3431769">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3431824">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3431902">func</span>&nbsp;<span class="op" id="3431907">(</span><span class="ident" id="3431908">g</span>&nbsp;<span class="op" id="3431910">*</span><span class="ident" id="3431911">singleflight</span><span class="op" id="3431923">)</span>&nbsp;<span class="ident" id="3431925">Do</span><span class="op" id="3431927">(</span><span class="ident" id="3431928">key</span>&nbsp;<span class="builtintype" id="3431932">string</span><span class="op" id="3431938">,</span>&nbsp;<span class="ident" id="3431940">fn</span>&nbsp;<span class="keyword" id="3431943">func</span><span class="op" id="3431947">(</span><span class="op" id="3431948">)</span>&nbsp;<span class="op" id="3431950">(</span><span class="keyword" id="3431951">interface</span><span class="op" id="3431960">{</span><span class="op" id="3431961">}</span><span class="op" id="3431962">,</span>&nbsp;<span class="builtintype" id="3431964">error</span><span class="op" id="3431969">)</span><span class="op" id="3431970">)</span>&nbsp;<span class="op" id="3431972">(</span><span class="ident" id="3431973">v</span>&nbsp;<span class="keyword" id="3431975">interface</span><span class="op" id="3431984">{</span><span class="op" id="3431985">}</span><span class="op" id="3431986">,</span>&nbsp;<span class="ident" id="3431988">err</span>&nbsp;<span class="builtintype" id="3431992">error</span><span class="op" id="3431997">,</span>&nbsp;<span class="ident" id="3431999">shared</span>&nbsp;<span class="builtintype" id="3432006">bool</span><span class="op" id="3432010">)</span>&nbsp;<span class="op" id="3432012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432015">g</span><span class="op" id="3432016">.</span><span class="ident" id="3432017">mu</span><span class="op" id="3432019">.</span><span class="ident" id="3432020">Lock</span><span class="op" id="3432024">(</span><span class="op" id="3432025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432028">if</span>&nbsp;<span class="ident" id="3432031">g</span><span class="op" id="3432032">.</span><span class="ident" id="3432033">m</span>&nbsp;<span class="op" id="3432035">==</span>&nbsp;<span class="ident" id="3432038">nil</span>&nbsp;<span class="op" id="3432042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432046">g</span><span class="op" id="3432047">.</span><span class="ident" id="3432048">m</span>&nbsp;<span class="op" id="3432050">=</span>&nbsp;<span class="builtinfunc" id="3432052">make</span><span class="op" id="3432056">(</span><span class="keyword" id="3432057">map</span><span class="op" id="3432060">[</span><span class="builtintype" id="3432061">string</span><span class="op" id="3432067">]</span><span class="op" id="3432068">*</span><span class="ident" id="3432069">call</span><span class="op" id="3432073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432076">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432079">if</span>&nbsp;<span class="ident" id="3432082">c</span><span class="op" id="3432083">,</span>&nbsp;<span class="ident" id="3432085">ok</span>&nbsp;<span class="op" id="3432088">:=</span>&nbsp;<span class="ident" id="3432091">g</span><span class="op" id="3432092">.</span><span class="ident" id="3432093">m</span><span class="op" id="3432094">[</span><span class="ident" id="3432095">key</span><span class="op" id="3432098">]</span><span class="op" id="3432099">;</span>&nbsp;<span class="ident" id="3432101">ok</span>&nbsp;<span class="op" id="3432104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432108">c</span><span class="op" id="3432109">.</span><span class="ident" id="3432110">dups</span><span class="op" id="3432114">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432119">g</span><span class="op" id="3432120">.</span><span class="ident" id="3432121">mu</span><span class="op" id="3432123">.</span><span class="ident" id="3432124">Unlock</span><span class="op" id="3432130">(</span><span class="op" id="3432131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432135">c</span><span class="op" id="3432136">.</span><span class="ident" id="3432137">wg</span><span class="op" id="3432139">.</span><span class="ident" id="3432140">Wait</span><span class="op" id="3432144">(</span><span class="op" id="3432145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432149">return</span>&nbsp;<span class="ident" id="3432156">c</span><span class="op" id="3432157">.</span><span class="ident" id="3432158">val</span><span class="op" id="3432161">,</span>&nbsp;<span class="ident" id="3432163">c</span><span class="op" id="3432164">.</span><span class="ident" id="3432165">err</span><span class="op" id="3432168">,</span>&nbsp;<span class="ident" id="3432170">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432179">c</span>&nbsp;<span class="op" id="3432181">:=</span>&nbsp;<span class="builtinfunc" id="3432184">new</span><span class="op" id="3432187">(</span><span class="ident" id="3432188">call</span><span class="op" id="3432192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432195">c</span><span class="op" id="3432196">.</span><span class="ident" id="3432197">wg</span><span class="op" id="3432199">.</span><span class="ident" id="3432200">Add</span><span class="op" id="3432203">(</span><span class="num" id="3432204">1</span><span class="op" id="3432205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432208">g</span><span class="op" id="3432209">.</span><span class="ident" id="3432210">m</span><span class="op" id="3432211">[</span><span class="ident" id="3432212">key</span><span class="op" id="3432215">]</span>&nbsp;<span class="op" id="3432217">=</span>&nbsp;<span class="ident" id="3432219">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432222">g</span><span class="op" id="3432223">.</span><span class="ident" id="3432224">mu</span><span class="op" id="3432226">.</span><span class="ident" id="3432227">Unlock</span><span class="op" id="3432233">(</span><span class="op" id="3432234">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432238">g</span><span class="op" id="3432239">.</span><span class="ident" id="3432240">doCall</span><span class="op" id="3432246">(</span><span class="ident" id="3432247">c</span><span class="op" id="3432248">,</span>&nbsp;<span class="ident" id="3432250">key</span><span class="op" id="3432253">,</span>&nbsp;<span class="ident" id="3432255">fn</span><span class="op" id="3432257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432260">return</span>&nbsp;<span class="ident" id="3432267">c</span><span class="op" id="3432268">.</span><span class="ident" id="3432269">val</span><span class="op" id="3432272">,</span>&nbsp;<span class="ident" id="3432274">c</span><span class="op" id="3432275">.</span><span class="ident" id="3432276">err</span><span class="op" id="3432279">,</span>&nbsp;<span class="ident" id="3432281">c</span><span class="op" id="3432282">.</span><span class="ident" id="3432283">dups</span>&nbsp;<span class="op" id="3432288">&gt;</span>&nbsp;<span class="num" id="3432290">0</span><br>
<span class="lineno"></span><span class="op" id="3432292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3432295">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3432360">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3432392">func</span>&nbsp;<span class="op" id="3432397">(</span><span class="ident" id="3432398">g</span>&nbsp;<span class="op" id="3432400">*</span><span class="ident" id="3432401">singleflight</span><span class="op" id="3432413">)</span>&nbsp;<span class="ident" id="3432415">DoChan</span><span class="op" id="3432421">(</span><span class="ident" id="3432422">key</span>&nbsp;<span class="builtintype" id="3432426">string</span><span class="op" id="3432432">,</span>&nbsp;<span class="ident" id="3432434">fn</span>&nbsp;<span class="keyword" id="3432437">func</span><span class="op" id="3432441">(</span><span class="op" id="3432442">)</span>&nbsp;<span class="op" id="3432444">(</span><span class="keyword" id="3432445">interface</span><span class="op" id="3432454">{</span><span class="op" id="3432455">}</span><span class="op" id="3432456">,</span>&nbsp;<span class="builtintype" id="3432458">error</span><span class="op" id="3432463">)</span><span class="op" id="3432464">)</span>&nbsp;<span class="op" id="3432466">&lt;-</span><span class="keyword" id="3432468">chan</span>&nbsp;<span class="ident" id="3432473">singleflightResult</span>&nbsp;<span class="op" id="3432492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432495">ch</span>&nbsp;<span class="op" id="3432498">:=</span>&nbsp;<span class="builtinfunc" id="3432501">make</span><span class="op" id="3432505">(</span><span class="keyword" id="3432506">chan</span>&nbsp;<span class="ident" id="3432511">singleflightResult</span><span class="op" id="3432529">,</span>&nbsp;<span class="num" id="3432531">1</span><span class="op" id="3432532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432535">g</span><span class="op" id="3432536">.</span><span class="ident" id="3432537">mu</span><span class="op" id="3432539">.</span><span class="ident" id="3432540">Lock</span><span class="op" id="3432544">(</span><span class="op" id="3432545">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432548">if</span>&nbsp;<span class="ident" id="3432551">g</span><span class="op" id="3432552">.</span><span class="ident" id="3432553">m</span>&nbsp;<span class="op" id="3432555">==</span>&nbsp;<span class="ident" id="3432558">nil</span>&nbsp;<span class="op" id="3432562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432566">g</span><span class="op" id="3432567">.</span><span class="ident" id="3432568">m</span>&nbsp;<span class="op" id="3432570">=</span>&nbsp;<span class="builtinfunc" id="3432572">make</span><span class="op" id="3432576">(</span><span class="keyword" id="3432577">map</span><span class="op" id="3432580">[</span><span class="builtintype" id="3432581">string</span><span class="op" id="3432587">]</span><span class="op" id="3432588">*</span><span class="ident" id="3432589">call</span><span class="op" id="3432593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432599">if</span>&nbsp;<span class="ident" id="3432602">c</span><span class="op" id="3432603">,</span>&nbsp;<span class="ident" id="3432605">ok</span>&nbsp;<span class="op" id="3432608">:=</span>&nbsp;<span class="ident" id="3432611">g</span><span class="op" id="3432612">.</span><span class="ident" id="3432613">m</span><span class="op" id="3432614">[</span><span class="ident" id="3432615">key</span><span class="op" id="3432618">]</span><span class="op" id="3432619">;</span>&nbsp;<span class="ident" id="3432621">ok</span>&nbsp;<span class="op" id="3432624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432628">c</span><span class="op" id="3432629">.</span><span class="ident" id="3432630">dups</span><span class="op" id="3432634">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432639">c</span><span class="op" id="3432640">.</span><span class="ident" id="3432641">chans</span>&nbsp;<span class="op" id="3432647">=</span>&nbsp;<span class="builtinfunc" id="3432649">append</span><span class="op" id="3432655">(</span><span class="ident" id="3432656">c</span><span class="op" id="3432657">.</span><span class="ident" id="3432658">chans</span><span class="op" id="3432663">,</span>&nbsp;<span class="ident" id="3432665">ch</span><span class="op" id="3432667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432671">g</span><span class="op" id="3432672">.</span><span class="ident" id="3432673">mu</span><span class="op" id="3432675">.</span><span class="ident" id="3432676">Unlock</span><span class="op" id="3432682">(</span><span class="op" id="3432683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432687">return</span>&nbsp;<span class="ident" id="3432694">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432701">c</span>&nbsp;<span class="op" id="3432703">:=</span>&nbsp;<span class="op" id="3432706">&amp;</span><span class="ident" id="3432707">call</span><span class="op" id="3432711">{</span><span class="ident" id="3432712">chans</span><span class="op" id="3432717">:</span>&nbsp;<span class="op" id="3432719">[</span><span class="op" id="3432720">]</span><span class="keyword" id="3432721">chan</span><span class="op" id="3432725">&lt;-</span>&nbsp;<span class="ident" id="3432728">singleflightResult</span><span class="op" id="3432746">{</span><span class="ident" id="3432747">ch</span><span class="op" id="3432749">}</span><span class="op" id="3432750">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432753">c</span><span class="op" id="3432754">.</span><span class="ident" id="3432755">wg</span><span class="op" id="3432757">.</span><span class="ident" id="3432758">Add</span><span class="op" id="3432761">(</span><span class="num" id="3432762">1</span><span class="op" id="3432763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432766">g</span><span class="op" id="3432767">.</span><span class="ident" id="3432768">m</span><span class="op" id="3432769">[</span><span class="ident" id="3432770">key</span><span class="op" id="3432773">]</span>&nbsp;<span class="op" id="3432775">=</span>&nbsp;<span class="ident" id="3432777">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432780">g</span><span class="op" id="3432781">.</span><span class="ident" id="3432782">mu</span><span class="op" id="3432784">.</span><span class="ident" id="3432785">Unlock</span><span class="op" id="3432791">(</span><span class="op" id="3432792">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432796">go</span>&nbsp;<span class="ident" id="3432799">g</span><span class="op" id="3432800">.</span><span class="ident" id="3432801">doCall</span><span class="op" id="3432807">(</span><span class="ident" id="3432808">c</span><span class="op" id="3432809">,</span>&nbsp;<span class="ident" id="3432811">key</span><span class="op" id="3432814">,</span>&nbsp;<span class="ident" id="3432816">fn</span><span class="op" id="3432818">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432822">return</span>&nbsp;<span class="ident" id="3432829">ch</span><br>
<span class="lineno"></span><span class="op" id="3432832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3432835">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3432880">func</span>&nbsp;<span class="op" id="3432885">(</span><span class="ident" id="3432886">g</span>&nbsp;<span class="op" id="3432888">*</span><span class="ident" id="3432889">singleflight</span><span class="op" id="3432901">)</span>&nbsp;<span class="ident" id="3432903">doCall</span><span class="op" id="3432909">(</span><span class="ident" id="3432910">c</span>&nbsp;<span class="op" id="3432912">*</span><span class="ident" id="3432913">call</span><span class="op" id="3432917">,</span>&nbsp;<span class="ident" id="3432919">key</span>&nbsp;<span class="builtintype" id="3432923">string</span><span class="op" id="3432929">,</span>&nbsp;<span class="ident" id="3432931">fn</span>&nbsp;<span class="keyword" id="3432934">func</span><span class="op" id="3432938">(</span><span class="op" id="3432939">)</span>&nbsp;<span class="op" id="3432941">(</span><span class="keyword" id="3432942">interface</span><span class="op" id="3432951">{</span><span class="op" id="3432952">}</span><span class="op" id="3432953">,</span>&nbsp;<span class="builtintype" id="3432955">error</span><span class="op" id="3432960">)</span><span class="op" id="3432961">)</span>&nbsp;<span class="op" id="3432963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432966">c</span><span class="op" id="3432967">.</span><span class="ident" id="3432968">val</span><span class="op" id="3432971">,</span>&nbsp;<span class="ident" id="3432973">c</span><span class="op" id="3432974">.</span><span class="ident" id="3432975">err</span>&nbsp;<span class="op" id="3432979">=</span>&nbsp;<span class="ident" id="3432981">fn</span><span class="op" id="3432983">(</span><span class="op" id="3432984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432987">c</span><span class="op" id="3432988">.</span><span class="ident" id="3432989">wg</span><span class="op" id="3432991">.</span><span class="ident" id="3432992">Done</span><span class="op" id="3432996">(</span><span class="op" id="3432997">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433001">g</span><span class="op" id="3433002">.</span><span class="ident" id="3433003">mu</span><span class="op" id="3433005">.</span><span class="ident" id="3433006">Lock</span><span class="op" id="3433010">(</span><span class="op" id="3433011">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3433014">delete</span><span class="op" id="3433020">(</span><span class="ident" id="3433021">g</span><span class="op" id="3433022">.</span><span class="ident" id="3433023">m</span><span class="op" id="3433024">,</span>&nbsp;<span class="ident" id="3433026">key</span><span class="op" id="3433029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433032">for</span>&nbsp;<span class="ident" id="3433036">_</span><span class="op" id="3433037">,</span>&nbsp;<span class="ident" id="3433039">ch</span>&nbsp;<span class="op" id="3433042">:=</span>&nbsp;<span class="keyword" id="3433045">range</span>&nbsp;<span class="ident" id="3433051">c</span><span class="op" id="3433052">.</span><span class="ident" id="3433053">chans</span>&nbsp;<span class="op" id="3433059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433063">ch</span>&nbsp;<span class="op" id="3433066">&lt;-</span>&nbsp;<span class="ident" id="3433069">singleflightResult</span><span class="op" id="3433087">{</span><span class="ident" id="3433088">c</span><span class="op" id="3433089">.</span><span class="ident" id="3433090">val</span><span class="op" id="3433093">,</span>&nbsp;<span class="ident" id="3433095">c</span><span class="op" id="3433096">.</span><span class="ident" id="3433097">err</span><span class="op" id="3433100">,</span>&nbsp;<span class="ident" id="3433102">c</span><span class="op" id="3433103">.</span><span class="ident" id="3433104">dups</span>&nbsp;<span class="op" id="3433109">&gt;</span>&nbsp;<span class="num" id="3433111">0</span><span class="op" id="3433112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433118">g</span><span class="op" id="3433119">.</span><span class="ident" id="3433120">mu</span><span class="op" id="3433122">.</span><span class="ident" id="3433123">Unlock</span><span class="op" id="3433129">(</span><span class="op" id="3433130">)</span><br>
<span class="lineno">100</span><span class="op" id="3433132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3433135">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3433205">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3433274">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3433306">func</span>&nbsp;<span class="op" id="3433311">(</span><span class="ident" id="3433312">g</span>&nbsp;<span class="op" id="3433314">*</span><span class="ident" id="3433315">singleflight</span><span class="op" id="3433327">)</span>&nbsp;<span class="ident" id="3433329">Forget</span><span class="op" id="3433335">(</span><span class="ident" id="3433336">key</span>&nbsp;<span class="builtintype" id="3433340">string</span><span class="op" id="3433346">)</span>&nbsp;<span class="op" id="3433348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433351">g</span><span class="op" id="3433352">.</span><span class="ident" id="3433353">mu</span><span class="op" id="3433355">.</span><span class="ident" id="3433356">Lock</span><span class="op" id="3433360">(</span><span class="op" id="3433361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3433364">delete</span><span class="op" id="3433370">(</span><span class="ident" id="3433371">g</span><span class="op" id="3433372">.</span><span class="ident" id="3433373">m</span><span class="op" id="3433374">,</span>&nbsp;<span class="ident" id="3433376">key</span><span class="op" id="3433379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433382">g</span><span class="op" id="3433383">.</span><span class="ident" id="3433384">mu</span><span class="op" id="3433386">.</span><span class="ident" id="3433387">Unlock</span><span class="op" id="3433393">(</span><span class="op" id="3433394">)</span><br>
<span class="lineno"></span><span class="op" id="3433396">}</span>
</div>
</body>
</html>
