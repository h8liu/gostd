<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html" class="current">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3304857">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3304913">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3304967">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3305018">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3305096">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3305143">package</span>&nbsp;<span class="ident" id="3305151">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3305156">import</span>&nbsp;<span class="op" id="3305163">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3305166">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3305177">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3305184">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3305187">func</span>&nbsp;<span class="ident" id="3305192">probeIPv4Stack</span><span class="op" id="3305206">(</span><span class="op" id="3305207">)</span>&nbsp;<span class="builtintype" id="3305209">bool</span>&nbsp;<span class="op" id="3305214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3305217">s</span><span class="op" id="3305218">,</span>&nbsp;<span class="ident" id="3305220">err</span>&nbsp;<span class="op" id="3305224">:=</span>&nbsp;<span class="ident" id="3305227">syscall</span><span class="op" id="3305234">.</span><span class="ident" id="3305235">Socket</span><span class="op" id="3305241">(</span><span class="ident" id="3305242">syscall</span><span class="op" id="3305249">.</span><span class="ident" id="3305250">AF_INET</span><span class="op" id="3305257">,</span>&nbsp;<span class="ident" id="3305259">syscall</span><span class="op" id="3305266">.</span><span class="ident" id="3305267">SOCK_STREAM</span><span class="op" id="3305278">,</span>&nbsp;<span class="ident" id="3305280">syscall</span><span class="op" id="3305287">.</span><span class="ident" id="3305288">IPPROTO_TCP</span><span class="op" id="3305299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3305302">switch</span>&nbsp;<span class="ident" id="3305309">err</span>&nbsp;<span class="op" id="3305313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3305316">case</span>&nbsp;<span class="ident" id="3305321">syscall</span><span class="op" id="3305328">.</span><span class="ident" id="3305329">EAFNOSUPPORT</span><span class="op" id="3305341">,</span>&nbsp;<span class="ident" id="3305343">syscall</span><span class="op" id="3305350">.</span><span class="ident" id="3305351">EPROTONOSUPPORT</span><span class="op" id="3305366">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3305370">return</span>&nbsp;<span class="builtintype" id="3305377">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3305384">case</span>&nbsp;<span class="builtintype" id="3305389">nil</span><span class="op" id="3305392">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3305396">closesocket</span><span class="op" id="3305407">(</span><span class="ident" id="3305408">s</span><span class="op" id="3305409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3305412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3305415">return</span>&nbsp;<span class="builtintype" id="3305422">true</span><br>
<span class="lineno">25</span><span class="op" id="3305427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3305430">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3305489">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3305552">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3305618">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3305679">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3305742">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3305797">//</span><br>
<span class="lineno"></span><span class="comment" id="3305800">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3305867">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3305931">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3305985">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3306050">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3306116">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3306177">func</span>&nbsp;<span class="ident" id="3306182">probeIPv6Stack</span><span class="op" id="3306196">(</span><span class="op" id="3306197">)</span>&nbsp;<span class="op" id="3306199">(</span><span class="ident" id="3306200">supportsIPv6</span><span class="op" id="3306212">,</span>&nbsp;<span class="ident" id="3306214">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3306230">bool</span><span class="op" id="3306234">)</span>&nbsp;<span class="op" id="3306236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306239">var</span>&nbsp;<span class="ident" id="3306243">probes</span>&nbsp;<span class="op" id="3306250">=</span>&nbsp;<span class="op" id="3306252">[</span><span class="op" id="3306253">]</span><span class="keyword" id="3306254">struct</span>&nbsp;<span class="op" id="3306261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306265">laddr</span>&nbsp;<span class="ident" id="3306271">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306281">value</span>&nbsp;<span class="builtintype" id="3306287">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306293">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3306299">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306305">}</span><span class="op" id="3306306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3306310">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306345">{</span><span class="ident" id="3306346">laddr</span><span class="op" id="3306351">:</span>&nbsp;<span class="ident" id="3306353">TCPAddr</span><span class="op" id="3306360">{</span><span class="ident" id="3306361">IP</span><span class="op" id="3306363">:</span>&nbsp;<span class="ident" id="3306365">ParseIP</span><span class="op" id="3306372">(</span><span class="string" id="3306373">&#34;::1&#34;</span><span class="op" id="3306378">)</span><span class="op" id="3306379">}</span><span class="op" id="3306380">,</span>&nbsp;<span class="ident" id="3306382">value</span><span class="op" id="3306387">:</span>&nbsp;<span class="num" id="3306389">1</span><span class="op" id="3306390">}</span><span class="op" id="3306391">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3306395">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306450">{</span><span class="ident" id="3306451">laddr</span><span class="op" id="3306456">:</span>&nbsp;<span class="ident" id="3306458">TCPAddr</span><span class="op" id="3306465">{</span><span class="ident" id="3306466">IP</span><span class="op" id="3306468">:</span>&nbsp;<span class="ident" id="3306470">IPv4</span><span class="op" id="3306474">(</span><span class="num" id="3306475">127</span><span class="op" id="3306478">,</span>&nbsp;<span class="num" id="3306480">0</span><span class="op" id="3306481">,</span>&nbsp;<span class="num" id="3306483">0</span><span class="op" id="3306484">,</span>&nbsp;<span class="num" id="3306486">1</span><span class="op" id="3306487">)</span><span class="op" id="3306488">}</span><span class="op" id="3306489">,</span>&nbsp;<span class="ident" id="3306491">value</span><span class="op" id="3306496">:</span>&nbsp;<span class="num" id="3306498">0</span><span class="op" id="3306499">}</span><span class="op" id="3306500">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306507">for</span>&nbsp;<span class="ident" id="3306511">i</span>&nbsp;<span class="op" id="3306513">:=</span>&nbsp;<span class="keyword" id="3306516">range</span>&nbsp;<span class="ident" id="3306522">probes</span>&nbsp;<span class="op" id="3306529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306533">s</span><span class="op" id="3306534">,</span>&nbsp;<span class="ident" id="3306536">err</span>&nbsp;<span class="op" id="3306540">:=</span>&nbsp;<span class="ident" id="3306543">syscall</span><span class="op" id="3306550">.</span><span class="ident" id="3306551">Socket</span><span class="op" id="3306557">(</span><span class="ident" id="3306558">syscall</span><span class="op" id="3306565">.</span><span class="ident" id="3306566">AF_INET6</span><span class="op" id="3306574">,</span>&nbsp;<span class="ident" id="3306576">syscall</span><span class="op" id="3306583">.</span><span class="ident" id="3306584">SOCK_STREAM</span><span class="op" id="3306595">,</span>&nbsp;<span class="ident" id="3306597">syscall</span><span class="op" id="3306604">.</span><span class="ident" id="3306605">IPPROTO_TCP</span><span class="op" id="3306616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306620">if</span>&nbsp;<span class="ident" id="3306623">err</span>&nbsp;<span class="op" id="3306627">!=</span>&nbsp;<span class="builtintype" id="3306630">nil</span>&nbsp;<span class="op" id="3306634">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306639">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306654">defer</span>&nbsp;<span class="ident" id="3306660">closesocket</span><span class="op" id="3306671">(</span><span class="ident" id="3306672">s</span><span class="op" id="3306673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306677">syscall</span><span class="op" id="3306684">.</span><span class="ident" id="3306685">SetsockoptInt</span><span class="op" id="3306698">(</span><span class="ident" id="3306699">s</span><span class="op" id="3306700">,</span>&nbsp;<span class="ident" id="3306702">syscall</span><span class="op" id="3306709">.</span><span class="ident" id="3306710">IPPROTO_IPV6</span><span class="op" id="3306722">,</span>&nbsp;<span class="ident" id="3306724">syscall</span><span class="op" id="3306731">.</span><span class="ident" id="3306732">IPV6_V6ONLY</span><span class="op" id="3306743">,</span>&nbsp;<span class="ident" id="3306745">probes</span><span class="op" id="3306751">[</span><span class="ident" id="3306752">i</span><span class="op" id="3306753">]</span><span class="op" id="3306754">.</span><span class="ident" id="3306755">value</span><span class="op" id="3306760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306764">sa</span><span class="op" id="3306766">,</span>&nbsp;<span class="ident" id="3306768">err</span>&nbsp;<span class="op" id="3306772">:=</span>&nbsp;<span class="ident" id="3306775">probes</span><span class="op" id="3306781">[</span><span class="ident" id="3306782">i</span><span class="op" id="3306783">]</span><span class="op" id="3306784">.</span><span class="ident" id="3306785">laddr</span><span class="op" id="3306790">.</span><span class="ident" id="3306791">sockaddr</span><span class="op" id="3306799">(</span><span class="ident" id="3306800">syscall</span><span class="op" id="3306807">.</span><span class="ident" id="3306808">AF_INET6</span><span class="op" id="3306816">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306820">if</span>&nbsp;<span class="ident" id="3306823">err</span>&nbsp;<span class="op" id="3306827">!=</span>&nbsp;<span class="builtintype" id="3306830">nil</span>&nbsp;<span class="op" id="3306834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306839">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306854">if</span>&nbsp;<span class="ident" id="3306857">err</span>&nbsp;<span class="op" id="3306861">:=</span>&nbsp;<span class="ident" id="3306864">syscall</span><span class="op" id="3306871">.</span><span class="ident" id="3306872">Bind</span><span class="op" id="3306876">(</span><span class="ident" id="3306877">s</span><span class="op" id="3306878">,</span>&nbsp;<span class="ident" id="3306880">sa</span><span class="op" id="3306882">)</span><span class="op" id="3306883">;</span>&nbsp;<span class="ident" id="3306885">err</span>&nbsp;<span class="op" id="3306889">!=</span>&nbsp;<span class="builtintype" id="3306892">nil</span>&nbsp;<span class="op" id="3306896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306901">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3306916">probes</span><span class="op" id="3306922">[</span><span class="ident" id="3306923">i</span><span class="op" id="3306924">]</span><span class="op" id="3306925">.</span><span class="ident" id="3306926">ok</span>&nbsp;<span class="op" id="3306929">=</span>&nbsp;<span class="builtintype" id="3306931">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3306937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3306941">return</span>&nbsp;<span class="ident" id="3306948">probes</span><span class="op" id="3306954">[</span><span class="num" id="3306955">0</span><span class="op" id="3306956">]</span><span class="op" id="3306957">.</span><span class="ident" id="3306958">ok</span><span class="op" id="3306960">,</span>&nbsp;<span class="ident" id="3306962">probes</span><span class="op" id="3306968">[</span><span class="num" id="3306969">1</span><span class="op" id="3306970">]</span><span class="op" id="3306971">.</span><span class="ident" id="3306972">ok</span><br>
<span class="lineno">70</span><span class="op" id="3306975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3306978">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3307042">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3307104">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3307168">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3307230">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3307296">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3307360">//</span><br>
<span class="lineno"></span><span class="comment" id="3307363">//&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3307400">//&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3307460">//&nbsp;&nbsp;&nbsp;&nbsp;capabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3307519">//&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3307575">//&nbsp;&nbsp;&nbsp;&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3307634">//&nbsp;&nbsp;&nbsp;&nbsp;wildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3307685">//</span><br>
<span class="lineno"></span><span class="comment" id="3307688">//&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3307736">//&nbsp;&nbsp;&nbsp;&nbsp;Same&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3307750">//</span><br>
<span class="lineno"></span><span class="comment" id="3307753">//&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3307798">//&nbsp;&nbsp;&nbsp;&nbsp;Almost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3307857">//&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3307915">//&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3307975">//&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3307998">//</span><br>
<span class="lineno">95</span><span class="comment" id="3308001">//&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3308056">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3308109">//</span><br>
<span class="lineno"></span><span class="comment" id="3308112">//&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3308164">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3308225">//&nbsp;&nbsp;&nbsp;&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3308236">//</span><br>
<span class="lineno"></span><span class="comment" id="3308239">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3308307">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3308374">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3308408">//</span><br>
<span class="lineno"></span><span class="comment" id="3308411">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3308479">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3308540">func</span>&nbsp;<span class="ident" id="3308545">favoriteAddrFamily</span><span class="op" id="3308563">(</span><span class="ident" id="3308564">net</span>&nbsp;<span class="builtintype" id="3308568">string</span><span class="op" id="3308574">,</span>&nbsp;<span class="ident" id="3308576">laddr</span><span class="op" id="3308581">,</span>&nbsp;<span class="ident" id="3308583">raddr</span>&nbsp;<span class="ident" id="3308589">sockaddr</span><span class="op" id="3308597">,</span>&nbsp;<span class="ident" id="3308599">mode</span>&nbsp;<span class="builtintype" id="3308604">string</span><span class="op" id="3308610">)</span>&nbsp;<span class="op" id="3308612">(</span><span class="ident" id="3308613">family</span>&nbsp;<span class="builtintype" id="3308620">int</span><span class="op" id="3308623">,</span>&nbsp;<span class="ident" id="3308625">ipv6only</span>&nbsp;<span class="builtintype" id="3308634">bool</span><span class="op" id="3308638">)</span>&nbsp;<span class="op" id="3308640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308643">switch</span>&nbsp;<span class="ident" id="3308650">net</span><span class="op" id="3308653">[</span><span class="builtinfunc" id="3308654">len</span><span class="op" id="3308657">(</span><span class="ident" id="3308658">net</span><span class="op" id="3308661">)</span><span class="op" id="3308662">-</span><span class="num" id="3308663">1</span><span class="op" id="3308664">]</span>&nbsp;<span class="op" id="3308666">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308669">case</span>&nbsp;<span class="string" id="3308674">&#39;4&#39;</span><span class="op" id="3308677">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308681">return</span>&nbsp;<span class="ident" id="3308688">syscall</span><span class="op" id="3308695">.</span><span class="ident" id="3308696">AF_INET</span><span class="op" id="3308703">,</span>&nbsp;<span class="builtintype" id="3308705">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308712">case</span>&nbsp;<span class="string" id="3308717">&#39;6&#39;</span><span class="op" id="3308720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308724">return</span>&nbsp;<span class="ident" id="3308731">syscall</span><span class="op" id="3308738">.</span><span class="ident" id="3308739">AF_INET6</span><span class="op" id="3308747">,</span>&nbsp;<span class="builtintype" id="3308749">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3308755">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308759">if</span>&nbsp;<span class="ident" id="3308762">mode</span>&nbsp;<span class="op" id="3308767">==</span>&nbsp;<span class="string" id="3308770">&#34;listen&#34;</span>&nbsp;<span class="op" id="3308779">&amp;&amp;</span>&nbsp;<span class="op" id="3308782">(</span><span class="ident" id="3308783">laddr</span>&nbsp;<span class="op" id="3308789">==</span>&nbsp;<span class="builtintype" id="3308792">nil</span>&nbsp;<span class="op" id="3308796">||</span>&nbsp;<span class="ident" id="3308799">laddr</span><span class="op" id="3308804">.</span><span class="ident" id="3308805">isWildcard</span><span class="op" id="3308815">(</span><span class="op" id="3308816">)</span><span class="op" id="3308817">)</span>&nbsp;<span class="op" id="3308819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308823">if</span>&nbsp;<span class="ident" id="3308826">supportsIPv4map</span>&nbsp;<span class="op" id="3308842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308847">return</span>&nbsp;<span class="ident" id="3308854">syscall</span><span class="op" id="3308861">.</span><span class="ident" id="3308862">AF_INET6</span><span class="op" id="3308870">,</span>&nbsp;<span class="builtintype" id="3308872">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3308880">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308884">if</span>&nbsp;<span class="ident" id="3308887">laddr</span>&nbsp;<span class="op" id="3308893">==</span>&nbsp;<span class="builtintype" id="3308896">nil</span>&nbsp;<span class="op" id="3308900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308905">return</span>&nbsp;<span class="ident" id="3308912">syscall</span><span class="op" id="3308919">.</span><span class="ident" id="3308920">AF_INET</span><span class="op" id="3308927">,</span>&nbsp;<span class="builtintype" id="3308929">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3308937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308941">return</span>&nbsp;<span class="ident" id="3308948">laddr</span><span class="op" id="3308953">.</span><span class="ident" id="3308954">family</span><span class="op" id="3308960">(</span><span class="op" id="3308961">)</span><span class="op" id="3308962">,</span>&nbsp;<span class="builtintype" id="3308964">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3308971">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3308975">if</span>&nbsp;<span class="op" id="3308978">(</span><span class="ident" id="3308979">laddr</span>&nbsp;<span class="op" id="3308985">==</span>&nbsp;<span class="builtintype" id="3308988">nil</span>&nbsp;<span class="op" id="3308992">||</span>&nbsp;<span class="ident" id="3308995">laddr</span><span class="op" id="3309000">.</span><span class="ident" id="3309001">family</span><span class="op" id="3309007">(</span><span class="op" id="3309008">)</span>&nbsp;<span class="op" id="3309010">==</span>&nbsp;<span class="ident" id="3309013">syscall</span><span class="op" id="3309020">.</span><span class="ident" id="3309021">AF_INET</span><span class="op" id="3309028">)</span>&nbsp;<span class="op" id="3309030">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3309035">(</span><span class="ident" id="3309036">raddr</span>&nbsp;<span class="op" id="3309042">==</span>&nbsp;<span class="builtintype" id="3309045">nil</span>&nbsp;<span class="op" id="3309049">||</span>&nbsp;<span class="ident" id="3309052">raddr</span><span class="op" id="3309057">.</span><span class="ident" id="3309058">family</span><span class="op" id="3309064">(</span><span class="op" id="3309065">)</span>&nbsp;<span class="op" id="3309067">==</span>&nbsp;<span class="ident" id="3309070">syscall</span><span class="op" id="3309077">.</span><span class="ident" id="3309078">AF_INET</span><span class="op" id="3309085">)</span>&nbsp;<span class="op" id="3309087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309091">return</span>&nbsp;<span class="ident" id="3309098">syscall</span><span class="op" id="3309105">.</span><span class="ident" id="3309106">AF_INET</span><span class="op" id="3309113">,</span>&nbsp;<span class="builtintype" id="3309115">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3309122">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309125">return</span>&nbsp;<span class="ident" id="3309132">syscall</span><span class="op" id="3309139">.</span><span class="ident" id="3309140">AF_INET6</span><span class="op" id="3309148">,</span>&nbsp;<span class="builtintype" id="3309150">false</span><br>
<span class="lineno"></span><span class="op" id="3309156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3309159">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3309195">func</span>&nbsp;<span class="ident" id="3309200">internetSocket</span><span class="op" id="3309214">(</span><span class="ident" id="3309215">net</span>&nbsp;<span class="builtintype" id="3309219">string</span><span class="op" id="3309225">,</span>&nbsp;<span class="ident" id="3309227">laddr</span><span class="op" id="3309232">,</span>&nbsp;<span class="ident" id="3309234">raddr</span>&nbsp;<span class="ident" id="3309240">sockaddr</span><span class="op" id="3309248">,</span>&nbsp;<span class="ident" id="3309250">deadline</span>&nbsp;<span class="ident" id="3309259">time</span><span class="op" id="3309263">.</span><span class="ident" id="3309264">Time</span><span class="op" id="3309268">,</span>&nbsp;<span class="ident" id="3309270">sotype</span><span class="op" id="3309276">,</span>&nbsp;<span class="ident" id="3309278">proto</span>&nbsp;<span class="builtintype" id="3309284">int</span><span class="op" id="3309287">,</span>&nbsp;<span class="ident" id="3309289">mode</span>&nbsp;<span class="builtintype" id="3309294">string</span><span class="op" id="3309300">)</span>&nbsp;<span class="op" id="3309302">(</span><span class="ident" id="3309303">fd</span>&nbsp;<span class="op" id="3309306">*</span><span class="ident" id="3309307">netFD</span><span class="op" id="3309312">,</span>&nbsp;<span class="ident" id="3309314">err</span>&nbsp;<span class="builtintype" id="3309318">error</span><span class="op" id="3309323">)</span>&nbsp;<span class="op" id="3309325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3309328">family</span><span class="op" id="3309334">,</span>&nbsp;<span class="ident" id="3309336">ipv6only</span>&nbsp;<span class="op" id="3309345">:=</span>&nbsp;<span class="ident" id="3309348">favoriteAddrFamily</span><span class="op" id="3309366">(</span><span class="ident" id="3309367">net</span><span class="op" id="3309370">,</span>&nbsp;<span class="ident" id="3309372">laddr</span><span class="op" id="3309377">,</span>&nbsp;<span class="ident" id="3309379">raddr</span><span class="op" id="3309384">,</span>&nbsp;<span class="ident" id="3309386">mode</span><span class="op" id="3309390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309393">return</span>&nbsp;<span class="ident" id="3309400">socket</span><span class="op" id="3309406">(</span><span class="ident" id="3309407">net</span><span class="op" id="3309410">,</span>&nbsp;<span class="ident" id="3309412">family</span><span class="op" id="3309418">,</span>&nbsp;<span class="ident" id="3309420">sotype</span><span class="op" id="3309426">,</span>&nbsp;<span class="ident" id="3309428">proto</span><span class="op" id="3309433">,</span>&nbsp;<span class="ident" id="3309435">ipv6only</span><span class="op" id="3309443">,</span>&nbsp;<span class="ident" id="3309445">laddr</span><span class="op" id="3309450">,</span>&nbsp;<span class="ident" id="3309452">raddr</span><span class="op" id="3309457">,</span>&nbsp;<span class="ident" id="3309459">deadline</span><span class="op" id="3309467">)</span><br>
<span class="lineno"></span><span class="op" id="3309469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3309472">func</span>&nbsp;<span class="ident" id="3309477">ipToSockaddr</span><span class="op" id="3309489">(</span><span class="ident" id="3309490">family</span>&nbsp;<span class="builtintype" id="3309497">int</span><span class="op" id="3309500">,</span>&nbsp;<span class="ident" id="3309502">ip</span>&nbsp;<span class="ident" id="3309505">IP</span><span class="op" id="3309507">,</span>&nbsp;<span class="ident" id="3309509">port</span>&nbsp;<span class="builtintype" id="3309514">int</span><span class="op" id="3309517">,</span>&nbsp;<span class="ident" id="3309519">zone</span>&nbsp;<span class="builtintype" id="3309524">string</span><span class="op" id="3309530">)</span>&nbsp;<span class="op" id="3309532">(</span><span class="ident" id="3309533">syscall</span><span class="op" id="3309540">.</span><span class="ident" id="3309541">Sockaddr</span><span class="op" id="3309549">,</span>&nbsp;<span class="builtintype" id="3309551">error</span><span class="op" id="3309556">)</span>&nbsp;<span class="op" id="3309558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309561">switch</span>&nbsp;<span class="ident" id="3309568">family</span>&nbsp;<span class="op" id="3309575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309578">case</span>&nbsp;<span class="ident" id="3309583">syscall</span><span class="op" id="3309590">.</span><span class="ident" id="3309591">AF_INET</span><span class="op" id="3309598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309602">if</span>&nbsp;<span class="builtinfunc" id="3309605">len</span><span class="op" id="3309608">(</span><span class="ident" id="3309609">ip</span><span class="op" id="3309611">)</span>&nbsp;<span class="op" id="3309613">==</span>&nbsp;<span class="num" id="3309616">0</span>&nbsp;<span class="op" id="3309618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3309623">ip</span>&nbsp;<span class="op" id="3309626">=</span>&nbsp;<span class="ident" id="3309628">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3309639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309643">if</span>&nbsp;<span class="ident" id="3309646">ip</span>&nbsp;<span class="op" id="3309649">=</span>&nbsp;<span class="ident" id="3309651">ip</span><span class="op" id="3309653">.</span><span class="ident" id="3309654">To4</span><span class="op" id="3309657">(</span><span class="op" id="3309658">)</span><span class="op" id="3309659">;</span>&nbsp;<span class="ident" id="3309661">ip</span>&nbsp;<span class="op" id="3309664">==</span>&nbsp;<span class="builtintype" id="3309667">nil</span>&nbsp;<span class="op" id="3309671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309676">return</span>&nbsp;<span class="builtintype" id="3309683">nil</span><span class="op" id="3309686">,</span>&nbsp;<span class="ident" id="3309688">InvalidAddrError</span><span class="op" id="3309704">(</span><span class="string" id="3309705">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3309723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3309727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3309731">sa</span>&nbsp;<span class="op" id="3309734">:=</span>&nbsp;<span class="builtinfunc" id="3309737">new</span><span class="op" id="3309740">(</span><span class="ident" id="3309741">syscall</span><span class="op" id="3309748">.</span><span class="ident" id="3309749">SockaddrInet4</span><span class="op" id="3309762">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309766">for</span>&nbsp;<span class="ident" id="3309770">i</span>&nbsp;<span class="op" id="3309772">:=</span>&nbsp;<span class="num" id="3309775">0</span><span class="op" id="3309776">;</span>&nbsp;<span class="ident" id="3309778">i</span>&nbsp;<span class="op" id="3309780">&lt;</span>&nbsp;<span class="ident" id="3309782">IPv4len</span><span class="op" id="3309789">;</span>&nbsp;<span class="ident" id="3309791">i</span><span class="op" id="3309792">++</span>&nbsp;<span class="op" id="3309795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3309800">sa</span><span class="op" id="3309802">.</span><span class="ident" id="3309803">Addr</span><span class="op" id="3309807">[</span><span class="ident" id="3309808">i</span><span class="op" id="3309809">]</span>&nbsp;<span class="op" id="3309811">=</span>&nbsp;<span class="ident" id="3309813">ip</span><span class="op" id="3309815">[</span><span class="ident" id="3309816">i</span><span class="op" id="3309817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3309821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3309825">sa</span><span class="op" id="3309827">.</span><span class="ident" id="3309828">Port</span>&nbsp;<span class="op" id="3309833">=</span>&nbsp;<span class="ident" id="3309835">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309842">return</span>&nbsp;<span class="ident" id="3309849">sa</span><span class="op" id="3309851">,</span>&nbsp;<span class="builtintype" id="3309853">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309858">case</span>&nbsp;<span class="ident" id="3309863">syscall</span><span class="op" id="3309870">.</span><span class="ident" id="3309871">AF_INET6</span><span class="op" id="3309879">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3309883">if</span>&nbsp;<span class="builtinfunc" id="3309886">len</span><span class="op" id="3309889">(</span><span class="ident" id="3309890">ip</span><span class="op" id="3309892">)</span>&nbsp;<span class="op" id="3309894">==</span>&nbsp;<span class="num" id="3309897">0</span>&nbsp;<span class="op" id="3309899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3309904">ip</span>&nbsp;<span class="op" id="3309907">=</span>&nbsp;<span class="ident" id="3309909">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3309920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3309924">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3309999">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3310070">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3310141">if</span>&nbsp;<span class="ident" id="3310144">ip</span><span class="op" id="3310146">.</span><span class="ident" id="3310147">Equal</span><span class="op" id="3310152">(</span><span class="ident" id="3310153">IPv4zero</span><span class="op" id="3310161">)</span>&nbsp;<span class="op" id="3310163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3310168">ip</span>&nbsp;<span class="op" id="3310171">=</span>&nbsp;<span class="ident" id="3310173">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3310184">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3310188">if</span>&nbsp;<span class="ident" id="3310191">ip</span>&nbsp;<span class="op" id="3310194">=</span>&nbsp;<span class="ident" id="3310196">ip</span><span class="op" id="3310198">.</span><span class="ident" id="3310199">To16</span><span class="op" id="3310203">(</span><span class="op" id="3310204">)</span><span class="op" id="3310205">;</span>&nbsp;<span class="ident" id="3310207">ip</span>&nbsp;<span class="op" id="3310210">==</span>&nbsp;<span class="builtintype" id="3310213">nil</span>&nbsp;<span class="op" id="3310217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3310222">return</span>&nbsp;<span class="builtintype" id="3310229">nil</span><span class="op" id="3310232">,</span>&nbsp;<span class="ident" id="3310234">InvalidAddrError</span><span class="op" id="3310250">(</span><span class="string" id="3310251">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3310269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3310273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3310277">sa</span>&nbsp;<span class="op" id="3310280">:=</span>&nbsp;<span class="builtinfunc" id="3310283">new</span><span class="op" id="3310286">(</span><span class="ident" id="3310287">syscall</span><span class="op" id="3310294">.</span><span class="ident" id="3310295">SockaddrInet6</span><span class="op" id="3310308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3310312">for</span>&nbsp;<span class="ident" id="3310316">i</span>&nbsp;<span class="op" id="3310318">:=</span>&nbsp;<span class="num" id="3310321">0</span><span class="op" id="3310322">;</span>&nbsp;<span class="ident" id="3310324">i</span>&nbsp;<span class="op" id="3310326">&lt;</span>&nbsp;<span class="ident" id="3310328">IPv6len</span><span class="op" id="3310335">;</span>&nbsp;<span class="ident" id="3310337">i</span><span class="op" id="3310338">++</span>&nbsp;<span class="op" id="3310341">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3310346">sa</span><span class="op" id="3310348">.</span><span class="ident" id="3310349">Addr</span><span class="op" id="3310353">[</span><span class="ident" id="3310354">i</span><span class="op" id="3310355">]</span>&nbsp;<span class="op" id="3310357">=</span>&nbsp;<span class="ident" id="3310359">ip</span><span class="op" id="3310361">[</span><span class="ident" id="3310362">i</span><span class="op" id="3310363">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3310367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3310371">sa</span><span class="op" id="3310373">.</span><span class="ident" id="3310374">Port</span>&nbsp;<span class="op" id="3310379">=</span>&nbsp;<span class="ident" id="3310381">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3310388">sa</span><span class="op" id="3310390">.</span><span class="ident" id="3310391">ZoneId</span>&nbsp;<span class="op" id="3310398">=</span>&nbsp;<span class="builtintype" id="3310400">uint32</span><span class="op" id="3310406">(</span><span class="ident" id="3310407">zoneToInt</span><span class="op" id="3310416">(</span><span class="ident" id="3310417">zone</span><span class="op" id="3310421">)</span><span class="op" id="3310422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3310426">return</span>&nbsp;<span class="ident" id="3310433">sa</span><span class="op" id="3310435">,</span>&nbsp;<span class="builtintype" id="3310437">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3310442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3310445">return</span>&nbsp;<span class="builtintype" id="3310452">nil</span><span class="op" id="3310455">,</span>&nbsp;<span class="ident" id="3310457">InvalidAddrError</span><span class="op" id="3310473">(</span><span class="string" id="3310474">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3310500">)</span><br>
<span class="lineno"></span><span class="op" id="3310502">}</span>
</div>
</body>
</html>
