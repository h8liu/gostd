<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2958661">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2958716">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2958770">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2958821">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2958850">package</span>&nbsp;<span class="ident" id="2958858">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2958868">import</span>&nbsp;<span class="op" id="2958875">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958878">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958892">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958900">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958907">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958914">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958926">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2958932">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="2958939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2958942">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2959013">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="2959076">type</span>&nbsp;<span class="ident" id="2959081">Server</span>&nbsp;<span class="keyword" id="2959088">struct</span>&nbsp;<span class="op" id="2959095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959098">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2959107">string</span>&nbsp;<span class="comment" id="2959114">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959177">Listener</span>&nbsp;<span class="ident" id="2959186">net</span><span class="op" id="2959189">.</span><span class="ident" id="2959190">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959201">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959272">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959344">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959407">TLS</span>&nbsp;<span class="op" id="2959411">*</span><span class="ident" id="2959412">tls</span><span class="op" id="2959415">.</span><span class="ident" id="2959416">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959425">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959488">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959518">Config</span>&nbsp;<span class="op" id="2959525">*</span><span class="ident" id="2959526">http</span><span class="op" id="2959530">.</span><span class="ident" id="2959531">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959540">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959610">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959660">wg</span>&nbsp;<span class="ident" id="2959663">sync</span><span class="op" id="2959667">.</span><span class="ident" id="2959668">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="2959678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2959681">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="2959746">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="2959759">type</span>&nbsp;<span class="ident" id="2959764">historyListener</span>&nbsp;<span class="keyword" id="2959780">struct</span>&nbsp;<span class="op" id="2959787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959790">net</span><span class="op" id="2959793">.</span><span class="ident" id="2959794">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959804">sync</span><span class="op" id="2959808">.</span><span class="ident" id="2959809">Mutex</span>&nbsp;<span class="comment" id="2959815">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959836">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2959847">[</span><span class="op" id="2959848">]</span><span class="ident" id="2959849">net</span><span class="op" id="2959852">.</span><span class="ident" id="2959853">Conn</span><br>
<span class="lineno">45</span><span class="op" id="2959858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2959861">func</span>&nbsp;<span class="op" id="2959866">(</span><span class="ident" id="2959867">hs</span>&nbsp;<span class="op" id="2959870">*</span><span class="ident" id="2959871">historyListener</span><span class="op" id="2959886">)</span>&nbsp;<span class="ident" id="2959888">Accept</span><span class="op" id="2959894">(</span><span class="op" id="2959895">)</span>&nbsp;<span class="op" id="2959897">(</span><span class="ident" id="2959898">c</span>&nbsp;<span class="ident" id="2959900">net</span><span class="op" id="2959903">.</span><span class="ident" id="2959904">Conn</span><span class="op" id="2959908">,</span>&nbsp;<span class="ident" id="2959910">err</span>&nbsp;<span class="builtintype" id="2959914">error</span><span class="op" id="2959919">)</span>&nbsp;<span class="op" id="2959921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959924">c</span><span class="op" id="2959925">,</span>&nbsp;<span class="ident" id="2959927">err</span>&nbsp;<span class="op" id="2959931">=</span>&nbsp;<span class="ident" id="2959933">hs</span><span class="op" id="2959935">.</span><span class="ident" id="2959936">Listener</span><span class="op" id="2959944">.</span><span class="ident" id="2959945">Accept</span><span class="op" id="2959951">(</span><span class="op" id="2959952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959955">if</span>&nbsp;<span class="ident" id="2959958">err</span>&nbsp;<span class="op" id="2959962">==</span>&nbsp;<span class="ident" id="2959965">nil</span>&nbsp;<span class="op" id="2959969">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959973">hs</span><span class="op" id="2959975">.</span><span class="ident" id="2959976">Lock</span><span class="op" id="2959980">(</span><span class="op" id="2959981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959985">hs</span><span class="op" id="2959987">.</span><span class="ident" id="2959988">history</span>&nbsp;<span class="op" id="2959996">=</span>&nbsp;<span class="builtinfunc" id="2959998">append</span><span class="op" id="2960004">(</span><span class="ident" id="2960005">hs</span><span class="op" id="2960007">.</span><span class="ident" id="2960008">history</span><span class="op" id="2960015">,</span>&nbsp;<span class="ident" id="2960017">c</span><span class="op" id="2960018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960022">hs</span><span class="op" id="2960024">.</span><span class="ident" id="2960025">Unlock</span><span class="op" id="2960031">(</span><span class="op" id="2960032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960038">return</span><br>
<span class="lineno">55</span><span class="op" id="2960045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2960048">func</span>&nbsp;<span class="ident" id="2960053">newLocalListener</span><span class="op" id="2960069">(</span><span class="op" id="2960070">)</span>&nbsp;<span class="ident" id="2960072">net</span><span class="op" id="2960075">.</span><span class="ident" id="2960076">Listener</span>&nbsp;<span class="op" id="2960085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960088">if</span>&nbsp;<span class="op" id="2960091">*</span><span class="ident" id="2960092">serve</span>&nbsp;<span class="op" id="2960098">!=</span>&nbsp;<span class="string" id="2960101">&#34;&#34;</span>&nbsp;<span class="op" id="2960104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960108">l</span><span class="op" id="2960109">,</span>&nbsp;<span class="ident" id="2960111">err</span>&nbsp;<span class="op" id="2960115">:=</span>&nbsp;<span class="ident" id="2960118">net</span><span class="op" id="2960121">.</span><span class="ident" id="2960122">Listen</span><span class="op" id="2960128">(</span><span class="string" id="2960129">&#34;tcp&#34;</span><span class="op" id="2960134">,</span>&nbsp;<span class="op" id="2960136">*</span><span class="ident" id="2960137">serve</span><span class="op" id="2960142">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960146">if</span>&nbsp;<span class="ident" id="2960149">err</span>&nbsp;<span class="op" id="2960153">!=</span>&nbsp;<span class="ident" id="2960156">nil</span>&nbsp;<span class="op" id="2960160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2960165">panic</span><span class="op" id="2960170">(</span><span class="ident" id="2960171">fmt</span><span class="op" id="2960174">.</span><span class="ident" id="2960175">Sprintf</span><span class="op" id="2960182">(</span><span class="string" id="2960183">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="2960221">,</span>&nbsp;<span class="op" id="2960223">*</span><span class="ident" id="2960224">serve</span><span class="op" id="2960229">,</span>&nbsp;<span class="ident" id="2960231">err</span><span class="op" id="2960234">)</span><span class="op" id="2960235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960243">return</span>&nbsp;<span class="ident" id="2960250">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960253">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960256">l</span><span class="op" id="2960257">,</span>&nbsp;<span class="ident" id="2960259">err</span>&nbsp;<span class="op" id="2960263">:=</span>&nbsp;<span class="ident" id="2960266">net</span><span class="op" id="2960269">.</span><span class="ident" id="2960270">Listen</span><span class="op" id="2960276">(</span><span class="string" id="2960277">&#34;tcp&#34;</span><span class="op" id="2960282">,</span>&nbsp;<span class="string" id="2960284">&#34;127.0.0.1:0&#34;</span><span class="op" id="2960297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960300">if</span>&nbsp;<span class="ident" id="2960303">err</span>&nbsp;<span class="op" id="2960307">!=</span>&nbsp;<span class="ident" id="2960310">nil</span>&nbsp;<span class="op" id="2960314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960318">if</span>&nbsp;<span class="ident" id="2960321">l</span><span class="op" id="2960322">,</span>&nbsp;<span class="ident" id="2960324">err</span>&nbsp;<span class="op" id="2960328">=</span>&nbsp;<span class="ident" id="2960330">net</span><span class="op" id="2960333">.</span><span class="ident" id="2960334">Listen</span><span class="op" id="2960340">(</span><span class="string" id="2960341">&#34;tcp6&#34;</span><span class="op" id="2960347">,</span>&nbsp;<span class="string" id="2960349">&#34;[::1]:0&#34;</span><span class="op" id="2960358">)</span><span class="op" id="2960359">;</span>&nbsp;<span class="ident" id="2960361">err</span>&nbsp;<span class="op" id="2960365">!=</span>&nbsp;<span class="ident" id="2960368">nil</span>&nbsp;<span class="op" id="2960372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2960377">panic</span><span class="op" id="2960382">(</span><span class="ident" id="2960383">fmt</span><span class="op" id="2960386">.</span><span class="ident" id="2960387">Sprintf</span><span class="op" id="2960394">(</span><span class="string" id="2960395">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="2960437">,</span>&nbsp;<span class="ident" id="2960439">err</span><span class="op" id="2960442">)</span><span class="op" id="2960443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960447">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960453">return</span>&nbsp;<span class="ident" id="2960460">l</span><br>
<span class="lineno"></span><span class="op" id="2960462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2960465">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="2960520">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="2960546">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="2960604">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="2960672">var</span>&nbsp;<span class="ident" id="2960676">serve</span>&nbsp;<span class="op" id="2960682">=</span>&nbsp;<span class="ident" id="2960684">flag</span><span class="op" id="2960688">.</span><span class="ident" id="2960689">String</span><span class="op" id="2960695">(</span><span class="string" id="2960696">&#34;httptest.serve&#34;</span><span class="op" id="2960712">,</span>&nbsp;<span class="string" id="2960714">&#34;&#34;</span><span class="op" id="2960716">,</span>&nbsp;<span class="string" id="2960718">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="2960786">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2960789">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="2960835">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="2960899">func</span>&nbsp;<span class="ident" id="2960904">NewServer</span><span class="op" id="2960913">(</span><span class="ident" id="2960914">handler</span>&nbsp;<span class="ident" id="2960922">http</span><span class="op" id="2960926">.</span><span class="ident" id="2960927">Handler</span><span class="op" id="2960934">)</span>&nbsp;<span class="op" id="2960936">*</span><span class="ident" id="2960937">Server</span>&nbsp;<span class="op" id="2960944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960947">ts</span>&nbsp;<span class="op" id="2960950">:=</span>&nbsp;<span class="ident" id="2960953">NewUnstartedServer</span><span class="op" id="2960971">(</span><span class="ident" id="2960972">handler</span><span class="op" id="2960979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960982">ts</span><span class="op" id="2960984">.</span><span class="ident" id="2960985">Start</span><span class="op" id="2960990">(</span><span class="op" id="2960991">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960994">return</span>&nbsp;<span class="ident" id="2961001">ts</span><br>
<span class="lineno"></span><span class="op" id="2961004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2961007">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2961072">//</span><br>
<span class="lineno">90</span><span class="comment" id="2961075">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="2961144">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="2961157">//</span><br>
<span class="lineno"></span><span class="comment" id="2961160">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="2961224">func</span>&nbsp;<span class="ident" id="2961229">NewUnstartedServer</span><span class="op" id="2961247">(</span><span class="ident" id="2961248">handler</span>&nbsp;<span class="ident" id="2961256">http</span><span class="op" id="2961260">.</span><span class="ident" id="2961261">Handler</span><span class="op" id="2961268">)</span>&nbsp;<span class="op" id="2961270">*</span><span class="ident" id="2961271">Server</span>&nbsp;<span class="op" id="2961278">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961281">return</span>&nbsp;<span class="op" id="2961288">&amp;</span><span class="ident" id="2961289">Server</span><span class="op" id="2961295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961299">Listener</span><span class="op" id="2961307">:</span>&nbsp;<span class="ident" id="2961309">newLocalListener</span><span class="op" id="2961325">(</span><span class="op" id="2961326">)</span><span class="op" id="2961327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961331">Config</span><span class="op" id="2961337">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2961341">&amp;</span><span class="ident" id="2961342">http</span><span class="op" id="2961346">.</span><span class="ident" id="2961347">Server</span><span class="op" id="2961353">{</span><span class="ident" id="2961354">Handler</span><span class="op" id="2961361">:</span>&nbsp;<span class="ident" id="2961363">handler</span><span class="op" id="2961370">}</span><span class="op" id="2961371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961374">}</span><br>
<span class="lineno"></span><span class="op" id="2961376">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="2961379">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="2961429">func</span>&nbsp;<span class="op" id="2961434">(</span><span class="ident" id="2961435">s</span>&nbsp;<span class="op" id="2961437">*</span><span class="ident" id="2961438">Server</span><span class="op" id="2961444">)</span>&nbsp;<span class="ident" id="2961446">Start</span><span class="op" id="2961451">(</span><span class="op" id="2961452">)</span>&nbsp;<span class="op" id="2961454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961457">if</span>&nbsp;<span class="ident" id="2961460">s</span><span class="op" id="2961461">.</span><span class="ident" id="2961462">URL</span>&nbsp;<span class="op" id="2961466">!=</span>&nbsp;<span class="string" id="2961469">&#34;&#34;</span>&nbsp;<span class="op" id="2961472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2961476">panic</span><span class="op" id="2961481">(</span><span class="string" id="2961482">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="2961506">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961512">s</span><span class="op" id="2961513">.</span><span class="ident" id="2961514">Listener</span>&nbsp;<span class="op" id="2961523">=</span>&nbsp;<span class="op" id="2961525">&amp;</span><span class="ident" id="2961526">historyListener</span><span class="op" id="2961541">{</span><span class="ident" id="2961542">Listener</span><span class="op" id="2961550">:</span>&nbsp;<span class="ident" id="2961552">s</span><span class="op" id="2961553">.</span><span class="ident" id="2961554">Listener</span><span class="op" id="2961562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961565">s</span><span class="op" id="2961566">.</span><span class="ident" id="2961567">URL</span>&nbsp;<span class="op" id="2961571">=</span>&nbsp;<span class="string" id="2961573">&#34;http://&#34;</span>&nbsp;<span class="op" id="2961583">+</span>&nbsp;<span class="ident" id="2961585">s</span><span class="op" id="2961586">.</span><span class="ident" id="2961587">Listener</span><span class="op" id="2961595">.</span><span class="ident" id="2961596">Addr</span><span class="op" id="2961600">(</span><span class="op" id="2961601">)</span><span class="op" id="2961602">.</span><span class="ident" id="2961603">String</span><span class="op" id="2961609">(</span><span class="op" id="2961610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961613">s</span><span class="op" id="2961614">.</span><span class="ident" id="2961615">wrapHandler</span><span class="op" id="2961626">(</span><span class="op" id="2961627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961630">go</span>&nbsp;<span class="ident" id="2961633">s</span><span class="op" id="2961634">.</span><span class="ident" id="2961635">Config</span><span class="op" id="2961641">.</span><span class="ident" id="2961642">Serve</span><span class="op" id="2961647">(</span><span class="ident" id="2961648">s</span><span class="op" id="2961649">.</span><span class="ident" id="2961650">Listener</span><span class="op" id="2961658">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961661">if</span>&nbsp;<span class="op" id="2961664">*</span><span class="ident" id="2961665">serve</span>&nbsp;<span class="op" id="2961671">!=</span>&nbsp;<span class="string" id="2961674">&#34;&#34;</span>&nbsp;<span class="op" id="2961677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961681">fmt</span><span class="op" id="2961684">.</span><span class="ident" id="2961685">Fprintln</span><span class="op" id="2961693">(</span><span class="ident" id="2961694">os</span><span class="op" id="2961696">.</span><span class="ident" id="2961697">Stderr</span><span class="op" id="2961703">,</span>&nbsp;<span class="string" id="2961705">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="2961727">,</span>&nbsp;<span class="ident" id="2961729">s</span><span class="op" id="2961730">.</span><span class="ident" id="2961731">URL</span><span class="op" id="2961734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961738">select</span>&nbsp;<span class="op" id="2961745">{</span><span class="op" id="2961746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961749">}</span><br>
<span class="lineno"></span><span class="op" id="2961751">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="2961754">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="2961814">func</span>&nbsp;<span class="op" id="2961819">(</span><span class="ident" id="2961820">s</span>&nbsp;<span class="op" id="2961822">*</span><span class="ident" id="2961823">Server</span><span class="op" id="2961829">)</span>&nbsp;<span class="ident" id="2961831">StartTLS</span><span class="op" id="2961839">(</span><span class="op" id="2961840">)</span>&nbsp;<span class="op" id="2961842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961845">if</span>&nbsp;<span class="ident" id="2961848">s</span><span class="op" id="2961849">.</span><span class="ident" id="2961850">URL</span>&nbsp;<span class="op" id="2961854">!=</span>&nbsp;<span class="string" id="2961857">&#34;&#34;</span>&nbsp;<span class="op" id="2961860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2961864">panic</span><span class="op" id="2961869">(</span><span class="string" id="2961870">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="2961894">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961900">cert</span><span class="op" id="2961904">,</span>&nbsp;<span class="ident" id="2961906">err</span>&nbsp;<span class="op" id="2961910">:=</span>&nbsp;<span class="ident" id="2961913">tls</span><span class="op" id="2961916">.</span><span class="ident" id="2961917">X509KeyPair</span><span class="op" id="2961928">(</span><span class="ident" id="2961929">localhostCert</span><span class="op" id="2961942">,</span>&nbsp;<span class="ident" id="2961944">localhostKey</span><span class="op" id="2961956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961959">if</span>&nbsp;<span class="ident" id="2961962">err</span>&nbsp;<span class="op" id="2961966">!=</span>&nbsp;<span class="ident" id="2961969">nil</span>&nbsp;<span class="op" id="2961973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2961977">panic</span><span class="op" id="2961982">(</span><span class="ident" id="2961983">fmt</span><span class="op" id="2961986">.</span><span class="ident" id="2961987">Sprintf</span><span class="op" id="2961994">(</span><span class="string" id="2961995">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="2962023">,</span>&nbsp;<span class="ident" id="2962025">err</span><span class="op" id="2962028">)</span><span class="op" id="2962029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962032">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962036">existingConfig</span>&nbsp;<span class="op" id="2962051">:=</span>&nbsp;<span class="ident" id="2962054">s</span><span class="op" id="2962055">.</span><span class="ident" id="2962056">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962061">s</span><span class="op" id="2962062">.</span><span class="ident" id="2962063">TLS</span>&nbsp;<span class="op" id="2962067">=</span>&nbsp;<span class="builtinfunc" id="2962069">new</span><span class="op" id="2962072">(</span><span class="ident" id="2962073">tls</span><span class="op" id="2962076">.</span><span class="ident" id="2962077">Config</span><span class="op" id="2962083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962086">if</span>&nbsp;<span class="ident" id="2962089">existingConfig</span>&nbsp;<span class="op" id="2962104">!=</span>&nbsp;<span class="ident" id="2962107">nil</span>&nbsp;<span class="op" id="2962111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962115">*</span><span class="ident" id="2962116">s</span><span class="op" id="2962117">.</span><span class="ident" id="2962118">TLS</span>&nbsp;<span class="op" id="2962122">=</span>&nbsp;<span class="op" id="2962124">*</span><span class="ident" id="2962125">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962144">if</span>&nbsp;<span class="ident" id="2962147">s</span><span class="op" id="2962148">.</span><span class="ident" id="2962149">TLS</span><span class="op" id="2962152">.</span><span class="ident" id="2962153">NextProtos</span>&nbsp;<span class="op" id="2962164">==</span>&nbsp;<span class="ident" id="2962167">nil</span>&nbsp;<span class="op" id="2962171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962175">s</span><span class="op" id="2962176">.</span><span class="ident" id="2962177">TLS</span><span class="op" id="2962180">.</span><span class="ident" id="2962181">NextProtos</span>&nbsp;<span class="op" id="2962192">=</span>&nbsp;<span class="op" id="2962194">[</span><span class="op" id="2962195">]</span><span class="builtintype" id="2962196">string</span><span class="op" id="2962202">{</span><span class="string" id="2962203">&#34;http/1.1&#34;</span><span class="op" id="2962213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962219">if</span>&nbsp;<span class="builtinfunc" id="2962222">len</span><span class="op" id="2962225">(</span><span class="ident" id="2962226">s</span><span class="op" id="2962227">.</span><span class="ident" id="2962228">TLS</span><span class="op" id="2962231">.</span><span class="ident" id="2962232">Certificates</span><span class="op" id="2962244">)</span>&nbsp;<span class="op" id="2962246">==</span>&nbsp;<span class="num" id="2962249">0</span>&nbsp;<span class="op" id="2962251">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962255">s</span><span class="op" id="2962256">.</span><span class="ident" id="2962257">TLS</span><span class="op" id="2962260">.</span><span class="ident" id="2962261">Certificates</span>&nbsp;<span class="op" id="2962274">=</span>&nbsp;<span class="op" id="2962276">[</span><span class="op" id="2962277">]</span><span class="ident" id="2962278">tls</span><span class="op" id="2962281">.</span><span class="ident" id="2962282">Certificate</span><span class="op" id="2962293">{</span><span class="ident" id="2962294">cert</span><span class="op" id="2962298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962304">tlsListener</span>&nbsp;<span class="op" id="2962316">:=</span>&nbsp;<span class="ident" id="2962319">tls</span><span class="op" id="2962322">.</span><span class="ident" id="2962323">NewListener</span><span class="op" id="2962334">(</span><span class="ident" id="2962335">s</span><span class="op" id="2962336">.</span><span class="ident" id="2962337">Listener</span><span class="op" id="2962345">,</span>&nbsp;<span class="ident" id="2962347">s</span><span class="op" id="2962348">.</span><span class="ident" id="2962349">TLS</span><span class="op" id="2962352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962356">s</span><span class="op" id="2962357">.</span><span class="ident" id="2962358">Listener</span>&nbsp;<span class="op" id="2962367">=</span>&nbsp;<span class="op" id="2962369">&amp;</span><span class="ident" id="2962370">historyListener</span><span class="op" id="2962385">{</span><span class="ident" id="2962386">Listener</span><span class="op" id="2962394">:</span>&nbsp;<span class="ident" id="2962396">tlsListener</span><span class="op" id="2962407">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962410">s</span><span class="op" id="2962411">.</span><span class="ident" id="2962412">URL</span>&nbsp;<span class="op" id="2962416">=</span>&nbsp;<span class="string" id="2962418">&#34;https://&#34;</span>&nbsp;<span class="op" id="2962429">+</span>&nbsp;<span class="ident" id="2962431">s</span><span class="op" id="2962432">.</span><span class="ident" id="2962433">Listener</span><span class="op" id="2962441">.</span><span class="ident" id="2962442">Addr</span><span class="op" id="2962446">(</span><span class="op" id="2962447">)</span><span class="op" id="2962448">.</span><span class="ident" id="2962449">String</span><span class="op" id="2962455">(</span><span class="op" id="2962456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962459">s</span><span class="op" id="2962460">.</span><span class="ident" id="2962461">wrapHandler</span><span class="op" id="2962472">(</span><span class="op" id="2962473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962476">go</span>&nbsp;<span class="ident" id="2962479">s</span><span class="op" id="2962480">.</span><span class="ident" id="2962481">Config</span><span class="op" id="2962487">.</span><span class="ident" id="2962488">Serve</span><span class="op" id="2962493">(</span><span class="ident" id="2962494">s</span><span class="op" id="2962495">.</span><span class="ident" id="2962496">Listener</span><span class="op" id="2962504">)</span><br>
<span class="lineno"></span><span class="op" id="2962506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="2962509">func</span>&nbsp;<span class="op" id="2962514">(</span><span class="ident" id="2962515">s</span>&nbsp;<span class="op" id="2962517">*</span><span class="ident" id="2962518">Server</span><span class="op" id="2962524">)</span>&nbsp;<span class="ident" id="2962526">wrapHandler</span><span class="op" id="2962537">(</span><span class="op" id="2962538">)</span>&nbsp;<span class="op" id="2962540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962543">h</span>&nbsp;<span class="op" id="2962545">:=</span>&nbsp;<span class="ident" id="2962548">s</span><span class="op" id="2962549">.</span><span class="ident" id="2962550">Config</span><span class="op" id="2962556">.</span><span class="ident" id="2962557">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962566">if</span>&nbsp;<span class="ident" id="2962569">h</span>&nbsp;<span class="op" id="2962571">==</span>&nbsp;<span class="ident" id="2962574">nil</span>&nbsp;<span class="op" id="2962578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962582">h</span>&nbsp;<span class="op" id="2962584">=</span>&nbsp;<span class="ident" id="2962586">http</span><span class="op" id="2962590">.</span><span class="ident" id="2962591">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962608">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962611">s</span><span class="op" id="2962612">.</span><span class="ident" id="2962613">Config</span><span class="op" id="2962619">.</span><span class="ident" id="2962620">Handler</span>&nbsp;<span class="op" id="2962628">=</span>&nbsp;<span class="op" id="2962630">&amp;</span><span class="ident" id="2962631">waitGroupHandler</span><span class="op" id="2962647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962651">s</span><span class="op" id="2962652">:</span>&nbsp;<span class="ident" id="2962654">s</span><span class="op" id="2962655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962659">h</span><span class="op" id="2962660">:</span>&nbsp;<span class="ident" id="2962662">h</span><span class="op" id="2962663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962666">}</span><br>
<span class="lineno"></span><span class="op" id="2962668">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="2962671">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="2962730">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="2962794">func</span>&nbsp;<span class="ident" id="2962799">NewTLSServer</span><span class="op" id="2962811">(</span><span class="ident" id="2962812">handler</span>&nbsp;<span class="ident" id="2962820">http</span><span class="op" id="2962824">.</span><span class="ident" id="2962825">Handler</span><span class="op" id="2962832">)</span>&nbsp;<span class="op" id="2962834">*</span><span class="ident" id="2962835">Server</span>&nbsp;<span class="op" id="2962842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962845">ts</span>&nbsp;<span class="op" id="2962848">:=</span>&nbsp;<span class="ident" id="2962851">NewUnstartedServer</span><span class="op" id="2962869">(</span><span class="ident" id="2962870">handler</span><span class="op" id="2962877">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962880">ts</span><span class="op" id="2962882">.</span><span class="ident" id="2962883">StartTLS</span><span class="op" id="2962891">(</span><span class="op" id="2962892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962895">return</span>&nbsp;<span class="ident" id="2962902">ts</span><br>
<span class="lineno"></span><span class="op" id="2962905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2962908">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="2962972">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="2963015">func</span>&nbsp;<span class="op" id="2963020">(</span><span class="ident" id="2963021">s</span>&nbsp;<span class="op" id="2963023">*</span><span class="ident" id="2963024">Server</span><span class="op" id="2963030">)</span>&nbsp;<span class="ident" id="2963032">Close</span><span class="op" id="2963037">(</span><span class="op" id="2963038">)</span>&nbsp;<span class="op" id="2963040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963043">s</span><span class="op" id="2963044">.</span><span class="ident" id="2963045">Listener</span><span class="op" id="2963053">.</span><span class="ident" id="2963054">Close</span><span class="op" id="2963059">(</span><span class="op" id="2963060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963063">s</span><span class="op" id="2963064">.</span><span class="ident" id="2963065">wg</span><span class="op" id="2963067">.</span><span class="ident" id="2963068">Wait</span><span class="op" id="2963072">(</span><span class="op" id="2963073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963076">s</span><span class="op" id="2963077">.</span><span class="ident" id="2963078">CloseClientConnections</span><span class="op" id="2963100">(</span><span class="op" id="2963101">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963104">if</span>&nbsp;<span class="ident" id="2963107">t</span><span class="op" id="2963108">,</span>&nbsp;<span class="ident" id="2963110">ok</span>&nbsp;<span class="op" id="2963113">:=</span>&nbsp;<span class="ident" id="2963116">http</span><span class="op" id="2963120">.</span><span class="ident" id="2963121">DefaultTransport</span><span class="op" id="2963137">.</span><span class="op" id="2963138">(</span><span class="op" id="2963139">*</span><span class="ident" id="2963140">http</span><span class="op" id="2963144">.</span><span class="ident" id="2963145">Transport</span><span class="op" id="2963154">)</span><span class="op" id="2963155">;</span>&nbsp;<span class="ident" id="2963157">ok</span>&nbsp;<span class="op" id="2963160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963164">t</span><span class="op" id="2963165">.</span><span class="ident" id="2963166">CloseIdleConnections</span><span class="op" id="2963186">(</span><span class="op" id="2963187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963190">}</span><br>
<span class="lineno"></span><span class="op" id="2963192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="2963195">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="2963264">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="2963287">func</span>&nbsp;<span class="op" id="2963292">(</span><span class="ident" id="2963293">s</span>&nbsp;<span class="op" id="2963295">*</span><span class="ident" id="2963296">Server</span><span class="op" id="2963302">)</span>&nbsp;<span class="ident" id="2963304">CloseClientConnections</span><span class="op" id="2963326">(</span><span class="op" id="2963327">)</span>&nbsp;<span class="op" id="2963329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963332">hl</span><span class="op" id="2963334">,</span>&nbsp;<span class="ident" id="2963336">ok</span>&nbsp;<span class="op" id="2963339">:=</span>&nbsp;<span class="ident" id="2963342">s</span><span class="op" id="2963343">.</span><span class="ident" id="2963344">Listener</span><span class="op" id="2963352">.</span><span class="op" id="2963353">(</span><span class="op" id="2963354">*</span><span class="ident" id="2963355">historyListener</span><span class="op" id="2963370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963373">if</span>&nbsp;<span class="op" id="2963376">!</span><span class="ident" id="2963377">ok</span>&nbsp;<span class="op" id="2963380">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963384">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963395">hl</span><span class="op" id="2963397">.</span><span class="ident" id="2963398">Lock</span><span class="op" id="2963402">(</span><span class="op" id="2963403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963406">for</span>&nbsp;<span class="ident" id="2963410">_</span><span class="op" id="2963411">,</span>&nbsp;<span class="ident" id="2963413">conn</span>&nbsp;<span class="op" id="2963418">:=</span>&nbsp;<span class="keyword" id="2963421">range</span>&nbsp;<span class="ident" id="2963427">hl</span><span class="op" id="2963429">.</span><span class="ident" id="2963430">history</span>&nbsp;<span class="op" id="2963438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963442">conn</span><span class="op" id="2963446">.</span><span class="ident" id="2963447">Close</span><span class="op" id="2963452">(</span><span class="op" id="2963453">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963459">hl</span><span class="op" id="2963461">.</span><span class="ident" id="2963462">Unlock</span><span class="op" id="2963468">(</span><span class="op" id="2963469">)</span><br>
<span class="lineno"></span><span class="op" id="2963471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2963474">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="2963543">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="2963610">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="2963654">type</span>&nbsp;<span class="ident" id="2963659">waitGroupHandler</span>&nbsp;<span class="keyword" id="2963676">struct</span>&nbsp;<span class="op" id="2963683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963686">s</span>&nbsp;<span class="op" id="2963688">*</span><span class="ident" id="2963689">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963697">h</span>&nbsp;<span class="ident" id="2963699">http</span><span class="op" id="2963703">.</span><span class="ident" id="2963704">Handler</span>&nbsp;<span class="comment" id="2963712">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="2963723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2963726">func</span>&nbsp;<span class="op" id="2963731">(</span><span class="ident" id="2963732">h</span>&nbsp;<span class="op" id="2963734">*</span><span class="ident" id="2963735">waitGroupHandler</span><span class="op" id="2963751">)</span>&nbsp;<span class="ident" id="2963753">ServeHTTP</span><span class="op" id="2963762">(</span><span class="ident" id="2963763">w</span>&nbsp;<span class="ident" id="2963765">http</span><span class="op" id="2963769">.</span><span class="ident" id="2963770">ResponseWriter</span><span class="op" id="2963784">,</span>&nbsp;<span class="ident" id="2963786">r</span>&nbsp;<span class="op" id="2963788">*</span><span class="ident" id="2963789">http</span><span class="op" id="2963793">.</span><span class="ident" id="2963794">Request</span><span class="op" id="2963801">)</span>&nbsp;<span class="op" id="2963803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963806">h</span><span class="op" id="2963807">.</span><span class="ident" id="2963808">s</span><span class="op" id="2963809">.</span><span class="ident" id="2963810">wg</span><span class="op" id="2963812">.</span><span class="ident" id="2963813">Add</span><span class="op" id="2963816">(</span><span class="num" id="2963817">1</span><span class="op" id="2963818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963821">defer</span>&nbsp;<span class="ident" id="2963827">h</span><span class="op" id="2963828">.</span><span class="ident" id="2963829">s</span><span class="op" id="2963830">.</span><span class="ident" id="2963831">wg</span><span class="op" id="2963833">.</span><span class="ident" id="2963834">Done</span><span class="op" id="2963838">(</span><span class="op" id="2963839">)</span>&nbsp;<span class="comment" id="2963841">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963885">h</span><span class="op" id="2963886">.</span><span class="ident" id="2963887">h</span><span class="op" id="2963888">.</span><span class="ident" id="2963889">ServeHTTP</span><span class="op" id="2963898">(</span><span class="ident" id="2963899">w</span><span class="op" id="2963900">,</span>&nbsp;<span class="ident" id="2963902">r</span><span class="op" id="2963903">)</span><br>
<span class="lineno"></span><span class="op" id="2963905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2963908">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="2963964">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="2964037">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="2964056">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="2964090">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="2964226">var</span>&nbsp;<span class="ident" id="2964230">localhostCert</span>&nbsp;<span class="op" id="2964244">=</span>&nbsp;<span class="op" id="2964246">[</span><span class="op" id="2964247">]</span><span class="builtintype" id="2964248">byte</span><span class="op" id="2964252">(</span><span class="string" id="2964253">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="2964824">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2964827">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="2964881">var</span>&nbsp;<span class="ident" id="2964885">localhostKey</span>&nbsp;<span class="op" id="2964898">=</span>&nbsp;<span class="op" id="2964900">[</span><span class="op" id="2964901">]</span><span class="builtintype" id="2964902">byte</span><span class="op" id="2964906">(</span><span class="string" id="2964907">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="2965405">)</span>
</div>
</body>
</html>
