<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4024783">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4024839">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4024893">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4024944">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="4024998">//</span><br>
<span class="lineno"></span><span class="comment" id="4025001">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="4025073">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="4025123">package</span>&nbsp;<span class="ident" id="4025131">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4025137">import</span>&nbsp;<span class="op" id="4025144">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4025147">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4025156">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="4025170">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4025173">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="4025235">const</span>&nbsp;<span class="ident" id="4025241">m</span>&nbsp;<span class="op" id="4025243">=</span>&nbsp;<span class="num" id="4025245">1</span><span class="op" id="4025246">&lt;&lt;</span><span class="num" id="4025248">16</span>&nbsp;<span class="op" id="4025251">-</span>&nbsp;<span class="num" id="4025253">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4025256">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="4025327">type</span>&nbsp;<span class="ident" id="4025332">Image</span>&nbsp;<span class="keyword" id="4025338">interface</span>&nbsp;<span class="op" id="4025348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025351">image</span><span class="op" id="4025356">.</span><span class="ident" id="4025357">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025364">Set</span><span class="op" id="4025367">(</span><span class="ident" id="4025368">x</span><span class="op" id="4025369">,</span>&nbsp;<span class="ident" id="4025371">y</span>&nbsp;<span class="builtintype" id="4025373">int</span><span class="op" id="4025376">,</span>&nbsp;<span class="ident" id="4025378">c</span>&nbsp;<span class="ident" id="4025380">color</span><span class="op" id="4025385">.</span><span class="ident" id="4025386">Color</span><span class="op" id="4025391">)</span><br>
<span class="lineno"></span><span class="op" id="4025393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4025396">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="4025442">type</span>&nbsp;<span class="ident" id="4025447">Quantizer</span>&nbsp;<span class="keyword" id="4025457">interface</span>&nbsp;<span class="op" id="4025467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025470">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025541">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025608">Quantize</span><span class="op" id="4025616">(</span><span class="ident" id="4025617">p</span>&nbsp;<span class="ident" id="4025619">color</span><span class="op" id="4025624">.</span><span class="ident" id="4025625">Palette</span><span class="op" id="4025632">,</span>&nbsp;<span class="ident" id="4025634">m</span>&nbsp;<span class="ident" id="4025636">image</span><span class="op" id="4025641">.</span><span class="ident" id="4025642">Image</span><span class="op" id="4025647">)</span>&nbsp;<span class="ident" id="4025649">color</span><span class="op" id="4025654">.</span><span class="ident" id="4025655">Palette</span><br>
<span class="lineno">30</span><span class="op" id="4025663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4025666">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="4025711">type</span>&nbsp;<span class="ident" id="4025716">Op</span>&nbsp;<span class="builtintype" id="4025719">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4025724">const</span>&nbsp;<span class="op" id="4025730">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025733">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025780">Over</span>&nbsp;<span class="ident" id="4025785">Op</span>&nbsp;<span class="op" id="4025788">=</span>&nbsp;<span class="ident" id="4025790">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025796">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025831">Src</span><br>
<span class="lineno">40</span><span class="op" id="4025835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4025838">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4025917">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="4025924">func</span>&nbsp;<span class="op" id="4025929">(</span><span class="ident" id="4025930">op</span>&nbsp;<span class="ident" id="4025933">Op</span><span class="op" id="4025935">)</span>&nbsp;<span class="ident" id="4025937">Draw</span><span class="op" id="4025941">(</span><span class="ident" id="4025942">dst</span>&nbsp;<span class="ident" id="4025946">Image</span><span class="op" id="4025951">,</span>&nbsp;<span class="ident" id="4025953">r</span>&nbsp;<span class="ident" id="4025955">image</span><span class="op" id="4025960">.</span><span class="ident" id="4025961">Rectangle</span><span class="op" id="4025970">,</span>&nbsp;<span class="ident" id="4025972">src</span>&nbsp;<span class="ident" id="4025976">image</span><span class="op" id="4025981">.</span><span class="ident" id="4025982">Image</span><span class="op" id="4025987">,</span>&nbsp;<span class="ident" id="4025989">sp</span>&nbsp;<span class="ident" id="4025992">image</span><span class="op" id="4025997">.</span><span class="ident" id="4025998">Point</span><span class="op" id="4026003">)</span>&nbsp;<span class="op" id="4026005">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026008">DrawMask</span><span class="op" id="4026016">(</span><span class="ident" id="4026017">dst</span><span class="op" id="4026020">,</span>&nbsp;<span class="ident" id="4026022">r</span><span class="op" id="4026023">,</span>&nbsp;<span class="ident" id="4026025">src</span><span class="op" id="4026028">,</span>&nbsp;<span class="ident" id="4026030">sp</span><span class="op" id="4026032">,</span>&nbsp;<span class="ident" id="4026034">nil</span><span class="op" id="4026037">,</span>&nbsp;<span class="ident" id="4026039">image</span><span class="op" id="4026044">.</span><span class="ident" id="4026045">Point</span><span class="op" id="4026050">{</span><span class="op" id="4026051">}</span><span class="op" id="4026052">,</span>&nbsp;<span class="ident" id="4026054">op</span><span class="op" id="4026056">)</span><br>
<span class="lineno"></span><span class="op" id="4026058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4026061">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="4026097">type</span>&nbsp;<span class="ident" id="4026102">Drawer</span>&nbsp;<span class="keyword" id="4026109">interface</span>&nbsp;<span class="op" id="4026119">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026122">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026188">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026250">Draw</span><span class="op" id="4026254">(</span><span class="ident" id="4026255">dst</span>&nbsp;<span class="ident" id="4026259">Image</span><span class="op" id="4026264">,</span>&nbsp;<span class="ident" id="4026266">r</span>&nbsp;<span class="ident" id="4026268">image</span><span class="op" id="4026273">.</span><span class="ident" id="4026274">Rectangle</span><span class="op" id="4026283">,</span>&nbsp;<span class="ident" id="4026285">src</span>&nbsp;<span class="ident" id="4026289">image</span><span class="op" id="4026294">.</span><span class="ident" id="4026295">Image</span><span class="op" id="4026300">,</span>&nbsp;<span class="ident" id="4026302">sp</span>&nbsp;<span class="ident" id="4026305">image</span><span class="op" id="4026310">.</span><span class="ident" id="4026311">Point</span><span class="op" id="4026316">)</span><br>
<span class="lineno"></span><span class="op" id="4026318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4026321">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4026397">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="4026411">var</span>&nbsp;<span class="ident" id="4026415">FloydSteinberg</span>&nbsp;<span class="ident" id="4026430">Drawer</span>&nbsp;<span class="op" id="4026437">=</span>&nbsp;<span class="ident" id="4026439">floydSteinberg</span><span class="op" id="4026453">{</span><span class="op" id="4026454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4026457">type</span>&nbsp;<span class="ident" id="4026462">floydSteinberg</span>&nbsp;<span class="keyword" id="4026477">struct</span><span class="op" id="4026483">{</span><span class="op" id="4026484">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="4026487">func</span>&nbsp;<span class="op" id="4026492">(</span><span class="ident" id="4026493">floydSteinberg</span><span class="op" id="4026507">)</span>&nbsp;<span class="ident" id="4026509">Draw</span><span class="op" id="4026513">(</span><span class="ident" id="4026514">dst</span>&nbsp;<span class="ident" id="4026518">Image</span><span class="op" id="4026523">,</span>&nbsp;<span class="ident" id="4026525">r</span>&nbsp;<span class="ident" id="4026527">image</span><span class="op" id="4026532">.</span><span class="ident" id="4026533">Rectangle</span><span class="op" id="4026542">,</span>&nbsp;<span class="ident" id="4026544">src</span>&nbsp;<span class="ident" id="4026548">image</span><span class="op" id="4026553">.</span><span class="ident" id="4026554">Image</span><span class="op" id="4026559">,</span>&nbsp;<span class="ident" id="4026561">sp</span>&nbsp;<span class="ident" id="4026564">image</span><span class="op" id="4026569">.</span><span class="ident" id="4026570">Point</span><span class="op" id="4026575">)</span>&nbsp;<span class="op" id="4026577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026580">clip</span><span class="op" id="4026584">(</span><span class="ident" id="4026585">dst</span><span class="op" id="4026588">,</span>&nbsp;<span class="op" id="4026590">&amp;</span><span class="ident" id="4026591">r</span><span class="op" id="4026592">,</span>&nbsp;<span class="ident" id="4026594">src</span><span class="op" id="4026597">,</span>&nbsp;<span class="op" id="4026599">&amp;</span><span class="ident" id="4026600">sp</span><span class="op" id="4026602">,</span>&nbsp;<span class="ident" id="4026604">nil</span><span class="op" id="4026607">,</span>&nbsp;<span class="ident" id="4026609">nil</span><span class="op" id="4026612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026615">if</span>&nbsp;<span class="ident" id="4026618">r</span><span class="op" id="4026619">.</span><span class="ident" id="4026620">Empty</span><span class="op" id="4026625">(</span><span class="op" id="4026626">)</span>&nbsp;<span class="op" id="4026628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026632">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4026640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026643">drawPaletted</span><span class="op" id="4026655">(</span><span class="ident" id="4026656">dst</span><span class="op" id="4026659">,</span>&nbsp;<span class="ident" id="4026661">r</span><span class="op" id="4026662">,</span>&nbsp;<span class="ident" id="4026664">src</span><span class="op" id="4026667">,</span>&nbsp;<span class="ident" id="4026669">sp</span><span class="op" id="4026671">,</span>&nbsp;<span class="builtintype" id="4026673">true</span><span class="op" id="4026677">)</span><br>
<span class="lineno"></span><span class="op" id="4026679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4026682">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4026754">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4026831">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="4026874">func</span>&nbsp;<span class="ident" id="4026879">clip</span><span class="op" id="4026883">(</span><span class="ident" id="4026884">dst</span>&nbsp;<span class="ident" id="4026888">Image</span><span class="op" id="4026893">,</span>&nbsp;<span class="ident" id="4026895">r</span>&nbsp;<span class="op" id="4026897">*</span><span class="ident" id="4026898">image</span><span class="op" id="4026903">.</span><span class="ident" id="4026904">Rectangle</span><span class="op" id="4026913">,</span>&nbsp;<span class="ident" id="4026915">src</span>&nbsp;<span class="ident" id="4026919">image</span><span class="op" id="4026924">.</span><span class="ident" id="4026925">Image</span><span class="op" id="4026930">,</span>&nbsp;<span class="ident" id="4026932">sp</span>&nbsp;<span class="op" id="4026935">*</span><span class="ident" id="4026936">image</span><span class="op" id="4026941">.</span><span class="ident" id="4026942">Point</span><span class="op" id="4026947">,</span>&nbsp;<span class="ident" id="4026949">mask</span>&nbsp;<span class="ident" id="4026954">image</span><span class="op" id="4026959">.</span><span class="ident" id="4026960">Image</span><span class="op" id="4026965">,</span>&nbsp;<span class="ident" id="4026967">mp</span>&nbsp;<span class="op" id="4026970">*</span><span class="ident" id="4026971">image</span><span class="op" id="4026976">.</span><span class="ident" id="4026977">Point</span><span class="op" id="4026982">)</span>&nbsp;<span class="op" id="4026984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026987">orig</span>&nbsp;<span class="op" id="4026992">:=</span>&nbsp;<span class="ident" id="4026995">r</span><span class="op" id="4026996">.</span><span class="ident" id="4026997">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027002">*</span><span class="ident" id="4027003">r</span>&nbsp;<span class="op" id="4027005">=</span>&nbsp;<span class="ident" id="4027007">r</span><span class="op" id="4027008">.</span><span class="ident" id="4027009">Intersect</span><span class="op" id="4027018">(</span><span class="ident" id="4027019">dst</span><span class="op" id="4027022">.</span><span class="ident" id="4027023">Bounds</span><span class="op" id="4027029">(</span><span class="op" id="4027030">)</span><span class="op" id="4027031">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027034">*</span><span class="ident" id="4027035">r</span>&nbsp;<span class="op" id="4027037">=</span>&nbsp;<span class="ident" id="4027039">r</span><span class="op" id="4027040">.</span><span class="ident" id="4027041">Intersect</span><span class="op" id="4027050">(</span><span class="ident" id="4027051">src</span><span class="op" id="4027054">.</span><span class="ident" id="4027055">Bounds</span><span class="op" id="4027061">(</span><span class="op" id="4027062">)</span><span class="op" id="4027063">.</span><span class="ident" id="4027064">Add</span><span class="op" id="4027067">(</span><span class="ident" id="4027068">orig</span><span class="op" id="4027072">.</span><span class="ident" id="4027073">Sub</span><span class="op" id="4027076">(</span><span class="op" id="4027077">*</span><span class="ident" id="4027078">sp</span><span class="op" id="4027080">)</span><span class="op" id="4027081">)</span><span class="op" id="4027082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027085">if</span>&nbsp;<span class="ident" id="4027088">mask</span>&nbsp;<span class="op" id="4027093">!=</span>&nbsp;<span class="ident" id="4027096">nil</span>&nbsp;<span class="op" id="4027100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027104">*</span><span class="ident" id="4027105">r</span>&nbsp;<span class="op" id="4027107">=</span>&nbsp;<span class="ident" id="4027109">r</span><span class="op" id="4027110">.</span><span class="ident" id="4027111">Intersect</span><span class="op" id="4027120">(</span><span class="ident" id="4027121">mask</span><span class="op" id="4027125">.</span><span class="ident" id="4027126">Bounds</span><span class="op" id="4027132">(</span><span class="op" id="4027133">)</span><span class="op" id="4027134">.</span><span class="ident" id="4027135">Add</span><span class="op" id="4027138">(</span><span class="ident" id="4027139">orig</span><span class="op" id="4027143">.</span><span class="ident" id="4027144">Sub</span><span class="op" id="4027147">(</span><span class="op" id="4027148">*</span><span class="ident" id="4027149">mp</span><span class="op" id="4027151">)</span><span class="op" id="4027152">)</span><span class="op" id="4027153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027159">dx</span>&nbsp;<span class="op" id="4027162">:=</span>&nbsp;<span class="ident" id="4027165">r</span><span class="op" id="4027166">.</span><span class="ident" id="4027167">Min</span><span class="op" id="4027170">.</span><span class="ident" id="4027171">X</span>&nbsp;<span class="op" id="4027173">-</span>&nbsp;<span class="ident" id="4027175">orig</span><span class="op" id="4027179">.</span><span class="ident" id="4027180">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027183">dy</span>&nbsp;<span class="op" id="4027186">:=</span>&nbsp;<span class="ident" id="4027189">r</span><span class="op" id="4027190">.</span><span class="ident" id="4027191">Min</span><span class="op" id="4027194">.</span><span class="ident" id="4027195">Y</span>&nbsp;<span class="op" id="4027197">-</span>&nbsp;<span class="ident" id="4027199">orig</span><span class="op" id="4027203">.</span><span class="ident" id="4027204">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027207">if</span>&nbsp;<span class="ident" id="4027210">dx</span>&nbsp;<span class="op" id="4027213">==</span>&nbsp;<span class="num" id="4027216">0</span>&nbsp;<span class="op" id="4027218">&amp;&amp;</span>&nbsp;<span class="ident" id="4027221">dy</span>&nbsp;<span class="op" id="4027224">==</span>&nbsp;<span class="num" id="4027227">0</span>&nbsp;<span class="op" id="4027229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027233">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027244">(</span><span class="op" id="4027245">*</span><span class="ident" id="4027246">sp</span><span class="op" id="4027248">)</span><span class="op" id="4027249">.</span><span class="ident" id="4027250">X</span>&nbsp;<span class="op" id="4027252">+=</span>&nbsp;<span class="ident" id="4027255">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027259">(</span><span class="op" id="4027260">*</span><span class="ident" id="4027261">sp</span><span class="op" id="4027263">)</span><span class="op" id="4027264">.</span><span class="ident" id="4027265">Y</span>&nbsp;<span class="op" id="4027267">+=</span>&nbsp;<span class="ident" id="4027270">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027274">(</span><span class="op" id="4027275">*</span><span class="ident" id="4027276">mp</span><span class="op" id="4027278">)</span><span class="op" id="4027279">.</span><span class="ident" id="4027280">X</span>&nbsp;<span class="op" id="4027282">+=</span>&nbsp;<span class="ident" id="4027285">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027289">(</span><span class="op" id="4027290">*</span><span class="ident" id="4027291">mp</span><span class="op" id="4027293">)</span><span class="op" id="4027294">.</span><span class="ident" id="4027295">Y</span>&nbsp;<span class="op" id="4027297">+=</span>&nbsp;<span class="ident" id="4027300">dy</span><br>
<span class="lineno"></span><span class="op" id="4027303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="4027306">func</span>&nbsp;<span class="ident" id="4027311">processBackward</span><span class="op" id="4027326">(</span><span class="ident" id="4027327">dst</span>&nbsp;<span class="ident" id="4027331">Image</span><span class="op" id="4027336">,</span>&nbsp;<span class="ident" id="4027338">r</span>&nbsp;<span class="ident" id="4027340">image</span><span class="op" id="4027345">.</span><span class="ident" id="4027346">Rectangle</span><span class="op" id="4027355">,</span>&nbsp;<span class="ident" id="4027357">src</span>&nbsp;<span class="ident" id="4027361">image</span><span class="op" id="4027366">.</span><span class="ident" id="4027367">Image</span><span class="op" id="4027372">,</span>&nbsp;<span class="ident" id="4027374">sp</span>&nbsp;<span class="ident" id="4027377">image</span><span class="op" id="4027382">.</span><span class="ident" id="4027383">Point</span><span class="op" id="4027388">)</span>&nbsp;<span class="builtintype" id="4027390">bool</span>&nbsp;<span class="op" id="4027395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027398">return</span>&nbsp;<span class="ident" id="4027405">image</span><span class="op" id="4027410">.</span><span class="ident" id="4027411">Image</span><span class="op" id="4027416">(</span><span class="ident" id="4027417">dst</span><span class="op" id="4027420">)</span>&nbsp;<span class="op" id="4027422">==</span>&nbsp;<span class="ident" id="4027425">src</span>&nbsp;<span class="op" id="4027429">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027434">r</span><span class="op" id="4027435">.</span><span class="ident" id="4027436">Overlaps</span><span class="op" id="4027444">(</span><span class="ident" id="4027445">r</span><span class="op" id="4027446">.</span><span class="ident" id="4027447">Add</span><span class="op" id="4027450">(</span><span class="ident" id="4027451">sp</span><span class="op" id="4027453">.</span><span class="ident" id="4027454">Sub</span><span class="op" id="4027457">(</span><span class="ident" id="4027458">r</span><span class="op" id="4027459">.</span><span class="ident" id="4027460">Min</span><span class="op" id="4027463">)</span><span class="op" id="4027464">)</span><span class="op" id="4027465">)</span>&nbsp;<span class="op" id="4027467">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027472">(</span><span class="ident" id="4027473">sp</span><span class="op" id="4027475">.</span><span class="ident" id="4027476">Y</span>&nbsp;<span class="op" id="4027478">&lt;</span>&nbsp;<span class="ident" id="4027480">r</span><span class="op" id="4027481">.</span><span class="ident" id="4027482">Min</span><span class="op" id="4027485">.</span><span class="ident" id="4027486">Y</span>&nbsp;<span class="op" id="4027488">||</span>&nbsp;<span class="op" id="4027491">(</span><span class="ident" id="4027492">sp</span><span class="op" id="4027494">.</span><span class="ident" id="4027495">Y</span>&nbsp;<span class="op" id="4027497">==</span>&nbsp;<span class="ident" id="4027500">r</span><span class="op" id="4027501">.</span><span class="ident" id="4027502">Min</span><span class="op" id="4027505">.</span><span class="ident" id="4027506">Y</span>&nbsp;<span class="op" id="4027508">&amp;&amp;</span>&nbsp;<span class="ident" id="4027511">sp</span><span class="op" id="4027513">.</span><span class="ident" id="4027514">X</span>&nbsp;<span class="op" id="4027516">&lt;</span>&nbsp;<span class="ident" id="4027518">r</span><span class="op" id="4027519">.</span><span class="ident" id="4027520">Min</span><span class="op" id="4027523">.</span><span class="ident" id="4027524">X</span><span class="op" id="4027525">)</span><span class="op" id="4027526">)</span><br>
<span class="lineno"></span><span class="op" id="4027528">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="4027531">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="4027571">func</span>&nbsp;<span class="ident" id="4027576">Draw</span><span class="op" id="4027580">(</span><span class="ident" id="4027581">dst</span>&nbsp;<span class="ident" id="4027585">Image</span><span class="op" id="4027590">,</span>&nbsp;<span class="ident" id="4027592">r</span>&nbsp;<span class="ident" id="4027594">image</span><span class="op" id="4027599">.</span><span class="ident" id="4027600">Rectangle</span><span class="op" id="4027609">,</span>&nbsp;<span class="ident" id="4027611">src</span>&nbsp;<span class="ident" id="4027615">image</span><span class="op" id="4027620">.</span><span class="ident" id="4027621">Image</span><span class="op" id="4027626">,</span>&nbsp;<span class="ident" id="4027628">sp</span>&nbsp;<span class="ident" id="4027631">image</span><span class="op" id="4027636">.</span><span class="ident" id="4027637">Point</span><span class="op" id="4027642">,</span>&nbsp;<span class="ident" id="4027644">op</span>&nbsp;<span class="ident" id="4027647">Op</span><span class="op" id="4027649">)</span>&nbsp;<span class="op" id="4027651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027654">DrawMask</span><span class="op" id="4027662">(</span><span class="ident" id="4027663">dst</span><span class="op" id="4027666">,</span>&nbsp;<span class="ident" id="4027668">r</span><span class="op" id="4027669">,</span>&nbsp;<span class="ident" id="4027671">src</span><span class="op" id="4027674">,</span>&nbsp;<span class="ident" id="4027676">sp</span><span class="op" id="4027678">,</span>&nbsp;<span class="ident" id="4027680">nil</span><span class="op" id="4027683">,</span>&nbsp;<span class="ident" id="4027685">image</span><span class="op" id="4027690">.</span><span class="ident" id="4027691">Point</span><span class="op" id="4027696">{</span><span class="op" id="4027697">}</span><span class="op" id="4027698">,</span>&nbsp;<span class="ident" id="4027700">op</span><span class="op" id="4027702">)</span><br>
<span class="lineno"></span><span class="op" id="4027704">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4027707">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4027803">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="4027892">func</span>&nbsp;<span class="ident" id="4027897">DrawMask</span><span class="op" id="4027905">(</span><span class="ident" id="4027906">dst</span>&nbsp;<span class="ident" id="4027910">Image</span><span class="op" id="4027915">,</span>&nbsp;<span class="ident" id="4027917">r</span>&nbsp;<span class="ident" id="4027919">image</span><span class="op" id="4027924">.</span><span class="ident" id="4027925">Rectangle</span><span class="op" id="4027934">,</span>&nbsp;<span class="ident" id="4027936">src</span>&nbsp;<span class="ident" id="4027940">image</span><span class="op" id="4027945">.</span><span class="ident" id="4027946">Image</span><span class="op" id="4027951">,</span>&nbsp;<span class="ident" id="4027953">sp</span>&nbsp;<span class="ident" id="4027956">image</span><span class="op" id="4027961">.</span><span class="ident" id="4027962">Point</span><span class="op" id="4027967">,</span>&nbsp;<span class="ident" id="4027969">mask</span>&nbsp;<span class="ident" id="4027974">image</span><span class="op" id="4027979">.</span><span class="ident" id="4027980">Image</span><span class="op" id="4027985">,</span>&nbsp;<span class="ident" id="4027987">mp</span>&nbsp;<span class="ident" id="4027990">image</span><span class="op" id="4027995">.</span><span class="ident" id="4027996">Point</span><span class="op" id="4028001">,</span>&nbsp;<span class="ident" id="4028003">op</span>&nbsp;<span class="ident" id="4028006">Op</span><span class="op" id="4028008">)</span>&nbsp;<span class="op" id="4028010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028013">clip</span><span class="op" id="4028017">(</span><span class="ident" id="4028018">dst</span><span class="op" id="4028021">,</span>&nbsp;<span class="op" id="4028023">&amp;</span><span class="ident" id="4028024">r</span><span class="op" id="4028025">,</span>&nbsp;<span class="ident" id="4028027">src</span><span class="op" id="4028030">,</span>&nbsp;<span class="op" id="4028032">&amp;</span><span class="ident" id="4028033">sp</span><span class="op" id="4028035">,</span>&nbsp;<span class="ident" id="4028037">mask</span><span class="op" id="4028041">,</span>&nbsp;<span class="op" id="4028043">&amp;</span><span class="ident" id="4028044">mp</span><span class="op" id="4028046">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028049">if</span>&nbsp;<span class="ident" id="4028052">r</span><span class="op" id="4028053">.</span><span class="ident" id="4028054">Empty</span><span class="op" id="4028059">(</span><span class="op" id="4028060">)</span>&nbsp;<span class="op" id="4028062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028066">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4028078">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028191">switch</span>&nbsp;<span class="ident" id="4028198">dst0</span>&nbsp;<span class="op" id="4028203">:=</span>&nbsp;<span class="ident" id="4028206">dst</span><span class="op" id="4028209">.</span><span class="op" id="4028210">(</span><span class="keyword" id="4028211">type</span><span class="op" id="4028215">)</span>&nbsp;<span class="op" id="4028217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028220">case</span>&nbsp;<span class="op" id="4028225">*</span><span class="ident" id="4028226">image</span><span class="op" id="4028231">.</span><span class="ident" id="4028232">RGBA</span><span class="op" id="4028236">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028240">if</span>&nbsp;<span class="ident" id="4028243">op</span>&nbsp;<span class="op" id="4028246">==</span>&nbsp;<span class="ident" id="4028249">Over</span>&nbsp;<span class="op" id="4028254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028259">if</span>&nbsp;<span class="ident" id="4028262">mask</span>&nbsp;<span class="op" id="4028267">==</span>&nbsp;<span class="ident" id="4028270">nil</span>&nbsp;<span class="op" id="4028274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028280">switch</span>&nbsp;<span class="ident" id="4028287">src0</span>&nbsp;<span class="op" id="4028292">:=</span>&nbsp;<span class="ident" id="4028295">src</span><span class="op" id="4028298">.</span><span class="op" id="4028299">(</span><span class="keyword" id="4028300">type</span><span class="op" id="4028304">)</span>&nbsp;<span class="op" id="4028306">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028312">case</span>&nbsp;<span class="op" id="4028317">*</span><span class="ident" id="4028318">image</span><span class="op" id="4028323">.</span><span class="ident" id="4028324">Uniform</span><span class="op" id="4028331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028338">drawFillOver</span><span class="op" id="4028350">(</span><span class="ident" id="4028351">dst0</span><span class="op" id="4028355">,</span>&nbsp;<span class="ident" id="4028357">r</span><span class="op" id="4028358">,</span>&nbsp;<span class="ident" id="4028360">src0</span><span class="op" id="4028364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028371">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028382">case</span>&nbsp;<span class="op" id="4028387">*</span><span class="ident" id="4028388">image</span><span class="op" id="4028393">.</span><span class="ident" id="4028394">RGBA</span><span class="op" id="4028398">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028405">drawCopyOver</span><span class="op" id="4028417">(</span><span class="ident" id="4028418">dst0</span><span class="op" id="4028422">,</span>&nbsp;<span class="ident" id="4028424">r</span><span class="op" id="4028425">,</span>&nbsp;<span class="ident" id="4028427">src0</span><span class="op" id="4028431">,</span>&nbsp;<span class="ident" id="4028433">sp</span><span class="op" id="4028435">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028442">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028453">case</span>&nbsp;<span class="op" id="4028458">*</span><span class="ident" id="4028459">image</span><span class="op" id="4028464">.</span><span class="ident" id="4028465">NRGBA</span><span class="op" id="4028470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028477">drawNRGBAOver</span><span class="op" id="4028490">(</span><span class="ident" id="4028491">dst0</span><span class="op" id="4028495">,</span>&nbsp;<span class="ident" id="4028497">r</span><span class="op" id="4028498">,</span>&nbsp;<span class="ident" id="4028500">src0</span><span class="op" id="4028504">,</span>&nbsp;<span class="ident" id="4028506">sp</span><span class="op" id="4028508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028515">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028526">case</span>&nbsp;<span class="op" id="4028531">*</span><span class="ident" id="4028532">image</span><span class="op" id="4028537">.</span><span class="ident" id="4028538">YCbCr</span><span class="op" id="4028543">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028550">if</span>&nbsp;<span class="ident" id="4028553">drawYCbCr</span><span class="op" id="4028562">(</span><span class="ident" id="4028563">dst0</span><span class="op" id="4028567">,</span>&nbsp;<span class="ident" id="4028569">r</span><span class="op" id="4028570">,</span>&nbsp;<span class="ident" id="4028572">src0</span><span class="op" id="4028576">,</span>&nbsp;<span class="ident" id="4028578">sp</span><span class="op" id="4028580">)</span>&nbsp;<span class="op" id="4028582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028590">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028613">}</span>&nbsp;<span class="keyword" id="4028615">else</span>&nbsp;<span class="keyword" id="4028620">if</span>&nbsp;<span class="ident" id="4028623">mask0</span><span class="op" id="4028628">,</span>&nbsp;<span class="ident" id="4028630">ok</span>&nbsp;<span class="op" id="4028633">:=</span>&nbsp;<span class="ident" id="4028636">mask</span><span class="op" id="4028640">.</span><span class="op" id="4028641">(</span><span class="op" id="4028642">*</span><span class="ident" id="4028643">image</span><span class="op" id="4028648">.</span><span class="ident" id="4028649">Alpha</span><span class="op" id="4028654">)</span><span class="op" id="4028655">;</span>&nbsp;<span class="ident" id="4028657">ok</span>&nbsp;<span class="op" id="4028660">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028666">switch</span>&nbsp;<span class="ident" id="4028673">src0</span>&nbsp;<span class="op" id="4028678">:=</span>&nbsp;<span class="ident" id="4028681">src</span><span class="op" id="4028684">.</span><span class="op" id="4028685">(</span><span class="keyword" id="4028686">type</span><span class="op" id="4028690">)</span>&nbsp;<span class="op" id="4028692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028698">case</span>&nbsp;<span class="op" id="4028703">*</span><span class="ident" id="4028704">image</span><span class="op" id="4028709">.</span><span class="ident" id="4028710">Uniform</span><span class="op" id="4028717">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028724">drawGlyphOver</span><span class="op" id="4028737">(</span><span class="ident" id="4028738">dst0</span><span class="op" id="4028742">,</span>&nbsp;<span class="ident" id="4028744">r</span><span class="op" id="4028745">,</span>&nbsp;<span class="ident" id="4028747">src0</span><span class="op" id="4028751">,</span>&nbsp;<span class="ident" id="4028753">mask0</span><span class="op" id="4028758">,</span>&nbsp;<span class="ident" id="4028760">mp</span><span class="op" id="4028762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028769">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028780">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028789">}</span>&nbsp;<span class="keyword" id="4028791">else</span>&nbsp;<span class="op" id="4028796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028801">if</span>&nbsp;<span class="ident" id="4028804">mask</span>&nbsp;<span class="op" id="4028809">==</span>&nbsp;<span class="ident" id="4028812">nil</span>&nbsp;<span class="op" id="4028816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028822">switch</span>&nbsp;<span class="ident" id="4028829">src0</span>&nbsp;<span class="op" id="4028834">:=</span>&nbsp;<span class="ident" id="4028837">src</span><span class="op" id="4028840">.</span><span class="op" id="4028841">(</span><span class="keyword" id="4028842">type</span><span class="op" id="4028846">)</span>&nbsp;<span class="op" id="4028848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028854">case</span>&nbsp;<span class="op" id="4028859">*</span><span class="ident" id="4028860">image</span><span class="op" id="4028865">.</span><span class="ident" id="4028866">Uniform</span><span class="op" id="4028873">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028880">drawFillSrc</span><span class="op" id="4028891">(</span><span class="ident" id="4028892">dst0</span><span class="op" id="4028896">,</span>&nbsp;<span class="ident" id="4028898">r</span><span class="op" id="4028899">,</span>&nbsp;<span class="ident" id="4028901">src0</span><span class="op" id="4028905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028912">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028923">case</span>&nbsp;<span class="op" id="4028928">*</span><span class="ident" id="4028929">image</span><span class="op" id="4028934">.</span><span class="ident" id="4028935">RGBA</span><span class="op" id="4028939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028946">drawCopySrc</span><span class="op" id="4028957">(</span><span class="ident" id="4028958">dst0</span><span class="op" id="4028962">,</span>&nbsp;<span class="ident" id="4028964">r</span><span class="op" id="4028965">,</span>&nbsp;<span class="ident" id="4028967">src0</span><span class="op" id="4028971">,</span>&nbsp;<span class="ident" id="4028973">sp</span><span class="op" id="4028975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028982">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028993">case</span>&nbsp;<span class="op" id="4028998">*</span><span class="ident" id="4028999">image</span><span class="op" id="4029004">.</span><span class="ident" id="4029005">NRGBA</span><span class="op" id="4029010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029017">drawNRGBASrc</span><span class="op" id="4029029">(</span><span class="ident" id="4029030">dst0</span><span class="op" id="4029034">,</span>&nbsp;<span class="ident" id="4029036">r</span><span class="op" id="4029037">,</span>&nbsp;<span class="ident" id="4029039">src0</span><span class="op" id="4029043">,</span>&nbsp;<span class="ident" id="4029045">sp</span><span class="op" id="4029047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029054">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029065">case</span>&nbsp;<span class="op" id="4029070">*</span><span class="ident" id="4029071">image</span><span class="op" id="4029076">.</span><span class="ident" id="4029077">YCbCr</span><span class="op" id="4029082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029089">if</span>&nbsp;<span class="ident" id="4029092">drawYCbCr</span><span class="op" id="4029101">(</span><span class="ident" id="4029102">dst0</span><span class="op" id="4029106">,</span>&nbsp;<span class="ident" id="4029108">r</span><span class="op" id="4029109">,</span>&nbsp;<span class="ident" id="4029111">src0</span><span class="op" id="4029115">,</span>&nbsp;<span class="ident" id="4029117">sp</span><span class="op" id="4029119">)</span>&nbsp;<span class="op" id="4029121">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029129">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029156">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029160">drawRGBA</span><span class="op" id="4029168">(</span><span class="ident" id="4029169">dst0</span><span class="op" id="4029173">,</span>&nbsp;<span class="ident" id="4029175">r</span><span class="op" id="4029176">,</span>&nbsp;<span class="ident" id="4029178">src</span><span class="op" id="4029181">,</span>&nbsp;<span class="ident" id="4029183">sp</span><span class="op" id="4029185">,</span>&nbsp;<span class="ident" id="4029187">mask</span><span class="op" id="4029191">,</span>&nbsp;<span class="ident" id="4029193">mp</span><span class="op" id="4029195">,</span>&nbsp;<span class="ident" id="4029197">op</span><span class="op" id="4029199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029211">case</span>&nbsp;<span class="op" id="4029216">*</span><span class="ident" id="4029217">image</span><span class="op" id="4029222">.</span><span class="ident" id="4029223">Paletted</span><span class="op" id="4029231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029235">if</span>&nbsp;<span class="ident" id="4029238">op</span>&nbsp;<span class="op" id="4029241">==</span>&nbsp;<span class="ident" id="4029244">Src</span>&nbsp;<span class="op" id="4029248">&amp;&amp;</span>&nbsp;<span class="ident" id="4029251">mask</span>&nbsp;<span class="op" id="4029256">==</span>&nbsp;<span class="ident" id="4029259">nil</span>&nbsp;<span class="op" id="4029263">&amp;&amp;</span>&nbsp;<span class="op" id="4029266">!</span><span class="ident" id="4029267">processBackward</span><span class="op" id="4029282">(</span><span class="ident" id="4029283">dst</span><span class="op" id="4029286">,</span>&nbsp;<span class="ident" id="4029288">r</span><span class="op" id="4029289">,</span>&nbsp;<span class="ident" id="4029291">src</span><span class="op" id="4029294">,</span>&nbsp;<span class="ident" id="4029296">sp</span><span class="op" id="4029298">)</span>&nbsp;<span class="op" id="4029300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029305">drawPaletted</span><span class="op" id="4029317">(</span><span class="ident" id="4029318">dst0</span><span class="op" id="4029322">,</span>&nbsp;<span class="ident" id="4029324">r</span><span class="op" id="4029325">,</span>&nbsp;<span class="ident" id="4029327">src</span><span class="op" id="4029330">,</span>&nbsp;<span class="ident" id="4029332">sp</span><span class="op" id="4029334">,</span>&nbsp;<span class="builtintype" id="4029336">false</span><span class="op" id="4029341">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029352">x0</span><span class="op" id="4029354">,</span>&nbsp;<span class="ident" id="4029356">x1</span><span class="op" id="4029358">,</span>&nbsp;<span class="ident" id="4029360">dx</span>&nbsp;<span class="op" id="4029363">:=</span>&nbsp;<span class="ident" id="4029366">r</span><span class="op" id="4029367">.</span><span class="ident" id="4029368">Min</span><span class="op" id="4029371">.</span><span class="ident" id="4029372">X</span><span class="op" id="4029373">,</span>&nbsp;<span class="ident" id="4029375">r</span><span class="op" id="4029376">.</span><span class="ident" id="4029377">Max</span><span class="op" id="4029380">.</span><span class="ident" id="4029381">X</span><span class="op" id="4029382">,</span>&nbsp;<span class="num" id="4029384">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029387">y0</span><span class="op" id="4029389">,</span>&nbsp;<span class="ident" id="4029391">y1</span><span class="op" id="4029393">,</span>&nbsp;<span class="ident" id="4029395">dy</span>&nbsp;<span class="op" id="4029398">:=</span>&nbsp;<span class="ident" id="4029401">r</span><span class="op" id="4029402">.</span><span class="ident" id="4029403">Min</span><span class="op" id="4029406">.</span><span class="ident" id="4029407">Y</span><span class="op" id="4029408">,</span>&nbsp;<span class="ident" id="4029410">r</span><span class="op" id="4029411">.</span><span class="ident" id="4029412">Max</span><span class="op" id="4029415">.</span><span class="ident" id="4029416">Y</span><span class="op" id="4029417">,</span>&nbsp;<span class="num" id="4029419">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029422">if</span>&nbsp;<span class="ident" id="4029425">processBackward</span><span class="op" id="4029440">(</span><span class="ident" id="4029441">dst</span><span class="op" id="4029444">,</span>&nbsp;<span class="ident" id="4029446">r</span><span class="op" id="4029447">,</span>&nbsp;<span class="ident" id="4029449">src</span><span class="op" id="4029452">,</span>&nbsp;<span class="ident" id="4029454">sp</span><span class="op" id="4029456">)</span>&nbsp;<span class="op" id="4029458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029462">x0</span><span class="op" id="4029464">,</span>&nbsp;<span class="ident" id="4029466">x1</span><span class="op" id="4029468">,</span>&nbsp;<span class="ident" id="4029470">dx</span>&nbsp;<span class="op" id="4029473">=</span>&nbsp;<span class="ident" id="4029475">x1</span><span class="op" id="4029477">-</span><span class="num" id="4029478">1</span><span class="op" id="4029479">,</span>&nbsp;<span class="ident" id="4029481">x0</span><span class="op" id="4029483">-</span><span class="num" id="4029484">1</span><span class="op" id="4029485">,</span>&nbsp;<span class="op" id="4029487">-</span><span class="num" id="4029488">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029492">y0</span><span class="op" id="4029494">,</span>&nbsp;<span class="ident" id="4029496">y1</span><span class="op" id="4029498">,</span>&nbsp;<span class="ident" id="4029500">dy</span>&nbsp;<span class="op" id="4029503">=</span>&nbsp;<span class="ident" id="4029505">y1</span><span class="op" id="4029507">-</span><span class="num" id="4029508">1</span><span class="op" id="4029509">,</span>&nbsp;<span class="ident" id="4029511">y0</span><span class="op" id="4029513">-</span><span class="num" id="4029514">1</span><span class="op" id="4029515">,</span>&nbsp;<span class="op" id="4029517">-</span><span class="num" id="4029518">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029525">var</span>&nbsp;<span class="ident" id="4029529">out</span>&nbsp;<span class="ident" id="4029533">color</span><span class="op" id="4029538">.</span><span class="ident" id="4029539">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029547">sy</span>&nbsp;<span class="op" id="4029550">:=</span>&nbsp;<span class="ident" id="4029553">sp</span><span class="op" id="4029555">.</span><span class="ident" id="4029556">Y</span>&nbsp;<span class="op" id="4029558">+</span>&nbsp;<span class="ident" id="4029560">y0</span>&nbsp;<span class="op" id="4029563">-</span>&nbsp;<span class="ident" id="4029565">r</span><span class="op" id="4029566">.</span><span class="ident" id="4029567">Min</span><span class="op" id="4029570">.</span><span class="ident" id="4029571">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029574">my</span>&nbsp;<span class="op" id="4029577">:=</span>&nbsp;<span class="ident" id="4029580">mp</span><span class="op" id="4029582">.</span><span class="ident" id="4029583">Y</span>&nbsp;<span class="op" id="4029585">+</span>&nbsp;<span class="ident" id="4029587">y0</span>&nbsp;<span class="op" id="4029590">-</span>&nbsp;<span class="ident" id="4029592">r</span><span class="op" id="4029593">.</span><span class="ident" id="4029594">Min</span><span class="op" id="4029597">.</span><span class="ident" id="4029598">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029601">for</span>&nbsp;<span class="ident" id="4029605">y</span>&nbsp;<span class="op" id="4029607">:=</span>&nbsp;<span class="ident" id="4029610">y0</span><span class="op" id="4029612">;</span>&nbsp;<span class="ident" id="4029614">y</span>&nbsp;<span class="op" id="4029616">!=</span>&nbsp;<span class="ident" id="4029619">y1</span><span class="op" id="4029621">;</span>&nbsp;<span class="ident" id="4029623">y</span><span class="op" id="4029624">,</span>&nbsp;<span class="ident" id="4029626">sy</span><span class="op" id="4029628">,</span>&nbsp;<span class="ident" id="4029630">my</span>&nbsp;<span class="op" id="4029633">=</span>&nbsp;<span class="ident" id="4029635">y</span><span class="op" id="4029636">+</span><span class="ident" id="4029637">dy</span><span class="op" id="4029639">,</span>&nbsp;<span class="ident" id="4029641">sy</span><span class="op" id="4029643">+</span><span class="ident" id="4029644">dy</span><span class="op" id="4029646">,</span>&nbsp;<span class="ident" id="4029648">my</span><span class="op" id="4029650">+</span><span class="ident" id="4029651">dy</span>&nbsp;<span class="op" id="4029654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029658">sx</span>&nbsp;<span class="op" id="4029661">:=</span>&nbsp;<span class="ident" id="4029664">sp</span><span class="op" id="4029666">.</span><span class="ident" id="4029667">X</span>&nbsp;<span class="op" id="4029669">+</span>&nbsp;<span class="ident" id="4029671">x0</span>&nbsp;<span class="op" id="4029674">-</span>&nbsp;<span class="ident" id="4029676">r</span><span class="op" id="4029677">.</span><span class="ident" id="4029678">Min</span><span class="op" id="4029681">.</span><span class="ident" id="4029682">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029686">mx</span>&nbsp;<span class="op" id="4029689">:=</span>&nbsp;<span class="ident" id="4029692">mp</span><span class="op" id="4029694">.</span><span class="ident" id="4029695">X</span>&nbsp;<span class="op" id="4029697">+</span>&nbsp;<span class="ident" id="4029699">x0</span>&nbsp;<span class="op" id="4029702">-</span>&nbsp;<span class="ident" id="4029704">r</span><span class="op" id="4029705">.</span><span class="ident" id="4029706">Min</span><span class="op" id="4029709">.</span><span class="ident" id="4029710">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029714">for</span>&nbsp;<span class="ident" id="4029718">x</span>&nbsp;<span class="op" id="4029720">:=</span>&nbsp;<span class="ident" id="4029723">x0</span><span class="op" id="4029725">;</span>&nbsp;<span class="ident" id="4029727">x</span>&nbsp;<span class="op" id="4029729">!=</span>&nbsp;<span class="ident" id="4029732">x1</span><span class="op" id="4029734">;</span>&nbsp;<span class="ident" id="4029736">x</span><span class="op" id="4029737">,</span>&nbsp;<span class="ident" id="4029739">sx</span><span class="op" id="4029741">,</span>&nbsp;<span class="ident" id="4029743">mx</span>&nbsp;<span class="op" id="4029746">=</span>&nbsp;<span class="ident" id="4029748">x</span><span class="op" id="4029749">+</span><span class="ident" id="4029750">dx</span><span class="op" id="4029752">,</span>&nbsp;<span class="ident" id="4029754">sx</span><span class="op" id="4029756">+</span><span class="ident" id="4029757">dx</span><span class="op" id="4029759">,</span>&nbsp;<span class="ident" id="4029761">mx</span><span class="op" id="4029763">+</span><span class="ident" id="4029764">dx</span>&nbsp;<span class="op" id="4029767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029772">ma</span>&nbsp;<span class="op" id="4029775">:=</span>&nbsp;<span class="builtintype" id="4029778">uint32</span><span class="op" id="4029784">(</span><span class="ident" id="4029785">m</span><span class="op" id="4029786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029791">if</span>&nbsp;<span class="ident" id="4029794">mask</span>&nbsp;<span class="op" id="4029799">!=</span>&nbsp;<span class="ident" id="4029802">nil</span>&nbsp;<span class="op" id="4029806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029812">_</span><span class="op" id="4029813">,</span>&nbsp;<span class="ident" id="4029815">_</span><span class="op" id="4029816">,</span>&nbsp;<span class="ident" id="4029818">_</span><span class="op" id="4029819">,</span>&nbsp;<span class="ident" id="4029821">ma</span>&nbsp;<span class="op" id="4029824">=</span>&nbsp;<span class="ident" id="4029826">mask</span><span class="op" id="4029830">.</span><span class="ident" id="4029831">At</span><span class="op" id="4029833">(</span><span class="ident" id="4029834">mx</span><span class="op" id="4029836">,</span>&nbsp;<span class="ident" id="4029838">my</span><span class="op" id="4029840">)</span><span class="op" id="4029841">.</span><span class="ident" id="4029842">RGBA</span><span class="op" id="4029846">(</span><span class="op" id="4029847">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029857">switch</span>&nbsp;<span class="op" id="4029864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029869">case</span>&nbsp;<span class="ident" id="4029874">ma</span>&nbsp;<span class="op" id="4029877">==</span>&nbsp;<span class="num" id="4029880">0</span><span class="op" id="4029881">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029887">if</span>&nbsp;<span class="ident" id="4029890">op</span>&nbsp;<span class="op" id="4029893">==</span>&nbsp;<span class="ident" id="4029896">Over</span>&nbsp;<span class="op" id="4029901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4029908">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029922">}</span>&nbsp;<span class="keyword" id="4029924">else</span>&nbsp;<span class="op" id="4029929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4029936">dst</span><span class="op" id="4029939">.</span><span class="ident" id="4029940">Set</span><span class="op" id="4029943">(</span><span class="ident" id="4029944">x</span><span class="op" id="4029945">,</span>&nbsp;<span class="ident" id="4029947">y</span><span class="op" id="4029948">,</span>&nbsp;<span class="ident" id="4029950">color</span><span class="op" id="4029955">.</span><span class="ident" id="4029956">Transparent</span><span class="op" id="4029967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4029973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4029978">case</span>&nbsp;<span class="ident" id="4029983">ma</span>&nbsp;<span class="op" id="4029986">==</span>&nbsp;<span class="ident" id="4029989">m</span>&nbsp;<span class="op" id="4029991">&amp;&amp;</span>&nbsp;<span class="ident" id="4029994">op</span>&nbsp;<span class="op" id="4029997">==</span>&nbsp;<span class="ident" id="4030000">Src</span><span class="op" id="4030003">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030009">dst</span><span class="op" id="4030012">.</span><span class="ident" id="4030013">Set</span><span class="op" id="4030016">(</span><span class="ident" id="4030017">x</span><span class="op" id="4030018">,</span>&nbsp;<span class="ident" id="4030020">y</span><span class="op" id="4030021">,</span>&nbsp;<span class="ident" id="4030023">src</span><span class="op" id="4030026">.</span><span class="ident" id="4030027">At</span><span class="op" id="4030029">(</span><span class="ident" id="4030030">sx</span><span class="op" id="4030032">,</span>&nbsp;<span class="ident" id="4030034">sy</span><span class="op" id="4030036">)</span><span class="op" id="4030037">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030042">default</span><span class="op" id="4030049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030055">sr</span><span class="op" id="4030057">,</span>&nbsp;<span class="ident" id="4030059">sg</span><span class="op" id="4030061">,</span>&nbsp;<span class="ident" id="4030063">sb</span><span class="op" id="4030065">,</span>&nbsp;<span class="ident" id="4030067">sa</span>&nbsp;<span class="op" id="4030070">:=</span>&nbsp;<span class="ident" id="4030073">src</span><span class="op" id="4030076">.</span><span class="ident" id="4030077">At</span><span class="op" id="4030079">(</span><span class="ident" id="4030080">sx</span><span class="op" id="4030082">,</span>&nbsp;<span class="ident" id="4030084">sy</span><span class="op" id="4030086">)</span><span class="op" id="4030087">.</span><span class="ident" id="4030088">RGBA</span><span class="op" id="4030092">(</span><span class="op" id="4030093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4030099">if</span>&nbsp;<span class="ident" id="4030102">op</span>&nbsp;<span class="op" id="4030105">==</span>&nbsp;<span class="ident" id="4030108">Over</span>&nbsp;<span class="op" id="4030113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030120">dr</span><span class="op" id="4030122">,</span>&nbsp;<span class="ident" id="4030124">dg</span><span class="op" id="4030126">,</span>&nbsp;<span class="ident" id="4030128">db</span><span class="op" id="4030130">,</span>&nbsp;<span class="ident" id="4030132">da</span>&nbsp;<span class="op" id="4030135">:=</span>&nbsp;<span class="ident" id="4030138">dst</span><span class="op" id="4030141">.</span><span class="ident" id="4030142">At</span><span class="op" id="4030144">(</span><span class="ident" id="4030145">x</span><span class="op" id="4030146">,</span>&nbsp;<span class="ident" id="4030148">y</span><span class="op" id="4030149">)</span><span class="op" id="4030150">.</span><span class="ident" id="4030151">RGBA</span><span class="op" id="4030155">(</span><span class="op" id="4030156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030163">a</span>&nbsp;<span class="op" id="4030165">:=</span>&nbsp;<span class="ident" id="4030168">m</span>&nbsp;<span class="op" id="4030170">-</span>&nbsp;<span class="op" id="4030172">(</span><span class="ident" id="4030173">sa</span>&nbsp;<span class="op" id="4030176">*</span>&nbsp;<span class="ident" id="4030178">ma</span>&nbsp;<span class="op" id="4030181">/</span>&nbsp;<span class="ident" id="4030183">m</span><span class="op" id="4030184">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030191">out</span><span class="op" id="4030194">.</span><span class="ident" id="4030195">R</span>&nbsp;<span class="op" id="4030197">=</span>&nbsp;<span class="builtintype" id="4030199">uint16</span><span class="op" id="4030205">(</span><span class="op" id="4030206">(</span><span class="ident" id="4030207">dr</span><span class="op" id="4030209">*</span><span class="ident" id="4030210">a</span>&nbsp;<span class="op" id="4030212">+</span>&nbsp;<span class="ident" id="4030214">sr</span><span class="op" id="4030216">*</span><span class="ident" id="4030217">ma</span><span class="op" id="4030219">)</span>&nbsp;<span class="op" id="4030221">/</span>&nbsp;<span class="ident" id="4030223">m</span><span class="op" id="4030224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030231">out</span><span class="op" id="4030234">.</span><span class="ident" id="4030235">G</span>&nbsp;<span class="op" id="4030237">=</span>&nbsp;<span class="builtintype" id="4030239">uint16</span><span class="op" id="4030245">(</span><span class="op" id="4030246">(</span><span class="ident" id="4030247">dg</span><span class="op" id="4030249">*</span><span class="ident" id="4030250">a</span>&nbsp;<span class="op" id="4030252">+</span>&nbsp;<span class="ident" id="4030254">sg</span><span class="op" id="4030256">*</span><span class="ident" id="4030257">ma</span><span class="op" id="4030259">)</span>&nbsp;<span class="op" id="4030261">/</span>&nbsp;<span class="ident" id="4030263">m</span><span class="op" id="4030264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030271">out</span><span class="op" id="4030274">.</span><span class="ident" id="4030275">B</span>&nbsp;<span class="op" id="4030277">=</span>&nbsp;<span class="builtintype" id="4030279">uint16</span><span class="op" id="4030285">(</span><span class="op" id="4030286">(</span><span class="ident" id="4030287">db</span><span class="op" id="4030289">*</span><span class="ident" id="4030290">a</span>&nbsp;<span class="op" id="4030292">+</span>&nbsp;<span class="ident" id="4030294">sb</span><span class="op" id="4030296">*</span><span class="ident" id="4030297">ma</span><span class="op" id="4030299">)</span>&nbsp;<span class="op" id="4030301">/</span>&nbsp;<span class="ident" id="4030303">m</span><span class="op" id="4030304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030311">out</span><span class="op" id="4030314">.</span><span class="ident" id="4030315">A</span>&nbsp;<span class="op" id="4030317">=</span>&nbsp;<span class="builtintype" id="4030319">uint16</span><span class="op" id="4030325">(</span><span class="op" id="4030326">(</span><span class="ident" id="4030327">da</span><span class="op" id="4030329">*</span><span class="ident" id="4030330">a</span>&nbsp;<span class="op" id="4030332">+</span>&nbsp;<span class="ident" id="4030334">sa</span><span class="op" id="4030336">*</span><span class="ident" id="4030337">ma</span><span class="op" id="4030339">)</span>&nbsp;<span class="op" id="4030341">/</span>&nbsp;<span class="ident" id="4030343">m</span><span class="op" id="4030344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030350">}</span>&nbsp;<span class="keyword" id="4030352">else</span>&nbsp;<span class="op" id="4030357">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030364">out</span><span class="op" id="4030367">.</span><span class="ident" id="4030368">R</span>&nbsp;<span class="op" id="4030370">=</span>&nbsp;<span class="builtintype" id="4030372">uint16</span><span class="op" id="4030378">(</span><span class="ident" id="4030379">sr</span>&nbsp;<span class="op" id="4030382">*</span>&nbsp;<span class="ident" id="4030384">ma</span>&nbsp;<span class="op" id="4030387">/</span>&nbsp;<span class="ident" id="4030389">m</span><span class="op" id="4030390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030397">out</span><span class="op" id="4030400">.</span><span class="ident" id="4030401">G</span>&nbsp;<span class="op" id="4030403">=</span>&nbsp;<span class="builtintype" id="4030405">uint16</span><span class="op" id="4030411">(</span><span class="ident" id="4030412">sg</span>&nbsp;<span class="op" id="4030415">*</span>&nbsp;<span class="ident" id="4030417">ma</span>&nbsp;<span class="op" id="4030420">/</span>&nbsp;<span class="ident" id="4030422">m</span><span class="op" id="4030423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030430">out</span><span class="op" id="4030433">.</span><span class="ident" id="4030434">B</span>&nbsp;<span class="op" id="4030436">=</span>&nbsp;<span class="builtintype" id="4030438">uint16</span><span class="op" id="4030444">(</span><span class="ident" id="4030445">sb</span>&nbsp;<span class="op" id="4030448">*</span>&nbsp;<span class="ident" id="4030450">ma</span>&nbsp;<span class="op" id="4030453">/</span>&nbsp;<span class="ident" id="4030455">m</span><span class="op" id="4030456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030463">out</span><span class="op" id="4030466">.</span><span class="ident" id="4030467">A</span>&nbsp;<span class="op" id="4030469">=</span>&nbsp;<span class="builtintype" id="4030471">uint16</span><span class="op" id="4030477">(</span><span class="ident" id="4030478">sa</span>&nbsp;<span class="op" id="4030481">*</span>&nbsp;<span class="ident" id="4030483">ma</span>&nbsp;<span class="op" id="4030486">/</span>&nbsp;<span class="ident" id="4030488">m</span><span class="op" id="4030489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030495">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4030501">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4030562">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4030627">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4030690">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030751">dst</span><span class="op" id="4030754">.</span><span class="ident" id="4030755">Set</span><span class="op" id="4030758">(</span><span class="ident" id="4030759">x</span><span class="op" id="4030760">,</span>&nbsp;<span class="ident" id="4030762">y</span><span class="op" id="4030763">,</span>&nbsp;<span class="op" id="4030765">&amp;</span><span class="ident" id="4030766">out</span><span class="op" id="4030769">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4030781">}</span><br>
<span class="lineno"></span><span class="op" id="4030783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="4030786">func</span>&nbsp;<span class="ident" id="4030791">drawFillOver</span><span class="op" id="4030803">(</span><span class="ident" id="4030804">dst</span>&nbsp;<span class="op" id="4030808">*</span><span class="ident" id="4030809">image</span><span class="op" id="4030814">.</span><span class="ident" id="4030815">RGBA</span><span class="op" id="4030819">,</span>&nbsp;<span class="ident" id="4030821">r</span>&nbsp;<span class="ident" id="4030823">image</span><span class="op" id="4030828">.</span><span class="ident" id="4030829">Rectangle</span><span class="op" id="4030838">,</span>&nbsp;<span class="ident" id="4030840">src</span>&nbsp;<span class="op" id="4030844">*</span><span class="ident" id="4030845">image</span><span class="op" id="4030850">.</span><span class="ident" id="4030851">Uniform</span><span class="op" id="4030858">)</span>&nbsp;<span class="op" id="4030860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030863">sr</span><span class="op" id="4030865">,</span>&nbsp;<span class="ident" id="4030867">sg</span><span class="op" id="4030869">,</span>&nbsp;<span class="ident" id="4030871">sb</span><span class="op" id="4030873">,</span>&nbsp;<span class="ident" id="4030875">sa</span>&nbsp;<span class="op" id="4030878">:=</span>&nbsp;<span class="ident" id="4030881">src</span><span class="op" id="4030884">.</span><span class="ident" id="4030885">RGBA</span><span class="op" id="4030889">(</span><span class="op" id="4030890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4030893">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030951">a</span>&nbsp;<span class="op" id="4030953">:=</span>&nbsp;<span class="op" id="4030956">(</span><span class="ident" id="4030957">m</span>&nbsp;<span class="op" id="4030959">-</span>&nbsp;<span class="ident" id="4030961">sa</span><span class="op" id="4030963">)</span>&nbsp;<span class="op" id="4030965">*</span>&nbsp;<span class="num" id="4030967">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4030974">i0</span>&nbsp;<span class="op" id="4030977">:=</span>&nbsp;<span class="ident" id="4030980">dst</span><span class="op" id="4030983">.</span><span class="ident" id="4030984">PixOffset</span><span class="op" id="4030993">(</span><span class="ident" id="4030994">r</span><span class="op" id="4030995">.</span><span class="ident" id="4030996">Min</span><span class="op" id="4030999">.</span><span class="ident" id="4031000">X</span><span class="op" id="4031001">,</span>&nbsp;<span class="ident" id="4031003">r</span><span class="op" id="4031004">.</span><span class="ident" id="4031005">Min</span><span class="op" id="4031008">.</span><span class="ident" id="4031009">Y</span><span class="op" id="4031010">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031013">i1</span>&nbsp;<span class="op" id="4031016">:=</span>&nbsp;<span class="ident" id="4031019">i0</span>&nbsp;<span class="op" id="4031022">+</span>&nbsp;<span class="ident" id="4031024">r</span><span class="op" id="4031025">.</span><span class="ident" id="4031026">Dx</span><span class="op" id="4031028">(</span><span class="op" id="4031029">)</span><span class="op" id="4031030">*</span><span class="num" id="4031031">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031034">for</span>&nbsp;<span class="ident" id="4031038">y</span>&nbsp;<span class="op" id="4031040">:=</span>&nbsp;<span class="ident" id="4031043">r</span><span class="op" id="4031044">.</span><span class="ident" id="4031045">Min</span><span class="op" id="4031048">.</span><span class="ident" id="4031049">Y</span><span class="op" id="4031050">;</span>&nbsp;<span class="ident" id="4031052">y</span>&nbsp;<span class="op" id="4031054">!=</span>&nbsp;<span class="ident" id="4031057">r</span><span class="op" id="4031058">.</span><span class="ident" id="4031059">Max</span><span class="op" id="4031062">.</span><span class="ident" id="4031063">Y</span><span class="op" id="4031064">;</span>&nbsp;<span class="ident" id="4031066">y</span><span class="op" id="4031067">++</span>&nbsp;<span class="op" id="4031070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031074">for</span>&nbsp;<span class="ident" id="4031078">i</span>&nbsp;<span class="op" id="4031080">:=</span>&nbsp;<span class="ident" id="4031083">i0</span><span class="op" id="4031085">;</span>&nbsp;<span class="ident" id="4031087">i</span>&nbsp;<span class="op" id="4031089">&lt;</span>&nbsp;<span class="ident" id="4031091">i1</span><span class="op" id="4031093">;</span>&nbsp;<span class="ident" id="4031095">i</span>&nbsp;<span class="op" id="4031097">+=</span>&nbsp;<span class="num" id="4031100">4</span>&nbsp;<span class="op" id="4031102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031107">dr</span>&nbsp;<span class="op" id="4031110">:=</span>&nbsp;<span class="builtintype" id="4031113">uint32</span><span class="op" id="4031119">(</span><span class="ident" id="4031120">dst</span><span class="op" id="4031123">.</span><span class="ident" id="4031124">Pix</span><span class="op" id="4031127">[</span><span class="ident" id="4031128">i</span><span class="op" id="4031129">+</span><span class="num" id="4031130">0</span><span class="op" id="4031131">]</span><span class="op" id="4031132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031137">dg</span>&nbsp;<span class="op" id="4031140">:=</span>&nbsp;<span class="builtintype" id="4031143">uint32</span><span class="op" id="4031149">(</span><span class="ident" id="4031150">dst</span><span class="op" id="4031153">.</span><span class="ident" id="4031154">Pix</span><span class="op" id="4031157">[</span><span class="ident" id="4031158">i</span><span class="op" id="4031159">+</span><span class="num" id="4031160">1</span><span class="op" id="4031161">]</span><span class="op" id="4031162">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031167">db</span>&nbsp;<span class="op" id="4031170">:=</span>&nbsp;<span class="builtintype" id="4031173">uint32</span><span class="op" id="4031179">(</span><span class="ident" id="4031180">dst</span><span class="op" id="4031183">.</span><span class="ident" id="4031184">Pix</span><span class="op" id="4031187">[</span><span class="ident" id="4031188">i</span><span class="op" id="4031189">+</span><span class="num" id="4031190">2</span><span class="op" id="4031191">]</span><span class="op" id="4031192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031197">da</span>&nbsp;<span class="op" id="4031200">:=</span>&nbsp;<span class="builtintype" id="4031203">uint32</span><span class="op" id="4031209">(</span><span class="ident" id="4031210">dst</span><span class="op" id="4031213">.</span><span class="ident" id="4031214">Pix</span><span class="op" id="4031217">[</span><span class="ident" id="4031218">i</span><span class="op" id="4031219">+</span><span class="num" id="4031220">3</span><span class="op" id="4031221">]</span><span class="op" id="4031222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031228">dst</span><span class="op" id="4031231">.</span><span class="ident" id="4031232">Pix</span><span class="op" id="4031235">[</span><span class="ident" id="4031236">i</span><span class="op" id="4031237">+</span><span class="num" id="4031238">0</span><span class="op" id="4031239">]</span>&nbsp;<span class="op" id="4031241">=</span>&nbsp;<span class="builtintype" id="4031243">uint8</span><span class="op" id="4031248">(</span><span class="op" id="4031249">(</span><span class="ident" id="4031250">dr</span><span class="op" id="4031252">*</span><span class="ident" id="4031253">a</span><span class="op" id="4031254">/</span><span class="ident" id="4031255">m</span>&nbsp;<span class="op" id="4031257">+</span>&nbsp;<span class="ident" id="4031259">sr</span><span class="op" id="4031261">)</span>&nbsp;<span class="op" id="4031263">&gt;&gt;</span>&nbsp;<span class="num" id="4031266">8</span><span class="op" id="4031267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031272">dst</span><span class="op" id="4031275">.</span><span class="ident" id="4031276">Pix</span><span class="op" id="4031279">[</span><span class="ident" id="4031280">i</span><span class="op" id="4031281">+</span><span class="num" id="4031282">1</span><span class="op" id="4031283">]</span>&nbsp;<span class="op" id="4031285">=</span>&nbsp;<span class="builtintype" id="4031287">uint8</span><span class="op" id="4031292">(</span><span class="op" id="4031293">(</span><span class="ident" id="4031294">dg</span><span class="op" id="4031296">*</span><span class="ident" id="4031297">a</span><span class="op" id="4031298">/</span><span class="ident" id="4031299">m</span>&nbsp;<span class="op" id="4031301">+</span>&nbsp;<span class="ident" id="4031303">sg</span><span class="op" id="4031305">)</span>&nbsp;<span class="op" id="4031307">&gt;&gt;</span>&nbsp;<span class="num" id="4031310">8</span><span class="op" id="4031311">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031316">dst</span><span class="op" id="4031319">.</span><span class="ident" id="4031320">Pix</span><span class="op" id="4031323">[</span><span class="ident" id="4031324">i</span><span class="op" id="4031325">+</span><span class="num" id="4031326">2</span><span class="op" id="4031327">]</span>&nbsp;<span class="op" id="4031329">=</span>&nbsp;<span class="builtintype" id="4031331">uint8</span><span class="op" id="4031336">(</span><span class="op" id="4031337">(</span><span class="ident" id="4031338">db</span><span class="op" id="4031340">*</span><span class="ident" id="4031341">a</span><span class="op" id="4031342">/</span><span class="ident" id="4031343">m</span>&nbsp;<span class="op" id="4031345">+</span>&nbsp;<span class="ident" id="4031347">sb</span><span class="op" id="4031349">)</span>&nbsp;<span class="op" id="4031351">&gt;&gt;</span>&nbsp;<span class="num" id="4031354">8</span><span class="op" id="4031355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031360">dst</span><span class="op" id="4031363">.</span><span class="ident" id="4031364">Pix</span><span class="op" id="4031367">[</span><span class="ident" id="4031368">i</span><span class="op" id="4031369">+</span><span class="num" id="4031370">3</span><span class="op" id="4031371">]</span>&nbsp;<span class="op" id="4031373">=</span>&nbsp;<span class="builtintype" id="4031375">uint8</span><span class="op" id="4031380">(</span><span class="op" id="4031381">(</span><span class="ident" id="4031382">da</span><span class="op" id="4031384">*</span><span class="ident" id="4031385">a</span><span class="op" id="4031386">/</span><span class="ident" id="4031387">m</span>&nbsp;<span class="op" id="4031389">+</span>&nbsp;<span class="ident" id="4031391">sa</span><span class="op" id="4031393">)</span>&nbsp;<span class="op" id="4031395">&gt;&gt;</span>&nbsp;<span class="num" id="4031398">8</span><span class="op" id="4031399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031407">i0</span>&nbsp;<span class="op" id="4031410">+=</span>&nbsp;<span class="ident" id="4031413">dst</span><span class="op" id="4031416">.</span><span class="ident" id="4031417">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031426">i1</span>&nbsp;<span class="op" id="4031429">+=</span>&nbsp;<span class="ident" id="4031432">dst</span><span class="op" id="4031435">.</span><span class="ident" id="4031436">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4031444">}</span><br>
<span class="lineno"></span><span class="op" id="4031446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4031449">func</span>&nbsp;<span class="ident" id="4031454">drawFillSrc</span><span class="op" id="4031465">(</span><span class="ident" id="4031466">dst</span>&nbsp;<span class="op" id="4031470">*</span><span class="ident" id="4031471">image</span><span class="op" id="4031476">.</span><span class="ident" id="4031477">RGBA</span><span class="op" id="4031481">,</span>&nbsp;<span class="ident" id="4031483">r</span>&nbsp;<span class="ident" id="4031485">image</span><span class="op" id="4031490">.</span><span class="ident" id="4031491">Rectangle</span><span class="op" id="4031500">,</span>&nbsp;<span class="ident" id="4031502">src</span>&nbsp;<span class="op" id="4031506">*</span><span class="ident" id="4031507">image</span><span class="op" id="4031512">.</span><span class="ident" id="4031513">Uniform</span><span class="op" id="4031520">)</span>&nbsp;<span class="op" id="4031522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031525">sr</span><span class="op" id="4031527">,</span>&nbsp;<span class="ident" id="4031529">sg</span><span class="op" id="4031531">,</span>&nbsp;<span class="ident" id="4031533">sb</span><span class="op" id="4031535">,</span>&nbsp;<span class="ident" id="4031537">sa</span>&nbsp;<span class="op" id="4031540">:=</span>&nbsp;<span class="ident" id="4031543">src</span><span class="op" id="4031546">.</span><span class="ident" id="4031547">RGBA</span><span class="op" id="4031551">(</span><span class="op" id="4031552">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4031555">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4031657">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4031761">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031832">i0</span>&nbsp;<span class="op" id="4031835">:=</span>&nbsp;<span class="ident" id="4031838">dst</span><span class="op" id="4031841">.</span><span class="ident" id="4031842">PixOffset</span><span class="op" id="4031851">(</span><span class="ident" id="4031852">r</span><span class="op" id="4031853">.</span><span class="ident" id="4031854">Min</span><span class="op" id="4031857">.</span><span class="ident" id="4031858">X</span><span class="op" id="4031859">,</span>&nbsp;<span class="ident" id="4031861">r</span><span class="op" id="4031862">.</span><span class="ident" id="4031863">Min</span><span class="op" id="4031866">.</span><span class="ident" id="4031867">Y</span><span class="op" id="4031868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031871">i1</span>&nbsp;<span class="op" id="4031874">:=</span>&nbsp;<span class="ident" id="4031877">i0</span>&nbsp;<span class="op" id="4031880">+</span>&nbsp;<span class="ident" id="4031882">r</span><span class="op" id="4031883">.</span><span class="ident" id="4031884">Dx</span><span class="op" id="4031886">(</span><span class="op" id="4031887">)</span><span class="op" id="4031888">*</span><span class="num" id="4031889">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4031892">for</span>&nbsp;<span class="ident" id="4031896">i</span>&nbsp;<span class="op" id="4031898">:=</span>&nbsp;<span class="ident" id="4031901">i0</span><span class="op" id="4031903">;</span>&nbsp;<span class="ident" id="4031905">i</span>&nbsp;<span class="op" id="4031907">&lt;</span>&nbsp;<span class="ident" id="4031909">i1</span><span class="op" id="4031911">;</span>&nbsp;<span class="ident" id="4031913">i</span>&nbsp;<span class="op" id="4031915">+=</span>&nbsp;<span class="num" id="4031918">4</span>&nbsp;<span class="op" id="4031920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031924">dst</span><span class="op" id="4031927">.</span><span class="ident" id="4031928">Pix</span><span class="op" id="4031931">[</span><span class="ident" id="4031932">i</span><span class="op" id="4031933">+</span><span class="num" id="4031934">0</span><span class="op" id="4031935">]</span>&nbsp;<span class="op" id="4031937">=</span>&nbsp;<span class="builtintype" id="4031939">uint8</span><span class="op" id="4031944">(</span><span class="ident" id="4031945">sr</span>&nbsp;<span class="op" id="4031948">&gt;&gt;</span>&nbsp;<span class="num" id="4031951">8</span><span class="op" id="4031952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031956">dst</span><span class="op" id="4031959">.</span><span class="ident" id="4031960">Pix</span><span class="op" id="4031963">[</span><span class="ident" id="4031964">i</span><span class="op" id="4031965">+</span><span class="num" id="4031966">1</span><span class="op" id="4031967">]</span>&nbsp;<span class="op" id="4031969">=</span>&nbsp;<span class="builtintype" id="4031971">uint8</span><span class="op" id="4031976">(</span><span class="ident" id="4031977">sg</span>&nbsp;<span class="op" id="4031980">&gt;&gt;</span>&nbsp;<span class="num" id="4031983">8</span><span class="op" id="4031984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4031988">dst</span><span class="op" id="4031991">.</span><span class="ident" id="4031992">Pix</span><span class="op" id="4031995">[</span><span class="ident" id="4031996">i</span><span class="op" id="4031997">+</span><span class="num" id="4031998">2</span><span class="op" id="4031999">]</span>&nbsp;<span class="op" id="4032001">=</span>&nbsp;<span class="builtintype" id="4032003">uint8</span><span class="op" id="4032008">(</span><span class="ident" id="4032009">sb</span>&nbsp;<span class="op" id="4032012">&gt;&gt;</span>&nbsp;<span class="num" id="4032015">8</span><span class="op" id="4032016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032020">dst</span><span class="op" id="4032023">.</span><span class="ident" id="4032024">Pix</span><span class="op" id="4032027">[</span><span class="ident" id="4032028">i</span><span class="op" id="4032029">+</span><span class="num" id="4032030">3</span><span class="op" id="4032031">]</span>&nbsp;<span class="op" id="4032033">=</span>&nbsp;<span class="builtintype" id="4032035">uint8</span><span class="op" id="4032040">(</span><span class="ident" id="4032041">sa</span>&nbsp;<span class="op" id="4032044">&gt;&gt;</span>&nbsp;<span class="num" id="4032047">8</span><span class="op" id="4032048">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032054">firstRow</span>&nbsp;<span class="op" id="4032063">:=</span>&nbsp;<span class="ident" id="4032066">dst</span><span class="op" id="4032069">.</span><span class="ident" id="4032070">Pix</span><span class="op" id="4032073">[</span><span class="ident" id="4032074">i0</span><span class="op" id="4032076">:</span><span class="ident" id="4032077">i1</span><span class="op" id="4032079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032082">for</span>&nbsp;<span class="ident" id="4032086">y</span>&nbsp;<span class="op" id="4032088">:=</span>&nbsp;<span class="ident" id="4032091">r</span><span class="op" id="4032092">.</span><span class="ident" id="4032093">Min</span><span class="op" id="4032096">.</span><span class="ident" id="4032097">Y</span>&nbsp;<span class="op" id="4032099">+</span>&nbsp;<span class="num" id="4032101">1</span><span class="op" id="4032102">;</span>&nbsp;<span class="ident" id="4032104">y</span>&nbsp;<span class="op" id="4032106">&lt;</span>&nbsp;<span class="ident" id="4032108">r</span><span class="op" id="4032109">.</span><span class="ident" id="4032110">Max</span><span class="op" id="4032113">.</span><span class="ident" id="4032114">Y</span><span class="op" id="4032115">;</span>&nbsp;<span class="ident" id="4032117">y</span><span class="op" id="4032118">++</span>&nbsp;<span class="op" id="4032121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032125">i0</span>&nbsp;<span class="op" id="4032128">+=</span>&nbsp;<span class="ident" id="4032131">dst</span><span class="op" id="4032134">.</span><span class="ident" id="4032135">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032144">i1</span>&nbsp;<span class="op" id="4032147">+=</span>&nbsp;<span class="ident" id="4032150">dst</span><span class="op" id="4032153">.</span><span class="ident" id="4032154">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4032163">copy</span><span class="op" id="4032167">(</span><span class="ident" id="4032168">dst</span><span class="op" id="4032171">.</span><span class="ident" id="4032172">Pix</span><span class="op" id="4032175">[</span><span class="ident" id="4032176">i0</span><span class="op" id="4032178">:</span><span class="ident" id="4032179">i1</span><span class="op" id="4032181">]</span><span class="op" id="4032182">,</span>&nbsp;<span class="ident" id="4032184">firstRow</span><span class="op" id="4032192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032195">}</span><br>
<span class="lineno"></span><span class="op" id="4032197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4032200">func</span>&nbsp;<span class="ident" id="4032205">drawCopyOver</span><span class="op" id="4032217">(</span><span class="ident" id="4032218">dst</span>&nbsp;<span class="op" id="4032222">*</span><span class="ident" id="4032223">image</span><span class="op" id="4032228">.</span><span class="ident" id="4032229">RGBA</span><span class="op" id="4032233">,</span>&nbsp;<span class="ident" id="4032235">r</span>&nbsp;<span class="ident" id="4032237">image</span><span class="op" id="4032242">.</span><span class="ident" id="4032243">Rectangle</span><span class="op" id="4032252">,</span>&nbsp;<span class="ident" id="4032254">src</span>&nbsp;<span class="op" id="4032258">*</span><span class="ident" id="4032259">image</span><span class="op" id="4032264">.</span><span class="ident" id="4032265">RGBA</span><span class="op" id="4032269">,</span>&nbsp;<span class="ident" id="4032271">sp</span>&nbsp;<span class="ident" id="4032274">image</span><span class="op" id="4032279">.</span><span class="ident" id="4032280">Point</span><span class="op" id="4032285">)</span>&nbsp;<span class="op" id="4032287">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032290">dx</span><span class="op" id="4032292">,</span>&nbsp;<span class="ident" id="4032294">dy</span>&nbsp;<span class="op" id="4032297">:=</span>&nbsp;<span class="ident" id="4032300">r</span><span class="op" id="4032301">.</span><span class="ident" id="4032302">Dx</span><span class="op" id="4032304">(</span><span class="op" id="4032305">)</span><span class="op" id="4032306">,</span>&nbsp;<span class="ident" id="4032308">r</span><span class="op" id="4032309">.</span><span class="ident" id="4032310">Dy</span><span class="op" id="4032312">(</span><span class="op" id="4032313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032316">d0</span>&nbsp;<span class="op" id="4032319">:=</span>&nbsp;<span class="ident" id="4032322">dst</span><span class="op" id="4032325">.</span><span class="ident" id="4032326">PixOffset</span><span class="op" id="4032335">(</span><span class="ident" id="4032336">r</span><span class="op" id="4032337">.</span><span class="ident" id="4032338">Min</span><span class="op" id="4032341">.</span><span class="ident" id="4032342">X</span><span class="op" id="4032343">,</span>&nbsp;<span class="ident" id="4032345">r</span><span class="op" id="4032346">.</span><span class="ident" id="4032347">Min</span><span class="op" id="4032350">.</span><span class="ident" id="4032351">Y</span><span class="op" id="4032352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032355">s0</span>&nbsp;<span class="op" id="4032358">:=</span>&nbsp;<span class="ident" id="4032361">src</span><span class="op" id="4032364">.</span><span class="ident" id="4032365">PixOffset</span><span class="op" id="4032374">(</span><span class="ident" id="4032375">sp</span><span class="op" id="4032377">.</span><span class="ident" id="4032378">X</span><span class="op" id="4032379">,</span>&nbsp;<span class="ident" id="4032381">sp</span><span class="op" id="4032383">.</span><span class="ident" id="4032384">Y</span><span class="op" id="4032385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032388">var</span>&nbsp;<span class="op" id="4032392">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032396">ddelta</span><span class="op" id="4032402">,</span>&nbsp;<span class="ident" id="4032404">sdelta</span>&nbsp;<span class="builtintype" id="4032411">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032417">i0</span><span class="op" id="4032419">,</span>&nbsp;<span class="ident" id="4032421">i1</span><span class="op" id="4032423">,</span>&nbsp;<span class="ident" id="4032425">idelta</span>&nbsp;<span class="builtintype" id="4032432">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032440">if</span>&nbsp;<span class="ident" id="4032443">r</span><span class="op" id="4032444">.</span><span class="ident" id="4032445">Min</span><span class="op" id="4032448">.</span><span class="ident" id="4032449">Y</span>&nbsp;<span class="op" id="4032451">&lt;</span>&nbsp;<span class="ident" id="4032453">sp</span><span class="op" id="4032455">.</span><span class="ident" id="4032456">Y</span>&nbsp;<span class="op" id="4032458">||</span>&nbsp;<span class="ident" id="4032461">r</span><span class="op" id="4032462">.</span><span class="ident" id="4032463">Min</span><span class="op" id="4032466">.</span><span class="ident" id="4032467">Y</span>&nbsp;<span class="op" id="4032469">==</span>&nbsp;<span class="ident" id="4032472">sp</span><span class="op" id="4032474">.</span><span class="ident" id="4032475">Y</span>&nbsp;<span class="op" id="4032477">&amp;&amp;</span>&nbsp;<span class="ident" id="4032480">r</span><span class="op" id="4032481">.</span><span class="ident" id="4032482">Min</span><span class="op" id="4032485">.</span><span class="ident" id="4032486">X</span>&nbsp;<span class="op" id="4032488">&lt;=</span>&nbsp;<span class="ident" id="4032491">sp</span><span class="op" id="4032493">.</span><span class="ident" id="4032494">X</span>&nbsp;<span class="op" id="4032496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032500">ddelta</span>&nbsp;<span class="op" id="4032507">=</span>&nbsp;<span class="ident" id="4032509">dst</span><span class="op" id="4032512">.</span><span class="ident" id="4032513">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032522">sdelta</span>&nbsp;<span class="op" id="4032529">=</span>&nbsp;<span class="ident" id="4032531">src</span><span class="op" id="4032534">.</span><span class="ident" id="4032535">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032544">i0</span><span class="op" id="4032546">,</span>&nbsp;<span class="ident" id="4032548">i1</span><span class="op" id="4032550">,</span>&nbsp;<span class="ident" id="4032552">idelta</span>&nbsp;<span class="op" id="4032559">=</span>&nbsp;<span class="num" id="4032561">0</span><span class="op" id="4032562">,</span>&nbsp;<span class="ident" id="4032564">dx</span><span class="op" id="4032566">*</span><span class="num" id="4032567">4</span><span class="op" id="4032568">,</span>&nbsp;<span class="op" id="4032570">+</span><span class="num" id="4032571">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032574">}</span>&nbsp;<span class="keyword" id="4032576">else</span>&nbsp;<span class="op" id="4032581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032585">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4032693">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032793">d0</span>&nbsp;<span class="op" id="4032796">+=</span>&nbsp;<span class="op" id="4032799">(</span><span class="ident" id="4032800">dy</span>&nbsp;<span class="op" id="4032803">-</span>&nbsp;<span class="num" id="4032805">1</span><span class="op" id="4032806">)</span>&nbsp;<span class="op" id="4032808">*</span>&nbsp;<span class="ident" id="4032810">dst</span><span class="op" id="4032813">.</span><span class="ident" id="4032814">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032823">s0</span>&nbsp;<span class="op" id="4032826">+=</span>&nbsp;<span class="op" id="4032829">(</span><span class="ident" id="4032830">dy</span>&nbsp;<span class="op" id="4032833">-</span>&nbsp;<span class="num" id="4032835">1</span><span class="op" id="4032836">)</span>&nbsp;<span class="op" id="4032838">*</span>&nbsp;<span class="ident" id="4032840">src</span><span class="op" id="4032843">.</span><span class="ident" id="4032844">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032853">ddelta</span>&nbsp;<span class="op" id="4032860">=</span>&nbsp;<span class="op" id="4032862">-</span><span class="ident" id="4032863">dst</span><span class="op" id="4032866">.</span><span class="ident" id="4032867">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032876">sdelta</span>&nbsp;<span class="op" id="4032883">=</span>&nbsp;<span class="op" id="4032885">-</span><span class="ident" id="4032886">src</span><span class="op" id="4032889">.</span><span class="ident" id="4032890">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032899">i0</span><span class="op" id="4032901">,</span>&nbsp;<span class="ident" id="4032903">i1</span><span class="op" id="4032905">,</span>&nbsp;<span class="ident" id="4032907">idelta</span>&nbsp;<span class="op" id="4032914">=</span>&nbsp;<span class="op" id="4032916">(</span><span class="ident" id="4032917">dx</span><span class="op" id="4032919">-</span><span class="num" id="4032920">1</span><span class="op" id="4032921">)</span><span class="op" id="4032922">*</span><span class="num" id="4032923">4</span><span class="op" id="4032924">,</span>&nbsp;<span class="op" id="4032926">-</span><span class="num" id="4032927">4</span><span class="op" id="4032928">,</span>&nbsp;<span class="op" id="4032930">-</span><span class="num" id="4032931">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4032934">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4032937">for</span>&nbsp;<span class="op" id="4032941">;</span>&nbsp;<span class="ident" id="4032943">dy</span>&nbsp;<span class="op" id="4032946">&gt;</span>&nbsp;<span class="num" id="4032948">0</span><span class="op" id="4032949">;</span>&nbsp;<span class="ident" id="4032951">dy</span><span class="op" id="4032953">--</span>&nbsp;<span class="op" id="4032956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032960">dpix</span>&nbsp;<span class="op" id="4032965">:=</span>&nbsp;<span class="ident" id="4032968">dst</span><span class="op" id="4032971">.</span><span class="ident" id="4032972">Pix</span><span class="op" id="4032975">[</span><span class="ident" id="4032976">d0</span><span class="op" id="4032978">:</span><span class="op" id="4032979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4032983">spix</span>&nbsp;<span class="op" id="4032988">:=</span>&nbsp;<span class="ident" id="4032991">src</span><span class="op" id="4032994">.</span><span class="ident" id="4032995">Pix</span><span class="op" id="4032998">[</span><span class="ident" id="4032999">s0</span><span class="op" id="4033001">:</span><span class="op" id="4033002">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4033006">for</span>&nbsp;<span class="ident" id="4033010">i</span>&nbsp;<span class="op" id="4033012">:=</span>&nbsp;<span class="ident" id="4033015">i0</span><span class="op" id="4033017">;</span>&nbsp;<span class="ident" id="4033019">i</span>&nbsp;<span class="op" id="4033021">!=</span>&nbsp;<span class="ident" id="4033024">i1</span><span class="op" id="4033026">;</span>&nbsp;<span class="ident" id="4033028">i</span>&nbsp;<span class="op" id="4033030">+=</span>&nbsp;<span class="ident" id="4033033">idelta</span>&nbsp;<span class="op" id="4033040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033045">sr</span>&nbsp;<span class="op" id="4033048">:=</span>&nbsp;<span class="builtintype" id="4033051">uint32</span><span class="op" id="4033057">(</span><span class="ident" id="4033058">spix</span><span class="op" id="4033062">[</span><span class="ident" id="4033063">i</span><span class="op" id="4033064">+</span><span class="num" id="4033065">0</span><span class="op" id="4033066">]</span><span class="op" id="4033067">)</span>&nbsp;<span class="op" id="4033069">*</span>&nbsp;<span class="num" id="4033071">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033080">sg</span>&nbsp;<span class="op" id="4033083">:=</span>&nbsp;<span class="builtintype" id="4033086">uint32</span><span class="op" id="4033092">(</span><span class="ident" id="4033093">spix</span><span class="op" id="4033097">[</span><span class="ident" id="4033098">i</span><span class="op" id="4033099">+</span><span class="num" id="4033100">1</span><span class="op" id="4033101">]</span><span class="op" id="4033102">)</span>&nbsp;<span class="op" id="4033104">*</span>&nbsp;<span class="num" id="4033106">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033115">sb</span>&nbsp;<span class="op" id="4033118">:=</span>&nbsp;<span class="builtintype" id="4033121">uint32</span><span class="op" id="4033127">(</span><span class="ident" id="4033128">spix</span><span class="op" id="4033132">[</span><span class="ident" id="4033133">i</span><span class="op" id="4033134">+</span><span class="num" id="4033135">2</span><span class="op" id="4033136">]</span><span class="op" id="4033137">)</span>&nbsp;<span class="op" id="4033139">*</span>&nbsp;<span class="num" id="4033141">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033150">sa</span>&nbsp;<span class="op" id="4033153">:=</span>&nbsp;<span class="builtintype" id="4033156">uint32</span><span class="op" id="4033162">(</span><span class="ident" id="4033163">spix</span><span class="op" id="4033167">[</span><span class="ident" id="4033168">i</span><span class="op" id="4033169">+</span><span class="num" id="4033170">3</span><span class="op" id="4033171">]</span><span class="op" id="4033172">)</span>&nbsp;<span class="op" id="4033174">*</span>&nbsp;<span class="num" id="4033176">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033186">dr</span>&nbsp;<span class="op" id="4033189">:=</span>&nbsp;<span class="builtintype" id="4033192">uint32</span><span class="op" id="4033198">(</span><span class="ident" id="4033199">dpix</span><span class="op" id="4033203">[</span><span class="ident" id="4033204">i</span><span class="op" id="4033205">+</span><span class="num" id="4033206">0</span><span class="op" id="4033207">]</span><span class="op" id="4033208">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033213">dg</span>&nbsp;<span class="op" id="4033216">:=</span>&nbsp;<span class="builtintype" id="4033219">uint32</span><span class="op" id="4033225">(</span><span class="ident" id="4033226">dpix</span><span class="op" id="4033230">[</span><span class="ident" id="4033231">i</span><span class="op" id="4033232">+</span><span class="num" id="4033233">1</span><span class="op" id="4033234">]</span><span class="op" id="4033235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033240">db</span>&nbsp;<span class="op" id="4033243">:=</span>&nbsp;<span class="builtintype" id="4033246">uint32</span><span class="op" id="4033252">(</span><span class="ident" id="4033253">dpix</span><span class="op" id="4033257">[</span><span class="ident" id="4033258">i</span><span class="op" id="4033259">+</span><span class="num" id="4033260">2</span><span class="op" id="4033261">]</span><span class="op" id="4033262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033267">da</span>&nbsp;<span class="op" id="4033270">:=</span>&nbsp;<span class="builtintype" id="4033273">uint32</span><span class="op" id="4033279">(</span><span class="ident" id="4033280">dpix</span><span class="op" id="4033284">[</span><span class="ident" id="4033285">i</span><span class="op" id="4033286">+</span><span class="num" id="4033287">3</span><span class="op" id="4033288">]</span><span class="op" id="4033289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033295">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033355">a</span>&nbsp;<span class="op" id="4033357">:=</span>&nbsp;<span class="op" id="4033360">(</span><span class="ident" id="4033361">m</span>&nbsp;<span class="op" id="4033363">-</span>&nbsp;<span class="ident" id="4033365">sa</span><span class="op" id="4033367">)</span>&nbsp;<span class="op" id="4033369">*</span>&nbsp;<span class="num" id="4033371">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033381">dpix</span><span class="op" id="4033385">[</span><span class="ident" id="4033386">i</span><span class="op" id="4033387">+</span><span class="num" id="4033388">0</span><span class="op" id="4033389">]</span>&nbsp;<span class="op" id="4033391">=</span>&nbsp;<span class="builtintype" id="4033393">uint8</span><span class="op" id="4033398">(</span><span class="op" id="4033399">(</span><span class="ident" id="4033400">dr</span><span class="op" id="4033402">*</span><span class="ident" id="4033403">a</span><span class="op" id="4033404">/</span><span class="ident" id="4033405">m</span>&nbsp;<span class="op" id="4033407">+</span>&nbsp;<span class="ident" id="4033409">sr</span><span class="op" id="4033411">)</span>&nbsp;<span class="op" id="4033413">&gt;&gt;</span>&nbsp;<span class="num" id="4033416">8</span><span class="op" id="4033417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033422">dpix</span><span class="op" id="4033426">[</span><span class="ident" id="4033427">i</span><span class="op" id="4033428">+</span><span class="num" id="4033429">1</span><span class="op" id="4033430">]</span>&nbsp;<span class="op" id="4033432">=</span>&nbsp;<span class="builtintype" id="4033434">uint8</span><span class="op" id="4033439">(</span><span class="op" id="4033440">(</span><span class="ident" id="4033441">dg</span><span class="op" id="4033443">*</span><span class="ident" id="4033444">a</span><span class="op" id="4033445">/</span><span class="ident" id="4033446">m</span>&nbsp;<span class="op" id="4033448">+</span>&nbsp;<span class="ident" id="4033450">sg</span><span class="op" id="4033452">)</span>&nbsp;<span class="op" id="4033454">&gt;&gt;</span>&nbsp;<span class="num" id="4033457">8</span><span class="op" id="4033458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033463">dpix</span><span class="op" id="4033467">[</span><span class="ident" id="4033468">i</span><span class="op" id="4033469">+</span><span class="num" id="4033470">2</span><span class="op" id="4033471">]</span>&nbsp;<span class="op" id="4033473">=</span>&nbsp;<span class="builtintype" id="4033475">uint8</span><span class="op" id="4033480">(</span><span class="op" id="4033481">(</span><span class="ident" id="4033482">db</span><span class="op" id="4033484">*</span><span class="ident" id="4033485">a</span><span class="op" id="4033486">/</span><span class="ident" id="4033487">m</span>&nbsp;<span class="op" id="4033489">+</span>&nbsp;<span class="ident" id="4033491">sb</span><span class="op" id="4033493">)</span>&nbsp;<span class="op" id="4033495">&gt;&gt;</span>&nbsp;<span class="num" id="4033498">8</span><span class="op" id="4033499">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033504">dpix</span><span class="op" id="4033508">[</span><span class="ident" id="4033509">i</span><span class="op" id="4033510">+</span><span class="num" id="4033511">3</span><span class="op" id="4033512">]</span>&nbsp;<span class="op" id="4033514">=</span>&nbsp;<span class="builtintype" id="4033516">uint8</span><span class="op" id="4033521">(</span><span class="op" id="4033522">(</span><span class="ident" id="4033523">da</span><span class="op" id="4033525">*</span><span class="ident" id="4033526">a</span><span class="op" id="4033527">/</span><span class="ident" id="4033528">m</span>&nbsp;<span class="op" id="4033530">+</span>&nbsp;<span class="ident" id="4033532">sa</span><span class="op" id="4033534">)</span>&nbsp;<span class="op" id="4033536">&gt;&gt;</span>&nbsp;<span class="num" id="4033539">8</span><span class="op" id="4033540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4033544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033548">d0</span>&nbsp;<span class="op" id="4033551">+=</span>&nbsp;<span class="ident" id="4033554">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033563">s0</span>&nbsp;<span class="op" id="4033566">+=</span>&nbsp;<span class="ident" id="4033569">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4033577">}</span><br>
<span class="lineno">305</span><span class="op" id="4033579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4033582">func</span>&nbsp;<span class="ident" id="4033587">drawCopySrc</span><span class="op" id="4033598">(</span><span class="ident" id="4033599">dst</span>&nbsp;<span class="op" id="4033603">*</span><span class="ident" id="4033604">image</span><span class="op" id="4033609">.</span><span class="ident" id="4033610">RGBA</span><span class="op" id="4033614">,</span>&nbsp;<span class="ident" id="4033616">r</span>&nbsp;<span class="ident" id="4033618">image</span><span class="op" id="4033623">.</span><span class="ident" id="4033624">Rectangle</span><span class="op" id="4033633">,</span>&nbsp;<span class="ident" id="4033635">src</span>&nbsp;<span class="op" id="4033639">*</span><span class="ident" id="4033640">image</span><span class="op" id="4033645">.</span><span class="ident" id="4033646">RGBA</span><span class="op" id="4033650">,</span>&nbsp;<span class="ident" id="4033652">sp</span>&nbsp;<span class="ident" id="4033655">image</span><span class="op" id="4033660">.</span><span class="ident" id="4033661">Point</span><span class="op" id="4033666">)</span>&nbsp;<span class="op" id="4033668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033671">n</span><span class="op" id="4033672">,</span>&nbsp;<span class="ident" id="4033674">dy</span>&nbsp;<span class="op" id="4033677">:=</span>&nbsp;<span class="num" id="4033680">4</span><span class="op" id="4033681">*</span><span class="ident" id="4033682">r</span><span class="op" id="4033683">.</span><span class="ident" id="4033684">Dx</span><span class="op" id="4033686">(</span><span class="op" id="4033687">)</span><span class="op" id="4033688">,</span>&nbsp;<span class="ident" id="4033690">r</span><span class="op" id="4033691">.</span><span class="ident" id="4033692">Dy</span><span class="op" id="4033694">(</span><span class="op" id="4033695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033698">d0</span>&nbsp;<span class="op" id="4033701">:=</span>&nbsp;<span class="ident" id="4033704">dst</span><span class="op" id="4033707">.</span><span class="ident" id="4033708">PixOffset</span><span class="op" id="4033717">(</span><span class="ident" id="4033718">r</span><span class="op" id="4033719">.</span><span class="ident" id="4033720">Min</span><span class="op" id="4033723">.</span><span class="ident" id="4033724">X</span><span class="op" id="4033725">,</span>&nbsp;<span class="ident" id="4033727">r</span><span class="op" id="4033728">.</span><span class="ident" id="4033729">Min</span><span class="op" id="4033732">.</span><span class="ident" id="4033733">Y</span><span class="op" id="4033734">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033737">s0</span>&nbsp;<span class="op" id="4033740">:=</span>&nbsp;<span class="ident" id="4033743">src</span><span class="op" id="4033746">.</span><span class="ident" id="4033747">PixOffset</span><span class="op" id="4033756">(</span><span class="ident" id="4033757">sp</span><span class="op" id="4033759">.</span><span class="ident" id="4033760">X</span><span class="op" id="4033761">,</span>&nbsp;<span class="ident" id="4033763">sp</span><span class="op" id="4033765">.</span><span class="ident" id="4033766">Y</span><span class="op" id="4033767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4033770">var</span>&nbsp;<span class="ident" id="4033774">ddelta</span><span class="op" id="4033780">,</span>&nbsp;<span class="ident" id="4033782">sdelta</span>&nbsp;<span class="builtintype" id="4033789">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4033794">if</span>&nbsp;<span class="ident" id="4033797">r</span><span class="op" id="4033798">.</span><span class="ident" id="4033799">Min</span><span class="op" id="4033802">.</span><span class="ident" id="4033803">Y</span>&nbsp;<span class="op" id="4033805">&lt;=</span>&nbsp;<span class="ident" id="4033808">sp</span><span class="op" id="4033810">.</span><span class="ident" id="4033811">Y</span>&nbsp;<span class="op" id="4033813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033817">ddelta</span>&nbsp;<span class="op" id="4033824">=</span>&nbsp;<span class="ident" id="4033826">dst</span><span class="op" id="4033829">.</span><span class="ident" id="4033830">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4033839">sdelta</span>&nbsp;<span class="op" id="4033846">=</span>&nbsp;<span class="ident" id="4033848">src</span><span class="op" id="4033851">.</span><span class="ident" id="4033852">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4033860">}</span>&nbsp;<span class="keyword" id="4033862">else</span>&nbsp;<span class="op" id="4033867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033871">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4033971">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4034067">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034163">d0</span>&nbsp;<span class="op" id="4034166">+=</span>&nbsp;<span class="op" id="4034169">(</span><span class="ident" id="4034170">dy</span>&nbsp;<span class="op" id="4034173">-</span>&nbsp;<span class="num" id="4034175">1</span><span class="op" id="4034176">)</span>&nbsp;<span class="op" id="4034178">*</span>&nbsp;<span class="ident" id="4034180">dst</span><span class="op" id="4034183">.</span><span class="ident" id="4034184">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034193">s0</span>&nbsp;<span class="op" id="4034196">+=</span>&nbsp;<span class="op" id="4034199">(</span><span class="ident" id="4034200">dy</span>&nbsp;<span class="op" id="4034203">-</span>&nbsp;<span class="num" id="4034205">1</span><span class="op" id="4034206">)</span>&nbsp;<span class="op" id="4034208">*</span>&nbsp;<span class="ident" id="4034210">src</span><span class="op" id="4034213">.</span><span class="ident" id="4034214">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034223">ddelta</span>&nbsp;<span class="op" id="4034230">=</span>&nbsp;<span class="op" id="4034232">-</span><span class="ident" id="4034233">dst</span><span class="op" id="4034236">.</span><span class="ident" id="4034237">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034246">sdelta</span>&nbsp;<span class="op" id="4034253">=</span>&nbsp;<span class="op" id="4034255">-</span><span class="ident" id="4034256">src</span><span class="op" id="4034259">.</span><span class="ident" id="4034260">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034271">for</span>&nbsp;<span class="op" id="4034275">;</span>&nbsp;<span class="ident" id="4034277">dy</span>&nbsp;<span class="op" id="4034280">&gt;</span>&nbsp;<span class="num" id="4034282">0</span><span class="op" id="4034283">;</span>&nbsp;<span class="ident" id="4034285">dy</span><span class="op" id="4034287">--</span>&nbsp;<span class="op" id="4034290">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4034294">copy</span><span class="op" id="4034298">(</span><span class="ident" id="4034299">dst</span><span class="op" id="4034302">.</span><span class="ident" id="4034303">Pix</span><span class="op" id="4034306">[</span><span class="ident" id="4034307">d0</span><span class="op" id="4034309">:</span><span class="ident" id="4034310">d0</span><span class="op" id="4034312">+</span><span class="ident" id="4034313">n</span><span class="op" id="4034314">]</span><span class="op" id="4034315">,</span>&nbsp;<span class="ident" id="4034317">src</span><span class="op" id="4034320">.</span><span class="ident" id="4034321">Pix</span><span class="op" id="4034324">[</span><span class="ident" id="4034325">s0</span><span class="op" id="4034327">:</span><span class="ident" id="4034328">s0</span><span class="op" id="4034330">+</span><span class="ident" id="4034331">n</span><span class="op" id="4034332">]</span><span class="op" id="4034333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034337">d0</span>&nbsp;<span class="op" id="4034340">+=</span>&nbsp;<span class="ident" id="4034343">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034352">s0</span>&nbsp;<span class="op" id="4034355">+=</span>&nbsp;<span class="ident" id="4034358">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4034366">}</span><br>
<span class="lineno"></span><span class="op" id="4034368">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="4034371">func</span>&nbsp;<span class="ident" id="4034376">drawNRGBAOver</span><span class="op" id="4034389">(</span><span class="ident" id="4034390">dst</span>&nbsp;<span class="op" id="4034394">*</span><span class="ident" id="4034395">image</span><span class="op" id="4034400">.</span><span class="ident" id="4034401">RGBA</span><span class="op" id="4034405">,</span>&nbsp;<span class="ident" id="4034407">r</span>&nbsp;<span class="ident" id="4034409">image</span><span class="op" id="4034414">.</span><span class="ident" id="4034415">Rectangle</span><span class="op" id="4034424">,</span>&nbsp;<span class="ident" id="4034426">src</span>&nbsp;<span class="op" id="4034430">*</span><span class="ident" id="4034431">image</span><span class="op" id="4034436">.</span><span class="ident" id="4034437">NRGBA</span><span class="op" id="4034442">,</span>&nbsp;<span class="ident" id="4034444">sp</span>&nbsp;<span class="ident" id="4034447">image</span><span class="op" id="4034452">.</span><span class="ident" id="4034453">Point</span><span class="op" id="4034458">)</span>&nbsp;<span class="op" id="4034460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034463">i0</span>&nbsp;<span class="op" id="4034466">:=</span>&nbsp;<span class="op" id="4034469">(</span><span class="ident" id="4034470">r</span><span class="op" id="4034471">.</span><span class="ident" id="4034472">Min</span><span class="op" id="4034475">.</span><span class="ident" id="4034476">X</span>&nbsp;<span class="op" id="4034478">-</span>&nbsp;<span class="ident" id="4034480">dst</span><span class="op" id="4034483">.</span><span class="ident" id="4034484">Rect</span><span class="op" id="4034488">.</span><span class="ident" id="4034489">Min</span><span class="op" id="4034492">.</span><span class="ident" id="4034493">X</span><span class="op" id="4034494">)</span>&nbsp;<span class="op" id="4034496">*</span>&nbsp;<span class="num" id="4034498">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034501">i1</span>&nbsp;<span class="op" id="4034504">:=</span>&nbsp;<span class="op" id="4034507">(</span><span class="ident" id="4034508">r</span><span class="op" id="4034509">.</span><span class="ident" id="4034510">Max</span><span class="op" id="4034513">.</span><span class="ident" id="4034514">X</span>&nbsp;<span class="op" id="4034516">-</span>&nbsp;<span class="ident" id="4034518">dst</span><span class="op" id="4034521">.</span><span class="ident" id="4034522">Rect</span><span class="op" id="4034526">.</span><span class="ident" id="4034527">Min</span><span class="op" id="4034530">.</span><span class="ident" id="4034531">X</span><span class="op" id="4034532">)</span>&nbsp;<span class="op" id="4034534">*</span>&nbsp;<span class="num" id="4034536">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034539">si0</span>&nbsp;<span class="op" id="4034543">:=</span>&nbsp;<span class="op" id="4034546">(</span><span class="ident" id="4034547">sp</span><span class="op" id="4034549">.</span><span class="ident" id="4034550">X</span>&nbsp;<span class="op" id="4034552">-</span>&nbsp;<span class="ident" id="4034554">src</span><span class="op" id="4034557">.</span><span class="ident" id="4034558">Rect</span><span class="op" id="4034562">.</span><span class="ident" id="4034563">Min</span><span class="op" id="4034566">.</span><span class="ident" id="4034567">X</span><span class="op" id="4034568">)</span>&nbsp;<span class="op" id="4034570">*</span>&nbsp;<span class="num" id="4034572">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034575">yMax</span>&nbsp;<span class="op" id="4034580">:=</span>&nbsp;<span class="ident" id="4034583">r</span><span class="op" id="4034584">.</span><span class="ident" id="4034585">Max</span><span class="op" id="4034588">.</span><span class="ident" id="4034589">Y</span>&nbsp;<span class="op" id="4034591">-</span>&nbsp;<span class="ident" id="4034593">dst</span><span class="op" id="4034596">.</span><span class="ident" id="4034597">Rect</span><span class="op" id="4034601">.</span><span class="ident" id="4034602">Min</span><span class="op" id="4034605">.</span><span class="ident" id="4034606">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034610">y</span>&nbsp;<span class="op" id="4034612">:=</span>&nbsp;<span class="ident" id="4034615">r</span><span class="op" id="4034616">.</span><span class="ident" id="4034617">Min</span><span class="op" id="4034620">.</span><span class="ident" id="4034621">Y</span>&nbsp;<span class="op" id="4034623">-</span>&nbsp;<span class="ident" id="4034625">dst</span><span class="op" id="4034628">.</span><span class="ident" id="4034629">Rect</span><span class="op" id="4034633">.</span><span class="ident" id="4034634">Min</span><span class="op" id="4034637">.</span><span class="ident" id="4034638">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034641">sy</span>&nbsp;<span class="op" id="4034644">:=</span>&nbsp;<span class="ident" id="4034647">sp</span><span class="op" id="4034649">.</span><span class="ident" id="4034650">Y</span>&nbsp;<span class="op" id="4034652">-</span>&nbsp;<span class="ident" id="4034654">src</span><span class="op" id="4034657">.</span><span class="ident" id="4034658">Rect</span><span class="op" id="4034662">.</span><span class="ident" id="4034663">Min</span><span class="op" id="4034666">.</span><span class="ident" id="4034667">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034670">for</span>&nbsp;<span class="op" id="4034674">;</span>&nbsp;<span class="ident" id="4034676">y</span>&nbsp;<span class="op" id="4034678">!=</span>&nbsp;<span class="ident" id="4034681">yMax</span><span class="op" id="4034685">;</span>&nbsp;<span class="ident" id="4034687">y</span><span class="op" id="4034688">,</span>&nbsp;<span class="ident" id="4034690">sy</span>&nbsp;<span class="op" id="4034693">=</span>&nbsp;<span class="ident" id="4034695">y</span><span class="op" id="4034696">+</span><span class="num" id="4034697">1</span><span class="op" id="4034698">,</span>&nbsp;<span class="ident" id="4034700">sy</span><span class="op" id="4034702">+</span><span class="num" id="4034703">1</span>&nbsp;<span class="op" id="4034705">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034709">dpix</span>&nbsp;<span class="op" id="4034714">:=</span>&nbsp;<span class="ident" id="4034717">dst</span><span class="op" id="4034720">.</span><span class="ident" id="4034721">Pix</span><span class="op" id="4034724">[</span><span class="ident" id="4034725">y</span><span class="op" id="4034726">*</span><span class="ident" id="4034727">dst</span><span class="op" id="4034730">.</span><span class="ident" id="4034731">Stride</span><span class="op" id="4034737">:</span><span class="op" id="4034738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034742">spix</span>&nbsp;<span class="op" id="4034747">:=</span>&nbsp;<span class="ident" id="4034750">src</span><span class="op" id="4034753">.</span><span class="ident" id="4034754">Pix</span><span class="op" id="4034757">[</span><span class="ident" id="4034758">sy</span><span class="op" id="4034760">*</span><span class="ident" id="4034761">src</span><span class="op" id="4034764">.</span><span class="ident" id="4034765">Stride</span><span class="op" id="4034771">:</span><span class="op" id="4034772">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4034777">for</span>&nbsp;<span class="ident" id="4034781">i</span><span class="op" id="4034782">,</span>&nbsp;<span class="ident" id="4034784">si</span>&nbsp;<span class="op" id="4034787">:=</span>&nbsp;<span class="ident" id="4034790">i0</span><span class="op" id="4034792">,</span>&nbsp;<span class="ident" id="4034794">si0</span><span class="op" id="4034797">;</span>&nbsp;<span class="ident" id="4034799">i</span>&nbsp;<span class="op" id="4034801">&lt;</span>&nbsp;<span class="ident" id="4034803">i1</span><span class="op" id="4034805">;</span>&nbsp;<span class="ident" id="4034807">i</span><span class="op" id="4034808">,</span>&nbsp;<span class="ident" id="4034810">si</span>&nbsp;<span class="op" id="4034813">=</span>&nbsp;<span class="ident" id="4034815">i</span><span class="op" id="4034816">+</span><span class="num" id="4034817">4</span><span class="op" id="4034818">,</span>&nbsp;<span class="ident" id="4034820">si</span><span class="op" id="4034822">+</span><span class="num" id="4034823">4</span>&nbsp;<span class="op" id="4034825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4034830">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034898">sa</span>&nbsp;<span class="op" id="4034901">:=</span>&nbsp;<span class="builtintype" id="4034904">uint32</span><span class="op" id="4034910">(</span><span class="ident" id="4034911">spix</span><span class="op" id="4034915">[</span><span class="ident" id="4034916">si</span><span class="op" id="4034918">+</span><span class="num" id="4034919">3</span><span class="op" id="4034920">]</span><span class="op" id="4034921">)</span>&nbsp;<span class="op" id="4034923">*</span>&nbsp;<span class="num" id="4034925">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034934">sr</span>&nbsp;<span class="op" id="4034937">:=</span>&nbsp;<span class="builtintype" id="4034940">uint32</span><span class="op" id="4034946">(</span><span class="ident" id="4034947">spix</span><span class="op" id="4034951">[</span><span class="ident" id="4034952">si</span><span class="op" id="4034954">+</span><span class="num" id="4034955">0</span><span class="op" id="4034956">]</span><span class="op" id="4034957">)</span>&nbsp;<span class="op" id="4034959">*</span>&nbsp;<span class="ident" id="4034961">sa</span>&nbsp;<span class="op" id="4034964">/</span>&nbsp;<span class="num" id="4034966">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4034974">sg</span>&nbsp;<span class="op" id="4034977">:=</span>&nbsp;<span class="builtintype" id="4034980">uint32</span><span class="op" id="4034986">(</span><span class="ident" id="4034987">spix</span><span class="op" id="4034991">[</span><span class="ident" id="4034992">si</span><span class="op" id="4034994">+</span><span class="num" id="4034995">1</span><span class="op" id="4034996">]</span><span class="op" id="4034997">)</span>&nbsp;<span class="op" id="4034999">*</span>&nbsp;<span class="ident" id="4035001">sa</span>&nbsp;<span class="op" id="4035004">/</span>&nbsp;<span class="num" id="4035006">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035014">sb</span>&nbsp;<span class="op" id="4035017">:=</span>&nbsp;<span class="builtintype" id="4035020">uint32</span><span class="op" id="4035026">(</span><span class="ident" id="4035027">spix</span><span class="op" id="4035031">[</span><span class="ident" id="4035032">si</span><span class="op" id="4035034">+</span><span class="num" id="4035035">2</span><span class="op" id="4035036">]</span><span class="op" id="4035037">)</span>&nbsp;<span class="op" id="4035039">*</span>&nbsp;<span class="ident" id="4035041">sa</span>&nbsp;<span class="op" id="4035044">/</span>&nbsp;<span class="num" id="4035046">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035055">dr</span>&nbsp;<span class="op" id="4035058">:=</span>&nbsp;<span class="builtintype" id="4035061">uint32</span><span class="op" id="4035067">(</span><span class="ident" id="4035068">dpix</span><span class="op" id="4035072">[</span><span class="ident" id="4035073">i</span><span class="op" id="4035074">+</span><span class="num" id="4035075">0</span><span class="op" id="4035076">]</span><span class="op" id="4035077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035082">dg</span>&nbsp;<span class="op" id="4035085">:=</span>&nbsp;<span class="builtintype" id="4035088">uint32</span><span class="op" id="4035094">(</span><span class="ident" id="4035095">dpix</span><span class="op" id="4035099">[</span><span class="ident" id="4035100">i</span><span class="op" id="4035101">+</span><span class="num" id="4035102">1</span><span class="op" id="4035103">]</span><span class="op" id="4035104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035109">db</span>&nbsp;<span class="op" id="4035112">:=</span>&nbsp;<span class="builtintype" id="4035115">uint32</span><span class="op" id="4035121">(</span><span class="ident" id="4035122">dpix</span><span class="op" id="4035126">[</span><span class="ident" id="4035127">i</span><span class="op" id="4035128">+</span><span class="num" id="4035129">2</span><span class="op" id="4035130">]</span><span class="op" id="4035131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035136">da</span>&nbsp;<span class="op" id="4035139">:=</span>&nbsp;<span class="builtintype" id="4035142">uint32</span><span class="op" id="4035148">(</span><span class="ident" id="4035149">dpix</span><span class="op" id="4035153">[</span><span class="ident" id="4035154">i</span><span class="op" id="4035155">+</span><span class="num" id="4035156">3</span><span class="op" id="4035157">]</span><span class="op" id="4035158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4035164">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035224">a</span>&nbsp;<span class="op" id="4035226">:=</span>&nbsp;<span class="op" id="4035229">(</span><span class="ident" id="4035230">m</span>&nbsp;<span class="op" id="4035232">-</span>&nbsp;<span class="ident" id="4035234">sa</span><span class="op" id="4035236">)</span>&nbsp;<span class="op" id="4035238">*</span>&nbsp;<span class="num" id="4035240">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035250">dpix</span><span class="op" id="4035254">[</span><span class="ident" id="4035255">i</span><span class="op" id="4035256">+</span><span class="num" id="4035257">0</span><span class="op" id="4035258">]</span>&nbsp;<span class="op" id="4035260">=</span>&nbsp;<span class="builtintype" id="4035262">uint8</span><span class="op" id="4035267">(</span><span class="op" id="4035268">(</span><span class="ident" id="4035269">dr</span><span class="op" id="4035271">*</span><span class="ident" id="4035272">a</span><span class="op" id="4035273">/</span><span class="ident" id="4035274">m</span>&nbsp;<span class="op" id="4035276">+</span>&nbsp;<span class="ident" id="4035278">sr</span><span class="op" id="4035280">)</span>&nbsp;<span class="op" id="4035282">&gt;&gt;</span>&nbsp;<span class="num" id="4035285">8</span><span class="op" id="4035286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035291">dpix</span><span class="op" id="4035295">[</span><span class="ident" id="4035296">i</span><span class="op" id="4035297">+</span><span class="num" id="4035298">1</span><span class="op" id="4035299">]</span>&nbsp;<span class="op" id="4035301">=</span>&nbsp;<span class="builtintype" id="4035303">uint8</span><span class="op" id="4035308">(</span><span class="op" id="4035309">(</span><span class="ident" id="4035310">dg</span><span class="op" id="4035312">*</span><span class="ident" id="4035313">a</span><span class="op" id="4035314">/</span><span class="ident" id="4035315">m</span>&nbsp;<span class="op" id="4035317">+</span>&nbsp;<span class="ident" id="4035319">sg</span><span class="op" id="4035321">)</span>&nbsp;<span class="op" id="4035323">&gt;&gt;</span>&nbsp;<span class="num" id="4035326">8</span><span class="op" id="4035327">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035332">dpix</span><span class="op" id="4035336">[</span><span class="ident" id="4035337">i</span><span class="op" id="4035338">+</span><span class="num" id="4035339">2</span><span class="op" id="4035340">]</span>&nbsp;<span class="op" id="4035342">=</span>&nbsp;<span class="builtintype" id="4035344">uint8</span><span class="op" id="4035349">(</span><span class="op" id="4035350">(</span><span class="ident" id="4035351">db</span><span class="op" id="4035353">*</span><span class="ident" id="4035354">a</span><span class="op" id="4035355">/</span><span class="ident" id="4035356">m</span>&nbsp;<span class="op" id="4035358">+</span>&nbsp;<span class="ident" id="4035360">sb</span><span class="op" id="4035362">)</span>&nbsp;<span class="op" id="4035364">&gt;&gt;</span>&nbsp;<span class="num" id="4035367">8</span><span class="op" id="4035368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035373">dpix</span><span class="op" id="4035377">[</span><span class="ident" id="4035378">i</span><span class="op" id="4035379">+</span><span class="num" id="4035380">3</span><span class="op" id="4035381">]</span>&nbsp;<span class="op" id="4035383">=</span>&nbsp;<span class="builtintype" id="4035385">uint8</span><span class="op" id="4035390">(</span><span class="op" id="4035391">(</span><span class="ident" id="4035392">da</span><span class="op" id="4035394">*</span><span class="ident" id="4035395">a</span><span class="op" id="4035396">/</span><span class="ident" id="4035397">m</span>&nbsp;<span class="op" id="4035399">+</span>&nbsp;<span class="ident" id="4035401">sa</span><span class="op" id="4035403">)</span>&nbsp;<span class="op" id="4035405">&gt;&gt;</span>&nbsp;<span class="num" id="4035408">8</span><span class="op" id="4035409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4035416">}</span><br>
<span class="lineno"></span><span class="op" id="4035418">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="4035421">func</span>&nbsp;<span class="ident" id="4035426">drawNRGBASrc</span><span class="op" id="4035438">(</span><span class="ident" id="4035439">dst</span>&nbsp;<span class="op" id="4035443">*</span><span class="ident" id="4035444">image</span><span class="op" id="4035449">.</span><span class="ident" id="4035450">RGBA</span><span class="op" id="4035454">,</span>&nbsp;<span class="ident" id="4035456">r</span>&nbsp;<span class="ident" id="4035458">image</span><span class="op" id="4035463">.</span><span class="ident" id="4035464">Rectangle</span><span class="op" id="4035473">,</span>&nbsp;<span class="ident" id="4035475">src</span>&nbsp;<span class="op" id="4035479">*</span><span class="ident" id="4035480">image</span><span class="op" id="4035485">.</span><span class="ident" id="4035486">NRGBA</span><span class="op" id="4035491">,</span>&nbsp;<span class="ident" id="4035493">sp</span>&nbsp;<span class="ident" id="4035496">image</span><span class="op" id="4035501">.</span><span class="ident" id="4035502">Point</span><span class="op" id="4035507">)</span>&nbsp;<span class="op" id="4035509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035512">i0</span>&nbsp;<span class="op" id="4035515">:=</span>&nbsp;<span class="op" id="4035518">(</span><span class="ident" id="4035519">r</span><span class="op" id="4035520">.</span><span class="ident" id="4035521">Min</span><span class="op" id="4035524">.</span><span class="ident" id="4035525">X</span>&nbsp;<span class="op" id="4035527">-</span>&nbsp;<span class="ident" id="4035529">dst</span><span class="op" id="4035532">.</span><span class="ident" id="4035533">Rect</span><span class="op" id="4035537">.</span><span class="ident" id="4035538">Min</span><span class="op" id="4035541">.</span><span class="ident" id="4035542">X</span><span class="op" id="4035543">)</span>&nbsp;<span class="op" id="4035545">*</span>&nbsp;<span class="num" id="4035547">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035550">i1</span>&nbsp;<span class="op" id="4035553">:=</span>&nbsp;<span class="op" id="4035556">(</span><span class="ident" id="4035557">r</span><span class="op" id="4035558">.</span><span class="ident" id="4035559">Max</span><span class="op" id="4035562">.</span><span class="ident" id="4035563">X</span>&nbsp;<span class="op" id="4035565">-</span>&nbsp;<span class="ident" id="4035567">dst</span><span class="op" id="4035570">.</span><span class="ident" id="4035571">Rect</span><span class="op" id="4035575">.</span><span class="ident" id="4035576">Min</span><span class="op" id="4035579">.</span><span class="ident" id="4035580">X</span><span class="op" id="4035581">)</span>&nbsp;<span class="op" id="4035583">*</span>&nbsp;<span class="num" id="4035585">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035588">si0</span>&nbsp;<span class="op" id="4035592">:=</span>&nbsp;<span class="op" id="4035595">(</span><span class="ident" id="4035596">sp</span><span class="op" id="4035598">.</span><span class="ident" id="4035599">X</span>&nbsp;<span class="op" id="4035601">-</span>&nbsp;<span class="ident" id="4035603">src</span><span class="op" id="4035606">.</span><span class="ident" id="4035607">Rect</span><span class="op" id="4035611">.</span><span class="ident" id="4035612">Min</span><span class="op" id="4035615">.</span><span class="ident" id="4035616">X</span><span class="op" id="4035617">)</span>&nbsp;<span class="op" id="4035619">*</span>&nbsp;<span class="num" id="4035621">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035624">yMax</span>&nbsp;<span class="op" id="4035629">:=</span>&nbsp;<span class="ident" id="4035632">r</span><span class="op" id="4035633">.</span><span class="ident" id="4035634">Max</span><span class="op" id="4035637">.</span><span class="ident" id="4035638">Y</span>&nbsp;<span class="op" id="4035640">-</span>&nbsp;<span class="ident" id="4035642">dst</span><span class="op" id="4035645">.</span><span class="ident" id="4035646">Rect</span><span class="op" id="4035650">.</span><span class="ident" id="4035651">Min</span><span class="op" id="4035654">.</span><span class="ident" id="4035655">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035659">y</span>&nbsp;<span class="op" id="4035661">:=</span>&nbsp;<span class="ident" id="4035664">r</span><span class="op" id="4035665">.</span><span class="ident" id="4035666">Min</span><span class="op" id="4035669">.</span><span class="ident" id="4035670">Y</span>&nbsp;<span class="op" id="4035672">-</span>&nbsp;<span class="ident" id="4035674">dst</span><span class="op" id="4035677">.</span><span class="ident" id="4035678">Rect</span><span class="op" id="4035682">.</span><span class="ident" id="4035683">Min</span><span class="op" id="4035686">.</span><span class="ident" id="4035687">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035690">sy</span>&nbsp;<span class="op" id="4035693">:=</span>&nbsp;<span class="ident" id="4035696">sp</span><span class="op" id="4035698">.</span><span class="ident" id="4035699">Y</span>&nbsp;<span class="op" id="4035701">-</span>&nbsp;<span class="ident" id="4035703">src</span><span class="op" id="4035706">.</span><span class="ident" id="4035707">Rect</span><span class="op" id="4035711">.</span><span class="ident" id="4035712">Min</span><span class="op" id="4035715">.</span><span class="ident" id="4035716">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035719">for</span>&nbsp;<span class="op" id="4035723">;</span>&nbsp;<span class="ident" id="4035725">y</span>&nbsp;<span class="op" id="4035727">!=</span>&nbsp;<span class="ident" id="4035730">yMax</span><span class="op" id="4035734">;</span>&nbsp;<span class="ident" id="4035736">y</span><span class="op" id="4035737">,</span>&nbsp;<span class="ident" id="4035739">sy</span>&nbsp;<span class="op" id="4035742">=</span>&nbsp;<span class="ident" id="4035744">y</span><span class="op" id="4035745">+</span><span class="num" id="4035746">1</span><span class="op" id="4035747">,</span>&nbsp;<span class="ident" id="4035749">sy</span><span class="op" id="4035751">+</span><span class="num" id="4035752">1</span>&nbsp;<span class="op" id="4035754">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035758">dpix</span>&nbsp;<span class="op" id="4035763">:=</span>&nbsp;<span class="ident" id="4035766">dst</span><span class="op" id="4035769">.</span><span class="ident" id="4035770">Pix</span><span class="op" id="4035773">[</span><span class="ident" id="4035774">y</span><span class="op" id="4035775">*</span><span class="ident" id="4035776">dst</span><span class="op" id="4035779">.</span><span class="ident" id="4035780">Stride</span><span class="op" id="4035786">:</span><span class="op" id="4035787">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035791">spix</span>&nbsp;<span class="op" id="4035796">:=</span>&nbsp;<span class="ident" id="4035799">src</span><span class="op" id="4035802">.</span><span class="ident" id="4035803">Pix</span><span class="op" id="4035806">[</span><span class="ident" id="4035807">sy</span><span class="op" id="4035809">*</span><span class="ident" id="4035810">src</span><span class="op" id="4035813">.</span><span class="ident" id="4035814">Stride</span><span class="op" id="4035820">:</span><span class="op" id="4035821">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4035826">for</span>&nbsp;<span class="ident" id="4035830">i</span><span class="op" id="4035831">,</span>&nbsp;<span class="ident" id="4035833">si</span>&nbsp;<span class="op" id="4035836">:=</span>&nbsp;<span class="ident" id="4035839">i0</span><span class="op" id="4035841">,</span>&nbsp;<span class="ident" id="4035843">si0</span><span class="op" id="4035846">;</span>&nbsp;<span class="ident" id="4035848">i</span>&nbsp;<span class="op" id="4035850">&lt;</span>&nbsp;<span class="ident" id="4035852">i1</span><span class="op" id="4035854">;</span>&nbsp;<span class="ident" id="4035856">i</span><span class="op" id="4035857">,</span>&nbsp;<span class="ident" id="4035859">si</span>&nbsp;<span class="op" id="4035862">=</span>&nbsp;<span class="ident" id="4035864">i</span><span class="op" id="4035865">+</span><span class="num" id="4035866">4</span><span class="op" id="4035867">,</span>&nbsp;<span class="ident" id="4035869">si</span><span class="op" id="4035871">+</span><span class="num" id="4035872">4</span>&nbsp;<span class="op" id="4035874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4035879">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035947">sa</span>&nbsp;<span class="op" id="4035950">:=</span>&nbsp;<span class="builtintype" id="4035953">uint32</span><span class="op" id="4035959">(</span><span class="ident" id="4035960">spix</span><span class="op" id="4035964">[</span><span class="ident" id="4035965">si</span><span class="op" id="4035967">+</span><span class="num" id="4035968">3</span><span class="op" id="4035969">]</span><span class="op" id="4035970">)</span>&nbsp;<span class="op" id="4035972">*</span>&nbsp;<span class="num" id="4035974">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4035983">sr</span>&nbsp;<span class="op" id="4035986">:=</span>&nbsp;<span class="builtintype" id="4035989">uint32</span><span class="op" id="4035995">(</span><span class="ident" id="4035996">spix</span><span class="op" id="4036000">[</span><span class="ident" id="4036001">si</span><span class="op" id="4036003">+</span><span class="num" id="4036004">0</span><span class="op" id="4036005">]</span><span class="op" id="4036006">)</span>&nbsp;<span class="op" id="4036008">*</span>&nbsp;<span class="ident" id="4036010">sa</span>&nbsp;<span class="op" id="4036013">/</span>&nbsp;<span class="num" id="4036015">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036023">sg</span>&nbsp;<span class="op" id="4036026">:=</span>&nbsp;<span class="builtintype" id="4036029">uint32</span><span class="op" id="4036035">(</span><span class="ident" id="4036036">spix</span><span class="op" id="4036040">[</span><span class="ident" id="4036041">si</span><span class="op" id="4036043">+</span><span class="num" id="4036044">1</span><span class="op" id="4036045">]</span><span class="op" id="4036046">)</span>&nbsp;<span class="op" id="4036048">*</span>&nbsp;<span class="ident" id="4036050">sa</span>&nbsp;<span class="op" id="4036053">/</span>&nbsp;<span class="num" id="4036055">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036063">sb</span>&nbsp;<span class="op" id="4036066">:=</span>&nbsp;<span class="builtintype" id="4036069">uint32</span><span class="op" id="4036075">(</span><span class="ident" id="4036076">spix</span><span class="op" id="4036080">[</span><span class="ident" id="4036081">si</span><span class="op" id="4036083">+</span><span class="num" id="4036084">2</span><span class="op" id="4036085">]</span><span class="op" id="4036086">)</span>&nbsp;<span class="op" id="4036088">*</span>&nbsp;<span class="ident" id="4036090">sa</span>&nbsp;<span class="op" id="4036093">/</span>&nbsp;<span class="num" id="4036095">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036104">dpix</span><span class="op" id="4036108">[</span><span class="ident" id="4036109">i</span><span class="op" id="4036110">+</span><span class="num" id="4036111">0</span><span class="op" id="4036112">]</span>&nbsp;<span class="op" id="4036114">=</span>&nbsp;<span class="builtintype" id="4036116">uint8</span><span class="op" id="4036121">(</span><span class="ident" id="4036122">sr</span>&nbsp;<span class="op" id="4036125">&gt;&gt;</span>&nbsp;<span class="num" id="4036128">8</span><span class="op" id="4036129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036134">dpix</span><span class="op" id="4036138">[</span><span class="ident" id="4036139">i</span><span class="op" id="4036140">+</span><span class="num" id="4036141">1</span><span class="op" id="4036142">]</span>&nbsp;<span class="op" id="4036144">=</span>&nbsp;<span class="builtintype" id="4036146">uint8</span><span class="op" id="4036151">(</span><span class="ident" id="4036152">sg</span>&nbsp;<span class="op" id="4036155">&gt;&gt;</span>&nbsp;<span class="num" id="4036158">8</span><span class="op" id="4036159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036164">dpix</span><span class="op" id="4036168">[</span><span class="ident" id="4036169">i</span><span class="op" id="4036170">+</span><span class="num" id="4036171">2</span><span class="op" id="4036172">]</span>&nbsp;<span class="op" id="4036174">=</span>&nbsp;<span class="builtintype" id="4036176">uint8</span><span class="op" id="4036181">(</span><span class="ident" id="4036182">sb</span>&nbsp;<span class="op" id="4036185">&gt;&gt;</span>&nbsp;<span class="num" id="4036188">8</span><span class="op" id="4036189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036194">dpix</span><span class="op" id="4036198">[</span><span class="ident" id="4036199">i</span><span class="op" id="4036200">+</span><span class="num" id="4036201">3</span><span class="op" id="4036202">]</span>&nbsp;<span class="op" id="4036204">=</span>&nbsp;<span class="builtintype" id="4036206">uint8</span><span class="op" id="4036211">(</span><span class="ident" id="4036212">sa</span>&nbsp;<span class="op" id="4036215">&gt;&gt;</span>&nbsp;<span class="num" id="4036218">8</span><span class="op" id="4036219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4036223">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4036226">}</span><br>
<span class="lineno"></span><span class="op" id="4036228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4036231">func</span>&nbsp;<span class="ident" id="4036236">drawYCbCr</span><span class="op" id="4036245">(</span><span class="ident" id="4036246">dst</span>&nbsp;<span class="op" id="4036250">*</span><span class="ident" id="4036251">image</span><span class="op" id="4036256">.</span><span class="ident" id="4036257">RGBA</span><span class="op" id="4036261">,</span>&nbsp;<span class="ident" id="4036263">r</span>&nbsp;<span class="ident" id="4036265">image</span><span class="op" id="4036270">.</span><span class="ident" id="4036271">Rectangle</span><span class="op" id="4036280">,</span>&nbsp;<span class="ident" id="4036282">src</span>&nbsp;<span class="op" id="4036286">*</span><span class="ident" id="4036287">image</span><span class="op" id="4036292">.</span><span class="ident" id="4036293">YCbCr</span><span class="op" id="4036298">,</span>&nbsp;<span class="ident" id="4036300">sp</span>&nbsp;<span class="ident" id="4036303">image</span><span class="op" id="4036308">.</span><span class="ident" id="4036309">Point</span><span class="op" id="4036314">)</span>&nbsp;<span class="op" id="4036316">(</span><span class="ident" id="4036317">ok</span>&nbsp;<span class="builtintype" id="4036320">bool</span><span class="op" id="4036324">)</span>&nbsp;<span class="op" id="4036326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4036329">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4036409">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036472">x0</span>&nbsp;<span class="op" id="4036475">:=</span>&nbsp;<span class="op" id="4036478">(</span><span class="ident" id="4036479">r</span><span class="op" id="4036480">.</span><span class="ident" id="4036481">Min</span><span class="op" id="4036484">.</span><span class="ident" id="4036485">X</span>&nbsp;<span class="op" id="4036487">-</span>&nbsp;<span class="ident" id="4036489">dst</span><span class="op" id="4036492">.</span><span class="ident" id="4036493">Rect</span><span class="op" id="4036497">.</span><span class="ident" id="4036498">Min</span><span class="op" id="4036501">.</span><span class="ident" id="4036502">X</span><span class="op" id="4036503">)</span>&nbsp;<span class="op" id="4036505">*</span>&nbsp;<span class="num" id="4036507">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036510">x1</span>&nbsp;<span class="op" id="4036513">:=</span>&nbsp;<span class="op" id="4036516">(</span><span class="ident" id="4036517">r</span><span class="op" id="4036518">.</span><span class="ident" id="4036519">Max</span><span class="op" id="4036522">.</span><span class="ident" id="4036523">X</span>&nbsp;<span class="op" id="4036525">-</span>&nbsp;<span class="ident" id="4036527">dst</span><span class="op" id="4036530">.</span><span class="ident" id="4036531">Rect</span><span class="op" id="4036535">.</span><span class="ident" id="4036536">Min</span><span class="op" id="4036539">.</span><span class="ident" id="4036540">X</span><span class="op" id="4036541">)</span>&nbsp;<span class="op" id="4036543">*</span>&nbsp;<span class="num" id="4036545">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036548">y0</span>&nbsp;<span class="op" id="4036551">:=</span>&nbsp;<span class="ident" id="4036554">r</span><span class="op" id="4036555">.</span><span class="ident" id="4036556">Min</span><span class="op" id="4036559">.</span><span class="ident" id="4036560">Y</span>&nbsp;<span class="op" id="4036562">-</span>&nbsp;<span class="ident" id="4036564">dst</span><span class="op" id="4036567">.</span><span class="ident" id="4036568">Rect</span><span class="op" id="4036572">.</span><span class="ident" id="4036573">Min</span><span class="op" id="4036576">.</span><span class="ident" id="4036577">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036580">y1</span>&nbsp;<span class="op" id="4036583">:=</span>&nbsp;<span class="ident" id="4036586">r</span><span class="op" id="4036587">.</span><span class="ident" id="4036588">Max</span><span class="op" id="4036591">.</span><span class="ident" id="4036592">Y</span>&nbsp;<span class="op" id="4036594">-</span>&nbsp;<span class="ident" id="4036596">dst</span><span class="op" id="4036599">.</span><span class="ident" id="4036600">Rect</span><span class="op" id="4036604">.</span><span class="ident" id="4036605">Min</span><span class="op" id="4036608">.</span><span class="ident" id="4036609">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4036612">switch</span>&nbsp;<span class="ident" id="4036619">src</span><span class="op" id="4036622">.</span><span class="ident" id="4036623">SubsampleRatio</span>&nbsp;<span class="op" id="4036638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4036641">case</span>&nbsp;<span class="ident" id="4036646">image</span><span class="op" id="4036651">.</span><span class="ident" id="4036652">YCbCrSubsampleRatio444</span><span class="op" id="4036674">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4036678">for</span>&nbsp;<span class="ident" id="4036682">y</span><span class="op" id="4036683">,</span>&nbsp;<span class="ident" id="4036685">sy</span>&nbsp;<span class="op" id="4036688">:=</span>&nbsp;<span class="ident" id="4036691">y0</span><span class="op" id="4036693">,</span>&nbsp;<span class="ident" id="4036695">sp</span><span class="op" id="4036697">.</span><span class="ident" id="4036698">Y</span><span class="op" id="4036699">;</span>&nbsp;<span class="ident" id="4036701">y</span>&nbsp;<span class="op" id="4036703">!=</span>&nbsp;<span class="ident" id="4036706">y1</span><span class="op" id="4036708">;</span>&nbsp;<span class="ident" id="4036710">y</span><span class="op" id="4036711">,</span>&nbsp;<span class="ident" id="4036713">sy</span>&nbsp;<span class="op" id="4036716">=</span>&nbsp;<span class="ident" id="4036718">y</span><span class="op" id="4036719">+</span><span class="num" id="4036720">1</span><span class="op" id="4036721">,</span>&nbsp;<span class="ident" id="4036723">sy</span><span class="op" id="4036725">+</span><span class="num" id="4036726">1</span>&nbsp;<span class="op" id="4036728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036733">dpix</span>&nbsp;<span class="op" id="4036738">:=</span>&nbsp;<span class="ident" id="4036741">dst</span><span class="op" id="4036744">.</span><span class="ident" id="4036745">Pix</span><span class="op" id="4036748">[</span><span class="ident" id="4036749">y</span><span class="op" id="4036750">*</span><span class="ident" id="4036751">dst</span><span class="op" id="4036754">.</span><span class="ident" id="4036755">Stride</span><span class="op" id="4036761">:</span><span class="op" id="4036762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036767">yi</span>&nbsp;<span class="op" id="4036770">:=</span>&nbsp;<span class="op" id="4036773">(</span><span class="ident" id="4036774">sy</span><span class="op" id="4036776">-</span><span class="ident" id="4036777">src</span><span class="op" id="4036780">.</span><span class="ident" id="4036781">Rect</span><span class="op" id="4036785">.</span><span class="ident" id="4036786">Min</span><span class="op" id="4036789">.</span><span class="ident" id="4036790">Y</span><span class="op" id="4036791">)</span><span class="op" id="4036792">*</span><span class="ident" id="4036793">src</span><span class="op" id="4036796">.</span><span class="ident" id="4036797">YStride</span>&nbsp;<span class="op" id="4036805">+</span>&nbsp;<span class="op" id="4036807">(</span><span class="ident" id="4036808">sp</span><span class="op" id="4036810">.</span><span class="ident" id="4036811">X</span>&nbsp;<span class="op" id="4036813">-</span>&nbsp;<span class="ident" id="4036815">src</span><span class="op" id="4036818">.</span><span class="ident" id="4036819">Rect</span><span class="op" id="4036823">.</span><span class="ident" id="4036824">Min</span><span class="op" id="4036827">.</span><span class="ident" id="4036828">X</span><span class="op" id="4036829">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036834">ci</span>&nbsp;<span class="op" id="4036837">:=</span>&nbsp;<span class="op" id="4036840">(</span><span class="ident" id="4036841">sy</span><span class="op" id="4036843">-</span><span class="ident" id="4036844">src</span><span class="op" id="4036847">.</span><span class="ident" id="4036848">Rect</span><span class="op" id="4036852">.</span><span class="ident" id="4036853">Min</span><span class="op" id="4036856">.</span><span class="ident" id="4036857">Y</span><span class="op" id="4036858">)</span><span class="op" id="4036859">*</span><span class="ident" id="4036860">src</span><span class="op" id="4036863">.</span><span class="ident" id="4036864">CStride</span>&nbsp;<span class="op" id="4036872">+</span>&nbsp;<span class="op" id="4036874">(</span><span class="ident" id="4036875">sp</span><span class="op" id="4036877">.</span><span class="ident" id="4036878">X</span>&nbsp;<span class="op" id="4036880">-</span>&nbsp;<span class="ident" id="4036882">src</span><span class="op" id="4036885">.</span><span class="ident" id="4036886">Rect</span><span class="op" id="4036890">.</span><span class="ident" id="4036891">Min</span><span class="op" id="4036894">.</span><span class="ident" id="4036895">X</span><span class="op" id="4036896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4036901">for</span>&nbsp;<span class="ident" id="4036905">x</span>&nbsp;<span class="op" id="4036907">:=</span>&nbsp;<span class="ident" id="4036910">x0</span><span class="op" id="4036912">;</span>&nbsp;<span class="ident" id="4036914">x</span>&nbsp;<span class="op" id="4036916">!=</span>&nbsp;<span class="ident" id="4036919">x1</span><span class="op" id="4036921">;</span>&nbsp;<span class="ident" id="4036923">x</span><span class="op" id="4036924">,</span>&nbsp;<span class="ident" id="4036926">yi</span><span class="op" id="4036928">,</span>&nbsp;<span class="ident" id="4036930">ci</span>&nbsp;<span class="op" id="4036933">=</span>&nbsp;<span class="ident" id="4036935">x</span><span class="op" id="4036936">+</span><span class="num" id="4036937">4</span><span class="op" id="4036938">,</span>&nbsp;<span class="ident" id="4036940">yi</span><span class="op" id="4036942">+</span><span class="num" id="4036943">1</span><span class="op" id="4036944">,</span>&nbsp;<span class="ident" id="4036946">ci</span><span class="op" id="4036948">+</span><span class="num" id="4036949">1</span>&nbsp;<span class="op" id="4036951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4036957">rr</span><span class="op" id="4036959">,</span>&nbsp;<span class="ident" id="4036961">gg</span><span class="op" id="4036963">,</span>&nbsp;<span class="ident" id="4036965">bb</span>&nbsp;<span class="op" id="4036968">:=</span>&nbsp;<span class="ident" id="4036971">color</span><span class="op" id="4036976">.</span><span class="ident" id="4036977">YCbCrToRGB</span><span class="op" id="4036987">(</span><span class="ident" id="4036988">src</span><span class="op" id="4036991">.</span><span class="ident" id="4036992">Y</span><span class="op" id="4036993">[</span><span class="ident" id="4036994">yi</span><span class="op" id="4036996">]</span><span class="op" id="4036997">,</span>&nbsp;<span class="ident" id="4036999">src</span><span class="op" id="4037002">.</span><span class="ident" id="4037003">Cb</span><span class="op" id="4037005">[</span><span class="ident" id="4037006">ci</span><span class="op" id="4037008">]</span><span class="op" id="4037009">,</span>&nbsp;<span class="ident" id="4037011">src</span><span class="op" id="4037014">.</span><span class="ident" id="4037015">Cr</span><span class="op" id="4037017">[</span><span class="ident" id="4037018">ci</span><span class="op" id="4037020">]</span><span class="op" id="4037021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037027">dpix</span><span class="op" id="4037031">[</span><span class="ident" id="4037032">x</span><span class="op" id="4037033">+</span><span class="num" id="4037034">0</span><span class="op" id="4037035">]</span>&nbsp;<span class="op" id="4037037">=</span>&nbsp;<span class="ident" id="4037039">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037046">dpix</span><span class="op" id="4037050">[</span><span class="ident" id="4037051">x</span><span class="op" id="4037052">+</span><span class="num" id="4037053">1</span><span class="op" id="4037054">]</span>&nbsp;<span class="op" id="4037056">=</span>&nbsp;<span class="ident" id="4037058">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037065">dpix</span><span class="op" id="4037069">[</span><span class="ident" id="4037070">x</span><span class="op" id="4037071">+</span><span class="num" id="4037072">2</span><span class="op" id="4037073">]</span>&nbsp;<span class="op" id="4037075">=</span>&nbsp;<span class="ident" id="4037077">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037084">dpix</span><span class="op" id="4037088">[</span><span class="ident" id="4037089">x</span><span class="op" id="4037090">+</span><span class="num" id="4037091">3</span><span class="op" id="4037092">]</span>&nbsp;<span class="op" id="4037094">=</span>&nbsp;<span class="num" id="4037096">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4037103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4037107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4037110">case</span>&nbsp;<span class="ident" id="4037115">image</span><span class="op" id="4037120">.</span><span class="ident" id="4037121">YCbCrSubsampleRatio422</span><span class="op" id="4037143">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4037147">for</span>&nbsp;<span class="ident" id="4037151">y</span><span class="op" id="4037152">,</span>&nbsp;<span class="ident" id="4037154">sy</span>&nbsp;<span class="op" id="4037157">:=</span>&nbsp;<span class="ident" id="4037160">y0</span><span class="op" id="4037162">,</span>&nbsp;<span class="ident" id="4037164">sp</span><span class="op" id="4037166">.</span><span class="ident" id="4037167">Y</span><span class="op" id="4037168">;</span>&nbsp;<span class="ident" id="4037170">y</span>&nbsp;<span class="op" id="4037172">!=</span>&nbsp;<span class="ident" id="4037175">y1</span><span class="op" id="4037177">;</span>&nbsp;<span class="ident" id="4037179">y</span><span class="op" id="4037180">,</span>&nbsp;<span class="ident" id="4037182">sy</span>&nbsp;<span class="op" id="4037185">=</span>&nbsp;<span class="ident" id="4037187">y</span><span class="op" id="4037188">+</span><span class="num" id="4037189">1</span><span class="op" id="4037190">,</span>&nbsp;<span class="ident" id="4037192">sy</span><span class="op" id="4037194">+</span><span class="num" id="4037195">1</span>&nbsp;<span class="op" id="4037197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037202">dpix</span>&nbsp;<span class="op" id="4037207">:=</span>&nbsp;<span class="ident" id="4037210">dst</span><span class="op" id="4037213">.</span><span class="ident" id="4037214">Pix</span><span class="op" id="4037217">[</span><span class="ident" id="4037218">y</span><span class="op" id="4037219">*</span><span class="ident" id="4037220">dst</span><span class="op" id="4037223">.</span><span class="ident" id="4037224">Stride</span><span class="op" id="4037230">:</span><span class="op" id="4037231">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037236">yi</span>&nbsp;<span class="op" id="4037239">:=</span>&nbsp;<span class="op" id="4037242">(</span><span class="ident" id="4037243">sy</span><span class="op" id="4037245">-</span><span class="ident" id="4037246">src</span><span class="op" id="4037249">.</span><span class="ident" id="4037250">Rect</span><span class="op" id="4037254">.</span><span class="ident" id="4037255">Min</span><span class="op" id="4037258">.</span><span class="ident" id="4037259">Y</span><span class="op" id="4037260">)</span><span class="op" id="4037261">*</span><span class="ident" id="4037262">src</span><span class="op" id="4037265">.</span><span class="ident" id="4037266">YStride</span>&nbsp;<span class="op" id="4037274">+</span>&nbsp;<span class="op" id="4037276">(</span><span class="ident" id="4037277">sp</span><span class="op" id="4037279">.</span><span class="ident" id="4037280">X</span>&nbsp;<span class="op" id="4037282">-</span>&nbsp;<span class="ident" id="4037284">src</span><span class="op" id="4037287">.</span><span class="ident" id="4037288">Rect</span><span class="op" id="4037292">.</span><span class="ident" id="4037293">Min</span><span class="op" id="4037296">.</span><span class="ident" id="4037297">X</span><span class="op" id="4037298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037303">ciBase</span>&nbsp;<span class="op" id="4037310">:=</span>&nbsp;<span class="op" id="4037313">(</span><span class="ident" id="4037314">sy</span><span class="op" id="4037316">-</span><span class="ident" id="4037317">src</span><span class="op" id="4037320">.</span><span class="ident" id="4037321">Rect</span><span class="op" id="4037325">.</span><span class="ident" id="4037326">Min</span><span class="op" id="4037329">.</span><span class="ident" id="4037330">Y</span><span class="op" id="4037331">)</span><span class="op" id="4037332">*</span><span class="ident" id="4037333">src</span><span class="op" id="4037336">.</span><span class="ident" id="4037337">CStride</span>&nbsp;<span class="op" id="4037345">-</span>&nbsp;<span class="ident" id="4037347">src</span><span class="op" id="4037350">.</span><span class="ident" id="4037351">Rect</span><span class="op" id="4037355">.</span><span class="ident" id="4037356">Min</span><span class="op" id="4037359">.</span><span class="ident" id="4037360">X</span><span class="op" id="4037361">/</span><span class="num" id="4037362">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4037367">for</span>&nbsp;<span class="ident" id="4037371">x</span><span class="op" id="4037372">,</span>&nbsp;<span class="ident" id="4037374">sx</span>&nbsp;<span class="op" id="4037377">:=</span>&nbsp;<span class="ident" id="4037380">x0</span><span class="op" id="4037382">,</span>&nbsp;<span class="ident" id="4037384">sp</span><span class="op" id="4037386">.</span><span class="ident" id="4037387">X</span><span class="op" id="4037388">;</span>&nbsp;<span class="ident" id="4037390">x</span>&nbsp;<span class="op" id="4037392">!=</span>&nbsp;<span class="ident" id="4037395">x1</span><span class="op" id="4037397">;</span>&nbsp;<span class="ident" id="4037399">x</span><span class="op" id="4037400">,</span>&nbsp;<span class="ident" id="4037402">sx</span><span class="op" id="4037404">,</span>&nbsp;<span class="ident" id="4037406">yi</span>&nbsp;<span class="op" id="4037409">=</span>&nbsp;<span class="ident" id="4037411">x</span><span class="op" id="4037412">+</span><span class="num" id="4037413">4</span><span class="op" id="4037414">,</span>&nbsp;<span class="ident" id="4037416">sx</span><span class="op" id="4037418">+</span><span class="num" id="4037419">1</span><span class="op" id="4037420">,</span>&nbsp;<span class="ident" id="4037422">yi</span><span class="op" id="4037424">+</span><span class="num" id="4037425">1</span>&nbsp;<span class="op" id="4037427">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037433">ci</span>&nbsp;<span class="op" id="4037436">:=</span>&nbsp;<span class="ident" id="4037439">ciBase</span>&nbsp;<span class="op" id="4037446">+</span>&nbsp;<span class="ident" id="4037448">sx</span><span class="op" id="4037450">/</span><span class="num" id="4037451">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037457">rr</span><span class="op" id="4037459">,</span>&nbsp;<span class="ident" id="4037461">gg</span><span class="op" id="4037463">,</span>&nbsp;<span class="ident" id="4037465">bb</span>&nbsp;<span class="op" id="4037468">:=</span>&nbsp;<span class="ident" id="4037471">color</span><span class="op" id="4037476">.</span><span class="ident" id="4037477">YCbCrToRGB</span><span class="op" id="4037487">(</span><span class="ident" id="4037488">src</span><span class="op" id="4037491">.</span><span class="ident" id="4037492">Y</span><span class="op" id="4037493">[</span><span class="ident" id="4037494">yi</span><span class="op" id="4037496">]</span><span class="op" id="4037497">,</span>&nbsp;<span class="ident" id="4037499">src</span><span class="op" id="4037502">.</span><span class="ident" id="4037503">Cb</span><span class="op" id="4037505">[</span><span class="ident" id="4037506">ci</span><span class="op" id="4037508">]</span><span class="op" id="4037509">,</span>&nbsp;<span class="ident" id="4037511">src</span><span class="op" id="4037514">.</span><span class="ident" id="4037515">Cr</span><span class="op" id="4037517">[</span><span class="ident" id="4037518">ci</span><span class="op" id="4037520">]</span><span class="op" id="4037521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037527">dpix</span><span class="op" id="4037531">[</span><span class="ident" id="4037532">x</span><span class="op" id="4037533">+</span><span class="num" id="4037534">0</span><span class="op" id="4037535">]</span>&nbsp;<span class="op" id="4037537">=</span>&nbsp;<span class="ident" id="4037539">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037546">dpix</span><span class="op" id="4037550">[</span><span class="ident" id="4037551">x</span><span class="op" id="4037552">+</span><span class="num" id="4037553">1</span><span class="op" id="4037554">]</span>&nbsp;<span class="op" id="4037556">=</span>&nbsp;<span class="ident" id="4037558">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037565">dpix</span><span class="op" id="4037569">[</span><span class="ident" id="4037570">x</span><span class="op" id="4037571">+</span><span class="num" id="4037572">2</span><span class="op" id="4037573">]</span>&nbsp;<span class="op" id="4037575">=</span>&nbsp;<span class="ident" id="4037577">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037584">dpix</span><span class="op" id="4037588">[</span><span class="ident" id="4037589">x</span><span class="op" id="4037590">+</span><span class="num" id="4037591">3</span><span class="op" id="4037592">]</span>&nbsp;<span class="op" id="4037594">=</span>&nbsp;<span class="num" id="4037596">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4037603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4037607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4037610">case</span>&nbsp;<span class="ident" id="4037615">image</span><span class="op" id="4037620">.</span><span class="ident" id="4037621">YCbCrSubsampleRatio420</span><span class="op" id="4037643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4037647">for</span>&nbsp;<span class="ident" id="4037651">y</span><span class="op" id="4037652">,</span>&nbsp;<span class="ident" id="4037654">sy</span>&nbsp;<span class="op" id="4037657">:=</span>&nbsp;<span class="ident" id="4037660">y0</span><span class="op" id="4037662">,</span>&nbsp;<span class="ident" id="4037664">sp</span><span class="op" id="4037666">.</span><span class="ident" id="4037667">Y</span><span class="op" id="4037668">;</span>&nbsp;<span class="ident" id="4037670">y</span>&nbsp;<span class="op" id="4037672">!=</span>&nbsp;<span class="ident" id="4037675">y1</span><span class="op" id="4037677">;</span>&nbsp;<span class="ident" id="4037679">y</span><span class="op" id="4037680">,</span>&nbsp;<span class="ident" id="4037682">sy</span>&nbsp;<span class="op" id="4037685">=</span>&nbsp;<span class="ident" id="4037687">y</span><span class="op" id="4037688">+</span><span class="num" id="4037689">1</span><span class="op" id="4037690">,</span>&nbsp;<span class="ident" id="4037692">sy</span><span class="op" id="4037694">+</span><span class="num" id="4037695">1</span>&nbsp;<span class="op" id="4037697">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037702">dpix</span>&nbsp;<span class="op" id="4037707">:=</span>&nbsp;<span class="ident" id="4037710">dst</span><span class="op" id="4037713">.</span><span class="ident" id="4037714">Pix</span><span class="op" id="4037717">[</span><span class="ident" id="4037718">y</span><span class="op" id="4037719">*</span><span class="ident" id="4037720">dst</span><span class="op" id="4037723">.</span><span class="ident" id="4037724">Stride</span><span class="op" id="4037730">:</span><span class="op" id="4037731">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037736">yi</span>&nbsp;<span class="op" id="4037739">:=</span>&nbsp;<span class="op" id="4037742">(</span><span class="ident" id="4037743">sy</span><span class="op" id="4037745">-</span><span class="ident" id="4037746">src</span><span class="op" id="4037749">.</span><span class="ident" id="4037750">Rect</span><span class="op" id="4037754">.</span><span class="ident" id="4037755">Min</span><span class="op" id="4037758">.</span><span class="ident" id="4037759">Y</span><span class="op" id="4037760">)</span><span class="op" id="4037761">*</span><span class="ident" id="4037762">src</span><span class="op" id="4037765">.</span><span class="ident" id="4037766">YStride</span>&nbsp;<span class="op" id="4037774">+</span>&nbsp;<span class="op" id="4037776">(</span><span class="ident" id="4037777">sp</span><span class="op" id="4037779">.</span><span class="ident" id="4037780">X</span>&nbsp;<span class="op" id="4037782">-</span>&nbsp;<span class="ident" id="4037784">src</span><span class="op" id="4037787">.</span><span class="ident" id="4037788">Rect</span><span class="op" id="4037792">.</span><span class="ident" id="4037793">Min</span><span class="op" id="4037796">.</span><span class="ident" id="4037797">X</span><span class="op" id="4037798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037803">ciBase</span>&nbsp;<span class="op" id="4037810">:=</span>&nbsp;<span class="op" id="4037813">(</span><span class="ident" id="4037814">sy</span><span class="op" id="4037816">/</span><span class="num" id="4037817">2</span><span class="op" id="4037818">-</span><span class="ident" id="4037819">src</span><span class="op" id="4037822">.</span><span class="ident" id="4037823">Rect</span><span class="op" id="4037827">.</span><span class="ident" id="4037828">Min</span><span class="op" id="4037831">.</span><span class="ident" id="4037832">Y</span><span class="op" id="4037833">/</span><span class="num" id="4037834">2</span><span class="op" id="4037835">)</span><span class="op" id="4037836">*</span><span class="ident" id="4037837">src</span><span class="op" id="4037840">.</span><span class="ident" id="4037841">CStride</span>&nbsp;<span class="op" id="4037849">-</span>&nbsp;<span class="ident" id="4037851">src</span><span class="op" id="4037854">.</span><span class="ident" id="4037855">Rect</span><span class="op" id="4037859">.</span><span class="ident" id="4037860">Min</span><span class="op" id="4037863">.</span><span class="ident" id="4037864">X</span><span class="op" id="4037865">/</span><span class="num" id="4037866">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4037871">for</span>&nbsp;<span class="ident" id="4037875">x</span><span class="op" id="4037876">,</span>&nbsp;<span class="ident" id="4037878">sx</span>&nbsp;<span class="op" id="4037881">:=</span>&nbsp;<span class="ident" id="4037884">x0</span><span class="op" id="4037886">,</span>&nbsp;<span class="ident" id="4037888">sp</span><span class="op" id="4037890">.</span><span class="ident" id="4037891">X</span><span class="op" id="4037892">;</span>&nbsp;<span class="ident" id="4037894">x</span>&nbsp;<span class="op" id="4037896">!=</span>&nbsp;<span class="ident" id="4037899">x1</span><span class="op" id="4037901">;</span>&nbsp;<span class="ident" id="4037903">x</span><span class="op" id="4037904">,</span>&nbsp;<span class="ident" id="4037906">sx</span><span class="op" id="4037908">,</span>&nbsp;<span class="ident" id="4037910">yi</span>&nbsp;<span class="op" id="4037913">=</span>&nbsp;<span class="ident" id="4037915">x</span><span class="op" id="4037916">+</span><span class="num" id="4037917">4</span><span class="op" id="4037918">,</span>&nbsp;<span class="ident" id="4037920">sx</span><span class="op" id="4037922">+</span><span class="num" id="4037923">1</span><span class="op" id="4037924">,</span>&nbsp;<span class="ident" id="4037926">yi</span><span class="op" id="4037928">+</span><span class="num" id="4037929">1</span>&nbsp;<span class="op" id="4037931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037937">ci</span>&nbsp;<span class="op" id="4037940">:=</span>&nbsp;<span class="ident" id="4037943">ciBase</span>&nbsp;<span class="op" id="4037950">+</span>&nbsp;<span class="ident" id="4037952">sx</span><span class="op" id="4037954">/</span><span class="num" id="4037955">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4037961">rr</span><span class="op" id="4037963">,</span>&nbsp;<span class="ident" id="4037965">gg</span><span class="op" id="4037967">,</span>&nbsp;<span class="ident" id="4037969">bb</span>&nbsp;<span class="op" id="4037972">:=</span>&nbsp;<span class="ident" id="4037975">color</span><span class="op" id="4037980">.</span><span class="ident" id="4037981">YCbCrToRGB</span><span class="op" id="4037991">(</span><span class="ident" id="4037992">src</span><span class="op" id="4037995">.</span><span class="ident" id="4037996">Y</span><span class="op" id="4037997">[</span><span class="ident" id="4037998">yi</span><span class="op" id="4038000">]</span><span class="op" id="4038001">,</span>&nbsp;<span class="ident" id="4038003">src</span><span class="op" id="4038006">.</span><span class="ident" id="4038007">Cb</span><span class="op" id="4038009">[</span><span class="ident" id="4038010">ci</span><span class="op" id="4038012">]</span><span class="op" id="4038013">,</span>&nbsp;<span class="ident" id="4038015">src</span><span class="op" id="4038018">.</span><span class="ident" id="4038019">Cr</span><span class="op" id="4038021">[</span><span class="ident" id="4038022">ci</span><span class="op" id="4038024">]</span><span class="op" id="4038025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038031">dpix</span><span class="op" id="4038035">[</span><span class="ident" id="4038036">x</span><span class="op" id="4038037">+</span><span class="num" id="4038038">0</span><span class="op" id="4038039">]</span>&nbsp;<span class="op" id="4038041">=</span>&nbsp;<span class="ident" id="4038043">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038050">dpix</span><span class="op" id="4038054">[</span><span class="ident" id="4038055">x</span><span class="op" id="4038056">+</span><span class="num" id="4038057">1</span><span class="op" id="4038058">]</span>&nbsp;<span class="op" id="4038060">=</span>&nbsp;<span class="ident" id="4038062">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038069">dpix</span><span class="op" id="4038073">[</span><span class="ident" id="4038074">x</span><span class="op" id="4038075">+</span><span class="num" id="4038076">2</span><span class="op" id="4038077">]</span>&nbsp;<span class="op" id="4038079">=</span>&nbsp;<span class="ident" id="4038081">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038088">dpix</span><span class="op" id="4038092">[</span><span class="ident" id="4038093">x</span><span class="op" id="4038094">+</span><span class="num" id="4038095">3</span><span class="op" id="4038096">]</span>&nbsp;<span class="op" id="4038098">=</span>&nbsp;<span class="num" id="4038100">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4038107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4038111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038114">case</span>&nbsp;<span class="ident" id="4038119">image</span><span class="op" id="4038124">.</span><span class="ident" id="4038125">YCbCrSubsampleRatio440</span><span class="op" id="4038147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038151">for</span>&nbsp;<span class="ident" id="4038155">y</span><span class="op" id="4038156">,</span>&nbsp;<span class="ident" id="4038158">sy</span>&nbsp;<span class="op" id="4038161">:=</span>&nbsp;<span class="ident" id="4038164">y0</span><span class="op" id="4038166">,</span>&nbsp;<span class="ident" id="4038168">sp</span><span class="op" id="4038170">.</span><span class="ident" id="4038171">Y</span><span class="op" id="4038172">;</span>&nbsp;<span class="ident" id="4038174">y</span>&nbsp;<span class="op" id="4038176">!=</span>&nbsp;<span class="ident" id="4038179">y1</span><span class="op" id="4038181">;</span>&nbsp;<span class="ident" id="4038183">y</span><span class="op" id="4038184">,</span>&nbsp;<span class="ident" id="4038186">sy</span>&nbsp;<span class="op" id="4038189">=</span>&nbsp;<span class="ident" id="4038191">y</span><span class="op" id="4038192">+</span><span class="num" id="4038193">1</span><span class="op" id="4038194">,</span>&nbsp;<span class="ident" id="4038196">sy</span><span class="op" id="4038198">+</span><span class="num" id="4038199">1</span>&nbsp;<span class="op" id="4038201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038206">dpix</span>&nbsp;<span class="op" id="4038211">:=</span>&nbsp;<span class="ident" id="4038214">dst</span><span class="op" id="4038217">.</span><span class="ident" id="4038218">Pix</span><span class="op" id="4038221">[</span><span class="ident" id="4038222">y</span><span class="op" id="4038223">*</span><span class="ident" id="4038224">dst</span><span class="op" id="4038227">.</span><span class="ident" id="4038228">Stride</span><span class="op" id="4038234">:</span><span class="op" id="4038235">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038240">yi</span>&nbsp;<span class="op" id="4038243">:=</span>&nbsp;<span class="op" id="4038246">(</span><span class="ident" id="4038247">sy</span><span class="op" id="4038249">-</span><span class="ident" id="4038250">src</span><span class="op" id="4038253">.</span><span class="ident" id="4038254">Rect</span><span class="op" id="4038258">.</span><span class="ident" id="4038259">Min</span><span class="op" id="4038262">.</span><span class="ident" id="4038263">Y</span><span class="op" id="4038264">)</span><span class="op" id="4038265">*</span><span class="ident" id="4038266">src</span><span class="op" id="4038269">.</span><span class="ident" id="4038270">YStride</span>&nbsp;<span class="op" id="4038278">+</span>&nbsp;<span class="op" id="4038280">(</span><span class="ident" id="4038281">sp</span><span class="op" id="4038283">.</span><span class="ident" id="4038284">X</span>&nbsp;<span class="op" id="4038286">-</span>&nbsp;<span class="ident" id="4038288">src</span><span class="op" id="4038291">.</span><span class="ident" id="4038292">Rect</span><span class="op" id="4038296">.</span><span class="ident" id="4038297">Min</span><span class="op" id="4038300">.</span><span class="ident" id="4038301">X</span><span class="op" id="4038302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038307">ci</span>&nbsp;<span class="op" id="4038310">:=</span>&nbsp;<span class="op" id="4038313">(</span><span class="ident" id="4038314">sy</span><span class="op" id="4038316">/</span><span class="num" id="4038317">2</span><span class="op" id="4038318">-</span><span class="ident" id="4038319">src</span><span class="op" id="4038322">.</span><span class="ident" id="4038323">Rect</span><span class="op" id="4038327">.</span><span class="ident" id="4038328">Min</span><span class="op" id="4038331">.</span><span class="ident" id="4038332">Y</span><span class="op" id="4038333">/</span><span class="num" id="4038334">2</span><span class="op" id="4038335">)</span><span class="op" id="4038336">*</span><span class="ident" id="4038337">src</span><span class="op" id="4038340">.</span><span class="ident" id="4038341">CStride</span>&nbsp;<span class="op" id="4038349">+</span>&nbsp;<span class="op" id="4038351">(</span><span class="ident" id="4038352">sp</span><span class="op" id="4038354">.</span><span class="ident" id="4038355">X</span>&nbsp;<span class="op" id="4038357">-</span>&nbsp;<span class="ident" id="4038359">src</span><span class="op" id="4038362">.</span><span class="ident" id="4038363">Rect</span><span class="op" id="4038367">.</span><span class="ident" id="4038368">Min</span><span class="op" id="4038371">.</span><span class="ident" id="4038372">X</span><span class="op" id="4038373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038378">for</span>&nbsp;<span class="ident" id="4038382">x</span>&nbsp;<span class="op" id="4038384">:=</span>&nbsp;<span class="ident" id="4038387">x0</span><span class="op" id="4038389">;</span>&nbsp;<span class="ident" id="4038391">x</span>&nbsp;<span class="op" id="4038393">!=</span>&nbsp;<span class="ident" id="4038396">x1</span><span class="op" id="4038398">;</span>&nbsp;<span class="ident" id="4038400">x</span><span class="op" id="4038401">,</span>&nbsp;<span class="ident" id="4038403">yi</span><span class="op" id="4038405">,</span>&nbsp;<span class="ident" id="4038407">ci</span>&nbsp;<span class="op" id="4038410">=</span>&nbsp;<span class="ident" id="4038412">x</span><span class="op" id="4038413">+</span><span class="num" id="4038414">4</span><span class="op" id="4038415">,</span>&nbsp;<span class="ident" id="4038417">yi</span><span class="op" id="4038419">+</span><span class="num" id="4038420">1</span><span class="op" id="4038421">,</span>&nbsp;<span class="ident" id="4038423">ci</span><span class="op" id="4038425">+</span><span class="num" id="4038426">1</span>&nbsp;<span class="op" id="4038428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038434">rr</span><span class="op" id="4038436">,</span>&nbsp;<span class="ident" id="4038438">gg</span><span class="op" id="4038440">,</span>&nbsp;<span class="ident" id="4038442">bb</span>&nbsp;<span class="op" id="4038445">:=</span>&nbsp;<span class="ident" id="4038448">color</span><span class="op" id="4038453">.</span><span class="ident" id="4038454">YCbCrToRGB</span><span class="op" id="4038464">(</span><span class="ident" id="4038465">src</span><span class="op" id="4038468">.</span><span class="ident" id="4038469">Y</span><span class="op" id="4038470">[</span><span class="ident" id="4038471">yi</span><span class="op" id="4038473">]</span><span class="op" id="4038474">,</span>&nbsp;<span class="ident" id="4038476">src</span><span class="op" id="4038479">.</span><span class="ident" id="4038480">Cb</span><span class="op" id="4038482">[</span><span class="ident" id="4038483">ci</span><span class="op" id="4038485">]</span><span class="op" id="4038486">,</span>&nbsp;<span class="ident" id="4038488">src</span><span class="op" id="4038491">.</span><span class="ident" id="4038492">Cr</span><span class="op" id="4038494">[</span><span class="ident" id="4038495">ci</span><span class="op" id="4038497">]</span><span class="op" id="4038498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038504">dpix</span><span class="op" id="4038508">[</span><span class="ident" id="4038509">x</span><span class="op" id="4038510">+</span><span class="num" id="4038511">0</span><span class="op" id="4038512">]</span>&nbsp;<span class="op" id="4038514">=</span>&nbsp;<span class="ident" id="4038516">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038523">dpix</span><span class="op" id="4038527">[</span><span class="ident" id="4038528">x</span><span class="op" id="4038529">+</span><span class="num" id="4038530">1</span><span class="op" id="4038531">]</span>&nbsp;<span class="op" id="4038533">=</span>&nbsp;<span class="ident" id="4038535">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038542">dpix</span><span class="op" id="4038546">[</span><span class="ident" id="4038547">x</span><span class="op" id="4038548">+</span><span class="num" id="4038549">2</span><span class="op" id="4038550">]</span>&nbsp;<span class="op" id="4038552">=</span>&nbsp;<span class="ident" id="4038554">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038561">dpix</span><span class="op" id="4038565">[</span><span class="ident" id="4038566">x</span><span class="op" id="4038567">+</span><span class="num" id="4038568">3</span><span class="op" id="4038569">]</span>&nbsp;<span class="op" id="4038571">=</span>&nbsp;<span class="num" id="4038573">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4038580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4038584">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038587">default</span><span class="op" id="4038594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038598">return</span>&nbsp;<span class="builtintype" id="4038605">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4038612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038615">return</span>&nbsp;<span class="builtintype" id="4038622">true</span><br>
<span class="lineno"></span><span class="op" id="4038627">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="4038630">func</span>&nbsp;<span class="ident" id="4038635">drawGlyphOver</span><span class="op" id="4038648">(</span><span class="ident" id="4038649">dst</span>&nbsp;<span class="op" id="4038653">*</span><span class="ident" id="4038654">image</span><span class="op" id="4038659">.</span><span class="ident" id="4038660">RGBA</span><span class="op" id="4038664">,</span>&nbsp;<span class="ident" id="4038666">r</span>&nbsp;<span class="ident" id="4038668">image</span><span class="op" id="4038673">.</span><span class="ident" id="4038674">Rectangle</span><span class="op" id="4038683">,</span>&nbsp;<span class="ident" id="4038685">src</span>&nbsp;<span class="op" id="4038689">*</span><span class="ident" id="4038690">image</span><span class="op" id="4038695">.</span><span class="ident" id="4038696">Uniform</span><span class="op" id="4038703">,</span>&nbsp;<span class="ident" id="4038705">mask</span>&nbsp;<span class="op" id="4038710">*</span><span class="ident" id="4038711">image</span><span class="op" id="4038716">.</span><span class="ident" id="4038717">Alpha</span><span class="op" id="4038722">,</span>&nbsp;<span class="ident" id="4038724">mp</span>&nbsp;<span class="ident" id="4038727">image</span><span class="op" id="4038732">.</span><span class="ident" id="4038733">Point</span><span class="op" id="4038738">)</span>&nbsp;<span class="op" id="4038740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038743">i0</span>&nbsp;<span class="op" id="4038746">:=</span>&nbsp;<span class="ident" id="4038749">dst</span><span class="op" id="4038752">.</span><span class="ident" id="4038753">PixOffset</span><span class="op" id="4038762">(</span><span class="ident" id="4038763">r</span><span class="op" id="4038764">.</span><span class="ident" id="4038765">Min</span><span class="op" id="4038768">.</span><span class="ident" id="4038769">X</span><span class="op" id="4038770">,</span>&nbsp;<span class="ident" id="4038772">r</span><span class="op" id="4038773">.</span><span class="ident" id="4038774">Min</span><span class="op" id="4038777">.</span><span class="ident" id="4038778">Y</span><span class="op" id="4038779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038782">i1</span>&nbsp;<span class="op" id="4038785">:=</span>&nbsp;<span class="ident" id="4038788">i0</span>&nbsp;<span class="op" id="4038791">+</span>&nbsp;<span class="ident" id="4038793">r</span><span class="op" id="4038794">.</span><span class="ident" id="4038795">Dx</span><span class="op" id="4038797">(</span><span class="op" id="4038798">)</span><span class="op" id="4038799">*</span><span class="num" id="4038800">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038803">mi0</span>&nbsp;<span class="op" id="4038807">:=</span>&nbsp;<span class="ident" id="4038810">mask</span><span class="op" id="4038814">.</span><span class="ident" id="4038815">PixOffset</span><span class="op" id="4038824">(</span><span class="ident" id="4038825">mp</span><span class="op" id="4038827">.</span><span class="ident" id="4038828">X</span><span class="op" id="4038829">,</span>&nbsp;<span class="ident" id="4038831">mp</span><span class="op" id="4038833">.</span><span class="ident" id="4038834">Y</span><span class="op" id="4038835">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038838">sr</span><span class="op" id="4038840">,</span>&nbsp;<span class="ident" id="4038842">sg</span><span class="op" id="4038844">,</span>&nbsp;<span class="ident" id="4038846">sb</span><span class="op" id="4038848">,</span>&nbsp;<span class="ident" id="4038850">sa</span>&nbsp;<span class="op" id="4038853">:=</span>&nbsp;<span class="ident" id="4038856">src</span><span class="op" id="4038859">.</span><span class="ident" id="4038860">RGBA</span><span class="op" id="4038864">(</span><span class="op" id="4038865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038868">for</span>&nbsp;<span class="ident" id="4038872">y</span><span class="op" id="4038873">,</span>&nbsp;<span class="ident" id="4038875">my</span>&nbsp;<span class="op" id="4038878">:=</span>&nbsp;<span class="ident" id="4038881">r</span><span class="op" id="4038882">.</span><span class="ident" id="4038883">Min</span><span class="op" id="4038886">.</span><span class="ident" id="4038887">Y</span><span class="op" id="4038888">,</span>&nbsp;<span class="ident" id="4038890">mp</span><span class="op" id="4038892">.</span><span class="ident" id="4038893">Y</span><span class="op" id="4038894">;</span>&nbsp;<span class="ident" id="4038896">y</span>&nbsp;<span class="op" id="4038898">!=</span>&nbsp;<span class="ident" id="4038901">r</span><span class="op" id="4038902">.</span><span class="ident" id="4038903">Max</span><span class="op" id="4038906">.</span><span class="ident" id="4038907">Y</span><span class="op" id="4038908">;</span>&nbsp;<span class="ident" id="4038910">y</span><span class="op" id="4038911">,</span>&nbsp;<span class="ident" id="4038913">my</span>&nbsp;<span class="op" id="4038916">=</span>&nbsp;<span class="ident" id="4038918">y</span><span class="op" id="4038919">+</span><span class="num" id="4038920">1</span><span class="op" id="4038921">,</span>&nbsp;<span class="ident" id="4038923">my</span><span class="op" id="4038925">+</span><span class="num" id="4038926">1</span>&nbsp;<span class="op" id="4038928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4038932">for</span>&nbsp;<span class="ident" id="4038936">i</span><span class="op" id="4038937">,</span>&nbsp;<span class="ident" id="4038939">mi</span>&nbsp;<span class="op" id="4038942">:=</span>&nbsp;<span class="ident" id="4038945">i0</span><span class="op" id="4038947">,</span>&nbsp;<span class="ident" id="4038949">mi0</span><span class="op" id="4038952">;</span>&nbsp;<span class="ident" id="4038954">i</span>&nbsp;<span class="op" id="4038956">&lt;</span>&nbsp;<span class="ident" id="4038958">i1</span><span class="op" id="4038960">;</span>&nbsp;<span class="ident" id="4038962">i</span><span class="op" id="4038963">,</span>&nbsp;<span class="ident" id="4038965">mi</span>&nbsp;<span class="op" id="4038968">=</span>&nbsp;<span class="ident" id="4038970">i</span><span class="op" id="4038971">+</span><span class="num" id="4038972">4</span><span class="op" id="4038973">,</span>&nbsp;<span class="ident" id="4038975">mi</span><span class="op" id="4038977">+</span><span class="num" id="4038978">1</span>&nbsp;<span class="op" id="4038980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4038985">ma</span>&nbsp;<span class="op" id="4038988">:=</span>&nbsp;<span class="builtintype" id="4038991">uint32</span><span class="op" id="4038997">(</span><span class="ident" id="4038998">mask</span><span class="op" id="4039002">.</span><span class="ident" id="4039003">Pix</span><span class="op" id="4039006">[</span><span class="ident" id="4039007">mi</span><span class="op" id="4039009">]</span><span class="op" id="4039010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4039015">if</span>&nbsp;<span class="ident" id="4039018">ma</span>&nbsp;<span class="op" id="4039021">==</span>&nbsp;<span class="num" id="4039024">0</span>&nbsp;<span class="op" id="4039026">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4039032">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4039044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039049">ma</span>&nbsp;<span class="op" id="4039052">|=</span>&nbsp;<span class="ident" id="4039055">ma</span>&nbsp;<span class="op" id="4039058">&lt;&lt;</span>&nbsp;<span class="num" id="4039061">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039067">dr</span>&nbsp;<span class="op" id="4039070">:=</span>&nbsp;<span class="builtintype" id="4039073">uint32</span><span class="op" id="4039079">(</span><span class="ident" id="4039080">dst</span><span class="op" id="4039083">.</span><span class="ident" id="4039084">Pix</span><span class="op" id="4039087">[</span><span class="ident" id="4039088">i</span><span class="op" id="4039089">+</span><span class="num" id="4039090">0</span><span class="op" id="4039091">]</span><span class="op" id="4039092">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039097">dg</span>&nbsp;<span class="op" id="4039100">:=</span>&nbsp;<span class="builtintype" id="4039103">uint32</span><span class="op" id="4039109">(</span><span class="ident" id="4039110">dst</span><span class="op" id="4039113">.</span><span class="ident" id="4039114">Pix</span><span class="op" id="4039117">[</span><span class="ident" id="4039118">i</span><span class="op" id="4039119">+</span><span class="num" id="4039120">1</span><span class="op" id="4039121">]</span><span class="op" id="4039122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039127">db</span>&nbsp;<span class="op" id="4039130">:=</span>&nbsp;<span class="builtintype" id="4039133">uint32</span><span class="op" id="4039139">(</span><span class="ident" id="4039140">dst</span><span class="op" id="4039143">.</span><span class="ident" id="4039144">Pix</span><span class="op" id="4039147">[</span><span class="ident" id="4039148">i</span><span class="op" id="4039149">+</span><span class="num" id="4039150">2</span><span class="op" id="4039151">]</span><span class="op" id="4039152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039157">da</span>&nbsp;<span class="op" id="4039160">:=</span>&nbsp;<span class="builtintype" id="4039163">uint32</span><span class="op" id="4039169">(</span><span class="ident" id="4039170">dst</span><span class="op" id="4039173">.</span><span class="ident" id="4039174">Pix</span><span class="op" id="4039177">[</span><span class="ident" id="4039178">i</span><span class="op" id="4039179">+</span><span class="num" id="4039180">3</span><span class="op" id="4039181">]</span><span class="op" id="4039182">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4039188">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039248">a</span>&nbsp;<span class="op" id="4039250">:=</span>&nbsp;<span class="op" id="4039253">(</span><span class="ident" id="4039254">m</span>&nbsp;<span class="op" id="4039256">-</span>&nbsp;<span class="op" id="4039258">(</span><span class="ident" id="4039259">sa</span>&nbsp;<span class="op" id="4039262">*</span>&nbsp;<span class="ident" id="4039264">ma</span>&nbsp;<span class="op" id="4039267">/</span>&nbsp;<span class="ident" id="4039269">m</span><span class="op" id="4039270">)</span><span class="op" id="4039271">)</span>&nbsp;<span class="op" id="4039273">*</span>&nbsp;<span class="num" id="4039275">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039285">dst</span><span class="op" id="4039288">.</span><span class="ident" id="4039289">Pix</span><span class="op" id="4039292">[</span><span class="ident" id="4039293">i</span><span class="op" id="4039294">+</span><span class="num" id="4039295">0</span><span class="op" id="4039296">]</span>&nbsp;<span class="op" id="4039298">=</span>&nbsp;<span class="builtintype" id="4039300">uint8</span><span class="op" id="4039305">(</span><span class="op" id="4039306">(</span><span class="ident" id="4039307">dr</span><span class="op" id="4039309">*</span><span class="ident" id="4039310">a</span>&nbsp;<span class="op" id="4039312">+</span>&nbsp;<span class="ident" id="4039314">sr</span><span class="op" id="4039316">*</span><span class="ident" id="4039317">ma</span><span class="op" id="4039319">)</span>&nbsp;<span class="op" id="4039321">/</span>&nbsp;<span class="ident" id="4039323">m</span>&nbsp;<span class="op" id="4039325">&gt;&gt;</span>&nbsp;<span class="num" id="4039328">8</span><span class="op" id="4039329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039334">dst</span><span class="op" id="4039337">.</span><span class="ident" id="4039338">Pix</span><span class="op" id="4039341">[</span><span class="ident" id="4039342">i</span><span class="op" id="4039343">+</span><span class="num" id="4039344">1</span><span class="op" id="4039345">]</span>&nbsp;<span class="op" id="4039347">=</span>&nbsp;<span class="builtintype" id="4039349">uint8</span><span class="op" id="4039354">(</span><span class="op" id="4039355">(</span><span class="ident" id="4039356">dg</span><span class="op" id="4039358">*</span><span class="ident" id="4039359">a</span>&nbsp;<span class="op" id="4039361">+</span>&nbsp;<span class="ident" id="4039363">sg</span><span class="op" id="4039365">*</span><span class="ident" id="4039366">ma</span><span class="op" id="4039368">)</span>&nbsp;<span class="op" id="4039370">/</span>&nbsp;<span class="ident" id="4039372">m</span>&nbsp;<span class="op" id="4039374">&gt;&gt;</span>&nbsp;<span class="num" id="4039377">8</span><span class="op" id="4039378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039383">dst</span><span class="op" id="4039386">.</span><span class="ident" id="4039387">Pix</span><span class="op" id="4039390">[</span><span class="ident" id="4039391">i</span><span class="op" id="4039392">+</span><span class="num" id="4039393">2</span><span class="op" id="4039394">]</span>&nbsp;<span class="op" id="4039396">=</span>&nbsp;<span class="builtintype" id="4039398">uint8</span><span class="op" id="4039403">(</span><span class="op" id="4039404">(</span><span class="ident" id="4039405">db</span><span class="op" id="4039407">*</span><span class="ident" id="4039408">a</span>&nbsp;<span class="op" id="4039410">+</span>&nbsp;<span class="ident" id="4039412">sb</span><span class="op" id="4039414">*</span><span class="ident" id="4039415">ma</span><span class="op" id="4039417">)</span>&nbsp;<span class="op" id="4039419">/</span>&nbsp;<span class="ident" id="4039421">m</span>&nbsp;<span class="op" id="4039423">&gt;&gt;</span>&nbsp;<span class="num" id="4039426">8</span><span class="op" id="4039427">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039432">dst</span><span class="op" id="4039435">.</span><span class="ident" id="4039436">Pix</span><span class="op" id="4039439">[</span><span class="ident" id="4039440">i</span><span class="op" id="4039441">+</span><span class="num" id="4039442">3</span><span class="op" id="4039443">]</span>&nbsp;<span class="op" id="4039445">=</span>&nbsp;<span class="builtintype" id="4039447">uint8</span><span class="op" id="4039452">(</span><span class="op" id="4039453">(</span><span class="ident" id="4039454">da</span><span class="op" id="4039456">*</span><span class="ident" id="4039457">a</span>&nbsp;<span class="op" id="4039459">+</span>&nbsp;<span class="ident" id="4039461">sa</span><span class="op" id="4039463">*</span><span class="ident" id="4039464">ma</span><span class="op" id="4039466">)</span>&nbsp;<span class="op" id="4039468">/</span>&nbsp;<span class="ident" id="4039470">m</span>&nbsp;<span class="op" id="4039472">&gt;&gt;</span>&nbsp;<span class="num" id="4039475">8</span><span class="op" id="4039476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4039480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039484">i0</span>&nbsp;<span class="op" id="4039487">+=</span>&nbsp;<span class="ident" id="4039490">dst</span><span class="op" id="4039493">.</span><span class="ident" id="4039494">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039503">i1</span>&nbsp;<span class="op" id="4039506">+=</span>&nbsp;<span class="ident" id="4039509">dst</span><span class="op" id="4039512">.</span><span class="ident" id="4039513">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039522">mi0</span>&nbsp;<span class="op" id="4039526">+=</span>&nbsp;<span class="ident" id="4039529">mask</span><span class="op" id="4039533">.</span><span class="ident" id="4039534">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4039542">}</span><br>
<span class="lineno"></span><span class="op" id="4039544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4039547">func</span>&nbsp;<span class="ident" id="4039552">drawRGBA</span><span class="op" id="4039560">(</span><span class="ident" id="4039561">dst</span>&nbsp;<span class="op" id="4039565">*</span><span class="ident" id="4039566">image</span><span class="op" id="4039571">.</span><span class="ident" id="4039572">RGBA</span><span class="op" id="4039576">,</span>&nbsp;<span class="ident" id="4039578">r</span>&nbsp;<span class="ident" id="4039580">image</span><span class="op" id="4039585">.</span><span class="ident" id="4039586">Rectangle</span><span class="op" id="4039595">,</span>&nbsp;<span class="ident" id="4039597">src</span>&nbsp;<span class="ident" id="4039601">image</span><span class="op" id="4039606">.</span><span class="ident" id="4039607">Image</span><span class="op" id="4039612">,</span>&nbsp;<span class="ident" id="4039614">sp</span>&nbsp;<span class="ident" id="4039617">image</span><span class="op" id="4039622">.</span><span class="ident" id="4039623">Point</span><span class="op" id="4039628">,</span>&nbsp;<span class="ident" id="4039630">mask</span>&nbsp;<span class="ident" id="4039635">image</span><span class="op" id="4039640">.</span><span class="ident" id="4039641">Image</span><span class="op" id="4039646">,</span>&nbsp;<span class="ident" id="4039648">mp</span>&nbsp;<span class="ident" id="4039651">image</span><span class="op" id="4039656">.</span><span class="ident" id="4039657">Point</span><span class="op" id="4039662">,</span>&nbsp;<span class="ident" id="4039664">op</span>&nbsp;<span class="ident" id="4039667">Op</span><span class="op" id="4039669">)</span>&nbsp;<span class="op" id="4039671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039674">x0</span><span class="op" id="4039676">,</span>&nbsp;<span class="ident" id="4039678">x1</span><span class="op" id="4039680">,</span>&nbsp;<span class="ident" id="4039682">dx</span>&nbsp;<span class="op" id="4039685">:=</span>&nbsp;<span class="ident" id="4039688">r</span><span class="op" id="4039689">.</span><span class="ident" id="4039690">Min</span><span class="op" id="4039693">.</span><span class="ident" id="4039694">X</span><span class="op" id="4039695">,</span>&nbsp;<span class="ident" id="4039697">r</span><span class="op" id="4039698">.</span><span class="ident" id="4039699">Max</span><span class="op" id="4039702">.</span><span class="ident" id="4039703">X</span><span class="op" id="4039704">,</span>&nbsp;<span class="num" id="4039706">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039709">y0</span><span class="op" id="4039711">,</span>&nbsp;<span class="ident" id="4039713">y1</span><span class="op" id="4039715">,</span>&nbsp;<span class="ident" id="4039717">dy</span>&nbsp;<span class="op" id="4039720">:=</span>&nbsp;<span class="ident" id="4039723">r</span><span class="op" id="4039724">.</span><span class="ident" id="4039725">Min</span><span class="op" id="4039728">.</span><span class="ident" id="4039729">Y</span><span class="op" id="4039730">,</span>&nbsp;<span class="ident" id="4039732">r</span><span class="op" id="4039733">.</span><span class="ident" id="4039734">Max</span><span class="op" id="4039737">.</span><span class="ident" id="4039738">Y</span><span class="op" id="4039739">,</span>&nbsp;<span class="num" id="4039741">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4039744">if</span>&nbsp;<span class="ident" id="4039747">image</span><span class="op" id="4039752">.</span><span class="ident" id="4039753">Image</span><span class="op" id="4039758">(</span><span class="ident" id="4039759">dst</span><span class="op" id="4039762">)</span>&nbsp;<span class="op" id="4039764">==</span>&nbsp;<span class="ident" id="4039767">src</span>&nbsp;<span class="op" id="4039771">&amp;&amp;</span>&nbsp;<span class="ident" id="4039774">r</span><span class="op" id="4039775">.</span><span class="ident" id="4039776">Overlaps</span><span class="op" id="4039784">(</span><span class="ident" id="4039785">r</span><span class="op" id="4039786">.</span><span class="ident" id="4039787">Add</span><span class="op" id="4039790">(</span><span class="ident" id="4039791">sp</span><span class="op" id="4039793">.</span><span class="ident" id="4039794">Sub</span><span class="op" id="4039797">(</span><span class="ident" id="4039798">r</span><span class="op" id="4039799">.</span><span class="ident" id="4039800">Min</span><span class="op" id="4039803">)</span><span class="op" id="4039804">)</span><span class="op" id="4039805">)</span>&nbsp;<span class="op" id="4039807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4039811">if</span>&nbsp;<span class="ident" id="4039814">sp</span><span class="op" id="4039816">.</span><span class="ident" id="4039817">Y</span>&nbsp;<span class="op" id="4039819">&lt;</span>&nbsp;<span class="ident" id="4039821">r</span><span class="op" id="4039822">.</span><span class="ident" id="4039823">Min</span><span class="op" id="4039826">.</span><span class="ident" id="4039827">Y</span>&nbsp;<span class="op" id="4039829">||</span>&nbsp;<span class="ident" id="4039832">sp</span><span class="op" id="4039834">.</span><span class="ident" id="4039835">Y</span>&nbsp;<span class="op" id="4039837">==</span>&nbsp;<span class="ident" id="4039840">r</span><span class="op" id="4039841">.</span><span class="ident" id="4039842">Min</span><span class="op" id="4039845">.</span><span class="ident" id="4039846">Y</span>&nbsp;<span class="op" id="4039848">&amp;&amp;</span>&nbsp;<span class="ident" id="4039851">sp</span><span class="op" id="4039853">.</span><span class="ident" id="4039854">X</span>&nbsp;<span class="op" id="4039856">&lt;</span>&nbsp;<span class="ident" id="4039858">r</span><span class="op" id="4039859">.</span><span class="ident" id="4039860">Min</span><span class="op" id="4039863">.</span><span class="ident" id="4039864">X</span>&nbsp;<span class="op" id="4039866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039871">x0</span><span class="op" id="4039873">,</span>&nbsp;<span class="ident" id="4039875">x1</span><span class="op" id="4039877">,</span>&nbsp;<span class="ident" id="4039879">dx</span>&nbsp;<span class="op" id="4039882">=</span>&nbsp;<span class="ident" id="4039884">x1</span><span class="op" id="4039886">-</span><span class="num" id="4039887">1</span><span class="op" id="4039888">,</span>&nbsp;<span class="ident" id="4039890">x0</span><span class="op" id="4039892">-</span><span class="num" id="4039893">1</span><span class="op" id="4039894">,</span>&nbsp;<span class="op" id="4039896">-</span><span class="num" id="4039897">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039902">y0</span><span class="op" id="4039904">,</span>&nbsp;<span class="ident" id="4039906">y1</span><span class="op" id="4039908">,</span>&nbsp;<span class="ident" id="4039910">dy</span>&nbsp;<span class="op" id="4039913">=</span>&nbsp;<span class="ident" id="4039915">y1</span><span class="op" id="4039917">-</span><span class="num" id="4039918">1</span><span class="op" id="4039919">,</span>&nbsp;<span class="ident" id="4039921">y0</span><span class="op" id="4039923">-</span><span class="num" id="4039924">1</span><span class="op" id="4039925">,</span>&nbsp;<span class="op" id="4039927">-</span><span class="num" id="4039928">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4039932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4039935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039939">sy</span>&nbsp;<span class="op" id="4039942">:=</span>&nbsp;<span class="ident" id="4039945">sp</span><span class="op" id="4039947">.</span><span class="ident" id="4039948">Y</span>&nbsp;<span class="op" id="4039950">+</span>&nbsp;<span class="ident" id="4039952">y0</span>&nbsp;<span class="op" id="4039955">-</span>&nbsp;<span class="ident" id="4039957">r</span><span class="op" id="4039958">.</span><span class="ident" id="4039959">Min</span><span class="op" id="4039962">.</span><span class="ident" id="4039963">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039966">my</span>&nbsp;<span class="op" id="4039969">:=</span>&nbsp;<span class="ident" id="4039972">mp</span><span class="op" id="4039974">.</span><span class="ident" id="4039975">Y</span>&nbsp;<span class="op" id="4039977">+</span>&nbsp;<span class="ident" id="4039979">y0</span>&nbsp;<span class="op" id="4039982">-</span>&nbsp;<span class="ident" id="4039984">r</span><span class="op" id="4039985">.</span><span class="ident" id="4039986">Min</span><span class="op" id="4039989">.</span><span class="ident" id="4039990">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4039993">sx0</span>&nbsp;<span class="op" id="4039997">:=</span>&nbsp;<span class="ident" id="4040000">sp</span><span class="op" id="4040002">.</span><span class="ident" id="4040003">X</span>&nbsp;<span class="op" id="4040005">+</span>&nbsp;<span class="ident" id="4040007">x0</span>&nbsp;<span class="op" id="4040010">-</span>&nbsp;<span class="ident" id="4040012">r</span><span class="op" id="4040013">.</span><span class="ident" id="4040014">Min</span><span class="op" id="4040017">.</span><span class="ident" id="4040018">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040021">mx0</span>&nbsp;<span class="op" id="4040025">:=</span>&nbsp;<span class="ident" id="4040028">mp</span><span class="op" id="4040030">.</span><span class="ident" id="4040031">X</span>&nbsp;<span class="op" id="4040033">+</span>&nbsp;<span class="ident" id="4040035">x0</span>&nbsp;<span class="op" id="4040038">-</span>&nbsp;<span class="ident" id="4040040">r</span><span class="op" id="4040041">.</span><span class="ident" id="4040042">Min</span><span class="op" id="4040045">.</span><span class="ident" id="4040046">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040049">sx1</span>&nbsp;<span class="op" id="4040053">:=</span>&nbsp;<span class="ident" id="4040056">sx0</span>&nbsp;<span class="op" id="4040060">+</span>&nbsp;<span class="op" id="4040062">(</span><span class="ident" id="4040063">x1</span>&nbsp;<span class="op" id="4040066">-</span>&nbsp;<span class="ident" id="4040068">x0</span><span class="op" id="4040070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040073">i0</span>&nbsp;<span class="op" id="4040076">:=</span>&nbsp;<span class="ident" id="4040079">dst</span><span class="op" id="4040082">.</span><span class="ident" id="4040083">PixOffset</span><span class="op" id="4040092">(</span><span class="ident" id="4040093">x0</span><span class="op" id="4040095">,</span>&nbsp;<span class="ident" id="4040097">y0</span><span class="op" id="4040099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040102">di</span>&nbsp;<span class="op" id="4040105">:=</span>&nbsp;<span class="ident" id="4040108">dx</span>&nbsp;<span class="op" id="4040111">*</span>&nbsp;<span class="num" id="4040113">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4040116">for</span>&nbsp;<span class="ident" id="4040120">y</span>&nbsp;<span class="op" id="4040122">:=</span>&nbsp;<span class="ident" id="4040125">y0</span><span class="op" id="4040127">;</span>&nbsp;<span class="ident" id="4040129">y</span>&nbsp;<span class="op" id="4040131">!=</span>&nbsp;<span class="ident" id="4040134">y1</span><span class="op" id="4040136">;</span>&nbsp;<span class="ident" id="4040138">y</span><span class="op" id="4040139">,</span>&nbsp;<span class="ident" id="4040141">sy</span><span class="op" id="4040143">,</span>&nbsp;<span class="ident" id="4040145">my</span>&nbsp;<span class="op" id="4040148">=</span>&nbsp;<span class="ident" id="4040150">y</span><span class="op" id="4040151">+</span><span class="ident" id="4040152">dy</span><span class="op" id="4040154">,</span>&nbsp;<span class="ident" id="4040156">sy</span><span class="op" id="4040158">+</span><span class="ident" id="4040159">dy</span><span class="op" id="4040161">,</span>&nbsp;<span class="ident" id="4040163">my</span><span class="op" id="4040165">+</span><span class="ident" id="4040166">dy</span>&nbsp;<span class="op" id="4040169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4040173">for</span>&nbsp;<span class="ident" id="4040177">i</span><span class="op" id="4040178">,</span>&nbsp;<span class="ident" id="4040180">sx</span><span class="op" id="4040182">,</span>&nbsp;<span class="ident" id="4040184">mx</span>&nbsp;<span class="op" id="4040187">:=</span>&nbsp;<span class="ident" id="4040190">i0</span><span class="op" id="4040192">,</span>&nbsp;<span class="ident" id="4040194">sx0</span><span class="op" id="4040197">,</span>&nbsp;<span class="ident" id="4040199">mx0</span><span class="op" id="4040202">;</span>&nbsp;<span class="ident" id="4040204">sx</span>&nbsp;<span class="op" id="4040207">!=</span>&nbsp;<span class="ident" id="4040210">sx1</span><span class="op" id="4040213">;</span>&nbsp;<span class="ident" id="4040215">i</span><span class="op" id="4040216">,</span>&nbsp;<span class="ident" id="4040218">sx</span><span class="op" id="4040220">,</span>&nbsp;<span class="ident" id="4040222">mx</span>&nbsp;<span class="op" id="4040225">=</span>&nbsp;<span class="ident" id="4040227">i</span><span class="op" id="4040228">+</span><span class="ident" id="4040229">di</span><span class="op" id="4040231">,</span>&nbsp;<span class="ident" id="4040233">sx</span><span class="op" id="4040235">+</span><span class="ident" id="4040236">dx</span><span class="op" id="4040238">,</span>&nbsp;<span class="ident" id="4040240">mx</span><span class="op" id="4040242">+</span><span class="ident" id="4040243">dx</span>&nbsp;<span class="op" id="4040246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040251">ma</span>&nbsp;<span class="op" id="4040254">:=</span>&nbsp;<span class="builtintype" id="4040257">uint32</span><span class="op" id="4040263">(</span><span class="ident" id="4040264">m</span><span class="op" id="4040265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4040270">if</span>&nbsp;<span class="ident" id="4040273">mask</span>&nbsp;<span class="op" id="4040278">!=</span>&nbsp;<span class="ident" id="4040281">nil</span>&nbsp;<span class="op" id="4040285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040291">_</span><span class="op" id="4040292">,</span>&nbsp;<span class="ident" id="4040294">_</span><span class="op" id="4040295">,</span>&nbsp;<span class="ident" id="4040297">_</span><span class="op" id="4040298">,</span>&nbsp;<span class="ident" id="4040300">ma</span>&nbsp;<span class="op" id="4040303">=</span>&nbsp;<span class="ident" id="4040305">mask</span><span class="op" id="4040309">.</span><span class="ident" id="4040310">At</span><span class="op" id="4040312">(</span><span class="ident" id="4040313">mx</span><span class="op" id="4040315">,</span>&nbsp;<span class="ident" id="4040317">my</span><span class="op" id="4040319">)</span><span class="op" id="4040320">.</span><span class="ident" id="4040321">RGBA</span><span class="op" id="4040325">(</span><span class="op" id="4040326">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4040331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040336">sr</span><span class="op" id="4040338">,</span>&nbsp;<span class="ident" id="4040340">sg</span><span class="op" id="4040342">,</span>&nbsp;<span class="ident" id="4040344">sb</span><span class="op" id="4040346">,</span>&nbsp;<span class="ident" id="4040348">sa</span>&nbsp;<span class="op" id="4040351">:=</span>&nbsp;<span class="ident" id="4040354">src</span><span class="op" id="4040357">.</span><span class="ident" id="4040358">At</span><span class="op" id="4040360">(</span><span class="ident" id="4040361">sx</span><span class="op" id="4040363">,</span>&nbsp;<span class="ident" id="4040365">sy</span><span class="op" id="4040367">)</span><span class="op" id="4040368">.</span><span class="ident" id="4040369">RGBA</span><span class="op" id="4040373">(</span><span class="op" id="4040374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4040379">if</span>&nbsp;<span class="ident" id="4040382">op</span>&nbsp;<span class="op" id="4040385">==</span>&nbsp;<span class="ident" id="4040388">Over</span>&nbsp;<span class="op" id="4040393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040399">dr</span>&nbsp;<span class="op" id="4040402">:=</span>&nbsp;<span class="builtintype" id="4040405">uint32</span><span class="op" id="4040411">(</span><span class="ident" id="4040412">dst</span><span class="op" id="4040415">.</span><span class="ident" id="4040416">Pix</span><span class="op" id="4040419">[</span><span class="ident" id="4040420">i</span><span class="op" id="4040421">+</span><span class="num" id="4040422">0</span><span class="op" id="4040423">]</span><span class="op" id="4040424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040430">dg</span>&nbsp;<span class="op" id="4040433">:=</span>&nbsp;<span class="builtintype" id="4040436">uint32</span><span class="op" id="4040442">(</span><span class="ident" id="4040443">dst</span><span class="op" id="4040446">.</span><span class="ident" id="4040447">Pix</span><span class="op" id="4040450">[</span><span class="ident" id="4040451">i</span><span class="op" id="4040452">+</span><span class="num" id="4040453">1</span><span class="op" id="4040454">]</span><span class="op" id="4040455">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040461">db</span>&nbsp;<span class="op" id="4040464">:=</span>&nbsp;<span class="builtintype" id="4040467">uint32</span><span class="op" id="4040473">(</span><span class="ident" id="4040474">dst</span><span class="op" id="4040477">.</span><span class="ident" id="4040478">Pix</span><span class="op" id="4040481">[</span><span class="ident" id="4040482">i</span><span class="op" id="4040483">+</span><span class="num" id="4040484">2</span><span class="op" id="4040485">]</span><span class="op" id="4040486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040492">da</span>&nbsp;<span class="op" id="4040495">:=</span>&nbsp;<span class="builtintype" id="4040498">uint32</span><span class="op" id="4040504">(</span><span class="ident" id="4040505">dst</span><span class="op" id="4040508">.</span><span class="ident" id="4040509">Pix</span><span class="op" id="4040512">[</span><span class="ident" id="4040513">i</span><span class="op" id="4040514">+</span><span class="num" id="4040515">3</span><span class="op" id="4040516">]</span><span class="op" id="4040517">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4040524">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4040604">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4040662">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4040683">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4040749">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4040814">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040886">a</span>&nbsp;<span class="op" id="4040888">:=</span>&nbsp;<span class="op" id="4040891">(</span><span class="ident" id="4040892">m</span>&nbsp;<span class="op" id="4040894">-</span>&nbsp;<span class="op" id="4040896">(</span><span class="ident" id="4040897">sa</span>&nbsp;<span class="op" id="4040900">*</span>&nbsp;<span class="ident" id="4040902">ma</span>&nbsp;<span class="op" id="4040905">/</span>&nbsp;<span class="ident" id="4040907">m</span><span class="op" id="4040908">)</span><span class="op" id="4040909">)</span>&nbsp;<span class="op" id="4040911">*</span>&nbsp;<span class="num" id="4040913">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040924">dst</span><span class="op" id="4040927">.</span><span class="ident" id="4040928">Pix</span><span class="op" id="4040931">[</span><span class="ident" id="4040932">i</span><span class="op" id="4040933">+</span><span class="num" id="4040934">0</span><span class="op" id="4040935">]</span>&nbsp;<span class="op" id="4040937">=</span>&nbsp;<span class="builtintype" id="4040939">uint8</span><span class="op" id="4040944">(</span><span class="op" id="4040945">(</span><span class="ident" id="4040946">dr</span><span class="op" id="4040948">*</span><span class="ident" id="4040949">a</span>&nbsp;<span class="op" id="4040951">+</span>&nbsp;<span class="ident" id="4040953">sr</span><span class="op" id="4040955">*</span><span class="ident" id="4040956">ma</span><span class="op" id="4040958">)</span>&nbsp;<span class="op" id="4040960">/</span>&nbsp;<span class="ident" id="4040962">m</span>&nbsp;<span class="op" id="4040964">&gt;&gt;</span>&nbsp;<span class="num" id="4040967">8</span><span class="op" id="4040968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4040974">dst</span><span class="op" id="4040977">.</span><span class="ident" id="4040978">Pix</span><span class="op" id="4040981">[</span><span class="ident" id="4040982">i</span><span class="op" id="4040983">+</span><span class="num" id="4040984">1</span><span class="op" id="4040985">]</span>&nbsp;<span class="op" id="4040987">=</span>&nbsp;<span class="builtintype" id="4040989">uint8</span><span class="op" id="4040994">(</span><span class="op" id="4040995">(</span><span class="ident" id="4040996">dg</span><span class="op" id="4040998">*</span><span class="ident" id="4040999">a</span>&nbsp;<span class="op" id="4041001">+</span>&nbsp;<span class="ident" id="4041003">sg</span><span class="op" id="4041005">*</span><span class="ident" id="4041006">ma</span><span class="op" id="4041008">)</span>&nbsp;<span class="op" id="4041010">/</span>&nbsp;<span class="ident" id="4041012">m</span>&nbsp;<span class="op" id="4041014">&gt;&gt;</span>&nbsp;<span class="num" id="4041017">8</span><span class="op" id="4041018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041024">dst</span><span class="op" id="4041027">.</span><span class="ident" id="4041028">Pix</span><span class="op" id="4041031">[</span><span class="ident" id="4041032">i</span><span class="op" id="4041033">+</span><span class="num" id="4041034">2</span><span class="op" id="4041035">]</span>&nbsp;<span class="op" id="4041037">=</span>&nbsp;<span class="builtintype" id="4041039">uint8</span><span class="op" id="4041044">(</span><span class="op" id="4041045">(</span><span class="ident" id="4041046">db</span><span class="op" id="4041048">*</span><span class="ident" id="4041049">a</span>&nbsp;<span class="op" id="4041051">+</span>&nbsp;<span class="ident" id="4041053">sb</span><span class="op" id="4041055">*</span><span class="ident" id="4041056">ma</span><span class="op" id="4041058">)</span>&nbsp;<span class="op" id="4041060">/</span>&nbsp;<span class="ident" id="4041062">m</span>&nbsp;<span class="op" id="4041064">&gt;&gt;</span>&nbsp;<span class="num" id="4041067">8</span><span class="op" id="4041068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041074">dst</span><span class="op" id="4041077">.</span><span class="ident" id="4041078">Pix</span><span class="op" id="4041081">[</span><span class="ident" id="4041082">i</span><span class="op" id="4041083">+</span><span class="num" id="4041084">3</span><span class="op" id="4041085">]</span>&nbsp;<span class="op" id="4041087">=</span>&nbsp;<span class="builtintype" id="4041089">uint8</span><span class="op" id="4041094">(</span><span class="op" id="4041095">(</span><span class="ident" id="4041096">da</span><span class="op" id="4041098">*</span><span class="ident" id="4041099">a</span>&nbsp;<span class="op" id="4041101">+</span>&nbsp;<span class="ident" id="4041103">sa</span><span class="op" id="4041105">*</span><span class="ident" id="4041106">ma</span><span class="op" id="4041108">)</span>&nbsp;<span class="op" id="4041110">/</span>&nbsp;<span class="ident" id="4041112">m</span>&nbsp;<span class="op" id="4041114">&gt;&gt;</span>&nbsp;<span class="num" id="4041117">8</span><span class="op" id="4041118">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4041124">}</span>&nbsp;<span class="keyword" id="4041126">else</span>&nbsp;<span class="op" id="4041131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041137">dst</span><span class="op" id="4041140">.</span><span class="ident" id="4041141">Pix</span><span class="op" id="4041144">[</span><span class="ident" id="4041145">i</span><span class="op" id="4041146">+</span><span class="num" id="4041147">0</span><span class="op" id="4041148">]</span>&nbsp;<span class="op" id="4041150">=</span>&nbsp;<span class="builtintype" id="4041152">uint8</span><span class="op" id="4041157">(</span><span class="ident" id="4041158">sr</span>&nbsp;<span class="op" id="4041161">*</span>&nbsp;<span class="ident" id="4041163">ma</span>&nbsp;<span class="op" id="4041166">/</span>&nbsp;<span class="ident" id="4041168">m</span>&nbsp;<span class="op" id="4041170">&gt;&gt;</span>&nbsp;<span class="num" id="4041173">8</span><span class="op" id="4041174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041180">dst</span><span class="op" id="4041183">.</span><span class="ident" id="4041184">Pix</span><span class="op" id="4041187">[</span><span class="ident" id="4041188">i</span><span class="op" id="4041189">+</span><span class="num" id="4041190">1</span><span class="op" id="4041191">]</span>&nbsp;<span class="op" id="4041193">=</span>&nbsp;<span class="builtintype" id="4041195">uint8</span><span class="op" id="4041200">(</span><span class="ident" id="4041201">sg</span>&nbsp;<span class="op" id="4041204">*</span>&nbsp;<span class="ident" id="4041206">ma</span>&nbsp;<span class="op" id="4041209">/</span>&nbsp;<span class="ident" id="4041211">m</span>&nbsp;<span class="op" id="4041213">&gt;&gt;</span>&nbsp;<span class="num" id="4041216">8</span><span class="op" id="4041217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041223">dst</span><span class="op" id="4041226">.</span><span class="ident" id="4041227">Pix</span><span class="op" id="4041230">[</span><span class="ident" id="4041231">i</span><span class="op" id="4041232">+</span><span class="num" id="4041233">2</span><span class="op" id="4041234">]</span>&nbsp;<span class="op" id="4041236">=</span>&nbsp;<span class="builtintype" id="4041238">uint8</span><span class="op" id="4041243">(</span><span class="ident" id="4041244">sb</span>&nbsp;<span class="op" id="4041247">*</span>&nbsp;<span class="ident" id="4041249">ma</span>&nbsp;<span class="op" id="4041252">/</span>&nbsp;<span class="ident" id="4041254">m</span>&nbsp;<span class="op" id="4041256">&gt;&gt;</span>&nbsp;<span class="num" id="4041259">8</span><span class="op" id="4041260">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041266">dst</span><span class="op" id="4041269">.</span><span class="ident" id="4041270">Pix</span><span class="op" id="4041273">[</span><span class="ident" id="4041274">i</span><span class="op" id="4041275">+</span><span class="num" id="4041276">3</span><span class="op" id="4041277">]</span>&nbsp;<span class="op" id="4041279">=</span>&nbsp;<span class="builtintype" id="4041281">uint8</span><span class="op" id="4041286">(</span><span class="ident" id="4041287">sa</span>&nbsp;<span class="op" id="4041290">*</span>&nbsp;<span class="ident" id="4041292">ma</span>&nbsp;<span class="op" id="4041295">/</span>&nbsp;<span class="ident" id="4041297">m</span>&nbsp;<span class="op" id="4041299">&gt;&gt;</span>&nbsp;<span class="num" id="4041302">8</span><span class="op" id="4041303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4041308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4041312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4041316">i0</span>&nbsp;<span class="op" id="4041319">+=</span>&nbsp;<span class="ident" id="4041322">dy</span>&nbsp;<span class="op" id="4041325">*</span>&nbsp;<span class="ident" id="4041327">dst</span><span class="op" id="4041330">.</span><span class="ident" id="4041331">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4041339">}</span><br>
<span class="lineno">545</span><span class="op" id="4041341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4041344">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="4041391">func</span>&nbsp;<span class="ident" id="4041396">clamp</span><span class="op" id="4041401">(</span><span class="ident" id="4041402">i</span>&nbsp;<span class="builtintype" id="4041404">int32</span><span class="op" id="4041409">)</span>&nbsp;<span class="builtintype" id="4041411">int32</span>&nbsp;<span class="op" id="4041417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4041420">if</span>&nbsp;<span class="ident" id="4041423">i</span>&nbsp;<span class="op" id="4041425">&lt;</span>&nbsp;<span class="num" id="4041427">0</span>&nbsp;<span class="op" id="4041429">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4041433">return</span>&nbsp;<span class="num" id="4041440">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4041443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4041446">if</span>&nbsp;<span class="ident" id="4041449">i</span>&nbsp;<span class="op" id="4041451">&gt;</span>&nbsp;<span class="num" id="4041453">0xffff</span>&nbsp;<span class="op" id="4041460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4041464">return</span>&nbsp;<span class="num" id="4041471">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4041479">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4041482">return</span>&nbsp;<span class="ident" id="4041489">i</span><br>
<span class="lineno"></span><span class="op" id="4041491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4041494">func</span>&nbsp;<span class="ident" id="4041499">drawPaletted</span><span class="op" id="4041511">(</span><span class="ident" id="4041512">dst</span>&nbsp;<span class="ident" id="4041516">Image</span><span class="op" id="4041521">,</span>&nbsp;<span class="ident" id="4041523">r</span>&nbsp;<span class="ident" id="4041525">image</span><span class="op" id="4041530">.</span><span class="ident" id="4041531">Rectangle</span><span class="op" id="4041540">,</span>&nbsp;<span class="ident" id="4041542">src</span>&nbsp;<span class="ident" id="4041546">image</span><span class="op" id="4041551">.</span><span class="ident" id="4041552">Image</span><span class="op" id="4041557">,</span>&nbsp;<span class="ident" id="4041559">sp</span>&nbsp;<span class="ident" id="4041562">image</span><span class="op" id="4041567">.</span><span class="ident" id="4041568">Point</span><span class="op" id="4041573">,</span>&nbsp;<span class="ident" id="4041575">floydSteinberg</span>&nbsp;<span class="builtintype" id="4041590">bool</span><span class="op" id="4041594">)</span>&nbsp;<span class="op" id="4041596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4041599">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4041666">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4041731">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4041794">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4041864">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4041935">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042006">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042052">palette</span><span class="op" id="4042059">,</span>&nbsp;<span class="ident" id="4042061">pix</span><span class="op" id="4042064">,</span>&nbsp;<span class="ident" id="4042066">stride</span>&nbsp;<span class="op" id="4042073">:=</span>&nbsp;<span class="op" id="4042076">[</span><span class="op" id="4042077">]</span><span class="op" id="4042078">[</span><span class="num" id="4042079">3</span><span class="op" id="4042080">]</span><span class="builtintype" id="4042081">int32</span><span class="op" id="4042086">(</span><span class="ident" id="4042087">nil</span><span class="op" id="4042090">)</span><span class="op" id="4042091">,</span>&nbsp;<span class="op" id="4042093">[</span><span class="op" id="4042094">]</span><span class="builtintype" id="4042095">byte</span><span class="op" id="4042099">(</span><span class="ident" id="4042100">nil</span><span class="op" id="4042103">)</span><span class="op" id="4042104">,</span>&nbsp;<span class="num" id="4042106">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042109">if</span>&nbsp;<span class="ident" id="4042112">p</span><span class="op" id="4042113">,</span>&nbsp;<span class="ident" id="4042115">ok</span>&nbsp;<span class="op" id="4042118">:=</span>&nbsp;<span class="ident" id="4042121">dst</span><span class="op" id="4042124">.</span><span class="op" id="4042125">(</span><span class="op" id="4042126">*</span><span class="ident" id="4042127">image</span><span class="op" id="4042132">.</span><span class="ident" id="4042133">Paletted</span><span class="op" id="4042141">)</span><span class="op" id="4042142">;</span>&nbsp;<span class="ident" id="4042144">ok</span>&nbsp;<span class="op" id="4042147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042151">palette</span>&nbsp;<span class="op" id="4042159">=</span>&nbsp;<span class="builtinfunc" id="4042161">make</span><span class="op" id="4042165">(</span><span class="op" id="4042166">[</span><span class="op" id="4042167">]</span><span class="op" id="4042168">[</span><span class="num" id="4042169">3</span><span class="op" id="4042170">]</span><span class="builtintype" id="4042171">int32</span><span class="op" id="4042176">,</span>&nbsp;<span class="builtinfunc" id="4042178">len</span><span class="op" id="4042181">(</span><span class="ident" id="4042182">p</span><span class="op" id="4042183">.</span><span class="ident" id="4042184">Palette</span><span class="op" id="4042191">)</span><span class="op" id="4042192">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042196">for</span>&nbsp;<span class="ident" id="4042200">i</span><span class="op" id="4042201">,</span>&nbsp;<span class="ident" id="4042203">col</span>&nbsp;<span class="op" id="4042207">:=</span>&nbsp;<span class="keyword" id="4042210">range</span>&nbsp;<span class="ident" id="4042216">p</span><span class="op" id="4042217">.</span><span class="ident" id="4042218">Palette</span>&nbsp;<span class="op" id="4042226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042231">r</span><span class="op" id="4042232">,</span>&nbsp;<span class="ident" id="4042234">g</span><span class="op" id="4042235">,</span>&nbsp;<span class="ident" id="4042237">b</span><span class="op" id="4042238">,</span>&nbsp;<span class="ident" id="4042240">_</span>&nbsp;<span class="op" id="4042242">:=</span>&nbsp;<span class="ident" id="4042245">col</span><span class="op" id="4042248">.</span><span class="ident" id="4042249">RGBA</span><span class="op" id="4042253">(</span><span class="op" id="4042254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042259">palette</span><span class="op" id="4042266">[</span><span class="ident" id="4042267">i</span><span class="op" id="4042268">]</span><span class="op" id="4042269">[</span><span class="num" id="4042270">0</span><span class="op" id="4042271">]</span>&nbsp;<span class="op" id="4042273">=</span>&nbsp;<span class="builtintype" id="4042275">int32</span><span class="op" id="4042280">(</span><span class="ident" id="4042281">r</span><span class="op" id="4042282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042287">palette</span><span class="op" id="4042294">[</span><span class="ident" id="4042295">i</span><span class="op" id="4042296">]</span><span class="op" id="4042297">[</span><span class="num" id="4042298">1</span><span class="op" id="4042299">]</span>&nbsp;<span class="op" id="4042301">=</span>&nbsp;<span class="builtintype" id="4042303">int32</span><span class="op" id="4042308">(</span><span class="ident" id="4042309">g</span><span class="op" id="4042310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042315">palette</span><span class="op" id="4042322">[</span><span class="ident" id="4042323">i</span><span class="op" id="4042324">]</span><span class="op" id="4042325">[</span><span class="num" id="4042326">2</span><span class="op" id="4042327">]</span>&nbsp;<span class="op" id="4042329">=</span>&nbsp;<span class="builtintype" id="4042331">int32</span><span class="op" id="4042336">(</span><span class="ident" id="4042337">b</span><span class="op" id="4042338">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042346">pix</span><span class="op" id="4042349">,</span>&nbsp;<span class="ident" id="4042351">stride</span>&nbsp;<span class="op" id="4042358">=</span>&nbsp;<span class="ident" id="4042360">p</span><span class="op" id="4042361">.</span><span class="ident" id="4042362">Pix</span><span class="op" id="4042365">[</span><span class="ident" id="4042366">p</span><span class="op" id="4042367">.</span><span class="ident" id="4042368">PixOffset</span><span class="op" id="4042377">(</span><span class="ident" id="4042378">r</span><span class="op" id="4042379">.</span><span class="ident" id="4042380">Min</span><span class="op" id="4042383">.</span><span class="ident" id="4042384">X</span><span class="op" id="4042385">,</span>&nbsp;<span class="ident" id="4042387">r</span><span class="op" id="4042388">.</span><span class="ident" id="4042389">Min</span><span class="op" id="4042392">.</span><span class="ident" id="4042393">Y</span><span class="op" id="4042394">)</span><span class="op" id="4042395">:</span><span class="op" id="4042396">]</span><span class="op" id="4042397">,</span>&nbsp;<span class="ident" id="4042399">p</span><span class="op" id="4042400">.</span><span class="ident" id="4042401">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042413">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042488">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042563">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042619">var</span>&nbsp;<span class="ident" id="4042623">quantErrorCurr</span><span class="op" id="4042637">,</span>&nbsp;<span class="ident" id="4042639">quantErrorNext</span>&nbsp;<span class="op" id="4042654">[</span><span class="op" id="4042655">]</span><span class="op" id="4042656">[</span><span class="num" id="4042657">3</span><span class="op" id="4042658">]</span><span class="builtintype" id="4042659">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042666">if</span>&nbsp;<span class="ident" id="4042669">floydSteinberg</span>&nbsp;<span class="op" id="4042684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042688">quantErrorCurr</span>&nbsp;<span class="op" id="4042703">=</span>&nbsp;<span class="builtinfunc" id="4042705">make</span><span class="op" id="4042709">(</span><span class="op" id="4042710">[</span><span class="op" id="4042711">]</span><span class="op" id="4042712">[</span><span class="num" id="4042713">3</span><span class="op" id="4042714">]</span><span class="builtintype" id="4042715">int32</span><span class="op" id="4042720">,</span>&nbsp;<span class="ident" id="4042722">r</span><span class="op" id="4042723">.</span><span class="ident" id="4042724">Dx</span><span class="op" id="4042726">(</span><span class="op" id="4042727">)</span><span class="op" id="4042728">+</span><span class="num" id="4042729">2</span><span class="op" id="4042730">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042734">quantErrorNext</span>&nbsp;<span class="op" id="4042749">=</span>&nbsp;<span class="builtinfunc" id="4042751">make</span><span class="op" id="4042755">(</span><span class="op" id="4042756">[</span><span class="op" id="4042757">]</span><span class="op" id="4042758">[</span><span class="num" id="4042759">3</span><span class="op" id="4042760">]</span><span class="builtintype" id="4042761">int32</span><span class="op" id="4042766">,</span>&nbsp;<span class="ident" id="4042768">r</span><span class="op" id="4042769">.</span><span class="ident" id="4042770">Dx</span><span class="op" id="4042772">(</span><span class="op" id="4042773">)</span><span class="op" id="4042774">+</span><span class="num" id="4042775">2</span><span class="op" id="4042776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4042779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042783">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4042816">out</span>&nbsp;<span class="op" id="4042820">:=</span>&nbsp;<span class="ident" id="4042823">color</span><span class="op" id="4042828">.</span><span class="ident" id="4042829">RGBA64</span><span class="op" id="4042835">{</span><span class="ident" id="4042836">A</span><span class="op" id="4042837">:</span>&nbsp;<span class="num" id="4042839">0xffff</span><span class="op" id="4042845">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042848">for</span>&nbsp;<span class="ident" id="4042852">y</span>&nbsp;<span class="op" id="4042854">:=</span>&nbsp;<span class="num" id="4042857">0</span><span class="op" id="4042858">;</span>&nbsp;<span class="ident" id="4042860">y</span>&nbsp;<span class="op" id="4042862">!=</span>&nbsp;<span class="ident" id="4042865">r</span><span class="op" id="4042866">.</span><span class="ident" id="4042867">Dy</span><span class="op" id="4042869">(</span><span class="op" id="4042870">)</span><span class="op" id="4042871">;</span>&nbsp;<span class="ident" id="4042873">y</span><span class="op" id="4042874">++</span>&nbsp;<span class="op" id="4042877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4042881">for</span>&nbsp;<span class="ident" id="4042885">x</span>&nbsp;<span class="op" id="4042887">:=</span>&nbsp;<span class="num" id="4042890">0</span><span class="op" id="4042891">;</span>&nbsp;<span class="ident" id="4042893">x</span>&nbsp;<span class="op" id="4042895">!=</span>&nbsp;<span class="ident" id="4042898">r</span><span class="op" id="4042899">.</span><span class="ident" id="4042900">Dx</span><span class="op" id="4042902">(</span><span class="op" id="4042903">)</span><span class="op" id="4042904">;</span>&nbsp;<span class="ident" id="4042906">x</span><span class="op" id="4042907">++</span>&nbsp;<span class="op" id="4042910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042915">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4042973">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043011">sr</span><span class="op" id="4043013">,</span>&nbsp;<span class="ident" id="4043015">sg</span><span class="op" id="4043017">,</span>&nbsp;<span class="ident" id="4043019">sb</span><span class="op" id="4043021">,</span>&nbsp;<span class="ident" id="4043023">_</span>&nbsp;<span class="op" id="4043025">:=</span>&nbsp;<span class="ident" id="4043028">src</span><span class="op" id="4043031">.</span><span class="ident" id="4043032">At</span><span class="op" id="4043034">(</span><span class="ident" id="4043035">sp</span><span class="op" id="4043037">.</span><span class="ident" id="4043038">X</span><span class="op" id="4043039">+</span><span class="ident" id="4043040">x</span><span class="op" id="4043041">,</span>&nbsp;<span class="ident" id="4043043">sp</span><span class="op" id="4043045">.</span><span class="ident" id="4043046">Y</span><span class="op" id="4043047">+</span><span class="ident" id="4043048">y</span><span class="op" id="4043049">)</span><span class="op" id="4043050">.</span><span class="ident" id="4043051">RGBA</span><span class="op" id="4043055">(</span><span class="op" id="4043056">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043061">er</span><span class="op" id="4043063">,</span>&nbsp;<span class="ident" id="4043065">eg</span><span class="op" id="4043067">,</span>&nbsp;<span class="ident" id="4043069">eb</span>&nbsp;<span class="op" id="4043072">:=</span>&nbsp;<span class="builtintype" id="4043075">int32</span><span class="op" id="4043080">(</span><span class="ident" id="4043081">sr</span><span class="op" id="4043083">)</span><span class="op" id="4043084">,</span>&nbsp;<span class="builtintype" id="4043086">int32</span><span class="op" id="4043091">(</span><span class="ident" id="4043092">sg</span><span class="op" id="4043094">)</span><span class="op" id="4043095">,</span>&nbsp;<span class="builtintype" id="4043097">int32</span><span class="op" id="4043102">(</span><span class="ident" id="4043103">sb</span><span class="op" id="4043105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043110">if</span>&nbsp;<span class="ident" id="4043113">floydSteinberg</span>&nbsp;<span class="op" id="4043128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043134">er</span>&nbsp;<span class="op" id="4043137">=</span>&nbsp;<span class="ident" id="4043139">clamp</span><span class="op" id="4043144">(</span><span class="ident" id="4043145">er</span>&nbsp;<span class="op" id="4043148">+</span>&nbsp;<span class="ident" id="4043150">quantErrorCurr</span><span class="op" id="4043164">[</span><span class="ident" id="4043165">x</span><span class="op" id="4043166">+</span><span class="num" id="4043167">1</span><span class="op" id="4043168">]</span><span class="op" id="4043169">[</span><span class="num" id="4043170">0</span><span class="op" id="4043171">]</span><span class="op" id="4043172">/</span><span class="num" id="4043173">16</span><span class="op" id="4043175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043181">eg</span>&nbsp;<span class="op" id="4043184">=</span>&nbsp;<span class="ident" id="4043186">clamp</span><span class="op" id="4043191">(</span><span class="ident" id="4043192">eg</span>&nbsp;<span class="op" id="4043195">+</span>&nbsp;<span class="ident" id="4043197">quantErrorCurr</span><span class="op" id="4043211">[</span><span class="ident" id="4043212">x</span><span class="op" id="4043213">+</span><span class="num" id="4043214">1</span><span class="op" id="4043215">]</span><span class="op" id="4043216">[</span><span class="num" id="4043217">1</span><span class="op" id="4043218">]</span><span class="op" id="4043219">/</span><span class="num" id="4043220">16</span><span class="op" id="4043222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043228">eb</span>&nbsp;<span class="op" id="4043231">=</span>&nbsp;<span class="ident" id="4043233">clamp</span><span class="op" id="4043238">(</span><span class="ident" id="4043239">eb</span>&nbsp;<span class="op" id="4043242">+</span>&nbsp;<span class="ident" id="4043244">quantErrorCurr</span><span class="op" id="4043258">[</span><span class="ident" id="4043259">x</span><span class="op" id="4043260">+</span><span class="num" id="4043261">1</span><span class="op" id="4043262">]</span><span class="op" id="4043263">[</span><span class="num" id="4043264">2</span><span class="op" id="4043265">]</span><span class="op" id="4043266">/</span><span class="num" id="4043267">16</span><span class="op" id="4043269">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043280">if</span>&nbsp;<span class="ident" id="4043283">palette</span>&nbsp;<span class="op" id="4043291">!=</span>&nbsp;<span class="ident" id="4043294">nil</span>&nbsp;<span class="op" id="4043298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4043304">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4043372">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4043440">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4043509">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043561">bestIndex</span><span class="op" id="4043570">,</span>&nbsp;<span class="ident" id="4043572">bestSSD</span>&nbsp;<span class="op" id="4043580">:=</span>&nbsp;<span class="num" id="4043583">0</span><span class="op" id="4043584">,</span>&nbsp;<span class="builtintype" id="4043586">uint32</span><span class="op" id="4043592">(</span><span class="num" id="4043593">1</span><span class="op" id="4043594">&lt;&lt;</span><span class="num" id="4043596">32</span><span class="op" id="4043598">-</span><span class="num" id="4043599">1</span><span class="op" id="4043600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043606">for</span>&nbsp;<span class="ident" id="4043610">index</span><span class="op" id="4043615">,</span>&nbsp;<span class="ident" id="4043617">p</span>&nbsp;<span class="op" id="4043619">:=</span>&nbsp;<span class="keyword" id="4043622">range</span>&nbsp;<span class="ident" id="4043628">palette</span>&nbsp;<span class="op" id="4043636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043643">delta</span>&nbsp;<span class="op" id="4043649">:=</span>&nbsp;<span class="op" id="4043652">(</span><span class="ident" id="4043653">er</span>&nbsp;<span class="op" id="4043656">-</span>&nbsp;<span class="ident" id="4043658">p</span><span class="op" id="4043659">[</span><span class="num" id="4043660">0</span><span class="op" id="4043661">]</span><span class="op" id="4043662">)</span>&nbsp;<span class="op" id="4043664">&gt;&gt;</span>&nbsp;<span class="num" id="4043667">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043674">ssd</span>&nbsp;<span class="op" id="4043678">:=</span>&nbsp;<span class="builtintype" id="4043681">uint32</span><span class="op" id="4043687">(</span><span class="ident" id="4043688">delta</span>&nbsp;<span class="op" id="4043694">*</span>&nbsp;<span class="ident" id="4043696">delta</span><span class="op" id="4043701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043708">delta</span>&nbsp;<span class="op" id="4043714">=</span>&nbsp;<span class="op" id="4043716">(</span><span class="ident" id="4043717">eg</span>&nbsp;<span class="op" id="4043720">-</span>&nbsp;<span class="ident" id="4043722">p</span><span class="op" id="4043723">[</span><span class="num" id="4043724">1</span><span class="op" id="4043725">]</span><span class="op" id="4043726">)</span>&nbsp;<span class="op" id="4043728">&gt;&gt;</span>&nbsp;<span class="num" id="4043731">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043738">ssd</span>&nbsp;<span class="op" id="4043742">+=</span>&nbsp;<span class="builtintype" id="4043745">uint32</span><span class="op" id="4043751">(</span><span class="ident" id="4043752">delta</span>&nbsp;<span class="op" id="4043758">*</span>&nbsp;<span class="ident" id="4043760">delta</span><span class="op" id="4043765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043772">delta</span>&nbsp;<span class="op" id="4043778">=</span>&nbsp;<span class="op" id="4043780">(</span><span class="ident" id="4043781">eb</span>&nbsp;<span class="op" id="4043784">-</span>&nbsp;<span class="ident" id="4043786">p</span><span class="op" id="4043787">[</span><span class="num" id="4043788">2</span><span class="op" id="4043789">]</span><span class="op" id="4043790">)</span>&nbsp;<span class="op" id="4043792">&gt;&gt;</span>&nbsp;<span class="num" id="4043795">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043802">ssd</span>&nbsp;<span class="op" id="4043806">+=</span>&nbsp;<span class="builtintype" id="4043809">uint32</span><span class="op" id="4043815">(</span><span class="ident" id="4043816">delta</span>&nbsp;<span class="op" id="4043822">*</span>&nbsp;<span class="ident" id="4043824">delta</span><span class="op" id="4043829">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043836">if</span>&nbsp;<span class="ident" id="4043839">ssd</span>&nbsp;<span class="op" id="4043843">&lt;</span>&nbsp;<span class="ident" id="4043845">bestSSD</span>&nbsp;<span class="op" id="4043853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043861">bestIndex</span><span class="op" id="4043870">,</span>&nbsp;<span class="ident" id="4043872">bestSSD</span>&nbsp;<span class="op" id="4043880">=</span>&nbsp;<span class="ident" id="4043882">index</span><span class="op" id="4043887">,</span>&nbsp;<span class="ident" id="4043889">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043899">if</span>&nbsp;<span class="ident" id="4043902">ssd</span>&nbsp;<span class="op" id="4043906">==</span>&nbsp;<span class="num" id="4043909">0</span>&nbsp;<span class="op" id="4043911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043920">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043932">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4043945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4043951">pix</span><span class="op" id="4043954">[</span><span class="ident" id="4043955">y</span><span class="op" id="4043956">*</span><span class="ident" id="4043957">stride</span><span class="op" id="4043963">+</span><span class="ident" id="4043964">x</span><span class="op" id="4043965">]</span>&nbsp;<span class="op" id="4043967">=</span>&nbsp;<span class="builtintype" id="4043969">byte</span><span class="op" id="4043973">(</span><span class="ident" id="4043974">bestIndex</span><span class="op" id="4043983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4043990">if</span>&nbsp;<span class="op" id="4043993">!</span><span class="ident" id="4043994">floydSteinberg</span>&nbsp;<span class="op" id="4044009">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044016">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044035">er</span>&nbsp;<span class="op" id="4044038">-=</span>&nbsp;<span class="builtintype" id="4044041">int32</span><span class="op" id="4044046">(</span><span class="ident" id="4044047">palette</span><span class="op" id="4044054">[</span><span class="ident" id="4044055">bestIndex</span><span class="op" id="4044064">]</span><span class="op" id="4044065">[</span><span class="num" id="4044066">0</span><span class="op" id="4044067">]</span><span class="op" id="4044068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044074">eg</span>&nbsp;<span class="op" id="4044077">-=</span>&nbsp;<span class="builtintype" id="4044080">int32</span><span class="op" id="4044085">(</span><span class="ident" id="4044086">palette</span><span class="op" id="4044093">[</span><span class="ident" id="4044094">bestIndex</span><span class="op" id="4044103">]</span><span class="op" id="4044104">[</span><span class="num" id="4044105">1</span><span class="op" id="4044106">]</span><span class="op" id="4044107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044113">eb</span>&nbsp;<span class="op" id="4044116">-=</span>&nbsp;<span class="builtintype" id="4044119">int32</span><span class="op" id="4044124">(</span><span class="ident" id="4044125">palette</span><span class="op" id="4044132">[</span><span class="ident" id="4044133">bestIndex</span><span class="op" id="4044142">]</span><span class="op" id="4044143">[</span><span class="num" id="4044144">2</span><span class="op" id="4044145">]</span><span class="op" id="4044146">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044152">}</span>&nbsp;<span class="keyword" id="4044154">else</span>&nbsp;<span class="op" id="4044159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044165">out</span><span class="op" id="4044168">.</span><span class="ident" id="4044169">R</span>&nbsp;<span class="op" id="4044171">=</span>&nbsp;<span class="builtintype" id="4044173">uint16</span><span class="op" id="4044179">(</span><span class="ident" id="4044180">er</span><span class="op" id="4044182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044188">out</span><span class="op" id="4044191">.</span><span class="ident" id="4044192">G</span>&nbsp;<span class="op" id="4044194">=</span>&nbsp;<span class="builtintype" id="4044196">uint16</span><span class="op" id="4044202">(</span><span class="ident" id="4044203">eg</span><span class="op" id="4044205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044211">out</span><span class="op" id="4044214">.</span><span class="ident" id="4044215">B</span>&nbsp;<span class="op" id="4044217">=</span>&nbsp;<span class="builtintype" id="4044219">uint16</span><span class="op" id="4044225">(</span><span class="ident" id="4044226">eb</span><span class="op" id="4044228">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044234">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044295">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044360">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044423">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044484">dst</span><span class="op" id="4044487">.</span><span class="ident" id="4044488">Set</span><span class="op" id="4044491">(</span><span class="ident" id="4044492">r</span><span class="op" id="4044493">.</span><span class="ident" id="4044494">Min</span><span class="op" id="4044497">.</span><span class="ident" id="4044498">X</span><span class="op" id="4044499">+</span><span class="ident" id="4044500">x</span><span class="op" id="4044501">,</span>&nbsp;<span class="ident" id="4044503">r</span><span class="op" id="4044504">.</span><span class="ident" id="4044505">Min</span><span class="op" id="4044508">.</span><span class="ident" id="4044509">Y</span><span class="op" id="4044510">+</span><span class="ident" id="4044511">y</span><span class="op" id="4044512">,</span>&nbsp;<span class="op" id="4044514">&amp;</span><span class="ident" id="4044515">out</span><span class="op" id="4044518">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044525">if</span>&nbsp;<span class="op" id="4044528">!</span><span class="ident" id="4044529">floydSteinberg</span>&nbsp;<span class="op" id="4044544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4044551">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044570">sr</span><span class="op" id="4044572">,</span>&nbsp;<span class="ident" id="4044574">sg</span><span class="op" id="4044576">,</span>&nbsp;<span class="ident" id="4044578">sb</span><span class="op" id="4044580">,</span>&nbsp;<span class="ident" id="4044582">_</span>&nbsp;<span class="op" id="4044584">=</span>&nbsp;<span class="ident" id="4044586">dst</span><span class="op" id="4044589">.</span><span class="ident" id="4044590">At</span><span class="op" id="4044592">(</span><span class="ident" id="4044593">r</span><span class="op" id="4044594">.</span><span class="ident" id="4044595">Min</span><span class="op" id="4044598">.</span><span class="ident" id="4044599">X</span><span class="op" id="4044600">+</span><span class="ident" id="4044601">x</span><span class="op" id="4044602">,</span>&nbsp;<span class="ident" id="4044604">r</span><span class="op" id="4044605">.</span><span class="ident" id="4044606">Min</span><span class="op" id="4044609">.</span><span class="ident" id="4044610">Y</span><span class="op" id="4044611">+</span><span class="ident" id="4044612">y</span><span class="op" id="4044613">)</span><span class="op" id="4044614">.</span><span class="ident" id="4044615">RGBA</span><span class="op" id="4044619">(</span><span class="op" id="4044620">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044626">er</span>&nbsp;<span class="op" id="4044629">-=</span>&nbsp;<span class="builtintype" id="4044632">int32</span><span class="op" id="4044637">(</span><span class="ident" id="4044638">sr</span><span class="op" id="4044640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044646">eg</span>&nbsp;<span class="op" id="4044649">-=</span>&nbsp;<span class="builtintype" id="4044652">int32</span><span class="op" id="4044657">(</span><span class="ident" id="4044658">sg</span><span class="op" id="4044660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044666">eb</span>&nbsp;<span class="op" id="4044669">-=</span>&nbsp;<span class="builtintype" id="4044672">int32</span><span class="op" id="4044677">(</span><span class="ident" id="4044678">sb</span><span class="op" id="4044680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4044685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4044691">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044747">quantErrorNext</span><span class="op" id="4044761">[</span><span class="ident" id="4044762">x</span><span class="op" id="4044763">+</span><span class="num" id="4044764">0</span><span class="op" id="4044765">]</span><span class="op" id="4044766">[</span><span class="num" id="4044767">0</span><span class="op" id="4044768">]</span>&nbsp;<span class="op" id="4044770">+=</span>&nbsp;<span class="ident" id="4044773">er</span>&nbsp;<span class="op" id="4044776">*</span>&nbsp;<span class="num" id="4044778">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044783">quantErrorNext</span><span class="op" id="4044797">[</span><span class="ident" id="4044798">x</span><span class="op" id="4044799">+</span><span class="num" id="4044800">0</span><span class="op" id="4044801">]</span><span class="op" id="4044802">[</span><span class="num" id="4044803">1</span><span class="op" id="4044804">]</span>&nbsp;<span class="op" id="4044806">+=</span>&nbsp;<span class="ident" id="4044809">eg</span>&nbsp;<span class="op" id="4044812">*</span>&nbsp;<span class="num" id="4044814">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044819">quantErrorNext</span><span class="op" id="4044833">[</span><span class="ident" id="4044834">x</span><span class="op" id="4044835">+</span><span class="num" id="4044836">0</span><span class="op" id="4044837">]</span><span class="op" id="4044838">[</span><span class="num" id="4044839">2</span><span class="op" id="4044840">]</span>&nbsp;<span class="op" id="4044842">+=</span>&nbsp;<span class="ident" id="4044845">eb</span>&nbsp;<span class="op" id="4044848">*</span>&nbsp;<span class="num" id="4044850">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044855">quantErrorNext</span><span class="op" id="4044869">[</span><span class="ident" id="4044870">x</span><span class="op" id="4044871">+</span><span class="num" id="4044872">1</span><span class="op" id="4044873">]</span><span class="op" id="4044874">[</span><span class="num" id="4044875">0</span><span class="op" id="4044876">]</span>&nbsp;<span class="op" id="4044878">+=</span>&nbsp;<span class="ident" id="4044881">er</span>&nbsp;<span class="op" id="4044884">*</span>&nbsp;<span class="num" id="4044886">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044891">quantErrorNext</span><span class="op" id="4044905">[</span><span class="ident" id="4044906">x</span><span class="op" id="4044907">+</span><span class="num" id="4044908">1</span><span class="op" id="4044909">]</span><span class="op" id="4044910">[</span><span class="num" id="4044911">1</span><span class="op" id="4044912">]</span>&nbsp;<span class="op" id="4044914">+=</span>&nbsp;<span class="ident" id="4044917">eg</span>&nbsp;<span class="op" id="4044920">*</span>&nbsp;<span class="num" id="4044922">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044927">quantErrorNext</span><span class="op" id="4044941">[</span><span class="ident" id="4044942">x</span><span class="op" id="4044943">+</span><span class="num" id="4044944">1</span><span class="op" id="4044945">]</span><span class="op" id="4044946">[</span><span class="num" id="4044947">2</span><span class="op" id="4044948">]</span>&nbsp;<span class="op" id="4044950">+=</span>&nbsp;<span class="ident" id="4044953">eb</span>&nbsp;<span class="op" id="4044956">*</span>&nbsp;<span class="num" id="4044958">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044963">quantErrorNext</span><span class="op" id="4044977">[</span><span class="ident" id="4044978">x</span><span class="op" id="4044979">+</span><span class="num" id="4044980">2</span><span class="op" id="4044981">]</span><span class="op" id="4044982">[</span><span class="num" id="4044983">0</span><span class="op" id="4044984">]</span>&nbsp;<span class="op" id="4044986">+=</span>&nbsp;<span class="ident" id="4044989">er</span>&nbsp;<span class="op" id="4044992">*</span>&nbsp;<span class="num" id="4044994">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4044999">quantErrorNext</span><span class="op" id="4045013">[</span><span class="ident" id="4045014">x</span><span class="op" id="4045015">+</span><span class="num" id="4045016">2</span><span class="op" id="4045017">]</span><span class="op" id="4045018">[</span><span class="num" id="4045019">1</span><span class="op" id="4045020">]</span>&nbsp;<span class="op" id="4045022">+=</span>&nbsp;<span class="ident" id="4045025">eg</span>&nbsp;<span class="op" id="4045028">*</span>&nbsp;<span class="num" id="4045030">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045035">quantErrorNext</span><span class="op" id="4045049">[</span><span class="ident" id="4045050">x</span><span class="op" id="4045051">+</span><span class="num" id="4045052">2</span><span class="op" id="4045053">]</span><span class="op" id="4045054">[</span><span class="num" id="4045055">2</span><span class="op" id="4045056">]</span>&nbsp;<span class="op" id="4045058">+=</span>&nbsp;<span class="ident" id="4045061">eb</span>&nbsp;<span class="op" id="4045064">*</span>&nbsp;<span class="num" id="4045066">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045071">quantErrorCurr</span><span class="op" id="4045085">[</span><span class="ident" id="4045086">x</span><span class="op" id="4045087">+</span><span class="num" id="4045088">2</span><span class="op" id="4045089">]</span><span class="op" id="4045090">[</span><span class="num" id="4045091">0</span><span class="op" id="4045092">]</span>&nbsp;<span class="op" id="4045094">+=</span>&nbsp;<span class="ident" id="4045097">er</span>&nbsp;<span class="op" id="4045100">*</span>&nbsp;<span class="num" id="4045102">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045107">quantErrorCurr</span><span class="op" id="4045121">[</span><span class="ident" id="4045122">x</span><span class="op" id="4045123">+</span><span class="num" id="4045124">2</span><span class="op" id="4045125">]</span><span class="op" id="4045126">[</span><span class="num" id="4045127">1</span><span class="op" id="4045128">]</span>&nbsp;<span class="op" id="4045130">+=</span>&nbsp;<span class="ident" id="4045133">eg</span>&nbsp;<span class="op" id="4045136">*</span>&nbsp;<span class="num" id="4045138">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045143">quantErrorCurr</span><span class="op" id="4045157">[</span><span class="ident" id="4045158">x</span><span class="op" id="4045159">+</span><span class="num" id="4045160">2</span><span class="op" id="4045161">]</span><span class="op" id="4045162">[</span><span class="num" id="4045163">2</span><span class="op" id="4045164">]</span>&nbsp;<span class="op" id="4045166">+=</span>&nbsp;<span class="ident" id="4045169">eb</span>&nbsp;<span class="op" id="4045172">*</span>&nbsp;<span class="num" id="4045174">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4045183">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4045228">if</span>&nbsp;<span class="ident" id="4045231">floydSteinberg</span>&nbsp;<span class="op" id="4045246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045251">quantErrorCurr</span><span class="op" id="4045265">,</span>&nbsp;<span class="ident" id="4045267">quantErrorNext</span>&nbsp;<span class="op" id="4045282">=</span>&nbsp;<span class="ident" id="4045284">quantErrorNext</span><span class="op" id="4045298">,</span>&nbsp;<span class="ident" id="4045300">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4045318">for</span>&nbsp;<span class="ident" id="4045322">i</span>&nbsp;<span class="op" id="4045324">:=</span>&nbsp;<span class="keyword" id="4045327">range</span>&nbsp;<span class="ident" id="4045333">quantErrorNext</span>&nbsp;<span class="op" id="4045348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4045354">quantErrorNext</span><span class="op" id="4045368">[</span><span class="ident" id="4045369">i</span><span class="op" id="4045370">]</span>&nbsp;<span class="op" id="4045372">=</span>&nbsp;<span class="op" id="4045374">[</span><span class="num" id="4045375">3</span><span class="op" id="4045376">]</span><span class="builtintype" id="4045377">int32</span><span class="op" id="4045382">{</span><span class="op" id="4045383">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4045395">}</span><br>
<span class="lineno"></span><span class="op" id="4045397">}</span>
</div>
</body>
</html>
