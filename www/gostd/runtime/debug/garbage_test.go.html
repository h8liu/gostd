<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html" class="current">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8101070">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8101126">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8101180">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8101231">package</span>&nbsp;<span class="ident" id="8101239">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8101246">import</span>&nbsp;<span class="op" id="8101253">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8101256">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8101267">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8101278">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8101285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8101288">func</span>&nbsp;<span class="ident" id="8101293">TestReadGCStats</span><span class="op" id="8101308">(</span><span class="ident" id="8101309">t</span>&nbsp;<span class="op" id="8101311">*</span><span class="ident" id="8101312">testing</span><span class="op" id="8101319">.</span><span class="ident" id="8101320">T</span><span class="op" id="8101321">)</span>&nbsp;<span class="op" id="8101323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8101326">defer</span>&nbsp;<span class="ident" id="8101332">SetGCPercent</span><span class="op" id="8101344">(</span><span class="ident" id="8101345">SetGCPercent</span><span class="op" id="8101357">(</span><span class="op" id="8101358">-</span><span class="num" id="8101359">1</span><span class="op" id="8101360">)</span><span class="op" id="8101361">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8101365">var</span>&nbsp;<span class="ident" id="8101369">stats</span>&nbsp;<span class="ident" id="8101375">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8101384">var</span>&nbsp;<span class="ident" id="8101388">mstats</span>&nbsp;<span class="ident" id="8101395">runtime</span><span class="op" id="8101402">.</span><span class="ident" id="8101403">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8101413">var</span>&nbsp;<span class="ident" id="8101417">min</span><span class="op" id="8101420">,</span>&nbsp;<span class="ident" id="8101422">max</span>&nbsp;<span class="ident" id="8101426">time</span><span class="op" id="8101430">.</span><span class="ident" id="8101431">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8101442">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8101498">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101566">stats</span><span class="op" id="8101571">.</span><span class="ident" id="8101572">PauseQuantiles</span>&nbsp;<span class="op" id="8101587">=</span>&nbsp;<span class="builtinfunc" id="8101589">make</span><span class="op" id="8101593">(</span><span class="op" id="8101594">[</span><span class="op" id="8101595">]</span><span class="ident" id="8101596">time</span><span class="op" id="8101600">.</span><span class="ident" id="8101601">Duration</span><span class="op" id="8101609">,</span>&nbsp;<span class="num" id="8101611">10</span><span class="op" id="8101613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101616">ReadGCStats</span><span class="op" id="8101627">(</span><span class="op" id="8101628">&amp;</span><span class="ident" id="8101629">stats</span><span class="op" id="8101634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101637">runtime</span><span class="op" id="8101644">.</span><span class="ident" id="8101645">GC</span><span class="op" id="8101647">(</span><span class="op" id="8101648">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8101652">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101718">ReadGCStats</span><span class="op" id="8101729">(</span><span class="op" id="8101730">&amp;</span><span class="ident" id="8101731">stats</span><span class="op" id="8101736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101739">runtime</span><span class="op" id="8101746">.</span><span class="ident" id="8101747">ReadMemStats</span><span class="op" id="8101759">(</span><span class="op" id="8101760">&amp;</span><span class="ident" id="8101761">mstats</span><span class="op" id="8101767">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8101771">if</span>&nbsp;<span class="ident" id="8101774">stats</span><span class="op" id="8101779">.</span><span class="ident" id="8101780">NumGC</span>&nbsp;<span class="op" id="8101786">!=</span>&nbsp;<span class="ident" id="8101789">int64</span><span class="op" id="8101794">(</span><span class="ident" id="8101795">mstats</span><span class="op" id="8101801">.</span><span class="ident" id="8101802">NumGC</span><span class="op" id="8101807">)</span>&nbsp;<span class="op" id="8101809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101813">t</span><span class="op" id="8101814">.</span><span class="ident" id="8101815">Errorf</span><span class="op" id="8101821">(</span><span class="string" id="8101822">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8101863">,</span>&nbsp;<span class="ident" id="8101865">stats</span><span class="op" id="8101870">.</span><span class="ident" id="8101871">NumGC</span><span class="op" id="8101876">,</span>&nbsp;<span class="ident" id="8101878">mstats</span><span class="op" id="8101884">.</span><span class="ident" id="8101885">NumGC</span><span class="op" id="8101890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8101893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8101896">if</span>&nbsp;<span class="ident" id="8101899">stats</span><span class="op" id="8101904">.</span><span class="ident" id="8101905">PauseTotal</span>&nbsp;<span class="op" id="8101916">!=</span>&nbsp;<span class="ident" id="8101919">time</span><span class="op" id="8101923">.</span><span class="ident" id="8101924">Duration</span><span class="op" id="8101932">(</span><span class="ident" id="8101933">mstats</span><span class="op" id="8101939">.</span><span class="ident" id="8101940">PauseTotalNs</span><span class="op" id="8101952">)</span>&nbsp;<span class="op" id="8101954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8101958">t</span><span class="op" id="8101959">.</span><span class="ident" id="8101960">Errorf</span><span class="op" id="8101966">(</span><span class="string" id="8101967">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8102020">,</span>&nbsp;<span class="ident" id="8102022">stats</span><span class="op" id="8102027">.</span><span class="ident" id="8102028">PauseTotal</span><span class="op" id="8102038">,</span>&nbsp;<span class="ident" id="8102040">mstats</span><span class="op" id="8102046">.</span><span class="ident" id="8102047">PauseTotalNs</span><span class="op" id="8102059">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102065">if</span>&nbsp;<span class="ident" id="8102068">stats</span><span class="op" id="8102073">.</span><span class="ident" id="8102074">LastGC</span><span class="op" id="8102080">.</span><span class="ident" id="8102081">UnixNano</span><span class="op" id="8102089">(</span><span class="op" id="8102090">)</span>&nbsp;<span class="op" id="8102092">!=</span>&nbsp;<span class="ident" id="8102095">int64</span><span class="op" id="8102100">(</span><span class="ident" id="8102101">mstats</span><span class="op" id="8102107">.</span><span class="ident" id="8102108">LastGC</span><span class="op" id="8102114">)</span>&nbsp;<span class="op" id="8102116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102120">t</span><span class="op" id="8102121">.</span><span class="ident" id="8102122">Errorf</span><span class="op" id="8102128">(</span><span class="string" id="8102129">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8102181">,</span>&nbsp;<span class="ident" id="8102183">stats</span><span class="op" id="8102188">.</span><span class="ident" id="8102189">LastGC</span><span class="op" id="8102195">.</span><span class="ident" id="8102196">UnixNano</span><span class="op" id="8102204">(</span><span class="op" id="8102205">)</span><span class="op" id="8102206">,</span>&nbsp;<span class="ident" id="8102208">mstats</span><span class="op" id="8102214">.</span><span class="ident" id="8102215">LastGC</span><span class="op" id="8102221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102227">n</span>&nbsp;<span class="op" id="8102229">:=</span>&nbsp;<span class="builtintype" id="8102232">int</span><span class="op" id="8102235">(</span><span class="ident" id="8102236">mstats</span><span class="op" id="8102242">.</span><span class="ident" id="8102243">NumGC</span><span class="op" id="8102248">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102251">if</span>&nbsp;<span class="ident" id="8102254">n</span>&nbsp;<span class="op" id="8102256">&gt;</span>&nbsp;<span class="builtinfunc" id="8102258">len</span><span class="op" id="8102261">(</span><span class="ident" id="8102262">mstats</span><span class="op" id="8102268">.</span><span class="ident" id="8102269">PauseNs</span><span class="op" id="8102276">)</span>&nbsp;<span class="op" id="8102278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102282">n</span>&nbsp;<span class="op" id="8102284">=</span>&nbsp;<span class="builtinfunc" id="8102286">len</span><span class="op" id="8102289">(</span><span class="ident" id="8102290">mstats</span><span class="op" id="8102296">.</span><span class="ident" id="8102297">PauseNs</span><span class="op" id="8102304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102310">if</span>&nbsp;<span class="builtinfunc" id="8102313">len</span><span class="op" id="8102316">(</span><span class="ident" id="8102317">stats</span><span class="op" id="8102322">.</span><span class="ident" id="8102323">Pause</span><span class="op" id="8102328">)</span>&nbsp;<span class="op" id="8102330">!=</span>&nbsp;<span class="ident" id="8102333">n</span>&nbsp;<span class="op" id="8102335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102339">t</span><span class="op" id="8102340">.</span><span class="ident" id="8102341">Errorf</span><span class="op" id="8102347">(</span><span class="string" id="8102348">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8102380">,</span>&nbsp;<span class="builtinfunc" id="8102382">len</span><span class="op" id="8102385">(</span><span class="ident" id="8102386">stats</span><span class="op" id="8102391">.</span><span class="ident" id="8102392">Pause</span><span class="op" id="8102397">)</span><span class="op" id="8102398">,</span>&nbsp;<span class="ident" id="8102400">n</span><span class="op" id="8102401">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102404">}</span>&nbsp;<span class="keyword" id="8102406">else</span>&nbsp;<span class="op" id="8102411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102415">off</span>&nbsp;<span class="op" id="8102419">:=</span>&nbsp;<span class="op" id="8102422">(</span><span class="builtintype" id="8102423">int</span><span class="op" id="8102426">(</span><span class="ident" id="8102427">mstats</span><span class="op" id="8102433">.</span><span class="ident" id="8102434">NumGC</span><span class="op" id="8102439">)</span>&nbsp;<span class="op" id="8102441">+</span>&nbsp;<span class="builtinfunc" id="8102443">len</span><span class="op" id="8102446">(</span><span class="ident" id="8102447">mstats</span><span class="op" id="8102453">.</span><span class="ident" id="8102454">PauseNs</span><span class="op" id="8102461">)</span>&nbsp;<span class="op" id="8102463">-</span>&nbsp;<span class="num" id="8102465">1</span><span class="op" id="8102466">)</span>&nbsp;<span class="op" id="8102468">%</span>&nbsp;<span class="builtinfunc" id="8102470">len</span><span class="op" id="8102473">(</span><span class="ident" id="8102474">mstats</span><span class="op" id="8102480">.</span><span class="ident" id="8102481">PauseNs</span><span class="op" id="8102488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102492">for</span>&nbsp;<span class="ident" id="8102496">i</span>&nbsp;<span class="op" id="8102498">:=</span>&nbsp;<span class="num" id="8102501">0</span><span class="op" id="8102502">;</span>&nbsp;<span class="ident" id="8102504">i</span>&nbsp;<span class="op" id="8102506">&lt;</span>&nbsp;<span class="ident" id="8102508">n</span><span class="op" id="8102509">;</span>&nbsp;<span class="ident" id="8102511">i</span><span class="op" id="8102512">++</span>&nbsp;<span class="op" id="8102515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102520">dt</span>&nbsp;<span class="op" id="8102523">:=</span>&nbsp;<span class="ident" id="8102526">stats</span><span class="op" id="8102531">.</span><span class="ident" id="8102532">Pause</span><span class="op" id="8102537">[</span><span class="ident" id="8102538">i</span><span class="op" id="8102539">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102544">if</span>&nbsp;<span class="ident" id="8102547">dt</span>&nbsp;<span class="op" id="8102550">!=</span>&nbsp;<span class="ident" id="8102553">time</span><span class="op" id="8102557">.</span><span class="ident" id="8102558">Duration</span><span class="op" id="8102566">(</span><span class="ident" id="8102567">mstats</span><span class="op" id="8102573">.</span><span class="ident" id="8102574">PauseNs</span><span class="op" id="8102581">[</span><span class="ident" id="8102582">off</span><span class="op" id="8102585">]</span><span class="op" id="8102586">)</span>&nbsp;<span class="op" id="8102588">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102594">t</span><span class="op" id="8102595">.</span><span class="ident" id="8102596">Errorf</span><span class="op" id="8102602">(</span><span class="string" id="8102603">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8102634">,</span>&nbsp;<span class="ident" id="8102636">i</span><span class="op" id="8102637">,</span>&nbsp;<span class="ident" id="8102639">dt</span><span class="op" id="8102641">,</span>&nbsp;<span class="ident" id="8102643">mstats</span><span class="op" id="8102649">.</span><span class="ident" id="8102650">PauseNs</span><span class="op" id="8102657">[</span><span class="ident" id="8102658">off</span><span class="op" id="8102661">]</span><span class="op" id="8102662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102672">if</span>&nbsp;<span class="ident" id="8102675">max</span>&nbsp;<span class="op" id="8102679">&lt;</span>&nbsp;<span class="ident" id="8102681">dt</span>&nbsp;<span class="op" id="8102684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102690">max</span>&nbsp;<span class="op" id="8102694">=</span>&nbsp;<span class="ident" id="8102696">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102702">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102707">if</span>&nbsp;<span class="ident" id="8102710">min</span>&nbsp;<span class="op" id="8102714">&gt;</span>&nbsp;<span class="ident" id="8102716">dt</span>&nbsp;<span class="op" id="8102719">||</span>&nbsp;<span class="ident" id="8102722">i</span>&nbsp;<span class="op" id="8102724">==</span>&nbsp;<span class="num" id="8102727">0</span>&nbsp;<span class="op" id="8102729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102735">min</span>&nbsp;<span class="op" id="8102739">=</span>&nbsp;<span class="ident" id="8102741">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102752">off</span>&nbsp;<span class="op" id="8102756">=</span>&nbsp;<span class="op" id="8102758">(</span><span class="ident" id="8102759">off</span>&nbsp;<span class="op" id="8102763">+</span>&nbsp;<span class="builtinfunc" id="8102765">len</span><span class="op" id="8102768">(</span><span class="ident" id="8102769">mstats</span><span class="op" id="8102775">.</span><span class="ident" id="8102776">PauseNs</span><span class="op" id="8102783">)</span>&nbsp;<span class="op" id="8102785">-</span>&nbsp;<span class="num" id="8102787">1</span><span class="op" id="8102788">)</span>&nbsp;<span class="op" id="8102790">%</span>&nbsp;<span class="builtinfunc" id="8102792">len</span><span class="op" id="8102795">(</span><span class="ident" id="8102796">mstats</span><span class="op" id="8102802">.</span><span class="ident" id="8102803">PauseNs</span><span class="op" id="8102810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102814">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102821">q</span>&nbsp;<span class="op" id="8102823">:=</span>&nbsp;<span class="ident" id="8102826">stats</span><span class="op" id="8102831">.</span><span class="ident" id="8102832">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102848">nq</span>&nbsp;<span class="op" id="8102851">:=</span>&nbsp;<span class="builtinfunc" id="8102854">len</span><span class="op" id="8102857">(</span><span class="ident" id="8102858">q</span><span class="op" id="8102859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102862">if</span>&nbsp;<span class="ident" id="8102865">q</span><span class="op" id="8102866">[</span><span class="num" id="8102867">0</span><span class="op" id="8102868">]</span>&nbsp;<span class="op" id="8102870">!=</span>&nbsp;<span class="ident" id="8102873">min</span>&nbsp;<span class="op" id="8102877">||</span>&nbsp;<span class="ident" id="8102880">q</span><span class="op" id="8102881">[</span><span class="ident" id="8102882">nq</span><span class="op" id="8102884">-</span><span class="num" id="8102885">1</span><span class="op" id="8102886">]</span>&nbsp;<span class="op" id="8102888">!=</span>&nbsp;<span class="ident" id="8102891">max</span>&nbsp;<span class="op" id="8102895">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8102899">t</span><span class="op" id="8102900">.</span><span class="ident" id="8102901">Errorf</span><span class="op" id="8102907">(</span><span class="string" id="8102908">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="8102966">,</span>&nbsp;<span class="ident" id="8102968">q</span><span class="op" id="8102969">[</span><span class="num" id="8102970">0</span><span class="op" id="8102971">]</span><span class="op" id="8102972">,</span>&nbsp;<span class="ident" id="8102974">q</span><span class="op" id="8102975">[</span><span class="ident" id="8102976">nq</span><span class="op" id="8102978">-</span><span class="num" id="8102979">1</span><span class="op" id="8102980">]</span><span class="op" id="8102981">,</span>&nbsp;<span class="ident" id="8102983">min</span><span class="op" id="8102986">,</span>&nbsp;<span class="ident" id="8102988">max</span><span class="op" id="8102991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8102994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8102998">for</span>&nbsp;<span class="ident" id="8103002">i</span>&nbsp;<span class="op" id="8103004">:=</span>&nbsp;<span class="num" id="8103007">0</span><span class="op" id="8103008">;</span>&nbsp;<span class="ident" id="8103010">i</span>&nbsp;<span class="op" id="8103012">&lt;</span>&nbsp;<span class="ident" id="8103014">nq</span><span class="op" id="8103016">-</span><span class="num" id="8103017">1</span><span class="op" id="8103018">;</span>&nbsp;<span class="ident" id="8103020">i</span><span class="op" id="8103021">++</span>&nbsp;<span class="op" id="8103024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103028">if</span>&nbsp;<span class="ident" id="8103031">q</span><span class="op" id="8103032">[</span><span class="ident" id="8103033">i</span><span class="op" id="8103034">]</span>&nbsp;<span class="op" id="8103036">&gt;</span>&nbsp;<span class="ident" id="8103038">q</span><span class="op" id="8103039">[</span><span class="ident" id="8103040">i</span><span class="op" id="8103041">+</span><span class="num" id="8103042">1</span><span class="op" id="8103043">]</span>&nbsp;<span class="op" id="8103045">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103050">t</span><span class="op" id="8103051">.</span><span class="ident" id="8103052">Errorf</span><span class="op" id="8103058">(</span><span class="string" id="8103059">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="8103118">,</span>&nbsp;<span class="ident" id="8103120">i</span><span class="op" id="8103121">,</span>&nbsp;<span class="ident" id="8103123">q</span><span class="op" id="8103124">[</span><span class="ident" id="8103125">i</span><span class="op" id="8103126">]</span><span class="op" id="8103127">,</span>&nbsp;<span class="ident" id="8103129">i</span><span class="op" id="8103130">+</span><span class="num" id="8103131">1</span><span class="op" id="8103132">,</span>&nbsp;<span class="ident" id="8103134">q</span><span class="op" id="8103135">[</span><span class="ident" id="8103136">i</span><span class="op" id="8103137">+</span><span class="num" id="8103138">1</span><span class="op" id="8103139">]</span><span class="op" id="8103140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8103144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8103147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8103151">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103191">if</span>&nbsp;<span class="builtinfunc" id="8103194">len</span><span class="op" id="8103197">(</span><span class="ident" id="8103198">stats</span><span class="op" id="8103203">.</span><span class="ident" id="8103204">PauseEnd</span><span class="op" id="8103212">)</span>&nbsp;<span class="op" id="8103214">!=</span>&nbsp;<span class="ident" id="8103217">n</span>&nbsp;<span class="op" id="8103219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103223">t</span><span class="op" id="8103224">.</span><span class="ident" id="8103225">Fatalf</span><span class="op" id="8103231">(</span><span class="string" id="8103232">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8103267">,</span>&nbsp;<span class="builtinfunc" id="8103269">len</span><span class="op" id="8103272">(</span><span class="ident" id="8103273">stats</span><span class="op" id="8103278">.</span><span class="ident" id="8103279">PauseEnd</span><span class="op" id="8103287">)</span><span class="op" id="8103288">,</span>&nbsp;<span class="ident" id="8103290">n</span><span class="op" id="8103291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8103294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103297">off</span>&nbsp;<span class="op" id="8103301">:=</span>&nbsp;<span class="op" id="8103304">(</span><span class="builtintype" id="8103305">int</span><span class="op" id="8103308">(</span><span class="ident" id="8103309">mstats</span><span class="op" id="8103315">.</span><span class="ident" id="8103316">NumGC</span><span class="op" id="8103321">)</span>&nbsp;<span class="op" id="8103323">+</span>&nbsp;<span class="builtinfunc" id="8103325">len</span><span class="op" id="8103328">(</span><span class="ident" id="8103329">mstats</span><span class="op" id="8103335">.</span><span class="ident" id="8103336">PauseEnd</span><span class="op" id="8103344">)</span>&nbsp;<span class="op" id="8103346">-</span>&nbsp;<span class="num" id="8103348">1</span><span class="op" id="8103349">)</span>&nbsp;<span class="op" id="8103351">%</span>&nbsp;<span class="builtinfunc" id="8103353">len</span><span class="op" id="8103356">(</span><span class="ident" id="8103357">mstats</span><span class="op" id="8103363">.</span><span class="ident" id="8103364">PauseEnd</span><span class="op" id="8103372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103375">for</span>&nbsp;<span class="ident" id="8103379">i</span>&nbsp;<span class="op" id="8103381">:=</span>&nbsp;<span class="num" id="8103384">0</span><span class="op" id="8103385">;</span>&nbsp;<span class="ident" id="8103387">i</span>&nbsp;<span class="op" id="8103389">&lt;</span>&nbsp;<span class="ident" id="8103391">n</span><span class="op" id="8103392">;</span>&nbsp;<span class="ident" id="8103394">i</span><span class="op" id="8103395">++</span>&nbsp;<span class="op" id="8103398">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103402">dt</span>&nbsp;<span class="op" id="8103405">:=</span>&nbsp;<span class="ident" id="8103408">stats</span><span class="op" id="8103413">.</span><span class="ident" id="8103414">PauseEnd</span><span class="op" id="8103422">[</span><span class="ident" id="8103423">i</span><span class="op" id="8103424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103428">if</span>&nbsp;<span class="ident" id="8103431">dt</span><span class="op" id="8103433">.</span><span class="ident" id="8103434">UnixNano</span><span class="op" id="8103442">(</span><span class="op" id="8103443">)</span>&nbsp;<span class="op" id="8103445">!=</span>&nbsp;<span class="ident" id="8103448">int64</span><span class="op" id="8103453">(</span><span class="ident" id="8103454">mstats</span><span class="op" id="8103460">.</span><span class="ident" id="8103461">PauseEnd</span><span class="op" id="8103469">[</span><span class="ident" id="8103470">off</span><span class="op" id="8103473">]</span><span class="op" id="8103474">)</span>&nbsp;<span class="op" id="8103476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103481">t</span><span class="op" id="8103482">.</span><span class="ident" id="8103483">Errorf</span><span class="op" id="8103489">(</span><span class="string" id="8103490">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8103524">,</span>&nbsp;<span class="ident" id="8103526">i</span><span class="op" id="8103527">,</span>&nbsp;<span class="ident" id="8103529">dt</span><span class="op" id="8103531">,</span>&nbsp;<span class="ident" id="8103533">mstats</span><span class="op" id="8103539">.</span><span class="ident" id="8103540">PauseEnd</span><span class="op" id="8103548">[</span><span class="ident" id="8103549">off</span><span class="op" id="8103552">]</span><span class="op" id="8103553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8103557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103561">off</span>&nbsp;<span class="op" id="8103565">=</span>&nbsp;<span class="op" id="8103567">(</span><span class="ident" id="8103568">off</span>&nbsp;<span class="op" id="8103572">+</span>&nbsp;<span class="builtinfunc" id="8103574">len</span><span class="op" id="8103577">(</span><span class="ident" id="8103578">mstats</span><span class="op" id="8103584">.</span><span class="ident" id="8103585">PauseEnd</span><span class="op" id="8103593">)</span>&nbsp;<span class="op" id="8103595">-</span>&nbsp;<span class="num" id="8103597">1</span><span class="op" id="8103598">)</span>&nbsp;<span class="op" id="8103600">%</span>&nbsp;<span class="builtinfunc" id="8103602">len</span><span class="op" id="8103605">(</span><span class="ident" id="8103606">mstats</span><span class="op" id="8103612">.</span><span class="ident" id="8103613">PauseEnd</span><span class="op" id="8103621">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8103624">}</span><br>
<span class="lineno"></span><span class="op" id="8103626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8103629">var</span>&nbsp;<span class="ident" id="8103633">big</span>&nbsp;<span class="op" id="8103637">=</span>&nbsp;<span class="builtinfunc" id="8103639">make</span><span class="op" id="8103643">(</span><span class="op" id="8103644">[</span><span class="op" id="8103645">]</span><span class="builtintype" id="8103646">byte</span><span class="op" id="8103650">,</span>&nbsp;<span class="num" id="8103652">1</span><span class="op" id="8103653">&lt;&lt;</span><span class="num" id="8103655">20</span><span class="op" id="8103657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="8103660">func</span>&nbsp;<span class="ident" id="8103665">TestFreeOSMemory</span><span class="op" id="8103681">(</span><span class="ident" id="8103682">t</span>&nbsp;<span class="op" id="8103684">*</span><span class="ident" id="8103685">testing</span><span class="op" id="8103692">.</span><span class="ident" id="8103693">T</span><span class="op" id="8103694">)</span>&nbsp;<span class="op" id="8103696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103699">var</span>&nbsp;<span class="ident" id="8103703">ms1</span><span class="op" id="8103706">,</span>&nbsp;<span class="ident" id="8103708">ms2</span>&nbsp;<span class="ident" id="8103712">runtime</span><span class="op" id="8103719">.</span><span class="ident" id="8103720">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103731">if</span>&nbsp;<span class="ident" id="8103734">big</span>&nbsp;<span class="op" id="8103738">==</span>&nbsp;<span class="builtintype" id="8103741">nil</span>&nbsp;<span class="op" id="8103745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103749">t</span><span class="op" id="8103750">.</span><span class="ident" id="8103751">Skip</span><span class="op" id="8103755">(</span><span class="string" id="8103756">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="8103802">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8103805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103808">big</span>&nbsp;<span class="op" id="8103812">=</span>&nbsp;<span class="builtintype" id="8103814">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103819">runtime</span><span class="op" id="8103826">.</span><span class="ident" id="8103827">GC</span><span class="op" id="8103829">(</span><span class="op" id="8103830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103833">runtime</span><span class="op" id="8103840">.</span><span class="ident" id="8103841">ReadMemStats</span><span class="op" id="8103853">(</span><span class="op" id="8103854">&amp;</span><span class="ident" id="8103855">ms1</span><span class="op" id="8103858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103861">FreeOSMemory</span><span class="op" id="8103873">(</span><span class="op" id="8103874">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103877">runtime</span><span class="op" id="8103884">.</span><span class="ident" id="8103885">ReadMemStats</span><span class="op" id="8103897">(</span><span class="op" id="8103898">&amp;</span><span class="ident" id="8103899">ms2</span><span class="op" id="8103902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8103905">if</span>&nbsp;<span class="ident" id="8103908">ms1</span><span class="op" id="8103911">.</span><span class="ident" id="8103912">HeapReleased</span>&nbsp;<span class="op" id="8103925">&gt;=</span>&nbsp;<span class="ident" id="8103928">ms2</span><span class="op" id="8103931">.</span><span class="ident" id="8103932">HeapReleased</span>&nbsp;<span class="op" id="8103945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8103949">t</span><span class="op" id="8103950">.</span><span class="ident" id="8103951">Errorf</span><span class="op" id="8103957">(</span><span class="string" id="8103958">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="8104012">,</span>&nbsp;<span class="ident" id="8104014">ms1</span><span class="op" id="8104017">.</span><span class="ident" id="8104018">HeapReleased</span><span class="op" id="8104030">,</span>&nbsp;<span class="ident" id="8104032">ms2</span><span class="op" id="8104035">.</span><span class="ident" id="8104036">HeapReleased</span><span class="op" id="8104048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8104051">}</span><br>
<span class="lineno"></span><span class="op" id="8104053">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="8104056">func</span>&nbsp;<span class="ident" id="8104061">TestSetGCPercent</span><span class="op" id="8104077">(</span><span class="ident" id="8104078">t</span>&nbsp;<span class="op" id="8104080">*</span><span class="ident" id="8104081">testing</span><span class="op" id="8104088">.</span><span class="ident" id="8104089">T</span><span class="op" id="8104090">)</span>&nbsp;<span class="op" id="8104092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8104095">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8104159">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8104223">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8104252">old</span>&nbsp;<span class="op" id="8104256">:=</span>&nbsp;<span class="ident" id="8104259">SetGCPercent</span><span class="op" id="8104271">(</span><span class="num" id="8104272">123</span><span class="op" id="8104275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8104278">new</span>&nbsp;<span class="op" id="8104282">:=</span>&nbsp;<span class="ident" id="8104285">SetGCPercent</span><span class="op" id="8104297">(</span><span class="ident" id="8104298">old</span><span class="op" id="8104301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8104304">if</span>&nbsp;<span class="builtinfunc" id="8104307">new</span>&nbsp;<span class="op" id="8104311">!=</span>&nbsp;<span class="num" id="8104314">123</span>&nbsp;<span class="op" id="8104318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8104322">t</span><span class="op" id="8104323">.</span><span class="ident" id="8104324">Errorf</span><span class="op" id="8104330">(</span><span class="string" id="8104331">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="8104382">,</span>&nbsp;<span class="builtinfunc" id="8104384">new</span><span class="op" id="8104387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8104390">}</span><br>
<span class="lineno">115</span><span class="op" id="8104392">}</span>
</div>
</body>
</html>
