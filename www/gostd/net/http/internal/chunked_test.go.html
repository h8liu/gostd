<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6875557">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6875612">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6875666">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6875717">package</span>&nbsp;<span class="ident" id="6875725">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6875735">import</span>&nbsp;<span class="op" id="6875742">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875745">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875754">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875763">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875770">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875776">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875789">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6875800">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6875810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6875813">func</span>&nbsp;<span class="ident" id="6875818">TestChunk</span><span class="op" id="6875827">(</span><span class="ident" id="6875828">t</span>&nbsp;<span class="op" id="6875830">*</span><span class="ident" id="6875831">testing</span><span class="op" id="6875838">.</span><span class="ident" id="6875839">T</span><span class="op" id="6875840">)</span>&nbsp;<span class="op" id="6875842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875845">var</span>&nbsp;<span class="ident" id="6875849">b</span>&nbsp;<span class="ident" id="6875851">bytes</span><span class="op" id="6875856">.</span><span class="ident" id="6875857">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875866">w</span>&nbsp;<span class="op" id="6875868">:=</span>&nbsp;<span class="ident" id="6875871">NewChunkedWriter</span><span class="op" id="6875887">(</span><span class="op" id="6875888">&amp;</span><span class="ident" id="6875889">b</span><span class="op" id="6875890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875893">const</span>&nbsp;<span class="ident" id="6875899">chunk1</span>&nbsp;<span class="op" id="6875906">=</span>&nbsp;<span class="string" id="6875908">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875919">const</span>&nbsp;<span class="ident" id="6875925">chunk2</span>&nbsp;<span class="op" id="6875932">=</span>&nbsp;<span class="string" id="6875934">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875961">w</span><span class="op" id="6875962">.</span><span class="ident" id="6875963">Write</span><span class="op" id="6875968">(</span><span class="op" id="6875969">[</span><span class="op" id="6875970">]</span><span class="builtintype" id="6875971">byte</span><span class="op" id="6875975">(</span><span class="ident" id="6875976">chunk1</span><span class="op" id="6875982">)</span><span class="op" id="6875983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875986">w</span><span class="op" id="6875987">.</span><span class="ident" id="6875988">Write</span><span class="op" id="6875993">(</span><span class="op" id="6875994">[</span><span class="op" id="6875995">]</span><span class="builtintype" id="6875996">byte</span><span class="op" id="6876000">(</span><span class="ident" id="6876001">chunk2</span><span class="op" id="6876007">)</span><span class="op" id="6876008">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876011">w</span><span class="op" id="6876012">.</span><span class="ident" id="6876013">Close</span><span class="op" id="6876018">(</span><span class="op" id="6876019">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876023">if</span>&nbsp;<span class="ident" id="6876026">g</span><span class="op" id="6876027">,</span>&nbsp;<span class="ident" id="6876029">e</span>&nbsp;<span class="op" id="6876031">:=</span>&nbsp;<span class="ident" id="6876034">b</span><span class="op" id="6876035">.</span><span class="ident" id="6876036">String</span><span class="op" id="6876042">(</span><span class="op" id="6876043">)</span><span class="op" id="6876044">,</span>&nbsp;<span class="string" id="6876046">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="6876102">;</span>&nbsp;<span class="ident" id="6876104">g</span>&nbsp;<span class="op" id="6876106">!=</span>&nbsp;<span class="ident" id="6876109">e</span>&nbsp;<span class="op" id="6876111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876115">t</span><span class="op" id="6876116">.</span><span class="ident" id="6876117">Fatalf</span><span class="op" id="6876123">(</span><span class="string" id="6876124">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6876156">,</span>&nbsp;<span class="ident" id="6876158">g</span><span class="op" id="6876159">,</span>&nbsp;<span class="ident" id="6876161">e</span><span class="op" id="6876162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876165">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876169">r</span>&nbsp;<span class="op" id="6876171">:=</span>&nbsp;<span class="ident" id="6876174">NewChunkedReader</span><span class="op" id="6876190">(</span><span class="op" id="6876191">&amp;</span><span class="ident" id="6876192">b</span><span class="op" id="6876193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876196">data</span><span class="op" id="6876200">,</span>&nbsp;<span class="ident" id="6876202">err</span>&nbsp;<span class="op" id="6876206">:=</span>&nbsp;<span class="ident" id="6876209">ioutil</span><span class="op" id="6876215">.</span><span class="ident" id="6876216">ReadAll</span><span class="op" id="6876223">(</span><span class="ident" id="6876224">r</span><span class="op" id="6876225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876228">if</span>&nbsp;<span class="ident" id="6876231">err</span>&nbsp;<span class="op" id="6876235">!=</span>&nbsp;<span class="ident" id="6876238">nil</span>&nbsp;<span class="op" id="6876242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876246">t</span><span class="op" id="6876247">.</span><span class="ident" id="6876248">Logf</span><span class="op" id="6876252">(</span><span class="string" id="6876253">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="6876265">,</span>&nbsp;<span class="ident" id="6876267">data</span><span class="op" id="6876271">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876275">t</span><span class="op" id="6876276">.</span><span class="ident" id="6876277">Fatalf</span><span class="op" id="6876283">(</span><span class="string" id="6876284">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="6876309">,</span>&nbsp;<span class="ident" id="6876311">err</span><span class="op" id="6876314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876320">if</span>&nbsp;<span class="ident" id="6876323">g</span><span class="op" id="6876324">,</span>&nbsp;<span class="ident" id="6876326">e</span>&nbsp;<span class="op" id="6876328">:=</span>&nbsp;<span class="builtintype" id="6876331">string</span><span class="op" id="6876337">(</span><span class="ident" id="6876338">data</span><span class="op" id="6876342">)</span><span class="op" id="6876343">,</span>&nbsp;<span class="ident" id="6876345">chunk1</span><span class="op" id="6876351">+</span><span class="ident" id="6876352">chunk2</span><span class="op" id="6876358">;</span>&nbsp;<span class="ident" id="6876360">g</span>&nbsp;<span class="op" id="6876362">!=</span>&nbsp;<span class="ident" id="6876365">e</span>&nbsp;<span class="op" id="6876367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876371">t</span><span class="op" id="6876372">.</span><span class="ident" id="6876373">Errorf</span><span class="op" id="6876379">(</span><span class="string" id="6876380">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6876411">,</span>&nbsp;<span class="ident" id="6876413">g</span><span class="op" id="6876414">,</span>&nbsp;<span class="ident" id="6876416">e</span><span class="op" id="6876417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876420">}</span><br>
<span class="lineno">40</span><span class="op" id="6876422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876425">func</span>&nbsp;<span class="ident" id="6876430">TestChunkReadMultiple</span><span class="op" id="6876451">(</span><span class="ident" id="6876452">t</span>&nbsp;<span class="op" id="6876454">*</span><span class="ident" id="6876455">testing</span><span class="op" id="6876462">.</span><span class="ident" id="6876463">T</span><span class="op" id="6876464">)</span>&nbsp;<span class="op" id="6876466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876469">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876515">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876519">var</span>&nbsp;<span class="ident" id="6876523">b</span>&nbsp;<span class="ident" id="6876525">bytes</span><span class="op" id="6876530">.</span><span class="ident" id="6876531">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876540">w</span>&nbsp;<span class="op" id="6876542">:=</span>&nbsp;<span class="ident" id="6876545">NewChunkedWriter</span><span class="op" id="6876561">(</span><span class="op" id="6876562">&amp;</span><span class="ident" id="6876563">b</span><span class="op" id="6876564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876568">w</span><span class="op" id="6876569">.</span><span class="ident" id="6876570">Write</span><span class="op" id="6876575">(</span><span class="op" id="6876576">[</span><span class="op" id="6876577">]</span><span class="builtintype" id="6876578">byte</span><span class="op" id="6876582">(</span><span class="string" id="6876583">&#34;foo&#34;</span><span class="op" id="6876588">)</span><span class="op" id="6876589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876593">w</span><span class="op" id="6876594">.</span><span class="ident" id="6876595">Write</span><span class="op" id="6876600">(</span><span class="op" id="6876601">[</span><span class="op" id="6876602">]</span><span class="builtintype" id="6876603">byte</span><span class="op" id="6876607">(</span><span class="string" id="6876608">&#34;bar&#34;</span><span class="op" id="6876613">)</span><span class="op" id="6876614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876618">w</span><span class="op" id="6876619">.</span><span class="ident" id="6876620">Close</span><span class="op" id="6876625">(</span><span class="op" id="6876626">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876631">r</span>&nbsp;<span class="op" id="6876633">:=</span>&nbsp;<span class="ident" id="6876636">NewChunkedReader</span><span class="op" id="6876652">(</span><span class="op" id="6876653">&amp;</span><span class="ident" id="6876654">b</span><span class="op" id="6876655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876659">buf</span>&nbsp;<span class="op" id="6876663">:=</span>&nbsp;<span class="builtinfunc" id="6876666">make</span><span class="op" id="6876670">(</span><span class="op" id="6876671">[</span><span class="op" id="6876672">]</span><span class="builtintype" id="6876673">byte</span><span class="op" id="6876677">,</span>&nbsp;<span class="num" id="6876679">10</span><span class="op" id="6876681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876685">n</span><span class="op" id="6876686">,</span>&nbsp;<span class="ident" id="6876688">err</span>&nbsp;<span class="op" id="6876692">:=</span>&nbsp;<span class="ident" id="6876695">r</span><span class="op" id="6876696">.</span><span class="ident" id="6876697">Read</span><span class="op" id="6876701">(</span><span class="ident" id="6876702">buf</span><span class="op" id="6876705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876709">if</span>&nbsp;<span class="ident" id="6876712">n</span>&nbsp;<span class="op" id="6876714">!=</span>&nbsp;<span class="num" id="6876717">6</span>&nbsp;<span class="op" id="6876719">||</span>&nbsp;<span class="ident" id="6876722">err</span>&nbsp;<span class="op" id="6876726">!=</span>&nbsp;<span class="ident" id="6876729">io</span><span class="op" id="6876731">.</span><span class="ident" id="6876732">EOF</span>&nbsp;<span class="op" id="6876736">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876741">t</span><span class="op" id="6876742">.</span><span class="ident" id="6876743">Errorf</span><span class="op" id="6876749">(</span><span class="string" id="6876750">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="6876778">,</span>&nbsp;<span class="ident" id="6876780">n</span><span class="op" id="6876781">,</span>&nbsp;<span class="ident" id="6876783">err</span><span class="op" id="6876786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876794">buf</span>&nbsp;<span class="op" id="6876798">=</span>&nbsp;<span class="ident" id="6876800">buf</span><span class="op" id="6876803">[</span><span class="op" id="6876804">:</span><span class="ident" id="6876805">n</span><span class="op" id="6876806">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876810">if</span>&nbsp;<span class="builtintype" id="6876813">string</span><span class="op" id="6876819">(</span><span class="ident" id="6876820">buf</span><span class="op" id="6876823">)</span>&nbsp;<span class="op" id="6876825">!=</span>&nbsp;<span class="string" id="6876828">&#34;foobar&#34;</span>&nbsp;<span class="op" id="6876837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876842">t</span><span class="op" id="6876843">.</span><span class="ident" id="6876844">Errorf</span><span class="op" id="6876850">(</span><span class="string" id="6876851">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6876871">,</span>&nbsp;<span class="ident" id="6876873">buf</span><span class="op" id="6876876">,</span>&nbsp;<span class="string" id="6876878">&#34;foobar&#34;</span><span class="op" id="6876886">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876897">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876975">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877039">var</span>&nbsp;<span class="ident" id="6877043">b</span>&nbsp;<span class="ident" id="6877045">bytes</span><span class="op" id="6877050">.</span><span class="ident" id="6877051">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877060">w</span>&nbsp;<span class="op" id="6877062">:=</span>&nbsp;<span class="ident" id="6877065">NewChunkedWriter</span><span class="op" id="6877081">(</span><span class="op" id="6877082">&amp;</span><span class="ident" id="6877083">b</span><span class="op" id="6877084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877088">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877164">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877231">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877306">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877369">const</span>&nbsp;<span class="ident" id="6877375">fillBufChunk</span>&nbsp;<span class="op" id="6877388">=</span>&nbsp;<span class="string" id="6877390">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877406">const</span>&nbsp;<span class="ident" id="6877412">shortChunk</span>&nbsp;<span class="op" id="6877423">=</span>&nbsp;<span class="string" id="6877425">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877433">w</span><span class="op" id="6877434">.</span><span class="ident" id="6877435">Write</span><span class="op" id="6877440">(</span><span class="op" id="6877441">[</span><span class="op" id="6877442">]</span><span class="builtintype" id="6877443">byte</span><span class="op" id="6877447">(</span><span class="ident" id="6877448">fillBufChunk</span><span class="op" id="6877460">)</span><span class="op" id="6877461">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877465">w</span><span class="op" id="6877466">.</span><span class="ident" id="6877467">Write</span><span class="op" id="6877472">(</span><span class="op" id="6877473">[</span><span class="op" id="6877474">]</span><span class="builtintype" id="6877475">byte</span><span class="op" id="6877479">(</span><span class="ident" id="6877480">shortChunk</span><span class="op" id="6877490">)</span><span class="op" id="6877491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877495">w</span><span class="op" id="6877496">.</span><span class="ident" id="6877497">Close</span><span class="op" id="6877502">(</span><span class="op" id="6877503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877508">r</span>&nbsp;<span class="op" id="6877510">:=</span>&nbsp;<span class="ident" id="6877513">NewChunkedReader</span><span class="op" id="6877529">(</span><span class="ident" id="6877530">bufio</span><span class="op" id="6877535">.</span><span class="ident" id="6877536">NewReaderSize</span><span class="op" id="6877549">(</span><span class="op" id="6877550">&amp;</span><span class="ident" id="6877551">b</span><span class="op" id="6877552">,</span>&nbsp;<span class="num" id="6877554">16</span><span class="op" id="6877556">)</span><span class="op" id="6877557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877561">buf</span>&nbsp;<span class="op" id="6877565">:=</span>&nbsp;<span class="builtinfunc" id="6877568">make</span><span class="op" id="6877572">(</span><span class="op" id="6877573">[</span><span class="op" id="6877574">]</span><span class="builtintype" id="6877575">byte</span><span class="op" id="6877579">,</span>&nbsp;<span class="builtinfunc" id="6877581">len</span><span class="op" id="6877584">(</span><span class="ident" id="6877585">fillBufChunk</span><span class="op" id="6877597">)</span><span class="op" id="6877598">+</span><span class="builtinfunc" id="6877599">len</span><span class="op" id="6877602">(</span><span class="ident" id="6877603">shortChunk</span><span class="op" id="6877613">)</span><span class="op" id="6877614">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877618">n</span><span class="op" id="6877619">,</span>&nbsp;<span class="ident" id="6877621">err</span>&nbsp;<span class="op" id="6877625">:=</span>&nbsp;<span class="ident" id="6877628">r</span><span class="op" id="6877629">.</span><span class="ident" id="6877630">Read</span><span class="op" id="6877634">(</span><span class="ident" id="6877635">buf</span><span class="op" id="6877638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877642">if</span>&nbsp;<span class="ident" id="6877645">n</span>&nbsp;<span class="op" id="6877647">!=</span>&nbsp;<span class="builtinfunc" id="6877650">len</span><span class="op" id="6877653">(</span><span class="ident" id="6877654">fillBufChunk</span><span class="op" id="6877666">)</span>&nbsp;<span class="op" id="6877668">||</span>&nbsp;<span class="ident" id="6877671">err</span>&nbsp;<span class="op" id="6877675">!=</span>&nbsp;<span class="ident" id="6877678">nil</span>&nbsp;<span class="op" id="6877682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877687">t</span><span class="op" id="6877688">.</span><span class="ident" id="6877689">Errorf</span><span class="op" id="6877695">(</span><span class="string" id="6877696">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="6877725">,</span>&nbsp;<span class="ident" id="6877727">n</span><span class="op" id="6877728">,</span>&nbsp;<span class="ident" id="6877730">err</span><span class="op" id="6877733">,</span>&nbsp;<span class="builtinfunc" id="6877735">len</span><span class="op" id="6877738">(</span><span class="ident" id="6877739">fillBufChunk</span><span class="op" id="6877751">)</span><span class="op" id="6877752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877760">buf</span>&nbsp;<span class="op" id="6877764">=</span>&nbsp;<span class="ident" id="6877766">buf</span><span class="op" id="6877769">[</span><span class="op" id="6877770">:</span><span class="ident" id="6877771">n</span><span class="op" id="6877772">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877776">if</span>&nbsp;<span class="builtintype" id="6877779">string</span><span class="op" id="6877785">(</span><span class="ident" id="6877786">buf</span><span class="op" id="6877789">)</span>&nbsp;<span class="op" id="6877791">!=</span>&nbsp;<span class="ident" id="6877794">fillBufChunk</span>&nbsp;<span class="op" id="6877807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877812">t</span><span class="op" id="6877813">.</span><span class="ident" id="6877814">Errorf</span><span class="op" id="6877820">(</span><span class="string" id="6877821">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6877841">,</span>&nbsp;<span class="ident" id="6877843">buf</span><span class="op" id="6877846">,</span>&nbsp;<span class="ident" id="6877848">fillBufChunk</span><span class="op" id="6877860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877869">n</span><span class="op" id="6877870">,</span>&nbsp;<span class="ident" id="6877872">err</span>&nbsp;<span class="op" id="6877876">=</span>&nbsp;<span class="ident" id="6877878">r</span><span class="op" id="6877879">.</span><span class="ident" id="6877880">Read</span><span class="op" id="6877884">(</span><span class="ident" id="6877885">buf</span><span class="op" id="6877888">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877892">if</span>&nbsp;<span class="ident" id="6877895">n</span>&nbsp;<span class="op" id="6877897">!=</span>&nbsp;<span class="builtinfunc" id="6877900">len</span><span class="op" id="6877903">(</span><span class="ident" id="6877904">shortChunk</span><span class="op" id="6877914">)</span>&nbsp;<span class="op" id="6877916">||</span>&nbsp;<span class="ident" id="6877919">err</span>&nbsp;<span class="op" id="6877923">!=</span>&nbsp;<span class="ident" id="6877926">io</span><span class="op" id="6877928">.</span><span class="ident" id="6877929">EOF</span>&nbsp;<span class="op" id="6877933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877938">t</span><span class="op" id="6877939">.</span><span class="ident" id="6877940">Errorf</span><span class="op" id="6877946">(</span><span class="string" id="6877947">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="6877976">,</span>&nbsp;<span class="ident" id="6877978">n</span><span class="op" id="6877979">,</span>&nbsp;<span class="ident" id="6877981">err</span><span class="op" id="6877984">,</span>&nbsp;<span class="builtinfunc" id="6877986">len</span><span class="op" id="6877989">(</span><span class="ident" id="6877990">shortChunk</span><span class="op" id="6878000">)</span><span class="op" id="6878001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878012">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878095">r</span>&nbsp;<span class="op" id="6878097">:=</span>&nbsp;<span class="ident" id="6878100">NewChunkedReader</span><span class="op" id="6878116">(</span><span class="ident" id="6878117">bufio</span><span class="op" id="6878122">.</span><span class="ident" id="6878123">NewReader</span><span class="op" id="6878132">(</span><span class="ident" id="6878133">strings</span><span class="op" id="6878140">.</span><span class="ident" id="6878141">NewReader</span><span class="op" id="6878150">(</span><span class="string" id="6878151">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="6878170">)</span><span class="op" id="6878171">)</span><span class="op" id="6878172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878176">buf</span>&nbsp;<span class="op" id="6878180">:=</span>&nbsp;<span class="builtinfunc" id="6878183">make</span><span class="op" id="6878187">(</span><span class="op" id="6878188">[</span><span class="op" id="6878189">]</span><span class="builtintype" id="6878190">byte</span><span class="op" id="6878194">,</span>&nbsp;<span class="num" id="6878196">3</span><span class="op" id="6878197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878201">n</span><span class="op" id="6878202">,</span>&nbsp;<span class="ident" id="6878204">err</span>&nbsp;<span class="op" id="6878208">:=</span>&nbsp;<span class="ident" id="6878211">r</span><span class="op" id="6878212">.</span><span class="ident" id="6878213">Read</span><span class="op" id="6878217">(</span><span class="ident" id="6878218">buf</span><span class="op" id="6878221">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878225">if</span>&nbsp;<span class="ident" id="6878228">n</span>&nbsp;<span class="op" id="6878230">!=</span>&nbsp;<span class="num" id="6878233">3</span>&nbsp;<span class="op" id="6878235">||</span>&nbsp;<span class="ident" id="6878238">err</span>&nbsp;<span class="op" id="6878242">!=</span>&nbsp;<span class="ident" id="6878245">io</span><span class="op" id="6878247">.</span><span class="ident" id="6878248">EOF</span>&nbsp;<span class="op" id="6878252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878257">t</span><span class="op" id="6878258">.</span><span class="ident" id="6878259">Errorf</span><span class="op" id="6878265">(</span><span class="string" id="6878266">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="6878294">,</span>&nbsp;<span class="ident" id="6878296">n</span><span class="op" id="6878297">,</span>&nbsp;<span class="ident" id="6878299">err</span><span class="op" id="6878302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878310">if</span>&nbsp;<span class="builtintype" id="6878313">string</span><span class="op" id="6878319">(</span><span class="ident" id="6878320">buf</span><span class="op" id="6878323">)</span>&nbsp;<span class="op" id="6878325">!=</span>&nbsp;<span class="string" id="6878328">&#34;foo&#34;</span>&nbsp;<span class="op" id="6878334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878339">t</span><span class="op" id="6878340">.</span><span class="ident" id="6878341">Errorf</span><span class="op" id="6878347">(</span><span class="string" id="6878348">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="6878368">,</span>&nbsp;<span class="ident" id="6878370">buf</span><span class="op" id="6878373">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878380">}</span><br>
<span class="lineno"></span><span class="op" id="6878382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878385">func</span>&nbsp;<span class="ident" id="6878390">TestChunkReaderAllocs</span><span class="op" id="6878411">(</span><span class="ident" id="6878412">t</span>&nbsp;<span class="op" id="6878414">*</span><span class="ident" id="6878415">testing</span><span class="op" id="6878422">.</span><span class="ident" id="6878423">T</span><span class="op" id="6878424">)</span>&nbsp;<span class="op" id="6878426">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878429">if</span>&nbsp;<span class="ident" id="6878432">testing</span><span class="op" id="6878439">.</span><span class="ident" id="6878440">Short</span><span class="op" id="6878445">(</span><span class="op" id="6878446">)</span>&nbsp;<span class="op" id="6878448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878452">t</span><span class="op" id="6878453">.</span><span class="ident" id="6878454">Skip</span><span class="op" id="6878458">(</span><span class="string" id="6878459">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6878483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878489">var</span>&nbsp;<span class="ident" id="6878493">buf</span>&nbsp;<span class="ident" id="6878497">bytes</span><span class="op" id="6878502">.</span><span class="ident" id="6878503">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878511">w</span>&nbsp;<span class="op" id="6878513">:=</span>&nbsp;<span class="ident" id="6878516">NewChunkedWriter</span><span class="op" id="6878532">(</span><span class="op" id="6878533">&amp;</span><span class="ident" id="6878534">buf</span><span class="op" id="6878537">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878540">a</span><span class="op" id="6878541">,</span>&nbsp;<span class="ident" id="6878543">b</span><span class="op" id="6878544">,</span>&nbsp;<span class="ident" id="6878546">c</span>&nbsp;<span class="op" id="6878548">:=</span>&nbsp;<span class="op" id="6878551">[</span><span class="op" id="6878552">]</span><span class="builtintype" id="6878553">byte</span><span class="op" id="6878557">(</span><span class="string" id="6878558">&#34;aaaaaa&#34;</span><span class="op" id="6878566">)</span><span class="op" id="6878567">,</span>&nbsp;<span class="op" id="6878569">[</span><span class="op" id="6878570">]</span><span class="builtintype" id="6878571">byte</span><span class="op" id="6878575">(</span><span class="string" id="6878576">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="6878590">)</span><span class="op" id="6878591">,</span>&nbsp;<span class="op" id="6878593">[</span><span class="op" id="6878594">]</span><span class="builtintype" id="6878595">byte</span><span class="op" id="6878599">(</span><span class="string" id="6878600">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="6878626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878629">w</span><span class="op" id="6878630">.</span><span class="ident" id="6878631">Write</span><span class="op" id="6878636">(</span><span class="ident" id="6878637">a</span><span class="op" id="6878638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878641">w</span><span class="op" id="6878642">.</span><span class="ident" id="6878643">Write</span><span class="op" id="6878648">(</span><span class="ident" id="6878649">b</span><span class="op" id="6878650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878653">w</span><span class="op" id="6878654">.</span><span class="ident" id="6878655">Write</span><span class="op" id="6878660">(</span><span class="ident" id="6878661">c</span><span class="op" id="6878662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878665">w</span><span class="op" id="6878666">.</span><span class="ident" id="6878667">Close</span><span class="op" id="6878672">(</span><span class="op" id="6878673">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878677">readBuf</span>&nbsp;<span class="op" id="6878685">:=</span>&nbsp;<span class="builtinfunc" id="6878688">make</span><span class="op" id="6878692">(</span><span class="op" id="6878693">[</span><span class="op" id="6878694">]</span><span class="builtintype" id="6878695">byte</span><span class="op" id="6878699">,</span>&nbsp;<span class="builtinfunc" id="6878701">len</span><span class="op" id="6878704">(</span><span class="ident" id="6878705">a</span><span class="op" id="6878706">)</span><span class="op" id="6878707">+</span><span class="builtinfunc" id="6878708">len</span><span class="op" id="6878711">(</span><span class="ident" id="6878712">b</span><span class="op" id="6878713">)</span><span class="op" id="6878714">+</span><span class="builtinfunc" id="6878715">len</span><span class="op" id="6878718">(</span><span class="ident" id="6878719">c</span><span class="op" id="6878720">)</span><span class="op" id="6878721">+</span><span class="num" id="6878722">1</span><span class="op" id="6878723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878726">byter</span>&nbsp;<span class="op" id="6878732">:=</span>&nbsp;<span class="ident" id="6878735">bytes</span><span class="op" id="6878740">.</span><span class="ident" id="6878741">NewReader</span><span class="op" id="6878750">(</span><span class="ident" id="6878751">buf</span><span class="op" id="6878754">.</span><span class="ident" id="6878755">Bytes</span><span class="op" id="6878760">(</span><span class="op" id="6878761">)</span><span class="op" id="6878762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878765">bufr</span>&nbsp;<span class="op" id="6878770">:=</span>&nbsp;<span class="ident" id="6878773">bufio</span><span class="op" id="6878778">.</span><span class="ident" id="6878779">NewReader</span><span class="op" id="6878788">(</span><span class="ident" id="6878789">byter</span><span class="op" id="6878794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878797">mallocs</span>&nbsp;<span class="op" id="6878805">:=</span>&nbsp;<span class="ident" id="6878808">testing</span><span class="op" id="6878815">.</span><span class="ident" id="6878816">AllocsPerRun</span><span class="op" id="6878828">(</span><span class="num" id="6878829">100</span><span class="op" id="6878832">,</span>&nbsp;<span class="keyword" id="6878834">func</span><span class="op" id="6878838">(</span><span class="op" id="6878839">)</span>&nbsp;<span class="op" id="6878841">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878845">byter</span><span class="op" id="6878850">.</span><span class="ident" id="6878851">Seek</span><span class="op" id="6878855">(</span><span class="num" id="6878856">0</span><span class="op" id="6878857">,</span>&nbsp;<span class="num" id="6878859">0</span><span class="op" id="6878860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878864">bufr</span><span class="op" id="6878868">.</span><span class="ident" id="6878869">Reset</span><span class="op" id="6878874">(</span><span class="ident" id="6878875">byter</span><span class="op" id="6878880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878884">r</span>&nbsp;<span class="op" id="6878886">:=</span>&nbsp;<span class="ident" id="6878889">NewChunkedReader</span><span class="op" id="6878905">(</span><span class="ident" id="6878906">bufr</span><span class="op" id="6878910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878914">n</span><span class="op" id="6878915">,</span>&nbsp;<span class="ident" id="6878917">err</span>&nbsp;<span class="op" id="6878921">:=</span>&nbsp;<span class="ident" id="6878924">io</span><span class="op" id="6878926">.</span><span class="ident" id="6878927">ReadFull</span><span class="op" id="6878935">(</span><span class="ident" id="6878936">r</span><span class="op" id="6878937">,</span>&nbsp;<span class="ident" id="6878939">readBuf</span><span class="op" id="6878946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878950">if</span>&nbsp;<span class="ident" id="6878953">n</span>&nbsp;<span class="op" id="6878955">!=</span>&nbsp;<span class="builtinfunc" id="6878958">len</span><span class="op" id="6878961">(</span><span class="ident" id="6878962">readBuf</span><span class="op" id="6878969">)</span><span class="op" id="6878970">-</span><span class="num" id="6878971">1</span>&nbsp;<span class="op" id="6878973">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878978">t</span><span class="op" id="6878979">.</span><span class="ident" id="6878980">Fatalf</span><span class="op" id="6878986">(</span><span class="string" id="6878987">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6879011">,</span>&nbsp;<span class="ident" id="6879013">n</span><span class="op" id="6879014">,</span>&nbsp;<span class="builtinfunc" id="6879016">len</span><span class="op" id="6879019">(</span><span class="ident" id="6879020">readBuf</span><span class="op" id="6879027">)</span><span class="op" id="6879028">-</span><span class="num" id="6879029">1</span><span class="op" id="6879030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879038">if</span>&nbsp;<span class="ident" id="6879041">err</span>&nbsp;<span class="op" id="6879045">!=</span>&nbsp;<span class="ident" id="6879048">io</span><span class="op" id="6879050">.</span><span class="ident" id="6879051">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6879068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879073">t</span><span class="op" id="6879074">.</span><span class="ident" id="6879075">Fatalf</span><span class="op" id="6879081">(</span><span class="string" id="6879082">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="6879122">,</span>&nbsp;<span class="ident" id="6879124">err</span><span class="op" id="6879127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879131">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879134">}</span><span class="op" id="6879135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879138">if</span>&nbsp;<span class="ident" id="6879141">mallocs</span>&nbsp;<span class="op" id="6879149">&gt;</span>&nbsp;<span class="num" id="6879151">1.5</span>&nbsp;<span class="op" id="6879155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879159">t</span><span class="op" id="6879160">.</span><span class="ident" id="6879161">Errorf</span><span class="op" id="6879167">(</span><span class="string" id="6879168">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6879190">,</span>&nbsp;<span class="ident" id="6879192">mallocs</span><span class="op" id="6879199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879202">}</span><br>
<span class="lineno"></span><span class="op" id="6879204">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6879207">func</span>&nbsp;<span class="ident" id="6879212">TestParseHexUint</span><span class="op" id="6879228">(</span><span class="ident" id="6879229">t</span>&nbsp;<span class="op" id="6879231">*</span><span class="ident" id="6879232">testing</span><span class="op" id="6879239">.</span><span class="ident" id="6879240">T</span><span class="op" id="6879241">)</span>&nbsp;<span class="op" id="6879243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879246">for</span>&nbsp;<span class="ident" id="6879250">i</span>&nbsp;<span class="op" id="6879252">:=</span>&nbsp;<span class="ident" id="6879255">uint64</span><span class="op" id="6879261">(</span><span class="num" id="6879262">0</span><span class="op" id="6879263">)</span><span class="op" id="6879264">;</span>&nbsp;<span class="ident" id="6879266">i</span>&nbsp;<span class="op" id="6879268">&lt;=</span>&nbsp;<span class="num" id="6879271">1234</span><span class="op" id="6879275">;</span>&nbsp;<span class="ident" id="6879277">i</span><span class="op" id="6879278">++</span>&nbsp;<span class="op" id="6879281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879285">line</span>&nbsp;<span class="op" id="6879290">:=</span>&nbsp;<span class="op" id="6879293">[</span><span class="op" id="6879294">]</span><span class="builtintype" id="6879295">byte</span><span class="op" id="6879299">(</span><span class="ident" id="6879300">fmt</span><span class="op" id="6879303">.</span><span class="ident" id="6879304">Sprintf</span><span class="op" id="6879311">(</span><span class="string" id="6879312">&#34;%x&#34;</span><span class="op" id="6879316">,</span>&nbsp;<span class="ident" id="6879318">i</span><span class="op" id="6879319">)</span><span class="op" id="6879320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879324">got</span><span class="op" id="6879327">,</span>&nbsp;<span class="ident" id="6879329">err</span>&nbsp;<span class="op" id="6879333">:=</span>&nbsp;<span class="ident" id="6879336">parseHexUint</span><span class="op" id="6879348">(</span><span class="ident" id="6879349">line</span><span class="op" id="6879353">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879357">if</span>&nbsp;<span class="ident" id="6879360">err</span>&nbsp;<span class="op" id="6879364">!=</span>&nbsp;<span class="ident" id="6879367">nil</span>&nbsp;<span class="op" id="6879371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879376">t</span><span class="op" id="6879377">.</span><span class="ident" id="6879378">Fatalf</span><span class="op" id="6879384">(</span><span class="string" id="6879385">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6879396">,</span>&nbsp;<span class="ident" id="6879398">i</span><span class="op" id="6879399">,</span>&nbsp;<span class="ident" id="6879401">err</span><span class="op" id="6879404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879412">if</span>&nbsp;<span class="ident" id="6879415">got</span>&nbsp;<span class="op" id="6879419">!=</span>&nbsp;<span class="ident" id="6879422">i</span>&nbsp;<span class="op" id="6879424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879429">t</span><span class="op" id="6879430">.</span><span class="ident" id="6879431">Errorf</span><span class="op" id="6879437">(</span><span class="string" id="6879438">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6879466">,</span>&nbsp;<span class="ident" id="6879468">line</span><span class="op" id="6879472">,</span>&nbsp;<span class="ident" id="6879474">got</span><span class="op" id="6879477">,</span>&nbsp;<span class="ident" id="6879479">i</span><span class="op" id="6879480">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879490">_</span><span class="op" id="6879491">,</span>&nbsp;<span class="ident" id="6879493">err</span>&nbsp;<span class="op" id="6879497">:=</span>&nbsp;<span class="ident" id="6879500">parseHexUint</span><span class="op" id="6879512">(</span><span class="op" id="6879513">[</span><span class="op" id="6879514">]</span><span class="builtintype" id="6879515">byte</span><span class="op" id="6879519">(</span><span class="string" id="6879520">&#34;bogus&#34;</span><span class="op" id="6879527">)</span><span class="op" id="6879528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879531">if</span>&nbsp;<span class="ident" id="6879534">err</span>&nbsp;<span class="op" id="6879538">==</span>&nbsp;<span class="ident" id="6879541">nil</span>&nbsp;<span class="op" id="6879545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879549">t</span><span class="op" id="6879550">.</span><span class="ident" id="6879551">Error</span><span class="op" id="6879556">(</span><span class="string" id="6879557">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="6879588">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879591">}</span><br>
<span class="lineno"></span><span class="op" id="6879593">}</span>
</div>
</body>
</html>
