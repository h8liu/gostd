<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1540932">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1540987">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1541041">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1541092">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1541113">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1541170">package</span>&nbsp;<span class="ident" id="1541178">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1541187">import</span>&nbsp;<span class="op" id="1541194">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1541197">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1541206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1541209">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1541284">var</span>&nbsp;<span class="ident" id="1541288">proflock</span>&nbsp;<span class="ident" id="1541297">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1541304">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1541383">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1541457">const</span>&nbsp;<span class="op" id="1541463">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541466">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541484">memProfile</span>&nbsp;<span class="ident" id="1541495">bucketType</span>&nbsp;<span class="op" id="1541506">=</span>&nbsp;<span class="num" id="1541508">1</span>&nbsp;<span class="op" id="1541510">+</span>&nbsp;<span class="ident" id="1541512">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541518">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541533">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541563">buckHashSize</span>&nbsp;<span class="op" id="1541576">=</span>&nbsp;<span class="num" id="1541578">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541587">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541630">maxStack</span>&nbsp;<span class="op" id="1541639">=</span>&nbsp;<span class="num" id="1541641">32</span><br>
<span class="lineno">30</span><span class="op" id="1541644">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1541647">type</span>&nbsp;<span class="ident" id="1541652">bucketType</span>&nbsp;<span class="builtintype" id="1541663">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1541668">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1541724">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1541781">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1541841">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1541897">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1541943">//</span><br>
<span class="lineno">40</span><span class="comment" id="1541946">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1541987">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1542050">type</span>&nbsp;<span class="ident" id="1542055">bucket</span>&nbsp;<span class="keyword" id="1542062">struct</span>&nbsp;<span class="op" id="1542069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542072">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542080">*</span><span class="ident" id="1542081">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542089">allnext</span>&nbsp;<span class="op" id="1542097">*</span><span class="ident" id="1542098">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542106">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542114">bucketType</span>&nbsp;<span class="comment" id="1542125">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542154">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1542162">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542171">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1542179">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542188">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1542196">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1542204">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1542207">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1542274">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1542305">type</span>&nbsp;<span class="ident" id="1542310">memRecord</span>&nbsp;<span class="keyword" id="1542320">struct</span>&nbsp;<span class="op" id="1542327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542330">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542393">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542461">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542489">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542552">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542620">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542680">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542684">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542727">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542777">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542819">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542872">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542916">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1542928">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542937">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1542949">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542958">alloc_bytes</span>&nbsp;<span class="builtintype" id="1542970">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542979">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1542991">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543001">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543049">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1543066">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543075">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1543092">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543101">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1543118">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543127">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1543144">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1543154">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543180">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1543199">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543208">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1543227">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543236">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1543255">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543264">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1543283">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1543291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1543294">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1543365">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1543398">type</span>&nbsp;<span class="ident" id="1543403">blockRecord</span>&nbsp;<span class="keyword" id="1543415">struct</span>&nbsp;<span class="op" id="1543422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543425">count</span>&nbsp;&nbsp;<span class="ident" id="1543432">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543439">cycles</span>&nbsp;<span class="ident" id="1543446">int64</span><br>
<span class="lineno"></span><span class="op" id="1543452">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1543455">var</span>&nbsp;<span class="op" id="1543459">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543462">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1543472">*</span><span class="ident" id="1543473">bucket</span>&nbsp;<span class="comment" id="1543480">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543507">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1543517">*</span><span class="ident" id="1543518">bucket</span>&nbsp;<span class="comment" id="1543525">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543554">buckhash</span>&nbsp;&nbsp;<span class="op" id="1543564">*</span><span class="op" id="1543565">[</span><span class="num" id="1543566">179999</span><span class="op" id="1543572">]</span><span class="op" id="1543573">*</span><span class="ident" id="1543574">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543582">bucketmem</span>&nbsp;<span class="builtintype" id="1543592">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1543600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1543603">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1543684">func</span>&nbsp;<span class="ident" id="1543689">newBucket</span><span class="op" id="1543698">(</span><span class="ident" id="1543699">typ</span>&nbsp;<span class="ident" id="1543703">bucketType</span><span class="op" id="1543713">,</span>&nbsp;<span class="ident" id="1543715">nstk</span>&nbsp;<span class="builtintype" id="1543720">int</span><span class="op" id="1543723">)</span>&nbsp;<span class="op" id="1543725">*</span><span class="ident" id="1543726">bucket</span>&nbsp;<span class="op" id="1543733">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543736">size</span>&nbsp;<span class="op" id="1543741">:=</span>&nbsp;<span class="ident" id="1543744">unsafe</span><span class="op" id="1543750">.</span><span class="ident" id="1543751">Sizeof</span><span class="op" id="1543757">(</span><span class="ident" id="1543758">bucket</span><span class="op" id="1543764">{</span><span class="op" id="1543765">}</span><span class="op" id="1543766">)</span>&nbsp;<span class="op" id="1543768">+</span>&nbsp;<span class="builtintype" id="1543770">uintptr</span><span class="op" id="1543777">(</span><span class="ident" id="1543778">nstk</span><span class="op" id="1543782">)</span><span class="op" id="1543783">*</span><span class="ident" id="1543784">unsafe</span><span class="op" id="1543790">.</span><span class="ident" id="1543791">Sizeof</span><span class="op" id="1543797">(</span><span class="builtintype" id="1543798">uintptr</span><span class="op" id="1543805">(</span><span class="num" id="1543806">0</span><span class="op" id="1543807">)</span><span class="op" id="1543808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543811">switch</span>&nbsp;<span class="ident" id="1543818">typ</span>&nbsp;<span class="op" id="1543822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543825">default</span><span class="op" id="1543832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543836">gothrow</span><span class="op" id="1543843">(</span><span class="string" id="1543844">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1543873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543876">case</span>&nbsp;<span class="ident" id="1543881">memProfile</span><span class="op" id="1543891">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543895">size</span>&nbsp;<span class="op" id="1543900">+=</span>&nbsp;<span class="ident" id="1543903">unsafe</span><span class="op" id="1543909">.</span><span class="ident" id="1543910">Sizeof</span><span class="op" id="1543916">(</span><span class="ident" id="1543917">memRecord</span><span class="op" id="1543926">{</span><span class="op" id="1543927">}</span><span class="op" id="1543928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543931">case</span>&nbsp;<span class="ident" id="1543936">blockProfile</span><span class="op" id="1543948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543952">size</span>&nbsp;<span class="op" id="1543957">+=</span>&nbsp;<span class="ident" id="1543960">unsafe</span><span class="op" id="1543966">.</span><span class="ident" id="1543967">Sizeof</span><span class="op" id="1543973">(</span><span class="ident" id="1543974">blockRecord</span><span class="op" id="1543985">{</span><span class="op" id="1543986">}</span><span class="op" id="1543987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543994">b</span>&nbsp;<span class="op" id="1543996">:=</span>&nbsp;<span class="op" id="1543999">(</span><span class="op" id="1544000">*</span><span class="ident" id="1544001">bucket</span><span class="op" id="1544007">)</span><span class="op" id="1544008">(</span><span class="ident" id="1544009">persistentalloc</span><span class="op" id="1544024">(</span><span class="ident" id="1544025">size</span><span class="op" id="1544029">,</span>&nbsp;<span class="num" id="1544031">0</span><span class="op" id="1544032">,</span>&nbsp;<span class="op" id="1544034">&amp;</span><span class="ident" id="1544035">memstats</span><span class="op" id="1544043">.</span><span class="ident" id="1544044">buckhash_sys</span><span class="op" id="1544056">)</span><span class="op" id="1544057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544060">bucketmem</span>&nbsp;<span class="op" id="1544070">+=</span>&nbsp;<span class="ident" id="1544073">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544079">b</span><span class="op" id="1544080">.</span><span class="ident" id="1544081">typ</span>&nbsp;<span class="op" id="1544085">=</span>&nbsp;<span class="ident" id="1544087">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544092">b</span><span class="op" id="1544093">.</span><span class="ident" id="1544094">nstk</span>&nbsp;<span class="op" id="1544099">=</span>&nbsp;<span class="builtintype" id="1544101">uintptr</span><span class="op" id="1544108">(</span><span class="ident" id="1544109">nstk</span><span class="op" id="1544113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544116">return</span>&nbsp;<span class="ident" id="1544123">b</span><br>
<span class="lineno">115</span><span class="op" id="1544125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1544128">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1544177">func</span>&nbsp;<span class="op" id="1544182">(</span><span class="ident" id="1544183">b</span>&nbsp;<span class="op" id="1544185">*</span><span class="ident" id="1544186">bucket</span><span class="op" id="1544192">)</span>&nbsp;<span class="ident" id="1544194">stk</span><span class="op" id="1544197">(</span><span class="op" id="1544198">)</span>&nbsp;<span class="op" id="1544200">[</span><span class="op" id="1544201">]</span><span class="builtintype" id="1544202">uintptr</span>&nbsp;<span class="op" id="1544210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544213">stk</span>&nbsp;<span class="op" id="1544217">:=</span>&nbsp;<span class="op" id="1544220">(</span><span class="op" id="1544221">*</span><span class="op" id="1544222">[</span><span class="ident" id="1544223">maxStack</span><span class="op" id="1544231">]</span><span class="builtintype" id="1544232">uintptr</span><span class="op" id="1544239">)</span><span class="op" id="1544240">(</span><span class="ident" id="1544241">add</span><span class="op" id="1544244">(</span><span class="ident" id="1544245">unsafe</span><span class="op" id="1544251">.</span><span class="ident" id="1544252">Pointer</span><span class="op" id="1544259">(</span><span class="ident" id="1544260">b</span><span class="op" id="1544261">)</span><span class="op" id="1544262">,</span>&nbsp;<span class="ident" id="1544264">unsafe</span><span class="op" id="1544270">.</span><span class="ident" id="1544271">Sizeof</span><span class="op" id="1544277">(</span><span class="op" id="1544278">*</span><span class="ident" id="1544279">b</span><span class="op" id="1544280">)</span><span class="op" id="1544281">)</span><span class="op" id="1544282">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544285">return</span>&nbsp;<span class="ident" id="1544292">stk</span><span class="op" id="1544295">[</span><span class="op" id="1544296">:</span><span class="ident" id="1544297">b</span><span class="op" id="1544298">.</span><span class="ident" id="1544299">nstk</span><span class="op" id="1544303">:</span><span class="ident" id="1544304">b</span><span class="op" id="1544305">.</span><span class="ident" id="1544306">nstk</span><span class="op" id="1544310">]</span><br>
<span class="lineno"></span><span class="op" id="1544312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1544315">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1544384">func</span>&nbsp;<span class="op" id="1544389">(</span><span class="ident" id="1544390">b</span>&nbsp;<span class="op" id="1544392">*</span><span class="ident" id="1544393">bucket</span><span class="op" id="1544399">)</span>&nbsp;<span class="ident" id="1544401">mp</span><span class="op" id="1544403">(</span><span class="op" id="1544404">)</span>&nbsp;<span class="op" id="1544406">*</span><span class="ident" id="1544407">memRecord</span>&nbsp;<span class="op" id="1544417">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544420">if</span>&nbsp;<span class="ident" id="1544423">b</span><span class="op" id="1544424">.</span><span class="ident" id="1544425">typ</span>&nbsp;<span class="op" id="1544429">!=</span>&nbsp;<span class="ident" id="1544432">memProfile</span>&nbsp;<span class="op" id="1544443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544447">gothrow</span><span class="op" id="1544454">(</span><span class="string" id="1544455">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1544477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544483">data</span>&nbsp;<span class="op" id="1544488">:=</span>&nbsp;<span class="ident" id="1544491">add</span><span class="op" id="1544494">(</span><span class="ident" id="1544495">unsafe</span><span class="op" id="1544501">.</span><span class="ident" id="1544502">Pointer</span><span class="op" id="1544509">(</span><span class="ident" id="1544510">b</span><span class="op" id="1544511">)</span><span class="op" id="1544512">,</span>&nbsp;<span class="ident" id="1544514">unsafe</span><span class="op" id="1544520">.</span><span class="ident" id="1544521">Sizeof</span><span class="op" id="1544527">(</span><span class="op" id="1544528">*</span><span class="ident" id="1544529">b</span><span class="op" id="1544530">)</span><span class="op" id="1544531">+</span><span class="ident" id="1544532">b</span><span class="op" id="1544533">.</span><span class="ident" id="1544534">nstk</span><span class="op" id="1544538">*</span><span class="ident" id="1544539">unsafe</span><span class="op" id="1544545">.</span><span class="ident" id="1544546">Sizeof</span><span class="op" id="1544552">(</span><span class="builtintype" id="1544553">uintptr</span><span class="op" id="1544560">(</span><span class="num" id="1544561">0</span><span class="op" id="1544562">)</span><span class="op" id="1544563">)</span><span class="op" id="1544564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544567">return</span>&nbsp;<span class="op" id="1544574">(</span><span class="op" id="1544575">*</span><span class="ident" id="1544576">memRecord</span><span class="op" id="1544585">)</span><span class="op" id="1544586">(</span><span class="ident" id="1544587">data</span><span class="op" id="1544591">)</span><br>
<span class="lineno">130</span><span class="op" id="1544593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1544596">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1544669">func</span>&nbsp;<span class="op" id="1544674">(</span><span class="ident" id="1544675">b</span>&nbsp;<span class="op" id="1544677">*</span><span class="ident" id="1544678">bucket</span><span class="op" id="1544684">)</span>&nbsp;<span class="ident" id="1544686">bp</span><span class="op" id="1544688">(</span><span class="op" id="1544689">)</span>&nbsp;<span class="op" id="1544691">*</span><span class="ident" id="1544692">blockRecord</span>&nbsp;<span class="op" id="1544704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544707">if</span>&nbsp;<span class="ident" id="1544710">b</span><span class="op" id="1544711">.</span><span class="ident" id="1544712">typ</span>&nbsp;<span class="op" id="1544716">!=</span>&nbsp;<span class="ident" id="1544719">blockProfile</span>&nbsp;<span class="op" id="1544732">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544736">gothrow</span><span class="op" id="1544743">(</span><span class="string" id="1544744">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1544766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544772">data</span>&nbsp;<span class="op" id="1544777">:=</span>&nbsp;<span class="ident" id="1544780">add</span><span class="op" id="1544783">(</span><span class="ident" id="1544784">unsafe</span><span class="op" id="1544790">.</span><span class="ident" id="1544791">Pointer</span><span class="op" id="1544798">(</span><span class="ident" id="1544799">b</span><span class="op" id="1544800">)</span><span class="op" id="1544801">,</span>&nbsp;<span class="ident" id="1544803">unsafe</span><span class="op" id="1544809">.</span><span class="ident" id="1544810">Sizeof</span><span class="op" id="1544816">(</span><span class="op" id="1544817">*</span><span class="ident" id="1544818">b</span><span class="op" id="1544819">)</span><span class="op" id="1544820">+</span><span class="ident" id="1544821">b</span><span class="op" id="1544822">.</span><span class="ident" id="1544823">nstk</span><span class="op" id="1544827">*</span><span class="ident" id="1544828">unsafe</span><span class="op" id="1544834">.</span><span class="ident" id="1544835">Sizeof</span><span class="op" id="1544841">(</span><span class="builtintype" id="1544842">uintptr</span><span class="op" id="1544849">(</span><span class="num" id="1544850">0</span><span class="op" id="1544851">)</span><span class="op" id="1544852">)</span><span class="op" id="1544853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544856">return</span>&nbsp;<span class="op" id="1544863">(</span><span class="op" id="1544864">*</span><span class="ident" id="1544865">blockRecord</span><span class="op" id="1544876">)</span><span class="op" id="1544877">(</span><span class="ident" id="1544878">data</span><span class="op" id="1544882">)</span><br>
<span class="lineno"></span><span class="op" id="1544884">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1544887">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1544958">func</span>&nbsp;<span class="ident" id="1544963">stkbucket</span><span class="op" id="1544972">(</span><span class="ident" id="1544973">typ</span>&nbsp;<span class="ident" id="1544977">bucketType</span><span class="op" id="1544987">,</span>&nbsp;<span class="ident" id="1544989">size</span>&nbsp;<span class="builtintype" id="1544994">uintptr</span><span class="op" id="1545001">,</span>&nbsp;<span class="ident" id="1545003">stk</span>&nbsp;<span class="op" id="1545007">[</span><span class="op" id="1545008">]</span><span class="builtintype" id="1545009">uintptr</span><span class="op" id="1545016">,</span>&nbsp;<span class="ident" id="1545018">alloc</span>&nbsp;<span class="builtintype" id="1545024">bool</span><span class="op" id="1545028">)</span>&nbsp;<span class="op" id="1545030">*</span><span class="ident" id="1545031">bucket</span>&nbsp;<span class="op" id="1545038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545041">if</span>&nbsp;<span class="ident" id="1545044">buckhash</span>&nbsp;<span class="op" id="1545053">==</span>&nbsp;<span class="ident" id="1545056">nil</span>&nbsp;<span class="op" id="1545060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545064">buckhash</span>&nbsp;<span class="op" id="1545073">=</span>&nbsp;<span class="op" id="1545075">(</span><span class="op" id="1545076">*</span><span class="op" id="1545077">[</span><span class="ident" id="1545078">buckHashSize</span><span class="op" id="1545090">]</span><span class="op" id="1545091">*</span><span class="ident" id="1545092">bucket</span><span class="op" id="1545098">)</span><span class="op" id="1545099">(</span><span class="ident" id="1545100">sysAlloc</span><span class="op" id="1545108">(</span><span class="ident" id="1545109">unsafe</span><span class="op" id="1545115">.</span><span class="ident" id="1545116">Sizeof</span><span class="op" id="1545122">(</span><span class="op" id="1545123">*</span><span class="ident" id="1545124">buckhash</span><span class="op" id="1545132">)</span><span class="op" id="1545133">,</span>&nbsp;<span class="op" id="1545135">&amp;</span><span class="ident" id="1545136">memstats</span><span class="op" id="1545144">.</span><span class="ident" id="1545145">buckhash_sys</span><span class="op" id="1545157">)</span><span class="op" id="1545158">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545162">if</span>&nbsp;<span class="ident" id="1545165">buckhash</span>&nbsp;<span class="op" id="1545174">==</span>&nbsp;<span class="ident" id="1545177">nil</span>&nbsp;<span class="op" id="1545181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545186">gothrow</span><span class="op" id="1545193">(</span><span class="string" id="1545194">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1545227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545238">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545254">var</span>&nbsp;<span class="ident" id="1545258">h</span>&nbsp;<span class="builtintype" id="1545260">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545269">for</span>&nbsp;<span class="ident" id="1545273">_</span><span class="op" id="1545274">,</span>&nbsp;<span class="ident" id="1545276">pc</span>&nbsp;<span class="op" id="1545279">:=</span>&nbsp;<span class="keyword" id="1545282">range</span>&nbsp;<span class="ident" id="1545288">stk</span>&nbsp;<span class="op" id="1545292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545296">h</span>&nbsp;<span class="op" id="1545298">+=</span>&nbsp;<span class="ident" id="1545301">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545306">h</span>&nbsp;<span class="op" id="1545308">+=</span>&nbsp;<span class="ident" id="1545311">h</span>&nbsp;<span class="op" id="1545313">&lt;&lt;</span>&nbsp;<span class="num" id="1545316">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545321">h</span>&nbsp;<span class="op" id="1545323">^=</span>&nbsp;<span class="ident" id="1545326">h</span>&nbsp;<span class="op" id="1545328">&gt;&gt;</span>&nbsp;<span class="num" id="1545331">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545337">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545354">h</span>&nbsp;<span class="op" id="1545356">+=</span>&nbsp;<span class="ident" id="1545359">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545365">h</span>&nbsp;<span class="op" id="1545367">+=</span>&nbsp;<span class="ident" id="1545370">h</span>&nbsp;<span class="op" id="1545372">&lt;&lt;</span>&nbsp;<span class="num" id="1545375">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545379">h</span>&nbsp;<span class="op" id="1545381">^=</span>&nbsp;<span class="ident" id="1545384">h</span>&nbsp;<span class="op" id="1545386">&gt;&gt;</span>&nbsp;<span class="num" id="1545389">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545392">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545405">h</span>&nbsp;<span class="op" id="1545407">+=</span>&nbsp;<span class="ident" id="1545410">h</span>&nbsp;<span class="op" id="1545412">&lt;&lt;</span>&nbsp;<span class="num" id="1545415">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545418">h</span>&nbsp;<span class="op" id="1545420">^=</span>&nbsp;<span class="ident" id="1545423">h</span>&nbsp;<span class="op" id="1545425">&gt;&gt;</span>&nbsp;<span class="num" id="1545428">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545433">i</span>&nbsp;<span class="op" id="1545435">:=</span>&nbsp;<span class="builtintype" id="1545438">int</span><span class="op" id="1545441">(</span><span class="ident" id="1545442">h</span>&nbsp;<span class="op" id="1545444">%</span>&nbsp;<span class="ident" id="1545446">buckHashSize</span><span class="op" id="1545458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545461">for</span>&nbsp;<span class="ident" id="1545465">b</span>&nbsp;<span class="op" id="1545467">:=</span>&nbsp;<span class="ident" id="1545470">buckhash</span><span class="op" id="1545478">[</span><span class="ident" id="1545479">i</span><span class="op" id="1545480">]</span><span class="op" id="1545481">;</span>&nbsp;<span class="ident" id="1545483">b</span>&nbsp;<span class="op" id="1545485">!=</span>&nbsp;<span class="ident" id="1545488">nil</span><span class="op" id="1545491">;</span>&nbsp;<span class="ident" id="1545493">b</span>&nbsp;<span class="op" id="1545495">=</span>&nbsp;<span class="ident" id="1545497">b</span><span class="op" id="1545498">.</span><span class="ident" id="1545499">next</span>&nbsp;<span class="op" id="1545504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545508">if</span>&nbsp;<span class="ident" id="1545511">b</span><span class="op" id="1545512">.</span><span class="ident" id="1545513">typ</span>&nbsp;<span class="op" id="1545517">==</span>&nbsp;<span class="ident" id="1545520">typ</span>&nbsp;<span class="op" id="1545524">&amp;&amp;</span>&nbsp;<span class="ident" id="1545527">b</span><span class="op" id="1545528">.</span><span class="ident" id="1545529">hash</span>&nbsp;<span class="op" id="1545534">==</span>&nbsp;<span class="ident" id="1545537">h</span>&nbsp;<span class="op" id="1545539">&amp;&amp;</span>&nbsp;<span class="ident" id="1545542">b</span><span class="op" id="1545543">.</span><span class="ident" id="1545544">size</span>&nbsp;<span class="op" id="1545549">==</span>&nbsp;<span class="ident" id="1545552">size</span>&nbsp;<span class="op" id="1545557">&amp;&amp;</span>&nbsp;<span class="ident" id="1545560">eqslice</span><span class="op" id="1545567">(</span><span class="ident" id="1545568">b</span><span class="op" id="1545569">.</span><span class="ident" id="1545570">stk</span><span class="op" id="1545573">(</span><span class="op" id="1545574">)</span><span class="op" id="1545575">,</span>&nbsp;<span class="ident" id="1545577">stk</span><span class="op" id="1545580">)</span>&nbsp;<span class="op" id="1545582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545587">return</span>&nbsp;<span class="ident" id="1545594">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545598">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545605">if</span>&nbsp;<span class="op" id="1545608">!</span><span class="ident" id="1545609">alloc</span>&nbsp;<span class="op" id="1545615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545619">return</span>&nbsp;<span class="ident" id="1545626">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545631">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545635">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545658">b</span>&nbsp;<span class="op" id="1545660">:=</span>&nbsp;<span class="ident" id="1545663">newBucket</span><span class="op" id="1545672">(</span><span class="ident" id="1545673">typ</span><span class="op" id="1545676">,</span>&nbsp;<span class="builtinfunc" id="1545678">len</span><span class="op" id="1545681">(</span><span class="ident" id="1545682">stk</span><span class="op" id="1545685">)</span><span class="op" id="1545686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1545689">copy</span><span class="op" id="1545693">(</span><span class="ident" id="1545694">b</span><span class="op" id="1545695">.</span><span class="ident" id="1545696">stk</span><span class="op" id="1545699">(</span><span class="op" id="1545700">)</span><span class="op" id="1545701">,</span>&nbsp;<span class="ident" id="1545703">stk</span><span class="op" id="1545706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545709">b</span><span class="op" id="1545710">.</span><span class="ident" id="1545711">hash</span>&nbsp;<span class="op" id="1545716">=</span>&nbsp;<span class="ident" id="1545718">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545721">b</span><span class="op" id="1545722">.</span><span class="ident" id="1545723">size</span>&nbsp;<span class="op" id="1545728">=</span>&nbsp;<span class="ident" id="1545730">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545736">b</span><span class="op" id="1545737">.</span><span class="ident" id="1545738">next</span>&nbsp;<span class="op" id="1545743">=</span>&nbsp;<span class="ident" id="1545745">buckhash</span><span class="op" id="1545753">[</span><span class="ident" id="1545754">i</span><span class="op" id="1545755">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545758">buckhash</span><span class="op" id="1545766">[</span><span class="ident" id="1545767">i</span><span class="op" id="1545768">]</span>&nbsp;<span class="op" id="1545770">=</span>&nbsp;<span class="ident" id="1545772">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545775">if</span>&nbsp;<span class="ident" id="1545778">typ</span>&nbsp;<span class="op" id="1545782">==</span>&nbsp;<span class="ident" id="1545785">memProfile</span>&nbsp;<span class="op" id="1545796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545800">b</span><span class="op" id="1545801">.</span><span class="ident" id="1545802">allnext</span>&nbsp;<span class="op" id="1545810">=</span>&nbsp;<span class="ident" id="1545812">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545823">mbuckets</span>&nbsp;<span class="op" id="1545832">=</span>&nbsp;<span class="ident" id="1545834">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545837">}</span>&nbsp;<span class="keyword" id="1545839">else</span>&nbsp;<span class="op" id="1545844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545848">b</span><span class="op" id="1545849">.</span><span class="ident" id="1545850">allnext</span>&nbsp;<span class="op" id="1545858">=</span>&nbsp;<span class="ident" id="1545860">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545871">bbuckets</span>&nbsp;<span class="op" id="1545880">=</span>&nbsp;<span class="ident" id="1545882">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545885">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545888">return</span>&nbsp;<span class="ident" id="1545895">b</span><br>
<span class="lineno"></span><span class="op" id="1545897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1545900">func</span>&nbsp;<span class="ident" id="1545905">sysAlloc</span><span class="op" id="1545913">(</span><span class="ident" id="1545914">n</span>&nbsp;<span class="builtintype" id="1545916">uintptr</span><span class="op" id="1545923">,</span>&nbsp;<span class="ident" id="1545925">stat</span>&nbsp;<span class="op" id="1545930">*</span><span class="ident" id="1545931">uint64</span><span class="op" id="1545937">)</span>&nbsp;<span class="ident" id="1545939">unsafe</span><span class="op" id="1545945">.</span><span class="ident" id="1545946">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1545955">func</span>&nbsp;<span class="ident" id="1545960">eqslice</span><span class="op" id="1545967">(</span><span class="ident" id="1545968">x</span><span class="op" id="1545969">,</span>&nbsp;<span class="ident" id="1545971">y</span>&nbsp;<span class="op" id="1545973">[</span><span class="op" id="1545974">]</span><span class="builtintype" id="1545975">uintptr</span><span class="op" id="1545982">)</span>&nbsp;<span class="builtintype" id="1545984">bool</span>&nbsp;<span class="op" id="1545989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545992">if</span>&nbsp;<span class="builtinfunc" id="1545995">len</span><span class="op" id="1545998">(</span><span class="ident" id="1545999">x</span><span class="op" id="1546000">)</span>&nbsp;<span class="op" id="1546002">!=</span>&nbsp;<span class="builtinfunc" id="1546005">len</span><span class="op" id="1546008">(</span><span class="ident" id="1546009">y</span><span class="op" id="1546010">)</span>&nbsp;<span class="op" id="1546012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546016">return</span>&nbsp;<span class="builtintype" id="1546023">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546033">for</span>&nbsp;<span class="ident" id="1546037">i</span><span class="op" id="1546038">,</span>&nbsp;<span class="ident" id="1546040">xi</span>&nbsp;<span class="op" id="1546043">:=</span>&nbsp;<span class="keyword" id="1546046">range</span>&nbsp;<span class="ident" id="1546052">x</span>&nbsp;<span class="op" id="1546054">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546058">if</span>&nbsp;<span class="ident" id="1546061">xi</span>&nbsp;<span class="op" id="1546064">!=</span>&nbsp;<span class="ident" id="1546067">y</span><span class="op" id="1546068">[</span><span class="ident" id="1546069">i</span><span class="op" id="1546070">]</span>&nbsp;<span class="op" id="1546072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546077">return</span>&nbsp;<span class="builtintype" id="1546084">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546098">return</span>&nbsp;<span class="builtintype" id="1546105">true</span><br>
<span class="lineno">205</span><span class="op" id="1546110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546113">func</span>&nbsp;<span class="ident" id="1546118">mprof_GC</span><span class="op" id="1546126">(</span><span class="op" id="1546127">)</span>&nbsp;<span class="op" id="1546129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546132">for</span>&nbsp;<span class="ident" id="1546136">b</span>&nbsp;<span class="op" id="1546138">:=</span>&nbsp;<span class="ident" id="1546141">mbuckets</span><span class="op" id="1546149">;</span>&nbsp;<span class="ident" id="1546151">b</span>&nbsp;<span class="op" id="1546153">!=</span>&nbsp;<span class="ident" id="1546156">nil</span><span class="op" id="1546159">;</span>&nbsp;<span class="ident" id="1546161">b</span>&nbsp;<span class="op" id="1546163">=</span>&nbsp;<span class="ident" id="1546165">b</span><span class="op" id="1546166">.</span><span class="ident" id="1546167">allnext</span>&nbsp;<span class="op" id="1546175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546179">mp</span>&nbsp;<span class="op" id="1546182">:=</span>&nbsp;<span class="ident" id="1546185">b</span><span class="op" id="1546186">.</span><span class="ident" id="1546187">mp</span><span class="op" id="1546189">(</span><span class="op" id="1546190">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546194">mp</span><span class="op" id="1546196">.</span><span class="ident" id="1546197">allocs</span>&nbsp;<span class="op" id="1546204">+=</span>&nbsp;<span class="ident" id="1546207">mp</span><span class="op" id="1546209">.</span><span class="ident" id="1546210">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546224">mp</span><span class="op" id="1546226">.</span><span class="ident" id="1546227">frees</span>&nbsp;<span class="op" id="1546233">+=</span>&nbsp;<span class="ident" id="1546236">mp</span><span class="op" id="1546238">.</span><span class="ident" id="1546239">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546252">mp</span><span class="op" id="1546254">.</span><span class="ident" id="1546255">alloc_bytes</span>&nbsp;<span class="op" id="1546267">+=</span>&nbsp;<span class="ident" id="1546270">mp</span><span class="op" id="1546272">.</span><span class="ident" id="1546273">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546292">mp</span><span class="op" id="1546294">.</span><span class="ident" id="1546295">free_bytes</span>&nbsp;<span class="op" id="1546306">+=</span>&nbsp;<span class="ident" id="1546309">mp</span><span class="op" id="1546311">.</span><span class="ident" id="1546312">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546331">mp</span><span class="op" id="1546333">.</span><span class="ident" id="1546334">prev_allocs</span>&nbsp;<span class="op" id="1546346">=</span>&nbsp;<span class="ident" id="1546348">mp</span><span class="op" id="1546350">.</span><span class="ident" id="1546351">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546367">mp</span><span class="op" id="1546369">.</span><span class="ident" id="1546370">prev_frees</span>&nbsp;<span class="op" id="1546381">=</span>&nbsp;<span class="ident" id="1546383">mp</span><span class="op" id="1546385">.</span><span class="ident" id="1546386">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546401">mp</span><span class="op" id="1546403">.</span><span class="ident" id="1546404">prev_alloc_bytes</span>&nbsp;<span class="op" id="1546421">=</span>&nbsp;<span class="ident" id="1546423">mp</span><span class="op" id="1546425">.</span><span class="ident" id="1546426">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546447">mp</span><span class="op" id="1546449">.</span><span class="ident" id="1546450">prev_free_bytes</span>&nbsp;<span class="op" id="1546466">=</span>&nbsp;<span class="ident" id="1546468">mp</span><span class="op" id="1546470">.</span><span class="ident" id="1546471">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546492">mp</span><span class="op" id="1546494">.</span><span class="ident" id="1546495">recent_allocs</span>&nbsp;<span class="op" id="1546509">=</span>&nbsp;<span class="num" id="1546511">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546515">mp</span><span class="op" id="1546517">.</span><span class="ident" id="1546518">recent_frees</span>&nbsp;<span class="op" id="1546531">=</span>&nbsp;<span class="num" id="1546533">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546537">mp</span><span class="op" id="1546539">.</span><span class="ident" id="1546540">recent_alloc_bytes</span>&nbsp;<span class="op" id="1546559">=</span>&nbsp;<span class="num" id="1546561">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546565">mp</span><span class="op" id="1546567">.</span><span class="ident" id="1546568">recent_free_bytes</span>&nbsp;<span class="op" id="1546586">=</span>&nbsp;<span class="num" id="1546588">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546591">}</span><br>
<span class="lineno">225</span><span class="op" id="1546593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1546596">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1546673">func</span>&nbsp;<span class="ident" id="1546678">mProf_GC</span><span class="op" id="1546686">(</span><span class="op" id="1546687">)</span>&nbsp;<span class="op" id="1546689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546692">lock</span><span class="op" id="1546696">(</span><span class="op" id="1546697">&amp;</span><span class="ident" id="1546698">proflock</span><span class="op" id="1546706">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546709">mprof_GC</span><span class="op" id="1546717">(</span><span class="op" id="1546718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546721">unlock</span><span class="op" id="1546727">(</span><span class="op" id="1546728">&amp;</span><span class="ident" id="1546729">proflock</span><span class="op" id="1546737">)</span><br>
<span class="lineno"></span><span class="op" id="1546739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1546742">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1546790">func</span>&nbsp;<span class="ident" id="1546795">mProf_Malloc</span><span class="op" id="1546807">(</span><span class="ident" id="1546808">p</span>&nbsp;<span class="ident" id="1546810">unsafe</span><span class="op" id="1546816">.</span><span class="ident" id="1546817">Pointer</span><span class="op" id="1546824">,</span>&nbsp;<span class="ident" id="1546826">size</span>&nbsp;<span class="builtintype" id="1546831">uintptr</span><span class="op" id="1546838">)</span>&nbsp;<span class="op" id="1546840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546843">var</span>&nbsp;<span class="ident" id="1546847">stk</span>&nbsp;<span class="op" id="1546851">[</span><span class="ident" id="1546852">maxStack</span><span class="op" id="1546860">]</span><span class="builtintype" id="1546861">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546870">nstk</span>&nbsp;<span class="op" id="1546875">:=</span>&nbsp;<span class="ident" id="1546878">callers</span><span class="op" id="1546885">(</span><span class="num" id="1546886">4</span><span class="op" id="1546887">,</span>&nbsp;<span class="op" id="1546889">&amp;</span><span class="ident" id="1546890">stk</span><span class="op" id="1546893">[</span><span class="num" id="1546894">0</span><span class="op" id="1546895">]</span><span class="op" id="1546896">,</span>&nbsp;<span class="builtinfunc" id="1546898">len</span><span class="op" id="1546901">(</span><span class="ident" id="1546902">stk</span><span class="op" id="1546905">)</span><span class="op" id="1546906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546909">lock</span><span class="op" id="1546913">(</span><span class="op" id="1546914">&amp;</span><span class="ident" id="1546915">proflock</span><span class="op" id="1546923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546926">b</span>&nbsp;<span class="op" id="1546928">:=</span>&nbsp;<span class="ident" id="1546931">stkbucket</span><span class="op" id="1546940">(</span><span class="ident" id="1546941">memProfile</span><span class="op" id="1546951">,</span>&nbsp;<span class="ident" id="1546953">size</span><span class="op" id="1546957">,</span>&nbsp;<span class="ident" id="1546959">stk</span><span class="op" id="1546962">[</span><span class="op" id="1546963">:</span><span class="ident" id="1546964">nstk</span><span class="op" id="1546968">]</span><span class="op" id="1546969">,</span>&nbsp;<span class="builtintype" id="1546971">true</span><span class="op" id="1546975">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546978">mp</span>&nbsp;<span class="op" id="1546981">:=</span>&nbsp;<span class="ident" id="1546984">b</span><span class="op" id="1546985">.</span><span class="ident" id="1546986">mp</span><span class="op" id="1546988">(</span><span class="op" id="1546989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546992">mp</span><span class="op" id="1546994">.</span><span class="ident" id="1546995">recent_allocs</span><span class="op" id="1547008">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547012">mp</span><span class="op" id="1547014">.</span><span class="ident" id="1547015">recent_alloc_bytes</span>&nbsp;<span class="op" id="1547034">+=</span>&nbsp;<span class="ident" id="1547037">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547043">unlock</span><span class="op" id="1547049">(</span><span class="op" id="1547050">&amp;</span><span class="ident" id="1547051">proflock</span><span class="op" id="1547059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547063">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547151">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547215">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547279">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547320">setprofilebucket</span><span class="op" id="1547336">(</span><span class="ident" id="1547337">p</span><span class="op" id="1547338">,</span>&nbsp;<span class="ident" id="1547340">b</span><span class="op" id="1547341">)</span><br>
<span class="lineno">250</span><span class="op" id="1547343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1547346">func</span>&nbsp;<span class="ident" id="1547351">setprofilebucket_m</span><span class="op" id="1547369">(</span><span class="op" id="1547370">)</span>&nbsp;<span class="comment" id="1547372">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1547384">func</span>&nbsp;<span class="ident" id="1547389">setprofilebucket</span><span class="op" id="1547405">(</span><span class="ident" id="1547406">p</span>&nbsp;<span class="ident" id="1547408">unsafe</span><span class="op" id="1547414">.</span><span class="ident" id="1547415">Pointer</span><span class="op" id="1547422">,</span>&nbsp;<span class="ident" id="1547424">b</span>&nbsp;<span class="op" id="1547426">*</span><span class="ident" id="1547427">bucket</span><span class="op" id="1547433">)</span>&nbsp;<span class="op" id="1547435">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547438">g</span>&nbsp;<span class="op" id="1547440">:=</span>&nbsp;<span class="ident" id="1547443">getg</span><span class="op" id="1547447">(</span><span class="op" id="1547448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547451">g</span><span class="op" id="1547452">.</span><span class="ident" id="1547453">m</span><span class="op" id="1547454">.</span><span class="ident" id="1547455">ptrarg</span><span class="op" id="1547461">[</span><span class="num" id="1547462">0</span><span class="op" id="1547463">]</span>&nbsp;<span class="op" id="1547465">=</span>&nbsp;<span class="ident" id="1547467">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547470">g</span><span class="op" id="1547471">.</span><span class="ident" id="1547472">m</span><span class="op" id="1547473">.</span><span class="ident" id="1547474">ptrarg</span><span class="op" id="1547480">[</span><span class="num" id="1547481">1</span><span class="op" id="1547482">]</span>&nbsp;<span class="op" id="1547484">=</span>&nbsp;<span class="ident" id="1547486">unsafe</span><span class="op" id="1547492">.</span><span class="ident" id="1547493">Pointer</span><span class="op" id="1547500">(</span><span class="ident" id="1547501">b</span><span class="op" id="1547502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547505">onM</span><span class="op" id="1547508">(</span><span class="ident" id="1547509">setprofilebucket_m</span><span class="op" id="1547527">)</span><br>
<span class="lineno"></span><span class="op" id="1547529">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1547532">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1547573">func</span>&nbsp;<span class="ident" id="1547578">mProf_Free</span><span class="op" id="1547588">(</span><span class="ident" id="1547589">b</span>&nbsp;<span class="op" id="1547591">*</span><span class="ident" id="1547592">bucket</span><span class="op" id="1547598">,</span>&nbsp;<span class="ident" id="1547600">size</span>&nbsp;<span class="builtintype" id="1547605">uintptr</span><span class="op" id="1547612">,</span>&nbsp;<span class="ident" id="1547614">freed</span>&nbsp;<span class="builtintype" id="1547620">bool</span><span class="op" id="1547624">)</span>&nbsp;<span class="op" id="1547626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547629">lock</span><span class="op" id="1547633">(</span><span class="op" id="1547634">&amp;</span><span class="ident" id="1547635">proflock</span><span class="op" id="1547643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547646">mp</span>&nbsp;<span class="op" id="1547649">:=</span>&nbsp;<span class="ident" id="1547652">b</span><span class="op" id="1547653">.</span><span class="ident" id="1547654">mp</span><span class="op" id="1547656">(</span><span class="op" id="1547657">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547660">if</span>&nbsp;<span class="ident" id="1547663">freed</span>&nbsp;<span class="op" id="1547669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547673">mp</span><span class="op" id="1547675">.</span><span class="ident" id="1547676">recent_frees</span><span class="op" id="1547688">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547693">mp</span><span class="op" id="1547695">.</span><span class="ident" id="1547696">recent_free_bytes</span>&nbsp;<span class="op" id="1547714">+=</span>&nbsp;<span class="ident" id="1547717">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547723">}</span>&nbsp;<span class="keyword" id="1547725">else</span>&nbsp;<span class="op" id="1547730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547734">mp</span><span class="op" id="1547736">.</span><span class="ident" id="1547737">prev_frees</span><span class="op" id="1547747">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547752">mp</span><span class="op" id="1547754">.</span><span class="ident" id="1547755">prev_free_bytes</span>&nbsp;<span class="op" id="1547771">+=</span>&nbsp;<span class="ident" id="1547774">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1547780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547783">unlock</span><span class="op" id="1547789">(</span><span class="op" id="1547790">&amp;</span><span class="ident" id="1547791">proflock</span><span class="op" id="1547799">)</span><br>
<span class="lineno"></span><span class="op" id="1547801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1547804">var</span>&nbsp;<span class="ident" id="1547808">blockprofilerate</span>&nbsp;<span class="ident" id="1547825">uint64</span>&nbsp;<span class="comment" id="1547832">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1547849">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1547923">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1547998">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1548070">//</span><br>
<span class="lineno"></span><span class="comment" id="1548073">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1548139">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1548190">func</span>&nbsp;<span class="ident" id="1548195">SetBlockProfileRate</span><span class="op" id="1548214">(</span><span class="ident" id="1548215">rate</span>&nbsp;<span class="builtintype" id="1548220">int</span><span class="op" id="1548223">)</span>&nbsp;<span class="op" id="1548225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548228">var</span>&nbsp;<span class="ident" id="1548232">r</span>&nbsp;<span class="ident" id="1548234">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548241">if</span>&nbsp;<span class="ident" id="1548244">rate</span>&nbsp;<span class="op" id="1548249">&lt;=</span>&nbsp;<span class="num" id="1548252">0</span>&nbsp;<span class="op" id="1548254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548258">r</span>&nbsp;<span class="op" id="1548260">=</span>&nbsp;<span class="num" id="1548262">0</span>&nbsp;<span class="comment" id="1548264">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548286">}</span>&nbsp;<span class="keyword" id="1548288">else</span>&nbsp;<span class="keyword" id="1548293">if</span>&nbsp;<span class="ident" id="1548296">rate</span>&nbsp;<span class="op" id="1548301">==</span>&nbsp;<span class="num" id="1548304">1</span>&nbsp;<span class="op" id="1548306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548310">r</span>&nbsp;<span class="op" id="1548312">=</span>&nbsp;<span class="num" id="1548314">1</span>&nbsp;<span class="comment" id="1548316">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548339">}</span>&nbsp;<span class="keyword" id="1548341">else</span>&nbsp;<span class="op" id="1548346">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548350">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548431">r</span>&nbsp;<span class="op" id="1548433">=</span>&nbsp;<span class="ident" id="1548435">int64</span><span class="op" id="1548440">(</span><span class="builtintype" id="1548441">float64</span><span class="op" id="1548448">(</span><span class="ident" id="1548449">rate</span><span class="op" id="1548453">)</span>&nbsp;<span class="op" id="1548455">*</span>&nbsp;<span class="builtintype" id="1548457">float64</span><span class="op" id="1548464">(</span><span class="ident" id="1548465">tickspersecond</span><span class="op" id="1548479">(</span><span class="op" id="1548480">)</span><span class="op" id="1548481">)</span>&nbsp;<span class="op" id="1548483">/</span>&nbsp;<span class="op" id="1548485">(</span><span class="num" id="1548486">1000</span>&nbsp;<span class="op" id="1548491">*</span>&nbsp;<span class="num" id="1548493">1000</span>&nbsp;<span class="op" id="1548498">*</span>&nbsp;<span class="num" id="1548500">1000</span><span class="op" id="1548504">)</span><span class="op" id="1548505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548509">if</span>&nbsp;<span class="ident" id="1548512">r</span>&nbsp;<span class="op" id="1548514">==</span>&nbsp;<span class="num" id="1548517">0</span>&nbsp;<span class="op" id="1548519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548524">r</span>&nbsp;<span class="op" id="1548526">=</span>&nbsp;<span class="num" id="1548528">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548532">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548539">atomicstore64</span><span class="op" id="1548552">(</span><span class="op" id="1548553">&amp;</span><span class="ident" id="1548554">blockprofilerate</span><span class="op" id="1548570">,</span>&nbsp;<span class="ident" id="1548572">uint64</span><span class="op" id="1548578">(</span><span class="ident" id="1548579">r</span><span class="op" id="1548580">)</span><span class="op" id="1548581">)</span><br>
<span class="lineno"></span><span class="op" id="1548583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1548586">func</span>&nbsp;<span class="ident" id="1548591">blockevent</span><span class="op" id="1548601">(</span><span class="ident" id="1548602">cycles</span>&nbsp;<span class="ident" id="1548609">int64</span><span class="op" id="1548614">,</span>&nbsp;<span class="ident" id="1548616">skip</span>&nbsp;<span class="builtintype" id="1548621">int</span><span class="op" id="1548624">)</span>&nbsp;<span class="op" id="1548626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548629">if</span>&nbsp;<span class="ident" id="1548632">cycles</span>&nbsp;<span class="op" id="1548639">&lt;=</span>&nbsp;<span class="num" id="1548642">0</span>&nbsp;<span class="op" id="1548644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548648">cycles</span>&nbsp;<span class="op" id="1548655">=</span>&nbsp;<span class="num" id="1548657">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548663">rate</span>&nbsp;<span class="op" id="1548668">:=</span>&nbsp;<span class="ident" id="1548671">int64</span><span class="op" id="1548676">(</span><span class="ident" id="1548677">atomicload64</span><span class="op" id="1548689">(</span><span class="op" id="1548690">&amp;</span><span class="ident" id="1548691">blockprofilerate</span><span class="op" id="1548707">)</span><span class="op" id="1548708">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548711">if</span>&nbsp;<span class="ident" id="1548714">rate</span>&nbsp;<span class="op" id="1548719">&lt;=</span>&nbsp;<span class="num" id="1548722">0</span>&nbsp;<span class="op" id="1548724">||</span>&nbsp;<span class="op" id="1548727">(</span><span class="ident" id="1548728">rate</span>&nbsp;<span class="op" id="1548733">&gt;</span>&nbsp;<span class="ident" id="1548735">cycles</span>&nbsp;<span class="op" id="1548742">&amp;&amp;</span>&nbsp;<span class="ident" id="1548745">int64</span><span class="op" id="1548750">(</span><span class="ident" id="1548751">fastrand1</span><span class="op" id="1548760">(</span><span class="op" id="1548761">)</span><span class="op" id="1548762">)</span><span class="op" id="1548763">%</span><span class="ident" id="1548764">rate</span>&nbsp;<span class="op" id="1548769">&gt;</span>&nbsp;<span class="ident" id="1548771">cycles</span><span class="op" id="1548777">)</span>&nbsp;<span class="op" id="1548779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548783">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548794">gp</span>&nbsp;<span class="op" id="1548797">:=</span>&nbsp;<span class="ident" id="1548800">getg</span><span class="op" id="1548804">(</span><span class="op" id="1548805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548808">var</span>&nbsp;<span class="ident" id="1548812">nstk</span>&nbsp;<span class="builtintype" id="1548817">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548822">var</span>&nbsp;<span class="ident" id="1548826">stk</span>&nbsp;<span class="op" id="1548830">[</span><span class="ident" id="1548831">maxStack</span><span class="op" id="1548839">]</span><span class="builtintype" id="1548840">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548849">if</span>&nbsp;<span class="ident" id="1548852">gp</span><span class="op" id="1548854">.</span><span class="ident" id="1548855">m</span><span class="op" id="1548856">.</span><span class="ident" id="1548857">curg</span>&nbsp;<span class="op" id="1548862">==</span>&nbsp;<span class="ident" id="1548865">nil</span>&nbsp;<span class="op" id="1548869">||</span>&nbsp;<span class="ident" id="1548872">gp</span><span class="op" id="1548874">.</span><span class="ident" id="1548875">m</span><span class="op" id="1548876">.</span><span class="ident" id="1548877">curg</span>&nbsp;<span class="op" id="1548882">==</span>&nbsp;<span class="ident" id="1548885">gp</span>&nbsp;<span class="op" id="1548888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548892">nstk</span>&nbsp;<span class="op" id="1548897">=</span>&nbsp;<span class="ident" id="1548899">callers</span><span class="op" id="1548906">(</span><span class="ident" id="1548907">skip</span><span class="op" id="1548911">,</span>&nbsp;<span class="op" id="1548913">&amp;</span><span class="ident" id="1548914">stk</span><span class="op" id="1548917">[</span><span class="num" id="1548918">0</span><span class="op" id="1548919">]</span><span class="op" id="1548920">,</span>&nbsp;<span class="builtinfunc" id="1548922">len</span><span class="op" id="1548925">(</span><span class="ident" id="1548926">stk</span><span class="op" id="1548929">)</span><span class="op" id="1548930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548933">}</span>&nbsp;<span class="keyword" id="1548935">else</span>&nbsp;<span class="op" id="1548940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548944">nstk</span>&nbsp;<span class="op" id="1548949">=</span>&nbsp;<span class="ident" id="1548951">gcallers</span><span class="op" id="1548959">(</span><span class="ident" id="1548960">gp</span><span class="op" id="1548962">.</span><span class="ident" id="1548963">m</span><span class="op" id="1548964">.</span><span class="ident" id="1548965">curg</span><span class="op" id="1548969">,</span>&nbsp;<span class="ident" id="1548971">skip</span><span class="op" id="1548975">,</span>&nbsp;<span class="op" id="1548977">&amp;</span><span class="ident" id="1548978">stk</span><span class="op" id="1548981">[</span><span class="num" id="1548982">0</span><span class="op" id="1548983">]</span><span class="op" id="1548984">,</span>&nbsp;<span class="builtinfunc" id="1548986">len</span><span class="op" id="1548989">(</span><span class="ident" id="1548990">stk</span><span class="op" id="1548993">)</span><span class="op" id="1548994">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549000">lock</span><span class="op" id="1549004">(</span><span class="op" id="1549005">&amp;</span><span class="ident" id="1549006">proflock</span><span class="op" id="1549014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549017">b</span>&nbsp;<span class="op" id="1549019">:=</span>&nbsp;<span class="ident" id="1549022">stkbucket</span><span class="op" id="1549031">(</span><span class="ident" id="1549032">blockProfile</span><span class="op" id="1549044">,</span>&nbsp;<span class="num" id="1549046">0</span><span class="op" id="1549047">,</span>&nbsp;<span class="ident" id="1549049">stk</span><span class="op" id="1549052">[</span><span class="op" id="1549053">:</span><span class="ident" id="1549054">nstk</span><span class="op" id="1549058">]</span><span class="op" id="1549059">,</span>&nbsp;<span class="builtintype" id="1549061">true</span><span class="op" id="1549065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549068">b</span><span class="op" id="1549069">.</span><span class="ident" id="1549070">bp</span><span class="op" id="1549072">(</span><span class="op" id="1549073">)</span><span class="op" id="1549074">.</span><span class="ident" id="1549075">count</span><span class="op" id="1549080">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549084">b</span><span class="op" id="1549085">.</span><span class="ident" id="1549086">bp</span><span class="op" id="1549088">(</span><span class="op" id="1549089">)</span><span class="op" id="1549090">.</span><span class="ident" id="1549091">cycles</span>&nbsp;<span class="op" id="1549098">+=</span>&nbsp;<span class="ident" id="1549101">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549109">unlock</span><span class="op" id="1549115">(</span><span class="op" id="1549116">&amp;</span><span class="ident" id="1549117">proflock</span><span class="op" id="1549125">)</span><br>
<span class="lineno"></span><span class="op" id="1549127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1549130">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1549164">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1549217">type</span>&nbsp;<span class="ident" id="1549222">StackRecord</span>&nbsp;<span class="keyword" id="1549234">struct</span>&nbsp;<span class="op" id="1549241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549244">Stack0</span>&nbsp;<span class="op" id="1549251">[</span><span class="num" id="1549252">32</span><span class="op" id="1549254">]</span><span class="builtintype" id="1549255">uintptr</span>&nbsp;<span class="comment" id="1549263">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1549317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1549320">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1549381">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1549406">func</span>&nbsp;<span class="op" id="1549411">(</span><span class="ident" id="1549412">r</span>&nbsp;<span class="op" id="1549414">*</span><span class="ident" id="1549415">StackRecord</span><span class="op" id="1549426">)</span>&nbsp;<span class="ident" id="1549428">Stack</span><span class="op" id="1549433">(</span><span class="op" id="1549434">)</span>&nbsp;<span class="op" id="1549436">[</span><span class="op" id="1549437">]</span><span class="builtintype" id="1549438">uintptr</span>&nbsp;<span class="op" id="1549446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549449">for</span>&nbsp;<span class="ident" id="1549453">i</span><span class="op" id="1549454">,</span>&nbsp;<span class="ident" id="1549456">v</span>&nbsp;<span class="op" id="1549458">:=</span>&nbsp;<span class="keyword" id="1549461">range</span>&nbsp;<span class="ident" id="1549467">r</span><span class="op" id="1549468">.</span><span class="ident" id="1549469">Stack0</span>&nbsp;<span class="op" id="1549476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549480">if</span>&nbsp;<span class="ident" id="1549483">v</span>&nbsp;<span class="op" id="1549485">==</span>&nbsp;<span class="num" id="1549488">0</span>&nbsp;<span class="op" id="1549490">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549495">return</span>&nbsp;<span class="ident" id="1549502">r</span><span class="op" id="1549503">.</span><span class="ident" id="1549504">Stack0</span><span class="op" id="1549510">[</span><span class="num" id="1549511">0</span><span class="op" id="1549512">:</span><span class="ident" id="1549513">i</span><span class="op" id="1549514">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549524">return</span>&nbsp;<span class="ident" id="1549531">r</span><span class="op" id="1549532">.</span><span class="ident" id="1549533">Stack0</span><span class="op" id="1549539">[</span><span class="num" id="1549540">0</span><span class="op" id="1549541">:</span><span class="op" id="1549542">]</span><br>
<span class="lineno"></span><span class="op" id="1549544">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1549547">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1549609">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1549666">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1549711">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1549765">//</span><br>
<span class="lineno"></span><span class="comment" id="1549768">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1549845">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1549905">//</span><br>
<span class="lineno"></span><span class="comment" id="1549908">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1549970">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1550033">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1550094">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1550155">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1550213">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1550243">var</span>&nbsp;<span class="ident" id="1550247">MemProfileRate</span>&nbsp;<span class="builtintype" id="1550262">int</span>&nbsp;<span class="op" id="1550266">=</span>&nbsp;<span class="num" id="1550268">512</span>&nbsp;<span class="op" id="1550272">*</span>&nbsp;<span class="num" id="1550274">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1550280">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1550339">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1550387">type</span>&nbsp;<span class="ident" id="1550392">MemProfileRecord</span>&nbsp;<span class="keyword" id="1550409">struct</span>&nbsp;<span class="op" id="1550416">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550419">AllocBytes</span><span class="op" id="1550429">,</span>&nbsp;<span class="ident" id="1550431">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1550445">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550457">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550494">AllocObjects</span><span class="op" id="1550506">,</span>&nbsp;<span class="ident" id="1550508">FreeObjects</span>&nbsp;<span class="ident" id="1550520">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550532">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550571">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1550597">[</span><span class="num" id="1550598">32</span><span class="op" id="1550600">]</span><span class="builtintype" id="1550601">uintptr</span>&nbsp;<span class="comment" id="1550609">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1550663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1550666">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1550741">func</span>&nbsp;<span class="op" id="1550746">(</span><span class="ident" id="1550747">r</span>&nbsp;<span class="op" id="1550749">*</span><span class="ident" id="1550750">MemProfileRecord</span><span class="op" id="1550766">)</span>&nbsp;<span class="ident" id="1550768">InUseBytes</span><span class="op" id="1550778">(</span><span class="op" id="1550779">)</span>&nbsp;<span class="ident" id="1550781">int64</span>&nbsp;<span class="op" id="1550787">{</span>&nbsp;<span class="keyword" id="1550789">return</span>&nbsp;<span class="ident" id="1550796">r</span><span class="op" id="1550797">.</span><span class="ident" id="1550798">AllocBytes</span>&nbsp;<span class="op" id="1550809">-</span>&nbsp;<span class="ident" id="1550811">r</span><span class="op" id="1550812">.</span><span class="ident" id="1550813">FreeBytes</span>&nbsp;<span class="op" id="1550823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1550826">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1550909">func</span>&nbsp;<span class="op" id="1550914">(</span><span class="ident" id="1550915">r</span>&nbsp;<span class="op" id="1550917">*</span><span class="ident" id="1550918">MemProfileRecord</span><span class="op" id="1550934">)</span>&nbsp;<span class="ident" id="1550936">InUseObjects</span><span class="op" id="1550948">(</span><span class="op" id="1550949">)</span>&nbsp;<span class="ident" id="1550951">int64</span>&nbsp;<span class="op" id="1550957">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550960">return</span>&nbsp;<span class="ident" id="1550967">r</span><span class="op" id="1550968">.</span><span class="ident" id="1550969">AllocObjects</span>&nbsp;<span class="op" id="1550982">-</span>&nbsp;<span class="ident" id="1550984">r</span><span class="op" id="1550985">.</span><span class="ident" id="1550986">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1550998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1551001">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1551062">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1551087">func</span>&nbsp;<span class="op" id="1551092">(</span><span class="ident" id="1551093">r</span>&nbsp;<span class="op" id="1551095">*</span><span class="ident" id="1551096">MemProfileRecord</span><span class="op" id="1551112">)</span>&nbsp;<span class="ident" id="1551114">Stack</span><span class="op" id="1551119">(</span><span class="op" id="1551120">)</span>&nbsp;<span class="op" id="1551122">[</span><span class="op" id="1551123">]</span><span class="builtintype" id="1551124">uintptr</span>&nbsp;<span class="op" id="1551132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551135">for</span>&nbsp;<span class="ident" id="1551139">i</span><span class="op" id="1551140">,</span>&nbsp;<span class="ident" id="1551142">v</span>&nbsp;<span class="op" id="1551144">:=</span>&nbsp;<span class="keyword" id="1551147">range</span>&nbsp;<span class="ident" id="1551153">r</span><span class="op" id="1551154">.</span><span class="ident" id="1551155">Stack0</span>&nbsp;<span class="op" id="1551162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551166">if</span>&nbsp;<span class="ident" id="1551169">v</span>&nbsp;<span class="op" id="1551171">==</span>&nbsp;<span class="num" id="1551174">0</span>&nbsp;<span class="op" id="1551176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551181">return</span>&nbsp;<span class="ident" id="1551188">r</span><span class="op" id="1551189">.</span><span class="ident" id="1551190">Stack0</span><span class="op" id="1551196">[</span><span class="num" id="1551197">0</span><span class="op" id="1551198">:</span><span class="ident" id="1551199">i</span><span class="op" id="1551200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551204">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551210">return</span>&nbsp;<span class="ident" id="1551217">r</span><span class="op" id="1551218">.</span><span class="ident" id="1551219">Stack0</span><span class="op" id="1551225">[</span><span class="num" id="1551226">0</span><span class="op" id="1551227">:</span><span class="op" id="1551228">]</span><br>
<span class="lineno"></span><span class="op" id="1551230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1551233">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1551311">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1551388">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1551457">//</span><br>
<span class="lineno"></span><span class="comment" id="1551460">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1551525">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1551584">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1551646">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1551684">//</span><br>
<span class="lineno"></span><span class="comment" id="1551687">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1551743">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1551798">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1551833">func</span>&nbsp;<span class="ident" id="1551838">MemProfile</span><span class="op" id="1551848">(</span><span class="ident" id="1551849">p</span>&nbsp;<span class="op" id="1551851">[</span><span class="op" id="1551852">]</span><span class="ident" id="1551853">MemProfileRecord</span><span class="op" id="1551869">,</span>&nbsp;<span class="ident" id="1551871">inuseZero</span>&nbsp;<span class="builtintype" id="1551881">bool</span><span class="op" id="1551885">)</span>&nbsp;<span class="op" id="1551887">(</span><span class="ident" id="1551888">n</span>&nbsp;<span class="builtintype" id="1551890">int</span><span class="op" id="1551893">,</span>&nbsp;<span class="ident" id="1551895">ok</span>&nbsp;<span class="builtintype" id="1551898">bool</span><span class="op" id="1551902">)</span>&nbsp;<span class="op" id="1551904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551907">lock</span><span class="op" id="1551911">(</span><span class="op" id="1551912">&amp;</span><span class="ident" id="1551913">proflock</span><span class="op" id="1551921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551924">clear</span>&nbsp;<span class="op" id="1551930">:=</span>&nbsp;<span class="builtintype" id="1551933">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551939">for</span>&nbsp;<span class="ident" id="1551943">b</span>&nbsp;<span class="op" id="1551945">:=</span>&nbsp;<span class="ident" id="1551948">mbuckets</span><span class="op" id="1551956">;</span>&nbsp;<span class="ident" id="1551958">b</span>&nbsp;<span class="op" id="1551960">!=</span>&nbsp;<span class="ident" id="1551963">nil</span><span class="op" id="1551966">;</span>&nbsp;<span class="ident" id="1551968">b</span>&nbsp;<span class="op" id="1551970">=</span>&nbsp;<span class="ident" id="1551972">b</span><span class="op" id="1551973">.</span><span class="ident" id="1551974">allnext</span>&nbsp;<span class="op" id="1551982">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551986">mp</span>&nbsp;<span class="op" id="1551989">:=</span>&nbsp;<span class="ident" id="1551992">b</span><span class="op" id="1551993">.</span><span class="ident" id="1551994">mp</span><span class="op" id="1551996">(</span><span class="op" id="1551997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552001">if</span>&nbsp;<span class="ident" id="1552004">inuseZero</span>&nbsp;<span class="op" id="1552014">||</span>&nbsp;<span class="ident" id="1552017">mp</span><span class="op" id="1552019">.</span><span class="ident" id="1552020">alloc_bytes</span>&nbsp;<span class="op" id="1552032">!=</span>&nbsp;<span class="ident" id="1552035">mp</span><span class="op" id="1552037">.</span><span class="ident" id="1552038">free_bytes</span>&nbsp;<span class="op" id="1552049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552054">n</span><span class="op" id="1552055">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552064">if</span>&nbsp;<span class="ident" id="1552067">mp</span><span class="op" id="1552069">.</span><span class="ident" id="1552070">allocs</span>&nbsp;<span class="op" id="1552077">!=</span>&nbsp;<span class="num" id="1552080">0</span>&nbsp;<span class="op" id="1552082">||</span>&nbsp;<span class="ident" id="1552085">mp</span><span class="op" id="1552087">.</span><span class="ident" id="1552088">frees</span>&nbsp;<span class="op" id="1552094">!=</span>&nbsp;<span class="num" id="1552097">0</span>&nbsp;<span class="op" id="1552099">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552104">clear</span>&nbsp;<span class="op" id="1552110">=</span>&nbsp;<span class="builtintype" id="1552112">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552126">if</span>&nbsp;<span class="ident" id="1552129">clear</span>&nbsp;<span class="op" id="1552135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552139">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552201">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552261">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552330">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552399">mprof_GC</span><span class="op" id="1552407">(</span><span class="op" id="1552408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552412">mprof_GC</span><span class="op" id="1552420">(</span><span class="op" id="1552421">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552425">n</span>&nbsp;<span class="op" id="1552427">=</span>&nbsp;<span class="num" id="1552429">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552433">for</span>&nbsp;<span class="ident" id="1552437">b</span>&nbsp;<span class="op" id="1552439">:=</span>&nbsp;<span class="ident" id="1552442">mbuckets</span><span class="op" id="1552450">;</span>&nbsp;<span class="ident" id="1552452">b</span>&nbsp;<span class="op" id="1552454">!=</span>&nbsp;<span class="ident" id="1552457">nil</span><span class="op" id="1552460">;</span>&nbsp;<span class="ident" id="1552462">b</span>&nbsp;<span class="op" id="1552464">=</span>&nbsp;<span class="ident" id="1552466">b</span><span class="op" id="1552467">.</span><span class="ident" id="1552468">allnext</span>&nbsp;<span class="op" id="1552476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552481">mp</span>&nbsp;<span class="op" id="1552484">:=</span>&nbsp;<span class="ident" id="1552487">b</span><span class="op" id="1552488">.</span><span class="ident" id="1552489">mp</span><span class="op" id="1552491">(</span><span class="op" id="1552492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552497">if</span>&nbsp;<span class="ident" id="1552500">inuseZero</span>&nbsp;<span class="op" id="1552510">||</span>&nbsp;<span class="ident" id="1552513">mp</span><span class="op" id="1552515">.</span><span class="ident" id="1552516">alloc_bytes</span>&nbsp;<span class="op" id="1552528">!=</span>&nbsp;<span class="ident" id="1552531">mp</span><span class="op" id="1552533">.</span><span class="ident" id="1552534">free_bytes</span>&nbsp;<span class="op" id="1552545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552551">n</span><span class="op" id="1552552">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552568">if</span>&nbsp;<span class="ident" id="1552571">n</span>&nbsp;<span class="op" id="1552573">&lt;=</span>&nbsp;<span class="builtinfunc" id="1552576">len</span><span class="op" id="1552579">(</span><span class="ident" id="1552580">p</span><span class="op" id="1552581">)</span>&nbsp;<span class="op" id="1552583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552587">ok</span>&nbsp;<span class="op" id="1552590">=</span>&nbsp;<span class="builtintype" id="1552592">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552599">idx</span>&nbsp;<span class="op" id="1552603">:=</span>&nbsp;<span class="num" id="1552606">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552610">for</span>&nbsp;<span class="ident" id="1552614">b</span>&nbsp;<span class="op" id="1552616">:=</span>&nbsp;<span class="ident" id="1552619">mbuckets</span><span class="op" id="1552627">;</span>&nbsp;<span class="ident" id="1552629">b</span>&nbsp;<span class="op" id="1552631">!=</span>&nbsp;<span class="ident" id="1552634">nil</span><span class="op" id="1552637">;</span>&nbsp;<span class="ident" id="1552639">b</span>&nbsp;<span class="op" id="1552641">=</span>&nbsp;<span class="ident" id="1552643">b</span><span class="op" id="1552644">.</span><span class="ident" id="1552645">allnext</span>&nbsp;<span class="op" id="1552653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552658">mp</span>&nbsp;<span class="op" id="1552661">:=</span>&nbsp;<span class="ident" id="1552664">b</span><span class="op" id="1552665">.</span><span class="ident" id="1552666">mp</span><span class="op" id="1552668">(</span><span class="op" id="1552669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552674">if</span>&nbsp;<span class="ident" id="1552677">inuseZero</span>&nbsp;<span class="op" id="1552687">||</span>&nbsp;<span class="ident" id="1552690">mp</span><span class="op" id="1552692">.</span><span class="ident" id="1552693">alloc_bytes</span>&nbsp;<span class="op" id="1552705">!=</span>&nbsp;<span class="ident" id="1552708">mp</span><span class="op" id="1552710">.</span><span class="ident" id="1552711">free_bytes</span>&nbsp;<span class="op" id="1552722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552728">record</span><span class="op" id="1552734">(</span><span class="op" id="1552735">&amp;</span><span class="ident" id="1552736">p</span><span class="op" id="1552737">[</span><span class="ident" id="1552738">idx</span><span class="op" id="1552741">]</span><span class="op" id="1552742">,</span>&nbsp;<span class="ident" id="1552744">b</span><span class="op" id="1552745">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552751">idx</span><span class="op" id="1552754">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552770">unlock</span><span class="op" id="1552776">(</span><span class="op" id="1552777">&amp;</span><span class="ident" id="1552778">proflock</span><span class="op" id="1552786">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552789">return</span><br>
<span class="lineno"></span><span class="op" id="1552796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1552799">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1552823">func</span>&nbsp;<span class="ident" id="1552828">record</span><span class="op" id="1552834">(</span><span class="ident" id="1552835">r</span>&nbsp;<span class="op" id="1552837">*</span><span class="ident" id="1552838">MemProfileRecord</span><span class="op" id="1552854">,</span>&nbsp;<span class="ident" id="1552856">b</span>&nbsp;<span class="op" id="1552858">*</span><span class="ident" id="1552859">bucket</span><span class="op" id="1552865">)</span>&nbsp;<span class="op" id="1552867">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552870">mp</span>&nbsp;<span class="op" id="1552873">:=</span>&nbsp;<span class="ident" id="1552876">b</span><span class="op" id="1552877">.</span><span class="ident" id="1552878">mp</span><span class="op" id="1552880">(</span><span class="op" id="1552881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552884">r</span><span class="op" id="1552885">.</span><span class="ident" id="1552886">AllocBytes</span>&nbsp;<span class="op" id="1552897">=</span>&nbsp;<span class="ident" id="1552899">int64</span><span class="op" id="1552904">(</span><span class="ident" id="1552905">mp</span><span class="op" id="1552907">.</span><span class="ident" id="1552908">alloc_bytes</span><span class="op" id="1552919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552922">r</span><span class="op" id="1552923">.</span><span class="ident" id="1552924">FreeBytes</span>&nbsp;<span class="op" id="1552934">=</span>&nbsp;<span class="ident" id="1552936">int64</span><span class="op" id="1552941">(</span><span class="ident" id="1552942">mp</span><span class="op" id="1552944">.</span><span class="ident" id="1552945">free_bytes</span><span class="op" id="1552955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552958">r</span><span class="op" id="1552959">.</span><span class="ident" id="1552960">AllocObjects</span>&nbsp;<span class="op" id="1552973">=</span>&nbsp;<span class="ident" id="1552975">int64</span><span class="op" id="1552980">(</span><span class="ident" id="1552981">mp</span><span class="op" id="1552983">.</span><span class="ident" id="1552984">allocs</span><span class="op" id="1552990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552993">r</span><span class="op" id="1552994">.</span><span class="ident" id="1552995">FreeObjects</span>&nbsp;<span class="op" id="1553007">=</span>&nbsp;<span class="ident" id="1553009">int64</span><span class="op" id="1553014">(</span><span class="ident" id="1553015">mp</span><span class="op" id="1553017">.</span><span class="ident" id="1553018">frees</span><span class="op" id="1553023">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1553026">copy</span><span class="op" id="1553030">(</span><span class="ident" id="1553031">r</span><span class="op" id="1553032">.</span><span class="ident" id="1553033">Stack0</span><span class="op" id="1553039">[</span><span class="op" id="1553040">:</span><span class="op" id="1553041">]</span><span class="op" id="1553042">,</span>&nbsp;<span class="ident" id="1553044">b</span><span class="op" id="1553045">.</span><span class="ident" id="1553046">stk</span><span class="op" id="1553049">(</span><span class="op" id="1553050">)</span><span class="op" id="1553051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553054">for</span>&nbsp;<span class="ident" id="1553058">i</span>&nbsp;<span class="op" id="1553060">:=</span>&nbsp;<span class="builtintype" id="1553063">int</span><span class="op" id="1553066">(</span><span class="ident" id="1553067">b</span><span class="op" id="1553068">.</span><span class="ident" id="1553069">nstk</span><span class="op" id="1553073">)</span><span class="op" id="1553074">;</span>&nbsp;<span class="ident" id="1553076">i</span>&nbsp;<span class="op" id="1553078">&lt;</span>&nbsp;<span class="builtinfunc" id="1553080">len</span><span class="op" id="1553083">(</span><span class="ident" id="1553084">r</span><span class="op" id="1553085">.</span><span class="ident" id="1553086">Stack0</span><span class="op" id="1553092">)</span><span class="op" id="1553093">;</span>&nbsp;<span class="ident" id="1553095">i</span><span class="op" id="1553096">++</span>&nbsp;<span class="op" id="1553099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553103">r</span><span class="op" id="1553104">.</span><span class="ident" id="1553105">Stack0</span><span class="op" id="1553111">[</span><span class="ident" id="1553112">i</span><span class="op" id="1553113">]</span>&nbsp;<span class="op" id="1553115">=</span>&nbsp;<span class="num" id="1553117">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553120">}</span><br>
<span class="lineno"></span><span class="op" id="1553122">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1553125">func</span>&nbsp;<span class="ident" id="1553130">iterate_memprof</span><span class="op" id="1553145">(</span><span class="ident" id="1553146">fn</span>&nbsp;<span class="keyword" id="1553149">func</span><span class="op" id="1553153">(</span><span class="op" id="1553154">*</span><span class="ident" id="1553155">bucket</span><span class="op" id="1553161">,</span>&nbsp;<span class="builtintype" id="1553163">uintptr</span><span class="op" id="1553170">,</span>&nbsp;<span class="op" id="1553172">*</span><span class="builtintype" id="1553173">uintptr</span><span class="op" id="1553180">,</span>&nbsp;<span class="builtintype" id="1553182">uintptr</span><span class="op" id="1553189">,</span>&nbsp;<span class="builtintype" id="1553191">uintptr</span><span class="op" id="1553198">,</span>&nbsp;<span class="builtintype" id="1553200">uintptr</span><span class="op" id="1553207">)</span><span class="op" id="1553208">)</span>&nbsp;<span class="op" id="1553210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553213">lock</span><span class="op" id="1553217">(</span><span class="op" id="1553218">&amp;</span><span class="ident" id="1553219">proflock</span><span class="op" id="1553227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553230">for</span>&nbsp;<span class="ident" id="1553234">b</span>&nbsp;<span class="op" id="1553236">:=</span>&nbsp;<span class="ident" id="1553239">mbuckets</span><span class="op" id="1553247">;</span>&nbsp;<span class="ident" id="1553249">b</span>&nbsp;<span class="op" id="1553251">!=</span>&nbsp;<span class="ident" id="1553254">nil</span><span class="op" id="1553257">;</span>&nbsp;<span class="ident" id="1553259">b</span>&nbsp;<span class="op" id="1553261">=</span>&nbsp;<span class="ident" id="1553263">b</span><span class="op" id="1553264">.</span><span class="ident" id="1553265">allnext</span>&nbsp;<span class="op" id="1553273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553277">mp</span>&nbsp;<span class="op" id="1553280">:=</span>&nbsp;<span class="ident" id="1553283">b</span><span class="op" id="1553284">.</span><span class="ident" id="1553285">mp</span><span class="op" id="1553287">(</span><span class="op" id="1553288">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553292">fn</span><span class="op" id="1553294">(</span><span class="ident" id="1553295">b</span><span class="op" id="1553296">,</span>&nbsp;<span class="builtintype" id="1553298">uintptr</span><span class="op" id="1553305">(</span><span class="ident" id="1553306">b</span><span class="op" id="1553307">.</span><span class="ident" id="1553308">nstk</span><span class="op" id="1553312">)</span><span class="op" id="1553313">,</span>&nbsp;<span class="op" id="1553315">&amp;</span><span class="ident" id="1553316">b</span><span class="op" id="1553317">.</span><span class="ident" id="1553318">stk</span><span class="op" id="1553321">(</span><span class="op" id="1553322">)</span><span class="op" id="1553323">[</span><span class="num" id="1553324">0</span><span class="op" id="1553325">]</span><span class="op" id="1553326">,</span>&nbsp;<span class="ident" id="1553328">b</span><span class="op" id="1553329">.</span><span class="ident" id="1553330">size</span><span class="op" id="1553334">,</span>&nbsp;<span class="ident" id="1553336">mp</span><span class="op" id="1553338">.</span><span class="ident" id="1553339">allocs</span><span class="op" id="1553345">,</span>&nbsp;<span class="ident" id="1553347">mp</span><span class="op" id="1553349">.</span><span class="ident" id="1553350">frees</span><span class="op" id="1553355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553361">unlock</span><span class="op" id="1553367">(</span><span class="op" id="1553368">&amp;</span><span class="ident" id="1553369">proflock</span><span class="op" id="1553377">)</span><br>
<span class="lineno"></span><span class="op" id="1553379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1553382">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1553441">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1553489">type</span>&nbsp;<span class="ident" id="1553494">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1553513">struct</span>&nbsp;<span class="op" id="1553520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553523">Count</span>&nbsp;&nbsp;<span class="ident" id="1553530">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553537">Cycles</span>&nbsp;<span class="ident" id="1553544">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553551">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1553563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1553566">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1553648">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1553727">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1553798">//</span><br>
<span class="lineno"></span><span class="comment" id="1553801">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1553857">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1553914">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1553951">func</span>&nbsp;<span class="ident" id="1553956">BlockProfile</span><span class="op" id="1553968">(</span><span class="ident" id="1553969">p</span>&nbsp;<span class="op" id="1553971">[</span><span class="op" id="1553972">]</span><span class="ident" id="1553973">BlockProfileRecord</span><span class="op" id="1553991">)</span>&nbsp;<span class="op" id="1553993">(</span><span class="ident" id="1553994">n</span>&nbsp;<span class="builtintype" id="1553996">int</span><span class="op" id="1553999">,</span>&nbsp;<span class="ident" id="1554001">ok</span>&nbsp;<span class="builtintype" id="1554004">bool</span><span class="op" id="1554008">)</span>&nbsp;<span class="op" id="1554010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554013">lock</span><span class="op" id="1554017">(</span><span class="op" id="1554018">&amp;</span><span class="ident" id="1554019">proflock</span><span class="op" id="1554027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554030">for</span>&nbsp;<span class="ident" id="1554034">b</span>&nbsp;<span class="op" id="1554036">:=</span>&nbsp;<span class="ident" id="1554039">bbuckets</span><span class="op" id="1554047">;</span>&nbsp;<span class="ident" id="1554049">b</span>&nbsp;<span class="op" id="1554051">!=</span>&nbsp;<span class="ident" id="1554054">nil</span><span class="op" id="1554057">;</span>&nbsp;<span class="ident" id="1554059">b</span>&nbsp;<span class="op" id="1554061">=</span>&nbsp;<span class="ident" id="1554063">b</span><span class="op" id="1554064">.</span><span class="ident" id="1554065">allnext</span>&nbsp;<span class="op" id="1554073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554077">n</span><span class="op" id="1554078">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554082">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554085">if</span>&nbsp;<span class="ident" id="1554088">n</span>&nbsp;<span class="op" id="1554090">&lt;=</span>&nbsp;<span class="builtinfunc" id="1554093">len</span><span class="op" id="1554096">(</span><span class="ident" id="1554097">p</span><span class="op" id="1554098">)</span>&nbsp;<span class="op" id="1554100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554104">ok</span>&nbsp;<span class="op" id="1554107">=</span>&nbsp;<span class="builtintype" id="1554109">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554116">for</span>&nbsp;<span class="ident" id="1554120">b</span>&nbsp;<span class="op" id="1554122">:=</span>&nbsp;<span class="ident" id="1554125">bbuckets</span><span class="op" id="1554133">;</span>&nbsp;<span class="ident" id="1554135">b</span>&nbsp;<span class="op" id="1554137">!=</span>&nbsp;<span class="ident" id="1554140">nil</span><span class="op" id="1554143">;</span>&nbsp;<span class="ident" id="1554145">b</span>&nbsp;<span class="op" id="1554147">=</span>&nbsp;<span class="ident" id="1554149">b</span><span class="op" id="1554150">.</span><span class="ident" id="1554151">allnext</span>&nbsp;<span class="op" id="1554159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554164">bp</span>&nbsp;<span class="op" id="1554167">:=</span>&nbsp;<span class="ident" id="1554170">b</span><span class="op" id="1554171">.</span><span class="ident" id="1554172">bp</span><span class="op" id="1554174">(</span><span class="op" id="1554175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554180">r</span>&nbsp;<span class="op" id="1554182">:=</span>&nbsp;<span class="op" id="1554185">&amp;</span><span class="ident" id="1554186">p</span><span class="op" id="1554187">[</span><span class="num" id="1554188">0</span><span class="op" id="1554189">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554194">r</span><span class="op" id="1554195">.</span><span class="ident" id="1554196">Count</span>&nbsp;<span class="op" id="1554202">=</span>&nbsp;<span class="ident" id="1554204">int64</span><span class="op" id="1554209">(</span><span class="ident" id="1554210">bp</span><span class="op" id="1554212">.</span><span class="ident" id="1554213">count</span><span class="op" id="1554218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554223">r</span><span class="op" id="1554224">.</span><span class="ident" id="1554225">Cycles</span>&nbsp;<span class="op" id="1554232">=</span>&nbsp;<span class="ident" id="1554234">int64</span><span class="op" id="1554239">(</span><span class="ident" id="1554240">bp</span><span class="op" id="1554242">.</span><span class="ident" id="1554243">cycles</span><span class="op" id="1554249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554254">i</span>&nbsp;<span class="op" id="1554256">:=</span>&nbsp;<span class="builtinfunc" id="1554259">copy</span><span class="op" id="1554263">(</span><span class="ident" id="1554264">r</span><span class="op" id="1554265">.</span><span class="ident" id="1554266">Stack0</span><span class="op" id="1554272">[</span><span class="op" id="1554273">:</span><span class="op" id="1554274">]</span><span class="op" id="1554275">,</span>&nbsp;<span class="ident" id="1554277">b</span><span class="op" id="1554278">.</span><span class="ident" id="1554279">stk</span><span class="op" id="1554282">(</span><span class="op" id="1554283">)</span><span class="op" id="1554284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554289">for</span>&nbsp;<span class="op" id="1554293">;</span>&nbsp;<span class="ident" id="1554295">i</span>&nbsp;<span class="op" id="1554297">&lt;</span>&nbsp;<span class="builtinfunc" id="1554299">len</span><span class="op" id="1554302">(</span><span class="ident" id="1554303">r</span><span class="op" id="1554304">.</span><span class="ident" id="1554305">Stack0</span><span class="op" id="1554311">)</span><span class="op" id="1554312">;</span>&nbsp;<span class="ident" id="1554314">i</span><span class="op" id="1554315">++</span>&nbsp;<span class="op" id="1554318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554324">r</span><span class="op" id="1554325">.</span><span class="ident" id="1554326">Stack0</span><span class="op" id="1554332">[</span><span class="ident" id="1554333">i</span><span class="op" id="1554334">]</span>&nbsp;<span class="op" id="1554336">=</span>&nbsp;<span class="num" id="1554338">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554348">p</span>&nbsp;<span class="op" id="1554350">=</span>&nbsp;<span class="ident" id="1554352">p</span><span class="op" id="1554353">[</span><span class="num" id="1554354">1</span><span class="op" id="1554355">:</span><span class="op" id="1554356">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554366">unlock</span><span class="op" id="1554372">(</span><span class="op" id="1554373">&amp;</span><span class="ident" id="1554374">proflock</span><span class="op" id="1554382">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554385">return</span><br>
<span class="lineno"></span><span class="op" id="1554392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1554395">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1554483">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1554569">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1554647">//</span><br>
<span class="lineno"></span><span class="comment" id="1554650">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1554711">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1554755">func</span>&nbsp;<span class="ident" id="1554760">ThreadCreateProfile</span><span class="op" id="1554779">(</span><span class="ident" id="1554780">p</span>&nbsp;<span class="op" id="1554782">[</span><span class="op" id="1554783">]</span><span class="ident" id="1554784">StackRecord</span><span class="op" id="1554795">)</span>&nbsp;<span class="op" id="1554797">(</span><span class="ident" id="1554798">n</span>&nbsp;<span class="builtintype" id="1554800">int</span><span class="op" id="1554803">,</span>&nbsp;<span class="ident" id="1554805">ok</span>&nbsp;<span class="builtintype" id="1554808">bool</span><span class="op" id="1554812">)</span>&nbsp;<span class="op" id="1554814">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554817">first</span>&nbsp;<span class="op" id="1554823">:=</span>&nbsp;<span class="op" id="1554826">(</span><span class="op" id="1554827">*</span><span class="ident" id="1554828">m</span><span class="op" id="1554829">)</span><span class="op" id="1554830">(</span><span class="ident" id="1554831">atomicloadp</span><span class="op" id="1554842">(</span><span class="ident" id="1554843">unsafe</span><span class="op" id="1554849">.</span><span class="ident" id="1554850">Pointer</span><span class="op" id="1554857">(</span><span class="op" id="1554858">&amp;</span><span class="ident" id="1554859">allm</span><span class="op" id="1554863">)</span><span class="op" id="1554864">)</span><span class="op" id="1554865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554868">for</span>&nbsp;<span class="ident" id="1554872">mp</span>&nbsp;<span class="op" id="1554875">:=</span>&nbsp;<span class="ident" id="1554878">first</span><span class="op" id="1554883">;</span>&nbsp;<span class="ident" id="1554885">mp</span>&nbsp;<span class="op" id="1554888">!=</span>&nbsp;<span class="ident" id="1554891">nil</span><span class="op" id="1554894">;</span>&nbsp;<span class="ident" id="1554896">mp</span>&nbsp;<span class="op" id="1554899">=</span>&nbsp;<span class="ident" id="1554901">mp</span><span class="op" id="1554903">.</span><span class="ident" id="1554904">alllink</span>&nbsp;<span class="op" id="1554912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554916">n</span><span class="op" id="1554917">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554924">if</span>&nbsp;<span class="ident" id="1554927">n</span>&nbsp;<span class="op" id="1554929">&lt;=</span>&nbsp;<span class="builtinfunc" id="1554932">len</span><span class="op" id="1554935">(</span><span class="ident" id="1554936">p</span><span class="op" id="1554937">)</span>&nbsp;<span class="op" id="1554939">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554943">ok</span>&nbsp;<span class="op" id="1554946">=</span>&nbsp;<span class="builtintype" id="1554948">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554955">i</span>&nbsp;<span class="op" id="1554957">:=</span>&nbsp;<span class="num" id="1554960">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554964">for</span>&nbsp;<span class="ident" id="1554968">mp</span>&nbsp;<span class="op" id="1554971">:=</span>&nbsp;<span class="ident" id="1554974">first</span><span class="op" id="1554979">;</span>&nbsp;<span class="ident" id="1554981">mp</span>&nbsp;<span class="op" id="1554984">!=</span>&nbsp;<span class="ident" id="1554987">nil</span><span class="op" id="1554990">;</span>&nbsp;<span class="ident" id="1554992">mp</span>&nbsp;<span class="op" id="1554995">=</span>&nbsp;<span class="ident" id="1554997">mp</span><span class="op" id="1554999">.</span><span class="ident" id="1555000">alllink</span>&nbsp;<span class="op" id="1555008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555013">for</span>&nbsp;<span class="ident" id="1555017">s</span>&nbsp;<span class="op" id="1555019">:=</span>&nbsp;<span class="keyword" id="1555022">range</span>&nbsp;<span class="ident" id="1555028">mp</span><span class="op" id="1555030">.</span><span class="ident" id="1555031">createstack</span>&nbsp;<span class="op" id="1555043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555049">p</span><span class="op" id="1555050">[</span><span class="ident" id="1555051">i</span><span class="op" id="1555052">]</span><span class="op" id="1555053">.</span><span class="ident" id="1555054">Stack0</span><span class="op" id="1555060">[</span><span class="ident" id="1555061">s</span><span class="op" id="1555062">]</span>&nbsp;<span class="op" id="1555064">=</span>&nbsp;<span class="builtintype" id="1555066">uintptr</span><span class="op" id="1555073">(</span><span class="ident" id="1555074">mp</span><span class="op" id="1555076">.</span><span class="ident" id="1555077">createstack</span><span class="op" id="1555088">[</span><span class="ident" id="1555089">s</span><span class="op" id="1555090">]</span><span class="op" id="1555091">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555101">i</span><span class="op" id="1555102">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555113">return</span><br>
<span class="lineno">520</span><span class="op" id="1555120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1555123">var</span>&nbsp;<span class="ident" id="1555127">allgs</span>&nbsp;<span class="op" id="1555133">[</span><span class="op" id="1555134">]</span><span class="op" id="1555135">*</span><span class="ident" id="1555136">g</span>&nbsp;<span class="comment" id="1555138">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1555149">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1555241">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1555324">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1555399">//</span><br>
<span class="lineno"></span><span class="comment" id="1555402">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1555463">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1555504">func</span>&nbsp;<span class="ident" id="1555509">GoroutineProfile</span><span class="op" id="1555525">(</span><span class="ident" id="1555526">p</span>&nbsp;<span class="op" id="1555528">[</span><span class="op" id="1555529">]</span><span class="ident" id="1555530">StackRecord</span><span class="op" id="1555541">)</span>&nbsp;<span class="op" id="1555543">(</span><span class="ident" id="1555544">n</span>&nbsp;<span class="builtintype" id="1555546">int</span><span class="op" id="1555549">,</span>&nbsp;<span class="ident" id="1555551">ok</span>&nbsp;<span class="builtintype" id="1555554">bool</span><span class="op" id="1555558">)</span>&nbsp;<span class="op" id="1555560">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555564">n</span>&nbsp;<span class="op" id="1555566">=</span>&nbsp;<span class="ident" id="1555568">NumGoroutine</span><span class="op" id="1555580">(</span><span class="op" id="1555581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555584">if</span>&nbsp;<span class="ident" id="1555587">n</span>&nbsp;<span class="op" id="1555589">&lt;=</span>&nbsp;<span class="builtinfunc" id="1555592">len</span><span class="op" id="1555595">(</span><span class="ident" id="1555596">p</span><span class="op" id="1555597">)</span>&nbsp;<span class="op" id="1555599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555603">gp</span>&nbsp;<span class="op" id="1555606">:=</span>&nbsp;<span class="ident" id="1555609">getg</span><span class="op" id="1555613">(</span><span class="op" id="1555614">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555618">semacquire</span><span class="op" id="1555628">(</span><span class="op" id="1555629">&amp;</span><span class="ident" id="1555630">worldsema</span><span class="op" id="1555639">,</span>&nbsp;<span class="builtintype" id="1555641">false</span><span class="op" id="1555646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555650">gp</span><span class="op" id="1555652">.</span><span class="ident" id="1555653">m</span><span class="op" id="1555654">.</span><span class="ident" id="1555655">gcing</span>&nbsp;<span class="op" id="1555661">=</span>&nbsp;<span class="num" id="1555663">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555667">onM</span><span class="op" id="1555670">(</span><span class="ident" id="1555671">stoptheworld</span><span class="op" id="1555683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555688">n</span>&nbsp;<span class="op" id="1555690">=</span>&nbsp;<span class="ident" id="1555692">NumGoroutine</span><span class="op" id="1555704">(</span><span class="op" id="1555705">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555709">if</span>&nbsp;<span class="ident" id="1555712">n</span>&nbsp;<span class="op" id="1555714">&lt;=</span>&nbsp;<span class="builtinfunc" id="1555717">len</span><span class="op" id="1555720">(</span><span class="ident" id="1555721">p</span><span class="op" id="1555722">)</span>&nbsp;<span class="op" id="1555724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555729">ok</span>&nbsp;<span class="op" id="1555732">=</span>&nbsp;<span class="builtintype" id="1555734">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555742">r</span>&nbsp;<span class="op" id="1555744">:=</span>&nbsp;<span class="ident" id="1555747">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555752">sp</span>&nbsp;<span class="op" id="1555755">:=</span>&nbsp;<span class="ident" id="1555758">getcallersp</span><span class="op" id="1555769">(</span><span class="ident" id="1555770">unsafe</span><span class="op" id="1555776">.</span><span class="ident" id="1555777">Pointer</span><span class="op" id="1555784">(</span><span class="op" id="1555785">&amp;</span><span class="ident" id="1555786">p</span><span class="op" id="1555787">)</span><span class="op" id="1555788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555793">pc</span>&nbsp;<span class="op" id="1555796">:=</span>&nbsp;<span class="ident" id="1555799">getcallerpc</span><span class="op" id="1555810">(</span><span class="ident" id="1555811">unsafe</span><span class="op" id="1555817">.</span><span class="ident" id="1555818">Pointer</span><span class="op" id="1555825">(</span><span class="op" id="1555826">&amp;</span><span class="ident" id="1555827">p</span><span class="op" id="1555828">)</span><span class="op" id="1555829">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555834">onM</span><span class="op" id="1555837">(</span><span class="keyword" id="1555838">func</span><span class="op" id="1555842">(</span><span class="op" id="1555843">)</span>&nbsp;<span class="op" id="1555845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555851">saveg</span><span class="op" id="1555856">(</span><span class="ident" id="1555857">pc</span><span class="op" id="1555859">,</span>&nbsp;<span class="ident" id="1555861">sp</span><span class="op" id="1555863">,</span>&nbsp;<span class="ident" id="1555865">gp</span><span class="op" id="1555867">,</span>&nbsp;<span class="op" id="1555869">&amp;</span><span class="ident" id="1555870">r</span><span class="op" id="1555871">[</span><span class="num" id="1555872">0</span><span class="op" id="1555873">]</span><span class="op" id="1555874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555879">}</span><span class="op" id="1555880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555885">r</span>&nbsp;<span class="op" id="1555887">=</span>&nbsp;<span class="ident" id="1555889">r</span><span class="op" id="1555890">[</span><span class="num" id="1555891">1</span><span class="op" id="1555892">:</span><span class="op" id="1555893">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555898">for</span>&nbsp;<span class="ident" id="1555902">_</span><span class="op" id="1555903">,</span>&nbsp;<span class="ident" id="1555905">gp1</span>&nbsp;<span class="op" id="1555909">:=</span>&nbsp;<span class="keyword" id="1555912">range</span>&nbsp;<span class="ident" id="1555918">allgs</span>&nbsp;<span class="op" id="1555924">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555930">if</span>&nbsp;<span class="ident" id="1555933">gp1</span>&nbsp;<span class="op" id="1555937">==</span>&nbsp;<span class="ident" id="1555940">gp</span>&nbsp;<span class="op" id="1555943">||</span>&nbsp;<span class="ident" id="1555946">readgstatus</span><span class="op" id="1555957">(</span><span class="ident" id="1555958">gp1</span><span class="op" id="1555961">)</span>&nbsp;<span class="op" id="1555963">==</span>&nbsp;<span class="ident" id="1555966">_Gdead</span>&nbsp;<span class="op" id="1555973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555980">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555999">saveg</span><span class="op" id="1556004">(</span><span class="op" id="1556005">^</span><span class="builtintype" id="1556006">uintptr</span><span class="op" id="1556013">(</span><span class="num" id="1556014">0</span><span class="op" id="1556015">)</span><span class="op" id="1556016">,</span>&nbsp;<span class="op" id="1556018">^</span><span class="builtintype" id="1556019">uintptr</span><span class="op" id="1556026">(</span><span class="num" id="1556027">0</span><span class="op" id="1556028">)</span><span class="op" id="1556029">,</span>&nbsp;<span class="ident" id="1556031">gp1</span><span class="op" id="1556034">,</span>&nbsp;<span class="op" id="1556036">&amp;</span><span class="ident" id="1556037">r</span><span class="op" id="1556038">[</span><span class="num" id="1556039">0</span><span class="op" id="1556040">]</span><span class="op" id="1556041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556047">r</span>&nbsp;<span class="op" id="1556049">=</span>&nbsp;<span class="ident" id="1556051">r</span><span class="op" id="1556052">[</span><span class="num" id="1556053">1</span><span class="op" id="1556054">:</span><span class="op" id="1556055">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556069">gp</span><span class="op" id="1556071">.</span><span class="ident" id="1556072">m</span><span class="op" id="1556073">.</span><span class="ident" id="1556074">gcing</span>&nbsp;<span class="op" id="1556080">=</span>&nbsp;<span class="num" id="1556082">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556086">semrelease</span><span class="op" id="1556096">(</span><span class="op" id="1556097">&amp;</span><span class="ident" id="1556098">worldsema</span><span class="op" id="1556107">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556111">onM</span><span class="op" id="1556114">(</span><span class="ident" id="1556115">starttheworld</span><span class="op" id="1556128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556135">return</span>&nbsp;<span class="ident" id="1556142">n</span><span class="op" id="1556143">,</span>&nbsp;<span class="ident" id="1556145">ok</span><br>
<span class="lineno"></span><span class="op" id="1556148">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1556151">func</span>&nbsp;<span class="ident" id="1556156">saveg</span><span class="op" id="1556161">(</span><span class="ident" id="1556162">pc</span><span class="op" id="1556164">,</span>&nbsp;<span class="ident" id="1556166">sp</span>&nbsp;<span class="builtintype" id="1556169">uintptr</span><span class="op" id="1556176">,</span>&nbsp;<span class="ident" id="1556178">gp</span>&nbsp;<span class="op" id="1556181">*</span><span class="ident" id="1556182">g</span><span class="op" id="1556183">,</span>&nbsp;<span class="ident" id="1556185">r</span>&nbsp;<span class="op" id="1556187">*</span><span class="ident" id="1556188">StackRecord</span><span class="op" id="1556199">)</span>&nbsp;<span class="op" id="1556201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556204">n</span>&nbsp;<span class="op" id="1556206">:=</span>&nbsp;<span class="ident" id="1556209">gentraceback</span><span class="op" id="1556221">(</span><span class="ident" id="1556222">pc</span><span class="op" id="1556224">,</span>&nbsp;<span class="ident" id="1556226">sp</span><span class="op" id="1556228">,</span>&nbsp;<span class="num" id="1556230">0</span><span class="op" id="1556231">,</span>&nbsp;<span class="ident" id="1556233">gp</span><span class="op" id="1556235">,</span>&nbsp;<span class="num" id="1556237">0</span><span class="op" id="1556238">,</span>&nbsp;<span class="op" id="1556240">&amp;</span><span class="ident" id="1556241">r</span><span class="op" id="1556242">.</span><span class="ident" id="1556243">Stack0</span><span class="op" id="1556249">[</span><span class="num" id="1556250">0</span><span class="op" id="1556251">]</span><span class="op" id="1556252">,</span>&nbsp;<span class="builtinfunc" id="1556254">len</span><span class="op" id="1556257">(</span><span class="ident" id="1556258">r</span><span class="op" id="1556259">.</span><span class="ident" id="1556260">Stack0</span><span class="op" id="1556266">)</span><span class="op" id="1556267">,</span>&nbsp;<span class="ident" id="1556269">nil</span><span class="op" id="1556272">,</span>&nbsp;<span class="ident" id="1556274">nil</span><span class="op" id="1556277">,</span>&nbsp;<span class="num" id="1556279">0</span><span class="op" id="1556280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556283">if</span>&nbsp;<span class="ident" id="1556286">n</span>&nbsp;<span class="op" id="1556288">&lt;</span>&nbsp;<span class="builtinfunc" id="1556290">len</span><span class="op" id="1556293">(</span><span class="ident" id="1556294">r</span><span class="op" id="1556295">.</span><span class="ident" id="1556296">Stack0</span><span class="op" id="1556302">)</span>&nbsp;<span class="op" id="1556304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556308">r</span><span class="op" id="1556309">.</span><span class="ident" id="1556310">Stack0</span><span class="op" id="1556316">[</span><span class="ident" id="1556317">n</span><span class="op" id="1556318">]</span>&nbsp;<span class="op" id="1556320">=</span>&nbsp;<span class="num" id="1556322">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556325">}</span><br>
<span class="lineno"></span><span class="op" id="1556327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1556330">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1556395">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1556446">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1556516">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1556571">func</span>&nbsp;<span class="ident" id="1556576">Stack</span><span class="op" id="1556581">(</span><span class="ident" id="1556582">buf</span>&nbsp;<span class="op" id="1556586">[</span><span class="op" id="1556587">]</span><span class="builtintype" id="1556588">byte</span><span class="op" id="1556592">,</span>&nbsp;<span class="ident" id="1556594">all</span>&nbsp;<span class="builtintype" id="1556598">bool</span><span class="op" id="1556602">)</span>&nbsp;<span class="builtintype" id="1556604">int</span>&nbsp;<span class="op" id="1556608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556611">mp</span>&nbsp;<span class="op" id="1556614">:=</span>&nbsp;<span class="ident" id="1556617">acquirem</span><span class="op" id="1556625">(</span><span class="op" id="1556626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556629">gp</span>&nbsp;<span class="op" id="1556632">:=</span>&nbsp;<span class="ident" id="1556635">mp</span><span class="op" id="1556637">.</span><span class="ident" id="1556638">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556644">if</span>&nbsp;<span class="ident" id="1556647">all</span>&nbsp;<span class="op" id="1556651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556655">semacquire</span><span class="op" id="1556665">(</span><span class="op" id="1556666">&amp;</span><span class="ident" id="1556667">worldsema</span><span class="op" id="1556676">,</span>&nbsp;<span class="builtintype" id="1556678">false</span><span class="op" id="1556683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556687">mp</span><span class="op" id="1556689">.</span><span class="ident" id="1556690">gcing</span>&nbsp;<span class="op" id="1556696">=</span>&nbsp;<span class="num" id="1556698">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556702">releasem</span><span class="op" id="1556710">(</span><span class="ident" id="1556711">mp</span><span class="op" id="1556713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556717">onM</span><span class="op" id="1556720">(</span><span class="ident" id="1556721">stoptheworld</span><span class="op" id="1556733">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556737">if</span>&nbsp;<span class="ident" id="1556740">mp</span>&nbsp;<span class="op" id="1556743">!=</span>&nbsp;<span class="ident" id="1556746">acquirem</span><span class="op" id="1556754">(</span><span class="op" id="1556755">)</span>&nbsp;<span class="op" id="1556757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556762">gothrow</span><span class="op" id="1556769">(</span><span class="string" id="1556770">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1556790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556801">n</span>&nbsp;<span class="op" id="1556803">:=</span>&nbsp;<span class="num" id="1556806">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556809">if</span>&nbsp;<span class="builtinfunc" id="1556812">len</span><span class="op" id="1556815">(</span><span class="ident" id="1556816">buf</span><span class="op" id="1556819">)</span>&nbsp;<span class="op" id="1556821">&gt;</span>&nbsp;<span class="num" id="1556823">0</span>&nbsp;<span class="op" id="1556825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556829">sp</span>&nbsp;<span class="op" id="1556832">:=</span>&nbsp;<span class="ident" id="1556835">getcallersp</span><span class="op" id="1556846">(</span><span class="ident" id="1556847">unsafe</span><span class="op" id="1556853">.</span><span class="ident" id="1556854">Pointer</span><span class="op" id="1556861">(</span><span class="op" id="1556862">&amp;</span><span class="ident" id="1556863">buf</span><span class="op" id="1556866">)</span><span class="op" id="1556867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556871">pc</span>&nbsp;<span class="op" id="1556874">:=</span>&nbsp;<span class="ident" id="1556877">getcallerpc</span><span class="op" id="1556888">(</span><span class="ident" id="1556889">unsafe</span><span class="op" id="1556895">.</span><span class="ident" id="1556896">Pointer</span><span class="op" id="1556903">(</span><span class="op" id="1556904">&amp;</span><span class="ident" id="1556905">buf</span><span class="op" id="1556908">)</span><span class="op" id="1556909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556913">onM</span><span class="op" id="1556916">(</span><span class="keyword" id="1556917">func</span><span class="op" id="1556921">(</span><span class="op" id="1556922">)</span>&nbsp;<span class="op" id="1556924">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556929">g0</span>&nbsp;<span class="op" id="1556932">:=</span>&nbsp;<span class="ident" id="1556935">getg</span><span class="op" id="1556939">(</span><span class="op" id="1556940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556945">g0</span><span class="op" id="1556947">.</span><span class="ident" id="1556948">writebuf</span>&nbsp;<span class="op" id="1556957">=</span>&nbsp;<span class="ident" id="1556959">buf</span><span class="op" id="1556962">[</span><span class="num" id="1556963">0</span><span class="op" id="1556964">:</span><span class="num" id="1556965">0</span><span class="op" id="1556966">:</span><span class="builtinfunc" id="1556967">len</span><span class="op" id="1556970">(</span><span class="ident" id="1556971">buf</span><span class="op" id="1556974">)</span><span class="op" id="1556975">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556980">goroutineheader</span><span class="op" id="1556995">(</span><span class="ident" id="1556996">gp</span><span class="op" id="1556998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557003">traceback</span><span class="op" id="1557012">(</span><span class="ident" id="1557013">pc</span><span class="op" id="1557015">,</span>&nbsp;<span class="ident" id="1557017">sp</span><span class="op" id="1557019">,</span>&nbsp;<span class="num" id="1557021">0</span><span class="op" id="1557022">,</span>&nbsp;<span class="ident" id="1557024">gp</span><span class="op" id="1557026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557031">if</span>&nbsp;<span class="ident" id="1557034">all</span>&nbsp;<span class="op" id="1557038">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557044">tracebackothers</span><span class="op" id="1557059">(</span><span class="ident" id="1557060">gp</span><span class="op" id="1557062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557072">n</span>&nbsp;<span class="op" id="1557074">=</span>&nbsp;<span class="builtinfunc" id="1557076">len</span><span class="op" id="1557079">(</span><span class="ident" id="1557080">g0</span><span class="op" id="1557082">.</span><span class="ident" id="1557083">writebuf</span><span class="op" id="1557091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557096">g0</span><span class="op" id="1557098">.</span><span class="ident" id="1557099">writebuf</span>&nbsp;<span class="op" id="1557108">=</span>&nbsp;<span class="ident" id="1557110">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557116">}</span><span class="op" id="1557117">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557124">if</span>&nbsp;<span class="ident" id="1557127">all</span>&nbsp;<span class="op" id="1557131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557135">mp</span><span class="op" id="1557137">.</span><span class="ident" id="1557138">gcing</span>&nbsp;<span class="op" id="1557144">=</span>&nbsp;<span class="num" id="1557146">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557150">semrelease</span><span class="op" id="1557160">(</span><span class="op" id="1557161">&amp;</span><span class="ident" id="1557162">worldsema</span><span class="op" id="1557171">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557175">onM</span><span class="op" id="1557178">(</span><span class="ident" id="1557179">starttheworld</span><span class="op" id="1557192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557198">releasem</span><span class="op" id="1557206">(</span><span class="ident" id="1557207">mp</span><span class="op" id="1557209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557212">return</span>&nbsp;<span class="ident" id="1557219">n</span><br>
<span class="lineno"></span><span class="op" id="1557221">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1557224">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1557254">var</span>&nbsp;<span class="ident" id="1557258">tracelock</span>&nbsp;<span class="ident" id="1557268">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1557275">func</span>&nbsp;<span class="ident" id="1557280">tracealloc</span><span class="op" id="1557290">(</span><span class="ident" id="1557291">p</span>&nbsp;<span class="ident" id="1557293">unsafe</span><span class="op" id="1557299">.</span><span class="ident" id="1557300">Pointer</span><span class="op" id="1557307">,</span>&nbsp;<span class="ident" id="1557309">size</span>&nbsp;<span class="builtintype" id="1557314">uintptr</span><span class="op" id="1557321">,</span>&nbsp;<span class="ident" id="1557323">typ</span>&nbsp;<span class="op" id="1557327">*</span><span class="ident" id="1557328">_type</span><span class="op" id="1557333">)</span>&nbsp;<span class="op" id="1557335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557338">lock</span><span class="op" id="1557342">(</span><span class="op" id="1557343">&amp;</span><span class="ident" id="1557344">tracelock</span><span class="op" id="1557353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557356">gp</span>&nbsp;<span class="op" id="1557359">:=</span>&nbsp;<span class="ident" id="1557362">getg</span><span class="op" id="1557366">(</span><span class="op" id="1557367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557370">gp</span><span class="op" id="1557372">.</span><span class="ident" id="1557373">m</span><span class="op" id="1557374">.</span><span class="ident" id="1557375">traceback</span>&nbsp;<span class="op" id="1557385">=</span>&nbsp;<span class="num" id="1557387">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557390">if</span>&nbsp;<span class="ident" id="1557393">typ</span>&nbsp;<span class="op" id="1557397">==</span>&nbsp;<span class="ident" id="1557400">nil</span>&nbsp;<span class="op" id="1557404">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1557408">print</span><span class="op" id="1557413">(</span><span class="string" id="1557414">&#34;tracealloc(&#34;</span><span class="op" id="1557427">,</span>&nbsp;<span class="ident" id="1557429">p</span><span class="op" id="1557430">,</span>&nbsp;<span class="string" id="1557432">&#34;,&nbsp;&#34;</span><span class="op" id="1557436">,</span>&nbsp;<span class="ident" id="1557438">hex</span><span class="op" id="1557441">(</span><span class="ident" id="1557442">size</span><span class="op" id="1557446">)</span><span class="op" id="1557447">,</span>&nbsp;<span class="string" id="1557449">&#34;)\n&#34;</span><span class="op" id="1557454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557457">}</span>&nbsp;<span class="keyword" id="1557459">else</span>&nbsp;<span class="op" id="1557464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1557468">print</span><span class="op" id="1557473">(</span><span class="string" id="1557474">&#34;tracealloc(&#34;</span><span class="op" id="1557487">,</span>&nbsp;<span class="ident" id="1557489">p</span><span class="op" id="1557490">,</span>&nbsp;<span class="string" id="1557492">&#34;,&nbsp;&#34;</span><span class="op" id="1557496">,</span>&nbsp;<span class="ident" id="1557498">hex</span><span class="op" id="1557501">(</span><span class="ident" id="1557502">size</span><span class="op" id="1557506">)</span><span class="op" id="1557507">,</span>&nbsp;<span class="string" id="1557509">&#34;,&nbsp;&#34;</span><span class="op" id="1557513">,</span>&nbsp;<span class="op" id="1557515">*</span><span class="ident" id="1557516">typ</span><span class="op" id="1557519">.</span><span class="ident" id="1557520">_string</span><span class="op" id="1557527">,</span>&nbsp;<span class="string" id="1557529">&#34;)\n&#34;</span><span class="op" id="1557534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557540">if</span>&nbsp;<span class="ident" id="1557543">gp</span><span class="op" id="1557545">.</span><span class="ident" id="1557546">m</span><span class="op" id="1557547">.</span><span class="ident" id="1557548">curg</span>&nbsp;<span class="op" id="1557553">==</span>&nbsp;<span class="ident" id="1557556">nil</span>&nbsp;<span class="op" id="1557560">||</span>&nbsp;<span class="ident" id="1557563">gp</span>&nbsp;<span class="op" id="1557566">==</span>&nbsp;<span class="ident" id="1557569">gp</span><span class="op" id="1557571">.</span><span class="ident" id="1557572">m</span><span class="op" id="1557573">.</span><span class="ident" id="1557574">curg</span>&nbsp;<span class="op" id="1557579">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557583">goroutineheader</span><span class="op" id="1557598">(</span><span class="ident" id="1557599">gp</span><span class="op" id="1557601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557605">pc</span>&nbsp;<span class="op" id="1557608">:=</span>&nbsp;<span class="ident" id="1557611">getcallerpc</span><span class="op" id="1557622">(</span><span class="ident" id="1557623">unsafe</span><span class="op" id="1557629">.</span><span class="ident" id="1557630">Pointer</span><span class="op" id="1557637">(</span><span class="op" id="1557638">&amp;</span><span class="ident" id="1557639">p</span><span class="op" id="1557640">)</span><span class="op" id="1557641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557645">sp</span>&nbsp;<span class="op" id="1557648">:=</span>&nbsp;<span class="ident" id="1557651">getcallersp</span><span class="op" id="1557662">(</span><span class="ident" id="1557663">unsafe</span><span class="op" id="1557669">.</span><span class="ident" id="1557670">Pointer</span><span class="op" id="1557677">(</span><span class="op" id="1557678">&amp;</span><span class="ident" id="1557679">p</span><span class="op" id="1557680">)</span><span class="op" id="1557681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557685">onM</span><span class="op" id="1557688">(</span><span class="keyword" id="1557689">func</span><span class="op" id="1557693">(</span><span class="op" id="1557694">)</span>&nbsp;<span class="op" id="1557696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557701">traceback</span><span class="op" id="1557710">(</span><span class="ident" id="1557711">pc</span><span class="op" id="1557713">,</span>&nbsp;<span class="ident" id="1557715">sp</span><span class="op" id="1557717">,</span>&nbsp;<span class="num" id="1557719">0</span><span class="op" id="1557720">,</span>&nbsp;<span class="ident" id="1557722">gp</span><span class="op" id="1557724">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557728">}</span><span class="op" id="1557729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557732">}</span>&nbsp;<span class="keyword" id="1557734">else</span>&nbsp;<span class="op" id="1557739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557743">goroutineheader</span><span class="op" id="1557758">(</span><span class="ident" id="1557759">gp</span><span class="op" id="1557761">.</span><span class="ident" id="1557762">m</span><span class="op" id="1557763">.</span><span class="ident" id="1557764">curg</span><span class="op" id="1557768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557772">traceback</span><span class="op" id="1557781">(</span><span class="op" id="1557782">^</span><span class="builtintype" id="1557783">uintptr</span><span class="op" id="1557790">(</span><span class="num" id="1557791">0</span><span class="op" id="1557792">)</span><span class="op" id="1557793">,</span>&nbsp;<span class="op" id="1557795">^</span><span class="builtintype" id="1557796">uintptr</span><span class="op" id="1557803">(</span><span class="num" id="1557804">0</span><span class="op" id="1557805">)</span><span class="op" id="1557806">,</span>&nbsp;<span class="num" id="1557808">0</span><span class="op" id="1557809">,</span>&nbsp;<span class="ident" id="1557811">gp</span><span class="op" id="1557813">.</span><span class="ident" id="1557814">m</span><span class="op" id="1557815">.</span><span class="ident" id="1557816">curg</span><span class="op" id="1557820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557823">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1557826">print</span><span class="op" id="1557831">(</span><span class="string" id="1557832">&#34;\n&#34;</span><span class="op" id="1557836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557839">gp</span><span class="op" id="1557841">.</span><span class="ident" id="1557842">m</span><span class="op" id="1557843">.</span><span class="ident" id="1557844">traceback</span>&nbsp;<span class="op" id="1557854">=</span>&nbsp;<span class="num" id="1557856">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557859">unlock</span><span class="op" id="1557865">(</span><span class="op" id="1557866">&amp;</span><span class="ident" id="1557867">tracelock</span><span class="op" id="1557876">)</span><br>
<span class="lineno"></span><span class="op" id="1557878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1557881">func</span>&nbsp;<span class="ident" id="1557886">tracefree</span><span class="op" id="1557895">(</span><span class="ident" id="1557896">p</span>&nbsp;<span class="ident" id="1557898">unsafe</span><span class="op" id="1557904">.</span><span class="ident" id="1557905">Pointer</span><span class="op" id="1557912">,</span>&nbsp;<span class="ident" id="1557914">size</span>&nbsp;<span class="builtintype" id="1557919">uintptr</span><span class="op" id="1557926">)</span>&nbsp;<span class="op" id="1557928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557931">lock</span><span class="op" id="1557935">(</span><span class="op" id="1557936">&amp;</span><span class="ident" id="1557937">tracelock</span><span class="op" id="1557946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557949">gp</span>&nbsp;<span class="op" id="1557952">:=</span>&nbsp;<span class="ident" id="1557955">getg</span><span class="op" id="1557959">(</span><span class="op" id="1557960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557963">gp</span><span class="op" id="1557965">.</span><span class="ident" id="1557966">m</span><span class="op" id="1557967">.</span><span class="ident" id="1557968">traceback</span>&nbsp;<span class="op" id="1557978">=</span>&nbsp;<span class="num" id="1557980">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1557983">print</span><span class="op" id="1557988">(</span><span class="string" id="1557989">&#34;tracefree(&#34;</span><span class="op" id="1558001">,</span>&nbsp;<span class="ident" id="1558003">p</span><span class="op" id="1558004">,</span>&nbsp;<span class="string" id="1558006">&#34;,&nbsp;&#34;</span><span class="op" id="1558010">,</span>&nbsp;<span class="ident" id="1558012">hex</span><span class="op" id="1558015">(</span><span class="ident" id="1558016">size</span><span class="op" id="1558020">)</span><span class="op" id="1558021">,</span>&nbsp;<span class="string" id="1558023">&#34;)\n&#34;</span><span class="op" id="1558028">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558031">goroutineheader</span><span class="op" id="1558046">(</span><span class="ident" id="1558047">gp</span><span class="op" id="1558049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558052">pc</span>&nbsp;<span class="op" id="1558055">:=</span>&nbsp;<span class="ident" id="1558058">getcallerpc</span><span class="op" id="1558069">(</span><span class="ident" id="1558070">unsafe</span><span class="op" id="1558076">.</span><span class="ident" id="1558077">Pointer</span><span class="op" id="1558084">(</span><span class="op" id="1558085">&amp;</span><span class="ident" id="1558086">p</span><span class="op" id="1558087">)</span><span class="op" id="1558088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558091">sp</span>&nbsp;<span class="op" id="1558094">:=</span>&nbsp;<span class="ident" id="1558097">getcallersp</span><span class="op" id="1558108">(</span><span class="ident" id="1558109">unsafe</span><span class="op" id="1558115">.</span><span class="ident" id="1558116">Pointer</span><span class="op" id="1558123">(</span><span class="op" id="1558124">&amp;</span><span class="ident" id="1558125">p</span><span class="op" id="1558126">)</span><span class="op" id="1558127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558130">onM</span><span class="op" id="1558133">(</span><span class="keyword" id="1558134">func</span><span class="op" id="1558138">(</span><span class="op" id="1558139">)</span>&nbsp;<span class="op" id="1558141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558145">traceback</span><span class="op" id="1558154">(</span><span class="ident" id="1558155">pc</span><span class="op" id="1558157">,</span>&nbsp;<span class="ident" id="1558159">sp</span><span class="op" id="1558161">,</span>&nbsp;<span class="num" id="1558163">0</span><span class="op" id="1558164">,</span>&nbsp;<span class="ident" id="1558166">gp</span><span class="op" id="1558168">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1558171">}</span><span class="op" id="1558172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1558175">print</span><span class="op" id="1558180">(</span><span class="string" id="1558181">&#34;\n&#34;</span><span class="op" id="1558185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558188">gp</span><span class="op" id="1558190">.</span><span class="ident" id="1558191">m</span><span class="op" id="1558192">.</span><span class="ident" id="1558193">traceback</span>&nbsp;<span class="op" id="1558203">=</span>&nbsp;<span class="num" id="1558205">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558208">unlock</span><span class="op" id="1558214">(</span><span class="op" id="1558215">&amp;</span><span class="ident" id="1558216">tracelock</span><span class="op" id="1558225">)</span><br>
<span class="lineno"></span><span class="op" id="1558227">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1558230">func</span>&nbsp;<span class="ident" id="1558235">tracegc</span><span class="op" id="1558242">(</span><span class="op" id="1558243">)</span>&nbsp;<span class="op" id="1558245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558248">lock</span><span class="op" id="1558252">(</span><span class="op" id="1558253">&amp;</span><span class="ident" id="1558254">tracelock</span><span class="op" id="1558263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558266">gp</span>&nbsp;<span class="op" id="1558269">:=</span>&nbsp;<span class="ident" id="1558272">getg</span><span class="op" id="1558276">(</span><span class="op" id="1558277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558280">gp</span><span class="op" id="1558282">.</span><span class="ident" id="1558283">m</span><span class="op" id="1558284">.</span><span class="ident" id="1558285">traceback</span>&nbsp;<span class="op" id="1558295">=</span>&nbsp;<span class="num" id="1558297">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1558300">print</span><span class="op" id="1558305">(</span><span class="string" id="1558306">&#34;tracegc()\n&#34;</span><span class="op" id="1558319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1558322">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558377">tracebackothers</span><span class="op" id="1558392">(</span><span class="ident" id="1558393">gp</span><span class="op" id="1558395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1558398">print</span><span class="op" id="1558403">(</span><span class="string" id="1558404">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1558419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1558422">print</span><span class="op" id="1558427">(</span><span class="string" id="1558428">&#34;\n&#34;</span><span class="op" id="1558432">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558435">gp</span><span class="op" id="1558437">.</span><span class="ident" id="1558438">m</span><span class="op" id="1558439">.</span><span class="ident" id="1558440">traceback</span>&nbsp;<span class="op" id="1558450">=</span>&nbsp;<span class="num" id="1558452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558455">unlock</span><span class="op" id="1558461">(</span><span class="op" id="1558462">&amp;</span><span class="ident" id="1558463">tracelock</span><span class="op" id="1558472">)</span><br>
<span class="lineno"></span><span class="op" id="1558474">}</span>
</div>
</body>
</html>
