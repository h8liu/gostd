<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4019619">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4019674">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4019728">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4019779">package</span>&nbsp;<span class="ident" id="4019787">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4019792">import</span>&nbsp;<span class="op" id="4019799">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019802">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019811">&#34;crypto/aes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019825">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019842">&#34;crypto/hmac&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019857">&#34;crypto/sha256&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019874">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019891">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4019901">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4019906">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4019909">//&nbsp;sessionState&nbsp;contains&nbsp;the&nbsp;information&nbsp;that&nbsp;is&nbsp;serialized&nbsp;into&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span><span class="comment" id="4019984">//&nbsp;ticket&nbsp;in&nbsp;order&nbsp;to&nbsp;later&nbsp;resume&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="4020033">type</span>&nbsp;<span class="ident" id="4020038">sessionState</span>&nbsp;<span class="keyword" id="4020051">struct</span>&nbsp;<span class="op" id="4020058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020061">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4020074">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020082">cipherSuite</span>&nbsp;&nbsp;<span class="builtintype" id="4020095">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020103">masterSecret</span>&nbsp;<span class="op" id="4020116">[</span><span class="op" id="4020117">]</span><span class="builtintype" id="4020118">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020124">certificates</span>&nbsp;<span class="op" id="4020137">[</span><span class="op" id="4020138">]</span><span class="op" id="4020139">[</span><span class="op" id="4020140">]</span><span class="builtintype" id="4020141">byte</span><br>
<span class="lineno">25</span><span class="op" id="4020146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4020149">func</span>&nbsp;<span class="op" id="4020154">(</span><span class="ident" id="4020155">s</span>&nbsp;<span class="op" id="4020157">*</span><span class="ident" id="4020158">sessionState</span><span class="op" id="4020170">)</span>&nbsp;<span class="ident" id="4020172">equal</span><span class="op" id="4020177">(</span><span class="ident" id="4020178">i</span>&nbsp;<span class="keyword" id="4020180">interface</span><span class="op" id="4020189">{</span><span class="op" id="4020190">}</span><span class="op" id="4020191">)</span>&nbsp;<span class="builtintype" id="4020193">bool</span>&nbsp;<span class="op" id="4020198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020201">s1</span><span class="op" id="4020203">,</span>&nbsp;<span class="ident" id="4020205">ok</span>&nbsp;<span class="op" id="4020208">:=</span>&nbsp;<span class="ident" id="4020211">i</span><span class="op" id="4020212">.</span><span class="op" id="4020213">(</span><span class="op" id="4020214">*</span><span class="ident" id="4020215">sessionState</span><span class="op" id="4020227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020230">if</span>&nbsp;<span class="op" id="4020233">!</span><span class="ident" id="4020234">ok</span>&nbsp;<span class="op" id="4020237">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020241">return</span>&nbsp;<span class="ident" id="4020248">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020259">if</span>&nbsp;<span class="ident" id="4020262">s</span><span class="op" id="4020263">.</span><span class="ident" id="4020264">vers</span>&nbsp;<span class="op" id="4020269">!=</span>&nbsp;<span class="ident" id="4020272">s1</span><span class="op" id="4020274">.</span><span class="ident" id="4020275">vers</span>&nbsp;<span class="op" id="4020280">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020285">s</span><span class="op" id="4020286">.</span><span class="ident" id="4020287">cipherSuite</span>&nbsp;<span class="op" id="4020299">!=</span>&nbsp;<span class="ident" id="4020302">s1</span><span class="op" id="4020304">.</span><span class="ident" id="4020305">cipherSuite</span>&nbsp;<span class="op" id="4020317">||</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020322">!</span><span class="ident" id="4020323">bytes</span><span class="op" id="4020328">.</span><span class="ident" id="4020329">Equal</span><span class="op" id="4020334">(</span><span class="ident" id="4020335">s</span><span class="op" id="4020336">.</span><span class="ident" id="4020337">masterSecret</span><span class="op" id="4020349">,</span>&nbsp;<span class="ident" id="4020351">s1</span><span class="op" id="4020353">.</span><span class="ident" id="4020354">masterSecret</span><span class="op" id="4020366">)</span>&nbsp;<span class="op" id="4020368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020372">return</span>&nbsp;<span class="ident" id="4020379">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020390">if</span>&nbsp;<span class="builtinfunc" id="4020393">len</span><span class="op" id="4020396">(</span><span class="ident" id="4020397">s</span><span class="op" id="4020398">.</span><span class="ident" id="4020399">certificates</span><span class="op" id="4020411">)</span>&nbsp;<span class="op" id="4020413">!=</span>&nbsp;<span class="builtinfunc" id="4020416">len</span><span class="op" id="4020419">(</span><span class="ident" id="4020420">s1</span><span class="op" id="4020422">.</span><span class="ident" id="4020423">certificates</span><span class="op" id="4020435">)</span>&nbsp;<span class="op" id="4020437">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020441">return</span>&nbsp;<span class="ident" id="4020448">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020459">for</span>&nbsp;<span class="ident" id="4020463">i</span>&nbsp;<span class="op" id="4020465">:=</span>&nbsp;<span class="keyword" id="4020468">range</span>&nbsp;<span class="ident" id="4020474">s</span><span class="op" id="4020475">.</span><span class="ident" id="4020476">certificates</span>&nbsp;<span class="op" id="4020489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020493">if</span>&nbsp;<span class="op" id="4020496">!</span><span class="ident" id="4020497">bytes</span><span class="op" id="4020502">.</span><span class="ident" id="4020503">Equal</span><span class="op" id="4020508">(</span><span class="ident" id="4020509">s</span><span class="op" id="4020510">.</span><span class="ident" id="4020511">certificates</span><span class="op" id="4020523">[</span><span class="ident" id="4020524">i</span><span class="op" id="4020525">]</span><span class="op" id="4020526">,</span>&nbsp;<span class="ident" id="4020528">s1</span><span class="op" id="4020530">.</span><span class="ident" id="4020531">certificates</span><span class="op" id="4020543">[</span><span class="ident" id="4020544">i</span><span class="op" id="4020545">]</span><span class="op" id="4020546">)</span>&nbsp;<span class="op" id="4020548">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020553">return</span>&nbsp;<span class="ident" id="4020560">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020575">return</span>&nbsp;<span class="ident" id="4020582">true</span><br>
<span class="lineno">50</span><span class="op" id="4020587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4020590">func</span>&nbsp;<span class="op" id="4020595">(</span><span class="ident" id="4020596">s</span>&nbsp;<span class="op" id="4020598">*</span><span class="ident" id="4020599">sessionState</span><span class="op" id="4020611">)</span>&nbsp;<span class="ident" id="4020613">marshal</span><span class="op" id="4020620">(</span><span class="op" id="4020621">)</span>&nbsp;<span class="op" id="4020623">[</span><span class="op" id="4020624">]</span><span class="builtintype" id="4020625">byte</span>&nbsp;<span class="op" id="4020630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020633">length</span>&nbsp;<span class="op" id="4020640">:=</span>&nbsp;<span class="num" id="4020643">2</span>&nbsp;<span class="op" id="4020645">+</span>&nbsp;<span class="num" id="4020647">2</span>&nbsp;<span class="op" id="4020649">+</span>&nbsp;<span class="num" id="4020651">2</span>&nbsp;<span class="op" id="4020653">+</span>&nbsp;<span class="builtinfunc" id="4020655">len</span><span class="op" id="4020658">(</span><span class="ident" id="4020659">s</span><span class="op" id="4020660">.</span><span class="ident" id="4020661">masterSecret</span><span class="op" id="4020673">)</span>&nbsp;<span class="op" id="4020675">+</span>&nbsp;<span class="num" id="4020677">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020680">for</span>&nbsp;<span class="ident" id="4020684">_</span><span class="op" id="4020685">,</span>&nbsp;<span class="ident" id="4020687">cert</span>&nbsp;<span class="op" id="4020692">:=</span>&nbsp;<span class="keyword" id="4020695">range</span>&nbsp;<span class="ident" id="4020701">s</span><span class="op" id="4020702">.</span><span class="ident" id="4020703">certificates</span>&nbsp;<span class="op" id="4020716">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020720">length</span>&nbsp;<span class="op" id="4020727">+=</span>&nbsp;<span class="num" id="4020730">4</span>&nbsp;<span class="op" id="4020732">+</span>&nbsp;<span class="builtinfunc" id="4020734">len</span><span class="op" id="4020737">(</span><span class="ident" id="4020738">cert</span><span class="op" id="4020742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020749">ret</span>&nbsp;<span class="op" id="4020753">:=</span>&nbsp;<span class="builtinfunc" id="4020756">make</span><span class="op" id="4020760">(</span><span class="op" id="4020761">[</span><span class="op" id="4020762">]</span><span class="builtintype" id="4020763">byte</span><span class="op" id="4020767">,</span>&nbsp;<span class="ident" id="4020769">length</span><span class="op" id="4020775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020778">x</span>&nbsp;<span class="op" id="4020780">:=</span>&nbsp;<span class="ident" id="4020783">ret</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020788">x</span><span class="op" id="4020789">[</span><span class="num" id="4020790">0</span><span class="op" id="4020791">]</span>&nbsp;<span class="op" id="4020793">=</span>&nbsp;<span class="builtintype" id="4020795">byte</span><span class="op" id="4020799">(</span><span class="ident" id="4020800">s</span><span class="op" id="4020801">.</span><span class="ident" id="4020802">vers</span>&nbsp;<span class="op" id="4020807">&gt;&gt;</span>&nbsp;<span class="num" id="4020810">8</span><span class="op" id="4020811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020814">x</span><span class="op" id="4020815">[</span><span class="num" id="4020816">1</span><span class="op" id="4020817">]</span>&nbsp;<span class="op" id="4020819">=</span>&nbsp;<span class="builtintype" id="4020821">byte</span><span class="op" id="4020825">(</span><span class="ident" id="4020826">s</span><span class="op" id="4020827">.</span><span class="ident" id="4020828">vers</span><span class="op" id="4020832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020835">x</span><span class="op" id="4020836">[</span><span class="num" id="4020837">2</span><span class="op" id="4020838">]</span>&nbsp;<span class="op" id="4020840">=</span>&nbsp;<span class="builtintype" id="4020842">byte</span><span class="op" id="4020846">(</span><span class="ident" id="4020847">s</span><span class="op" id="4020848">.</span><span class="ident" id="4020849">cipherSuite</span>&nbsp;<span class="op" id="4020861">&gt;&gt;</span>&nbsp;<span class="num" id="4020864">8</span><span class="op" id="4020865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020868">x</span><span class="op" id="4020869">[</span><span class="num" id="4020870">3</span><span class="op" id="4020871">]</span>&nbsp;<span class="op" id="4020873">=</span>&nbsp;<span class="builtintype" id="4020875">byte</span><span class="op" id="4020879">(</span><span class="ident" id="4020880">s</span><span class="op" id="4020881">.</span><span class="ident" id="4020882">cipherSuite</span><span class="op" id="4020893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020896">x</span><span class="op" id="4020897">[</span><span class="num" id="4020898">4</span><span class="op" id="4020899">]</span>&nbsp;<span class="op" id="4020901">=</span>&nbsp;<span class="builtintype" id="4020903">byte</span><span class="op" id="4020907">(</span><span class="builtinfunc" id="4020908">len</span><span class="op" id="4020911">(</span><span class="ident" id="4020912">s</span><span class="op" id="4020913">.</span><span class="ident" id="4020914">masterSecret</span><span class="op" id="4020926">)</span>&nbsp;<span class="op" id="4020928">&gt;&gt;</span>&nbsp;<span class="num" id="4020931">8</span><span class="op" id="4020932">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020935">x</span><span class="op" id="4020936">[</span><span class="num" id="4020937">5</span><span class="op" id="4020938">]</span>&nbsp;<span class="op" id="4020940">=</span>&nbsp;<span class="builtintype" id="4020942">byte</span><span class="op" id="4020946">(</span><span class="builtinfunc" id="4020947">len</span><span class="op" id="4020950">(</span><span class="ident" id="4020951">s</span><span class="op" id="4020952">.</span><span class="ident" id="4020953">masterSecret</span><span class="op" id="4020965">)</span><span class="op" id="4020966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020969">x</span>&nbsp;<span class="op" id="4020971">=</span>&nbsp;<span class="ident" id="4020973">x</span><span class="op" id="4020974">[</span><span class="num" id="4020975">6</span><span class="op" id="4020976">:</span><span class="op" id="4020977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4020980">copy</span><span class="op" id="4020984">(</span><span class="ident" id="4020985">x</span><span class="op" id="4020986">,</span>&nbsp;<span class="ident" id="4020988">s</span><span class="op" id="4020989">.</span><span class="ident" id="4020990">masterSecret</span><span class="op" id="4021002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021005">x</span>&nbsp;<span class="op" id="4021007">=</span>&nbsp;<span class="ident" id="4021009">x</span><span class="op" id="4021010">[</span><span class="builtinfunc" id="4021011">len</span><span class="op" id="4021014">(</span><span class="ident" id="4021015">s</span><span class="op" id="4021016">.</span><span class="ident" id="4021017">masterSecret</span><span class="op" id="4021029">)</span><span class="op" id="4021030">:</span><span class="op" id="4021031">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021035">x</span><span class="op" id="4021036">[</span><span class="num" id="4021037">0</span><span class="op" id="4021038">]</span>&nbsp;<span class="op" id="4021040">=</span>&nbsp;<span class="builtintype" id="4021042">byte</span><span class="op" id="4021046">(</span><span class="builtinfunc" id="4021047">len</span><span class="op" id="4021050">(</span><span class="ident" id="4021051">s</span><span class="op" id="4021052">.</span><span class="ident" id="4021053">certificates</span><span class="op" id="4021065">)</span>&nbsp;<span class="op" id="4021067">&gt;&gt;</span>&nbsp;<span class="num" id="4021070">8</span><span class="op" id="4021071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021074">x</span><span class="op" id="4021075">[</span><span class="num" id="4021076">1</span><span class="op" id="4021077">]</span>&nbsp;<span class="op" id="4021079">=</span>&nbsp;<span class="builtintype" id="4021081">byte</span><span class="op" id="4021085">(</span><span class="builtinfunc" id="4021086">len</span><span class="op" id="4021089">(</span><span class="ident" id="4021090">s</span><span class="op" id="4021091">.</span><span class="ident" id="4021092">certificates</span><span class="op" id="4021104">)</span><span class="op" id="4021105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021108">x</span>&nbsp;<span class="op" id="4021110">=</span>&nbsp;<span class="ident" id="4021112">x</span><span class="op" id="4021113">[</span><span class="num" id="4021114">2</span><span class="op" id="4021115">:</span><span class="op" id="4021116">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021120">for</span>&nbsp;<span class="ident" id="4021124">_</span><span class="op" id="4021125">,</span>&nbsp;<span class="ident" id="4021127">cert</span>&nbsp;<span class="op" id="4021132">:=</span>&nbsp;<span class="keyword" id="4021135">range</span>&nbsp;<span class="ident" id="4021141">s</span><span class="op" id="4021142">.</span><span class="ident" id="4021143">certificates</span>&nbsp;<span class="op" id="4021156">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021160">x</span><span class="op" id="4021161">[</span><span class="num" id="4021162">0</span><span class="op" id="4021163">]</span>&nbsp;<span class="op" id="4021165">=</span>&nbsp;<span class="builtintype" id="4021167">byte</span><span class="op" id="4021171">(</span><span class="builtinfunc" id="4021172">len</span><span class="op" id="4021175">(</span><span class="ident" id="4021176">cert</span><span class="op" id="4021180">)</span>&nbsp;<span class="op" id="4021182">&gt;&gt;</span>&nbsp;<span class="num" id="4021185">24</span><span class="op" id="4021187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021191">x</span><span class="op" id="4021192">[</span><span class="num" id="4021193">1</span><span class="op" id="4021194">]</span>&nbsp;<span class="op" id="4021196">=</span>&nbsp;<span class="builtintype" id="4021198">byte</span><span class="op" id="4021202">(</span><span class="builtinfunc" id="4021203">len</span><span class="op" id="4021206">(</span><span class="ident" id="4021207">cert</span><span class="op" id="4021211">)</span>&nbsp;<span class="op" id="4021213">&gt;&gt;</span>&nbsp;<span class="num" id="4021216">16</span><span class="op" id="4021218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021222">x</span><span class="op" id="4021223">[</span><span class="num" id="4021224">2</span><span class="op" id="4021225">]</span>&nbsp;<span class="op" id="4021227">=</span>&nbsp;<span class="builtintype" id="4021229">byte</span><span class="op" id="4021233">(</span><span class="builtinfunc" id="4021234">len</span><span class="op" id="4021237">(</span><span class="ident" id="4021238">cert</span><span class="op" id="4021242">)</span>&nbsp;<span class="op" id="4021244">&gt;&gt;</span>&nbsp;<span class="num" id="4021247">8</span><span class="op" id="4021248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021252">x</span><span class="op" id="4021253">[</span><span class="num" id="4021254">3</span><span class="op" id="4021255">]</span>&nbsp;<span class="op" id="4021257">=</span>&nbsp;<span class="builtintype" id="4021259">byte</span><span class="op" id="4021263">(</span><span class="builtinfunc" id="4021264">len</span><span class="op" id="4021267">(</span><span class="ident" id="4021268">cert</span><span class="op" id="4021272">)</span><span class="op" id="4021273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4021277">copy</span><span class="op" id="4021281">(</span><span class="ident" id="4021282">x</span><span class="op" id="4021283">[</span><span class="num" id="4021284">4</span><span class="op" id="4021285">:</span><span class="op" id="4021286">]</span><span class="op" id="4021287">,</span>&nbsp;<span class="ident" id="4021289">cert</span><span class="op" id="4021293">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021297">x</span>&nbsp;<span class="op" id="4021299">=</span>&nbsp;<span class="ident" id="4021301">x</span><span class="op" id="4021302">[</span><span class="num" id="4021303">4</span><span class="op" id="4021304">+</span><span class="builtinfunc" id="4021305">len</span><span class="op" id="4021308">(</span><span class="ident" id="4021309">cert</span><span class="op" id="4021313">)</span><span class="op" id="4021314">:</span><span class="op" id="4021315">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021322">return</span>&nbsp;<span class="ident" id="4021329">ret</span><br>
<span class="lineno"></span><span class="op" id="4021333">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="4021336">func</span>&nbsp;<span class="op" id="4021341">(</span><span class="ident" id="4021342">s</span>&nbsp;<span class="op" id="4021344">*</span><span class="ident" id="4021345">sessionState</span><span class="op" id="4021357">)</span>&nbsp;<span class="ident" id="4021359">unmarshal</span><span class="op" id="4021368">(</span><span class="ident" id="4021369">data</span>&nbsp;<span class="op" id="4021374">[</span><span class="op" id="4021375">]</span><span class="builtintype" id="4021376">byte</span><span class="op" id="4021380">)</span>&nbsp;<span class="builtintype" id="4021382">bool</span>&nbsp;<span class="op" id="4021387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021390">if</span>&nbsp;<span class="builtinfunc" id="4021393">len</span><span class="op" id="4021396">(</span><span class="ident" id="4021397">data</span><span class="op" id="4021401">)</span>&nbsp;<span class="op" id="4021403">&lt;</span>&nbsp;<span class="num" id="4021405">8</span>&nbsp;<span class="op" id="4021407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021411">return</span>&nbsp;<span class="ident" id="4021418">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021425">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021429">s</span><span class="op" id="4021430">.</span><span class="ident" id="4021431">vers</span>&nbsp;<span class="op" id="4021436">=</span>&nbsp;<span class="builtintype" id="4021438">uint16</span><span class="op" id="4021444">(</span><span class="ident" id="4021445">data</span><span class="op" id="4021449">[</span><span class="num" id="4021450">0</span><span class="op" id="4021451">]</span><span class="op" id="4021452">)</span><span class="op" id="4021453">&lt;&lt;</span><span class="num" id="4021455">8</span>&nbsp;<span class="op" id="4021457">|</span>&nbsp;<span class="builtintype" id="4021459">uint16</span><span class="op" id="4021465">(</span><span class="ident" id="4021466">data</span><span class="op" id="4021470">[</span><span class="num" id="4021471">1</span><span class="op" id="4021472">]</span><span class="op" id="4021473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021476">s</span><span class="op" id="4021477">.</span><span class="ident" id="4021478">cipherSuite</span>&nbsp;<span class="op" id="4021490">=</span>&nbsp;<span class="builtintype" id="4021492">uint16</span><span class="op" id="4021498">(</span><span class="ident" id="4021499">data</span><span class="op" id="4021503">[</span><span class="num" id="4021504">2</span><span class="op" id="4021505">]</span><span class="op" id="4021506">)</span><span class="op" id="4021507">&lt;&lt;</span><span class="num" id="4021509">8</span>&nbsp;<span class="op" id="4021511">|</span>&nbsp;<span class="builtintype" id="4021513">uint16</span><span class="op" id="4021519">(</span><span class="ident" id="4021520">data</span><span class="op" id="4021524">[</span><span class="num" id="4021525">3</span><span class="op" id="4021526">]</span><span class="op" id="4021527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021530">masterSecretLen</span>&nbsp;<span class="op" id="4021546">:=</span>&nbsp;<span class="builtintype" id="4021549">int</span><span class="op" id="4021552">(</span><span class="ident" id="4021553">data</span><span class="op" id="4021557">[</span><span class="num" id="4021558">4</span><span class="op" id="4021559">]</span><span class="op" id="4021560">)</span><span class="op" id="4021561">&lt;&lt;</span><span class="num" id="4021563">8</span>&nbsp;<span class="op" id="4021565">|</span>&nbsp;<span class="builtintype" id="4021567">int</span><span class="op" id="4021570">(</span><span class="ident" id="4021571">data</span><span class="op" id="4021575">[</span><span class="num" id="4021576">5</span><span class="op" id="4021577">]</span><span class="op" id="4021578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021581">data</span>&nbsp;<span class="op" id="4021586">=</span>&nbsp;<span class="ident" id="4021588">data</span><span class="op" id="4021592">[</span><span class="num" id="4021593">6</span><span class="op" id="4021594">:</span><span class="op" id="4021595">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021598">if</span>&nbsp;<span class="builtinfunc" id="4021601">len</span><span class="op" id="4021604">(</span><span class="ident" id="4021605">data</span><span class="op" id="4021609">)</span>&nbsp;<span class="op" id="4021611">&lt;</span>&nbsp;<span class="ident" id="4021613">masterSecretLen</span>&nbsp;<span class="op" id="4021629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021633">return</span>&nbsp;<span class="ident" id="4021640">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021651">s</span><span class="op" id="4021652">.</span><span class="ident" id="4021653">masterSecret</span>&nbsp;<span class="op" id="4021666">=</span>&nbsp;<span class="ident" id="4021668">data</span><span class="op" id="4021672">[</span><span class="op" id="4021673">:</span><span class="ident" id="4021674">masterSecretLen</span><span class="op" id="4021689">]</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021692">data</span>&nbsp;<span class="op" id="4021697">=</span>&nbsp;<span class="ident" id="4021699">data</span><span class="op" id="4021703">[</span><span class="ident" id="4021704">masterSecretLen</span><span class="op" id="4021719">:</span><span class="op" id="4021720">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021724">if</span>&nbsp;<span class="builtinfunc" id="4021727">len</span><span class="op" id="4021730">(</span><span class="ident" id="4021731">data</span><span class="op" id="4021735">)</span>&nbsp;<span class="op" id="4021737">&lt;</span>&nbsp;<span class="num" id="4021739">2</span>&nbsp;<span class="op" id="4021741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021745">return</span>&nbsp;<span class="ident" id="4021752">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021759">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021763">numCerts</span>&nbsp;<span class="op" id="4021772">:=</span>&nbsp;<span class="builtintype" id="4021775">int</span><span class="op" id="4021778">(</span><span class="ident" id="4021779">data</span><span class="op" id="4021783">[</span><span class="num" id="4021784">0</span><span class="op" id="4021785">]</span><span class="op" id="4021786">)</span><span class="op" id="4021787">&lt;&lt;</span><span class="num" id="4021789">8</span>&nbsp;<span class="op" id="4021791">|</span>&nbsp;<span class="builtintype" id="4021793">int</span><span class="op" id="4021796">(</span><span class="ident" id="4021797">data</span><span class="op" id="4021801">[</span><span class="num" id="4021802">1</span><span class="op" id="4021803">]</span><span class="op" id="4021804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021807">data</span>&nbsp;<span class="op" id="4021812">=</span>&nbsp;<span class="ident" id="4021814">data</span><span class="op" id="4021818">[</span><span class="num" id="4021819">2</span><span class="op" id="4021820">:</span><span class="op" id="4021821">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021825">s</span><span class="op" id="4021826">.</span><span class="ident" id="4021827">certificates</span>&nbsp;<span class="op" id="4021840">=</span>&nbsp;<span class="builtinfunc" id="4021842">make</span><span class="op" id="4021846">(</span><span class="op" id="4021847">[</span><span class="op" id="4021848">]</span><span class="op" id="4021849">[</span><span class="op" id="4021850">]</span><span class="builtintype" id="4021851">byte</span><span class="op" id="4021855">,</span>&nbsp;<span class="ident" id="4021857">numCerts</span><span class="op" id="4021865">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021868">for</span>&nbsp;<span class="ident" id="4021872">i</span>&nbsp;<span class="op" id="4021874">:=</span>&nbsp;<span class="keyword" id="4021877">range</span>&nbsp;<span class="ident" id="4021883">s</span><span class="op" id="4021884">.</span><span class="ident" id="4021885">certificates</span>&nbsp;<span class="op" id="4021898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021902">if</span>&nbsp;<span class="builtinfunc" id="4021905">len</span><span class="op" id="4021908">(</span><span class="ident" id="4021909">data</span><span class="op" id="4021913">)</span>&nbsp;<span class="op" id="4021915">&lt;</span>&nbsp;<span class="num" id="4021917">4</span>&nbsp;<span class="op" id="4021919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021924">return</span>&nbsp;<span class="ident" id="4021931">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021943">certLen</span>&nbsp;<span class="op" id="4021951">:=</span>&nbsp;<span class="builtintype" id="4021954">int</span><span class="op" id="4021957">(</span><span class="ident" id="4021958">data</span><span class="op" id="4021962">[</span><span class="num" id="4021963">0</span><span class="op" id="4021964">]</span><span class="op" id="4021965">)</span><span class="op" id="4021966">&lt;&lt;</span><span class="num" id="4021968">24</span>&nbsp;<span class="op" id="4021971">|</span>&nbsp;<span class="builtintype" id="4021973">int</span><span class="op" id="4021976">(</span><span class="ident" id="4021977">data</span><span class="op" id="4021981">[</span><span class="num" id="4021982">1</span><span class="op" id="4021983">]</span><span class="op" id="4021984">)</span><span class="op" id="4021985">&lt;&lt;</span><span class="num" id="4021987">16</span>&nbsp;<span class="op" id="4021990">|</span>&nbsp;<span class="builtintype" id="4021992">int</span><span class="op" id="4021995">(</span><span class="ident" id="4021996">data</span><span class="op" id="4022000">[</span><span class="num" id="4022001">2</span><span class="op" id="4022002">]</span><span class="op" id="4022003">)</span><span class="op" id="4022004">&lt;&lt;</span><span class="num" id="4022006">8</span>&nbsp;<span class="op" id="4022008">|</span>&nbsp;<span class="builtintype" id="4022010">int</span><span class="op" id="4022013">(</span><span class="ident" id="4022014">data</span><span class="op" id="4022018">[</span><span class="num" id="4022019">3</span><span class="op" id="4022020">]</span><span class="op" id="4022021">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022025">data</span>&nbsp;<span class="op" id="4022030">=</span>&nbsp;<span class="ident" id="4022032">data</span><span class="op" id="4022036">[</span><span class="num" id="4022037">4</span><span class="op" id="4022038">:</span><span class="op" id="4022039">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022043">if</span>&nbsp;<span class="ident" id="4022046">certLen</span>&nbsp;<span class="op" id="4022054">&lt;</span>&nbsp;<span class="num" id="4022056">0</span>&nbsp;<span class="op" id="4022058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022063">return</span>&nbsp;<span class="ident" id="4022070">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022082">if</span>&nbsp;<span class="builtinfunc" id="4022085">len</span><span class="op" id="4022088">(</span><span class="ident" id="4022089">data</span><span class="op" id="4022093">)</span>&nbsp;<span class="op" id="4022095">&lt;</span>&nbsp;<span class="ident" id="4022097">certLen</span>&nbsp;<span class="op" id="4022105">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022110">return</span>&nbsp;<span class="ident" id="4022117">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022129">s</span><span class="op" id="4022130">.</span><span class="ident" id="4022131">certificates</span><span class="op" id="4022143">[</span><span class="ident" id="4022144">i</span><span class="op" id="4022145">]</span>&nbsp;<span class="op" id="4022147">=</span>&nbsp;<span class="ident" id="4022149">data</span><span class="op" id="4022153">[</span><span class="op" id="4022154">:</span><span class="ident" id="4022155">certLen</span><span class="op" id="4022162">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022166">data</span>&nbsp;<span class="op" id="4022171">=</span>&nbsp;<span class="ident" id="4022173">data</span><span class="op" id="4022177">[</span><span class="ident" id="4022178">certLen</span><span class="op" id="4022185">:</span><span class="op" id="4022186">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022189">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022193">if</span>&nbsp;<span class="builtinfunc" id="4022196">len</span><span class="op" id="4022199">(</span><span class="ident" id="4022200">data</span><span class="op" id="4022204">)</span>&nbsp;<span class="op" id="4022206">&gt;</span>&nbsp;<span class="num" id="4022208">0</span>&nbsp;<span class="op" id="4022210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022214">return</span>&nbsp;<span class="ident" id="4022221">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022232">return</span>&nbsp;<span class="ident" id="4022239">true</span><br>
<span class="lineno"></span><span class="op" id="4022244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4022247">func</span>&nbsp;<span class="op" id="4022252">(</span><span class="ident" id="4022253">c</span>&nbsp;<span class="op" id="4022255">*</span><span class="ident" id="4022256">Conn</span><span class="op" id="4022260">)</span>&nbsp;<span class="ident" id="4022262">encryptTicket</span><span class="op" id="4022275">(</span><span class="ident" id="4022276">state</span>&nbsp;<span class="op" id="4022282">*</span><span class="ident" id="4022283">sessionState</span><span class="op" id="4022295">)</span>&nbsp;<span class="op" id="4022297">(</span><span class="op" id="4022298">[</span><span class="op" id="4022299">]</span><span class="builtintype" id="4022300">byte</span><span class="op" id="4022304">,</span>&nbsp;<span class="builtintype" id="4022306">error</span><span class="op" id="4022311">)</span>&nbsp;<span class="op" id="4022313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022316">serialized</span>&nbsp;<span class="op" id="4022327">:=</span>&nbsp;<span class="ident" id="4022330">state</span><span class="op" id="4022335">.</span><span class="ident" id="4022336">marshal</span><span class="op" id="4022343">(</span><span class="op" id="4022344">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022347">encrypted</span>&nbsp;<span class="op" id="4022357">:=</span>&nbsp;<span class="builtinfunc" id="4022360">make</span><span class="op" id="4022364">(</span><span class="op" id="4022365">[</span><span class="op" id="4022366">]</span><span class="builtintype" id="4022367">byte</span><span class="op" id="4022371">,</span>&nbsp;<span class="ident" id="4022373">aes</span><span class="op" id="4022376">.</span><span class="ident" id="4022377">BlockSize</span><span class="op" id="4022386">+</span><span class="builtinfunc" id="4022387">len</span><span class="op" id="4022390">(</span><span class="ident" id="4022391">serialized</span><span class="op" id="4022401">)</span><span class="op" id="4022402">+</span><span class="ident" id="4022403">sha256</span><span class="op" id="4022409">.</span><span class="ident" id="4022410">Size</span><span class="op" id="4022414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022417">iv</span>&nbsp;<span class="op" id="4022420">:=</span>&nbsp;<span class="ident" id="4022423">encrypted</span><span class="op" id="4022432">[</span><span class="op" id="4022433">:</span><span class="ident" id="4022434">aes</span><span class="op" id="4022437">.</span><span class="ident" id="4022438">BlockSize</span><span class="op" id="4022447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022450">macBytes</span>&nbsp;<span class="op" id="4022459">:=</span>&nbsp;<span class="ident" id="4022462">encrypted</span><span class="op" id="4022471">[</span><span class="builtinfunc" id="4022472">len</span><span class="op" id="4022475">(</span><span class="ident" id="4022476">encrypted</span><span class="op" id="4022485">)</span><span class="op" id="4022486">-</span><span class="ident" id="4022487">sha256</span><span class="op" id="4022493">.</span><span class="ident" id="4022494">Size</span><span class="op" id="4022498">:</span><span class="op" id="4022499">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022503">if</span>&nbsp;<span class="ident" id="4022506">_</span><span class="op" id="4022507">,</span>&nbsp;<span class="ident" id="4022509">err</span>&nbsp;<span class="op" id="4022513">:=</span>&nbsp;<span class="ident" id="4022516">io</span><span class="op" id="4022518">.</span><span class="ident" id="4022519">ReadFull</span><span class="op" id="4022527">(</span><span class="ident" id="4022528">c</span><span class="op" id="4022529">.</span><span class="ident" id="4022530">config</span><span class="op" id="4022536">.</span><span class="ident" id="4022537">rand</span><span class="op" id="4022541">(</span><span class="op" id="4022542">)</span><span class="op" id="4022543">,</span>&nbsp;<span class="ident" id="4022545">iv</span><span class="op" id="4022547">)</span><span class="op" id="4022548">;</span>&nbsp;<span class="ident" id="4022550">err</span>&nbsp;<span class="op" id="4022554">!=</span>&nbsp;<span class="ident" id="4022557">nil</span>&nbsp;<span class="op" id="4022561">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022565">return</span>&nbsp;<span class="ident" id="4022572">nil</span><span class="op" id="4022575">,</span>&nbsp;<span class="ident" id="4022577">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022585">block</span><span class="op" id="4022590">,</span>&nbsp;<span class="ident" id="4022592">err</span>&nbsp;<span class="op" id="4022596">:=</span>&nbsp;<span class="ident" id="4022599">aes</span><span class="op" id="4022602">.</span><span class="ident" id="4022603">NewCipher</span><span class="op" id="4022612">(</span><span class="ident" id="4022613">c</span><span class="op" id="4022614">.</span><span class="ident" id="4022615">config</span><span class="op" id="4022621">.</span><span class="ident" id="4022622">SessionTicketKey</span><span class="op" id="4022638">[</span><span class="op" id="4022639">:</span><span class="num" id="4022640">16</span><span class="op" id="4022642">]</span><span class="op" id="4022643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022646">if</span>&nbsp;<span class="ident" id="4022649">err</span>&nbsp;<span class="op" id="4022653">!=</span>&nbsp;<span class="ident" id="4022656">nil</span>&nbsp;<span class="op" id="4022660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022664">return</span>&nbsp;<span class="ident" id="4022671">nil</span><span class="op" id="4022674">,</span>&nbsp;<span class="ident" id="4022676">errors</span><span class="op" id="4022682">.</span><span class="ident" id="4022683">New</span><span class="op" id="4022686">(</span><span class="string" id="4022687">&#34;tls:&nbsp;failed&nbsp;to&nbsp;create&nbsp;cipher&nbsp;while&nbsp;encrypting&nbsp;ticket:&nbsp;&#34;</span>&nbsp;<span class="op" id="4022744">+</span>&nbsp;<span class="ident" id="4022746">err</span><span class="op" id="4022749">.</span><span class="ident" id="4022750">Error</span><span class="op" id="4022755">(</span><span class="op" id="4022756">)</span><span class="op" id="4022757">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022763">cipher</span><span class="op" id="4022769">.</span><span class="ident" id="4022770">NewCTR</span><span class="op" id="4022776">(</span><span class="ident" id="4022777">block</span><span class="op" id="4022782">,</span>&nbsp;<span class="ident" id="4022784">iv</span><span class="op" id="4022786">)</span><span class="op" id="4022787">.</span><span class="ident" id="4022788">XORKeyStream</span><span class="op" id="4022800">(</span><span class="ident" id="4022801">encrypted</span><span class="op" id="4022810">[</span><span class="ident" id="4022811">aes</span><span class="op" id="4022814">.</span><span class="ident" id="4022815">BlockSize</span><span class="op" id="4022824">:</span><span class="op" id="4022825">]</span><span class="op" id="4022826">,</span>&nbsp;<span class="ident" id="4022828">serialized</span><span class="op" id="4022838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022842">mac</span>&nbsp;<span class="op" id="4022846">:=</span>&nbsp;<span class="ident" id="4022849">hmac</span><span class="op" id="4022853">.</span><span class="ident" id="4022854">New</span><span class="op" id="4022857">(</span><span class="ident" id="4022858">sha256</span><span class="op" id="4022864">.</span><span class="ident" id="4022865">New</span><span class="op" id="4022868">,</span>&nbsp;<span class="ident" id="4022870">c</span><span class="op" id="4022871">.</span><span class="ident" id="4022872">config</span><span class="op" id="4022878">.</span><span class="ident" id="4022879">SessionTicketKey</span><span class="op" id="4022895">[</span><span class="num" id="4022896">16</span><span class="op" id="4022898">:</span><span class="num" id="4022899">32</span><span class="op" id="4022901">]</span><span class="op" id="4022902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022905">mac</span><span class="op" id="4022908">.</span><span class="ident" id="4022909">Write</span><span class="op" id="4022914">(</span><span class="ident" id="4022915">encrypted</span><span class="op" id="4022924">[</span><span class="op" id="4022925">:</span><span class="builtinfunc" id="4022926">len</span><span class="op" id="4022929">(</span><span class="ident" id="4022930">encrypted</span><span class="op" id="4022939">)</span><span class="op" id="4022940">-</span><span class="ident" id="4022941">sha256</span><span class="op" id="4022947">.</span><span class="ident" id="4022948">Size</span><span class="op" id="4022952">]</span><span class="op" id="4022953">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022956">mac</span><span class="op" id="4022959">.</span><span class="ident" id="4022960">Sum</span><span class="op" id="4022963">(</span><span class="ident" id="4022964">macBytes</span><span class="op" id="4022972">[</span><span class="op" id="4022973">:</span><span class="num" id="4022974">0</span><span class="op" id="4022975">]</span><span class="op" id="4022976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022980">return</span>&nbsp;<span class="ident" id="4022987">encrypted</span><span class="op" id="4022996">,</span>&nbsp;<span class="ident" id="4022998">nil</span><br>
<span class="lineno"></span><span class="op" id="4023002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="4023005">func</span>&nbsp;<span class="op" id="4023010">(</span><span class="ident" id="4023011">c</span>&nbsp;<span class="op" id="4023013">*</span><span class="ident" id="4023014">Conn</span><span class="op" id="4023018">)</span>&nbsp;<span class="ident" id="4023020">decryptTicket</span><span class="op" id="4023033">(</span><span class="ident" id="4023034">encrypted</span>&nbsp;<span class="op" id="4023044">[</span><span class="op" id="4023045">]</span><span class="builtintype" id="4023046">byte</span><span class="op" id="4023050">)</span>&nbsp;<span class="op" id="4023052">(</span><span class="op" id="4023053">*</span><span class="ident" id="4023054">sessionState</span><span class="op" id="4023066">,</span>&nbsp;<span class="builtintype" id="4023068">bool</span><span class="op" id="4023072">)</span>&nbsp;<span class="op" id="4023074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023077">if</span>&nbsp;<span class="ident" id="4023080">c</span><span class="op" id="4023081">.</span><span class="ident" id="4023082">config</span><span class="op" id="4023088">.</span><span class="ident" id="4023089">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4023112">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4023117">len</span><span class="op" id="4023120">(</span><span class="ident" id="4023121">encrypted</span><span class="op" id="4023130">)</span>&nbsp;<span class="op" id="4023132">&lt;</span>&nbsp;<span class="ident" id="4023134">aes</span><span class="op" id="4023137">.</span><span class="ident" id="4023138">BlockSize</span><span class="op" id="4023147">+</span><span class="ident" id="4023148">sha256</span><span class="op" id="4023154">.</span><span class="ident" id="4023155">Size</span>&nbsp;<span class="op" id="4023160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023164">return</span>&nbsp;<span class="ident" id="4023171">nil</span><span class="op" id="4023174">,</span>&nbsp;<span class="ident" id="4023176">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023183">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023187">iv</span>&nbsp;<span class="op" id="4023190">:=</span>&nbsp;<span class="ident" id="4023193">encrypted</span><span class="op" id="4023202">[</span><span class="op" id="4023203">:</span><span class="ident" id="4023204">aes</span><span class="op" id="4023207">.</span><span class="ident" id="4023208">BlockSize</span><span class="op" id="4023217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023220">macBytes</span>&nbsp;<span class="op" id="4023229">:=</span>&nbsp;<span class="ident" id="4023232">encrypted</span><span class="op" id="4023241">[</span><span class="builtinfunc" id="4023242">len</span><span class="op" id="4023245">(</span><span class="ident" id="4023246">encrypted</span><span class="op" id="4023255">)</span><span class="op" id="4023256">-</span><span class="ident" id="4023257">sha256</span><span class="op" id="4023263">.</span><span class="ident" id="4023264">Size</span><span class="op" id="4023268">:</span><span class="op" id="4023269">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023273">mac</span>&nbsp;<span class="op" id="4023277">:=</span>&nbsp;<span class="ident" id="4023280">hmac</span><span class="op" id="4023284">.</span><span class="ident" id="4023285">New</span><span class="op" id="4023288">(</span><span class="ident" id="4023289">sha256</span><span class="op" id="4023295">.</span><span class="ident" id="4023296">New</span><span class="op" id="4023299">,</span>&nbsp;<span class="ident" id="4023301">c</span><span class="op" id="4023302">.</span><span class="ident" id="4023303">config</span><span class="op" id="4023309">.</span><span class="ident" id="4023310">SessionTicketKey</span><span class="op" id="4023326">[</span><span class="num" id="4023327">16</span><span class="op" id="4023329">:</span><span class="num" id="4023330">32</span><span class="op" id="4023332">]</span><span class="op" id="4023333">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023336">mac</span><span class="op" id="4023339">.</span><span class="ident" id="4023340">Write</span><span class="op" id="4023345">(</span><span class="ident" id="4023346">encrypted</span><span class="op" id="4023355">[</span><span class="op" id="4023356">:</span><span class="builtinfunc" id="4023357">len</span><span class="op" id="4023360">(</span><span class="ident" id="4023361">encrypted</span><span class="op" id="4023370">)</span><span class="op" id="4023371">-</span><span class="ident" id="4023372">sha256</span><span class="op" id="4023378">.</span><span class="ident" id="4023379">Size</span><span class="op" id="4023383">]</span><span class="op" id="4023384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023387">expected</span>&nbsp;<span class="op" id="4023396">:=</span>&nbsp;<span class="ident" id="4023399">mac</span><span class="op" id="4023402">.</span><span class="ident" id="4023403">Sum</span><span class="op" id="4023406">(</span><span class="ident" id="4023407">nil</span><span class="op" id="4023410">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023414">if</span>&nbsp;<span class="ident" id="4023417">subtle</span><span class="op" id="4023423">.</span><span class="ident" id="4023424">ConstantTimeCompare</span><span class="op" id="4023443">(</span><span class="ident" id="4023444">macBytes</span><span class="op" id="4023452">,</span>&nbsp;<span class="ident" id="4023454">expected</span><span class="op" id="4023462">)</span>&nbsp;<span class="op" id="4023464">!=</span>&nbsp;<span class="num" id="4023467">1</span>&nbsp;<span class="op" id="4023469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023473">return</span>&nbsp;<span class="ident" id="4023480">nil</span><span class="op" id="4023483">,</span>&nbsp;<span class="ident" id="4023485">false</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023496">block</span><span class="op" id="4023501">,</span>&nbsp;<span class="ident" id="4023503">err</span>&nbsp;<span class="op" id="4023507">:=</span>&nbsp;<span class="ident" id="4023510">aes</span><span class="op" id="4023513">.</span><span class="ident" id="4023514">NewCipher</span><span class="op" id="4023523">(</span><span class="ident" id="4023524">c</span><span class="op" id="4023525">.</span><span class="ident" id="4023526">config</span><span class="op" id="4023532">.</span><span class="ident" id="4023533">SessionTicketKey</span><span class="op" id="4023549">[</span><span class="op" id="4023550">:</span><span class="num" id="4023551">16</span><span class="op" id="4023553">]</span><span class="op" id="4023554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023557">if</span>&nbsp;<span class="ident" id="4023560">err</span>&nbsp;<span class="op" id="4023564">!=</span>&nbsp;<span class="ident" id="4023567">nil</span>&nbsp;<span class="op" id="4023571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023575">return</span>&nbsp;<span class="ident" id="4023582">nil</span><span class="op" id="4023585">,</span>&nbsp;<span class="ident" id="4023587">false</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023597">ciphertext</span>&nbsp;<span class="op" id="4023608">:=</span>&nbsp;<span class="ident" id="4023611">encrypted</span><span class="op" id="4023620">[</span><span class="ident" id="4023621">aes</span><span class="op" id="4023624">.</span><span class="ident" id="4023625">BlockSize</span>&nbsp;<span class="op" id="4023635">:</span>&nbsp;<span class="builtinfunc" id="4023637">len</span><span class="op" id="4023640">(</span><span class="ident" id="4023641">encrypted</span><span class="op" id="4023650">)</span><span class="op" id="4023651">-</span><span class="ident" id="4023652">sha256</span><span class="op" id="4023658">.</span><span class="ident" id="4023659">Size</span><span class="op" id="4023663">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023666">plaintext</span>&nbsp;<span class="op" id="4023676">:=</span>&nbsp;<span class="ident" id="4023679">ciphertext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023691">cipher</span><span class="op" id="4023697">.</span><span class="ident" id="4023698">NewCTR</span><span class="op" id="4023704">(</span><span class="ident" id="4023705">block</span><span class="op" id="4023710">,</span>&nbsp;<span class="ident" id="4023712">iv</span><span class="op" id="4023714">)</span><span class="op" id="4023715">.</span><span class="ident" id="4023716">XORKeyStream</span><span class="op" id="4023728">(</span><span class="ident" id="4023729">plaintext</span><span class="op" id="4023738">,</span>&nbsp;<span class="ident" id="4023740">ciphertext</span><span class="op" id="4023750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023754">state</span>&nbsp;<span class="op" id="4023760">:=</span>&nbsp;<span class="builtinfunc" id="4023763">new</span><span class="op" id="4023766">(</span><span class="ident" id="4023767">sessionState</span><span class="op" id="4023779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023782">ok</span>&nbsp;<span class="op" id="4023785">:=</span>&nbsp;<span class="ident" id="4023788">state</span><span class="op" id="4023793">.</span><span class="ident" id="4023794">unmarshal</span><span class="op" id="4023803">(</span><span class="ident" id="4023804">plaintext</span><span class="op" id="4023813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023816">return</span>&nbsp;<span class="ident" id="4023823">state</span><span class="op" id="4023828">,</span>&nbsp;<span class="ident" id="4023830">ok</span><br>
<span class="lineno"></span><span class="op" id="4023833">}</span>
</div>
</body>
</html>
