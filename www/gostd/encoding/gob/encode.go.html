<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4915956">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4916011">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4916065">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4916116">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4916171">package</span>&nbsp;<span class="ident" id="4916179">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4916184">import</span>&nbsp;<span class="op" id="4916191">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4916194">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4916206">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4916214">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="4916224">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4916227">const</span>&nbsp;<span class="ident" id="4916233">uint64Size</span>&nbsp;<span class="op" id="4916244">=</span>&nbsp;<span class="num" id="4916246">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4916249">type</span>&nbsp;<span class="ident" id="4916254">encHelper</span>&nbsp;<span class="keyword" id="4916264">func</span><span class="op" id="4916268">(</span><span class="ident" id="4916269">state</span>&nbsp;<span class="op" id="4916275">*</span><span class="ident" id="4916276">encoderState</span><span class="op" id="4916288">,</span>&nbsp;<span class="ident" id="4916290">v</span>&nbsp;<span class="ident" id="4916292">reflect</span><span class="op" id="4916299">.</span><span class="ident" id="4916300">Value</span><span class="op" id="4916305">)</span>&nbsp;<span class="builtintype" id="4916307">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4916313">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="4916390">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="4916456">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4916526">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="4916557">type</span>&nbsp;<span class="ident" id="4916562">encoderState</span>&nbsp;<span class="keyword" id="4916575">struct</span>&nbsp;<span class="op" id="4916582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916585">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916594">*</span><span class="ident" id="4916595">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916604">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916613">*</span><span class="ident" id="4916614">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916625">sendZero</span>&nbsp;<span class="builtintype" id="4916634">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916655">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916725">fieldnum</span>&nbsp;<span class="builtintype" id="4916734">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916755">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916790">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916799">[</span><span class="num" id="4916800">1</span>&nbsp;<span class="op" id="4916802">+</span>&nbsp;<span class="ident" id="4916804">uint64Size</span><span class="op" id="4916814">]</span><span class="builtintype" id="4916815">byte</span>&nbsp;<span class="comment" id="4916820">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916878">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4916887">*</span><span class="ident" id="4916888">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4916908">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="4916925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4916928">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="4917014">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4917109">type</span>&nbsp;<span class="ident" id="4917114">encBuffer</span>&nbsp;<span class="keyword" id="4917124">struct</span>&nbsp;<span class="op" id="4917131">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917134">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4917142">[</span><span class="op" id="4917143">]</span><span class="builtintype" id="4917144">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917150">scratch</span>&nbsp;<span class="op" id="4917158">[</span><span class="num" id="4917159">64</span><span class="op" id="4917161">]</span><span class="builtintype" id="4917162">byte</span><br>
<span class="lineno"></span><span class="op" id="4917167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4917170">func</span>&nbsp;<span class="op" id="4917175">(</span><span class="ident" id="4917176">e</span>&nbsp;<span class="op" id="4917178">*</span><span class="ident" id="4917179">encBuffer</span><span class="op" id="4917188">)</span>&nbsp;<span class="ident" id="4917190">WriteByte</span><span class="op" id="4917199">(</span><span class="ident" id="4917200">c</span>&nbsp;<span class="builtintype" id="4917202">byte</span><span class="op" id="4917206">)</span>&nbsp;<span class="op" id="4917208">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917211">e</span><span class="op" id="4917212">.</span><span class="ident" id="4917213">data</span>&nbsp;<span class="op" id="4917218">=</span>&nbsp;<span class="builtinfunc" id="4917220">append</span><span class="op" id="4917226">(</span><span class="ident" id="4917227">e</span><span class="op" id="4917228">.</span><span class="ident" id="4917229">data</span><span class="op" id="4917233">,</span>&nbsp;<span class="ident" id="4917235">c</span><span class="op" id="4917236">)</span><br>
<span class="lineno"></span><span class="op" id="4917238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4917241">func</span>&nbsp;<span class="op" id="4917246">(</span><span class="ident" id="4917247">e</span>&nbsp;<span class="op" id="4917249">*</span><span class="ident" id="4917250">encBuffer</span><span class="op" id="4917259">)</span>&nbsp;<span class="ident" id="4917261">Write</span><span class="op" id="4917266">(</span><span class="ident" id="4917267">p</span>&nbsp;<span class="op" id="4917269">[</span><span class="op" id="4917270">]</span><span class="builtintype" id="4917271">byte</span><span class="op" id="4917275">)</span>&nbsp;<span class="op" id="4917277">(</span><span class="builtintype" id="4917278">int</span><span class="op" id="4917281">,</span>&nbsp;<span class="builtintype" id="4917283">error</span><span class="op" id="4917288">)</span>&nbsp;<span class="op" id="4917290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917293">e</span><span class="op" id="4917294">.</span><span class="ident" id="4917295">data</span>&nbsp;<span class="op" id="4917300">=</span>&nbsp;<span class="builtinfunc" id="4917302">append</span><span class="op" id="4917308">(</span><span class="ident" id="4917309">e</span><span class="op" id="4917310">.</span><span class="ident" id="4917311">data</span><span class="op" id="4917315">,</span>&nbsp;<span class="ident" id="4917317">p</span><span class="op" id="4917318">...</span><span class="op" id="4917321">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917324">return</span>&nbsp;<span class="builtinfunc" id="4917331">len</span><span class="op" id="4917334">(</span><span class="ident" id="4917335">p</span><span class="op" id="4917336">)</span><span class="op" id="4917337">,</span>&nbsp;<span class="ident" id="4917339">nil</span><br>
<span class="lineno"></span><span class="op" id="4917343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4917346">func</span>&nbsp;<span class="op" id="4917351">(</span><span class="ident" id="4917352">e</span>&nbsp;<span class="op" id="4917354">*</span><span class="ident" id="4917355">encBuffer</span><span class="op" id="4917364">)</span>&nbsp;<span class="ident" id="4917366">WriteString</span><span class="op" id="4917377">(</span><span class="ident" id="4917378">s</span>&nbsp;<span class="builtintype" id="4917380">string</span><span class="op" id="4917386">)</span>&nbsp;<span class="op" id="4917388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917391">e</span><span class="op" id="4917392">.</span><span class="ident" id="4917393">data</span>&nbsp;<span class="op" id="4917398">=</span>&nbsp;<span class="builtinfunc" id="4917400">append</span><span class="op" id="4917406">(</span><span class="ident" id="4917407">e</span><span class="op" id="4917408">.</span><span class="ident" id="4917409">data</span><span class="op" id="4917413">,</span>&nbsp;<span class="ident" id="4917415">s</span><span class="op" id="4917416">...</span><span class="op" id="4917419">)</span><br>
<span class="lineno">50</span><span class="op" id="4917421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4917424">func</span>&nbsp;<span class="op" id="4917429">(</span><span class="ident" id="4917430">e</span>&nbsp;<span class="op" id="4917432">*</span><span class="ident" id="4917433">encBuffer</span><span class="op" id="4917442">)</span>&nbsp;<span class="ident" id="4917444">Len</span><span class="op" id="4917447">(</span><span class="op" id="4917448">)</span>&nbsp;<span class="builtintype" id="4917450">int</span>&nbsp;<span class="op" id="4917454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917457">return</span>&nbsp;<span class="builtinfunc" id="4917464">len</span><span class="op" id="4917467">(</span><span class="ident" id="4917468">e</span><span class="op" id="4917469">.</span><span class="ident" id="4917470">data</span><span class="op" id="4917474">)</span><br>
<span class="lineno"></span><span class="op" id="4917476">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="4917479">func</span>&nbsp;<span class="op" id="4917484">(</span><span class="ident" id="4917485">e</span>&nbsp;<span class="op" id="4917487">*</span><span class="ident" id="4917488">encBuffer</span><span class="op" id="4917497">)</span>&nbsp;<span class="ident" id="4917499">Bytes</span><span class="op" id="4917504">(</span><span class="op" id="4917505">)</span>&nbsp;<span class="op" id="4917507">[</span><span class="op" id="4917508">]</span><span class="builtintype" id="4917509">byte</span>&nbsp;<span class="op" id="4917514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917517">return</span>&nbsp;<span class="ident" id="4917524">e</span><span class="op" id="4917525">.</span><span class="ident" id="4917526">data</span><br>
<span class="lineno"></span><span class="op" id="4917531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4917534">func</span>&nbsp;<span class="op" id="4917539">(</span><span class="ident" id="4917540">e</span>&nbsp;<span class="op" id="4917542">*</span><span class="ident" id="4917543">encBuffer</span><span class="op" id="4917552">)</span>&nbsp;<span class="ident" id="4917554">Reset</span><span class="op" id="4917559">(</span><span class="op" id="4917560">)</span>&nbsp;<span class="op" id="4917562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917565">e</span><span class="op" id="4917566">.</span><span class="ident" id="4917567">data</span>&nbsp;<span class="op" id="4917572">=</span>&nbsp;<span class="ident" id="4917574">e</span><span class="op" id="4917575">.</span><span class="ident" id="4917576">data</span><span class="op" id="4917580">[</span><span class="num" id="4917581">0</span><span class="op" id="4917582">:</span><span class="num" id="4917583">0</span><span class="op" id="4917584">]</span><br>
<span class="lineno"></span><span class="op" id="4917586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4917589">func</span>&nbsp;<span class="op" id="4917594">(</span><span class="ident" id="4917595">enc</span>&nbsp;<span class="op" id="4917599">*</span><span class="ident" id="4917600">Encoder</span><span class="op" id="4917607">)</span>&nbsp;<span class="ident" id="4917609">newEncoderState</span><span class="op" id="4917624">(</span><span class="ident" id="4917625">b</span>&nbsp;<span class="op" id="4917627">*</span><span class="ident" id="4917628">encBuffer</span><span class="op" id="4917637">)</span>&nbsp;<span class="op" id="4917639">*</span><span class="ident" id="4917640">encoderState</span>&nbsp;<span class="op" id="4917653">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917656">e</span>&nbsp;<span class="op" id="4917658">:=</span>&nbsp;<span class="ident" id="4917661">enc</span><span class="op" id="4917664">.</span><span class="ident" id="4917665">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917675">if</span>&nbsp;<span class="ident" id="4917678">e</span>&nbsp;<span class="op" id="4917680">==</span>&nbsp;<span class="ident" id="4917683">nil</span>&nbsp;<span class="op" id="4917687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917691">e</span>&nbsp;<span class="op" id="4917693">=</span>&nbsp;<span class="builtinfunc" id="4917695">new</span><span class="op" id="4917698">(</span><span class="ident" id="4917699">encoderState</span><span class="op" id="4917711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917715">e</span><span class="op" id="4917716">.</span><span class="ident" id="4917717">enc</span>&nbsp;<span class="op" id="4917721">=</span>&nbsp;<span class="ident" id="4917723">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917728">}</span>&nbsp;<span class="keyword" id="4917730">else</span>&nbsp;<span class="op" id="4917735">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917739">enc</span><span class="op" id="4917742">.</span><span class="ident" id="4917743">freeList</span>&nbsp;<span class="op" id="4917752">=</span>&nbsp;<span class="ident" id="4917754">e</span><span class="op" id="4917755">.</span><span class="ident" id="4917756">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917765">e</span><span class="op" id="4917766">.</span><span class="ident" id="4917767">sendZero</span>&nbsp;<span class="op" id="4917776">=</span>&nbsp;<span class="builtintype" id="4917778">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917785">e</span><span class="op" id="4917786">.</span><span class="ident" id="4917787">fieldnum</span>&nbsp;<span class="op" id="4917796">=</span>&nbsp;<span class="num" id="4917798">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917801">e</span><span class="op" id="4917802">.</span><span class="ident" id="4917803">b</span>&nbsp;<span class="op" id="4917805">=</span>&nbsp;<span class="ident" id="4917807">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917810">if</span>&nbsp;<span class="builtinfunc" id="4917813">len</span><span class="op" id="4917816">(</span><span class="ident" id="4917817">b</span><span class="op" id="4917818">.</span><span class="ident" id="4917819">data</span><span class="op" id="4917823">)</span>&nbsp;<span class="op" id="4917825">==</span>&nbsp;<span class="num" id="4917828">0</span>&nbsp;<span class="op" id="4917830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917834">b</span><span class="op" id="4917835">.</span><span class="ident" id="4917836">data</span>&nbsp;<span class="op" id="4917841">=</span>&nbsp;<span class="ident" id="4917843">b</span><span class="op" id="4917844">.</span><span class="ident" id="4917845">scratch</span><span class="op" id="4917852">[</span><span class="num" id="4917853">0</span><span class="op" id="4917854">:</span><span class="num" id="4917855">0</span><span class="op" id="4917856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4917859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4917862">return</span>&nbsp;<span class="ident" id="4917869">e</span><br>
<span class="lineno"></span><span class="op" id="4917871">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="4917874">func</span>&nbsp;<span class="op" id="4917879">(</span><span class="ident" id="4917880">enc</span>&nbsp;<span class="op" id="4917884">*</span><span class="ident" id="4917885">Encoder</span><span class="op" id="4917892">)</span>&nbsp;<span class="ident" id="4917894">freeEncoderState</span><span class="op" id="4917910">(</span><span class="ident" id="4917911">e</span>&nbsp;<span class="op" id="4917913">*</span><span class="ident" id="4917914">encoderState</span><span class="op" id="4917926">)</span>&nbsp;<span class="op" id="4917928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917931">e</span><span class="op" id="4917932">.</span><span class="ident" id="4917933">next</span>&nbsp;<span class="op" id="4917938">=</span>&nbsp;<span class="ident" id="4917940">enc</span><span class="op" id="4917943">.</span><span class="ident" id="4917944">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4917954">enc</span><span class="op" id="4917957">.</span><span class="ident" id="4917958">freeList</span>&nbsp;<span class="op" id="4917967">=</span>&nbsp;<span class="ident" id="4917969">e</span><br>
<span class="lineno"></span><span class="op" id="4917971">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4917974">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="4918045">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="4918106">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="4918174">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4918207">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="4918268">func</span>&nbsp;<span class="op" id="4918273">(</span><span class="ident" id="4918274">state</span>&nbsp;<span class="op" id="4918280">*</span><span class="ident" id="4918281">encoderState</span><span class="op" id="4918293">)</span>&nbsp;<span class="ident" id="4918295">encodeUint</span><span class="op" id="4918305">(</span><span class="ident" id="4918306">x</span>&nbsp;<span class="ident" id="4918308">uint64</span><span class="op" id="4918314">)</span>&nbsp;<span class="op" id="4918316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918319">if</span>&nbsp;<span class="ident" id="4918322">x</span>&nbsp;<span class="op" id="4918324">&lt;=</span>&nbsp;<span class="num" id="4918327">0x7F</span>&nbsp;<span class="op" id="4918332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918336">state</span><span class="op" id="4918341">.</span><span class="ident" id="4918342">b</span><span class="op" id="4918343">.</span><span class="ident" id="4918344">WriteByte</span><span class="op" id="4918353">(</span><span class="builtintype" id="4918354">uint8</span><span class="op" id="4918359">(</span><span class="ident" id="4918360">x</span><span class="op" id="4918361">)</span><span class="op" id="4918362">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918366">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918377">i</span>&nbsp;<span class="op" id="4918379">:=</span>&nbsp;<span class="ident" id="4918382">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918394">for</span>&nbsp;<span class="ident" id="4918398">x</span>&nbsp;<span class="op" id="4918400">&gt;</span>&nbsp;<span class="num" id="4918402">0</span>&nbsp;<span class="op" id="4918404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918408">state</span><span class="op" id="4918413">.</span><span class="ident" id="4918414">buf</span><span class="op" id="4918417">[</span><span class="ident" id="4918418">i</span><span class="op" id="4918419">]</span>&nbsp;<span class="op" id="4918421">=</span>&nbsp;<span class="builtintype" id="4918423">uint8</span><span class="op" id="4918428">(</span><span class="ident" id="4918429">x</span><span class="op" id="4918430">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918434">x</span>&nbsp;<span class="op" id="4918436">&gt;&gt;=</span>&nbsp;<span class="num" id="4918440">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918444">i</span><span class="op" id="4918445">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918452">state</span><span class="op" id="4918457">.</span><span class="ident" id="4918458">buf</span><span class="op" id="4918461">[</span><span class="ident" id="4918462">i</span><span class="op" id="4918463">]</span>&nbsp;<span class="op" id="4918465">=</span>&nbsp;<span class="builtintype" id="4918467">uint8</span><span class="op" id="4918472">(</span><span class="ident" id="4918473">i</span>&nbsp;<span class="op" id="4918475">-</span>&nbsp;<span class="ident" id="4918477">uint64Size</span><span class="op" id="4918487">)</span>&nbsp;<span class="comment" id="4918489">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918515">state</span><span class="op" id="4918520">.</span><span class="ident" id="4918521">b</span><span class="op" id="4918522">.</span><span class="ident" id="4918523">Write</span><span class="op" id="4918528">(</span><span class="ident" id="4918529">state</span><span class="op" id="4918534">.</span><span class="ident" id="4918535">buf</span><span class="op" id="4918538">[</span><span class="ident" id="4918539">i</span>&nbsp;<span class="op" id="4918541">:</span>&nbsp;<span class="ident" id="4918543">uint64Size</span><span class="op" id="4918553">+</span><span class="num" id="4918554">1</span><span class="op" id="4918555">]</span><span class="op" id="4918556">)</span><br>
<span class="lineno">105</span><span class="op" id="4918558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4918561">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="4918619">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="4918705">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="4918733">func</span>&nbsp;<span class="op" id="4918738">(</span><span class="ident" id="4918739">state</span>&nbsp;<span class="op" id="4918745">*</span><span class="ident" id="4918746">encoderState</span><span class="op" id="4918758">)</span>&nbsp;<span class="ident" id="4918760">encodeInt</span><span class="op" id="4918769">(</span><span class="ident" id="4918770">i</span>&nbsp;<span class="ident" id="4918772">int64</span><span class="op" id="4918777">)</span>&nbsp;<span class="op" id="4918779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918782">var</span>&nbsp;<span class="ident" id="4918786">x</span>&nbsp;<span class="ident" id="4918788">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4918796">if</span>&nbsp;<span class="ident" id="4918799">i</span>&nbsp;<span class="op" id="4918801">&lt;</span>&nbsp;<span class="num" id="4918803">0</span>&nbsp;<span class="op" id="4918805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918809">x</span>&nbsp;<span class="op" id="4918811">=</span>&nbsp;<span class="ident" id="4918813">uint64</span><span class="op" id="4918819">(</span><span class="op" id="4918820">^</span><span class="ident" id="4918821">i</span><span class="op" id="4918822">&lt;&lt;</span><span class="num" id="4918824">1</span><span class="op" id="4918825">)</span>&nbsp;<span class="op" id="4918827">|</span>&nbsp;<span class="num" id="4918829">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918832">}</span>&nbsp;<span class="keyword" id="4918834">else</span>&nbsp;<span class="op" id="4918839">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918843">x</span>&nbsp;<span class="op" id="4918845">=</span>&nbsp;<span class="ident" id="4918847">uint64</span><span class="op" id="4918853">(</span><span class="ident" id="4918854">i</span>&nbsp;<span class="op" id="4918856">&lt;&lt;</span>&nbsp;<span class="num" id="4918859">1</span><span class="op" id="4918860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4918863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4918866">state</span><span class="op" id="4918871">.</span><span class="ident" id="4918872">encodeUint</span><span class="op" id="4918882">(</span><span class="ident" id="4918883">uint64</span><span class="op" id="4918889">(</span><span class="ident" id="4918890">x</span><span class="op" id="4918891">)</span><span class="op" id="4918892">)</span><br>
<span class="lineno"></span><span class="op" id="4918894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4918897">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4918965">type</span>&nbsp;<span class="ident" id="4918970">encOp</span>&nbsp;<span class="keyword" id="4918976">func</span><span class="op" id="4918980">(</span><span class="ident" id="4918981">i</span>&nbsp;<span class="op" id="4918983">*</span><span class="ident" id="4918984">encInstr</span><span class="op" id="4918992">,</span>&nbsp;<span class="ident" id="4918994">state</span>&nbsp;<span class="op" id="4919000">*</span><span class="ident" id="4919001">encoderState</span><span class="op" id="4919013">,</span>&nbsp;<span class="ident" id="4919015">v</span>&nbsp;<span class="ident" id="4919017">reflect</span><span class="op" id="4919024">.</span><span class="ident" id="4919025">Value</span><span class="op" id="4919030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4919033">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="4919079">type</span>&nbsp;<span class="ident" id="4919084">encInstr</span>&nbsp;<span class="keyword" id="4919093">struct</span>&nbsp;<span class="op" id="4919100">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919103">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4919109">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919116">field</span>&nbsp;<span class="builtintype" id="4919122">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4919128">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919154">index</span>&nbsp;<span class="op" id="4919160">[</span><span class="op" id="4919161">]</span><span class="builtintype" id="4919162">int</span>&nbsp;<span class="comment" id="4919166">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919183">indir</span>&nbsp;<span class="builtintype" id="4919189">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4919195">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="4919261">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4919264">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="4919357">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="4919411">func</span>&nbsp;<span class="op" id="4919416">(</span><span class="ident" id="4919417">state</span>&nbsp;<span class="op" id="4919423">*</span><span class="ident" id="4919424">encoderState</span><span class="op" id="4919436">)</span>&nbsp;<span class="ident" id="4919438">update</span><span class="op" id="4919444">(</span><span class="ident" id="4919445">instr</span>&nbsp;<span class="op" id="4919451">*</span><span class="ident" id="4919452">encInstr</span><span class="op" id="4919460">)</span>&nbsp;<span class="op" id="4919462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4919465">if</span>&nbsp;<span class="ident" id="4919468">instr</span>&nbsp;<span class="op" id="4919474">!=</span>&nbsp;<span class="ident" id="4919477">nil</span>&nbsp;<span class="op" id="4919481">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919485">state</span><span class="op" id="4919490">.</span><span class="ident" id="4919491">encodeUint</span><span class="op" id="4919501">(</span><span class="ident" id="4919502">uint64</span><span class="op" id="4919508">(</span><span class="ident" id="4919509">instr</span><span class="op" id="4919514">.</span><span class="ident" id="4919515">field</span>&nbsp;<span class="op" id="4919521">-</span>&nbsp;<span class="ident" id="4919523">state</span><span class="op" id="4919528">.</span><span class="ident" id="4919529">fieldnum</span><span class="op" id="4919537">)</span><span class="op" id="4919538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4919542">state</span><span class="op" id="4919547">.</span><span class="ident" id="4919548">fieldnum</span>&nbsp;<span class="op" id="4919557">=</span>&nbsp;<span class="ident" id="4919559">instr</span><span class="op" id="4919564">.</span><span class="ident" id="4919565">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4919572">}</span><br>
<span class="lineno"></span><span class="op" id="4919574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4919577">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4919641">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4919709">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4919776">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="4919843">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="4919907">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4919974">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="4920040">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4920052">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="4920119">func</span>&nbsp;<span class="ident" id="4920124">encIndirect</span><span class="op" id="4920135">(</span><span class="ident" id="4920136">pv</span>&nbsp;<span class="ident" id="4920139">reflect</span><span class="op" id="4920146">.</span><span class="ident" id="4920147">Value</span><span class="op" id="4920152">,</span>&nbsp;<span class="ident" id="4920154">indir</span>&nbsp;<span class="builtintype" id="4920160">int</span><span class="op" id="4920163">)</span>&nbsp;<span class="ident" id="4920165">reflect</span><span class="op" id="4920172">.</span><span class="ident" id="4920173">Value</span>&nbsp;<span class="op" id="4920179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920182">for</span>&nbsp;<span class="op" id="4920186">;</span>&nbsp;<span class="ident" id="4920188">indir</span>&nbsp;<span class="op" id="4920194">&gt;</span>&nbsp;<span class="num" id="4920196">0</span><span class="op" id="4920197">;</span>&nbsp;<span class="ident" id="4920199">indir</span><span class="op" id="4920204">--</span>&nbsp;<span class="op" id="4920207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920211">if</span>&nbsp;<span class="ident" id="4920214">pv</span><span class="op" id="4920216">.</span><span class="ident" id="4920217">IsNil</span><span class="op" id="4920222">(</span><span class="op" id="4920223">)</span>&nbsp;<span class="op" id="4920225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920230">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920238">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920242">pv</span>&nbsp;<span class="op" id="4920245">=</span>&nbsp;<span class="ident" id="4920247">pv</span><span class="op" id="4920249">.</span><span class="ident" id="4920250">Elem</span><span class="op" id="4920254">(</span><span class="op" id="4920255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920261">return</span>&nbsp;<span class="ident" id="4920268">pv</span><br>
<span class="lineno"></span><span class="op" id="4920271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="4920274">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="4920341">func</span>&nbsp;<span class="ident" id="4920346">encBool</span><span class="op" id="4920353">(</span><span class="ident" id="4920354">i</span>&nbsp;<span class="op" id="4920356">*</span><span class="ident" id="4920357">encInstr</span><span class="op" id="4920365">,</span>&nbsp;<span class="ident" id="4920367">state</span>&nbsp;<span class="op" id="4920373">*</span><span class="ident" id="4920374">encoderState</span><span class="op" id="4920386">,</span>&nbsp;<span class="ident" id="4920388">v</span>&nbsp;<span class="ident" id="4920390">reflect</span><span class="op" id="4920397">.</span><span class="ident" id="4920398">Value</span><span class="op" id="4920403">)</span>&nbsp;<span class="op" id="4920405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920408">b</span>&nbsp;<span class="op" id="4920410">:=</span>&nbsp;<span class="ident" id="4920413">v</span><span class="op" id="4920414">.</span><span class="ident" id="4920415">Bool</span><span class="op" id="4920419">(</span><span class="op" id="4920420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920423">if</span>&nbsp;<span class="ident" id="4920426">b</span>&nbsp;<span class="op" id="4920428">||</span>&nbsp;<span class="ident" id="4920431">state</span><span class="op" id="4920436">.</span><span class="ident" id="4920437">sendZero</span>&nbsp;<span class="op" id="4920446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920450">state</span><span class="op" id="4920455">.</span><span class="ident" id="4920456">update</span><span class="op" id="4920462">(</span><span class="ident" id="4920463">i</span><span class="op" id="4920464">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920468">if</span>&nbsp;<span class="ident" id="4920471">b</span>&nbsp;<span class="op" id="4920473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920478">state</span><span class="op" id="4920483">.</span><span class="ident" id="4920484">encodeUint</span><span class="op" id="4920494">(</span><span class="num" id="4920495">1</span><span class="op" id="4920496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920500">}</span>&nbsp;<span class="keyword" id="4920502">else</span>&nbsp;<span class="op" id="4920507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920512">state</span><span class="op" id="4920517">.</span><span class="ident" id="4920518">encodeUint</span><span class="op" id="4920528">(</span><span class="num" id="4920529">0</span><span class="op" id="4920530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920534">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920537">}</span><br>
<span class="lineno"></span><span class="op" id="4920539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4920542">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4920625">func</span>&nbsp;<span class="ident" id="4920630">encInt</span><span class="op" id="4920636">(</span><span class="ident" id="4920637">i</span>&nbsp;<span class="op" id="4920639">*</span><span class="ident" id="4920640">encInstr</span><span class="op" id="4920648">,</span>&nbsp;<span class="ident" id="4920650">state</span>&nbsp;<span class="op" id="4920656">*</span><span class="ident" id="4920657">encoderState</span><span class="op" id="4920669">,</span>&nbsp;<span class="ident" id="4920671">v</span>&nbsp;<span class="ident" id="4920673">reflect</span><span class="op" id="4920680">.</span><span class="ident" id="4920681">Value</span><span class="op" id="4920686">)</span>&nbsp;<span class="op" id="4920688">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920691">value</span>&nbsp;<span class="op" id="4920697">:=</span>&nbsp;<span class="ident" id="4920700">v</span><span class="op" id="4920701">.</span><span class="ident" id="4920702">Int</span><span class="op" id="4920705">(</span><span class="op" id="4920706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920709">if</span>&nbsp;<span class="ident" id="4920712">value</span>&nbsp;<span class="op" id="4920718">!=</span>&nbsp;<span class="num" id="4920721">0</span>&nbsp;<span class="op" id="4920723">||</span>&nbsp;<span class="ident" id="4920726">state</span><span class="op" id="4920731">.</span><span class="ident" id="4920732">sendZero</span>&nbsp;<span class="op" id="4920741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920745">state</span><span class="op" id="4920750">.</span><span class="ident" id="4920751">update</span><span class="op" id="4920757">(</span><span class="ident" id="4920758">i</span><span class="op" id="4920759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920763">state</span><span class="op" id="4920768">.</span><span class="ident" id="4920769">encodeInt</span><span class="op" id="4920778">(</span><span class="ident" id="4920779">value</span><span class="op" id="4920784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4920787">}</span><br>
<span class="lineno">180</span><span class="op" id="4920789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4920792">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4920891">func</span>&nbsp;<span class="ident" id="4920896">encUint</span><span class="op" id="4920903">(</span><span class="ident" id="4920904">i</span>&nbsp;<span class="op" id="4920906">*</span><span class="ident" id="4920907">encInstr</span><span class="op" id="4920915">,</span>&nbsp;<span class="ident" id="4920917">state</span>&nbsp;<span class="op" id="4920923">*</span><span class="ident" id="4920924">encoderState</span><span class="op" id="4920936">,</span>&nbsp;<span class="ident" id="4920938">v</span>&nbsp;<span class="ident" id="4920940">reflect</span><span class="op" id="4920947">.</span><span class="ident" id="4920948">Value</span><span class="op" id="4920953">)</span>&nbsp;<span class="op" id="4920955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4920958">value</span>&nbsp;<span class="op" id="4920964">:=</span>&nbsp;<span class="ident" id="4920967">v</span><span class="op" id="4920968">.</span><span class="ident" id="4920969">Uint</span><span class="op" id="4920973">(</span><span class="op" id="4920974">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4920977">if</span>&nbsp;<span class="ident" id="4920980">value</span>&nbsp;<span class="op" id="4920986">!=</span>&nbsp;<span class="num" id="4920989">0</span>&nbsp;<span class="op" id="4920991">||</span>&nbsp;<span class="ident" id="4920994">state</span><span class="op" id="4920999">.</span><span class="ident" id="4921000">sendZero</span>&nbsp;<span class="op" id="4921009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921013">state</span><span class="op" id="4921018">.</span><span class="ident" id="4921019">update</span><span class="op" id="4921025">(</span><span class="ident" id="4921026">i</span><span class="op" id="4921027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921031">state</span><span class="op" id="4921036">.</span><span class="ident" id="4921037">encodeUint</span><span class="op" id="4921047">(</span><span class="ident" id="4921048">value</span><span class="op" id="4921053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921056">}</span><br>
<span class="lineno"></span><span class="op" id="4921058">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4921061">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="4921136">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4921206">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4921278">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="4921350">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4921415">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="4921429">func</span>&nbsp;<span class="ident" id="4921434">floatBits</span><span class="op" id="4921443">(</span><span class="ident" id="4921444">f</span>&nbsp;<span class="builtintype" id="4921446">float64</span><span class="op" id="4921453">)</span>&nbsp;<span class="ident" id="4921455">uint64</span>&nbsp;<span class="op" id="4921462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921465">u</span>&nbsp;<span class="op" id="4921467">:=</span>&nbsp;<span class="ident" id="4921470">math</span><span class="op" id="4921474">.</span><span class="ident" id="4921475">Float64bits</span><span class="op" id="4921486">(</span><span class="ident" id="4921487">f</span><span class="op" id="4921488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921491">var</span>&nbsp;<span class="ident" id="4921495">v</span>&nbsp;<span class="ident" id="4921497">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921505">for</span>&nbsp;<span class="ident" id="4921509">i</span>&nbsp;<span class="op" id="4921511">:=</span>&nbsp;<span class="num" id="4921514">0</span><span class="op" id="4921515">;</span>&nbsp;<span class="ident" id="4921517">i</span>&nbsp;<span class="op" id="4921519">&lt;</span>&nbsp;<span class="num" id="4921521">8</span><span class="op" id="4921522">;</span>&nbsp;<span class="ident" id="4921524">i</span><span class="op" id="4921525">++</span>&nbsp;<span class="op" id="4921528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921532">v</span>&nbsp;<span class="op" id="4921534">&lt;&lt;=</span>&nbsp;<span class="num" id="4921538">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921542">v</span>&nbsp;<span class="op" id="4921544">|=</span>&nbsp;<span class="ident" id="4921547">u</span>&nbsp;<span class="op" id="4921549">&amp;</span>&nbsp;<span class="num" id="4921551">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921558">u</span>&nbsp;<span class="op" id="4921560">&gt;&gt;=</span>&nbsp;<span class="num" id="4921564">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921567">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921570">return</span>&nbsp;<span class="ident" id="4921577">v</span><br>
<span class="lineno"></span><span class="op" id="4921579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4921582">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4921662">func</span>&nbsp;<span class="ident" id="4921667">encFloat</span><span class="op" id="4921675">(</span><span class="ident" id="4921676">i</span>&nbsp;<span class="op" id="4921678">*</span><span class="ident" id="4921679">encInstr</span><span class="op" id="4921687">,</span>&nbsp;<span class="ident" id="4921689">state</span>&nbsp;<span class="op" id="4921695">*</span><span class="ident" id="4921696">encoderState</span><span class="op" id="4921708">,</span>&nbsp;<span class="ident" id="4921710">v</span>&nbsp;<span class="ident" id="4921712">reflect</span><span class="op" id="4921719">.</span><span class="ident" id="4921720">Value</span><span class="op" id="4921725">)</span>&nbsp;<span class="op" id="4921727">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921730">f</span>&nbsp;<span class="op" id="4921732">:=</span>&nbsp;<span class="ident" id="4921735">v</span><span class="op" id="4921736">.</span><span class="ident" id="4921737">Float</span><span class="op" id="4921742">(</span><span class="op" id="4921743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4921746">if</span>&nbsp;<span class="ident" id="4921749">f</span>&nbsp;<span class="op" id="4921751">!=</span>&nbsp;<span class="num" id="4921754">0</span>&nbsp;<span class="op" id="4921756">||</span>&nbsp;<span class="ident" id="4921759">state</span><span class="op" id="4921764">.</span><span class="ident" id="4921765">sendZero</span>&nbsp;<span class="op" id="4921774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921778">bits</span>&nbsp;<span class="op" id="4921783">:=</span>&nbsp;<span class="ident" id="4921786">floatBits</span><span class="op" id="4921795">(</span><span class="ident" id="4921796">f</span><span class="op" id="4921797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921801">state</span><span class="op" id="4921806">.</span><span class="ident" id="4921807">update</span><span class="op" id="4921813">(</span><span class="ident" id="4921814">i</span><span class="op" id="4921815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4921819">state</span><span class="op" id="4921824">.</span><span class="ident" id="4921825">encodeUint</span><span class="op" id="4921835">(</span><span class="ident" id="4921836">bits</span><span class="op" id="4921840">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4921843">}</span><br>
<span class="lineno"></span><span class="op" id="4921845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4921848">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4921928">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="4922007">func</span>&nbsp;<span class="ident" id="4922012">encComplex</span><span class="op" id="4922022">(</span><span class="ident" id="4922023">i</span>&nbsp;<span class="op" id="4922025">*</span><span class="ident" id="4922026">encInstr</span><span class="op" id="4922034">,</span>&nbsp;<span class="ident" id="4922036">state</span>&nbsp;<span class="op" id="4922042">*</span><span class="ident" id="4922043">encoderState</span><span class="op" id="4922055">,</span>&nbsp;<span class="ident" id="4922057">v</span>&nbsp;<span class="ident" id="4922059">reflect</span><span class="op" id="4922066">.</span><span class="ident" id="4922067">Value</span><span class="op" id="4922072">)</span>&nbsp;<span class="op" id="4922074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922077">c</span>&nbsp;<span class="op" id="4922079">:=</span>&nbsp;<span class="ident" id="4922082">v</span><span class="op" id="4922083">.</span><span class="ident" id="4922084">Complex</span><span class="op" id="4922091">(</span><span class="op" id="4922092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922095">if</span>&nbsp;<span class="ident" id="4922098">c</span>&nbsp;<span class="op" id="4922100">!=</span>&nbsp;<span class="num" id="4922103">0</span><span class="op" id="4922104">+</span><span class="num" id="4922105">0i</span>&nbsp;<span class="op" id="4922108">||</span>&nbsp;<span class="ident" id="4922111">state</span><span class="op" id="4922116">.</span><span class="ident" id="4922117">sendZero</span>&nbsp;<span class="op" id="4922126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922130">rpart</span>&nbsp;<span class="op" id="4922136">:=</span>&nbsp;<span class="ident" id="4922139">floatBits</span><span class="op" id="4922148">(</span><span class="builtinfunc" id="4922149">real</span><span class="op" id="4922153">(</span><span class="ident" id="4922154">c</span><span class="op" id="4922155">)</span><span class="op" id="4922156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922160">ipart</span>&nbsp;<span class="op" id="4922166">:=</span>&nbsp;<span class="ident" id="4922169">floatBits</span><span class="op" id="4922178">(</span><span class="builtinfunc" id="4922179">imag</span><span class="op" id="4922183">(</span><span class="ident" id="4922184">c</span><span class="op" id="4922185">)</span><span class="op" id="4922186">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922190">state</span><span class="op" id="4922195">.</span><span class="ident" id="4922196">update</span><span class="op" id="4922202">(</span><span class="ident" id="4922203">i</span><span class="op" id="4922204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922208">state</span><span class="op" id="4922213">.</span><span class="ident" id="4922214">encodeUint</span><span class="op" id="4922224">(</span><span class="ident" id="4922225">rpart</span><span class="op" id="4922230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922234">state</span><span class="op" id="4922239">.</span><span class="ident" id="4922240">encodeUint</span><span class="op" id="4922250">(</span><span class="ident" id="4922251">ipart</span><span class="op" id="4922256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922259">}</span><br>
<span class="lineno"></span><span class="op" id="4922261">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4922264">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4922321">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4922396">func</span>&nbsp;<span class="ident" id="4922401">encUint8Array</span><span class="op" id="4922414">(</span><span class="ident" id="4922415">i</span>&nbsp;<span class="op" id="4922417">*</span><span class="ident" id="4922418">encInstr</span><span class="op" id="4922426">,</span>&nbsp;<span class="ident" id="4922428">state</span>&nbsp;<span class="op" id="4922434">*</span><span class="ident" id="4922435">encoderState</span><span class="op" id="4922447">,</span>&nbsp;<span class="ident" id="4922449">v</span>&nbsp;<span class="ident" id="4922451">reflect</span><span class="op" id="4922458">.</span><span class="ident" id="4922459">Value</span><span class="op" id="4922464">)</span>&nbsp;<span class="op" id="4922466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922469">b</span>&nbsp;<span class="op" id="4922471">:=</span>&nbsp;<span class="ident" id="4922474">v</span><span class="op" id="4922475">.</span><span class="ident" id="4922476">Bytes</span><span class="op" id="4922481">(</span><span class="op" id="4922482">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922485">if</span>&nbsp;<span class="builtinfunc" id="4922488">len</span><span class="op" id="4922491">(</span><span class="ident" id="4922492">b</span><span class="op" id="4922493">)</span>&nbsp;<span class="op" id="4922495">&gt;</span>&nbsp;<span class="num" id="4922497">0</span>&nbsp;<span class="op" id="4922499">||</span>&nbsp;<span class="ident" id="4922502">state</span><span class="op" id="4922507">.</span><span class="ident" id="4922508">sendZero</span>&nbsp;<span class="op" id="4922517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922521">state</span><span class="op" id="4922526">.</span><span class="ident" id="4922527">update</span><span class="op" id="4922533">(</span><span class="ident" id="4922534">i</span><span class="op" id="4922535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922539">state</span><span class="op" id="4922544">.</span><span class="ident" id="4922545">encodeUint</span><span class="op" id="4922555">(</span><span class="ident" id="4922556">uint64</span><span class="op" id="4922562">(</span><span class="builtinfunc" id="4922563">len</span><span class="op" id="4922566">(</span><span class="ident" id="4922567">b</span><span class="op" id="4922568">)</span><span class="op" id="4922569">)</span><span class="op" id="4922570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922574">state</span><span class="op" id="4922579">.</span><span class="ident" id="4922580">b</span><span class="op" id="4922581">.</span><span class="ident" id="4922582">Write</span><span class="op" id="4922587">(</span><span class="ident" id="4922588">b</span><span class="op" id="4922589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922592">}</span><br>
<span class="lineno">240</span><span class="op" id="4922594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4922597">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4922646">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4922717">func</span>&nbsp;<span class="ident" id="4922722">encString</span><span class="op" id="4922731">(</span><span class="ident" id="4922732">i</span>&nbsp;<span class="op" id="4922734">*</span><span class="ident" id="4922735">encInstr</span><span class="op" id="4922743">,</span>&nbsp;<span class="ident" id="4922745">state</span>&nbsp;<span class="op" id="4922751">*</span><span class="ident" id="4922752">encoderState</span><span class="op" id="4922764">,</span>&nbsp;<span class="ident" id="4922766">v</span>&nbsp;<span class="ident" id="4922768">reflect</span><span class="op" id="4922775">.</span><span class="ident" id="4922776">Value</span><span class="op" id="4922781">)</span>&nbsp;<span class="op" id="4922783">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922786">s</span>&nbsp;<span class="op" id="4922788">:=</span>&nbsp;<span class="ident" id="4922791">v</span><span class="op" id="4922792">.</span><span class="ident" id="4922793">String</span><span class="op" id="4922799">(</span><span class="op" id="4922800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4922803">if</span>&nbsp;<span class="builtinfunc" id="4922806">len</span><span class="op" id="4922809">(</span><span class="ident" id="4922810">s</span><span class="op" id="4922811">)</span>&nbsp;<span class="op" id="4922813">&gt;</span>&nbsp;<span class="num" id="4922815">0</span>&nbsp;<span class="op" id="4922817">||</span>&nbsp;<span class="ident" id="4922820">state</span><span class="op" id="4922825">.</span><span class="ident" id="4922826">sendZero</span>&nbsp;<span class="op" id="4922835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922839">state</span><span class="op" id="4922844">.</span><span class="ident" id="4922845">update</span><span class="op" id="4922851">(</span><span class="ident" id="4922852">i</span><span class="op" id="4922853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922857">state</span><span class="op" id="4922862">.</span><span class="ident" id="4922863">encodeUint</span><span class="op" id="4922873">(</span><span class="ident" id="4922874">uint64</span><span class="op" id="4922880">(</span><span class="builtinfunc" id="4922881">len</span><span class="op" id="4922884">(</span><span class="ident" id="4922885">s</span><span class="op" id="4922886">)</span><span class="op" id="4922887">)</span><span class="op" id="4922888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4922892">state</span><span class="op" id="4922897">.</span><span class="ident" id="4922898">b</span><span class="op" id="4922899">.</span><span class="ident" id="4922900">WriteString</span><span class="op" id="4922911">(</span><span class="ident" id="4922912">s</span><span class="op" id="4922913">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4922916">}</span><br>
<span class="lineno"></span><span class="op" id="4922918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4922921">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="4922981">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="4923012">func</span>&nbsp;<span class="ident" id="4923017">encStructTerminator</span><span class="op" id="4923036">(</span><span class="ident" id="4923037">i</span>&nbsp;<span class="op" id="4923039">*</span><span class="ident" id="4923040">encInstr</span><span class="op" id="4923048">,</span>&nbsp;<span class="ident" id="4923050">state</span>&nbsp;<span class="op" id="4923056">*</span><span class="ident" id="4923057">encoderState</span><span class="op" id="4923069">,</span>&nbsp;<span class="ident" id="4923071">v</span>&nbsp;<span class="ident" id="4923073">reflect</span><span class="op" id="4923080">.</span><span class="ident" id="4923081">Value</span><span class="op" id="4923086">)</span>&nbsp;<span class="op" id="4923088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923091">state</span><span class="op" id="4923096">.</span><span class="ident" id="4923097">encodeUint</span><span class="op" id="4923107">(</span><span class="num" id="4923108">0</span><span class="op" id="4923109">)</span><br>
<span class="lineno"></span><span class="op" id="4923111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4923114">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4923135">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="4923213">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="4923293">type</span>&nbsp;<span class="ident" id="4923298">encEngine</span>&nbsp;<span class="keyword" id="4923308">struct</span>&nbsp;<span class="op" id="4923315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923318">instr</span>&nbsp;<span class="op" id="4923324">[</span><span class="op" id="4923325">]</span><span class="ident" id="4923326">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="4923335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4923338">const</span>&nbsp;<span class="ident" id="4923344">singletonField</span>&nbsp;<span class="op" id="4923359">=</span>&nbsp;<span class="num" id="4923361">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4923364">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="4923431">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="4923485">func</span>&nbsp;<span class="ident" id="4923490">valid</span><span class="op" id="4923495">(</span><span class="ident" id="4923496">v</span>&nbsp;<span class="ident" id="4923498">reflect</span><span class="op" id="4923505">.</span><span class="ident" id="4923506">Value</span><span class="op" id="4923511">)</span>&nbsp;<span class="builtintype" id="4923513">bool</span>&nbsp;<span class="op" id="4923518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923521">switch</span>&nbsp;<span class="ident" id="4923528">v</span><span class="op" id="4923529">.</span><span class="ident" id="4923530">Kind</span><span class="op" id="4923534">(</span><span class="op" id="4923535">)</span>&nbsp;<span class="op" id="4923537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923540">case</span>&nbsp;<span class="ident" id="4923545">reflect</span><span class="op" id="4923552">.</span><span class="ident" id="4923553">Invalid</span><span class="op" id="4923560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923564">return</span>&nbsp;<span class="builtintype" id="4923571">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923578">case</span>&nbsp;<span class="ident" id="4923583">reflect</span><span class="op" id="4923590">.</span><span class="ident" id="4923591">Ptr</span><span class="op" id="4923594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923598">return</span>&nbsp;<span class="op" id="4923605">!</span><span class="ident" id="4923606">v</span><span class="op" id="4923607">.</span><span class="ident" id="4923608">IsNil</span><span class="op" id="4923613">(</span><span class="op" id="4923614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4923617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923620">return</span>&nbsp;<span class="builtintype" id="4923627">true</span><br>
<span class="lineno"></span><span class="op" id="4923632">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4923635">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4923696">func</span>&nbsp;<span class="op" id="4923701">(</span><span class="ident" id="4923702">enc</span>&nbsp;<span class="op" id="4923706">*</span><span class="ident" id="4923707">Encoder</span><span class="op" id="4923714">)</span>&nbsp;<span class="ident" id="4923716">encodeSingle</span><span class="op" id="4923728">(</span><span class="ident" id="4923729">b</span>&nbsp;<span class="op" id="4923731">*</span><span class="ident" id="4923732">encBuffer</span><span class="op" id="4923741">,</span>&nbsp;<span class="ident" id="4923743">engine</span>&nbsp;<span class="op" id="4923750">*</span><span class="ident" id="4923751">encEngine</span><span class="op" id="4923760">,</span>&nbsp;<span class="ident" id="4923762">value</span>&nbsp;<span class="ident" id="4923768">reflect</span><span class="op" id="4923775">.</span><span class="ident" id="4923776">Value</span><span class="op" id="4923781">)</span>&nbsp;<span class="op" id="4923783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923786">state</span>&nbsp;<span class="op" id="4923792">:=</span>&nbsp;<span class="ident" id="4923795">enc</span><span class="op" id="4923798">.</span><span class="ident" id="4923799">newEncoderState</span><span class="op" id="4923814">(</span><span class="ident" id="4923815">b</span><span class="op" id="4923816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4923819">defer</span>&nbsp;<span class="ident" id="4923825">enc</span><span class="op" id="4923828">.</span><span class="ident" id="4923829">freeEncoderState</span><span class="op" id="4923845">(</span><span class="ident" id="4923846">state</span><span class="op" id="4923851">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4923854">state</span><span class="op" id="4923859">.</span><span class="ident" id="4923860">fieldnum</span>&nbsp;<span class="op" id="4923869">=</span>&nbsp;<span class="ident" id="4923871">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4923887">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4923960">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924031">state</span><span class="op" id="4924036">.</span><span class="ident" id="4924037">sendZero</span>&nbsp;<span class="op" id="4924046">=</span>&nbsp;<span class="builtintype" id="4924048">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924054">instr</span>&nbsp;<span class="op" id="4924060">:=</span>&nbsp;<span class="op" id="4924063">&amp;</span><span class="ident" id="4924064">engine</span><span class="op" id="4924070">.</span><span class="ident" id="4924071">instr</span><span class="op" id="4924076">[</span><span class="ident" id="4924077">singletonField</span><span class="op" id="4924091">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924094">if</span>&nbsp;<span class="ident" id="4924097">instr</span><span class="op" id="4924102">.</span><span class="ident" id="4924103">indir</span>&nbsp;<span class="op" id="4924109">&gt;</span>&nbsp;<span class="num" id="4924111">0</span>&nbsp;<span class="op" id="4924113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924117">value</span>&nbsp;<span class="op" id="4924123">=</span>&nbsp;<span class="ident" id="4924125">encIndirect</span><span class="op" id="4924136">(</span><span class="ident" id="4924137">value</span><span class="op" id="4924142">,</span>&nbsp;<span class="ident" id="4924144">instr</span><span class="op" id="4924149">.</span><span class="ident" id="4924150">indir</span><span class="op" id="4924155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924161">if</span>&nbsp;<span class="ident" id="4924164">valid</span><span class="op" id="4924169">(</span><span class="ident" id="4924170">value</span><span class="op" id="4924175">)</span>&nbsp;<span class="op" id="4924177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924181">instr</span><span class="op" id="4924186">.</span><span class="ident" id="4924187">op</span><span class="op" id="4924189">(</span><span class="ident" id="4924190">instr</span><span class="op" id="4924195">,</span>&nbsp;<span class="ident" id="4924197">state</span><span class="op" id="4924202">,</span>&nbsp;<span class="ident" id="4924204">value</span><span class="op" id="4924209">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924212">}</span><br>
<span class="lineno"></span><span class="op" id="4924214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4924217">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4924264">func</span>&nbsp;<span class="op" id="4924269">(</span><span class="ident" id="4924270">enc</span>&nbsp;<span class="op" id="4924274">*</span><span class="ident" id="4924275">Encoder</span><span class="op" id="4924282">)</span>&nbsp;<span class="ident" id="4924284">encodeStruct</span><span class="op" id="4924296">(</span><span class="ident" id="4924297">b</span>&nbsp;<span class="op" id="4924299">*</span><span class="ident" id="4924300">encBuffer</span><span class="op" id="4924309">,</span>&nbsp;<span class="ident" id="4924311">engine</span>&nbsp;<span class="op" id="4924318">*</span><span class="ident" id="4924319">encEngine</span><span class="op" id="4924328">,</span>&nbsp;<span class="ident" id="4924330">value</span>&nbsp;<span class="ident" id="4924336">reflect</span><span class="op" id="4924343">.</span><span class="ident" id="4924344">Value</span><span class="op" id="4924349">)</span>&nbsp;<span class="op" id="4924351">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924354">if</span>&nbsp;<span class="op" id="4924357">!</span><span class="ident" id="4924358">valid</span><span class="op" id="4924363">(</span><span class="ident" id="4924364">value</span><span class="op" id="4924369">)</span>&nbsp;<span class="op" id="4924371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924375">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924386">state</span>&nbsp;<span class="op" id="4924392">:=</span>&nbsp;<span class="ident" id="4924395">enc</span><span class="op" id="4924398">.</span><span class="ident" id="4924399">newEncoderState</span><span class="op" id="4924414">(</span><span class="ident" id="4924415">b</span><span class="op" id="4924416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924419">defer</span>&nbsp;<span class="ident" id="4924425">enc</span><span class="op" id="4924428">.</span><span class="ident" id="4924429">freeEncoderState</span><span class="op" id="4924445">(</span><span class="ident" id="4924446">state</span><span class="op" id="4924451">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924454">state</span><span class="op" id="4924459">.</span><span class="ident" id="4924460">fieldnum</span>&nbsp;<span class="op" id="4924469">=</span>&nbsp;<span class="op" id="4924471">-</span><span class="num" id="4924472">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924475">for</span>&nbsp;<span class="ident" id="4924479">i</span>&nbsp;<span class="op" id="4924481">:=</span>&nbsp;<span class="num" id="4924484">0</span><span class="op" id="4924485">;</span>&nbsp;<span class="ident" id="4924487">i</span>&nbsp;<span class="op" id="4924489">&lt;</span>&nbsp;<span class="builtinfunc" id="4924491">len</span><span class="op" id="4924494">(</span><span class="ident" id="4924495">engine</span><span class="op" id="4924501">.</span><span class="ident" id="4924502">instr</span><span class="op" id="4924507">)</span><span class="op" id="4924508">;</span>&nbsp;<span class="ident" id="4924510">i</span><span class="op" id="4924511">++</span>&nbsp;<span class="op" id="4924514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924518">instr</span>&nbsp;<span class="op" id="4924524">:=</span>&nbsp;<span class="op" id="4924527">&amp;</span><span class="ident" id="4924528">engine</span><span class="op" id="4924534">.</span><span class="ident" id="4924535">instr</span><span class="op" id="4924540">[</span><span class="ident" id="4924541">i</span><span class="op" id="4924542">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924546">if</span>&nbsp;<span class="ident" id="4924549">i</span>&nbsp;<span class="op" id="4924551">&gt;=</span>&nbsp;<span class="ident" id="4924554">value</span><span class="op" id="4924559">.</span><span class="ident" id="4924560">NumField</span><span class="op" id="4924568">(</span><span class="op" id="4924569">)</span>&nbsp;<span class="op" id="4924571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924576">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924602">instr</span><span class="op" id="4924607">.</span><span class="ident" id="4924608">op</span><span class="op" id="4924610">(</span><span class="ident" id="4924611">instr</span><span class="op" id="4924616">,</span>&nbsp;<span class="ident" id="4924618">state</span><span class="op" id="4924623">,</span>&nbsp;<span class="ident" id="4924625">reflect</span><span class="op" id="4924632">.</span><span class="ident" id="4924633">Value</span><span class="op" id="4924638">{</span><span class="op" id="4924639">}</span><span class="op" id="4924640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924645">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924657">field</span>&nbsp;<span class="op" id="4924663">:=</span>&nbsp;<span class="ident" id="4924666">value</span><span class="op" id="4924671">.</span><span class="ident" id="4924672">FieldByIndex</span><span class="op" id="4924684">(</span><span class="ident" id="4924685">instr</span><span class="op" id="4924690">.</span><span class="ident" id="4924691">index</span><span class="op" id="4924696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924700">if</span>&nbsp;<span class="ident" id="4924703">instr</span><span class="op" id="4924708">.</span><span class="ident" id="4924709">indir</span>&nbsp;<span class="op" id="4924715">&gt;</span>&nbsp;<span class="num" id="4924717">0</span>&nbsp;<span class="op" id="4924719">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924724">field</span>&nbsp;<span class="op" id="4924730">=</span>&nbsp;<span class="ident" id="4924732">encIndirect</span><span class="op" id="4924743">(</span><span class="ident" id="4924744">field</span><span class="op" id="4924749">,</span>&nbsp;<span class="ident" id="4924751">instr</span><span class="op" id="4924756">.</span><span class="ident" id="4924757">indir</span><span class="op" id="4924762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4924767">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924839">if</span>&nbsp;<span class="op" id="4924842">!</span><span class="ident" id="4924843">valid</span><span class="op" id="4924848">(</span><span class="ident" id="4924849">field</span><span class="op" id="4924854">)</span>&nbsp;<span class="op" id="4924856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4924862">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924874">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4924882">instr</span><span class="op" id="4924887">.</span><span class="ident" id="4924888">op</span><span class="op" id="4924890">(</span><span class="ident" id="4924891">instr</span><span class="op" id="4924896">,</span>&nbsp;<span class="ident" id="4924898">state</span><span class="op" id="4924903">,</span>&nbsp;<span class="ident" id="4924905">field</span><span class="op" id="4924910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4924913">}</span><br>
<span class="lineno"></span><span class="op" id="4924915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="4924918">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4924951">func</span>&nbsp;<span class="op" id="4924956">(</span><span class="ident" id="4924957">enc</span>&nbsp;<span class="op" id="4924961">*</span><span class="ident" id="4924962">Encoder</span><span class="op" id="4924969">)</span>&nbsp;<span class="ident" id="4924971">encodeArray</span><span class="op" id="4924982">(</span><span class="ident" id="4924983">b</span>&nbsp;<span class="op" id="4924985">*</span><span class="ident" id="4924986">encBuffer</span><span class="op" id="4924995">,</span>&nbsp;<span class="ident" id="4924997">value</span>&nbsp;<span class="ident" id="4925003">reflect</span><span class="op" id="4925010">.</span><span class="ident" id="4925011">Value</span><span class="op" id="4925016">,</span>&nbsp;<span class="ident" id="4925018">op</span>&nbsp;<span class="ident" id="4925021">encOp</span><span class="op" id="4925026">,</span>&nbsp;<span class="ident" id="4925028">elemIndir</span>&nbsp;<span class="builtintype" id="4925038">int</span><span class="op" id="4925041">,</span>&nbsp;<span class="ident" id="4925043">length</span>&nbsp;<span class="builtintype" id="4925050">int</span><span class="op" id="4925053">,</span>&nbsp;<span class="ident" id="4925055">helper</span>&nbsp;<span class="ident" id="4925062">encHelper</span><span class="op" id="4925071">)</span>&nbsp;<span class="op" id="4925073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925076">state</span>&nbsp;<span class="op" id="4925082">:=</span>&nbsp;<span class="ident" id="4925085">enc</span><span class="op" id="4925088">.</span><span class="ident" id="4925089">newEncoderState</span><span class="op" id="4925104">(</span><span class="ident" id="4925105">b</span><span class="op" id="4925106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925109">defer</span>&nbsp;<span class="ident" id="4925115">enc</span><span class="op" id="4925118">.</span><span class="ident" id="4925119">freeEncoderState</span><span class="op" id="4925135">(</span><span class="ident" id="4925136">state</span><span class="op" id="4925141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925144">state</span><span class="op" id="4925149">.</span><span class="ident" id="4925150">fieldnum</span>&nbsp;<span class="op" id="4925159">=</span>&nbsp;<span class="op" id="4925161">-</span><span class="num" id="4925162">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925165">state</span><span class="op" id="4925170">.</span><span class="ident" id="4925171">sendZero</span>&nbsp;<span class="op" id="4925180">=</span>&nbsp;<span class="builtintype" id="4925182">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925188">state</span><span class="op" id="4925193">.</span><span class="ident" id="4925194">encodeUint</span><span class="op" id="4925204">(</span><span class="ident" id="4925205">uint64</span><span class="op" id="4925211">(</span><span class="ident" id="4925212">length</span><span class="op" id="4925218">)</span><span class="op" id="4925219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925222">if</span>&nbsp;<span class="ident" id="4925225">helper</span>&nbsp;<span class="op" id="4925232">!=</span>&nbsp;<span class="ident" id="4925235">nil</span>&nbsp;<span class="op" id="4925239">&amp;&amp;</span>&nbsp;<span class="ident" id="4925242">helper</span><span class="op" id="4925248">(</span><span class="ident" id="4925249">state</span><span class="op" id="4925254">,</span>&nbsp;<span class="ident" id="4925256">value</span><span class="op" id="4925261">)</span>&nbsp;<span class="op" id="4925263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925267">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925275">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925278">for</span>&nbsp;<span class="ident" id="4925282">i</span>&nbsp;<span class="op" id="4925284">:=</span>&nbsp;<span class="num" id="4925287">0</span><span class="op" id="4925288">;</span>&nbsp;<span class="ident" id="4925290">i</span>&nbsp;<span class="op" id="4925292">&lt;</span>&nbsp;<span class="ident" id="4925294">length</span><span class="op" id="4925300">;</span>&nbsp;<span class="ident" id="4925302">i</span><span class="op" id="4925303">++</span>&nbsp;<span class="op" id="4925306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925310">elem</span>&nbsp;<span class="op" id="4925315">:=</span>&nbsp;<span class="ident" id="4925318">value</span><span class="op" id="4925323">.</span><span class="ident" id="4925324">Index</span><span class="op" id="4925329">(</span><span class="ident" id="4925330">i</span><span class="op" id="4925331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925335">if</span>&nbsp;<span class="ident" id="4925338">elemIndir</span>&nbsp;<span class="op" id="4925348">&gt;</span>&nbsp;<span class="num" id="4925350">0</span>&nbsp;<span class="op" id="4925352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925357">elem</span>&nbsp;<span class="op" id="4925362">=</span>&nbsp;<span class="ident" id="4925364">encIndirect</span><span class="op" id="4925375">(</span><span class="ident" id="4925376">elem</span><span class="op" id="4925380">,</span>&nbsp;<span class="ident" id="4925382">elemIndir</span><span class="op" id="4925391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4925396">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925467">if</span>&nbsp;<span class="op" id="4925470">!</span><span class="ident" id="4925471">valid</span><span class="op" id="4925476">(</span><span class="ident" id="4925477">elem</span><span class="op" id="4925481">)</span>&nbsp;<span class="op" id="4925483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925489">errorf</span><span class="op" id="4925495">(</span><span class="string" id="4925496">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4925522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925535">op</span><span class="op" id="4925537">(</span><span class="ident" id="4925538">nil</span><span class="op" id="4925541">,</span>&nbsp;<span class="ident" id="4925543">state</span><span class="op" id="4925548">,</span>&nbsp;<span class="ident" id="4925550">elem</span><span class="op" id="4925554">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925557">}</span><br>
<span class="lineno"></span><span class="op" id="4925559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4925562">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4925630">func</span>&nbsp;<span class="ident" id="4925635">encodeReflectValue</span><span class="op" id="4925653">(</span><span class="ident" id="4925654">state</span>&nbsp;<span class="op" id="4925660">*</span><span class="ident" id="4925661">encoderState</span><span class="op" id="4925673">,</span>&nbsp;<span class="ident" id="4925675">v</span>&nbsp;<span class="ident" id="4925677">reflect</span><span class="op" id="4925684">.</span><span class="ident" id="4925685">Value</span><span class="op" id="4925690">,</span>&nbsp;<span class="ident" id="4925692">op</span>&nbsp;<span class="ident" id="4925695">encOp</span><span class="op" id="4925700">,</span>&nbsp;<span class="ident" id="4925702">indir</span>&nbsp;<span class="builtintype" id="4925708">int</span><span class="op" id="4925711">)</span>&nbsp;<span class="op" id="4925713">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925716">for</span>&nbsp;<span class="ident" id="4925720">i</span>&nbsp;<span class="op" id="4925722">:=</span>&nbsp;<span class="num" id="4925725">0</span><span class="op" id="4925726">;</span>&nbsp;<span class="ident" id="4925728">i</span>&nbsp;<span class="op" id="4925730">&lt;</span>&nbsp;<span class="ident" id="4925732">indir</span>&nbsp;<span class="op" id="4925738">&amp;&amp;</span>&nbsp;<span class="ident" id="4925741">v</span><span class="op" id="4925742">.</span><span class="ident" id="4925743">IsValid</span><span class="op" id="4925750">(</span><span class="op" id="4925751">)</span><span class="op" id="4925752">;</span>&nbsp;<span class="ident" id="4925754">i</span><span class="op" id="4925755">++</span>&nbsp;<span class="op" id="4925758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925762">v</span>&nbsp;<span class="op" id="4925764">=</span>&nbsp;<span class="ident" id="4925766">reflect</span><span class="op" id="4925773">.</span><span class="ident" id="4925774">Indirect</span><span class="op" id="4925782">(</span><span class="ident" id="4925783">v</span><span class="op" id="4925784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4925790">if</span>&nbsp;<span class="op" id="4925793">!</span><span class="ident" id="4925794">v</span><span class="op" id="4925795">.</span><span class="ident" id="4925796">IsValid</span><span class="op" id="4925803">(</span><span class="op" id="4925804">)</span>&nbsp;<span class="op" id="4925806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925810">errorf</span><span class="op" id="4925816">(</span><span class="string" id="4925817">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4925850">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4925853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4925856">op</span><span class="op" id="4925858">(</span><span class="ident" id="4925859">nil</span><span class="op" id="4925862">,</span>&nbsp;<span class="ident" id="4925864">state</span><span class="op" id="4925869">,</span>&nbsp;<span class="ident" id="4925871">v</span><span class="op" id="4925872">)</span><br>
<span class="lineno"></span><span class="op" id="4925874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4925877">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="4925951">func</span>&nbsp;<span class="op" id="4925956">(</span><span class="ident" id="4925957">enc</span>&nbsp;<span class="op" id="4925961">*</span><span class="ident" id="4925962">Encoder</span><span class="op" id="4925969">)</span>&nbsp;<span class="ident" id="4925971">encodeMap</span><span class="op" id="4925980">(</span><span class="ident" id="4925981">b</span>&nbsp;<span class="op" id="4925983">*</span><span class="ident" id="4925984">encBuffer</span><span class="op" id="4925993">,</span>&nbsp;<span class="ident" id="4925995">mv</span>&nbsp;<span class="ident" id="4925998">reflect</span><span class="op" id="4926005">.</span><span class="ident" id="4926006">Value</span><span class="op" id="4926011">,</span>&nbsp;<span class="ident" id="4926013">keyOp</span><span class="op" id="4926018">,</span>&nbsp;<span class="ident" id="4926020">elemOp</span>&nbsp;<span class="ident" id="4926027">encOp</span><span class="op" id="4926032">,</span>&nbsp;<span class="ident" id="4926034">keyIndir</span><span class="op" id="4926042">,</span>&nbsp;<span class="ident" id="4926044">elemIndir</span>&nbsp;<span class="builtintype" id="4926054">int</span><span class="op" id="4926057">)</span>&nbsp;<span class="op" id="4926059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926062">state</span>&nbsp;<span class="op" id="4926068">:=</span>&nbsp;<span class="ident" id="4926071">enc</span><span class="op" id="4926074">.</span><span class="ident" id="4926075">newEncoderState</span><span class="op" id="4926090">(</span><span class="ident" id="4926091">b</span><span class="op" id="4926092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926095">state</span><span class="op" id="4926100">.</span><span class="ident" id="4926101">fieldnum</span>&nbsp;<span class="op" id="4926110">=</span>&nbsp;<span class="op" id="4926112">-</span><span class="num" id="4926113">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926116">state</span><span class="op" id="4926121">.</span><span class="ident" id="4926122">sendZero</span>&nbsp;<span class="op" id="4926131">=</span>&nbsp;<span class="builtintype" id="4926133">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926139">keys</span>&nbsp;<span class="op" id="4926144">:=</span>&nbsp;<span class="ident" id="4926147">mv</span><span class="op" id="4926149">.</span><span class="ident" id="4926150">MapKeys</span><span class="op" id="4926157">(</span><span class="op" id="4926158">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926161">state</span><span class="op" id="4926166">.</span><span class="ident" id="4926167">encodeUint</span><span class="op" id="4926177">(</span><span class="ident" id="4926178">uint64</span><span class="op" id="4926184">(</span><span class="builtinfunc" id="4926185">len</span><span class="op" id="4926188">(</span><span class="ident" id="4926189">keys</span><span class="op" id="4926193">)</span><span class="op" id="4926194">)</span><span class="op" id="4926195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926198">for</span>&nbsp;<span class="ident" id="4926202">_</span><span class="op" id="4926203">,</span>&nbsp;<span class="ident" id="4926205">key</span>&nbsp;<span class="op" id="4926209">:=</span>&nbsp;<span class="keyword" id="4926212">range</span>&nbsp;<span class="ident" id="4926218">keys</span>&nbsp;<span class="op" id="4926223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926227">encodeReflectValue</span><span class="op" id="4926245">(</span><span class="ident" id="4926246">state</span><span class="op" id="4926251">,</span>&nbsp;<span class="ident" id="4926253">key</span><span class="op" id="4926256">,</span>&nbsp;<span class="ident" id="4926258">keyOp</span><span class="op" id="4926263">,</span>&nbsp;<span class="ident" id="4926265">keyIndir</span><span class="op" id="4926273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926277">encodeReflectValue</span><span class="op" id="4926295">(</span><span class="ident" id="4926296">state</span><span class="op" id="4926301">,</span>&nbsp;<span class="ident" id="4926303">mv</span><span class="op" id="4926305">.</span><span class="ident" id="4926306">MapIndex</span><span class="op" id="4926314">(</span><span class="ident" id="4926315">key</span><span class="op" id="4926318">)</span><span class="op" id="4926319">,</span>&nbsp;<span class="ident" id="4926321">elemOp</span><span class="op" id="4926327">,</span>&nbsp;<span class="ident" id="4926329">elemIndir</span><span class="op" id="4926338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4926341">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926344">enc</span><span class="op" id="4926347">.</span><span class="ident" id="4926348">freeEncoderState</span><span class="op" id="4926364">(</span><span class="ident" id="4926365">state</span><span class="op" id="4926370">)</span><br>
<span class="lineno"></span><span class="op" id="4926372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4926375">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="4926426">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="4926508">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="4926595">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="4926678">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4926703">func</span>&nbsp;<span class="op" id="4926708">(</span><span class="ident" id="4926709">enc</span>&nbsp;<span class="op" id="4926713">*</span><span class="ident" id="4926714">Encoder</span><span class="op" id="4926721">)</span>&nbsp;<span class="ident" id="4926723">encodeInterface</span><span class="op" id="4926738">(</span><span class="ident" id="4926739">b</span>&nbsp;<span class="op" id="4926741">*</span><span class="ident" id="4926742">encBuffer</span><span class="op" id="4926751">,</span>&nbsp;<span class="ident" id="4926753">iv</span>&nbsp;<span class="ident" id="4926756">reflect</span><span class="op" id="4926763">.</span><span class="ident" id="4926764">Value</span><span class="op" id="4926769">)</span>&nbsp;<span class="op" id="4926771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4926774">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4926839">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926910">elem</span>&nbsp;<span class="op" id="4926915">:=</span>&nbsp;<span class="ident" id="4926918">iv</span><span class="op" id="4926920">.</span><span class="ident" id="4926921">Elem</span><span class="op" id="4926925">(</span><span class="op" id="4926926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4926929">if</span>&nbsp;<span class="ident" id="4926932">elem</span><span class="op" id="4926936">.</span><span class="ident" id="4926937">Kind</span><span class="op" id="4926941">(</span><span class="op" id="4926942">)</span>&nbsp;<span class="op" id="4926944">==</span>&nbsp;<span class="ident" id="4926947">reflect</span><span class="op" id="4926954">.</span><span class="ident" id="4926955">Ptr</span>&nbsp;<span class="op" id="4926959">&amp;&amp;</span>&nbsp;<span class="ident" id="4926962">elem</span><span class="op" id="4926966">.</span><span class="ident" id="4926967">IsNil</span><span class="op" id="4926972">(</span><span class="op" id="4926973">)</span>&nbsp;<span class="op" id="4926975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4926979">errorf</span><span class="op" id="4926985">(</span><span class="string" id="4926986">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="4927046">,</span>&nbsp;<span class="ident" id="4927048">iv</span><span class="op" id="4927050">.</span><span class="ident" id="4927051">Elem</span><span class="op" id="4927055">(</span><span class="op" id="4927056">)</span><span class="op" id="4927057">.</span><span class="ident" id="4927058">Type</span><span class="op" id="4927062">(</span><span class="op" id="4927063">)</span><span class="op" id="4927064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927067">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927070">state</span>&nbsp;<span class="op" id="4927076">:=</span>&nbsp;<span class="ident" id="4927079">enc</span><span class="op" id="4927082">.</span><span class="ident" id="4927083">newEncoderState</span><span class="op" id="4927098">(</span><span class="ident" id="4927099">b</span><span class="op" id="4927100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927103">state</span><span class="op" id="4927108">.</span><span class="ident" id="4927109">fieldnum</span>&nbsp;<span class="op" id="4927118">=</span>&nbsp;<span class="op" id="4927120">-</span><span class="num" id="4927121">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927124">state</span><span class="op" id="4927129">.</span><span class="ident" id="4927130">sendZero</span>&nbsp;<span class="op" id="4927139">=</span>&nbsp;<span class="builtintype" id="4927141">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927147">if</span>&nbsp;<span class="ident" id="4927150">iv</span><span class="op" id="4927152">.</span><span class="ident" id="4927153">IsNil</span><span class="op" id="4927158">(</span><span class="op" id="4927159">)</span>&nbsp;<span class="op" id="4927161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927165">state</span><span class="op" id="4927170">.</span><span class="ident" id="4927171">encodeUint</span><span class="op" id="4927181">(</span><span class="num" id="4927182">0</span><span class="op" id="4927183">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927187">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927199">ut</span>&nbsp;<span class="op" id="4927202">:=</span>&nbsp;<span class="ident" id="4927205">userType</span><span class="op" id="4927213">(</span><span class="ident" id="4927214">iv</span><span class="op" id="4927216">.</span><span class="ident" id="4927217">Elem</span><span class="op" id="4927221">(</span><span class="op" id="4927222">)</span><span class="op" id="4927223">.</span><span class="ident" id="4927224">Type</span><span class="op" id="4927228">(</span><span class="op" id="4927229">)</span><span class="op" id="4927230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927233">registerLock</span><span class="op" id="4927245">.</span><span class="ident" id="4927246">RLock</span><span class="op" id="4927251">(</span><span class="op" id="4927252">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927255">name</span><span class="op" id="4927259">,</span>&nbsp;<span class="ident" id="4927261">ok</span>&nbsp;<span class="op" id="4927264">:=</span>&nbsp;<span class="ident" id="4927267">concreteTypeToName</span><span class="op" id="4927285">[</span><span class="ident" id="4927286">ut</span><span class="op" id="4927288">.</span><span class="ident" id="4927289">base</span><span class="op" id="4927293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927296">registerLock</span><span class="op" id="4927308">.</span><span class="ident" id="4927309">RUnlock</span><span class="op" id="4927316">(</span><span class="op" id="4927317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927320">if</span>&nbsp;<span class="op" id="4927323">!</span><span class="ident" id="4927324">ok</span>&nbsp;<span class="op" id="4927327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927331">errorf</span><span class="op" id="4927337">(</span><span class="string" id="4927338">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="4927377">,</span>&nbsp;<span class="ident" id="4927379">ut</span><span class="op" id="4927381">.</span><span class="ident" id="4927382">base</span><span class="op" id="4927386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927389">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4927392">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927411">state</span><span class="op" id="4927416">.</span><span class="ident" id="4927417">encodeUint</span><span class="op" id="4927427">(</span><span class="ident" id="4927428">uint64</span><span class="op" id="4927434">(</span><span class="builtinfunc" id="4927435">len</span><span class="op" id="4927438">(</span><span class="ident" id="4927439">name</span><span class="op" id="4927443">)</span><span class="op" id="4927444">)</span><span class="op" id="4927445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927448">state</span><span class="op" id="4927453">.</span><span class="ident" id="4927454">b</span><span class="op" id="4927455">.</span><span class="ident" id="4927456">WriteString</span><span class="op" id="4927467">(</span><span class="ident" id="4927468">name</span><span class="op" id="4927472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4927475">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927512">enc</span><span class="op" id="4927515">.</span><span class="ident" id="4927516">sendTypeDescriptor</span><span class="op" id="4927534">(</span><span class="ident" id="4927535">enc</span><span class="op" id="4927538">.</span><span class="ident" id="4927539">writer</span><span class="op" id="4927545">(</span><span class="op" id="4927546">)</span><span class="op" id="4927547">,</span>&nbsp;<span class="ident" id="4927549">state</span><span class="op" id="4927554">,</span>&nbsp;<span class="ident" id="4927556">ut</span><span class="op" id="4927558">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4927561">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927583">enc</span><span class="op" id="4927586">.</span><span class="ident" id="4927587">sendTypeId</span><span class="op" id="4927597">(</span><span class="ident" id="4927598">state</span><span class="op" id="4927603">,</span>&nbsp;<span class="ident" id="4927605">ut</span><span class="op" id="4927607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4927610">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4927679">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927733">enc</span><span class="op" id="4927736">.</span><span class="ident" id="4927737">pushWriter</span><span class="op" id="4927747">(</span><span class="ident" id="4927748">b</span><span class="op" id="4927749">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927752">data</span>&nbsp;<span class="op" id="4927757">:=</span>&nbsp;<span class="builtinfunc" id="4927760">new</span><span class="op" id="4927763">(</span><span class="ident" id="4927764">encBuffer</span><span class="op" id="4927773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927776">data</span><span class="op" id="4927780">.</span><span class="ident" id="4927781">Write</span><span class="op" id="4927786">(</span><span class="ident" id="4927787">spaceForLength</span><span class="op" id="4927801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927804">enc</span><span class="op" id="4927807">.</span><span class="ident" id="4927808">encode</span><span class="op" id="4927814">(</span><span class="ident" id="4927815">data</span><span class="op" id="4927819">,</span>&nbsp;<span class="ident" id="4927821">elem</span><span class="op" id="4927825">,</span>&nbsp;<span class="ident" id="4927827">ut</span><span class="op" id="4927829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927832">if</span>&nbsp;<span class="ident" id="4927835">enc</span><span class="op" id="4927838">.</span><span class="ident" id="4927839">err</span>&nbsp;<span class="op" id="4927843">!=</span>&nbsp;<span class="ident" id="4927846">nil</span>&nbsp;<span class="op" id="4927850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927854">error_</span><span class="op" id="4927860">(</span><span class="ident" id="4927861">enc</span><span class="op" id="4927864">.</span><span class="ident" id="4927865">err</span><span class="op" id="4927868">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927874">enc</span><span class="op" id="4927877">.</span><span class="ident" id="4927878">popWriter</span><span class="op" id="4927887">(</span><span class="op" id="4927888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927891">enc</span><span class="op" id="4927894">.</span><span class="ident" id="4927895">writeMessage</span><span class="op" id="4927907">(</span><span class="ident" id="4927908">b</span><span class="op" id="4927909">,</span>&nbsp;<span class="ident" id="4927911">data</span><span class="op" id="4927915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4927918">if</span>&nbsp;<span class="ident" id="4927921">enc</span><span class="op" id="4927924">.</span><span class="ident" id="4927925">err</span>&nbsp;<span class="op" id="4927929">!=</span>&nbsp;<span class="ident" id="4927932">nil</span>&nbsp;<span class="op" id="4927936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927940">error_</span><span class="op" id="4927946">(</span><span class="ident" id="4927947">enc</span><span class="op" id="4927950">.</span><span class="ident" id="4927951">err</span><span class="op" id="4927954">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4927957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4927960">enc</span><span class="op" id="4927963">.</span><span class="ident" id="4927964">freeEncoderState</span><span class="op" id="4927980">(</span><span class="ident" id="4927981">state</span><span class="op" id="4927986">)</span><br>
<span class="lineno"></span><span class="op" id="4927988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4927991">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="4928052">func</span>&nbsp;<span class="ident" id="4928057">isZero</span><span class="op" id="4928063">(</span><span class="ident" id="4928064">val</span>&nbsp;<span class="ident" id="4928068">reflect</span><span class="op" id="4928075">.</span><span class="ident" id="4928076">Value</span><span class="op" id="4928081">)</span>&nbsp;<span class="builtintype" id="4928083">bool</span>&nbsp;<span class="op" id="4928088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928091">switch</span>&nbsp;<span class="ident" id="4928098">val</span><span class="op" id="4928101">.</span><span class="ident" id="4928102">Kind</span><span class="op" id="4928106">(</span><span class="op" id="4928107">)</span>&nbsp;<span class="op" id="4928109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928112">case</span>&nbsp;<span class="ident" id="4928117">reflect</span><span class="op" id="4928124">.</span><span class="ident" id="4928125">Array</span><span class="op" id="4928130">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928134">for</span>&nbsp;<span class="ident" id="4928138">i</span>&nbsp;<span class="op" id="4928140">:=</span>&nbsp;<span class="num" id="4928143">0</span><span class="op" id="4928144">;</span>&nbsp;<span class="ident" id="4928146">i</span>&nbsp;<span class="op" id="4928148">&lt;</span>&nbsp;<span class="ident" id="4928150">val</span><span class="op" id="4928153">.</span><span class="ident" id="4928154">Len</span><span class="op" id="4928157">(</span><span class="op" id="4928158">)</span><span class="op" id="4928159">;</span>&nbsp;<span class="ident" id="4928161">i</span><span class="op" id="4928162">++</span>&nbsp;<span class="op" id="4928165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928170">if</span>&nbsp;<span class="op" id="4928173">!</span><span class="ident" id="4928174">isZero</span><span class="op" id="4928180">(</span><span class="ident" id="4928181">val</span><span class="op" id="4928184">.</span><span class="ident" id="4928185">Index</span><span class="op" id="4928190">(</span><span class="ident" id="4928191">i</span><span class="op" id="4928192">)</span><span class="op" id="4928193">)</span>&nbsp;<span class="op" id="4928195">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928201">return</span>&nbsp;<span class="builtintype" id="4928208">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928225">return</span>&nbsp;<span class="builtintype" id="4928232">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928238">case</span>&nbsp;<span class="ident" id="4928243">reflect</span><span class="op" id="4928250">.</span><span class="ident" id="4928251">Map</span><span class="op" id="4928254">,</span>&nbsp;<span class="ident" id="4928256">reflect</span><span class="op" id="4928263">.</span><span class="ident" id="4928264">Slice</span><span class="op" id="4928269">,</span>&nbsp;<span class="ident" id="4928271">reflect</span><span class="op" id="4928278">.</span><span class="ident" id="4928279">String</span><span class="op" id="4928285">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928289">return</span>&nbsp;<span class="ident" id="4928296">val</span><span class="op" id="4928299">.</span><span class="ident" id="4928300">Len</span><span class="op" id="4928303">(</span><span class="op" id="4928304">)</span>&nbsp;<span class="op" id="4928306">==</span>&nbsp;<span class="num" id="4928309">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928312">case</span>&nbsp;<span class="ident" id="4928317">reflect</span><span class="op" id="4928324">.</span><span class="ident" id="4928325">Bool</span><span class="op" id="4928329">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928333">return</span>&nbsp;<span class="op" id="4928340">!</span><span class="ident" id="4928341">val</span><span class="op" id="4928344">.</span><span class="ident" id="4928345">Bool</span><span class="op" id="4928349">(</span><span class="op" id="4928350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928353">case</span>&nbsp;<span class="ident" id="4928358">reflect</span><span class="op" id="4928365">.</span><span class="ident" id="4928366">Complex64</span><span class="op" id="4928375">,</span>&nbsp;<span class="ident" id="4928377">reflect</span><span class="op" id="4928384">.</span><span class="ident" id="4928385">Complex128</span><span class="op" id="4928395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928399">return</span>&nbsp;<span class="ident" id="4928406">val</span><span class="op" id="4928409">.</span><span class="ident" id="4928410">Complex</span><span class="op" id="4928417">(</span><span class="op" id="4928418">)</span>&nbsp;<span class="op" id="4928420">==</span>&nbsp;<span class="num" id="4928423">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928426">case</span>&nbsp;<span class="ident" id="4928431">reflect</span><span class="op" id="4928438">.</span><span class="ident" id="4928439">Chan</span><span class="op" id="4928443">,</span>&nbsp;<span class="ident" id="4928445">reflect</span><span class="op" id="4928452">.</span><span class="ident" id="4928453">Func</span><span class="op" id="4928457">,</span>&nbsp;<span class="ident" id="4928459">reflect</span><span class="op" id="4928466">.</span><span class="ident" id="4928467">Interface</span><span class="op" id="4928476">,</span>&nbsp;<span class="ident" id="4928478">reflect</span><span class="op" id="4928485">.</span><span class="ident" id="4928486">Ptr</span><span class="op" id="4928489">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928493">return</span>&nbsp;<span class="ident" id="4928500">val</span><span class="op" id="4928503">.</span><span class="ident" id="4928504">IsNil</span><span class="op" id="4928509">(</span><span class="op" id="4928510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928513">case</span>&nbsp;<span class="ident" id="4928518">reflect</span><span class="op" id="4928525">.</span><span class="ident" id="4928526">Int</span><span class="op" id="4928529">,</span>&nbsp;<span class="ident" id="4928531">reflect</span><span class="op" id="4928538">.</span><span class="ident" id="4928539">Int8</span><span class="op" id="4928543">,</span>&nbsp;<span class="ident" id="4928545">reflect</span><span class="op" id="4928552">.</span><span class="ident" id="4928553">Int16</span><span class="op" id="4928558">,</span>&nbsp;<span class="ident" id="4928560">reflect</span><span class="op" id="4928567">.</span><span class="ident" id="4928568">Int32</span><span class="op" id="4928573">,</span>&nbsp;<span class="ident" id="4928575">reflect</span><span class="op" id="4928582">.</span><span class="ident" id="4928583">Int64</span><span class="op" id="4928588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928592">return</span>&nbsp;<span class="ident" id="4928599">val</span><span class="op" id="4928602">.</span><span class="ident" id="4928603">Int</span><span class="op" id="4928606">(</span><span class="op" id="4928607">)</span>&nbsp;<span class="op" id="4928609">==</span>&nbsp;<span class="num" id="4928612">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928615">case</span>&nbsp;<span class="ident" id="4928620">reflect</span><span class="op" id="4928627">.</span><span class="ident" id="4928628">Float32</span><span class="op" id="4928635">,</span>&nbsp;<span class="ident" id="4928637">reflect</span><span class="op" id="4928644">.</span><span class="ident" id="4928645">Float64</span><span class="op" id="4928652">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928656">return</span>&nbsp;<span class="ident" id="4928663">val</span><span class="op" id="4928666">.</span><span class="ident" id="4928667">Float</span><span class="op" id="4928672">(</span><span class="op" id="4928673">)</span>&nbsp;<span class="op" id="4928675">==</span>&nbsp;<span class="num" id="4928678">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928681">case</span>&nbsp;<span class="ident" id="4928686">reflect</span><span class="op" id="4928693">.</span><span class="ident" id="4928694">Uint</span><span class="op" id="4928698">,</span>&nbsp;<span class="ident" id="4928700">reflect</span><span class="op" id="4928707">.</span><span class="ident" id="4928708">Uint8</span><span class="op" id="4928713">,</span>&nbsp;<span class="ident" id="4928715">reflect</span><span class="op" id="4928722">.</span><span class="ident" id="4928723">Uint16</span><span class="op" id="4928729">,</span>&nbsp;<span class="ident" id="4928731">reflect</span><span class="op" id="4928738">.</span><span class="ident" id="4928739">Uint32</span><span class="op" id="4928745">,</span>&nbsp;<span class="ident" id="4928747">reflect</span><span class="op" id="4928754">.</span><span class="ident" id="4928755">Uint64</span><span class="op" id="4928761">,</span>&nbsp;<span class="ident" id="4928763">reflect</span><span class="op" id="4928770">.</span><span class="ident" id="4928771">Uintptr</span><span class="op" id="4928778">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928782">return</span>&nbsp;<span class="ident" id="4928789">val</span><span class="op" id="4928792">.</span><span class="ident" id="4928793">Uint</span><span class="op" id="4928797">(</span><span class="op" id="4928798">)</span>&nbsp;<span class="op" id="4928800">==</span>&nbsp;<span class="num" id="4928803">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928806">case</span>&nbsp;<span class="ident" id="4928811">reflect</span><span class="op" id="4928818">.</span><span class="ident" id="4928819">Struct</span><span class="op" id="4928825">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928829">for</span>&nbsp;<span class="ident" id="4928833">i</span>&nbsp;<span class="op" id="4928835">:=</span>&nbsp;<span class="num" id="4928838">0</span><span class="op" id="4928839">;</span>&nbsp;<span class="ident" id="4928841">i</span>&nbsp;<span class="op" id="4928843">&lt;</span>&nbsp;<span class="ident" id="4928845">val</span><span class="op" id="4928848">.</span><span class="ident" id="4928849">NumField</span><span class="op" id="4928857">(</span><span class="op" id="4928858">)</span><span class="op" id="4928859">;</span>&nbsp;<span class="ident" id="4928861">i</span><span class="op" id="4928862">++</span>&nbsp;<span class="op" id="4928865">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928870">if</span>&nbsp;<span class="op" id="4928873">!</span><span class="ident" id="4928874">isZero</span><span class="op" id="4928880">(</span><span class="ident" id="4928881">val</span><span class="op" id="4928884">.</span><span class="ident" id="4928885">Field</span><span class="op" id="4928890">(</span><span class="ident" id="4928891">i</span><span class="op" id="4928892">)</span><span class="op" id="4928893">)</span>&nbsp;<span class="op" id="4928895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928901">return</span>&nbsp;<span class="builtintype" id="4928908">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4928925">return</span>&nbsp;<span class="builtintype" id="4928932">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4928938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4928941">panic</span><span class="op" id="4928946">(</span><span class="string" id="4928947">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="4928973">+</span>&nbsp;<span class="ident" id="4928975">val</span><span class="op" id="4928978">.</span><span class="ident" id="4928979">Type</span><span class="op" id="4928983">(</span><span class="op" id="4928984">)</span><span class="op" id="4928985">.</span><span class="ident" id="4928986">String</span><span class="op" id="4928992">(</span><span class="op" id="4928993">)</span><span class="op" id="4928994">)</span><br>
<span class="lineno"></span><span class="op" id="4928996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4928999">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="4929074">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4929111">func</span>&nbsp;<span class="op" id="4929116">(</span><span class="ident" id="4929117">enc</span>&nbsp;<span class="op" id="4929121">*</span><span class="ident" id="4929122">Encoder</span><span class="op" id="4929129">)</span>&nbsp;<span class="ident" id="4929131">encodeGobEncoder</span><span class="op" id="4929147">(</span><span class="ident" id="4929148">b</span>&nbsp;<span class="op" id="4929150">*</span><span class="ident" id="4929151">encBuffer</span><span class="op" id="4929160">,</span>&nbsp;<span class="ident" id="4929162">ut</span>&nbsp;<span class="op" id="4929165">*</span><span class="ident" id="4929166">userTypeInfo</span><span class="op" id="4929178">,</span>&nbsp;<span class="ident" id="4929180">v</span>&nbsp;<span class="ident" id="4929182">reflect</span><span class="op" id="4929189">.</span><span class="ident" id="4929190">Value</span><span class="op" id="4929195">)</span>&nbsp;<span class="op" id="4929197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4929200">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929258">var</span>&nbsp;<span class="ident" id="4929262">data</span>&nbsp;<span class="op" id="4929267">[</span><span class="op" id="4929268">]</span><span class="builtintype" id="4929269">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929275">var</span>&nbsp;<span class="ident" id="4929279">err</span>&nbsp;<span class="builtintype" id="4929283">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4929290">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929321">switch</span>&nbsp;<span class="ident" id="4929328">ut</span><span class="op" id="4929330">.</span><span class="ident" id="4929331">externalEnc</span>&nbsp;<span class="op" id="4929343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929346">case</span>&nbsp;<span class="ident" id="4929351">xGob</span><span class="op" id="4929355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929359">data</span><span class="op" id="4929363">,</span>&nbsp;<span class="ident" id="4929365">err</span>&nbsp;<span class="op" id="4929369">=</span>&nbsp;<span class="ident" id="4929371">v</span><span class="op" id="4929372">.</span><span class="ident" id="4929373">Interface</span><span class="op" id="4929382">(</span><span class="op" id="4929383">)</span><span class="op" id="4929384">.</span><span class="op" id="4929385">(</span><span class="ident" id="4929386">GobEncoder</span><span class="op" id="4929396">)</span><span class="op" id="4929397">.</span><span class="ident" id="4929398">GobEncode</span><span class="op" id="4929407">(</span><span class="op" id="4929408">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929411">case</span>&nbsp;<span class="ident" id="4929416">xBinary</span><span class="op" id="4929423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929427">data</span><span class="op" id="4929431">,</span>&nbsp;<span class="ident" id="4929433">err</span>&nbsp;<span class="op" id="4929437">=</span>&nbsp;<span class="ident" id="4929439">v</span><span class="op" id="4929440">.</span><span class="ident" id="4929441">Interface</span><span class="op" id="4929450">(</span><span class="op" id="4929451">)</span><span class="op" id="4929452">.</span><span class="op" id="4929453">(</span><span class="ident" id="4929454">encoding</span><span class="op" id="4929462">.</span><span class="ident" id="4929463">BinaryMarshaler</span><span class="op" id="4929478">)</span><span class="op" id="4929479">.</span><span class="ident" id="4929480">MarshalBinary</span><span class="op" id="4929493">(</span><span class="op" id="4929494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929497">case</span>&nbsp;<span class="ident" id="4929502">xText</span><span class="op" id="4929507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929511">data</span><span class="op" id="4929515">,</span>&nbsp;<span class="ident" id="4929517">err</span>&nbsp;<span class="op" id="4929521">=</span>&nbsp;<span class="ident" id="4929523">v</span><span class="op" id="4929524">.</span><span class="ident" id="4929525">Interface</span><span class="op" id="4929534">(</span><span class="op" id="4929535">)</span><span class="op" id="4929536">.</span><span class="op" id="4929537">(</span><span class="ident" id="4929538">encoding</span><span class="op" id="4929546">.</span><span class="ident" id="4929547">TextMarshaler</span><span class="op" id="4929560">)</span><span class="op" id="4929561">.</span><span class="ident" id="4929562">MarshalText</span><span class="op" id="4929573">(</span><span class="op" id="4929574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929577">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4929580">if</span>&nbsp;<span class="ident" id="4929583">err</span>&nbsp;<span class="op" id="4929587">!=</span>&nbsp;<span class="ident" id="4929590">nil</span>&nbsp;<span class="op" id="4929594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929598">error_</span><span class="op" id="4929604">(</span><span class="ident" id="4929605">err</span><span class="op" id="4929608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4929611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929614">state</span>&nbsp;<span class="op" id="4929620">:=</span>&nbsp;<span class="ident" id="4929623">enc</span><span class="op" id="4929626">.</span><span class="ident" id="4929627">newEncoderState</span><span class="op" id="4929642">(</span><span class="ident" id="4929643">b</span><span class="op" id="4929644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929647">state</span><span class="op" id="4929652">.</span><span class="ident" id="4929653">fieldnum</span>&nbsp;<span class="op" id="4929662">=</span>&nbsp;<span class="op" id="4929664">-</span><span class="num" id="4929665">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929668">state</span><span class="op" id="4929673">.</span><span class="ident" id="4929674">encodeUint</span><span class="op" id="4929684">(</span><span class="ident" id="4929685">uint64</span><span class="op" id="4929691">(</span><span class="builtinfunc" id="4929692">len</span><span class="op" id="4929695">(</span><span class="ident" id="4929696">data</span><span class="op" id="4929700">)</span><span class="op" id="4929701">)</span><span class="op" id="4929702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929705">state</span><span class="op" id="4929710">.</span><span class="ident" id="4929711">b</span><span class="op" id="4929712">.</span><span class="ident" id="4929713">Write</span><span class="op" id="4929718">(</span><span class="ident" id="4929719">data</span><span class="op" id="4929723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929726">enc</span><span class="op" id="4929729">.</span><span class="ident" id="4929730">freeEncoderState</span><span class="op" id="4929746">(</span><span class="ident" id="4929747">state</span><span class="op" id="4929752">)</span><br>
<span class="lineno"></span><span class="op" id="4929754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="4929757">var</span>&nbsp;<span class="ident" id="4929761">encOpTable</span>&nbsp;<span class="op" id="4929772">=</span>&nbsp;<span class="op" id="4929774">[</span><span class="op" id="4929775">...</span><span class="op" id="4929778">]</span><span class="ident" id="4929779">encOp</span><span class="op" id="4929784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929787">reflect</span><span class="op" id="4929794">.</span><span class="ident" id="4929795">Bool</span><span class="op" id="4929799">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929807">encBool</span><span class="op" id="4929814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929817">reflect</span><span class="op" id="4929824">.</span><span class="ident" id="4929825">Int</span><span class="op" id="4929828">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929837">encInt</span><span class="op" id="4929843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929846">reflect</span><span class="op" id="4929853">.</span><span class="ident" id="4929854">Int8</span><span class="op" id="4929858">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929866">encInt</span><span class="op" id="4929872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929875">reflect</span><span class="op" id="4929882">.</span><span class="ident" id="4929883">Int16</span><span class="op" id="4929888">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929895">encInt</span><span class="op" id="4929901">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929904">reflect</span><span class="op" id="4929911">.</span><span class="ident" id="4929912">Int32</span><span class="op" id="4929917">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929924">encInt</span><span class="op" id="4929930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929933">reflect</span><span class="op" id="4929940">.</span><span class="ident" id="4929941">Int64</span><span class="op" id="4929946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929953">encInt</span><span class="op" id="4929959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929962">reflect</span><span class="op" id="4929969">.</span><span class="ident" id="4929970">Uint</span><span class="op" id="4929974">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4929982">encUint</span><span class="op" id="4929989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4929992">reflect</span><span class="op" id="4929999">.</span><span class="ident" id="4930000">Uint8</span><span class="op" id="4930005">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930012">encUint</span><span class="op" id="4930019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930022">reflect</span><span class="op" id="4930029">.</span><span class="ident" id="4930030">Uint16</span><span class="op" id="4930036">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930042">encUint</span><span class="op" id="4930049">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930052">reflect</span><span class="op" id="4930059">.</span><span class="ident" id="4930060">Uint32</span><span class="op" id="4930066">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930072">encUint</span><span class="op" id="4930079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930082">reflect</span><span class="op" id="4930089">.</span><span class="ident" id="4930090">Uint64</span><span class="op" id="4930096">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930102">encUint</span><span class="op" id="4930109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930112">reflect</span><span class="op" id="4930119">.</span><span class="ident" id="4930120">Uintptr</span><span class="op" id="4930127">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930132">encUint</span><span class="op" id="4930139">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930142">reflect</span><span class="op" id="4930149">.</span><span class="ident" id="4930150">Float32</span><span class="op" id="4930157">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930162">encFloat</span><span class="op" id="4930170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930173">reflect</span><span class="op" id="4930180">.</span><span class="ident" id="4930181">Float64</span><span class="op" id="4930188">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930193">encFloat</span><span class="op" id="4930201">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930204">reflect</span><span class="op" id="4930211">.</span><span class="ident" id="4930212">Complex64</span><span class="op" id="4930221">:</span>&nbsp;&nbsp;<span class="ident" id="4930224">encComplex</span><span class="op" id="4930234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930237">reflect</span><span class="op" id="4930244">.</span><span class="ident" id="4930245">Complex128</span><span class="op" id="4930255">:</span>&nbsp;<span class="ident" id="4930257">encComplex</span><span class="op" id="4930267">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930270">reflect</span><span class="op" id="4930277">.</span><span class="ident" id="4930278">String</span><span class="op" id="4930284">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4930290">encString</span><span class="op" id="4930299">,</span><br>
<span class="lineno"></span><span class="op" id="4930301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="4930304">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4930386">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4930424">func</span>&nbsp;<span class="ident" id="4930429">encOpFor</span><span class="op" id="4930437">(</span><span class="ident" id="4930438">rt</span>&nbsp;<span class="ident" id="4930441">reflect</span><span class="op" id="4930448">.</span><span class="ident" id="4930449">Type</span><span class="op" id="4930453">,</span>&nbsp;<span class="ident" id="4930455">inProgress</span>&nbsp;<span class="keyword" id="4930466">map</span><span class="op" id="4930469">[</span><span class="ident" id="4930470">reflect</span><span class="op" id="4930477">.</span><span class="ident" id="4930478">Type</span><span class="op" id="4930482">]</span><span class="op" id="4930483">*</span><span class="ident" id="4930484">encOp</span><span class="op" id="4930489">,</span>&nbsp;<span class="ident" id="4930491">building</span>&nbsp;<span class="keyword" id="4930500">map</span><span class="op" id="4930503">[</span><span class="op" id="4930504">*</span><span class="ident" id="4930505">typeInfo</span><span class="op" id="4930513">]</span><span class="builtintype" id="4930514">bool</span><span class="op" id="4930518">)</span>&nbsp;<span class="op" id="4930520">(</span><span class="op" id="4930521">*</span><span class="ident" id="4930522">encOp</span><span class="op" id="4930527">,</span>&nbsp;<span class="builtintype" id="4930529">int</span><span class="op" id="4930532">)</span>&nbsp;<span class="op" id="4930534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930537">ut</span>&nbsp;<span class="op" id="4930540">:=</span>&nbsp;<span class="ident" id="4930543">userType</span><span class="op" id="4930551">(</span><span class="ident" id="4930552">rt</span><span class="op" id="4930554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4930557">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930637">if</span>&nbsp;<span class="ident" id="4930640">ut</span><span class="op" id="4930642">.</span><span class="ident" id="4930643">externalEnc</span>&nbsp;<span class="op" id="4930655">!=</span>&nbsp;<span class="num" id="4930658">0</span>&nbsp;<span class="op" id="4930660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930664">return</span>&nbsp;<span class="ident" id="4930671">gobEncodeOpFor</span><span class="op" id="4930685">(</span><span class="ident" id="4930686">ut</span><span class="op" id="4930688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4930694">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4930779">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930836">if</span>&nbsp;<span class="ident" id="4930839">opPtr</span>&nbsp;<span class="op" id="4930845">:=</span>&nbsp;<span class="ident" id="4930848">inProgress</span><span class="op" id="4930858">[</span><span class="ident" id="4930859">rt</span><span class="op" id="4930861">]</span><span class="op" id="4930862">;</span>&nbsp;<span class="ident" id="4930864">opPtr</span>&nbsp;<span class="op" id="4930870">!=</span>&nbsp;<span class="ident" id="4930873">nil</span>&nbsp;<span class="op" id="4930877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930881">return</span>&nbsp;<span class="ident" id="4930888">opPtr</span><span class="op" id="4930893">,</span>&nbsp;<span class="ident" id="4930895">ut</span><span class="op" id="4930897">.</span><span class="ident" id="4930898">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4930905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930908">typ</span>&nbsp;<span class="op" id="4930912">:=</span>&nbsp;<span class="ident" id="4930915">ut</span><span class="op" id="4930917">.</span><span class="ident" id="4930918">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930924">indir</span>&nbsp;<span class="op" id="4930930">:=</span>&nbsp;<span class="ident" id="4930933">ut</span><span class="op" id="4930935">.</span><span class="ident" id="4930936">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4930943">k</span>&nbsp;<span class="op" id="4930945">:=</span>&nbsp;<span class="ident" id="4930948">typ</span><span class="op" id="4930951">.</span><span class="ident" id="4930952">Kind</span><span class="op" id="4930956">(</span><span class="op" id="4930957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930960">var</span>&nbsp;<span class="ident" id="4930964">op</span>&nbsp;<span class="ident" id="4930967">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4930974">if</span>&nbsp;<span class="builtintype" id="4930977">int</span><span class="op" id="4930980">(</span><span class="ident" id="4930981">k</span><span class="op" id="4930982">)</span>&nbsp;<span class="op" id="4930984">&lt;</span>&nbsp;<span class="builtinfunc" id="4930986">len</span><span class="op" id="4930989">(</span><span class="ident" id="4930990">encOpTable</span><span class="op" id="4931000">)</span>&nbsp;<span class="op" id="4931002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931006">op</span>&nbsp;<span class="op" id="4931009">=</span>&nbsp;<span class="ident" id="4931011">encOpTable</span><span class="op" id="4931021">[</span><span class="ident" id="4931022">k</span><span class="op" id="4931023">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931026">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931029">if</span>&nbsp;<span class="ident" id="4931032">op</span>&nbsp;<span class="op" id="4931035">==</span>&nbsp;<span class="ident" id="4931038">nil</span>&nbsp;<span class="op" id="4931042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931046">inProgress</span><span class="op" id="4931056">[</span><span class="ident" id="4931057">rt</span><span class="op" id="4931059">]</span>&nbsp;<span class="op" id="4931061">=</span>&nbsp;<span class="op" id="4931063">&amp;</span><span class="ident" id="4931064">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931069">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931088">switch</span>&nbsp;<span class="ident" id="4931095">t</span>&nbsp;<span class="op" id="4931097">:=</span>&nbsp;<span class="ident" id="4931100">typ</span><span class="op" id="4931103">;</span>&nbsp;<span class="ident" id="4931105">t</span><span class="op" id="4931106">.</span><span class="ident" id="4931107">Kind</span><span class="op" id="4931111">(</span><span class="op" id="4931112">)</span>&nbsp;<span class="op" id="4931114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931118">case</span>&nbsp;<span class="ident" id="4931123">reflect</span><span class="op" id="4931130">.</span><span class="ident" id="4931131">Slice</span><span class="op" id="4931136">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931141">if</span>&nbsp;<span class="ident" id="4931144">t</span><span class="op" id="4931145">.</span><span class="ident" id="4931146">Elem</span><span class="op" id="4931150">(</span><span class="op" id="4931151">)</span><span class="op" id="4931152">.</span><span class="ident" id="4931153">Kind</span><span class="op" id="4931157">(</span><span class="op" id="4931158">)</span>&nbsp;<span class="op" id="4931160">==</span>&nbsp;<span class="ident" id="4931163">reflect</span><span class="op" id="4931170">.</span><span class="ident" id="4931171">Uint8</span>&nbsp;<span class="op" id="4931177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931183">op</span>&nbsp;<span class="op" id="4931186">=</span>&nbsp;<span class="ident" id="4931188">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931206">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931220">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931291">elemOp</span><span class="op" id="4931297">,</span>&nbsp;<span class="ident" id="4931299">elemIndir</span>&nbsp;<span class="op" id="4931309">:=</span>&nbsp;<span class="ident" id="4931312">encOpFor</span><span class="op" id="4931320">(</span><span class="ident" id="4931321">t</span><span class="op" id="4931322">.</span><span class="ident" id="4931323">Elem</span><span class="op" id="4931327">(</span><span class="op" id="4931328">)</span><span class="op" id="4931329">,</span>&nbsp;<span class="ident" id="4931331">inProgress</span><span class="op" id="4931341">,</span>&nbsp;<span class="ident" id="4931343">building</span><span class="op" id="4931351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931356">helper</span>&nbsp;<span class="op" id="4931363">:=</span>&nbsp;<span class="ident" id="4931366">encSliceHelper</span><span class="op" id="4931380">[</span><span class="ident" id="4931381">t</span><span class="op" id="4931382">.</span><span class="ident" id="4931383">Elem</span><span class="op" id="4931387">(</span><span class="op" id="4931388">)</span><span class="op" id="4931389">.</span><span class="ident" id="4931390">Kind</span><span class="op" id="4931394">(</span><span class="op" id="4931395">)</span><span class="op" id="4931396">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931401">op</span>&nbsp;<span class="op" id="4931404">=</span>&nbsp;<span class="keyword" id="4931406">func</span><span class="op" id="4931410">(</span><span class="ident" id="4931411">i</span>&nbsp;<span class="op" id="4931413">*</span><span class="ident" id="4931414">encInstr</span><span class="op" id="4931422">,</span>&nbsp;<span class="ident" id="4931424">state</span>&nbsp;<span class="op" id="4931430">*</span><span class="ident" id="4931431">encoderState</span><span class="op" id="4931443">,</span>&nbsp;<span class="ident" id="4931445">slice</span>&nbsp;<span class="ident" id="4931451">reflect</span><span class="op" id="4931458">.</span><span class="ident" id="4931459">Value</span><span class="op" id="4931464">)</span>&nbsp;<span class="op" id="4931466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931472">if</span>&nbsp;<span class="op" id="4931475">!</span><span class="ident" id="4931476">state</span><span class="op" id="4931481">.</span><span class="ident" id="4931482">sendZero</span>&nbsp;<span class="op" id="4931491">&amp;&amp;</span>&nbsp;<span class="ident" id="4931494">slice</span><span class="op" id="4931499">.</span><span class="ident" id="4931500">Len</span><span class="op" id="4931503">(</span><span class="op" id="4931504">)</span>&nbsp;<span class="op" id="4931506">==</span>&nbsp;<span class="num" id="4931509">0</span>&nbsp;<span class="op" id="4931511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931518">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931535">state</span><span class="op" id="4931540">.</span><span class="ident" id="4931541">update</span><span class="op" id="4931547">(</span><span class="ident" id="4931548">i</span><span class="op" id="4931549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931555">state</span><span class="op" id="4931560">.</span><span class="ident" id="4931561">enc</span><span class="op" id="4931564">.</span><span class="ident" id="4931565">encodeArray</span><span class="op" id="4931576">(</span><span class="ident" id="4931577">state</span><span class="op" id="4931582">.</span><span class="ident" id="4931583">b</span><span class="op" id="4931584">,</span>&nbsp;<span class="ident" id="4931586">slice</span><span class="op" id="4931591">,</span>&nbsp;<span class="op" id="4931593">*</span><span class="ident" id="4931594">elemOp</span><span class="op" id="4931600">,</span>&nbsp;<span class="ident" id="4931602">elemIndir</span><span class="op" id="4931611">,</span>&nbsp;<span class="ident" id="4931613">slice</span><span class="op" id="4931618">.</span><span class="ident" id="4931619">Len</span><span class="op" id="4931622">(</span><span class="op" id="4931623">)</span><span class="op" id="4931624">,</span>&nbsp;<span class="ident" id="4931626">helper</span><span class="op" id="4931632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931641">case</span>&nbsp;<span class="ident" id="4931646">reflect</span><span class="op" id="4931653">.</span><span class="ident" id="4931654">Array</span><span class="op" id="4931659">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4931664">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931705">elemOp</span><span class="op" id="4931711">,</span>&nbsp;<span class="ident" id="4931713">elemIndir</span>&nbsp;<span class="op" id="4931723">:=</span>&nbsp;<span class="ident" id="4931726">encOpFor</span><span class="op" id="4931734">(</span><span class="ident" id="4931735">t</span><span class="op" id="4931736">.</span><span class="ident" id="4931737">Elem</span><span class="op" id="4931741">(</span><span class="op" id="4931742">)</span><span class="op" id="4931743">,</span>&nbsp;<span class="ident" id="4931745">inProgress</span><span class="op" id="4931755">,</span>&nbsp;<span class="ident" id="4931757">building</span><span class="op" id="4931765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931770">helper</span>&nbsp;<span class="op" id="4931777">:=</span>&nbsp;<span class="ident" id="4931780">encArrayHelper</span><span class="op" id="4931794">[</span><span class="ident" id="4931795">t</span><span class="op" id="4931796">.</span><span class="ident" id="4931797">Elem</span><span class="op" id="4931801">(</span><span class="op" id="4931802">)</span><span class="op" id="4931803">.</span><span class="ident" id="4931804">Kind</span><span class="op" id="4931808">(</span><span class="op" id="4931809">)</span><span class="op" id="4931810">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931815">op</span>&nbsp;<span class="op" id="4931818">=</span>&nbsp;<span class="keyword" id="4931820">func</span><span class="op" id="4931824">(</span><span class="ident" id="4931825">i</span>&nbsp;<span class="op" id="4931827">*</span><span class="ident" id="4931828">encInstr</span><span class="op" id="4931836">,</span>&nbsp;<span class="ident" id="4931838">state</span>&nbsp;<span class="op" id="4931844">*</span><span class="ident" id="4931845">encoderState</span><span class="op" id="4931857">,</span>&nbsp;<span class="ident" id="4931859">array</span>&nbsp;<span class="ident" id="4931865">reflect</span><span class="op" id="4931872">.</span><span class="ident" id="4931873">Value</span><span class="op" id="4931878">)</span>&nbsp;<span class="op" id="4931880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931886">state</span><span class="op" id="4931891">.</span><span class="ident" id="4931892">update</span><span class="op" id="4931898">(</span><span class="ident" id="4931899">i</span><span class="op" id="4931900">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4931906">state</span><span class="op" id="4931911">.</span><span class="ident" id="4931912">enc</span><span class="op" id="4931915">.</span><span class="ident" id="4931916">encodeArray</span><span class="op" id="4931927">(</span><span class="ident" id="4931928">state</span><span class="op" id="4931933">.</span><span class="ident" id="4931934">b</span><span class="op" id="4931935">,</span>&nbsp;<span class="ident" id="4931937">array</span><span class="op" id="4931942">,</span>&nbsp;<span class="op" id="4931944">*</span><span class="ident" id="4931945">elemOp</span><span class="op" id="4931951">,</span>&nbsp;<span class="ident" id="4931953">elemIndir</span><span class="op" id="4931962">,</span>&nbsp;<span class="ident" id="4931964">array</span><span class="op" id="4931969">.</span><span class="ident" id="4931970">Len</span><span class="op" id="4931973">(</span><span class="op" id="4931974">)</span><span class="op" id="4931975">,</span>&nbsp;<span class="ident" id="4931977">helper</span><span class="op" id="4931983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4931988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4931992">case</span>&nbsp;<span class="ident" id="4931997">reflect</span><span class="op" id="4932004">.</span><span class="ident" id="4932005">Map</span><span class="op" id="4932008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932013">keyOp</span><span class="op" id="4932018">,</span>&nbsp;<span class="ident" id="4932020">keyIndir</span>&nbsp;<span class="op" id="4932029">:=</span>&nbsp;<span class="ident" id="4932032">encOpFor</span><span class="op" id="4932040">(</span><span class="ident" id="4932041">t</span><span class="op" id="4932042">.</span><span class="ident" id="4932043">Key</span><span class="op" id="4932046">(</span><span class="op" id="4932047">)</span><span class="op" id="4932048">,</span>&nbsp;<span class="ident" id="4932050">inProgress</span><span class="op" id="4932060">,</span>&nbsp;<span class="ident" id="4932062">building</span><span class="op" id="4932070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932075">elemOp</span><span class="op" id="4932081">,</span>&nbsp;<span class="ident" id="4932083">elemIndir</span>&nbsp;<span class="op" id="4932093">:=</span>&nbsp;<span class="ident" id="4932096">encOpFor</span><span class="op" id="4932104">(</span><span class="ident" id="4932105">t</span><span class="op" id="4932106">.</span><span class="ident" id="4932107">Elem</span><span class="op" id="4932111">(</span><span class="op" id="4932112">)</span><span class="op" id="4932113">,</span>&nbsp;<span class="ident" id="4932115">inProgress</span><span class="op" id="4932125">,</span>&nbsp;<span class="ident" id="4932127">building</span><span class="op" id="4932135">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932140">op</span>&nbsp;<span class="op" id="4932143">=</span>&nbsp;<span class="keyword" id="4932145">func</span><span class="op" id="4932149">(</span><span class="ident" id="4932150">i</span>&nbsp;<span class="op" id="4932152">*</span><span class="ident" id="4932153">encInstr</span><span class="op" id="4932161">,</span>&nbsp;<span class="ident" id="4932163">state</span>&nbsp;<span class="op" id="4932169">*</span><span class="ident" id="4932170">encoderState</span><span class="op" id="4932182">,</span>&nbsp;<span class="ident" id="4932184">mv</span>&nbsp;<span class="ident" id="4932187">reflect</span><span class="op" id="4932194">.</span><span class="ident" id="4932195">Value</span><span class="op" id="4932200">)</span>&nbsp;<span class="op" id="4932202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932208">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932266">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932335">if</span>&nbsp;<span class="op" id="4932338">!</span><span class="ident" id="4932339">state</span><span class="op" id="4932344">.</span><span class="ident" id="4932345">sendZero</span>&nbsp;<span class="op" id="4932354">&amp;&amp;</span>&nbsp;<span class="ident" id="4932357">mv</span><span class="op" id="4932359">.</span><span class="ident" id="4932360">IsNil</span><span class="op" id="4932365">(</span><span class="op" id="4932366">)</span>&nbsp;<span class="op" id="4932368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932375">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932392">state</span><span class="op" id="4932397">.</span><span class="ident" id="4932398">update</span><span class="op" id="4932404">(</span><span class="ident" id="4932405">i</span><span class="op" id="4932406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932412">state</span><span class="op" id="4932417">.</span><span class="ident" id="4932418">enc</span><span class="op" id="4932421">.</span><span class="ident" id="4932422">encodeMap</span><span class="op" id="4932431">(</span><span class="ident" id="4932432">state</span><span class="op" id="4932437">.</span><span class="ident" id="4932438">b</span><span class="op" id="4932439">,</span>&nbsp;<span class="ident" id="4932441">mv</span><span class="op" id="4932443">,</span>&nbsp;<span class="op" id="4932445">*</span><span class="ident" id="4932446">keyOp</span><span class="op" id="4932451">,</span>&nbsp;<span class="op" id="4932453">*</span><span class="ident" id="4932454">elemOp</span><span class="op" id="4932460">,</span>&nbsp;<span class="ident" id="4932462">keyIndir</span><span class="op" id="4932470">,</span>&nbsp;<span class="ident" id="4932472">elemIndir</span><span class="op" id="4932481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932490">case</span>&nbsp;<span class="ident" id="4932495">reflect</span><span class="op" id="4932502">.</span><span class="ident" id="4932503">Struct</span><span class="op" id="4932509">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932514">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932589">getEncEngine</span><span class="op" id="4932601">(</span><span class="ident" id="4932602">userType</span><span class="op" id="4932610">(</span><span class="ident" id="4932611">typ</span><span class="op" id="4932614">)</span><span class="op" id="4932615">,</span>&nbsp;<span class="ident" id="4932617">building</span><span class="op" id="4932625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932630">info</span>&nbsp;<span class="op" id="4932635">:=</span>&nbsp;<span class="ident" id="4932638">mustGetTypeInfo</span><span class="op" id="4932653">(</span><span class="ident" id="4932654">typ</span><span class="op" id="4932657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932662">op</span>&nbsp;<span class="op" id="4932665">=</span>&nbsp;<span class="keyword" id="4932667">func</span><span class="op" id="4932671">(</span><span class="ident" id="4932672">i</span>&nbsp;<span class="op" id="4932674">*</span><span class="ident" id="4932675">encInstr</span><span class="op" id="4932683">,</span>&nbsp;<span class="ident" id="4932685">state</span>&nbsp;<span class="op" id="4932691">*</span><span class="ident" id="4932692">encoderState</span><span class="op" id="4932704">,</span>&nbsp;<span class="ident" id="4932706">sv</span>&nbsp;<span class="ident" id="4932709">reflect</span><span class="op" id="4932716">.</span><span class="ident" id="4932717">Value</span><span class="op" id="4932722">)</span>&nbsp;<span class="op" id="4932724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932730">state</span><span class="op" id="4932735">.</span><span class="ident" id="4932736">update</span><span class="op" id="4932742">(</span><span class="ident" id="4932743">i</span><span class="op" id="4932744">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4932750">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932821">enc</span>&nbsp;<span class="op" id="4932825">:=</span>&nbsp;<span class="ident" id="4932828">info</span><span class="op" id="4932832">.</span><span class="ident" id="4932833">encoder</span><span class="op" id="4932840">.</span><span class="ident" id="4932841">Load</span><span class="op" id="4932845">(</span><span class="op" id="4932846">)</span><span class="op" id="4932847">.</span><span class="op" id="4932848">(</span><span class="op" id="4932849">*</span><span class="ident" id="4932850">encEngine</span><span class="op" id="4932859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932865">state</span><span class="op" id="4932870">.</span><span class="ident" id="4932871">enc</span><span class="op" id="4932874">.</span><span class="ident" id="4932875">encodeStruct</span><span class="op" id="4932887">(</span><span class="ident" id="4932888">state</span><span class="op" id="4932893">.</span><span class="ident" id="4932894">b</span><span class="op" id="4932895">,</span>&nbsp;<span class="ident" id="4932897">enc</span><span class="op" id="4932900">,</span>&nbsp;<span class="ident" id="4932902">sv</span><span class="op" id="4932904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4932909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4932913">case</span>&nbsp;<span class="ident" id="4932918">reflect</span><span class="op" id="4932925">.</span><span class="ident" id="4932926">Interface</span><span class="op" id="4932935">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4932940">op</span>&nbsp;<span class="op" id="4932943">=</span>&nbsp;<span class="keyword" id="4932945">func</span><span class="op" id="4932949">(</span><span class="ident" id="4932950">i</span>&nbsp;<span class="op" id="4932952">*</span><span class="ident" id="4932953">encInstr</span><span class="op" id="4932961">,</span>&nbsp;<span class="ident" id="4932963">state</span>&nbsp;<span class="op" id="4932969">*</span><span class="ident" id="4932970">encoderState</span><span class="op" id="4932982">,</span>&nbsp;<span class="ident" id="4932984">iv</span>&nbsp;<span class="ident" id="4932987">reflect</span><span class="op" id="4932994">.</span><span class="ident" id="4932995">Value</span><span class="op" id="4933000">)</span>&nbsp;<span class="op" id="4933002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933008">if</span>&nbsp;<span class="op" id="4933011">!</span><span class="ident" id="4933012">state</span><span class="op" id="4933017">.</span><span class="ident" id="4933018">sendZero</span>&nbsp;<span class="op" id="4933027">&amp;&amp;</span>&nbsp;<span class="op" id="4933030">(</span><span class="op" id="4933031">!</span><span class="ident" id="4933032">iv</span><span class="op" id="4933034">.</span><span class="ident" id="4933035">IsValid</span><span class="op" id="4933042">(</span><span class="op" id="4933043">)</span>&nbsp;<span class="op" id="4933045">||</span>&nbsp;<span class="ident" id="4933048">iv</span><span class="op" id="4933050">.</span><span class="ident" id="4933051">IsNil</span><span class="op" id="4933056">(</span><span class="op" id="4933057">)</span><span class="op" id="4933058">)</span>&nbsp;<span class="op" id="4933060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933067">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933084">state</span><span class="op" id="4933089">.</span><span class="ident" id="4933090">update</span><span class="op" id="4933096">(</span><span class="ident" id="4933097">i</span><span class="op" id="4933098">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933104">state</span><span class="op" id="4933109">.</span><span class="ident" id="4933110">enc</span><span class="op" id="4933113">.</span><span class="ident" id="4933114">encodeInterface</span><span class="op" id="4933129">(</span><span class="ident" id="4933130">state</span><span class="op" id="4933135">.</span><span class="ident" id="4933136">b</span><span class="op" id="4933137">,</span>&nbsp;<span class="ident" id="4933139">iv</span><span class="op" id="4933141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933156">if</span>&nbsp;<span class="ident" id="4933159">op</span>&nbsp;<span class="op" id="4933162">==</span>&nbsp;<span class="ident" id="4933165">nil</span>&nbsp;<span class="op" id="4933169">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933173">errorf</span><span class="op" id="4933179">(</span><span class="string" id="4933180">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4933210">,</span>&nbsp;<span class="ident" id="4933212">rt</span><span class="op" id="4933214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933220">return</span>&nbsp;<span class="op" id="4933227">&amp;</span><span class="ident" id="4933228">op</span><span class="op" id="4933230">,</span>&nbsp;<span class="ident" id="4933232">indir</span><br>
<span class="lineno"></span><span class="op" id="4933238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="4933241">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4933324">func</span>&nbsp;<span class="ident" id="4933329">gobEncodeOpFor</span><span class="op" id="4933343">(</span><span class="ident" id="4933344">ut</span>&nbsp;<span class="op" id="4933347">*</span><span class="ident" id="4933348">userTypeInfo</span><span class="op" id="4933360">)</span>&nbsp;<span class="op" id="4933362">(</span><span class="op" id="4933363">*</span><span class="ident" id="4933364">encOp</span><span class="op" id="4933369">,</span>&nbsp;<span class="builtintype" id="4933371">int</span><span class="op" id="4933374">)</span>&nbsp;<span class="op" id="4933376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933379">rt</span>&nbsp;<span class="op" id="4933382">:=</span>&nbsp;<span class="ident" id="4933385">ut</span><span class="op" id="4933387">.</span><span class="ident" id="4933388">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933394">if</span>&nbsp;<span class="ident" id="4933397">ut</span><span class="op" id="4933399">.</span><span class="ident" id="4933400">encIndir</span>&nbsp;<span class="op" id="4933409">==</span>&nbsp;<span class="op" id="4933412">-</span><span class="num" id="4933413">1</span>&nbsp;<span class="op" id="4933415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933419">rt</span>&nbsp;<span class="op" id="4933422">=</span>&nbsp;<span class="ident" id="4933424">reflect</span><span class="op" id="4933431">.</span><span class="ident" id="4933432">PtrTo</span><span class="op" id="4933437">(</span><span class="ident" id="4933438">rt</span><span class="op" id="4933440">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933443">}</span>&nbsp;<span class="keyword" id="4933445">else</span>&nbsp;<span class="keyword" id="4933450">if</span>&nbsp;<span class="ident" id="4933453">ut</span><span class="op" id="4933455">.</span><span class="ident" id="4933456">encIndir</span>&nbsp;<span class="op" id="4933465">&gt;</span>&nbsp;<span class="num" id="4933467">0</span>&nbsp;<span class="op" id="4933469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933473">for</span>&nbsp;<span class="ident" id="4933477">i</span>&nbsp;<span class="op" id="4933479">:=</span>&nbsp;<span class="builtintype" id="4933482">int8</span><span class="op" id="4933486">(</span><span class="num" id="4933487">0</span><span class="op" id="4933488">)</span><span class="op" id="4933489">;</span>&nbsp;<span class="ident" id="4933491">i</span>&nbsp;<span class="op" id="4933493">&lt;</span>&nbsp;<span class="ident" id="4933495">ut</span><span class="op" id="4933497">.</span><span class="ident" id="4933498">encIndir</span><span class="op" id="4933506">;</span>&nbsp;<span class="ident" id="4933508">i</span><span class="op" id="4933509">++</span>&nbsp;<span class="op" id="4933512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933517">rt</span>&nbsp;<span class="op" id="4933520">=</span>&nbsp;<span class="ident" id="4933522">rt</span><span class="op" id="4933524">.</span><span class="ident" id="4933525">Elem</span><span class="op" id="4933529">(</span><span class="op" id="4933530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933537">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933540">var</span>&nbsp;<span class="ident" id="4933544">op</span>&nbsp;<span class="ident" id="4933547">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933554">op</span>&nbsp;<span class="op" id="4933557">=</span>&nbsp;<span class="keyword" id="4933559">func</span><span class="op" id="4933563">(</span><span class="ident" id="4933564">i</span>&nbsp;<span class="op" id="4933566">*</span><span class="ident" id="4933567">encInstr</span><span class="op" id="4933575">,</span>&nbsp;<span class="ident" id="4933577">state</span>&nbsp;<span class="op" id="4933583">*</span><span class="ident" id="4933584">encoderState</span><span class="op" id="4933596">,</span>&nbsp;<span class="ident" id="4933598">v</span>&nbsp;<span class="ident" id="4933600">reflect</span><span class="op" id="4933607">.</span><span class="ident" id="4933608">Value</span><span class="op" id="4933613">)</span>&nbsp;<span class="op" id="4933615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933619">if</span>&nbsp;<span class="ident" id="4933622">ut</span><span class="op" id="4933624">.</span><span class="ident" id="4933625">encIndir</span>&nbsp;<span class="op" id="4933634">==</span>&nbsp;<span class="op" id="4933637">-</span><span class="num" id="4933638">1</span>&nbsp;<span class="op" id="4933640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4933645">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933706">if</span>&nbsp;<span class="op" id="4933709">!</span><span class="ident" id="4933710">v</span><span class="op" id="4933711">.</span><span class="ident" id="4933712">CanAddr</span><span class="op" id="4933719">(</span><span class="op" id="4933720">)</span>&nbsp;<span class="op" id="4933722">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933728">errorf</span><span class="op" id="4933734">(</span><span class="string" id="4933735">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4933767">,</span>&nbsp;<span class="ident" id="4933769">rt</span><span class="op" id="4933771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933781">v</span>&nbsp;<span class="op" id="4933783">=</span>&nbsp;<span class="ident" id="4933785">v</span><span class="op" id="4933786">.</span><span class="ident" id="4933787">Addr</span><span class="op" id="4933791">(</span><span class="op" id="4933792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933800">if</span>&nbsp;<span class="op" id="4933803">!</span><span class="ident" id="4933804">state</span><span class="op" id="4933809">.</span><span class="ident" id="4933810">sendZero</span>&nbsp;<span class="op" id="4933819">&amp;&amp;</span>&nbsp;<span class="ident" id="4933822">isZero</span><span class="op" id="4933828">(</span><span class="ident" id="4933829">v</span><span class="op" id="4933830">)</span>&nbsp;<span class="op" id="4933832">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933837">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933850">state</span><span class="op" id="4933855">.</span><span class="ident" id="4933856">update</span><span class="op" id="4933862">(</span><span class="ident" id="4933863">i</span><span class="op" id="4933864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4933868">state</span><span class="op" id="4933873">.</span><span class="ident" id="4933874">enc</span><span class="op" id="4933877">.</span><span class="ident" id="4933878">encodeGobEncoder</span><span class="op" id="4933894">(</span><span class="ident" id="4933895">state</span><span class="op" id="4933900">.</span><span class="ident" id="4933901">b</span><span class="op" id="4933902">,</span>&nbsp;<span class="ident" id="4933904">ut</span><span class="op" id="4933906">,</span>&nbsp;<span class="ident" id="4933908">v</span><span class="op" id="4933909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4933912">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4933915">return</span>&nbsp;<span class="op" id="4933922">&amp;</span><span class="ident" id="4933923">op</span><span class="op" id="4933925">,</span>&nbsp;<span class="builtintype" id="4933927">int</span><span class="op" id="4933930">(</span><span class="ident" id="4933931">ut</span><span class="op" id="4933933">.</span><span class="ident" id="4933934">encIndir</span><span class="op" id="4933942">)</span>&nbsp;<span class="comment" id="4933944">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="4934007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4934010">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4934064">func</span>&nbsp;<span class="ident" id="4934069">compileEnc</span><span class="op" id="4934079">(</span><span class="ident" id="4934080">ut</span>&nbsp;<span class="op" id="4934083">*</span><span class="ident" id="4934084">userTypeInfo</span><span class="op" id="4934096">,</span>&nbsp;<span class="ident" id="4934098">building</span>&nbsp;<span class="keyword" id="4934107">map</span><span class="op" id="4934110">[</span><span class="op" id="4934111">*</span><span class="ident" id="4934112">typeInfo</span><span class="op" id="4934120">]</span><span class="builtintype" id="4934121">bool</span><span class="op" id="4934125">)</span>&nbsp;<span class="op" id="4934127">*</span><span class="ident" id="4934128">encEngine</span>&nbsp;<span class="op" id="4934138">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934141">srt</span>&nbsp;<span class="op" id="4934145">:=</span>&nbsp;<span class="ident" id="4934148">ut</span><span class="op" id="4934150">.</span><span class="ident" id="4934151">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934157">engine</span>&nbsp;<span class="op" id="4934164">:=</span>&nbsp;<span class="builtinfunc" id="4934167">new</span><span class="op" id="4934170">(</span><span class="ident" id="4934171">encEngine</span><span class="op" id="4934180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934183">seen</span>&nbsp;<span class="op" id="4934188">:=</span>&nbsp;<span class="builtinfunc" id="4934191">make</span><span class="op" id="4934195">(</span><span class="keyword" id="4934196">map</span><span class="op" id="4934199">[</span><span class="ident" id="4934200">reflect</span><span class="op" id="4934207">.</span><span class="ident" id="4934208">Type</span><span class="op" id="4934212">]</span><span class="op" id="4934213">*</span><span class="ident" id="4934214">encOp</span><span class="op" id="4934219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934222">rt</span>&nbsp;<span class="op" id="4934225">:=</span>&nbsp;<span class="ident" id="4934228">ut</span><span class="op" id="4934230">.</span><span class="ident" id="4934231">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934237">if</span>&nbsp;<span class="ident" id="4934240">ut</span><span class="op" id="4934242">.</span><span class="ident" id="4934243">externalEnc</span>&nbsp;<span class="op" id="4934255">!=</span>&nbsp;<span class="num" id="4934258">0</span>&nbsp;<span class="op" id="4934260">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934264">rt</span>&nbsp;<span class="op" id="4934267">=</span>&nbsp;<span class="ident" id="4934269">ut</span><span class="op" id="4934271">.</span><span class="ident" id="4934272">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934281">if</span>&nbsp;<span class="ident" id="4934284">ut</span><span class="op" id="4934286">.</span><span class="ident" id="4934287">externalEnc</span>&nbsp;<span class="op" id="4934299">==</span>&nbsp;<span class="num" id="4934302">0</span>&nbsp;<span class="op" id="4934304">&amp;&amp;</span>&nbsp;<span class="ident" id="4934307">srt</span><span class="op" id="4934310">.</span><span class="ident" id="4934311">Kind</span><span class="op" id="4934315">(</span><span class="op" id="4934316">)</span>&nbsp;<span class="op" id="4934318">==</span>&nbsp;<span class="ident" id="4934321">reflect</span><span class="op" id="4934328">.</span><span class="ident" id="4934329">Struct</span>&nbsp;<span class="op" id="4934336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934340">for</span>&nbsp;<span class="ident" id="4934344">fieldNum</span><span class="op" id="4934352">,</span>&nbsp;<span class="ident" id="4934354">wireFieldNum</span>&nbsp;<span class="op" id="4934367">:=</span>&nbsp;<span class="num" id="4934370">0</span><span class="op" id="4934371">,</span>&nbsp;<span class="num" id="4934373">0</span><span class="op" id="4934374">;</span>&nbsp;<span class="ident" id="4934376">fieldNum</span>&nbsp;<span class="op" id="4934385">&lt;</span>&nbsp;<span class="ident" id="4934387">srt</span><span class="op" id="4934390">.</span><span class="ident" id="4934391">NumField</span><span class="op" id="4934399">(</span><span class="op" id="4934400">)</span><span class="op" id="4934401">;</span>&nbsp;<span class="ident" id="4934403">fieldNum</span><span class="op" id="4934411">++</span>&nbsp;<span class="op" id="4934414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934419">f</span>&nbsp;<span class="op" id="4934421">:=</span>&nbsp;<span class="ident" id="4934424">srt</span><span class="op" id="4934427">.</span><span class="ident" id="4934428">Field</span><span class="op" id="4934433">(</span><span class="ident" id="4934434">fieldNum</span><span class="op" id="4934442">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934447">if</span>&nbsp;<span class="op" id="4934450">!</span><span class="ident" id="4934451">isSent</span><span class="op" id="4934457">(</span><span class="op" id="4934458">&amp;</span><span class="ident" id="4934459">f</span><span class="op" id="4934460">)</span>&nbsp;<span class="op" id="4934462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934468">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934485">op</span><span class="op" id="4934487">,</span>&nbsp;<span class="ident" id="4934489">indir</span>&nbsp;<span class="op" id="4934495">:=</span>&nbsp;<span class="ident" id="4934498">encOpFor</span><span class="op" id="4934506">(</span><span class="ident" id="4934507">f</span><span class="op" id="4934508">.</span><span class="ident" id="4934509">Type</span><span class="op" id="4934513">,</span>&nbsp;<span class="ident" id="4934515">seen</span><span class="op" id="4934519">,</span>&nbsp;<span class="ident" id="4934521">building</span><span class="op" id="4934529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934534">engine</span><span class="op" id="4934540">.</span><span class="ident" id="4934541">instr</span>&nbsp;<span class="op" id="4934547">=</span>&nbsp;<span class="builtinfunc" id="4934549">append</span><span class="op" id="4934555">(</span><span class="ident" id="4934556">engine</span><span class="op" id="4934562">.</span><span class="ident" id="4934563">instr</span><span class="op" id="4934568">,</span>&nbsp;<span class="ident" id="4934570">encInstr</span><span class="op" id="4934578">{</span><span class="op" id="4934579">*</span><span class="ident" id="4934580">op</span><span class="op" id="4934582">,</span>&nbsp;<span class="ident" id="4934584">wireFieldNum</span><span class="op" id="4934596">,</span>&nbsp;<span class="ident" id="4934598">f</span><span class="op" id="4934599">.</span><span class="ident" id="4934600">Index</span><span class="op" id="4934605">,</span>&nbsp;<span class="ident" id="4934607">indir</span><span class="op" id="4934612">}</span><span class="op" id="4934613">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934618">wireFieldNum</span><span class="op" id="4934630">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934639">if</span>&nbsp;<span class="ident" id="4934642">srt</span><span class="op" id="4934645">.</span><span class="ident" id="4934646">NumField</span><span class="op" id="4934654">(</span><span class="op" id="4934655">)</span>&nbsp;<span class="op" id="4934657">&gt;</span>&nbsp;<span class="num" id="4934659">0</span>&nbsp;<span class="op" id="4934661">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4934664">len</span><span class="op" id="4934667">(</span><span class="ident" id="4934668">engine</span><span class="op" id="4934674">.</span><span class="ident" id="4934675">instr</span><span class="op" id="4934680">)</span>&nbsp;<span class="op" id="4934682">==</span>&nbsp;<span class="num" id="4934685">0</span>&nbsp;<span class="op" id="4934687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934692">errorf</span><span class="op" id="4934698">(</span><span class="string" id="4934699">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="4934731">,</span>&nbsp;<span class="ident" id="4934733">rt</span><span class="op" id="4934735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934739">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934743">engine</span><span class="op" id="4934749">.</span><span class="ident" id="4934750">instr</span>&nbsp;<span class="op" id="4934756">=</span>&nbsp;<span class="builtinfunc" id="4934758">append</span><span class="op" id="4934764">(</span><span class="ident" id="4934765">engine</span><span class="op" id="4934771">.</span><span class="ident" id="4934772">instr</span><span class="op" id="4934777">,</span>&nbsp;<span class="ident" id="4934779">encInstr</span><span class="op" id="4934787">{</span><span class="ident" id="4934788">encStructTerminator</span><span class="op" id="4934807">,</span>&nbsp;<span class="num" id="4934809">0</span><span class="op" id="4934810">,</span>&nbsp;<span class="ident" id="4934812">nil</span><span class="op" id="4934815">,</span>&nbsp;<span class="num" id="4934817">0</span><span class="op" id="4934818">}</span><span class="op" id="4934819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934822">}</span>&nbsp;<span class="keyword" id="4934824">else</span>&nbsp;<span class="op" id="4934829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934833">engine</span><span class="op" id="4934839">.</span><span class="ident" id="4934840">instr</span>&nbsp;<span class="op" id="4934846">=</span>&nbsp;<span class="builtinfunc" id="4934848">make</span><span class="op" id="4934852">(</span><span class="op" id="4934853">[</span><span class="op" id="4934854">]</span><span class="ident" id="4934855">encInstr</span><span class="op" id="4934863">,</span>&nbsp;<span class="num" id="4934865">1</span><span class="op" id="4934866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934870">op</span><span class="op" id="4934872">,</span>&nbsp;<span class="ident" id="4934874">indir</span>&nbsp;<span class="op" id="4934880">:=</span>&nbsp;<span class="ident" id="4934883">encOpFor</span><span class="op" id="4934891">(</span><span class="ident" id="4934892">rt</span><span class="op" id="4934894">,</span>&nbsp;<span class="ident" id="4934896">seen</span><span class="op" id="4934900">,</span>&nbsp;<span class="ident" id="4934902">building</span><span class="op" id="4934910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4934914">engine</span><span class="op" id="4934920">.</span><span class="ident" id="4934921">instr</span><span class="op" id="4934926">[</span><span class="num" id="4934927">0</span><span class="op" id="4934928">]</span>&nbsp;<span class="op" id="4934930">=</span>&nbsp;<span class="ident" id="4934932">encInstr</span><span class="op" id="4934940">{</span><span class="op" id="4934941">*</span><span class="ident" id="4934942">op</span><span class="op" id="4934944">,</span>&nbsp;<span class="ident" id="4934946">singletonField</span><span class="op" id="4934960">,</span>&nbsp;<span class="ident" id="4934962">nil</span><span class="op" id="4934965">,</span>&nbsp;<span class="ident" id="4934967">indir</span><span class="op" id="4934972">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4934975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4934978">return</span>&nbsp;<span class="ident" id="4934985">engine</span><br>
<span class="lineno"></span><span class="op" id="4934992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4934995">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="4935051">func</span>&nbsp;<span class="ident" id="4935056">getEncEngine</span><span class="op" id="4935068">(</span><span class="ident" id="4935069">ut</span>&nbsp;<span class="op" id="4935072">*</span><span class="ident" id="4935073">userTypeInfo</span><span class="op" id="4935085">,</span>&nbsp;<span class="ident" id="4935087">building</span>&nbsp;<span class="keyword" id="4935096">map</span><span class="op" id="4935099">[</span><span class="op" id="4935100">*</span><span class="ident" id="4935101">typeInfo</span><span class="op" id="4935109">]</span><span class="builtintype" id="4935110">bool</span><span class="op" id="4935114">)</span>&nbsp;<span class="op" id="4935116">*</span><span class="ident" id="4935117">encEngine</span>&nbsp;<span class="op" id="4935127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935130">info</span><span class="op" id="4935134">,</span>&nbsp;<span class="ident" id="4935136">err</span>&nbsp;<span class="op" id="4935140">:=</span>&nbsp;<span class="ident" id="4935143">getTypeInfo</span><span class="op" id="4935154">(</span><span class="ident" id="4935155">ut</span><span class="op" id="4935157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935160">if</span>&nbsp;<span class="ident" id="4935163">err</span>&nbsp;<span class="op" id="4935167">!=</span>&nbsp;<span class="ident" id="4935170">nil</span>&nbsp;<span class="op" id="4935174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935178">error_</span><span class="op" id="4935184">(</span><span class="ident" id="4935185">err</span><span class="op" id="4935188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935191">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935194">enc</span><span class="op" id="4935197">,</span>&nbsp;<span class="ident" id="4935199">ok</span>&nbsp;<span class="op" id="4935202">:=</span>&nbsp;<span class="ident" id="4935205">info</span><span class="op" id="4935209">.</span><span class="ident" id="4935210">encoder</span><span class="op" id="4935217">.</span><span class="ident" id="4935218">Load</span><span class="op" id="4935222">(</span><span class="op" id="4935223">)</span><span class="op" id="4935224">.</span><span class="op" id="4935225">(</span><span class="op" id="4935226">*</span><span class="ident" id="4935227">encEngine</span><span class="op" id="4935236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935239">if</span>&nbsp;<span class="op" id="4935242">!</span><span class="ident" id="4935243">ok</span>&nbsp;<span class="op" id="4935246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935250">enc</span>&nbsp;<span class="op" id="4935254">=</span>&nbsp;<span class="ident" id="4935256">buildEncEngine</span><span class="op" id="4935270">(</span><span class="ident" id="4935271">info</span><span class="op" id="4935275">,</span>&nbsp;<span class="ident" id="4935277">ut</span><span class="op" id="4935279">,</span>&nbsp;<span class="ident" id="4935281">building</span><span class="op" id="4935289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935295">return</span>&nbsp;<span class="ident" id="4935302">enc</span><br>
<span class="lineno">660</span><span class="op" id="4935306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4935309">func</span>&nbsp;<span class="ident" id="4935314">buildEncEngine</span><span class="op" id="4935328">(</span><span class="ident" id="4935329">info</span>&nbsp;<span class="op" id="4935334">*</span><span class="ident" id="4935335">typeInfo</span><span class="op" id="4935343">,</span>&nbsp;<span class="ident" id="4935345">ut</span>&nbsp;<span class="op" id="4935348">*</span><span class="ident" id="4935349">userTypeInfo</span><span class="op" id="4935361">,</span>&nbsp;<span class="ident" id="4935363">building</span>&nbsp;<span class="keyword" id="4935372">map</span><span class="op" id="4935375">[</span><span class="op" id="4935376">*</span><span class="ident" id="4935377">typeInfo</span><span class="op" id="4935385">]</span><span class="builtintype" id="4935386">bool</span><span class="op" id="4935390">)</span>&nbsp;<span class="op" id="4935392">*</span><span class="ident" id="4935393">encEngine</span>&nbsp;<span class="op" id="4935403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4935406">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935437">if</span>&nbsp;<span class="ident" id="4935440">building</span>&nbsp;<span class="op" id="4935449">!=</span>&nbsp;<span class="ident" id="4935452">nil</span>&nbsp;<span class="op" id="4935456">&amp;&amp;</span>&nbsp;<span class="ident" id="4935459">building</span><span class="op" id="4935467">[</span><span class="ident" id="4935468">info</span><span class="op" id="4935472">]</span>&nbsp;<span class="op" id="4935474">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935478">return</span>&nbsp;<span class="ident" id="4935485">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935493">info</span><span class="op" id="4935497">.</span><span class="ident" id="4935498">encInit</span><span class="op" id="4935505">.</span><span class="ident" id="4935506">Lock</span><span class="op" id="4935510">(</span><span class="op" id="4935511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935514">defer</span>&nbsp;<span class="ident" id="4935520">info</span><span class="op" id="4935524">.</span><span class="ident" id="4935525">encInit</span><span class="op" id="4935532">.</span><span class="ident" id="4935533">Unlock</span><span class="op" id="4935539">(</span><span class="op" id="4935540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935543">enc</span><span class="op" id="4935546">,</span>&nbsp;<span class="ident" id="4935548">ok</span>&nbsp;<span class="op" id="4935551">:=</span>&nbsp;<span class="ident" id="4935554">info</span><span class="op" id="4935558">.</span><span class="ident" id="4935559">encoder</span><span class="op" id="4935566">.</span><span class="ident" id="4935567">Load</span><span class="op" id="4935571">(</span><span class="op" id="4935572">)</span><span class="op" id="4935573">.</span><span class="op" id="4935574">(</span><span class="op" id="4935575">*</span><span class="ident" id="4935576">encEngine</span><span class="op" id="4935585">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935588">if</span>&nbsp;<span class="op" id="4935591">!</span><span class="ident" id="4935592">ok</span>&nbsp;<span class="op" id="4935595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935599">if</span>&nbsp;<span class="ident" id="4935602">building</span>&nbsp;<span class="op" id="4935611">==</span>&nbsp;<span class="ident" id="4935614">nil</span>&nbsp;<span class="op" id="4935618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935623">building</span>&nbsp;<span class="op" id="4935632">=</span>&nbsp;<span class="builtinfunc" id="4935634">make</span><span class="op" id="4935638">(</span><span class="keyword" id="4935639">map</span><span class="op" id="4935642">[</span><span class="op" id="4935643">*</span><span class="ident" id="4935644">typeInfo</span><span class="op" id="4935652">]</span><span class="builtintype" id="4935653">bool</span><span class="op" id="4935657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935665">building</span><span class="op" id="4935673">[</span><span class="ident" id="4935674">info</span><span class="op" id="4935678">]</span>&nbsp;<span class="op" id="4935680">=</span>&nbsp;<span class="builtintype" id="4935682">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935689">enc</span>&nbsp;<span class="op" id="4935693">=</span>&nbsp;<span class="ident" id="4935695">compileEnc</span><span class="op" id="4935705">(</span><span class="ident" id="4935706">ut</span><span class="op" id="4935708">,</span>&nbsp;<span class="ident" id="4935710">building</span><span class="op" id="4935718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935722">info</span><span class="op" id="4935726">.</span><span class="ident" id="4935727">encoder</span><span class="op" id="4935734">.</span><span class="ident" id="4935735">Store</span><span class="op" id="4935740">(</span><span class="ident" id="4935741">enc</span><span class="op" id="4935744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935750">return</span>&nbsp;<span class="ident" id="4935757">enc</span><br>
<span class="lineno"></span><span class="op" id="4935761">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4935764">func</span>&nbsp;<span class="op" id="4935769">(</span><span class="ident" id="4935770">enc</span>&nbsp;<span class="op" id="4935774">*</span><span class="ident" id="4935775">Encoder</span><span class="op" id="4935782">)</span>&nbsp;<span class="ident" id="4935784">encode</span><span class="op" id="4935790">(</span><span class="ident" id="4935791">b</span>&nbsp;<span class="op" id="4935793">*</span><span class="ident" id="4935794">encBuffer</span><span class="op" id="4935803">,</span>&nbsp;<span class="ident" id="4935805">value</span>&nbsp;<span class="ident" id="4935811">reflect</span><span class="op" id="4935818">.</span><span class="ident" id="4935819">Value</span><span class="op" id="4935824">,</span>&nbsp;<span class="ident" id="4935826">ut</span>&nbsp;<span class="op" id="4935829">*</span><span class="ident" id="4935830">userTypeInfo</span><span class="op" id="4935842">)</span>&nbsp;<span class="op" id="4935844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935847">defer</span>&nbsp;<span class="ident" id="4935853">catchError</span><span class="op" id="4935863">(</span><span class="op" id="4935864">&amp;</span><span class="ident" id="4935865">enc</span><span class="op" id="4935868">.</span><span class="ident" id="4935869">err</span><span class="op" id="4935872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935875">engine</span>&nbsp;<span class="op" id="4935882">:=</span>&nbsp;<span class="ident" id="4935885">getEncEngine</span><span class="op" id="4935897">(</span><span class="ident" id="4935898">ut</span><span class="op" id="4935900">,</span>&nbsp;<span class="ident" id="4935902">nil</span><span class="op" id="4935905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935908">indir</span>&nbsp;<span class="op" id="4935914">:=</span>&nbsp;<span class="ident" id="4935917">ut</span><span class="op" id="4935919">.</span><span class="ident" id="4935920">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935927">if</span>&nbsp;<span class="ident" id="4935930">ut</span><span class="op" id="4935932">.</span><span class="ident" id="4935933">externalEnc</span>&nbsp;<span class="op" id="4935945">!=</span>&nbsp;<span class="num" id="4935948">0</span>&nbsp;<span class="op" id="4935950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4935954">indir</span>&nbsp;<span class="op" id="4935960">=</span>&nbsp;<span class="builtintype" id="4935962">int</span><span class="op" id="4935965">(</span><span class="ident" id="4935966">ut</span><span class="op" id="4935968">.</span><span class="ident" id="4935969">encIndir</span><span class="op" id="4935977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4935980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4935983">for</span>&nbsp;<span class="ident" id="4935987">i</span>&nbsp;<span class="op" id="4935989">:=</span>&nbsp;<span class="num" id="4935992">0</span><span class="op" id="4935993">;</span>&nbsp;<span class="ident" id="4935995">i</span>&nbsp;<span class="op" id="4935997">&lt;</span>&nbsp;<span class="ident" id="4935999">indir</span><span class="op" id="4936004">;</span>&nbsp;<span class="ident" id="4936006">i</span><span class="op" id="4936007">++</span>&nbsp;<span class="op" id="4936010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936014">value</span>&nbsp;<span class="op" id="4936020">=</span>&nbsp;<span class="ident" id="4936022">reflect</span><span class="op" id="4936029">.</span><span class="ident" id="4936030">Indirect</span><span class="op" id="4936038">(</span><span class="ident" id="4936039">value</span><span class="op" id="4936044">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4936050">if</span>&nbsp;<span class="ident" id="4936053">ut</span><span class="op" id="4936055">.</span><span class="ident" id="4936056">externalEnc</span>&nbsp;<span class="op" id="4936068">==</span>&nbsp;<span class="num" id="4936071">0</span>&nbsp;<span class="op" id="4936073">&amp;&amp;</span>&nbsp;<span class="ident" id="4936076">value</span><span class="op" id="4936081">.</span><span class="ident" id="4936082">Type</span><span class="op" id="4936086">(</span><span class="op" id="4936087">)</span><span class="op" id="4936088">.</span><span class="ident" id="4936089">Kind</span><span class="op" id="4936093">(</span><span class="op" id="4936094">)</span>&nbsp;<span class="op" id="4936096">==</span>&nbsp;<span class="ident" id="4936099">reflect</span><span class="op" id="4936106">.</span><span class="ident" id="4936107">Struct</span>&nbsp;<span class="op" id="4936114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936118">enc</span><span class="op" id="4936121">.</span><span class="ident" id="4936122">encodeStruct</span><span class="op" id="4936134">(</span><span class="ident" id="4936135">b</span><span class="op" id="4936136">,</span>&nbsp;<span class="ident" id="4936138">engine</span><span class="op" id="4936144">,</span>&nbsp;<span class="ident" id="4936146">value</span><span class="op" id="4936151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936154">}</span>&nbsp;<span class="keyword" id="4936156">else</span>&nbsp;<span class="op" id="4936161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4936165">enc</span><span class="op" id="4936168">.</span><span class="ident" id="4936169">encodeSingle</span><span class="op" id="4936181">(</span><span class="ident" id="4936182">b</span><span class="op" id="4936183">,</span>&nbsp;<span class="ident" id="4936185">engine</span><span class="op" id="4936191">,</span>&nbsp;<span class="ident" id="4936193">value</span><span class="op" id="4936198">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4936201">}</span><br>
<span class="lineno"></span><span class="op" id="4936203">}</span>
</div>
</body>
</html>
