<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html" class="current">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3427209">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3427265">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3427319">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3427370">package</span>&nbsp;<span class="ident" id="3427378">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3427384">import</span>&nbsp;<span class="op" id="3427391">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3427394">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3427404">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3427410">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3427421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3427424">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3427499">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3427576">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3427655">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3427734">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3427758">var</span>&nbsp;<span class="ident" id="3427762">smallPrimes</span>&nbsp;<span class="op" id="3427774">=</span>&nbsp;<span class="op" id="3427776">[</span><span class="op" id="3427777">]</span><span class="builtintype" id="3427778">uint8</span><span class="op" id="3427783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3427786">3</span><span class="op" id="3427787">,</span>&nbsp;<span class="num" id="3427789">5</span><span class="op" id="3427790">,</span>&nbsp;<span class="num" id="3427792">7</span><span class="op" id="3427793">,</span>&nbsp;<span class="num" id="3427795">11</span><span class="op" id="3427797">,</span>&nbsp;<span class="num" id="3427799">13</span><span class="op" id="3427801">,</span>&nbsp;<span class="num" id="3427803">17</span><span class="op" id="3427805">,</span>&nbsp;<span class="num" id="3427807">19</span><span class="op" id="3427809">,</span>&nbsp;<span class="num" id="3427811">23</span><span class="op" id="3427813">,</span>&nbsp;<span class="num" id="3427815">29</span><span class="op" id="3427817">,</span>&nbsp;<span class="num" id="3427819">31</span><span class="op" id="3427821">,</span>&nbsp;<span class="num" id="3427823">37</span><span class="op" id="3427825">,</span>&nbsp;<span class="num" id="3427827">41</span><span class="op" id="3427829">,</span>&nbsp;<span class="num" id="3427831">43</span><span class="op" id="3427833">,</span>&nbsp;<span class="num" id="3427835">47</span><span class="op" id="3427837">,</span>&nbsp;<span class="num" id="3427839">53</span><span class="op" id="3427841">,</span><br>
<span class="lineno">20</span><span class="op" id="3427843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3427846">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3427926">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3428004">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3428074">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3428089">var</span>&nbsp;<span class="ident" id="3428093">smallPrimesProduct</span>&nbsp;<span class="op" id="3428112">=</span>&nbsp;<span class="builtinfunc" id="3428114">new</span><span class="op" id="3428117">(</span><span class="ident" id="3428118">big</span><span class="op" id="3428121">.</span><span class="ident" id="3428122">Int</span><span class="op" id="3428125">)</span><span class="op" id="3428126">.</span><span class="ident" id="3428127">SetUint64</span><span class="op" id="3428136">(</span><span class="num" id="3428137">16294579238595022365</span><span class="op" id="3428157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3428160">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3428230">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3428256">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3428335">func</span>&nbsp;<span class="ident" id="3428340">Prime</span><span class="op" id="3428345">(</span><span class="ident" id="3428346">rand</span>&nbsp;<span class="ident" id="3428351">io</span><span class="op" id="3428353">.</span><span class="ident" id="3428354">Reader</span><span class="op" id="3428360">,</span>&nbsp;<span class="ident" id="3428362">bits</span>&nbsp;<span class="builtintype" id="3428367">int</span><span class="op" id="3428370">)</span>&nbsp;<span class="op" id="3428372">(</span><span class="ident" id="3428373">p</span>&nbsp;<span class="op" id="3428375">*</span><span class="ident" id="3428376">big</span><span class="op" id="3428379">.</span><span class="ident" id="3428380">Int</span><span class="op" id="3428383">,</span>&nbsp;<span class="ident" id="3428385">err</span>&nbsp;<span class="builtintype" id="3428389">error</span><span class="op" id="3428394">)</span>&nbsp;<span class="op" id="3428396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428399">if</span>&nbsp;<span class="ident" id="3428402">bits</span>&nbsp;<span class="op" id="3428407">&lt;</span>&nbsp;<span class="num" id="3428409">2</span>&nbsp;<span class="op" id="3428411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428415">err</span>&nbsp;<span class="op" id="3428419">=</span>&nbsp;<span class="ident" id="3428421">errors</span><span class="op" id="3428427">.</span><span class="ident" id="3428428">New</span><span class="op" id="3428431">(</span><span class="string" id="3428432">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3428480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428484">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428496">b</span>&nbsp;<span class="op" id="3428498">:=</span>&nbsp;<span class="builtintype" id="3428501">uint</span><span class="op" id="3428505">(</span><span class="ident" id="3428506">bits</span>&nbsp;<span class="op" id="3428511">%</span>&nbsp;<span class="num" id="3428513">8</span><span class="op" id="3428514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428517">if</span>&nbsp;<span class="ident" id="3428520">b</span>&nbsp;<span class="op" id="3428522">==</span>&nbsp;<span class="num" id="3428525">0</span>&nbsp;<span class="op" id="3428527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428531">b</span>&nbsp;<span class="op" id="3428533">=</span>&nbsp;<span class="num" id="3428535">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428542">bytes</span>&nbsp;<span class="op" id="3428548">:=</span>&nbsp;<span class="builtinfunc" id="3428551">make</span><span class="op" id="3428555">(</span><span class="op" id="3428556">[</span><span class="op" id="3428557">]</span><span class="builtintype" id="3428558">byte</span><span class="op" id="3428562">,</span>&nbsp;<span class="op" id="3428564">(</span><span class="ident" id="3428565">bits</span><span class="op" id="3428569">+</span><span class="num" id="3428570">7</span><span class="op" id="3428571">)</span><span class="op" id="3428572">/</span><span class="num" id="3428573">8</span><span class="op" id="3428574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428577">p</span>&nbsp;<span class="op" id="3428579">=</span>&nbsp;<span class="builtinfunc" id="3428581">new</span><span class="op" id="3428584">(</span><span class="ident" id="3428585">big</span><span class="op" id="3428588">.</span><span class="ident" id="3428589">Int</span><span class="op" id="3428592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428596">bigMod</span>&nbsp;<span class="op" id="3428603">:=</span>&nbsp;<span class="builtinfunc" id="3428606">new</span><span class="op" id="3428609">(</span><span class="ident" id="3428610">big</span><span class="op" id="3428613">.</span><span class="ident" id="3428614">Int</span><span class="op" id="3428617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428621">for</span>&nbsp;<span class="op" id="3428625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428629">_</span><span class="op" id="3428630">,</span>&nbsp;<span class="ident" id="3428632">err</span>&nbsp;<span class="op" id="3428636">=</span>&nbsp;<span class="ident" id="3428638">io</span><span class="op" id="3428640">.</span><span class="ident" id="3428641">ReadFull</span><span class="op" id="3428649">(</span><span class="ident" id="3428650">rand</span><span class="op" id="3428654">,</span>&nbsp;<span class="ident" id="3428656">bytes</span><span class="op" id="3428661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428665">if</span>&nbsp;<span class="ident" id="3428668">err</span>&nbsp;<span class="op" id="3428672">!=</span>&nbsp;<span class="ident" id="3428675">nil</span>&nbsp;<span class="op" id="3428679">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428684">return</span>&nbsp;<span class="ident" id="3428691">nil</span><span class="op" id="3428694">,</span>&nbsp;<span class="ident" id="3428696">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3428702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428707">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428788">bytes</span><span class="op" id="3428793">[</span><span class="num" id="3428794">0</span><span class="op" id="3428795">]</span>&nbsp;<span class="op" id="3428797">&amp;=</span>&nbsp;<span class="builtintype" id="3428800">uint8</span><span class="op" id="3428805">(</span><span class="builtintype" id="3428806">int</span><span class="op" id="3428809">(</span><span class="num" id="3428810">1</span><span class="op" id="3428811">&lt;&lt;</span><span class="ident" id="3428813">b</span><span class="op" id="3428814">)</span>&nbsp;<span class="op" id="3428816">-</span>&nbsp;<span class="num" id="3428818">1</span><span class="op" id="3428819">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428823">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428902">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428963">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429029">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429071">if</span>&nbsp;<span class="ident" id="3429074">b</span>&nbsp;<span class="op" id="3429076">&gt;=</span>&nbsp;<span class="num" id="3429079">2</span>&nbsp;<span class="op" id="3429081">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429086">bytes</span><span class="op" id="3429091">[</span><span class="num" id="3429092">0</span><span class="op" id="3429093">]</span>&nbsp;<span class="op" id="3429095">|=</span>&nbsp;<span class="num" id="3429098">3</span>&nbsp;<span class="op" id="3429100">&lt;&lt;</span>&nbsp;<span class="op" id="3429103">(</span><span class="ident" id="3429104">b</span>&nbsp;<span class="op" id="3429106">-</span>&nbsp;<span class="num" id="3429108">2</span><span class="op" id="3429109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429113">}</span>&nbsp;<span class="keyword" id="3429115">else</span>&nbsp;<span class="op" id="3429120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429125">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429168">bytes</span><span class="op" id="3429173">[</span><span class="num" id="3429174">0</span><span class="op" id="3429175">]</span>&nbsp;<span class="op" id="3429177">|=</span>&nbsp;<span class="num" id="3429180">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429185">if</span>&nbsp;<span class="builtinfunc" id="3429188">len</span><span class="op" id="3429191">(</span><span class="ident" id="3429192">bytes</span><span class="op" id="3429197">)</span>&nbsp;<span class="op" id="3429199">&gt;</span>&nbsp;<span class="num" id="3429201">1</span>&nbsp;<span class="op" id="3429203">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429209">bytes</span><span class="op" id="3429214">[</span><span class="num" id="3429215">1</span><span class="op" id="3429216">]</span>&nbsp;<span class="op" id="3429218">|=</span>&nbsp;<span class="num" id="3429221">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429237">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429316">bytes</span><span class="op" id="3429321">[</span><span class="builtinfunc" id="3429322">len</span><span class="op" id="3429325">(</span><span class="ident" id="3429326">bytes</span><span class="op" id="3429331">)</span><span class="op" id="3429332">-</span><span class="num" id="3429333">1</span><span class="op" id="3429334">]</span>&nbsp;<span class="op" id="3429336">|=</span>&nbsp;<span class="num" id="3429339">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429344">p</span><span class="op" id="3429345">.</span><span class="ident" id="3429346">SetBytes</span><span class="op" id="3429354">(</span><span class="ident" id="3429355">bytes</span><span class="op" id="3429360">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429365">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429431">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429497">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429563">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429627">bigMod</span><span class="op" id="3429633">.</span><span class="ident" id="3429634">Mod</span><span class="op" id="3429637">(</span><span class="ident" id="3429638">p</span><span class="op" id="3429639">,</span>&nbsp;<span class="ident" id="3429641">smallPrimesProduct</span><span class="op" id="3429659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429663">mod</span>&nbsp;<span class="op" id="3429667">:=</span>&nbsp;<span class="ident" id="3429670">bigMod</span><span class="op" id="3429676">.</span><span class="ident" id="3429677">Uint64</span><span class="op" id="3429683">(</span><span class="op" id="3429684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429688">NextDelta</span><span class="op" id="3429697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429701">for</span>&nbsp;<span class="ident" id="3429705">delta</span>&nbsp;<span class="op" id="3429711">:=</span>&nbsp;<span class="ident" id="3429714">uint64</span><span class="op" id="3429720">(</span><span class="num" id="3429721">0</span><span class="op" id="3429722">)</span><span class="op" id="3429723">;</span>&nbsp;<span class="ident" id="3429725">delta</span>&nbsp;<span class="op" id="3429731">&lt;</span>&nbsp;<span class="num" id="3429733">1</span><span class="op" id="3429734">&lt;&lt;</span><span class="num" id="3429736">20</span><span class="op" id="3429738">;</span>&nbsp;<span class="ident" id="3429740">delta</span>&nbsp;<span class="op" id="3429746">+=</span>&nbsp;<span class="num" id="3429749">2</span>&nbsp;<span class="op" id="3429751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429756">m</span>&nbsp;<span class="op" id="3429758">:=</span>&nbsp;<span class="ident" id="3429761">mod</span>&nbsp;<span class="op" id="3429765">+</span>&nbsp;<span class="ident" id="3429767">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429776">for</span>&nbsp;<span class="ident" id="3429780">_</span><span class="op" id="3429781">,</span>&nbsp;<span class="ident" id="3429783">prime</span>&nbsp;<span class="op" id="3429789">:=</span>&nbsp;<span class="keyword" id="3429792">range</span>&nbsp;<span class="ident" id="3429798">smallPrimes</span>&nbsp;<span class="op" id="3429810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429816">if</span>&nbsp;<span class="ident" id="3429819">m</span><span class="op" id="3429820">%</span><span class="ident" id="3429821">uint64</span><span class="op" id="3429827">(</span><span class="ident" id="3429828">prime</span><span class="op" id="3429833">)</span>&nbsp;<span class="op" id="3429835">==</span>&nbsp;<span class="num" id="3429838">0</span>&nbsp;<span class="op" id="3429840">&amp;&amp;</span>&nbsp;<span class="op" id="3429843">(</span><span class="ident" id="3429844">bits</span>&nbsp;<span class="op" id="3429849">&gt;</span>&nbsp;<span class="num" id="3429851">6</span>&nbsp;<span class="op" id="3429853">||</span>&nbsp;<span class="ident" id="3429856">m</span>&nbsp;<span class="op" id="3429858">!=</span>&nbsp;<span class="ident" id="3429861">uint64</span><span class="op" id="3429867">(</span><span class="ident" id="3429868">prime</span><span class="op" id="3429873">)</span><span class="op" id="3429874">)</span>&nbsp;<span class="op" id="3429876">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429883">continue</span>&nbsp;<span class="ident" id="3429892">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429917">if</span>&nbsp;<span class="ident" id="3429920">delta</span>&nbsp;<span class="op" id="3429926">&gt;</span>&nbsp;<span class="num" id="3429928">0</span>&nbsp;<span class="op" id="3429930">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429936">bigMod</span><span class="op" id="3429942">.</span><span class="ident" id="3429943">SetUint64</span><span class="op" id="3429952">(</span><span class="ident" id="3429953">delta</span><span class="op" id="3429958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429964">p</span><span class="op" id="3429965">.</span><span class="ident" id="3429966">Add</span><span class="op" id="3429969">(</span><span class="ident" id="3429970">p</span><span class="op" id="3429971">,</span>&nbsp;<span class="ident" id="3429973">bigMod</span><span class="op" id="3429979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429989">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429997">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430002">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430068">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430129">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430140">if</span>&nbsp;<span class="ident" id="3430143">p</span><span class="op" id="3430144">.</span><span class="ident" id="3430145">ProbablyPrime</span><span class="op" id="3430158">(</span><span class="num" id="3430159">20</span><span class="op" id="3430161">)</span>&nbsp;<span class="op" id="3430163">&amp;&amp;</span>&nbsp;<span class="ident" id="3430166">p</span><span class="op" id="3430167">.</span><span class="ident" id="3430168">BitLen</span><span class="op" id="3430174">(</span><span class="op" id="3430175">)</span>&nbsp;<span class="op" id="3430177">==</span>&nbsp;<span class="ident" id="3430180">bits</span>&nbsp;<span class="op" id="3430185">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430190">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430202">}</span><br>
<span class="lineno"></span><span class="op" id="3430204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3430207">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3430281">func</span>&nbsp;<span class="ident" id="3430286">Int</span><span class="op" id="3430289">(</span><span class="ident" id="3430290">rand</span>&nbsp;<span class="ident" id="3430295">io</span><span class="op" id="3430297">.</span><span class="ident" id="3430298">Reader</span><span class="op" id="3430304">,</span>&nbsp;<span class="ident" id="3430306">max</span>&nbsp;<span class="op" id="3430310">*</span><span class="ident" id="3430311">big</span><span class="op" id="3430314">.</span><span class="ident" id="3430315">Int</span><span class="op" id="3430318">)</span>&nbsp;<span class="op" id="3430320">(</span><span class="ident" id="3430321">n</span>&nbsp;<span class="op" id="3430323">*</span><span class="ident" id="3430324">big</span><span class="op" id="3430327">.</span><span class="ident" id="3430328">Int</span><span class="op" id="3430331">,</span>&nbsp;<span class="ident" id="3430333">err</span>&nbsp;<span class="builtintype" id="3430337">error</span><span class="op" id="3430342">)</span>&nbsp;<span class="op" id="3430344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430347">if</span>&nbsp;<span class="ident" id="3430350">max</span><span class="op" id="3430353">.</span><span class="ident" id="3430354">Sign</span><span class="op" id="3430358">(</span><span class="op" id="3430359">)</span>&nbsp;<span class="op" id="3430361">&lt;=</span>&nbsp;<span class="num" id="3430364">0</span>&nbsp;<span class="op" id="3430366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3430370">panic</span><span class="op" id="3430375">(</span><span class="string" id="3430376">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3430414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430417">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430420">k</span>&nbsp;<span class="op" id="3430422">:=</span>&nbsp;<span class="op" id="3430425">(</span><span class="ident" id="3430426">max</span><span class="op" id="3430429">.</span><span class="ident" id="3430430">BitLen</span><span class="op" id="3430436">(</span><span class="op" id="3430437">)</span>&nbsp;<span class="op" id="3430439">+</span>&nbsp;<span class="num" id="3430441">7</span><span class="op" id="3430442">)</span>&nbsp;<span class="op" id="3430444">/</span>&nbsp;<span class="num" id="3430446">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430450">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430515">b</span>&nbsp;<span class="op" id="3430517">:=</span>&nbsp;<span class="builtintype" id="3430520">uint</span><span class="op" id="3430524">(</span><span class="ident" id="3430525">max</span><span class="op" id="3430528">.</span><span class="ident" id="3430529">BitLen</span><span class="op" id="3430535">(</span><span class="op" id="3430536">)</span>&nbsp;<span class="op" id="3430538">%</span>&nbsp;<span class="num" id="3430540">8</span><span class="op" id="3430541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430544">if</span>&nbsp;<span class="ident" id="3430547">b</span>&nbsp;<span class="op" id="3430549">==</span>&nbsp;<span class="num" id="3430552">0</span>&nbsp;<span class="op" id="3430554">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430558">b</span>&nbsp;<span class="op" id="3430560">=</span>&nbsp;<span class="num" id="3430562">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430569">bytes</span>&nbsp;<span class="op" id="3430575">:=</span>&nbsp;<span class="builtinfunc" id="3430578">make</span><span class="op" id="3430582">(</span><span class="op" id="3430583">[</span><span class="op" id="3430584">]</span><span class="builtintype" id="3430585">byte</span><span class="op" id="3430589">,</span>&nbsp;<span class="ident" id="3430591">k</span><span class="op" id="3430592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430595">n</span>&nbsp;<span class="op" id="3430597">=</span>&nbsp;<span class="builtinfunc" id="3430599">new</span><span class="op" id="3430602">(</span><span class="ident" id="3430603">big</span><span class="op" id="3430606">.</span><span class="ident" id="3430607">Int</span><span class="op" id="3430610">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430614">for</span>&nbsp;<span class="op" id="3430618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430622">_</span><span class="op" id="3430623">,</span>&nbsp;<span class="ident" id="3430625">err</span>&nbsp;<span class="op" id="3430629">=</span>&nbsp;<span class="ident" id="3430631">io</span><span class="op" id="3430633">.</span><span class="ident" id="3430634">ReadFull</span><span class="op" id="3430642">(</span><span class="ident" id="3430643">rand</span><span class="op" id="3430647">,</span>&nbsp;<span class="ident" id="3430649">bytes</span><span class="op" id="3430654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430658">if</span>&nbsp;<span class="ident" id="3430661">err</span>&nbsp;<span class="op" id="3430665">!=</span>&nbsp;<span class="ident" id="3430668">nil</span>&nbsp;<span class="op" id="3430672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430677">return</span>&nbsp;<span class="ident" id="3430684">nil</span><span class="op" id="3430687">,</span>&nbsp;<span class="ident" id="3430689">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430700">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430762">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430796">bytes</span><span class="op" id="3430801">[</span><span class="num" id="3430802">0</span><span class="op" id="3430803">]</span>&nbsp;<span class="op" id="3430805">&amp;=</span>&nbsp;<span class="builtintype" id="3430808">uint8</span><span class="op" id="3430813">(</span><span class="builtintype" id="3430814">int</span><span class="op" id="3430817">(</span><span class="num" id="3430818">1</span><span class="op" id="3430819">&lt;&lt;</span><span class="ident" id="3430821">b</span><span class="op" id="3430822">)</span>&nbsp;<span class="op" id="3430824">-</span>&nbsp;<span class="num" id="3430826">1</span><span class="op" id="3430827">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430832">n</span><span class="op" id="3430833">.</span><span class="ident" id="3430834">SetBytes</span><span class="op" id="3430842">(</span><span class="ident" id="3430843">bytes</span><span class="op" id="3430848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430852">if</span>&nbsp;<span class="ident" id="3430855">n</span><span class="op" id="3430856">.</span><span class="ident" id="3430857">Cmp</span><span class="op" id="3430860">(</span><span class="ident" id="3430861">max</span><span class="op" id="3430864">)</span>&nbsp;<span class="op" id="3430866">&lt;</span>&nbsp;<span class="num" id="3430868">0</span>&nbsp;<span class="op" id="3430870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430875">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430884">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430887">}</span><br>
<span class="lineno"></span><span class="op" id="3430889">}</span>
</div>
</body>
</html>
