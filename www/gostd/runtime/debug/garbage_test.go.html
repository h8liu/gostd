<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7128834">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7128890">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7128944">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7128995">package</span>&nbsp;<span class="ident" id="7129003">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7129010">import</span>&nbsp;<span class="op" id="7129017">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7129020">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7129031">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7129042">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7129049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7129052">func</span>&nbsp;<span class="ident" id="7129057">TestReadGCStats</span><span class="op" id="7129072">(</span><span class="ident" id="7129073">t</span>&nbsp;<span class="op" id="7129075">*</span><span class="ident" id="7129076">testing</span><span class="op" id="7129083">.</span><span class="ident" id="7129084">T</span><span class="op" id="7129085">)</span>&nbsp;<span class="op" id="7129087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129090">defer</span>&nbsp;<span class="ident" id="7129096">SetGCPercent</span><span class="op" id="7129108">(</span><span class="ident" id="7129109">SetGCPercent</span><span class="op" id="7129121">(</span><span class="op" id="7129122">-</span><span class="num" id="7129123">1</span><span class="op" id="7129124">)</span><span class="op" id="7129125">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129129">var</span>&nbsp;<span class="ident" id="7129133">stats</span>&nbsp;<span class="ident" id="7129139">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129148">var</span>&nbsp;<span class="ident" id="7129152">mstats</span>&nbsp;<span class="ident" id="7129159">runtime</span><span class="op" id="7129166">.</span><span class="ident" id="7129167">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129177">var</span>&nbsp;<span class="ident" id="7129181">min</span><span class="op" id="7129184">,</span>&nbsp;<span class="ident" id="7129186">max</span>&nbsp;<span class="ident" id="7129190">time</span><span class="op" id="7129194">.</span><span class="ident" id="7129195">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7129206">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7129262">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129330">stats</span><span class="op" id="7129335">.</span><span class="ident" id="7129336">PauseQuantiles</span>&nbsp;<span class="op" id="7129351">=</span>&nbsp;<span class="builtinfunc" id="7129353">make</span><span class="op" id="7129357">(</span><span class="op" id="7129358">[</span><span class="op" id="7129359">]</span><span class="ident" id="7129360">time</span><span class="op" id="7129364">.</span><span class="ident" id="7129365">Duration</span><span class="op" id="7129373">,</span>&nbsp;<span class="num" id="7129375">10</span><span class="op" id="7129377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129380">ReadGCStats</span><span class="op" id="7129391">(</span><span class="op" id="7129392">&amp;</span><span class="ident" id="7129393">stats</span><span class="op" id="7129398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129401">runtime</span><span class="op" id="7129408">.</span><span class="ident" id="7129409">GC</span><span class="op" id="7129411">(</span><span class="op" id="7129412">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7129416">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129482">ReadGCStats</span><span class="op" id="7129493">(</span><span class="op" id="7129494">&amp;</span><span class="ident" id="7129495">stats</span><span class="op" id="7129500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129503">runtime</span><span class="op" id="7129510">.</span><span class="ident" id="7129511">ReadMemStats</span><span class="op" id="7129523">(</span><span class="op" id="7129524">&amp;</span><span class="ident" id="7129525">mstats</span><span class="op" id="7129531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129535">if</span>&nbsp;<span class="ident" id="7129538">stats</span><span class="op" id="7129543">.</span><span class="ident" id="7129544">NumGC</span>&nbsp;<span class="op" id="7129550">!=</span>&nbsp;<span class="ident" id="7129553">int64</span><span class="op" id="7129558">(</span><span class="ident" id="7129559">mstats</span><span class="op" id="7129565">.</span><span class="ident" id="7129566">NumGC</span><span class="op" id="7129571">)</span>&nbsp;<span class="op" id="7129573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129577">t</span><span class="op" id="7129578">.</span><span class="ident" id="7129579">Errorf</span><span class="op" id="7129585">(</span><span class="string" id="7129586">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7129627">,</span>&nbsp;<span class="ident" id="7129629">stats</span><span class="op" id="7129634">.</span><span class="ident" id="7129635">NumGC</span><span class="op" id="7129640">,</span>&nbsp;<span class="ident" id="7129642">mstats</span><span class="op" id="7129648">.</span><span class="ident" id="7129649">NumGC</span><span class="op" id="7129654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7129657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129660">if</span>&nbsp;<span class="ident" id="7129663">stats</span><span class="op" id="7129668">.</span><span class="ident" id="7129669">PauseTotal</span>&nbsp;<span class="op" id="7129680">!=</span>&nbsp;<span class="ident" id="7129683">time</span><span class="op" id="7129687">.</span><span class="ident" id="7129688">Duration</span><span class="op" id="7129696">(</span><span class="ident" id="7129697">mstats</span><span class="op" id="7129703">.</span><span class="ident" id="7129704">PauseTotalNs</span><span class="op" id="7129716">)</span>&nbsp;<span class="op" id="7129718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129722">t</span><span class="op" id="7129723">.</span><span class="ident" id="7129724">Errorf</span><span class="op" id="7129730">(</span><span class="string" id="7129731">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7129784">,</span>&nbsp;<span class="ident" id="7129786">stats</span><span class="op" id="7129791">.</span><span class="ident" id="7129792">PauseTotal</span><span class="op" id="7129802">,</span>&nbsp;<span class="ident" id="7129804">mstats</span><span class="op" id="7129810">.</span><span class="ident" id="7129811">PauseTotalNs</span><span class="op" id="7129823">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7129826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7129829">if</span>&nbsp;<span class="ident" id="7129832">stats</span><span class="op" id="7129837">.</span><span class="ident" id="7129838">LastGC</span><span class="op" id="7129844">.</span><span class="ident" id="7129845">UnixNano</span><span class="op" id="7129853">(</span><span class="op" id="7129854">)</span>&nbsp;<span class="op" id="7129856">!=</span>&nbsp;<span class="ident" id="7129859">int64</span><span class="op" id="7129864">(</span><span class="ident" id="7129865">mstats</span><span class="op" id="7129871">.</span><span class="ident" id="7129872">LastGC</span><span class="op" id="7129878">)</span>&nbsp;<span class="op" id="7129880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129884">t</span><span class="op" id="7129885">.</span><span class="ident" id="7129886">Errorf</span><span class="op" id="7129892">(</span><span class="string" id="7129893">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7129945">,</span>&nbsp;<span class="ident" id="7129947">stats</span><span class="op" id="7129952">.</span><span class="ident" id="7129953">LastGC</span><span class="op" id="7129959">.</span><span class="ident" id="7129960">UnixNano</span><span class="op" id="7129968">(</span><span class="op" id="7129969">)</span><span class="op" id="7129970">,</span>&nbsp;<span class="ident" id="7129972">mstats</span><span class="op" id="7129978">.</span><span class="ident" id="7129979">LastGC</span><span class="op" id="7129985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7129988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7129991">n</span>&nbsp;<span class="op" id="7129993">:=</span>&nbsp;<span class="builtintype" id="7129996">int</span><span class="op" id="7129999">(</span><span class="ident" id="7130000">mstats</span><span class="op" id="7130006">.</span><span class="ident" id="7130007">NumGC</span><span class="op" id="7130012">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130015">if</span>&nbsp;<span class="ident" id="7130018">n</span>&nbsp;<span class="op" id="7130020">&gt;</span>&nbsp;<span class="builtinfunc" id="7130022">len</span><span class="op" id="7130025">(</span><span class="ident" id="7130026">mstats</span><span class="op" id="7130032">.</span><span class="ident" id="7130033">PauseNs</span><span class="op" id="7130040">)</span>&nbsp;<span class="op" id="7130042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130046">n</span>&nbsp;<span class="op" id="7130048">=</span>&nbsp;<span class="builtinfunc" id="7130050">len</span><span class="op" id="7130053">(</span><span class="ident" id="7130054">mstats</span><span class="op" id="7130060">.</span><span class="ident" id="7130061">PauseNs</span><span class="op" id="7130068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130074">if</span>&nbsp;<span class="builtinfunc" id="7130077">len</span><span class="op" id="7130080">(</span><span class="ident" id="7130081">stats</span><span class="op" id="7130086">.</span><span class="ident" id="7130087">Pause</span><span class="op" id="7130092">)</span>&nbsp;<span class="op" id="7130094">!=</span>&nbsp;<span class="ident" id="7130097">n</span>&nbsp;<span class="op" id="7130099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130103">t</span><span class="op" id="7130104">.</span><span class="ident" id="7130105">Errorf</span><span class="op" id="7130111">(</span><span class="string" id="7130112">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7130144">,</span>&nbsp;<span class="builtinfunc" id="7130146">len</span><span class="op" id="7130149">(</span><span class="ident" id="7130150">stats</span><span class="op" id="7130155">.</span><span class="ident" id="7130156">Pause</span><span class="op" id="7130161">)</span><span class="op" id="7130162">,</span>&nbsp;<span class="ident" id="7130164">n</span><span class="op" id="7130165">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130168">}</span>&nbsp;<span class="keyword" id="7130170">else</span>&nbsp;<span class="op" id="7130175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130179">off</span>&nbsp;<span class="op" id="7130183">:=</span>&nbsp;<span class="op" id="7130186">(</span><span class="builtintype" id="7130187">int</span><span class="op" id="7130190">(</span><span class="ident" id="7130191">mstats</span><span class="op" id="7130197">.</span><span class="ident" id="7130198">NumGC</span><span class="op" id="7130203">)</span>&nbsp;<span class="op" id="7130205">+</span>&nbsp;<span class="builtinfunc" id="7130207">len</span><span class="op" id="7130210">(</span><span class="ident" id="7130211">mstats</span><span class="op" id="7130217">.</span><span class="ident" id="7130218">PauseNs</span><span class="op" id="7130225">)</span>&nbsp;<span class="op" id="7130227">-</span>&nbsp;<span class="num" id="7130229">1</span><span class="op" id="7130230">)</span>&nbsp;<span class="op" id="7130232">%</span>&nbsp;<span class="builtinfunc" id="7130234">len</span><span class="op" id="7130237">(</span><span class="ident" id="7130238">mstats</span><span class="op" id="7130244">.</span><span class="ident" id="7130245">PauseNs</span><span class="op" id="7130252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130256">for</span>&nbsp;<span class="ident" id="7130260">i</span>&nbsp;<span class="op" id="7130262">:=</span>&nbsp;<span class="num" id="7130265">0</span><span class="op" id="7130266">;</span>&nbsp;<span class="ident" id="7130268">i</span>&nbsp;<span class="op" id="7130270">&lt;</span>&nbsp;<span class="ident" id="7130272">n</span><span class="op" id="7130273">;</span>&nbsp;<span class="ident" id="7130275">i</span><span class="op" id="7130276">++</span>&nbsp;<span class="op" id="7130279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130284">dt</span>&nbsp;<span class="op" id="7130287">:=</span>&nbsp;<span class="ident" id="7130290">stats</span><span class="op" id="7130295">.</span><span class="ident" id="7130296">Pause</span><span class="op" id="7130301">[</span><span class="ident" id="7130302">i</span><span class="op" id="7130303">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130308">if</span>&nbsp;<span class="ident" id="7130311">dt</span>&nbsp;<span class="op" id="7130314">!=</span>&nbsp;<span class="ident" id="7130317">time</span><span class="op" id="7130321">.</span><span class="ident" id="7130322">Duration</span><span class="op" id="7130330">(</span><span class="ident" id="7130331">mstats</span><span class="op" id="7130337">.</span><span class="ident" id="7130338">PauseNs</span><span class="op" id="7130345">[</span><span class="ident" id="7130346">off</span><span class="op" id="7130349">]</span><span class="op" id="7130350">)</span>&nbsp;<span class="op" id="7130352">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130358">t</span><span class="op" id="7130359">.</span><span class="ident" id="7130360">Errorf</span><span class="op" id="7130366">(</span><span class="string" id="7130367">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7130398">,</span>&nbsp;<span class="ident" id="7130400">i</span><span class="op" id="7130401">,</span>&nbsp;<span class="ident" id="7130403">dt</span><span class="op" id="7130405">,</span>&nbsp;<span class="ident" id="7130407">mstats</span><span class="op" id="7130413">.</span><span class="ident" id="7130414">PauseNs</span><span class="op" id="7130421">[</span><span class="ident" id="7130422">off</span><span class="op" id="7130425">]</span><span class="op" id="7130426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130436">if</span>&nbsp;<span class="ident" id="7130439">max</span>&nbsp;<span class="op" id="7130443">&lt;</span>&nbsp;<span class="ident" id="7130445">dt</span>&nbsp;<span class="op" id="7130448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130454">max</span>&nbsp;<span class="op" id="7130458">=</span>&nbsp;<span class="ident" id="7130460">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130466">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130471">if</span>&nbsp;<span class="ident" id="7130474">min</span>&nbsp;<span class="op" id="7130478">&gt;</span>&nbsp;<span class="ident" id="7130480">dt</span>&nbsp;<span class="op" id="7130483">||</span>&nbsp;<span class="ident" id="7130486">i</span>&nbsp;<span class="op" id="7130488">==</span>&nbsp;<span class="num" id="7130491">0</span>&nbsp;<span class="op" id="7130493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130499">min</span>&nbsp;<span class="op" id="7130503">=</span>&nbsp;<span class="ident" id="7130505">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130516">off</span>&nbsp;<span class="op" id="7130520">=</span>&nbsp;<span class="op" id="7130522">(</span><span class="ident" id="7130523">off</span>&nbsp;<span class="op" id="7130527">+</span>&nbsp;<span class="builtinfunc" id="7130529">len</span><span class="op" id="7130532">(</span><span class="ident" id="7130533">mstats</span><span class="op" id="7130539">.</span><span class="ident" id="7130540">PauseNs</span><span class="op" id="7130547">)</span>&nbsp;<span class="op" id="7130549">-</span>&nbsp;<span class="num" id="7130551">1</span><span class="op" id="7130552">)</span>&nbsp;<span class="op" id="7130554">%</span>&nbsp;<span class="builtinfunc" id="7130556">len</span><span class="op" id="7130559">(</span><span class="ident" id="7130560">mstats</span><span class="op" id="7130566">.</span><span class="ident" id="7130567">PauseNs</span><span class="op" id="7130574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130578">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130585">q</span>&nbsp;<span class="op" id="7130587">:=</span>&nbsp;<span class="ident" id="7130590">stats</span><span class="op" id="7130595">.</span><span class="ident" id="7130596">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130612">nq</span>&nbsp;<span class="op" id="7130615">:=</span>&nbsp;<span class="builtinfunc" id="7130618">len</span><span class="op" id="7130621">(</span><span class="ident" id="7130622">q</span><span class="op" id="7130623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130626">if</span>&nbsp;<span class="ident" id="7130629">q</span><span class="op" id="7130630">[</span><span class="num" id="7130631">0</span><span class="op" id="7130632">]</span>&nbsp;<span class="op" id="7130634">!=</span>&nbsp;<span class="ident" id="7130637">min</span>&nbsp;<span class="op" id="7130641">||</span>&nbsp;<span class="ident" id="7130644">q</span><span class="op" id="7130645">[</span><span class="ident" id="7130646">nq</span><span class="op" id="7130648">-</span><span class="num" id="7130649">1</span><span class="op" id="7130650">]</span>&nbsp;<span class="op" id="7130652">!=</span>&nbsp;<span class="ident" id="7130655">max</span>&nbsp;<span class="op" id="7130659">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130663">t</span><span class="op" id="7130664">.</span><span class="ident" id="7130665">Errorf</span><span class="op" id="7130671">(</span><span class="string" id="7130672">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="7130730">,</span>&nbsp;<span class="ident" id="7130732">q</span><span class="op" id="7130733">[</span><span class="num" id="7130734">0</span><span class="op" id="7130735">]</span><span class="op" id="7130736">,</span>&nbsp;<span class="ident" id="7130738">q</span><span class="op" id="7130739">[</span><span class="ident" id="7130740">nq</span><span class="op" id="7130742">-</span><span class="num" id="7130743">1</span><span class="op" id="7130744">]</span><span class="op" id="7130745">,</span>&nbsp;<span class="ident" id="7130747">min</span><span class="op" id="7130750">,</span>&nbsp;<span class="ident" id="7130752">max</span><span class="op" id="7130755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130762">for</span>&nbsp;<span class="ident" id="7130766">i</span>&nbsp;<span class="op" id="7130768">:=</span>&nbsp;<span class="num" id="7130771">0</span><span class="op" id="7130772">;</span>&nbsp;<span class="ident" id="7130774">i</span>&nbsp;<span class="op" id="7130776">&lt;</span>&nbsp;<span class="ident" id="7130778">nq</span><span class="op" id="7130780">-</span><span class="num" id="7130781">1</span><span class="op" id="7130782">;</span>&nbsp;<span class="ident" id="7130784">i</span><span class="op" id="7130785">++</span>&nbsp;<span class="op" id="7130788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130792">if</span>&nbsp;<span class="ident" id="7130795">q</span><span class="op" id="7130796">[</span><span class="ident" id="7130797">i</span><span class="op" id="7130798">]</span>&nbsp;<span class="op" id="7130800">&gt;</span>&nbsp;<span class="ident" id="7130802">q</span><span class="op" id="7130803">[</span><span class="ident" id="7130804">i</span><span class="op" id="7130805">+</span><span class="num" id="7130806">1</span><span class="op" id="7130807">]</span>&nbsp;<span class="op" id="7130809">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130814">t</span><span class="op" id="7130815">.</span><span class="ident" id="7130816">Errorf</span><span class="op" id="7130822">(</span><span class="string" id="7130823">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="7130882">,</span>&nbsp;<span class="ident" id="7130884">i</span><span class="op" id="7130885">,</span>&nbsp;<span class="ident" id="7130887">q</span><span class="op" id="7130888">[</span><span class="ident" id="7130889">i</span><span class="op" id="7130890">]</span><span class="op" id="7130891">,</span>&nbsp;<span class="ident" id="7130893">i</span><span class="op" id="7130894">+</span><span class="num" id="7130895">1</span><span class="op" id="7130896">,</span>&nbsp;<span class="ident" id="7130898">q</span><span class="op" id="7130899">[</span><span class="ident" id="7130900">i</span><span class="op" id="7130901">+</span><span class="num" id="7130902">1</span><span class="op" id="7130903">]</span><span class="op" id="7130904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7130911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7130915">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7130955">if</span>&nbsp;<span class="builtinfunc" id="7130958">len</span><span class="op" id="7130961">(</span><span class="ident" id="7130962">stats</span><span class="op" id="7130967">.</span><span class="ident" id="7130968">PauseEnd</span><span class="op" id="7130976">)</span>&nbsp;<span class="op" id="7130978">!=</span>&nbsp;<span class="ident" id="7130981">n</span>&nbsp;<span class="op" id="7130983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7130987">t</span><span class="op" id="7130988">.</span><span class="ident" id="7130989">Fatalf</span><span class="op" id="7130995">(</span><span class="string" id="7130996">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7131031">,</span>&nbsp;<span class="builtinfunc" id="7131033">len</span><span class="op" id="7131036">(</span><span class="ident" id="7131037">stats</span><span class="op" id="7131042">.</span><span class="ident" id="7131043">PauseEnd</span><span class="op" id="7131051">)</span><span class="op" id="7131052">,</span>&nbsp;<span class="ident" id="7131054">n</span><span class="op" id="7131055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7131058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131061">off</span>&nbsp;<span class="op" id="7131065">:=</span>&nbsp;<span class="op" id="7131068">(</span><span class="builtintype" id="7131069">int</span><span class="op" id="7131072">(</span><span class="ident" id="7131073">mstats</span><span class="op" id="7131079">.</span><span class="ident" id="7131080">NumGC</span><span class="op" id="7131085">)</span>&nbsp;<span class="op" id="7131087">+</span>&nbsp;<span class="builtinfunc" id="7131089">len</span><span class="op" id="7131092">(</span><span class="ident" id="7131093">mstats</span><span class="op" id="7131099">.</span><span class="ident" id="7131100">PauseEnd</span><span class="op" id="7131108">)</span>&nbsp;<span class="op" id="7131110">-</span>&nbsp;<span class="num" id="7131112">1</span><span class="op" id="7131113">)</span>&nbsp;<span class="op" id="7131115">%</span>&nbsp;<span class="builtinfunc" id="7131117">len</span><span class="op" id="7131120">(</span><span class="ident" id="7131121">mstats</span><span class="op" id="7131127">.</span><span class="ident" id="7131128">PauseEnd</span><span class="op" id="7131136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7131139">for</span>&nbsp;<span class="ident" id="7131143">i</span>&nbsp;<span class="op" id="7131145">:=</span>&nbsp;<span class="num" id="7131148">0</span><span class="op" id="7131149">;</span>&nbsp;<span class="ident" id="7131151">i</span>&nbsp;<span class="op" id="7131153">&lt;</span>&nbsp;<span class="ident" id="7131155">n</span><span class="op" id="7131156">;</span>&nbsp;<span class="ident" id="7131158">i</span><span class="op" id="7131159">++</span>&nbsp;<span class="op" id="7131162">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131166">dt</span>&nbsp;<span class="op" id="7131169">:=</span>&nbsp;<span class="ident" id="7131172">stats</span><span class="op" id="7131177">.</span><span class="ident" id="7131178">PauseEnd</span><span class="op" id="7131186">[</span><span class="ident" id="7131187">i</span><span class="op" id="7131188">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7131192">if</span>&nbsp;<span class="ident" id="7131195">dt</span><span class="op" id="7131197">.</span><span class="ident" id="7131198">UnixNano</span><span class="op" id="7131206">(</span><span class="op" id="7131207">)</span>&nbsp;<span class="op" id="7131209">!=</span>&nbsp;<span class="ident" id="7131212">int64</span><span class="op" id="7131217">(</span><span class="ident" id="7131218">mstats</span><span class="op" id="7131224">.</span><span class="ident" id="7131225">PauseEnd</span><span class="op" id="7131233">[</span><span class="ident" id="7131234">off</span><span class="op" id="7131237">]</span><span class="op" id="7131238">)</span>&nbsp;<span class="op" id="7131240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131245">t</span><span class="op" id="7131246">.</span><span class="ident" id="7131247">Errorf</span><span class="op" id="7131253">(</span><span class="string" id="7131254">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7131288">,</span>&nbsp;<span class="ident" id="7131290">i</span><span class="op" id="7131291">,</span>&nbsp;<span class="ident" id="7131293">dt</span><span class="op" id="7131295">,</span>&nbsp;<span class="ident" id="7131297">mstats</span><span class="op" id="7131303">.</span><span class="ident" id="7131304">PauseEnd</span><span class="op" id="7131312">[</span><span class="ident" id="7131313">off</span><span class="op" id="7131316">]</span><span class="op" id="7131317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7131321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131325">off</span>&nbsp;<span class="op" id="7131329">=</span>&nbsp;<span class="op" id="7131331">(</span><span class="ident" id="7131332">off</span>&nbsp;<span class="op" id="7131336">+</span>&nbsp;<span class="builtinfunc" id="7131338">len</span><span class="op" id="7131341">(</span><span class="ident" id="7131342">mstats</span><span class="op" id="7131348">.</span><span class="ident" id="7131349">PauseEnd</span><span class="op" id="7131357">)</span>&nbsp;<span class="op" id="7131359">-</span>&nbsp;<span class="num" id="7131361">1</span><span class="op" id="7131362">)</span>&nbsp;<span class="op" id="7131364">%</span>&nbsp;<span class="builtinfunc" id="7131366">len</span><span class="op" id="7131369">(</span><span class="ident" id="7131370">mstats</span><span class="op" id="7131376">.</span><span class="ident" id="7131377">PauseEnd</span><span class="op" id="7131385">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7131388">}</span><br>
<span class="lineno"></span><span class="op" id="7131390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7131393">var</span>&nbsp;<span class="ident" id="7131397">big</span>&nbsp;<span class="op" id="7131401">=</span>&nbsp;<span class="builtinfunc" id="7131403">make</span><span class="op" id="7131407">(</span><span class="op" id="7131408">[</span><span class="op" id="7131409">]</span><span class="builtintype" id="7131410">byte</span><span class="op" id="7131414">,</span>&nbsp;<span class="num" id="7131416">1</span><span class="op" id="7131417">&lt;&lt;</span><span class="num" id="7131419">20</span><span class="op" id="7131421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="7131424">func</span>&nbsp;<span class="ident" id="7131429">TestFreeOSMemory</span><span class="op" id="7131445">(</span><span class="ident" id="7131446">t</span>&nbsp;<span class="op" id="7131448">*</span><span class="ident" id="7131449">testing</span><span class="op" id="7131456">.</span><span class="ident" id="7131457">T</span><span class="op" id="7131458">)</span>&nbsp;<span class="op" id="7131460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7131463">var</span>&nbsp;<span class="ident" id="7131467">ms1</span><span class="op" id="7131470">,</span>&nbsp;<span class="ident" id="7131472">ms2</span>&nbsp;<span class="ident" id="7131476">runtime</span><span class="op" id="7131483">.</span><span class="ident" id="7131484">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7131495">if</span>&nbsp;<span class="ident" id="7131498">big</span>&nbsp;<span class="op" id="7131502">==</span>&nbsp;<span class="ident" id="7131505">nil</span>&nbsp;<span class="op" id="7131509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131513">t</span><span class="op" id="7131514">.</span><span class="ident" id="7131515">Skip</span><span class="op" id="7131519">(</span><span class="string" id="7131520">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="7131566">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7131569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131572">big</span>&nbsp;<span class="op" id="7131576">=</span>&nbsp;<span class="ident" id="7131578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131583">runtime</span><span class="op" id="7131590">.</span><span class="ident" id="7131591">GC</span><span class="op" id="7131593">(</span><span class="op" id="7131594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131597">runtime</span><span class="op" id="7131604">.</span><span class="ident" id="7131605">ReadMemStats</span><span class="op" id="7131617">(</span><span class="op" id="7131618">&amp;</span><span class="ident" id="7131619">ms1</span><span class="op" id="7131622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131625">FreeOSMemory</span><span class="op" id="7131637">(</span><span class="op" id="7131638">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131641">runtime</span><span class="op" id="7131648">.</span><span class="ident" id="7131649">ReadMemStats</span><span class="op" id="7131661">(</span><span class="op" id="7131662">&amp;</span><span class="ident" id="7131663">ms2</span><span class="op" id="7131666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7131669">if</span>&nbsp;<span class="ident" id="7131672">ms1</span><span class="op" id="7131675">.</span><span class="ident" id="7131676">HeapReleased</span>&nbsp;<span class="op" id="7131689">&gt;=</span>&nbsp;<span class="ident" id="7131692">ms2</span><span class="op" id="7131695">.</span><span class="ident" id="7131696">HeapReleased</span>&nbsp;<span class="op" id="7131709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7131713">t</span><span class="op" id="7131714">.</span><span class="ident" id="7131715">Errorf</span><span class="op" id="7131721">(</span><span class="string" id="7131722">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="7131776">,</span>&nbsp;<span class="ident" id="7131778">ms1</span><span class="op" id="7131781">.</span><span class="ident" id="7131782">HeapReleased</span><span class="op" id="7131794">,</span>&nbsp;<span class="ident" id="7131796">ms2</span><span class="op" id="7131799">.</span><span class="ident" id="7131800">HeapReleased</span><span class="op" id="7131812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7131815">}</span><br>
<span class="lineno"></span><span class="op" id="7131817">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="7131820">func</span>&nbsp;<span class="ident" id="7131825">TestSetGCPercent</span><span class="op" id="7131841">(</span><span class="ident" id="7131842">t</span>&nbsp;<span class="op" id="7131844">*</span><span class="ident" id="7131845">testing</span><span class="op" id="7131852">.</span><span class="ident" id="7131853">T</span><span class="op" id="7131854">)</span>&nbsp;<span class="op" id="7131856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7131859">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7131923">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7131987">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7132016">old</span>&nbsp;<span class="op" id="7132020">:=</span>&nbsp;<span class="ident" id="7132023">SetGCPercent</span><span class="op" id="7132035">(</span><span class="num" id="7132036">123</span><span class="op" id="7132039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7132042">new</span>&nbsp;<span class="op" id="7132046">:=</span>&nbsp;<span class="ident" id="7132049">SetGCPercent</span><span class="op" id="7132061">(</span><span class="ident" id="7132062">old</span><span class="op" id="7132065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7132068">if</span>&nbsp;<span class="builtinfunc" id="7132071">new</span>&nbsp;<span class="op" id="7132075">!=</span>&nbsp;<span class="num" id="7132078">123</span>&nbsp;<span class="op" id="7132082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7132086">t</span><span class="op" id="7132087">.</span><span class="ident" id="7132088">Errorf</span><span class="op" id="7132094">(</span><span class="string" id="7132095">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="7132146">,</span>&nbsp;<span class="builtinfunc" id="7132148">new</span><span class="op" id="7132151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7132154">}</span><br>
<span class="lineno">115</span><span class="op" id="7132156">}</span>
</div>
</body>
</html>
