<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1814583">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1814639">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1814693">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1814744">//&nbsp;Cgo&nbsp;call&nbsp;and&nbsp;callback&nbsp;support.</span><br>
<span class="lineno"></span><span class="comment" id="1814778">//</span><br>
<span class="lineno"></span><span class="comment" id="1814781">//&nbsp;To&nbsp;call&nbsp;into&nbsp;the&nbsp;C&nbsp;function&nbsp;f&nbsp;from&nbsp;Go,&nbsp;the&nbsp;cgo-generated&nbsp;code&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="1814852">//&nbsp;runtime.cgocall(_cgo_Cfunc_f,&nbsp;frame),&nbsp;where&nbsp;_cgo_Cfunc_f&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1814917">//&nbsp;gcc-compiled&nbsp;function&nbsp;written&nbsp;by&nbsp;cgo.</span><br>
<span class="lineno">10</span><span class="comment" id="1814958">//</span><br>
<span class="lineno"></span><span class="comment" id="1814961">//&nbsp;runtime.cgocall&nbsp;(below)&nbsp;locks&nbsp;g&nbsp;to&nbsp;m,&nbsp;calls&nbsp;entersyscall</span><br>
<span class="lineno"></span><span class="comment" id="1815021">//&nbsp;so&nbsp;as&nbsp;not&nbsp;to&nbsp;block&nbsp;other&nbsp;goroutines&nbsp;or&nbsp;the&nbsp;garbage&nbsp;collector,</span><br>
<span class="lineno"></span><span class="comment" id="1815086">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;runtime.asmcgocall(_cgo_Cfunc_f,&nbsp;frame).</span><br>
<span class="lineno"></span><span class="comment" id="1815145">//</span><br>
<span class="lineno">15</span><span class="comment" id="1815148">//&nbsp;runtime.asmcgocall&nbsp;(in&nbsp;asm_$GOARCH.s)&nbsp;switches&nbsp;to&nbsp;the&nbsp;m-&gt;g0&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="1815217">//&nbsp;(assumed&nbsp;to&nbsp;be&nbsp;an&nbsp;operating&nbsp;system-allocated&nbsp;stack,&nbsp;so&nbsp;safe&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="1815287">//&nbsp;gcc-compiled&nbsp;code&nbsp;on)&nbsp;and&nbsp;calls&nbsp;_cgo_Cfunc_f(frame).</span><br>
<span class="lineno"></span><span class="comment" id="1815343">//</span><br>
<span class="lineno"></span><span class="comment" id="1815346">//&nbsp;_cgo_Cfunc_f&nbsp;invokes&nbsp;the&nbsp;actual&nbsp;C&nbsp;function&nbsp;f&nbsp;with&nbsp;arguments</span><br>
<span class="lineno">20</span><span class="comment" id="1815409">//&nbsp;taken&nbsp;from&nbsp;the&nbsp;frame&nbsp;structure,&nbsp;records&nbsp;the&nbsp;results&nbsp;in&nbsp;the&nbsp;frame,</span><br>
<span class="lineno"></span><span class="comment" id="1815478">//&nbsp;and&nbsp;returns&nbsp;to&nbsp;runtime.asmcgocall.</span><br>
<span class="lineno"></span><span class="comment" id="1815516">//</span><br>
<span class="lineno"></span><span class="comment" id="1815519">//&nbsp;After&nbsp;it&nbsp;regains&nbsp;control,&nbsp;runtime.asmcgocall&nbsp;switches&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1815588">//&nbsp;original&nbsp;g&nbsp;(m-&gt;curg)&#39;s&nbsp;stack&nbsp;and&nbsp;returns&nbsp;to&nbsp;runtime.cgocall.</span><br>
<span class="lineno">25</span><span class="comment" id="1815652">//</span><br>
<span class="lineno"></span><span class="comment" id="1815655">//&nbsp;After&nbsp;it&nbsp;regains&nbsp;control,&nbsp;runtime.cgocall&nbsp;calls&nbsp;exitsyscall,&nbsp;which&nbsp;blocks</span><br>
<span class="lineno"></span><span class="comment" id="1815732">//&nbsp;until&nbsp;this&nbsp;m&nbsp;can&nbsp;run&nbsp;Go&nbsp;code&nbsp;without&nbsp;violating&nbsp;the&nbsp;$GOMAXPROCS&nbsp;limit,</span><br>
<span class="lineno"></span><span class="comment" id="1815805">//&nbsp;and&nbsp;then&nbsp;unlocks&nbsp;g&nbsp;from&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1815835">//</span><br>
<span class="lineno">30</span><span class="comment" id="1815838">//&nbsp;The&nbsp;above&nbsp;description&nbsp;skipped&nbsp;over&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;gcc-compiled</span><br>
<span class="lineno"></span><span class="comment" id="1815912">//&nbsp;function&nbsp;f&nbsp;calling&nbsp;back&nbsp;into&nbsp;Go.&nbsp;&nbsp;If&nbsp;that&nbsp;happens,&nbsp;we&nbsp;continue&nbsp;down</span><br>
<span class="lineno"></span><span class="comment" id="1815983">//&nbsp;the&nbsp;rabbit&nbsp;hole&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1816029">//</span><br>
<span class="lineno"></span><span class="comment" id="1816032">//&nbsp;To&nbsp;make&nbsp;it&nbsp;possible&nbsp;for&nbsp;gcc-compiled&nbsp;C&nbsp;code&nbsp;to&nbsp;call&nbsp;a&nbsp;Go&nbsp;function&nbsp;p.GoF,</span><br>
<span class="lineno">35</span><span class="comment" id="1816108">//&nbsp;cgo&nbsp;writes&nbsp;a&nbsp;gcc-compiled&nbsp;function&nbsp;named&nbsp;GoF&nbsp;(not&nbsp;p.GoF,&nbsp;since&nbsp;gcc&nbsp;doesn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1816186">//&nbsp;know&nbsp;about&nbsp;packages).&nbsp;&nbsp;The&nbsp;gcc-compiled&nbsp;C&nbsp;function&nbsp;f&nbsp;calls&nbsp;GoF.</span><br>
<span class="lineno"></span><span class="comment" id="1816253">//</span><br>
<span class="lineno"></span><span class="comment" id="1816256">//&nbsp;GoF&nbsp;calls&nbsp;crosscall2(_cgoexp_GoF,&nbsp;frame,&nbsp;framesize).&nbsp;&nbsp;Crosscall2</span><br>
<span class="lineno"></span><span class="comment" id="1816324">//&nbsp;(in&nbsp;cgo/gcc_$GOARCH.S,&nbsp;a&nbsp;gcc-compiled&nbsp;assembly&nbsp;file)&nbsp;is&nbsp;a&nbsp;two-argument</span><br>
<span class="lineno">40</span><span class="comment" id="1816398">//&nbsp;adapter&nbsp;from&nbsp;the&nbsp;gcc&nbsp;function&nbsp;call&nbsp;ABI&nbsp;to&nbsp;the&nbsp;6c&nbsp;function&nbsp;call&nbsp;ABI.</span><br>
<span class="lineno"></span><span class="comment" id="1816469">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;gcc&nbsp;to&nbsp;call&nbsp;6c&nbsp;functions.&nbsp;&nbsp;In&nbsp;this&nbsp;case&nbsp;it&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="1816539">//&nbsp;_cgoexp_GoF(frame,&nbsp;framesize),&nbsp;still&nbsp;running&nbsp;on&nbsp;m-&gt;g0&#39;s&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="1816604">//&nbsp;and&nbsp;outside&nbsp;the&nbsp;$GOMAXPROCS&nbsp;limit.&nbsp;&nbsp;Thus,&nbsp;this&nbsp;code&nbsp;cannot&nbsp;yet</span><br>
<span class="lineno"></span><span class="comment" id="1816670">//&nbsp;call&nbsp;arbitrary&nbsp;Go&nbsp;code&nbsp;directly&nbsp;and&nbsp;must&nbsp;be&nbsp;careful&nbsp;not&nbsp;to&nbsp;allocate</span><br>
<span class="lineno">45</span><span class="comment" id="1816741">//&nbsp;memory&nbsp;or&nbsp;use&nbsp;up&nbsp;m-&gt;g0&#39;s&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1816776">//</span><br>
<span class="lineno"></span><span class="comment" id="1816779">//&nbsp;_cgoexp_GoF&nbsp;calls&nbsp;runtime.cgocallback(p.GoF,&nbsp;frame,&nbsp;framesize).</span><br>
<span class="lineno"></span><span class="comment" id="1816846">//&nbsp;(The&nbsp;reason&nbsp;for&nbsp;having&nbsp;_cgoexp_GoF&nbsp;instead&nbsp;of&nbsp;writing&nbsp;a&nbsp;crosscall3</span><br>
<span class="lineno"></span><span class="comment" id="1816916">//&nbsp;to&nbsp;make&nbsp;this&nbsp;call&nbsp;directly&nbsp;is&nbsp;that&nbsp;_cgoexp_GoF,&nbsp;because&nbsp;it&nbsp;is&nbsp;compiled</span><br>
<span class="lineno">50</span><span class="comment" id="1816990">//&nbsp;with&nbsp;6c&nbsp;instead&nbsp;of&nbsp;gcc,&nbsp;can&nbsp;refer&nbsp;to&nbsp;dotted&nbsp;names&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="1817048">//&nbsp;runtime.cgocallback&nbsp;and&nbsp;p.GoF.)</span><br>
<span class="lineno"></span><span class="comment" id="1817083">//</span><br>
<span class="lineno"></span><span class="comment" id="1817086">//&nbsp;runtime.cgocallback&nbsp;(in&nbsp;asm_$GOARCH.s)&nbsp;switches&nbsp;from&nbsp;m-&gt;g0&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="1817150">//&nbsp;stack&nbsp;to&nbsp;the&nbsp;original&nbsp;g&nbsp;(m-&gt;curg)&#39;s&nbsp;stack,&nbsp;on&nbsp;which&nbsp;it&nbsp;calls</span><br>
<span class="lineno">55</span><span class="comment" id="1817214">//&nbsp;runtime.cgocallbackg(p.GoF,&nbsp;frame,&nbsp;framesize).</span><br>
<span class="lineno"></span><span class="comment" id="1817264">//&nbsp;As&nbsp;part&nbsp;of&nbsp;the&nbsp;stack&nbsp;switch,&nbsp;runtime.cgocallback&nbsp;saves&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="1817334">//&nbsp;SP&nbsp;as&nbsp;m-&gt;g0-&gt;sched.sp,&nbsp;so&nbsp;that&nbsp;any&nbsp;use&nbsp;of&nbsp;m-&gt;g0&#39;s&nbsp;stack&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1817404">//&nbsp;execution&nbsp;of&nbsp;the&nbsp;callback&nbsp;will&nbsp;be&nbsp;done&nbsp;below&nbsp;the&nbsp;existing&nbsp;stack&nbsp;frames.</span><br>
<span class="lineno"></span><span class="comment" id="1817479">//&nbsp;Before&nbsp;overwriting&nbsp;m-&gt;g0-&gt;sched.sp,&nbsp;it&nbsp;pushes&nbsp;the&nbsp;old&nbsp;value&nbsp;on&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="1817549">//&nbsp;m-&gt;g0&nbsp;stack,&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;be&nbsp;restored&nbsp;later.</span><br>
<span class="lineno"></span><span class="comment" id="1817599">//</span><br>
<span class="lineno"></span><span class="comment" id="1817602">//&nbsp;runtime.cgocallbackg&nbsp;(below)&nbsp;is&nbsp;now&nbsp;running&nbsp;on&nbsp;a&nbsp;real&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1817669">//&nbsp;stack&nbsp;(not&nbsp;an&nbsp;m-&gt;g0&nbsp;stack).&nbsp;&nbsp;First&nbsp;it&nbsp;calls&nbsp;runtime.exitsyscall,&nbsp;which&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="1817748">//&nbsp;block&nbsp;until&nbsp;the&nbsp;$GOMAXPROCS&nbsp;limit&nbsp;allows&nbsp;running&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno">65</span><span class="comment" id="1817816">//&nbsp;Once&nbsp;exitsyscall&nbsp;has&nbsp;returned,&nbsp;it&nbsp;is&nbsp;safe&nbsp;to&nbsp;do&nbsp;things&nbsp;like&nbsp;call&nbsp;the&nbsp;memory</span><br>
<span class="lineno"></span><span class="comment" id="1817895">//&nbsp;allocator&nbsp;or&nbsp;invoke&nbsp;the&nbsp;Go&nbsp;callback&nbsp;function&nbsp;p.GoF.&nbsp;&nbsp;runtime.cgocallbackg</span><br>
<span class="lineno"></span><span class="comment" id="1817972">//&nbsp;first&nbsp;defers&nbsp;a&nbsp;function&nbsp;to&nbsp;unwind&nbsp;m-&gt;g0.sched.sp,&nbsp;so&nbsp;that&nbsp;if&nbsp;p.GoF</span><br>
<span class="lineno"></span><span class="comment" id="1818042">//&nbsp;panics,&nbsp;m-&gt;g0.sched.sp&nbsp;will&nbsp;be&nbsp;restored&nbsp;to&nbsp;its&nbsp;old&nbsp;value:&nbsp;the&nbsp;m-&gt;g0&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="1818119">//&nbsp;and&nbsp;the&nbsp;m-&gt;curg&nbsp;stack&nbsp;will&nbsp;be&nbsp;unwound&nbsp;in&nbsp;lock&nbsp;step.</span><br>
<span class="lineno">70</span><span class="comment" id="1818174">//&nbsp;Then&nbsp;it&nbsp;calls&nbsp;p.GoF.&nbsp;&nbsp;Finally&nbsp;it&nbsp;pops&nbsp;but&nbsp;does&nbsp;not&nbsp;execute&nbsp;the&nbsp;deferred</span><br>
<span class="lineno"></span><span class="comment" id="1818249">//&nbsp;function,&nbsp;calls&nbsp;runtime.entersyscall,&nbsp;and&nbsp;returns&nbsp;to&nbsp;runtime.cgocallback.</span><br>
<span class="lineno"></span><span class="comment" id="1818326">//</span><br>
<span class="lineno"></span><span class="comment" id="1818329">//&nbsp;After&nbsp;it&nbsp;regains&nbsp;control,&nbsp;runtime.cgocallback&nbsp;switches&nbsp;back&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1818395">//&nbsp;m-&gt;g0&#39;s&nbsp;stack&nbsp;(the&nbsp;pointer&nbsp;is&nbsp;still&nbsp;in&nbsp;m-&gt;g0.sched.sp),&nbsp;restores&nbsp;the&nbsp;old</span><br>
<span class="lineno">75</span><span class="comment" id="1818471">//&nbsp;m-&gt;g0.sched.sp&nbsp;value&nbsp;from&nbsp;the&nbsp;stack,&nbsp;and&nbsp;returns&nbsp;to&nbsp;_cgoexp_GoF.</span><br>
<span class="lineno"></span><span class="comment" id="1818539">//</span><br>
<span class="lineno"></span><span class="comment" id="1818542">//&nbsp;_cgoexp_GoF&nbsp;immediately&nbsp;returns&nbsp;to&nbsp;crosscall2,&nbsp;which&nbsp;restores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1818611">//&nbsp;callee-save&nbsp;registers&nbsp;for&nbsp;gcc&nbsp;and&nbsp;returns&nbsp;to&nbsp;GoF,&nbsp;which&nbsp;returns&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="1818685">package</span>&nbsp;<span class="ident" id="1818693">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1818702">import</span>&nbsp;<span class="string" id="1818709">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1818719">//&nbsp;Call&nbsp;from&nbsp;Go&nbsp;to&nbsp;C.</span><br>
<span class="lineno">85</span><span class="comment" id="1818741">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1818754">func</span>&nbsp;<span class="ident" id="1818759">cgocall</span><span class="op" id="1818766">(</span><span class="ident" id="1818767">fn</span><span class="op" id="1818769">,</span>&nbsp;<span class="ident" id="1818771">arg</span>&nbsp;<span class="ident" id="1818775">unsafe</span><span class="op" id="1818781">.</span><span class="ident" id="1818782">Pointer</span><span class="op" id="1818789">)</span>&nbsp;<span class="op" id="1818791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818794">cgocall_errno</span><span class="op" id="1818807">(</span><span class="ident" id="1818808">fn</span><span class="op" id="1818810">,</span>&nbsp;<span class="ident" id="1818812">arg</span><span class="op" id="1818815">)</span><br>
<span class="lineno"></span><span class="op" id="1818817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="1818820">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1818833">func</span>&nbsp;<span class="ident" id="1818838">cgocall_errno</span><span class="op" id="1818851">(</span><span class="ident" id="1818852">fn</span><span class="op" id="1818854">,</span>&nbsp;<span class="ident" id="1818856">arg</span>&nbsp;<span class="ident" id="1818860">unsafe</span><span class="op" id="1818866">.</span><span class="ident" id="1818867">Pointer</span><span class="op" id="1818874">)</span>&nbsp;<span class="builtintype" id="1818876">int32</span>&nbsp;<span class="op" id="1818882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818885">if</span>&nbsp;<span class="op" id="1818888">!</span><span class="ident" id="1818889">iscgo</span>&nbsp;<span class="op" id="1818895">&amp;&amp;</span>&nbsp;<span class="ident" id="1818898">GOOS</span>&nbsp;<span class="op" id="1818903">!=</span>&nbsp;<span class="string" id="1818906">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1818916">&amp;&amp;</span>&nbsp;<span class="ident" id="1818919">GOOS</span>&nbsp;<span class="op" id="1818924">!=</span>&nbsp;<span class="string" id="1818927">&#34;windows&#34;</span>&nbsp;<span class="op" id="1818937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818941">gothrow</span><span class="op" id="1818948">(</span><span class="string" id="1818949">&#34;cgocall&nbsp;unavailable&#34;</span><span class="op" id="1818970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818973">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818977">if</span>&nbsp;<span class="ident" id="1818980">fn</span>&nbsp;<span class="op" id="1818983">==</span>&nbsp;<span class="ident" id="1818986">nil</span>&nbsp;<span class="op" id="1818990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818994">gothrow</span><span class="op" id="1819001">(</span><span class="string" id="1819002">&#34;cgocall&nbsp;nil&#34;</span><span class="op" id="1819015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1819018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1819022">if</span>&nbsp;<span class="ident" id="1819025">raceenabled</span>&nbsp;<span class="op" id="1819037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819041">racereleasemerge</span><span class="op" id="1819057">(</span><span class="ident" id="1819058">unsafe</span><span class="op" id="1819064">.</span><span class="ident" id="1819065">Pointer</span><span class="op" id="1819072">(</span><span class="op" id="1819073">&amp;</span><span class="ident" id="1819074">racecgosync</span><span class="op" id="1819085">)</span><span class="op" id="1819086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1819089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1819093">//&nbsp;Create&nbsp;an&nbsp;extra&nbsp;M&nbsp;for&nbsp;callbacks&nbsp;on&nbsp;threads&nbsp;not&nbsp;created&nbsp;by&nbsp;Go&nbsp;on&nbsp;first&nbsp;cgo&nbsp;call.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1819177">if</span>&nbsp;<span class="ident" id="1819180">needextram</span>&nbsp;<span class="op" id="1819191">==</span>&nbsp;<span class="num" id="1819194">1</span>&nbsp;<span class="op" id="1819196">&amp;&amp;</span>&nbsp;<span class="ident" id="1819199">cas</span><span class="op" id="1819202">(</span><span class="op" id="1819203">&amp;</span><span class="ident" id="1819204">needextram</span><span class="op" id="1819214">,</span>&nbsp;<span class="num" id="1819216">1</span><span class="op" id="1819217">,</span>&nbsp;<span class="num" id="1819219">0</span><span class="op" id="1819220">)</span>&nbsp;<span class="op" id="1819222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819226">onM</span><span class="op" id="1819229">(</span><span class="ident" id="1819230">newextram</span><span class="op" id="1819239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1819242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1819246">/*<br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;Lock&nbsp;g&nbsp;to&nbsp;m&nbsp;to&nbsp;ensure&nbsp;we&nbsp;stay&nbsp;on&nbsp;the&nbsp;same&nbsp;stack&nbsp;if&nbsp;we&nbsp;do&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;cgo&nbsp;callback.&nbsp;Add&nbsp;entry&nbsp;to&nbsp;defer&nbsp;stack&nbsp;in&nbsp;case&nbsp;of&nbsp;panic.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819379">lockOSThread</span><span class="op" id="1819391">(</span><span class="op" id="1819392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819395">mp</span>&nbsp;<span class="op" id="1819398">:=</span>&nbsp;<span class="ident" id="1819401">getg</span><span class="op" id="1819405">(</span><span class="op" id="1819406">)</span><span class="op" id="1819407">.</span><span class="ident" id="1819408">m</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819411">mp</span><span class="op" id="1819413">.</span><span class="ident" id="1819414">ncgocall</span><span class="op" id="1819422">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819426">mp</span><span class="op" id="1819428">.</span><span class="ident" id="1819429">ncgo</span><span class="op" id="1819433">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1819437">defer</span>&nbsp;<span class="ident" id="1819443">endcgo</span><span class="op" id="1819449">(</span><span class="ident" id="1819450">mp</span><span class="op" id="1819452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1819456">/*<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;Announce&nbsp;we&nbsp;are&nbsp;entering&nbsp;a&nbsp;system&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;so&nbsp;that&nbsp;the&nbsp;scheduler&nbsp;knows&nbsp;to&nbsp;create&nbsp;another<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;M&nbsp;to&nbsp;run&nbsp;goroutines&nbsp;while&nbsp;we&nbsp;are&nbsp;in&nbsp;the<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;foreign&nbsp;code.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*<br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;The&nbsp;call&nbsp;to&nbsp;asmcgocall&nbsp;is&nbsp;guaranteed&nbsp;not&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;split&nbsp;the&nbsp;stack&nbsp;and&nbsp;does&nbsp;not&nbsp;allocate&nbsp;memory,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;so&nbsp;it&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;while&nbsp;&#34;in&nbsp;a&nbsp;system&nbsp;call&#34;,&nbsp;outside<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;the&nbsp;$GOMAXPROCS&nbsp;accounting.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*/</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819814">entersyscall</span><span class="op" id="1819826">(</span><span class="op" id="1819827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819830">errno</span>&nbsp;<span class="op" id="1819836">:=</span>&nbsp;<span class="ident" id="1819839">asmcgocall_errno</span><span class="op" id="1819855">(</span><span class="ident" id="1819856">fn</span><span class="op" id="1819858">,</span>&nbsp;<span class="ident" id="1819860">arg</span><span class="op" id="1819863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819866">exitsyscall</span><span class="op" id="1819877">(</span><span class="op" id="1819878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1819882">return</span>&nbsp;<span class="ident" id="1819889">errno</span><br>
<span class="lineno">135</span><span class="op" id="1819895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1819898">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1819911">func</span>&nbsp;<span class="ident" id="1819916">endcgo</span><span class="op" id="1819922">(</span><span class="ident" id="1819923">mp</span>&nbsp;<span class="op" id="1819926">*</span><span class="ident" id="1819927">m</span><span class="op" id="1819928">)</span>&nbsp;<span class="op" id="1819930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1819933">mp</span><span class="op" id="1819935">.</span><span class="ident" id="1819936">ncgo</span><span class="op" id="1819940">--</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1819944">if</span>&nbsp;<span class="ident" id="1819947">mp</span><span class="op" id="1819949">.</span><span class="ident" id="1819950">ncgo</span>&nbsp;<span class="op" id="1819955">==</span>&nbsp;<span class="num" id="1819958">0</span>&nbsp;<span class="op" id="1819960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1819964">//&nbsp;We&nbsp;are&nbsp;going&nbsp;back&nbsp;to&nbsp;Go&nbsp;and&nbsp;are&nbsp;not&nbsp;in&nbsp;a&nbsp;recursive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1820020">//&nbsp;call.&nbsp;&nbsp;Let&nbsp;the&nbsp;GC&nbsp;collect&nbsp;any&nbsp;memory&nbsp;allocated&nbsp;via</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1820076">//&nbsp;_cgo_allocate&nbsp;that&nbsp;is&nbsp;no&nbsp;longer&nbsp;referenced.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820125">mp</span><span class="op" id="1820127">.</span><span class="ident" id="1820128">cgomal</span>&nbsp;<span class="op" id="1820135">=</span>&nbsp;<span class="ident" id="1820137">nil</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1820142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1820146">if</span>&nbsp;<span class="ident" id="1820149">raceenabled</span>&nbsp;<span class="op" id="1820161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820165">raceacquire</span><span class="op" id="1820176">(</span><span class="ident" id="1820177">unsafe</span><span class="op" id="1820183">.</span><span class="ident" id="1820184">Pointer</span><span class="op" id="1820191">(</span><span class="op" id="1820192">&amp;</span><span class="ident" id="1820193">racecgosync</span><span class="op" id="1820204">)</span><span class="op" id="1820205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1820208">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820212">unlockOSThread</span><span class="op" id="1820226">(</span><span class="op" id="1820227">)</span>&nbsp;<span class="comment" id="1820229">//&nbsp;invalidates&nbsp;mp</span><br>
<span class="lineno"></span><span class="op" id="1820247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1820250">//&nbsp;Helper&nbsp;functions&nbsp;for&nbsp;cgo&nbsp;code.</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="1820285">//&nbsp;Filled&nbsp;by&nbsp;schedinit&nbsp;from&nbsp;corresponding&nbsp;C&nbsp;variables,</span><br>
<span class="lineno"></span><span class="comment" id="1820340">//&nbsp;which&nbsp;are&nbsp;in&nbsp;turn&nbsp;filled&nbsp;in&nbsp;by&nbsp;dynamic&nbsp;linker&nbsp;when&nbsp;Cgo&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1820412">var</span>&nbsp;<span class="ident" id="1820416">cgoMalloc</span><span class="op" id="1820425">,</span>&nbsp;<span class="ident" id="1820427">cgoFree</span>&nbsp;<span class="ident" id="1820435">unsafe</span><span class="op" id="1820441">.</span><span class="ident" id="1820442">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1820451">func</span>&nbsp;<span class="ident" id="1820456">cmalloc</span><span class="op" id="1820463">(</span><span class="ident" id="1820464">n</span>&nbsp;<span class="builtintype" id="1820466">uintptr</span><span class="op" id="1820473">)</span>&nbsp;<span class="ident" id="1820475">unsafe</span><span class="op" id="1820481">.</span><span class="ident" id="1820482">Pointer</span>&nbsp;<span class="op" id="1820490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1820493">var</span>&nbsp;<span class="ident" id="1820497">args</span>&nbsp;<span class="keyword" id="1820502">struct</span>&nbsp;<span class="op" id="1820509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820513">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1820517">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820526">ret</span>&nbsp;<span class="ident" id="1820530">unsafe</span><span class="op" id="1820536">.</span><span class="ident" id="1820537">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1820546">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820549">args</span><span class="op" id="1820553">.</span><span class="ident" id="1820554">n</span>&nbsp;<span class="op" id="1820556">=</span>&nbsp;<span class="ident" id="1820558">uint64</span><span class="op" id="1820564">(</span><span class="ident" id="1820565">n</span><span class="op" id="1820566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820569">cgocall</span><span class="op" id="1820576">(</span><span class="ident" id="1820577">cgoMalloc</span><span class="op" id="1820586">,</span>&nbsp;<span class="ident" id="1820588">unsafe</span><span class="op" id="1820594">.</span><span class="ident" id="1820595">Pointer</span><span class="op" id="1820602">(</span><span class="op" id="1820603">&amp;</span><span class="ident" id="1820604">args</span><span class="op" id="1820608">)</span><span class="op" id="1820609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1820612">if</span>&nbsp;<span class="ident" id="1820615">args</span><span class="op" id="1820619">.</span><span class="ident" id="1820620">ret</span>&nbsp;<span class="op" id="1820624">==</span>&nbsp;<span class="ident" id="1820627">nil</span>&nbsp;<span class="op" id="1820631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820635">gothrow</span><span class="op" id="1820642">(</span><span class="string" id="1820643">&#34;C&nbsp;malloc&nbsp;failed&#34;</span><span class="op" id="1820660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1820663">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1820666">return</span>&nbsp;<span class="ident" id="1820673">args</span><span class="op" id="1820677">.</span><span class="ident" id="1820678">ret</span><br>
<span class="lineno"></span><span class="op" id="1820682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1820685">func</span>&nbsp;<span class="ident" id="1820690">cfree</span><span class="op" id="1820695">(</span><span class="ident" id="1820696">p</span>&nbsp;<span class="ident" id="1820698">unsafe</span><span class="op" id="1820704">.</span><span class="ident" id="1820705">Pointer</span><span class="op" id="1820712">)</span>&nbsp;<span class="op" id="1820714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820717">cgocall</span><span class="op" id="1820724">(</span><span class="ident" id="1820725">cgoFree</span><span class="op" id="1820732">,</span>&nbsp;<span class="ident" id="1820734">p</span><span class="op" id="1820735">)</span><br>
<span class="lineno">175</span><span class="op" id="1820737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1820740">//&nbsp;Call&nbsp;from&nbsp;C&nbsp;back&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1820767">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1820780">func</span>&nbsp;<span class="ident" id="1820785">cgocallbackg</span><span class="op" id="1820797">(</span><span class="op" id="1820798">)</span>&nbsp;<span class="op" id="1820800">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820803">gp</span>&nbsp;<span class="op" id="1820806">:=</span>&nbsp;<span class="ident" id="1820809">getg</span><span class="op" id="1820813">(</span><span class="op" id="1820814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1820817">if</span>&nbsp;<span class="ident" id="1820820">gp</span>&nbsp;<span class="op" id="1820823">!=</span>&nbsp;<span class="ident" id="1820826">gp</span><span class="op" id="1820828">.</span><span class="ident" id="1820829">m</span><span class="op" id="1820830">.</span><span class="ident" id="1820831">curg</span>&nbsp;<span class="op" id="1820836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1820840">println</span><span class="op" id="1820847">(</span><span class="string" id="1820848">&#34;runtime:&nbsp;bad&nbsp;g&nbsp;in&nbsp;cgocallback&#34;</span><span class="op" id="1820879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1820883">exit</span><span class="op" id="1820887">(</span><span class="num" id="1820888">2</span><span class="op" id="1820889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1820892">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1820896">//&nbsp;entersyscall&nbsp;saves&nbsp;the&nbsp;caller&#39;s&nbsp;SP&nbsp;to&nbsp;allow&nbsp;the&nbsp;GC&nbsp;to&nbsp;trace&nbsp;the&nbsp;Go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1820967">//&nbsp;stack.&nbsp;However,&nbsp;since&nbsp;we&#39;re&nbsp;returning&nbsp;to&nbsp;an&nbsp;earlier&nbsp;stack&nbsp;frame&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821039">//&nbsp;need&nbsp;to&nbsp;pair&nbsp;with&nbsp;the&nbsp;entersyscall()&nbsp;call&nbsp;made&nbsp;by&nbsp;cgocall,&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821110">//&nbsp;save&nbsp;syscall*&nbsp;and&nbsp;let&nbsp;reentersyscall&nbsp;restore&nbsp;them.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821165">savedsp</span>&nbsp;<span class="op" id="1821173">:=</span>&nbsp;<span class="ident" id="1821176">unsafe</span><span class="op" id="1821182">.</span><span class="ident" id="1821183">Pointer</span><span class="op" id="1821190">(</span><span class="ident" id="1821191">gp</span><span class="op" id="1821193">.</span><span class="ident" id="1821194">syscallsp</span><span class="op" id="1821203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821206">savedpc</span>&nbsp;<span class="op" id="1821214">:=</span>&nbsp;<span class="ident" id="1821217">gp</span><span class="op" id="1821219">.</span><span class="ident" id="1821220">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821231">exitsyscall</span><span class="op" id="1821242">(</span><span class="op" id="1821243">)</span>&nbsp;<span class="comment" id="1821245">//&nbsp;coming&nbsp;out&nbsp;of&nbsp;cgo&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821272">cgocallbackg1</span><span class="op" id="1821285">(</span><span class="op" id="1821286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821289">//&nbsp;going&nbsp;back&nbsp;to&nbsp;cgo&nbsp;call</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821316">reentersyscall</span><span class="op" id="1821330">(</span><span class="ident" id="1821331">savedpc</span><span class="op" id="1821338">,</span>&nbsp;<span class="ident" id="1821340">savedsp</span><span class="op" id="1821347">)</span><br>
<span class="lineno"></span><span class="op" id="1821349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1821352">func</span>&nbsp;<span class="ident" id="1821357">cgocallbackg1</span><span class="op" id="1821370">(</span><span class="op" id="1821371">)</span>&nbsp;<span class="op" id="1821373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821376">gp</span>&nbsp;<span class="op" id="1821379">:=</span>&nbsp;<span class="ident" id="1821382">getg</span><span class="op" id="1821386">(</span><span class="op" id="1821387">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821390">if</span>&nbsp;<span class="ident" id="1821393">gp</span><span class="op" id="1821395">.</span><span class="ident" id="1821396">m</span><span class="op" id="1821397">.</span><span class="ident" id="1821398">needextram</span>&nbsp;<span class="op" id="1821409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821413">gp</span><span class="op" id="1821415">.</span><span class="ident" id="1821416">m</span><span class="op" id="1821417">.</span><span class="ident" id="1821418">needextram</span>&nbsp;<span class="op" id="1821429">=</span>&nbsp;<span class="builtintype" id="1821431">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821439">onM</span><span class="op" id="1821442">(</span><span class="ident" id="1821443">newextram</span><span class="op" id="1821452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1821455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821459">//&nbsp;Add&nbsp;entry&nbsp;to&nbsp;defer&nbsp;stack&nbsp;in&nbsp;case&nbsp;of&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821506">restore</span>&nbsp;<span class="op" id="1821514">:=</span>&nbsp;<span class="builtintype" id="1821517">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821523">defer</span>&nbsp;<span class="ident" id="1821529">unwindm</span><span class="op" id="1821536">(</span><span class="op" id="1821537">&amp;</span><span class="ident" id="1821538">restore</span><span class="op" id="1821545">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821549">if</span>&nbsp;<span class="ident" id="1821552">raceenabled</span>&nbsp;<span class="op" id="1821564">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821568">raceacquire</span><span class="op" id="1821579">(</span><span class="ident" id="1821580">unsafe</span><span class="op" id="1821586">.</span><span class="ident" id="1821587">Pointer</span><span class="op" id="1821594">(</span><span class="op" id="1821595">&amp;</span><span class="ident" id="1821596">racecgosync</span><span class="op" id="1821607">)</span><span class="op" id="1821608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1821611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821615">type</span>&nbsp;<span class="ident" id="1821620">args</span>&nbsp;<span class="keyword" id="1821625">struct</span>&nbsp;<span class="op" id="1821632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821636">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1821644">*</span><span class="ident" id="1821645">funcval</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821655">arg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1821663">unsafe</span><span class="op" id="1821669">.</span><span class="ident" id="1821670">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821680">argsize</span>&nbsp;<span class="builtintype" id="1821688">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1821697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821700">var</span>&nbsp;<span class="ident" id="1821704">cb</span>&nbsp;<span class="op" id="1821707">*</span><span class="ident" id="1821708">args</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821715">//&nbsp;Location&nbsp;of&nbsp;callback&nbsp;arguments&nbsp;depends&nbsp;on&nbsp;stack&nbsp;frame&nbsp;layout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821780">//&nbsp;and&nbsp;size&nbsp;of&nbsp;stack&nbsp;frame&nbsp;of&nbsp;cgocallback_gofunc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821831">sp</span>&nbsp;<span class="op" id="1821834">:=</span>&nbsp;<span class="ident" id="1821837">gp</span><span class="op" id="1821839">.</span><span class="ident" id="1821840">m</span><span class="op" id="1821841">.</span><span class="ident" id="1821842">g0</span><span class="op" id="1821844">.</span><span class="ident" id="1821845">sched</span><span class="op" id="1821850">.</span><span class="ident" id="1821851">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821855">switch</span>&nbsp;<span class="ident" id="1821862">GOARCH</span>&nbsp;<span class="op" id="1821869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821872">default</span><span class="op" id="1821879">:</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1821883">gothrow</span><span class="op" id="1821890">(</span><span class="string" id="1821891">&#34;cgocallbackg&nbsp;is&nbsp;unimplemented&nbsp;on&nbsp;arch&#34;</span><span class="op" id="1821930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1821933">case</span>&nbsp;<span class="string" id="1821938">&#34;arm&#34;</span><span class="op" id="1821943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1821947">//&nbsp;On&nbsp;arm,&nbsp;stack&nbsp;frame&nbsp;is&nbsp;two&nbsp;words&nbsp;and&nbsp;there&#39;s&nbsp;a&nbsp;saved&nbsp;LR&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822016">//&nbsp;SP&nbsp;and&nbsp;the&nbsp;stack&nbsp;frame&nbsp;and&nbsp;between&nbsp;the&nbsp;stack&nbsp;frame&nbsp;and&nbsp;the&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822091">cb</span>&nbsp;<span class="op" id="1822094">=</span>&nbsp;<span class="op" id="1822096">(</span><span class="op" id="1822097">*</span><span class="ident" id="1822098">args</span><span class="op" id="1822102">)</span><span class="op" id="1822103">(</span><span class="ident" id="1822104">unsafe</span><span class="op" id="1822110">.</span><span class="ident" id="1822111">Pointer</span><span class="op" id="1822118">(</span><span class="ident" id="1822119">sp</span>&nbsp;<span class="op" id="1822122">+</span>&nbsp;<span class="num" id="1822124">4</span><span class="op" id="1822125">*</span><span class="ident" id="1822126">ptrSize</span><span class="op" id="1822133">)</span><span class="op" id="1822134">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822137">case</span>&nbsp;<span class="string" id="1822142">&#34;amd64&#34;</span><span class="op" id="1822149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822153">//&nbsp;On&nbsp;amd64,&nbsp;stack&nbsp;frame&nbsp;is&nbsp;one&nbsp;word,&nbsp;plus&nbsp;caller&nbsp;PC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822209">cb</span>&nbsp;<span class="op" id="1822212">=</span>&nbsp;<span class="op" id="1822214">(</span><span class="op" id="1822215">*</span><span class="ident" id="1822216">args</span><span class="op" id="1822220">)</span><span class="op" id="1822221">(</span><span class="ident" id="1822222">unsafe</span><span class="op" id="1822228">.</span><span class="ident" id="1822229">Pointer</span><span class="op" id="1822236">(</span><span class="ident" id="1822237">sp</span>&nbsp;<span class="op" id="1822240">+</span>&nbsp;<span class="num" id="1822242">2</span><span class="op" id="1822243">*</span><span class="ident" id="1822244">ptrSize</span><span class="op" id="1822251">)</span><span class="op" id="1822252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822255">case</span>&nbsp;<span class="string" id="1822260">&#34;386&#34;</span><span class="op" id="1822265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822269">//&nbsp;On&nbsp;386,&nbsp;stack&nbsp;frame&nbsp;is&nbsp;three&nbsp;words,&nbsp;plus&nbsp;caller&nbsp;PC.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822326">cb</span>&nbsp;<span class="op" id="1822329">=</span>&nbsp;<span class="op" id="1822331">(</span><span class="op" id="1822332">*</span><span class="ident" id="1822333">args</span><span class="op" id="1822337">)</span><span class="op" id="1822338">(</span><span class="ident" id="1822339">unsafe</span><span class="op" id="1822345">.</span><span class="ident" id="1822346">Pointer</span><span class="op" id="1822353">(</span><span class="ident" id="1822354">sp</span>&nbsp;<span class="op" id="1822357">+</span>&nbsp;<span class="num" id="1822359">4</span><span class="op" id="1822360">*</span><span class="ident" id="1822361">ptrSize</span><span class="op" id="1822368">)</span><span class="op" id="1822369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1822372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822376">//&nbsp;Invoke&nbsp;callback.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822397">reflectcall</span><span class="op" id="1822408">(</span><span class="ident" id="1822409">unsafe</span><span class="op" id="1822415">.</span><span class="ident" id="1822416">Pointer</span><span class="op" id="1822423">(</span><span class="ident" id="1822424">cb</span><span class="op" id="1822426">.</span><span class="ident" id="1822427">fn</span><span class="op" id="1822429">)</span><span class="op" id="1822430">,</span>&nbsp;<span class="ident" id="1822432">unsafe</span><span class="op" id="1822438">.</span><span class="ident" id="1822439">Pointer</span><span class="op" id="1822446">(</span><span class="ident" id="1822447">cb</span><span class="op" id="1822449">.</span><span class="ident" id="1822450">arg</span><span class="op" id="1822453">)</span><span class="op" id="1822454">,</span>&nbsp;<span class="builtintype" id="1822456">uint32</span><span class="op" id="1822462">(</span><span class="ident" id="1822463">cb</span><span class="op" id="1822465">.</span><span class="ident" id="1822466">argsize</span><span class="op" id="1822473">)</span><span class="op" id="1822474">,</span>&nbsp;<span class="num" id="1822476">0</span><span class="op" id="1822477">)</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822481">if</span>&nbsp;<span class="ident" id="1822484">raceenabled</span>&nbsp;<span class="op" id="1822496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822500">racereleasemerge</span><span class="op" id="1822516">(</span><span class="ident" id="1822517">unsafe</span><span class="op" id="1822523">.</span><span class="ident" id="1822524">Pointer</span><span class="op" id="1822531">(</span><span class="op" id="1822532">&amp;</span><span class="ident" id="1822533">racecgosync</span><span class="op" id="1822544">)</span><span class="op" id="1822545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1822548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822552">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;m-&gt;g0-&gt;sched.sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822587">//&nbsp;Our&nbsp;caller,&nbsp;cgocallback,&nbsp;will&nbsp;do&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822630">restore</span>&nbsp;<span class="op" id="1822638">=</span>&nbsp;<span class="builtintype" id="1822640">false</span><br>
<span class="lineno"></span><span class="op" id="1822646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="keyword" id="1822649">func</span>&nbsp;<span class="ident" id="1822654">unwindm</span><span class="op" id="1822661">(</span><span class="ident" id="1822662">restore</span>&nbsp;<span class="op" id="1822670">*</span><span class="builtintype" id="1822671">bool</span><span class="op" id="1822675">)</span>&nbsp;<span class="op" id="1822677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822680">if</span>&nbsp;<span class="op" id="1822683">!</span><span class="op" id="1822684">*</span><span class="ident" id="1822685">restore</span>&nbsp;<span class="op" id="1822693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822697">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1822705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822708">//&nbsp;Restore&nbsp;sp&nbsp;saved&nbsp;by&nbsp;cgocallback&nbsp;during</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1822751">//&nbsp;unwind&nbsp;of&nbsp;g&#39;s&nbsp;stack&nbsp;(see&nbsp;comment&nbsp;at&nbsp;top&nbsp;of&nbsp;file).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822805">mp</span>&nbsp;<span class="op" id="1822808">:=</span>&nbsp;<span class="ident" id="1822811">acquirem</span><span class="op" id="1822819">(</span><span class="op" id="1822820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822823">sched</span>&nbsp;<span class="op" id="1822829">:=</span>&nbsp;<span class="op" id="1822832">&amp;</span><span class="ident" id="1822833">mp</span><span class="op" id="1822835">.</span><span class="ident" id="1822836">g0</span><span class="op" id="1822838">.</span><span class="ident" id="1822839">sched</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822846">switch</span>&nbsp;<span class="ident" id="1822853">GOARCH</span>&nbsp;<span class="op" id="1822860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822863">default</span><span class="op" id="1822870">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822874">gothrow</span><span class="op" id="1822881">(</span><span class="string" id="1822882">&#34;unwindm&nbsp;not&nbsp;implemented&#34;</span><span class="op" id="1822907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822910">case</span>&nbsp;<span class="string" id="1822915">&#34;386&#34;</span><span class="op" id="1822920">,</span>&nbsp;<span class="string" id="1822922">&#34;amd64&#34;</span><span class="op" id="1822929">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822933">sched</span><span class="op" id="1822938">.</span><span class="ident" id="1822939">sp</span>&nbsp;<span class="op" id="1822942">=</span>&nbsp;<span class="op" id="1822944">*</span><span class="op" id="1822945">(</span><span class="op" id="1822946">*</span><span class="builtintype" id="1822947">uintptr</span><span class="op" id="1822954">)</span><span class="op" id="1822955">(</span><span class="ident" id="1822956">unsafe</span><span class="op" id="1822962">.</span><span class="ident" id="1822963">Pointer</span><span class="op" id="1822970">(</span><span class="ident" id="1822971">sched</span><span class="op" id="1822976">.</span><span class="ident" id="1822977">sp</span><span class="op" id="1822979">)</span><span class="op" id="1822980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1822983">case</span>&nbsp;<span class="string" id="1822988">&#34;arm&#34;</span><span class="op" id="1822993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1822997">sched</span><span class="op" id="1823002">.</span><span class="ident" id="1823003">sp</span>&nbsp;<span class="op" id="1823006">=</span>&nbsp;<span class="op" id="1823008">*</span><span class="op" id="1823009">(</span><span class="op" id="1823010">*</span><span class="builtintype" id="1823011">uintptr</span><span class="op" id="1823018">)</span><span class="op" id="1823019">(</span><span class="ident" id="1823020">unsafe</span><span class="op" id="1823026">.</span><span class="ident" id="1823027">Pointer</span><span class="op" id="1823034">(</span><span class="ident" id="1823035">sched</span><span class="op" id="1823040">.</span><span class="ident" id="1823041">sp</span>&nbsp;<span class="op" id="1823044">+</span>&nbsp;<span class="num" id="1823046">4</span><span class="op" id="1823047">)</span><span class="op" id="1823048">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1823051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1823054">releasem</span><span class="op" id="1823062">(</span><span class="ident" id="1823063">mp</span><span class="op" id="1823065">)</span><br>
<span class="lineno"></span><span class="op" id="1823067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1823070">//&nbsp;called&nbsp;from&nbsp;assembly</span><br>
<span class="lineno">270</span><span class="keyword" id="1823094">func</span>&nbsp;<span class="ident" id="1823099">badcgocallback</span><span class="op" id="1823113">(</span><span class="op" id="1823114">)</span>&nbsp;<span class="op" id="1823116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1823119">gothrow</span><span class="op" id="1823126">(</span><span class="string" id="1823127">&#34;misaligned&nbsp;stack&nbsp;in&nbsp;cgocallback&#34;</span><span class="op" id="1823160">)</span><br>
<span class="lineno"></span><span class="op" id="1823162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1823165">//&nbsp;called&nbsp;from&nbsp;(incomplete)&nbsp;assembly</span><br>
<span class="lineno">275</span><span class="keyword" id="1823202">func</span>&nbsp;<span class="ident" id="1823207">cgounimpl</span><span class="op" id="1823216">(</span><span class="op" id="1823217">)</span>&nbsp;<span class="op" id="1823219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1823222">gothrow</span><span class="op" id="1823229">(</span><span class="string" id="1823230">&#34;cgo&nbsp;not&nbsp;implemented&#34;</span><span class="op" id="1823251">)</span><br>
<span class="lineno"></span><span class="op" id="1823253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1823256">var</span>&nbsp;<span class="ident" id="1823260">racecgosync</span>&nbsp;<span class="ident" id="1823272">uint64</span>&nbsp;<span class="comment" id="1823279">//&nbsp;represents&nbsp;possible&nbsp;synchronization&nbsp;in&nbsp;C&nbsp;code</span>
</div>
</body>
</html>
