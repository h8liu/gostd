<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6056773">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6056828">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6056882">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6056933">package</span>&nbsp;<span class="ident" id="6056941">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6056946">import</span>&nbsp;<span class="op" id="6056953">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6056956">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6056965">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6056975">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6056982">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6056987">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6056990">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="6057035">type</span>&nbsp;<span class="ident" id="6057040">writer</span>&nbsp;<span class="keyword" id="6057047">interface</span>&nbsp;<span class="op" id="6057057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057060">io</span><span class="op" id="6057062">.</span><span class="ident" id="6057063">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057075">Flush</span><span class="op" id="6057080">(</span><span class="op" id="6057081">)</span>&nbsp;<span class="builtintype" id="6057083">error</span><br>
<span class="lineno"></span><span class="op" id="6057089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6057092">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6057169">type</span>&nbsp;<span class="ident" id="6057174">errWriteCloser</span>&nbsp;<span class="keyword" id="6057189">struct</span>&nbsp;<span class="op" id="6057196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057199">err</span>&nbsp;<span class="builtintype" id="6057203">error</span><br>
<span class="lineno"></span><span class="op" id="6057209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6057212">func</span>&nbsp;<span class="op" id="6057217">(</span><span class="ident" id="6057218">e</span>&nbsp;<span class="op" id="6057220">*</span><span class="ident" id="6057221">errWriteCloser</span><span class="op" id="6057235">)</span>&nbsp;<span class="ident" id="6057237">Write</span><span class="op" id="6057242">(</span><span class="op" id="6057243">[</span><span class="op" id="6057244">]</span><span class="builtintype" id="6057245">byte</span><span class="op" id="6057249">)</span>&nbsp;<span class="op" id="6057251">(</span><span class="builtintype" id="6057252">int</span><span class="op" id="6057255">,</span>&nbsp;<span class="builtintype" id="6057257">error</span><span class="op" id="6057262">)</span>&nbsp;<span class="op" id="6057264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6057267">return</span>&nbsp;<span class="num" id="6057274">0</span><span class="op" id="6057275">,</span>&nbsp;<span class="ident" id="6057277">e</span><span class="op" id="6057278">.</span><span class="ident" id="6057279">err</span><br>
<span class="lineno"></span><span class="op" id="6057283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6057286">func</span>&nbsp;<span class="op" id="6057291">(</span><span class="ident" id="6057292">e</span>&nbsp;<span class="op" id="6057294">*</span><span class="ident" id="6057295">errWriteCloser</span><span class="op" id="6057309">)</span>&nbsp;<span class="ident" id="6057311">Close</span><span class="op" id="6057316">(</span><span class="op" id="6057317">)</span>&nbsp;<span class="builtintype" id="6057319">error</span>&nbsp;<span class="op" id="6057325">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6057328">return</span>&nbsp;<span class="ident" id="6057335">e</span><span class="op" id="6057336">.</span><span class="ident" id="6057337">err</span><br>
<span class="lineno"></span><span class="op" id="6057341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6057344">const</span>&nbsp;<span class="op" id="6057350">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057353">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057425">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057466">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6057478">=</span>&nbsp;<span class="num" id="6057480">1</span><span class="op" id="6057481">&lt;&lt;</span><span class="num" id="6057483">12</span>&nbsp;<span class="op" id="6057486">-</span>&nbsp;<span class="num" id="6057488">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057491">invalidCode</span>&nbsp;<span class="op" id="6057503">=</span>&nbsp;<span class="num" id="6057505">1</span><span class="op" id="6057506">&lt;&lt;</span><span class="num" id="6057508">32</span>&nbsp;<span class="op" id="6057511">-</span>&nbsp;<span class="num" id="6057513">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057516">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057593">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057672">tableSize</span>&nbsp;<span class="op" id="6057682">=</span>&nbsp;<span class="num" id="6057684">4</span>&nbsp;<span class="op" id="6057686">*</span>&nbsp;<span class="num" id="6057688">1</span>&nbsp;<span class="op" id="6057690">&lt;&lt;</span>&nbsp;<span class="num" id="6057693">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057697">tableMask</span>&nbsp;<span class="op" id="6057707">=</span>&nbsp;<span class="ident" id="6057709">tableSize</span>&nbsp;<span class="op" id="6057719">-</span>&nbsp;<span class="num" id="6057721">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057724">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057795">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057858">invalidEntry</span>&nbsp;<span class="op" id="6057871">=</span>&nbsp;<span class="num" id="6057873">0</span><br>
<span class="lineno">45</span><span class="op" id="6057875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6057878">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="6057908">type</span>&nbsp;<span class="ident" id="6057913">encoder</span>&nbsp;<span class="keyword" id="6057921">struct</span>&nbsp;<span class="op" id="6057928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057931">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6057989">w</span>&nbsp;<span class="ident" id="6057991">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6057999">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058057">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058106">order</span>&nbsp;<span class="ident" id="6058112">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058119">write</span>&nbsp;<span class="keyword" id="6058125">func</span><span class="op" id="6058129">(</span><span class="op" id="6058130">*</span><span class="ident" id="6058131">encoder</span><span class="op" id="6058138">,</span>&nbsp;<span class="builtintype" id="6058140">uint32</span><span class="op" id="6058146">)</span>&nbsp;<span class="builtintype" id="6058148">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058155">bits</span>&nbsp;&nbsp;<span class="builtintype" id="6058161">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058169">nBits</span>&nbsp;<span class="builtintype" id="6058175">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058181">width</span>&nbsp;<span class="builtintype" id="6058187">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058193">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058245">litWidth</span>&nbsp;<span class="builtintype" id="6058254">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058260">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058314">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058377">hi</span><span class="op" id="6058379">,</span>&nbsp;<span class="ident" id="6058381">overflow</span>&nbsp;<span class="builtintype" id="6058390">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058398">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058472">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058536">savedCode</span>&nbsp;<span class="builtintype" id="6058546">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058554">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058629">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058683">err</span>&nbsp;<span class="builtintype" id="6058687">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058694">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058768">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058841">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6058912">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058946">table</span>&nbsp;<span class="op" id="6058952">[</span><span class="ident" id="6058953">tableSize</span><span class="op" id="6058962">]</span><span class="builtintype" id="6058963">uint32</span><br>
<span class="lineno"></span><span class="op" id="6058970">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="6058973">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6059044">func</span>&nbsp;<span class="op" id="6059049">(</span><span class="ident" id="6059050">e</span>&nbsp;<span class="op" id="6059052">*</span><span class="ident" id="6059053">encoder</span><span class="op" id="6059060">)</span>&nbsp;<span class="ident" id="6059062">writeLSB</span><span class="op" id="6059070">(</span><span class="ident" id="6059071">c</span>&nbsp;<span class="builtintype" id="6059073">uint32</span><span class="op" id="6059079">)</span>&nbsp;<span class="builtintype" id="6059081">error</span>&nbsp;<span class="op" id="6059087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059090">e</span><span class="op" id="6059091">.</span><span class="ident" id="6059092">bits</span>&nbsp;<span class="op" id="6059097">|=</span>&nbsp;<span class="ident" id="6059100">c</span>&nbsp;<span class="op" id="6059102">&lt;&lt;</span>&nbsp;<span class="ident" id="6059105">e</span><span class="op" id="6059106">.</span><span class="ident" id="6059107">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059114">e</span><span class="op" id="6059115">.</span><span class="ident" id="6059116">nBits</span>&nbsp;<span class="op" id="6059122">+=</span>&nbsp;<span class="ident" id="6059125">e</span><span class="op" id="6059126">.</span><span class="ident" id="6059127">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059134">for</span>&nbsp;<span class="ident" id="6059138">e</span><span class="op" id="6059139">.</span><span class="ident" id="6059140">nBits</span>&nbsp;<span class="op" id="6059146">&gt;=</span>&nbsp;<span class="num" id="6059149">8</span>&nbsp;<span class="op" id="6059151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059155">if</span>&nbsp;<span class="ident" id="6059158">err</span>&nbsp;<span class="op" id="6059162">:=</span>&nbsp;<span class="ident" id="6059165">e</span><span class="op" id="6059166">.</span><span class="ident" id="6059167">w</span><span class="op" id="6059168">.</span><span class="ident" id="6059169">WriteByte</span><span class="op" id="6059178">(</span><span class="builtintype" id="6059179">uint8</span><span class="op" id="6059184">(</span><span class="ident" id="6059185">e</span><span class="op" id="6059186">.</span><span class="ident" id="6059187">bits</span><span class="op" id="6059191">)</span><span class="op" id="6059192">)</span><span class="op" id="6059193">;</span>&nbsp;<span class="ident" id="6059195">err</span>&nbsp;<span class="op" id="6059199">!=</span>&nbsp;<span class="builtintype" id="6059202">nil</span>&nbsp;<span class="op" id="6059206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059211">return</span>&nbsp;<span class="ident" id="6059218">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6059224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059228">e</span><span class="op" id="6059229">.</span><span class="ident" id="6059230">bits</span>&nbsp;<span class="op" id="6059235">&gt;&gt;=</span>&nbsp;<span class="num" id="6059239">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059243">e</span><span class="op" id="6059244">.</span><span class="ident" id="6059245">nBits</span>&nbsp;<span class="op" id="6059251">-=</span>&nbsp;<span class="num" id="6059254">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6059257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059260">return</span>&nbsp;<span class="builtintype" id="6059267">nil</span><br>
<span class="lineno"></span><span class="op" id="6059271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6059274">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6059344">func</span>&nbsp;<span class="op" id="6059349">(</span><span class="ident" id="6059350">e</span>&nbsp;<span class="op" id="6059352">*</span><span class="ident" id="6059353">encoder</span><span class="op" id="6059360">)</span>&nbsp;<span class="ident" id="6059362">writeMSB</span><span class="op" id="6059370">(</span><span class="ident" id="6059371">c</span>&nbsp;<span class="builtintype" id="6059373">uint32</span><span class="op" id="6059379">)</span>&nbsp;<span class="builtintype" id="6059381">error</span>&nbsp;<span class="op" id="6059387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059390">e</span><span class="op" id="6059391">.</span><span class="ident" id="6059392">bits</span>&nbsp;<span class="op" id="6059397">|=</span>&nbsp;<span class="ident" id="6059400">c</span>&nbsp;<span class="op" id="6059402">&lt;&lt;</span>&nbsp;<span class="op" id="6059405">(</span><span class="num" id="6059406">32</span>&nbsp;<span class="op" id="6059409">-</span>&nbsp;<span class="ident" id="6059411">e</span><span class="op" id="6059412">.</span><span class="ident" id="6059413">width</span>&nbsp;<span class="op" id="6059419">-</span>&nbsp;<span class="ident" id="6059421">e</span><span class="op" id="6059422">.</span><span class="ident" id="6059423">nBits</span><span class="op" id="6059428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059431">e</span><span class="op" id="6059432">.</span><span class="ident" id="6059433">nBits</span>&nbsp;<span class="op" id="6059439">+=</span>&nbsp;<span class="ident" id="6059442">e</span><span class="op" id="6059443">.</span><span class="ident" id="6059444">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059451">for</span>&nbsp;<span class="ident" id="6059455">e</span><span class="op" id="6059456">.</span><span class="ident" id="6059457">nBits</span>&nbsp;<span class="op" id="6059463">&gt;=</span>&nbsp;<span class="num" id="6059466">8</span>&nbsp;<span class="op" id="6059468">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059472">if</span>&nbsp;<span class="ident" id="6059475">err</span>&nbsp;<span class="op" id="6059479">:=</span>&nbsp;<span class="ident" id="6059482">e</span><span class="op" id="6059483">.</span><span class="ident" id="6059484">w</span><span class="op" id="6059485">.</span><span class="ident" id="6059486">WriteByte</span><span class="op" id="6059495">(</span><span class="builtintype" id="6059496">uint8</span><span class="op" id="6059501">(</span><span class="ident" id="6059502">e</span><span class="op" id="6059503">.</span><span class="ident" id="6059504">bits</span>&nbsp;<span class="op" id="6059509">&gt;&gt;</span>&nbsp;<span class="num" id="6059512">24</span><span class="op" id="6059514">)</span><span class="op" id="6059515">)</span><span class="op" id="6059516">;</span>&nbsp;<span class="ident" id="6059518">err</span>&nbsp;<span class="op" id="6059522">!=</span>&nbsp;<span class="builtintype" id="6059525">nil</span>&nbsp;<span class="op" id="6059529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059534">return</span>&nbsp;<span class="ident" id="6059541">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6059547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059551">e</span><span class="op" id="6059552">.</span><span class="ident" id="6059553">bits</span>&nbsp;<span class="op" id="6059558">&lt;&lt;=</span>&nbsp;<span class="num" id="6059562">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6059566">e</span><span class="op" id="6059567">.</span><span class="ident" id="6059568">nBits</span>&nbsp;<span class="op" id="6059574">-=</span>&nbsp;<span class="num" id="6059577">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6059580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6059583">return</span>&nbsp;<span class="builtintype" id="6059590">nil</span><br>
<span class="lineno"></span><span class="op" id="6059594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6059597">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="6059675">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="6059734">var</span>&nbsp;<span class="ident" id="6059738">errOutOfCodes</span>&nbsp;<span class="op" id="6059752">=</span>&nbsp;<span class="ident" id="6059754">errors</span><span class="op" id="6059760">.</span><span class="ident" id="6059761">New</span><span class="op" id="6059764">(</span><span class="string" id="6059765">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="6059784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6059787">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6059860">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="6059934">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="6059978">func</span>&nbsp;<span class="op" id="6059983">(</span><span class="ident" id="6059984">e</span>&nbsp;<span class="op" id="6059986">*</span><span class="ident" id="6059987">encoder</span><span class="op" id="6059994">)</span>&nbsp;<span class="ident" id="6059996">incHi</span><span class="op" id="6060001">(</span><span class="op" id="6060002">)</span>&nbsp;<span class="builtintype" id="6060004">error</span>&nbsp;<span class="op" id="6060010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060013">e</span><span class="op" id="6060014">.</span><span class="ident" id="6060015">hi</span><span class="op" id="6060017">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060021">if</span>&nbsp;<span class="ident" id="6060024">e</span><span class="op" id="6060025">.</span><span class="ident" id="6060026">hi</span>&nbsp;<span class="op" id="6060029">==</span>&nbsp;<span class="ident" id="6060032">e</span><span class="op" id="6060033">.</span><span class="ident" id="6060034">overflow</span>&nbsp;<span class="op" id="6060043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060047">e</span><span class="op" id="6060048">.</span><span class="ident" id="6060049">width</span><span class="op" id="6060054">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060059">e</span><span class="op" id="6060060">.</span><span class="ident" id="6060061">overflow</span>&nbsp;<span class="op" id="6060070">&lt;&lt;=</span>&nbsp;<span class="num" id="6060074">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060080">if</span>&nbsp;<span class="ident" id="6060083">e</span><span class="op" id="6060084">.</span><span class="ident" id="6060085">hi</span>&nbsp;<span class="op" id="6060088">==</span>&nbsp;<span class="ident" id="6060091">maxCode</span>&nbsp;<span class="op" id="6060099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060103">clear</span>&nbsp;<span class="op" id="6060109">:=</span>&nbsp;<span class="builtintype" id="6060112">uint32</span><span class="op" id="6060118">(</span><span class="num" id="6060119">1</span><span class="op" id="6060120">)</span>&nbsp;<span class="op" id="6060122">&lt;&lt;</span>&nbsp;<span class="ident" id="6060125">e</span><span class="op" id="6060126">.</span><span class="ident" id="6060127">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060138">if</span>&nbsp;<span class="ident" id="6060141">err</span>&nbsp;<span class="op" id="6060145">:=</span>&nbsp;<span class="ident" id="6060148">e</span><span class="op" id="6060149">.</span><span class="ident" id="6060150">write</span><span class="op" id="6060155">(</span><span class="ident" id="6060156">e</span><span class="op" id="6060157">,</span>&nbsp;<span class="ident" id="6060159">clear</span><span class="op" id="6060164">)</span><span class="op" id="6060165">;</span>&nbsp;<span class="ident" id="6060167">err</span>&nbsp;<span class="op" id="6060171">!=</span>&nbsp;<span class="builtintype" id="6060174">nil</span>&nbsp;<span class="op" id="6060178">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060183">return</span>&nbsp;<span class="ident" id="6060190">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060200">e</span><span class="op" id="6060201">.</span><span class="ident" id="6060202">width</span>&nbsp;<span class="op" id="6060208">=</span>&nbsp;<span class="builtintype" id="6060210">uint</span><span class="op" id="6060214">(</span><span class="ident" id="6060215">e</span><span class="op" id="6060216">.</span><span class="ident" id="6060217">litWidth</span><span class="op" id="6060225">)</span>&nbsp;<span class="op" id="6060227">+</span>&nbsp;<span class="num" id="6060229">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060233">e</span><span class="op" id="6060234">.</span><span class="ident" id="6060235">hi</span>&nbsp;<span class="op" id="6060238">=</span>&nbsp;<span class="ident" id="6060240">clear</span>&nbsp;<span class="op" id="6060246">+</span>&nbsp;<span class="num" id="6060248">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060252">e</span><span class="op" id="6060253">.</span><span class="ident" id="6060254">overflow</span>&nbsp;<span class="op" id="6060263">=</span>&nbsp;<span class="ident" id="6060265">clear</span>&nbsp;<span class="op" id="6060271">&lt;&lt;</span>&nbsp;<span class="num" id="6060274">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060278">for</span>&nbsp;<span class="ident" id="6060282">i</span>&nbsp;<span class="op" id="6060284">:=</span>&nbsp;<span class="keyword" id="6060287">range</span>&nbsp;<span class="ident" id="6060293">e</span><span class="op" id="6060294">.</span><span class="ident" id="6060295">table</span>&nbsp;<span class="op" id="6060301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060306">e</span><span class="op" id="6060307">.</span><span class="ident" id="6060308">table</span><span class="op" id="6060313">[</span><span class="ident" id="6060314">i</span><span class="op" id="6060315">]</span>&nbsp;<span class="op" id="6060317">=</span>&nbsp;<span class="ident" id="6060319">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060338">return</span>&nbsp;<span class="ident" id="6060345">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060360">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060363">return</span>&nbsp;<span class="builtintype" id="6060370">nil</span><br>
<span class="lineno"></span><span class="op" id="6060374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6060377">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6060452">func</span>&nbsp;<span class="op" id="6060457">(</span><span class="ident" id="6060458">e</span>&nbsp;<span class="op" id="6060460">*</span><span class="ident" id="6060461">encoder</span><span class="op" id="6060468">)</span>&nbsp;<span class="ident" id="6060470">Write</span><span class="op" id="6060475">(</span><span class="ident" id="6060476">p</span>&nbsp;<span class="op" id="6060478">[</span><span class="op" id="6060479">]</span><span class="builtintype" id="6060480">byte</span><span class="op" id="6060484">)</span>&nbsp;<span class="op" id="6060486">(</span><span class="ident" id="6060487">n</span>&nbsp;<span class="builtintype" id="6060489">int</span><span class="op" id="6060492">,</span>&nbsp;<span class="ident" id="6060494">err</span>&nbsp;<span class="builtintype" id="6060498">error</span><span class="op" id="6060503">)</span>&nbsp;<span class="op" id="6060505">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060508">if</span>&nbsp;<span class="ident" id="6060511">e</span><span class="op" id="6060512">.</span><span class="ident" id="6060513">err</span>&nbsp;<span class="op" id="6060517">!=</span>&nbsp;<span class="builtintype" id="6060520">nil</span>&nbsp;<span class="op" id="6060524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060528">return</span>&nbsp;<span class="num" id="6060535">0</span><span class="op" id="6060536">,</span>&nbsp;<span class="ident" id="6060538">e</span><span class="op" id="6060539">.</span><span class="ident" id="6060540">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060548">if</span>&nbsp;<span class="builtinfunc" id="6060551">len</span><span class="op" id="6060554">(</span><span class="ident" id="6060555">p</span><span class="op" id="6060556">)</span>&nbsp;<span class="op" id="6060558">==</span>&nbsp;<span class="num" id="6060561">0</span>&nbsp;<span class="op" id="6060563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060567">return</span>&nbsp;<span class="num" id="6060574">0</span><span class="op" id="6060575">,</span>&nbsp;<span class="builtintype" id="6060577">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060585">n</span>&nbsp;<span class="op" id="6060587">=</span>&nbsp;<span class="builtinfunc" id="6060589">len</span><span class="op" id="6060592">(</span><span class="ident" id="6060593">p</span><span class="op" id="6060594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060597">litMask</span>&nbsp;<span class="op" id="6060605">:=</span>&nbsp;<span class="builtintype" id="6060608">uint32</span><span class="op" id="6060614">(</span><span class="num" id="6060615">1</span><span class="op" id="6060616">&lt;&lt;</span><span class="ident" id="6060618">e</span><span class="op" id="6060619">.</span><span class="ident" id="6060620">litWidth</span>&nbsp;<span class="op" id="6060629">-</span>&nbsp;<span class="num" id="6060631">1</span><span class="op" id="6060632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060635">code</span>&nbsp;<span class="op" id="6060640">:=</span>&nbsp;<span class="ident" id="6060643">e</span><span class="op" id="6060644">.</span><span class="ident" id="6060645">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060656">if</span>&nbsp;<span class="ident" id="6060659">code</span>&nbsp;<span class="op" id="6060664">==</span>&nbsp;<span class="ident" id="6060667">invalidCode</span>&nbsp;<span class="op" id="6060679">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6060683">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060734">code</span><span class="op" id="6060738">,</span>&nbsp;<span class="ident" id="6060740">p</span>&nbsp;<span class="op" id="6060742">=</span>&nbsp;<span class="builtintype" id="6060744">uint32</span><span class="op" id="6060750">(</span><span class="ident" id="6060751">p</span><span class="op" id="6060752">[</span><span class="num" id="6060753">0</span><span class="op" id="6060754">]</span><span class="op" id="6060755">)</span><span class="op" id="6060756">&amp;</span><span class="ident" id="6060757">litMask</span><span class="op" id="6060764">,</span>&nbsp;<span class="ident" id="6060766">p</span><span class="op" id="6060767">[</span><span class="num" id="6060768">1</span><span class="op" id="6060769">:</span><span class="op" id="6060770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6060773">}</span><br>
<span class="lineno"></span><span class="ident" id="6060775">loop</span><span class="op" id="6060779">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6060782">for</span>&nbsp;<span class="ident" id="6060786">_</span><span class="op" id="6060787">,</span>&nbsp;<span class="ident" id="6060789">x</span>&nbsp;<span class="op" id="6060791">:=</span>&nbsp;<span class="keyword" id="6060794">range</span>&nbsp;<span class="ident" id="6060800">p</span>&nbsp;<span class="op" id="6060802">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060806">literal</span>&nbsp;<span class="op" id="6060814">:=</span>&nbsp;<span class="builtintype" id="6060817">uint32</span><span class="op" id="6060823">(</span><span class="ident" id="6060824">x</span><span class="op" id="6060825">)</span>&nbsp;<span class="op" id="6060827">&amp;</span>&nbsp;<span class="ident" id="6060829">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060839">key</span>&nbsp;<span class="op" id="6060843">:=</span>&nbsp;<span class="ident" id="6060846">code</span><span class="op" id="6060850">&lt;&lt;</span><span class="num" id="6060852">8</span>&nbsp;<span class="op" id="6060854">|</span>&nbsp;<span class="ident" id="6060856">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6060866">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6060939">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6060972">hash</span>&nbsp;<span class="op" id="6060977">:=</span>&nbsp;<span class="op" id="6060980">(</span><span class="ident" id="6060981">key</span><span class="op" id="6060984">&gt;&gt;</span><span class="num" id="6060986">12</span>&nbsp;<span class="op" id="6060989">^</span>&nbsp;<span class="ident" id="6060991">key</span><span class="op" id="6060994">)</span>&nbsp;<span class="op" id="6060996">&amp;</span>&nbsp;<span class="ident" id="6060998">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061010">for</span>&nbsp;<span class="ident" id="6061014">h</span><span class="op" id="6061015">,</span>&nbsp;<span class="ident" id="6061017">t</span>&nbsp;<span class="op" id="6061019">:=</span>&nbsp;<span class="ident" id="6061022">hash</span><span class="op" id="6061026">,</span>&nbsp;<span class="ident" id="6061028">e</span><span class="op" id="6061029">.</span><span class="ident" id="6061030">table</span><span class="op" id="6061035">[</span><span class="ident" id="6061036">hash</span><span class="op" id="6061040">]</span><span class="op" id="6061041">;</span>&nbsp;<span class="ident" id="6061043">t</span>&nbsp;<span class="op" id="6061045">!=</span>&nbsp;<span class="ident" id="6061048">invalidEntry</span><span class="op" id="6061060">;</span>&nbsp;<span class="op" id="6061062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061067">if</span>&nbsp;<span class="ident" id="6061070">key</span>&nbsp;<span class="op" id="6061074">==</span>&nbsp;<span class="ident" id="6061077">t</span><span class="op" id="6061078">&gt;&gt;</span><span class="num" id="6061080">12</span>&nbsp;<span class="op" id="6061083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061089">code</span>&nbsp;<span class="op" id="6061094">=</span>&nbsp;<span class="ident" id="6061096">t</span>&nbsp;<span class="op" id="6061098">&amp;</span>&nbsp;<span class="ident" id="6061100">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061112">continue</span>&nbsp;<span class="ident" id="6061121">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061129">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061134">h</span>&nbsp;<span class="op" id="6061136">=</span>&nbsp;<span class="op" id="6061138">(</span><span class="ident" id="6061139">h</span>&nbsp;<span class="op" id="6061141">+</span>&nbsp;<span class="num" id="6061143">1</span><span class="op" id="6061144">)</span>&nbsp;<span class="op" id="6061146">&amp;</span>&nbsp;<span class="ident" id="6061148">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061161">t</span>&nbsp;<span class="op" id="6061163">=</span>&nbsp;<span class="ident" id="6061165">e</span><span class="op" id="6061166">.</span><span class="ident" id="6061167">table</span><span class="op" id="6061172">[</span><span class="ident" id="6061173">h</span><span class="op" id="6061174">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6061182">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6061255">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061283">if</span>&nbsp;<span class="ident" id="6061286">e</span><span class="op" id="6061287">.</span><span class="ident" id="6061288">err</span>&nbsp;<span class="op" id="6061292">=</span>&nbsp;<span class="ident" id="6061294">e</span><span class="op" id="6061295">.</span><span class="ident" id="6061296">write</span><span class="op" id="6061301">(</span><span class="ident" id="6061302">e</span><span class="op" id="6061303">,</span>&nbsp;<span class="ident" id="6061305">code</span><span class="op" id="6061309">)</span><span class="op" id="6061310">;</span>&nbsp;<span class="ident" id="6061312">e</span><span class="op" id="6061313">.</span><span class="ident" id="6061314">err</span>&nbsp;<span class="op" id="6061318">!=</span>&nbsp;<span class="builtintype" id="6061321">nil</span>&nbsp;<span class="op" id="6061325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061330">return</span>&nbsp;<span class="num" id="6061337">0</span><span class="op" id="6061338">,</span>&nbsp;<span class="ident" id="6061340">e</span><span class="op" id="6061341">.</span><span class="ident" id="6061342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061352">code</span>&nbsp;<span class="op" id="6061357">=</span>&nbsp;<span class="ident" id="6061359">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6061369">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6061443">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061516">if</span>&nbsp;<span class="ident" id="6061519">err1</span>&nbsp;<span class="op" id="6061524">:=</span>&nbsp;<span class="ident" id="6061527">e</span><span class="op" id="6061528">.</span><span class="ident" id="6061529">incHi</span><span class="op" id="6061534">(</span><span class="op" id="6061535">)</span><span class="op" id="6061536">;</span>&nbsp;<span class="ident" id="6061538">err1</span>&nbsp;<span class="op" id="6061543">!=</span>&nbsp;<span class="builtintype" id="6061546">nil</span>&nbsp;<span class="op" id="6061550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061555">if</span>&nbsp;<span class="ident" id="6061558">err1</span>&nbsp;<span class="op" id="6061563">==</span>&nbsp;<span class="ident" id="6061566">errOutOfCodes</span>&nbsp;<span class="op" id="6061580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061586">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061598">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061603">e</span><span class="op" id="6061604">.</span><span class="ident" id="6061605">err</span>&nbsp;<span class="op" id="6061609">=</span>&nbsp;<span class="ident" id="6061611">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061619">return</span>&nbsp;<span class="num" id="6061626">0</span><span class="op" id="6061627">,</span>&nbsp;<span class="ident" id="6061629">e</span><span class="op" id="6061630">.</span><span class="ident" id="6061631">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6061641">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061714">for</span>&nbsp;<span class="op" id="6061718">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061723">if</span>&nbsp;<span class="ident" id="6061726">e</span><span class="op" id="6061727">.</span><span class="ident" id="6061728">table</span><span class="op" id="6061733">[</span><span class="ident" id="6061734">hash</span><span class="op" id="6061738">]</span>&nbsp;<span class="op" id="6061740">==</span>&nbsp;<span class="ident" id="6061743">invalidEntry</span>&nbsp;<span class="op" id="6061756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061762">e</span><span class="op" id="6061763">.</span><span class="ident" id="6061764">table</span><span class="op" id="6061769">[</span><span class="ident" id="6061770">hash</span><span class="op" id="6061774">]</span>&nbsp;<span class="op" id="6061776">=</span>&nbsp;<span class="op" id="6061778">(</span><span class="ident" id="6061779">key</span>&nbsp;<span class="op" id="6061783">&lt;&lt;</span>&nbsp;<span class="num" id="6061786">12</span><span class="op" id="6061788">)</span>&nbsp;<span class="op" id="6061790">|</span>&nbsp;<span class="ident" id="6061792">e</span><span class="op" id="6061793">.</span><span class="ident" id="6061794">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061801">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061815">hash</span>&nbsp;<span class="op" id="6061820">=</span>&nbsp;<span class="op" id="6061822">(</span><span class="ident" id="6061823">hash</span>&nbsp;<span class="op" id="6061828">+</span>&nbsp;<span class="num" id="6061830">1</span><span class="op" id="6061831">)</span>&nbsp;<span class="op" id="6061833">&amp;</span>&nbsp;<span class="ident" id="6061835">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6061850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6061853">e</span><span class="op" id="6061854">.</span><span class="ident" id="6061855">savedCode</span>&nbsp;<span class="op" id="6061865">=</span>&nbsp;<span class="ident" id="6061867">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6061873">return</span>&nbsp;<span class="ident" id="6061880">n</span><span class="op" id="6061881">,</span>&nbsp;<span class="builtintype" id="6061883">nil</span><br>
<span class="lineno"></span><span class="op" id="6061887">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="6061890">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6061969">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6062001">func</span>&nbsp;<span class="op" id="6062006">(</span><span class="ident" id="6062007">e</span>&nbsp;<span class="op" id="6062009">*</span><span class="ident" id="6062010">encoder</span><span class="op" id="6062017">)</span>&nbsp;<span class="ident" id="6062019">Close</span><span class="op" id="6062024">(</span><span class="op" id="6062025">)</span>&nbsp;<span class="builtintype" id="6062027">error</span>&nbsp;<span class="op" id="6062033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062036">if</span>&nbsp;<span class="ident" id="6062039">e</span><span class="op" id="6062040">.</span><span class="ident" id="6062041">err</span>&nbsp;<span class="op" id="6062045">!=</span>&nbsp;<span class="builtintype" id="6062048">nil</span>&nbsp;<span class="op" id="6062052">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062056">if</span>&nbsp;<span class="ident" id="6062059">e</span><span class="op" id="6062060">.</span><span class="ident" id="6062061">err</span>&nbsp;<span class="op" id="6062065">==</span>&nbsp;<span class="ident" id="6062068">errClosed</span>&nbsp;<span class="op" id="6062078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062083">return</span>&nbsp;<span class="builtintype" id="6062090">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062100">return</span>&nbsp;<span class="ident" id="6062107">e</span><span class="op" id="6062108">.</span><span class="ident" id="6062109">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062114">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6062117">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062170">e</span><span class="op" id="6062171">.</span><span class="ident" id="6062172">err</span>&nbsp;<span class="op" id="6062176">=</span>&nbsp;<span class="ident" id="6062178">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6062189">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062223">if</span>&nbsp;<span class="ident" id="6062226">e</span><span class="op" id="6062227">.</span><span class="ident" id="6062228">savedCode</span>&nbsp;<span class="op" id="6062238">!=</span>&nbsp;<span class="ident" id="6062241">invalidCode</span>&nbsp;<span class="op" id="6062253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062257">if</span>&nbsp;<span class="ident" id="6062260">err</span>&nbsp;<span class="op" id="6062264">:=</span>&nbsp;<span class="ident" id="6062267">e</span><span class="op" id="6062268">.</span><span class="ident" id="6062269">write</span><span class="op" id="6062274">(</span><span class="ident" id="6062275">e</span><span class="op" id="6062276">,</span>&nbsp;<span class="ident" id="6062278">e</span><span class="op" id="6062279">.</span><span class="ident" id="6062280">savedCode</span><span class="op" id="6062289">)</span><span class="op" id="6062290">;</span>&nbsp;<span class="ident" id="6062292">err</span>&nbsp;<span class="op" id="6062296">!=</span>&nbsp;<span class="builtintype" id="6062299">nil</span>&nbsp;<span class="op" id="6062303">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062308">return</span>&nbsp;<span class="ident" id="6062315">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062325">if</span>&nbsp;<span class="ident" id="6062328">err</span>&nbsp;<span class="op" id="6062332">:=</span>&nbsp;<span class="ident" id="6062335">e</span><span class="op" id="6062336">.</span><span class="ident" id="6062337">incHi</span><span class="op" id="6062342">(</span><span class="op" id="6062343">)</span><span class="op" id="6062344">;</span>&nbsp;<span class="ident" id="6062346">err</span>&nbsp;<span class="op" id="6062350">!=</span>&nbsp;<span class="builtintype" id="6062353">nil</span>&nbsp;<span class="op" id="6062357">&amp;&amp;</span>&nbsp;<span class="ident" id="6062360">err</span>&nbsp;<span class="op" id="6062364">!=</span>&nbsp;<span class="ident" id="6062367">errOutOfCodes</span>&nbsp;<span class="op" id="6062381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062386">return</span>&nbsp;<span class="ident" id="6062393">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062399">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6062405">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062429">eof</span>&nbsp;<span class="op" id="6062433">:=</span>&nbsp;<span class="builtintype" id="6062436">uint32</span><span class="op" id="6062442">(</span><span class="num" id="6062443">1</span><span class="op" id="6062444">)</span><span class="op" id="6062445">&lt;&lt;</span><span class="ident" id="6062447">e</span><span class="op" id="6062448">.</span><span class="ident" id="6062449">litWidth</span>&nbsp;<span class="op" id="6062458">+</span>&nbsp;<span class="num" id="6062460">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062463">if</span>&nbsp;<span class="ident" id="6062466">err</span>&nbsp;<span class="op" id="6062470">:=</span>&nbsp;<span class="ident" id="6062473">e</span><span class="op" id="6062474">.</span><span class="ident" id="6062475">write</span><span class="op" id="6062480">(</span><span class="ident" id="6062481">e</span><span class="op" id="6062482">,</span>&nbsp;<span class="ident" id="6062484">eof</span><span class="op" id="6062487">)</span><span class="op" id="6062488">;</span>&nbsp;<span class="ident" id="6062490">err</span>&nbsp;<span class="op" id="6062494">!=</span>&nbsp;<span class="builtintype" id="6062497">nil</span>&nbsp;<span class="op" id="6062501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062505">return</span>&nbsp;<span class="ident" id="6062512">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6062520">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062546">if</span>&nbsp;<span class="ident" id="6062549">e</span><span class="op" id="6062550">.</span><span class="ident" id="6062551">nBits</span>&nbsp;<span class="op" id="6062557">&gt;</span>&nbsp;<span class="num" id="6062559">0</span>&nbsp;<span class="op" id="6062561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062565">if</span>&nbsp;<span class="ident" id="6062568">e</span><span class="op" id="6062569">.</span><span class="ident" id="6062570">order</span>&nbsp;<span class="op" id="6062576">==</span>&nbsp;<span class="ident" id="6062579">MSB</span>&nbsp;<span class="op" id="6062583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6062588">e</span><span class="op" id="6062589">.</span><span class="ident" id="6062590">bits</span>&nbsp;<span class="op" id="6062595">&gt;&gt;=</span>&nbsp;<span class="num" id="6062599">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062608">if</span>&nbsp;<span class="ident" id="6062611">err</span>&nbsp;<span class="op" id="6062615">:=</span>&nbsp;<span class="ident" id="6062618">e</span><span class="op" id="6062619">.</span><span class="ident" id="6062620">w</span><span class="op" id="6062621">.</span><span class="ident" id="6062622">WriteByte</span><span class="op" id="6062631">(</span><span class="builtintype" id="6062632">uint8</span><span class="op" id="6062637">(</span><span class="ident" id="6062638">e</span><span class="op" id="6062639">.</span><span class="ident" id="6062640">bits</span><span class="op" id="6062644">)</span><span class="op" id="6062645">)</span><span class="op" id="6062646">;</span>&nbsp;<span class="ident" id="6062648">err</span>&nbsp;<span class="op" id="6062652">!=</span>&nbsp;<span class="builtintype" id="6062655">nil</span>&nbsp;<span class="op" id="6062659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062664">return</span>&nbsp;<span class="ident" id="6062671">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6062680">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6062683">return</span>&nbsp;<span class="ident" id="6062690">e</span><span class="op" id="6062691">.</span><span class="ident" id="6062692">w</span><span class="op" id="6062693">.</span><span class="ident" id="6062694">Flush</span><span class="op" id="6062699">(</span><span class="op" id="6062700">)</span><br>
<span class="lineno"></span><span class="op" id="6062702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6062705">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="6062748">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="6062822">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6062897">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="6062918">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6062991">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="6063026">func</span>&nbsp;<span class="ident" id="6063031">NewWriter</span><span class="op" id="6063040">(</span><span class="ident" id="6063041">w</span>&nbsp;<span class="ident" id="6063043">io</span><span class="op" id="6063045">.</span><span class="ident" id="6063046">Writer</span><span class="op" id="6063052">,</span>&nbsp;<span class="ident" id="6063054">order</span>&nbsp;<span class="ident" id="6063060">Order</span><span class="op" id="6063065">,</span>&nbsp;<span class="ident" id="6063067">litWidth</span>&nbsp;<span class="builtintype" id="6063076">int</span><span class="op" id="6063079">)</span>&nbsp;<span class="ident" id="6063081">io</span><span class="op" id="6063083">.</span><span class="ident" id="6063084">WriteCloser</span>&nbsp;<span class="op" id="6063096">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063099">var</span>&nbsp;<span class="ident" id="6063103">write</span>&nbsp;<span class="keyword" id="6063109">func</span><span class="op" id="6063113">(</span><span class="op" id="6063114">*</span><span class="ident" id="6063115">encoder</span><span class="op" id="6063122">,</span>&nbsp;<span class="builtintype" id="6063124">uint32</span><span class="op" id="6063130">)</span>&nbsp;<span class="builtintype" id="6063132">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063139">switch</span>&nbsp;<span class="ident" id="6063146">order</span>&nbsp;<span class="op" id="6063152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063155">case</span>&nbsp;<span class="ident" id="6063160">LSB</span><span class="op" id="6063163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063167">write</span>&nbsp;<span class="op" id="6063173">=</span>&nbsp;<span class="op" id="6063175">(</span><span class="op" id="6063176">*</span><span class="ident" id="6063177">encoder</span><span class="op" id="6063184">)</span><span class="op" id="6063185">.</span><span class="ident" id="6063186">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063196">case</span>&nbsp;<span class="ident" id="6063201">MSB</span><span class="op" id="6063204">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063208">write</span>&nbsp;<span class="op" id="6063214">=</span>&nbsp;<span class="op" id="6063216">(</span><span class="op" id="6063217">*</span><span class="ident" id="6063218">encoder</span><span class="op" id="6063225">)</span><span class="op" id="6063226">.</span><span class="ident" id="6063227">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063237">default</span><span class="op" id="6063244">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063248">return</span>&nbsp;<span class="op" id="6063255">&amp;</span><span class="ident" id="6063256">errWriteCloser</span><span class="op" id="6063270">{</span><span class="ident" id="6063271">errors</span><span class="op" id="6063277">.</span><span class="ident" id="6063278">New</span><span class="op" id="6063281">(</span><span class="string" id="6063282">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="6063302">)</span><span class="op" id="6063303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6063306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063309">if</span>&nbsp;<span class="ident" id="6063312">litWidth</span>&nbsp;<span class="op" id="6063321">&lt;</span>&nbsp;<span class="num" id="6063323">2</span>&nbsp;<span class="op" id="6063325">||</span>&nbsp;<span class="num" id="6063328">8</span>&nbsp;<span class="op" id="6063330">&lt;</span>&nbsp;<span class="ident" id="6063332">litWidth</span>&nbsp;<span class="op" id="6063341">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063345">return</span>&nbsp;<span class="op" id="6063352">&amp;</span><span class="ident" id="6063353">errWriteCloser</span><span class="op" id="6063367">{</span><span class="ident" id="6063368">fmt</span><span class="op" id="6063371">.</span><span class="ident" id="6063372">Errorf</span><span class="op" id="6063378">(</span><span class="string" id="6063379">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6063410">,</span>&nbsp;<span class="ident" id="6063412">litWidth</span><span class="op" id="6063420">)</span><span class="op" id="6063421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6063424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063427">bw</span><span class="op" id="6063429">,</span>&nbsp;<span class="ident" id="6063431">ok</span>&nbsp;<span class="op" id="6063434">:=</span>&nbsp;<span class="ident" id="6063437">w</span><span class="op" id="6063438">.</span><span class="op" id="6063439">(</span><span class="ident" id="6063440">writer</span><span class="op" id="6063446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063449">if</span>&nbsp;<span class="op" id="6063452">!</span><span class="ident" id="6063453">ok</span>&nbsp;<span class="op" id="6063456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063460">bw</span>&nbsp;<span class="op" id="6063463">=</span>&nbsp;<span class="ident" id="6063465">bufio</span><span class="op" id="6063470">.</span><span class="ident" id="6063471">NewWriter</span><span class="op" id="6063480">(</span><span class="ident" id="6063481">w</span><span class="op" id="6063482">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6063485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063488">lw</span>&nbsp;<span class="op" id="6063491">:=</span>&nbsp;<span class="builtintype" id="6063494">uint</span><span class="op" id="6063498">(</span><span class="ident" id="6063499">litWidth</span><span class="op" id="6063507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6063510">return</span>&nbsp;<span class="op" id="6063517">&amp;</span><span class="ident" id="6063518">encoder</span><span class="op" id="6063525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063529">w</span><span class="op" id="6063530">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063540">bw</span><span class="op" id="6063542">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063546">order</span><span class="op" id="6063551">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063557">order</span><span class="op" id="6063562">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063566">write</span><span class="op" id="6063571">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063577">write</span><span class="op" id="6063582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063586">width</span><span class="op" id="6063591">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6063597">1</span>&nbsp;<span class="op" id="6063599">+</span>&nbsp;<span class="ident" id="6063601">lw</span><span class="op" id="6063603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063607">litWidth</span><span class="op" id="6063615">:</span>&nbsp;&nbsp;<span class="ident" id="6063618">lw</span><span class="op" id="6063620">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063624">hi</span><span class="op" id="6063626">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6063635">1</span><span class="op" id="6063636">&lt;&lt;</span><span class="ident" id="6063638">lw</span>&nbsp;<span class="op" id="6063641">+</span>&nbsp;<span class="num" id="6063643">1</span><span class="op" id="6063644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063648">overflow</span><span class="op" id="6063656">:</span>&nbsp;&nbsp;<span class="num" id="6063659">1</span>&nbsp;<span class="op" id="6063661">&lt;&lt;</span>&nbsp;<span class="op" id="6063664">(</span><span class="ident" id="6063665">lw</span>&nbsp;<span class="op" id="6063668">+</span>&nbsp;<span class="num" id="6063670">1</span><span class="op" id="6063671">)</span><span class="op" id="6063672">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6063676">savedCode</span><span class="op" id="6063685">:</span>&nbsp;<span class="ident" id="6063687">invalidCode</span><span class="op" id="6063698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6063701">}</span><br>
<span class="lineno"></span><span class="op" id="6063703">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
