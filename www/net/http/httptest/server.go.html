<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4813595">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4813650">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4813704">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4813755">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4813784">package</span>&nbsp;<span class="ident" id="4813792">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4813802">import</span>&nbsp;<span class="op" id="4813809">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813812">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813826">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813834">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813841">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813848">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813860">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4813866">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4813873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4813876">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="4813947">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="4814010">type</span>&nbsp;<span class="ident" id="4814015">Server</span>&nbsp;<span class="keyword" id="4814022">struct</span>&nbsp;<span class="op" id="4814029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814032">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4814041">string</span>&nbsp;<span class="comment" id="4814048">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814111">Listener</span>&nbsp;<span class="ident" id="4814120"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4814123">.</span><span class="ident" id="4814124">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814135">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814206">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814278">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814341">TLS</span>&nbsp;<span class="op" id="4814345">*</span><span class="ident" id="4814346"><a href="/net/http/httptest/server.go.html#4813812">tls</a></span><span class="op" id="4814349">.</span><span class="ident" id="4814350">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814359">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814422">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814452">Config</span>&nbsp;<span class="op" id="4814459">*</span><span class="ident" id="4814460"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4814464">.</span><span class="ident" id="4814465">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814474">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4814544">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814594">wg</span>&nbsp;<span class="ident" id="4814597"><a href="/net/http/httptest/server.go.html#4813866">sync</a></span><span class="op" id="4814601">.</span><span class="ident" id="4814602">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="4814612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4814615">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="4814680">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="4814693">type</span>&nbsp;<span class="ident" id="4814698">historyListener</span>&nbsp;<span class="keyword" id="4814714">struct</span>&nbsp;<span class="op" id="4814721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814724"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4814727">.</span><span class="ident" id="4814728">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814738"><a href="/net/http/httptest/server.go.html#4813866">sync</a></span><span class="op" id="4814742">.</span><span class="ident" id="4814743">Mutex</span>&nbsp;<span class="comment" id="4814749">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814770">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4814781">[</span><span class="op" id="4814782">]</span><span class="ident" id="4814783"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4814786">.</span><span class="ident" id="4814787">Conn</span><br>
<span class="lineno">45</span><span class="op" id="4814792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4814795">func</span>&nbsp;<span class="op" id="4814800">(</span><span class="ident" id="4814801">hs</span>&nbsp;<span class="op" id="4814804">*</span><span class="ident" id="4814805"><a href="/net/http/httptest/server.go.html#4814698">historyListener</a></span><span class="op" id="4814820">)</span>&nbsp;<span class="ident" id="4814822">Accept</span><span class="op" id="4814828">(</span><span class="op" id="4814829">)</span>&nbsp;<span class="op" id="4814831">(</span><span class="ident" id="4814832">c</span>&nbsp;<span class="ident" id="4814834"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4814837">.</span><span class="ident" id="4814838">Conn</span><span class="op" id="4814842">,</span>&nbsp;<span class="ident" id="4814844">err</span>&nbsp;<span class="builtintype" id="4814848">error</span><span class="op" id="4814853">)</span>&nbsp;<span class="op" id="4814855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814858"><a href="/net/http/httptest/server.go.html#4814832">c</a></span><span class="op" id="4814859">,</span>&nbsp;<span class="ident" id="4814861"><a href="/net/http/httptest/server.go.html#4814844">err</a></span>&nbsp;<span class="op" id="4814865">=</span>&nbsp;<span class="ident" id="4814867"><a href="/net/http/httptest/server.go.html#4814801">hs</a></span><span class="op" id="4814869">.</span><span class="ident" id="4814870">Listener</span><span class="op" id="4814878">.</span><span class="ident" id="4814879">Accept</span><span class="op" id="4814885">(</span><span class="op" id="4814886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814889">if</span>&nbsp;<span class="ident" id="4814892"><a href="/net/http/httptest/server.go.html#4814844">err</a></span>&nbsp;<span class="op" id="4814896">==</span>&nbsp;<span class="ident" id="4814899">nil</span>&nbsp;<span class="op" id="4814903">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814907"><a href="/net/http/httptest/server.go.html#4814801">hs</a></span><span class="op" id="4814909">.</span><span class="ident" id="4814910">Lock</span><span class="op" id="4814914">(</span><span class="op" id="4814915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814919"><a href="/net/http/httptest/server.go.html#4814801">hs</a></span><span class="op" id="4814921">.</span><span class="ident" id="4814922">history</span>&nbsp;<span class="op" id="4814930">=</span>&nbsp;<span class="builtinfunc" id="4814932">append</span><span class="op" id="4814938">(</span><span class="ident" id="4814939"><a href="/net/http/httptest/server.go.html#4814801">hs</a></span><span class="op" id="4814941">.</span><span class="ident" id="4814942">history</span><span class="op" id="4814949">,</span>&nbsp;<span class="ident" id="4814951"><a href="/net/http/httptest/server.go.html#4814832">c</a></span><span class="op" id="4814952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4814956"><a href="/net/http/httptest/server.go.html#4814801">hs</a></span><span class="op" id="4814958">.</span><span class="ident" id="4814959">Unlock</span><span class="op" id="4814965">(</span><span class="op" id="4814966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4814969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4814972">return</span><br>
<span class="lineno">55</span><span class="op" id="4814979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4814982">func</span>&nbsp;<span class="ident" id="4814987">newLocalListener</span><span class="op" id="4815003">(</span><span class="op" id="4815004">)</span>&nbsp;<span class="ident" id="4815006"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4815009">.</span><span class="ident" id="4815010">Listener</span>&nbsp;<span class="op" id="4815019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815022">if</span>&nbsp;<span class="op" id="4815025">*</span><span class="ident" id="4815026"><a href="/net/http/httptest/server.go.html#4815610">serve</a></span>&nbsp;<span class="op" id="4815032">!=</span>&nbsp;<span class="string" id="4815035">&#34;&#34;</span>&nbsp;<span class="op" id="4815038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815042">l</span><span class="op" id="4815043">,</span>&nbsp;<span class="ident" id="4815045">err</span>&nbsp;<span class="op" id="4815049">:=</span>&nbsp;<span class="ident" id="4815052"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4815055">.</span><span class="ident" id="4815056">Listen</span><span class="op" id="4815062">(</span><span class="string" id="4815063">&#34;tcp&#34;</span><span class="op" id="4815068">,</span>&nbsp;<span class="op" id="4815070">*</span><span class="ident" id="4815071"><a href="/net/http/httptest/server.go.html#4815610">serve</a></span><span class="op" id="4815076">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815080">if</span>&nbsp;<span class="ident" id="4815083"><a href="/net/http/httptest/server.go.html#4815045">err</a></span>&nbsp;<span class="op" id="4815087">!=</span>&nbsp;<span class="ident" id="4815090">nil</span>&nbsp;<span class="op" id="4815094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4815099">panic</span><span class="op" id="4815104">(</span><span class="ident" id="4815105"><a href="/net/http/httptest/server.go.html#4813834">fmt</a></span><span class="op" id="4815108">.</span><span class="ident" id="4815109">Sprintf</span><span class="op" id="4815116">(</span><span class="string" id="4815117">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="4815155">,</span>&nbsp;<span class="op" id="4815157">*</span><span class="ident" id="4815158"><a href="/net/http/httptest/server.go.html#4815610">serve</a></span><span class="op" id="4815163">,</span>&nbsp;<span class="ident" id="4815165"><a href="/net/http/httptest/server.go.html#4815045">err</a></span><span class="op" id="4815168">)</span><span class="op" id="4815169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815177">return</span>&nbsp;<span class="ident" id="4815184"><a href="/net/http/httptest/server.go.html#4815042">l</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815187">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815190">l</span><span class="op" id="4815191">,</span>&nbsp;<span class="ident" id="4815193">err</span>&nbsp;<span class="op" id="4815197">:=</span>&nbsp;<span class="ident" id="4815200"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4815203">.</span><span class="ident" id="4815204">Listen</span><span class="op" id="4815210">(</span><span class="string" id="4815211">&#34;tcp&#34;</span><span class="op" id="4815216">,</span>&nbsp;<span class="string" id="4815218">&#34;127.0.0.1:0&#34;</span><span class="op" id="4815231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815234">if</span>&nbsp;<span class="ident" id="4815237"><a href="/net/http/httptest/server.go.html#4815193">err</a></span>&nbsp;<span class="op" id="4815241">!=</span>&nbsp;<span class="ident" id="4815244">nil</span>&nbsp;<span class="op" id="4815248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815252">if</span>&nbsp;<span class="ident" id="4815255"><a href="/net/http/httptest/server.go.html#4815190">l</a></span><span class="op" id="4815256">,</span>&nbsp;<span class="ident" id="4815258"><a href="/net/http/httptest/server.go.html#4815193">err</a></span>&nbsp;<span class="op" id="4815262">=</span>&nbsp;<span class="ident" id="4815264"><a href="/net/http/httptest/server.go.html#4813841">net</a></span><span class="op" id="4815267">.</span><span class="ident" id="4815268">Listen</span><span class="op" id="4815274">(</span><span class="string" id="4815275">&#34;tcp6&#34;</span><span class="op" id="4815281">,</span>&nbsp;<span class="string" id="4815283">&#34;[::1]:0&#34;</span><span class="op" id="4815292">)</span><span class="op" id="4815293">;</span>&nbsp;<span class="ident" id="4815295"><a href="/net/http/httptest/server.go.html#4815193">err</a></span>&nbsp;<span class="op" id="4815299">!=</span>&nbsp;<span class="ident" id="4815302">nil</span>&nbsp;<span class="op" id="4815306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4815311">panic</span><span class="op" id="4815316">(</span><span class="ident" id="4815317"><a href="/net/http/httptest/server.go.html#4813834">fmt</a></span><span class="op" id="4815320">.</span><span class="ident" id="4815321">Sprintf</span><span class="op" id="4815328">(</span><span class="string" id="4815329">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="4815371">,</span>&nbsp;<span class="ident" id="4815373"><a href="/net/http/httptest/server.go.html#4815193">err</a></span><span class="op" id="4815376">)</span><span class="op" id="4815377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815381">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4815384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815387">return</span>&nbsp;<span class="ident" id="4815394"><a href="/net/http/httptest/server.go.html#4815190">l</a></span><br>
<span class="lineno"></span><span class="op" id="4815396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4815399">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="4815454">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="4815480">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="4815538">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="4815606">var</span>&nbsp;<span class="ident" id="4815610">serve</span>&nbsp;<span class="op" id="4815616">=</span>&nbsp;<span class="ident" id="4815618"><a href="/net/http/httptest/server.go.html#4813826">flag</a></span><span class="op" id="4815622">.</span><span class="ident" id="4815623">String</span><span class="op" id="4815629">(</span><span class="string" id="4815630">&#34;httptest.serve&#34;</span><span class="op" id="4815646">,</span>&nbsp;<span class="string" id="4815648">&#34;&#34;</span><span class="op" id="4815650">,</span>&nbsp;<span class="string" id="4815652">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="4815720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="4815723">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4815769">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="4815833">func</span>&nbsp;<span class="ident" id="4815838">NewServer</span><span class="op" id="4815847">(</span><span class="ident" id="4815848">handler</span>&nbsp;<span class="ident" id="4815856"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4815860">.</span><span class="ident" id="4815861">Handler</span><span class="op" id="4815868">)</span>&nbsp;<span class="op" id="4815870">*</span><span class="ident" id="4815871"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span>&nbsp;<span class="op" id="4815878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815881">ts</span>&nbsp;<span class="op" id="4815884">:=</span>&nbsp;<span class="ident" id="4815887"><a href="/net/http/httptest/server.go.html#4816163">NewUnstartedServer</a></span><span class="op" id="4815905">(</span><span class="ident" id="4815906"><a href="/net/http/httptest/server.go.html#4815848">handler</a></span><span class="op" id="4815913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4815916"><a href="/net/http/httptest/server.go.html#4815881">ts</a></span><span class="op" id="4815918">.</span><span class="ident" id="4815919">Start</span><span class="op" id="4815924">(</span><span class="op" id="4815925">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4815928">return</span>&nbsp;<span class="ident" id="4815935"><a href="/net/http/httptest/server.go.html#4815881">ts</a></span><br>
<span class="lineno"></span><span class="op" id="4815938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4815941">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="4816006">//</span><br>
<span class="lineno">90</span><span class="comment" id="4816009">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4816078">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="4816091">//</span><br>
<span class="lineno"></span><span class="comment" id="4816094">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="4816158">func</span>&nbsp;<span class="ident" id="4816163">NewUnstartedServer</span><span class="op" id="4816181">(</span><span class="ident" id="4816182">handler</span>&nbsp;<span class="ident" id="4816190"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4816194">.</span><span class="ident" id="4816195">Handler</span><span class="op" id="4816202">)</span>&nbsp;<span class="op" id="4816204">*</span><span class="ident" id="4816205"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span>&nbsp;<span class="op" id="4816212">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816215">return</span>&nbsp;<span class="op" id="4816222">&amp;</span><span class="ident" id="4816223"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><span class="op" id="4816229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816233">Listener</span><span class="op" id="4816241">:</span>&nbsp;<span class="ident" id="4816243"><a href="/net/http/httptest/server.go.html#4814987">newLocalListener</a></span><span class="op" id="4816259">(</span><span class="op" id="4816260">)</span><span class="op" id="4816261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816265">Config</span><span class="op" id="4816271">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4816275">&amp;</span><span class="ident" id="4816276"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4816280">.</span><span class="ident" id="4816281">Server</span><span class="op" id="4816287">{</span><span class="ident" id="4816288">Handler</span><span class="op" id="4816295">:</span>&nbsp;<span class="ident" id="4816297"><a href="/net/http/httptest/server.go.html#4816182">handler</a></span><span class="op" id="4816304">}</span><span class="op" id="4816305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816308">}</span><br>
<span class="lineno"></span><span class="op" id="4816310">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4816313">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="4816363">func</span>&nbsp;<span class="op" id="4816368">(</span><span class="ident" id="4816369">s</span>&nbsp;<span class="op" id="4816371">*</span><span class="ident" id="4816372"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><span class="op" id="4816378">)</span>&nbsp;<span class="ident" id="4816380">Start</span><span class="op" id="4816385">(</span><span class="op" id="4816386">)</span>&nbsp;<span class="op" id="4816388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816391">if</span>&nbsp;<span class="ident" id="4816394"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816395">.</span><span class="ident" id="4816396">URL</span>&nbsp;<span class="op" id="4816400">!=</span>&nbsp;<span class="string" id="4816403">&#34;&#34;</span>&nbsp;<span class="op" id="4816406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4816410">panic</span><span class="op" id="4816415">(</span><span class="string" id="4816416">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="4816440">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816446"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816447">.</span><span class="ident" id="4816448">Listener</span>&nbsp;<span class="op" id="4816457">=</span>&nbsp;<span class="op" id="4816459">&amp;</span><span class="ident" id="4816460"><a href="/net/http/httptest/server.go.html#4814698">historyListener</a></span><span class="op" id="4816475">{</span><span class="ident" id="4816476">Listener</span><span class="op" id="4816484">:</span>&nbsp;<span class="ident" id="4816486"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816487">.</span><span class="ident" id="4816488">Listener</span><span class="op" id="4816496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816499"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816500">.</span><span class="ident" id="4816501">URL</span>&nbsp;<span class="op" id="4816505">=</span>&nbsp;<span class="string" id="4816507">&#34;http://&#34;</span>&nbsp;<span class="op" id="4816517">+</span>&nbsp;<span class="ident" id="4816519"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816520">.</span><span class="ident" id="4816521">Listener</span><span class="op" id="4816529">.</span><span class="ident" id="4816530">Addr</span><span class="op" id="4816534">(</span><span class="op" id="4816535">)</span><span class="op" id="4816536">.</span><span class="ident" id="4816537">String</span><span class="op" id="4816543">(</span><span class="op" id="4816544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816547"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816548">.</span><span class="ident" id="4816549">wrapHandler</span><span class="op" id="4816560">(</span><span class="op" id="4816561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816564">go</span>&nbsp;<span class="ident" id="4816567"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816568">.</span><span class="ident" id="4816569">Config</span><span class="op" id="4816575">.</span><span class="ident" id="4816576">Serve</span><span class="op" id="4816581">(</span><span class="ident" id="4816582"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816583">.</span><span class="ident" id="4816584">Listener</span><span class="op" id="4816592">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816595">if</span>&nbsp;<span class="op" id="4816598">*</span><span class="ident" id="4816599"><a href="/net/http/httptest/server.go.html#4815610">serve</a></span>&nbsp;<span class="op" id="4816605">!=</span>&nbsp;<span class="string" id="4816608">&#34;&#34;</span>&nbsp;<span class="op" id="4816611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816615"><a href="/net/http/httptest/server.go.html#4813834">fmt</a></span><span class="op" id="4816618">.</span><span class="ident" id="4816619">Fprintln</span><span class="op" id="4816627">(</span><span class="ident" id="4816628"><a href="/net/http/httptest/server.go.html#4813860">os</a></span><span class="op" id="4816630">.</span><span class="ident" id="4816631">Stderr</span><span class="op" id="4816637">,</span>&nbsp;<span class="string" id="4816639">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="4816661">,</span>&nbsp;<span class="ident" id="4816663"><a href="/net/http/httptest/server.go.html#4816369">s</a></span><span class="op" id="4816664">.</span><span class="ident" id="4816665">URL</span><span class="op" id="4816668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816672">select</span>&nbsp;<span class="op" id="4816679">{</span><span class="op" id="4816680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816683">}</span><br>
<span class="lineno"></span><span class="op" id="4816685">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4816688">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="4816748">func</span>&nbsp;<span class="op" id="4816753">(</span><span class="ident" id="4816754">s</span>&nbsp;<span class="op" id="4816756">*</span><span class="ident" id="4816757"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><span class="op" id="4816763">)</span>&nbsp;<span class="ident" id="4816765">StartTLS</span><span class="op" id="4816773">(</span><span class="op" id="4816774">)</span>&nbsp;<span class="op" id="4816776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816779">if</span>&nbsp;<span class="ident" id="4816782"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4816783">.</span><span class="ident" id="4816784">URL</span>&nbsp;<span class="op" id="4816788">!=</span>&nbsp;<span class="string" id="4816791">&#34;&#34;</span>&nbsp;<span class="op" id="4816794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4816798">panic</span><span class="op" id="4816803">(</span><span class="string" id="4816804">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="4816828">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816834">cert</span><span class="op" id="4816838">,</span>&nbsp;<span class="ident" id="4816840">err</span>&nbsp;<span class="op" id="4816844">:=</span>&nbsp;<span class="ident" id="4816847"><a href="/net/http/httptest/server.go.html#4813812">tls</a></span><span class="op" id="4816850">.</span><span class="ident" id="4816851">X509KeyPair</span><span class="op" id="4816862">(</span><span class="ident" id="4816863"><a href="/net/http/httptest/server.go.html#4819164">localhostCert</a></span><span class="op" id="4816876">,</span>&nbsp;<span class="ident" id="4816878"><a href="/net/http/httptest/server.go.html#4819819">localhostKey</a></span><span class="op" id="4816890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4816893">if</span>&nbsp;<span class="ident" id="4816896"><a href="/net/http/httptest/server.go.html#4816840">err</a></span>&nbsp;<span class="op" id="4816900">!=</span>&nbsp;<span class="ident" id="4816903">nil</span>&nbsp;<span class="op" id="4816907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4816911">panic</span><span class="op" id="4816916">(</span><span class="ident" id="4816917"><a href="/net/http/httptest/server.go.html#4813834">fmt</a></span><span class="op" id="4816920">.</span><span class="ident" id="4816921">Sprintf</span><span class="op" id="4816928">(</span><span class="string" id="4816929">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="4816957">,</span>&nbsp;<span class="ident" id="4816959"><a href="/net/http/httptest/server.go.html#4816840">err</a></span><span class="op" id="4816962">)</span><span class="op" id="4816963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4816966">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816970">existingConfig</span>&nbsp;<span class="op" id="4816985">:=</span>&nbsp;<span class="ident" id="4816988"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4816989">.</span><span class="ident" id="4816990">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4816995"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4816996">.</span><span class="ident" id="4816997">TLS</span>&nbsp;<span class="op" id="4817001">=</span>&nbsp;<span class="builtinfunc" id="4817003">new</span><span class="op" id="4817006">(</span><span class="ident" id="4817007"><a href="/net/http/httptest/server.go.html#4813812">tls</a></span><span class="op" id="4817010">.</span><span class="ident" id="4817011">Config</span><span class="op" id="4817017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817020">if</span>&nbsp;<span class="ident" id="4817023"><a href="/net/http/httptest/server.go.html#4816970">existingConfig</a></span>&nbsp;<span class="op" id="4817038">!=</span>&nbsp;<span class="ident" id="4817041">nil</span>&nbsp;<span class="op" id="4817045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817049">*</span><span class="ident" id="4817050"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817051">.</span><span class="ident" id="4817052">TLS</span>&nbsp;<span class="op" id="4817056">=</span>&nbsp;<span class="op" id="4817058">*</span><span class="ident" id="4817059"><a href="/net/http/httptest/server.go.html#4816970">existingConfig</a></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817078">if</span>&nbsp;<span class="ident" id="4817081"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817082">.</span><span class="ident" id="4817083">TLS</span><span class="op" id="4817086">.</span><span class="ident" id="4817087">NextProtos</span>&nbsp;<span class="op" id="4817098">==</span>&nbsp;<span class="ident" id="4817101">nil</span>&nbsp;<span class="op" id="4817105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817109"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817110">.</span><span class="ident" id="4817111">TLS</span><span class="op" id="4817114">.</span><span class="ident" id="4817115">NextProtos</span>&nbsp;<span class="op" id="4817126">=</span>&nbsp;<span class="op" id="4817128">[</span><span class="op" id="4817129">]</span><span class="builtintype" id="4817130">string</span><span class="op" id="4817136">{</span><span class="string" id="4817137">&#34;http/1.1&#34;</span><span class="op" id="4817147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817153">if</span>&nbsp;<span class="builtinfunc" id="4817156">len</span><span class="op" id="4817159">(</span><span class="ident" id="4817160"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817161">.</span><span class="ident" id="4817162">TLS</span><span class="op" id="4817165">.</span><span class="ident" id="4817166">Certificates</span><span class="op" id="4817178">)</span>&nbsp;<span class="op" id="4817180">==</span>&nbsp;<span class="num" id="4817183">0</span>&nbsp;<span class="op" id="4817185">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817189"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817190">.</span><span class="ident" id="4817191">TLS</span><span class="op" id="4817194">.</span><span class="ident" id="4817195">Certificates</span>&nbsp;<span class="op" id="4817208">=</span>&nbsp;<span class="op" id="4817210">[</span><span class="op" id="4817211">]</span><span class="ident" id="4817212"><a href="/net/http/httptest/server.go.html#4813812">tls</a></span><span class="op" id="4817215">.</span><span class="ident" id="4817216">Certificate</span><span class="op" id="4817227">{</span><span class="ident" id="4817228"><a href="/net/http/httptest/server.go.html#4816834">cert</a></span><span class="op" id="4817232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817238">tlsListener</span>&nbsp;<span class="op" id="4817250">:=</span>&nbsp;<span class="ident" id="4817253"><a href="/net/http/httptest/server.go.html#4813812">tls</a></span><span class="op" id="4817256">.</span><span class="ident" id="4817257">NewListener</span><span class="op" id="4817268">(</span><span class="ident" id="4817269"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817270">.</span><span class="ident" id="4817271">Listener</span><span class="op" id="4817279">,</span>&nbsp;<span class="ident" id="4817281"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817282">.</span><span class="ident" id="4817283">TLS</span><span class="op" id="4817286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817290"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817291">.</span><span class="ident" id="4817292">Listener</span>&nbsp;<span class="op" id="4817301">=</span>&nbsp;<span class="op" id="4817303">&amp;</span><span class="ident" id="4817304"><a href="/net/http/httptest/server.go.html#4814698">historyListener</a></span><span class="op" id="4817319">{</span><span class="ident" id="4817320">Listener</span><span class="op" id="4817328">:</span>&nbsp;<span class="ident" id="4817330"><a href="/net/http/httptest/server.go.html#4817238">tlsListener</a></span><span class="op" id="4817341">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817344"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817345">.</span><span class="ident" id="4817346">URL</span>&nbsp;<span class="op" id="4817350">=</span>&nbsp;<span class="string" id="4817352">&#34;https://&#34;</span>&nbsp;<span class="op" id="4817363">+</span>&nbsp;<span class="ident" id="4817365"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817366">.</span><span class="ident" id="4817367">Listener</span><span class="op" id="4817375">.</span><span class="ident" id="4817376">Addr</span><span class="op" id="4817380">(</span><span class="op" id="4817381">)</span><span class="op" id="4817382">.</span><span class="ident" id="4817383">String</span><span class="op" id="4817389">(</span><span class="op" id="4817390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817393"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817394">.</span><span class="ident" id="4817395">wrapHandler</span><span class="op" id="4817406">(</span><span class="op" id="4817407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817410">go</span>&nbsp;<span class="ident" id="4817413"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817414">.</span><span class="ident" id="4817415">Config</span><span class="op" id="4817421">.</span><span class="ident" id="4817422">Serve</span><span class="op" id="4817427">(</span><span class="ident" id="4817428"><a href="/net/http/httptest/server.go.html#4816754">s</a></span><span class="op" id="4817429">.</span><span class="ident" id="4817430">Listener</span><span class="op" id="4817438">)</span><br>
<span class="lineno"></span><span class="op" id="4817440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="4817443">func</span>&nbsp;<span class="op" id="4817448">(</span><span class="ident" id="4817449">s</span>&nbsp;<span class="op" id="4817451">*</span><span class="ident" id="4817452"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><span class="op" id="4817458">)</span>&nbsp;<span class="ident" id="4817460">wrapHandler</span><span class="op" id="4817471">(</span><span class="op" id="4817472">)</span>&nbsp;<span class="op" id="4817474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817477">h</span>&nbsp;<span class="op" id="4817479">:=</span>&nbsp;<span class="ident" id="4817482"><a href="/net/http/httptest/server.go.html#4817449">s</a></span><span class="op" id="4817483">.</span><span class="ident" id="4817484">Config</span><span class="op" id="4817490">.</span><span class="ident" id="4817491">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817500">if</span>&nbsp;<span class="ident" id="4817503"><a href="/net/http/httptest/server.go.html#4817477">h</a></span>&nbsp;<span class="op" id="4817505">==</span>&nbsp;<span class="ident" id="4817508">nil</span>&nbsp;<span class="op" id="4817512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817516"><a href="/net/http/httptest/server.go.html#4817477">h</a></span>&nbsp;<span class="op" id="4817518">=</span>&nbsp;<span class="ident" id="4817520"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4817524">.</span><span class="ident" id="4817525">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817542">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817545"><a href="/net/http/httptest/server.go.html#4817449">s</a></span><span class="op" id="4817546">.</span><span class="ident" id="4817547">Config</span><span class="op" id="4817553">.</span><span class="ident" id="4817554">Handler</span>&nbsp;<span class="op" id="4817562">=</span>&nbsp;<span class="op" id="4817564">&amp;</span><span class="ident" id="4817565"><a href="/net/http/httptest/server.go.html#4818593">waitGroupHandler</a></span><span class="op" id="4817581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817585">s</span><span class="op" id="4817586">:</span>&nbsp;<span class="ident" id="4817588"><a href="/net/http/httptest/server.go.html#4817449">s</a></span><span class="op" id="4817589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817593">h</span><span class="op" id="4817594">:</span>&nbsp;<span class="ident" id="4817596"><a href="/net/http/httptest/server.go.html#4817477">h</a></span><span class="op" id="4817597">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4817600">}</span><br>
<span class="lineno"></span><span class="op" id="4817602">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4817605">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="4817664">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="4817728">func</span>&nbsp;<span class="ident" id="4817733">NewTLSServer</span><span class="op" id="4817745">(</span><span class="ident" id="4817746">handler</span>&nbsp;<span class="ident" id="4817754"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4817758">.</span><span class="ident" id="4817759">Handler</span><span class="op" id="4817766">)</span>&nbsp;<span class="op" id="4817768">*</span><span class="ident" id="4817769"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span>&nbsp;<span class="op" id="4817776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817779">ts</span>&nbsp;<span class="op" id="4817782">:=</span>&nbsp;<span class="ident" id="4817785"><a href="/net/http/httptest/server.go.html#4816163">NewUnstartedServer</a></span><span class="op" id="4817803">(</span><span class="ident" id="4817804"><a href="/net/http/httptest/server.go.html#4817746">handler</a></span><span class="op" id="4817811">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817814"><a href="/net/http/httptest/server.go.html#4817779">ts</a></span><span class="op" id="4817816">.</span><span class="ident" id="4817817">StartTLS</span><span class="op" id="4817825">(</span><span class="op" id="4817826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4817829">return</span>&nbsp;<span class="ident" id="4817836"><a href="/net/http/httptest/server.go.html#4817779">ts</a></span><br>
<span class="lineno"></span><span class="op" id="4817839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4817842">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="4817906">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4817949">func</span>&nbsp;<span class="op" id="4817954">(</span><span class="ident" id="4817955">s</span>&nbsp;<span class="op" id="4817957">*</span><span class="ident" id="4817958"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><span class="op" id="4817964">)</span>&nbsp;<span class="ident" id="4817966">Close</span><span class="op" id="4817971">(</span><span class="op" id="4817972">)</span>&nbsp;<span class="op" id="4817974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817977"><a href="/net/http/httptest/server.go.html#4817955">s</a></span><span class="op" id="4817978">.</span><span class="ident" id="4817979">Listener</span><span class="op" id="4817987">.</span><span class="ident" id="4817988">Close</span><span class="op" id="4817993">(</span><span class="op" id="4817994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4817997"><a href="/net/http/httptest/server.go.html#4817955">s</a></span><span class="op" id="4817998">.</span><span class="ident" id="4817999">wg</span><span class="op" id="4818001">.</span><span class="ident" id="4818002">Wait</span><span class="op" id="4818006">(</span><span class="op" id="4818007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818010"><a href="/net/http/httptest/server.go.html#4817955">s</a></span><span class="op" id="4818011">.</span><span class="ident" id="4818012">CloseClientConnections</span><span class="op" id="4818034">(</span><span class="op" id="4818035">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818038">if</span>&nbsp;<span class="ident" id="4818041">t</span><span class="op" id="4818042">,</span>&nbsp;<span class="ident" id="4818044">ok</span>&nbsp;<span class="op" id="4818047">:=</span>&nbsp;<span class="ident" id="4818050"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4818054">.</span><span class="ident" id="4818055">DefaultTransport</span><span class="op" id="4818071">.</span><span class="op" id="4818072">(</span><span class="op" id="4818073">*</span><span class="ident" id="4818074"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4818078">.</span><span class="ident" id="4818079">Transport</span><span class="op" id="4818088">)</span><span class="op" id="4818089">;</span>&nbsp;<span class="ident" id="4818091"><a href="/net/http/httptest/server.go.html#4818044">ok</a></span>&nbsp;<span class="op" id="4818094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818098"><a href="/net/http/httptest/server.go.html#4818041">t</a></span><span class="op" id="4818099">.</span><span class="ident" id="4818100">CloseIdleConnections</span><span class="op" id="4818120">(</span><span class="op" id="4818121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818124">}</span><br>
<span class="lineno"></span><span class="op" id="4818126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="4818129">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="4818198">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4818221">func</span>&nbsp;<span class="op" id="4818226">(</span><span class="ident" id="4818227">s</span>&nbsp;<span class="op" id="4818229">*</span><span class="ident" id="4818230"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><span class="op" id="4818236">)</span>&nbsp;<span class="ident" id="4818238">CloseClientConnections</span><span class="op" id="4818260">(</span><span class="op" id="4818261">)</span>&nbsp;<span class="op" id="4818263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818266">hl</span><span class="op" id="4818268">,</span>&nbsp;<span class="ident" id="4818270">ok</span>&nbsp;<span class="op" id="4818273">:=</span>&nbsp;<span class="ident" id="4818276"><a href="/net/http/httptest/server.go.html#4818227">s</a></span><span class="op" id="4818277">.</span><span class="ident" id="4818278">Listener</span><span class="op" id="4818286">.</span><span class="op" id="4818287">(</span><span class="op" id="4818288">*</span><span class="ident" id="4818289"><a href="/net/http/httptest/server.go.html#4814698">historyListener</a></span><span class="op" id="4818304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818307">if</span>&nbsp;<span class="op" id="4818310">!</span><span class="ident" id="4818311"><a href="/net/http/httptest/server.go.html#4818270">ok</a></span>&nbsp;<span class="op" id="4818314">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818318">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818329"><a href="/net/http/httptest/server.go.html#4818266">hl</a></span><span class="op" id="4818331">.</span><span class="ident" id="4818332">Lock</span><span class="op" id="4818336">(</span><span class="op" id="4818337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818340">for</span>&nbsp;<span class="ident" id="4818344">_</span><span class="op" id="4818345">,</span>&nbsp;<span class="ident" id="4818347">conn</span>&nbsp;<span class="op" id="4818352">:=</span>&nbsp;<span class="keyword" id="4818355">range</span>&nbsp;<span class="ident" id="4818361"><a href="/net/http/httptest/server.go.html#4818266">hl</a></span><span class="op" id="4818363">.</span><span class="ident" id="4818364">history</span>&nbsp;<span class="op" id="4818372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818376"><a href="/net/http/httptest/server.go.html#4818347">conn</a></span><span class="op" id="4818380">.</span><span class="ident" id="4818381">Close</span><span class="op" id="4818386">(</span><span class="op" id="4818387">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4818390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818393"><a href="/net/http/httptest/server.go.html#4818266">hl</a></span><span class="op" id="4818395">.</span><span class="ident" id="4818396">Unlock</span><span class="op" id="4818402">(</span><span class="op" id="4818403">)</span><br>
<span class="lineno"></span><span class="op" id="4818405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4818408">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="4818477">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="4818544">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="4818588">type</span>&nbsp;<span class="ident" id="4818593">waitGroupHandler</span>&nbsp;<span class="keyword" id="4818610">struct</span>&nbsp;<span class="op" id="4818617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818620">s</span>&nbsp;<span class="op" id="4818622">*</span><span class="ident" id="4818623"><a href="/net/http/httptest/server.go.html#4814015">Server</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818631">h</span>&nbsp;<span class="ident" id="4818633"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4818637">.</span><span class="ident" id="4818638">Handler</span>&nbsp;<span class="comment" id="4818646">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="4818657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4818660">func</span>&nbsp;<span class="op" id="4818665">(</span><span class="ident" id="4818666">h</span>&nbsp;<span class="op" id="4818668">*</span><span class="ident" id="4818669"><a href="/net/http/httptest/server.go.html#4818593">waitGroupHandler</a></span><span class="op" id="4818685">)</span>&nbsp;<span class="ident" id="4818687">ServeHTTP</span><span class="op" id="4818696">(</span><span class="ident" id="4818697">w</span>&nbsp;<span class="ident" id="4818699"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4818703">.</span><span class="ident" id="4818704">ResponseWriter</span><span class="op" id="4818718">,</span>&nbsp;<span class="ident" id="4818720">r</span>&nbsp;<span class="op" id="4818722">*</span><span class="ident" id="4818723"><a href="/net/http/httptest/server.go.html#4813848">http</a></span><span class="op" id="4818727">.</span><span class="ident" id="4818728">Request</span><span class="op" id="4818735">)</span>&nbsp;<span class="op" id="4818737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818740"><a href="/net/http/httptest/server.go.html#4818666">h</a></span><span class="op" id="4818741">.</span><span class="ident" id="4818742">s</span><span class="op" id="4818743">.</span><span class="ident" id="4818744">wg</span><span class="op" id="4818746">.</span><span class="ident" id="4818747">Add</span><span class="op" id="4818750">(</span><span class="num" id="4818751">1</span><span class="op" id="4818752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4818755">defer</span>&nbsp;<span class="ident" id="4818761"><a href="/net/http/httptest/server.go.html#4818666">h</a></span><span class="op" id="4818762">.</span><span class="ident" id="4818763">s</span><span class="op" id="4818764">.</span><span class="ident" id="4818765">wg</span><span class="op" id="4818767">.</span><span class="ident" id="4818768">Done</span><span class="op" id="4818772">(</span><span class="op" id="4818773">)</span>&nbsp;<span class="comment" id="4818775">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4818819"><a href="/net/http/httptest/server.go.html#4818666">h</a></span><span class="op" id="4818820">.</span><span class="ident" id="4818821">h</span><span class="op" id="4818822">.</span><span class="ident" id="4818823">ServeHTTP</span><span class="op" id="4818832">(</span><span class="ident" id="4818833"><a href="/net/http/httptest/server.go.html#4818697">w</a></span><span class="op" id="4818834">,</span>&nbsp;<span class="ident" id="4818836"><a href="/net/http/httptest/server.go.html#4818720">r</a></span><span class="op" id="4818837">)</span><br>
<span class="lineno"></span><span class="op" id="4818839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4818842">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="4818898">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="4818971">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="4818990">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="4819024">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="4819160">var</span>&nbsp;<span class="ident" id="4819164">localhostCert</span>&nbsp;<span class="op" id="4819178">=</span>&nbsp;<span class="op" id="4819180">[</span><span class="op" id="4819181">]</span><span class="builtintype" id="4819182">byte</span><span class="op" id="4819186">(</span><span class="string" id="4819187">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="4819758">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4819761">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="4819815">var</span>&nbsp;<span class="ident" id="4819819">localhostKey</span>&nbsp;<span class="op" id="4819832">=</span>&nbsp;<span class="op" id="4819834">[</span><span class="op" id="4819835">]</span><span class="builtintype" id="4819836">byte</span><span class="op" id="4819840">(</span><span class="string" id="4819841">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="4820339">)</span>
</div>
</body>
</html>
