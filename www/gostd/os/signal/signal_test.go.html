<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8262646">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8262701">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8262755">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8262806">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8262871">package</span>&nbsp;<span class="ident" id="8262879">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8262887">import</span>&nbsp;<span class="op" id="8262894">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262897">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262905">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262918">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262924">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262935">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262946">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262957">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262968">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8262979">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8262986">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8262989">func</span>&nbsp;<span class="ident" id="8262994">waitSig</span><span class="op" id="8263001">(</span><span class="ident" id="8263002">t</span>&nbsp;<span class="op" id="8263004">*</span><span class="ident" id="8263005">testing</span><span class="op" id="8263012">.</span><span class="ident" id="8263013">T</span><span class="op" id="8263014">,</span>&nbsp;<span class="ident" id="8263016">c</span>&nbsp;<span class="op" id="8263018">&lt;-</span><span class="keyword" id="8263020">chan</span>&nbsp;<span class="ident" id="8263025">os</span><span class="op" id="8263027">.</span><span class="ident" id="8263028">Signal</span><span class="op" id="8263034">,</span>&nbsp;<span class="ident" id="8263036">sig</span>&nbsp;<span class="ident" id="8263040">os</span><span class="op" id="8263042">.</span><span class="ident" id="8263043">Signal</span><span class="op" id="8263049">)</span>&nbsp;<span class="op" id="8263051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263054">select</span>&nbsp;<span class="op" id="8263061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263064">case</span>&nbsp;<span class="ident" id="8263069">s</span>&nbsp;<span class="op" id="8263071">:=</span>&nbsp;<span class="op" id="8263074">&lt;-</span><span class="ident" id="8263076">c</span><span class="op" id="8263077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263081">if</span>&nbsp;<span class="ident" id="8263084">s</span>&nbsp;<span class="op" id="8263086">!=</span>&nbsp;<span class="ident" id="8263089">sig</span>&nbsp;<span class="op" id="8263093">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263098">t</span><span class="op" id="8263099">.</span><span class="ident" id="8263100">Fatalf</span><span class="op" id="8263106">(</span><span class="string" id="8263107">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8263131">,</span>&nbsp;<span class="ident" id="8263133">s</span><span class="op" id="8263134">,</span>&nbsp;<span class="ident" id="8263136">sig</span><span class="op" id="8263139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263146">case</span>&nbsp;<span class="op" id="8263151">&lt;-</span><span class="ident" id="8263153">time</span><span class="op" id="8263157">.</span><span class="ident" id="8263158">After</span><span class="op" id="8263163">(</span><span class="num" id="8263164">1</span>&nbsp;<span class="op" id="8263166">*</span>&nbsp;<span class="ident" id="8263168">time</span><span class="op" id="8263172">.</span><span class="ident" id="8263173">Second</span><span class="op" id="8263179">)</span><span class="op" id="8263180">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263184">t</span><span class="op" id="8263185">.</span><span class="ident" id="8263186">Fatalf</span><span class="op" id="8263192">(</span><span class="string" id="8263193">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="8263217">,</span>&nbsp;<span class="ident" id="8263219">sig</span><span class="op" id="8263222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8263225">}</span><br>
<span class="lineno">30</span><span class="op" id="8263227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8263230">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="8263272">func</span>&nbsp;<span class="ident" id="8263277">TestSignal</span><span class="op" id="8263287">(</span><span class="ident" id="8263288">t</span>&nbsp;<span class="op" id="8263290">*</span><span class="ident" id="8263291">testing</span><span class="op" id="8263298">.</span><span class="ident" id="8263299">T</span><span class="op" id="8263300">)</span>&nbsp;<span class="op" id="8263302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263305">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263324">c</span>&nbsp;<span class="op" id="8263326">:=</span>&nbsp;<span class="builtinfunc" id="8263329">make</span><span class="op" id="8263333">(</span><span class="keyword" id="8263334">chan</span>&nbsp;<span class="ident" id="8263339">os</span><span class="op" id="8263341">.</span><span class="ident" id="8263342">Signal</span><span class="op" id="8263348">,</span>&nbsp;<span class="num" id="8263350">1</span><span class="op" id="8263351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263354">Notify</span><span class="op" id="8263360">(</span><span class="ident" id="8263361">c</span><span class="op" id="8263362">,</span>&nbsp;<span class="ident" id="8263364">syscall</span><span class="op" id="8263371">.</span><span class="ident" id="8263372">SIGHUP</span><span class="op" id="8263378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8263381">defer</span>&nbsp;<span class="ident" id="8263387">Stop</span><span class="op" id="8263391">(</span><span class="ident" id="8263392">c</span><span class="op" id="8263393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263397">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263428">t</span><span class="op" id="8263429">.</span><span class="ident" id="8263430">Logf</span><span class="op" id="8263434">(</span><span class="string" id="8263435">&#34;sighup...&#34;</span><span class="op" id="8263446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263449">syscall</span><span class="op" id="8263456">.</span><span class="ident" id="8263457">Kill</span><span class="op" id="8263461">(</span><span class="ident" id="8263462">syscall</span><span class="op" id="8263469">.</span><span class="ident" id="8263470">Getpid</span><span class="op" id="8263476">(</span><span class="op" id="8263477">)</span><span class="op" id="8263478">,</span>&nbsp;<span class="ident" id="8263480">syscall</span><span class="op" id="8263487">.</span><span class="ident" id="8263488">SIGHUP</span><span class="op" id="8263494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263497">waitSig</span><span class="op" id="8263504">(</span><span class="ident" id="8263505">t</span><span class="op" id="8263506">,</span>&nbsp;<span class="ident" id="8263508">c</span><span class="op" id="8263509">,</span>&nbsp;<span class="ident" id="8263511">syscall</span><span class="op" id="8263518">.</span><span class="ident" id="8263519">SIGHUP</span><span class="op" id="8263525">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263529">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263564">c1</span>&nbsp;<span class="op" id="8263567">:=</span>&nbsp;<span class="builtinfunc" id="8263570">make</span><span class="op" id="8263574">(</span><span class="keyword" id="8263575">chan</span>&nbsp;<span class="ident" id="8263580">os</span><span class="op" id="8263582">.</span><span class="ident" id="8263583">Signal</span><span class="op" id="8263589">,</span>&nbsp;<span class="num" id="8263591">1</span><span class="op" id="8263592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263595">Notify</span><span class="op" id="8263601">(</span><span class="ident" id="8263602">c1</span><span class="op" id="8263604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263608">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263641">t</span><span class="op" id="8263642">.</span><span class="ident" id="8263643">Logf</span><span class="op" id="8263647">(</span><span class="string" id="8263648">&#34;sigwinch...&#34;</span><span class="op" id="8263661">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263664">syscall</span><span class="op" id="8263671">.</span><span class="ident" id="8263672">Kill</span><span class="op" id="8263676">(</span><span class="ident" id="8263677">syscall</span><span class="op" id="8263684">.</span><span class="ident" id="8263685">Getpid</span><span class="op" id="8263691">(</span><span class="op" id="8263692">)</span><span class="op" id="8263693">,</span>&nbsp;<span class="ident" id="8263695">syscall</span><span class="op" id="8263702">.</span><span class="ident" id="8263703">SIGWINCH</span><span class="op" id="8263711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263714">waitSig</span><span class="op" id="8263721">(</span><span class="ident" id="8263722">t</span><span class="op" id="8263723">,</span>&nbsp;<span class="ident" id="8263725">c1</span><span class="op" id="8263727">,</span>&nbsp;<span class="ident" id="8263729">syscall</span><span class="op" id="8263736">.</span><span class="ident" id="8263737">SIGWINCH</span><span class="op" id="8263745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263749">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263794">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8263844">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263882">t</span><span class="op" id="8263883">.</span><span class="ident" id="8263884">Logf</span><span class="op" id="8263888">(</span><span class="string" id="8263889">&#34;sighup...&#34;</span><span class="op" id="8263900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263903">syscall</span><span class="op" id="8263910">.</span><span class="ident" id="8263911">Kill</span><span class="op" id="8263915">(</span><span class="ident" id="8263916">syscall</span><span class="op" id="8263923">.</span><span class="ident" id="8263924">Getpid</span><span class="op" id="8263930">(</span><span class="op" id="8263931">)</span><span class="op" id="8263932">,</span>&nbsp;<span class="ident" id="8263934">syscall</span><span class="op" id="8263941">.</span><span class="ident" id="8263942">SIGHUP</span><span class="op" id="8263948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263951">waitSig</span><span class="op" id="8263958">(</span><span class="ident" id="8263959">t</span><span class="op" id="8263960">,</span>&nbsp;<span class="ident" id="8263962">c1</span><span class="op" id="8263964">,</span>&nbsp;<span class="ident" id="8263966">syscall</span><span class="op" id="8263973">.</span><span class="ident" id="8263974">SIGHUP</span><span class="op" id="8263980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8263983">t</span><span class="op" id="8263984">.</span><span class="ident" id="8263985">Logf</span><span class="op" id="8263989">(</span><span class="string" id="8263990">&#34;sighup...&#34;</span><span class="op" id="8264001">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264004">syscall</span><span class="op" id="8264011">.</span><span class="ident" id="8264012">Kill</span><span class="op" id="8264016">(</span><span class="ident" id="8264017">syscall</span><span class="op" id="8264024">.</span><span class="ident" id="8264025">Getpid</span><span class="op" id="8264031">(</span><span class="op" id="8264032">)</span><span class="op" id="8264033">,</span>&nbsp;<span class="ident" id="8264035">syscall</span><span class="op" id="8264042">.</span><span class="ident" id="8264043">SIGHUP</span><span class="op" id="8264049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264052">waitSig</span><span class="op" id="8264059">(</span><span class="ident" id="8264060">t</span><span class="op" id="8264061">,</span>&nbsp;<span class="ident" id="8264063">c1</span><span class="op" id="8264065">,</span>&nbsp;<span class="ident" id="8264067">syscall</span><span class="op" id="8264074">.</span><span class="ident" id="8264075">SIGHUP</span><span class="op" id="8264081">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8264085">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264137">waitSig</span><span class="op" id="8264144">(</span><span class="ident" id="8264145">t</span><span class="op" id="8264146">,</span>&nbsp;<span class="ident" id="8264148">c</span><span class="op" id="8264149">,</span>&nbsp;<span class="ident" id="8264151">syscall</span><span class="op" id="8264158">.</span><span class="ident" id="8264159">SIGHUP</span><span class="op" id="8264165">)</span><br>
<span class="lineno">65</span><span class="op" id="8264167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8264170">func</span>&nbsp;<span class="ident" id="8264175">TestStress</span><span class="op" id="8264185">(</span><span class="ident" id="8264186">t</span>&nbsp;<span class="op" id="8264188">*</span><span class="ident" id="8264189">testing</span><span class="op" id="8264196">.</span><span class="ident" id="8264197">T</span><span class="op" id="8264198">)</span>&nbsp;<span class="op" id="8264200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264203">dur</span>&nbsp;<span class="op" id="8264207">:=</span>&nbsp;<span class="num" id="8264210">3</span>&nbsp;<span class="op" id="8264212">*</span>&nbsp;<span class="ident" id="8264214">time</span><span class="op" id="8264218">.</span><span class="ident" id="8264219">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264227">if</span>&nbsp;<span class="ident" id="8264230">testing</span><span class="op" id="8264237">.</span><span class="ident" id="8264238">Short</span><span class="op" id="8264243">(</span><span class="op" id="8264244">)</span>&nbsp;<span class="op" id="8264246">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264250">dur</span>&nbsp;<span class="op" id="8264254">=</span>&nbsp;<span class="num" id="8264256">100</span>&nbsp;<span class="op" id="8264260">*</span>&nbsp;<span class="ident" id="8264262">time</span><span class="op" id="8264266">.</span><span class="ident" id="8264267">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264283">defer</span>&nbsp;<span class="ident" id="8264289">runtime</span><span class="op" id="8264296">.</span><span class="ident" id="8264297">GOMAXPROCS</span><span class="op" id="8264307">(</span><span class="ident" id="8264308">runtime</span><span class="op" id="8264315">.</span><span class="ident" id="8264316">GOMAXPROCS</span><span class="op" id="8264326">(</span><span class="num" id="8264327">4</span><span class="op" id="8264328">)</span><span class="op" id="8264329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264332">done</span>&nbsp;<span class="op" id="8264337">:=</span>&nbsp;<span class="builtinfunc" id="8264340">make</span><span class="op" id="8264344">(</span><span class="keyword" id="8264345">chan</span>&nbsp;<span class="builtintype" id="8264350">bool</span><span class="op" id="8264354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264357">finished</span>&nbsp;<span class="op" id="8264366">:=</span>&nbsp;<span class="builtinfunc" id="8264369">make</span><span class="op" id="8264373">(</span><span class="keyword" id="8264374">chan</span>&nbsp;<span class="builtintype" id="8264379">bool</span><span class="op" id="8264383">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264386">go</span>&nbsp;<span class="keyword" id="8264389">func</span><span class="op" id="8264393">(</span><span class="op" id="8264394">)</span>&nbsp;<span class="op" id="8264396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264400">sig</span>&nbsp;<span class="op" id="8264404">:=</span>&nbsp;<span class="builtinfunc" id="8264407">make</span><span class="op" id="8264411">(</span><span class="keyword" id="8264412">chan</span>&nbsp;<span class="ident" id="8264417">os</span><span class="op" id="8264419">.</span><span class="ident" id="8264420">Signal</span><span class="op" id="8264426">,</span>&nbsp;<span class="num" id="8264428">1</span><span class="op" id="8264429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264433">Notify</span><span class="op" id="8264439">(</span><span class="ident" id="8264440">sig</span><span class="op" id="8264443">,</span>&nbsp;<span class="ident" id="8264445">syscall</span><span class="op" id="8264452">.</span><span class="ident" id="8264453">SIGUSR1</span><span class="op" id="8264460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264464">defer</span>&nbsp;<span class="ident" id="8264470">Stop</span><span class="op" id="8264474">(</span><span class="ident" id="8264475">sig</span><span class="op" id="8264478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264481">Loop</span><span class="op" id="8264485">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264489">for</span>&nbsp;<span class="op" id="8264493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264498">select</span>&nbsp;<span class="op" id="8264505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264510">case</span>&nbsp;<span class="op" id="8264515">&lt;-</span><span class="ident" id="8264517">sig</span><span class="op" id="8264520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264525">case</span>&nbsp;<span class="op" id="8264530">&lt;-</span><span class="ident" id="8264532">done</span><span class="op" id="8264536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264542">break</span>&nbsp;<span class="ident" id="8264548">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264564">finished</span>&nbsp;<span class="op" id="8264573">&lt;-</span>&nbsp;<span class="builtintype" id="8264576">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264582">}</span><span class="op" id="8264583">(</span><span class="op" id="8264584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264587">go</span>&nbsp;<span class="keyword" id="8264590">func</span><span class="op" id="8264594">(</span><span class="op" id="8264595">)</span>&nbsp;<span class="op" id="8264597">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264600">Loop</span><span class="op" id="8264604">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264608">for</span>&nbsp;<span class="op" id="8264612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264617">select</span>&nbsp;<span class="op" id="8264624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264629">case</span>&nbsp;<span class="op" id="8264634">&lt;-</span><span class="ident" id="8264636">done</span><span class="op" id="8264640">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264646">break</span>&nbsp;<span class="ident" id="8264652">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8264660">default</span><span class="op" id="8264667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264673">syscall</span><span class="op" id="8264680">.</span><span class="ident" id="8264681">Kill</span><span class="op" id="8264685">(</span><span class="ident" id="8264686">syscall</span><span class="op" id="8264693">.</span><span class="ident" id="8264694">Getpid</span><span class="op" id="8264700">(</span><span class="op" id="8264701">)</span><span class="op" id="8264702">,</span>&nbsp;<span class="ident" id="8264704">syscall</span><span class="op" id="8264711">.</span><span class="ident" id="8264712">SIGUSR1</span><span class="op" id="8264719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264725">runtime</span><span class="op" id="8264732">.</span><span class="ident" id="8264733">Gosched</span><span class="op" id="8264740">(</span><span class="op" id="8264741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264750">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264754">finished</span>&nbsp;<span class="op" id="8264763">&lt;-</span>&nbsp;<span class="builtintype" id="8264766">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264772">}</span><span class="op" id="8264773">(</span><span class="op" id="8264774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8264777">time</span><span class="op" id="8264781">.</span><span class="ident" id="8264782">Sleep</span><span class="op" id="8264787">(</span><span class="ident" id="8264788">dur</span><span class="op" id="8264791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8264794">close</span><span class="op" id="8264799">(</span><span class="ident" id="8264800">done</span><span class="op" id="8264804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264807">&lt;-</span><span class="ident" id="8264809">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8264819">&lt;-</span><span class="ident" id="8264821">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8264831">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8264902">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8264952">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265016">time</span><span class="op" id="8265020">.</span><span class="ident" id="8265021">Sleep</span><span class="op" id="8265026">(</span><span class="num" id="8265027">10</span>&nbsp;<span class="op" id="8265030">*</span>&nbsp;<span class="ident" id="8265032">time</span><span class="op" id="8265036">.</span><span class="ident" id="8265037">Millisecond</span><span class="op" id="8265048">)</span><br>
<span class="lineno">110</span><span class="op" id="8265050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8265053">var</span>&nbsp;<span class="ident" id="8265057">sendUncaughtSighup</span>&nbsp;<span class="op" id="8265076">=</span>&nbsp;<span class="ident" id="8265078">flag</span><span class="op" id="8265082">.</span><span class="ident" id="8265083">Int</span><span class="op" id="8265086">(</span><span class="string" id="8265087">&#34;send_uncaught_sighup&#34;</span><span class="op" id="8265109">,</span>&nbsp;<span class="num" id="8265111">0</span><span class="op" id="8265112">,</span>&nbsp;<span class="string" id="8265114">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="8265152">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8265155">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="8265210">func</span>&nbsp;<span class="ident" id="8265215">TestStop</span><span class="op" id="8265223">(</span><span class="ident" id="8265224">t</span>&nbsp;<span class="op" id="8265226">*</span><span class="ident" id="8265227">testing</span><span class="op" id="8265234">.</span><span class="ident" id="8265235">T</span><span class="op" id="8265236">)</span>&nbsp;<span class="op" id="8265238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265241">sigs</span>&nbsp;<span class="op" id="8265246">:=</span>&nbsp;<span class="op" id="8265249">[</span><span class="op" id="8265250">]</span><span class="ident" id="8265251">syscall</span><span class="op" id="8265258">.</span><span class="ident" id="8265259">Signal</span><span class="op" id="8265265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265269">syscall</span><span class="op" id="8265276">.</span><span class="ident" id="8265277">SIGWINCH</span><span class="op" id="8265285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265289">syscall</span><span class="op" id="8265296">.</span><span class="ident" id="8265297">SIGHUP</span><span class="op" id="8265303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265306">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265310">for</span>&nbsp;<span class="ident" id="8265314">_</span><span class="op" id="8265315">,</span>&nbsp;<span class="ident" id="8265317">sig</span>&nbsp;<span class="op" id="8265321">:=</span>&nbsp;<span class="keyword" id="8265324">range</span>&nbsp;<span class="ident" id="8265330">sigs</span>&nbsp;<span class="op" id="8265335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265339">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265361">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265406">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265477">if</span>&nbsp;<span class="ident" id="8265480">sig</span>&nbsp;<span class="op" id="8265484">!=</span>&nbsp;<span class="ident" id="8265487">syscall</span><span class="op" id="8265494">.</span><span class="ident" id="8265495">SIGHUP</span>&nbsp;<span class="op" id="8265502">||</span>&nbsp;<span class="op" id="8265505">*</span><span class="ident" id="8265506">sendUncaughtSighup</span>&nbsp;<span class="op" id="8265525">==</span>&nbsp;<span class="num" id="8265528">1</span>&nbsp;<span class="op" id="8265530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265535">syscall</span><span class="op" id="8265542">.</span><span class="ident" id="8265543">Kill</span><span class="op" id="8265547">(</span><span class="ident" id="8265548">syscall</span><span class="op" id="8265555">.</span><span class="ident" id="8265556">Getpid</span><span class="op" id="8265562">(</span><span class="op" id="8265563">)</span><span class="op" id="8265564">,</span>&nbsp;<span class="ident" id="8265566">sig</span><span class="op" id="8265569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265577">time</span><span class="op" id="8265581">.</span><span class="ident" id="8265582">Sleep</span><span class="op" id="8265587">(</span><span class="num" id="8265588">100</span>&nbsp;<span class="op" id="8265592">*</span>&nbsp;<span class="ident" id="8265594">time</span><span class="op" id="8265598">.</span><span class="ident" id="8265599">Millisecond</span><span class="op" id="8265610">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265615">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265635">c</span>&nbsp;<span class="op" id="8265637">:=</span>&nbsp;<span class="builtinfunc" id="8265640">make</span><span class="op" id="8265644">(</span><span class="keyword" id="8265645">chan</span>&nbsp;<span class="ident" id="8265650">os</span><span class="op" id="8265652">.</span><span class="ident" id="8265653">Signal</span><span class="op" id="8265659">,</span>&nbsp;<span class="num" id="8265661">1</span><span class="op" id="8265662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265666">Notify</span><span class="op" id="8265672">(</span><span class="ident" id="8265673">c</span><span class="op" id="8265674">,</span>&nbsp;<span class="ident" id="8265676">sig</span><span class="op" id="8265679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265683">defer</span>&nbsp;<span class="ident" id="8265689">Stop</span><span class="op" id="8265693">(</span><span class="ident" id="8265694">c</span><span class="op" id="8265695">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265700">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265735">syscall</span><span class="op" id="8265742">.</span><span class="ident" id="8265743">Kill</span><span class="op" id="8265747">(</span><span class="ident" id="8265748">syscall</span><span class="op" id="8265755">.</span><span class="ident" id="8265756">Getpid</span><span class="op" id="8265762">(</span><span class="op" id="8265763">)</span><span class="op" id="8265764">,</span>&nbsp;<span class="ident" id="8265766">sig</span><span class="op" id="8265769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265773">waitSig</span><span class="op" id="8265780">(</span><span class="ident" id="8265781">t</span><span class="op" id="8265782">,</span>&nbsp;<span class="ident" id="8265784">c</span><span class="op" id="8265785">,</span>&nbsp;<span class="ident" id="8265787">sig</span><span class="op" id="8265790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265795">Stop</span><span class="op" id="8265799">(</span><span class="ident" id="8265800">c</span><span class="op" id="8265801">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265805">select</span>&nbsp;<span class="op" id="8265812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265816">case</span>&nbsp;<span class="ident" id="8265821">s</span>&nbsp;<span class="op" id="8265823">:=</span>&nbsp;<span class="op" id="8265826">&lt;-</span><span class="ident" id="8265828">c</span><span class="op" id="8265829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8265834">t</span><span class="op" id="8265835">.</span><span class="ident" id="8265836">Fatalf</span><span class="op" id="8265842">(</span><span class="string" id="8265843">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8265865">,</span>&nbsp;<span class="ident" id="8265867">s</span><span class="op" id="8265868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8265872">case</span>&nbsp;<span class="op" id="8265877">&lt;-</span><span class="ident" id="8265879">time</span><span class="op" id="8265883">.</span><span class="ident" id="8265884">After</span><span class="op" id="8265889">(</span><span class="num" id="8265890">100</span>&nbsp;<span class="op" id="8265894">*</span>&nbsp;<span class="ident" id="8265896">time</span><span class="op" id="8265900">.</span><span class="ident" id="8265901">Millisecond</span><span class="op" id="8265912">)</span><span class="op" id="8265913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265918">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8265946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265951">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8265973">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266018">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266089">if</span>&nbsp;<span class="ident" id="8266092">sig</span>&nbsp;<span class="op" id="8266096">!=</span>&nbsp;<span class="ident" id="8266099">syscall</span><span class="op" id="8266106">.</span><span class="ident" id="8266107">SIGHUP</span>&nbsp;<span class="op" id="8266114">||</span>&nbsp;<span class="op" id="8266117">*</span><span class="ident" id="8266118">sendUncaughtSighup</span>&nbsp;<span class="op" id="8266137">==</span>&nbsp;<span class="num" id="8266140">2</span>&nbsp;<span class="op" id="8266142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266147">syscall</span><span class="op" id="8266154">.</span><span class="ident" id="8266155">Kill</span><span class="op" id="8266159">(</span><span class="ident" id="8266160">syscall</span><span class="op" id="8266167">.</span><span class="ident" id="8266168">Getpid</span><span class="op" id="8266174">(</span><span class="op" id="8266175">)</span><span class="op" id="8266176">,</span>&nbsp;<span class="ident" id="8266178">sig</span><span class="op" id="8266181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266190">select</span>&nbsp;<span class="op" id="8266197">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266201">case</span>&nbsp;<span class="ident" id="8266206">s</span>&nbsp;<span class="op" id="8266208">:=</span>&nbsp;<span class="op" id="8266211">&lt;-</span><span class="ident" id="8266213">c</span><span class="op" id="8266214">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266219">t</span><span class="op" id="8266220">.</span><span class="ident" id="8266221">Fatalf</span><span class="op" id="8266227">(</span><span class="string" id="8266228">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8266250">,</span>&nbsp;<span class="ident" id="8266252">s</span><span class="op" id="8266253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8266257">case</span>&nbsp;<span class="op" id="8266262">&lt;-</span><span class="ident" id="8266264">time</span><span class="op" id="8266268">.</span><span class="ident" id="8266269">After</span><span class="op" id="8266274">(</span><span class="num" id="8266275">100</span>&nbsp;<span class="op" id="8266279">*</span>&nbsp;<span class="ident" id="8266281">time</span><span class="op" id="8266285">.</span><span class="ident" id="8266286">Millisecond</span><span class="op" id="8266297">)</span><span class="op" id="8266298">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266303">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266331">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8266334">}</span><br>
<span class="lineno"></span><span class="op" id="8266336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8266339">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="8266420">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="8266429">func</span>&nbsp;<span class="ident" id="8266434">TestNohup</span><span class="op" id="8266443">(</span><span class="ident" id="8266444">t</span>&nbsp;<span class="op" id="8266446">*</span><span class="ident" id="8266447">testing</span><span class="op" id="8266454">.</span><span class="ident" id="8266455">T</span><span class="op" id="8266456">)</span>&nbsp;<span class="op" id="8266458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266461">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266525">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266578">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266622">c</span>&nbsp;<span class="op" id="8266624">:=</span>&nbsp;<span class="builtinfunc" id="8266627">make</span><span class="op" id="8266631">(</span><span class="keyword" id="8266632">chan</span>&nbsp;<span class="ident" id="8266637">os</span><span class="op" id="8266639">.</span><span class="ident" id="8266640">Signal</span><span class="op" id="8266646">,</span>&nbsp;<span class="num" id="8266648">1</span><span class="op" id="8266649">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8266652">Notify</span><span class="op" id="8266658">(</span><span class="ident" id="8266659">c</span><span class="op" id="8266660">,</span>&nbsp;<span class="ident" id="8266662">syscall</span><span class="op" id="8266669">.</span><span class="ident" id="8266670">SIGHUP</span><span class="op" id="8266676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266680">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266753">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266820">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266886">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8266965">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267043">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267047">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267130">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267213">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267217">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267277">for</span>&nbsp;<span class="ident" id="8267281">i</span>&nbsp;<span class="op" id="8267283">:=</span>&nbsp;<span class="num" id="8267286">1</span><span class="op" id="8267287">;</span>&nbsp;<span class="ident" id="8267289">i</span>&nbsp;<span class="op" id="8267291">&lt;=</span>&nbsp;<span class="num" id="8267294">2</span><span class="op" id="8267295">;</span>&nbsp;<span class="ident" id="8267297">i</span><span class="op" id="8267298">++</span>&nbsp;<span class="op" id="8267301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267305">out</span><span class="op" id="8267308">,</span>&nbsp;<span class="ident" id="8267310">err</span>&nbsp;<span class="op" id="8267314">:=</span>&nbsp;<span class="ident" id="8267317">exec</span><span class="op" id="8267321">.</span><span class="ident" id="8267322">Command</span><span class="op" id="8267329">(</span><span class="ident" id="8267330">os</span><span class="op" id="8267332">.</span><span class="ident" id="8267333">Args</span><span class="op" id="8267337">[</span><span class="num" id="8267338">0</span><span class="op" id="8267339">]</span><span class="op" id="8267340">,</span>&nbsp;<span class="string" id="8267342">&#34;-test.run=TestStop&#34;</span><span class="op" id="8267362">,</span>&nbsp;<span class="string" id="8267364">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8267388">+</span><span class="ident" id="8267389">strconv</span><span class="op" id="8267396">.</span><span class="ident" id="8267397">Itoa</span><span class="op" id="8267401">(</span><span class="ident" id="8267402">i</span><span class="op" id="8267403">)</span><span class="op" id="8267404">)</span><span class="op" id="8267405">.</span><span class="ident" id="8267406">CombinedOutput</span><span class="op" id="8267420">(</span><span class="op" id="8267421">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267425">if</span>&nbsp;<span class="ident" id="8267428">err</span>&nbsp;<span class="op" id="8267432">==</span>&nbsp;<span class="ident" id="8267435">nil</span>&nbsp;<span class="op" id="8267439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267444">t</span><span class="op" id="8267445">.</span><span class="ident" id="8267446">Fatalf</span><span class="op" id="8267452">(</span><span class="string" id="8267453">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="8267542">,</span>&nbsp;<span class="ident" id="8267544">i</span><span class="op" id="8267545">,</span>&nbsp;<span class="ident" id="8267547">out</span><span class="op" id="8267550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267561">Stop</span><span class="op" id="8267565">(</span><span class="ident" id="8267566">c</span><span class="op" id="8267567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8267571">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267629">_</span><span class="op" id="8267630">,</span>&nbsp;<span class="ident" id="8267632">err</span>&nbsp;<span class="op" id="8267636">:=</span>&nbsp;<span class="ident" id="8267639">os</span><span class="op" id="8267641">.</span><span class="ident" id="8267642">Stat</span><span class="op" id="8267646">(</span><span class="string" id="8267647">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8267663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267666">if</span>&nbsp;<span class="ident" id="8267669">err</span>&nbsp;<span class="op" id="8267673">!=</span>&nbsp;<span class="ident" id="8267676">nil</span>&nbsp;<span class="op" id="8267680">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267684">t</span><span class="op" id="8267685">.</span><span class="ident" id="8267686">Skip</span><span class="op" id="8267690">(</span><span class="string" id="8267691">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="8267740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8267743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8267747">for</span>&nbsp;<span class="ident" id="8267751">i</span>&nbsp;<span class="op" id="8267753">:=</span>&nbsp;<span class="num" id="8267756">1</span><span class="op" id="8267757">;</span>&nbsp;<span class="ident" id="8267759">i</span>&nbsp;<span class="op" id="8267761">&lt;=</span>&nbsp;<span class="num" id="8267764">2</span><span class="op" id="8267765">;</span>&nbsp;<span class="ident" id="8267767">i</span><span class="op" id="8267768">++</span>&nbsp;<span class="op" id="8267771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267775">os</span><span class="op" id="8267777">.</span><span class="ident" id="8267778">Remove</span><span class="op" id="8267784">(</span><span class="string" id="8267785">&#34;nohup.out&#34;</span><span class="op" id="8267796">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267800">out</span><span class="op" id="8267803">,</span>&nbsp;<span class="ident" id="8267805">err</span>&nbsp;<span class="op" id="8267809">:=</span>&nbsp;<span class="ident" id="8267812">exec</span><span class="op" id="8267816">.</span><span class="ident" id="8267817">Command</span><span class="op" id="8267824">(</span><span class="string" id="8267825">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8267841">,</span>&nbsp;<span class="ident" id="8267843">os</span><span class="op" id="8267845">.</span><span class="ident" id="8267846">Args</span><span class="op" id="8267850">[</span><span class="num" id="8267851">0</span><span class="op" id="8267852">]</span><span class="op" id="8267853">,</span>&nbsp;<span class="string" id="8267855">&#34;-test.run=TestStop&#34;</span><span class="op" id="8267875">,</span>&nbsp;<span class="string" id="8267877">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8267901">+</span><span class="ident" id="8267902">strconv</span><span class="op" id="8267909">.</span><span class="ident" id="8267910">Itoa</span><span class="op" id="8267914">(</span><span class="ident" id="8267915">i</span><span class="op" id="8267916">)</span><span class="op" id="8267917">)</span><span class="op" id="8267918">.</span><span class="ident" id="8267919">CombinedOutput</span><span class="op" id="8267933">(</span><span class="op" id="8267934">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267939">data</span><span class="op" id="8267943">,</span>&nbsp;<span class="ident" id="8267945">_</span>&nbsp;<span class="op" id="8267947">:=</span>&nbsp;<span class="ident" id="8267950">ioutil</span><span class="op" id="8267956">.</span><span class="ident" id="8267957">ReadFile</span><span class="op" id="8267965">(</span><span class="string" id="8267966">&#34;nohup.out&#34;</span><span class="op" id="8267977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8267981">os</span><span class="op" id="8267983">.</span><span class="ident" id="8267984">Remove</span><span class="op" id="8267990">(</span><span class="string" id="8267991">&#34;nohup.out&#34;</span><span class="op" id="8268002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8268006">if</span>&nbsp;<span class="ident" id="8268009">err</span>&nbsp;<span class="op" id="8268013">!=</span>&nbsp;<span class="ident" id="8268016">nil</span>&nbsp;<span class="op" id="8268020">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8268025">t</span><span class="op" id="8268026">.</span><span class="ident" id="8268027">Fatalf</span><span class="op" id="8268033">(</span><span class="string" id="8268034">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="8268145">,</span>&nbsp;<span class="ident" id="8268147">i</span><span class="op" id="8268148">,</span>&nbsp;<span class="ident" id="8268150">err</span><span class="op" id="8268153">,</span>&nbsp;<span class="ident" id="8268155">out</span><span class="op" id="8268158">,</span>&nbsp;<span class="ident" id="8268160">data</span><span class="op" id="8268164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8268168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8268171">}</span><br>
<span class="lineno"></span><span class="op" id="8268173">}</span>
</div>
</body>
</html>
