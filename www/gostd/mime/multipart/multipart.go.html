<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4947745">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4947800">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4947854">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4947904">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="4947908">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4948101">package</span>&nbsp;<span class="ident" id="4948109">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4948120">import</span>&nbsp;<span class="op" id="4948127">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948130">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948139">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948148">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948155">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948161">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948174">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4948182">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="4948198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4948201">var</span>&nbsp;<span class="ident" id="4948205">emptyParams</span>&nbsp;<span class="op" id="4948217">=</span>&nbsp;<span class="builtinfunc" id="4948219">make</span><span class="op" id="4948223">(</span><span class="keyword" id="4948224">map</span><span class="op" id="4948227">[</span><span class="builtintype" id="4948228">string</span><span class="op" id="4948234">]</span><span class="builtintype" id="4948235">string</span><span class="op" id="4948241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4948244">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="4948300">type</span>&nbsp;<span class="ident" id="4948305">Part</span>&nbsp;<span class="keyword" id="4948310">struct</span>&nbsp;<span class="op" id="4948317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948320">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948385">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948447">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948500">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948504">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948569">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948631">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948694">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948717">Header</span>&nbsp;<span class="ident" id="4948724">textproto</span><span class="op" id="4948733">.</span><span class="ident" id="4948734">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948747">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4948757">*</span><span class="ident" id="4948758">bytes</span><span class="op" id="4948763">.</span><span class="ident" id="4948764">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948772">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4948782">*</span><span class="ident" id="4948783">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948791">bytesRead</span>&nbsp;<span class="builtintype" id="4948801">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948807">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4948825">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4948833">dispositionParams</span>&nbsp;<span class="keyword" id="4948851">map</span><span class="op" id="4948854">[</span><span class="builtintype" id="4948855">string</span><span class="op" id="4948861">]</span><span class="builtintype" id="4948862">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948871">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948932">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4948979">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949009">r</span>&nbsp;<span class="ident" id="4949011">io</span><span class="op" id="4949013">.</span><span class="ident" id="4949014">Reader</span><br>
<span class="lineno">50</span><span class="op" id="4949021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4949024">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="4949094">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4949158">func</span>&nbsp;<span class="op" id="4949163">(</span><span class="ident" id="4949164">p</span>&nbsp;<span class="op" id="4949166">*</span><span class="ident" id="4949167">Part</span><span class="op" id="4949171">)</span>&nbsp;<span class="ident" id="4949173">FormName</span><span class="op" id="4949181">(</span><span class="op" id="4949182">)</span>&nbsp;<span class="builtintype" id="4949184">string</span>&nbsp;<span class="op" id="4949191">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4949194">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4949256">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949297">if</span>&nbsp;<span class="ident" id="4949300">p</span><span class="op" id="4949301">.</span><span class="ident" id="4949302">dispositionParams</span>&nbsp;<span class="op" id="4949320">==</span>&nbsp;<span class="ident" id="4949323">nil</span>&nbsp;<span class="op" id="4949327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949331">p</span><span class="op" id="4949332">.</span><span class="ident" id="4949333">parseContentDisposition</span><span class="op" id="4949356">(</span><span class="op" id="4949357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4949360">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949363">if</span>&nbsp;<span class="ident" id="4949366">p</span><span class="op" id="4949367">.</span><span class="ident" id="4949368">disposition</span>&nbsp;<span class="op" id="4949380">!=</span>&nbsp;<span class="string" id="4949383">&#34;form-data&#34;</span>&nbsp;<span class="op" id="4949395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949399">return</span>&nbsp;<span class="string" id="4949406">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4949410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949413">return</span>&nbsp;<span class="ident" id="4949420">p</span><span class="op" id="4949421">.</span><span class="ident" id="4949422">dispositionParams</span><span class="op" id="4949439">[</span><span class="string" id="4949440">&#34;name&#34;</span><span class="op" id="4949446">]</span><br>
<span class="lineno"></span><span class="op" id="4949448">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="4949451">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4949508">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4949539">func</span>&nbsp;<span class="op" id="4949544">(</span><span class="ident" id="4949545">p</span>&nbsp;<span class="op" id="4949547">*</span><span class="ident" id="4949548">Part</span><span class="op" id="4949552">)</span>&nbsp;<span class="ident" id="4949554">FileName</span><span class="op" id="4949562">(</span><span class="op" id="4949563">)</span>&nbsp;<span class="builtintype" id="4949565">string</span>&nbsp;<span class="op" id="4949572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949575">if</span>&nbsp;<span class="ident" id="4949578">p</span><span class="op" id="4949579">.</span><span class="ident" id="4949580">dispositionParams</span>&nbsp;<span class="op" id="4949598">==</span>&nbsp;<span class="ident" id="4949601">nil</span>&nbsp;<span class="op" id="4949605">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949609">p</span><span class="op" id="4949610">.</span><span class="ident" id="4949611">parseContentDisposition</span><span class="op" id="4949634">(</span><span class="op" id="4949635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4949638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949641">return</span>&nbsp;<span class="ident" id="4949648">p</span><span class="op" id="4949649">.</span><span class="ident" id="4949650">dispositionParams</span><span class="op" id="4949667">[</span><span class="string" id="4949668">&#34;filename&#34;</span><span class="op" id="4949678">]</span><br>
<span class="lineno"></span><span class="op" id="4949680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="4949683">func</span>&nbsp;<span class="op" id="4949688">(</span><span class="ident" id="4949689">p</span>&nbsp;<span class="op" id="4949691">*</span><span class="ident" id="4949692">Part</span><span class="op" id="4949696">)</span>&nbsp;<span class="ident" id="4949698">parseContentDisposition</span><span class="op" id="4949721">(</span><span class="op" id="4949722">)</span>&nbsp;<span class="op" id="4949724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949727">v</span>&nbsp;<span class="op" id="4949729">:=</span>&nbsp;<span class="ident" id="4949732">p</span><span class="op" id="4949733">.</span><span class="ident" id="4949734">Header</span><span class="op" id="4949740">.</span><span class="ident" id="4949741">Get</span><span class="op" id="4949744">(</span><span class="string" id="4949745">&#34;Content-Disposition&#34;</span><span class="op" id="4949766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949769">var</span>&nbsp;<span class="ident" id="4949773">err</span>&nbsp;<span class="builtintype" id="4949777">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949784">p</span><span class="op" id="4949785">.</span><span class="ident" id="4949786">disposition</span><span class="op" id="4949797">,</span>&nbsp;<span class="ident" id="4949799">p</span><span class="op" id="4949800">.</span><span class="ident" id="4949801">dispositionParams</span><span class="op" id="4949818">,</span>&nbsp;<span class="ident" id="4949820">err</span>&nbsp;<span class="op" id="4949824">=</span>&nbsp;<span class="ident" id="4949826">mime</span><span class="op" id="4949830">.</span><span class="ident" id="4949831">ParseMediaType</span><span class="op" id="4949845">(</span><span class="ident" id="4949846">v</span><span class="op" id="4949847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4949850">if</span>&nbsp;<span class="ident" id="4949853">err</span>&nbsp;<span class="op" id="4949857">!=</span>&nbsp;<span class="ident" id="4949860">nil</span>&nbsp;<span class="op" id="4949864">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4949868">p</span><span class="op" id="4949869">.</span><span class="ident" id="4949870">dispositionParams</span>&nbsp;<span class="op" id="4949888">=</span>&nbsp;<span class="ident" id="4949890">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4949903">}</span><br>
<span class="lineno"></span><span class="op" id="4949905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4949908">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="4949977">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="4950001">//</span><br>
<span class="lineno"></span><span class="comment" id="4950004">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4950073">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4950140">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="4950163">func</span>&nbsp;<span class="ident" id="4950168">NewReader</span><span class="op" id="4950177">(</span><span class="ident" id="4950178">r</span>&nbsp;<span class="ident" id="4950180">io</span><span class="op" id="4950182">.</span><span class="ident" id="4950183">Reader</span><span class="op" id="4950189">,</span>&nbsp;<span class="ident" id="4950191">boundary</span>&nbsp;<span class="builtintype" id="4950200">string</span><span class="op" id="4950206">)</span>&nbsp;<span class="op" id="4950208">*</span><span class="ident" id="4950209">Reader</span>&nbsp;<span class="op" id="4950216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950219">b</span>&nbsp;<span class="op" id="4950221">:=</span>&nbsp;<span class="op" id="4950224">[</span><span class="op" id="4950225">]</span><span class="builtintype" id="4950226">byte</span><span class="op" id="4950230">(</span><span class="string" id="4950231">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="4950240">+</span>&nbsp;<span class="ident" id="4950242">boundary</span>&nbsp;<span class="op" id="4950251">+</span>&nbsp;<span class="string" id="4950253">&#34;--&#34;</span><span class="op" id="4950257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950260">return</span>&nbsp;<span class="op" id="4950267">&amp;</span><span class="ident" id="4950268">Reader</span><span class="op" id="4950274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950278">bufReader</span><span class="op" id="4950287">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4950296">bufio</span><span class="op" id="4950301">.</span><span class="ident" id="4950302">NewReader</span><span class="op" id="4950311">(</span><span class="ident" id="4950312">r</span><span class="op" id="4950313">)</span><span class="op" id="4950314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950318">nl</span><span class="op" id="4950320">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4950336">b</span><span class="op" id="4950337">[</span><span class="op" id="4950338">:</span><span class="num" id="4950339">2</span><span class="op" id="4950340">]</span><span class="op" id="4950341">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950345">nlDashBoundary</span><span class="op" id="4950359">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4950363">b</span><span class="op" id="4950364">[</span><span class="op" id="4950365">:</span><span class="builtinfunc" id="4950366">len</span><span class="op" id="4950369">(</span><span class="ident" id="4950370">b</span><span class="op" id="4950371">)</span><span class="op" id="4950372">-</span><span class="num" id="4950373">2</span><span class="op" id="4950374">]</span><span class="op" id="4950375">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950379">dashBoundaryDash</span><span class="op" id="4950395">:</span>&nbsp;<span class="ident" id="4950397">b</span><span class="op" id="4950398">[</span><span class="num" id="4950399">2</span><span class="op" id="4950400">:</span><span class="op" id="4950401">]</span><span class="op" id="4950402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950406">dashBoundary</span><span class="op" id="4950418">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4950424">b</span><span class="op" id="4950425">[</span><span class="num" id="4950426">2</span>&nbsp;<span class="op" id="4950428">:</span>&nbsp;<span class="builtinfunc" id="4950430">len</span><span class="op" id="4950433">(</span><span class="ident" id="4950434">b</span><span class="op" id="4950435">)</span><span class="op" id="4950436">-</span><span class="num" id="4950437">2</span><span class="op" id="4950438">]</span><span class="op" id="4950439">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950442">}</span><br>
<span class="lineno"></span><span class="op" id="4950444">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="4950447">func</span>&nbsp;<span class="ident" id="4950452">newPart</span><span class="op" id="4950459">(</span><span class="ident" id="4950460">mr</span>&nbsp;<span class="op" id="4950463">*</span><span class="ident" id="4950464">Reader</span><span class="op" id="4950470">)</span>&nbsp;<span class="op" id="4950472">(</span><span class="op" id="4950473">*</span><span class="ident" id="4950474">Part</span><span class="op" id="4950478">,</span>&nbsp;<span class="builtintype" id="4950480">error</span><span class="op" id="4950485">)</span>&nbsp;<span class="op" id="4950487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950490">bp</span>&nbsp;<span class="op" id="4950493">:=</span>&nbsp;<span class="op" id="4950496">&amp;</span><span class="ident" id="4950497">Part</span><span class="op" id="4950501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950505">Header</span><span class="op" id="4950511">:</span>&nbsp;<span class="builtinfunc" id="4950513">make</span><span class="op" id="4950517">(</span><span class="keyword" id="4950518">map</span><span class="op" id="4950521">[</span><span class="builtintype" id="4950522">string</span><span class="op" id="4950528">]</span><span class="op" id="4950529">[</span><span class="op" id="4950530">]</span><span class="builtintype" id="4950531">string</span><span class="op" id="4950537">)</span><span class="op" id="4950538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950542">mr</span><span class="op" id="4950544">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4950550">mr</span><span class="op" id="4950552">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950556">buffer</span><span class="op" id="4950562">:</span>&nbsp;<span class="builtinfunc" id="4950564">new</span><span class="op" id="4950567">(</span><span class="ident" id="4950568">bytes</span><span class="op" id="4950573">.</span><span class="ident" id="4950574">Buffer</span><span class="op" id="4950580">)</span><span class="op" id="4950581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950587">if</span>&nbsp;<span class="ident" id="4950590">err</span>&nbsp;<span class="op" id="4950594">:=</span>&nbsp;<span class="ident" id="4950597">bp</span><span class="op" id="4950599">.</span><span class="ident" id="4950600">populateHeaders</span><span class="op" id="4950615">(</span><span class="op" id="4950616">)</span><span class="op" id="4950617">;</span>&nbsp;<span class="ident" id="4950619">err</span>&nbsp;<span class="op" id="4950623">!=</span>&nbsp;<span class="ident" id="4950626">nil</span>&nbsp;<span class="op" id="4950630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950634">return</span>&nbsp;<span class="ident" id="4950641">nil</span><span class="op" id="4950644">,</span>&nbsp;<span class="ident" id="4950646">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950651">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950654">bp</span><span class="op" id="4950656">.</span><span class="ident" id="4950657">r</span>&nbsp;<span class="op" id="4950659">=</span>&nbsp;<span class="ident" id="4950661">partReader</span><span class="op" id="4950671">{</span><span class="ident" id="4950672">bp</span><span class="op" id="4950674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950677">const</span>&nbsp;<span class="ident" id="4950683">cte</span>&nbsp;<span class="op" id="4950687">=</span>&nbsp;<span class="string" id="4950689">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950718">if</span>&nbsp;<span class="ident" id="4950721">bp</span><span class="op" id="4950723">.</span><span class="ident" id="4950724">Header</span><span class="op" id="4950730">.</span><span class="ident" id="4950731">Get</span><span class="op" id="4950734">(</span><span class="ident" id="4950735">cte</span><span class="op" id="4950738">)</span>&nbsp;<span class="op" id="4950740">==</span>&nbsp;<span class="string" id="4950743">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="4950762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950766">bp</span><span class="op" id="4950768">.</span><span class="ident" id="4950769">Header</span><span class="op" id="4950775">.</span><span class="ident" id="4950776">Del</span><span class="op" id="4950779">(</span><span class="ident" id="4950780">cte</span><span class="op" id="4950783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950787">bp</span><span class="op" id="4950789">.</span><span class="ident" id="4950790">r</span>&nbsp;<span class="op" id="4950792">=</span>&nbsp;<span class="ident" id="4950794">newQuotedPrintableReader</span><span class="op" id="4950818">(</span><span class="ident" id="4950819">bp</span><span class="op" id="4950821">.</span><span class="ident" id="4950822">r</span><span class="op" id="4950823">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4950826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950829">return</span>&nbsp;<span class="ident" id="4950836">bp</span><span class="op" id="4950838">,</span>&nbsp;<span class="ident" id="4950840">nil</span><br>
<span class="lineno"></span><span class="op" id="4950844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4950847">func</span>&nbsp;<span class="op" id="4950852">(</span><span class="ident" id="4950853">bp</span>&nbsp;<span class="op" id="4950856">*</span><span class="ident" id="4950857">Part</span><span class="op" id="4950861">)</span>&nbsp;<span class="ident" id="4950863">populateHeaders</span><span class="op" id="4950878">(</span><span class="op" id="4950879">)</span>&nbsp;<span class="builtintype" id="4950881">error</span>&nbsp;<span class="op" id="4950887">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950890">r</span>&nbsp;<span class="op" id="4950892">:=</span>&nbsp;<span class="ident" id="4950895">textproto</span><span class="op" id="4950904">.</span><span class="ident" id="4950905">NewReader</span><span class="op" id="4950914">(</span><span class="ident" id="4950915">bp</span><span class="op" id="4950917">.</span><span class="ident" id="4950918">mr</span><span class="op" id="4950920">.</span><span class="ident" id="4950921">bufReader</span><span class="op" id="4950930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950933">header</span><span class="op" id="4950939">,</span>&nbsp;<span class="ident" id="4950941">err</span>&nbsp;<span class="op" id="4950945">:=</span>&nbsp;<span class="ident" id="4950948">r</span><span class="op" id="4950949">.</span><span class="ident" id="4950950">ReadMIMEHeader</span><span class="op" id="4950964">(</span><span class="op" id="4950965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4950968">if</span>&nbsp;<span class="ident" id="4950971">err</span>&nbsp;<span class="op" id="4950975">==</span>&nbsp;<span class="ident" id="4950978">nil</span>&nbsp;<span class="op" id="4950982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4950986">bp</span><span class="op" id="4950988">.</span><span class="ident" id="4950989">Header</span>&nbsp;<span class="op" id="4950996">=</span>&nbsp;<span class="ident" id="4950998">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951006">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951009">return</span>&nbsp;<span class="ident" id="4951016">err</span><br>
<span class="lineno"></span><span class="op" id="4951020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4951023">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4951090">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="4951120">func</span>&nbsp;<span class="op" id="4951125">(</span><span class="ident" id="4951126">p</span>&nbsp;<span class="op" id="4951128">*</span><span class="ident" id="4951129">Part</span><span class="op" id="4951133">)</span>&nbsp;<span class="ident" id="4951135">Read</span><span class="op" id="4951139">(</span><span class="ident" id="4951140">d</span>&nbsp;<span class="op" id="4951142">[</span><span class="op" id="4951143">]</span><span class="builtintype" id="4951144">byte</span><span class="op" id="4951148">)</span>&nbsp;<span class="op" id="4951150">(</span><span class="ident" id="4951151">n</span>&nbsp;<span class="builtintype" id="4951153">int</span><span class="op" id="4951156">,</span>&nbsp;<span class="ident" id="4951158">err</span>&nbsp;<span class="builtintype" id="4951162">error</span><span class="op" id="4951167">)</span>&nbsp;<span class="op" id="4951169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951172">return</span>&nbsp;<span class="ident" id="4951179">p</span><span class="op" id="4951180">.</span><span class="ident" id="4951181">r</span><span class="op" id="4951182">.</span><span class="ident" id="4951183">Read</span><span class="op" id="4951187">(</span><span class="ident" id="4951188">d</span><span class="op" id="4951189">)</span><br>
<span class="lineno"></span><span class="op" id="4951191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4951194">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="4951268">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="4951332">type</span>&nbsp;<span class="ident" id="4951337">partReader</span>&nbsp;<span class="keyword" id="4951348">struct</span>&nbsp;<span class="op" id="4951355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951358">p</span>&nbsp;<span class="op" id="4951360">*</span><span class="ident" id="4951361">Part</span><br>
<span class="lineno"></span><span class="op" id="4951366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="4951369">func</span>&nbsp;<span class="op" id="4951374">(</span><span class="ident" id="4951375">pr</span>&nbsp;<span class="ident" id="4951378">partReader</span><span class="op" id="4951388">)</span>&nbsp;<span class="ident" id="4951390">Read</span><span class="op" id="4951394">(</span><span class="ident" id="4951395">d</span>&nbsp;<span class="op" id="4951397">[</span><span class="op" id="4951398">]</span><span class="builtintype" id="4951399">byte</span><span class="op" id="4951403">)</span>&nbsp;<span class="op" id="4951405">(</span><span class="ident" id="4951406">n</span>&nbsp;<span class="builtintype" id="4951408">int</span><span class="op" id="4951411">,</span>&nbsp;<span class="ident" id="4951413">err</span>&nbsp;<span class="builtintype" id="4951417">error</span><span class="op" id="4951422">)</span>&nbsp;<span class="op" id="4951424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951427">p</span>&nbsp;<span class="op" id="4951429">:=</span>&nbsp;<span class="ident" id="4951432">pr</span><span class="op" id="4951434">.</span><span class="ident" id="4951435">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951438">defer</span>&nbsp;<span class="keyword" id="4951444">func</span><span class="op" id="4951448">(</span><span class="op" id="4951449">)</span>&nbsp;<span class="op" id="4951451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951455">p</span><span class="op" id="4951456">.</span><span class="ident" id="4951457">bytesRead</span>&nbsp;<span class="op" id="4951467">+=</span>&nbsp;<span class="ident" id="4951470">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951473">}</span><span class="op" id="4951474">(</span><span class="op" id="4951475">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951478">if</span>&nbsp;<span class="ident" id="4951481">p</span><span class="op" id="4951482">.</span><span class="ident" id="4951483">buffer</span><span class="op" id="4951489">.</span><span class="ident" id="4951490">Len</span><span class="op" id="4951493">(</span><span class="op" id="4951494">)</span>&nbsp;<span class="op" id="4951496">&gt;=</span>&nbsp;<span class="builtinfunc" id="4951499">len</span><span class="op" id="4951502">(</span><span class="ident" id="4951503">d</span><span class="op" id="4951504">)</span>&nbsp;<span class="op" id="4951506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951510">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951570">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4951631">return</span>&nbsp;<span class="ident" id="4951638">p</span><span class="op" id="4951639">.</span><span class="ident" id="4951640">buffer</span><span class="op" id="4951646">.</span><span class="ident" id="4951647">Read</span><span class="op" id="4951651">(</span><span class="ident" id="4951652">d</span><span class="op" id="4951653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4951656">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4951659">peek</span><span class="op" id="4951663">,</span>&nbsp;<span class="ident" id="4951665">err</span>&nbsp;<span class="op" id="4951669">:=</span>&nbsp;<span class="ident" id="4951672">p</span><span class="op" id="4951673">.</span><span class="ident" id="4951674">mr</span><span class="op" id="4951676">.</span><span class="ident" id="4951677">bufReader</span><span class="op" id="4951686">.</span><span class="ident" id="4951687">Peek</span><span class="op" id="4951691">(</span><span class="num" id="4951692">4096</span><span class="op" id="4951696">)</span>&nbsp;<span class="comment" id="4951698">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951744">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951804">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951867">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951927">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4951987">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952012">if</span>&nbsp;<span class="ident" id="4952015">p</span><span class="op" id="4952016">.</span><span class="ident" id="4952017">bytesRead</span>&nbsp;<span class="op" id="4952027">==</span>&nbsp;<span class="num" id="4952030">0</span>&nbsp;<span class="op" id="4952032">&amp;&amp;</span>&nbsp;<span class="ident" id="4952035">p</span><span class="op" id="4952036">.</span><span class="ident" id="4952037">mr</span><span class="op" id="4952039">.</span><span class="ident" id="4952040">peekBufferIsEmptyPart</span><span class="op" id="4952061">(</span><span class="ident" id="4952062">peek</span><span class="op" id="4952066">)</span>&nbsp;<span class="op" id="4952068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952072">return</span>&nbsp;<span class="num" id="4952079">0</span><span class="op" id="4952080">,</span>&nbsp;<span class="ident" id="4952082">io</span><span class="op" id="4952084">.</span><span class="ident" id="4952085">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952090">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952093">unexpectedEOF</span>&nbsp;<span class="op" id="4952107">:=</span>&nbsp;<span class="ident" id="4952110">err</span>&nbsp;<span class="op" id="4952114">==</span>&nbsp;<span class="ident" id="4952117">io</span><span class="op" id="4952119">.</span><span class="ident" id="4952120">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952125">if</span>&nbsp;<span class="ident" id="4952128">err</span>&nbsp;<span class="op" id="4952132">!=</span>&nbsp;<span class="ident" id="4952135">nil</span>&nbsp;<span class="op" id="4952139">&amp;&amp;</span>&nbsp;<span class="op" id="4952142">!</span><span class="ident" id="4952143">unexpectedEOF</span>&nbsp;<span class="op" id="4952157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952161">return</span>&nbsp;<span class="num" id="4952168">0</span><span class="op" id="4952169">,</span>&nbsp;<span class="ident" id="4952171">fmt</span><span class="op" id="4952174">.</span><span class="ident" id="4952175">Errorf</span><span class="op" id="4952181">(</span><span class="string" id="4952182">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="4952208">,</span>&nbsp;<span class="ident" id="4952210">err</span><span class="op" id="4952213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952219">if</span>&nbsp;<span class="ident" id="4952222">peek</span>&nbsp;<span class="op" id="4952227">==</span>&nbsp;<span class="ident" id="4952230">nil</span>&nbsp;<span class="op" id="4952234">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4952238">panic</span><span class="op" id="4952243">(</span><span class="string" id="4952244">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="4952258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952265">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952324">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952388">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952447">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952459">nCopy</span>&nbsp;<span class="op" id="4952465">:=</span>&nbsp;<span class="num" id="4952468">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952471">foundBoundary</span>&nbsp;<span class="op" id="4952485">:=</span>&nbsp;<span class="builtintype" id="4952488">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952495">if</span>&nbsp;<span class="ident" id="4952498">idx</span>&nbsp;<span class="op" id="4952502">:=</span>&nbsp;<span class="ident" id="4952505">bytes</span><span class="op" id="4952510">.</span><span class="ident" id="4952511">Index</span><span class="op" id="4952516">(</span><span class="ident" id="4952517">peek</span><span class="op" id="4952521">,</span>&nbsp;<span class="ident" id="4952523">p</span><span class="op" id="4952524">.</span><span class="ident" id="4952525">mr</span><span class="op" id="4952527">.</span><span class="ident" id="4952528">nlDashBoundary</span><span class="op" id="4952542">)</span><span class="op" id="4952543">;</span>&nbsp;<span class="ident" id="4952545">idx</span>&nbsp;<span class="op" id="4952549">!=</span>&nbsp;<span class="op" id="4952552">-</span><span class="num" id="4952553">1</span>&nbsp;<span class="op" id="4952555">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952559">nCopy</span>&nbsp;<span class="op" id="4952565">=</span>&nbsp;<span class="ident" id="4952567">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952573">foundBoundary</span>&nbsp;<span class="op" id="4952587">=</span>&nbsp;<span class="builtintype" id="4952589">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952595">}</span>&nbsp;<span class="keyword" id="4952597">else</span>&nbsp;<span class="keyword" id="4952602">if</span>&nbsp;<span class="ident" id="4952605">safeCount</span>&nbsp;<span class="op" id="4952615">:=</span>&nbsp;<span class="builtinfunc" id="4952618">len</span><span class="op" id="4952621">(</span><span class="ident" id="4952622">peek</span><span class="op" id="4952626">)</span>&nbsp;<span class="op" id="4952628">-</span>&nbsp;<span class="builtinfunc" id="4952630">len</span><span class="op" id="4952633">(</span><span class="ident" id="4952634">p</span><span class="op" id="4952635">.</span><span class="ident" id="4952636">mr</span><span class="op" id="4952638">.</span><span class="ident" id="4952639">nlDashBoundary</span><span class="op" id="4952653">)</span><span class="op" id="4952654">;</span>&nbsp;<span class="ident" id="4952656">safeCount</span>&nbsp;<span class="op" id="4952666">&gt;</span>&nbsp;<span class="num" id="4952668">0</span>&nbsp;<span class="op" id="4952670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4952674">nCopy</span>&nbsp;<span class="op" id="4952680">=</span>&nbsp;<span class="ident" id="4952682">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952693">}</span>&nbsp;<span class="keyword" id="4952695">else</span>&nbsp;<span class="keyword" id="4952700">if</span>&nbsp;<span class="ident" id="4952703">unexpectedEOF</span>&nbsp;<span class="op" id="4952717">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952721">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952775">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4952832">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952875">return</span>&nbsp;<span class="num" id="4952882">0</span><span class="op" id="4952883">,</span>&nbsp;<span class="ident" id="4952885">io</span><span class="op" id="4952887">.</span><span class="ident" id="4952888">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4952906">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952909">if</span>&nbsp;<span class="ident" id="4952912">nCopy</span>&nbsp;<span class="op" id="4952918">&gt;</span>&nbsp;<span class="num" id="4952920">0</span>&nbsp;<span class="op" id="4952922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4952926">if</span>&nbsp;<span class="ident" id="4952929">_</span><span class="op" id="4952930">,</span>&nbsp;<span class="ident" id="4952932">err</span>&nbsp;<span class="op" id="4952936">:=</span>&nbsp;<span class="ident" id="4952939">io</span><span class="op" id="4952941">.</span><span class="ident" id="4952942">CopyN</span><span class="op" id="4952947">(</span><span class="ident" id="4952948">p</span><span class="op" id="4952949">.</span><span class="ident" id="4952950">buffer</span><span class="op" id="4952956">,</span>&nbsp;<span class="ident" id="4952958">p</span><span class="op" id="4952959">.</span><span class="ident" id="4952960">mr</span><span class="op" id="4952962">.</span><span class="ident" id="4952963">bufReader</span><span class="op" id="4952972">,</span>&nbsp;<span class="ident" id="4952974">int64</span><span class="op" id="4952979">(</span><span class="ident" id="4952980">nCopy</span><span class="op" id="4952985">)</span><span class="op" id="4952986">)</span><span class="op" id="4952987">;</span>&nbsp;<span class="ident" id="4952989">err</span>&nbsp;<span class="op" id="4952993">!=</span>&nbsp;<span class="ident" id="4952996">nil</span>&nbsp;<span class="op" id="4953000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4953005">return</span>&nbsp;<span class="num" id="4953012">0</span><span class="op" id="4953013">,</span>&nbsp;<span class="ident" id="4953015">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4953021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4953024">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953027">n</span><span class="op" id="4953028">,</span>&nbsp;<span class="ident" id="4953030">err</span>&nbsp;<span class="op" id="4953034">=</span>&nbsp;<span class="ident" id="4953036">p</span><span class="op" id="4953037">.</span><span class="ident" id="4953038">buffer</span><span class="op" id="4953044">.</span><span class="ident" id="4953045">Read</span><span class="op" id="4953049">(</span><span class="ident" id="4953050">d</span><span class="op" id="4953051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4953054">if</span>&nbsp;<span class="ident" id="4953057">err</span>&nbsp;<span class="op" id="4953061">==</span>&nbsp;<span class="ident" id="4953064">io</span><span class="op" id="4953066">.</span><span class="ident" id="4953067">EOF</span>&nbsp;<span class="op" id="4953071">&amp;&amp;</span>&nbsp;<span class="op" id="4953074">!</span><span class="ident" id="4953075">foundBoundary</span>&nbsp;<span class="op" id="4953089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4953093">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4953150">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953206">err</span>&nbsp;<span class="op" id="4953210">=</span>&nbsp;<span class="ident" id="4953212">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4953217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4953220">return</span><br>
<span class="lineno"></span><span class="op" id="4953227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4953230">func</span>&nbsp;<span class="op" id="4953235">(</span><span class="ident" id="4953236">p</span>&nbsp;<span class="op" id="4953238">*</span><span class="ident" id="4953239">Part</span><span class="op" id="4953243">)</span>&nbsp;<span class="ident" id="4953245">Close</span><span class="op" id="4953250">(</span><span class="op" id="4953251">)</span>&nbsp;<span class="builtintype" id="4953253">error</span>&nbsp;<span class="op" id="4953259">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953262">io</span><span class="op" id="4953264">.</span><span class="ident" id="4953265">Copy</span><span class="op" id="4953269">(</span><span class="ident" id="4953270">ioutil</span><span class="op" id="4953276">.</span><span class="ident" id="4953277">Discard</span><span class="op" id="4953284">,</span>&nbsp;<span class="ident" id="4953286">p</span><span class="op" id="4953287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4953290">return</span>&nbsp;<span class="ident" id="4953297">nil</span><br>
<span class="lineno"></span><span class="op" id="4953301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4953304">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="4953366">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="4953435">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="4953455">type</span>&nbsp;<span class="ident" id="4953460">Reader</span>&nbsp;<span class="keyword" id="4953467">struct</span>&nbsp;<span class="op" id="4953474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953477">bufReader</span>&nbsp;<span class="op" id="4953487">*</span><span class="ident" id="4953488">bufio</span><span class="op" id="4953493">.</span><span class="ident" id="4953494">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953503">currentPart</span>&nbsp;<span class="op" id="4953515">*</span><span class="ident" id="4953516">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953522">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4953534">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953540">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4953557">[</span><span class="op" id="4953558">]</span><span class="builtintype" id="4953559">byte</span>&nbsp;<span class="comment" id="4953564">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953622">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4953639">[</span><span class="op" id="4953640">]</span><span class="builtintype" id="4953641">byte</span>&nbsp;<span class="comment" id="4953646">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953668">dashBoundaryDash</span>&nbsp;<span class="op" id="4953685">[</span><span class="op" id="4953686">]</span><span class="builtintype" id="4953687">byte</span>&nbsp;<span class="comment" id="4953692">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953711">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4953728">[</span><span class="op" id="4953729">]</span><span class="builtintype" id="4953730">byte</span>&nbsp;<span class="comment" id="4953735">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="4953751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4953754">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="4953818">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4953881">func</span>&nbsp;<span class="op" id="4953886">(</span><span class="ident" id="4953887">r</span>&nbsp;<span class="op" id="4953889">*</span><span class="ident" id="4953890">Reader</span><span class="op" id="4953896">)</span>&nbsp;<span class="ident" id="4953898">NextPart</span><span class="op" id="4953906">(</span><span class="op" id="4953907">)</span>&nbsp;<span class="op" id="4953909">(</span><span class="op" id="4953910">*</span><span class="ident" id="4953911">Part</span><span class="op" id="4953915">,</span>&nbsp;<span class="builtintype" id="4953917">error</span><span class="op" id="4953922">)</span>&nbsp;<span class="op" id="4953924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4953927">if</span>&nbsp;<span class="ident" id="4953930">r</span><span class="op" id="4953931">.</span><span class="ident" id="4953932">currentPart</span>&nbsp;<span class="op" id="4953944">!=</span>&nbsp;<span class="ident" id="4953947">nil</span>&nbsp;<span class="op" id="4953951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953955">r</span><span class="op" id="4953956">.</span><span class="ident" id="4953957">currentPart</span><span class="op" id="4953968">.</span><span class="ident" id="4953969">Close</span><span class="op" id="4953974">(</span><span class="op" id="4953975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4953978">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4953982">expectNewPart</span>&nbsp;<span class="op" id="4953996">:=</span>&nbsp;<span class="builtintype" id="4953999">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954006">for</span>&nbsp;<span class="op" id="4954010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954014">line</span><span class="op" id="4954018">,</span>&nbsp;<span class="ident" id="4954020">err</span>&nbsp;<span class="op" id="4954024">:=</span>&nbsp;<span class="ident" id="4954027">r</span><span class="op" id="4954028">.</span><span class="ident" id="4954029">bufReader</span><span class="op" id="4954038">.</span><span class="ident" id="4954039">ReadSlice</span><span class="op" id="4954048">(</span><span class="string" id="4954049">&#39;\n&#39;</span><span class="op" id="4954053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954057">if</span>&nbsp;<span class="ident" id="4954060">err</span>&nbsp;<span class="op" id="4954064">==</span>&nbsp;<span class="ident" id="4954067">io</span><span class="op" id="4954069">.</span><span class="ident" id="4954070">EOF</span>&nbsp;<span class="op" id="4954074">&amp;&amp;</span>&nbsp;<span class="ident" id="4954077">r</span><span class="op" id="4954078">.</span><span class="ident" id="4954079">isFinalBoundary</span><span class="op" id="4954094">(</span><span class="ident" id="4954095">line</span><span class="op" id="4954099">)</span>&nbsp;<span class="op" id="4954101">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954106">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954161">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954215">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954272">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954331">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954356">return</span>&nbsp;<span class="ident" id="4954363">nil</span><span class="op" id="4954366">,</span>&nbsp;<span class="ident" id="4954368">io</span><span class="op" id="4954370">.</span><span class="ident" id="4954371">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954381">if</span>&nbsp;<span class="ident" id="4954384">err</span>&nbsp;<span class="op" id="4954388">!=</span>&nbsp;<span class="ident" id="4954391">nil</span>&nbsp;<span class="op" id="4954395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954400">return</span>&nbsp;<span class="ident" id="4954407">nil</span><span class="op" id="4954410">,</span>&nbsp;<span class="ident" id="4954412">fmt</span><span class="op" id="4954415">.</span><span class="ident" id="4954416">Errorf</span><span class="op" id="4954422">(</span><span class="string" id="4954423">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="4954448">,</span>&nbsp;<span class="ident" id="4954450">err</span><span class="op" id="4954453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954457">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954462">if</span>&nbsp;<span class="ident" id="4954465">r</span><span class="op" id="4954466">.</span><span class="ident" id="4954467">isBoundaryDelimiterLine</span><span class="op" id="4954490">(</span><span class="ident" id="4954491">line</span><span class="op" id="4954495">)</span>&nbsp;<span class="op" id="4954497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954502">r</span><span class="op" id="4954503">.</span><span class="ident" id="4954504">partsRead</span><span class="op" id="4954513">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954519">bp</span><span class="op" id="4954521">,</span>&nbsp;<span class="ident" id="4954523">err</span>&nbsp;<span class="op" id="4954527">:=</span>&nbsp;<span class="ident" id="4954530">newPart</span><span class="op" id="4954537">(</span><span class="ident" id="4954538">r</span><span class="op" id="4954539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954544">if</span>&nbsp;<span class="ident" id="4954547">err</span>&nbsp;<span class="op" id="4954551">!=</span>&nbsp;<span class="ident" id="4954554">nil</span>&nbsp;<span class="op" id="4954558">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954564">return</span>&nbsp;<span class="ident" id="4954571">nil</span><span class="op" id="4954574">,</span>&nbsp;<span class="ident" id="4954576">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4954588">r</span><span class="op" id="4954589">.</span><span class="ident" id="4954590">currentPart</span>&nbsp;<span class="op" id="4954602">=</span>&nbsp;<span class="ident" id="4954604">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954610">return</span>&nbsp;<span class="ident" id="4954617">bp</span><span class="op" id="4954619">,</span>&nbsp;<span class="ident" id="4954621">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954627">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954632">if</span>&nbsp;<span class="ident" id="4954635">r</span><span class="op" id="4954636">.</span><span class="ident" id="4954637">isFinalBoundary</span><span class="op" id="4954652">(</span><span class="ident" id="4954653">line</span><span class="op" id="4954657">)</span>&nbsp;<span class="op" id="4954659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954664">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954683">return</span>&nbsp;<span class="ident" id="4954690">nil</span><span class="op" id="4954693">,</span>&nbsp;<span class="ident" id="4954695">io</span><span class="op" id="4954697">.</span><span class="ident" id="4954698">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954704">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954709">if</span>&nbsp;<span class="ident" id="4954712">expectNewPart</span>&nbsp;<span class="op" id="4954726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954731">return</span>&nbsp;<span class="ident" id="4954738">nil</span><span class="op" id="4954741">,</span>&nbsp;<span class="ident" id="4954743">fmt</span><span class="op" id="4954746">.</span><span class="ident" id="4954747">Errorf</span><span class="op" id="4954753">(</span><span class="string" id="4954754">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="4954800">,</span>&nbsp;<span class="builtintype" id="4954802">string</span><span class="op" id="4954808">(</span><span class="ident" id="4954809">line</span><span class="op" id="4954813">)</span><span class="op" id="4954814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954823">if</span>&nbsp;<span class="ident" id="4954826">r</span><span class="op" id="4954827">.</span><span class="ident" id="4954828">partsRead</span>&nbsp;<span class="op" id="4954838">==</span>&nbsp;<span class="num" id="4954841">0</span>&nbsp;<span class="op" id="4954843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954848">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4954864">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4954875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954880">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954934">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4954990">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955045">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955064">if</span>&nbsp;<span class="ident" id="4955067">bytes</span><span class="op" id="4955072">.</span><span class="ident" id="4955073">Equal</span><span class="op" id="4955078">(</span><span class="ident" id="4955079">line</span><span class="op" id="4955083">,</span>&nbsp;<span class="ident" id="4955085">r</span><span class="op" id="4955086">.</span><span class="ident" id="4955087">nl</span><span class="op" id="4955089">)</span>&nbsp;<span class="op" id="4955091">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955096">expectNewPart</span>&nbsp;<span class="op" id="4955110">=</span>&nbsp;<span class="builtintype" id="4955112">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955120">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955136">return</span>&nbsp;<span class="ident" id="4955143">nil</span><span class="op" id="4955146">,</span>&nbsp;<span class="ident" id="4955148">fmt</span><span class="op" id="4955151">.</span><span class="ident" id="4955152">Errorf</span><span class="op" id="4955158">(</span><span class="string" id="4955159">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="4955201">,</span>&nbsp;<span class="ident" id="4955203">line</span><span class="op" id="4955207">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955210">}</span><br>
<span class="lineno"></span><span class="op" id="4955212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4955215">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4955282">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="4955321">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="4955365">func</span>&nbsp;<span class="op" id="4955370">(</span><span class="ident" id="4955371">mr</span>&nbsp;<span class="op" id="4955374">*</span><span class="ident" id="4955375">Reader</span><span class="op" id="4955381">)</span>&nbsp;<span class="ident" id="4955383">isFinalBoundary</span><span class="op" id="4955398">(</span><span class="ident" id="4955399">line</span>&nbsp;<span class="op" id="4955404">[</span><span class="op" id="4955405">]</span><span class="builtintype" id="4955406">byte</span><span class="op" id="4955410">)</span>&nbsp;<span class="builtintype" id="4955412">bool</span>&nbsp;<span class="op" id="4955417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955420">if</span>&nbsp;<span class="op" id="4955423">!</span><span class="ident" id="4955424">bytes</span><span class="op" id="4955429">.</span><span class="ident" id="4955430">HasPrefix</span><span class="op" id="4955439">(</span><span class="ident" id="4955440">line</span><span class="op" id="4955444">,</span>&nbsp;<span class="ident" id="4955446">mr</span><span class="op" id="4955448">.</span><span class="ident" id="4955449">dashBoundaryDash</span><span class="op" id="4955465">)</span>&nbsp;<span class="op" id="4955467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955471">return</span>&nbsp;<span class="builtintype" id="4955478">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4955485">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955488">rest</span>&nbsp;<span class="op" id="4955493">:=</span>&nbsp;<span class="ident" id="4955496">line</span><span class="op" id="4955500">[</span><span class="builtinfunc" id="4955501">len</span><span class="op" id="4955504">(</span><span class="ident" id="4955505">mr</span><span class="op" id="4955507">.</span><span class="ident" id="4955508">dashBoundaryDash</span><span class="op" id="4955524">)</span><span class="op" id="4955525">:</span><span class="op" id="4955526">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4955529">rest</span>&nbsp;<span class="op" id="4955534">=</span>&nbsp;<span class="ident" id="4955536">skipLWSPChar</span><span class="op" id="4955548">(</span><span class="ident" id="4955549">rest</span><span class="op" id="4955553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4955556">return</span>&nbsp;<span class="builtinfunc" id="4955563">len</span><span class="op" id="4955566">(</span><span class="ident" id="4955567">rest</span><span class="op" id="4955571">)</span>&nbsp;<span class="op" id="4955573">==</span>&nbsp;<span class="num" id="4955576">0</span>&nbsp;<span class="op" id="4955578">||</span>&nbsp;<span class="ident" id="4955581">bytes</span><span class="op" id="4955586">.</span><span class="ident" id="4955587">Equal</span><span class="op" id="4955592">(</span><span class="ident" id="4955593">rest</span><span class="op" id="4955597">,</span>&nbsp;<span class="ident" id="4955599">mr</span><span class="op" id="4955601">.</span><span class="ident" id="4955602">nl</span><span class="op" id="4955604">)</span><br>
<span class="lineno"></span><span class="op" id="4955606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="4955609">func</span>&nbsp;<span class="op" id="4955614">(</span><span class="ident" id="4955615">mr</span>&nbsp;<span class="op" id="4955618">*</span><span class="ident" id="4955619">Reader</span><span class="op" id="4955625">)</span>&nbsp;<span class="ident" id="4955627">isBoundaryDelimiterLine</span><span class="op" id="4955650">(</span><span class="ident" id="4955651">line</span>&nbsp;<span class="op" id="4955656">[</span><span class="op" id="4955657">]</span><span class="builtintype" id="4955658">byte</span><span class="op" id="4955662">)</span>&nbsp;<span class="op" id="4955664">(</span><span class="ident" id="4955665">ret</span>&nbsp;<span class="builtintype" id="4955669">bool</span><span class="op" id="4955673">)</span>&nbsp;<span class="op" id="4955675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955678">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955729">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955789">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955846">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955905">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4955969">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956011">if</span>&nbsp;<span class="op" id="4956014">!</span><span class="ident" id="4956015">bytes</span><span class="op" id="4956020">.</span><span class="ident" id="4956021">HasPrefix</span><span class="op" id="4956030">(</span><span class="ident" id="4956031">line</span><span class="op" id="4956035">,</span>&nbsp;<span class="ident" id="4956037">mr</span><span class="op" id="4956039">.</span><span class="ident" id="4956040">dashBoundary</span><span class="op" id="4956052">)</span>&nbsp;<span class="op" id="4956054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956058">return</span>&nbsp;<span class="builtintype" id="4956065">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4956072">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956075">rest</span>&nbsp;<span class="op" id="4956080">:=</span>&nbsp;<span class="ident" id="4956083">line</span><span class="op" id="4956087">[</span><span class="builtinfunc" id="4956088">len</span><span class="op" id="4956091">(</span><span class="ident" id="4956092">mr</span><span class="op" id="4956094">.</span><span class="ident" id="4956095">dashBoundary</span><span class="op" id="4956107">)</span><span class="op" id="4956108">:</span><span class="op" id="4956109">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956112">rest</span>&nbsp;<span class="op" id="4956117">=</span>&nbsp;<span class="ident" id="4956119">skipLWSPChar</span><span class="op" id="4956131">(</span><span class="ident" id="4956132">rest</span><span class="op" id="4956136">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4956140">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4956210">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4956281">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956309">if</span>&nbsp;<span class="ident" id="4956312">mr</span><span class="op" id="4956314">.</span><span class="ident" id="4956315">partsRead</span>&nbsp;<span class="op" id="4956325">==</span>&nbsp;<span class="num" id="4956328">0</span>&nbsp;<span class="op" id="4956330">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4956333">len</span><span class="op" id="4956336">(</span><span class="ident" id="4956337">rest</span><span class="op" id="4956341">)</span>&nbsp;<span class="op" id="4956343">==</span>&nbsp;<span class="num" id="4956346">1</span>&nbsp;<span class="op" id="4956348">&amp;&amp;</span>&nbsp;<span class="ident" id="4956351">rest</span><span class="op" id="4956355">[</span><span class="num" id="4956356">0</span><span class="op" id="4956357">]</span>&nbsp;<span class="op" id="4956359">==</span>&nbsp;<span class="string" id="4956362">&#39;\n&#39;</span>&nbsp;<span class="op" id="4956367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956371">mr</span><span class="op" id="4956373">.</span><span class="ident" id="4956374">nl</span>&nbsp;<span class="op" id="4956377">=</span>&nbsp;<span class="ident" id="4956379">mr</span><span class="op" id="4956381">.</span><span class="ident" id="4956382">nl</span><span class="op" id="4956384">[</span><span class="num" id="4956385">1</span><span class="op" id="4956386">:</span><span class="op" id="4956387">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4956391">mr</span><span class="op" id="4956393">.</span><span class="ident" id="4956394">nlDashBoundary</span>&nbsp;<span class="op" id="4956409">=</span>&nbsp;<span class="ident" id="4956411">mr</span><span class="op" id="4956413">.</span><span class="ident" id="4956414">nlDashBoundary</span><span class="op" id="4956428">[</span><span class="num" id="4956429">1</span><span class="op" id="4956430">:</span><span class="op" id="4956431">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4956434">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4956437">return</span>&nbsp;<span class="ident" id="4956444">bytes</span><span class="op" id="4956449">.</span><span class="ident" id="4956450">Equal</span><span class="op" id="4956455">(</span><span class="ident" id="4956456">rest</span><span class="op" id="4956460">,</span>&nbsp;<span class="ident" id="4956462">mr</span><span class="op" id="4956464">.</span><span class="ident" id="4956465">nl</span><span class="op" id="4956467">)</span><br>
<span class="lineno"></span><span class="op" id="4956469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4956472">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="4956537">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="4956604">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="4956675">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4956740">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="4956752">//</span><br>
<span class="lineno"></span><span class="comment" id="4956755">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="4956825">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="4956893">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4956961">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4957005">func</span>&nbsp;<span class="op" id="4957010">(</span><span class="ident" id="4957011">mr</span>&nbsp;<span class="op" id="4957014">*</span><span class="ident" id="4957015">Reader</span><span class="op" id="4957021">)</span>&nbsp;<span class="ident" id="4957023">peekBufferIsEmptyPart</span><span class="op" id="4957044">(</span><span class="ident" id="4957045">peek</span>&nbsp;<span class="op" id="4957050">[</span><span class="op" id="4957051">]</span><span class="builtintype" id="4957052">byte</span><span class="op" id="4957056">)</span>&nbsp;<span class="builtintype" id="4957058">bool</span>&nbsp;<span class="op" id="4957063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4957066">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4957089">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957151">if</span>&nbsp;<span class="ident" id="4957154">bytes</span><span class="op" id="4957159">.</span><span class="ident" id="4957160">HasPrefix</span><span class="op" id="4957169">(</span><span class="ident" id="4957170">peek</span><span class="op" id="4957174">,</span>&nbsp;<span class="ident" id="4957176">mr</span><span class="op" id="4957178">.</span><span class="ident" id="4957179">dashBoundaryDash</span><span class="op" id="4957195">)</span>&nbsp;<span class="op" id="4957197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957201">rest</span>&nbsp;<span class="op" id="4957206">:=</span>&nbsp;<span class="ident" id="4957209">peek</span><span class="op" id="4957213">[</span><span class="builtinfunc" id="4957214">len</span><span class="op" id="4957217">(</span><span class="ident" id="4957218">mr</span><span class="op" id="4957220">.</span><span class="ident" id="4957221">dashBoundaryDash</span><span class="op" id="4957237">)</span><span class="op" id="4957238">:</span><span class="op" id="4957239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957243">rest</span>&nbsp;<span class="op" id="4957248">=</span>&nbsp;<span class="ident" id="4957250">skipLWSPChar</span><span class="op" id="4957262">(</span><span class="ident" id="4957263">rest</span><span class="op" id="4957267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957271">return</span>&nbsp;<span class="ident" id="4957278">bytes</span><span class="op" id="4957283">.</span><span class="ident" id="4957284">HasPrefix</span><span class="op" id="4957293">(</span><span class="ident" id="4957294">rest</span><span class="op" id="4957298">,</span>&nbsp;<span class="ident" id="4957300">mr</span><span class="op" id="4957302">.</span><span class="ident" id="4957303">nl</span><span class="op" id="4957305">)</span>&nbsp;<span class="op" id="4957307">||</span>&nbsp;<span class="builtinfunc" id="4957310">len</span><span class="op" id="4957313">(</span><span class="ident" id="4957314">rest</span><span class="op" id="4957318">)</span>&nbsp;<span class="op" id="4957320">==</span>&nbsp;<span class="num" id="4957323">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957329">if</span>&nbsp;<span class="op" id="4957332">!</span><span class="ident" id="4957333">bytes</span><span class="op" id="4957338">.</span><span class="ident" id="4957339">HasPrefix</span><span class="op" id="4957348">(</span><span class="ident" id="4957349">peek</span><span class="op" id="4957353">,</span>&nbsp;<span class="ident" id="4957355">mr</span><span class="op" id="4957357">.</span><span class="ident" id="4957358">dashBoundary</span><span class="op" id="4957370">)</span>&nbsp;<span class="op" id="4957372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957376">return</span>&nbsp;<span class="builtintype" id="4957383">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4957393">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957438">rest</span>&nbsp;<span class="op" id="4957443">:=</span>&nbsp;<span class="ident" id="4957446">peek</span><span class="op" id="4957450">[</span><span class="builtinfunc" id="4957451">len</span><span class="op" id="4957454">(</span><span class="ident" id="4957455">mr</span><span class="op" id="4957457">.</span><span class="ident" id="4957458">dashBoundary</span><span class="op" id="4957470">)</span><span class="op" id="4957471">:</span><span class="op" id="4957472">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957475">rest</span>&nbsp;<span class="op" id="4957480">=</span>&nbsp;<span class="ident" id="4957482">skipLWSPChar</span><span class="op" id="4957494">(</span><span class="ident" id="4957495">rest</span><span class="op" id="4957499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957502">return</span>&nbsp;<span class="ident" id="4957509">bytes</span><span class="op" id="4957514">.</span><span class="ident" id="4957515">HasPrefix</span><span class="op" id="4957524">(</span><span class="ident" id="4957525">rest</span><span class="op" id="4957529">,</span>&nbsp;<span class="ident" id="4957531">mr</span><span class="op" id="4957533">.</span><span class="ident" id="4957534">nl</span><span class="op" id="4957536">)</span><br>
<span class="lineno"></span><span class="op" id="4957538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="4957541">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="4957605">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="4957625">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="4957656">func</span>&nbsp;<span class="ident" id="4957661">skipLWSPChar</span><span class="op" id="4957673">(</span><span class="ident" id="4957674">b</span>&nbsp;<span class="op" id="4957676">[</span><span class="op" id="4957677">]</span><span class="builtintype" id="4957678">byte</span><span class="op" id="4957682">)</span>&nbsp;<span class="op" id="4957684">[</span><span class="op" id="4957685">]</span><span class="builtintype" id="4957686">byte</span>&nbsp;<span class="op" id="4957691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957694">for</span>&nbsp;<span class="builtinfunc" id="4957698">len</span><span class="op" id="4957701">(</span><span class="ident" id="4957702">b</span><span class="op" id="4957703">)</span>&nbsp;<span class="op" id="4957705">&gt;</span>&nbsp;<span class="num" id="4957707">0</span>&nbsp;<span class="op" id="4957709">&amp;&amp;</span>&nbsp;<span class="op" id="4957712">(</span><span class="ident" id="4957713">b</span><span class="op" id="4957714">[</span><span class="num" id="4957715">0</span><span class="op" id="4957716">]</span>&nbsp;<span class="op" id="4957718">==</span>&nbsp;<span class="string" id="4957721">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4957725">||</span>&nbsp;<span class="ident" id="4957728">b</span><span class="op" id="4957729">[</span><span class="num" id="4957730">0</span><span class="op" id="4957731">]</span>&nbsp;<span class="op" id="4957733">==</span>&nbsp;<span class="string" id="4957736">&#39;\t&#39;</span><span class="op" id="4957740">)</span>&nbsp;<span class="op" id="4957742">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4957746">b</span>&nbsp;<span class="op" id="4957748">=</span>&nbsp;<span class="ident" id="4957750">b</span><span class="op" id="4957751">[</span><span class="num" id="4957752">1</span><span class="op" id="4957753">:</span><span class="op" id="4957754">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4957757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4957760">return</span>&nbsp;<span class="ident" id="4957767">b</span><br>
<span class="lineno"></span><span class="op" id="4957769">}</span>
</div>
</body>
</html>
