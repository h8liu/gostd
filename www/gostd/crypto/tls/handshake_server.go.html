<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4229178">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4229233">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4229287">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4229338">package</span>&nbsp;<span class="ident" id="4229346">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4229351">import</span>&nbsp;<span class="op" id="4229358">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229361">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229371">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229387">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229401">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229418">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229433">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229450">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229460">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4229467">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4229472">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4229475">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4229551">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4229603">type</span>&nbsp;<span class="ident" id="4229608">serverHandshakeState</span>&nbsp;<span class="keyword" id="4229629">struct</span>&nbsp;<span class="op" id="4229636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229639">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229655">*</span><span class="ident" id="4229656">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229662">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229678">*</span><span class="ident" id="4229679">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229695">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229711">*</span><span class="ident" id="4229712">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229728">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229744">*</span><span class="ident" id="4229745">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229758">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4229774">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229780">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4229796">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229802">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229818">*</span><span class="ident" id="4229819">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229833">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4229849">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229863">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229879">[</span><span class="op" id="4229880">]</span><span class="builtintype" id="4229881">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229887">certsFromClient</span>&nbsp;<span class="op" id="4229903">[</span><span class="op" id="4229904">]</span><span class="op" id="4229905">[</span><span class="op" id="4229906">]</span><span class="builtintype" id="4229907">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4229913">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4229929">*</span><span class="ident" id="4229930">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4229942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4229945">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4230002">func</span>&nbsp;<span class="op" id="4230007">(</span><span class="ident" id="4230008">c</span>&nbsp;<span class="op" id="4230010">*</span><span class="ident" id="4230011">Conn</span><span class="op" id="4230015">)</span>&nbsp;<span class="ident" id="4230017">serverHandshake</span><span class="op" id="4230032">(</span><span class="op" id="4230033">)</span>&nbsp;<span class="builtintype" id="4230035">error</span>&nbsp;<span class="op" id="4230041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4230044">config</span>&nbsp;<span class="op" id="4230051">:=</span>&nbsp;<span class="ident" id="4230054">c</span><span class="op" id="4230055">.</span><span class="ident" id="4230056">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4230065">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4230136">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4230166">config</span><span class="op" id="4230172">.</span><span class="ident" id="4230173">serverInitOnce</span><span class="op" id="4230187">.</span><span class="ident" id="4230188">Do</span><span class="op" id="4230190">(</span><span class="ident" id="4230191">config</span><span class="op" id="4230197">.</span><span class="ident" id="4230198">serverInit</span><span class="op" id="4230208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4230212">hs</span>&nbsp;<span class="op" id="4230215">:=</span>&nbsp;<span class="ident" id="4230218">serverHandshakeState</span><span class="op" id="4230238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4230242">c</span><span class="op" id="4230243">:</span>&nbsp;<span class="ident" id="4230245">c</span><span class="op" id="4230246">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4230252">isResume</span><span class="op" id="4230260">,</span>&nbsp;<span class="ident" id="4230262">err</span>&nbsp;<span class="op" id="4230266">:=</span>&nbsp;<span class="ident" id="4230269">hs</span><span class="op" id="4230271">.</span><span class="ident" id="4230272">readClientHello</span><span class="op" id="4230287">(</span><span class="op" id="4230288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230291">if</span>&nbsp;<span class="ident" id="4230294">err</span>&nbsp;<span class="op" id="4230298">!=</span>&nbsp;<span class="ident" id="4230301">nil</span>&nbsp;<span class="op" id="4230305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230309">return</span>&nbsp;<span class="ident" id="4230316">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230321">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4230325">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230417">if</span>&nbsp;<span class="ident" id="4230420">isResume</span>&nbsp;<span class="op" id="4230429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4230433">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230518">if</span>&nbsp;<span class="ident" id="4230521">err</span>&nbsp;<span class="op" id="4230525">:=</span>&nbsp;<span class="ident" id="4230528">hs</span><span class="op" id="4230530">.</span><span class="ident" id="4230531">doResumeHandshake</span><span class="op" id="4230548">(</span><span class="op" id="4230549">)</span><span class="op" id="4230550">;</span>&nbsp;<span class="ident" id="4230552">err</span>&nbsp;<span class="op" id="4230556">!=</span>&nbsp;<span class="ident" id="4230559">nil</span>&nbsp;<span class="op" id="4230563">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230568">return</span>&nbsp;<span class="ident" id="4230575">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230585">if</span>&nbsp;<span class="ident" id="4230588">err</span>&nbsp;<span class="op" id="4230592">:=</span>&nbsp;<span class="ident" id="4230595">hs</span><span class="op" id="4230597">.</span><span class="ident" id="4230598">establishKeys</span><span class="op" id="4230611">(</span><span class="op" id="4230612">)</span><span class="op" id="4230613">;</span>&nbsp;<span class="ident" id="4230615">err</span>&nbsp;<span class="op" id="4230619">!=</span>&nbsp;<span class="ident" id="4230622">nil</span>&nbsp;<span class="op" id="4230626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230631">return</span>&nbsp;<span class="ident" id="4230638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230644">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230648">if</span>&nbsp;<span class="ident" id="4230651">err</span>&nbsp;<span class="op" id="4230655">:=</span>&nbsp;<span class="ident" id="4230658">hs</span><span class="op" id="4230660">.</span><span class="ident" id="4230661">sendFinished</span><span class="op" id="4230673">(</span><span class="ident" id="4230674">c</span><span class="op" id="4230675">.</span><span class="ident" id="4230676">firstFinished</span><span class="op" id="4230689">[</span><span class="op" id="4230690">:</span><span class="op" id="4230691">]</span><span class="op" id="4230692">)</span><span class="op" id="4230693">;</span>&nbsp;<span class="ident" id="4230695">err</span>&nbsp;<span class="op" id="4230699">!=</span>&nbsp;<span class="ident" id="4230702">nil</span>&nbsp;<span class="op" id="4230706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230711">return</span>&nbsp;<span class="ident" id="4230718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230728">if</span>&nbsp;<span class="ident" id="4230731">err</span>&nbsp;<span class="op" id="4230735">:=</span>&nbsp;<span class="ident" id="4230738">hs</span><span class="op" id="4230740">.</span><span class="ident" id="4230741">readFinished</span><span class="op" id="4230753">(</span><span class="ident" id="4230754">nil</span><span class="op" id="4230757">)</span><span class="op" id="4230758">;</span>&nbsp;<span class="ident" id="4230760">err</span>&nbsp;<span class="op" id="4230764">!=</span>&nbsp;<span class="ident" id="4230767">nil</span>&nbsp;<span class="op" id="4230771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230776">return</span>&nbsp;<span class="ident" id="4230783">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4230793">c</span><span class="op" id="4230794">.</span><span class="ident" id="4230795">didResume</span>&nbsp;<span class="op" id="4230805">=</span>&nbsp;<span class="builtintype" id="4230807">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230813">}</span>&nbsp;<span class="keyword" id="4230815">else</span>&nbsp;<span class="op" id="4230820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4230824">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4230886">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230924">if</span>&nbsp;<span class="ident" id="4230927">err</span>&nbsp;<span class="op" id="4230931">:=</span>&nbsp;<span class="ident" id="4230934">hs</span><span class="op" id="4230936">.</span><span class="ident" id="4230937">doFullHandshake</span><span class="op" id="4230952">(</span><span class="op" id="4230953">)</span><span class="op" id="4230954">;</span>&nbsp;<span class="ident" id="4230956">err</span>&nbsp;<span class="op" id="4230960">!=</span>&nbsp;<span class="ident" id="4230963">nil</span>&nbsp;<span class="op" id="4230967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230972">return</span>&nbsp;<span class="ident" id="4230979">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4230985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4230989">if</span>&nbsp;<span class="ident" id="4230992">err</span>&nbsp;<span class="op" id="4230996">:=</span>&nbsp;<span class="ident" id="4230999">hs</span><span class="op" id="4231001">.</span><span class="ident" id="4231002">establishKeys</span><span class="op" id="4231015">(</span><span class="op" id="4231016">)</span><span class="op" id="4231017">;</span>&nbsp;<span class="ident" id="4231019">err</span>&nbsp;<span class="op" id="4231023">!=</span>&nbsp;<span class="ident" id="4231026">nil</span>&nbsp;<span class="op" id="4231030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231035">return</span>&nbsp;<span class="ident" id="4231042">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231052">if</span>&nbsp;<span class="ident" id="4231055">err</span>&nbsp;<span class="op" id="4231059">:=</span>&nbsp;<span class="ident" id="4231062">hs</span><span class="op" id="4231064">.</span><span class="ident" id="4231065">readFinished</span><span class="op" id="4231077">(</span><span class="ident" id="4231078">c</span><span class="op" id="4231079">.</span><span class="ident" id="4231080">firstFinished</span><span class="op" id="4231093">[</span><span class="op" id="4231094">:</span><span class="op" id="4231095">]</span><span class="op" id="4231096">)</span><span class="op" id="4231097">;</span>&nbsp;<span class="ident" id="4231099">err</span>&nbsp;<span class="op" id="4231103">!=</span>&nbsp;<span class="ident" id="4231106">nil</span>&nbsp;<span class="op" id="4231110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231115">return</span>&nbsp;<span class="ident" id="4231122">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231132">if</span>&nbsp;<span class="ident" id="4231135">err</span>&nbsp;<span class="op" id="4231139">:=</span>&nbsp;<span class="ident" id="4231142">hs</span><span class="op" id="4231144">.</span><span class="ident" id="4231145">sendSessionTicket</span><span class="op" id="4231162">(</span><span class="op" id="4231163">)</span><span class="op" id="4231164">;</span>&nbsp;<span class="ident" id="4231166">err</span>&nbsp;<span class="op" id="4231170">!=</span>&nbsp;<span class="ident" id="4231173">nil</span>&nbsp;<span class="op" id="4231177">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231182">return</span>&nbsp;<span class="ident" id="4231189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231199">if</span>&nbsp;<span class="ident" id="4231202">err</span>&nbsp;<span class="op" id="4231206">:=</span>&nbsp;<span class="ident" id="4231209">hs</span><span class="op" id="4231211">.</span><span class="ident" id="4231212">sendFinished</span><span class="op" id="4231224">(</span><span class="ident" id="4231225">nil</span><span class="op" id="4231228">)</span><span class="op" id="4231229">;</span>&nbsp;<span class="ident" id="4231231">err</span>&nbsp;<span class="op" id="4231235">!=</span>&nbsp;<span class="ident" id="4231238">nil</span>&nbsp;<span class="op" id="4231242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231247">return</span>&nbsp;<span class="ident" id="4231254">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231260">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231266">c</span><span class="op" id="4231267">.</span><span class="ident" id="4231268">handshakeComplete</span>&nbsp;<span class="op" id="4231286">=</span>&nbsp;<span class="builtintype" id="4231288">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231295">return</span>&nbsp;<span class="ident" id="4231302">nil</span><br>
<span class="lineno"></span><span class="op" id="4231306">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4231309">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4231384">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4231431">func</span>&nbsp;<span class="op" id="4231436">(</span><span class="ident" id="4231437">hs</span>&nbsp;<span class="op" id="4231440">*</span><span class="ident" id="4231441">serverHandshakeState</span><span class="op" id="4231461">)</span>&nbsp;<span class="ident" id="4231463">readClientHello</span><span class="op" id="4231478">(</span><span class="op" id="4231479">)</span>&nbsp;<span class="op" id="4231481">(</span><span class="ident" id="4231482">isResume</span>&nbsp;<span class="builtintype" id="4231491">bool</span><span class="op" id="4231495">,</span>&nbsp;<span class="ident" id="4231497">err</span>&nbsp;<span class="builtintype" id="4231501">error</span><span class="op" id="4231506">)</span>&nbsp;<span class="op" id="4231508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231511">config</span>&nbsp;<span class="op" id="4231518">:=</span>&nbsp;<span class="ident" id="4231521">hs</span><span class="op" id="4231523">.</span><span class="ident" id="4231524">c</span><span class="op" id="4231525">.</span><span class="ident" id="4231526">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231534">c</span>&nbsp;<span class="op" id="4231536">:=</span>&nbsp;<span class="ident" id="4231539">hs</span><span class="op" id="4231541">.</span><span class="ident" id="4231542">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231546">msg</span><span class="op" id="4231549">,</span>&nbsp;<span class="ident" id="4231551">err</span>&nbsp;<span class="op" id="4231555">:=</span>&nbsp;<span class="ident" id="4231558">c</span><span class="op" id="4231559">.</span><span class="ident" id="4231560">readHandshake</span><span class="op" id="4231573">(</span><span class="op" id="4231574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231577">if</span>&nbsp;<span class="ident" id="4231580">err</span>&nbsp;<span class="op" id="4231584">!=</span>&nbsp;<span class="ident" id="4231587">nil</span>&nbsp;<span class="op" id="4231591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231595">return</span>&nbsp;<span class="builtintype" id="4231602">false</span><span class="op" id="4231607">,</span>&nbsp;<span class="ident" id="4231609">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231617">var</span>&nbsp;<span class="ident" id="4231621">ok</span>&nbsp;<span class="builtintype" id="4231624">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231630">hs</span><span class="op" id="4231632">.</span><span class="ident" id="4231633">clientHello</span><span class="op" id="4231644">,</span>&nbsp;<span class="ident" id="4231646">ok</span>&nbsp;<span class="op" id="4231649">=</span>&nbsp;<span class="ident" id="4231651">msg</span><span class="op" id="4231654">.</span><span class="op" id="4231655">(</span><span class="op" id="4231656">*</span><span class="ident" id="4231657">clientHelloMsg</span><span class="op" id="4231671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231674">if</span>&nbsp;<span class="op" id="4231677">!</span><span class="ident" id="4231678">ok</span>&nbsp;<span class="op" id="4231681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231685">c</span><span class="op" id="4231686">.</span><span class="ident" id="4231687">sendAlert</span><span class="op" id="4231696">(</span><span class="ident" id="4231697">alertUnexpectedMessage</span><span class="op" id="4231719">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231723">return</span>&nbsp;<span class="builtintype" id="4231730">false</span><span class="op" id="4231735">,</span>&nbsp;<span class="ident" id="4231737">unexpectedMessageError</span><span class="op" id="4231759">(</span><span class="ident" id="4231760">hs</span><span class="op" id="4231762">.</span><span class="ident" id="4231763">clientHello</span><span class="op" id="4231774">,</span>&nbsp;<span class="ident" id="4231776">msg</span><span class="op" id="4231779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4231782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231785">c</span><span class="op" id="4231786">.</span><span class="ident" id="4231787">vers</span><span class="op" id="4231791">,</span>&nbsp;<span class="ident" id="4231793">ok</span>&nbsp;<span class="op" id="4231796">=</span>&nbsp;<span class="ident" id="4231798">config</span><span class="op" id="4231804">.</span><span class="ident" id="4231805">mutualVersion</span><span class="op" id="4231818">(</span><span class="ident" id="4231819">hs</span><span class="op" id="4231821">.</span><span class="ident" id="4231822">clientHello</span><span class="op" id="4231833">.</span><span class="ident" id="4231834">vers</span><span class="op" id="4231838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231841">if</span>&nbsp;<span class="op" id="4231844">!</span><span class="ident" id="4231845">ok</span>&nbsp;<span class="op" id="4231848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4231852">c</span><span class="op" id="4231853">.</span><span class="ident" id="4231854">sendAlert</span><span class="op" id="4231863">(</span><span class="ident" id="4231864">alertProtocolVersion</span><span class="op" id="4231884">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4231888">return</span>&nbsp;<span class="builtintype" id="4231895">false</span><span class="op" id="4231900">,</span>&nbsp;<span class="ident" id="4231902">fmt</span><span class="op" id="4231905">.</span><span class="ident" id="4231906">Errorf</span><span class="op" id="4231912">(</span><span class="string" id="4231913">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4231981">,</span>&nbsp;<span class="ident" id="4231983">hs</span><span class="op" id="4231985">.</span><span class="ident" id="4231986">clientHello</span><span class="op" id="4231997">.</span><span class="ident" id="4231998">vers</span><span class="op" id="4232002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232008">c</span><span class="op" id="4232009">.</span><span class="ident" id="4232010">haveVers</span>&nbsp;<span class="op" id="4232019">=</span>&nbsp;<span class="builtintype" id="4232021">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232028">hs</span><span class="op" id="4232030">.</span><span class="ident" id="4232031">finishedHash</span>&nbsp;<span class="op" id="4232044">=</span>&nbsp;<span class="ident" id="4232046">newFinishedHash</span><span class="op" id="4232061">(</span><span class="ident" id="4232062">c</span><span class="op" id="4232063">.</span><span class="ident" id="4232064">vers</span><span class="op" id="4232068">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232071">hs</span><span class="op" id="4232073">.</span><span class="ident" id="4232074">finishedHash</span><span class="op" id="4232086">.</span><span class="ident" id="4232087">Write</span><span class="op" id="4232092">(</span><span class="ident" id="4232093">hs</span><span class="op" id="4232095">.</span><span class="ident" id="4232096">clientHello</span><span class="op" id="4232107">.</span><span class="ident" id="4232108">marshal</span><span class="op" id="4232115">(</span><span class="op" id="4232116">)</span><span class="op" id="4232117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232121">hs</span><span class="op" id="4232123">.</span><span class="ident" id="4232124">hello</span>&nbsp;<span class="op" id="4232130">=</span>&nbsp;<span class="builtinfunc" id="4232132">new</span><span class="op" id="4232135">(</span><span class="ident" id="4232136">serverHelloMsg</span><span class="op" id="4232150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232154">supportedCurve</span>&nbsp;<span class="op" id="4232169">:=</span>&nbsp;<span class="builtintype" id="4232172">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232179">preferredCurves</span>&nbsp;<span class="op" id="4232195">:=</span>&nbsp;<span class="ident" id="4232198">config</span><span class="op" id="4232204">.</span><span class="ident" id="4232205">curvePreferences</span><span class="op" id="4232221">(</span><span class="op" id="4232222">)</span><br>
<span class="lineno"></span><span class="ident" id="4232224">Curves</span><span class="op" id="4232230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232233">for</span>&nbsp;<span class="ident" id="4232237">_</span><span class="op" id="4232238">,</span>&nbsp;<span class="ident" id="4232240">curve</span>&nbsp;<span class="op" id="4232246">:=</span>&nbsp;<span class="keyword" id="4232249">range</span>&nbsp;<span class="ident" id="4232255">hs</span><span class="op" id="4232257">.</span><span class="ident" id="4232258">clientHello</span><span class="op" id="4232269">.</span><span class="ident" id="4232270">supportedCurves</span>&nbsp;<span class="op" id="4232286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232290">for</span>&nbsp;<span class="ident" id="4232294">_</span><span class="op" id="4232295">,</span>&nbsp;<span class="ident" id="4232297">supported</span>&nbsp;<span class="op" id="4232307">:=</span>&nbsp;<span class="keyword" id="4232310">range</span>&nbsp;<span class="ident" id="4232316">preferredCurves</span>&nbsp;<span class="op" id="4232332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232337">if</span>&nbsp;<span class="ident" id="4232340">supported</span>&nbsp;<span class="op" id="4232350">==</span>&nbsp;<span class="ident" id="4232353">curve</span>&nbsp;<span class="op" id="4232359">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232365">supportedCurve</span>&nbsp;<span class="op" id="4232380">=</span>&nbsp;<span class="builtintype" id="4232382">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232391">break</span>&nbsp;<span class="ident" id="4232397">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232414">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232418">supportedPointFormat</span>&nbsp;<span class="op" id="4232439">:=</span>&nbsp;<span class="builtintype" id="4232442">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232449">for</span>&nbsp;<span class="ident" id="4232453">_</span><span class="op" id="4232454">,</span>&nbsp;<span class="ident" id="4232456">pointFormat</span>&nbsp;<span class="op" id="4232468">:=</span>&nbsp;<span class="keyword" id="4232471">range</span>&nbsp;<span class="ident" id="4232477">hs</span><span class="op" id="4232479">.</span><span class="ident" id="4232480">clientHello</span><span class="op" id="4232491">.</span><span class="ident" id="4232492">supportedPoints</span>&nbsp;<span class="op" id="4232508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232512">if</span>&nbsp;<span class="ident" id="4232515">pointFormat</span>&nbsp;<span class="op" id="4232527">==</span>&nbsp;<span class="ident" id="4232530">pointFormatUncompressed</span>&nbsp;<span class="op" id="4232554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232559">supportedPointFormat</span>&nbsp;<span class="op" id="4232580">=</span>&nbsp;<span class="builtintype" id="4232582">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232590">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232604">hs</span><span class="op" id="4232606">.</span><span class="ident" id="4232607">ellipticOk</span>&nbsp;<span class="op" id="4232618">=</span>&nbsp;<span class="ident" id="4232620">supportedCurve</span>&nbsp;<span class="op" id="4232635">&amp;&amp;</span>&nbsp;<span class="ident" id="4232638">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232661">foundCompression</span>&nbsp;<span class="op" id="4232678">:=</span>&nbsp;<span class="builtintype" id="4232681">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4232688">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232763">for</span>&nbsp;<span class="ident" id="4232767">_</span><span class="op" id="4232768">,</span>&nbsp;<span class="ident" id="4232770">compression</span>&nbsp;<span class="op" id="4232782">:=</span>&nbsp;<span class="keyword" id="4232785">range</span>&nbsp;<span class="ident" id="4232791">hs</span><span class="op" id="4232793">.</span><span class="ident" id="4232794">clientHello</span><span class="op" id="4232805">.</span><span class="ident" id="4232806">compressionMethods</span>&nbsp;<span class="op" id="4232825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232829">if</span>&nbsp;<span class="ident" id="4232832">compression</span>&nbsp;<span class="op" id="4232844">==</span>&nbsp;<span class="ident" id="4232847">compressionNone</span>&nbsp;<span class="op" id="4232863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232868">foundCompression</span>&nbsp;<span class="op" id="4232885">=</span>&nbsp;<span class="builtintype" id="4232887">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232895">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232910">if</span>&nbsp;<span class="op" id="4232913">!</span><span class="ident" id="4232914">foundCompression</span>&nbsp;<span class="op" id="4232931">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232935">c</span><span class="op" id="4232936">.</span><span class="ident" id="4232937">sendAlert</span><span class="op" id="4232946">(</span><span class="ident" id="4232947">alertHandshakeFailure</span><span class="op" id="4232968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232972">return</span>&nbsp;<span class="builtintype" id="4232979">false</span><span class="op" id="4232984">,</span>&nbsp;<span class="ident" id="4232986">errors</span><span class="op" id="4232992">.</span><span class="ident" id="4232993">New</span><span class="op" id="4232996">(</span><span class="string" id="4232997">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4233052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233059">hs</span><span class="op" id="4233061">.</span><span class="ident" id="4233062">hello</span><span class="op" id="4233067">.</span><span class="ident" id="4233068">vers</span>&nbsp;<span class="op" id="4233073">=</span>&nbsp;<span class="ident" id="4233075">c</span><span class="op" id="4233076">.</span><span class="ident" id="4233077">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233083">hs</span><span class="op" id="4233085">.</span><span class="ident" id="4233086">hello</span><span class="op" id="4233091">.</span><span class="ident" id="4233092">random</span>&nbsp;<span class="op" id="4233099">=</span>&nbsp;<span class="builtinfunc" id="4233101">make</span><span class="op" id="4233105">(</span><span class="op" id="4233106">[</span><span class="op" id="4233107">]</span><span class="builtintype" id="4233108">byte</span><span class="op" id="4233112">,</span>&nbsp;<span class="num" id="4233114">32</span><span class="op" id="4233116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233119">_</span><span class="op" id="4233120">,</span>&nbsp;<span class="ident" id="4233122">err</span>&nbsp;<span class="op" id="4233126">=</span>&nbsp;<span class="ident" id="4233128">io</span><span class="op" id="4233130">.</span><span class="ident" id="4233131">ReadFull</span><span class="op" id="4233139">(</span><span class="ident" id="4233140">config</span><span class="op" id="4233146">.</span><span class="ident" id="4233147">rand</span><span class="op" id="4233151">(</span><span class="op" id="4233152">)</span><span class="op" id="4233153">,</span>&nbsp;<span class="ident" id="4233155">hs</span><span class="op" id="4233157">.</span><span class="ident" id="4233158">hello</span><span class="op" id="4233163">.</span><span class="ident" id="4233164">random</span><span class="op" id="4233170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233173">if</span>&nbsp;<span class="ident" id="4233176">err</span>&nbsp;<span class="op" id="4233180">!=</span>&nbsp;<span class="ident" id="4233183">nil</span>&nbsp;<span class="op" id="4233187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233191">c</span><span class="op" id="4233192">.</span><span class="ident" id="4233193">sendAlert</span><span class="op" id="4233202">(</span><span class="ident" id="4233203">alertInternalError</span><span class="op" id="4233221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233225">return</span>&nbsp;<span class="builtintype" id="4233232">false</span><span class="op" id="4233237">,</span>&nbsp;<span class="ident" id="4233239">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233247">hs</span><span class="op" id="4233249">.</span><span class="ident" id="4233250">hello</span><span class="op" id="4233255">.</span><span class="ident" id="4233256">secureRenegotiation</span>&nbsp;<span class="op" id="4233276">=</span>&nbsp;<span class="ident" id="4233278">hs</span><span class="op" id="4233280">.</span><span class="ident" id="4233281">clientHello</span><span class="op" id="4233292">.</span><span class="ident" id="4233293">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233314">hs</span><span class="op" id="4233316">.</span><span class="ident" id="4233317">hello</span><span class="op" id="4233322">.</span><span class="ident" id="4233323">compressionMethod</span>&nbsp;<span class="op" id="4233341">=</span>&nbsp;<span class="ident" id="4233343">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233360">if</span>&nbsp;<span class="builtinfunc" id="4233363">len</span><span class="op" id="4233366">(</span><span class="ident" id="4233367">hs</span><span class="op" id="4233369">.</span><span class="ident" id="4233370">clientHello</span><span class="op" id="4233381">.</span><span class="ident" id="4233382">serverName</span><span class="op" id="4233392">)</span>&nbsp;<span class="op" id="4233394">&gt;</span>&nbsp;<span class="num" id="4233396">0</span>&nbsp;<span class="op" id="4233398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233402">c</span><span class="op" id="4233403">.</span><span class="ident" id="4233404">serverName</span>&nbsp;<span class="op" id="4233415">=</span>&nbsp;<span class="ident" id="4233417">hs</span><span class="op" id="4233419">.</span><span class="ident" id="4233420">clientHello</span><span class="op" id="4233431">.</span><span class="ident" id="4233432">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233448">if</span>&nbsp;<span class="builtinfunc" id="4233451">len</span><span class="op" id="4233454">(</span><span class="ident" id="4233455">hs</span><span class="op" id="4233457">.</span><span class="ident" id="4233458">clientHello</span><span class="op" id="4233469">.</span><span class="ident" id="4233470">alpnProtocols</span><span class="op" id="4233483">)</span>&nbsp;<span class="op" id="4233485">&gt;</span>&nbsp;<span class="num" id="4233487">0</span>&nbsp;<span class="op" id="4233489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233493">if</span>&nbsp;<span class="ident" id="4233496">selectedProto</span><span class="op" id="4233509">,</span>&nbsp;<span class="ident" id="4233511">fallback</span>&nbsp;<span class="op" id="4233520">:=</span>&nbsp;<span class="ident" id="4233523">mutualProtocol</span><span class="op" id="4233537">(</span><span class="ident" id="4233538">hs</span><span class="op" id="4233540">.</span><span class="ident" id="4233541">clientHello</span><span class="op" id="4233552">.</span><span class="ident" id="4233553">alpnProtocols</span><span class="op" id="4233566">,</span>&nbsp;<span class="ident" id="4233568">c</span><span class="op" id="4233569">.</span><span class="ident" id="4233570">config</span><span class="op" id="4233576">.</span><span class="ident" id="4233577">NextProtos</span><span class="op" id="4233587">)</span><span class="op" id="4233588">;</span>&nbsp;<span class="op" id="4233590">!</span><span class="ident" id="4233591">fallback</span>&nbsp;<span class="op" id="4233600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233605">hs</span><span class="op" id="4233607">.</span><span class="ident" id="4233608">hello</span><span class="op" id="4233613">.</span><span class="ident" id="4233614">alpnProtocol</span>&nbsp;<span class="op" id="4233627">=</span>&nbsp;<span class="ident" id="4233629">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233646">c</span><span class="op" id="4233647">.</span><span class="ident" id="4233648">clientProtocol</span>&nbsp;<span class="op" id="4233663">=</span>&nbsp;<span class="ident" id="4233665">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233684">}</span>&nbsp;<span class="keyword" id="4233686">else</span>&nbsp;<span class="op" id="4233691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233695">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233767">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233826">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233863">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233920">if</span>&nbsp;<span class="ident" id="4233923">hs</span><span class="op" id="4233925">.</span><span class="ident" id="4233926">clientHello</span><span class="op" id="4233937">.</span><span class="ident" id="4233938">nextProtoNeg</span>&nbsp;<span class="op" id="4233951">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4233954">len</span><span class="op" id="4233957">(</span><span class="ident" id="4233958">config</span><span class="op" id="4233964">.</span><span class="ident" id="4233965">NextProtos</span><span class="op" id="4233975">)</span>&nbsp;<span class="op" id="4233977">&gt;</span>&nbsp;<span class="num" id="4233979">0</span>&nbsp;<span class="op" id="4233981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233986">hs</span><span class="op" id="4233988">.</span><span class="ident" id="4233989">hello</span><span class="op" id="4233994">.</span><span class="ident" id="4233995">nextProtoNeg</span>&nbsp;<span class="op" id="4234008">=</span>&nbsp;<span class="builtintype" id="4234010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234018">hs</span><span class="op" id="4234020">.</span><span class="ident" id="4234021">hello</span><span class="op" id="4234026">.</span><span class="ident" id="4234027">nextProtos</span>&nbsp;<span class="op" id="4234038">=</span>&nbsp;<span class="ident" id="4234040">config</span><span class="op" id="4234046">.</span><span class="ident" id="4234047">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234067">if</span>&nbsp;<span class="builtinfunc" id="4234070">len</span><span class="op" id="4234073">(</span><span class="ident" id="4234074">config</span><span class="op" id="4234080">.</span><span class="ident" id="4234081">Certificates</span><span class="op" id="4234093">)</span>&nbsp;<span class="op" id="4234095">==</span>&nbsp;<span class="num" id="4234098">0</span>&nbsp;<span class="op" id="4234100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234104">c</span><span class="op" id="4234105">.</span><span class="ident" id="4234106">sendAlert</span><span class="op" id="4234115">(</span><span class="ident" id="4234116">alertInternalError</span><span class="op" id="4234134">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234138">return</span>&nbsp;<span class="builtintype" id="4234145">false</span><span class="op" id="4234150">,</span>&nbsp;<span class="ident" id="4234152">errors</span><span class="op" id="4234158">.</span><span class="ident" id="4234159">New</span><span class="op" id="4234162">(</span><span class="string" id="4234163">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4234196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234202">hs</span><span class="op" id="4234204">.</span><span class="ident" id="4234205">cert</span>&nbsp;<span class="op" id="4234210">=</span>&nbsp;<span class="op" id="4234212">&amp;</span><span class="ident" id="4234213">config</span><span class="op" id="4234219">.</span><span class="ident" id="4234220">Certificates</span><span class="op" id="4234232">[</span><span class="num" id="4234233">0</span><span class="op" id="4234234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234237">if</span>&nbsp;<span class="builtinfunc" id="4234240">len</span><span class="op" id="4234243">(</span><span class="ident" id="4234244">hs</span><span class="op" id="4234246">.</span><span class="ident" id="4234247">clientHello</span><span class="op" id="4234258">.</span><span class="ident" id="4234259">serverName</span><span class="op" id="4234269">)</span>&nbsp;<span class="op" id="4234271">&gt;</span>&nbsp;<span class="num" id="4234273">0</span>&nbsp;<span class="op" id="4234275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234279">chi</span>&nbsp;<span class="op" id="4234283">:=</span>&nbsp;<span class="op" id="4234286">&amp;</span><span class="ident" id="4234287">ClientHelloInfo</span><span class="op" id="4234302">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234307">CipherSuites</span><span class="op" id="4234319">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234324">hs</span><span class="op" id="4234326">.</span><span class="ident" id="4234327">clientHello</span><span class="op" id="4234338">.</span><span class="ident" id="4234339">cipherSuites</span><span class="op" id="4234351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234356">ServerName</span><span class="op" id="4234366">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4234373">hs</span><span class="op" id="4234375">.</span><span class="ident" id="4234376">clientHello</span><span class="op" id="4234387">.</span><span class="ident" id="4234388">serverName</span><span class="op" id="4234398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234403">SupportedCurves</span><span class="op" id="4234418">:</span>&nbsp;<span class="ident" id="4234420">hs</span><span class="op" id="4234422">.</span><span class="ident" id="4234423">clientHello</span><span class="op" id="4234434">.</span><span class="ident" id="4234435">supportedCurves</span><span class="op" id="4234450">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234455">SupportedPoints</span><span class="op" id="4234470">:</span>&nbsp;<span class="ident" id="4234472">hs</span><span class="op" id="4234474">.</span><span class="ident" id="4234475">clientHello</span><span class="op" id="4234486">.</span><span class="ident" id="4234487">supportedPoints</span><span class="op" id="4234502">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234506">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234510">if</span>&nbsp;<span class="ident" id="4234513">hs</span><span class="op" id="4234515">.</span><span class="ident" id="4234516">cert</span><span class="op" id="4234520">,</span>&nbsp;<span class="ident" id="4234522">err</span>&nbsp;<span class="op" id="4234526">=</span>&nbsp;<span class="ident" id="4234528">config</span><span class="op" id="4234534">.</span><span class="ident" id="4234535">getCertificate</span><span class="op" id="4234549">(</span><span class="ident" id="4234550">chi</span><span class="op" id="4234553">)</span><span class="op" id="4234554">;</span>&nbsp;<span class="ident" id="4234556">err</span>&nbsp;<span class="op" id="4234560">!=</span>&nbsp;<span class="ident" id="4234563">nil</span>&nbsp;<span class="op" id="4234567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234572">c</span><span class="op" id="4234573">.</span><span class="ident" id="4234574">sendAlert</span><span class="op" id="4234583">(</span><span class="ident" id="4234584">alertInternalError</span><span class="op" id="4234602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234607">return</span>&nbsp;<span class="builtintype" id="4234614">false</span><span class="op" id="4234619">,</span>&nbsp;<span class="ident" id="4234621">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234630">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234634">_</span><span class="op" id="4234635">,</span>&nbsp;<span class="ident" id="4234637">hs</span><span class="op" id="4234639">.</span><span class="ident" id="4234640">ecdsaOk</span>&nbsp;<span class="op" id="4234648">=</span>&nbsp;<span class="ident" id="4234650">hs</span><span class="op" id="4234652">.</span><span class="ident" id="4234653">cert</span><span class="op" id="4234657">.</span><span class="ident" id="4234658">PrivateKey</span><span class="op" id="4234668">.</span><span class="op" id="4234669">(</span><span class="op" id="4234670">*</span><span class="ident" id="4234671">ecdsa</span><span class="op" id="4234676">.</span><span class="ident" id="4234677">PrivateKey</span><span class="op" id="4234687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234691">if</span>&nbsp;<span class="ident" id="4234694">hs</span><span class="op" id="4234696">.</span><span class="ident" id="4234697">checkForResumption</span><span class="op" id="4234715">(</span><span class="op" id="4234716">)</span>&nbsp;<span class="op" id="4234718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234722">return</span>&nbsp;<span class="builtintype" id="4234729">true</span><span class="op" id="4234733">,</span>&nbsp;<span class="ident" id="4234735">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234744">var</span>&nbsp;<span class="ident" id="4234748">preferenceList</span><span class="op" id="4234762">,</span>&nbsp;<span class="ident" id="4234764">supportedList</span>&nbsp;<span class="op" id="4234778">[</span><span class="op" id="4234779">]</span><span class="builtintype" id="4234780">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234788">if</span>&nbsp;<span class="ident" id="4234791">c</span><span class="op" id="4234792">.</span><span class="ident" id="4234793">config</span><span class="op" id="4234799">.</span><span class="ident" id="4234800">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4234825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234829">preferenceList</span>&nbsp;<span class="op" id="4234844">=</span>&nbsp;<span class="ident" id="4234846">c</span><span class="op" id="4234847">.</span><span class="ident" id="4234848">config</span><span class="op" id="4234854">.</span><span class="ident" id="4234855">cipherSuites</span><span class="op" id="4234867">(</span><span class="op" id="4234868">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234872">supportedList</span>&nbsp;<span class="op" id="4234886">=</span>&nbsp;<span class="ident" id="4234888">hs</span><span class="op" id="4234890">.</span><span class="ident" id="4234891">clientHello</span><span class="op" id="4234902">.</span><span class="ident" id="4234903">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234917">}</span>&nbsp;<span class="keyword" id="4234919">else</span>&nbsp;<span class="op" id="4234924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234928">preferenceList</span>&nbsp;<span class="op" id="4234943">=</span>&nbsp;<span class="ident" id="4234945">hs</span><span class="op" id="4234947">.</span><span class="ident" id="4234948">clientHello</span><span class="op" id="4234959">.</span><span class="ident" id="4234960">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234975">supportedList</span>&nbsp;<span class="op" id="4234989">=</span>&nbsp;<span class="ident" id="4234991">c</span><span class="op" id="4234992">.</span><span class="ident" id="4234993">config</span><span class="op" id="4234999">.</span><span class="ident" id="4235000">cipherSuites</span><span class="op" id="4235012">(</span><span class="op" id="4235013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235016">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235020">for</span>&nbsp;<span class="ident" id="4235024">_</span><span class="op" id="4235025">,</span>&nbsp;<span class="ident" id="4235027">id</span>&nbsp;<span class="op" id="4235030">:=</span>&nbsp;<span class="keyword" id="4235033">range</span>&nbsp;<span class="ident" id="4235039">preferenceList</span>&nbsp;<span class="op" id="4235054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235058">if</span>&nbsp;<span class="ident" id="4235061">hs</span><span class="op" id="4235063">.</span><span class="ident" id="4235064">suite</span>&nbsp;<span class="op" id="4235070">=</span>&nbsp;<span class="ident" id="4235072">c</span><span class="op" id="4235073">.</span><span class="ident" id="4235074">tryCipherSuite</span><span class="op" id="4235088">(</span><span class="ident" id="4235089">id</span><span class="op" id="4235091">,</span>&nbsp;<span class="ident" id="4235093">supportedList</span><span class="op" id="4235106">,</span>&nbsp;<span class="ident" id="4235108">c</span><span class="op" id="4235109">.</span><span class="ident" id="4235110">vers</span><span class="op" id="4235114">,</span>&nbsp;<span class="ident" id="4235116">hs</span><span class="op" id="4235118">.</span><span class="ident" id="4235119">ellipticOk</span><span class="op" id="4235129">,</span>&nbsp;<span class="ident" id="4235131">hs</span><span class="op" id="4235133">.</span><span class="ident" id="4235134">ecdsaOk</span><span class="op" id="4235141">)</span><span class="op" id="4235142">;</span>&nbsp;<span class="ident" id="4235144">hs</span><span class="op" id="4235146">.</span><span class="ident" id="4235147">suite</span>&nbsp;<span class="op" id="4235153">!=</span>&nbsp;<span class="ident" id="4235156">nil</span>&nbsp;<span class="op" id="4235160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235165">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235173">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235180">if</span>&nbsp;<span class="ident" id="4235183">hs</span><span class="op" id="4235185">.</span><span class="ident" id="4235186">suite</span>&nbsp;<span class="op" id="4235192">==</span>&nbsp;<span class="ident" id="4235195">nil</span>&nbsp;<span class="op" id="4235199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4235203">c</span><span class="op" id="4235204">.</span><span class="ident" id="4235205">sendAlert</span><span class="op" id="4235214">(</span><span class="ident" id="4235215">alertHandshakeFailure</span><span class="op" id="4235236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235240">return</span>&nbsp;<span class="builtintype" id="4235247">false</span><span class="op" id="4235252">,</span>&nbsp;<span class="ident" id="4235254">errors</span><span class="op" id="4235260">.</span><span class="ident" id="4235261">New</span><span class="op" id="4235264">(</span><span class="string" id="4235265">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4235323">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4235330">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235400">for</span>&nbsp;<span class="ident" id="4235404">_</span><span class="op" id="4235405">,</span>&nbsp;<span class="ident" id="4235407">id</span>&nbsp;<span class="op" id="4235410">:=</span>&nbsp;<span class="keyword" id="4235413">range</span>&nbsp;<span class="ident" id="4235419">hs</span><span class="op" id="4235421">.</span><span class="ident" id="4235422">clientHello</span><span class="op" id="4235433">.</span><span class="ident" id="4235434">cipherSuites</span>&nbsp;<span class="op" id="4235447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235451">if</span>&nbsp;<span class="ident" id="4235454">id</span>&nbsp;<span class="op" id="4235457">==</span>&nbsp;<span class="ident" id="4235460">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="4235478">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4235483">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235532">if</span>&nbsp;<span class="ident" id="4235535">hs</span><span class="op" id="4235537">.</span><span class="ident" id="4235538">clientHello</span><span class="op" id="4235549">.</span><span class="ident" id="4235550">vers</span>&nbsp;<span class="op" id="4235555">&lt;</span>&nbsp;<span class="ident" id="4235557">c</span><span class="op" id="4235558">.</span><span class="ident" id="4235559">config</span><span class="op" id="4235565">.</span><span class="ident" id="4235566">MaxVersion</span>&nbsp;<span class="op" id="4235577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4235583">c</span><span class="op" id="4235584">.</span><span class="ident" id="4235585">sendAlert</span><span class="op" id="4235594">(</span><span class="ident" id="4235595">alertInappropriateFallback</span><span class="op" id="4235621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235627">return</span>&nbsp;<span class="builtintype" id="4235634">false</span><span class="op" id="4235639">,</span>&nbsp;<span class="ident" id="4235641">errors</span><span class="op" id="4235647">.</span><span class="ident" id="4235648">New</span><span class="op" id="4235651">(</span><span class="string" id="4235652">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4235702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235707">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235712">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235727">return</span>&nbsp;<span class="builtintype" id="4235734">false</span><span class="op" id="4235739">,</span>&nbsp;<span class="ident" id="4235741">nil</span><br>
<span class="lineno">240</span><span class="op" id="4235745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4235748">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4235835">func</span>&nbsp;<span class="op" id="4235840">(</span><span class="ident" id="4235841">hs</span>&nbsp;<span class="op" id="4235844">*</span><span class="ident" id="4235845">serverHandshakeState</span><span class="op" id="4235865">)</span>&nbsp;<span class="ident" id="4235867">checkForResumption</span><span class="op" id="4235885">(</span><span class="op" id="4235886">)</span>&nbsp;<span class="builtintype" id="4235888">bool</span>&nbsp;<span class="op" id="4235893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4235896">c</span>&nbsp;<span class="op" id="4235898">:=</span>&nbsp;<span class="ident" id="4235901">hs</span><span class="op" id="4235903">.</span><span class="ident" id="4235904">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235908">if</span>&nbsp;<span class="ident" id="4235911">c</span><span class="op" id="4235912">.</span><span class="ident" id="4235913">config</span><span class="op" id="4235919">.</span><span class="ident" id="4235920">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4235943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235947">return</span>&nbsp;<span class="builtintype" id="4235954">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4235961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235965">var</span>&nbsp;<span class="ident" id="4235969">ok</span>&nbsp;<span class="builtintype" id="4235972">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235978">if</span>&nbsp;<span class="ident" id="4235981">hs</span><span class="op" id="4235983">.</span><span class="ident" id="4235984">sessionState</span><span class="op" id="4235996">,</span>&nbsp;<span class="ident" id="4235998">ok</span>&nbsp;<span class="op" id="4236001">=</span>&nbsp;<span class="ident" id="4236003">c</span><span class="op" id="4236004">.</span><span class="ident" id="4236005">decryptTicket</span><span class="op" id="4236018">(</span><span class="ident" id="4236019">hs</span><span class="op" id="4236021">.</span><span class="ident" id="4236022">clientHello</span><span class="op" id="4236033">.</span><span class="ident" id="4236034">sessionTicket</span><span class="op" id="4236047">)</span><span class="op" id="4236048">;</span>&nbsp;<span class="op" id="4236050">!</span><span class="ident" id="4236051">ok</span>&nbsp;<span class="op" id="4236054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236058">return</span>&nbsp;<span class="builtintype" id="4236065">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236076">if</span>&nbsp;<span class="ident" id="4236079">hs</span><span class="op" id="4236081">.</span><span class="ident" id="4236082">sessionState</span><span class="op" id="4236094">.</span><span class="ident" id="4236095">vers</span>&nbsp;<span class="op" id="4236100">&gt;</span>&nbsp;<span class="ident" id="4236102">hs</span><span class="op" id="4236104">.</span><span class="ident" id="4236105">clientHello</span><span class="op" id="4236116">.</span><span class="ident" id="4236117">vers</span>&nbsp;<span class="op" id="4236122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236126">return</span>&nbsp;<span class="builtintype" id="4236133">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236143">if</span>&nbsp;<span class="ident" id="4236146">vers</span><span class="op" id="4236150">,</span>&nbsp;<span class="ident" id="4236152">ok</span>&nbsp;<span class="op" id="4236155">:=</span>&nbsp;<span class="ident" id="4236158">c</span><span class="op" id="4236159">.</span><span class="ident" id="4236160">config</span><span class="op" id="4236166">.</span><span class="ident" id="4236167">mutualVersion</span><span class="op" id="4236180">(</span><span class="ident" id="4236181">hs</span><span class="op" id="4236183">.</span><span class="ident" id="4236184">sessionState</span><span class="op" id="4236196">.</span><span class="ident" id="4236197">vers</span><span class="op" id="4236201">)</span><span class="op" id="4236202">;</span>&nbsp;<span class="op" id="4236204">!</span><span class="ident" id="4236205">ok</span>&nbsp;<span class="op" id="4236208">||</span>&nbsp;<span class="ident" id="4236211">vers</span>&nbsp;<span class="op" id="4236216">!=</span>&nbsp;<span class="ident" id="4236219">hs</span><span class="op" id="4236221">.</span><span class="ident" id="4236222">sessionState</span><span class="op" id="4236234">.</span><span class="ident" id="4236235">vers</span>&nbsp;<span class="op" id="4236240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236244">return</span>&nbsp;<span class="builtintype" id="4236251">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236262">cipherSuiteOk</span>&nbsp;<span class="op" id="4236276">:=</span>&nbsp;<span class="builtintype" id="4236279">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4236286">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236362">for</span>&nbsp;<span class="ident" id="4236366">_</span><span class="op" id="4236367">,</span>&nbsp;<span class="ident" id="4236369">id</span>&nbsp;<span class="op" id="4236372">:=</span>&nbsp;<span class="keyword" id="4236375">range</span>&nbsp;<span class="ident" id="4236381">hs</span><span class="op" id="4236383">.</span><span class="ident" id="4236384">clientHello</span><span class="op" id="4236395">.</span><span class="ident" id="4236396">cipherSuites</span>&nbsp;<span class="op" id="4236409">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236413">if</span>&nbsp;<span class="ident" id="4236416">id</span>&nbsp;<span class="op" id="4236419">==</span>&nbsp;<span class="ident" id="4236422">hs</span><span class="op" id="4236424">.</span><span class="ident" id="4236425">sessionState</span><span class="op" id="4236437">.</span><span class="ident" id="4236438">cipherSuite</span>&nbsp;<span class="op" id="4236450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236455">cipherSuiteOk</span>&nbsp;<span class="op" id="4236469">=</span>&nbsp;<span class="builtintype" id="4236471">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236479">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236490">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236493">if</span>&nbsp;<span class="op" id="4236496">!</span><span class="ident" id="4236497">cipherSuiteOk</span>&nbsp;<span class="op" id="4236511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236515">return</span>&nbsp;<span class="builtintype" id="4236522">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4236533">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236598">hs</span><span class="op" id="4236600">.</span><span class="ident" id="4236601">suite</span>&nbsp;<span class="op" id="4236607">=</span>&nbsp;<span class="ident" id="4236609">c</span><span class="op" id="4236610">.</span><span class="ident" id="4236611">tryCipherSuite</span><span class="op" id="4236625">(</span><span class="ident" id="4236626">hs</span><span class="op" id="4236628">.</span><span class="ident" id="4236629">sessionState</span><span class="op" id="4236641">.</span><span class="ident" id="4236642">cipherSuite</span><span class="op" id="4236653">,</span>&nbsp;<span class="ident" id="4236655">c</span><span class="op" id="4236656">.</span><span class="ident" id="4236657">config</span><span class="op" id="4236663">.</span><span class="ident" id="4236664">cipherSuites</span><span class="op" id="4236676">(</span><span class="op" id="4236677">)</span><span class="op" id="4236678">,</span>&nbsp;<span class="ident" id="4236680">hs</span><span class="op" id="4236682">.</span><span class="ident" id="4236683">sessionState</span><span class="op" id="4236695">.</span><span class="ident" id="4236696">vers</span><span class="op" id="4236700">,</span>&nbsp;<span class="ident" id="4236702">hs</span><span class="op" id="4236704">.</span><span class="ident" id="4236705">ellipticOk</span><span class="op" id="4236715">,</span>&nbsp;<span class="ident" id="4236717">hs</span><span class="op" id="4236719">.</span><span class="ident" id="4236720">ecdsaOk</span><span class="op" id="4236727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236730">if</span>&nbsp;<span class="ident" id="4236733">hs</span><span class="op" id="4236735">.</span><span class="ident" id="4236736">suite</span>&nbsp;<span class="op" id="4236742">==</span>&nbsp;<span class="ident" id="4236745">nil</span>&nbsp;<span class="op" id="4236749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236753">return</span>&nbsp;<span class="builtintype" id="4236760">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236771">sessionHasClientCerts</span>&nbsp;<span class="op" id="4236793">:=</span>&nbsp;<span class="builtinfunc" id="4236796">len</span><span class="op" id="4236799">(</span><span class="ident" id="4236800">hs</span><span class="op" id="4236802">.</span><span class="ident" id="4236803">sessionState</span><span class="op" id="4236815">.</span><span class="ident" id="4236816">certificates</span><span class="op" id="4236828">)</span>&nbsp;<span class="op" id="4236830">!=</span>&nbsp;<span class="num" id="4236833">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236836">needClientCerts</span>&nbsp;<span class="op" id="4236852">:=</span>&nbsp;<span class="ident" id="4236855">c</span><span class="op" id="4236856">.</span><span class="ident" id="4236857">config</span><span class="op" id="4236863">.</span><span class="ident" id="4236864">ClientAuth</span>&nbsp;<span class="op" id="4236875">==</span>&nbsp;<span class="ident" id="4236878">RequireAnyClientCert</span>&nbsp;<span class="op" id="4236899">||</span>&nbsp;<span class="ident" id="4236902">c</span><span class="op" id="4236903">.</span><span class="ident" id="4236904">config</span><span class="op" id="4236910">.</span><span class="ident" id="4236911">ClientAuth</span>&nbsp;<span class="op" id="4236922">==</span>&nbsp;<span class="ident" id="4236925">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236953">if</span>&nbsp;<span class="ident" id="4236956">needClientCerts</span>&nbsp;<span class="op" id="4236972">&amp;&amp;</span>&nbsp;<span class="op" id="4236975">!</span><span class="ident" id="4236976">sessionHasClientCerts</span>&nbsp;<span class="op" id="4236998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237002">return</span>&nbsp;<span class="builtintype" id="4237009">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4237016">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237019">if</span>&nbsp;<span class="ident" id="4237022">sessionHasClientCerts</span>&nbsp;<span class="op" id="4237044">&amp;&amp;</span>&nbsp;<span class="ident" id="4237047">c</span><span class="op" id="4237048">.</span><span class="ident" id="4237049">config</span><span class="op" id="4237055">.</span><span class="ident" id="4237056">ClientAuth</span>&nbsp;<span class="op" id="4237067">==</span>&nbsp;<span class="ident" id="4237070">NoClientCert</span>&nbsp;<span class="op" id="4237083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237087">return</span>&nbsp;<span class="builtintype" id="4237094">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4237101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237105">return</span>&nbsp;<span class="builtintype" id="4237112">true</span><br>
<span class="lineno">290</span><span class="op" id="4237117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4237120">func</span>&nbsp;<span class="op" id="4237125">(</span><span class="ident" id="4237126">hs</span>&nbsp;<span class="op" id="4237129">*</span><span class="ident" id="4237130">serverHandshakeState</span><span class="op" id="4237150">)</span>&nbsp;<span class="ident" id="4237152">doResumeHandshake</span><span class="op" id="4237169">(</span><span class="op" id="4237170">)</span>&nbsp;<span class="builtintype" id="4237172">error</span>&nbsp;<span class="op" id="4237178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237181">c</span>&nbsp;<span class="op" id="4237183">:=</span>&nbsp;<span class="ident" id="4237186">hs</span><span class="op" id="4237188">.</span><span class="ident" id="4237189">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237193">hs</span><span class="op" id="4237195">.</span><span class="ident" id="4237196">hello</span><span class="op" id="4237201">.</span><span class="ident" id="4237202">cipherSuite</span>&nbsp;<span class="op" id="4237214">=</span>&nbsp;<span class="ident" id="4237216">hs</span><span class="op" id="4237218">.</span><span class="ident" id="4237219">suite</span><span class="op" id="4237224">.</span><span class="ident" id="4237225">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4237229">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4237299">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237334">hs</span><span class="op" id="4237336">.</span><span class="ident" id="4237337">hello</span><span class="op" id="4237342">.</span><span class="ident" id="4237343">sessionId</span>&nbsp;<span class="op" id="4237353">=</span>&nbsp;<span class="ident" id="4237355">hs</span><span class="op" id="4237357">.</span><span class="ident" id="4237358">clientHello</span><span class="op" id="4237369">.</span><span class="ident" id="4237370">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237381">hs</span><span class="op" id="4237383">.</span><span class="ident" id="4237384">finishedHash</span><span class="op" id="4237396">.</span><span class="ident" id="4237397">Write</span><span class="op" id="4237402">(</span><span class="ident" id="4237403">hs</span><span class="op" id="4237405">.</span><span class="ident" id="4237406">hello</span><span class="op" id="4237411">.</span><span class="ident" id="4237412">marshal</span><span class="op" id="4237419">(</span><span class="op" id="4237420">)</span><span class="op" id="4237421">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237424">c</span><span class="op" id="4237425">.</span><span class="ident" id="4237426">writeRecord</span><span class="op" id="4237437">(</span><span class="ident" id="4237438">recordTypeHandshake</span><span class="op" id="4237457">,</span>&nbsp;<span class="ident" id="4237459">hs</span><span class="op" id="4237461">.</span><span class="ident" id="4237462">hello</span><span class="op" id="4237467">.</span><span class="ident" id="4237468">marshal</span><span class="op" id="4237475">(</span><span class="op" id="4237476">)</span><span class="op" id="4237477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237481">if</span>&nbsp;<span class="builtinfunc" id="4237484">len</span><span class="op" id="4237487">(</span><span class="ident" id="4237488">hs</span><span class="op" id="4237490">.</span><span class="ident" id="4237491">sessionState</span><span class="op" id="4237503">.</span><span class="ident" id="4237504">certificates</span><span class="op" id="4237516">)</span>&nbsp;<span class="op" id="4237518">&gt;</span>&nbsp;<span class="num" id="4237520">0</span>&nbsp;<span class="op" id="4237522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237526">if</span>&nbsp;<span class="ident" id="4237529">_</span><span class="op" id="4237530">,</span>&nbsp;<span class="ident" id="4237532">err</span>&nbsp;<span class="op" id="4237536">:=</span>&nbsp;<span class="ident" id="4237539">hs</span><span class="op" id="4237541">.</span><span class="ident" id="4237542">processCertsFromClient</span><span class="op" id="4237564">(</span><span class="ident" id="4237565">hs</span><span class="op" id="4237567">.</span><span class="ident" id="4237568">sessionState</span><span class="op" id="4237580">.</span><span class="ident" id="4237581">certificates</span><span class="op" id="4237593">)</span><span class="op" id="4237594">;</span>&nbsp;<span class="ident" id="4237596">err</span>&nbsp;<span class="op" id="4237600">!=</span>&nbsp;<span class="ident" id="4237603">nil</span>&nbsp;<span class="op" id="4237607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237612">return</span>&nbsp;<span class="ident" id="4237619">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4237625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4237628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237632">hs</span><span class="op" id="4237634">.</span><span class="ident" id="4237635">masterSecret</span>&nbsp;<span class="op" id="4237648">=</span>&nbsp;<span class="ident" id="4237650">hs</span><span class="op" id="4237652">.</span><span class="ident" id="4237653">sessionState</span><span class="op" id="4237665">.</span><span class="ident" id="4237666">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237681">return</span>&nbsp;<span class="ident" id="4237688">nil</span><br>
<span class="lineno"></span><span class="op" id="4237692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4237695">func</span>&nbsp;<span class="op" id="4237700">(</span><span class="ident" id="4237701">hs</span>&nbsp;<span class="op" id="4237704">*</span><span class="ident" id="4237705">serverHandshakeState</span><span class="op" id="4237725">)</span>&nbsp;<span class="ident" id="4237727">doFullHandshake</span><span class="op" id="4237742">(</span><span class="op" id="4237743">)</span>&nbsp;<span class="builtintype" id="4237745">error</span>&nbsp;<span class="op" id="4237751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237754">config</span>&nbsp;<span class="op" id="4237761">:=</span>&nbsp;<span class="ident" id="4237764">hs</span><span class="op" id="4237766">.</span><span class="ident" id="4237767">c</span><span class="op" id="4237768">.</span><span class="ident" id="4237769">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237777">c</span>&nbsp;<span class="op" id="4237779">:=</span>&nbsp;<span class="ident" id="4237782">hs</span><span class="op" id="4237784">.</span><span class="ident" id="4237785">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4237789">if</span>&nbsp;<span class="ident" id="4237792">hs</span><span class="op" id="4237794">.</span><span class="ident" id="4237795">clientHello</span><span class="op" id="4237806">.</span><span class="ident" id="4237807">ocspStapling</span>&nbsp;<span class="op" id="4237820">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4237823">len</span><span class="op" id="4237826">(</span><span class="ident" id="4237827">hs</span><span class="op" id="4237829">.</span><span class="ident" id="4237830">cert</span><span class="op" id="4237834">.</span><span class="ident" id="4237835">OCSPStaple</span><span class="op" id="4237845">)</span>&nbsp;<span class="op" id="4237847">&gt;</span>&nbsp;<span class="num" id="4237849">0</span>&nbsp;<span class="op" id="4237851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237855">hs</span><span class="op" id="4237857">.</span><span class="ident" id="4237858">hello</span><span class="op" id="4237863">.</span><span class="ident" id="4237864">ocspStapling</span>&nbsp;<span class="op" id="4237877">=</span>&nbsp;<span class="builtintype" id="4237879">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4237885">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237889">hs</span><span class="op" id="4237891">.</span><span class="ident" id="4237892">hello</span><span class="op" id="4237897">.</span><span class="ident" id="4237898">ticketSupported</span>&nbsp;<span class="op" id="4237914">=</span>&nbsp;<span class="ident" id="4237916">hs</span><span class="op" id="4237918">.</span><span class="ident" id="4237919">clientHello</span><span class="op" id="4237930">.</span><span class="ident" id="4237931">ticketSupported</span>&nbsp;<span class="op" id="4237947">&amp;&amp;</span>&nbsp;<span class="op" id="4237950">!</span><span class="ident" id="4237951">config</span><span class="op" id="4237957">.</span><span class="ident" id="4237958">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4237982">hs</span><span class="op" id="4237984">.</span><span class="ident" id="4237985">hello</span><span class="op" id="4237990">.</span><span class="ident" id="4237991">cipherSuite</span>&nbsp;<span class="op" id="4238003">=</span>&nbsp;<span class="ident" id="4238005">hs</span><span class="op" id="4238007">.</span><span class="ident" id="4238008">suite</span><span class="op" id="4238013">.</span><span class="ident" id="4238014">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238018">hs</span><span class="op" id="4238020">.</span><span class="ident" id="4238021">finishedHash</span><span class="op" id="4238033">.</span><span class="ident" id="4238034">Write</span><span class="op" id="4238039">(</span><span class="ident" id="4238040">hs</span><span class="op" id="4238042">.</span><span class="ident" id="4238043">hello</span><span class="op" id="4238048">.</span><span class="ident" id="4238049">marshal</span><span class="op" id="4238056">(</span><span class="op" id="4238057">)</span><span class="op" id="4238058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238061">c</span><span class="op" id="4238062">.</span><span class="ident" id="4238063">writeRecord</span><span class="op" id="4238074">(</span><span class="ident" id="4238075">recordTypeHandshake</span><span class="op" id="4238094">,</span>&nbsp;<span class="ident" id="4238096">hs</span><span class="op" id="4238098">.</span><span class="ident" id="4238099">hello</span><span class="op" id="4238104">.</span><span class="ident" id="4238105">marshal</span><span class="op" id="4238112">(</span><span class="op" id="4238113">)</span><span class="op" id="4238114">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238118">certMsg</span>&nbsp;<span class="op" id="4238126">:=</span>&nbsp;<span class="builtinfunc" id="4238129">new</span><span class="op" id="4238132">(</span><span class="ident" id="4238133">certificateMsg</span><span class="op" id="4238147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238150">certMsg</span><span class="op" id="4238157">.</span><span class="ident" id="4238158">certificates</span>&nbsp;<span class="op" id="4238171">=</span>&nbsp;<span class="ident" id="4238173">hs</span><span class="op" id="4238175">.</span><span class="ident" id="4238176">cert</span><span class="op" id="4238180">.</span><span class="ident" id="4238181">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238194">hs</span><span class="op" id="4238196">.</span><span class="ident" id="4238197">finishedHash</span><span class="op" id="4238209">.</span><span class="ident" id="4238210">Write</span><span class="op" id="4238215">(</span><span class="ident" id="4238216">certMsg</span><span class="op" id="4238223">.</span><span class="ident" id="4238224">marshal</span><span class="op" id="4238231">(</span><span class="op" id="4238232">)</span><span class="op" id="4238233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238236">c</span><span class="op" id="4238237">.</span><span class="ident" id="4238238">writeRecord</span><span class="op" id="4238249">(</span><span class="ident" id="4238250">recordTypeHandshake</span><span class="op" id="4238269">,</span>&nbsp;<span class="ident" id="4238271">certMsg</span><span class="op" id="4238278">.</span><span class="ident" id="4238279">marshal</span><span class="op" id="4238286">(</span><span class="op" id="4238287">)</span><span class="op" id="4238288">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4238292">if</span>&nbsp;<span class="ident" id="4238295">hs</span><span class="op" id="4238297">.</span><span class="ident" id="4238298">hello</span><span class="op" id="4238303">.</span><span class="ident" id="4238304">ocspStapling</span>&nbsp;<span class="op" id="4238317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238321">certStatus</span>&nbsp;<span class="op" id="4238332">:=</span>&nbsp;<span class="builtinfunc" id="4238335">new</span><span class="op" id="4238338">(</span><span class="ident" id="4238339">certificateStatusMsg</span><span class="op" id="4238359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238363">certStatus</span><span class="op" id="4238373">.</span><span class="ident" id="4238374">statusType</span>&nbsp;<span class="op" id="4238385">=</span>&nbsp;<span class="ident" id="4238387">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238404">certStatus</span><span class="op" id="4238414">.</span><span class="ident" id="4238415">response</span>&nbsp;<span class="op" id="4238424">=</span>&nbsp;<span class="ident" id="4238426">hs</span><span class="op" id="4238428">.</span><span class="ident" id="4238429">cert</span><span class="op" id="4238433">.</span><span class="ident" id="4238434">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238447">hs</span><span class="op" id="4238449">.</span><span class="ident" id="4238450">finishedHash</span><span class="op" id="4238462">.</span><span class="ident" id="4238463">Write</span><span class="op" id="4238468">(</span><span class="ident" id="4238469">certStatus</span><span class="op" id="4238479">.</span><span class="ident" id="4238480">marshal</span><span class="op" id="4238487">(</span><span class="op" id="4238488">)</span><span class="op" id="4238489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238493">c</span><span class="op" id="4238494">.</span><span class="ident" id="4238495">writeRecord</span><span class="op" id="4238506">(</span><span class="ident" id="4238507">recordTypeHandshake</span><span class="op" id="4238526">,</span>&nbsp;<span class="ident" id="4238528">certStatus</span><span class="op" id="4238538">.</span><span class="ident" id="4238539">marshal</span><span class="op" id="4238546">(</span><span class="op" id="4238547">)</span><span class="op" id="4238548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4238551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238555">keyAgreement</span>&nbsp;<span class="op" id="4238568">:=</span>&nbsp;<span class="ident" id="4238571">hs</span><span class="op" id="4238573">.</span><span class="ident" id="4238574">suite</span><span class="op" id="4238579">.</span><span class="ident" id="4238580">ka</span><span class="op" id="4238582">(</span><span class="ident" id="4238583">c</span><span class="op" id="4238584">.</span><span class="ident" id="4238585">vers</span><span class="op" id="4238589">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238592">skx</span><span class="op" id="4238595">,</span>&nbsp;<span class="ident" id="4238597">err</span>&nbsp;<span class="op" id="4238601">:=</span>&nbsp;<span class="ident" id="4238604">keyAgreement</span><span class="op" id="4238616">.</span><span class="ident" id="4238617">generateServerKeyExchange</span><span class="op" id="4238642">(</span><span class="ident" id="4238643">config</span><span class="op" id="4238649">,</span>&nbsp;<span class="ident" id="4238651">hs</span><span class="op" id="4238653">.</span><span class="ident" id="4238654">cert</span><span class="op" id="4238658">,</span>&nbsp;<span class="ident" id="4238660">hs</span><span class="op" id="4238662">.</span><span class="ident" id="4238663">clientHello</span><span class="op" id="4238674">,</span>&nbsp;<span class="ident" id="4238676">hs</span><span class="op" id="4238678">.</span><span class="ident" id="4238679">hello</span><span class="op" id="4238684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4238687">if</span>&nbsp;<span class="ident" id="4238690">err</span>&nbsp;<span class="op" id="4238694">!=</span>&nbsp;<span class="ident" id="4238697">nil</span>&nbsp;<span class="op" id="4238701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238705">c</span><span class="op" id="4238706">.</span><span class="ident" id="4238707">sendAlert</span><span class="op" id="4238716">(</span><span class="ident" id="4238717">alertHandshakeFailure</span><span class="op" id="4238738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4238742">return</span>&nbsp;<span class="ident" id="4238749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4238754">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4238757">if</span>&nbsp;<span class="ident" id="4238760">skx</span>&nbsp;<span class="op" id="4238764">!=</span>&nbsp;<span class="ident" id="4238767">nil</span>&nbsp;<span class="op" id="4238771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238775">hs</span><span class="op" id="4238777">.</span><span class="ident" id="4238778">finishedHash</span><span class="op" id="4238790">.</span><span class="ident" id="4238791">Write</span><span class="op" id="4238796">(</span><span class="ident" id="4238797">skx</span><span class="op" id="4238800">.</span><span class="ident" id="4238801">marshal</span><span class="op" id="4238808">(</span><span class="op" id="4238809">)</span><span class="op" id="4238810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238814">c</span><span class="op" id="4238815">.</span><span class="ident" id="4238816">writeRecord</span><span class="op" id="4238827">(</span><span class="ident" id="4238828">recordTypeHandshake</span><span class="op" id="4238847">,</span>&nbsp;<span class="ident" id="4238849">skx</span><span class="op" id="4238852">.</span><span class="ident" id="4238853">marshal</span><span class="op" id="4238860">(</span><span class="op" id="4238861">)</span><span class="op" id="4238862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4238865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4238869">if</span>&nbsp;<span class="ident" id="4238872">config</span><span class="op" id="4238878">.</span><span class="ident" id="4238879">ClientAuth</span>&nbsp;<span class="op" id="4238890">&gt;=</span>&nbsp;<span class="ident" id="4238893">RequestClientCert</span>&nbsp;<span class="op" id="4238911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4238915">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238949">certReq</span>&nbsp;<span class="op" id="4238957">:=</span>&nbsp;<span class="builtinfunc" id="4238960">new</span><span class="op" id="4238963">(</span><span class="ident" id="4238964">certificateRequestMsg</span><span class="op" id="4238985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4238989">certReq</span><span class="op" id="4238996">.</span><span class="ident" id="4238997">certificateTypes</span>&nbsp;<span class="op" id="4239014">=</span>&nbsp;<span class="op" id="4239016">[</span><span class="op" id="4239017">]</span><span class="builtintype" id="4239018">byte</span><span class="op" id="4239022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4239027">byte</span><span class="op" id="4239031">(</span><span class="ident" id="4239032">certTypeRSASign</span><span class="op" id="4239047">)</span><span class="op" id="4239048">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4239053">byte</span><span class="op" id="4239057">(</span><span class="ident" id="4239058">certTypeECDSASign</span><span class="op" id="4239075">)</span><span class="op" id="4239076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4239080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4239084">if</span>&nbsp;<span class="ident" id="4239087">c</span><span class="op" id="4239088">.</span><span class="ident" id="4239089">vers</span>&nbsp;<span class="op" id="4239094">&gt;=</span>&nbsp;<span class="ident" id="4239097">VersionTLS12</span>&nbsp;<span class="op" id="4239110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239115">certReq</span><span class="op" id="4239122">.</span><span class="ident" id="4239123">hasSignatureAndHash</span>&nbsp;<span class="op" id="4239143">=</span>&nbsp;<span class="builtintype" id="4239145">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239153">certReq</span><span class="op" id="4239160">.</span><span class="ident" id="4239161">signatureAndHashes</span>&nbsp;<span class="op" id="4239180">=</span>&nbsp;<span class="ident" id="4239182">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4239223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4239228">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4239284">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4239345">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4239402">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4239460">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4239507">if</span>&nbsp;<span class="ident" id="4239510">config</span><span class="op" id="4239516">.</span><span class="ident" id="4239517">ClientCAs</span>&nbsp;<span class="op" id="4239527">!=</span>&nbsp;<span class="ident" id="4239530">nil</span>&nbsp;<span class="op" id="4239534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239539">certReq</span><span class="op" id="4239546">.</span><span class="ident" id="4239547">certificateAuthorities</span>&nbsp;<span class="op" id="4239570">=</span>&nbsp;<span class="ident" id="4239572">config</span><span class="op" id="4239578">.</span><span class="ident" id="4239579">ClientCAs</span><span class="op" id="4239588">.</span><span class="ident" id="4239589">Subjects</span><span class="op" id="4239597">(</span><span class="op" id="4239598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4239602">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239606">hs</span><span class="op" id="4239608">.</span><span class="ident" id="4239609">finishedHash</span><span class="op" id="4239621">.</span><span class="ident" id="4239622">Write</span><span class="op" id="4239627">(</span><span class="ident" id="4239628">certReq</span><span class="op" id="4239635">.</span><span class="ident" id="4239636">marshal</span><span class="op" id="4239643">(</span><span class="op" id="4239644">)</span><span class="op" id="4239645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239649">c</span><span class="op" id="4239650">.</span><span class="ident" id="4239651">writeRecord</span><span class="op" id="4239662">(</span><span class="ident" id="4239663">recordTypeHandshake</span><span class="op" id="4239682">,</span>&nbsp;<span class="ident" id="4239684">certReq</span><span class="op" id="4239691">.</span><span class="ident" id="4239692">marshal</span><span class="op" id="4239699">(</span><span class="op" id="4239700">)</span><span class="op" id="4239701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4239704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239708">helloDone</span>&nbsp;<span class="op" id="4239718">:=</span>&nbsp;<span class="builtinfunc" id="4239721">new</span><span class="op" id="4239724">(</span><span class="ident" id="4239725">serverHelloDoneMsg</span><span class="op" id="4239743">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239746">hs</span><span class="op" id="4239748">.</span><span class="ident" id="4239749">finishedHash</span><span class="op" id="4239761">.</span><span class="ident" id="4239762">Write</span><span class="op" id="4239767">(</span><span class="ident" id="4239768">helloDone</span><span class="op" id="4239777">.</span><span class="ident" id="4239778">marshal</span><span class="op" id="4239785">(</span><span class="op" id="4239786">)</span><span class="op" id="4239787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239790">c</span><span class="op" id="4239791">.</span><span class="ident" id="4239792">writeRecord</span><span class="op" id="4239803">(</span><span class="ident" id="4239804">recordTypeHandshake</span><span class="op" id="4239823">,</span>&nbsp;<span class="ident" id="4239825">helloDone</span><span class="op" id="4239834">.</span><span class="ident" id="4239835">marshal</span><span class="op" id="4239842">(</span><span class="op" id="4239843">)</span><span class="op" id="4239844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4239848">var</span>&nbsp;<span class="ident" id="4239852">pub</span>&nbsp;<span class="ident" id="4239856">crypto</span><span class="op" id="4239862">.</span><span class="ident" id="4239863">PublicKey</span>&nbsp;<span class="comment" id="4239873">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4239913">msg</span><span class="op" id="4239916">,</span>&nbsp;<span class="ident" id="4239918">err</span>&nbsp;<span class="op" id="4239922">:=</span>&nbsp;<span class="ident" id="4239925">c</span><span class="op" id="4239926">.</span><span class="ident" id="4239927">readHandshake</span><span class="op" id="4239940">(</span><span class="op" id="4239941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4239944">if</span>&nbsp;<span class="ident" id="4239947">err</span>&nbsp;<span class="op" id="4239951">!=</span>&nbsp;<span class="ident" id="4239954">nil</span>&nbsp;<span class="op" id="4239958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4239962">return</span>&nbsp;<span class="ident" id="4239969">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4239974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4239978">var</span>&nbsp;<span class="ident" id="4239982">ok</span>&nbsp;<span class="builtintype" id="4239985">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4239991">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4240061">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240106">if</span>&nbsp;<span class="ident" id="4240109">config</span><span class="op" id="4240115">.</span><span class="ident" id="4240116">ClientAuth</span>&nbsp;<span class="op" id="4240127">&gt;=</span>&nbsp;<span class="ident" id="4240130">RequestClientCert</span>&nbsp;<span class="op" id="4240148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240152">if</span>&nbsp;<span class="ident" id="4240155">certMsg</span><span class="op" id="4240162">,</span>&nbsp;<span class="ident" id="4240164">ok</span>&nbsp;<span class="op" id="4240167">=</span>&nbsp;<span class="ident" id="4240169">msg</span><span class="op" id="4240172">.</span><span class="op" id="4240173">(</span><span class="op" id="4240174">*</span><span class="ident" id="4240175">certificateMsg</span><span class="op" id="4240189">)</span><span class="op" id="4240190">;</span>&nbsp;<span class="op" id="4240192">!</span><span class="ident" id="4240193">ok</span>&nbsp;<span class="op" id="4240196">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240201">c</span><span class="op" id="4240202">.</span><span class="ident" id="4240203">sendAlert</span><span class="op" id="4240212">(</span><span class="ident" id="4240213">alertUnexpectedMessage</span><span class="op" id="4240235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240240">return</span>&nbsp;<span class="ident" id="4240247">unexpectedMessageError</span><span class="op" id="4240269">(</span><span class="ident" id="4240270">certMsg</span><span class="op" id="4240277">,</span>&nbsp;<span class="ident" id="4240279">msg</span><span class="op" id="4240282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240290">hs</span><span class="op" id="4240292">.</span><span class="ident" id="4240293">finishedHash</span><span class="op" id="4240305">.</span><span class="ident" id="4240306">Write</span><span class="op" id="4240311">(</span><span class="ident" id="4240312">certMsg</span><span class="op" id="4240319">.</span><span class="ident" id="4240320">marshal</span><span class="op" id="4240327">(</span><span class="op" id="4240328">)</span><span class="op" id="4240329">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240334">if</span>&nbsp;<span class="builtinfunc" id="4240337">len</span><span class="op" id="4240340">(</span><span class="ident" id="4240341">certMsg</span><span class="op" id="4240348">.</span><span class="ident" id="4240349">certificates</span><span class="op" id="4240361">)</span>&nbsp;<span class="op" id="4240363">==</span>&nbsp;<span class="num" id="4240366">0</span>&nbsp;<span class="op" id="4240368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4240373">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240425">switch</span>&nbsp;<span class="ident" id="4240432">config</span><span class="op" id="4240438">.</span><span class="ident" id="4240439">ClientAuth</span>&nbsp;<span class="op" id="4240450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240455">case</span>&nbsp;<span class="ident" id="4240460">RequireAnyClientCert</span><span class="op" id="4240480">,</span>&nbsp;<span class="ident" id="4240482">RequireAndVerifyClientCert</span><span class="op" id="4240508">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240514">c</span><span class="op" id="4240515">.</span><span class="ident" id="4240516">sendAlert</span><span class="op" id="4240525">(</span><span class="ident" id="4240526">alertBadCertificate</span><span class="op" id="4240545">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240551">return</span>&nbsp;<span class="ident" id="4240558">errors</span><span class="op" id="4240564">.</span><span class="ident" id="4240565">New</span><span class="op" id="4240568">(</span><span class="string" id="4240569">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4240611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240625">pub</span><span class="op" id="4240628">,</span>&nbsp;<span class="ident" id="4240630">err</span>&nbsp;<span class="op" id="4240634">=</span>&nbsp;<span class="ident" id="4240636">hs</span><span class="op" id="4240638">.</span><span class="ident" id="4240639">processCertsFromClient</span><span class="op" id="4240661">(</span><span class="ident" id="4240662">certMsg</span><span class="op" id="4240669">.</span><span class="ident" id="4240670">certificates</span><span class="op" id="4240682">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240686">if</span>&nbsp;<span class="ident" id="4240689">err</span>&nbsp;<span class="op" id="4240693">!=</span>&nbsp;<span class="ident" id="4240696">nil</span>&nbsp;<span class="op" id="4240700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240705">return</span>&nbsp;<span class="ident" id="4240712">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240723">msg</span><span class="op" id="4240726">,</span>&nbsp;<span class="ident" id="4240728">err</span>&nbsp;<span class="op" id="4240732">=</span>&nbsp;<span class="ident" id="4240734">c</span><span class="op" id="4240735">.</span><span class="ident" id="4240736">readHandshake</span><span class="op" id="4240749">(</span><span class="op" id="4240750">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240754">if</span>&nbsp;<span class="ident" id="4240757">err</span>&nbsp;<span class="op" id="4240761">!=</span>&nbsp;<span class="ident" id="4240764">nil</span>&nbsp;<span class="op" id="4240768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240773">return</span>&nbsp;<span class="ident" id="4240780">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4240793">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240821">ckx</span><span class="op" id="4240824">,</span>&nbsp;<span class="ident" id="4240826">ok</span>&nbsp;<span class="op" id="4240829">:=</span>&nbsp;<span class="ident" id="4240832">msg</span><span class="op" id="4240835">.</span><span class="op" id="4240836">(</span><span class="op" id="4240837">*</span><span class="ident" id="4240838">clientKeyExchangeMsg</span><span class="op" id="4240858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240861">if</span>&nbsp;<span class="op" id="4240864">!</span><span class="ident" id="4240865">ok</span>&nbsp;<span class="op" id="4240868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240872">c</span><span class="op" id="4240873">.</span><span class="ident" id="4240874">sendAlert</span><span class="op" id="4240883">(</span><span class="ident" id="4240884">alertUnexpectedMessage</span><span class="op" id="4240906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4240910">return</span>&nbsp;<span class="ident" id="4240917">unexpectedMessageError</span><span class="op" id="4240939">(</span><span class="ident" id="4240940">ckx</span><span class="op" id="4240943">,</span>&nbsp;<span class="ident" id="4240945">msg</span><span class="op" id="4240948">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4240951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4240954">hs</span><span class="op" id="4240956">.</span><span class="ident" id="4240957">finishedHash</span><span class="op" id="4240969">.</span><span class="ident" id="4240970">Write</span><span class="op" id="4240975">(</span><span class="ident" id="4240976">ckx</span><span class="op" id="4240979">.</span><span class="ident" id="4240980">marshal</span><span class="op" id="4240987">(</span><span class="op" id="4240988">)</span><span class="op" id="4240989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4240993">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4241074">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4241147">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4241216">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4241296">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4241376">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241430">if</span>&nbsp;<span class="builtinfunc" id="4241433">len</span><span class="op" id="4241436">(</span><span class="ident" id="4241437">c</span><span class="op" id="4241438">.</span><span class="ident" id="4241439">peerCertificates</span><span class="op" id="4241455">)</span>&nbsp;<span class="op" id="4241457">&gt;</span>&nbsp;<span class="num" id="4241459">0</span>&nbsp;<span class="op" id="4241461">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4241465">msg</span><span class="op" id="4241468">,</span>&nbsp;<span class="ident" id="4241470">err</span>&nbsp;<span class="op" id="4241474">=</span>&nbsp;<span class="ident" id="4241476">c</span><span class="op" id="4241477">.</span><span class="ident" id="4241478">readHandshake</span><span class="op" id="4241491">(</span><span class="op" id="4241492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241496">if</span>&nbsp;<span class="ident" id="4241499">err</span>&nbsp;<span class="op" id="4241503">!=</span>&nbsp;<span class="ident" id="4241506">nil</span>&nbsp;<span class="op" id="4241510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241515">return</span>&nbsp;<span class="ident" id="4241522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4241528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4241532">certVerify</span><span class="op" id="4241542">,</span>&nbsp;<span class="ident" id="4241544">ok</span>&nbsp;<span class="op" id="4241547">:=</span>&nbsp;<span class="ident" id="4241550">msg</span><span class="op" id="4241553">.</span><span class="op" id="4241554">(</span><span class="op" id="4241555">*</span><span class="ident" id="4241556">certificateVerifyMsg</span><span class="op" id="4241576">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241580">if</span>&nbsp;<span class="op" id="4241583">!</span><span class="ident" id="4241584">ok</span>&nbsp;<span class="op" id="4241587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4241592">c</span><span class="op" id="4241593">.</span><span class="ident" id="4241594">sendAlert</span><span class="op" id="4241603">(</span><span class="ident" id="4241604">alertUnexpectedMessage</span><span class="op" id="4241626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241631">return</span>&nbsp;<span class="ident" id="4241638">unexpectedMessageError</span><span class="op" id="4241660">(</span><span class="ident" id="4241661">certVerify</span><span class="op" id="4241671">,</span>&nbsp;<span class="ident" id="4241673">msg</span><span class="op" id="4241676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4241680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241685">switch</span>&nbsp;<span class="ident" id="4241692">key</span>&nbsp;<span class="op" id="4241696">:=</span>&nbsp;<span class="ident" id="4241699">pub</span><span class="op" id="4241702">.</span><span class="op" id="4241703">(</span><span class="keyword" id="4241704">type</span><span class="op" id="4241708">)</span>&nbsp;<span class="op" id="4241710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241714">case</span>&nbsp;<span class="op" id="4241719">*</span><span class="ident" id="4241720">ecdsa</span><span class="op" id="4241725">.</span><span class="ident" id="4241726">PublicKey</span><span class="op" id="4241735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4241740">ecdsaSig</span>&nbsp;<span class="op" id="4241749">:=</span>&nbsp;<span class="builtinfunc" id="4241752">new</span><span class="op" id="4241755">(</span><span class="ident" id="4241756">ecdsaSignature</span><span class="op" id="4241770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241775">if</span>&nbsp;<span class="ident" id="4241778">_</span><span class="op" id="4241779">,</span>&nbsp;<span class="ident" id="4241781">err</span>&nbsp;<span class="op" id="4241785">=</span>&nbsp;<span class="ident" id="4241787">asn1</span><span class="op" id="4241791">.</span><span class="ident" id="4241792">Unmarshal</span><span class="op" id="4241801">(</span><span class="ident" id="4241802">certVerify</span><span class="op" id="4241812">.</span><span class="ident" id="4241813">signature</span><span class="op" id="4241822">,</span>&nbsp;<span class="ident" id="4241824">ecdsaSig</span><span class="op" id="4241832">)</span><span class="op" id="4241833">;</span>&nbsp;<span class="ident" id="4241835">err</span>&nbsp;<span class="op" id="4241839">!=</span>&nbsp;<span class="ident" id="4241842">nil</span>&nbsp;<span class="op" id="4241846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241852">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4241861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241866">if</span>&nbsp;<span class="ident" id="4241869">ecdsaSig</span><span class="op" id="4241877">.</span><span class="ident" id="4241878">R</span><span class="op" id="4241879">.</span><span class="ident" id="4241880">Sign</span><span class="op" id="4241884">(</span><span class="op" id="4241885">)</span>&nbsp;<span class="op" id="4241887">&lt;=</span>&nbsp;<span class="num" id="4241890">0</span>&nbsp;<span class="op" id="4241892">||</span>&nbsp;<span class="ident" id="4241895">ecdsaSig</span><span class="op" id="4241903">.</span><span class="ident" id="4241904">S</span><span class="op" id="4241905">.</span><span class="ident" id="4241906">Sign</span><span class="op" id="4241910">(</span><span class="op" id="4241911">)</span>&nbsp;<span class="op" id="4241913">&lt;=</span>&nbsp;<span class="num" id="4241916">0</span>&nbsp;<span class="op" id="4241918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4241924">err</span>&nbsp;<span class="op" id="4241928">=</span>&nbsp;<span class="ident" id="4241930">errors</span><span class="op" id="4241936">.</span><span class="ident" id="4241937">New</span><span class="op" id="4241940">(</span><span class="string" id="4241941">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4241992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4241998">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4242007">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242012">digest</span><span class="op" id="4242018">,</span>&nbsp;<span class="ident" id="4242020">_</span><span class="op" id="4242021">,</span>&nbsp;<span class="ident" id="4242023">_</span>&nbsp;<span class="op" id="4242025">:=</span>&nbsp;<span class="ident" id="4242028">hs</span><span class="op" id="4242030">.</span><span class="ident" id="4242031">finishedHash</span><span class="op" id="4242043">.</span><span class="ident" id="4242044">hashForClientCertificate</span><span class="op" id="4242068">(</span><span class="ident" id="4242069">signatureECDSA</span><span class="op" id="4242083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242088">if</span>&nbsp;<span class="op" id="4242091">!</span><span class="ident" id="4242092">ecdsa</span><span class="op" id="4242097">.</span><span class="ident" id="4242098">Verify</span><span class="op" id="4242104">(</span><span class="ident" id="4242105">key</span><span class="op" id="4242108">,</span>&nbsp;<span class="ident" id="4242110">digest</span><span class="op" id="4242116">,</span>&nbsp;<span class="ident" id="4242118">ecdsaSig</span><span class="op" id="4242126">.</span><span class="ident" id="4242127">R</span><span class="op" id="4242128">,</span>&nbsp;<span class="ident" id="4242130">ecdsaSig</span><span class="op" id="4242138">.</span><span class="ident" id="4242139">S</span><span class="op" id="4242140">)</span>&nbsp;<span class="op" id="4242142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242148">err</span>&nbsp;<span class="op" id="4242152">=</span>&nbsp;<span class="ident" id="4242154">errors</span><span class="op" id="4242160">.</span><span class="ident" id="4242161">New</span><span class="op" id="4242164">(</span><span class="string" id="4242165">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4242193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242199">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4242208">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242212">case</span>&nbsp;<span class="op" id="4242217">*</span><span class="ident" id="4242218">rsa</span><span class="op" id="4242221">.</span><span class="ident" id="4242222">PublicKey</span><span class="op" id="4242231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242236">digest</span><span class="op" id="4242242">,</span>&nbsp;<span class="ident" id="4242244">hashFunc</span><span class="op" id="4242252">,</span>&nbsp;<span class="ident" id="4242254">_</span>&nbsp;<span class="op" id="4242256">:=</span>&nbsp;<span class="ident" id="4242259">hs</span><span class="op" id="4242261">.</span><span class="ident" id="4242262">finishedHash</span><span class="op" id="4242274">.</span><span class="ident" id="4242275">hashForClientCertificate</span><span class="op" id="4242299">(</span><span class="ident" id="4242300">signatureRSA</span><span class="op" id="4242312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242317">err</span>&nbsp;<span class="op" id="4242321">=</span>&nbsp;<span class="ident" id="4242323">rsa</span><span class="op" id="4242326">.</span><span class="ident" id="4242327">VerifyPKCS1v15</span><span class="op" id="4242341">(</span><span class="ident" id="4242342">key</span><span class="op" id="4242345">,</span>&nbsp;<span class="ident" id="4242347">hashFunc</span><span class="op" id="4242355">,</span>&nbsp;<span class="ident" id="4242357">digest</span><span class="op" id="4242363">,</span>&nbsp;<span class="ident" id="4242365">certVerify</span><span class="op" id="4242375">.</span><span class="ident" id="4242376">signature</span><span class="op" id="4242385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4242389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242393">if</span>&nbsp;<span class="ident" id="4242396">err</span>&nbsp;<span class="op" id="4242400">!=</span>&nbsp;<span class="ident" id="4242403">nil</span>&nbsp;<span class="op" id="4242407">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242412">c</span><span class="op" id="4242413">.</span><span class="ident" id="4242414">sendAlert</span><span class="op" id="4242423">(</span><span class="ident" id="4242424">alertBadCertificate</span><span class="op" id="4242443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242448">return</span>&nbsp;<span class="ident" id="4242455">errors</span><span class="op" id="4242461">.</span><span class="ident" id="4242462">New</span><span class="op" id="4242465">(</span><span class="string" id="4242466">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4242520">+</span>&nbsp;<span class="ident" id="4242522">err</span><span class="op" id="4242525">.</span><span class="ident" id="4242526">Error</span><span class="op" id="4242531">(</span><span class="op" id="4242532">)</span><span class="op" id="4242533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4242537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242542">hs</span><span class="op" id="4242544">.</span><span class="ident" id="4242545">finishedHash</span><span class="op" id="4242557">.</span><span class="ident" id="4242558">Write</span><span class="op" id="4242563">(</span><span class="ident" id="4242564">certVerify</span><span class="op" id="4242574">.</span><span class="ident" id="4242575">marshal</span><span class="op" id="4242582">(</span><span class="op" id="4242583">)</span><span class="op" id="4242584">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4242587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242591">preMasterSecret</span><span class="op" id="4242606">,</span>&nbsp;<span class="ident" id="4242608">err</span>&nbsp;<span class="op" id="4242612">:=</span>&nbsp;<span class="ident" id="4242615">keyAgreement</span><span class="op" id="4242627">.</span><span class="ident" id="4242628">processClientKeyExchange</span><span class="op" id="4242652">(</span><span class="ident" id="4242653">config</span><span class="op" id="4242659">,</span>&nbsp;<span class="ident" id="4242661">hs</span><span class="op" id="4242663">.</span><span class="ident" id="4242664">cert</span><span class="op" id="4242668">,</span>&nbsp;<span class="ident" id="4242670">ckx</span><span class="op" id="4242673">,</span>&nbsp;<span class="ident" id="4242675">c</span><span class="op" id="4242676">.</span><span class="ident" id="4242677">vers</span><span class="op" id="4242681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242684">if</span>&nbsp;<span class="ident" id="4242687">err</span>&nbsp;<span class="op" id="4242691">!=</span>&nbsp;<span class="ident" id="4242694">nil</span>&nbsp;<span class="op" id="4242698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242702">c</span><span class="op" id="4242703">.</span><span class="ident" id="4242704">sendAlert</span><span class="op" id="4242713">(</span><span class="ident" id="4242714">alertHandshakeFailure</span><span class="op" id="4242735">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242739">return</span>&nbsp;<span class="ident" id="4242746">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4242751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242754">hs</span><span class="op" id="4242756">.</span><span class="ident" id="4242757">masterSecret</span>&nbsp;<span class="op" id="4242770">=</span>&nbsp;<span class="ident" id="4242772">masterFromPreMasterSecret</span><span class="op" id="4242797">(</span><span class="ident" id="4242798">c</span><span class="op" id="4242799">.</span><span class="ident" id="4242800">vers</span><span class="op" id="4242804">,</span>&nbsp;<span class="ident" id="4242806">preMasterSecret</span><span class="op" id="4242821">,</span>&nbsp;<span class="ident" id="4242823">hs</span><span class="op" id="4242825">.</span><span class="ident" id="4242826">clientHello</span><span class="op" id="4242837">.</span><span class="ident" id="4242838">random</span><span class="op" id="4242844">,</span>&nbsp;<span class="ident" id="4242846">hs</span><span class="op" id="4242848">.</span><span class="ident" id="4242849">hello</span><span class="op" id="4242854">.</span><span class="ident" id="4242855">random</span><span class="op" id="4242861">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4242865">return</span>&nbsp;<span class="ident" id="4242872">nil</span><br>
<span class="lineno">475</span><span class="op" id="4242876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4242879">func</span>&nbsp;<span class="op" id="4242884">(</span><span class="ident" id="4242885">hs</span>&nbsp;<span class="op" id="4242888">*</span><span class="ident" id="4242889">serverHandshakeState</span><span class="op" id="4242909">)</span>&nbsp;<span class="ident" id="4242911">establishKeys</span><span class="op" id="4242924">(</span><span class="op" id="4242925">)</span>&nbsp;<span class="builtintype" id="4242927">error</span>&nbsp;<span class="op" id="4242933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242936">c</span>&nbsp;<span class="op" id="4242938">:=</span>&nbsp;<span class="ident" id="4242941">hs</span><span class="op" id="4242943">.</span><span class="ident" id="4242944">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4242948">clientMAC</span><span class="op" id="4242957">,</span>&nbsp;<span class="ident" id="4242959">serverMAC</span><span class="op" id="4242968">,</span>&nbsp;<span class="ident" id="4242970">clientKey</span><span class="op" id="4242979">,</span>&nbsp;<span class="ident" id="4242981">serverKey</span><span class="op" id="4242990">,</span>&nbsp;<span class="ident" id="4242992">clientIV</span><span class="op" id="4243000">,</span>&nbsp;<span class="ident" id="4243002">serverIV</span>&nbsp;<span class="op" id="4243011">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243016">keysFromMasterSecret</span><span class="op" id="4243036">(</span><span class="ident" id="4243037">c</span><span class="op" id="4243038">.</span><span class="ident" id="4243039">vers</span><span class="op" id="4243043">,</span>&nbsp;<span class="ident" id="4243045">hs</span><span class="op" id="4243047">.</span><span class="ident" id="4243048">masterSecret</span><span class="op" id="4243060">,</span>&nbsp;<span class="ident" id="4243062">hs</span><span class="op" id="4243064">.</span><span class="ident" id="4243065">clientHello</span><span class="op" id="4243076">.</span><span class="ident" id="4243077">random</span><span class="op" id="4243083">,</span>&nbsp;<span class="ident" id="4243085">hs</span><span class="op" id="4243087">.</span><span class="ident" id="4243088">hello</span><span class="op" id="4243093">.</span><span class="ident" id="4243094">random</span><span class="op" id="4243100">,</span>&nbsp;<span class="ident" id="4243102">hs</span><span class="op" id="4243104">.</span><span class="ident" id="4243105">suite</span><span class="op" id="4243110">.</span><span class="ident" id="4243111">macLen</span><span class="op" id="4243117">,</span>&nbsp;<span class="ident" id="4243119">hs</span><span class="op" id="4243121">.</span><span class="ident" id="4243122">suite</span><span class="op" id="4243127">.</span><span class="ident" id="4243128">keyLen</span><span class="op" id="4243134">,</span>&nbsp;<span class="ident" id="4243136">hs</span><span class="op" id="4243138">.</span><span class="ident" id="4243139">suite</span><span class="op" id="4243144">.</span><span class="ident" id="4243145">ivLen</span><span class="op" id="4243150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243154">var</span>&nbsp;<span class="ident" id="4243158">clientCipher</span><span class="op" id="4243170">,</span>&nbsp;<span class="ident" id="4243172">serverCipher</span>&nbsp;<span class="keyword" id="4243185">interface</span><span class="op" id="4243194">{</span><span class="op" id="4243195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243198">var</span>&nbsp;<span class="ident" id="4243202">clientHash</span><span class="op" id="4243212">,</span>&nbsp;<span class="ident" id="4243214">serverHash</span>&nbsp;<span class="ident" id="4243225">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243239">if</span>&nbsp;<span class="ident" id="4243242">hs</span><span class="op" id="4243244">.</span><span class="ident" id="4243245">suite</span><span class="op" id="4243250">.</span><span class="ident" id="4243251">aead</span>&nbsp;<span class="op" id="4243256">==</span>&nbsp;<span class="ident" id="4243259">nil</span>&nbsp;<span class="op" id="4243263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243267">clientCipher</span>&nbsp;<span class="op" id="4243280">=</span>&nbsp;<span class="ident" id="4243282">hs</span><span class="op" id="4243284">.</span><span class="ident" id="4243285">suite</span><span class="op" id="4243290">.</span><span class="ident" id="4243291">cipher</span><span class="op" id="4243297">(</span><span class="ident" id="4243298">clientKey</span><span class="op" id="4243307">,</span>&nbsp;<span class="ident" id="4243309">clientIV</span><span class="op" id="4243317">,</span>&nbsp;<span class="builtintype" id="4243319">true</span>&nbsp;<span class="comment" id="4243324">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4243341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243345">clientHash</span>&nbsp;<span class="op" id="4243356">=</span>&nbsp;<span class="ident" id="4243358">hs</span><span class="op" id="4243360">.</span><span class="ident" id="4243361">suite</span><span class="op" id="4243366">.</span><span class="ident" id="4243367">mac</span><span class="op" id="4243370">(</span><span class="ident" id="4243371">c</span><span class="op" id="4243372">.</span><span class="ident" id="4243373">vers</span><span class="op" id="4243377">,</span>&nbsp;<span class="ident" id="4243379">clientMAC</span><span class="op" id="4243388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243392">serverCipher</span>&nbsp;<span class="op" id="4243405">=</span>&nbsp;<span class="ident" id="4243407">hs</span><span class="op" id="4243409">.</span><span class="ident" id="4243410">suite</span><span class="op" id="4243415">.</span><span class="ident" id="4243416">cipher</span><span class="op" id="4243422">(</span><span class="ident" id="4243423">serverKey</span><span class="op" id="4243432">,</span>&nbsp;<span class="ident" id="4243434">serverIV</span><span class="op" id="4243442">,</span>&nbsp;<span class="builtintype" id="4243444">false</span>&nbsp;<span class="comment" id="4243450">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4243471">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243475">serverHash</span>&nbsp;<span class="op" id="4243486">=</span>&nbsp;<span class="ident" id="4243488">hs</span><span class="op" id="4243490">.</span><span class="ident" id="4243491">suite</span><span class="op" id="4243496">.</span><span class="ident" id="4243497">mac</span><span class="op" id="4243500">(</span><span class="ident" id="4243501">c</span><span class="op" id="4243502">.</span><span class="ident" id="4243503">vers</span><span class="op" id="4243507">,</span>&nbsp;<span class="ident" id="4243509">serverMAC</span><span class="op" id="4243518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4243521">}</span>&nbsp;<span class="keyword" id="4243523">else</span>&nbsp;<span class="op" id="4243528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243532">clientCipher</span>&nbsp;<span class="op" id="4243545">=</span>&nbsp;<span class="ident" id="4243547">hs</span><span class="op" id="4243549">.</span><span class="ident" id="4243550">suite</span><span class="op" id="4243555">.</span><span class="ident" id="4243556">aead</span><span class="op" id="4243560">(</span><span class="ident" id="4243561">clientKey</span><span class="op" id="4243570">,</span>&nbsp;<span class="ident" id="4243572">clientIV</span><span class="op" id="4243580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243584">serverCipher</span>&nbsp;<span class="op" id="4243597">=</span>&nbsp;<span class="ident" id="4243599">hs</span><span class="op" id="4243601">.</span><span class="ident" id="4243602">suite</span><span class="op" id="4243607">.</span><span class="ident" id="4243608">aead</span><span class="op" id="4243612">(</span><span class="ident" id="4243613">serverKey</span><span class="op" id="4243622">,</span>&nbsp;<span class="ident" id="4243624">serverIV</span><span class="op" id="4243632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4243635">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243639">c</span><span class="op" id="4243640">.</span><span class="ident" id="4243641">in</span><span class="op" id="4243643">.</span><span class="ident" id="4243644">prepareCipherSpec</span><span class="op" id="4243661">(</span><span class="ident" id="4243662">c</span><span class="op" id="4243663">.</span><span class="ident" id="4243664">vers</span><span class="op" id="4243668">,</span>&nbsp;<span class="ident" id="4243670">clientCipher</span><span class="op" id="4243682">,</span>&nbsp;<span class="ident" id="4243684">clientHash</span><span class="op" id="4243694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243697">c</span><span class="op" id="4243698">.</span><span class="ident" id="4243699">out</span><span class="op" id="4243702">.</span><span class="ident" id="4243703">prepareCipherSpec</span><span class="op" id="4243720">(</span><span class="ident" id="4243721">c</span><span class="op" id="4243722">.</span><span class="ident" id="4243723">vers</span><span class="op" id="4243727">,</span>&nbsp;<span class="ident" id="4243729">serverCipher</span><span class="op" id="4243741">,</span>&nbsp;<span class="ident" id="4243743">serverHash</span><span class="op" id="4243753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243757">return</span>&nbsp;<span class="ident" id="4243764">nil</span><br>
<span class="lineno">500</span><span class="op" id="4243768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4243771">func</span>&nbsp;<span class="op" id="4243776">(</span><span class="ident" id="4243777">hs</span>&nbsp;<span class="op" id="4243780">*</span><span class="ident" id="4243781">serverHandshakeState</span><span class="op" id="4243801">)</span>&nbsp;<span class="ident" id="4243803">readFinished</span><span class="op" id="4243815">(</span><span class="ident" id="4243816">out</span>&nbsp;<span class="op" id="4243820">[</span><span class="op" id="4243821">]</span><span class="builtintype" id="4243822">byte</span><span class="op" id="4243826">)</span>&nbsp;<span class="builtintype" id="4243828">error</span>&nbsp;<span class="op" id="4243834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243837">c</span>&nbsp;<span class="op" id="4243839">:=</span>&nbsp;<span class="ident" id="4243842">hs</span><span class="op" id="4243844">.</span><span class="ident" id="4243845">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243849">c</span><span class="op" id="4243850">.</span><span class="ident" id="4243851">readRecord</span><span class="op" id="4243861">(</span><span class="ident" id="4243862">recordTypeChangeCipherSpec</span><span class="op" id="4243888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243891">if</span>&nbsp;<span class="ident" id="4243894">err</span>&nbsp;<span class="op" id="4243898">:=</span>&nbsp;<span class="ident" id="4243901">c</span><span class="op" id="4243902">.</span><span class="ident" id="4243903">in</span><span class="op" id="4243905">.</span><span class="builtintype" id="4243906">error</span><span class="op" id="4243911">(</span><span class="op" id="4243912">)</span><span class="op" id="4243913">;</span>&nbsp;<span class="ident" id="4243915">err</span>&nbsp;<span class="op" id="4243919">!=</span>&nbsp;<span class="ident" id="4243922">nil</span>&nbsp;<span class="op" id="4243926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243930">return</span>&nbsp;<span class="ident" id="4243937">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4243942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4243946">if</span>&nbsp;<span class="ident" id="4243949">hs</span><span class="op" id="4243951">.</span><span class="ident" id="4243952">hello</span><span class="op" id="4243957">.</span><span class="ident" id="4243958">nextProtoNeg</span>&nbsp;<span class="op" id="4243971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4243975">msg</span><span class="op" id="4243978">,</span>&nbsp;<span class="ident" id="4243980">err</span>&nbsp;<span class="op" id="4243984">:=</span>&nbsp;<span class="ident" id="4243987">c</span><span class="op" id="4243988">.</span><span class="ident" id="4243989">readHandshake</span><span class="op" id="4244002">(</span><span class="op" id="4244003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244007">if</span>&nbsp;<span class="ident" id="4244010">err</span>&nbsp;<span class="op" id="4244014">!=</span>&nbsp;<span class="ident" id="4244017">nil</span>&nbsp;<span class="op" id="4244021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244026">return</span>&nbsp;<span class="ident" id="4244033">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244039">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244043">nextProto</span><span class="op" id="4244052">,</span>&nbsp;<span class="ident" id="4244054">ok</span>&nbsp;<span class="op" id="4244057">:=</span>&nbsp;<span class="ident" id="4244060">msg</span><span class="op" id="4244063">.</span><span class="op" id="4244064">(</span><span class="op" id="4244065">*</span><span class="ident" id="4244066">nextProtoMsg</span><span class="op" id="4244078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244082">if</span>&nbsp;<span class="op" id="4244085">!</span><span class="ident" id="4244086">ok</span>&nbsp;<span class="op" id="4244089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244094">c</span><span class="op" id="4244095">.</span><span class="ident" id="4244096">sendAlert</span><span class="op" id="4244105">(</span><span class="ident" id="4244106">alertUnexpectedMessage</span><span class="op" id="4244128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244133">return</span>&nbsp;<span class="ident" id="4244140">unexpectedMessageError</span><span class="op" id="4244162">(</span><span class="ident" id="4244163">nextProto</span><span class="op" id="4244172">,</span>&nbsp;<span class="ident" id="4244174">msg</span><span class="op" id="4244177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244181">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244185">hs</span><span class="op" id="4244187">.</span><span class="ident" id="4244188">finishedHash</span><span class="op" id="4244200">.</span><span class="ident" id="4244201">Write</span><span class="op" id="4244206">(</span><span class="ident" id="4244207">nextProto</span><span class="op" id="4244216">.</span><span class="ident" id="4244217">marshal</span><span class="op" id="4244224">(</span><span class="op" id="4244225">)</span><span class="op" id="4244226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244230">c</span><span class="op" id="4244231">.</span><span class="ident" id="4244232">clientProtocol</span>&nbsp;<span class="op" id="4244247">=</span>&nbsp;<span class="ident" id="4244249">nextProto</span><span class="op" id="4244258">.</span><span class="ident" id="4244259">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244270">msg</span><span class="op" id="4244273">,</span>&nbsp;<span class="ident" id="4244275">err</span>&nbsp;<span class="op" id="4244279">:=</span>&nbsp;<span class="ident" id="4244282">c</span><span class="op" id="4244283">.</span><span class="ident" id="4244284">readHandshake</span><span class="op" id="4244297">(</span><span class="op" id="4244298">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244301">if</span>&nbsp;<span class="ident" id="4244304">err</span>&nbsp;<span class="op" id="4244308">!=</span>&nbsp;<span class="ident" id="4244311">nil</span>&nbsp;<span class="op" id="4244315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244319">return</span>&nbsp;<span class="ident" id="4244326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244334">clientFinished</span><span class="op" id="4244348">,</span>&nbsp;<span class="ident" id="4244350">ok</span>&nbsp;<span class="op" id="4244353">:=</span>&nbsp;<span class="ident" id="4244356">msg</span><span class="op" id="4244359">.</span><span class="op" id="4244360">(</span><span class="op" id="4244361">*</span><span class="ident" id="4244362">finishedMsg</span><span class="op" id="4244373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244376">if</span>&nbsp;<span class="op" id="4244379">!</span><span class="ident" id="4244380">ok</span>&nbsp;<span class="op" id="4244383">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244387">c</span><span class="op" id="4244388">.</span><span class="ident" id="4244389">sendAlert</span><span class="op" id="4244398">(</span><span class="ident" id="4244399">alertUnexpectedMessage</span><span class="op" id="4244421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244425">return</span>&nbsp;<span class="ident" id="4244432">unexpectedMessageError</span><span class="op" id="4244454">(</span><span class="ident" id="4244455">clientFinished</span><span class="op" id="4244469">,</span>&nbsp;<span class="ident" id="4244471">msg</span><span class="op" id="4244474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244481">verify</span>&nbsp;<span class="op" id="4244488">:=</span>&nbsp;<span class="ident" id="4244491">hs</span><span class="op" id="4244493">.</span><span class="ident" id="4244494">finishedHash</span><span class="op" id="4244506">.</span><span class="ident" id="4244507">clientSum</span><span class="op" id="4244516">(</span><span class="ident" id="4244517">hs</span><span class="op" id="4244519">.</span><span class="ident" id="4244520">masterSecret</span><span class="op" id="4244532">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244535">if</span>&nbsp;<span class="builtinfunc" id="4244538">len</span><span class="op" id="4244541">(</span><span class="ident" id="4244542">verify</span><span class="op" id="4244548">)</span>&nbsp;<span class="op" id="4244550">!=</span>&nbsp;<span class="builtinfunc" id="4244553">len</span><span class="op" id="4244556">(</span><span class="ident" id="4244557">clientFinished</span><span class="op" id="4244571">.</span><span class="ident" id="4244572">verifyData</span><span class="op" id="4244582">)</span>&nbsp;<span class="op" id="4244584">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244589">subtle</span><span class="op" id="4244595">.</span><span class="ident" id="4244596">ConstantTimeCompare</span><span class="op" id="4244615">(</span><span class="ident" id="4244616">verify</span><span class="op" id="4244622">,</span>&nbsp;<span class="ident" id="4244624">clientFinished</span><span class="op" id="4244638">.</span><span class="ident" id="4244639">verifyData</span><span class="op" id="4244649">)</span>&nbsp;<span class="op" id="4244651">!=</span>&nbsp;<span class="num" id="4244654">1</span>&nbsp;<span class="op" id="4244656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244660">c</span><span class="op" id="4244661">.</span><span class="ident" id="4244662">sendAlert</span><span class="op" id="4244671">(</span><span class="ident" id="4244672">alertHandshakeFailure</span><span class="op" id="4244693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244697">return</span>&nbsp;<span class="ident" id="4244704">errors</span><span class="op" id="4244710">.</span><span class="ident" id="4244711">New</span><span class="op" id="4244714">(</span><span class="string" id="4244715">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4244760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244763">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244767">hs</span><span class="op" id="4244769">.</span><span class="ident" id="4244770">finishedHash</span><span class="op" id="4244782">.</span><span class="ident" id="4244783">Write</span><span class="op" id="4244788">(</span><span class="ident" id="4244789">clientFinished</span><span class="op" id="4244803">.</span><span class="ident" id="4244804">marshal</span><span class="op" id="4244811">(</span><span class="op" id="4244812">)</span><span class="op" id="4244813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4244816">copy</span><span class="op" id="4244820">(</span><span class="ident" id="4244821">out</span><span class="op" id="4244824">,</span>&nbsp;<span class="ident" id="4244826">verify</span><span class="op" id="4244832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244835">return</span>&nbsp;<span class="ident" id="4244842">nil</span><br>
<span class="lineno"></span><span class="op" id="4244846">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4244849">func</span>&nbsp;<span class="op" id="4244854">(</span><span class="ident" id="4244855">hs</span>&nbsp;<span class="op" id="4244858">*</span><span class="ident" id="4244859">serverHandshakeState</span><span class="op" id="4244879">)</span>&nbsp;<span class="ident" id="4244881">sendSessionTicket</span><span class="op" id="4244898">(</span><span class="op" id="4244899">)</span>&nbsp;<span class="builtintype" id="4244901">error</span>&nbsp;<span class="op" id="4244907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244910">if</span>&nbsp;<span class="op" id="4244913">!</span><span class="ident" id="4244914">hs</span><span class="op" id="4244916">.</span><span class="ident" id="4244917">hello</span><span class="op" id="4244922">.</span><span class="ident" id="4244923">ticketSupported</span>&nbsp;<span class="op" id="4244939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4244943">return</span>&nbsp;<span class="ident" id="4244950">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4244955">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244959">c</span>&nbsp;<span class="op" id="4244961">:=</span>&nbsp;<span class="ident" id="4244964">hs</span><span class="op" id="4244966">.</span><span class="ident" id="4244967">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4244970">m</span>&nbsp;<span class="op" id="4244972">:=</span>&nbsp;<span class="builtinfunc" id="4244975">new</span><span class="op" id="4244978">(</span><span class="ident" id="4244979">newSessionTicketMsg</span><span class="op" id="4244998">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4245002">var</span>&nbsp;<span class="ident" id="4245006">err</span>&nbsp;<span class="builtintype" id="4245010">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245017">state</span>&nbsp;<span class="op" id="4245023">:=</span>&nbsp;<span class="ident" id="4245026">sessionState</span><span class="op" id="4245038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245042">vers</span><span class="op" id="4245046">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4245056">c</span><span class="op" id="4245057">.</span><span class="ident" id="4245058">vers</span><span class="op" id="4245062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245066">cipherSuite</span><span class="op" id="4245077">:</span>&nbsp;&nbsp;<span class="ident" id="4245080">hs</span><span class="op" id="4245082">.</span><span class="ident" id="4245083">suite</span><span class="op" id="4245088">.</span><span class="ident" id="4245089">id</span><span class="op" id="4245091">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245095">masterSecret</span><span class="op" id="4245107">:</span>&nbsp;<span class="ident" id="4245109">hs</span><span class="op" id="4245111">.</span><span class="ident" id="4245112">masterSecret</span><span class="op" id="4245124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245128">certificates</span><span class="op" id="4245140">:</span>&nbsp;<span class="ident" id="4245142">hs</span><span class="op" id="4245144">.</span><span class="ident" id="4245145">certsFromClient</span><span class="op" id="4245160">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4245163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245166">m</span><span class="op" id="4245167">.</span><span class="ident" id="4245168">ticket</span><span class="op" id="4245174">,</span>&nbsp;<span class="ident" id="4245176">err</span>&nbsp;<span class="op" id="4245180">=</span>&nbsp;<span class="ident" id="4245182">c</span><span class="op" id="4245183">.</span><span class="ident" id="4245184">encryptTicket</span><span class="op" id="4245197">(</span><span class="op" id="4245198">&amp;</span><span class="ident" id="4245199">state</span><span class="op" id="4245204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4245207">if</span>&nbsp;<span class="ident" id="4245210">err</span>&nbsp;<span class="op" id="4245214">!=</span>&nbsp;<span class="ident" id="4245217">nil</span>&nbsp;<span class="op" id="4245221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4245225">return</span>&nbsp;<span class="ident" id="4245232">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4245237">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245241">hs</span><span class="op" id="4245243">.</span><span class="ident" id="4245244">finishedHash</span><span class="op" id="4245256">.</span><span class="ident" id="4245257">Write</span><span class="op" id="4245262">(</span><span class="ident" id="4245263">m</span><span class="op" id="4245264">.</span><span class="ident" id="4245265">marshal</span><span class="op" id="4245272">(</span><span class="op" id="4245273">)</span><span class="op" id="4245274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245277">c</span><span class="op" id="4245278">.</span><span class="ident" id="4245279">writeRecord</span><span class="op" id="4245290">(</span><span class="ident" id="4245291">recordTypeHandshake</span><span class="op" id="4245310">,</span>&nbsp;<span class="ident" id="4245312">m</span><span class="op" id="4245313">.</span><span class="ident" id="4245314">marshal</span><span class="op" id="4245321">(</span><span class="op" id="4245322">)</span><span class="op" id="4245323">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4245327">return</span>&nbsp;<span class="ident" id="4245334">nil</span><br>
<span class="lineno">570</span><span class="op" id="4245338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4245341">func</span>&nbsp;<span class="op" id="4245346">(</span><span class="ident" id="4245347">hs</span>&nbsp;<span class="op" id="4245350">*</span><span class="ident" id="4245351">serverHandshakeState</span><span class="op" id="4245371">)</span>&nbsp;<span class="ident" id="4245373">sendFinished</span><span class="op" id="4245385">(</span><span class="ident" id="4245386">out</span>&nbsp;<span class="op" id="4245390">[</span><span class="op" id="4245391">]</span><span class="builtintype" id="4245392">byte</span><span class="op" id="4245396">)</span>&nbsp;<span class="builtintype" id="4245398">error</span>&nbsp;<span class="op" id="4245404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245407">c</span>&nbsp;<span class="op" id="4245409">:=</span>&nbsp;<span class="ident" id="4245412">hs</span><span class="op" id="4245414">.</span><span class="ident" id="4245415">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245419">c</span><span class="op" id="4245420">.</span><span class="ident" id="4245421">writeRecord</span><span class="op" id="4245432">(</span><span class="ident" id="4245433">recordTypeChangeCipherSpec</span><span class="op" id="4245459">,</span>&nbsp;<span class="op" id="4245461">[</span><span class="op" id="4245462">]</span><span class="builtintype" id="4245463">byte</span><span class="op" id="4245467">{</span><span class="num" id="4245468">1</span><span class="op" id="4245469">}</span><span class="op" id="4245470">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245474">finished</span>&nbsp;<span class="op" id="4245483">:=</span>&nbsp;<span class="builtinfunc" id="4245486">new</span><span class="op" id="4245489">(</span><span class="ident" id="4245490">finishedMsg</span><span class="op" id="4245501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245504">finished</span><span class="op" id="4245512">.</span><span class="ident" id="4245513">verifyData</span>&nbsp;<span class="op" id="4245524">=</span>&nbsp;<span class="ident" id="4245526">hs</span><span class="op" id="4245528">.</span><span class="ident" id="4245529">finishedHash</span><span class="op" id="4245541">.</span><span class="ident" id="4245542">serverSum</span><span class="op" id="4245551">(</span><span class="ident" id="4245552">hs</span><span class="op" id="4245554">.</span><span class="ident" id="4245555">masterSecret</span><span class="op" id="4245567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245570">hs</span><span class="op" id="4245572">.</span><span class="ident" id="4245573">finishedHash</span><span class="op" id="4245585">.</span><span class="ident" id="4245586">Write</span><span class="op" id="4245591">(</span><span class="ident" id="4245592">finished</span><span class="op" id="4245600">.</span><span class="ident" id="4245601">marshal</span><span class="op" id="4245608">(</span><span class="op" id="4245609">)</span><span class="op" id="4245610">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245613">c</span><span class="op" id="4245614">.</span><span class="ident" id="4245615">writeRecord</span><span class="op" id="4245626">(</span><span class="ident" id="4245627">recordTypeHandshake</span><span class="op" id="4245646">,</span>&nbsp;<span class="ident" id="4245648">finished</span><span class="op" id="4245656">.</span><span class="ident" id="4245657">marshal</span><span class="op" id="4245664">(</span><span class="op" id="4245665">)</span><span class="op" id="4245666">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4245670">c</span><span class="op" id="4245671">.</span><span class="ident" id="4245672">cipherSuite</span>&nbsp;<span class="op" id="4245684">=</span>&nbsp;<span class="ident" id="4245686">hs</span><span class="op" id="4245688">.</span><span class="ident" id="4245689">suite</span><span class="op" id="4245694">.</span><span class="ident" id="4245695">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4245699">copy</span><span class="op" id="4245703">(</span><span class="ident" id="4245704">out</span><span class="op" id="4245707">,</span>&nbsp;<span class="ident" id="4245709">finished</span><span class="op" id="4245717">.</span><span class="ident" id="4245718">verifyData</span><span class="op" id="4245728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4245732">return</span>&nbsp;<span class="ident" id="4245739">nil</span><br>
<span class="lineno"></span><span class="op" id="4245743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4245746">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4245823">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4245900">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4245943">func</span>&nbsp;<span class="op" id="4245948">(</span><span class="ident" id="4245949">hs</span>&nbsp;<span class="op" id="4245952">*</span><span class="ident" id="4245953">serverHandshakeState</span><span class="op" id="4245973">)</span>&nbsp;<span class="ident" id="4245975">processCertsFromClient</span><span class="op" id="4245997">(</span><span class="ident" id="4245998">certificates</span>&nbsp;<span class="op" id="4246011">[</span><span class="op" id="4246012">]</span><span class="op" id="4246013">[</span><span class="op" id="4246014">]</span><span class="builtintype" id="4246015">byte</span><span class="op" id="4246019">)</span>&nbsp;<span class="op" id="4246021">(</span><span class="ident" id="4246022">crypto</span><span class="op" id="4246028">.</span><span class="ident" id="4246029">PublicKey</span><span class="op" id="4246038">,</span>&nbsp;<span class="builtintype" id="4246040">error</span><span class="op" id="4246045">)</span>&nbsp;<span class="op" id="4246047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246050">c</span>&nbsp;<span class="op" id="4246052">:=</span>&nbsp;<span class="ident" id="4246055">hs</span><span class="op" id="4246057">.</span><span class="ident" id="4246058">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246062">hs</span><span class="op" id="4246064">.</span><span class="ident" id="4246065">certsFromClient</span>&nbsp;<span class="op" id="4246081">=</span>&nbsp;<span class="ident" id="4246083">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246097">certs</span>&nbsp;<span class="op" id="4246103">:=</span>&nbsp;<span class="builtinfunc" id="4246106">make</span><span class="op" id="4246110">(</span><span class="op" id="4246111">[</span><span class="op" id="4246112">]</span><span class="op" id="4246113">*</span><span class="ident" id="4246114">x509</span><span class="op" id="4246118">.</span><span class="ident" id="4246119">Certificate</span><span class="op" id="4246130">,</span>&nbsp;<span class="builtinfunc" id="4246132">len</span><span class="op" id="4246135">(</span><span class="ident" id="4246136">certificates</span><span class="op" id="4246148">)</span><span class="op" id="4246149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246152">var</span>&nbsp;<span class="ident" id="4246156">err</span>&nbsp;<span class="builtintype" id="4246160">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246167">for</span>&nbsp;<span class="ident" id="4246171">i</span><span class="op" id="4246172">,</span>&nbsp;<span class="ident" id="4246174">asn1Data</span>&nbsp;<span class="op" id="4246183">:=</span>&nbsp;<span class="keyword" id="4246186">range</span>&nbsp;<span class="ident" id="4246192">certificates</span>&nbsp;<span class="op" id="4246205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246209">if</span>&nbsp;<span class="ident" id="4246212">certs</span><span class="op" id="4246217">[</span><span class="ident" id="4246218">i</span><span class="op" id="4246219">]</span><span class="op" id="4246220">,</span>&nbsp;<span class="ident" id="4246222">err</span>&nbsp;<span class="op" id="4246226">=</span>&nbsp;<span class="ident" id="4246228">x509</span><span class="op" id="4246232">.</span><span class="ident" id="4246233">ParseCertificate</span><span class="op" id="4246249">(</span><span class="ident" id="4246250">asn1Data</span><span class="op" id="4246258">)</span><span class="op" id="4246259">;</span>&nbsp;<span class="ident" id="4246261">err</span>&nbsp;<span class="op" id="4246265">!=</span>&nbsp;<span class="ident" id="4246268">nil</span>&nbsp;<span class="op" id="4246272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246277">c</span><span class="op" id="4246278">.</span><span class="ident" id="4246279">sendAlert</span><span class="op" id="4246288">(</span><span class="ident" id="4246289">alertBadCertificate</span><span class="op" id="4246308">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246313">return</span>&nbsp;<span class="ident" id="4246320">nil</span><span class="op" id="4246323">,</span>&nbsp;<span class="ident" id="4246325">errors</span><span class="op" id="4246331">.</span><span class="ident" id="4246332">New</span><span class="op" id="4246335">(</span><span class="string" id="4246336">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4246380">+</span>&nbsp;<span class="ident" id="4246382">err</span><span class="op" id="4246385">.</span><span class="ident" id="4246386">Error</span><span class="op" id="4246391">(</span><span class="op" id="4246392">)</span><span class="op" id="4246393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246404">if</span>&nbsp;<span class="ident" id="4246407">c</span><span class="op" id="4246408">.</span><span class="ident" id="4246409">config</span><span class="op" id="4246415">.</span><span class="ident" id="4246416">ClientAuth</span>&nbsp;<span class="op" id="4246427">&gt;=</span>&nbsp;<span class="ident" id="4246430">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="4246454">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4246457">len</span><span class="op" id="4246460">(</span><span class="ident" id="4246461">certs</span><span class="op" id="4246466">)</span>&nbsp;<span class="op" id="4246468">&gt;</span>&nbsp;<span class="num" id="4246470">0</span>&nbsp;<span class="op" id="4246472">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246476">opts</span>&nbsp;<span class="op" id="4246481">:=</span>&nbsp;<span class="ident" id="4246484">x509</span><span class="op" id="4246488">.</span><span class="ident" id="4246489">VerifyOptions</span><span class="op" id="4246502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246507">Roots</span><span class="op" id="4246512">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4246522">c</span><span class="op" id="4246523">.</span><span class="ident" id="4246524">config</span><span class="op" id="4246530">.</span><span class="ident" id="4246531">ClientCAs</span><span class="op" id="4246540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246545">CurrentTime</span><span class="op" id="4246556">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4246560">c</span><span class="op" id="4246561">.</span><span class="ident" id="4246562">config</span><span class="op" id="4246568">.</span><span class="ident" id="4246569">time</span><span class="op" id="4246573">(</span><span class="op" id="4246574">)</span><span class="op" id="4246575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246580">Intermediates</span><span class="op" id="4246593">:</span>&nbsp;<span class="ident" id="4246595">x509</span><span class="op" id="4246599">.</span><span class="ident" id="4246600">NewCertPool</span><span class="op" id="4246611">(</span><span class="op" id="4246612">)</span><span class="op" id="4246613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246618">KeyUsages</span><span class="op" id="4246627">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4246633">[</span><span class="op" id="4246634">]</span><span class="ident" id="4246635">x509</span><span class="op" id="4246639">.</span><span class="ident" id="4246640">ExtKeyUsage</span><span class="op" id="4246651">{</span><span class="ident" id="4246652">x509</span><span class="op" id="4246656">.</span><span class="ident" id="4246657">ExtKeyUsageClientAuth</span><span class="op" id="4246678">}</span><span class="op" id="4246679">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246688">for</span>&nbsp;<span class="ident" id="4246692">_</span><span class="op" id="4246693">,</span>&nbsp;<span class="ident" id="4246695">cert</span>&nbsp;<span class="op" id="4246700">:=</span>&nbsp;<span class="keyword" id="4246703">range</span>&nbsp;<span class="ident" id="4246709">certs</span><span class="op" id="4246714">[</span><span class="num" id="4246715">1</span><span class="op" id="4246716">:</span><span class="op" id="4246717">]</span>&nbsp;<span class="op" id="4246719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246724">opts</span><span class="op" id="4246728">.</span><span class="ident" id="4246729">Intermediates</span><span class="op" id="4246742">.</span><span class="ident" id="4246743">AddCert</span><span class="op" id="4246750">(</span><span class="ident" id="4246751">cert</span><span class="op" id="4246755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246759">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246764">chains</span><span class="op" id="4246770">,</span>&nbsp;<span class="ident" id="4246772">err</span>&nbsp;<span class="op" id="4246776">:=</span>&nbsp;<span class="ident" id="4246779">certs</span><span class="op" id="4246784">[</span><span class="num" id="4246785">0</span><span class="op" id="4246786">]</span><span class="op" id="4246787">.</span><span class="ident" id="4246788">Verify</span><span class="op" id="4246794">(</span><span class="ident" id="4246795">opts</span><span class="op" id="4246799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246803">if</span>&nbsp;<span class="ident" id="4246806">err</span>&nbsp;<span class="op" id="4246810">!=</span>&nbsp;<span class="ident" id="4246813">nil</span>&nbsp;<span class="op" id="4246817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246822">c</span><span class="op" id="4246823">.</span><span class="ident" id="4246824">sendAlert</span><span class="op" id="4246833">(</span><span class="ident" id="4246834">alertBadCertificate</span><span class="op" id="4246853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246858">return</span>&nbsp;<span class="ident" id="4246865">nil</span><span class="op" id="4246868">,</span>&nbsp;<span class="ident" id="4246870">errors</span><span class="op" id="4246876">.</span><span class="ident" id="4246877">New</span><span class="op" id="4246880">(</span><span class="string" id="4246881">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4246928">+</span>&nbsp;<span class="ident" id="4246930">err</span><span class="op" id="4246933">.</span><span class="ident" id="4246934">Error</span><span class="op" id="4246939">(</span><span class="op" id="4246940">)</span><span class="op" id="4246941">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4246945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4246950">ok</span>&nbsp;<span class="op" id="4246953">:=</span>&nbsp;<span class="builtintype" id="4246956">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4246964">for</span>&nbsp;<span class="ident" id="4246968">_</span><span class="op" id="4246969">,</span>&nbsp;<span class="ident" id="4246971">ku</span>&nbsp;<span class="op" id="4246974">:=</span>&nbsp;<span class="keyword" id="4246977">range</span>&nbsp;<span class="ident" id="4246983">certs</span><span class="op" id="4246988">[</span><span class="num" id="4246989">0</span><span class="op" id="4246990">]</span><span class="op" id="4246991">.</span><span class="ident" id="4246992">ExtKeyUsage</span>&nbsp;<span class="op" id="4247004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247009">if</span>&nbsp;<span class="ident" id="4247012">ku</span>&nbsp;<span class="op" id="4247015">==</span>&nbsp;<span class="ident" id="4247018">x509</span><span class="op" id="4247022">.</span><span class="ident" id="4247023">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4247045">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247051">ok</span>&nbsp;<span class="op" id="4247054">=</span>&nbsp;<span class="builtintype" id="4247056">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247065">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247082">if</span>&nbsp;<span class="op" id="4247085">!</span><span class="ident" id="4247086">ok</span>&nbsp;<span class="op" id="4247089">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247094">c</span><span class="op" id="4247095">.</span><span class="ident" id="4247096">sendAlert</span><span class="op" id="4247105">(</span><span class="ident" id="4247106">alertHandshakeFailure</span><span class="op" id="4247127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247132">return</span>&nbsp;<span class="ident" id="4247139">nil</span><span class="op" id="4247142">,</span>&nbsp;<span class="ident" id="4247144">errors</span><span class="op" id="4247150">.</span><span class="ident" id="4247151">New</span><span class="op" id="4247154">(</span><span class="string" id="4247155">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4247258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247267">c</span><span class="op" id="4247268">.</span><span class="ident" id="4247269">verifiedChains</span>&nbsp;<span class="op" id="4247284">=</span>&nbsp;<span class="ident" id="4247286">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247298">if</span>&nbsp;<span class="builtinfunc" id="4247301">len</span><span class="op" id="4247304">(</span><span class="ident" id="4247305">certs</span><span class="op" id="4247310">)</span>&nbsp;<span class="op" id="4247312">&gt;</span>&nbsp;<span class="num" id="4247314">0</span>&nbsp;<span class="op" id="4247316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247320">var</span>&nbsp;<span class="ident" id="4247324">pub</span>&nbsp;<span class="ident" id="4247328">crypto</span><span class="op" id="4247334">.</span><span class="ident" id="4247335">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247347">switch</span>&nbsp;<span class="ident" id="4247354">key</span>&nbsp;<span class="op" id="4247358">:=</span>&nbsp;<span class="ident" id="4247361">certs</span><span class="op" id="4247366">[</span><span class="num" id="4247367">0</span><span class="op" id="4247368">]</span><span class="op" id="4247369">.</span><span class="ident" id="4247370">PublicKey</span><span class="op" id="4247379">.</span><span class="op" id="4247380">(</span><span class="keyword" id="4247381">type</span><span class="op" id="4247385">)</span>&nbsp;<span class="op" id="4247387">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247391">case</span>&nbsp;<span class="op" id="4247396">*</span><span class="ident" id="4247397">ecdsa</span><span class="op" id="4247402">.</span><span class="ident" id="4247403">PublicKey</span><span class="op" id="4247412">,</span>&nbsp;<span class="op" id="4247414">*</span><span class="ident" id="4247415">rsa</span><span class="op" id="4247418">.</span><span class="ident" id="4247419">PublicKey</span><span class="op" id="4247428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247433">pub</span>&nbsp;<span class="op" id="4247437">=</span>&nbsp;<span class="ident" id="4247439">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247445">default</span><span class="op" id="4247452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247457">c</span><span class="op" id="4247458">.</span><span class="ident" id="4247459">sendAlert</span><span class="op" id="4247468">(</span><span class="ident" id="4247469">alertUnsupportedCertificate</span><span class="op" id="4247496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247501">return</span>&nbsp;<span class="ident" id="4247508">nil</span><span class="op" id="4247511">,</span>&nbsp;<span class="ident" id="4247513">fmt</span><span class="op" id="4247516">.</span><span class="ident" id="4247517">Errorf</span><span class="op" id="4247523">(</span><span class="string" id="4247524">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4247597">,</span>&nbsp;<span class="ident" id="4247599">certs</span><span class="op" id="4247604">[</span><span class="num" id="4247605">0</span><span class="op" id="4247606">]</span><span class="op" id="4247607">.</span><span class="ident" id="4247608">PublicKey</span><span class="op" id="4247617">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4247625">c</span><span class="op" id="4247626">.</span><span class="ident" id="4247627">peerCertificates</span>&nbsp;<span class="op" id="4247644">=</span>&nbsp;<span class="ident" id="4247646">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247654">return</span>&nbsp;<span class="ident" id="4247661">pub</span><span class="op" id="4247664">,</span>&nbsp;<span class="ident" id="4247666">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4247671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247675">return</span>&nbsp;<span class="ident" id="4247682">nil</span><span class="op" id="4247685">,</span>&nbsp;<span class="ident" id="4247687">nil</span><br>
<span class="lineno"></span><span class="op" id="4247691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4247694">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4247773">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4247798">func</span>&nbsp;<span class="op" id="4247803">(</span><span class="ident" id="4247804">c</span>&nbsp;<span class="op" id="4247806">*</span><span class="ident" id="4247807">Conn</span><span class="op" id="4247811">)</span>&nbsp;<span class="ident" id="4247813">tryCipherSuite</span><span class="op" id="4247827">(</span><span class="ident" id="4247828">id</span>&nbsp;<span class="builtintype" id="4247831">uint16</span><span class="op" id="4247837">,</span>&nbsp;<span class="ident" id="4247839">supportedCipherSuites</span>&nbsp;<span class="op" id="4247861">[</span><span class="op" id="4247862">]</span><span class="builtintype" id="4247863">uint16</span><span class="op" id="4247869">,</span>&nbsp;<span class="ident" id="4247871">version</span>&nbsp;<span class="builtintype" id="4247879">uint16</span><span class="op" id="4247885">,</span>&nbsp;<span class="ident" id="4247887">ellipticOk</span><span class="op" id="4247897">,</span>&nbsp;<span class="ident" id="4247899">ecdsaOk</span>&nbsp;<span class="builtintype" id="4247907">bool</span><span class="op" id="4247911">)</span>&nbsp;<span class="op" id="4247913">*</span><span class="ident" id="4247914">cipherSuite</span>&nbsp;<span class="op" id="4247926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247929">for</span>&nbsp;<span class="ident" id="4247933">_</span><span class="op" id="4247934">,</span>&nbsp;<span class="ident" id="4247936">supported</span>&nbsp;<span class="op" id="4247946">:=</span>&nbsp;<span class="keyword" id="4247949">range</span>&nbsp;<span class="ident" id="4247955">supportedCipherSuites</span>&nbsp;<span class="op" id="4247977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4247981">if</span>&nbsp;<span class="ident" id="4247984">id</span>&nbsp;<span class="op" id="4247987">==</span>&nbsp;<span class="ident" id="4247990">supported</span>&nbsp;<span class="op" id="4248000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248005">var</span>&nbsp;<span class="ident" id="4248009">candidate</span>&nbsp;<span class="op" id="4248019">*</span><span class="ident" id="4248020">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248036">for</span>&nbsp;<span class="ident" id="4248040">_</span><span class="op" id="4248041">,</span>&nbsp;<span class="ident" id="4248043">s</span>&nbsp;<span class="op" id="4248045">:=</span>&nbsp;<span class="keyword" id="4248048">range</span>&nbsp;<span class="ident" id="4248054">cipherSuites</span>&nbsp;<span class="op" id="4248067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248073">if</span>&nbsp;<span class="ident" id="4248076">s</span><span class="op" id="4248077">.</span><span class="ident" id="4248078">id</span>&nbsp;<span class="op" id="4248081">==</span>&nbsp;<span class="ident" id="4248084">id</span>&nbsp;<span class="op" id="4248087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4248094">candidate</span>&nbsp;<span class="op" id="4248104">=</span>&nbsp;<span class="ident" id="4248106">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248113">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248123">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248133">if</span>&nbsp;<span class="ident" id="4248136">candidate</span>&nbsp;<span class="op" id="4248146">==</span>&nbsp;<span class="ident" id="4248149">nil</span>&nbsp;<span class="op" id="4248153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248159">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4248176">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4248224">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248255">if</span>&nbsp;<span class="op" id="4248258">(</span><span class="ident" id="4248259">candidate</span><span class="op" id="4248268">.</span><span class="ident" id="4248269">flags</span><span class="op" id="4248274">&amp;</span><span class="ident" id="4248275">suiteECDHE</span>&nbsp;<span class="op" id="4248286">!=</span>&nbsp;<span class="num" id="4248289">0</span><span class="op" id="4248290">)</span>&nbsp;<span class="op" id="4248292">&amp;&amp;</span>&nbsp;<span class="op" id="4248295">!</span><span class="ident" id="4248296">ellipticOk</span>&nbsp;<span class="op" id="4248307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248313">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248330">if</span>&nbsp;<span class="op" id="4248333">(</span><span class="ident" id="4248334">candidate</span><span class="op" id="4248343">.</span><span class="ident" id="4248344">flags</span><span class="op" id="4248349">&amp;</span><span class="ident" id="4248350">suiteECDSA</span>&nbsp;<span class="op" id="4248361">!=</span>&nbsp;<span class="num" id="4248364">0</span><span class="op" id="4248365">)</span>&nbsp;<span class="op" id="4248367">!=</span>&nbsp;<span class="ident" id="4248370">ecdsaOk</span>&nbsp;<span class="op" id="4248378">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248384">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248401">if</span>&nbsp;<span class="ident" id="4248404">version</span>&nbsp;<span class="op" id="4248412">&lt;</span>&nbsp;<span class="ident" id="4248414">VersionTLS12</span>&nbsp;<span class="op" id="4248427">&amp;&amp;</span>&nbsp;<span class="ident" id="4248430">candidate</span><span class="op" id="4248439">.</span><span class="ident" id="4248440">flags</span><span class="op" id="4248445">&amp;</span><span class="ident" id="4248446">suiteTLS12</span>&nbsp;<span class="op" id="4248457">!=</span>&nbsp;<span class="num" id="4248460">0</span>&nbsp;<span class="op" id="4248462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248468">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248480">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248485">return</span>&nbsp;<span class="ident" id="4248492">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4248507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4248511">return</span>&nbsp;<span class="ident" id="4248518">nil</span><br>
<span class="lineno">685</span><span class="op" id="4248522">}</span>
</div>
</body>
</html>
