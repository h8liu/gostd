<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html" class="current">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8207223">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8207278">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8207332">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8207383">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8207448">package</span>&nbsp;<span class="ident" id="8207456">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8207464">import</span>&nbsp;<span class="op" id="8207471">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207474">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207482">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207495">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207501">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207512">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207523">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207534">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207545">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8207556">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8207563">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8207566">func</span>&nbsp;<span class="ident" id="8207571">waitSig</span><span class="op" id="8207578">(</span><span class="ident" id="8207579">t</span>&nbsp;<span class="op" id="8207581">*</span><span class="ident" id="8207582">testing</span><span class="op" id="8207589">.</span><span class="ident" id="8207590">T</span><span class="op" id="8207591">,</span>&nbsp;<span class="ident" id="8207593">c</span>&nbsp;<span class="op" id="8207595">&lt;-</span><span class="keyword" id="8207597">chan</span>&nbsp;<span class="ident" id="8207602">os</span><span class="op" id="8207604">.</span><span class="ident" id="8207605">Signal</span><span class="op" id="8207611">,</span>&nbsp;<span class="ident" id="8207613">sig</span>&nbsp;<span class="ident" id="8207617">os</span><span class="op" id="8207619">.</span><span class="ident" id="8207620">Signal</span><span class="op" id="8207626">)</span>&nbsp;<span class="op" id="8207628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207631">select</span>&nbsp;<span class="op" id="8207638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207641">case</span>&nbsp;<span class="ident" id="8207646">s</span>&nbsp;<span class="op" id="8207648">:=</span>&nbsp;<span class="op" id="8207651">&lt;-</span><span class="ident" id="8207653">c</span><span class="op" id="8207654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207658">if</span>&nbsp;<span class="ident" id="8207661">s</span>&nbsp;<span class="op" id="8207663">!=</span>&nbsp;<span class="ident" id="8207666">sig</span>&nbsp;<span class="op" id="8207670">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207675">t</span><span class="op" id="8207676">.</span><span class="ident" id="8207677">Fatalf</span><span class="op" id="8207683">(</span><span class="string" id="8207684">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8207708">,</span>&nbsp;<span class="ident" id="8207710">s</span><span class="op" id="8207711">,</span>&nbsp;<span class="ident" id="8207713">sig</span><span class="op" id="8207716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207723">case</span>&nbsp;<span class="op" id="8207728">&lt;-</span><span class="ident" id="8207730">time</span><span class="op" id="8207734">.</span><span class="ident" id="8207735">After</span><span class="op" id="8207740">(</span><span class="num" id="8207741">1</span>&nbsp;<span class="op" id="8207743">*</span>&nbsp;<span class="ident" id="8207745">time</span><span class="op" id="8207749">.</span><span class="ident" id="8207750">Second</span><span class="op" id="8207756">)</span><span class="op" id="8207757">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207761">t</span><span class="op" id="8207762">.</span><span class="ident" id="8207763">Fatalf</span><span class="op" id="8207769">(</span><span class="string" id="8207770">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="8207794">,</span>&nbsp;<span class="ident" id="8207796">sig</span><span class="op" id="8207799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8207802">}</span><br>
<span class="lineno">30</span><span class="op" id="8207804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8207807">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="8207849">func</span>&nbsp;<span class="ident" id="8207854">TestSignal</span><span class="op" id="8207864">(</span><span class="ident" id="8207865">t</span>&nbsp;<span class="op" id="8207867">*</span><span class="ident" id="8207868">testing</span><span class="op" id="8207875">.</span><span class="ident" id="8207876">T</span><span class="op" id="8207877">)</span>&nbsp;<span class="op" id="8207879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8207882">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207901">c</span>&nbsp;<span class="op" id="8207903">:=</span>&nbsp;<span class="builtinfunc" id="8207906">make</span><span class="op" id="8207910">(</span><span class="keyword" id="8207911">chan</span>&nbsp;<span class="ident" id="8207916">os</span><span class="op" id="8207918">.</span><span class="ident" id="8207919">Signal</span><span class="op" id="8207925">,</span>&nbsp;<span class="num" id="8207927">1</span><span class="op" id="8207928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8207931">Notify</span><span class="op" id="8207937">(</span><span class="ident" id="8207938">c</span><span class="op" id="8207939">,</span>&nbsp;<span class="ident" id="8207941">syscall</span><span class="op" id="8207948">.</span><span class="ident" id="8207949">SIGHUP</span><span class="op" id="8207955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8207958">defer</span>&nbsp;<span class="ident" id="8207964">Stop</span><span class="op" id="8207968">(</span><span class="ident" id="8207969">c</span><span class="op" id="8207970">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8207974">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208005">t</span><span class="op" id="8208006">.</span><span class="ident" id="8208007">Logf</span><span class="op" id="8208011">(</span><span class="string" id="8208012">&#34;sighup...&#34;</span><span class="op" id="8208023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208026">syscall</span><span class="op" id="8208033">.</span><span class="ident" id="8208034">Kill</span><span class="op" id="8208038">(</span><span class="ident" id="8208039">syscall</span><span class="op" id="8208046">.</span><span class="ident" id="8208047">Getpid</span><span class="op" id="8208053">(</span><span class="op" id="8208054">)</span><span class="op" id="8208055">,</span>&nbsp;<span class="ident" id="8208057">syscall</span><span class="op" id="8208064">.</span><span class="ident" id="8208065">SIGHUP</span><span class="op" id="8208071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208074">waitSig</span><span class="op" id="8208081">(</span><span class="ident" id="8208082">t</span><span class="op" id="8208083">,</span>&nbsp;<span class="ident" id="8208085">c</span><span class="op" id="8208086">,</span>&nbsp;<span class="ident" id="8208088">syscall</span><span class="op" id="8208095">.</span><span class="ident" id="8208096">SIGHUP</span><span class="op" id="8208102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208106">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208141">c1</span>&nbsp;<span class="op" id="8208144">:=</span>&nbsp;<span class="builtinfunc" id="8208147">make</span><span class="op" id="8208151">(</span><span class="keyword" id="8208152">chan</span>&nbsp;<span class="ident" id="8208157">os</span><span class="op" id="8208159">.</span><span class="ident" id="8208160">Signal</span><span class="op" id="8208166">,</span>&nbsp;<span class="num" id="8208168">1</span><span class="op" id="8208169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208172">Notify</span><span class="op" id="8208178">(</span><span class="ident" id="8208179">c1</span><span class="op" id="8208181">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208185">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208218">t</span><span class="op" id="8208219">.</span><span class="ident" id="8208220">Logf</span><span class="op" id="8208224">(</span><span class="string" id="8208225">&#34;sigwinch...&#34;</span><span class="op" id="8208238">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208241">syscall</span><span class="op" id="8208248">.</span><span class="ident" id="8208249">Kill</span><span class="op" id="8208253">(</span><span class="ident" id="8208254">syscall</span><span class="op" id="8208261">.</span><span class="ident" id="8208262">Getpid</span><span class="op" id="8208268">(</span><span class="op" id="8208269">)</span><span class="op" id="8208270">,</span>&nbsp;<span class="ident" id="8208272">syscall</span><span class="op" id="8208279">.</span><span class="ident" id="8208280">SIGWINCH</span><span class="op" id="8208288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208291">waitSig</span><span class="op" id="8208298">(</span><span class="ident" id="8208299">t</span><span class="op" id="8208300">,</span>&nbsp;<span class="ident" id="8208302">c1</span><span class="op" id="8208304">,</span>&nbsp;<span class="ident" id="8208306">syscall</span><span class="op" id="8208313">.</span><span class="ident" id="8208314">SIGWINCH</span><span class="op" id="8208322">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208326">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208371">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208421">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208459">t</span><span class="op" id="8208460">.</span><span class="ident" id="8208461">Logf</span><span class="op" id="8208465">(</span><span class="string" id="8208466">&#34;sighup...&#34;</span><span class="op" id="8208477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208480">syscall</span><span class="op" id="8208487">.</span><span class="ident" id="8208488">Kill</span><span class="op" id="8208492">(</span><span class="ident" id="8208493">syscall</span><span class="op" id="8208500">.</span><span class="ident" id="8208501">Getpid</span><span class="op" id="8208507">(</span><span class="op" id="8208508">)</span><span class="op" id="8208509">,</span>&nbsp;<span class="ident" id="8208511">syscall</span><span class="op" id="8208518">.</span><span class="ident" id="8208519">SIGHUP</span><span class="op" id="8208525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208528">waitSig</span><span class="op" id="8208535">(</span><span class="ident" id="8208536">t</span><span class="op" id="8208537">,</span>&nbsp;<span class="ident" id="8208539">c1</span><span class="op" id="8208541">,</span>&nbsp;<span class="ident" id="8208543">syscall</span><span class="op" id="8208550">.</span><span class="ident" id="8208551">SIGHUP</span><span class="op" id="8208557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208560">t</span><span class="op" id="8208561">.</span><span class="ident" id="8208562">Logf</span><span class="op" id="8208566">(</span><span class="string" id="8208567">&#34;sighup...&#34;</span><span class="op" id="8208578">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208581">syscall</span><span class="op" id="8208588">.</span><span class="ident" id="8208589">Kill</span><span class="op" id="8208593">(</span><span class="ident" id="8208594">syscall</span><span class="op" id="8208601">.</span><span class="ident" id="8208602">Getpid</span><span class="op" id="8208608">(</span><span class="op" id="8208609">)</span><span class="op" id="8208610">,</span>&nbsp;<span class="ident" id="8208612">syscall</span><span class="op" id="8208619">.</span><span class="ident" id="8208620">SIGHUP</span><span class="op" id="8208626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208629">waitSig</span><span class="op" id="8208636">(</span><span class="ident" id="8208637">t</span><span class="op" id="8208638">,</span>&nbsp;<span class="ident" id="8208640">c1</span><span class="op" id="8208642">,</span>&nbsp;<span class="ident" id="8208644">syscall</span><span class="op" id="8208651">.</span><span class="ident" id="8208652">SIGHUP</span><span class="op" id="8208658">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8208662">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208714">waitSig</span><span class="op" id="8208721">(</span><span class="ident" id="8208722">t</span><span class="op" id="8208723">,</span>&nbsp;<span class="ident" id="8208725">c</span><span class="op" id="8208726">,</span>&nbsp;<span class="ident" id="8208728">syscall</span><span class="op" id="8208735">.</span><span class="ident" id="8208736">SIGHUP</span><span class="op" id="8208742">)</span><br>
<span class="lineno">65</span><span class="op" id="8208744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8208747">func</span>&nbsp;<span class="ident" id="8208752">TestStress</span><span class="op" id="8208762">(</span><span class="ident" id="8208763">t</span>&nbsp;<span class="op" id="8208765">*</span><span class="ident" id="8208766">testing</span><span class="op" id="8208773">.</span><span class="ident" id="8208774">T</span><span class="op" id="8208775">)</span>&nbsp;<span class="op" id="8208777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208780">dur</span>&nbsp;<span class="op" id="8208784">:=</span>&nbsp;<span class="num" id="8208787">3</span>&nbsp;<span class="op" id="8208789">*</span>&nbsp;<span class="ident" id="8208791">time</span><span class="op" id="8208795">.</span><span class="ident" id="8208796">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208804">if</span>&nbsp;<span class="ident" id="8208807">testing</span><span class="op" id="8208814">.</span><span class="ident" id="8208815">Short</span><span class="op" id="8208820">(</span><span class="op" id="8208821">)</span>&nbsp;<span class="op" id="8208823">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208827">dur</span>&nbsp;<span class="op" id="8208831">=</span>&nbsp;<span class="num" id="8208833">100</span>&nbsp;<span class="op" id="8208837">*</span>&nbsp;<span class="ident" id="8208839">time</span><span class="op" id="8208843">.</span><span class="ident" id="8208844">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8208857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208860">defer</span>&nbsp;<span class="ident" id="8208866">runtime</span><span class="op" id="8208873">.</span><span class="ident" id="8208874">GOMAXPROCS</span><span class="op" id="8208884">(</span><span class="ident" id="8208885">runtime</span><span class="op" id="8208892">.</span><span class="ident" id="8208893">GOMAXPROCS</span><span class="op" id="8208903">(</span><span class="num" id="8208904">4</span><span class="op" id="8208905">)</span><span class="op" id="8208906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208909">done</span>&nbsp;<span class="op" id="8208914">:=</span>&nbsp;<span class="builtinfunc" id="8208917">make</span><span class="op" id="8208921">(</span><span class="keyword" id="8208922">chan</span>&nbsp;<span class="builtintype" id="8208927">bool</span><span class="op" id="8208931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208934">finished</span>&nbsp;<span class="op" id="8208943">:=</span>&nbsp;<span class="builtinfunc" id="8208946">make</span><span class="op" id="8208950">(</span><span class="keyword" id="8208951">chan</span>&nbsp;<span class="builtintype" id="8208956">bool</span><span class="op" id="8208960">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8208963">go</span>&nbsp;<span class="keyword" id="8208966">func</span><span class="op" id="8208970">(</span><span class="op" id="8208971">)</span>&nbsp;<span class="op" id="8208973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8208977">sig</span>&nbsp;<span class="op" id="8208981">:=</span>&nbsp;<span class="builtinfunc" id="8208984">make</span><span class="op" id="8208988">(</span><span class="keyword" id="8208989">chan</span>&nbsp;<span class="ident" id="8208994">os</span><span class="op" id="8208996">.</span><span class="ident" id="8208997">Signal</span><span class="op" id="8209003">,</span>&nbsp;<span class="num" id="8209005">1</span><span class="op" id="8209006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209010">Notify</span><span class="op" id="8209016">(</span><span class="ident" id="8209017">sig</span><span class="op" id="8209020">,</span>&nbsp;<span class="ident" id="8209022">syscall</span><span class="op" id="8209029">.</span><span class="ident" id="8209030">SIGUSR1</span><span class="op" id="8209037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209041">defer</span>&nbsp;<span class="ident" id="8209047">Stop</span><span class="op" id="8209051">(</span><span class="ident" id="8209052">sig</span><span class="op" id="8209055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209058">Loop</span><span class="op" id="8209062">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209066">for</span>&nbsp;<span class="op" id="8209070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209075">select</span>&nbsp;<span class="op" id="8209082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209087">case</span>&nbsp;<span class="op" id="8209092">&lt;-</span><span class="ident" id="8209094">sig</span><span class="op" id="8209097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209102">case</span>&nbsp;<span class="op" id="8209107">&lt;-</span><span class="ident" id="8209109">done</span><span class="op" id="8209113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209119">break</span>&nbsp;<span class="ident" id="8209125">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209141">finished</span>&nbsp;<span class="op" id="8209150">&lt;-</span>&nbsp;<span class="builtintype" id="8209153">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209159">}</span><span class="op" id="8209160">(</span><span class="op" id="8209161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209164">go</span>&nbsp;<span class="keyword" id="8209167">func</span><span class="op" id="8209171">(</span><span class="op" id="8209172">)</span>&nbsp;<span class="op" id="8209174">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209177">Loop</span><span class="op" id="8209181">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209185">for</span>&nbsp;<span class="op" id="8209189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209194">select</span>&nbsp;<span class="op" id="8209201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209206">case</span>&nbsp;<span class="op" id="8209211">&lt;-</span><span class="ident" id="8209213">done</span><span class="op" id="8209217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209223">break</span>&nbsp;<span class="ident" id="8209229">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209237">default</span><span class="op" id="8209244">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209250">syscall</span><span class="op" id="8209257">.</span><span class="ident" id="8209258">Kill</span><span class="op" id="8209262">(</span><span class="ident" id="8209263">syscall</span><span class="op" id="8209270">.</span><span class="ident" id="8209271">Getpid</span><span class="op" id="8209277">(</span><span class="op" id="8209278">)</span><span class="op" id="8209279">,</span>&nbsp;<span class="ident" id="8209281">syscall</span><span class="op" id="8209288">.</span><span class="ident" id="8209289">SIGUSR1</span><span class="op" id="8209296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209302">runtime</span><span class="op" id="8209309">.</span><span class="ident" id="8209310">Gosched</span><span class="op" id="8209317">(</span><span class="op" id="8209318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209327">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209331">finished</span>&nbsp;<span class="op" id="8209340">&lt;-</span>&nbsp;<span class="builtintype" id="8209343">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209349">}</span><span class="op" id="8209350">(</span><span class="op" id="8209351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209354">time</span><span class="op" id="8209358">.</span><span class="ident" id="8209359">Sleep</span><span class="op" id="8209364">(</span><span class="ident" id="8209365">dur</span><span class="op" id="8209368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8209371">close</span><span class="op" id="8209376">(</span><span class="ident" id="8209377">done</span><span class="op" id="8209381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209384">&lt;-</span><span class="ident" id="8209386">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209396">&lt;-</span><span class="ident" id="8209398">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209408">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209479">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209529">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209593">time</span><span class="op" id="8209597">.</span><span class="ident" id="8209598">Sleep</span><span class="op" id="8209603">(</span><span class="num" id="8209604">10</span>&nbsp;<span class="op" id="8209607">*</span>&nbsp;<span class="ident" id="8209609">time</span><span class="op" id="8209613">.</span><span class="ident" id="8209614">Millisecond</span><span class="op" id="8209625">)</span><br>
<span class="lineno">110</span><span class="op" id="8209627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8209630">var</span>&nbsp;<span class="ident" id="8209634">sendUncaughtSighup</span>&nbsp;<span class="op" id="8209653">=</span>&nbsp;<span class="ident" id="8209655">flag</span><span class="op" id="8209659">.</span><span class="ident" id="8209660">Int</span><span class="op" id="8209663">(</span><span class="string" id="8209664">&#34;send_uncaught_sighup&#34;</span><span class="op" id="8209686">,</span>&nbsp;<span class="num" id="8209688">0</span><span class="op" id="8209689">,</span>&nbsp;<span class="string" id="8209691">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="8209729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8209732">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="8209787">func</span>&nbsp;<span class="ident" id="8209792">TestStop</span><span class="op" id="8209800">(</span><span class="ident" id="8209801">t</span>&nbsp;<span class="op" id="8209803">*</span><span class="ident" id="8209804">testing</span><span class="op" id="8209811">.</span><span class="ident" id="8209812">T</span><span class="op" id="8209813">)</span>&nbsp;<span class="op" id="8209815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209818">sigs</span>&nbsp;<span class="op" id="8209823">:=</span>&nbsp;<span class="op" id="8209826">[</span><span class="op" id="8209827">]</span><span class="ident" id="8209828">syscall</span><span class="op" id="8209835">.</span><span class="ident" id="8209836">Signal</span><span class="op" id="8209842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209846">syscall</span><span class="op" id="8209853">.</span><span class="ident" id="8209854">SIGWINCH</span><span class="op" id="8209862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8209866">syscall</span><span class="op" id="8209873">.</span><span class="ident" id="8209874">SIGHUP</span><span class="op" id="8209880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8209883">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8209887">for</span>&nbsp;<span class="ident" id="8209891">_</span><span class="op" id="8209892">,</span>&nbsp;<span class="ident" id="8209894">sig</span>&nbsp;<span class="op" id="8209898">:=</span>&nbsp;<span class="keyword" id="8209901">range</span>&nbsp;<span class="ident" id="8209907">sigs</span>&nbsp;<span class="op" id="8209912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209916">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209938">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8209983">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210054">if</span>&nbsp;<span class="ident" id="8210057">sig</span>&nbsp;<span class="op" id="8210061">!=</span>&nbsp;<span class="ident" id="8210064">syscall</span><span class="op" id="8210071">.</span><span class="ident" id="8210072">SIGHUP</span>&nbsp;<span class="op" id="8210079">||</span>&nbsp;<span class="op" id="8210082">*</span><span class="ident" id="8210083">sendUncaughtSighup</span>&nbsp;<span class="op" id="8210102">==</span>&nbsp;<span class="num" id="8210105">1</span>&nbsp;<span class="op" id="8210107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210112">syscall</span><span class="op" id="8210119">.</span><span class="ident" id="8210120">Kill</span><span class="op" id="8210124">(</span><span class="ident" id="8210125">syscall</span><span class="op" id="8210132">.</span><span class="ident" id="8210133">Getpid</span><span class="op" id="8210139">(</span><span class="op" id="8210140">)</span><span class="op" id="8210141">,</span>&nbsp;<span class="ident" id="8210143">sig</span><span class="op" id="8210146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210154">time</span><span class="op" id="8210158">.</span><span class="ident" id="8210159">Sleep</span><span class="op" id="8210164">(</span><span class="num" id="8210165">100</span>&nbsp;<span class="op" id="8210169">*</span>&nbsp;<span class="ident" id="8210171">time</span><span class="op" id="8210175">.</span><span class="ident" id="8210176">Millisecond</span><span class="op" id="8210187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210192">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210212">c</span>&nbsp;<span class="op" id="8210214">:=</span>&nbsp;<span class="builtinfunc" id="8210217">make</span><span class="op" id="8210221">(</span><span class="keyword" id="8210222">chan</span>&nbsp;<span class="ident" id="8210227">os</span><span class="op" id="8210229">.</span><span class="ident" id="8210230">Signal</span><span class="op" id="8210236">,</span>&nbsp;<span class="num" id="8210238">1</span><span class="op" id="8210239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210243">Notify</span><span class="op" id="8210249">(</span><span class="ident" id="8210250">c</span><span class="op" id="8210251">,</span>&nbsp;<span class="ident" id="8210253">sig</span><span class="op" id="8210256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210260">defer</span>&nbsp;<span class="ident" id="8210266">Stop</span><span class="op" id="8210270">(</span><span class="ident" id="8210271">c</span><span class="op" id="8210272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210277">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210312">syscall</span><span class="op" id="8210319">.</span><span class="ident" id="8210320">Kill</span><span class="op" id="8210324">(</span><span class="ident" id="8210325">syscall</span><span class="op" id="8210332">.</span><span class="ident" id="8210333">Getpid</span><span class="op" id="8210339">(</span><span class="op" id="8210340">)</span><span class="op" id="8210341">,</span>&nbsp;<span class="ident" id="8210343">sig</span><span class="op" id="8210346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210350">waitSig</span><span class="op" id="8210357">(</span><span class="ident" id="8210358">t</span><span class="op" id="8210359">,</span>&nbsp;<span class="ident" id="8210361">c</span><span class="op" id="8210362">,</span>&nbsp;<span class="ident" id="8210364">sig</span><span class="op" id="8210367">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210372">Stop</span><span class="op" id="8210376">(</span><span class="ident" id="8210377">c</span><span class="op" id="8210378">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210382">select</span>&nbsp;<span class="op" id="8210389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210393">case</span>&nbsp;<span class="ident" id="8210398">s</span>&nbsp;<span class="op" id="8210400">:=</span>&nbsp;<span class="op" id="8210403">&lt;-</span><span class="ident" id="8210405">c</span><span class="op" id="8210406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210411">t</span><span class="op" id="8210412">.</span><span class="ident" id="8210413">Fatalf</span><span class="op" id="8210419">(</span><span class="string" id="8210420">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8210442">,</span>&nbsp;<span class="ident" id="8210444">s</span><span class="op" id="8210445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210449">case</span>&nbsp;<span class="op" id="8210454">&lt;-</span><span class="ident" id="8210456">time</span><span class="op" id="8210460">.</span><span class="ident" id="8210461">After</span><span class="op" id="8210466">(</span><span class="num" id="8210467">100</span>&nbsp;<span class="op" id="8210471">*</span>&nbsp;<span class="ident" id="8210473">time</span><span class="op" id="8210477">.</span><span class="ident" id="8210478">Millisecond</span><span class="op" id="8210489">)</span><span class="op" id="8210490">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210495">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210528">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210550">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210595">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210666">if</span>&nbsp;<span class="ident" id="8210669">sig</span>&nbsp;<span class="op" id="8210673">!=</span>&nbsp;<span class="ident" id="8210676">syscall</span><span class="op" id="8210683">.</span><span class="ident" id="8210684">SIGHUP</span>&nbsp;<span class="op" id="8210691">||</span>&nbsp;<span class="op" id="8210694">*</span><span class="ident" id="8210695">sendUncaughtSighup</span>&nbsp;<span class="op" id="8210714">==</span>&nbsp;<span class="num" id="8210717">2</span>&nbsp;<span class="op" id="8210719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210724">syscall</span><span class="op" id="8210731">.</span><span class="ident" id="8210732">Kill</span><span class="op" id="8210736">(</span><span class="ident" id="8210737">syscall</span><span class="op" id="8210744">.</span><span class="ident" id="8210745">Getpid</span><span class="op" id="8210751">(</span><span class="op" id="8210752">)</span><span class="op" id="8210753">,</span>&nbsp;<span class="ident" id="8210755">sig</span><span class="op" id="8210758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210767">select</span>&nbsp;<span class="op" id="8210774">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210778">case</span>&nbsp;<span class="ident" id="8210783">s</span>&nbsp;<span class="op" id="8210785">:=</span>&nbsp;<span class="op" id="8210788">&lt;-</span><span class="ident" id="8210790">c</span><span class="op" id="8210791">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8210796">t</span><span class="op" id="8210797">.</span><span class="ident" id="8210798">Fatalf</span><span class="op" id="8210804">(</span><span class="string" id="8210805">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="8210827">,</span>&nbsp;<span class="ident" id="8210829">s</span><span class="op" id="8210830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8210834">case</span>&nbsp;<span class="op" id="8210839">&lt;-</span><span class="ident" id="8210841">time</span><span class="op" id="8210845">.</span><span class="ident" id="8210846">After</span><span class="op" id="8210851">(</span><span class="num" id="8210852">100</span>&nbsp;<span class="op" id="8210856">*</span>&nbsp;<span class="ident" id="8210858">time</span><span class="op" id="8210862">.</span><span class="ident" id="8210863">Millisecond</span><span class="op" id="8210874">)</span><span class="op" id="8210875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8210880">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210908">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8210911">}</span><br>
<span class="lineno"></span><span class="op" id="8210913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8210916">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="8210997">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="8211006">func</span>&nbsp;<span class="ident" id="8211011">TestNohup</span><span class="op" id="8211020">(</span><span class="ident" id="8211021">t</span>&nbsp;<span class="op" id="8211023">*</span><span class="ident" id="8211024">testing</span><span class="op" id="8211031">.</span><span class="ident" id="8211032">T</span><span class="op" id="8211033">)</span>&nbsp;<span class="op" id="8211035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211038">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211102">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211155">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211199">c</span>&nbsp;<span class="op" id="8211201">:=</span>&nbsp;<span class="builtinfunc" id="8211204">make</span><span class="op" id="8211208">(</span><span class="keyword" id="8211209">chan</span>&nbsp;<span class="ident" id="8211214">os</span><span class="op" id="8211216">.</span><span class="ident" id="8211217">Signal</span><span class="op" id="8211223">,</span>&nbsp;<span class="num" id="8211225">1</span><span class="op" id="8211226">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211229">Notify</span><span class="op" id="8211235">(</span><span class="ident" id="8211236">c</span><span class="op" id="8211237">,</span>&nbsp;<span class="ident" id="8211239">syscall</span><span class="op" id="8211246">.</span><span class="ident" id="8211247">SIGHUP</span><span class="op" id="8211253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211257">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211330">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211397">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211463">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211542">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211620">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211624">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211707">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211790">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8211794">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8211854">for</span>&nbsp;<span class="ident" id="8211858">i</span>&nbsp;<span class="op" id="8211860">:=</span>&nbsp;<span class="num" id="8211863">1</span><span class="op" id="8211864">;</span>&nbsp;<span class="ident" id="8211866">i</span>&nbsp;<span class="op" id="8211868">&lt;=</span>&nbsp;<span class="num" id="8211871">2</span><span class="op" id="8211872">;</span>&nbsp;<span class="ident" id="8211874">i</span><span class="op" id="8211875">++</span>&nbsp;<span class="op" id="8211878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8211882">out</span><span class="op" id="8211885">,</span>&nbsp;<span class="ident" id="8211887">err</span>&nbsp;<span class="op" id="8211891">:=</span>&nbsp;<span class="ident" id="8211894">exec</span><span class="op" id="8211898">.</span><span class="ident" id="8211899">Command</span><span class="op" id="8211906">(</span><span class="ident" id="8211907">os</span><span class="op" id="8211909">.</span><span class="ident" id="8211910">Args</span><span class="op" id="8211914">[</span><span class="num" id="8211915">0</span><span class="op" id="8211916">]</span><span class="op" id="8211917">,</span>&nbsp;<span class="string" id="8211919">&#34;-test.run=TestStop&#34;</span><span class="op" id="8211939">,</span>&nbsp;<span class="string" id="8211941">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8211965">+</span><span class="ident" id="8211966">strconv</span><span class="op" id="8211973">.</span><span class="ident" id="8211974">Itoa</span><span class="op" id="8211978">(</span><span class="ident" id="8211979">i</span><span class="op" id="8211980">)</span><span class="op" id="8211981">)</span><span class="op" id="8211982">.</span><span class="ident" id="8211983">CombinedOutput</span><span class="op" id="8211997">(</span><span class="op" id="8211998">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212002">if</span>&nbsp;<span class="ident" id="8212005">err</span>&nbsp;<span class="op" id="8212009">==</span>&nbsp;<span class="ident" id="8212012">nil</span>&nbsp;<span class="op" id="8212016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212021">t</span><span class="op" id="8212022">.</span><span class="ident" id="8212023">Fatalf</span><span class="op" id="8212029">(</span><span class="string" id="8212030">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="8212119">,</span>&nbsp;<span class="ident" id="8212121">i</span><span class="op" id="8212122">,</span>&nbsp;<span class="ident" id="8212124">out</span><span class="op" id="8212127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212138">Stop</span><span class="op" id="8212142">(</span><span class="ident" id="8212143">c</span><span class="op" id="8212144">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8212148">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212206">_</span><span class="op" id="8212207">,</span>&nbsp;<span class="ident" id="8212209">err</span>&nbsp;<span class="op" id="8212213">:=</span>&nbsp;<span class="ident" id="8212216">os</span><span class="op" id="8212218">.</span><span class="ident" id="8212219">Stat</span><span class="op" id="8212223">(</span><span class="string" id="8212224">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8212240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212243">if</span>&nbsp;<span class="ident" id="8212246">err</span>&nbsp;<span class="op" id="8212250">!=</span>&nbsp;<span class="ident" id="8212253">nil</span>&nbsp;<span class="op" id="8212257">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212261">t</span><span class="op" id="8212262">.</span><span class="ident" id="8212263">Skip</span><span class="op" id="8212267">(</span><span class="string" id="8212268">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="8212317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212324">for</span>&nbsp;<span class="ident" id="8212328">i</span>&nbsp;<span class="op" id="8212330">:=</span>&nbsp;<span class="num" id="8212333">1</span><span class="op" id="8212334">;</span>&nbsp;<span class="ident" id="8212336">i</span>&nbsp;<span class="op" id="8212338">&lt;=</span>&nbsp;<span class="num" id="8212341">2</span><span class="op" id="8212342">;</span>&nbsp;<span class="ident" id="8212344">i</span><span class="op" id="8212345">++</span>&nbsp;<span class="op" id="8212348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212352">os</span><span class="op" id="8212354">.</span><span class="ident" id="8212355">Remove</span><span class="op" id="8212361">(</span><span class="string" id="8212362">&#34;nohup.out&#34;</span><span class="op" id="8212373">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212377">out</span><span class="op" id="8212380">,</span>&nbsp;<span class="ident" id="8212382">err</span>&nbsp;<span class="op" id="8212386">:=</span>&nbsp;<span class="ident" id="8212389">exec</span><span class="op" id="8212393">.</span><span class="ident" id="8212394">Command</span><span class="op" id="8212401">(</span><span class="string" id="8212402">&#34;/usr/bin/nohup&#34;</span><span class="op" id="8212418">,</span>&nbsp;<span class="ident" id="8212420">os</span><span class="op" id="8212422">.</span><span class="ident" id="8212423">Args</span><span class="op" id="8212427">[</span><span class="num" id="8212428">0</span><span class="op" id="8212429">]</span><span class="op" id="8212430">,</span>&nbsp;<span class="string" id="8212432">&#34;-test.run=TestStop&#34;</span><span class="op" id="8212452">,</span>&nbsp;<span class="string" id="8212454">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="8212478">+</span><span class="ident" id="8212479">strconv</span><span class="op" id="8212486">.</span><span class="ident" id="8212487">Itoa</span><span class="op" id="8212491">(</span><span class="ident" id="8212492">i</span><span class="op" id="8212493">)</span><span class="op" id="8212494">)</span><span class="op" id="8212495">.</span><span class="ident" id="8212496">CombinedOutput</span><span class="op" id="8212510">(</span><span class="op" id="8212511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212516">data</span><span class="op" id="8212520">,</span>&nbsp;<span class="ident" id="8212522">_</span>&nbsp;<span class="op" id="8212524">:=</span>&nbsp;<span class="ident" id="8212527">ioutil</span><span class="op" id="8212533">.</span><span class="ident" id="8212534">ReadFile</span><span class="op" id="8212542">(</span><span class="string" id="8212543">&#34;nohup.out&#34;</span><span class="op" id="8212554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212558">os</span><span class="op" id="8212560">.</span><span class="ident" id="8212561">Remove</span><span class="op" id="8212567">(</span><span class="string" id="8212568">&#34;nohup.out&#34;</span><span class="op" id="8212579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8212583">if</span>&nbsp;<span class="ident" id="8212586">err</span>&nbsp;<span class="op" id="8212590">!=</span>&nbsp;<span class="ident" id="8212593">nil</span>&nbsp;<span class="op" id="8212597">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8212602">t</span><span class="op" id="8212603">.</span><span class="ident" id="8212604">Fatalf</span><span class="op" id="8212610">(</span><span class="string" id="8212611">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="8212722">,</span>&nbsp;<span class="ident" id="8212724">i</span><span class="op" id="8212725">,</span>&nbsp;<span class="ident" id="8212727">err</span><span class="op" id="8212730">,</span>&nbsp;<span class="ident" id="8212732">out</span><span class="op" id="8212735">,</span>&nbsp;<span class="ident" id="8212737">data</span><span class="op" id="8212741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8212748">}</span><br>
<span class="lineno"></span><span class="op" id="8212750">}</span>
</div>
</body>
</html>
