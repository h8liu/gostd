<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1540119">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1540174">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1540228">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1540279">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1540314">package</span>&nbsp;<span class="ident" id="1540322">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1540331">import</span>&nbsp;<span class="string" id="1540338">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1540348">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1540413">//</span><br>
<span class="lineno"></span><span class="comment" id="1540416">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1540475">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1540491">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1540519">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1540569">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1540623">//</span><br>
<span class="lineno"></span><span class="comment" id="1540626">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1540676">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1540737">const</span>&nbsp;<span class="op" id="1540743">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540746">mutex_unlocked</span>&nbsp;<span class="op" id="1540761">=</span>&nbsp;<span class="num" id="1540763">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540766">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1540781">=</span>&nbsp;<span class="num" id="1540783">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540786">mutex_sleeping</span>&nbsp;<span class="op" id="1540801">=</span>&nbsp;<span class="num" id="1540803">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540807">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540823">=</span>&nbsp;<span class="num" id="1540825">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540828">active_spin_cnt</span>&nbsp;<span class="op" id="1540844">=</span>&nbsp;<span class="num" id="1540846">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540850">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540866">=</span>&nbsp;<span class="num" id="1540868">1</span><br>
<span class="lineno">30</span><span class="op" id="1540870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1540873">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1540950">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1541029">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1541104">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1541130">func</span>&nbsp;<span class="ident" id="1541135">futexsleep</span><span class="op" id="1541145">(</span><span class="ident" id="1541146">addr</span>&nbsp;<span class="op" id="1541151">*</span><span class="builtintype" id="1541152">uint32</span><span class="op" id="1541158">,</span>&nbsp;<span class="ident" id="1541160">val</span>&nbsp;<span class="builtintype" id="1541164">uint32</span><span class="op" id="1541170">,</span>&nbsp;<span class="ident" id="1541172">ns</span>&nbsp;<span class="ident" id="1541175">int64</span><span class="op" id="1541180">)</span><br>
<span class="lineno"></span><span class="keyword" id="1541182">func</span>&nbsp;<span class="ident" id="1541187">futexwakeup</span><span class="op" id="1541198">(</span><span class="ident" id="1541199">addr</span>&nbsp;<span class="op" id="1541204">*</span><span class="builtintype" id="1541205">uint32</span><span class="op" id="1541211">,</span>&nbsp;<span class="ident" id="1541213">cnt</span>&nbsp;<span class="builtintype" id="1541217">uint32</span><span class="op" id="1541223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1541226">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1541284">func</span>&nbsp;<span class="ident" id="1541289">key32</span><span class="op" id="1541294">(</span><span class="ident" id="1541295">p</span>&nbsp;<span class="op" id="1541297">*</span><span class="builtintype" id="1541298">uintptr</span><span class="op" id="1541305">)</span>&nbsp;<span class="op" id="1541307">*</span><span class="builtintype" id="1541308">uint32</span>&nbsp;<span class="op" id="1541315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541318">return</span>&nbsp;<span class="op" id="1541325">(</span><span class="op" id="1541326">*</span><span class="builtintype" id="1541327">uint32</span><span class="op" id="1541333">)</span><span class="op" id="1541334">(</span><span class="ident" id="1541335">unsafe</span><span class="op" id="1541341">.</span><span class="ident" id="1541342">Pointer</span><span class="op" id="1541349">(</span><span class="ident" id="1541350">p</span><span class="op" id="1541351">)</span><span class="op" id="1541352">)</span><br>
<span class="lineno"></span><span class="op" id="1541354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1541357">func</span>&nbsp;<span class="ident" id="1541362">lock</span><span class="op" id="1541366">(</span><span class="ident" id="1541367">l</span>&nbsp;<span class="op" id="1541369">*</span><span class="ident" id="1541370">mutex</span><span class="op" id="1541375">)</span>&nbsp;<span class="op" id="1541377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541380">gp</span>&nbsp;<span class="op" id="1541383">:=</span>&nbsp;<span class="ident" id="1541386">getg</span><span class="op" id="1541390">(</span><span class="op" id="1541391">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541395">if</span>&nbsp;<span class="ident" id="1541398">gp</span><span class="op" id="1541400">.</span><span class="ident" id="1541401">m</span><span class="op" id="1541402">.</span><span class="ident" id="1541403">locks</span>&nbsp;<span class="op" id="1541409">&lt;</span>&nbsp;<span class="num" id="1541411">0</span>&nbsp;<span class="op" id="1541413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541417">gothrow</span><span class="op" id="1541424">(</span><span class="string" id="1541425">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1541452">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541458">gp</span><span class="op" id="1541460">.</span><span class="ident" id="1541461">m</span><span class="op" id="1541462">.</span><span class="ident" id="1541463">locks</span><span class="op" id="1541468">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541473">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541504">v</span>&nbsp;<span class="op" id="1541506">:=</span>&nbsp;<span class="ident" id="1541509">xchg</span><span class="op" id="1541513">(</span><span class="ident" id="1541514">key32</span><span class="op" id="1541519">(</span><span class="op" id="1541520">&amp;</span><span class="ident" id="1541521">l</span><span class="op" id="1541522">.</span><span class="ident" id="1541523">key</span><span class="op" id="1541526">)</span><span class="op" id="1541527">,</span>&nbsp;<span class="ident" id="1541529">mutex_locked</span><span class="op" id="1541541">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541544">if</span>&nbsp;<span class="ident" id="1541547">v</span>&nbsp;<span class="op" id="1541549">==</span>&nbsp;<span class="ident" id="1541552">mutex_unlocked</span>&nbsp;<span class="op" id="1541567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541571">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541583">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541633">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541685">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541735">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541786">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541841">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541896">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541917">wait</span>&nbsp;<span class="op" id="1541922">:=</span>&nbsp;<span class="ident" id="1541925">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541929">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1541970">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542025">spin</span>&nbsp;<span class="op" id="1542030">:=</span>&nbsp;<span class="num" id="1542033">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542036">if</span>&nbsp;<span class="ident" id="1542039">ncpu</span>&nbsp;<span class="op" id="1542044">&gt;</span>&nbsp;<span class="num" id="1542046">1</span>&nbsp;<span class="op" id="1542048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542052">spin</span>&nbsp;<span class="op" id="1542057">=</span>&nbsp;<span class="ident" id="1542059">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542075">for</span>&nbsp;<span class="op" id="1542079">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542083">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542112">for</span>&nbsp;<span class="ident" id="1542116">i</span>&nbsp;<span class="op" id="1542118">:=</span>&nbsp;<span class="num" id="1542121">0</span><span class="op" id="1542122">;</span>&nbsp;<span class="ident" id="1542124">i</span>&nbsp;<span class="op" id="1542126">&lt;</span>&nbsp;<span class="ident" id="1542128">spin</span><span class="op" id="1542132">;</span>&nbsp;<span class="ident" id="1542134">i</span><span class="op" id="1542135">++</span>&nbsp;<span class="op" id="1542138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542143">for</span>&nbsp;<span class="ident" id="1542147">l</span><span class="op" id="1542148">.</span><span class="ident" id="1542149">key</span>&nbsp;<span class="op" id="1542153">==</span>&nbsp;<span class="ident" id="1542156">mutex_unlocked</span>&nbsp;<span class="op" id="1542171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542177">if</span>&nbsp;<span class="ident" id="1542180">cas</span><span class="op" id="1542183">(</span><span class="ident" id="1542184">key32</span><span class="op" id="1542189">(</span><span class="op" id="1542190">&amp;</span><span class="ident" id="1542191">l</span><span class="op" id="1542192">.</span><span class="ident" id="1542193">key</span><span class="op" id="1542196">)</span><span class="op" id="1542197">,</span>&nbsp;<span class="ident" id="1542199">mutex_unlocked</span><span class="op" id="1542213">,</span>&nbsp;<span class="ident" id="1542215">wait</span><span class="op" id="1542219">)</span>&nbsp;<span class="op" id="1542221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542228">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542249">procyield</span><span class="op" id="1542258">(</span><span class="ident" id="1542259">active_spin_cnt</span><span class="op" id="1542274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542283">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542316">for</span>&nbsp;<span class="ident" id="1542320">i</span>&nbsp;<span class="op" id="1542322">:=</span>&nbsp;<span class="num" id="1542325">0</span><span class="op" id="1542326">;</span>&nbsp;<span class="ident" id="1542328">i</span>&nbsp;<span class="op" id="1542330">&lt;</span>&nbsp;<span class="ident" id="1542332">passive_spin</span><span class="op" id="1542344">;</span>&nbsp;<span class="ident" id="1542346">i</span><span class="op" id="1542347">++</span>&nbsp;<span class="op" id="1542350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542355">for</span>&nbsp;<span class="ident" id="1542359">l</span><span class="op" id="1542360">.</span><span class="ident" id="1542361">key</span>&nbsp;<span class="op" id="1542365">==</span>&nbsp;<span class="ident" id="1542368">mutex_unlocked</span>&nbsp;<span class="op" id="1542383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542389">if</span>&nbsp;<span class="ident" id="1542392">cas</span><span class="op" id="1542395">(</span><span class="ident" id="1542396">key32</span><span class="op" id="1542401">(</span><span class="op" id="1542402">&amp;</span><span class="ident" id="1542403">l</span><span class="op" id="1542404">.</span><span class="ident" id="1542405">key</span><span class="op" id="1542408">)</span><span class="op" id="1542409">,</span>&nbsp;<span class="ident" id="1542411">mutex_unlocked</span><span class="op" id="1542425">,</span>&nbsp;<span class="ident" id="1542427">wait</span><span class="op" id="1542431">)</span>&nbsp;<span class="op" id="1542433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542440">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542461">osyield</span><span class="op" id="1542468">(</span><span class="op" id="1542469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1542478">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542490">v</span>&nbsp;<span class="op" id="1542492">=</span>&nbsp;<span class="ident" id="1542494">xchg</span><span class="op" id="1542498">(</span><span class="ident" id="1542499">key32</span><span class="op" id="1542504">(</span><span class="op" id="1542505">&amp;</span><span class="ident" id="1542506">l</span><span class="op" id="1542507">.</span><span class="ident" id="1542508">key</span><span class="op" id="1542511">)</span><span class="op" id="1542512">,</span>&nbsp;<span class="ident" id="1542514">mutex_sleeping</span><span class="op" id="1542528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542532">if</span>&nbsp;<span class="ident" id="1542535">v</span>&nbsp;<span class="op" id="1542537">==</span>&nbsp;<span class="ident" id="1542540">mutex_unlocked</span>&nbsp;<span class="op" id="1542555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542560">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542569">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542573">wait</span>&nbsp;<span class="op" id="1542578">=</span>&nbsp;<span class="ident" id="1542580">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542597">futexsleep</span><span class="op" id="1542607">(</span><span class="ident" id="1542608">key32</span><span class="op" id="1542613">(</span><span class="op" id="1542614">&amp;</span><span class="ident" id="1542615">l</span><span class="op" id="1542616">.</span><span class="ident" id="1542617">key</span><span class="op" id="1542620">)</span><span class="op" id="1542621">,</span>&nbsp;<span class="ident" id="1542623">mutex_sleeping</span><span class="op" id="1542637">,</span>&nbsp;<span class="op" id="1542639">-</span><span class="num" id="1542640">1</span><span class="op" id="1542641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542644">}</span><br>
<span class="lineno"></span><span class="op" id="1542646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1542649">func</span>&nbsp;<span class="ident" id="1542654">unlock</span><span class="op" id="1542660">(</span><span class="ident" id="1542661">l</span>&nbsp;<span class="op" id="1542663">*</span><span class="ident" id="1542664">mutex</span><span class="op" id="1542669">)</span>&nbsp;<span class="op" id="1542671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542674">v</span>&nbsp;<span class="op" id="1542676">:=</span>&nbsp;<span class="ident" id="1542679">xchg</span><span class="op" id="1542683">(</span><span class="ident" id="1542684">key32</span><span class="op" id="1542689">(</span><span class="op" id="1542690">&amp;</span><span class="ident" id="1542691">l</span><span class="op" id="1542692">.</span><span class="ident" id="1542693">key</span><span class="op" id="1542696">)</span><span class="op" id="1542697">,</span>&nbsp;<span class="ident" id="1542699">mutex_unlocked</span><span class="op" id="1542713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542716">if</span>&nbsp;<span class="ident" id="1542719">v</span>&nbsp;<span class="op" id="1542721">==</span>&nbsp;<span class="ident" id="1542724">mutex_unlocked</span>&nbsp;<span class="op" id="1542739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542743">gothrow</span><span class="op" id="1542750">(</span><span class="string" id="1542751">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1542776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542779">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542782">if</span>&nbsp;<span class="ident" id="1542785">v</span>&nbsp;<span class="op" id="1542787">==</span>&nbsp;<span class="ident" id="1542790">mutex_sleeping</span>&nbsp;<span class="op" id="1542805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542809">futexwakeup</span><span class="op" id="1542820">(</span><span class="ident" id="1542821">key32</span><span class="op" id="1542826">(</span><span class="op" id="1542827">&amp;</span><span class="ident" id="1542828">l</span><span class="op" id="1542829">.</span><span class="ident" id="1542830">key</span><span class="op" id="1542833">)</span><span class="op" id="1542834">,</span>&nbsp;<span class="num" id="1542836">1</span><span class="op" id="1542837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542844">gp</span>&nbsp;<span class="op" id="1542847">:=</span>&nbsp;<span class="ident" id="1542850">getg</span><span class="op" id="1542854">(</span><span class="op" id="1542855">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542858">gp</span><span class="op" id="1542860">.</span><span class="ident" id="1542861">m</span><span class="op" id="1542862">.</span><span class="ident" id="1542863">locks</span><span class="op" id="1542868">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542872">if</span>&nbsp;<span class="ident" id="1542875">gp</span><span class="op" id="1542877">.</span><span class="ident" id="1542878">m</span><span class="op" id="1542879">.</span><span class="ident" id="1542880">locks</span>&nbsp;<span class="op" id="1542886">&lt;</span>&nbsp;<span class="num" id="1542888">0</span>&nbsp;<span class="op" id="1542890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542894">gothrow</span><span class="op" id="1542901">(</span><span class="string" id="1542902">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1542931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542937">if</span>&nbsp;<span class="ident" id="1542940">gp</span><span class="op" id="1542942">.</span><span class="ident" id="1542943">m</span><span class="op" id="1542944">.</span><span class="ident" id="1542945">locks</span>&nbsp;<span class="op" id="1542951">==</span>&nbsp;<span class="num" id="1542954">0</span>&nbsp;<span class="op" id="1542956">&amp;&amp;</span>&nbsp;<span class="ident" id="1542959">gp</span><span class="op" id="1542961">.</span><span class="ident" id="1542962">preempt</span>&nbsp;<span class="op" id="1542970">{</span>&nbsp;<span class="comment" id="1542972">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543045">gp</span><span class="op" id="1543047">.</span><span class="ident" id="1543048">stackguard0</span>&nbsp;<span class="op" id="1543060">=</span>&nbsp;<span class="ident" id="1543062">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543076">}</span><br>
<span class="lineno"></span><span class="op" id="1543078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1543081">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1543108">func</span>&nbsp;<span class="ident" id="1543113">noteclear</span><span class="op" id="1543122">(</span><span class="ident" id="1543123">n</span>&nbsp;<span class="op" id="1543125">*</span><span class="ident" id="1543126">note</span><span class="op" id="1543130">)</span>&nbsp;<span class="op" id="1543132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543135">n</span><span class="op" id="1543136">.</span><span class="ident" id="1543137">key</span>&nbsp;<span class="op" id="1543141">=</span>&nbsp;<span class="num" id="1543143">0</span><br>
<span class="lineno"></span><span class="op" id="1543145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543148">func</span>&nbsp;<span class="ident" id="1543153">notewakeup</span><span class="op" id="1543163">(</span><span class="ident" id="1543164">n</span>&nbsp;<span class="op" id="1543166">*</span><span class="ident" id="1543167">note</span><span class="op" id="1543171">)</span>&nbsp;<span class="op" id="1543173">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543176">old</span>&nbsp;<span class="op" id="1543180">:=</span>&nbsp;<span class="ident" id="1543183">xchg</span><span class="op" id="1543187">(</span><span class="ident" id="1543188">key32</span><span class="op" id="1543193">(</span><span class="op" id="1543194">&amp;</span><span class="ident" id="1543195">n</span><span class="op" id="1543196">.</span><span class="ident" id="1543197">key</span><span class="op" id="1543200">)</span><span class="op" id="1543201">,</span>&nbsp;<span class="num" id="1543203">1</span><span class="op" id="1543204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543207">if</span>&nbsp;<span class="ident" id="1543210">old</span>&nbsp;<span class="op" id="1543214">!=</span>&nbsp;<span class="num" id="1543217">0</span>&nbsp;<span class="op" id="1543219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1543223">print</span><span class="op" id="1543228">(</span><span class="string" id="1543229">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1543259">,</span>&nbsp;<span class="ident" id="1543261">old</span><span class="op" id="1543264">,</span>&nbsp;<span class="string" id="1543266">&#34;)\n&#34;</span><span class="op" id="1543271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543275">gothrow</span><span class="op" id="1543282">(</span><span class="string" id="1543283">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1543311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543314">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543317">futexwakeup</span><span class="op" id="1543328">(</span><span class="ident" id="1543329">key32</span><span class="op" id="1543334">(</span><span class="op" id="1543335">&amp;</span><span class="ident" id="1543336">n</span><span class="op" id="1543337">.</span><span class="ident" id="1543338">key</span><span class="op" id="1543341">)</span><span class="op" id="1543342">,</span>&nbsp;<span class="num" id="1543344">1</span><span class="op" id="1543345">)</span><br>
<span class="lineno"></span><span class="op" id="1543347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543350">func</span>&nbsp;<span class="ident" id="1543355">notesleep</span><span class="op" id="1543364">(</span><span class="ident" id="1543365">n</span>&nbsp;<span class="op" id="1543367">*</span><span class="ident" id="1543368">note</span><span class="op" id="1543372">)</span>&nbsp;<span class="op" id="1543374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543377">gp</span>&nbsp;<span class="op" id="1543380">:=</span>&nbsp;<span class="ident" id="1543383">getg</span><span class="op" id="1543387">(</span><span class="op" id="1543388">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543391">if</span>&nbsp;<span class="ident" id="1543394">gp</span>&nbsp;<span class="op" id="1543397">!=</span>&nbsp;<span class="ident" id="1543400">gp</span><span class="op" id="1543402">.</span><span class="ident" id="1543403">m</span><span class="op" id="1543404">.</span><span class="ident" id="1543405">g0</span>&nbsp;<span class="op" id="1543408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543412">gothrow</span><span class="op" id="1543419">(</span><span class="string" id="1543420">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1543441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543447">for</span>&nbsp;<span class="ident" id="1543451">atomicload</span><span class="op" id="1543461">(</span><span class="ident" id="1543462">key32</span><span class="op" id="1543467">(</span><span class="op" id="1543468">&amp;</span><span class="ident" id="1543469">n</span><span class="op" id="1543470">.</span><span class="ident" id="1543471">key</span><span class="op" id="1543474">)</span><span class="op" id="1543475">)</span>&nbsp;<span class="op" id="1543477">==</span>&nbsp;<span class="num" id="1543480">0</span>&nbsp;<span class="op" id="1543482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543486">gp</span><span class="op" id="1543488">.</span><span class="ident" id="1543489">m</span><span class="op" id="1543490">.</span><span class="ident" id="1543491">blocked</span>&nbsp;<span class="op" id="1543499">=</span>&nbsp;<span class="builtintype" id="1543501">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543508">futexsleep</span><span class="op" id="1543518">(</span><span class="ident" id="1543519">key32</span><span class="op" id="1543524">(</span><span class="op" id="1543525">&amp;</span><span class="ident" id="1543526">n</span><span class="op" id="1543527">.</span><span class="ident" id="1543528">key</span><span class="op" id="1543531">)</span><span class="op" id="1543532">,</span>&nbsp;<span class="num" id="1543534">0</span><span class="op" id="1543535">,</span>&nbsp;<span class="op" id="1543537">-</span><span class="num" id="1543538">1</span><span class="op" id="1543539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543543">gp</span><span class="op" id="1543545">.</span><span class="ident" id="1543546">m</span><span class="op" id="1543547">.</span><span class="ident" id="1543548">blocked</span>&nbsp;<span class="op" id="1543556">=</span>&nbsp;<span class="builtintype" id="1543558">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543565">}</span><br>
<span class="lineno"></span><span class="op" id="1543567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1543570">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1543583">func</span>&nbsp;<span class="ident" id="1543588">notetsleep_internal</span><span class="op" id="1543607">(</span><span class="ident" id="1543608">n</span>&nbsp;<span class="op" id="1543610">*</span><span class="ident" id="1543611">note</span><span class="op" id="1543615">,</span>&nbsp;<span class="ident" id="1543617">ns</span>&nbsp;<span class="ident" id="1543620">int64</span><span class="op" id="1543625">)</span>&nbsp;<span class="builtintype" id="1543627">bool</span>&nbsp;<span class="op" id="1543632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543635">gp</span>&nbsp;<span class="op" id="1543638">:=</span>&nbsp;<span class="ident" id="1543641">getg</span><span class="op" id="1543645">(</span><span class="op" id="1543646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543650">if</span>&nbsp;<span class="ident" id="1543653">ns</span>&nbsp;<span class="op" id="1543656">&lt;</span>&nbsp;<span class="num" id="1543658">0</span>&nbsp;<span class="op" id="1543660">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543664">for</span>&nbsp;<span class="ident" id="1543668">atomicload</span><span class="op" id="1543678">(</span><span class="ident" id="1543679">key32</span><span class="op" id="1543684">(</span><span class="op" id="1543685">&amp;</span><span class="ident" id="1543686">n</span><span class="op" id="1543687">.</span><span class="ident" id="1543688">key</span><span class="op" id="1543691">)</span><span class="op" id="1543692">)</span>&nbsp;<span class="op" id="1543694">==</span>&nbsp;<span class="num" id="1543697">0</span>&nbsp;<span class="op" id="1543699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543704">gp</span><span class="op" id="1543706">.</span><span class="ident" id="1543707">m</span><span class="op" id="1543708">.</span><span class="ident" id="1543709">blocked</span>&nbsp;<span class="op" id="1543717">=</span>&nbsp;<span class="builtintype" id="1543719">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543727">futexsleep</span><span class="op" id="1543737">(</span><span class="ident" id="1543738">key32</span><span class="op" id="1543743">(</span><span class="op" id="1543744">&amp;</span><span class="ident" id="1543745">n</span><span class="op" id="1543746">.</span><span class="ident" id="1543747">key</span><span class="op" id="1543750">)</span><span class="op" id="1543751">,</span>&nbsp;<span class="num" id="1543753">0</span><span class="op" id="1543754">,</span>&nbsp;<span class="op" id="1543756">-</span><span class="num" id="1543757">1</span><span class="op" id="1543758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543763">gp</span><span class="op" id="1543765">.</span><span class="ident" id="1543766">m</span><span class="op" id="1543767">.</span><span class="ident" id="1543768">blocked</span>&nbsp;<span class="op" id="1543776">=</span>&nbsp;<span class="builtintype" id="1543778">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543786">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543790">return</span>&nbsp;<span class="builtintype" id="1543797">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543807">if</span>&nbsp;<span class="ident" id="1543810">atomicload</span><span class="op" id="1543820">(</span><span class="ident" id="1543821">key32</span><span class="op" id="1543826">(</span><span class="op" id="1543827">&amp;</span><span class="ident" id="1543828">n</span><span class="op" id="1543829">.</span><span class="ident" id="1543830">key</span><span class="op" id="1543833">)</span><span class="op" id="1543834">)</span>&nbsp;<span class="op" id="1543836">!=</span>&nbsp;<span class="num" id="1543839">0</span>&nbsp;<span class="op" id="1543841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543845">return</span>&nbsp;<span class="builtintype" id="1543852">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543862">deadline</span>&nbsp;<span class="op" id="1543871">:=</span>&nbsp;<span class="ident" id="1543874">nanotime</span><span class="op" id="1543882">(</span><span class="op" id="1543883">)</span>&nbsp;<span class="op" id="1543885">+</span>&nbsp;<span class="ident" id="1543887">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543891">for</span>&nbsp;<span class="op" id="1543895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543899">gp</span><span class="op" id="1543901">.</span><span class="ident" id="1543902">m</span><span class="op" id="1543903">.</span><span class="ident" id="1543904">blocked</span>&nbsp;<span class="op" id="1543912">=</span>&nbsp;<span class="builtintype" id="1543914">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543921">futexsleep</span><span class="op" id="1543931">(</span><span class="ident" id="1543932">key32</span><span class="op" id="1543937">(</span><span class="op" id="1543938">&amp;</span><span class="ident" id="1543939">n</span><span class="op" id="1543940">.</span><span class="ident" id="1543941">key</span><span class="op" id="1543944">)</span><span class="op" id="1543945">,</span>&nbsp;<span class="num" id="1543947">0</span><span class="op" id="1543948">,</span>&nbsp;<span class="ident" id="1543950">ns</span><span class="op" id="1543952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543956">gp</span><span class="op" id="1543958">.</span><span class="ident" id="1543959">m</span><span class="op" id="1543960">.</span><span class="ident" id="1543961">blocked</span>&nbsp;<span class="op" id="1543969">=</span>&nbsp;<span class="builtintype" id="1543971">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543979">if</span>&nbsp;<span class="ident" id="1543982">atomicload</span><span class="op" id="1543992">(</span><span class="ident" id="1543993">key32</span><span class="op" id="1543998">(</span><span class="op" id="1543999">&amp;</span><span class="ident" id="1544000">n</span><span class="op" id="1544001">.</span><span class="ident" id="1544002">key</span><span class="op" id="1544005">)</span><span class="op" id="1544006">)</span>&nbsp;<span class="op" id="1544008">!=</span>&nbsp;<span class="num" id="1544011">0</span>&nbsp;<span class="op" id="1544013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544018">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544026">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544030">now</span>&nbsp;<span class="op" id="1544034">:=</span>&nbsp;<span class="ident" id="1544037">nanotime</span><span class="op" id="1544045">(</span><span class="op" id="1544046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544050">if</span>&nbsp;<span class="ident" id="1544053">now</span>&nbsp;<span class="op" id="1544057">&gt;=</span>&nbsp;<span class="ident" id="1544060">deadline</span>&nbsp;<span class="op" id="1544069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544074">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544086">ns</span>&nbsp;<span class="op" id="1544089">=</span>&nbsp;<span class="ident" id="1544091">deadline</span>&nbsp;<span class="op" id="1544100">-</span>&nbsp;<span class="ident" id="1544102">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544110">return</span>&nbsp;<span class="ident" id="1544117">atomicload</span><span class="op" id="1544127">(</span><span class="ident" id="1544128">key32</span><span class="op" id="1544133">(</span><span class="op" id="1544134">&amp;</span><span class="ident" id="1544135">n</span><span class="op" id="1544136">.</span><span class="ident" id="1544137">key</span><span class="op" id="1544140">)</span><span class="op" id="1544141">)</span>&nbsp;<span class="op" id="1544143">!=</span>&nbsp;<span class="num" id="1544146">0</span><br>
<span class="lineno"></span><span class="op" id="1544148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1544151">func</span>&nbsp;<span class="ident" id="1544156">notetsleep</span><span class="op" id="1544166">(</span><span class="ident" id="1544167">n</span>&nbsp;<span class="op" id="1544169">*</span><span class="ident" id="1544170">note</span><span class="op" id="1544174">,</span>&nbsp;<span class="ident" id="1544176">ns</span>&nbsp;<span class="ident" id="1544179">int64</span><span class="op" id="1544184">)</span>&nbsp;<span class="builtintype" id="1544186">bool</span>&nbsp;<span class="op" id="1544191">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544194">gp</span>&nbsp;<span class="op" id="1544197">:=</span>&nbsp;<span class="ident" id="1544200">getg</span><span class="op" id="1544204">(</span><span class="op" id="1544205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544208">if</span>&nbsp;<span class="ident" id="1544211">gp</span>&nbsp;<span class="op" id="1544214">!=</span>&nbsp;<span class="ident" id="1544217">gp</span><span class="op" id="1544219">.</span><span class="ident" id="1544220">m</span><span class="op" id="1544221">.</span><span class="ident" id="1544222">g0</span>&nbsp;<span class="op" id="1544225">&amp;&amp;</span>&nbsp;<span class="ident" id="1544228">gp</span><span class="op" id="1544230">.</span><span class="ident" id="1544231">m</span><span class="op" id="1544232">.</span><span class="ident" id="1544233">gcing</span>&nbsp;<span class="op" id="1544239">==</span>&nbsp;<span class="num" id="1544242">0</span>&nbsp;<span class="op" id="1544244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544248">gothrow</span><span class="op" id="1544255">(</span><span class="string" id="1544256">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1544278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544285">return</span>&nbsp;<span class="ident" id="1544292">notetsleep_internal</span><span class="op" id="1544311">(</span><span class="ident" id="1544312">n</span><span class="op" id="1544313">,</span>&nbsp;<span class="ident" id="1544315">ns</span><span class="op" id="1544317">)</span><br>
<span class="lineno"></span><span class="op" id="1544319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1544322">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1544384">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1544454">func</span>&nbsp;<span class="ident" id="1544459">notetsleepg</span><span class="op" id="1544470">(</span><span class="ident" id="1544471">n</span>&nbsp;<span class="op" id="1544473">*</span><span class="ident" id="1544474">note</span><span class="op" id="1544478">,</span>&nbsp;<span class="ident" id="1544480">ns</span>&nbsp;<span class="ident" id="1544483">int64</span><span class="op" id="1544488">)</span>&nbsp;<span class="builtintype" id="1544490">bool</span>&nbsp;<span class="op" id="1544495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544498">gp</span>&nbsp;<span class="op" id="1544501">:=</span>&nbsp;<span class="ident" id="1544504">getg</span><span class="op" id="1544508">(</span><span class="op" id="1544509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544512">if</span>&nbsp;<span class="ident" id="1544515">gp</span>&nbsp;<span class="op" id="1544518">==</span>&nbsp;<span class="ident" id="1544521">gp</span><span class="op" id="1544523">.</span><span class="ident" id="1544524">m</span><span class="op" id="1544525">.</span><span class="ident" id="1544526">g0</span>&nbsp;<span class="op" id="1544529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544533">gothrow</span><span class="op" id="1544540">(</span><span class="string" id="1544541">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1544560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1544563">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544567">entersyscallblock</span><span class="op" id="1544584">(</span><span class="op" id="1544585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544588">ok</span>&nbsp;<span class="op" id="1544591">:=</span>&nbsp;<span class="ident" id="1544594">notetsleep_internal</span><span class="op" id="1544613">(</span><span class="ident" id="1544614">n</span><span class="op" id="1544615">,</span>&nbsp;<span class="ident" id="1544617">ns</span><span class="op" id="1544619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544622">exitsyscall</span><span class="op" id="1544633">(</span><span class="op" id="1544634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1544637">return</span>&nbsp;<span class="ident" id="1544644">ok</span><br>
<span class="lineno">205</span><span class="op" id="1544647">}</span>
</div>
</body>
</html>
