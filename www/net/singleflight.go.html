<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2672651">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2672707">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2672761">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2672812">package</span>&nbsp;<span class="ident" id="2672820">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2672825">import</span>&nbsp;<span class="string" id="2672832">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2672840">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="2672898">type</span>&nbsp;<span class="ident" id="2672903">call</span>&nbsp;<span class="keyword" id="2672908">struct</span>&nbsp;<span class="op" id="2672915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2672918">wg</span>&nbsp;<span class="ident" id="2672921"><a href="/net/singleflight.go.html#2672832">sync</a></span><span class="op" id="2672925">.</span><span class="ident" id="2672926">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2672938">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2673001">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673052">val</span>&nbsp;<span class="keyword" id="2673056">interface</span><span class="op" id="2673065">{</span><span class="op" id="2673066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673069">err</span>&nbsp;<span class="builtintype" id="2673073">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2673081">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2673141">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2673203">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673248">dups</span>&nbsp;&nbsp;<span class="builtintype" id="2673254">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673259">chans</span>&nbsp;<span class="op" id="2673265">[</span><span class="op" id="2673266">]</span><span class="keyword" id="2673267">chan</span><span class="op" id="2673271">&lt;-</span>&nbsp;<span class="ident" id="2673274"><a href="/net/singleflight.go.html#2673630">singleflightResult</a></span><br>
<span class="lineno"></span><span class="op" id="2673293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="2673296">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="2673364">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="2673431">type</span>&nbsp;<span class="ident" id="2673436">singleflight</span>&nbsp;<span class="keyword" id="2673449">struct</span>&nbsp;<span class="op" id="2673456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673459">mu</span>&nbsp;<span class="ident" id="2673462"><a href="/net/singleflight.go.html#2672832">sync</a></span><span class="op" id="2673466">.</span><span class="ident" id="2673467">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2673479">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673494">m</span>&nbsp;&nbsp;<span class="keyword" id="2673497">map</span><span class="op" id="2673500">[</span><span class="builtintype" id="2673501">string</span><span class="op" id="2673507">]</span><span class="op" id="2673508">*</span><span class="ident" id="2673509"><a href="/net/singleflight.go.html#2672903">call</a></span>&nbsp;<span class="comment" id="2673514">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="2673536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2673539">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="2673608">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="2673625">type</span>&nbsp;<span class="ident" id="2673630">singleflightResult</span>&nbsp;<span class="keyword" id="2673649">struct</span>&nbsp;<span class="op" id="2673656">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673659">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2673666">interface</span><span class="op" id="2673675">{</span><span class="op" id="2673676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673679">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2673686">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2673693">shared</span>&nbsp;<span class="builtintype" id="2673700">bool</span><br>
<span class="lineno"></span><span class="op" id="2673705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2673708">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="2673777">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="2673843">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2673912">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="2673967">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="2674045">func</span>&nbsp;<span class="op" id="2674050">(</span><span class="ident" id="2674051">g</span>&nbsp;<span class="op" id="2674053">*</span><span class="ident" id="2674054"><a href="/net/singleflight.go.html#2673436">singleflight</a></span><span class="op" id="2674066">)</span>&nbsp;<span class="ident" id="2674068">Do</span><span class="op" id="2674070">(</span><span class="ident" id="2674071">key</span>&nbsp;<span class="builtintype" id="2674075">string</span><span class="op" id="2674081">,</span>&nbsp;<span class="ident" id="2674083">fn</span>&nbsp;<span class="keyword" id="2674086">func</span><span class="op" id="2674090">(</span><span class="op" id="2674091">)</span>&nbsp;<span class="op" id="2674093">(</span><span class="keyword" id="2674094">interface</span><span class="op" id="2674103">{</span><span class="op" id="2674104">}</span><span class="op" id="2674105">,</span>&nbsp;<span class="builtintype" id="2674107">error</span><span class="op" id="2674112">)</span><span class="op" id="2674113">)</span>&nbsp;<span class="op" id="2674115">(</span><span class="ident" id="2674116">v</span>&nbsp;<span class="keyword" id="2674118">interface</span><span class="op" id="2674127">{</span><span class="op" id="2674128">}</span><span class="op" id="2674129">,</span>&nbsp;<span class="ident" id="2674131">err</span>&nbsp;<span class="builtintype" id="2674135">error</span><span class="op" id="2674140">,</span>&nbsp;<span class="ident" id="2674142">shared</span>&nbsp;<span class="builtintype" id="2674149">bool</span><span class="op" id="2674153">)</span>&nbsp;<span class="op" id="2674155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674158"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674159">.</span><span class="ident" id="2674160">mu</span><span class="op" id="2674162">.</span><span class="ident" id="2674163">Lock</span><span class="op" id="2674167">(</span><span class="op" id="2674168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674171">if</span>&nbsp;<span class="ident" id="2674174"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674175">.</span><span class="ident" id="2674176">m</span>&nbsp;<span class="op" id="2674178">==</span>&nbsp;<span class="ident" id="2674181">nil</span>&nbsp;<span class="op" id="2674185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674189"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674190">.</span><span class="ident" id="2674191">m</span>&nbsp;<span class="op" id="2674193">=</span>&nbsp;<span class="builtinfunc" id="2674195">make</span><span class="op" id="2674199">(</span><span class="keyword" id="2674200">map</span><span class="op" id="2674203">[</span><span class="builtintype" id="2674204">string</span><span class="op" id="2674210">]</span><span class="op" id="2674211">*</span><span class="ident" id="2674212"><a href="/net/singleflight.go.html#2672903">call</a></span><span class="op" id="2674216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2674219">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674222">if</span>&nbsp;<span class="ident" id="2674225">c</span><span class="op" id="2674226">,</span>&nbsp;<span class="ident" id="2674228">ok</span>&nbsp;<span class="op" id="2674231">:=</span>&nbsp;<span class="ident" id="2674234"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674235">.</span><span class="ident" id="2674236">m</span><span class="op" id="2674237">[</span><span class="ident" id="2674238"><a href="/net/singleflight.go.html#2674071">key</a></span><span class="op" id="2674241">]</span><span class="op" id="2674242">;</span>&nbsp;<span class="ident" id="2674244"><a href="/net/singleflight.go.html#2674228">ok</a></span>&nbsp;<span class="op" id="2674247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674251"><a href="/net/singleflight.go.html#2674225">c</a></span><span class="op" id="2674252">.</span><span class="ident" id="2674253">dups</span><span class="op" id="2674257">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674262"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674263">.</span><span class="ident" id="2674264">mu</span><span class="op" id="2674266">.</span><span class="ident" id="2674267">Unlock</span><span class="op" id="2674273">(</span><span class="op" id="2674274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674278"><a href="/net/singleflight.go.html#2674225">c</a></span><span class="op" id="2674279">.</span><span class="ident" id="2674280">wg</span><span class="op" id="2674282">.</span><span class="ident" id="2674283">Wait</span><span class="op" id="2674287">(</span><span class="op" id="2674288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674292">return</span>&nbsp;<span class="ident" id="2674299"><a href="/net/singleflight.go.html#2674225">c</a></span><span class="op" id="2674300">.</span><span class="ident" id="2674301">val</span><span class="op" id="2674304">,</span>&nbsp;<span class="ident" id="2674306"><a href="/net/singleflight.go.html#2674225">c</a></span><span class="op" id="2674307">.</span><span class="ident" id="2674308">err</span><span class="op" id="2674311">,</span>&nbsp;<span class="ident" id="2674313">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2674319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674322">c</span>&nbsp;<span class="op" id="2674324">:=</span>&nbsp;<span class="builtinfunc" id="2674327">new</span><span class="op" id="2674330">(</span><span class="ident" id="2674331"><a href="/net/singleflight.go.html#2672903">call</a></span><span class="op" id="2674335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674338"><a href="/net/singleflight.go.html#2674322">c</a></span><span class="op" id="2674339">.</span><span class="ident" id="2674340">wg</span><span class="op" id="2674342">.</span><span class="ident" id="2674343">Add</span><span class="op" id="2674346">(</span><span class="num" id="2674347">1</span><span class="op" id="2674348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674351"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674352">.</span><span class="ident" id="2674353">m</span><span class="op" id="2674354">[</span><span class="ident" id="2674355"><a href="/net/singleflight.go.html#2674071">key</a></span><span class="op" id="2674358">]</span>&nbsp;<span class="op" id="2674360">=</span>&nbsp;<span class="ident" id="2674362"><a href="/net/singleflight.go.html#2674322">c</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674365"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674366">.</span><span class="ident" id="2674367">mu</span><span class="op" id="2674369">.</span><span class="ident" id="2674370">Unlock</span><span class="op" id="2674376">(</span><span class="op" id="2674377">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674381"><a href="/net/singleflight.go.html#2674051">g</a></span><span class="op" id="2674382">.</span><span class="ident" id="2674383">doCall</span><span class="op" id="2674389">(</span><span class="ident" id="2674390"><a href="/net/singleflight.go.html#2674322">c</a></span><span class="op" id="2674391">,</span>&nbsp;<span class="ident" id="2674393"><a href="/net/singleflight.go.html#2674071">key</a></span><span class="op" id="2674396">,</span>&nbsp;<span class="ident" id="2674398"><a href="/net/singleflight.go.html#2674083">fn</a></span><span class="op" id="2674400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674403">return</span>&nbsp;<span class="ident" id="2674410"><a href="/net/singleflight.go.html#2674322">c</a></span><span class="op" id="2674411">.</span><span class="ident" id="2674412">val</span><span class="op" id="2674415">,</span>&nbsp;<span class="ident" id="2674417"><a href="/net/singleflight.go.html#2674322">c</a></span><span class="op" id="2674418">.</span><span class="ident" id="2674419">err</span><span class="op" id="2674422">,</span>&nbsp;<span class="ident" id="2674424"><a href="/net/singleflight.go.html#2674322">c</a></span><span class="op" id="2674425">.</span><span class="ident" id="2674426">dups</span>&nbsp;<span class="op" id="2674431">&gt;</span>&nbsp;<span class="num" id="2674433">0</span><br>
<span class="lineno"></span><span class="op" id="2674435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="2674438">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2674503">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="2674535">func</span>&nbsp;<span class="op" id="2674540">(</span><span class="ident" id="2674541">g</span>&nbsp;<span class="op" id="2674543">*</span><span class="ident" id="2674544"><a href="/net/singleflight.go.html#2673436">singleflight</a></span><span class="op" id="2674556">)</span>&nbsp;<span class="ident" id="2674558">DoChan</span><span class="op" id="2674564">(</span><span class="ident" id="2674565">key</span>&nbsp;<span class="builtintype" id="2674569">string</span><span class="op" id="2674575">,</span>&nbsp;<span class="ident" id="2674577">fn</span>&nbsp;<span class="keyword" id="2674580">func</span><span class="op" id="2674584">(</span><span class="op" id="2674585">)</span>&nbsp;<span class="op" id="2674587">(</span><span class="keyword" id="2674588">interface</span><span class="op" id="2674597">{</span><span class="op" id="2674598">}</span><span class="op" id="2674599">,</span>&nbsp;<span class="builtintype" id="2674601">error</span><span class="op" id="2674606">)</span><span class="op" id="2674607">)</span>&nbsp;<span class="op" id="2674609">&lt;-</span><span class="keyword" id="2674611">chan</span>&nbsp;<span class="ident" id="2674616"><a href="/net/singleflight.go.html#2673630">singleflightResult</a></span>&nbsp;<span class="op" id="2674635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674638">ch</span>&nbsp;<span class="op" id="2674641">:=</span>&nbsp;<span class="builtinfunc" id="2674644">make</span><span class="op" id="2674648">(</span><span class="keyword" id="2674649">chan</span>&nbsp;<span class="ident" id="2674654"><a href="/net/singleflight.go.html#2673630">singleflightResult</a></span><span class="op" id="2674672">,</span>&nbsp;<span class="num" id="2674674">1</span><span class="op" id="2674675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674678"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674679">.</span><span class="ident" id="2674680">mu</span><span class="op" id="2674682">.</span><span class="ident" id="2674683">Lock</span><span class="op" id="2674687">(</span><span class="op" id="2674688">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674691">if</span>&nbsp;<span class="ident" id="2674694"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674695">.</span><span class="ident" id="2674696">m</span>&nbsp;<span class="op" id="2674698">==</span>&nbsp;<span class="ident" id="2674701">nil</span>&nbsp;<span class="op" id="2674705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674709"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674710">.</span><span class="ident" id="2674711">m</span>&nbsp;<span class="op" id="2674713">=</span>&nbsp;<span class="builtinfunc" id="2674715">make</span><span class="op" id="2674719">(</span><span class="keyword" id="2674720">map</span><span class="op" id="2674723">[</span><span class="builtintype" id="2674724">string</span><span class="op" id="2674730">]</span><span class="op" id="2674731">*</span><span class="ident" id="2674732"><a href="/net/singleflight.go.html#2672903">call</a></span><span class="op" id="2674736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2674739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674742">if</span>&nbsp;<span class="ident" id="2674745">c</span><span class="op" id="2674746">,</span>&nbsp;<span class="ident" id="2674748">ok</span>&nbsp;<span class="op" id="2674751">:=</span>&nbsp;<span class="ident" id="2674754"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674755">.</span><span class="ident" id="2674756">m</span><span class="op" id="2674757">[</span><span class="ident" id="2674758"><a href="/net/singleflight.go.html#2674565">key</a></span><span class="op" id="2674761">]</span><span class="op" id="2674762">;</span>&nbsp;<span class="ident" id="2674764"><a href="/net/singleflight.go.html#2674748">ok</a></span>&nbsp;<span class="op" id="2674767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674771"><a href="/net/singleflight.go.html#2674745">c</a></span><span class="op" id="2674772">.</span><span class="ident" id="2674773">dups</span><span class="op" id="2674777">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674782"><a href="/net/singleflight.go.html#2674745">c</a></span><span class="op" id="2674783">.</span><span class="ident" id="2674784">chans</span>&nbsp;<span class="op" id="2674790">=</span>&nbsp;<span class="builtinfunc" id="2674792">append</span><span class="op" id="2674798">(</span><span class="ident" id="2674799"><a href="/net/singleflight.go.html#2674745">c</a></span><span class="op" id="2674800">.</span><span class="ident" id="2674801">chans</span><span class="op" id="2674806">,</span>&nbsp;<span class="ident" id="2674808"><a href="/net/singleflight.go.html#2674638">ch</a></span><span class="op" id="2674810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674814"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674815">.</span><span class="ident" id="2674816">mu</span><span class="op" id="2674818">.</span><span class="ident" id="2674819">Unlock</span><span class="op" id="2674825">(</span><span class="op" id="2674826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674830">return</span>&nbsp;<span class="ident" id="2674837"><a href="/net/singleflight.go.html#2674638">ch</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2674841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674844">c</span>&nbsp;<span class="op" id="2674846">:=</span>&nbsp;<span class="op" id="2674849">&amp;</span><span class="ident" id="2674850"><a href="/net/singleflight.go.html#2672903">call</a></span><span class="op" id="2674854">{</span><span class="ident" id="2674855">chans</span><span class="op" id="2674860">:</span>&nbsp;<span class="op" id="2674862">[</span><span class="op" id="2674863">]</span><span class="keyword" id="2674864">chan</span><span class="op" id="2674868">&lt;-</span>&nbsp;<span class="ident" id="2674871"><a href="/net/singleflight.go.html#2673630">singleflightResult</a></span><span class="op" id="2674889">{</span><span class="ident" id="2674890"><a href="/net/singleflight.go.html#2674638">ch</a></span><span class="op" id="2674892">}</span><span class="op" id="2674893">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674896"><a href="/net/singleflight.go.html#2674844">c</a></span><span class="op" id="2674897">.</span><span class="ident" id="2674898">wg</span><span class="op" id="2674900">.</span><span class="ident" id="2674901">Add</span><span class="op" id="2674904">(</span><span class="num" id="2674905">1</span><span class="op" id="2674906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674909"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674910">.</span><span class="ident" id="2674911">m</span><span class="op" id="2674912">[</span><span class="ident" id="2674913"><a href="/net/singleflight.go.html#2674565">key</a></span><span class="op" id="2674916">]</span>&nbsp;<span class="op" id="2674918">=</span>&nbsp;<span class="ident" id="2674920"><a href="/net/singleflight.go.html#2674844">c</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2674923"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674924">.</span><span class="ident" id="2674925">mu</span><span class="op" id="2674927">.</span><span class="ident" id="2674928">Unlock</span><span class="op" id="2674934">(</span><span class="op" id="2674935">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674939">go</span>&nbsp;<span class="ident" id="2674942"><a href="/net/singleflight.go.html#2674541">g</a></span><span class="op" id="2674943">.</span><span class="ident" id="2674944">doCall</span><span class="op" id="2674950">(</span><span class="ident" id="2674951"><a href="/net/singleflight.go.html#2674844">c</a></span><span class="op" id="2674952">,</span>&nbsp;<span class="ident" id="2674954"><a href="/net/singleflight.go.html#2674565">key</a></span><span class="op" id="2674957">,</span>&nbsp;<span class="ident" id="2674959"><a href="/net/singleflight.go.html#2674577">fn</a></span><span class="op" id="2674961">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2674965">return</span>&nbsp;<span class="ident" id="2674972"><a href="/net/singleflight.go.html#2674638">ch</a></span><br>
<span class="lineno"></span><span class="op" id="2674975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2674978">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="2675023">func</span>&nbsp;<span class="op" id="2675028">(</span><span class="ident" id="2675029">g</span>&nbsp;<span class="op" id="2675031">*</span><span class="ident" id="2675032"><a href="/net/singleflight.go.html#2673436">singleflight</a></span><span class="op" id="2675044">)</span>&nbsp;<span class="ident" id="2675046">doCall</span><span class="op" id="2675052">(</span><span class="ident" id="2675053">c</span>&nbsp;<span class="op" id="2675055">*</span><span class="ident" id="2675056"><a href="/net/singleflight.go.html#2672903">call</a></span><span class="op" id="2675060">,</span>&nbsp;<span class="ident" id="2675062">key</span>&nbsp;<span class="builtintype" id="2675066">string</span><span class="op" id="2675072">,</span>&nbsp;<span class="ident" id="2675074">fn</span>&nbsp;<span class="keyword" id="2675077">func</span><span class="op" id="2675081">(</span><span class="op" id="2675082">)</span>&nbsp;<span class="op" id="2675084">(</span><span class="keyword" id="2675085">interface</span><span class="op" id="2675094">{</span><span class="op" id="2675095">}</span><span class="op" id="2675096">,</span>&nbsp;<span class="builtintype" id="2675098">error</span><span class="op" id="2675103">)</span><span class="op" id="2675104">)</span>&nbsp;<span class="op" id="2675106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675109"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675110">.</span><span class="ident" id="2675111">val</span><span class="op" id="2675114">,</span>&nbsp;<span class="ident" id="2675116"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675117">.</span><span class="ident" id="2675118">err</span>&nbsp;<span class="op" id="2675122">=</span>&nbsp;<span class="ident" id="2675124"><a href="/net/singleflight.go.html#2675074">fn</a></span><span class="op" id="2675126">(</span><span class="op" id="2675127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675130"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675131">.</span><span class="ident" id="2675132">wg</span><span class="op" id="2675134">.</span><span class="ident" id="2675135">Done</span><span class="op" id="2675139">(</span><span class="op" id="2675140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675144"><a href="/net/singleflight.go.html#2675029">g</a></span><span class="op" id="2675145">.</span><span class="ident" id="2675146">mu</span><span class="op" id="2675148">.</span><span class="ident" id="2675149">Lock</span><span class="op" id="2675153">(</span><span class="op" id="2675154">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2675157">delete</span><span class="op" id="2675163">(</span><span class="ident" id="2675164"><a href="/net/singleflight.go.html#2675029">g</a></span><span class="op" id="2675165">.</span><span class="ident" id="2675166">m</span><span class="op" id="2675167">,</span>&nbsp;<span class="ident" id="2675169"><a href="/net/singleflight.go.html#2675062">key</a></span><span class="op" id="2675172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2675175">for</span>&nbsp;<span class="ident" id="2675179">_</span><span class="op" id="2675180">,</span>&nbsp;<span class="ident" id="2675182">ch</span>&nbsp;<span class="op" id="2675185">:=</span>&nbsp;<span class="keyword" id="2675188">range</span>&nbsp;<span class="ident" id="2675194"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675195">.</span><span class="ident" id="2675196">chans</span>&nbsp;<span class="op" id="2675202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675206"><a href="/net/singleflight.go.html#2675182">ch</a></span>&nbsp;<span class="op" id="2675209">&lt;-</span>&nbsp;<span class="ident" id="2675212"><a href="/net/singleflight.go.html#2673630">singleflightResult</a></span><span class="op" id="2675230">{</span><span class="ident" id="2675231"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675232">.</span><span class="ident" id="2675233">val</span><span class="op" id="2675236">,</span>&nbsp;<span class="ident" id="2675238"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675239">.</span><span class="ident" id="2675240">err</span><span class="op" id="2675243">,</span>&nbsp;<span class="ident" id="2675245"><a href="/net/singleflight.go.html#2675053">c</a></span><span class="op" id="2675246">.</span><span class="ident" id="2675247">dups</span>&nbsp;<span class="op" id="2675252">&gt;</span>&nbsp;<span class="num" id="2675254">0</span><span class="op" id="2675255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2675258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675261"><a href="/net/singleflight.go.html#2675029">g</a></span><span class="op" id="2675262">.</span><span class="ident" id="2675263">mu</span><span class="op" id="2675265">.</span><span class="ident" id="2675266">Unlock</span><span class="op" id="2675272">(</span><span class="op" id="2675273">)</span><br>
<span class="lineno">100</span><span class="op" id="2675275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2675278">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="2675348">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="2675417">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="2675449">func</span>&nbsp;<span class="op" id="2675454">(</span><span class="ident" id="2675455">g</span>&nbsp;<span class="op" id="2675457">*</span><span class="ident" id="2675458"><a href="/net/singleflight.go.html#2673436">singleflight</a></span><span class="op" id="2675470">)</span>&nbsp;<span class="ident" id="2675472">Forget</span><span class="op" id="2675478">(</span><span class="ident" id="2675479">key</span>&nbsp;<span class="builtintype" id="2675483">string</span><span class="op" id="2675489">)</span>&nbsp;<span class="op" id="2675491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675494"><a href="/net/singleflight.go.html#2675455">g</a></span><span class="op" id="2675495">.</span><span class="ident" id="2675496">mu</span><span class="op" id="2675498">.</span><span class="ident" id="2675499">Lock</span><span class="op" id="2675503">(</span><span class="op" id="2675504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2675507">delete</span><span class="op" id="2675513">(</span><span class="ident" id="2675514"><a href="/net/singleflight.go.html#2675455">g</a></span><span class="op" id="2675515">.</span><span class="ident" id="2675516">m</span><span class="op" id="2675517">,</span>&nbsp;<span class="ident" id="2675519"><a href="/net/singleflight.go.html#2675479">key</a></span><span class="op" id="2675522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2675525"><a href="/net/singleflight.go.html#2675455">g</a></span><span class="op" id="2675526">.</span><span class="ident" id="2675527">mu</span><span class="op" id="2675529">.</span><span class="ident" id="2675530">Unlock</span><span class="op" id="2675536">(</span><span class="op" id="2675537">)</span><br>
<span class="lineno"></span><span class="op" id="2675539">}</span>
</div>
</body>
</html>
