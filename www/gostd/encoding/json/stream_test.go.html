<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8156576">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8156632">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8156686">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8156737">package</span>&nbsp;<span class="ident" id="8156745">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8156751">import</span>&nbsp;<span class="op" id="8156758">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156761">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156770">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156783">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156790">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156801">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156812">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8156822">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="8156825">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="8156861">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="8156887">var</span>&nbsp;<span class="ident" id="8156891">streamTest</span>&nbsp;<span class="op" id="8156902">=</span>&nbsp;<span class="op" id="8156904">[</span><span class="op" id="8156905">]</span><span class="keyword" id="8156906">interface</span><span class="op" id="8156915">{</span><span class="op" id="8156916">}</span><span class="op" id="8156917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8156920">0.1</span><span class="op" id="8156923">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8156926">&#34;hello&#34;</span><span class="op" id="8156933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8156936">nil</span><span class="op" id="8156939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="8156942">true</span><span class="op" id="8156946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="8156949">false</span><span class="op" id="8156954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8156957">[</span><span class="op" id="8156958">]</span><span class="keyword" id="8156959">interface</span><span class="op" id="8156968">{</span><span class="op" id="8156969">}</span><span class="op" id="8156970">{</span><span class="string" id="8156971">&#34;a&#34;</span><span class="op" id="8156974">,</span>&nbsp;<span class="string" id="8156976">&#34;b&#34;</span><span class="op" id="8156979">,</span>&nbsp;<span class="string" id="8156981">&#34;c&#34;</span><span class="op" id="8156984">}</span><span class="op" id="8156985">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8156988">map</span><span class="op" id="8156991">[</span><span class="builtintype" id="8156992">string</span><span class="op" id="8156998">]</span><span class="keyword" id="8156999">interface</span><span class="op" id="8157008">{</span><span class="op" id="8157009">}</span><span class="op" id="8157010">{</span><span class="string" id="8157011">&#34;K&#34;</span><span class="op" id="8157016">:</span>&nbsp;<span class="string" id="8157018">&#34;Kelvin&#34;</span><span class="op" id="8157026">,</span>&nbsp;<span class="string" id="8157028">&#34;ß&#34;</span><span class="op" id="8157032">:</span>&nbsp;<span class="string" id="8157034">&#34;long&nbsp;s&#34;</span><span class="op" id="8157042">}</span><span class="op" id="8157043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8157046">3.14</span><span class="op" id="8157050">,</span>&nbsp;<span class="comment" id="8157052">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="8157107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8157110">var</span>&nbsp;<span class="ident" id="8157114">streamEncoded</span>&nbsp;<span class="op" id="8157128">=</span>&nbsp;<span class="string" id="8157130">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8157212">func</span>&nbsp;<span class="ident" id="8157217">TestEncoder</span><span class="op" id="8157228">(</span><span class="ident" id="8157229">t</span>&nbsp;<span class="op" id="8157231">*</span><span class="ident" id="8157232">testing</span><span class="op" id="8157239">.</span><span class="ident" id="8157240">T</span><span class="op" id="8157241">)</span>&nbsp;<span class="op" id="8157243">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157246">for</span>&nbsp;<span class="ident" id="8157250">i</span>&nbsp;<span class="op" id="8157252">:=</span>&nbsp;<span class="num" id="8157255">0</span><span class="op" id="8157256">;</span>&nbsp;<span class="ident" id="8157258">i</span>&nbsp;<span class="op" id="8157260">&lt;=</span>&nbsp;<span class="builtinfunc" id="8157263">len</span><span class="op" id="8157266">(</span><span class="ident" id="8157267">streamTest</span><span class="op" id="8157277">)</span><span class="op" id="8157278">;</span>&nbsp;<span class="ident" id="8157280">i</span><span class="op" id="8157281">++</span>&nbsp;<span class="op" id="8157284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157288">var</span>&nbsp;<span class="ident" id="8157292">buf</span>&nbsp;<span class="ident" id="8157296">bytes</span><span class="op" id="8157301">.</span><span class="ident" id="8157302">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157311">enc</span>&nbsp;<span class="op" id="8157315">:=</span>&nbsp;<span class="ident" id="8157318">NewEncoder</span><span class="op" id="8157328">(</span><span class="op" id="8157329">&amp;</span><span class="ident" id="8157330">buf</span><span class="op" id="8157333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157337">for</span>&nbsp;<span class="ident" id="8157341">j</span><span class="op" id="8157342">,</span>&nbsp;<span class="ident" id="8157344">v</span>&nbsp;<span class="op" id="8157346">:=</span>&nbsp;<span class="keyword" id="8157349">range</span>&nbsp;<span class="ident" id="8157355">streamTest</span><span class="op" id="8157365">[</span><span class="num" id="8157366">0</span><span class="op" id="8157367">:</span><span class="ident" id="8157368">i</span><span class="op" id="8157369">]</span>&nbsp;<span class="op" id="8157371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157376">if</span>&nbsp;<span class="ident" id="8157379">err</span>&nbsp;<span class="op" id="8157383">:=</span>&nbsp;<span class="ident" id="8157386">enc</span><span class="op" id="8157389">.</span><span class="ident" id="8157390">Encode</span><span class="op" id="8157396">(</span><span class="ident" id="8157397">v</span><span class="op" id="8157398">)</span><span class="op" id="8157399">;</span>&nbsp;<span class="ident" id="8157401">err</span>&nbsp;<span class="op" id="8157405">!=</span>&nbsp;<span class="ident" id="8157408">nil</span>&nbsp;<span class="op" id="8157412">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157418">t</span><span class="op" id="8157419">.</span><span class="ident" id="8157420">Fatalf</span><span class="op" id="8157426">(</span><span class="string" id="8157427">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="8157443">,</span>&nbsp;<span class="ident" id="8157445">j</span><span class="op" id="8157446">,</span>&nbsp;<span class="ident" id="8157448">err</span><span class="op" id="8157451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157464">if</span>&nbsp;<span class="ident" id="8157467">have</span><span class="op" id="8157471">,</span>&nbsp;<span class="ident" id="8157473">want</span>&nbsp;<span class="op" id="8157478">:=</span>&nbsp;<span class="ident" id="8157481">buf</span><span class="op" id="8157484">.</span><span class="ident" id="8157485">String</span><span class="op" id="8157491">(</span><span class="op" id="8157492">)</span><span class="op" id="8157493">,</span>&nbsp;<span class="ident" id="8157495">nlines</span><span class="op" id="8157501">(</span><span class="ident" id="8157502">streamEncoded</span><span class="op" id="8157515">,</span>&nbsp;<span class="ident" id="8157517">i</span><span class="op" id="8157518">)</span><span class="op" id="8157519">;</span>&nbsp;<span class="ident" id="8157521">have</span>&nbsp;<span class="op" id="8157526">!=</span>&nbsp;<span class="ident" id="8157529">want</span>&nbsp;<span class="op" id="8157534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157539">t</span><span class="op" id="8157540">.</span><span class="ident" id="8157541">Errorf</span><span class="op" id="8157547">(</span><span class="string" id="8157548">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8157577">,</span>&nbsp;<span class="ident" id="8157579">i</span><span class="op" id="8157580">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8157585">diff</span><span class="op" id="8157589">(</span><span class="ident" id="8157590">t</span><span class="op" id="8157591">,</span>&nbsp;<span class="op" id="8157593">[</span><span class="op" id="8157594">]</span><span class="builtintype" id="8157595">byte</span><span class="op" id="8157599">(</span><span class="ident" id="8157600">have</span><span class="op" id="8157604">)</span><span class="op" id="8157605">,</span>&nbsp;<span class="op" id="8157607">[</span><span class="op" id="8157608">]</span><span class="builtintype" id="8157609">byte</span><span class="op" id="8157613">(</span><span class="ident" id="8157614">want</span><span class="op" id="8157618">)</span><span class="op" id="8157619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157624">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8157635">}</span><br>
<span class="lineno"></span><span class="op" id="8157637">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="8157640">func</span>&nbsp;<span class="ident" id="8157645">TestDecoder</span><span class="op" id="8157656">(</span><span class="ident" id="8157657">t</span>&nbsp;<span class="op" id="8157659">*</span><span class="ident" id="8157660">testing</span><span class="op" id="8157667">.</span><span class="ident" id="8157668">T</span><span class="op" id="8157669">)</span>&nbsp;<span class="op" id="8157671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157674">for</span>&nbsp;<span class="ident" id="8157678">i</span>&nbsp;<span class="op" id="8157680">:=</span>&nbsp;<span class="num" id="8157683">0</span><span class="op" id="8157684">;</span>&nbsp;<span class="ident" id="8157686">i</span>&nbsp;<span class="op" id="8157688">&lt;=</span>&nbsp;<span class="builtinfunc" id="8157691">len</span><span class="op" id="8157694">(</span><span class="ident" id="8157695">streamTest</span><span class="op" id="8157705">)</span><span class="op" id="8157706">;</span>&nbsp;<span class="ident" id="8157708">i</span><span class="op" id="8157709">++</span>&nbsp;<span class="op" id="8157712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8157716">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8157759">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8157802">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8157861">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8157905">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157942">var</span>&nbsp;<span class="ident" id="8157946">buf</span>&nbsp;<span class="ident" id="8157950">bytes</span><span class="op" id="8157955">.</span><span class="ident" id="8157956">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8157965">for</span>&nbsp;<span class="ident" id="8157969">_</span><span class="op" id="8157970">,</span>&nbsp;<span class="ident" id="8157972">c</span>&nbsp;<span class="op" id="8157974">:=</span>&nbsp;<span class="keyword" id="8157977">range</span>&nbsp;<span class="ident" id="8157983">nlines</span><span class="op" id="8157989">(</span><span class="ident" id="8157990">streamEncoded</span><span class="op" id="8158003">,</span>&nbsp;<span class="ident" id="8158005">i</span><span class="op" id="8158006">)</span>&nbsp;<span class="op" id="8158008">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158013">if</span>&nbsp;<span class="ident" id="8158016">c</span>&nbsp;<span class="op" id="8158018">!=</span>&nbsp;<span class="string" id="8158021">&#39;\n&#39;</span>&nbsp;<span class="op" id="8158026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158032">buf</span><span class="op" id="8158035">.</span><span class="ident" id="8158036">WriteRune</span><span class="op" id="8158045">(</span><span class="ident" id="8158046">c</span><span class="op" id="8158047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158060">out</span>&nbsp;<span class="op" id="8158064">:=</span>&nbsp;<span class="builtinfunc" id="8158067">make</span><span class="op" id="8158071">(</span><span class="op" id="8158072">[</span><span class="op" id="8158073">]</span><span class="keyword" id="8158074">interface</span><span class="op" id="8158083">{</span><span class="op" id="8158084">}</span><span class="op" id="8158085">,</span>&nbsp;<span class="ident" id="8158087">i</span><span class="op" id="8158088">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158092">dec</span>&nbsp;<span class="op" id="8158096">:=</span>&nbsp;<span class="ident" id="8158099">NewDecoder</span><span class="op" id="8158109">(</span><span class="op" id="8158110">&amp;</span><span class="ident" id="8158111">buf</span><span class="op" id="8158114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158118">for</span>&nbsp;<span class="ident" id="8158122">j</span>&nbsp;<span class="op" id="8158124">:=</span>&nbsp;<span class="keyword" id="8158127">range</span>&nbsp;<span class="ident" id="8158133">out</span>&nbsp;<span class="op" id="8158137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158142">if</span>&nbsp;<span class="ident" id="8158145">err</span>&nbsp;<span class="op" id="8158149">:=</span>&nbsp;<span class="ident" id="8158152">dec</span><span class="op" id="8158155">.</span><span class="ident" id="8158156">Decode</span><span class="op" id="8158162">(</span><span class="op" id="8158163">&amp;</span><span class="ident" id="8158164">out</span><span class="op" id="8158167">[</span><span class="ident" id="8158168">j</span><span class="op" id="8158169">]</span><span class="op" id="8158170">)</span><span class="op" id="8158171">;</span>&nbsp;<span class="ident" id="8158173">err</span>&nbsp;<span class="op" id="8158177">!=</span>&nbsp;<span class="ident" id="8158180">nil</span>&nbsp;<span class="op" id="8158184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158190">t</span><span class="op" id="8158191">.</span><span class="ident" id="8158192">Fatalf</span><span class="op" id="8158198">(</span><span class="string" id="8158199">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="8158218">,</span>&nbsp;<span class="ident" id="8158220">j</span><span class="op" id="8158221">,</span>&nbsp;<span class="ident" id="8158223">i</span><span class="op" id="8158224">,</span>&nbsp;<span class="ident" id="8158226">err</span><span class="op" id="8158229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158234">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158242">if</span>&nbsp;<span class="op" id="8158245">!</span><span class="ident" id="8158246">reflect</span><span class="op" id="8158253">.</span><span class="ident" id="8158254">DeepEqual</span><span class="op" id="8158263">(</span><span class="ident" id="8158264">out</span><span class="op" id="8158267">,</span>&nbsp;<span class="ident" id="8158269">streamTest</span><span class="op" id="8158279">[</span><span class="num" id="8158280">0</span><span class="op" id="8158281">:</span><span class="ident" id="8158282">i</span><span class="op" id="8158283">]</span><span class="op" id="8158284">)</span>&nbsp;<span class="op" id="8158286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158291">t</span><span class="op" id="8158292">.</span><span class="ident" id="8158293">Errorf</span><span class="op" id="8158299">(</span><span class="string" id="8158300">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8158329">,</span>&nbsp;<span class="ident" id="8158331">i</span><span class="op" id="8158332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158337">for</span>&nbsp;<span class="ident" id="8158341">j</span>&nbsp;<span class="op" id="8158343">:=</span>&nbsp;<span class="keyword" id="8158346">range</span>&nbsp;<span class="ident" id="8158352">out</span>&nbsp;<span class="op" id="8158356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158362">if</span>&nbsp;<span class="op" id="8158365">!</span><span class="ident" id="8158366">reflect</span><span class="op" id="8158373">.</span><span class="ident" id="8158374">DeepEqual</span><span class="op" id="8158383">(</span><span class="ident" id="8158384">out</span><span class="op" id="8158387">[</span><span class="ident" id="8158388">j</span><span class="op" id="8158389">]</span><span class="op" id="8158390">,</span>&nbsp;<span class="ident" id="8158392">streamTest</span><span class="op" id="8158402">[</span><span class="ident" id="8158403">j</span><span class="op" id="8158404">]</span><span class="op" id="8158405">)</span>&nbsp;<span class="op" id="8158407">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158414">t</span><span class="op" id="8158415">.</span><span class="ident" id="8158416">Errorf</span><span class="op" id="8158422">(</span><span class="string" id="8158423">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8158445">,</span>&nbsp;<span class="ident" id="8158447">j</span><span class="op" id="8158448">,</span>&nbsp;<span class="ident" id="8158450">out</span><span class="op" id="8158453">[</span><span class="ident" id="8158454">j</span><span class="op" id="8158455">]</span><span class="op" id="8158456">,</span>&nbsp;<span class="ident" id="8158458">streamTest</span><span class="op" id="8158468">[</span><span class="ident" id="8158469">j</span><span class="op" id="8158470">]</span><span class="op" id="8158471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158487">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158495">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158498">}</span><br>
<span class="lineno"></span><span class="op" id="8158500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8158503">func</span>&nbsp;<span class="ident" id="8158508">TestDecoderBuffered</span><span class="op" id="8158527">(</span><span class="ident" id="8158528">t</span>&nbsp;<span class="op" id="8158530">*</span><span class="ident" id="8158531">testing</span><span class="op" id="8158538">.</span><span class="ident" id="8158539">T</span><span class="op" id="8158540">)</span>&nbsp;<span class="op" id="8158542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158545">r</span>&nbsp;<span class="op" id="8158547">:=</span>&nbsp;<span class="ident" id="8158550">strings</span><span class="op" id="8158557">.</span><span class="ident" id="8158558">NewReader</span><span class="op" id="8158567">(</span><span class="string" id="8158568">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="8158595">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158598">var</span>&nbsp;<span class="ident" id="8158602">m</span>&nbsp;<span class="keyword" id="8158604">struct</span>&nbsp;<span class="op" id="8158611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158615">Name</span>&nbsp;<span class="builtintype" id="8158620">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158631">d</span>&nbsp;<span class="op" id="8158633">:=</span>&nbsp;<span class="ident" id="8158636">NewDecoder</span><span class="op" id="8158646">(</span><span class="ident" id="8158647">r</span><span class="op" id="8158648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158651">err</span>&nbsp;<span class="op" id="8158655">:=</span>&nbsp;<span class="ident" id="8158658">d</span><span class="op" id="8158659">.</span><span class="ident" id="8158660">Decode</span><span class="op" id="8158666">(</span><span class="op" id="8158667">&amp;</span><span class="ident" id="8158668">m</span><span class="op" id="8158669">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158672">if</span>&nbsp;<span class="ident" id="8158675">err</span>&nbsp;<span class="op" id="8158679">!=</span>&nbsp;<span class="ident" id="8158682">nil</span>&nbsp;<span class="op" id="8158686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158690">t</span><span class="op" id="8158691">.</span><span class="ident" id="8158692">Fatal</span><span class="op" id="8158697">(</span><span class="ident" id="8158698">err</span><span class="op" id="8158701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158707">if</span>&nbsp;<span class="ident" id="8158710">m</span><span class="op" id="8158711">.</span><span class="ident" id="8158712">Name</span>&nbsp;<span class="op" id="8158717">!=</span>&nbsp;<span class="string" id="8158720">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="8158729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158733">t</span><span class="op" id="8158734">.</span><span class="ident" id="8158735">Errorf</span><span class="op" id="8158741">(</span><span class="string" id="8158742">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="8158766">,</span>&nbsp;<span class="ident" id="8158768">m</span><span class="op" id="8158769">.</span><span class="ident" id="8158770">Name</span><span class="op" id="8158774">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158780">rest</span><span class="op" id="8158784">,</span>&nbsp;<span class="ident" id="8158786">err</span>&nbsp;<span class="op" id="8158790">:=</span>&nbsp;<span class="ident" id="8158793">ioutil</span><span class="op" id="8158799">.</span><span class="ident" id="8158800">ReadAll</span><span class="op" id="8158807">(</span><span class="ident" id="8158808">d</span><span class="op" id="8158809">.</span><span class="ident" id="8158810">Buffered</span><span class="op" id="8158818">(</span><span class="op" id="8158819">)</span><span class="op" id="8158820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158823">if</span>&nbsp;<span class="ident" id="8158826">err</span>&nbsp;<span class="op" id="8158830">!=</span>&nbsp;<span class="ident" id="8158833">nil</span>&nbsp;<span class="op" id="8158837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158841">t</span><span class="op" id="8158842">.</span><span class="ident" id="8158843">Fatal</span><span class="op" id="8158848">(</span><span class="ident" id="8158849">err</span><span class="op" id="8158852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158855">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158858">if</span>&nbsp;<span class="ident" id="8158861">g</span><span class="op" id="8158862">,</span>&nbsp;<span class="ident" id="8158864">w</span>&nbsp;<span class="op" id="8158866">:=</span>&nbsp;<span class="builtintype" id="8158869">string</span><span class="op" id="8158875">(</span><span class="ident" id="8158876">rest</span><span class="op" id="8158880">)</span><span class="op" id="8158881">,</span>&nbsp;<span class="string" id="8158883">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="8158892">;</span>&nbsp;<span class="ident" id="8158894">g</span>&nbsp;<span class="op" id="8158896">!=</span>&nbsp;<span class="ident" id="8158899">w</span>&nbsp;<span class="op" id="8158901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8158905">t</span><span class="op" id="8158906">.</span><span class="ident" id="8158907">Errorf</span><span class="op" id="8158913">(</span><span class="string" id="8158914">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8158939">,</span>&nbsp;<span class="ident" id="8158941">g</span><span class="op" id="8158942">,</span>&nbsp;<span class="ident" id="8158944">w</span><span class="op" id="8158945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8158948">}</span><br>
<span class="lineno"></span><span class="op" id="8158950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="8158953">func</span>&nbsp;<span class="ident" id="8158958">nlines</span><span class="op" id="8158964">(</span><span class="ident" id="8158965">s</span>&nbsp;<span class="builtintype" id="8158967">string</span><span class="op" id="8158973">,</span>&nbsp;<span class="ident" id="8158975">n</span>&nbsp;<span class="builtintype" id="8158977">int</span><span class="op" id="8158980">)</span>&nbsp;<span class="builtintype" id="8158982">string</span>&nbsp;<span class="op" id="8158989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8158992">if</span>&nbsp;<span class="ident" id="8158995">n</span>&nbsp;<span class="op" id="8158997">&lt;=</span>&nbsp;<span class="num" id="8159000">0</span>&nbsp;<span class="op" id="8159002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159006">return</span>&nbsp;<span class="string" id="8159013">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159020">for</span>&nbsp;<span class="ident" id="8159024">i</span><span class="op" id="8159025">,</span>&nbsp;<span class="ident" id="8159027">c</span>&nbsp;<span class="op" id="8159029">:=</span>&nbsp;<span class="keyword" id="8159032">range</span>&nbsp;<span class="ident" id="8159038">s</span>&nbsp;<span class="op" id="8159040">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159044">if</span>&nbsp;<span class="ident" id="8159047">c</span>&nbsp;<span class="op" id="8159049">==</span>&nbsp;<span class="string" id="8159052">&#39;\n&#39;</span>&nbsp;<span class="op" id="8159057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159062">if</span>&nbsp;<span class="ident" id="8159065">n</span><span class="op" id="8159066">--</span><span class="op" id="8159068">;</span>&nbsp;<span class="ident" id="8159070">n</span>&nbsp;<span class="op" id="8159072">==</span>&nbsp;<span class="num" id="8159075">0</span>&nbsp;<span class="op" id="8159077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159083">return</span>&nbsp;<span class="ident" id="8159090">s</span><span class="op" id="8159091">[</span><span class="num" id="8159092">0</span>&nbsp;<span class="op" id="8159094">:</span>&nbsp;<span class="ident" id="8159096">i</span><span class="op" id="8159097">+</span><span class="num" id="8159098">1</span><span class="op" id="8159099">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159108">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159114">return</span>&nbsp;<span class="ident" id="8159121">s</span><br>
<span class="lineno"></span><span class="op" id="8159123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8159126">func</span>&nbsp;<span class="ident" id="8159131">TestRawMessage</span><span class="op" id="8159145">(</span><span class="ident" id="8159146">t</span>&nbsp;<span class="op" id="8159148">*</span><span class="ident" id="8159149">testing</span><span class="op" id="8159156">.</span><span class="ident" id="8159157">T</span><span class="op" id="8159158">)</span>&nbsp;<span class="op" id="8159160">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8159163">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159215">var</span>&nbsp;<span class="ident" id="8159219">data</span>&nbsp;<span class="keyword" id="8159224">struct</span>&nbsp;<span class="op" id="8159231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159235">X</span>&nbsp;&nbsp;<span class="builtintype" id="8159238">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159248">Id</span>&nbsp;<span class="op" id="8159251">*</span><span class="ident" id="8159252">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159265">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8159268">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159280">const</span>&nbsp;<span class="ident" id="8159286">raw</span>&nbsp;<span class="op" id="8159290">=</span>&nbsp;<span class="string" id="8159292">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159311">const</span>&nbsp;<span class="ident" id="8159317">msg</span>&nbsp;<span class="op" id="8159321">=</span>&nbsp;<span class="string" id="8159323">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159365">err</span>&nbsp;<span class="op" id="8159369">:=</span>&nbsp;<span class="ident" id="8159372">Unmarshal</span><span class="op" id="8159381">(</span><span class="op" id="8159382">[</span><span class="op" id="8159383">]</span><span class="builtintype" id="8159384">byte</span><span class="op" id="8159388">(</span><span class="ident" id="8159389">msg</span><span class="op" id="8159392">)</span><span class="op" id="8159393">,</span>&nbsp;<span class="op" id="8159395">&amp;</span><span class="ident" id="8159396">data</span><span class="op" id="8159400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159403">if</span>&nbsp;<span class="ident" id="8159406">err</span>&nbsp;<span class="op" id="8159410">!=</span>&nbsp;<span class="ident" id="8159413">nil</span>&nbsp;<span class="op" id="8159417">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159421">t</span><span class="op" id="8159422">.</span><span class="ident" id="8159423">Fatalf</span><span class="op" id="8159429">(</span><span class="string" id="8159430">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8159445">,</span>&nbsp;<span class="ident" id="8159447">err</span><span class="op" id="8159450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159456">if</span>&nbsp;<span class="builtintype" id="8159459">string</span><span class="op" id="8159465">(</span><span class="op" id="8159466">[</span><span class="op" id="8159467">]</span><span class="builtintype" id="8159468">byte</span><span class="op" id="8159472">(</span><span class="op" id="8159473">*</span><span class="ident" id="8159474">data</span><span class="op" id="8159478">.</span><span class="ident" id="8159479">Id</span><span class="op" id="8159481">)</span><span class="op" id="8159482">)</span>&nbsp;<span class="op" id="8159484">!=</span>&nbsp;<span class="ident" id="8159487">raw</span>&nbsp;<span class="op" id="8159491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159495">t</span><span class="op" id="8159496">.</span><span class="ident" id="8159497">Fatalf</span><span class="op" id="8159503">(</span><span class="string" id="8159504">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8159537">,</span>&nbsp;<span class="op" id="8159539">[</span><span class="op" id="8159540">]</span><span class="builtintype" id="8159541">byte</span><span class="op" id="8159545">(</span><span class="op" id="8159546">*</span><span class="ident" id="8159547">data</span><span class="op" id="8159551">.</span><span class="ident" id="8159552">Id</span><span class="op" id="8159554">)</span><span class="op" id="8159555">,</span>&nbsp;<span class="ident" id="8159557">raw</span><span class="op" id="8159560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159563">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159566">b</span><span class="op" id="8159567">,</span>&nbsp;<span class="ident" id="8159569">err</span>&nbsp;<span class="op" id="8159573">:=</span>&nbsp;<span class="ident" id="8159576">Marshal</span><span class="op" id="8159583">(</span><span class="op" id="8159584">&amp;</span><span class="ident" id="8159585">data</span><span class="op" id="8159589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159592">if</span>&nbsp;<span class="ident" id="8159595">err</span>&nbsp;<span class="op" id="8159599">!=</span>&nbsp;<span class="ident" id="8159602">nil</span>&nbsp;<span class="op" id="8159606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159610">t</span><span class="op" id="8159611">.</span><span class="ident" id="8159612">Fatalf</span><span class="op" id="8159618">(</span><span class="string" id="8159619">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8159632">,</span>&nbsp;<span class="ident" id="8159634">err</span><span class="op" id="8159637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159643">if</span>&nbsp;<span class="builtintype" id="8159646">string</span><span class="op" id="8159652">(</span><span class="ident" id="8159653">b</span><span class="op" id="8159654">)</span>&nbsp;<span class="op" id="8159656">!=</span>&nbsp;<span class="ident" id="8159659">msg</span>&nbsp;<span class="op" id="8159663">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159667">t</span><span class="op" id="8159668">.</span><span class="ident" id="8159669">Fatalf</span><span class="op" id="8159675">(</span><span class="string" id="8159676">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8159704">,</span>&nbsp;<span class="ident" id="8159706">b</span><span class="op" id="8159707">,</span>&nbsp;<span class="ident" id="8159709">msg</span><span class="op" id="8159712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159715">}</span><br>
<span class="lineno"></span><span class="op" id="8159717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8159720">func</span>&nbsp;<span class="ident" id="8159725">TestNullRawMessage</span><span class="op" id="8159743">(</span><span class="ident" id="8159744">t</span>&nbsp;<span class="op" id="8159746">*</span><span class="ident" id="8159747">testing</span><span class="op" id="8159754">.</span><span class="ident" id="8159755">T</span><span class="op" id="8159756">)</span>&nbsp;<span class="op" id="8159758">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8159761">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159813">var</span>&nbsp;<span class="ident" id="8159817">data</span>&nbsp;<span class="keyword" id="8159822">struct</span>&nbsp;<span class="op" id="8159829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159833">X</span>&nbsp;&nbsp;<span class="builtintype" id="8159836">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159846">Id</span>&nbsp;<span class="op" id="8159849">*</span><span class="ident" id="8159850">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159863">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8159866">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8159875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159878">data</span><span class="op" id="8159882">.</span><span class="ident" id="8159883">Id</span>&nbsp;<span class="op" id="8159886">=</span>&nbsp;<span class="builtinfunc" id="8159888">new</span><span class="op" id="8159891">(</span><span class="ident" id="8159892">RawMessage</span><span class="op" id="8159902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159905">const</span>&nbsp;<span class="ident" id="8159911">msg</span>&nbsp;<span class="op" id="8159915">=</span>&nbsp;<span class="string" id="8159917">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8159948">err</span>&nbsp;<span class="op" id="8159952">:=</span>&nbsp;<span class="ident" id="8159955">Unmarshal</span><span class="op" id="8159964">(</span><span class="op" id="8159965">[</span><span class="op" id="8159966">]</span><span class="builtintype" id="8159967">byte</span><span class="op" id="8159971">(</span><span class="ident" id="8159972">msg</span><span class="op" id="8159975">)</span><span class="op" id="8159976">,</span>&nbsp;<span class="op" id="8159978">&amp;</span><span class="ident" id="8159979">data</span><span class="op" id="8159983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8159986">if</span>&nbsp;<span class="ident" id="8159989">err</span>&nbsp;<span class="op" id="8159993">!=</span>&nbsp;<span class="ident" id="8159996">nil</span>&nbsp;<span class="op" id="8160000">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160004">t</span><span class="op" id="8160005">.</span><span class="ident" id="8160006">Fatalf</span><span class="op" id="8160012">(</span><span class="string" id="8160013">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8160028">,</span>&nbsp;<span class="ident" id="8160030">err</span><span class="op" id="8160033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160039">if</span>&nbsp;<span class="ident" id="8160042">data</span><span class="op" id="8160046">.</span><span class="ident" id="8160047">Id</span>&nbsp;<span class="op" id="8160050">!=</span>&nbsp;<span class="ident" id="8160053">nil</span>&nbsp;<span class="op" id="8160057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160061">t</span><span class="op" id="8160062">.</span><span class="ident" id="8160063">Fatalf</span><span class="op" id="8160069">(</span><span class="string" id="8160070">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8160108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160111">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160114">b</span><span class="op" id="8160115">,</span>&nbsp;<span class="ident" id="8160117">err</span>&nbsp;<span class="op" id="8160121">:=</span>&nbsp;<span class="ident" id="8160124">Marshal</span><span class="op" id="8160131">(</span><span class="op" id="8160132">&amp;</span><span class="ident" id="8160133">data</span><span class="op" id="8160137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160140">if</span>&nbsp;<span class="ident" id="8160143">err</span>&nbsp;<span class="op" id="8160147">!=</span>&nbsp;<span class="ident" id="8160150">nil</span>&nbsp;<span class="op" id="8160154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160158">t</span><span class="op" id="8160159">.</span><span class="ident" id="8160160">Fatalf</span><span class="op" id="8160166">(</span><span class="string" id="8160167">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8160180">,</span>&nbsp;<span class="ident" id="8160182">err</span><span class="op" id="8160185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160191">if</span>&nbsp;<span class="builtintype" id="8160194">string</span><span class="op" id="8160200">(</span><span class="ident" id="8160201">b</span><span class="op" id="8160202">)</span>&nbsp;<span class="op" id="8160204">!=</span>&nbsp;<span class="ident" id="8160207">msg</span>&nbsp;<span class="op" id="8160211">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160215">t</span><span class="op" id="8160216">.</span><span class="ident" id="8160217">Fatalf</span><span class="op" id="8160223">(</span><span class="string" id="8160224">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8160252">,</span>&nbsp;<span class="ident" id="8160254">b</span><span class="op" id="8160255">,</span>&nbsp;<span class="ident" id="8160257">msg</span><span class="op" id="8160260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160263">}</span><br>
<span class="lineno"></span><span class="op" id="8160265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8160268">var</span>&nbsp;<span class="ident" id="8160272">blockingTests</span>&nbsp;<span class="op" id="8160286">=</span>&nbsp;<span class="op" id="8160288">[</span><span class="op" id="8160289">]</span><span class="builtintype" id="8160290">string</span><span class="op" id="8160296">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8160299">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="8160309">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8160312">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="8160323">,</span><br>
<span class="lineno"></span><span class="op" id="8160325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8160328">func</span>&nbsp;<span class="ident" id="8160333">TestBlocking</span><span class="op" id="8160345">(</span><span class="ident" id="8160346">t</span>&nbsp;<span class="op" id="8160348">*</span><span class="ident" id="8160349">testing</span><span class="op" id="8160356">.</span><span class="ident" id="8160357">T</span><span class="op" id="8160358">)</span>&nbsp;<span class="op" id="8160360">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160363">for</span>&nbsp;<span class="ident" id="8160367">_</span><span class="op" id="8160368">,</span>&nbsp;<span class="ident" id="8160370">enc</span>&nbsp;<span class="op" id="8160374">:=</span>&nbsp;<span class="keyword" id="8160377">range</span>&nbsp;<span class="ident" id="8160383">blockingTests</span>&nbsp;<span class="op" id="8160397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160401">r</span><span class="op" id="8160402">,</span>&nbsp;<span class="ident" id="8160404">w</span>&nbsp;<span class="op" id="8160406">:=</span>&nbsp;<span class="ident" id="8160409">net</span><span class="op" id="8160412">.</span><span class="ident" id="8160413">Pipe</span><span class="op" id="8160417">(</span><span class="op" id="8160418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160422">go</span>&nbsp;<span class="ident" id="8160425">w</span><span class="op" id="8160426">.</span><span class="ident" id="8160427">Write</span><span class="op" id="8160432">(</span><span class="op" id="8160433">[</span><span class="op" id="8160434">]</span><span class="builtintype" id="8160435">byte</span><span class="op" id="8160439">(</span><span class="ident" id="8160440">enc</span><span class="op" id="8160443">)</span><span class="op" id="8160444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160448">var</span>&nbsp;<span class="ident" id="8160452">val</span>&nbsp;<span class="keyword" id="8160456">interface</span><span class="op" id="8160465">{</span><span class="op" id="8160466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8160471">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8160526">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160574">if</span>&nbsp;<span class="ident" id="8160577">err</span>&nbsp;<span class="op" id="8160581">:=</span>&nbsp;<span class="ident" id="8160584">NewDecoder</span><span class="op" id="8160594">(</span><span class="ident" id="8160595">r</span><span class="op" id="8160596">)</span><span class="op" id="8160597">.</span><span class="ident" id="8160598">Decode</span><span class="op" id="8160604">(</span><span class="op" id="8160605">&amp;</span><span class="ident" id="8160606">val</span><span class="op" id="8160609">)</span><span class="op" id="8160610">;</span>&nbsp;<span class="ident" id="8160612">err</span>&nbsp;<span class="op" id="8160616">!=</span>&nbsp;<span class="ident" id="8160619">nil</span>&nbsp;<span class="op" id="8160623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160628">t</span><span class="op" id="8160629">.</span><span class="ident" id="8160630">Errorf</span><span class="op" id="8160636">(</span><span class="string" id="8160637">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8160654">,</span>&nbsp;<span class="ident" id="8160656">enc</span><span class="op" id="8160659">,</span>&nbsp;<span class="ident" id="8160661">err</span><span class="op" id="8160664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160668">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160672">r</span><span class="op" id="8160673">.</span><span class="ident" id="8160674">Close</span><span class="op" id="8160679">(</span><span class="op" id="8160680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160684">w</span><span class="op" id="8160685">.</span><span class="ident" id="8160686">Close</span><span class="op" id="8160691">(</span><span class="op" id="8160692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160695">}</span><br>
<span class="lineno"></span><span class="op" id="8160697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="8160700">func</span>&nbsp;<span class="ident" id="8160705">BenchmarkEncoderEncode</span><span class="op" id="8160727">(</span><span class="ident" id="8160728">b</span>&nbsp;<span class="op" id="8160730">*</span><span class="ident" id="8160731">testing</span><span class="op" id="8160738">.</span><span class="ident" id="8160739">B</span><span class="op" id="8160740">)</span>&nbsp;<span class="op" id="8160742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160745">b</span><span class="op" id="8160746">.</span><span class="ident" id="8160747">ReportAllocs</span><span class="op" id="8160759">(</span><span class="op" id="8160760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160763">type</span>&nbsp;<span class="ident" id="8160768">T</span>&nbsp;<span class="keyword" id="8160770">struct</span>&nbsp;<span class="op" id="8160777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160781">X</span><span class="op" id="8160782">,</span>&nbsp;<span class="ident" id="8160784">Y</span>&nbsp;<span class="builtintype" id="8160786">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160794">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160797">v</span>&nbsp;<span class="op" id="8160799">:=</span>&nbsp;<span class="op" id="8160802">&amp;</span><span class="ident" id="8160803">T</span><span class="op" id="8160804">{</span><span class="string" id="8160805">&#34;foo&#34;</span><span class="op" id="8160810">,</span>&nbsp;<span class="string" id="8160812">&#34;bar&#34;</span><span class="op" id="8160817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160820">for</span>&nbsp;<span class="ident" id="8160824">i</span>&nbsp;<span class="op" id="8160826">:=</span>&nbsp;<span class="num" id="8160829">0</span><span class="op" id="8160830">;</span>&nbsp;<span class="ident" id="8160832">i</span>&nbsp;<span class="op" id="8160834">&lt;</span>&nbsp;<span class="ident" id="8160836">b</span><span class="op" id="8160837">.</span><span class="ident" id="8160838">N</span><span class="op" id="8160839">;</span>&nbsp;<span class="ident" id="8160841">i</span><span class="op" id="8160842">++</span>&nbsp;<span class="op" id="8160845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8160849">if</span>&nbsp;<span class="ident" id="8160852">err</span>&nbsp;<span class="op" id="8160856">:=</span>&nbsp;<span class="ident" id="8160859">NewEncoder</span><span class="op" id="8160869">(</span><span class="ident" id="8160870">ioutil</span><span class="op" id="8160876">.</span><span class="ident" id="8160877">Discard</span><span class="op" id="8160884">)</span><span class="op" id="8160885">.</span><span class="ident" id="8160886">Encode</span><span class="op" id="8160892">(</span><span class="ident" id="8160893">v</span><span class="op" id="8160894">)</span><span class="op" id="8160895">;</span>&nbsp;<span class="ident" id="8160897">err</span>&nbsp;<span class="op" id="8160901">!=</span>&nbsp;<span class="ident" id="8160904">nil</span>&nbsp;<span class="op" id="8160908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8160913">b</span><span class="op" id="8160914">.</span><span class="ident" id="8160915">Fatal</span><span class="op" id="8160920">(</span><span class="ident" id="8160921">err</span><span class="op" id="8160924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160928">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8160931">}</span><br>
<span class="lineno"></span><span class="op" id="8160933">}</span>
</div>
</body>
</html>
