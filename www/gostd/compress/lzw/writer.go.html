<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5354296">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5354351">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5354405">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5354456">package</span>&nbsp;<span class="ident" id="5354464">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5354469">import</span>&nbsp;<span class="op" id="5354476">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354479">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354488">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354498">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5354505">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5354510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5354513">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5354558">type</span>&nbsp;<span class="ident" id="5354563">writer</span>&nbsp;<span class="keyword" id="5354570">interface</span>&nbsp;<span class="op" id="5354580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354583">io</span><span class="op" id="5354585">.</span><span class="ident" id="5354586">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354598">Flush</span><span class="op" id="5354603">(</span><span class="op" id="5354604">)</span>&nbsp;<span class="builtintype" id="5354606">error</span><br>
<span class="lineno"></span><span class="op" id="5354612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5354615">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5354692">type</span>&nbsp;<span class="ident" id="5354697">errWriteCloser</span>&nbsp;<span class="keyword" id="5354712">struct</span>&nbsp;<span class="op" id="5354719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354722">err</span>&nbsp;<span class="builtintype" id="5354726">error</span><br>
<span class="lineno"></span><span class="op" id="5354732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5354735">func</span>&nbsp;<span class="op" id="5354740">(</span><span class="ident" id="5354741">e</span>&nbsp;<span class="op" id="5354743">*</span><span class="ident" id="5354744">errWriteCloser</span><span class="op" id="5354758">)</span>&nbsp;<span class="ident" id="5354760">Write</span><span class="op" id="5354765">(</span><span class="op" id="5354766">[</span><span class="op" id="5354767">]</span><span class="builtintype" id="5354768">byte</span><span class="op" id="5354772">)</span>&nbsp;<span class="op" id="5354774">(</span><span class="builtintype" id="5354775">int</span><span class="op" id="5354778">,</span>&nbsp;<span class="builtintype" id="5354780">error</span><span class="op" id="5354785">)</span>&nbsp;<span class="op" id="5354787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354790">return</span>&nbsp;<span class="num" id="5354797">0</span><span class="op" id="5354798">,</span>&nbsp;<span class="ident" id="5354800">e</span><span class="op" id="5354801">.</span><span class="ident" id="5354802">err</span><br>
<span class="lineno"></span><span class="op" id="5354806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5354809">func</span>&nbsp;<span class="op" id="5354814">(</span><span class="ident" id="5354815">e</span>&nbsp;<span class="op" id="5354817">*</span><span class="ident" id="5354818">errWriteCloser</span><span class="op" id="5354832">)</span>&nbsp;<span class="ident" id="5354834">Close</span><span class="op" id="5354839">(</span><span class="op" id="5354840">)</span>&nbsp;<span class="builtintype" id="5354842">error</span>&nbsp;<span class="op" id="5354848">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354851">return</span>&nbsp;<span class="ident" id="5354858">e</span><span class="op" id="5354859">.</span><span class="ident" id="5354860">err</span><br>
<span class="lineno"></span><span class="op" id="5354864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5354867">const</span>&nbsp;<span class="op" id="5354873">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5354876">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5354948">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354989">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5355001">=</span>&nbsp;<span class="num" id="5355003">1</span><span class="op" id="5355004">&lt;&lt;</span><span class="num" id="5355006">12</span>&nbsp;<span class="op" id="5355009">-</span>&nbsp;<span class="num" id="5355011">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355014">invalidCode</span>&nbsp;<span class="op" id="5355026">=</span>&nbsp;<span class="num" id="5355028">1</span><span class="op" id="5355029">&lt;&lt;</span><span class="num" id="5355031">32</span>&nbsp;<span class="op" id="5355034">-</span>&nbsp;<span class="num" id="5355036">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355039">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355116">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355195">tableSize</span>&nbsp;<span class="op" id="5355205">=</span>&nbsp;<span class="num" id="5355207">4</span>&nbsp;<span class="op" id="5355209">*</span>&nbsp;<span class="num" id="5355211">1</span>&nbsp;<span class="op" id="5355213">&lt;&lt;</span>&nbsp;<span class="num" id="5355216">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355220">tableMask</span>&nbsp;<span class="op" id="5355230">=</span>&nbsp;<span class="ident" id="5355232">tableSize</span>&nbsp;<span class="op" id="5355242">-</span>&nbsp;<span class="num" id="5355244">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355247">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355318">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355381">invalidEntry</span>&nbsp;<span class="op" id="5355394">=</span>&nbsp;<span class="num" id="5355396">0</span><br>
<span class="lineno">45</span><span class="op" id="5355398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5355401">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5355431">type</span>&nbsp;<span class="ident" id="5355436">encoder</span>&nbsp;<span class="keyword" id="5355444">struct</span>&nbsp;<span class="op" id="5355451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355454">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355512">w</span>&nbsp;<span class="ident" id="5355514">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355522">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355580">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355629">order</span>&nbsp;<span class="ident" id="5355635">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355642">write</span>&nbsp;<span class="keyword" id="5355648">func</span><span class="op" id="5355652">(</span><span class="op" id="5355653">*</span><span class="ident" id="5355654">encoder</span><span class="op" id="5355661">,</span>&nbsp;<span class="builtintype" id="5355663">uint32</span><span class="op" id="5355669">)</span>&nbsp;<span class="builtintype" id="5355671">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355678">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5355684">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355692">nBits</span>&nbsp;<span class="builtintype" id="5355698">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355704">width</span>&nbsp;<span class="builtintype" id="5355710">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355716">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355768">litWidth</span>&nbsp;<span class="builtintype" id="5355777">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355783">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355837">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5355900">hi</span><span class="op" id="5355902">,</span>&nbsp;<span class="ident" id="5355904">overflow</span>&nbsp;<span class="builtintype" id="5355913">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355921">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5355995">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356059">savedCode</span>&nbsp;<span class="builtintype" id="5356069">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5356077">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5356152">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356206">err</span>&nbsp;<span class="builtintype" id="5356210">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5356217">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5356291">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5356364">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5356435">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356469">table</span>&nbsp;<span class="op" id="5356475">[</span><span class="ident" id="5356476">tableSize</span><span class="op" id="5356485">]</span><span class="builtintype" id="5356486">uint32</span><br>
<span class="lineno"></span><span class="op" id="5356493">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5356496">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5356567">func</span>&nbsp;<span class="op" id="5356572">(</span><span class="ident" id="5356573">e</span>&nbsp;<span class="op" id="5356575">*</span><span class="ident" id="5356576">encoder</span><span class="op" id="5356583">)</span>&nbsp;<span class="ident" id="5356585">writeLSB</span><span class="op" id="5356593">(</span><span class="ident" id="5356594">c</span>&nbsp;<span class="builtintype" id="5356596">uint32</span><span class="op" id="5356602">)</span>&nbsp;<span class="builtintype" id="5356604">error</span>&nbsp;<span class="op" id="5356610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356613">e</span><span class="op" id="5356614">.</span><span class="ident" id="5356615">bits</span>&nbsp;<span class="op" id="5356620">|=</span>&nbsp;<span class="ident" id="5356623">c</span>&nbsp;<span class="op" id="5356625">&lt;&lt;</span>&nbsp;<span class="ident" id="5356628">e</span><span class="op" id="5356629">.</span><span class="ident" id="5356630">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356637">e</span><span class="op" id="5356638">.</span><span class="ident" id="5356639">nBits</span>&nbsp;<span class="op" id="5356645">+=</span>&nbsp;<span class="ident" id="5356648">e</span><span class="op" id="5356649">.</span><span class="ident" id="5356650">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356657">for</span>&nbsp;<span class="ident" id="5356661">e</span><span class="op" id="5356662">.</span><span class="ident" id="5356663">nBits</span>&nbsp;<span class="op" id="5356669">&gt;=</span>&nbsp;<span class="num" id="5356672">8</span>&nbsp;<span class="op" id="5356674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356678">if</span>&nbsp;<span class="ident" id="5356681">err</span>&nbsp;<span class="op" id="5356685">:=</span>&nbsp;<span class="ident" id="5356688">e</span><span class="op" id="5356689">.</span><span class="ident" id="5356690">w</span><span class="op" id="5356691">.</span><span class="ident" id="5356692">WriteByte</span><span class="op" id="5356701">(</span><span class="builtintype" id="5356702">uint8</span><span class="op" id="5356707">(</span><span class="ident" id="5356708">e</span><span class="op" id="5356709">.</span><span class="ident" id="5356710">bits</span><span class="op" id="5356714">)</span><span class="op" id="5356715">)</span><span class="op" id="5356716">;</span>&nbsp;<span class="ident" id="5356718">err</span>&nbsp;<span class="op" id="5356722">!=</span>&nbsp;<span class="ident" id="5356725">nil</span>&nbsp;<span class="op" id="5356729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356734">return</span>&nbsp;<span class="ident" id="5356741">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356751">e</span><span class="op" id="5356752">.</span><span class="ident" id="5356753">bits</span>&nbsp;<span class="op" id="5356758">&gt;&gt;=</span>&nbsp;<span class="num" id="5356762">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356766">e</span><span class="op" id="5356767">.</span><span class="ident" id="5356768">nBits</span>&nbsp;<span class="op" id="5356774">-=</span>&nbsp;<span class="num" id="5356777">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5356780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356783">return</span>&nbsp;<span class="ident" id="5356790">nil</span><br>
<span class="lineno"></span><span class="op" id="5356794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5356797">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5356867">func</span>&nbsp;<span class="op" id="5356872">(</span><span class="ident" id="5356873">e</span>&nbsp;<span class="op" id="5356875">*</span><span class="ident" id="5356876">encoder</span><span class="op" id="5356883">)</span>&nbsp;<span class="ident" id="5356885">writeMSB</span><span class="op" id="5356893">(</span><span class="ident" id="5356894">c</span>&nbsp;<span class="builtintype" id="5356896">uint32</span><span class="op" id="5356902">)</span>&nbsp;<span class="builtintype" id="5356904">error</span>&nbsp;<span class="op" id="5356910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356913">e</span><span class="op" id="5356914">.</span><span class="ident" id="5356915">bits</span>&nbsp;<span class="op" id="5356920">|=</span>&nbsp;<span class="ident" id="5356923">c</span>&nbsp;<span class="op" id="5356925">&lt;&lt;</span>&nbsp;<span class="op" id="5356928">(</span><span class="num" id="5356929">32</span>&nbsp;<span class="op" id="5356932">-</span>&nbsp;<span class="ident" id="5356934">e</span><span class="op" id="5356935">.</span><span class="ident" id="5356936">width</span>&nbsp;<span class="op" id="5356942">-</span>&nbsp;<span class="ident" id="5356944">e</span><span class="op" id="5356945">.</span><span class="ident" id="5356946">nBits</span><span class="op" id="5356951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5356954">e</span><span class="op" id="5356955">.</span><span class="ident" id="5356956">nBits</span>&nbsp;<span class="op" id="5356962">+=</span>&nbsp;<span class="ident" id="5356965">e</span><span class="op" id="5356966">.</span><span class="ident" id="5356967">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356974">for</span>&nbsp;<span class="ident" id="5356978">e</span><span class="op" id="5356979">.</span><span class="ident" id="5356980">nBits</span>&nbsp;<span class="op" id="5356986">&gt;=</span>&nbsp;<span class="num" id="5356989">8</span>&nbsp;<span class="op" id="5356991">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5356995">if</span>&nbsp;<span class="ident" id="5356998">err</span>&nbsp;<span class="op" id="5357002">:=</span>&nbsp;<span class="ident" id="5357005">e</span><span class="op" id="5357006">.</span><span class="ident" id="5357007">w</span><span class="op" id="5357008">.</span><span class="ident" id="5357009">WriteByte</span><span class="op" id="5357018">(</span><span class="builtintype" id="5357019">uint8</span><span class="op" id="5357024">(</span><span class="ident" id="5357025">e</span><span class="op" id="5357026">.</span><span class="ident" id="5357027">bits</span>&nbsp;<span class="op" id="5357032">&gt;&gt;</span>&nbsp;<span class="num" id="5357035">24</span><span class="op" id="5357037">)</span><span class="op" id="5357038">)</span><span class="op" id="5357039">;</span>&nbsp;<span class="ident" id="5357041">err</span>&nbsp;<span class="op" id="5357045">!=</span>&nbsp;<span class="ident" id="5357048">nil</span>&nbsp;<span class="op" id="5357052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357057">return</span>&nbsp;<span class="ident" id="5357064">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357074">e</span><span class="op" id="5357075">.</span><span class="ident" id="5357076">bits</span>&nbsp;<span class="op" id="5357081">&lt;&lt;=</span>&nbsp;<span class="num" id="5357085">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357089">e</span><span class="op" id="5357090">.</span><span class="ident" id="5357091">nBits</span>&nbsp;<span class="op" id="5357097">-=</span>&nbsp;<span class="num" id="5357100">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357106">return</span>&nbsp;<span class="ident" id="5357113">nil</span><br>
<span class="lineno"></span><span class="op" id="5357117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5357120">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5357198">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5357257">var</span>&nbsp;<span class="ident" id="5357261">errOutOfCodes</span>&nbsp;<span class="op" id="5357275">=</span>&nbsp;<span class="ident" id="5357277">errors</span><span class="op" id="5357283">.</span><span class="ident" id="5357284">New</span><span class="op" id="5357287">(</span><span class="string" id="5357288">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5357307">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5357310">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5357383">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5357457">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5357501">func</span>&nbsp;<span class="op" id="5357506">(</span><span class="ident" id="5357507">e</span>&nbsp;<span class="op" id="5357509">*</span><span class="ident" id="5357510">encoder</span><span class="op" id="5357517">)</span>&nbsp;<span class="ident" id="5357519">incHi</span><span class="op" id="5357524">(</span><span class="op" id="5357525">)</span>&nbsp;<span class="builtintype" id="5357527">error</span>&nbsp;<span class="op" id="5357533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357536">e</span><span class="op" id="5357537">.</span><span class="ident" id="5357538">hi</span><span class="op" id="5357540">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357544">if</span>&nbsp;<span class="ident" id="5357547">e</span><span class="op" id="5357548">.</span><span class="ident" id="5357549">hi</span>&nbsp;<span class="op" id="5357552">==</span>&nbsp;<span class="ident" id="5357555">e</span><span class="op" id="5357556">.</span><span class="ident" id="5357557">overflow</span>&nbsp;<span class="op" id="5357566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357570">e</span><span class="op" id="5357571">.</span><span class="ident" id="5357572">width</span><span class="op" id="5357577">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357582">e</span><span class="op" id="5357583">.</span><span class="ident" id="5357584">overflow</span>&nbsp;<span class="op" id="5357593">&lt;&lt;=</span>&nbsp;<span class="num" id="5357597">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357603">if</span>&nbsp;<span class="ident" id="5357606">e</span><span class="op" id="5357607">.</span><span class="ident" id="5357608">hi</span>&nbsp;<span class="op" id="5357611">==</span>&nbsp;<span class="ident" id="5357614">maxCode</span>&nbsp;<span class="op" id="5357622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357626">clear</span>&nbsp;<span class="op" id="5357632">:=</span>&nbsp;<span class="builtintype" id="5357635">uint32</span><span class="op" id="5357641">(</span><span class="num" id="5357642">1</span><span class="op" id="5357643">)</span>&nbsp;<span class="op" id="5357645">&lt;&lt;</span>&nbsp;<span class="ident" id="5357648">e</span><span class="op" id="5357649">.</span><span class="ident" id="5357650">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357661">if</span>&nbsp;<span class="ident" id="5357664">err</span>&nbsp;<span class="op" id="5357668">:=</span>&nbsp;<span class="ident" id="5357671">e</span><span class="op" id="5357672">.</span><span class="ident" id="5357673">write</span><span class="op" id="5357678">(</span><span class="ident" id="5357679">e</span><span class="op" id="5357680">,</span>&nbsp;<span class="ident" id="5357682">clear</span><span class="op" id="5357687">)</span><span class="op" id="5357688">;</span>&nbsp;<span class="ident" id="5357690">err</span>&nbsp;<span class="op" id="5357694">!=</span>&nbsp;<span class="ident" id="5357697">nil</span>&nbsp;<span class="op" id="5357701">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357706">return</span>&nbsp;<span class="ident" id="5357713">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357723">e</span><span class="op" id="5357724">.</span><span class="ident" id="5357725">width</span>&nbsp;<span class="op" id="5357731">=</span>&nbsp;<span class="builtintype" id="5357733">uint</span><span class="op" id="5357737">(</span><span class="ident" id="5357738">e</span><span class="op" id="5357739">.</span><span class="ident" id="5357740">litWidth</span><span class="op" id="5357748">)</span>&nbsp;<span class="op" id="5357750">+</span>&nbsp;<span class="num" id="5357752">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357756">e</span><span class="op" id="5357757">.</span><span class="ident" id="5357758">hi</span>&nbsp;<span class="op" id="5357761">=</span>&nbsp;<span class="ident" id="5357763">clear</span>&nbsp;<span class="op" id="5357769">+</span>&nbsp;<span class="num" id="5357771">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357775">e</span><span class="op" id="5357776">.</span><span class="ident" id="5357777">overflow</span>&nbsp;<span class="op" id="5357786">=</span>&nbsp;<span class="ident" id="5357788">clear</span>&nbsp;<span class="op" id="5357794">&lt;&lt;</span>&nbsp;<span class="num" id="5357797">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357801">for</span>&nbsp;<span class="ident" id="5357805">i</span>&nbsp;<span class="op" id="5357807">:=</span>&nbsp;<span class="keyword" id="5357810">range</span>&nbsp;<span class="ident" id="5357816">e</span><span class="op" id="5357817">.</span><span class="ident" id="5357818">table</span>&nbsp;<span class="op" id="5357824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5357829">e</span><span class="op" id="5357830">.</span><span class="ident" id="5357831">table</span><span class="op" id="5357836">[</span><span class="ident" id="5357837">i</span><span class="op" id="5357838">]</span>&nbsp;<span class="op" id="5357840">=</span>&nbsp;<span class="ident" id="5357842">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357861">return</span>&nbsp;<span class="ident" id="5357868">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5357883">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5357886">return</span>&nbsp;<span class="ident" id="5357893">nil</span><br>
<span class="lineno"></span><span class="op" id="5357897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5357900">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5357975">func</span>&nbsp;<span class="op" id="5357980">(</span><span class="ident" id="5357981">e</span>&nbsp;<span class="op" id="5357983">*</span><span class="ident" id="5357984">encoder</span><span class="op" id="5357991">)</span>&nbsp;<span class="ident" id="5357993">Write</span><span class="op" id="5357998">(</span><span class="ident" id="5357999">p</span>&nbsp;<span class="op" id="5358001">[</span><span class="op" id="5358002">]</span><span class="builtintype" id="5358003">byte</span><span class="op" id="5358007">)</span>&nbsp;<span class="op" id="5358009">(</span><span class="ident" id="5358010">n</span>&nbsp;<span class="builtintype" id="5358012">int</span><span class="op" id="5358015">,</span>&nbsp;<span class="ident" id="5358017">err</span>&nbsp;<span class="builtintype" id="5358021">error</span><span class="op" id="5358026">)</span>&nbsp;<span class="op" id="5358028">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358031">if</span>&nbsp;<span class="ident" id="5358034">e</span><span class="op" id="5358035">.</span><span class="ident" id="5358036">err</span>&nbsp;<span class="op" id="5358040">!=</span>&nbsp;<span class="ident" id="5358043">nil</span>&nbsp;<span class="op" id="5358047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358051">return</span>&nbsp;<span class="num" id="5358058">0</span><span class="op" id="5358059">,</span>&nbsp;<span class="ident" id="5358061">e</span><span class="op" id="5358062">.</span><span class="ident" id="5358063">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358071">if</span>&nbsp;<span class="builtinfunc" id="5358074">len</span><span class="op" id="5358077">(</span><span class="ident" id="5358078">p</span><span class="op" id="5358079">)</span>&nbsp;<span class="op" id="5358081">==</span>&nbsp;<span class="num" id="5358084">0</span>&nbsp;<span class="op" id="5358086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358090">return</span>&nbsp;<span class="num" id="5358097">0</span><span class="op" id="5358098">,</span>&nbsp;<span class="ident" id="5358100">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358108">n</span>&nbsp;<span class="op" id="5358110">=</span>&nbsp;<span class="builtinfunc" id="5358112">len</span><span class="op" id="5358115">(</span><span class="ident" id="5358116">p</span><span class="op" id="5358117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358120">litMask</span>&nbsp;<span class="op" id="5358128">:=</span>&nbsp;<span class="builtintype" id="5358131">uint32</span><span class="op" id="5358137">(</span><span class="num" id="5358138">1</span><span class="op" id="5358139">&lt;&lt;</span><span class="ident" id="5358141">e</span><span class="op" id="5358142">.</span><span class="ident" id="5358143">litWidth</span>&nbsp;<span class="op" id="5358152">-</span>&nbsp;<span class="num" id="5358154">1</span><span class="op" id="5358155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358158">code</span>&nbsp;<span class="op" id="5358163">:=</span>&nbsp;<span class="ident" id="5358166">e</span><span class="op" id="5358167">.</span><span class="ident" id="5358168">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358179">if</span>&nbsp;<span class="ident" id="5358182">code</span>&nbsp;<span class="op" id="5358187">==</span>&nbsp;<span class="ident" id="5358190">invalidCode</span>&nbsp;<span class="op" id="5358202">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358206">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358257">code</span><span class="op" id="5358261">,</span>&nbsp;<span class="ident" id="5358263">p</span>&nbsp;<span class="op" id="5358265">=</span>&nbsp;<span class="builtintype" id="5358267">uint32</span><span class="op" id="5358273">(</span><span class="ident" id="5358274">p</span><span class="op" id="5358275">[</span><span class="num" id="5358276">0</span><span class="op" id="5358277">]</span><span class="op" id="5358278">)</span><span class="op" id="5358279">&amp;</span><span class="ident" id="5358280">litMask</span><span class="op" id="5358287">,</span>&nbsp;<span class="ident" id="5358289">p</span><span class="op" id="5358290">[</span><span class="num" id="5358291">1</span><span class="op" id="5358292">:</span><span class="op" id="5358293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358296">}</span><br>
<span class="lineno"></span><span class="ident" id="5358298">loop</span><span class="op" id="5358302">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358305">for</span>&nbsp;<span class="ident" id="5358309">_</span><span class="op" id="5358310">,</span>&nbsp;<span class="ident" id="5358312">x</span>&nbsp;<span class="op" id="5358314">:=</span>&nbsp;<span class="keyword" id="5358317">range</span>&nbsp;<span class="ident" id="5358323">p</span>&nbsp;<span class="op" id="5358325">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358329">literal</span>&nbsp;<span class="op" id="5358337">:=</span>&nbsp;<span class="builtintype" id="5358340">uint32</span><span class="op" id="5358346">(</span><span class="ident" id="5358347">x</span><span class="op" id="5358348">)</span>&nbsp;<span class="op" id="5358350">&amp;</span>&nbsp;<span class="ident" id="5358352">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358362">key</span>&nbsp;<span class="op" id="5358366">:=</span>&nbsp;<span class="ident" id="5358369">code</span><span class="op" id="5358373">&lt;&lt;</span><span class="num" id="5358375">8</span>&nbsp;<span class="op" id="5358377">|</span>&nbsp;<span class="ident" id="5358379">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358389">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358462">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358495">hash</span>&nbsp;<span class="op" id="5358500">:=</span>&nbsp;<span class="op" id="5358503">(</span><span class="ident" id="5358504">key</span><span class="op" id="5358507">&gt;&gt;</span><span class="num" id="5358509">12</span>&nbsp;<span class="op" id="5358512">^</span>&nbsp;<span class="ident" id="5358514">key</span><span class="op" id="5358517">)</span>&nbsp;<span class="op" id="5358519">&amp;</span>&nbsp;<span class="ident" id="5358521">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358533">for</span>&nbsp;<span class="ident" id="5358537">h</span><span class="op" id="5358538">,</span>&nbsp;<span class="ident" id="5358540">t</span>&nbsp;<span class="op" id="5358542">:=</span>&nbsp;<span class="ident" id="5358545">hash</span><span class="op" id="5358549">,</span>&nbsp;<span class="ident" id="5358551">e</span><span class="op" id="5358552">.</span><span class="ident" id="5358553">table</span><span class="op" id="5358558">[</span><span class="ident" id="5358559">hash</span><span class="op" id="5358563">]</span><span class="op" id="5358564">;</span>&nbsp;<span class="ident" id="5358566">t</span>&nbsp;<span class="op" id="5358568">!=</span>&nbsp;<span class="ident" id="5358571">invalidEntry</span><span class="op" id="5358583">;</span>&nbsp;<span class="op" id="5358585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358590">if</span>&nbsp;<span class="ident" id="5358593">key</span>&nbsp;<span class="op" id="5358597">==</span>&nbsp;<span class="ident" id="5358600">t</span><span class="op" id="5358601">&gt;&gt;</span><span class="num" id="5358603">12</span>&nbsp;<span class="op" id="5358606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358612">code</span>&nbsp;<span class="op" id="5358617">=</span>&nbsp;<span class="ident" id="5358619">t</span>&nbsp;<span class="op" id="5358621">&amp;</span>&nbsp;<span class="ident" id="5358623">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358635">continue</span>&nbsp;<span class="ident" id="5358644">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358652">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358657">h</span>&nbsp;<span class="op" id="5358659">=</span>&nbsp;<span class="op" id="5358661">(</span><span class="ident" id="5358662">h</span>&nbsp;<span class="op" id="5358664">+</span>&nbsp;<span class="num" id="5358666">1</span><span class="op" id="5358667">)</span>&nbsp;<span class="op" id="5358669">&amp;</span>&nbsp;<span class="ident" id="5358671">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358684">t</span>&nbsp;<span class="op" id="5358686">=</span>&nbsp;<span class="ident" id="5358688">e</span><span class="op" id="5358689">.</span><span class="ident" id="5358690">table</span><span class="op" id="5358695">[</span><span class="ident" id="5358696">h</span><span class="op" id="5358697">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358705">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358778">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358806">if</span>&nbsp;<span class="ident" id="5358809">e</span><span class="op" id="5358810">.</span><span class="ident" id="5358811">err</span>&nbsp;<span class="op" id="5358815">=</span>&nbsp;<span class="ident" id="5358817">e</span><span class="op" id="5358818">.</span><span class="ident" id="5358819">write</span><span class="op" id="5358824">(</span><span class="ident" id="5358825">e</span><span class="op" id="5358826">,</span>&nbsp;<span class="ident" id="5358828">code</span><span class="op" id="5358832">)</span><span class="op" id="5358833">;</span>&nbsp;<span class="ident" id="5358835">e</span><span class="op" id="5358836">.</span><span class="ident" id="5358837">err</span>&nbsp;<span class="op" id="5358841">!=</span>&nbsp;<span class="ident" id="5358844">nil</span>&nbsp;<span class="op" id="5358848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5358853">return</span>&nbsp;<span class="num" id="5358860">0</span><span class="op" id="5358861">,</span>&nbsp;<span class="ident" id="5358863">e</span><span class="op" id="5358864">.</span><span class="ident" id="5358865">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5358871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5358875">code</span>&nbsp;<span class="op" id="5358880">=</span>&nbsp;<span class="ident" id="5358882">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358892">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5358966">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359039">if</span>&nbsp;<span class="ident" id="5359042">err1</span>&nbsp;<span class="op" id="5359047">:=</span>&nbsp;<span class="ident" id="5359050">e</span><span class="op" id="5359051">.</span><span class="ident" id="5359052">incHi</span><span class="op" id="5359057">(</span><span class="op" id="5359058">)</span><span class="op" id="5359059">;</span>&nbsp;<span class="ident" id="5359061">err1</span>&nbsp;<span class="op" id="5359066">!=</span>&nbsp;<span class="ident" id="5359069">nil</span>&nbsp;<span class="op" id="5359073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359078">if</span>&nbsp;<span class="ident" id="5359081">err1</span>&nbsp;<span class="op" id="5359086">==</span>&nbsp;<span class="ident" id="5359089">errOutOfCodes</span>&nbsp;<span class="op" id="5359103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359109">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359121">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359126">e</span><span class="op" id="5359127">.</span><span class="ident" id="5359128">err</span>&nbsp;<span class="op" id="5359132">=</span>&nbsp;<span class="ident" id="5359134">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359142">return</span>&nbsp;<span class="num" id="5359149">0</span><span class="op" id="5359150">,</span>&nbsp;<span class="ident" id="5359152">e</span><span class="op" id="5359153">.</span><span class="ident" id="5359154">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359164">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359237">for</span>&nbsp;<span class="op" id="5359241">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359246">if</span>&nbsp;<span class="ident" id="5359249">e</span><span class="op" id="5359250">.</span><span class="ident" id="5359251">table</span><span class="op" id="5359256">[</span><span class="ident" id="5359257">hash</span><span class="op" id="5359261">]</span>&nbsp;<span class="op" id="5359263">==</span>&nbsp;<span class="ident" id="5359266">invalidEntry</span>&nbsp;<span class="op" id="5359279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359285">e</span><span class="op" id="5359286">.</span><span class="ident" id="5359287">table</span><span class="op" id="5359292">[</span><span class="ident" id="5359293">hash</span><span class="op" id="5359297">]</span>&nbsp;<span class="op" id="5359299">=</span>&nbsp;<span class="op" id="5359301">(</span><span class="ident" id="5359302">key</span>&nbsp;<span class="op" id="5359306">&lt;&lt;</span>&nbsp;<span class="num" id="5359309">12</span><span class="op" id="5359311">)</span>&nbsp;<span class="op" id="5359313">|</span>&nbsp;<span class="ident" id="5359315">e</span><span class="op" id="5359316">.</span><span class="ident" id="5359317">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359324">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359338">hash</span>&nbsp;<span class="op" id="5359343">=</span>&nbsp;<span class="op" id="5359345">(</span><span class="ident" id="5359346">hash</span>&nbsp;<span class="op" id="5359351">+</span>&nbsp;<span class="num" id="5359353">1</span><span class="op" id="5359354">)</span>&nbsp;<span class="op" id="5359356">&amp;</span>&nbsp;<span class="ident" id="5359358">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359376">e</span><span class="op" id="5359377">.</span><span class="ident" id="5359378">savedCode</span>&nbsp;<span class="op" id="5359388">=</span>&nbsp;<span class="ident" id="5359390">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359396">return</span>&nbsp;<span class="ident" id="5359403">n</span><span class="op" id="5359404">,</span>&nbsp;<span class="ident" id="5359406">nil</span><br>
<span class="lineno"></span><span class="op" id="5359410">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5359413">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5359492">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5359524">func</span>&nbsp;<span class="op" id="5359529">(</span><span class="ident" id="5359530">e</span>&nbsp;<span class="op" id="5359532">*</span><span class="ident" id="5359533">encoder</span><span class="op" id="5359540">)</span>&nbsp;<span class="ident" id="5359542">Close</span><span class="op" id="5359547">(</span><span class="op" id="5359548">)</span>&nbsp;<span class="builtintype" id="5359550">error</span>&nbsp;<span class="op" id="5359556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359559">if</span>&nbsp;<span class="ident" id="5359562">e</span><span class="op" id="5359563">.</span><span class="ident" id="5359564">err</span>&nbsp;<span class="op" id="5359568">!=</span>&nbsp;<span class="ident" id="5359571">nil</span>&nbsp;<span class="op" id="5359575">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359579">if</span>&nbsp;<span class="ident" id="5359582">e</span><span class="op" id="5359583">.</span><span class="ident" id="5359584">err</span>&nbsp;<span class="op" id="5359588">==</span>&nbsp;<span class="ident" id="5359591">errClosed</span>&nbsp;<span class="op" id="5359601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359606">return</span>&nbsp;<span class="ident" id="5359613">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359623">return</span>&nbsp;<span class="ident" id="5359630">e</span><span class="op" id="5359631">.</span><span class="ident" id="5359632">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359637">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359640">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359693">e</span><span class="op" id="5359694">.</span><span class="ident" id="5359695">err</span>&nbsp;<span class="op" id="5359699">=</span>&nbsp;<span class="ident" id="5359701">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359712">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359746">if</span>&nbsp;<span class="ident" id="5359749">e</span><span class="op" id="5359750">.</span><span class="ident" id="5359751">savedCode</span>&nbsp;<span class="op" id="5359761">!=</span>&nbsp;<span class="ident" id="5359764">invalidCode</span>&nbsp;<span class="op" id="5359776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359780">if</span>&nbsp;<span class="ident" id="5359783">err</span>&nbsp;<span class="op" id="5359787">:=</span>&nbsp;<span class="ident" id="5359790">e</span><span class="op" id="5359791">.</span><span class="ident" id="5359792">write</span><span class="op" id="5359797">(</span><span class="ident" id="5359798">e</span><span class="op" id="5359799">,</span>&nbsp;<span class="ident" id="5359801">e</span><span class="op" id="5359802">.</span><span class="ident" id="5359803">savedCode</span><span class="op" id="5359812">)</span><span class="op" id="5359813">;</span>&nbsp;<span class="ident" id="5359815">err</span>&nbsp;<span class="op" id="5359819">!=</span>&nbsp;<span class="ident" id="5359822">nil</span>&nbsp;<span class="op" id="5359826">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359831">return</span>&nbsp;<span class="ident" id="5359838">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359848">if</span>&nbsp;<span class="ident" id="5359851">err</span>&nbsp;<span class="op" id="5359855">:=</span>&nbsp;<span class="ident" id="5359858">e</span><span class="op" id="5359859">.</span><span class="ident" id="5359860">incHi</span><span class="op" id="5359865">(</span><span class="op" id="5359866">)</span><span class="op" id="5359867">;</span>&nbsp;<span class="ident" id="5359869">err</span>&nbsp;<span class="op" id="5359873">!=</span>&nbsp;<span class="ident" id="5359876">nil</span>&nbsp;<span class="op" id="5359880">&amp;&amp;</span>&nbsp;<span class="ident" id="5359883">err</span>&nbsp;<span class="op" id="5359887">!=</span>&nbsp;<span class="ident" id="5359890">errOutOfCodes</span>&nbsp;<span class="op" id="5359904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359909">return</span>&nbsp;<span class="ident" id="5359916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359922">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5359925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5359928">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5359952">eof</span>&nbsp;<span class="op" id="5359956">:=</span>&nbsp;<span class="builtintype" id="5359959">uint32</span><span class="op" id="5359965">(</span><span class="num" id="5359966">1</span><span class="op" id="5359967">)</span><span class="op" id="5359968">&lt;&lt;</span><span class="ident" id="5359970">e</span><span class="op" id="5359971">.</span><span class="ident" id="5359972">litWidth</span>&nbsp;<span class="op" id="5359981">+</span>&nbsp;<span class="num" id="5359983">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5359986">if</span>&nbsp;<span class="ident" id="5359989">err</span>&nbsp;<span class="op" id="5359993">:=</span>&nbsp;<span class="ident" id="5359996">e</span><span class="op" id="5359997">.</span><span class="ident" id="5359998">write</span><span class="op" id="5360003">(</span><span class="ident" id="5360004">e</span><span class="op" id="5360005">,</span>&nbsp;<span class="ident" id="5360007">eof</span><span class="op" id="5360010">)</span><span class="op" id="5360011">;</span>&nbsp;<span class="ident" id="5360013">err</span>&nbsp;<span class="op" id="5360017">!=</span>&nbsp;<span class="ident" id="5360020">nil</span>&nbsp;<span class="op" id="5360024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360028">return</span>&nbsp;<span class="ident" id="5360035">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5360043">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360069">if</span>&nbsp;<span class="ident" id="5360072">e</span><span class="op" id="5360073">.</span><span class="ident" id="5360074">nBits</span>&nbsp;<span class="op" id="5360080">&gt;</span>&nbsp;<span class="num" id="5360082">0</span>&nbsp;<span class="op" id="5360084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360088">if</span>&nbsp;<span class="ident" id="5360091">e</span><span class="op" id="5360092">.</span><span class="ident" id="5360093">order</span>&nbsp;<span class="op" id="5360099">==</span>&nbsp;<span class="ident" id="5360102">MSB</span>&nbsp;<span class="op" id="5360106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360111">e</span><span class="op" id="5360112">.</span><span class="ident" id="5360113">bits</span>&nbsp;<span class="op" id="5360118">&gt;&gt;=</span>&nbsp;<span class="num" id="5360122">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360131">if</span>&nbsp;<span class="ident" id="5360134">err</span>&nbsp;<span class="op" id="5360138">:=</span>&nbsp;<span class="ident" id="5360141">e</span><span class="op" id="5360142">.</span><span class="ident" id="5360143">w</span><span class="op" id="5360144">.</span><span class="ident" id="5360145">WriteByte</span><span class="op" id="5360154">(</span><span class="builtintype" id="5360155">uint8</span><span class="op" id="5360160">(</span><span class="ident" id="5360161">e</span><span class="op" id="5360162">.</span><span class="ident" id="5360163">bits</span><span class="op" id="5360167">)</span><span class="op" id="5360168">)</span><span class="op" id="5360169">;</span>&nbsp;<span class="ident" id="5360171">err</span>&nbsp;<span class="op" id="5360175">!=</span>&nbsp;<span class="ident" id="5360178">nil</span>&nbsp;<span class="op" id="5360182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360187">return</span>&nbsp;<span class="ident" id="5360194">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360203">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360206">return</span>&nbsp;<span class="ident" id="5360213">e</span><span class="op" id="5360214">.</span><span class="ident" id="5360215">w</span><span class="op" id="5360216">.</span><span class="ident" id="5360217">Flush</span><span class="op" id="5360222">(</span><span class="op" id="5360223">)</span><br>
<span class="lineno"></span><span class="op" id="5360225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5360228">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5360271">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5360345">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5360420">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5360441">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5360514">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5360549">func</span>&nbsp;<span class="ident" id="5360554">NewWriter</span><span class="op" id="5360563">(</span><span class="ident" id="5360564">w</span>&nbsp;<span class="ident" id="5360566">io</span><span class="op" id="5360568">.</span><span class="ident" id="5360569">Writer</span><span class="op" id="5360575">,</span>&nbsp;<span class="ident" id="5360577">order</span>&nbsp;<span class="ident" id="5360583">Order</span><span class="op" id="5360588">,</span>&nbsp;<span class="ident" id="5360590">litWidth</span>&nbsp;<span class="builtintype" id="5360599">int</span><span class="op" id="5360602">)</span>&nbsp;<span class="ident" id="5360604">io</span><span class="op" id="5360606">.</span><span class="ident" id="5360607">WriteCloser</span>&nbsp;<span class="op" id="5360619">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360622">var</span>&nbsp;<span class="ident" id="5360626">write</span>&nbsp;<span class="keyword" id="5360632">func</span><span class="op" id="5360636">(</span><span class="op" id="5360637">*</span><span class="ident" id="5360638">encoder</span><span class="op" id="5360645">,</span>&nbsp;<span class="builtintype" id="5360647">uint32</span><span class="op" id="5360653">)</span>&nbsp;<span class="builtintype" id="5360655">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360662">switch</span>&nbsp;<span class="ident" id="5360669">order</span>&nbsp;<span class="op" id="5360675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360678">case</span>&nbsp;<span class="ident" id="5360683">LSB</span><span class="op" id="5360686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360690">write</span>&nbsp;<span class="op" id="5360696">=</span>&nbsp;<span class="op" id="5360698">(</span><span class="op" id="5360699">*</span><span class="ident" id="5360700">encoder</span><span class="op" id="5360707">)</span><span class="op" id="5360708">.</span><span class="ident" id="5360709">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360719">case</span>&nbsp;<span class="ident" id="5360724">MSB</span><span class="op" id="5360727">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360731">write</span>&nbsp;<span class="op" id="5360737">=</span>&nbsp;<span class="op" id="5360739">(</span><span class="op" id="5360740">*</span><span class="ident" id="5360741">encoder</span><span class="op" id="5360748">)</span><span class="op" id="5360749">.</span><span class="ident" id="5360750">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360760">default</span><span class="op" id="5360767">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360771">return</span>&nbsp;<span class="op" id="5360778">&amp;</span><span class="ident" id="5360779">errWriteCloser</span><span class="op" id="5360793">{</span><span class="ident" id="5360794">errors</span><span class="op" id="5360800">.</span><span class="ident" id="5360801">New</span><span class="op" id="5360804">(</span><span class="string" id="5360805">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5360825">)</span><span class="op" id="5360826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360832">if</span>&nbsp;<span class="ident" id="5360835">litWidth</span>&nbsp;<span class="op" id="5360844">&lt;</span>&nbsp;<span class="num" id="5360846">2</span>&nbsp;<span class="op" id="5360848">||</span>&nbsp;<span class="num" id="5360851">8</span>&nbsp;<span class="op" id="5360853">&lt;</span>&nbsp;<span class="ident" id="5360855">litWidth</span>&nbsp;<span class="op" id="5360864">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360868">return</span>&nbsp;<span class="op" id="5360875">&amp;</span><span class="ident" id="5360876">errWriteCloser</span><span class="op" id="5360890">{</span><span class="ident" id="5360891">fmt</span><span class="op" id="5360894">.</span><span class="ident" id="5360895">Errorf</span><span class="op" id="5360901">(</span><span class="string" id="5360902">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5360933">,</span>&nbsp;<span class="ident" id="5360935">litWidth</span><span class="op" id="5360943">)</span><span class="op" id="5360944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5360947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360950">bw</span><span class="op" id="5360952">,</span>&nbsp;<span class="ident" id="5360954">ok</span>&nbsp;<span class="op" id="5360957">:=</span>&nbsp;<span class="ident" id="5360960">w</span><span class="op" id="5360961">.</span><span class="op" id="5360962">(</span><span class="ident" id="5360963">writer</span><span class="op" id="5360969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5360972">if</span>&nbsp;<span class="op" id="5360975">!</span><span class="ident" id="5360976">ok</span>&nbsp;<span class="op" id="5360979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5360983">bw</span>&nbsp;<span class="op" id="5360986">=</span>&nbsp;<span class="ident" id="5360988">bufio</span><span class="op" id="5360993">.</span><span class="ident" id="5360994">NewWriter</span><span class="op" id="5361003">(</span><span class="ident" id="5361004">w</span><span class="op" id="5361005">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361011">lw</span>&nbsp;<span class="op" id="5361014">:=</span>&nbsp;<span class="builtintype" id="5361017">uint</span><span class="op" id="5361021">(</span><span class="ident" id="5361022">litWidth</span><span class="op" id="5361030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5361033">return</span>&nbsp;<span class="op" id="5361040">&amp;</span><span class="ident" id="5361041">encoder</span><span class="op" id="5361048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361052">w</span><span class="op" id="5361053">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5361063">bw</span><span class="op" id="5361065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361069">order</span><span class="op" id="5361074">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5361080">order</span><span class="op" id="5361085">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361089">write</span><span class="op" id="5361094">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5361100">write</span><span class="op" id="5361105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361109">width</span><span class="op" id="5361114">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5361120">1</span>&nbsp;<span class="op" id="5361122">+</span>&nbsp;<span class="ident" id="5361124">lw</span><span class="op" id="5361126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361130">litWidth</span><span class="op" id="5361138">:</span>&nbsp;&nbsp;<span class="ident" id="5361141">lw</span><span class="op" id="5361143">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361147">hi</span><span class="op" id="5361149">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5361158">1</span><span class="op" id="5361159">&lt;&lt;</span><span class="ident" id="5361161">lw</span>&nbsp;<span class="op" id="5361164">+</span>&nbsp;<span class="num" id="5361166">1</span><span class="op" id="5361167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361171">overflow</span><span class="op" id="5361179">:</span>&nbsp;&nbsp;<span class="num" id="5361182">1</span>&nbsp;<span class="op" id="5361184">&lt;&lt;</span>&nbsp;<span class="op" id="5361187">(</span><span class="ident" id="5361188">lw</span>&nbsp;<span class="op" id="5361191">+</span>&nbsp;<span class="num" id="5361193">1</span><span class="op" id="5361194">)</span><span class="op" id="5361195">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5361199">savedCode</span><span class="op" id="5361208">:</span>&nbsp;<span class="ident" id="5361210">invalidCode</span><span class="op" id="5361221">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5361224">}</span><br>
<span class="lineno"></span><span class="op" id="5361226">}</span>
</div>
</body>
</html>
