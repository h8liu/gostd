<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5756754">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5756810">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5756864">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5756915">package</span>&nbsp;<span class="ident" id="5756923">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5756932">import</span>&nbsp;<span class="op" id="5756939">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5756942">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5756959">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5756969">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5756975">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5756986">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5756993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5756996">var</span>&nbsp;<span class="ident" id="5757000">errMissingParams</span>&nbsp;<span class="op" id="5757017">=</span>&nbsp;<span class="ident" id="5757019">errors</span><span class="op" id="5757025">.</span><span class="ident" id="5757026">New</span><span class="op" id="5757029">(</span><span class="string" id="5757030">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5757068">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5757071">type</span>&nbsp;<span class="ident" id="5757076">serverCodec</span>&nbsp;<span class="keyword" id="5757088">struct</span>&nbsp;<span class="op" id="5757095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757098">dec</span>&nbsp;<span class="op" id="5757102">*</span><span class="ident" id="5757103">json</span><span class="op" id="5757107">.</span><span class="ident" id="5757108">Decoder</span>&nbsp;<span class="comment" id="5757116">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757144">enc</span>&nbsp;<span class="op" id="5757148">*</span><span class="ident" id="5757149">json</span><span class="op" id="5757153">.</span><span class="ident" id="5757154">Encoder</span>&nbsp;<span class="comment" id="5757162">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757190">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5757194">io</span><span class="op" id="5757196">.</span><span class="ident" id="5757197">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757206">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757231">req</span>&nbsp;<span class="ident" id="5757235">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757251">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757318">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757362">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757421">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757478">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5757531">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757581">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5757589">sync</span><span class="op" id="5757593">.</span><span class="ident" id="5757594">Mutex</span>&nbsp;<span class="comment" id="5757600">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757626">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757634">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757642">pending</span>&nbsp;<span class="keyword" id="5757650">map</span><span class="op" id="5757653">[</span><span class="ident" id="5757654">uint64</span><span class="op" id="5757660">]</span><span class="op" id="5757661">*</span><span class="ident" id="5757662">json</span><span class="op" id="5757666">.</span><span class="ident" id="5757667">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5757678">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5757681">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5757753">func</span>&nbsp;<span class="ident" id="5757758">NewServerCodec</span><span class="op" id="5757772">(</span><span class="ident" id="5757773">conn</span>&nbsp;<span class="ident" id="5757778">io</span><span class="op" id="5757780">.</span><span class="ident" id="5757781">ReadWriteCloser</span><span class="op" id="5757796">)</span>&nbsp;<span class="ident" id="5757798">rpc</span><span class="op" id="5757801">.</span><span class="ident" id="5757802">ServerCodec</span>&nbsp;<span class="op" id="5757814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5757817">return</span>&nbsp;<span class="op" id="5757824">&amp;</span><span class="ident" id="5757825">serverCodec</span><span class="op" id="5757836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757840">dec</span><span class="op" id="5757843">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757849">json</span><span class="op" id="5757853">.</span><span class="ident" id="5757854">NewDecoder</span><span class="op" id="5757864">(</span><span class="ident" id="5757865">conn</span><span class="op" id="5757869">)</span><span class="op" id="5757870">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757874">enc</span><span class="op" id="5757877">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757883">json</span><span class="op" id="5757887">.</span><span class="ident" id="5757888">NewEncoder</span><span class="op" id="5757898">(</span><span class="ident" id="5757899">conn</span><span class="op" id="5757903">)</span><span class="op" id="5757904">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757908">c</span><span class="op" id="5757909">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5757917">conn</span><span class="op" id="5757921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5757925">pending</span><span class="op" id="5757932">:</span>&nbsp;<span class="builtinfunc" id="5757934">make</span><span class="op" id="5757938">(</span><span class="keyword" id="5757939">map</span><span class="op" id="5757942">[</span><span class="ident" id="5757943">uint64</span><span class="op" id="5757949">]</span><span class="op" id="5757950">*</span><span class="ident" id="5757951">json</span><span class="op" id="5757955">.</span><span class="ident" id="5757956">RawMessage</span><span class="op" id="5757966">)</span><span class="op" id="5757967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5757970">}</span><br>
<span class="lineno"></span><span class="op" id="5757972">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5757975">type</span>&nbsp;<span class="ident" id="5757980">serverRequest</span>&nbsp;<span class="keyword" id="5757994">struct</span>&nbsp;<span class="op" id="5758001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758004">Method</span>&nbsp;<span class="builtintype" id="5758011">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5758028">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758045">Params</span>&nbsp;<span class="op" id="5758052">*</span><span class="ident" id="5758053">json</span><span class="op" id="5758057">.</span><span class="ident" id="5758058">RawMessage</span>&nbsp;<span class="string" id="5758069">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758086">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5758093">*</span><span class="ident" id="5758094">json</span><span class="op" id="5758098">.</span><span class="ident" id="5758099">RawMessage</span>&nbsp;<span class="string" id="5758110">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5758122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758125">func</span>&nbsp;<span class="op" id="5758130">(</span><span class="ident" id="5758131">r</span>&nbsp;<span class="op" id="5758133">*</span><span class="ident" id="5758134">serverRequest</span><span class="op" id="5758147">)</span>&nbsp;<span class="ident" id="5758149">reset</span><span class="op" id="5758154">(</span><span class="op" id="5758155">)</span>&nbsp;<span class="op" id="5758157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758160">r</span><span class="op" id="5758161">.</span><span class="ident" id="5758162">Method</span>&nbsp;<span class="op" id="5758169">=</span>&nbsp;<span class="string" id="5758171">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758175">r</span><span class="op" id="5758176">.</span><span class="ident" id="5758177">Params</span>&nbsp;<span class="op" id="5758184">=</span>&nbsp;<span class="ident" id="5758186">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758191">r</span><span class="op" id="5758192">.</span><span class="ident" id="5758193">Id</span>&nbsp;<span class="op" id="5758196">=</span>&nbsp;<span class="ident" id="5758198">nil</span><br>
<span class="lineno"></span><span class="op" id="5758202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758205">type</span>&nbsp;<span class="ident" id="5758210">serverResponse</span>&nbsp;<span class="keyword" id="5758225">struct</span>&nbsp;<span class="op" id="5758232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758235">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5758242">*</span><span class="ident" id="5758243">json</span><span class="op" id="5758247">.</span><span class="ident" id="5758248">RawMessage</span>&nbsp;<span class="string" id="5758259">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758272">Result</span>&nbsp;<span class="keyword" id="5758279">interface</span><span class="op" id="5758288">{</span><span class="op" id="5758289">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5758296">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758313">Error</span>&nbsp;&nbsp;<span class="keyword" id="5758320">interface</span><span class="op" id="5758329">{</span><span class="op" id="5758330">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5758337">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5758352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758355">func</span>&nbsp;<span class="op" id="5758360">(</span><span class="ident" id="5758361">c</span>&nbsp;<span class="op" id="5758363">*</span><span class="ident" id="5758364">serverCodec</span><span class="op" id="5758375">)</span>&nbsp;<span class="ident" id="5758377">ReadRequestHeader</span><span class="op" id="5758394">(</span><span class="ident" id="5758395">r</span>&nbsp;<span class="op" id="5758397">*</span><span class="ident" id="5758398">rpc</span><span class="op" id="5758401">.</span><span class="ident" id="5758402">Request</span><span class="op" id="5758409">)</span>&nbsp;<span class="builtintype" id="5758411">error</span>&nbsp;<span class="op" id="5758417">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758420">c</span><span class="op" id="5758421">.</span><span class="ident" id="5758422">req</span><span class="op" id="5758425">.</span><span class="ident" id="5758426">reset</span><span class="op" id="5758431">(</span><span class="op" id="5758432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758435">if</span>&nbsp;<span class="ident" id="5758438">err</span>&nbsp;<span class="op" id="5758442">:=</span>&nbsp;<span class="ident" id="5758445">c</span><span class="op" id="5758446">.</span><span class="ident" id="5758447">dec</span><span class="op" id="5758450">.</span><span class="ident" id="5758451">Decode</span><span class="op" id="5758457">(</span><span class="op" id="5758458">&amp;</span><span class="ident" id="5758459">c</span><span class="op" id="5758460">.</span><span class="ident" id="5758461">req</span><span class="op" id="5758464">)</span><span class="op" id="5758465">;</span>&nbsp;<span class="ident" id="5758467">err</span>&nbsp;<span class="op" id="5758471">!=</span>&nbsp;<span class="ident" id="5758474">nil</span>&nbsp;<span class="op" id="5758478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758482">return</span>&nbsp;<span class="ident" id="5758489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5758494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758497">r</span><span class="op" id="5758498">.</span><span class="ident" id="5758499">ServiceMethod</span>&nbsp;<span class="op" id="5758513">=</span>&nbsp;<span class="ident" id="5758515">c</span><span class="op" id="5758516">.</span><span class="ident" id="5758517">req</span><span class="op" id="5758520">.</span><span class="ident" id="5758521">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758530">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758573">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758619">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758666">c</span><span class="op" id="5758667">.</span><span class="ident" id="5758668">mutex</span><span class="op" id="5758673">.</span><span class="ident" id="5758674">Lock</span><span class="op" id="5758678">(</span><span class="op" id="5758679">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758682">c</span><span class="op" id="5758683">.</span><span class="ident" id="5758684">seq</span><span class="op" id="5758687">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758691">c</span><span class="op" id="5758692">.</span><span class="ident" id="5758693">pending</span><span class="op" id="5758700">[</span><span class="ident" id="5758701">c</span><span class="op" id="5758702">.</span><span class="ident" id="5758703">seq</span><span class="op" id="5758706">]</span>&nbsp;<span class="op" id="5758708">=</span>&nbsp;<span class="ident" id="5758710">c</span><span class="op" id="5758711">.</span><span class="ident" id="5758712">req</span><span class="op" id="5758715">.</span><span class="ident" id="5758716">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758720">c</span><span class="op" id="5758721">.</span><span class="ident" id="5758722">req</span><span class="op" id="5758725">.</span><span class="ident" id="5758726">Id</span>&nbsp;<span class="op" id="5758729">=</span>&nbsp;<span class="ident" id="5758731">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758736">r</span><span class="op" id="5758737">.</span><span class="ident" id="5758738">Seq</span>&nbsp;<span class="op" id="5758742">=</span>&nbsp;<span class="ident" id="5758744">c</span><span class="op" id="5758745">.</span><span class="ident" id="5758746">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5758751">c</span><span class="op" id="5758752">.</span><span class="ident" id="5758753">mutex</span><span class="op" id="5758758">.</span><span class="ident" id="5758759">Unlock</span><span class="op" id="5758765">(</span><span class="op" id="5758766">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758770">return</span>&nbsp;<span class="ident" id="5758777">nil</span><br>
<span class="lineno"></span><span class="op" id="5758781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5758784">func</span>&nbsp;<span class="op" id="5758789">(</span><span class="ident" id="5758790">c</span>&nbsp;<span class="op" id="5758792">*</span><span class="ident" id="5758793">serverCodec</span><span class="op" id="5758804">)</span>&nbsp;<span class="ident" id="5758806">ReadRequestBody</span><span class="op" id="5758821">(</span><span class="ident" id="5758822">x</span>&nbsp;<span class="keyword" id="5758824">interface</span><span class="op" id="5758833">{</span><span class="op" id="5758834">}</span><span class="op" id="5758835">)</span>&nbsp;<span class="builtintype" id="5758837">error</span>&nbsp;<span class="op" id="5758843">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758846">if</span>&nbsp;<span class="ident" id="5758849">x</span>&nbsp;<span class="op" id="5758851">==</span>&nbsp;<span class="ident" id="5758854">nil</span>&nbsp;<span class="op" id="5758858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758862">return</span>&nbsp;<span class="ident" id="5758869">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5758874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758877">if</span>&nbsp;<span class="ident" id="5758880">c</span><span class="op" id="5758881">.</span><span class="ident" id="5758882">req</span><span class="op" id="5758885">.</span><span class="ident" id="5758886">Params</span>&nbsp;<span class="op" id="5758893">==</span>&nbsp;<span class="ident" id="5758896">nil</span>&nbsp;<span class="op" id="5758900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5758904">return</span>&nbsp;<span class="ident" id="5758911">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5758929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758932">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758964">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5758990">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5759042">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759090">var</span>&nbsp;<span class="ident" id="5759094">params</span>&nbsp;<span class="op" id="5759101">[</span><span class="num" id="5759102">1</span><span class="op" id="5759103">]</span><span class="keyword" id="5759104">interface</span><span class="op" id="5759113">{</span><span class="op" id="5759114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759117">params</span><span class="op" id="5759123">[</span><span class="num" id="5759124">0</span><span class="op" id="5759125">]</span>&nbsp;<span class="op" id="5759127">=</span>&nbsp;<span class="ident" id="5759129">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759132">return</span>&nbsp;<span class="ident" id="5759139">json</span><span class="op" id="5759143">.</span><span class="ident" id="5759144">Unmarshal</span><span class="op" id="5759153">(</span><span class="op" id="5759154">*</span><span class="ident" id="5759155">c</span><span class="op" id="5759156">.</span><span class="ident" id="5759157">req</span><span class="op" id="5759160">.</span><span class="ident" id="5759161">Params</span><span class="op" id="5759167">,</span>&nbsp;<span class="op" id="5759169">&amp;</span><span class="ident" id="5759170">params</span><span class="op" id="5759176">)</span><br>
<span class="lineno"></span><span class="op" id="5759178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5759181">var</span>&nbsp;<span class="ident" id="5759185">null</span>&nbsp;<span class="op" id="5759190">=</span>&nbsp;<span class="ident" id="5759192">json</span><span class="op" id="5759196">.</span><span class="ident" id="5759197">RawMessage</span><span class="op" id="5759207">(</span><span class="op" id="5759208">[</span><span class="op" id="5759209">]</span><span class="builtintype" id="5759210">byte</span><span class="op" id="5759214">(</span><span class="string" id="5759215">&#34;null&#34;</span><span class="op" id="5759221">)</span><span class="op" id="5759222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5759225">func</span>&nbsp;<span class="op" id="5759230">(</span><span class="ident" id="5759231">c</span>&nbsp;<span class="op" id="5759233">*</span><span class="ident" id="5759234">serverCodec</span><span class="op" id="5759245">)</span>&nbsp;<span class="ident" id="5759247">WriteResponse</span><span class="op" id="5759260">(</span><span class="ident" id="5759261">r</span>&nbsp;<span class="op" id="5759263">*</span><span class="ident" id="5759264">rpc</span><span class="op" id="5759267">.</span><span class="ident" id="5759268">Response</span><span class="op" id="5759276">,</span>&nbsp;<span class="ident" id="5759278">x</span>&nbsp;<span class="keyword" id="5759280">interface</span><span class="op" id="5759289">{</span><span class="op" id="5759290">}</span><span class="op" id="5759291">)</span>&nbsp;<span class="builtintype" id="5759293">error</span>&nbsp;<span class="op" id="5759299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759302">c</span><span class="op" id="5759303">.</span><span class="ident" id="5759304">mutex</span><span class="op" id="5759309">.</span><span class="ident" id="5759310">Lock</span><span class="op" id="5759314">(</span><span class="op" id="5759315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759318">b</span><span class="op" id="5759319">,</span>&nbsp;<span class="ident" id="5759321">ok</span>&nbsp;<span class="op" id="5759324">:=</span>&nbsp;<span class="ident" id="5759327">c</span><span class="op" id="5759328">.</span><span class="ident" id="5759329">pending</span><span class="op" id="5759336">[</span><span class="ident" id="5759337">r</span><span class="op" id="5759338">.</span><span class="ident" id="5759339">Seq</span><span class="op" id="5759342">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759345">if</span>&nbsp;<span class="op" id="5759348">!</span><span class="ident" id="5759349">ok</span>&nbsp;<span class="op" id="5759352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759356">c</span><span class="op" id="5759357">.</span><span class="ident" id="5759358">mutex</span><span class="op" id="5759363">.</span><span class="ident" id="5759364">Unlock</span><span class="op" id="5759370">(</span><span class="op" id="5759371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759375">return</span>&nbsp;<span class="ident" id="5759382">errors</span><span class="op" id="5759388">.</span><span class="ident" id="5759389">New</span><span class="op" id="5759392">(</span><span class="string" id="5759393">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5759430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5759433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5759436">delete</span><span class="op" id="5759442">(</span><span class="ident" id="5759443">c</span><span class="op" id="5759444">.</span><span class="ident" id="5759445">pending</span><span class="op" id="5759452">,</span>&nbsp;<span class="ident" id="5759454">r</span><span class="op" id="5759455">.</span><span class="ident" id="5759456">Seq</span><span class="op" id="5759459">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759462">c</span><span class="op" id="5759463">.</span><span class="ident" id="5759464">mutex</span><span class="op" id="5759469">.</span><span class="ident" id="5759470">Unlock</span><span class="op" id="5759476">(</span><span class="op" id="5759477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759481">if</span>&nbsp;<span class="ident" id="5759484">b</span>&nbsp;<span class="op" id="5759486">==</span>&nbsp;<span class="ident" id="5759489">nil</span>&nbsp;<span class="op" id="5759493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5759497">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759544">b</span>&nbsp;<span class="op" id="5759546">=</span>&nbsp;<span class="op" id="5759548">&amp;</span><span class="ident" id="5759549">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5759555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759558">resp</span>&nbsp;<span class="op" id="5759563">:=</span>&nbsp;<span class="ident" id="5759566">serverResponse</span><span class="op" id="5759580">{</span><span class="ident" id="5759581">Id</span><span class="op" id="5759583">:</span>&nbsp;<span class="ident" id="5759585">b</span><span class="op" id="5759586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759589">if</span>&nbsp;<span class="ident" id="5759592">r</span><span class="op" id="5759593">.</span><span class="ident" id="5759594">Error</span>&nbsp;<span class="op" id="5759600">==</span>&nbsp;<span class="string" id="5759603">&#34;&#34;</span>&nbsp;<span class="op" id="5759606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759610">resp</span><span class="op" id="5759614">.</span><span class="ident" id="5759615">Result</span>&nbsp;<span class="op" id="5759622">=</span>&nbsp;<span class="ident" id="5759624">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5759627">}</span>&nbsp;<span class="keyword" id="5759629">else</span>&nbsp;<span class="op" id="5759634">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759638">resp</span><span class="op" id="5759642">.</span><span class="ident" id="5759643">Error</span>&nbsp;<span class="op" id="5759649">=</span>&nbsp;<span class="ident" id="5759651">r</span><span class="op" id="5759652">.</span><span class="ident" id="5759653">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5759660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759663">return</span>&nbsp;<span class="ident" id="5759670">c</span><span class="op" id="5759671">.</span><span class="ident" id="5759672">enc</span><span class="op" id="5759675">.</span><span class="ident" id="5759676">Encode</span><span class="op" id="5759682">(</span><span class="ident" id="5759683">resp</span><span class="op" id="5759687">)</span><br>
<span class="lineno"></span><span class="op" id="5759689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5759692">func</span>&nbsp;<span class="op" id="5759697">(</span><span class="ident" id="5759698">c</span>&nbsp;<span class="op" id="5759700">*</span><span class="ident" id="5759701">serverCodec</span><span class="op" id="5759712">)</span>&nbsp;<span class="ident" id="5759714">Close</span><span class="op" id="5759719">(</span><span class="op" id="5759720">)</span>&nbsp;<span class="builtintype" id="5759722">error</span>&nbsp;<span class="op" id="5759728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5759731">return</span>&nbsp;<span class="ident" id="5759738">c</span><span class="op" id="5759739">.</span><span class="ident" id="5759740">c</span><span class="op" id="5759741">.</span><span class="ident" id="5759742">Close</span><span class="op" id="5759747">(</span><span class="op" id="5759748">)</span><br>
<span class="lineno"></span><span class="op" id="5759750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5759753">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5759815">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5759886">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5759947">func</span>&nbsp;<span class="ident" id="5759952">ServeConn</span><span class="op" id="5759961">(</span><span class="ident" id="5759962">conn</span>&nbsp;<span class="ident" id="5759967">io</span><span class="op" id="5759969">.</span><span class="ident" id="5759970">ReadWriteCloser</span><span class="op" id="5759985">)</span>&nbsp;<span class="op" id="5759987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5759990">rpc</span><span class="op" id="5759993">.</span><span class="ident" id="5759994">ServeCodec</span><span class="op" id="5760004">(</span><span class="ident" id="5760005">NewServerCodec</span><span class="op" id="5760019">(</span><span class="ident" id="5760020">conn</span><span class="op" id="5760024">)</span><span class="op" id="5760025">)</span><br>
<span class="lineno"></span><span class="op" id="5760027">}</span>
</div>
</body>
</html>
