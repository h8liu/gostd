<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2491862">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2491918">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2491972">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2492023">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2492052">package</span>&nbsp;<span class="ident" id="2492060">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2492069">import</span>&nbsp;<span class="op" id="2492076">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2492079">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2492088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2492091">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2492154">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2492179">type</span>&nbsp;<span class="ident" id="2492184">makeFuncImpl</span>&nbsp;<span class="keyword" id="2492197">struct</span>&nbsp;<span class="op" id="2492204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2492207">code</span>&nbsp;&nbsp;<span class="builtintype" id="2492213">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2492222">stack</span>&nbsp;<span class="op" id="2492228">*</span><span class="ident" id="2492229">bitVector</span>&nbsp;<span class="comment" id="2492239">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2492291">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2492297">*</span><span class="ident" id="2492298">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2492308">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2492314">func</span><span class="op" id="2492318">(</span><span class="op" id="2492319">[</span><span class="op" id="2492320">]</span><span class="ident" id="2492321">Value</span><span class="op" id="2492326">)</span>&nbsp;<span class="op" id="2492328">[</span><span class="op" id="2492329">]</span><span class="ident" id="2492330">Value</span><br>
<span class="lineno">20</span><span class="op" id="2492336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2492339">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2492392">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2492454">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2492477">//</span><br>
<span class="lineno"></span><span class="comment" id="2492480">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2492530">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2492561">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2492631">//</span><br>
<span class="lineno">30</span><span class="comment" id="2492634">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2492700">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2492754">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2492821">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2492879">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2492949">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2493007">//</span><br>
<span class="lineno"></span><span class="comment" id="2493010">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2493080">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2493156">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2493196">//</span><br>
<span class="lineno"></span><span class="comment" id="2493199">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2493269">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2493341">//</span><br>
<span class="lineno"></span><span class="keyword" id="2493344">func</span>&nbsp;<span class="ident" id="2493349">MakeFunc</span><span class="op" id="2493357">(</span><span class="ident" id="2493358">typ</span>&nbsp;<span class="ident" id="2493362">Type</span><span class="op" id="2493366">,</span>&nbsp;<span class="ident" id="2493368">fn</span>&nbsp;<span class="keyword" id="2493371">func</span><span class="op" id="2493375">(</span><span class="ident" id="2493376">args</span>&nbsp;<span class="op" id="2493381">[</span><span class="op" id="2493382">]</span><span class="ident" id="2493383">Value</span><span class="op" id="2493388">)</span>&nbsp;<span class="op" id="2493390">(</span><span class="ident" id="2493391">results</span>&nbsp;<span class="op" id="2493399">[</span><span class="op" id="2493400">]</span><span class="ident" id="2493401">Value</span><span class="op" id="2493406">)</span><span class="op" id="2493407">)</span>&nbsp;<span class="ident" id="2493409">Value</span>&nbsp;<span class="op" id="2493415">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2493418">if</span>&nbsp;<span class="ident" id="2493421">typ</span><span class="op" id="2493424">.</span><span class="ident" id="2493425">Kind</span><span class="op" id="2493429">(</span><span class="op" id="2493430">)</span>&nbsp;<span class="op" id="2493432">!=</span>&nbsp;<span class="ident" id="2493435">Func</span>&nbsp;<span class="op" id="2493440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2493444">panic</span><span class="op" id="2493449">(</span><span class="string" id="2493450">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2493496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2493499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2493503">t</span>&nbsp;<span class="op" id="2493505">:=</span>&nbsp;<span class="ident" id="2493508">typ</span><span class="op" id="2493511">.</span><span class="ident" id="2493512">common</span><span class="op" id="2493518">(</span><span class="op" id="2493519">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2493522">ftyp</span>&nbsp;<span class="op" id="2493527">:=</span>&nbsp;<span class="op" id="2493530">(</span><span class="op" id="2493531">*</span><span class="ident" id="2493532">funcType</span><span class="op" id="2493540">)</span><span class="op" id="2493541">(</span><span class="ident" id="2493542">unsafe</span><span class="op" id="2493548">.</span><span class="ident" id="2493549">Pointer</span><span class="op" id="2493556">(</span><span class="ident" id="2493557">t</span><span class="op" id="2493558">)</span><span class="op" id="2493559">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2493563">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2493608">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2493663">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2493723">dummy</span>&nbsp;<span class="op" id="2493729">:=</span>&nbsp;<span class="ident" id="2493732">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2493746">code</span>&nbsp;<span class="op" id="2493751">:=</span>&nbsp;<span class="op" id="2493754">*</span><span class="op" id="2493755">*</span><span class="op" id="2493756">(</span><span class="op" id="2493757">*</span><span class="op" id="2493758">*</span><span class="builtintype" id="2493759">uintptr</span><span class="op" id="2493766">)</span><span class="op" id="2493767">(</span><span class="ident" id="2493768">unsafe</span><span class="op" id="2493774">.</span><span class="ident" id="2493775">Pointer</span><span class="op" id="2493782">(</span><span class="op" id="2493783">&amp;</span><span class="ident" id="2493784">dummy</span><span class="op" id="2493789">)</span><span class="op" id="2493790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2493794">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2493855">_</span><span class="op" id="2493856">,</span>&nbsp;<span class="ident" id="2493858">_</span><span class="op" id="2493859">,</span>&nbsp;<span class="ident" id="2493861">_</span><span class="op" id="2493862">,</span>&nbsp;<span class="ident" id="2493864">stack</span>&nbsp;<span class="op" id="2493870">:=</span>&nbsp;<span class="ident" id="2493873">funcLayout</span><span class="op" id="2493883">(</span><span class="ident" id="2493884">t</span><span class="op" id="2493885">,</span>&nbsp;<span class="ident" id="2493887">nil</span><span class="op" id="2493890">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2493894">impl</span>&nbsp;<span class="op" id="2493899">:=</span>&nbsp;<span class="op" id="2493902">&amp;</span><span class="ident" id="2493903">makeFuncImpl</span><span class="op" id="2493915">{</span><span class="ident" id="2493916">code</span><span class="op" id="2493920">:</span>&nbsp;<span class="ident" id="2493922">code</span><span class="op" id="2493926">,</span>&nbsp;<span class="ident" id="2493928">stack</span><span class="op" id="2493933">:</span>&nbsp;<span class="ident" id="2493935">stack</span><span class="op" id="2493940">,</span>&nbsp;<span class="ident" id="2493942">typ</span><span class="op" id="2493945">:</span>&nbsp;<span class="ident" id="2493947">ftyp</span><span class="op" id="2493951">,</span>&nbsp;<span class="ident" id="2493953">fn</span><span class="op" id="2493955">:</span>&nbsp;<span class="ident" id="2493957">fn</span><span class="op" id="2493959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2493963">return</span>&nbsp;<span class="ident" id="2493970">Value</span><span class="op" id="2493975">{</span><span class="ident" id="2493976">t</span><span class="op" id="2493977">,</span>&nbsp;<span class="ident" id="2493979">unsafe</span><span class="op" id="2493985">.</span><span class="ident" id="2493986">Pointer</span><span class="op" id="2493993">(</span><span class="ident" id="2493994">impl</span><span class="op" id="2493998">)</span><span class="op" id="2493999">,</span>&nbsp;<span class="ident" id="2494001">flag</span><span class="op" id="2494005">(</span><span class="ident" id="2494006">Func</span><span class="op" id="2494010">)</span><span class="op" id="2494011">}</span><br>
<span class="lineno"></span><span class="op" id="2494013">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2494016">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2494081">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2494151">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2494229">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2494303">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2494344">func</span>&nbsp;<span class="ident" id="2494349">makeFuncStub</span><span class="op" id="2494361">(</span><span class="op" id="2494362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2494365">type</span>&nbsp;<span class="ident" id="2494370">methodValue</span>&nbsp;<span class="keyword" id="2494382">struct</span>&nbsp;<span class="op" id="2494389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2494392">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2494399">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2494408">stack</span>&nbsp;&nbsp;<span class="op" id="2494415">*</span><span class="ident" id="2494416">bitVector</span>&nbsp;<span class="comment" id="2494426">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2494478">method</span>&nbsp;<span class="builtintype" id="2494485">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2494490">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2494497">Value</span><br>
<span class="lineno"></span><span class="op" id="2494503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2494506">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2494578">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2494640">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2494708">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2494770">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2494840">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2494909">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2494959">func</span>&nbsp;<span class="ident" id="2494964">makeMethodValue</span><span class="op" id="2494979">(</span><span class="ident" id="2494980">op</span>&nbsp;<span class="builtintype" id="2494983">string</span><span class="op" id="2494989">,</span>&nbsp;<span class="ident" id="2494991">v</span>&nbsp;<span class="ident" id="2494993">Value</span><span class="op" id="2494998">)</span>&nbsp;<span class="ident" id="2495000">Value</span>&nbsp;<span class="op" id="2495006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2495009">if</span>&nbsp;<span class="ident" id="2495012">v</span><span class="op" id="2495013">.</span><span class="ident" id="2495014">flag</span><span class="op" id="2495018">&amp;</span><span class="ident" id="2495019">flagMethod</span>&nbsp;<span class="op" id="2495030">==</span>&nbsp;<span class="num" id="2495033">0</span>&nbsp;<span class="op" id="2495035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2495039">panic</span><span class="op" id="2495044">(</span><span class="string" id="2495045">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2495102">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2495105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495109">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495189">fl</span>&nbsp;<span class="op" id="2495192">:=</span>&nbsp;<span class="ident" id="2495195">v</span><span class="op" id="2495196">.</span><span class="ident" id="2495197">flag</span>&nbsp;<span class="op" id="2495202">&amp;</span>&nbsp;<span class="op" id="2495204">(</span><span class="ident" id="2495205">flagRO</span>&nbsp;<span class="op" id="2495212">|</span>&nbsp;<span class="ident" id="2495214">flagAddr</span>&nbsp;<span class="op" id="2495223">|</span>&nbsp;<span class="ident" id="2495225">flagIndir</span><span class="op" id="2495234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495237">fl</span>&nbsp;<span class="op" id="2495240">|=</span>&nbsp;<span class="ident" id="2495243">flag</span><span class="op" id="2495247">(</span><span class="ident" id="2495248">v</span><span class="op" id="2495249">.</span><span class="ident" id="2495250">typ</span><span class="op" id="2495253">.</span><span class="ident" id="2495254">Kind</span><span class="op" id="2495258">(</span><span class="op" id="2495259">)</span><span class="op" id="2495260">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495263">rcvr</span>&nbsp;<span class="op" id="2495268">:=</span>&nbsp;<span class="ident" id="2495271">Value</span><span class="op" id="2495276">{</span><span class="ident" id="2495277">v</span><span class="op" id="2495278">.</span><span class="ident" id="2495279">typ</span><span class="op" id="2495282">,</span>&nbsp;<span class="ident" id="2495284">v</span><span class="op" id="2495285">.</span><span class="ident" id="2495286">ptr</span><span class="op" id="2495289">,</span>&nbsp;<span class="ident" id="2495291">fl</span><span class="op" id="2495293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495297">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495353">funcType</span>&nbsp;<span class="op" id="2495362">:=</span>&nbsp;<span class="ident" id="2495365">v</span><span class="op" id="2495366">.</span><span class="ident" id="2495367">Type</span><span class="op" id="2495371">(</span><span class="op" id="2495372">)</span><span class="op" id="2495373">.</span><span class="op" id="2495374">(</span><span class="op" id="2495375">*</span><span class="ident" id="2495376">rtype</span><span class="op" id="2495381">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495385">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495430">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495485">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495545">dummy</span>&nbsp;<span class="op" id="2495551">:=</span>&nbsp;<span class="ident" id="2495554">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495571">code</span>&nbsp;<span class="op" id="2495576">:=</span>&nbsp;<span class="op" id="2495579">*</span><span class="op" id="2495580">*</span><span class="op" id="2495581">(</span><span class="op" id="2495582">*</span><span class="op" id="2495583">*</span><span class="builtintype" id="2495584">uintptr</span><span class="op" id="2495591">)</span><span class="op" id="2495592">(</span><span class="ident" id="2495593">unsafe</span><span class="op" id="2495599">.</span><span class="ident" id="2495600">Pointer</span><span class="op" id="2495607">(</span><span class="op" id="2495608">&amp;</span><span class="ident" id="2495609">dummy</span><span class="op" id="2495614">)</span><span class="op" id="2495615">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495619">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495679">_</span><span class="op" id="2495680">,</span>&nbsp;<span class="ident" id="2495682">_</span><span class="op" id="2495683">,</span>&nbsp;<span class="ident" id="2495685">_</span><span class="op" id="2495686">,</span>&nbsp;<span class="ident" id="2495688">stack</span>&nbsp;<span class="op" id="2495694">:=</span>&nbsp;<span class="ident" id="2495697">funcLayout</span><span class="op" id="2495707">(</span><span class="ident" id="2495708">funcType</span><span class="op" id="2495716">,</span>&nbsp;<span class="ident" id="2495718">nil</span><span class="op" id="2495721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495725">fv</span>&nbsp;<span class="op" id="2495728">:=</span>&nbsp;<span class="op" id="2495731">&amp;</span><span class="ident" id="2495732">methodValue</span><span class="op" id="2495743">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495747">fn</span><span class="op" id="2495749">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2495755">code</span><span class="op" id="2495759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495763">stack</span><span class="op" id="2495768">:</span>&nbsp;&nbsp;<span class="ident" id="2495771">stack</span><span class="op" id="2495776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495780">method</span><span class="op" id="2495786">:</span>&nbsp;<span class="builtintype" id="2495788">int</span><span class="op" id="2495791">(</span><span class="ident" id="2495792">v</span><span class="op" id="2495793">.</span><span class="ident" id="2495794">flag</span><span class="op" id="2495798">)</span>&nbsp;<span class="op" id="2495800">&gt;&gt;</span>&nbsp;<span class="ident" id="2495803">flagMethodShift</span><span class="op" id="2495818">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2495822">rcvr</span><span class="op" id="2495826">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2495830">rcvr</span><span class="op" id="2495834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2495837">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495841">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495887">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2495953">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2496017">methodReceiver</span><span class="op" id="2496031">(</span><span class="ident" id="2496032">op</span><span class="op" id="2496034">,</span>&nbsp;<span class="ident" id="2496036">fv</span><span class="op" id="2496038">.</span><span class="ident" id="2496039">rcvr</span><span class="op" id="2496043">,</span>&nbsp;<span class="ident" id="2496045">fv</span><span class="op" id="2496047">.</span><span class="ident" id="2496048">method</span><span class="op" id="2496054">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2496058">return</span>&nbsp;<span class="ident" id="2496065">Value</span><span class="op" id="2496070">{</span><span class="ident" id="2496071">funcType</span><span class="op" id="2496079">,</span>&nbsp;<span class="ident" id="2496081">unsafe</span><span class="op" id="2496087">.</span><span class="ident" id="2496088">Pointer</span><span class="op" id="2496095">(</span><span class="ident" id="2496096">fv</span><span class="op" id="2496098">)</span><span class="op" id="2496099">,</span>&nbsp;<span class="ident" id="2496101">v</span><span class="op" id="2496102">.</span><span class="ident" id="2496103">flag</span><span class="op" id="2496107">&amp;</span><span class="ident" id="2496108">flagRO</span>&nbsp;<span class="op" id="2496115">|</span>&nbsp;<span class="ident" id="2496117">flag</span><span class="op" id="2496121">(</span><span class="ident" id="2496122">Func</span><span class="op" id="2496126">)</span><span class="op" id="2496127">}</span><br>
<span class="lineno"></span><span class="op" id="2496129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2496132">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2496200">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2496273">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2496350">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2496424">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2496465">func</span>&nbsp;<span class="ident" id="2496470">methodValueCall</span><span class="op" id="2496485">(</span><span class="op" id="2496486">)</span>
</div>
</body>
</html>
