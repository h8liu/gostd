<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2640228">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2640283">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2640337">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2640388">package</span>&nbsp;<span class="ident" id="2640396">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2640405">import</span>&nbsp;<span class="string" id="2640412">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2640418">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2640476">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2640533">type</span>&nbsp;<span class="ident" id="2640538">Replacer</span>&nbsp;<span class="keyword" id="2640547">struct</span>&nbsp;<span class="op" id="2640554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640557">r</span>&nbsp;<span class="ident" id="2640559">replacer</span><br>
<span class="lineno"></span><span class="op" id="2640568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2640571">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2640649">type</span>&nbsp;<span class="ident" id="2640654">replacer</span>&nbsp;<span class="keyword" id="2640663">interface</span>&nbsp;<span class="op" id="2640673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640676">Replace</span><span class="op" id="2640683">(</span><span class="ident" id="2640684">s</span>&nbsp;<span class="builtintype" id="2640686">string</span><span class="op" id="2640692">)</span>&nbsp;<span class="builtintype" id="2640694">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2640702">WriteString</span><span class="op" id="2640713">(</span><span class="ident" id="2640714">w</span>&nbsp;<span class="ident" id="2640716">io</span><span class="op" id="2640718">.</span><span class="ident" id="2640719">Writer</span><span class="op" id="2640725">,</span>&nbsp;<span class="ident" id="2640727">s</span>&nbsp;<span class="builtintype" id="2640729">string</span><span class="op" id="2640735">)</span>&nbsp;<span class="op" id="2640737">(</span><span class="ident" id="2640738">n</span>&nbsp;<span class="builtintype" id="2640740">int</span><span class="op" id="2640743">,</span>&nbsp;<span class="ident" id="2640745">err</span>&nbsp;<span class="builtintype" id="2640749">error</span><span class="op" id="2640754">)</span><br>
<span class="lineno"></span><span class="op" id="2640756">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2640759">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2640835">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2640904">func</span>&nbsp;<span class="ident" id="2640909">NewReplacer</span><span class="op" id="2640920">(</span><span class="ident" id="2640921">oldnew</span>&nbsp;<span class="op" id="2640928">...</span><span class="builtintype" id="2640931">string</span><span class="op" id="2640937">)</span>&nbsp;<span class="op" id="2640939">*</span><span class="ident" id="2640940">Replacer</span>&nbsp;<span class="op" id="2640949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2640952">if</span>&nbsp;<span class="builtinfunc" id="2640955">len</span><span class="op" id="2640958">(</span><span class="ident" id="2640959">oldnew</span><span class="op" id="2640965">)</span><span class="op" id="2640966">%</span><span class="num" id="2640967">2</span>&nbsp;<span class="op" id="2640969">==</span>&nbsp;<span class="num" id="2640972">1</span>&nbsp;<span class="op" id="2640974">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2640978">panic</span><span class="op" id="2640983">(</span><span class="string" id="2640984">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2641025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641032">if</span>&nbsp;<span class="builtinfunc" id="2641035">len</span><span class="op" id="2641038">(</span><span class="ident" id="2641039">oldnew</span><span class="op" id="2641045">)</span>&nbsp;<span class="op" id="2641047">==</span>&nbsp;<span class="num" id="2641050">2</span>&nbsp;<span class="op" id="2641052">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2641055">len</span><span class="op" id="2641058">(</span><span class="ident" id="2641059">oldnew</span><span class="op" id="2641065">[</span><span class="num" id="2641066">0</span><span class="op" id="2641067">]</span><span class="op" id="2641068">)</span>&nbsp;<span class="op" id="2641070">&gt;</span>&nbsp;<span class="num" id="2641072">1</span>&nbsp;<span class="op" id="2641074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641078">return</span>&nbsp;<span class="op" id="2641085">&amp;</span><span class="ident" id="2641086">Replacer</span><span class="op" id="2641094">{</span><span class="ident" id="2641095">r</span><span class="op" id="2641096">:</span>&nbsp;<span class="ident" id="2641098">makeSingleStringReplacer</span><span class="op" id="2641122">(</span><span class="ident" id="2641123">oldnew</span><span class="op" id="2641129">[</span><span class="num" id="2641130">0</span><span class="op" id="2641131">]</span><span class="op" id="2641132">,</span>&nbsp;<span class="ident" id="2641134">oldnew</span><span class="op" id="2641140">[</span><span class="num" id="2641141">1</span><span class="op" id="2641142">]</span><span class="op" id="2641143">)</span><span class="op" id="2641144">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641151">allNewBytes</span>&nbsp;<span class="op" id="2641163">:=</span>&nbsp;<span class="builtintype" id="2641166">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641172">for</span>&nbsp;<span class="ident" id="2641176">i</span>&nbsp;<span class="op" id="2641178">:=</span>&nbsp;<span class="num" id="2641181">0</span><span class="op" id="2641182">;</span>&nbsp;<span class="ident" id="2641184">i</span>&nbsp;<span class="op" id="2641186">&lt;</span>&nbsp;<span class="builtinfunc" id="2641188">len</span><span class="op" id="2641191">(</span><span class="ident" id="2641192">oldnew</span><span class="op" id="2641198">)</span><span class="op" id="2641199">;</span>&nbsp;<span class="ident" id="2641201">i</span>&nbsp;<span class="op" id="2641203">+=</span>&nbsp;<span class="num" id="2641206">2</span>&nbsp;<span class="op" id="2641208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641212">if</span>&nbsp;<span class="builtinfunc" id="2641215">len</span><span class="op" id="2641218">(</span><span class="ident" id="2641219">oldnew</span><span class="op" id="2641225">[</span><span class="ident" id="2641226">i</span><span class="op" id="2641227">]</span><span class="op" id="2641228">)</span>&nbsp;<span class="op" id="2641230">!=</span>&nbsp;<span class="num" id="2641233">1</span>&nbsp;<span class="op" id="2641235">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641240">return</span>&nbsp;<span class="op" id="2641247">&amp;</span><span class="ident" id="2641248">Replacer</span><span class="op" id="2641256">{</span><span class="ident" id="2641257">r</span><span class="op" id="2641258">:</span>&nbsp;<span class="ident" id="2641260">makeGenericReplacer</span><span class="op" id="2641279">(</span><span class="ident" id="2641280">oldnew</span><span class="op" id="2641286">)</span><span class="op" id="2641287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641295">if</span>&nbsp;<span class="builtinfunc" id="2641298">len</span><span class="op" id="2641301">(</span><span class="ident" id="2641302">oldnew</span><span class="op" id="2641308">[</span><span class="ident" id="2641309">i</span><span class="op" id="2641310">+</span><span class="num" id="2641311">1</span><span class="op" id="2641312">]</span><span class="op" id="2641313">)</span>&nbsp;<span class="op" id="2641315">!=</span>&nbsp;<span class="num" id="2641318">1</span>&nbsp;<span class="op" id="2641320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641325">allNewBytes</span>&nbsp;<span class="op" id="2641337">=</span>&nbsp;<span class="builtintype" id="2641339">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641347">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641354">if</span>&nbsp;<span class="ident" id="2641357">allNewBytes</span>&nbsp;<span class="op" id="2641369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641373">r</span>&nbsp;<span class="op" id="2641375">:=</span>&nbsp;<span class="ident" id="2641378">byteReplacer</span><span class="op" id="2641390">{</span><span class="op" id="2641391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641395">for</span>&nbsp;<span class="ident" id="2641399">i</span>&nbsp;<span class="op" id="2641401">:=</span>&nbsp;<span class="keyword" id="2641404">range</span>&nbsp;<span class="ident" id="2641410">r</span>&nbsp;<span class="op" id="2641412">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641417">r</span><span class="op" id="2641418">[</span><span class="ident" id="2641419">i</span><span class="op" id="2641420">]</span>&nbsp;<span class="op" id="2641422">=</span>&nbsp;<span class="builtintype" id="2641424">byte</span><span class="op" id="2641428">(</span><span class="ident" id="2641429">i</span><span class="op" id="2641430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2641438">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2641497">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641544">for</span>&nbsp;<span class="ident" id="2641548">i</span>&nbsp;<span class="op" id="2641550">:=</span>&nbsp;<span class="builtinfunc" id="2641553">len</span><span class="op" id="2641556">(</span><span class="ident" id="2641557">oldnew</span><span class="op" id="2641563">)</span>&nbsp;<span class="op" id="2641565">-</span>&nbsp;<span class="num" id="2641567">2</span><span class="op" id="2641568">;</span>&nbsp;<span class="ident" id="2641570">i</span>&nbsp;<span class="op" id="2641572">&gt;=</span>&nbsp;<span class="num" id="2641575">0</span><span class="op" id="2641576">;</span>&nbsp;<span class="ident" id="2641578">i</span>&nbsp;<span class="op" id="2641580">-=</span>&nbsp;<span class="num" id="2641583">2</span>&nbsp;<span class="op" id="2641585">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641590">o</span>&nbsp;<span class="op" id="2641592">:=</span>&nbsp;<span class="ident" id="2641595">oldnew</span><span class="op" id="2641601">[</span><span class="ident" id="2641602">i</span><span class="op" id="2641603">]</span><span class="op" id="2641604">[</span><span class="num" id="2641605">0</span><span class="op" id="2641606">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641611">n</span>&nbsp;<span class="op" id="2641613">:=</span>&nbsp;<span class="ident" id="2641616">oldnew</span><span class="op" id="2641622">[</span><span class="ident" id="2641623">i</span><span class="op" id="2641624">+</span><span class="num" id="2641625">1</span><span class="op" id="2641626">]</span><span class="op" id="2641627">[</span><span class="num" id="2641628">0</span><span class="op" id="2641629">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641634">r</span><span class="op" id="2641635">[</span><span class="ident" id="2641636">o</span><span class="op" id="2641637">]</span>&nbsp;<span class="op" id="2641639">=</span>&nbsp;<span class="ident" id="2641641">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641649">return</span>&nbsp;<span class="op" id="2641656">&amp;</span><span class="ident" id="2641657">Replacer</span><span class="op" id="2641665">{</span><span class="ident" id="2641666">r</span><span class="op" id="2641667">:</span>&nbsp;<span class="op" id="2641669">&amp;</span><span class="ident" id="2641670">r</span><span class="op" id="2641671">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641678">r</span>&nbsp;<span class="op" id="2641680">:=</span>&nbsp;<span class="ident" id="2641683">byteStringReplacer</span><span class="op" id="2641701">{</span><span class="op" id="2641702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2641705">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2641763">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641809">for</span>&nbsp;<span class="ident" id="2641813">i</span>&nbsp;<span class="op" id="2641815">:=</span>&nbsp;<span class="builtinfunc" id="2641818">len</span><span class="op" id="2641821">(</span><span class="ident" id="2641822">oldnew</span><span class="op" id="2641828">)</span>&nbsp;<span class="op" id="2641830">-</span>&nbsp;<span class="num" id="2641832">2</span><span class="op" id="2641833">;</span>&nbsp;<span class="ident" id="2641835">i</span>&nbsp;<span class="op" id="2641837">&gt;=</span>&nbsp;<span class="num" id="2641840">0</span><span class="op" id="2641841">;</span>&nbsp;<span class="ident" id="2641843">i</span>&nbsp;<span class="op" id="2641845">-=</span>&nbsp;<span class="num" id="2641848">2</span>&nbsp;<span class="op" id="2641850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641854">o</span>&nbsp;<span class="op" id="2641856">:=</span>&nbsp;<span class="ident" id="2641859">oldnew</span><span class="op" id="2641865">[</span><span class="ident" id="2641866">i</span><span class="op" id="2641867">]</span><span class="op" id="2641868">[</span><span class="num" id="2641869">0</span><span class="op" id="2641870">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641874">n</span>&nbsp;<span class="op" id="2641876">:=</span>&nbsp;<span class="ident" id="2641879">oldnew</span><span class="op" id="2641885">[</span><span class="ident" id="2641886">i</span><span class="op" id="2641887">+</span><span class="num" id="2641888">1</span><span class="op" id="2641889">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2641893">r</span><span class="op" id="2641894">[</span><span class="ident" id="2641895">o</span><span class="op" id="2641896">]</span>&nbsp;<span class="op" id="2641898">=</span>&nbsp;<span class="op" id="2641900">[</span><span class="op" id="2641901">]</span><span class="builtintype" id="2641902">byte</span><span class="op" id="2641906">(</span><span class="ident" id="2641907">n</span><span class="op" id="2641908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2641911">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2641914">return</span>&nbsp;<span class="op" id="2641921">&amp;</span><span class="ident" id="2641922">Replacer</span><span class="op" id="2641930">{</span><span class="ident" id="2641931">r</span><span class="op" id="2641932">:</span>&nbsp;<span class="op" id="2641934">&amp;</span><span class="ident" id="2641935">r</span><span class="op" id="2641936">}</span><br>
<span class="lineno"></span><span class="op" id="2641938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2641941">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2642005">func</span>&nbsp;<span class="op" id="2642010">(</span><span class="ident" id="2642011">r</span>&nbsp;<span class="op" id="2642013">*</span><span class="ident" id="2642014">Replacer</span><span class="op" id="2642022">)</span>&nbsp;<span class="ident" id="2642024">Replace</span><span class="op" id="2642031">(</span><span class="ident" id="2642032">s</span>&nbsp;<span class="builtintype" id="2642034">string</span><span class="op" id="2642040">)</span>&nbsp;<span class="builtintype" id="2642042">string</span>&nbsp;<span class="op" id="2642049">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2642052">return</span>&nbsp;<span class="ident" id="2642059">r</span><span class="op" id="2642060">.</span><span class="ident" id="2642061">r</span><span class="op" id="2642062">.</span><span class="ident" id="2642063">Replace</span><span class="op" id="2642070">(</span><span class="ident" id="2642071">s</span><span class="op" id="2642072">)</span><br>
<span class="lineno"></span><span class="op" id="2642074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2642077">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2642139">func</span>&nbsp;<span class="op" id="2642144">(</span><span class="ident" id="2642145">r</span>&nbsp;<span class="op" id="2642147">*</span><span class="ident" id="2642148">Replacer</span><span class="op" id="2642156">)</span>&nbsp;<span class="ident" id="2642158">WriteString</span><span class="op" id="2642169">(</span><span class="ident" id="2642170">w</span>&nbsp;<span class="ident" id="2642172">io</span><span class="op" id="2642174">.</span><span class="ident" id="2642175">Writer</span><span class="op" id="2642181">,</span>&nbsp;<span class="ident" id="2642183">s</span>&nbsp;<span class="builtintype" id="2642185">string</span><span class="op" id="2642191">)</span>&nbsp;<span class="op" id="2642193">(</span><span class="ident" id="2642194">n</span>&nbsp;<span class="builtintype" id="2642196">int</span><span class="op" id="2642199">,</span>&nbsp;<span class="ident" id="2642201">err</span>&nbsp;<span class="builtintype" id="2642205">error</span><span class="op" id="2642210">)</span>&nbsp;<span class="op" id="2642212">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2642215">return</span>&nbsp;<span class="ident" id="2642222">r</span><span class="op" id="2642223">.</span><span class="ident" id="2642224">r</span><span class="op" id="2642225">.</span><span class="ident" id="2642226">WriteString</span><span class="op" id="2642237">(</span><span class="ident" id="2642238">w</span><span class="op" id="2642239">,</span>&nbsp;<span class="ident" id="2642241">s</span><span class="op" id="2642242">)</span><br>
<span class="lineno"></span><span class="op" id="2642244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2642247">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2642324">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2642402">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2642450">//</span><br>
<span class="lineno"></span><span class="comment" id="2642453">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2642463">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2642474">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2642486">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2642498">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2642509">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2642523">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2642534">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2642546">//</span><br>
<span class="lineno"></span><span class="comment" id="2642549">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2642627">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2642705">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2642779">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2642830">type</span>&nbsp;<span class="ident" id="2642835">trieNode</span>&nbsp;<span class="keyword" id="2642844">struct</span>&nbsp;<span class="op" id="2642851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2642854">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2642927">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2642964">value</span>&nbsp;<span class="builtintype" id="2642970">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2642978">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643053">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643128">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643201">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643274">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2643306">priority</span>&nbsp;<span class="builtintype" id="2643315">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643321">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643377">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643441">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643509">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643567">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643571">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643643">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643701">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643775">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643852">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2643927">prefix</span>&nbsp;<span class="builtintype" id="2643934">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2643942">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2643949">*</span><span class="ident" id="2643950">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2643961">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644032">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644106">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644180">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644254">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644319">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644394">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2644416">table</span>&nbsp;<span class="op" id="2644422">[</span><span class="op" id="2644423">]</span><span class="op" id="2644424">*</span><span class="ident" id="2644425">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2644434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2644437">func</span>&nbsp;<span class="op" id="2644442">(</span><span class="ident" id="2644443">t</span>&nbsp;<span class="op" id="2644445">*</span><span class="ident" id="2644446">trieNode</span><span class="op" id="2644454">)</span>&nbsp;<span class="ident" id="2644456">add</span><span class="op" id="2644459">(</span><span class="ident" id="2644460">key</span><span class="op" id="2644463">,</span>&nbsp;<span class="ident" id="2644465">val</span>&nbsp;<span class="builtintype" id="2644469">string</span><span class="op" id="2644475">,</span>&nbsp;<span class="ident" id="2644477">priority</span>&nbsp;<span class="builtintype" id="2644486">int</span><span class="op" id="2644489">,</span>&nbsp;<span class="ident" id="2644491">r</span>&nbsp;<span class="op" id="2644493">*</span><span class="ident" id="2644494">genericReplacer</span><span class="op" id="2644509">)</span>&nbsp;<span class="op" id="2644511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644514">if</span>&nbsp;<span class="ident" id="2644517">key</span>&nbsp;<span class="op" id="2644521">==</span>&nbsp;<span class="string" id="2644524">&#34;&#34;</span>&nbsp;<span class="op" id="2644527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644531">if</span>&nbsp;<span class="ident" id="2644534">t</span><span class="op" id="2644535">.</span><span class="ident" id="2644536">priority</span>&nbsp;<span class="op" id="2644545">==</span>&nbsp;<span class="num" id="2644548">0</span>&nbsp;<span class="op" id="2644550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2644555">t</span><span class="op" id="2644556">.</span><span class="ident" id="2644557">value</span>&nbsp;<span class="op" id="2644563">=</span>&nbsp;<span class="ident" id="2644565">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2644572">t</span><span class="op" id="2644573">.</span><span class="ident" id="2644574">priority</span>&nbsp;<span class="op" id="2644583">=</span>&nbsp;<span class="ident" id="2644585">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2644596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644600">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2644608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644612">if</span>&nbsp;<span class="ident" id="2644615">t</span><span class="op" id="2644616">.</span><span class="ident" id="2644617">prefix</span>&nbsp;<span class="op" id="2644624">!=</span>&nbsp;<span class="string" id="2644627">&#34;&#34;</span>&nbsp;<span class="op" id="2644630">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644634">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644686">var</span>&nbsp;<span class="ident" id="2644690">n</span>&nbsp;<span class="builtintype" id="2644692">int</span>&nbsp;<span class="comment" id="2644696">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644737">for</span>&nbsp;<span class="op" id="2644741">;</span>&nbsp;<span class="ident" id="2644743">n</span>&nbsp;<span class="op" id="2644745">&lt;</span>&nbsp;<span class="builtinfunc" id="2644747">len</span><span class="op" id="2644750">(</span><span class="ident" id="2644751">t</span><span class="op" id="2644752">.</span><span class="ident" id="2644753">prefix</span><span class="op" id="2644759">)</span>&nbsp;<span class="op" id="2644761">&amp;&amp;</span>&nbsp;<span class="ident" id="2644764">n</span>&nbsp;<span class="op" id="2644766">&lt;</span>&nbsp;<span class="builtinfunc" id="2644768">len</span><span class="op" id="2644771">(</span><span class="ident" id="2644772">key</span><span class="op" id="2644775">)</span><span class="op" id="2644776">;</span>&nbsp;<span class="ident" id="2644778">n</span><span class="op" id="2644779">++</span>&nbsp;<span class="op" id="2644782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644787">if</span>&nbsp;<span class="ident" id="2644790">t</span><span class="op" id="2644791">.</span><span class="ident" id="2644792">prefix</span><span class="op" id="2644798">[</span><span class="ident" id="2644799">n</span><span class="op" id="2644800">]</span>&nbsp;<span class="op" id="2644802">!=</span>&nbsp;<span class="ident" id="2644805">key</span><span class="op" id="2644808">[</span><span class="ident" id="2644809">n</span><span class="op" id="2644810">]</span>&nbsp;<span class="op" id="2644812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644818">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2644827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2644831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2644835">if</span>&nbsp;<span class="ident" id="2644838">n</span>&nbsp;<span class="op" id="2644840">==</span>&nbsp;<span class="builtinfunc" id="2644843">len</span><span class="op" id="2644846">(</span><span class="ident" id="2644847">t</span><span class="op" id="2644848">.</span><span class="ident" id="2644849">prefix</span><span class="op" id="2644855">)</span>&nbsp;<span class="op" id="2644857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2644862">t</span><span class="op" id="2644863">.</span><span class="ident" id="2644864">next</span><span class="op" id="2644868">.</span><span class="ident" id="2644869">add</span><span class="op" id="2644872">(</span><span class="ident" id="2644873">key</span><span class="op" id="2644876">[</span><span class="ident" id="2644877">n</span><span class="op" id="2644878">:</span><span class="op" id="2644879">]</span><span class="op" id="2644880">,</span>&nbsp;<span class="ident" id="2644882">val</span><span class="op" id="2644885">,</span>&nbsp;<span class="ident" id="2644887">priority</span><span class="op" id="2644895">,</span>&nbsp;<span class="ident" id="2644897">r</span><span class="op" id="2644898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2644902">}</span>&nbsp;<span class="keyword" id="2644904">else</span>&nbsp;<span class="keyword" id="2644909">if</span>&nbsp;<span class="ident" id="2644912">n</span>&nbsp;<span class="op" id="2644914">==</span>&nbsp;<span class="num" id="2644917">0</span>&nbsp;<span class="op" id="2644919">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644924">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2644992">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2645057">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2645103">var</span>&nbsp;<span class="ident" id="2645107">prefixNode</span>&nbsp;<span class="op" id="2645118">*</span><span class="ident" id="2645119">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2645131">if</span>&nbsp;<span class="builtinfunc" id="2645134">len</span><span class="op" id="2645137">(</span><span class="ident" id="2645138">t</span><span class="op" id="2645139">.</span><span class="ident" id="2645140">prefix</span><span class="op" id="2645146">)</span>&nbsp;<span class="op" id="2645148">==</span>&nbsp;<span class="num" id="2645151">1</span>&nbsp;<span class="op" id="2645153">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645159">prefixNode</span>&nbsp;<span class="op" id="2645170">=</span>&nbsp;<span class="ident" id="2645172">t</span><span class="op" id="2645173">.</span><span class="ident" id="2645174">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645182">}</span>&nbsp;<span class="keyword" id="2645184">else</span>&nbsp;<span class="op" id="2645189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645195">prefixNode</span>&nbsp;<span class="op" id="2645206">=</span>&nbsp;<span class="op" id="2645208">&amp;</span><span class="ident" id="2645209">trieNode</span><span class="op" id="2645217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645224">prefix</span><span class="op" id="2645230">:</span>&nbsp;<span class="ident" id="2645232">t</span><span class="op" id="2645233">.</span><span class="ident" id="2645234">prefix</span><span class="op" id="2645240">[</span><span class="num" id="2645241">1</span><span class="op" id="2645242">:</span><span class="op" id="2645243">]</span><span class="op" id="2645244">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645251">next</span><span class="op" id="2645255">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2645259">t</span><span class="op" id="2645260">.</span><span class="ident" id="2645261">next</span><span class="op" id="2645265">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645281">keyNode</span>&nbsp;<span class="op" id="2645289">:=</span>&nbsp;<span class="builtinfunc" id="2645292">new</span><span class="op" id="2645295">(</span><span class="ident" id="2645296">trieNode</span><span class="op" id="2645304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645309">t</span><span class="op" id="2645310">.</span><span class="ident" id="2645311">table</span>&nbsp;<span class="op" id="2645317">=</span>&nbsp;<span class="builtinfunc" id="2645319">make</span><span class="op" id="2645323">(</span><span class="op" id="2645324">[</span><span class="op" id="2645325">]</span><span class="op" id="2645326">*</span><span class="ident" id="2645327">trieNode</span><span class="op" id="2645335">,</span>&nbsp;<span class="ident" id="2645337">r</span><span class="op" id="2645338">.</span><span class="ident" id="2645339">tableSize</span><span class="op" id="2645348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645353">t</span><span class="op" id="2645354">.</span><span class="ident" id="2645355">table</span><span class="op" id="2645360">[</span><span class="ident" id="2645361">r</span><span class="op" id="2645362">.</span><span class="ident" id="2645363">mapping</span><span class="op" id="2645370">[</span><span class="ident" id="2645371">t</span><span class="op" id="2645372">.</span><span class="ident" id="2645373">prefix</span><span class="op" id="2645379">[</span><span class="num" id="2645380">0</span><span class="op" id="2645381">]</span><span class="op" id="2645382">]</span><span class="op" id="2645383">]</span>&nbsp;<span class="op" id="2645385">=</span>&nbsp;<span class="ident" id="2645387">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645401">t</span><span class="op" id="2645402">.</span><span class="ident" id="2645403">table</span><span class="op" id="2645408">[</span><span class="ident" id="2645409">r</span><span class="op" id="2645410">.</span><span class="ident" id="2645411">mapping</span><span class="op" id="2645418">[</span><span class="ident" id="2645419">key</span><span class="op" id="2645422">[</span><span class="num" id="2645423">0</span><span class="op" id="2645424">]</span><span class="op" id="2645425">]</span><span class="op" id="2645426">]</span>&nbsp;<span class="op" id="2645428">=</span>&nbsp;<span class="ident" id="2645430">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645441">t</span><span class="op" id="2645442">.</span><span class="ident" id="2645443">prefix</span>&nbsp;<span class="op" id="2645450">=</span>&nbsp;<span class="string" id="2645452">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645458">t</span><span class="op" id="2645459">.</span><span class="ident" id="2645460">next</span>&nbsp;<span class="op" id="2645465">=</span>&nbsp;<span class="ident" id="2645467">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645474">keyNode</span><span class="op" id="2645481">.</span><span class="ident" id="2645482">add</span><span class="op" id="2645485">(</span><span class="ident" id="2645486">key</span><span class="op" id="2645489">[</span><span class="num" id="2645490">1</span><span class="op" id="2645491">:</span><span class="op" id="2645492">]</span><span class="op" id="2645493">,</span>&nbsp;<span class="ident" id="2645495">val</span><span class="op" id="2645498">,</span>&nbsp;<span class="ident" id="2645500">priority</span><span class="op" id="2645508">,</span>&nbsp;<span class="ident" id="2645510">r</span><span class="op" id="2645511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645515">}</span>&nbsp;<span class="keyword" id="2645517">else</span>&nbsp;<span class="op" id="2645522">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2645527">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645589">next</span>&nbsp;<span class="op" id="2645594">:=</span>&nbsp;<span class="op" id="2645597">&amp;</span><span class="ident" id="2645598">trieNode</span><span class="op" id="2645606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645612">prefix</span><span class="op" id="2645618">:</span>&nbsp;<span class="ident" id="2645620">t</span><span class="op" id="2645621">.</span><span class="ident" id="2645622">prefix</span><span class="op" id="2645628">[</span><span class="ident" id="2645629">n</span><span class="op" id="2645630">:</span><span class="op" id="2645631">]</span><span class="op" id="2645632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645638">next</span><span class="op" id="2645642">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2645646">t</span><span class="op" id="2645647">.</span><span class="ident" id="2645648">next</span><span class="op" id="2645652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645657">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645662">t</span><span class="op" id="2645663">.</span><span class="ident" id="2645664">prefix</span>&nbsp;<span class="op" id="2645671">=</span>&nbsp;<span class="ident" id="2645673">t</span><span class="op" id="2645674">.</span><span class="ident" id="2645675">prefix</span><span class="op" id="2645681">[</span><span class="op" id="2645682">:</span><span class="ident" id="2645683">n</span><span class="op" id="2645684">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645689">t</span><span class="op" id="2645690">.</span><span class="ident" id="2645691">next</span>&nbsp;<span class="op" id="2645696">=</span>&nbsp;<span class="ident" id="2645698">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645706">next</span><span class="op" id="2645710">.</span><span class="ident" id="2645711">add</span><span class="op" id="2645714">(</span><span class="ident" id="2645715">key</span><span class="op" id="2645718">[</span><span class="ident" id="2645719">n</span><span class="op" id="2645720">:</span><span class="op" id="2645721">]</span><span class="op" id="2645722">,</span>&nbsp;<span class="ident" id="2645724">val</span><span class="op" id="2645727">,</span>&nbsp;<span class="ident" id="2645729">priority</span><span class="op" id="2645737">,</span>&nbsp;<span class="ident" id="2645739">r</span><span class="op" id="2645740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645747">}</span>&nbsp;<span class="keyword" id="2645749">else</span>&nbsp;<span class="keyword" id="2645754">if</span>&nbsp;<span class="ident" id="2645757">t</span><span class="op" id="2645758">.</span><span class="ident" id="2645759">table</span>&nbsp;<span class="op" id="2645765">!=</span>&nbsp;<span class="ident" id="2645768">nil</span>&nbsp;<span class="op" id="2645772">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2645776">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645809">m</span>&nbsp;<span class="op" id="2645811">:=</span>&nbsp;<span class="ident" id="2645814">r</span><span class="op" id="2645815">.</span><span class="ident" id="2645816">mapping</span><span class="op" id="2645823">[</span><span class="ident" id="2645824">key</span><span class="op" id="2645827">[</span><span class="num" id="2645828">0</span><span class="op" id="2645829">]</span><span class="op" id="2645830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2645834">if</span>&nbsp;<span class="ident" id="2645837">t</span><span class="op" id="2645838">.</span><span class="ident" id="2645839">table</span><span class="op" id="2645844">[</span><span class="ident" id="2645845">m</span><span class="op" id="2645846">]</span>&nbsp;<span class="op" id="2645848">==</span>&nbsp;<span class="ident" id="2645851">nil</span>&nbsp;<span class="op" id="2645855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645860">t</span><span class="op" id="2645861">.</span><span class="ident" id="2645862">table</span><span class="op" id="2645867">[</span><span class="ident" id="2645868">m</span><span class="op" id="2645869">]</span>&nbsp;<span class="op" id="2645871">=</span>&nbsp;<span class="builtinfunc" id="2645873">new</span><span class="op" id="2645876">(</span><span class="ident" id="2645877">trieNode</span><span class="op" id="2645885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645889">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645893">t</span><span class="op" id="2645894">.</span><span class="ident" id="2645895">table</span><span class="op" id="2645900">[</span><span class="ident" id="2645901">m</span><span class="op" id="2645902">]</span><span class="op" id="2645903">.</span><span class="ident" id="2645904">add</span><span class="op" id="2645907">(</span><span class="ident" id="2645908">key</span><span class="op" id="2645911">[</span><span class="num" id="2645912">1</span><span class="op" id="2645913">:</span><span class="op" id="2645914">]</span><span class="op" id="2645915">,</span>&nbsp;<span class="ident" id="2645917">val</span><span class="op" id="2645920">,</span>&nbsp;<span class="ident" id="2645922">priority</span><span class="op" id="2645930">,</span>&nbsp;<span class="ident" id="2645932">r</span><span class="op" id="2645933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2645936">}</span>&nbsp;<span class="keyword" id="2645938">else</span>&nbsp;<span class="op" id="2645943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645947">t</span><span class="op" id="2645948">.</span><span class="ident" id="2645949">prefix</span>&nbsp;<span class="op" id="2645956">=</span>&nbsp;<span class="ident" id="2645958">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645964">t</span><span class="op" id="2645965">.</span><span class="ident" id="2645966">next</span>&nbsp;<span class="op" id="2645971">=</span>&nbsp;<span class="builtinfunc" id="2645973">new</span><span class="op" id="2645976">(</span><span class="ident" id="2645977">trieNode</span><span class="op" id="2645985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2645989">t</span><span class="op" id="2645990">.</span><span class="ident" id="2645991">next</span><span class="op" id="2645995">.</span><span class="ident" id="2645996">add</span><span class="op" id="2645999">(</span><span class="string" id="2646000">&#34;&#34;</span><span class="op" id="2646002">,</span>&nbsp;<span class="ident" id="2646004">val</span><span class="op" id="2646007">,</span>&nbsp;<span class="ident" id="2646009">priority</span><span class="op" id="2646017">,</span>&nbsp;<span class="ident" id="2646019">r</span><span class="op" id="2646020">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646023">}</span><br>
<span class="lineno"></span><span class="op" id="2646025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2646028">func</span>&nbsp;<span class="op" id="2646033">(</span><span class="ident" id="2646034">r</span>&nbsp;<span class="op" id="2646036">*</span><span class="ident" id="2646037">genericReplacer</span><span class="op" id="2646052">)</span>&nbsp;<span class="ident" id="2646054">lookup</span><span class="op" id="2646060">(</span><span class="ident" id="2646061">s</span>&nbsp;<span class="builtintype" id="2646063">string</span><span class="op" id="2646069">,</span>&nbsp;<span class="ident" id="2646071">ignoreRoot</span>&nbsp;<span class="builtintype" id="2646082">bool</span><span class="op" id="2646086">)</span>&nbsp;<span class="op" id="2646088">(</span><span class="ident" id="2646089">val</span>&nbsp;<span class="builtintype" id="2646093">string</span><span class="op" id="2646099">,</span>&nbsp;<span class="ident" id="2646101">keylen</span>&nbsp;<span class="builtintype" id="2646108">int</span><span class="op" id="2646111">,</span>&nbsp;<span class="ident" id="2646113">found</span>&nbsp;<span class="builtintype" id="2646119">bool</span><span class="op" id="2646123">)</span>&nbsp;<span class="op" id="2646125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2646128">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2646201">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646227">bestPriority</span>&nbsp;<span class="op" id="2646240">:=</span>&nbsp;<span class="num" id="2646243">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646246">node</span>&nbsp;<span class="op" id="2646251">:=</span>&nbsp;<span class="op" id="2646254">&amp;</span><span class="ident" id="2646255">r</span><span class="op" id="2646256">.</span><span class="ident" id="2646257">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646263">n</span>&nbsp;<span class="op" id="2646265">:=</span>&nbsp;<span class="num" id="2646268">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646271">for</span>&nbsp;<span class="ident" id="2646275">node</span>&nbsp;<span class="op" id="2646280">!=</span>&nbsp;<span class="ident" id="2646283">nil</span>&nbsp;<span class="op" id="2646287">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646291">if</span>&nbsp;<span class="ident" id="2646294">node</span><span class="op" id="2646298">.</span><span class="ident" id="2646299">priority</span>&nbsp;<span class="op" id="2646308">&gt;</span>&nbsp;<span class="ident" id="2646310">bestPriority</span>&nbsp;<span class="op" id="2646323">&amp;&amp;</span>&nbsp;<span class="op" id="2646326">!</span><span class="op" id="2646327">(</span><span class="ident" id="2646328">ignoreRoot</span>&nbsp;<span class="op" id="2646339">&amp;&amp;</span>&nbsp;<span class="ident" id="2646342">node</span>&nbsp;<span class="op" id="2646347">==</span>&nbsp;<span class="op" id="2646350">&amp;</span><span class="ident" id="2646351">r</span><span class="op" id="2646352">.</span><span class="ident" id="2646353">root</span><span class="op" id="2646357">)</span>&nbsp;<span class="op" id="2646359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646364">bestPriority</span>&nbsp;<span class="op" id="2646377">=</span>&nbsp;<span class="ident" id="2646379">node</span><span class="op" id="2646383">.</span><span class="ident" id="2646384">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646396">val</span>&nbsp;<span class="op" id="2646400">=</span>&nbsp;<span class="ident" id="2646402">node</span><span class="op" id="2646406">.</span><span class="ident" id="2646407">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646416">keylen</span>&nbsp;<span class="op" id="2646423">=</span>&nbsp;<span class="ident" id="2646425">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646430">found</span>&nbsp;<span class="op" id="2646436">=</span>&nbsp;<span class="builtintype" id="2646438">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646450">if</span>&nbsp;<span class="ident" id="2646453">s</span>&nbsp;<span class="op" id="2646455">==</span>&nbsp;<span class="string" id="2646458">&#34;&#34;</span>&nbsp;<span class="op" id="2646461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646466">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646474">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646478">if</span>&nbsp;<span class="ident" id="2646481">node</span><span class="op" id="2646485">.</span><span class="ident" id="2646486">table</span>&nbsp;<span class="op" id="2646492">!=</span>&nbsp;<span class="ident" id="2646495">nil</span>&nbsp;<span class="op" id="2646499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646504">index</span>&nbsp;<span class="op" id="2646510">:=</span>&nbsp;<span class="ident" id="2646513">r</span><span class="op" id="2646514">.</span><span class="ident" id="2646515">mapping</span><span class="op" id="2646522">[</span><span class="ident" id="2646523">s</span><span class="op" id="2646524">[</span><span class="num" id="2646525">0</span><span class="op" id="2646526">]</span><span class="op" id="2646527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646532">if</span>&nbsp;<span class="builtintype" id="2646535">int</span><span class="op" id="2646538">(</span><span class="ident" id="2646539">index</span><span class="op" id="2646544">)</span>&nbsp;<span class="op" id="2646546">==</span>&nbsp;<span class="ident" id="2646549">r</span><span class="op" id="2646550">.</span><span class="ident" id="2646551">tableSize</span>&nbsp;<span class="op" id="2646561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646567">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646576">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646581">node</span>&nbsp;<span class="op" id="2646586">=</span>&nbsp;<span class="ident" id="2646588">node</span><span class="op" id="2646592">.</span><span class="ident" id="2646593">table</span><span class="op" id="2646598">[</span><span class="ident" id="2646599">index</span><span class="op" id="2646604">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646609">s</span>&nbsp;<span class="op" id="2646611">=</span>&nbsp;<span class="ident" id="2646613">s</span><span class="op" id="2646614">[</span><span class="num" id="2646615">1</span><span class="op" id="2646616">:</span><span class="op" id="2646617">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646622">n</span><span class="op" id="2646623">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646628">}</span>&nbsp;<span class="keyword" id="2646630">else</span>&nbsp;<span class="keyword" id="2646635">if</span>&nbsp;<span class="ident" id="2646638">node</span><span class="op" id="2646642">.</span><span class="ident" id="2646643">prefix</span>&nbsp;<span class="op" id="2646650">!=</span>&nbsp;<span class="string" id="2646653">&#34;&#34;</span>&nbsp;<span class="op" id="2646656">&amp;&amp;</span>&nbsp;<span class="ident" id="2646659">HasPrefix</span><span class="op" id="2646668">(</span><span class="ident" id="2646669">s</span><span class="op" id="2646670">,</span>&nbsp;<span class="ident" id="2646672">node</span><span class="op" id="2646676">.</span><span class="ident" id="2646677">prefix</span><span class="op" id="2646683">)</span>&nbsp;<span class="op" id="2646685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646690">n</span>&nbsp;<span class="op" id="2646692">+=</span>&nbsp;<span class="builtinfunc" id="2646695">len</span><span class="op" id="2646698">(</span><span class="ident" id="2646699">node</span><span class="op" id="2646703">.</span><span class="ident" id="2646704">prefix</span><span class="op" id="2646710">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646715">s</span>&nbsp;<span class="op" id="2646717">=</span>&nbsp;<span class="ident" id="2646719">s</span><span class="op" id="2646720">[</span><span class="builtinfunc" id="2646721">len</span><span class="op" id="2646724">(</span><span class="ident" id="2646725">node</span><span class="op" id="2646729">.</span><span class="ident" id="2646730">prefix</span><span class="op" id="2646736">)</span><span class="op" id="2646737">:</span><span class="op" id="2646738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646743">node</span>&nbsp;<span class="op" id="2646748">=</span>&nbsp;<span class="ident" id="2646750">node</span><span class="op" id="2646754">.</span><span class="ident" id="2646755">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646762">}</span>&nbsp;<span class="keyword" id="2646764">else</span>&nbsp;<span class="op" id="2646769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646774">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646782">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2646785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2646788">return</span><br>
<span class="lineno"></span><span class="op" id="2646795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2646798">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2646849">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2646909">type</span>&nbsp;<span class="ident" id="2646914">genericReplacer</span>&nbsp;<span class="keyword" id="2646930">struct</span>&nbsp;<span class="op" id="2646937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2646940">root</span>&nbsp;<span class="ident" id="2646945">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2646955">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2647029">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647054">tableSize</span>&nbsp;<span class="builtintype" id="2647064">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2647069">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647138">mapping</span>&nbsp;<span class="op" id="2647146">[</span><span class="num" id="2647147">256</span><span class="op" id="2647150">]</span><span class="builtintype" id="2647151">byte</span><br>
<span class="lineno"></span><span class="op" id="2647156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2647159">func</span>&nbsp;<span class="ident" id="2647164">makeGenericReplacer</span><span class="op" id="2647183">(</span><span class="ident" id="2647184">oldnew</span>&nbsp;<span class="op" id="2647191">[</span><span class="op" id="2647192">]</span><span class="builtintype" id="2647193">string</span><span class="op" id="2647199">)</span>&nbsp;<span class="op" id="2647201">*</span><span class="ident" id="2647202">genericReplacer</span>&nbsp;<span class="op" id="2647218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647221">r</span>&nbsp;<span class="op" id="2647223">:=</span>&nbsp;<span class="builtinfunc" id="2647226">new</span><span class="op" id="2647229">(</span><span class="ident" id="2647230">genericReplacer</span><span class="op" id="2647245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2647248">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647305">for</span>&nbsp;<span class="ident" id="2647309">i</span>&nbsp;<span class="op" id="2647311">:=</span>&nbsp;<span class="num" id="2647314">0</span><span class="op" id="2647315">;</span>&nbsp;<span class="ident" id="2647317">i</span>&nbsp;<span class="op" id="2647319">&lt;</span>&nbsp;<span class="builtinfunc" id="2647321">len</span><span class="op" id="2647324">(</span><span class="ident" id="2647325">oldnew</span><span class="op" id="2647331">)</span><span class="op" id="2647332">;</span>&nbsp;<span class="ident" id="2647334">i</span>&nbsp;<span class="op" id="2647336">+=</span>&nbsp;<span class="num" id="2647339">2</span>&nbsp;<span class="op" id="2647341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647345">key</span>&nbsp;<span class="op" id="2647349">:=</span>&nbsp;<span class="ident" id="2647352">oldnew</span><span class="op" id="2647358">[</span><span class="ident" id="2647359">i</span><span class="op" id="2647360">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647364">for</span>&nbsp;<span class="ident" id="2647368">j</span>&nbsp;<span class="op" id="2647370">:=</span>&nbsp;<span class="num" id="2647373">0</span><span class="op" id="2647374">;</span>&nbsp;<span class="ident" id="2647376">j</span>&nbsp;<span class="op" id="2647378">&lt;</span>&nbsp;<span class="builtinfunc" id="2647380">len</span><span class="op" id="2647383">(</span><span class="ident" id="2647384">key</span><span class="op" id="2647387">)</span><span class="op" id="2647388">;</span>&nbsp;<span class="ident" id="2647390">j</span><span class="op" id="2647391">++</span>&nbsp;<span class="op" id="2647394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647399">r</span><span class="op" id="2647400">.</span><span class="ident" id="2647401">mapping</span><span class="op" id="2647408">[</span><span class="ident" id="2647409">key</span><span class="op" id="2647412">[</span><span class="ident" id="2647413">j</span><span class="op" id="2647414">]</span><span class="op" id="2647415">]</span>&nbsp;<span class="op" id="2647417">=</span>&nbsp;<span class="num" id="2647419">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647430">for</span>&nbsp;<span class="ident" id="2647434">_</span><span class="op" id="2647435">,</span>&nbsp;<span class="ident" id="2647437">b</span>&nbsp;<span class="op" id="2647439">:=</span>&nbsp;<span class="keyword" id="2647442">range</span>&nbsp;<span class="ident" id="2647448">r</span><span class="op" id="2647449">.</span><span class="ident" id="2647450">mapping</span>&nbsp;<span class="op" id="2647458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647462">r</span><span class="op" id="2647463">.</span><span class="ident" id="2647464">tableSize</span>&nbsp;<span class="op" id="2647474">+=</span>&nbsp;<span class="builtintype" id="2647477">int</span><span class="op" id="2647480">(</span><span class="ident" id="2647481">b</span><span class="op" id="2647482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647489">var</span>&nbsp;<span class="ident" id="2647493">index</span>&nbsp;<span class="builtintype" id="2647499">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647505">for</span>&nbsp;<span class="ident" id="2647509">i</span><span class="op" id="2647510">,</span>&nbsp;<span class="ident" id="2647512">b</span>&nbsp;<span class="op" id="2647514">:=</span>&nbsp;<span class="keyword" id="2647517">range</span>&nbsp;<span class="ident" id="2647523">r</span><span class="op" id="2647524">.</span><span class="ident" id="2647525">mapping</span>&nbsp;<span class="op" id="2647533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647537">if</span>&nbsp;<span class="ident" id="2647540">b</span>&nbsp;<span class="op" id="2647542">==</span>&nbsp;<span class="num" id="2647545">0</span>&nbsp;<span class="op" id="2647547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647552">r</span><span class="op" id="2647553">.</span><span class="ident" id="2647554">mapping</span><span class="op" id="2647561">[</span><span class="ident" id="2647562">i</span><span class="op" id="2647563">]</span>&nbsp;<span class="op" id="2647565">=</span>&nbsp;<span class="builtintype" id="2647567">byte</span><span class="op" id="2647571">(</span><span class="ident" id="2647572">r</span><span class="op" id="2647573">.</span><span class="ident" id="2647574">tableSize</span><span class="op" id="2647583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647587">}</span>&nbsp;<span class="keyword" id="2647589">else</span>&nbsp;<span class="op" id="2647594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647599">r</span><span class="op" id="2647600">.</span><span class="ident" id="2647601">mapping</span><span class="op" id="2647608">[</span><span class="ident" id="2647609">i</span><span class="op" id="2647610">]</span>&nbsp;<span class="op" id="2647612">=</span>&nbsp;<span class="ident" id="2647614">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647623">index</span><span class="op" id="2647628">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2647639">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647699">r</span><span class="op" id="2647700">.</span><span class="ident" id="2647701">root</span><span class="op" id="2647705">.</span><span class="ident" id="2647706">table</span>&nbsp;<span class="op" id="2647712">=</span>&nbsp;<span class="builtinfunc" id="2647714">make</span><span class="op" id="2647718">(</span><span class="op" id="2647719">[</span><span class="op" id="2647720">]</span><span class="op" id="2647721">*</span><span class="ident" id="2647722">trieNode</span><span class="op" id="2647730">,</span>&nbsp;<span class="ident" id="2647732">r</span><span class="op" id="2647733">.</span><span class="ident" id="2647734">tableSize</span><span class="op" id="2647743">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647747">for</span>&nbsp;<span class="ident" id="2647751">i</span>&nbsp;<span class="op" id="2647753">:=</span>&nbsp;<span class="num" id="2647756">0</span><span class="op" id="2647757">;</span>&nbsp;<span class="ident" id="2647759">i</span>&nbsp;<span class="op" id="2647761">&lt;</span>&nbsp;<span class="builtinfunc" id="2647763">len</span><span class="op" id="2647766">(</span><span class="ident" id="2647767">oldnew</span><span class="op" id="2647773">)</span><span class="op" id="2647774">;</span>&nbsp;<span class="ident" id="2647776">i</span>&nbsp;<span class="op" id="2647778">+=</span>&nbsp;<span class="num" id="2647781">2</span>&nbsp;<span class="op" id="2647783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2647787">r</span><span class="op" id="2647788">.</span><span class="ident" id="2647789">root</span><span class="op" id="2647793">.</span><span class="ident" id="2647794">add</span><span class="op" id="2647797">(</span><span class="ident" id="2647798">oldnew</span><span class="op" id="2647804">[</span><span class="ident" id="2647805">i</span><span class="op" id="2647806">]</span><span class="op" id="2647807">,</span>&nbsp;<span class="ident" id="2647809">oldnew</span><span class="op" id="2647815">[</span><span class="ident" id="2647816">i</span><span class="op" id="2647817">+</span><span class="num" id="2647818">1</span><span class="op" id="2647819">]</span><span class="op" id="2647820">,</span>&nbsp;<span class="builtinfunc" id="2647822">len</span><span class="op" id="2647825">(</span><span class="ident" id="2647826">oldnew</span><span class="op" id="2647832">)</span><span class="op" id="2647833">-</span><span class="ident" id="2647834">i</span><span class="op" id="2647835">,</span>&nbsp;<span class="ident" id="2647837">r</span><span class="op" id="2647838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2647844">return</span>&nbsp;<span class="ident" id="2647851">r</span><br>
<span class="lineno">270</span><span class="op" id="2647853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2647856">type</span>&nbsp;<span class="ident" id="2647861">appendSliceWriter</span>&nbsp;<span class="op" id="2647879">[</span><span class="op" id="2647880">]</span><span class="builtintype" id="2647881">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2647887">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2647939">func</span>&nbsp;<span class="op" id="2647944">(</span><span class="ident" id="2647945">w</span>&nbsp;<span class="op" id="2647947">*</span><span class="ident" id="2647948">appendSliceWriter</span><span class="op" id="2647965">)</span>&nbsp;<span class="ident" id="2647967">Write</span><span class="op" id="2647972">(</span><span class="ident" id="2647973">p</span>&nbsp;<span class="op" id="2647975">[</span><span class="op" id="2647976">]</span><span class="builtintype" id="2647977">byte</span><span class="op" id="2647981">)</span>&nbsp;<span class="op" id="2647983">(</span><span class="builtintype" id="2647984">int</span><span class="op" id="2647987">,</span>&nbsp;<span class="builtintype" id="2647989">error</span><span class="op" id="2647994">)</span>&nbsp;<span class="op" id="2647996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2647999">*</span><span class="ident" id="2648000">w</span>&nbsp;<span class="op" id="2648002">=</span>&nbsp;<span class="builtinfunc" id="2648004">append</span><span class="op" id="2648010">(</span><span class="op" id="2648011">*</span><span class="ident" id="2648012">w</span><span class="op" id="2648013">,</span>&nbsp;<span class="ident" id="2648015">p</span><span class="op" id="2648016">...</span><span class="op" id="2648019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648022">return</span>&nbsp;<span class="builtinfunc" id="2648029">len</span><span class="op" id="2648032">(</span><span class="ident" id="2648033">p</span><span class="op" id="2648034">)</span><span class="op" id="2648035">,</span>&nbsp;<span class="ident" id="2648037">nil</span><br>
<span class="lineno"></span><span class="op" id="2648041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2648044">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2648124">func</span>&nbsp;<span class="op" id="2648129">(</span><span class="ident" id="2648130">w</span>&nbsp;<span class="op" id="2648132">*</span><span class="ident" id="2648133">appendSliceWriter</span><span class="op" id="2648150">)</span>&nbsp;<span class="ident" id="2648152">WriteString</span><span class="op" id="2648163">(</span><span class="ident" id="2648164">s</span>&nbsp;<span class="builtintype" id="2648166">string</span><span class="op" id="2648172">)</span>&nbsp;<span class="op" id="2648174">(</span><span class="builtintype" id="2648175">int</span><span class="op" id="2648178">,</span>&nbsp;<span class="builtintype" id="2648180">error</span><span class="op" id="2648185">)</span>&nbsp;<span class="op" id="2648187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2648190">*</span><span class="ident" id="2648191">w</span>&nbsp;<span class="op" id="2648193">=</span>&nbsp;<span class="builtinfunc" id="2648195">append</span><span class="op" id="2648201">(</span><span class="op" id="2648202">*</span><span class="ident" id="2648203">w</span><span class="op" id="2648204">,</span>&nbsp;<span class="ident" id="2648206">s</span><span class="op" id="2648207">...</span><span class="op" id="2648210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648213">return</span>&nbsp;<span class="builtinfunc" id="2648220">len</span><span class="op" id="2648223">(</span><span class="ident" id="2648224">s</span><span class="op" id="2648225">)</span><span class="op" id="2648226">,</span>&nbsp;<span class="ident" id="2648228">nil</span><br>
<span class="lineno"></span><span class="op" id="2648232">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2648235">type</span>&nbsp;<span class="ident" id="2648240">stringWriterIface</span>&nbsp;<span class="keyword" id="2648258">interface</span>&nbsp;<span class="op" id="2648268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648271">WriteString</span><span class="op" id="2648282">(</span><span class="builtintype" id="2648283">string</span><span class="op" id="2648289">)</span>&nbsp;<span class="op" id="2648291">(</span><span class="builtintype" id="2648292">int</span><span class="op" id="2648295">,</span>&nbsp;<span class="builtintype" id="2648297">error</span><span class="op" id="2648302">)</span><br>
<span class="lineno"></span><span class="op" id="2648304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2648307">type</span>&nbsp;<span class="ident" id="2648312">stringWriter</span>&nbsp;<span class="keyword" id="2648325">struct</span>&nbsp;<span class="op" id="2648332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648335">w</span>&nbsp;<span class="ident" id="2648337">io</span><span class="op" id="2648339">.</span><span class="ident" id="2648340">Writer</span><br>
<span class="lineno"></span><span class="op" id="2648347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2648350">func</span>&nbsp;<span class="op" id="2648355">(</span><span class="ident" id="2648356">w</span>&nbsp;<span class="ident" id="2648358">stringWriter</span><span class="op" id="2648370">)</span>&nbsp;<span class="ident" id="2648372">WriteString</span><span class="op" id="2648383">(</span><span class="ident" id="2648384">s</span>&nbsp;<span class="builtintype" id="2648386">string</span><span class="op" id="2648392">)</span>&nbsp;<span class="op" id="2648394">(</span><span class="builtintype" id="2648395">int</span><span class="op" id="2648398">,</span>&nbsp;<span class="builtintype" id="2648400">error</span><span class="op" id="2648405">)</span>&nbsp;<span class="op" id="2648407">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648410">return</span>&nbsp;<span class="ident" id="2648417">w</span><span class="op" id="2648418">.</span><span class="ident" id="2648419">w</span><span class="op" id="2648420">.</span><span class="ident" id="2648421">Write</span><span class="op" id="2648426">(</span><span class="op" id="2648427">[</span><span class="op" id="2648428">]</span><span class="builtintype" id="2648429">byte</span><span class="op" id="2648433">(</span><span class="ident" id="2648434">s</span><span class="op" id="2648435">)</span><span class="op" id="2648436">)</span><br>
<span class="lineno"></span><span class="op" id="2648438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2648441">func</span>&nbsp;<span class="ident" id="2648446">getStringWriter</span><span class="op" id="2648461">(</span><span class="ident" id="2648462">w</span>&nbsp;<span class="ident" id="2648464">io</span><span class="op" id="2648466">.</span><span class="ident" id="2648467">Writer</span><span class="op" id="2648473">)</span>&nbsp;<span class="ident" id="2648475">stringWriterIface</span>&nbsp;<span class="op" id="2648493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648496">sw</span><span class="op" id="2648498">,</span>&nbsp;<span class="ident" id="2648500">ok</span>&nbsp;<span class="op" id="2648503">:=</span>&nbsp;<span class="ident" id="2648506">w</span><span class="op" id="2648507">.</span><span class="op" id="2648508">(</span><span class="ident" id="2648509">stringWriterIface</span><span class="op" id="2648526">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648529">if</span>&nbsp;<span class="op" id="2648532">!</span><span class="ident" id="2648533">ok</span>&nbsp;<span class="op" id="2648536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648540">sw</span>&nbsp;<span class="op" id="2648543">=</span>&nbsp;<span class="ident" id="2648545">stringWriter</span><span class="op" id="2648557">{</span><span class="ident" id="2648558">w</span><span class="op" id="2648559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2648562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648565">return</span>&nbsp;<span class="ident" id="2648572">sw</span><br>
<span class="lineno"></span><span class="op" id="2648575">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2648578">func</span>&nbsp;<span class="op" id="2648583">(</span><span class="ident" id="2648584">r</span>&nbsp;<span class="op" id="2648586">*</span><span class="ident" id="2648587">genericReplacer</span><span class="op" id="2648602">)</span>&nbsp;<span class="ident" id="2648604">Replace</span><span class="op" id="2648611">(</span><span class="ident" id="2648612">s</span>&nbsp;<span class="builtintype" id="2648614">string</span><span class="op" id="2648620">)</span>&nbsp;<span class="builtintype" id="2648622">string</span>&nbsp;<span class="op" id="2648629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648632">buf</span>&nbsp;<span class="op" id="2648636">:=</span>&nbsp;<span class="builtinfunc" id="2648639">make</span><span class="op" id="2648643">(</span><span class="ident" id="2648644">appendSliceWriter</span><span class="op" id="2648661">,</span>&nbsp;<span class="num" id="2648663">0</span><span class="op" id="2648664">,</span>&nbsp;<span class="builtinfunc" id="2648666">len</span><span class="op" id="2648669">(</span><span class="ident" id="2648670">s</span><span class="op" id="2648671">)</span><span class="op" id="2648672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648675">r</span><span class="op" id="2648676">.</span><span class="ident" id="2648677">WriteString</span><span class="op" id="2648688">(</span><span class="op" id="2648689">&amp;</span><span class="ident" id="2648690">buf</span><span class="op" id="2648693">,</span>&nbsp;<span class="ident" id="2648695">s</span><span class="op" id="2648696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648699">return</span>&nbsp;<span class="builtintype" id="2648706">string</span><span class="op" id="2648712">(</span><span class="ident" id="2648713">buf</span><span class="op" id="2648716">)</span><br>
<span class="lineno">310</span><span class="op" id="2648718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2648721">func</span>&nbsp;<span class="op" id="2648726">(</span><span class="ident" id="2648727">r</span>&nbsp;<span class="op" id="2648729">*</span><span class="ident" id="2648730">genericReplacer</span><span class="op" id="2648745">)</span>&nbsp;<span class="ident" id="2648747">WriteString</span><span class="op" id="2648758">(</span><span class="ident" id="2648759">w</span>&nbsp;<span class="ident" id="2648761">io</span><span class="op" id="2648763">.</span><span class="ident" id="2648764">Writer</span><span class="op" id="2648770">,</span>&nbsp;<span class="ident" id="2648772">s</span>&nbsp;<span class="builtintype" id="2648774">string</span><span class="op" id="2648780">)</span>&nbsp;<span class="op" id="2648782">(</span><span class="ident" id="2648783">n</span>&nbsp;<span class="builtintype" id="2648785">int</span><span class="op" id="2648788">,</span>&nbsp;<span class="ident" id="2648790">err</span>&nbsp;<span class="builtintype" id="2648794">error</span><span class="op" id="2648799">)</span>&nbsp;<span class="op" id="2648801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648804">sw</span>&nbsp;<span class="op" id="2648807">:=</span>&nbsp;<span class="ident" id="2648810">getStringWriter</span><span class="op" id="2648825">(</span><span class="ident" id="2648826">w</span><span class="op" id="2648827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648830">var</span>&nbsp;<span class="ident" id="2648834">last</span><span class="op" id="2648838">,</span>&nbsp;<span class="ident" id="2648840">wn</span>&nbsp;<span class="builtintype" id="2648843">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648848">var</span>&nbsp;<span class="ident" id="2648852">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2648867">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648873">for</span>&nbsp;<span class="ident" id="2648877">i</span>&nbsp;<span class="op" id="2648879">:=</span>&nbsp;<span class="num" id="2648882">0</span><span class="op" id="2648883">;</span>&nbsp;<span class="ident" id="2648885">i</span>&nbsp;<span class="op" id="2648887">&lt;=</span>&nbsp;<span class="builtinfunc" id="2648890">len</span><span class="op" id="2648893">(</span><span class="ident" id="2648894">s</span><span class="op" id="2648895">)</span><span class="op" id="2648896">;</span>&nbsp;<span class="op" id="2648898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2648902">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2648955">if</span>&nbsp;<span class="ident" id="2648958">i</span>&nbsp;<span class="op" id="2648960">!=</span>&nbsp;<span class="builtinfunc" id="2648963">len</span><span class="op" id="2648966">(</span><span class="ident" id="2648967">s</span><span class="op" id="2648968">)</span>&nbsp;<span class="op" id="2648970">&amp;&amp;</span>&nbsp;<span class="ident" id="2648973">r</span><span class="op" id="2648974">.</span><span class="ident" id="2648975">root</span><span class="op" id="2648979">.</span><span class="ident" id="2648980">priority</span>&nbsp;<span class="op" id="2648989">==</span>&nbsp;<span class="num" id="2648992">0</span>&nbsp;<span class="op" id="2648994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2648999">index</span>&nbsp;<span class="op" id="2649005">:=</span>&nbsp;<span class="builtintype" id="2649008">int</span><span class="op" id="2649011">(</span><span class="ident" id="2649012">r</span><span class="op" id="2649013">.</span><span class="ident" id="2649014">mapping</span><span class="op" id="2649021">[</span><span class="ident" id="2649022">s</span><span class="op" id="2649023">[</span><span class="ident" id="2649024">i</span><span class="op" id="2649025">]</span><span class="op" id="2649026">]</span><span class="op" id="2649027">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649032">if</span>&nbsp;<span class="ident" id="2649035">index</span>&nbsp;<span class="op" id="2649041">==</span>&nbsp;<span class="ident" id="2649044">r</span><span class="op" id="2649045">.</span><span class="ident" id="2649046">tableSize</span>&nbsp;<span class="op" id="2649056">||</span>&nbsp;<span class="ident" id="2649059">r</span><span class="op" id="2649060">.</span><span class="ident" id="2649061">root</span><span class="op" id="2649065">.</span><span class="ident" id="2649066">table</span><span class="op" id="2649071">[</span><span class="ident" id="2649072">index</span><span class="op" id="2649077">]</span>&nbsp;<span class="op" id="2649079">==</span>&nbsp;<span class="ident" id="2649082">nil</span>&nbsp;<span class="op" id="2649086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649092">i</span><span class="op" id="2649093">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649100">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649116">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2649121">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649194">val</span><span class="op" id="2649197">,</span>&nbsp;<span class="ident" id="2649199">keylen</span><span class="op" id="2649205">,</span>&nbsp;<span class="ident" id="2649207">match</span>&nbsp;<span class="op" id="2649213">:=</span>&nbsp;<span class="ident" id="2649216">r</span><span class="op" id="2649217">.</span><span class="ident" id="2649218">lookup</span><span class="op" id="2649224">(</span><span class="ident" id="2649225">s</span><span class="op" id="2649226">[</span><span class="ident" id="2649227">i</span><span class="op" id="2649228">:</span><span class="op" id="2649229">]</span><span class="op" id="2649230">,</span>&nbsp;<span class="ident" id="2649232">prevMatchEmpty</span><span class="op" id="2649246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649250">prevMatchEmpty</span>&nbsp;<span class="op" id="2649265">=</span>&nbsp;<span class="ident" id="2649267">match</span>&nbsp;<span class="op" id="2649273">&amp;&amp;</span>&nbsp;<span class="ident" id="2649276">keylen</span>&nbsp;<span class="op" id="2649283">==</span>&nbsp;<span class="num" id="2649286">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649290">if</span>&nbsp;<span class="ident" id="2649293">match</span>&nbsp;<span class="op" id="2649299">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649304">wn</span><span class="op" id="2649306">,</span>&nbsp;<span class="ident" id="2649308">err</span>&nbsp;<span class="op" id="2649312">=</span>&nbsp;<span class="ident" id="2649314">sw</span><span class="op" id="2649316">.</span><span class="ident" id="2649317">WriteString</span><span class="op" id="2649328">(</span><span class="ident" id="2649329">s</span><span class="op" id="2649330">[</span><span class="ident" id="2649331">last</span><span class="op" id="2649335">:</span><span class="ident" id="2649336">i</span><span class="op" id="2649337">]</span><span class="op" id="2649338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649343">n</span>&nbsp;<span class="op" id="2649345">+=</span>&nbsp;<span class="ident" id="2649348">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649354">if</span>&nbsp;<span class="ident" id="2649357">err</span>&nbsp;<span class="op" id="2649361">!=</span>&nbsp;<span class="ident" id="2649364">nil</span>&nbsp;<span class="op" id="2649368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649374">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649384">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649389">wn</span><span class="op" id="2649391">,</span>&nbsp;<span class="ident" id="2649393">err</span>&nbsp;<span class="op" id="2649397">=</span>&nbsp;<span class="ident" id="2649399">sw</span><span class="op" id="2649401">.</span><span class="ident" id="2649402">WriteString</span><span class="op" id="2649413">(</span><span class="ident" id="2649414">val</span><span class="op" id="2649417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649422">n</span>&nbsp;<span class="op" id="2649424">+=</span>&nbsp;<span class="ident" id="2649427">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649433">if</span>&nbsp;<span class="ident" id="2649436">err</span>&nbsp;<span class="op" id="2649440">!=</span>&nbsp;<span class="ident" id="2649443">nil</span>&nbsp;<span class="op" id="2649447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649453">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649463">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649468">i</span>&nbsp;<span class="op" id="2649470">+=</span>&nbsp;<span class="ident" id="2649473">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649483">last</span>&nbsp;<span class="op" id="2649488">=</span>&nbsp;<span class="ident" id="2649490">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649495">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649510">i</span><span class="op" id="2649511">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649518">if</span>&nbsp;<span class="ident" id="2649521">last</span>&nbsp;<span class="op" id="2649526">!=</span>&nbsp;<span class="builtinfunc" id="2649529">len</span><span class="op" id="2649532">(</span><span class="ident" id="2649533">s</span><span class="op" id="2649534">)</span>&nbsp;<span class="op" id="2649536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649540">wn</span><span class="op" id="2649542">,</span>&nbsp;<span class="ident" id="2649544">err</span>&nbsp;<span class="op" id="2649548">=</span>&nbsp;<span class="ident" id="2649550">sw</span><span class="op" id="2649552">.</span><span class="ident" id="2649553">WriteString</span><span class="op" id="2649564">(</span><span class="ident" id="2649565">s</span><span class="op" id="2649566">[</span><span class="ident" id="2649567">last</span><span class="op" id="2649571">:</span><span class="op" id="2649572">]</span><span class="op" id="2649573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649577">n</span>&nbsp;<span class="op" id="2649579">+=</span>&nbsp;<span class="ident" id="2649582">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2649586">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649589">return</span><br>
<span class="lineno"></span><span class="op" id="2649596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2649599">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2649676">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2649743">type</span>&nbsp;<span class="ident" id="2649748">singleStringReplacer</span>&nbsp;<span class="keyword" id="2649769">struct</span>&nbsp;<span class="op" id="2649776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649779">finder</span>&nbsp;<span class="op" id="2649786">*</span><span class="ident" id="2649787">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2649801">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2649873">value</span>&nbsp;<span class="builtintype" id="2649879">string</span><br>
<span class="lineno"></span><span class="op" id="2649886">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2649889">func</span>&nbsp;<span class="ident" id="2649894">makeSingleStringReplacer</span><span class="op" id="2649918">(</span><span class="ident" id="2649919">pattern</span>&nbsp;<span class="builtintype" id="2649927">string</span><span class="op" id="2649933">,</span>&nbsp;<span class="ident" id="2649935">value</span>&nbsp;<span class="builtintype" id="2649941">string</span><span class="op" id="2649947">)</span>&nbsp;<span class="op" id="2649949">*</span><span class="ident" id="2649950">singleStringReplacer</span>&nbsp;<span class="op" id="2649971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2649974">return</span>&nbsp;<span class="op" id="2649981">&amp;</span><span class="ident" id="2649982">singleStringReplacer</span><span class="op" id="2650002">{</span><span class="ident" id="2650003">finder</span><span class="op" id="2650009">:</span>&nbsp;<span class="ident" id="2650011">makeStringFinder</span><span class="op" id="2650027">(</span><span class="ident" id="2650028">pattern</span><span class="op" id="2650035">)</span><span class="op" id="2650036">,</span>&nbsp;<span class="ident" id="2650038">value</span><span class="op" id="2650043">:</span>&nbsp;<span class="ident" id="2650045">value</span><span class="op" id="2650050">}</span><br>
<span class="lineno"></span><span class="op" id="2650052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2650055">func</span>&nbsp;<span class="op" id="2650060">(</span><span class="ident" id="2650061">r</span>&nbsp;<span class="op" id="2650063">*</span><span class="ident" id="2650064">singleStringReplacer</span><span class="op" id="2650084">)</span>&nbsp;<span class="ident" id="2650086">Replace</span><span class="op" id="2650093">(</span><span class="ident" id="2650094">s</span>&nbsp;<span class="builtintype" id="2650096">string</span><span class="op" id="2650102">)</span>&nbsp;<span class="builtintype" id="2650104">string</span>&nbsp;<span class="op" id="2650111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650114">var</span>&nbsp;<span class="ident" id="2650118">buf</span>&nbsp;<span class="op" id="2650122">[</span><span class="op" id="2650123">]</span><span class="builtintype" id="2650124">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650130">i</span><span class="op" id="2650131">,</span>&nbsp;<span class="ident" id="2650133">matched</span>&nbsp;<span class="op" id="2650141">:=</span>&nbsp;<span class="num" id="2650144">0</span><span class="op" id="2650145">,</span>&nbsp;<span class="builtintype" id="2650147">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650154">for</span>&nbsp;<span class="op" id="2650158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650162">match</span>&nbsp;<span class="op" id="2650168">:=</span>&nbsp;<span class="ident" id="2650171">r</span><span class="op" id="2650172">.</span><span class="ident" id="2650173">finder</span><span class="op" id="2650179">.</span><span class="ident" id="2650180">next</span><span class="op" id="2650184">(</span><span class="ident" id="2650185">s</span><span class="op" id="2650186">[</span><span class="ident" id="2650187">i</span><span class="op" id="2650188">:</span><span class="op" id="2650189">]</span><span class="op" id="2650190">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650194">if</span>&nbsp;<span class="ident" id="2650197">match</span>&nbsp;<span class="op" id="2650203">==</span>&nbsp;<span class="op" id="2650206">-</span><span class="num" id="2650207">1</span>&nbsp;<span class="op" id="2650209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650214">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650226">matched</span>&nbsp;<span class="op" id="2650234">=</span>&nbsp;<span class="builtintype" id="2650236">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650243">buf</span>&nbsp;<span class="op" id="2650247">=</span>&nbsp;<span class="builtinfunc" id="2650249">append</span><span class="op" id="2650255">(</span><span class="ident" id="2650256">buf</span><span class="op" id="2650259">,</span>&nbsp;<span class="ident" id="2650261">s</span><span class="op" id="2650262">[</span><span class="ident" id="2650263">i</span><span class="op" id="2650264">:</span><span class="ident" id="2650265">i</span><span class="op" id="2650266">+</span><span class="ident" id="2650267">match</span><span class="op" id="2650272">]</span><span class="op" id="2650273">...</span><span class="op" id="2650276">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650280">buf</span>&nbsp;<span class="op" id="2650284">=</span>&nbsp;<span class="builtinfunc" id="2650286">append</span><span class="op" id="2650292">(</span><span class="ident" id="2650293">buf</span><span class="op" id="2650296">,</span>&nbsp;<span class="ident" id="2650298">r</span><span class="op" id="2650299">.</span><span class="ident" id="2650300">value</span><span class="op" id="2650305">...</span><span class="op" id="2650308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650312">i</span>&nbsp;<span class="op" id="2650314">+=</span>&nbsp;<span class="ident" id="2650317">match</span>&nbsp;<span class="op" id="2650323">+</span>&nbsp;<span class="builtinfunc" id="2650325">len</span><span class="op" id="2650328">(</span><span class="ident" id="2650329">r</span><span class="op" id="2650330">.</span><span class="ident" id="2650331">finder</span><span class="op" id="2650337">.</span><span class="ident" id="2650338">pattern</span><span class="op" id="2650345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650351">if</span>&nbsp;<span class="op" id="2650354">!</span><span class="ident" id="2650355">matched</span>&nbsp;<span class="op" id="2650363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650367">return</span>&nbsp;<span class="ident" id="2650374">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650380">buf</span>&nbsp;<span class="op" id="2650384">=</span>&nbsp;<span class="builtinfunc" id="2650386">append</span><span class="op" id="2650392">(</span><span class="ident" id="2650393">buf</span><span class="op" id="2650396">,</span>&nbsp;<span class="ident" id="2650398">s</span><span class="op" id="2650399">[</span><span class="ident" id="2650400">i</span><span class="op" id="2650401">:</span><span class="op" id="2650402">]</span><span class="op" id="2650403">...</span><span class="op" id="2650406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650409">return</span>&nbsp;<span class="builtintype" id="2650416">string</span><span class="op" id="2650422">(</span><span class="ident" id="2650423">buf</span><span class="op" id="2650426">)</span><br>
<span class="lineno"></span><span class="op" id="2650428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2650431">func</span>&nbsp;<span class="op" id="2650436">(</span><span class="ident" id="2650437">r</span>&nbsp;<span class="op" id="2650439">*</span><span class="ident" id="2650440">singleStringReplacer</span><span class="op" id="2650460">)</span>&nbsp;<span class="ident" id="2650462">WriteString</span><span class="op" id="2650473">(</span><span class="ident" id="2650474">w</span>&nbsp;<span class="ident" id="2650476">io</span><span class="op" id="2650478">.</span><span class="ident" id="2650479">Writer</span><span class="op" id="2650485">,</span>&nbsp;<span class="ident" id="2650487">s</span>&nbsp;<span class="builtintype" id="2650489">string</span><span class="op" id="2650495">)</span>&nbsp;<span class="op" id="2650497">(</span><span class="ident" id="2650498">n</span>&nbsp;<span class="builtintype" id="2650500">int</span><span class="op" id="2650503">,</span>&nbsp;<span class="ident" id="2650505">err</span>&nbsp;<span class="builtintype" id="2650509">error</span><span class="op" id="2650514">)</span>&nbsp;<span class="op" id="2650516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650519">sw</span>&nbsp;<span class="op" id="2650522">:=</span>&nbsp;<span class="ident" id="2650525">getStringWriter</span><span class="op" id="2650540">(</span><span class="ident" id="2650541">w</span><span class="op" id="2650542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650545">var</span>&nbsp;<span class="ident" id="2650549">i</span><span class="op" id="2650550">,</span>&nbsp;<span class="ident" id="2650552">wn</span>&nbsp;<span class="builtintype" id="2650555">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650560">for</span>&nbsp;<span class="op" id="2650564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650568">match</span>&nbsp;<span class="op" id="2650574">:=</span>&nbsp;<span class="ident" id="2650577">r</span><span class="op" id="2650578">.</span><span class="ident" id="2650579">finder</span><span class="op" id="2650585">.</span><span class="ident" id="2650586">next</span><span class="op" id="2650590">(</span><span class="ident" id="2650591">s</span><span class="op" id="2650592">[</span><span class="ident" id="2650593">i</span><span class="op" id="2650594">:</span><span class="op" id="2650595">]</span><span class="op" id="2650596">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650600">if</span>&nbsp;<span class="ident" id="2650603">match</span>&nbsp;<span class="op" id="2650609">==</span>&nbsp;<span class="op" id="2650612">-</span><span class="num" id="2650613">1</span>&nbsp;<span class="op" id="2650615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650620">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650632">wn</span><span class="op" id="2650634">,</span>&nbsp;<span class="ident" id="2650636">err</span>&nbsp;<span class="op" id="2650640">=</span>&nbsp;<span class="ident" id="2650642">sw</span><span class="op" id="2650644">.</span><span class="ident" id="2650645">WriteString</span><span class="op" id="2650656">(</span><span class="ident" id="2650657">s</span><span class="op" id="2650658">[</span><span class="ident" id="2650659">i</span>&nbsp;<span class="op" id="2650661">:</span>&nbsp;<span class="ident" id="2650663">i</span><span class="op" id="2650664">+</span><span class="ident" id="2650665">match</span><span class="op" id="2650670">]</span><span class="op" id="2650671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650675">n</span>&nbsp;<span class="op" id="2650677">+=</span>&nbsp;<span class="ident" id="2650680">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650685">if</span>&nbsp;<span class="ident" id="2650688">err</span>&nbsp;<span class="op" id="2650692">!=</span>&nbsp;<span class="ident" id="2650695">nil</span>&nbsp;<span class="op" id="2650699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650704">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650717">wn</span><span class="op" id="2650719">,</span>&nbsp;<span class="ident" id="2650721">err</span>&nbsp;<span class="op" id="2650725">=</span>&nbsp;<span class="ident" id="2650727">sw</span><span class="op" id="2650729">.</span><span class="ident" id="2650730">WriteString</span><span class="op" id="2650741">(</span><span class="ident" id="2650742">r</span><span class="op" id="2650743">.</span><span class="ident" id="2650744">value</span><span class="op" id="2650749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650753">n</span>&nbsp;<span class="op" id="2650755">+=</span>&nbsp;<span class="ident" id="2650758">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650763">if</span>&nbsp;<span class="ident" id="2650766">err</span>&nbsp;<span class="op" id="2650770">!=</span>&nbsp;<span class="ident" id="2650773">nil</span>&nbsp;<span class="op" id="2650777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650782">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650795">i</span>&nbsp;<span class="op" id="2650797">+=</span>&nbsp;<span class="ident" id="2650800">match</span>&nbsp;<span class="op" id="2650806">+</span>&nbsp;<span class="builtinfunc" id="2650808">len</span><span class="op" id="2650811">(</span><span class="ident" id="2650812">r</span><span class="op" id="2650813">.</span><span class="ident" id="2650814">finder</span><span class="op" id="2650820">.</span><span class="ident" id="2650821">pattern</span><span class="op" id="2650828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2650831">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650834">wn</span><span class="op" id="2650836">,</span>&nbsp;<span class="ident" id="2650838">err</span>&nbsp;<span class="op" id="2650842">=</span>&nbsp;<span class="ident" id="2650844">sw</span><span class="op" id="2650846">.</span><span class="ident" id="2650847">WriteString</span><span class="op" id="2650858">(</span><span class="ident" id="2650859">s</span><span class="op" id="2650860">[</span><span class="ident" id="2650861">i</span><span class="op" id="2650862">:</span><span class="op" id="2650863">]</span><span class="op" id="2650864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2650867">n</span>&nbsp;<span class="op" id="2650869">+=</span>&nbsp;<span class="ident" id="2650872">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2650876">return</span><br>
<span class="lineno"></span><span class="op" id="2650883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2650886">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2650955">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2650999">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2651060">type</span>&nbsp;<span class="ident" id="2651065">byteReplacer</span>&nbsp;<span class="op" id="2651078">[</span><span class="num" id="2651079">256</span><span class="op" id="2651082">]</span><span class="builtintype" id="2651083">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2651089">func</span>&nbsp;<span class="op" id="2651094">(</span><span class="ident" id="2651095">r</span>&nbsp;<span class="op" id="2651097">*</span><span class="ident" id="2651098">byteReplacer</span><span class="op" id="2651110">)</span>&nbsp;<span class="ident" id="2651112">Replace</span><span class="op" id="2651119">(</span><span class="ident" id="2651120">s</span>&nbsp;<span class="builtintype" id="2651122">string</span><span class="op" id="2651128">)</span>&nbsp;<span class="builtintype" id="2651130">string</span>&nbsp;<span class="op" id="2651137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651140">var</span>&nbsp;<span class="ident" id="2651144">buf</span>&nbsp;<span class="op" id="2651148">[</span><span class="op" id="2651149">]</span><span class="builtintype" id="2651150">byte</span>&nbsp;<span class="comment" id="2651155">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651176">for</span>&nbsp;<span class="ident" id="2651180">i</span>&nbsp;<span class="op" id="2651182">:=</span>&nbsp;<span class="num" id="2651185">0</span><span class="op" id="2651186">;</span>&nbsp;<span class="ident" id="2651188">i</span>&nbsp;<span class="op" id="2651190">&lt;</span>&nbsp;<span class="builtinfunc" id="2651192">len</span><span class="op" id="2651195">(</span><span class="ident" id="2651196">s</span><span class="op" id="2651197">)</span><span class="op" id="2651198">;</span>&nbsp;<span class="ident" id="2651200">i</span><span class="op" id="2651201">++</span>&nbsp;<span class="op" id="2651204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651208">b</span>&nbsp;<span class="op" id="2651210">:=</span>&nbsp;<span class="ident" id="2651213">s</span><span class="op" id="2651214">[</span><span class="ident" id="2651215">i</span><span class="op" id="2651216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651220">if</span>&nbsp;<span class="ident" id="2651223">r</span><span class="op" id="2651224">[</span><span class="ident" id="2651225">b</span><span class="op" id="2651226">]</span>&nbsp;<span class="op" id="2651228">!=</span>&nbsp;<span class="ident" id="2651231">b</span>&nbsp;<span class="op" id="2651233">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651238">if</span>&nbsp;<span class="ident" id="2651241">buf</span>&nbsp;<span class="op" id="2651245">==</span>&nbsp;<span class="ident" id="2651248">nil</span>&nbsp;<span class="op" id="2651252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651258">buf</span>&nbsp;<span class="op" id="2651262">=</span>&nbsp;<span class="op" id="2651264">[</span><span class="op" id="2651265">]</span><span class="builtintype" id="2651266">byte</span><span class="op" id="2651270">(</span><span class="ident" id="2651271">s</span><span class="op" id="2651272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651282">buf</span><span class="op" id="2651285">[</span><span class="ident" id="2651286">i</span><span class="op" id="2651287">]</span>&nbsp;<span class="op" id="2651289">=</span>&nbsp;<span class="ident" id="2651291">r</span><span class="op" id="2651292">[</span><span class="ident" id="2651293">b</span><span class="op" id="2651294">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651298">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651304">if</span>&nbsp;<span class="ident" id="2651307">buf</span>&nbsp;<span class="op" id="2651311">==</span>&nbsp;<span class="ident" id="2651314">nil</span>&nbsp;<span class="op" id="2651318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651322">return</span>&nbsp;<span class="ident" id="2651329">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651335">return</span>&nbsp;<span class="builtintype" id="2651342">string</span><span class="op" id="2651348">(</span><span class="ident" id="2651349">buf</span><span class="op" id="2651352">)</span><br>
<span class="lineno">430</span><span class="op" id="2651354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2651357">func</span>&nbsp;<span class="op" id="2651362">(</span><span class="ident" id="2651363">r</span>&nbsp;<span class="op" id="2651365">*</span><span class="ident" id="2651366">byteReplacer</span><span class="op" id="2651378">)</span>&nbsp;<span class="ident" id="2651380">WriteString</span><span class="op" id="2651391">(</span><span class="ident" id="2651392">w</span>&nbsp;<span class="ident" id="2651394">io</span><span class="op" id="2651396">.</span><span class="ident" id="2651397">Writer</span><span class="op" id="2651403">,</span>&nbsp;<span class="ident" id="2651405">s</span>&nbsp;<span class="builtintype" id="2651407">string</span><span class="op" id="2651413">)</span>&nbsp;<span class="op" id="2651415">(</span><span class="ident" id="2651416">n</span>&nbsp;<span class="builtintype" id="2651418">int</span><span class="op" id="2651421">,</span>&nbsp;<span class="ident" id="2651423">err</span>&nbsp;<span class="builtintype" id="2651427">error</span><span class="op" id="2651432">)</span>&nbsp;<span class="op" id="2651434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2651437">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651515">bufsize</span>&nbsp;<span class="op" id="2651523">:=</span>&nbsp;<span class="num" id="2651526">32</span>&nbsp;<span class="op" id="2651529">&lt;&lt;</span>&nbsp;<span class="num" id="2651532">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651536">if</span>&nbsp;<span class="builtinfunc" id="2651539">len</span><span class="op" id="2651542">(</span><span class="ident" id="2651543">s</span><span class="op" id="2651544">)</span>&nbsp;<span class="op" id="2651546">&lt;</span>&nbsp;<span class="ident" id="2651548">bufsize</span>&nbsp;<span class="op" id="2651556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651560">bufsize</span>&nbsp;<span class="op" id="2651568">=</span>&nbsp;<span class="builtinfunc" id="2651570">len</span><span class="op" id="2651573">(</span><span class="ident" id="2651574">s</span><span class="op" id="2651575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651581">buf</span>&nbsp;<span class="op" id="2651585">:=</span>&nbsp;<span class="builtinfunc" id="2651588">make</span><span class="op" id="2651592">(</span><span class="op" id="2651593">[</span><span class="op" id="2651594">]</span><span class="builtintype" id="2651595">byte</span><span class="op" id="2651599">,</span>&nbsp;<span class="ident" id="2651601">bufsize</span><span class="op" id="2651608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651612">for</span>&nbsp;<span class="builtinfunc" id="2651616">len</span><span class="op" id="2651619">(</span><span class="ident" id="2651620">s</span><span class="op" id="2651621">)</span>&nbsp;<span class="op" id="2651623">&gt;</span>&nbsp;<span class="num" id="2651625">0</span>&nbsp;<span class="op" id="2651627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651631">ncopy</span>&nbsp;<span class="op" id="2651637">:=</span>&nbsp;<span class="builtinfunc" id="2651640">copy</span><span class="op" id="2651644">(</span><span class="ident" id="2651645">buf</span><span class="op" id="2651648">,</span>&nbsp;<span class="ident" id="2651650">s</span><span class="op" id="2651651">[</span><span class="op" id="2651652">:</span><span class="op" id="2651653">]</span><span class="op" id="2651654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651658">s</span>&nbsp;<span class="op" id="2651660">=</span>&nbsp;<span class="ident" id="2651662">s</span><span class="op" id="2651663">[</span><span class="ident" id="2651664">ncopy</span><span class="op" id="2651669">:</span><span class="op" id="2651670">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651674">for</span>&nbsp;<span class="ident" id="2651678">i</span><span class="op" id="2651679">,</span>&nbsp;<span class="ident" id="2651681">b</span>&nbsp;<span class="op" id="2651683">:=</span>&nbsp;<span class="keyword" id="2651686">range</span>&nbsp;<span class="ident" id="2651692">buf</span><span class="op" id="2651695">[</span><span class="op" id="2651696">:</span><span class="ident" id="2651697">ncopy</span><span class="op" id="2651702">]</span>&nbsp;<span class="op" id="2651704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651709">buf</span><span class="op" id="2651712">[</span><span class="ident" id="2651713">i</span><span class="op" id="2651714">]</span>&nbsp;<span class="op" id="2651716">=</span>&nbsp;<span class="ident" id="2651718">r</span><span class="op" id="2651719">[</span><span class="ident" id="2651720">b</span><span class="op" id="2651721">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651729">wn</span><span class="op" id="2651731">,</span>&nbsp;<span class="ident" id="2651733">err</span>&nbsp;<span class="op" id="2651737">:=</span>&nbsp;<span class="ident" id="2651740">w</span><span class="op" id="2651741">.</span><span class="ident" id="2651742">Write</span><span class="op" id="2651747">(</span><span class="ident" id="2651748">buf</span><span class="op" id="2651751">[</span><span class="op" id="2651752">:</span><span class="ident" id="2651753">ncopy</span><span class="op" id="2651758">]</span><span class="op" id="2651759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2651763">n</span>&nbsp;<span class="op" id="2651765">+=</span>&nbsp;<span class="ident" id="2651768">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651773">if</span>&nbsp;<span class="ident" id="2651776">err</span>&nbsp;<span class="op" id="2651780">!=</span>&nbsp;<span class="ident" id="2651783">nil</span>&nbsp;<span class="op" id="2651787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651792">return</span>&nbsp;<span class="ident" id="2651799">n</span><span class="op" id="2651800">,</span>&nbsp;<span class="ident" id="2651802">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2651811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2651814">return</span>&nbsp;<span class="ident" id="2651821">n</span><span class="op" id="2651822">,</span>&nbsp;<span class="ident" id="2651824">nil</span><br>
<span class="lineno"></span><span class="op" id="2651828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2651831">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2651900">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2651974">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2652041">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2652105">type</span>&nbsp;<span class="ident" id="2652110">byteStringReplacer</span>&nbsp;<span class="op" id="2652129">[</span><span class="num" id="2652130">256</span><span class="op" id="2652133">]</span><span class="op" id="2652134">[</span><span class="op" id="2652135">]</span><span class="builtintype" id="2652136">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2652142">func</span>&nbsp;<span class="op" id="2652147">(</span><span class="ident" id="2652148">r</span>&nbsp;<span class="op" id="2652150">*</span><span class="ident" id="2652151">byteStringReplacer</span><span class="op" id="2652169">)</span>&nbsp;<span class="ident" id="2652171">Replace</span><span class="op" id="2652178">(</span><span class="ident" id="2652179">s</span>&nbsp;<span class="builtintype" id="2652181">string</span><span class="op" id="2652187">)</span>&nbsp;<span class="builtintype" id="2652189">string</span>&nbsp;<span class="op" id="2652196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652199">newSize</span>&nbsp;<span class="op" id="2652207">:=</span>&nbsp;<span class="builtinfunc" id="2652210">len</span><span class="op" id="2652213">(</span><span class="ident" id="2652214">s</span><span class="op" id="2652215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652218">anyChanges</span>&nbsp;<span class="op" id="2652229">:=</span>&nbsp;<span class="builtintype" id="2652232">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652239">for</span>&nbsp;<span class="ident" id="2652243">i</span>&nbsp;<span class="op" id="2652245">:=</span>&nbsp;<span class="num" id="2652248">0</span><span class="op" id="2652249">;</span>&nbsp;<span class="ident" id="2652251">i</span>&nbsp;<span class="op" id="2652253">&lt;</span>&nbsp;<span class="builtinfunc" id="2652255">len</span><span class="op" id="2652258">(</span><span class="ident" id="2652259">s</span><span class="op" id="2652260">)</span><span class="op" id="2652261">;</span>&nbsp;<span class="ident" id="2652263">i</span><span class="op" id="2652264">++</span>&nbsp;<span class="op" id="2652267">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652271">b</span>&nbsp;<span class="op" id="2652273">:=</span>&nbsp;<span class="ident" id="2652276">s</span><span class="op" id="2652277">[</span><span class="ident" id="2652278">i</span><span class="op" id="2652279">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652283">if</span>&nbsp;<span class="ident" id="2652286">r</span><span class="op" id="2652287">[</span><span class="ident" id="2652288">b</span><span class="op" id="2652289">]</span>&nbsp;<span class="op" id="2652291">!=</span>&nbsp;<span class="ident" id="2652294">nil</span>&nbsp;<span class="op" id="2652298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652303">anyChanges</span>&nbsp;<span class="op" id="2652314">=</span>&nbsp;<span class="builtintype" id="2652316">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2652324">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652394">newSize</span>&nbsp;<span class="op" id="2652402">+=</span>&nbsp;<span class="builtinfunc" id="2652405">len</span><span class="op" id="2652408">(</span><span class="ident" id="2652409">r</span><span class="op" id="2652410">[</span><span class="ident" id="2652411">b</span><span class="op" id="2652412">]</span><span class="op" id="2652413">)</span>&nbsp;<span class="op" id="2652415">-</span>&nbsp;<span class="num" id="2652417">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652427">if</span>&nbsp;<span class="op" id="2652430">!</span><span class="ident" id="2652431">anyChanges</span>&nbsp;<span class="op" id="2652442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652446">return</span>&nbsp;<span class="ident" id="2652453">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652456">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652459">buf</span>&nbsp;<span class="op" id="2652463">:=</span>&nbsp;<span class="builtinfunc" id="2652466">make</span><span class="op" id="2652470">(</span><span class="op" id="2652471">[</span><span class="op" id="2652472">]</span><span class="builtintype" id="2652473">byte</span><span class="op" id="2652477">,</span>&nbsp;<span class="ident" id="2652479">newSize</span><span class="op" id="2652486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652489">bi</span>&nbsp;<span class="op" id="2652492">:=</span>&nbsp;<span class="ident" id="2652495">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652500">for</span>&nbsp;<span class="ident" id="2652504">i</span>&nbsp;<span class="op" id="2652506">:=</span>&nbsp;<span class="num" id="2652509">0</span><span class="op" id="2652510">;</span>&nbsp;<span class="ident" id="2652512">i</span>&nbsp;<span class="op" id="2652514">&lt;</span>&nbsp;<span class="builtinfunc" id="2652516">len</span><span class="op" id="2652519">(</span><span class="ident" id="2652520">s</span><span class="op" id="2652521">)</span><span class="op" id="2652522">;</span>&nbsp;<span class="ident" id="2652524">i</span><span class="op" id="2652525">++</span>&nbsp;<span class="op" id="2652528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652532">b</span>&nbsp;<span class="op" id="2652534">:=</span>&nbsp;<span class="ident" id="2652537">s</span><span class="op" id="2652538">[</span><span class="ident" id="2652539">i</span><span class="op" id="2652540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652544">if</span>&nbsp;<span class="ident" id="2652547">r</span><span class="op" id="2652548">[</span><span class="ident" id="2652549">b</span><span class="op" id="2652550">]</span>&nbsp;<span class="op" id="2652552">!=</span>&nbsp;<span class="ident" id="2652555">nil</span>&nbsp;<span class="op" id="2652559">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652564">n</span>&nbsp;<span class="op" id="2652566">:=</span>&nbsp;<span class="builtinfunc" id="2652569">copy</span><span class="op" id="2652573">(</span><span class="ident" id="2652574">bi</span><span class="op" id="2652576">,</span>&nbsp;<span class="ident" id="2652578">r</span><span class="op" id="2652579">[</span><span class="ident" id="2652580">b</span><span class="op" id="2652581">]</span><span class="op" id="2652582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652587">bi</span>&nbsp;<span class="op" id="2652590">=</span>&nbsp;<span class="ident" id="2652592">bi</span><span class="op" id="2652594">[</span><span class="ident" id="2652595">n</span><span class="op" id="2652596">:</span><span class="op" id="2652597">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652601">}</span>&nbsp;<span class="keyword" id="2652603">else</span>&nbsp;<span class="op" id="2652608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652613">bi</span><span class="op" id="2652615">[</span><span class="num" id="2652616">0</span><span class="op" id="2652617">]</span>&nbsp;<span class="op" id="2652619">=</span>&nbsp;<span class="ident" id="2652621">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652626">bi</span>&nbsp;<span class="op" id="2652629">=</span>&nbsp;<span class="ident" id="2652631">bi</span><span class="op" id="2652633">[</span><span class="num" id="2652634">1</span><span class="op" id="2652635">:</span><span class="op" id="2652636">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652646">return</span>&nbsp;<span class="builtintype" id="2652653">string</span><span class="op" id="2652659">(</span><span class="ident" id="2652660">buf</span><span class="op" id="2652663">)</span><br>
<span class="lineno"></span><span class="op" id="2652665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2652668">func</span>&nbsp;<span class="op" id="2652673">(</span><span class="ident" id="2652674">r</span>&nbsp;<span class="op" id="2652676">*</span><span class="ident" id="2652677">byteStringReplacer</span><span class="op" id="2652695">)</span>&nbsp;<span class="ident" id="2652697">WriteString</span><span class="op" id="2652708">(</span><span class="ident" id="2652709">w</span>&nbsp;<span class="ident" id="2652711">io</span><span class="op" id="2652713">.</span><span class="ident" id="2652714">Writer</span><span class="op" id="2652720">,</span>&nbsp;<span class="ident" id="2652722">s</span>&nbsp;<span class="builtintype" id="2652724">string</span><span class="op" id="2652730">)</span>&nbsp;<span class="op" id="2652732">(</span><span class="ident" id="2652733">n</span>&nbsp;<span class="builtintype" id="2652735">int</span><span class="op" id="2652738">,</span>&nbsp;<span class="ident" id="2652740">err</span>&nbsp;<span class="builtintype" id="2652744">error</span><span class="op" id="2652749">)</span>&nbsp;<span class="op" id="2652751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652754">sw</span>&nbsp;<span class="op" id="2652757">:=</span>&nbsp;<span class="ident" id="2652760">getStringWriter</span><span class="op" id="2652775">(</span><span class="ident" id="2652776">w</span><span class="op" id="2652777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652780">last</span>&nbsp;<span class="op" id="2652785">:=</span>&nbsp;<span class="num" id="2652788">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652791">for</span>&nbsp;<span class="ident" id="2652795">i</span>&nbsp;<span class="op" id="2652797">:=</span>&nbsp;<span class="num" id="2652800">0</span><span class="op" id="2652801">;</span>&nbsp;<span class="ident" id="2652803">i</span>&nbsp;<span class="op" id="2652805">&lt;</span>&nbsp;<span class="builtinfunc" id="2652807">len</span><span class="op" id="2652810">(</span><span class="ident" id="2652811">s</span><span class="op" id="2652812">)</span><span class="op" id="2652813">;</span>&nbsp;<span class="ident" id="2652815">i</span><span class="op" id="2652816">++</span>&nbsp;<span class="op" id="2652819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652823">b</span>&nbsp;<span class="op" id="2652825">:=</span>&nbsp;<span class="ident" id="2652828">s</span><span class="op" id="2652829">[</span><span class="ident" id="2652830">i</span><span class="op" id="2652831">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652835">if</span>&nbsp;<span class="ident" id="2652838">r</span><span class="op" id="2652839">[</span><span class="ident" id="2652840">b</span><span class="op" id="2652841">]</span>&nbsp;<span class="op" id="2652843">==</span>&nbsp;<span class="ident" id="2652846">nil</span>&nbsp;<span class="op" id="2652850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652855">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652870">if</span>&nbsp;<span class="ident" id="2652873">last</span>&nbsp;<span class="op" id="2652878">!=</span>&nbsp;<span class="ident" id="2652881">i</span>&nbsp;<span class="op" id="2652883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652888">nw</span><span class="op" id="2652890">,</span>&nbsp;<span class="ident" id="2652892">err</span>&nbsp;<span class="op" id="2652896">:=</span>&nbsp;<span class="ident" id="2652899">sw</span><span class="op" id="2652901">.</span><span class="ident" id="2652902">WriteString</span><span class="op" id="2652913">(</span><span class="ident" id="2652914">s</span><span class="op" id="2652915">[</span><span class="ident" id="2652916">last</span><span class="op" id="2652920">:</span><span class="ident" id="2652921">i</span><span class="op" id="2652922">]</span><span class="op" id="2652923">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652928">n</span>&nbsp;<span class="op" id="2652930">+=</span>&nbsp;<span class="ident" id="2652933">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652939">if</span>&nbsp;<span class="ident" id="2652942">err</span>&nbsp;<span class="op" id="2652946">!=</span>&nbsp;<span class="ident" id="2652949">nil</span>&nbsp;<span class="op" id="2652953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2652959">return</span>&nbsp;<span class="ident" id="2652966">n</span><span class="op" id="2652967">,</span>&nbsp;<span class="ident" id="2652969">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2652980">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652984">last</span>&nbsp;<span class="op" id="2652989">=</span>&nbsp;<span class="ident" id="2652991">i</span>&nbsp;<span class="op" id="2652993">+</span>&nbsp;<span class="num" id="2652995">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2652999">nw</span><span class="op" id="2653001">,</span>&nbsp;<span class="ident" id="2653003">err</span>&nbsp;<span class="op" id="2653007">:=</span>&nbsp;<span class="ident" id="2653010">w</span><span class="op" id="2653011">.</span><span class="ident" id="2653012">Write</span><span class="op" id="2653017">(</span><span class="ident" id="2653018">r</span><span class="op" id="2653019">[</span><span class="ident" id="2653020">b</span><span class="op" id="2653021">]</span><span class="op" id="2653022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2653026">n</span>&nbsp;<span class="op" id="2653028">+=</span>&nbsp;<span class="ident" id="2653031">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2653036">if</span>&nbsp;<span class="ident" id="2653039">err</span>&nbsp;<span class="op" id="2653043">!=</span>&nbsp;<span class="ident" id="2653046">nil</span>&nbsp;<span class="op" id="2653050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2653055">return</span>&nbsp;<span class="ident" id="2653062">n</span><span class="op" id="2653063">,</span>&nbsp;<span class="ident" id="2653065">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2653071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2653074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2653077">if</span>&nbsp;<span class="ident" id="2653080">last</span>&nbsp;<span class="op" id="2653085">!=</span>&nbsp;<span class="builtinfunc" id="2653088">len</span><span class="op" id="2653091">(</span><span class="ident" id="2653092">s</span><span class="op" id="2653093">)</span>&nbsp;<span class="op" id="2653095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2653099">var</span>&nbsp;<span class="ident" id="2653103">nw</span>&nbsp;<span class="builtintype" id="2653106">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2653112">nw</span><span class="op" id="2653114">,</span>&nbsp;<span class="ident" id="2653116">err</span>&nbsp;<span class="op" id="2653120">=</span>&nbsp;<span class="ident" id="2653122">sw</span><span class="op" id="2653124">.</span><span class="ident" id="2653125">WriteString</span><span class="op" id="2653136">(</span><span class="ident" id="2653137">s</span><span class="op" id="2653138">[</span><span class="ident" id="2653139">last</span><span class="op" id="2653143">:</span><span class="op" id="2653144">]</span><span class="op" id="2653145">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2653149">n</span>&nbsp;<span class="op" id="2653151">+=</span>&nbsp;<span class="ident" id="2653154">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2653158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2653161">return</span><br>
<span class="lineno"></span><span class="op" id="2653168">}</span>
</div>
</body>
</html>
