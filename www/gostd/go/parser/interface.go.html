<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html" class="current">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5283108">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5283163">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5283217">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5283268">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5283342">package</span>&nbsp;<span class="ident" id="5283350">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5283358">import</span>&nbsp;<span class="op" id="5283365">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283368">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283377">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283387">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283397">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283409">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283415">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283428">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283434">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5283451">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5283461">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5283464">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="5283531">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5283599">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5283656">//</span><br>
<span class="lineno">25</span><span class="keyword" id="5283659">func</span>&nbsp;<span class="ident" id="5283664">readSource</span><span class="op" id="5283674">(</span><span class="ident" id="5283675">filename</span>&nbsp;<span class="builtintype" id="5283684">string</span><span class="op" id="5283690">,</span>&nbsp;<span class="ident" id="5283692">src</span>&nbsp;<span class="keyword" id="5283696">interface</span><span class="op" id="5283705">{</span><span class="op" id="5283706">}</span><span class="op" id="5283707">)</span>&nbsp;<span class="op" id="5283709">(</span><span class="op" id="5283710">[</span><span class="op" id="5283711">]</span><span class="builtintype" id="5283712">byte</span><span class="op" id="5283716">,</span>&nbsp;<span class="builtintype" id="5283718">error</span><span class="op" id="5283723">)</span>&nbsp;<span class="op" id="5283725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283728">if</span>&nbsp;<span class="ident" id="5283731">src</span>&nbsp;<span class="op" id="5283735">!=</span>&nbsp;<span class="builtintype" id="5283738">nil</span>&nbsp;<span class="op" id="5283742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283746">switch</span>&nbsp;<span class="ident" id="5283753">s</span>&nbsp;<span class="op" id="5283755">:=</span>&nbsp;<span class="ident" id="5283758">src</span><span class="op" id="5283761">.</span><span class="op" id="5283762">(</span><span class="keyword" id="5283763">type</span><span class="op" id="5283767">)</span>&nbsp;<span class="op" id="5283769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283773">case</span>&nbsp;<span class="builtintype" id="5283778">string</span><span class="op" id="5283784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283789">return</span>&nbsp;<span class="op" id="5283796">[</span><span class="op" id="5283797">]</span><span class="builtintype" id="5283798">byte</span><span class="op" id="5283802">(</span><span class="ident" id="5283803">s</span><span class="op" id="5283804">)</span><span class="op" id="5283805">,</span>&nbsp;<span class="builtintype" id="5283807">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283813">case</span>&nbsp;<span class="op" id="5283818">[</span><span class="op" id="5283819">]</span><span class="builtintype" id="5283820">byte</span><span class="op" id="5283824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283829">return</span>&nbsp;<span class="ident" id="5283836">s</span><span class="op" id="5283837">,</span>&nbsp;<span class="builtintype" id="5283839">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283845">case</span>&nbsp;<span class="op" id="5283850">*</span><span class="ident" id="5283851">bytes</span><span class="op" id="5283856">.</span><span class="ident" id="5283857">Buffer</span><span class="op" id="5283863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283868">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283932">if</span>&nbsp;<span class="ident" id="5283935">s</span>&nbsp;<span class="op" id="5283937">!=</span>&nbsp;<span class="builtintype" id="5283940">nil</span>&nbsp;<span class="op" id="5283944">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283950">return</span>&nbsp;<span class="ident" id="5283957">s</span><span class="op" id="5283958">.</span><span class="ident" id="5283959">Bytes</span><span class="op" id="5283964">(</span><span class="op" id="5283965">)</span><span class="op" id="5283966">,</span>&nbsp;<span class="builtintype" id="5283968">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5283975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283979">case</span>&nbsp;<span class="ident" id="5283984">io</span><span class="op" id="5283986">.</span><span class="ident" id="5283987">Reader</span><span class="op" id="5283993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283998">var</span>&nbsp;<span class="ident" id="5284002">buf</span>&nbsp;<span class="ident" id="5284006">bytes</span><span class="op" id="5284011">.</span><span class="ident" id="5284012">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284022">if</span>&nbsp;<span class="ident" id="5284025">_</span><span class="op" id="5284026">,</span>&nbsp;<span class="ident" id="5284028">err</span>&nbsp;<span class="op" id="5284032">:=</span>&nbsp;<span class="ident" id="5284035">io</span><span class="op" id="5284037">.</span><span class="ident" id="5284038">Copy</span><span class="op" id="5284042">(</span><span class="op" id="5284043">&amp;</span><span class="ident" id="5284044">buf</span><span class="op" id="5284047">,</span>&nbsp;<span class="ident" id="5284049">s</span><span class="op" id="5284050">)</span><span class="op" id="5284051">;</span>&nbsp;<span class="ident" id="5284053">err</span>&nbsp;<span class="op" id="5284057">!=</span>&nbsp;<span class="builtintype" id="5284060">nil</span>&nbsp;<span class="op" id="5284064">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284070">return</span>&nbsp;<span class="builtintype" id="5284077">nil</span><span class="op" id="5284080">,</span>&nbsp;<span class="ident" id="5284082">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284094">return</span>&nbsp;<span class="ident" id="5284101">buf</span><span class="op" id="5284104">.</span><span class="ident" id="5284105">Bytes</span><span class="op" id="5284110">(</span><span class="op" id="5284111">)</span><span class="op" id="5284112">,</span>&nbsp;<span class="builtintype" id="5284114">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284124">return</span>&nbsp;<span class="builtintype" id="5284131">nil</span><span class="op" id="5284134">,</span>&nbsp;<span class="ident" id="5284136">errors</span><span class="op" id="5284142">.</span><span class="ident" id="5284143">New</span><span class="op" id="5284146">(</span><span class="string" id="5284147">&#34;invalid&nbsp;source&#34;</span><span class="op" id="5284163">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284169">return</span>&nbsp;<span class="ident" id="5284176">ioutil</span><span class="op" id="5284182">.</span><span class="ident" id="5284183">ReadFile</span><span class="op" id="5284191">(</span><span class="ident" id="5284192">filename</span><span class="op" id="5284200">)</span><br>
<span class="lineno"></span><span class="op" id="5284202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5284205">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="5284247">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="5284315">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="5284340">//</span><br>
<span class="lineno"></span><span class="keyword" id="5284343">type</span>&nbsp;<span class="ident" id="5284348">Mode</span>&nbsp;<span class="builtintype" id="5284353">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5284359">const</span>&nbsp;<span class="op" id="5284365">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284368">PackageClauseOnly</span>&nbsp;<span class="ident" id="5284386">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284403">=</span>&nbsp;<span class="num" id="5284405">1</span>&nbsp;<span class="op" id="5284407">&lt;&lt;</span>&nbsp;<span class="ident" id="5284410">iota</span>&nbsp;<span class="comment" id="5284415">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284453">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284500">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284543">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284590">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284629">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284676">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284716">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284763">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284793">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284840">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284890">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284908">=</span>&nbsp;<span class="ident" id="5284910">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284937">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="5285001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5285004">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5285079">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="5285151">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="5285213">//</span><br>
<span class="lineno"></span><span class="comment" id="5285216">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="5285291">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5285366">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="5285429">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5285496">//</span><br>
<span class="lineno"></span><span class="comment" id="5285499">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="5285573">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5285647">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5285665">//</span><br>
<span class="lineno"></span><span class="comment" id="5285668">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5285741">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="5285810">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="5285881">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="5285954">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="5286028">//</span><br>
<span class="lineno"></span><span class="keyword" id="5286031">func</span>&nbsp;<span class="ident" id="5286036">ParseFile</span><span class="op" id="5286045">(</span><span class="ident" id="5286046">fset</span>&nbsp;<span class="op" id="5286051">*</span><span class="ident" id="5286052">token</span><span class="op" id="5286057">.</span><span class="ident" id="5286058">FileSet</span><span class="op" id="5286065">,</span>&nbsp;<span class="ident" id="5286067">filename</span>&nbsp;<span class="builtintype" id="5286076">string</span><span class="op" id="5286082">,</span>&nbsp;<span class="ident" id="5286084">src</span>&nbsp;<span class="keyword" id="5286088">interface</span><span class="op" id="5286097">{</span><span class="op" id="5286098">}</span><span class="op" id="5286099">,</span>&nbsp;<span class="ident" id="5286101">mode</span>&nbsp;<span class="ident" id="5286106">Mode</span><span class="op" id="5286110">)</span>&nbsp;<span class="op" id="5286112">(</span><span class="ident" id="5286113">f</span>&nbsp;<span class="op" id="5286115">*</span><span class="ident" id="5286116">ast</span><span class="op" id="5286119">.</span><span class="ident" id="5286120">File</span><span class="op" id="5286124">,</span>&nbsp;<span class="ident" id="5286126">err</span>&nbsp;<span class="builtintype" id="5286130">error</span><span class="op" id="5286135">)</span>&nbsp;<span class="op" id="5286137">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286140">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286155">text</span><span class="op" id="5286159">,</span>&nbsp;<span class="ident" id="5286161">err</span>&nbsp;<span class="op" id="5286165">:=</span>&nbsp;<span class="ident" id="5286168">readSource</span><span class="op" id="5286178">(</span><span class="ident" id="5286179">filename</span><span class="op" id="5286187">,</span>&nbsp;<span class="ident" id="5286189">src</span><span class="op" id="5286192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286195">if</span>&nbsp;<span class="ident" id="5286198">err</span>&nbsp;<span class="op" id="5286202">!=</span>&nbsp;<span class="builtintype" id="5286205">nil</span>&nbsp;<span class="op" id="5286209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286213">return</span>&nbsp;<span class="builtintype" id="5286220">nil</span><span class="op" id="5286223">,</span>&nbsp;<span class="ident" id="5286225">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286230">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286234">var</span>&nbsp;<span class="ident" id="5286238">p</span>&nbsp;<span class="ident" id="5286240">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286248">defer</span>&nbsp;<span class="keyword" id="5286254">func</span><span class="op" id="5286258">(</span><span class="op" id="5286259">)</span>&nbsp;<span class="op" id="5286261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286265">if</span>&nbsp;<span class="ident" id="5286268">e</span>&nbsp;<span class="op" id="5286270">:=</span>&nbsp;<span class="builtinfunc" id="5286273">recover</span><span class="op" id="5286280">(</span><span class="op" id="5286281">)</span><span class="op" id="5286282">;</span>&nbsp;<span class="ident" id="5286284">e</span>&nbsp;<span class="op" id="5286286">!=</span>&nbsp;<span class="builtintype" id="5286289">nil</span>&nbsp;<span class="op" id="5286293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286298">_</span>&nbsp;<span class="op" id="5286300">=</span>&nbsp;<span class="ident" id="5286302">e</span><span class="op" id="5286303">.</span><span class="op" id="5286304">(</span><span class="ident" id="5286305">bailout</span><span class="op" id="5286312">)</span>&nbsp;<span class="comment" id="5286314">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286356">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286379">if</span>&nbsp;<span class="ident" id="5286382">f</span>&nbsp;<span class="op" id="5286384">==</span>&nbsp;<span class="builtintype" id="5286387">nil</span>&nbsp;<span class="op" id="5286391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286396">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286449">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286500">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286516">f</span>&nbsp;<span class="op" id="5286518">=</span>&nbsp;<span class="op" id="5286520">&amp;</span><span class="ident" id="5286521">ast</span><span class="op" id="5286524">.</span><span class="ident" id="5286525">File</span><span class="op" id="5286529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286535">Name</span><span class="op" id="5286539">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5286542">new</span><span class="op" id="5286545">(</span><span class="ident" id="5286546">ast</span><span class="op" id="5286549">.</span><span class="ident" id="5286550">Ident</span><span class="op" id="5286555">)</span><span class="op" id="5286556">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286562">Scope</span><span class="op" id="5286567">:</span>&nbsp;<span class="ident" id="5286569">ast</span><span class="op" id="5286572">.</span><span class="ident" id="5286573">NewScope</span><span class="op" id="5286581">(</span><span class="builtintype" id="5286582">nil</span><span class="op" id="5286585">)</span><span class="op" id="5286586">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286600">p</span><span class="op" id="5286601">.</span><span class="ident" id="5286602">errors</span><span class="op" id="5286608">.</span><span class="ident" id="5286609">Sort</span><span class="op" id="5286613">(</span><span class="op" id="5286614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286618">err</span>&nbsp;<span class="op" id="5286622">=</span>&nbsp;<span class="ident" id="5286624">p</span><span class="op" id="5286625">.</span><span class="ident" id="5286626">errors</span><span class="op" id="5286632">.</span><span class="ident" id="5286633">Err</span><span class="op" id="5286636">(</span><span class="op" id="5286637">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286640">}</span><span class="op" id="5286641">(</span><span class="op" id="5286642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286646">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286663">p</span><span class="op" id="5286664">.</span><span class="ident" id="5286665">init</span><span class="op" id="5286669">(</span><span class="ident" id="5286670">fset</span><span class="op" id="5286674">,</span>&nbsp;<span class="ident" id="5286676">filename</span><span class="op" id="5286684">,</span>&nbsp;<span class="ident" id="5286686">text</span><span class="op" id="5286690">,</span>&nbsp;<span class="ident" id="5286692">mode</span><span class="op" id="5286696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286699">f</span>&nbsp;<span class="op" id="5286701">=</span>&nbsp;<span class="ident" id="5286703">p</span><span class="op" id="5286704">.</span><span class="ident" id="5286705">parseFile</span><span class="op" id="5286714">(</span><span class="op" id="5286715">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286719">return</span><br>
<span class="lineno"></span><span class="op" id="5286726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5286729">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="5286805">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5286881">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="5286917">//</span><br>
<span class="lineno"></span><span class="comment" id="5286920">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="5286997">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="5287074">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5287143">//</span><br>
<span class="lineno"></span><span class="comment" id="5287146">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5287223">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5287300">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="5287341">//</span><br>
<span class="lineno"></span><span class="keyword" id="5287344">func</span>&nbsp;<span class="ident" id="5287349">ParseDir</span><span class="op" id="5287357">(</span><span class="ident" id="5287358">fset</span>&nbsp;<span class="op" id="5287363">*</span><span class="ident" id="5287364">token</span><span class="op" id="5287369">.</span><span class="ident" id="5287370">FileSet</span><span class="op" id="5287377">,</span>&nbsp;<span class="ident" id="5287379">path</span>&nbsp;<span class="builtintype" id="5287384">string</span><span class="op" id="5287390">,</span>&nbsp;<span class="ident" id="5287392">filter</span>&nbsp;<span class="keyword" id="5287399">func</span><span class="op" id="5287403">(</span><span class="ident" id="5287404">os</span><span class="op" id="5287406">.</span><span class="ident" id="5287407">FileInfo</span><span class="op" id="5287415">)</span>&nbsp;<span class="builtintype" id="5287417">bool</span><span class="op" id="5287421">,</span>&nbsp;<span class="ident" id="5287423">mode</span>&nbsp;<span class="ident" id="5287428">Mode</span><span class="op" id="5287432">)</span>&nbsp;<span class="op" id="5287434">(</span><span class="ident" id="5287435">pkgs</span>&nbsp;<span class="keyword" id="5287440">map</span><span class="op" id="5287443">[</span><span class="builtintype" id="5287444">string</span><span class="op" id="5287450">]</span><span class="op" id="5287451">*</span><span class="ident" id="5287452">ast</span><span class="op" id="5287455">.</span><span class="ident" id="5287456">Package</span><span class="op" id="5287463">,</span>&nbsp;<span class="ident" id="5287465">first</span>&nbsp;<span class="builtintype" id="5287471">error</span><span class="op" id="5287476">)</span>&nbsp;<span class="op" id="5287478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287481">fd</span><span class="op" id="5287483">,</span>&nbsp;<span class="ident" id="5287485">err</span>&nbsp;<span class="op" id="5287489">:=</span>&nbsp;<span class="ident" id="5287492">os</span><span class="op" id="5287494">.</span><span class="ident" id="5287495">Open</span><span class="op" id="5287499">(</span><span class="ident" id="5287500">path</span><span class="op" id="5287504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287507">if</span>&nbsp;<span class="ident" id="5287510">err</span>&nbsp;<span class="op" id="5287514">!=</span>&nbsp;<span class="builtintype" id="5287517">nil</span>&nbsp;<span class="op" id="5287521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287525">return</span>&nbsp;<span class="builtintype" id="5287532">nil</span><span class="op" id="5287535">,</span>&nbsp;<span class="ident" id="5287537">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5287542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287545">defer</span>&nbsp;<span class="ident" id="5287551">fd</span><span class="op" id="5287553">.</span><span class="ident" id="5287554">Close</span><span class="op" id="5287559">(</span><span class="op" id="5287560">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287564">list</span><span class="op" id="5287568">,</span>&nbsp;<span class="ident" id="5287570">err</span>&nbsp;<span class="op" id="5287574">:=</span>&nbsp;<span class="ident" id="5287577">fd</span><span class="op" id="5287579">.</span><span class="ident" id="5287580">Readdir</span><span class="op" id="5287587">(</span><span class="op" id="5287588">-</span><span class="num" id="5287589">1</span><span class="op" id="5287590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287593">if</span>&nbsp;<span class="ident" id="5287596">err</span>&nbsp;<span class="op" id="5287600">!=</span>&nbsp;<span class="builtintype" id="5287603">nil</span>&nbsp;<span class="op" id="5287607">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287611">return</span>&nbsp;<span class="builtintype" id="5287618">nil</span><span class="op" id="5287621">,</span>&nbsp;<span class="ident" id="5287623">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5287628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287632">pkgs</span>&nbsp;<span class="op" id="5287637">=</span>&nbsp;<span class="builtinfunc" id="5287639">make</span><span class="op" id="5287643">(</span><span class="keyword" id="5287644">map</span><span class="op" id="5287647">[</span><span class="builtintype" id="5287648">string</span><span class="op" id="5287654">]</span><span class="op" id="5287655">*</span><span class="ident" id="5287656">ast</span><span class="op" id="5287659">.</span><span class="ident" id="5287660">Package</span><span class="op" id="5287667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287670">for</span>&nbsp;<span class="ident" id="5287674">_</span><span class="op" id="5287675">,</span>&nbsp;<span class="ident" id="5287677">d</span>&nbsp;<span class="op" id="5287679">:=</span>&nbsp;<span class="keyword" id="5287682">range</span>&nbsp;<span class="ident" id="5287688">list</span>&nbsp;<span class="op" id="5287693">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287697">if</span>&nbsp;<span class="ident" id="5287700">strings</span><span class="op" id="5287707">.</span><span class="ident" id="5287708">HasSuffix</span><span class="op" id="5287717">(</span><span class="ident" id="5287718">d</span><span class="op" id="5287719">.</span><span class="ident" id="5287720">Name</span><span class="op" id="5287724">(</span><span class="op" id="5287725">)</span><span class="op" id="5287726">,</span>&nbsp;<span class="string" id="5287728">&#34;.go&#34;</span><span class="op" id="5287733">)</span>&nbsp;<span class="op" id="5287735">&amp;&amp;</span>&nbsp;<span class="op" id="5287738">(</span><span class="ident" id="5287739">filter</span>&nbsp;<span class="op" id="5287746">==</span>&nbsp;<span class="builtintype" id="5287749">nil</span>&nbsp;<span class="op" id="5287753">||</span>&nbsp;<span class="ident" id="5287756">filter</span><span class="op" id="5287762">(</span><span class="ident" id="5287763">d</span><span class="op" id="5287764">)</span><span class="op" id="5287765">)</span>&nbsp;<span class="op" id="5287767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287772">filename</span>&nbsp;<span class="op" id="5287781">:=</span>&nbsp;<span class="ident" id="5287784">filepath</span><span class="op" id="5287792">.</span><span class="ident" id="5287793">Join</span><span class="op" id="5287797">(</span><span class="ident" id="5287798">path</span><span class="op" id="5287802">,</span>&nbsp;<span class="ident" id="5287804">d</span><span class="op" id="5287805">.</span><span class="ident" id="5287806">Name</span><span class="op" id="5287810">(</span><span class="op" id="5287811">)</span><span class="op" id="5287812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287817">if</span>&nbsp;<span class="ident" id="5287820">src</span><span class="op" id="5287823">,</span>&nbsp;<span class="ident" id="5287825">err</span>&nbsp;<span class="op" id="5287829">:=</span>&nbsp;<span class="ident" id="5287832">ParseFile</span><span class="op" id="5287841">(</span><span class="ident" id="5287842">fset</span><span class="op" id="5287846">,</span>&nbsp;<span class="ident" id="5287848">filename</span><span class="op" id="5287856">,</span>&nbsp;<span class="builtintype" id="5287858">nil</span><span class="op" id="5287861">,</span>&nbsp;<span class="ident" id="5287863">mode</span><span class="op" id="5287867">)</span><span class="op" id="5287868">;</span>&nbsp;<span class="ident" id="5287870">err</span>&nbsp;<span class="op" id="5287874">==</span>&nbsp;<span class="builtintype" id="5287877">nil</span>&nbsp;<span class="op" id="5287881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287887">name</span>&nbsp;<span class="op" id="5287892">:=</span>&nbsp;<span class="ident" id="5287895">src</span><span class="op" id="5287898">.</span><span class="ident" id="5287899">Name</span><span class="op" id="5287903">.</span><span class="ident" id="5287904">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287913">pkg</span><span class="op" id="5287916">,</span>&nbsp;<span class="ident" id="5287918">found</span>&nbsp;<span class="op" id="5287924">:=</span>&nbsp;<span class="ident" id="5287927">pkgs</span><span class="op" id="5287931">[</span><span class="ident" id="5287932">name</span><span class="op" id="5287936">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287942">if</span>&nbsp;<span class="op" id="5287945">!</span><span class="ident" id="5287946">found</span>&nbsp;<span class="op" id="5287952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287959">pkg</span>&nbsp;<span class="op" id="5287963">=</span>&nbsp;<span class="op" id="5287965">&amp;</span><span class="ident" id="5287966">ast</span><span class="op" id="5287969">.</span><span class="ident" id="5287970">Package</span><span class="op" id="5287977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287985">Name</span><span class="op" id="5287989">:</span>&nbsp;&nbsp;<span class="ident" id="5287992">name</span><span class="op" id="5287996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288004">Files</span><span class="op" id="5288009">:</span>&nbsp;<span class="builtinfunc" id="5288011">make</span><span class="op" id="5288015">(</span><span class="keyword" id="5288016">map</span><span class="op" id="5288019">[</span><span class="builtintype" id="5288020">string</span><span class="op" id="5288026">]</span><span class="op" id="5288027">*</span><span class="ident" id="5288028">ast</span><span class="op" id="5288031">.</span><span class="ident" id="5288032">File</span><span class="op" id="5288036">)</span><span class="op" id="5288037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288044">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288051">pkgs</span><span class="op" id="5288055">[</span><span class="ident" id="5288056">name</span><span class="op" id="5288060">]</span>&nbsp;<span class="op" id="5288062">=</span>&nbsp;<span class="ident" id="5288064">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288078">pkg</span><span class="op" id="5288081">.</span><span class="ident" id="5288082">Files</span><span class="op" id="5288087">[</span><span class="ident" id="5288088">filename</span><span class="op" id="5288096">]</span>&nbsp;<span class="op" id="5288098">=</span>&nbsp;<span class="ident" id="5288100">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288107">}</span>&nbsp;<span class="keyword" id="5288109">else</span>&nbsp;<span class="keyword" id="5288114">if</span>&nbsp;<span class="ident" id="5288117">first</span>&nbsp;<span class="op" id="5288123">==</span>&nbsp;<span class="builtintype" id="5288126">nil</span>&nbsp;<span class="op" id="5288130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288136">first</span>&nbsp;<span class="op" id="5288142">=</span>&nbsp;<span class="ident" id="5288144">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288162">return</span><br>
<span class="lineno">165</span><span class="op" id="5288169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5288172">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="5288253">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="5288333">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="5288375">//</span><br>
<span class="lineno"></span><span class="keyword" id="5288378">func</span>&nbsp;<span class="ident" id="5288383">ParseExpr</span><span class="op" id="5288392">(</span><span class="ident" id="5288393">x</span>&nbsp;<span class="builtintype" id="5288395">string</span><span class="op" id="5288401">)</span>&nbsp;<span class="op" id="5288403">(</span><span class="ident" id="5288404">ast</span><span class="op" id="5288407">.</span><span class="ident" id="5288408">Expr</span><span class="op" id="5288412">,</span>&nbsp;<span class="builtintype" id="5288414">error</span><span class="op" id="5288419">)</span>&nbsp;<span class="op" id="5288421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288424">var</span>&nbsp;<span class="ident" id="5288428">p</span>&nbsp;<span class="ident" id="5288430">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288438">p</span><span class="op" id="5288439">.</span><span class="ident" id="5288440">init</span><span class="op" id="5288444">(</span><span class="ident" id="5288445">token</span><span class="op" id="5288450">.</span><span class="ident" id="5288451">NewFileSet</span><span class="op" id="5288461">(</span><span class="op" id="5288462">)</span><span class="op" id="5288463">,</span>&nbsp;<span class="string" id="5288465">&#34;&#34;</span><span class="op" id="5288467">,</span>&nbsp;<span class="op" id="5288469">[</span><span class="op" id="5288470">]</span><span class="builtintype" id="5288471">byte</span><span class="op" id="5288475">(</span><span class="ident" id="5288476">x</span><span class="op" id="5288477">)</span><span class="op" id="5288478">,</span>&nbsp;<span class="num" id="5288480">0</span><span class="op" id="5288481">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288485">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288542">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288599">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288658">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288689">p</span><span class="op" id="5288690">.</span><span class="ident" id="5288691">openScope</span><span class="op" id="5288700">(</span><span class="op" id="5288701">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288704">p</span><span class="op" id="5288705">.</span><span class="ident" id="5288706">pkgScope</span>&nbsp;<span class="op" id="5288715">=</span>&nbsp;<span class="ident" id="5288717">p</span><span class="op" id="5288718">.</span><span class="ident" id="5288719">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288729">e</span>&nbsp;<span class="op" id="5288731">:=</span>&nbsp;<span class="ident" id="5288734">p</span><span class="op" id="5288735">.</span><span class="ident" id="5288736">parseRhsOrType</span><span class="op" id="5288750">(</span><span class="op" id="5288751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288754">p</span><span class="op" id="5288755">.</span><span class="ident" id="5288756">closeScope</span><span class="op" id="5288766">(</span><span class="op" id="5288767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288770">assert</span><span class="op" id="5288776">(</span><span class="ident" id="5288777">p</span><span class="op" id="5288778">.</span><span class="ident" id="5288779">topScope</span>&nbsp;<span class="op" id="5288788">==</span>&nbsp;<span class="builtintype" id="5288791">nil</span><span class="op" id="5288794">,</span>&nbsp;<span class="string" id="5288796">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="5288815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288819">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288864">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288908">if</span>&nbsp;<span class="ident" id="5288911">p</span><span class="op" id="5288912">.</span><span class="ident" id="5288913">tok</span>&nbsp;<span class="op" id="5288917">==</span>&nbsp;<span class="ident" id="5288920">token</span><span class="op" id="5288925">.</span><span class="ident" id="5288926">SEMICOLON</span>&nbsp;<span class="op" id="5288936">&amp;&amp;</span>&nbsp;<span class="ident" id="5288939">p</span><span class="op" id="5288940">.</span><span class="ident" id="5288941">lit</span>&nbsp;<span class="op" id="5288945">==</span>&nbsp;<span class="string" id="5288948">&#34;\n&#34;</span>&nbsp;<span class="op" id="5288953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288957">p</span><span class="op" id="5288958">.</span><span class="ident" id="5288959">next</span><span class="op" id="5288963">(</span><span class="op" id="5288964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288967">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288970">p</span><span class="op" id="5288971">.</span><span class="ident" id="5288972">expect</span><span class="op" id="5288978">(</span><span class="ident" id="5288979">token</span><span class="op" id="5288984">.</span><span class="ident" id="5288985">EOF</span><span class="op" id="5288988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288992">if</span>&nbsp;<span class="ident" id="5288995">p</span><span class="op" id="5288996">.</span><span class="ident" id="5288997">errors</span><span class="op" id="5289003">.</span><span class="ident" id="5289004">Len</span><span class="op" id="5289007">(</span><span class="op" id="5289008">)</span>&nbsp;<span class="op" id="5289010">&gt;</span>&nbsp;<span class="num" id="5289012">0</span>&nbsp;<span class="op" id="5289014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289018">p</span><span class="op" id="5289019">.</span><span class="ident" id="5289020">errors</span><span class="op" id="5289026">.</span><span class="ident" id="5289027">Sort</span><span class="op" id="5289031">(</span><span class="op" id="5289032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289036">return</span>&nbsp;<span class="builtintype" id="5289043">nil</span><span class="op" id="5289046">,</span>&nbsp;<span class="ident" id="5289048">p</span><span class="op" id="5289049">.</span><span class="ident" id="5289050">errors</span><span class="op" id="5289056">.</span><span class="ident" id="5289057">Err</span><span class="op" id="5289060">(</span><span class="op" id="5289061">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289068">return</span>&nbsp;<span class="ident" id="5289075">e</span><span class="op" id="5289076">,</span>&nbsp;<span class="builtintype" id="5289078">nil</span><br>
<span class="lineno"></span><span class="op" id="5289082">}</span>
</div>
</body>
</html>
