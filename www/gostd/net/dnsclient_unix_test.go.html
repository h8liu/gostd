<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8189945">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8190000">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8190054">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8190105">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8190170">package</span>&nbsp;<span class="ident" id="8190178">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8190183">import</span>&nbsp;<span class="op" id="8190190">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190193">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190199">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190212">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190218">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190226">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190237">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8190248">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8190255">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8190258">var</span>&nbsp;<span class="ident" id="8190262">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="8190288">=</span>&nbsp;<span class="op" id="8190290">[</span><span class="op" id="8190291">]</span><span class="keyword" id="8190292">struct</span>&nbsp;<span class="op" id="8190299">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190302">server</span>&nbsp;&nbsp;<span class="builtintype" id="8190310">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190318">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8190326">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190334">qtype</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8190342">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190350">timeout</span>&nbsp;<span class="builtintype" id="8190358">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190363">rcode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8190371">int</span><br>
<span class="lineno">25</span><span class="op" id="8190375">}</span><span class="op" id="8190376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190379">//&nbsp;Querying&nbsp;&#34;com.&#34;&nbsp;with&nbsp;qtype=255&nbsp;usually&nbsp;makes&nbsp;an&nbsp;answer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8190438">//&nbsp;which&nbsp;requires&nbsp;more&nbsp;than&nbsp;512&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190478">{</span><span class="string" id="8190479">&#34;8.8.8.8:53&#34;</span><span class="op" id="8190491">,</span>&nbsp;<span class="string" id="8190493">&#34;com.&#34;</span><span class="op" id="8190499">,</span>&nbsp;<span class="ident" id="8190501">dnsTypeALL</span><span class="op" id="8190511">,</span>&nbsp;<span class="num" id="8190513">2</span><span class="op" id="8190514">,</span>&nbsp;<span class="ident" id="8190516">dnsRcodeSuccess</span><span class="op" id="8190531">}</span><span class="op" id="8190532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190535">{</span><span class="string" id="8190536">&#34;8.8.4.4:53&#34;</span><span class="op" id="8190548">,</span>&nbsp;<span class="string" id="8190550">&#34;com.&#34;</span><span class="op" id="8190556">,</span>&nbsp;<span class="ident" id="8190558">dnsTypeALL</span><span class="op" id="8190568">,</span>&nbsp;<span class="num" id="8190570">4</span><span class="op" id="8190571">,</span>&nbsp;<span class="ident" id="8190573">dnsRcodeSuccess</span><span class="op" id="8190588">}</span><span class="op" id="8190589">,</span><br>
<span class="lineno">30</span><span class="op" id="8190591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8190594">func</span>&nbsp;<span class="ident" id="8190599">TestDNSTransportFallback</span><span class="op" id="8190623">(</span><span class="ident" id="8190624">t</span>&nbsp;<span class="op" id="8190626">*</span><span class="ident" id="8190627">testing</span><span class="op" id="8190634">.</span><span class="ident" id="8190635">T</span><span class="op" id="8190636">)</span>&nbsp;<span class="op" id="8190638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190641">if</span>&nbsp;<span class="ident" id="8190644">testing</span><span class="op" id="8190651">.</span><span class="ident" id="8190652">Short</span><span class="op" id="8190657">(</span><span class="op" id="8190658">)</span>&nbsp;<span class="op" id="8190660">||</span>&nbsp;<span class="op" id="8190663">!</span><span class="op" id="8190664">*</span><span class="ident" id="8190665">testExternal</span>&nbsp;<span class="op" id="8190678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190682">t</span><span class="op" id="8190683">.</span><span class="ident" id="8190684">Skip</span><span class="op" id="8190688">(</span><span class="string" id="8190689">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8190730">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190737">for</span>&nbsp;<span class="ident" id="8190741">_</span><span class="op" id="8190742">,</span>&nbsp;<span class="ident" id="8190744">tt</span>&nbsp;<span class="op" id="8190747">:=</span>&nbsp;<span class="keyword" id="8190750">range</span>&nbsp;<span class="ident" id="8190756">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="8190782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190786">timeout</span>&nbsp;<span class="op" id="8190794">:=</span>&nbsp;<span class="ident" id="8190797">time</span><span class="op" id="8190801">.</span><span class="ident" id="8190802">Duration</span><span class="op" id="8190810">(</span><span class="ident" id="8190811">tt</span><span class="op" id="8190813">.</span><span class="ident" id="8190814">timeout</span><span class="op" id="8190821">)</span>&nbsp;<span class="op" id="8190823">*</span>&nbsp;<span class="ident" id="8190825">time</span><span class="op" id="8190829">.</span><span class="ident" id="8190830">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190839">msg</span><span class="op" id="8190842">,</span>&nbsp;<span class="ident" id="8190844">err</span>&nbsp;<span class="op" id="8190848">:=</span>&nbsp;<span class="ident" id="8190851">exchange</span><span class="op" id="8190859">(</span><span class="ident" id="8190860">tt</span><span class="op" id="8190862">.</span><span class="ident" id="8190863">server</span><span class="op" id="8190869">,</span>&nbsp;<span class="ident" id="8190871">tt</span><span class="op" id="8190873">.</span><span class="ident" id="8190874">name</span><span class="op" id="8190878">,</span>&nbsp;<span class="ident" id="8190880">tt</span><span class="op" id="8190882">.</span><span class="ident" id="8190883">qtype</span><span class="op" id="8190888">,</span>&nbsp;<span class="ident" id="8190890">timeout</span><span class="op" id="8190897">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190901">if</span>&nbsp;<span class="ident" id="8190904">err</span>&nbsp;<span class="op" id="8190908">!=</span>&nbsp;<span class="ident" id="8190911">nil</span>&nbsp;<span class="op" id="8190915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8190920">t</span><span class="op" id="8190921">.</span><span class="ident" id="8190922">Error</span><span class="op" id="8190927">(</span><span class="ident" id="8190928">err</span><span class="op" id="8190931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190936">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8190947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190951">switch</span>&nbsp;<span class="ident" id="8190958">msg</span><span class="op" id="8190961">.</span><span class="ident" id="8190962">rcode</span>&nbsp;<span class="op" id="8190968">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8190972">case</span>&nbsp;<span class="ident" id="8190977">tt</span><span class="op" id="8190979">.</span><span class="ident" id="8190980">rcode</span><span class="op" id="8190985">,</span>&nbsp;<span class="ident" id="8190987">dnsRcodeServerFailure</span><span class="op" id="8191008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8191012">default</span><span class="op" id="8191019">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191024">t</span><span class="op" id="8191025">.</span><span class="ident" id="8191026">Errorf</span><span class="op" id="8191032">(</span><span class="string" id="8191033">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8191058">,</span>&nbsp;<span class="ident" id="8191060">msg</span><span class="op" id="8191063">.</span><span class="ident" id="8191064">rcode</span><span class="op" id="8191069">,</span>&nbsp;<span class="ident" id="8191071">tt</span><span class="op" id="8191073">.</span><span class="ident" id="8191074">server</span><span class="op" id="8191080">,</span>&nbsp;<span class="ident" id="8191082">tt</span><span class="op" id="8191084">.</span><span class="ident" id="8191085">rcode</span><span class="op" id="8191090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8191095">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191106">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191109">}</span><br>
<span class="lineno"></span><span class="op" id="8191111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8191114">//&nbsp;See&nbsp;RFC&nbsp;6761&nbsp;for&nbsp;further&nbsp;information&nbsp;about&nbsp;the&nbsp;reserved,&nbsp;pseudo</span><br>
<span class="lineno"></span><span class="comment" id="8191181">//&nbsp;domain&nbsp;names.</span><br>
<span class="lineno">55</span><span class="keyword" id="8191198">var</span>&nbsp;<span class="ident" id="8191202">specialDomainNameTests</span>&nbsp;<span class="op" id="8191225">=</span>&nbsp;<span class="op" id="8191227">[</span><span class="op" id="8191228">]</span><span class="keyword" id="8191229">struct</span>&nbsp;<span class="op" id="8191236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191239">name</span>&nbsp;&nbsp;<span class="builtintype" id="8191245">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191253">qtype</span>&nbsp;<span class="builtintype" id="8191259">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191267">rcode</span>&nbsp;<span class="builtintype" id="8191273">int</span><br>
<span class="lineno"></span><span class="op" id="8191277">}</span><span class="op" id="8191278">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191281">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;not&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191345">//&nbsp;followings&nbsp;as&nbsp;special.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191372">{</span><span class="string" id="8191373">&#34;1.0.168.192.in-addr.arpa.&#34;</span><span class="op" id="8191400">,</span>&nbsp;<span class="ident" id="8191402">dnsTypePTR</span><span class="op" id="8191412">,</span>&nbsp;<span class="ident" id="8191414">dnsRcodeNameError</span><span class="op" id="8191431">}</span><span class="op" id="8191432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191435">{</span><span class="string" id="8191436">&#34;test.&#34;</span><span class="op" id="8191443">,</span>&nbsp;<span class="ident" id="8191445">dnsTypeALL</span><span class="op" id="8191455">,</span>&nbsp;<span class="ident" id="8191457">dnsRcodeNameError</span><span class="op" id="8191474">}</span><span class="op" id="8191475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191478">{</span><span class="string" id="8191479">&#34;example.com.&#34;</span><span class="op" id="8191493">,</span>&nbsp;<span class="ident" id="8191495">dnsTypeALL</span><span class="op" id="8191505">,</span>&nbsp;<span class="ident" id="8191507">dnsRcodeSuccess</span><span class="op" id="8191522">}</span><span class="op" id="8191523">,</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191527">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191587">//&nbsp;followings&nbsp;as&nbsp;special&nbsp;and&nbsp;should&nbsp;not&nbsp;send&nbsp;any&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191646">//&nbsp;Though,&nbsp;we&nbsp;test&nbsp;those&nbsp;names&nbsp;here&nbsp;for&nbsp;verifying&nbsp;nagative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8191706">//&nbsp;answers&nbsp;at&nbsp;DNS&nbsp;query-response&nbsp;interaction&nbsp;level.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191759">{</span><span class="string" id="8191760">&#34;localhost.&#34;</span><span class="op" id="8191772">,</span>&nbsp;<span class="ident" id="8191774">dnsTypeALL</span><span class="op" id="8191784">,</span>&nbsp;<span class="ident" id="8191786">dnsRcodeNameError</span><span class="op" id="8191803">}</span><span class="op" id="8191804">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191807">{</span><span class="string" id="8191808">&#34;invalid.&#34;</span><span class="op" id="8191818">,</span>&nbsp;<span class="ident" id="8191820">dnsTypeALL</span><span class="op" id="8191830">,</span>&nbsp;<span class="ident" id="8191832">dnsRcodeNameError</span><span class="op" id="8191849">}</span><span class="op" id="8191850">,</span><br>
<span class="lineno"></span><span class="op" id="8191852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8191855">func</span>&nbsp;<span class="ident" id="8191860">TestSpecialDomainName</span><span class="op" id="8191881">(</span><span class="ident" id="8191882">t</span>&nbsp;<span class="op" id="8191884">*</span><span class="ident" id="8191885">testing</span><span class="op" id="8191892">.</span><span class="ident" id="8191893">T</span><span class="op" id="8191894">)</span>&nbsp;<span class="op" id="8191896">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8191899">if</span>&nbsp;<span class="ident" id="8191902">testing</span><span class="op" id="8191909">.</span><span class="ident" id="8191910">Short</span><span class="op" id="8191915">(</span><span class="op" id="8191916">)</span>&nbsp;<span class="op" id="8191918">||</span>&nbsp;<span class="op" id="8191921">!</span><span class="op" id="8191922">*</span><span class="ident" id="8191923">testExternal</span>&nbsp;<span class="op" id="8191936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191940">t</span><span class="op" id="8191941">.</span><span class="ident" id="8191942">Skip</span><span class="op" id="8191946">(</span><span class="string" id="8191947">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8191988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8191991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8191995">server</span>&nbsp;<span class="op" id="8192002">:=</span>&nbsp;<span class="string" id="8192005">&#34;8.8.8.8:53&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192019">for</span>&nbsp;<span class="ident" id="8192023">_</span><span class="op" id="8192024">,</span>&nbsp;<span class="ident" id="8192026">tt</span>&nbsp;<span class="op" id="8192029">:=</span>&nbsp;<span class="keyword" id="8192032">range</span>&nbsp;<span class="ident" id="8192038">specialDomainNameTests</span>&nbsp;<span class="op" id="8192061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192065">msg</span><span class="op" id="8192068">,</span>&nbsp;<span class="ident" id="8192070">err</span>&nbsp;<span class="op" id="8192074">:=</span>&nbsp;<span class="ident" id="8192077">exchange</span><span class="op" id="8192085">(</span><span class="ident" id="8192086">server</span><span class="op" id="8192092">,</span>&nbsp;<span class="ident" id="8192094">tt</span><span class="op" id="8192096">.</span><span class="ident" id="8192097">name</span><span class="op" id="8192101">,</span>&nbsp;<span class="ident" id="8192103">tt</span><span class="op" id="8192105">.</span><span class="ident" id="8192106">qtype</span><span class="op" id="8192111">,</span>&nbsp;<span class="num" id="8192113">0</span><span class="op" id="8192114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192118">if</span>&nbsp;<span class="ident" id="8192121">err</span>&nbsp;<span class="op" id="8192125">!=</span>&nbsp;<span class="ident" id="8192128">nil</span>&nbsp;<span class="op" id="8192132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192137">t</span><span class="op" id="8192138">.</span><span class="ident" id="8192139">Error</span><span class="op" id="8192144">(</span><span class="ident" id="8192145">err</span><span class="op" id="8192148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192153">continue</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192168">switch</span>&nbsp;<span class="ident" id="8192175">msg</span><span class="op" id="8192178">.</span><span class="ident" id="8192179">rcode</span>&nbsp;<span class="op" id="8192185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192189">case</span>&nbsp;<span class="ident" id="8192194">tt</span><span class="op" id="8192196">.</span><span class="ident" id="8192197">rcode</span><span class="op" id="8192202">,</span>&nbsp;<span class="ident" id="8192204">dnsRcodeServerFailure</span><span class="op" id="8192225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192229">default</span><span class="op" id="8192236">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192241">t</span><span class="op" id="8192242">.</span><span class="ident" id="8192243">Errorf</span><span class="op" id="8192249">(</span><span class="string" id="8192250">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8192275">,</span>&nbsp;<span class="ident" id="8192277">msg</span><span class="op" id="8192280">.</span><span class="ident" id="8192281">rcode</span><span class="op" id="8192286">,</span>&nbsp;<span class="ident" id="8192288">server</span><span class="op" id="8192294">,</span>&nbsp;<span class="ident" id="8192296">tt</span><span class="op" id="8192298">.</span><span class="ident" id="8192299">rcode</span><span class="op" id="8192304">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192309">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192323">}</span><br>
<span class="lineno"></span><span class="op" id="8192325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8192328">type</span>&nbsp;<span class="ident" id="8192333">resolvConfTest</span>&nbsp;<span class="keyword" id="8192348">struct</span>&nbsp;<span class="op" id="8192355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192358">*</span><span class="ident" id="8192359">testing</span><span class="op" id="8192366">.</span><span class="ident" id="8192367">T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192370">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8192378">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192386">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8192394">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192402">started</span>&nbsp;<span class="builtintype" id="8192410">bool</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192416">quitc</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="8192424">chan</span>&nbsp;<span class="keyword" id="8192429">chan</span>&nbsp;<span class="keyword" id="8192434">struct</span><span class="op" id="8192440">{</span><span class="op" id="8192441">}</span><br>
<span class="lineno"></span><span class="op" id="8192443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8192446">func</span>&nbsp;<span class="ident" id="8192451">newResolvConfTest</span><span class="op" id="8192468">(</span><span class="ident" id="8192469">t</span>&nbsp;<span class="op" id="8192471">*</span><span class="ident" id="8192472">testing</span><span class="op" id="8192479">.</span><span class="ident" id="8192480">T</span><span class="op" id="8192481">)</span>&nbsp;<span class="op" id="8192483">*</span><span class="ident" id="8192484">resolvConfTest</span>&nbsp;<span class="op" id="8192499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192502">dir</span><span class="op" id="8192505">,</span>&nbsp;<span class="ident" id="8192507">err</span>&nbsp;<span class="op" id="8192511">:=</span>&nbsp;<span class="ident" id="8192514">ioutil</span><span class="op" id="8192520">.</span><span class="ident" id="8192521">TempDir</span><span class="op" id="8192528">(</span><span class="string" id="8192529">&#34;&#34;</span><span class="op" id="8192531">,</span>&nbsp;<span class="string" id="8192533">&#34;resolvConfTest&#34;</span><span class="op" id="8192549">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192552">if</span>&nbsp;<span class="ident" id="8192555">err</span>&nbsp;<span class="op" id="8192559">!=</span>&nbsp;<span class="ident" id="8192562">nil</span>&nbsp;<span class="op" id="8192566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192570">t</span><span class="op" id="8192571">.</span><span class="ident" id="8192572">Fatalf</span><span class="op" id="8192578">(</span><span class="string" id="8192579">&#34;could&nbsp;not&nbsp;create&nbsp;temp&nbsp;dir:&nbsp;%v&#34;</span><span class="op" id="8192610">,</span>&nbsp;<span class="ident" id="8192612">err</span><span class="op" id="8192615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8192622">//&nbsp;Disable&nbsp;the&nbsp;default&nbsp;loadConfig</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192657">onceLoadConfig</span><span class="op" id="8192671">.</span><span class="ident" id="8192672">Do</span><span class="op" id="8192674">(</span><span class="keyword" id="8192675">func</span><span class="op" id="8192679">(</span><span class="op" id="8192680">)</span>&nbsp;<span class="op" id="8192682">{</span><span class="op" id="8192683">}</span><span class="op" id="8192684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192688">r</span>&nbsp;<span class="op" id="8192690">:=</span>&nbsp;<span class="op" id="8192693">&amp;</span><span class="ident" id="8192694">resolvConfTest</span><span class="op" id="8192708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192712">T</span><span class="op" id="8192713">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8192719">t</span><span class="op" id="8192720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192724">dir</span><span class="op" id="8192727">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8192731">dir</span><span class="op" id="8192734">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192738">path</span><span class="op" id="8192742">:</span>&nbsp;&nbsp;<span class="ident" id="8192745">path</span><span class="op" id="8192749">.</span><span class="ident" id="8192750">Join</span><span class="op" id="8192754">(</span><span class="ident" id="8192755">dir</span><span class="op" id="8192758">,</span>&nbsp;<span class="string" id="8192760">&#34;resolv.conf&#34;</span><span class="op" id="8192773">)</span><span class="op" id="8192774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192778">quitc</span><span class="op" id="8192783">:</span>&nbsp;<span class="builtinfunc" id="8192785">make</span><span class="op" id="8192789">(</span><span class="keyword" id="8192790">chan</span>&nbsp;<span class="keyword" id="8192795">chan</span>&nbsp;<span class="keyword" id="8192800">struct</span><span class="op" id="8192806">{</span><span class="op" id="8192807">}</span><span class="op" id="8192808">)</span><span class="op" id="8192809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8192812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8192816">return</span>&nbsp;<span class="ident" id="8192823">r</span><br>
<span class="lineno">120</span><span class="op" id="8192825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8192828">func</span>&nbsp;<span class="op" id="8192833">(</span><span class="ident" id="8192834">r</span>&nbsp;<span class="op" id="8192836">*</span><span class="ident" id="8192837">resolvConfTest</span><span class="op" id="8192851">)</span>&nbsp;<span class="ident" id="8192853">Start</span><span class="op" id="8192858">(</span><span class="op" id="8192859">)</span>&nbsp;<span class="op" id="8192861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192864">loadConfig</span><span class="op" id="8192874">(</span><span class="ident" id="8192875">r</span><span class="op" id="8192876">.</span><span class="ident" id="8192877">path</span><span class="op" id="8192881">,</span>&nbsp;<span class="num" id="8192883">100</span><span class="op" id="8192886">*</span><span class="ident" id="8192887">time</span><span class="op" id="8192891">.</span><span class="ident" id="8192892">Millisecond</span><span class="op" id="8192903">,</span>&nbsp;<span class="ident" id="8192905">r</span><span class="op" id="8192906">.</span><span class="ident" id="8192907">quitc</span><span class="op" id="8192912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8192915">r</span><span class="op" id="8192916">.</span><span class="ident" id="8192917">started</span>&nbsp;<span class="op" id="8192925">=</span>&nbsp;<span class="builtintype" id="8192927">true</span><br>
<span class="lineno">125</span><span class="op" id="8192932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8192935">func</span>&nbsp;<span class="op" id="8192940">(</span><span class="ident" id="8192941">r</span>&nbsp;<span class="op" id="8192943">*</span><span class="ident" id="8192944">resolvConfTest</span><span class="op" id="8192958">)</span>&nbsp;<span class="ident" id="8192960">SetConf</span><span class="op" id="8192967">(</span><span class="ident" id="8192968">s</span>&nbsp;<span class="builtintype" id="8192970">string</span><span class="op" id="8192976">)</span>&nbsp;<span class="op" id="8192978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8192981">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;file&nbsp;mtime&nbsp;will&nbsp;be&nbsp;different&nbsp;once&nbsp;we&#39;re&nbsp;done&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8193050">//&nbsp;even&nbsp;on&nbsp;systems&nbsp;with&nbsp;coarse&nbsp;(1s)&nbsp;mtime&nbsp;resolution.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193105">time</span><span class="op" id="8193109">.</span><span class="ident" id="8193110">Sleep</span><span class="op" id="8193115">(</span><span class="ident" id="8193116">time</span><span class="op" id="8193120">.</span><span class="ident" id="8193121">Second</span><span class="op" id="8193127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193131">f</span><span class="op" id="8193132">,</span>&nbsp;<span class="ident" id="8193134">err</span>&nbsp;<span class="op" id="8193138">:=</span>&nbsp;<span class="ident" id="8193141">os</span><span class="op" id="8193143">.</span><span class="ident" id="8193144">OpenFile</span><span class="op" id="8193152">(</span><span class="ident" id="8193153">r</span><span class="op" id="8193154">.</span><span class="ident" id="8193155">path</span><span class="op" id="8193159">,</span>&nbsp;<span class="ident" id="8193161">os</span><span class="op" id="8193163">.</span><span class="ident" id="8193164">O_CREATE</span><span class="op" id="8193172">|</span><span class="ident" id="8193173">os</span><span class="op" id="8193175">.</span><span class="ident" id="8193176">O_TRUNC</span><span class="op" id="8193183">|</span><span class="ident" id="8193184">os</span><span class="op" id="8193186">.</span><span class="ident" id="8193187">O_WRONLY</span><span class="op" id="8193195">,</span>&nbsp;<span class="num" id="8193197">0600</span><span class="op" id="8193201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193204">if</span>&nbsp;<span class="ident" id="8193207">err</span>&nbsp;<span class="op" id="8193211">!=</span>&nbsp;<span class="ident" id="8193214">nil</span>&nbsp;<span class="op" id="8193218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193222">r</span><span class="op" id="8193223">.</span><span class="ident" id="8193224">Fatalf</span><span class="op" id="8193230">(</span><span class="string" id="8193231">&#34;failed&nbsp;to&nbsp;create&nbsp;temp&nbsp;file&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8193266">,</span>&nbsp;<span class="ident" id="8193268">r</span><span class="op" id="8193269">.</span><span class="ident" id="8193270">path</span><span class="op" id="8193274">,</span>&nbsp;<span class="ident" id="8193276">err</span><span class="op" id="8193279">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193285">if</span>&nbsp;<span class="ident" id="8193288">_</span><span class="op" id="8193289">,</span>&nbsp;<span class="ident" id="8193291">err</span>&nbsp;<span class="op" id="8193295">:=</span>&nbsp;<span class="ident" id="8193298">io</span><span class="op" id="8193300">.</span><span class="ident" id="8193301">WriteString</span><span class="op" id="8193312">(</span><span class="ident" id="8193313">f</span><span class="op" id="8193314">,</span>&nbsp;<span class="ident" id="8193316">s</span><span class="op" id="8193317">)</span><span class="op" id="8193318">;</span>&nbsp;<span class="ident" id="8193320">err</span>&nbsp;<span class="op" id="8193324">!=</span>&nbsp;<span class="ident" id="8193327">nil</span>&nbsp;<span class="op" id="8193331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193335">f</span><span class="op" id="8193336">.</span><span class="ident" id="8193337">Close</span><span class="op" id="8193342">(</span><span class="op" id="8193343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193347">r</span><span class="op" id="8193348">.</span><span class="ident" id="8193349">Fatalf</span><span class="op" id="8193355">(</span><span class="string" id="8193356">&#34;failed&nbsp;to&nbsp;write&nbsp;temp&nbsp;file:&nbsp;%v&#34;</span><span class="op" id="8193387">,</span>&nbsp;<span class="ident" id="8193389">err</span><span class="op" id="8193392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193395">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193398">f</span><span class="op" id="8193399">.</span><span class="ident" id="8193400">Close</span><span class="op" id="8193405">(</span><span class="op" id="8193406">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193410">if</span>&nbsp;<span class="ident" id="8193413">r</span><span class="op" id="8193414">.</span><span class="ident" id="8193415">started</span>&nbsp;<span class="op" id="8193423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193427">cfg</span><span class="op" id="8193430">.</span><span class="ident" id="8193431">ch</span>&nbsp;<span class="op" id="8193434">&lt;-</span>&nbsp;<span class="keyword" id="8193437">struct</span><span class="op" id="8193443">{</span><span class="op" id="8193444">}</span><span class="op" id="8193445">{</span><span class="op" id="8193446">}</span>&nbsp;<span class="comment" id="8193448">//&nbsp;fill&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193465">cfg</span><span class="op" id="8193468">.</span><span class="ident" id="8193469">ch</span>&nbsp;<span class="op" id="8193472">&lt;-</span>&nbsp;<span class="keyword" id="8193475">struct</span><span class="op" id="8193481">{</span><span class="op" id="8193482">}</span><span class="op" id="8193483">{</span><span class="op" id="8193484">}</span>&nbsp;<span class="comment" id="8193486">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;begin</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193516">cfg</span><span class="op" id="8193519">.</span><span class="ident" id="8193520">ch</span>&nbsp;<span class="op" id="8193523">&lt;-</span>&nbsp;<span class="keyword" id="8193526">struct</span><span class="op" id="8193532">{</span><span class="op" id="8193533">}</span><span class="op" id="8193534">{</span><span class="op" id="8193535">}</span>&nbsp;<span class="comment" id="8193537">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;complete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193569">}</span><br>
<span class="lineno"></span><span class="op" id="8193571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8193574">func</span>&nbsp;<span class="op" id="8193579">(</span><span class="ident" id="8193580">r</span>&nbsp;<span class="op" id="8193582">*</span><span class="ident" id="8193583">resolvConfTest</span><span class="op" id="8193597">)</span>&nbsp;<span class="ident" id="8193599">WantServers</span><span class="op" id="8193610">(</span><span class="ident" id="8193611">want</span>&nbsp;<span class="op" id="8193616">[</span><span class="op" id="8193617">]</span><span class="builtintype" id="8193618">string</span><span class="op" id="8193624">)</span>&nbsp;<span class="op" id="8193626">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193629">cfg</span><span class="op" id="8193632">.</span><span class="ident" id="8193633">mu</span><span class="op" id="8193635">.</span><span class="ident" id="8193636">RLock</span><span class="op" id="8193641">(</span><span class="op" id="8193642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193645">defer</span>&nbsp;<span class="ident" id="8193651">cfg</span><span class="op" id="8193654">.</span><span class="ident" id="8193655">mu</span><span class="op" id="8193657">.</span><span class="ident" id="8193658">RUnlock</span><span class="op" id="8193665">(</span><span class="op" id="8193666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193669">if</span>&nbsp;<span class="ident" id="8193672">got</span>&nbsp;<span class="op" id="8193676">:=</span>&nbsp;<span class="ident" id="8193679">cfg</span><span class="op" id="8193682">.</span><span class="ident" id="8193683">dnsConfig</span><span class="op" id="8193692">.</span><span class="ident" id="8193693">servers</span><span class="op" id="8193700">;</span>&nbsp;<span class="op" id="8193702">!</span><span class="ident" id="8193703">reflect</span><span class="op" id="8193710">.</span><span class="ident" id="8193711">DeepEqual</span><span class="op" id="8193720">(</span><span class="ident" id="8193721">got</span><span class="op" id="8193724">,</span>&nbsp;<span class="ident" id="8193726">want</span><span class="op" id="8193730">)</span>&nbsp;<span class="op" id="8193732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193736">r</span><span class="op" id="8193737">.</span><span class="ident" id="8193738">Fatalf</span><span class="op" id="8193744">(</span><span class="string" id="8193745">&#34;Unexpected&nbsp;dns&nbsp;server&nbsp;loaded,&nbsp;got&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8193791">,</span>&nbsp;<span class="ident" id="8193793">got</span><span class="op" id="8193796">,</span>&nbsp;<span class="ident" id="8193798">want</span><span class="op" id="8193802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193805">}</span><br>
<span class="lineno">155</span><span class="op" id="8193807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8193810">func</span>&nbsp;<span class="op" id="8193815">(</span><span class="ident" id="8193816">r</span>&nbsp;<span class="op" id="8193818">*</span><span class="ident" id="8193819">resolvConfTest</span><span class="op" id="8193833">)</span>&nbsp;<span class="ident" id="8193835">Close</span><span class="op" id="8193840">(</span><span class="op" id="8193841">)</span>&nbsp;<span class="op" id="8193843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193846">resp</span>&nbsp;<span class="op" id="8193851">:=</span>&nbsp;<span class="builtinfunc" id="8193854">make</span><span class="op" id="8193858">(</span><span class="keyword" id="8193859">chan</span>&nbsp;<span class="keyword" id="8193864">struct</span><span class="op" id="8193870">{</span><span class="op" id="8193871">}</span><span class="op" id="8193872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193875">r</span><span class="op" id="8193876">.</span><span class="ident" id="8193877">quitc</span>&nbsp;<span class="op" id="8193883">&lt;-</span>&nbsp;<span class="ident" id="8193886">resp</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8193892">&lt;-</span><span class="ident" id="8193894">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8193900">if</span>&nbsp;<span class="ident" id="8193903">err</span>&nbsp;<span class="op" id="8193907">:=</span>&nbsp;<span class="ident" id="8193910">os</span><span class="op" id="8193912">.</span><span class="ident" id="8193913">RemoveAll</span><span class="op" id="8193922">(</span><span class="ident" id="8193923">r</span><span class="op" id="8193924">.</span><span class="ident" id="8193925">dir</span><span class="op" id="8193928">)</span><span class="op" id="8193929">;</span>&nbsp;<span class="ident" id="8193931">err</span>&nbsp;<span class="op" id="8193935">!=</span>&nbsp;<span class="ident" id="8193938">nil</span>&nbsp;<span class="op" id="8193942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8193946">r</span><span class="op" id="8193947">.</span><span class="ident" id="8193948">Logf</span><span class="op" id="8193952">(</span><span class="string" id="8193953">&#34;failed&nbsp;to&nbsp;remove&nbsp;temp&nbsp;dir&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8193987">,</span>&nbsp;<span class="ident" id="8193989">r</span><span class="op" id="8193990">.</span><span class="ident" id="8193991">dir</span><span class="op" id="8193994">,</span>&nbsp;<span class="ident" id="8193996">err</span><span class="op" id="8193999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194002">}</span><br>
<span class="lineno"></span><span class="op" id="8194004">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="8194007">func</span>&nbsp;<span class="ident" id="8194012">TestReloadResolvConfFail</span><span class="op" id="8194036">(</span><span class="ident" id="8194037">t</span>&nbsp;<span class="op" id="8194039">*</span><span class="ident" id="8194040">testing</span><span class="op" id="8194047">.</span><span class="ident" id="8194048">T</span><span class="op" id="8194049">)</span>&nbsp;<span class="op" id="8194051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194054">if</span>&nbsp;<span class="ident" id="8194057">testing</span><span class="op" id="8194064">.</span><span class="ident" id="8194065">Short</span><span class="op" id="8194070">(</span><span class="op" id="8194071">)</span>&nbsp;<span class="op" id="8194073">||</span>&nbsp;<span class="op" id="8194076">!</span><span class="op" id="8194077">*</span><span class="ident" id="8194078">testExternal</span>&nbsp;<span class="op" id="8194091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194095">t</span><span class="op" id="8194096">.</span><span class="ident" id="8194097">Skip</span><span class="op" id="8194101">(</span><span class="string" id="8194102">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8194143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194146">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194150">r</span>&nbsp;<span class="op" id="8194152">:=</span>&nbsp;<span class="ident" id="8194155">newResolvConfTest</span><span class="op" id="8194172">(</span><span class="ident" id="8194173">t</span><span class="op" id="8194174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194177">defer</span>&nbsp;<span class="ident" id="8194183">r</span><span class="op" id="8194184">.</span><span class="ident" id="8194185">Close</span><span class="op" id="8194190">(</span><span class="op" id="8194191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8194195">//&nbsp;resolv.conf.tmp&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194234">r</span><span class="op" id="8194235">.</span><span class="ident" id="8194236">Start</span><span class="op" id="8194241">(</span><span class="op" id="8194242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194245">if</span>&nbsp;<span class="ident" id="8194248">_</span><span class="op" id="8194249">,</span>&nbsp;<span class="ident" id="8194251">err</span>&nbsp;<span class="op" id="8194255">:=</span>&nbsp;<span class="ident" id="8194258">goLookupIP</span><span class="op" id="8194268">(</span><span class="string" id="8194269">&#34;golang.org&#34;</span><span class="op" id="8194281">)</span><span class="op" id="8194282">;</span>&nbsp;<span class="ident" id="8194284">err</span>&nbsp;<span class="op" id="8194288">==</span>&nbsp;<span class="ident" id="8194291">nil</span>&nbsp;<span class="op" id="8194295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194299">t</span><span class="op" id="8194300">.</span><span class="ident" id="8194301">Fatal</span><span class="op" id="8194306">(</span><span class="string" id="8194307">&#34;goLookupIP(missing)&nbsp;succeeded&#34;</span><span class="op" id="8194338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194345">r</span><span class="op" id="8194346">.</span><span class="ident" id="8194347">SetConf</span><span class="op" id="8194354">(</span><span class="string" id="8194355">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="8194375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194378">if</span>&nbsp;<span class="ident" id="8194381">_</span><span class="op" id="8194382">,</span>&nbsp;<span class="ident" id="8194384">err</span>&nbsp;<span class="op" id="8194388">:=</span>&nbsp;<span class="ident" id="8194391">goLookupIP</span><span class="op" id="8194401">(</span><span class="string" id="8194402">&#34;golang.org&#34;</span><span class="op" id="8194414">)</span><span class="op" id="8194415">;</span>&nbsp;<span class="ident" id="8194417">err</span>&nbsp;<span class="op" id="8194421">!=</span>&nbsp;<span class="ident" id="8194424">nil</span>&nbsp;<span class="op" id="8194428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194432">t</span><span class="op" id="8194433">.</span><span class="ident" id="8194434">Fatalf</span><span class="op" id="8194440">(</span><span class="string" id="8194441">&#34;goLookupIP(missing;&nbsp;good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8194479">,</span>&nbsp;<span class="ident" id="8194481">err</span><span class="op" id="8194484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8194491">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;while&nbsp;we&nbsp;had&nbsp;a&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8194539">//&nbsp;one&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194583">r</span><span class="op" id="8194584">.</span><span class="ident" id="8194585">SetConf</span><span class="op" id="8194592">(</span><span class="string" id="8194593">&#34;&#34;</span><span class="op" id="8194595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194598">if</span>&nbsp;<span class="ident" id="8194601">_</span><span class="op" id="8194602">,</span>&nbsp;<span class="ident" id="8194604">err</span>&nbsp;<span class="op" id="8194608">:=</span>&nbsp;<span class="ident" id="8194611">goLookupIP</span><span class="op" id="8194621">(</span><span class="string" id="8194622">&#34;golang.org&#34;</span><span class="op" id="8194634">)</span><span class="op" id="8194635">;</span>&nbsp;<span class="ident" id="8194637">err</span>&nbsp;<span class="op" id="8194641">!=</span>&nbsp;<span class="ident" id="8194644">nil</span>&nbsp;<span class="op" id="8194648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194652">t</span><span class="op" id="8194653">.</span><span class="ident" id="8194654">Fatalf</span><span class="op" id="8194660">(</span><span class="string" id="8194661">&#34;goLookupIP(missing;&nbsp;good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8194704">,</span>&nbsp;<span class="ident" id="8194706">err</span><span class="op" id="8194709">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194712">}</span><br>
<span class="lineno"></span><span class="op" id="8194714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8194717">func</span>&nbsp;<span class="ident" id="8194722">TestReloadResolvConfChange</span><span class="op" id="8194748">(</span><span class="ident" id="8194749">t</span>&nbsp;<span class="op" id="8194751">*</span><span class="ident" id="8194752">testing</span><span class="op" id="8194759">.</span><span class="ident" id="8194760">T</span><span class="op" id="8194761">)</span>&nbsp;<span class="op" id="8194763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194766">if</span>&nbsp;<span class="ident" id="8194769">testing</span><span class="op" id="8194776">.</span><span class="ident" id="8194777">Short</span><span class="op" id="8194782">(</span><span class="op" id="8194783">)</span>&nbsp;<span class="op" id="8194785">||</span>&nbsp;<span class="op" id="8194788">!</span><span class="op" id="8194789">*</span><span class="ident" id="8194790">testExternal</span>&nbsp;<span class="op" id="8194803">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194807">t</span><span class="op" id="8194808">.</span><span class="ident" id="8194809">Skip</span><span class="op" id="8194813">(</span><span class="string" id="8194814">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8194855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8194858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194862">r</span>&nbsp;<span class="op" id="8194864">:=</span>&nbsp;<span class="ident" id="8194867">newResolvConfTest</span><span class="op" id="8194884">(</span><span class="ident" id="8194885">t</span><span class="op" id="8194886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194889">defer</span>&nbsp;<span class="ident" id="8194895">r</span><span class="op" id="8194896">.</span><span class="ident" id="8194897">Close</span><span class="op" id="8194902">(</span><span class="op" id="8194903">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194907">r</span><span class="op" id="8194908">.</span><span class="ident" id="8194909">SetConf</span><span class="op" id="8194916">(</span><span class="string" id="8194917">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="8194937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8194940">r</span><span class="op" id="8194941">.</span><span class="ident" id="8194942">Start</span><span class="op" id="8194947">(</span><span class="op" id="8194948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8194952">if</span>&nbsp;<span class="ident" id="8194955">_</span><span class="op" id="8194956">,</span>&nbsp;<span class="ident" id="8194958">err</span>&nbsp;<span class="op" id="8194962">:=</span>&nbsp;<span class="ident" id="8194965">goLookupIP</span><span class="op" id="8194975">(</span><span class="string" id="8194976">&#34;golang.org&#34;</span><span class="op" id="8194988">)</span><span class="op" id="8194989">;</span>&nbsp;<span class="ident" id="8194991">err</span>&nbsp;<span class="op" id="8194995">!=</span>&nbsp;<span class="ident" id="8194998">nil</span>&nbsp;<span class="op" id="8195002">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195006">t</span><span class="op" id="8195007">.</span><span class="ident" id="8195008">Fatalf</span><span class="op" id="8195014">(</span><span class="string" id="8195015">&#34;goLookupIP(good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8195044">,</span>&nbsp;<span class="ident" id="8195046">err</span><span class="op" id="8195049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195055">r</span><span class="op" id="8195056">.</span><span class="ident" id="8195057">WantServers</span><span class="op" id="8195068">(</span><span class="op" id="8195069">[</span><span class="op" id="8195070">]</span><span class="builtintype" id="8195071">string</span><span class="op" id="8195077">{</span><span class="string" id="8195078">&#34;8.8.8.8&#34;</span><span class="op" id="8195087">}</span><span class="op" id="8195088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8195092">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;when&nbsp;we&nbsp;had&nbsp;a&nbsp;good&nbsp;one</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8195143">//&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195183">r</span><span class="op" id="8195184">.</span><span class="ident" id="8195185">SetConf</span><span class="op" id="8195192">(</span><span class="string" id="8195193">&#34;&#34;</span><span class="op" id="8195195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195198">if</span>&nbsp;<span class="ident" id="8195201">_</span><span class="op" id="8195202">,</span>&nbsp;<span class="ident" id="8195204">err</span>&nbsp;<span class="op" id="8195208">:=</span>&nbsp;<span class="ident" id="8195211">goLookupIP</span><span class="op" id="8195221">(</span><span class="string" id="8195222">&#34;golang.org&#34;</span><span class="op" id="8195234">)</span><span class="op" id="8195235">;</span>&nbsp;<span class="ident" id="8195237">err</span>&nbsp;<span class="op" id="8195241">!=</span>&nbsp;<span class="ident" id="8195244">nil</span>&nbsp;<span class="op" id="8195248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195252">t</span><span class="op" id="8195253">.</span><span class="ident" id="8195254">Fatalf</span><span class="op" id="8195260">(</span><span class="string" id="8195261">&#34;goLookupIP(good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8195295">,</span>&nbsp;<span class="ident" id="8195297">err</span><span class="op" id="8195300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195303">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8195307">//&nbsp;A&nbsp;new&nbsp;good&nbsp;config&nbsp;should&nbsp;get&nbsp;picked&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195350">r</span><span class="op" id="8195351">.</span><span class="ident" id="8195352">SetConf</span><span class="op" id="8195359">(</span><span class="string" id="8195360">&#34;nameserver&nbsp;8.8.4.4&#34;</span><span class="op" id="8195380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195383">r</span><span class="op" id="8195384">.</span><span class="ident" id="8195385">WantServers</span><span class="op" id="8195396">(</span><span class="op" id="8195397">[</span><span class="op" id="8195398">]</span><span class="builtintype" id="8195399">string</span><span class="op" id="8195405">{</span><span class="string" id="8195406">&#34;8.8.4.4&#34;</span><span class="op" id="8195415">}</span><span class="op" id="8195416">)</span><br>
<span class="lineno"></span><span class="op" id="8195418">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="8195421">func</span>&nbsp;<span class="ident" id="8195426">BenchmarkGoLookupIP</span><span class="op" id="8195445">(</span><span class="ident" id="8195446">b</span>&nbsp;<span class="op" id="8195448">*</span><span class="ident" id="8195449">testing</span><span class="op" id="8195456">.</span><span class="ident" id="8195457">B</span><span class="op" id="8195458">)</span>&nbsp;<span class="op" id="8195460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195463">for</span>&nbsp;<span class="ident" id="8195467">i</span>&nbsp;<span class="op" id="8195469">:=</span>&nbsp;<span class="num" id="8195472">0</span><span class="op" id="8195473">;</span>&nbsp;<span class="ident" id="8195475">i</span>&nbsp;<span class="op" id="8195477">&lt;</span>&nbsp;<span class="ident" id="8195479">b</span><span class="op" id="8195480">.</span><span class="ident" id="8195481">N</span><span class="op" id="8195482">;</span>&nbsp;<span class="ident" id="8195484">i</span><span class="op" id="8195485">++</span>&nbsp;<span class="op" id="8195488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195492">goLookupIP</span><span class="op" id="8195502">(</span><span class="string" id="8195503">&#34;www.example.com&#34;</span><span class="op" id="8195520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195523">}</span><br>
<span class="lineno">225</span><span class="op" id="8195525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8195528">func</span>&nbsp;<span class="ident" id="8195533">BenchmarkGoLookupIPNoSuchHost</span><span class="op" id="8195562">(</span><span class="ident" id="8195563">b</span>&nbsp;<span class="op" id="8195565">*</span><span class="ident" id="8195566">testing</span><span class="op" id="8195573">.</span><span class="ident" id="8195574">B</span><span class="op" id="8195575">)</span>&nbsp;<span class="op" id="8195577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195580">for</span>&nbsp;<span class="ident" id="8195584">i</span>&nbsp;<span class="op" id="8195586">:=</span>&nbsp;<span class="num" id="8195589">0</span><span class="op" id="8195590">;</span>&nbsp;<span class="ident" id="8195592">i</span>&nbsp;<span class="op" id="8195594">&lt;</span>&nbsp;<span class="ident" id="8195596">b</span><span class="op" id="8195597">.</span><span class="ident" id="8195598">N</span><span class="op" id="8195599">;</span>&nbsp;<span class="ident" id="8195601">i</span><span class="op" id="8195602">++</span>&nbsp;<span class="op" id="8195605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195609">goLookupIP</span><span class="op" id="8195619">(</span><span class="string" id="8195620">&#34;some.nonexistent&#34;</span><span class="op" id="8195638">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195641">}</span><br>
<span class="lineno"></span><span class="op" id="8195643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8195646">func</span>&nbsp;<span class="ident" id="8195651">BenchmarkGoLookupIPWithBrokenNameServer</span><span class="op" id="8195690">(</span><span class="ident" id="8195691">b</span>&nbsp;<span class="op" id="8195693">*</span><span class="ident" id="8195694">testing</span><span class="op" id="8195701">.</span><span class="ident" id="8195702">B</span><span class="op" id="8195703">)</span>&nbsp;<span class="op" id="8195705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195708">onceLoadConfig</span><span class="op" id="8195722">.</span><span class="ident" id="8195723">Do</span><span class="op" id="8195725">(</span><span class="ident" id="8195726">loadDefaultConfig</span><span class="op" id="8195743">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8195746">if</span>&nbsp;<span class="ident" id="8195749">cfg</span><span class="op" id="8195752">.</span><span class="ident" id="8195753">dnserr</span>&nbsp;<span class="op" id="8195760">!=</span>&nbsp;<span class="ident" id="8195763">nil</span>&nbsp;<span class="op" id="8195767">||</span>&nbsp;<span class="ident" id="8195770">cfg</span><span class="op" id="8195773">.</span><span class="ident" id="8195774">dnsConfig</span>&nbsp;<span class="op" id="8195784">==</span>&nbsp;<span class="ident" id="8195787">nil</span>&nbsp;<span class="op" id="8195791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195795">b</span><span class="op" id="8195796">.</span><span class="ident" id="8195797">Fatalf</span><span class="op" id="8195803">(</span><span class="string" id="8195804">&#34;loadConfig&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8195827">,</span>&nbsp;<span class="ident" id="8195829">cfg</span><span class="op" id="8195832">.</span><span class="ident" id="8195833">dnserr</span><span class="op" id="8195839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8195842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8195845">//&nbsp;This&nbsp;looks&nbsp;ugly&nbsp;but&nbsp;it&#39;s&nbsp;safe&nbsp;as&nbsp;long&nbsp;as&nbsp;benchmarks&nbsp;are&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8195909">//&nbsp;sequentially&nbsp;in&nbsp;package&nbsp;testing.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195946">orig</span>&nbsp;<span class="op" id="8195951">:=</span>&nbsp;<span class="ident" id="8195954">cfg</span><span class="op" id="8195957">.</span><span class="ident" id="8195958">dnsConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8195969">cfg</span><span class="op" id="8195972">.</span><span class="ident" id="8195973">dnsConfig</span><span class="op" id="8195982">.</span><span class="ident" id="8195983">servers</span>&nbsp;<span class="op" id="8195991">=</span>&nbsp;<span class="builtinfunc" id="8195993">append</span><span class="op" id="8195999">(</span><span class="op" id="8196000">[</span><span class="op" id="8196001">]</span><span class="builtintype" id="8196002">string</span><span class="op" id="8196008">{</span><span class="string" id="8196009">&#34;203.0.113.254&#34;</span><span class="op" id="8196024">}</span><span class="op" id="8196025">,</span>&nbsp;<span class="ident" id="8196027">cfg</span><span class="op" id="8196030">.</span><span class="ident" id="8196031">dnsConfig</span><span class="op" id="8196040">.</span><span class="ident" id="8196041">servers</span><span class="op" id="8196048">...</span><span class="op" id="8196051">)</span>&nbsp;<span class="comment" id="8196053">//&nbsp;use&nbsp;TEST-NET-3&nbsp;block,&nbsp;see&nbsp;RFC&nbsp;5737</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8196092">for</span>&nbsp;<span class="ident" id="8196096">i</span>&nbsp;<span class="op" id="8196098">:=</span>&nbsp;<span class="num" id="8196101">0</span><span class="op" id="8196102">;</span>&nbsp;<span class="ident" id="8196104">i</span>&nbsp;<span class="op" id="8196106">&lt;</span>&nbsp;<span class="ident" id="8196108">b</span><span class="op" id="8196109">.</span><span class="ident" id="8196110">N</span><span class="op" id="8196111">;</span>&nbsp;<span class="ident" id="8196113">i</span><span class="op" id="8196114">++</span>&nbsp;<span class="op" id="8196117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196121">goLookupIP</span><span class="op" id="8196131">(</span><span class="string" id="8196132">&#34;www.example.com&#34;</span><span class="op" id="8196149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8196152">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8196155">cfg</span><span class="op" id="8196158">.</span><span class="ident" id="8196159">dnsConfig</span>&nbsp;<span class="op" id="8196169">=</span>&nbsp;<span class="ident" id="8196171">orig</span><br>
<span class="lineno"></span><span class="op" id="8196176">}</span>
</div>
</body>
</html>
