<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html" class="current">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7323758">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7323813">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7323867">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7323918">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7323944">package</span>&nbsp;<span class="ident" id="7323952">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7323957">import</span>&nbsp;<span class="op" id="7323964">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7323967">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7323976">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7323983">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7323989">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7323996">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324008">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324029">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324035">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324046">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324063">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324074">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324085">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324096">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7324107">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7324114">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="7324117">func</span>&nbsp;<span class="ident" id="7324122">newRequest</span><span class="op" id="7324132">(</span><span class="ident" id="7324133">httpreq</span>&nbsp;<span class="builtintype" id="7324141">string</span><span class="op" id="7324147">)</span>&nbsp;<span class="op" id="7324149">*</span><span class="ident" id="7324150">http</span><span class="op" id="7324154">.</span><span class="ident" id="7324155">Request</span>&nbsp;<span class="op" id="7324163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324166">buf</span>&nbsp;<span class="op" id="7324170">:=</span>&nbsp;<span class="ident" id="7324173">bufio</span><span class="op" id="7324178">.</span><span class="ident" id="7324179">NewReader</span><span class="op" id="7324188">(</span><span class="ident" id="7324189">strings</span><span class="op" id="7324196">.</span><span class="ident" id="7324197">NewReader</span><span class="op" id="7324206">(</span><span class="ident" id="7324207">httpreq</span><span class="op" id="7324214">)</span><span class="op" id="7324215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324218">req</span><span class="op" id="7324221">,</span>&nbsp;<span class="ident" id="7324223">err</span>&nbsp;<span class="op" id="7324227">:=</span>&nbsp;<span class="ident" id="7324230">http</span><span class="op" id="7324234">.</span><span class="ident" id="7324235">ReadRequest</span><span class="op" id="7324246">(</span><span class="ident" id="7324247">buf</span><span class="op" id="7324250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324253">if</span>&nbsp;<span class="ident" id="7324256">err</span>&nbsp;<span class="op" id="7324260">!=</span>&nbsp;<span class="builtintype" id="7324263">nil</span>&nbsp;<span class="op" id="7324267">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7324271">panic</span><span class="op" id="7324276">(</span><span class="string" id="7324277">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="7324313">+</span>&nbsp;<span class="ident" id="7324315">httpreq</span><span class="op" id="7324322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7324325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324328">req</span><span class="op" id="7324331">.</span><span class="ident" id="7324332">RemoteAddr</span>&nbsp;<span class="op" id="7324343">=</span>&nbsp;<span class="string" id="7324345">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324356">return</span>&nbsp;<span class="ident" id="7324363">req</span><br>
<span class="lineno"></span><span class="op" id="7324367">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="7324370">func</span>&nbsp;<span class="ident" id="7324375">runCgiTest</span><span class="op" id="7324385">(</span><span class="ident" id="7324386">t</span>&nbsp;<span class="op" id="7324388">*</span><span class="ident" id="7324389">testing</span><span class="op" id="7324396">.</span><span class="ident" id="7324397">T</span><span class="op" id="7324398">,</span>&nbsp;<span class="ident" id="7324400">h</span>&nbsp;<span class="op" id="7324402">*</span><span class="ident" id="7324403">Handler</span><span class="op" id="7324410">,</span>&nbsp;<span class="ident" id="7324412">httpreq</span>&nbsp;<span class="builtintype" id="7324420">string</span><span class="op" id="7324426">,</span>&nbsp;<span class="ident" id="7324428">expectedMap</span>&nbsp;<span class="keyword" id="7324440">map</span><span class="op" id="7324443">[</span><span class="builtintype" id="7324444">string</span><span class="op" id="7324450">]</span><span class="builtintype" id="7324451">string</span><span class="op" id="7324457">)</span>&nbsp;<span class="op" id="7324459">*</span><span class="ident" id="7324460">httptest</span><span class="op" id="7324468">.</span><span class="ident" id="7324469">ResponseRecorder</span>&nbsp;<span class="op" id="7324486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324489">rw</span>&nbsp;<span class="op" id="7324492">:=</span>&nbsp;<span class="ident" id="7324495">httptest</span><span class="op" id="7324503">.</span><span class="ident" id="7324504">NewRecorder</span><span class="op" id="7324515">(</span><span class="op" id="7324516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324519">req</span>&nbsp;<span class="op" id="7324523">:=</span>&nbsp;<span class="ident" id="7324526">newRequest</span><span class="op" id="7324536">(</span><span class="ident" id="7324537">httpreq</span><span class="op" id="7324544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324547">h</span><span class="op" id="7324548">.</span><span class="ident" id="7324549">ServeHTTP</span><span class="op" id="7324558">(</span><span class="ident" id="7324559">rw</span><span class="op" id="7324561">,</span>&nbsp;<span class="ident" id="7324563">req</span><span class="op" id="7324566">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7324570">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324628">m</span>&nbsp;<span class="op" id="7324630">:=</span>&nbsp;<span class="builtinfunc" id="7324633">make</span><span class="op" id="7324637">(</span><span class="keyword" id="7324638">map</span><span class="op" id="7324641">[</span><span class="builtintype" id="7324642">string</span><span class="op" id="7324648">]</span><span class="builtintype" id="7324649">string</span><span class="op" id="7324655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324658">m</span><span class="op" id="7324659">[</span><span class="string" id="7324660">&#34;_body&#34;</span><span class="op" id="7324667">]</span>&nbsp;<span class="op" id="7324669">=</span>&nbsp;<span class="ident" id="7324671">rw</span><span class="op" id="7324673">.</span><span class="ident" id="7324674">Body</span><span class="op" id="7324678">.</span><span class="ident" id="7324679">String</span><span class="op" id="7324685">(</span><span class="op" id="7324686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324689">linesRead</span>&nbsp;<span class="op" id="7324699">:=</span>&nbsp;<span class="num" id="7324702">0</span><br>
<span class="lineno">45</span><span class="ident" id="7324704">readlines</span><span class="op" id="7324713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324716">for</span>&nbsp;<span class="op" id="7324720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324724">line</span><span class="op" id="7324728">,</span>&nbsp;<span class="ident" id="7324730">err</span>&nbsp;<span class="op" id="7324734">:=</span>&nbsp;<span class="ident" id="7324737">rw</span><span class="op" id="7324739">.</span><span class="ident" id="7324740">Body</span><span class="op" id="7324744">.</span><span class="ident" id="7324745">ReadString</span><span class="op" id="7324755">(</span><span class="string" id="7324756">&#39;\n&#39;</span><span class="op" id="7324760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324764">switch</span>&nbsp;<span class="op" id="7324771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324775">case</span>&nbsp;<span class="ident" id="7324780">err</span>&nbsp;<span class="op" id="7324784">==</span>&nbsp;<span class="ident" id="7324787">io</span><span class="op" id="7324789">.</span><span class="ident" id="7324790">EOF</span><span class="op" id="7324793">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324798">break</span>&nbsp;<span class="ident" id="7324804">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7324816">case</span>&nbsp;<span class="ident" id="7324821">err</span>&nbsp;<span class="op" id="7324825">!=</span>&nbsp;<span class="builtintype" id="7324828">nil</span><span class="op" id="7324831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324836">t</span><span class="op" id="7324837">.</span><span class="ident" id="7324838">Fatalf</span><span class="op" id="7324844">(</span><span class="string" id="7324845">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="7324884">,</span>&nbsp;<span class="ident" id="7324886">err</span><span class="op" id="7324889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7324893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324897">linesRead</span><span class="op" id="7324906">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324911">trimmedLine</span>&nbsp;<span class="op" id="7324923">:=</span>&nbsp;<span class="ident" id="7324926">strings</span><span class="op" id="7324933">.</span><span class="ident" id="7324934">TrimRight</span><span class="op" id="7324943">(</span><span class="ident" id="7324944">line</span><span class="op" id="7324948">,</span>&nbsp;<span class="string" id="7324950">&#34;\r\n&#34;</span><span class="op" id="7324956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7324960">split</span>&nbsp;<span class="op" id="7324966">:=</span>&nbsp;<span class="ident" id="7324969">strings</span><span class="op" id="7324976">.</span><span class="ident" id="7324977">SplitN</span><span class="op" id="7324983">(</span><span class="ident" id="7324984">trimmedLine</span><span class="op" id="7324995">,</span>&nbsp;<span class="string" id="7324997">&#34;=&#34;</span><span class="op" id="7325000">,</span>&nbsp;<span class="num" id="7325002">2</span><span class="op" id="7325003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325007">if</span>&nbsp;<span class="builtinfunc" id="7325010">len</span><span class="op" id="7325013">(</span><span class="ident" id="7325014">split</span><span class="op" id="7325019">)</span>&nbsp;<span class="op" id="7325021">!=</span>&nbsp;<span class="num" id="7325024">2</span>&nbsp;<span class="op" id="7325026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325031">t</span><span class="op" id="7325032">.</span><span class="ident" id="7325033">Fatalf</span><span class="op" id="7325039">(</span><span class="string" id="7325040">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="7325110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7325116">len</span><span class="op" id="7325119">(</span><span class="ident" id="7325120">split</span><span class="op" id="7325125">)</span><span class="op" id="7325126">,</span>&nbsp;<span class="ident" id="7325128">linesRead</span><span class="op" id="7325137">,</span>&nbsp;<span class="ident" id="7325139">line</span><span class="op" id="7325143">,</span>&nbsp;<span class="ident" id="7325145">m</span><span class="op" id="7325146">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325154">m</span><span class="op" id="7325155">[</span><span class="ident" id="7325156">split</span><span class="op" id="7325161">[</span><span class="num" id="7325162">0</span><span class="op" id="7325163">]</span><span class="op" id="7325164">]</span>&nbsp;<span class="op" id="7325166">=</span>&nbsp;<span class="ident" id="7325168">split</span><span class="op" id="7325173">[</span><span class="num" id="7325174">1</span><span class="op" id="7325175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325182">for</span>&nbsp;<span class="ident" id="7325186">key</span><span class="op" id="7325189">,</span>&nbsp;<span class="ident" id="7325191">expected</span>&nbsp;<span class="op" id="7325200">:=</span>&nbsp;<span class="keyword" id="7325203">range</span>&nbsp;<span class="ident" id="7325209">expectedMap</span>&nbsp;<span class="op" id="7325221">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325225">got</span>&nbsp;<span class="op" id="7325229">:=</span>&nbsp;<span class="ident" id="7325232">m</span><span class="op" id="7325233">[</span><span class="ident" id="7325234">key</span><span class="op" id="7325237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325241">if</span>&nbsp;<span class="ident" id="7325244">key</span>&nbsp;<span class="op" id="7325248">==</span>&nbsp;<span class="string" id="7325251">&#34;cwd&#34;</span>&nbsp;<span class="op" id="7325257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7325262">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325304">fi1</span><span class="op" id="7325307">,</span>&nbsp;<span class="ident" id="7325309">_</span>&nbsp;<span class="op" id="7325311">:=</span>&nbsp;<span class="ident" id="7325314">os</span><span class="op" id="7325316">.</span><span class="ident" id="7325317">Stat</span><span class="op" id="7325321">(</span><span class="ident" id="7325322">got</span><span class="op" id="7325325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325330">fi2</span><span class="op" id="7325333">,</span>&nbsp;<span class="ident" id="7325335">_</span>&nbsp;<span class="op" id="7325337">:=</span>&nbsp;<span class="ident" id="7325340">os</span><span class="op" id="7325342">.</span><span class="ident" id="7325343">Stat</span><span class="op" id="7325347">(</span><span class="ident" id="7325348">expected</span><span class="op" id="7325356">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325361">if</span>&nbsp;<span class="ident" id="7325364">os</span><span class="op" id="7325366">.</span><span class="ident" id="7325367">SameFile</span><span class="op" id="7325375">(</span><span class="ident" id="7325376">fi1</span><span class="op" id="7325379">,</span>&nbsp;<span class="ident" id="7325381">fi2</span><span class="op" id="7325384">)</span>&nbsp;<span class="op" id="7325386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325392">got</span>&nbsp;<span class="op" id="7325396">=</span>&nbsp;<span class="ident" id="7325398">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325418">if</span>&nbsp;<span class="ident" id="7325421">got</span>&nbsp;<span class="op" id="7325425">!=</span>&nbsp;<span class="ident" id="7325428">expected</span>&nbsp;<span class="op" id="7325437">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325442">t</span><span class="op" id="7325443">.</span><span class="ident" id="7325444">Errorf</span><span class="op" id="7325450">(</span><span class="string" id="7325451">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7325483">,</span>&nbsp;<span class="ident" id="7325485">key</span><span class="op" id="7325488">,</span>&nbsp;<span class="ident" id="7325490">got</span><span class="op" id="7325493">,</span>&nbsp;<span class="ident" id="7325495">expected</span><span class="op" id="7325503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325513">return</span>&nbsp;<span class="ident" id="7325520">rw</span><br>
<span class="lineno"></span><span class="op" id="7325523">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7325526">var</span>&nbsp;<span class="ident" id="7325530">cgiTested</span><span class="op" id="7325539">,</span>&nbsp;<span class="ident" id="7325541">cgiWorks</span>&nbsp;<span class="builtintype" id="7325550">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7325556">func</span>&nbsp;<span class="ident" id="7325561">check</span><span class="op" id="7325566">(</span><span class="ident" id="7325567">t</span>&nbsp;<span class="op" id="7325569">*</span><span class="ident" id="7325570">testing</span><span class="op" id="7325577">.</span><span class="ident" id="7325578">T</span><span class="op" id="7325579">)</span>&nbsp;<span class="op" id="7325581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325584">if</span>&nbsp;<span class="op" id="7325587">!</span><span class="ident" id="7325588">cgiTested</span>&nbsp;<span class="op" id="7325598">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325602">cgiTested</span>&nbsp;<span class="op" id="7325612">=</span>&nbsp;<span class="builtintype" id="7325614">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325621">cgiWorks</span>&nbsp;<span class="op" id="7325630">=</span>&nbsp;<span class="ident" id="7325632">exec</span><span class="op" id="7325636">.</span><span class="ident" id="7325637">Command</span><span class="op" id="7325644">(</span><span class="string" id="7325645">&#34;./testdata/test.cgi&#34;</span><span class="op" id="7325666">)</span><span class="op" id="7325667">.</span><span class="ident" id="7325668">Run</span><span class="op" id="7325671">(</span><span class="op" id="7325672">)</span>&nbsp;<span class="op" id="7325674">==</span>&nbsp;<span class="builtintype" id="7325677">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7325685">if</span>&nbsp;<span class="op" id="7325688">!</span><span class="ident" id="7325689">cgiWorks</span>&nbsp;<span class="op" id="7325698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7325702">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7325746">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325797">t</span><span class="op" id="7325798">.</span><span class="ident" id="7325799">Skip</span><span class="op" id="7325803">(</span><span class="string" id="7325804">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="7325837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325840">}</span><br>
<span class="lineno"></span><span class="op" id="7325842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7325845">func</span>&nbsp;<span class="ident" id="7325850">TestCGIBasicGet</span><span class="op" id="7325865">(</span><span class="ident" id="7325866">t</span>&nbsp;<span class="op" id="7325868">*</span><span class="ident" id="7325869">testing</span><span class="op" id="7325876">.</span><span class="ident" id="7325877">T</span><span class="op" id="7325878">)</span>&nbsp;<span class="op" id="7325880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325883">check</span><span class="op" id="7325888">(</span><span class="ident" id="7325889">t</span><span class="op" id="7325890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325893">h</span>&nbsp;<span class="op" id="7325895">:=</span>&nbsp;<span class="op" id="7325898">&amp;</span><span class="ident" id="7325899">Handler</span><span class="op" id="7325906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325910">Path</span><span class="op" id="7325914">:</span>&nbsp;<span class="string" id="7325916">&#34;testdata/test.cgi&#34;</span><span class="op" id="7325935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325939">Root</span><span class="op" id="7325943">:</span>&nbsp;<span class="string" id="7325945">&#34;/test.cgi&#34;</span><span class="op" id="7325956">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7325959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7325962">expectedMap</span>&nbsp;<span class="op" id="7325974">:=</span>&nbsp;<span class="keyword" id="7325977">map</span><span class="op" id="7325980">[</span><span class="builtintype" id="7325981">string</span><span class="op" id="7325987">]</span><span class="builtintype" id="7325988">string</span><span class="op" id="7325994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7325998">&#34;test&#34;</span><span class="op" id="7326004">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326023">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7326034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326038">&#34;param-a&#34;</span><span class="op" id="7326047">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326063">&#34;b&#34;</span><span class="op" id="7326066">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326070">&#34;param-foo&#34;</span><span class="op" id="7326081">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326095">&#34;bar&#34;</span><span class="op" id="7326100">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326104">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7326127">:</span>&nbsp;<span class="string" id="7326129">&#34;CGI/1.1&#34;</span><span class="op" id="7326138">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326142">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7326157">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326167">&#34;example.com&#34;</span><span class="op" id="7326180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326184">&#34;env-PATH_INFO&#34;</span><span class="op" id="7326199">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326209">&#34;&#34;</span><span class="op" id="7326211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326215">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7326233">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326240">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7326253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326257">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7326274">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326282">&#34;1.2.3.4&#34;</span><span class="op" id="7326291">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326295">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7326312">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326320">&#34;1.2.3.4&#34;</span><span class="op" id="7326329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326333">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7326353">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326358">&#34;GET&#34;</span><span class="op" id="7326363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326367">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7326384">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326392">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7326415">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326419">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7326440">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7326444">&#34;testdata/test.cgi&#34;</span><span class="op" id="7326463">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326467">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7326484">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326492">&#34;/test.cgi&#34;</span><span class="op" id="7326503">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326507">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7326524">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326532">&#34;example.com&#34;</span><span class="op" id="7326545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326549">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7326566">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326574">&#34;80&#34;</span><span class="op" id="7326578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7326582">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7326603">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7326607">&#34;go&#34;</span><span class="op" id="7326611">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7326614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7326617">replay</span>&nbsp;<span class="op" id="7326624">:=</span>&nbsp;<span class="ident" id="7326627">runCgiTest</span><span class="op" id="7326637">(</span><span class="ident" id="7326638">t</span><span class="op" id="7326639">,</span>&nbsp;<span class="ident" id="7326641">h</span><span class="op" id="7326642">,</span>&nbsp;<span class="string" id="7326644">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7326703">,</span>&nbsp;<span class="ident" id="7326705">expectedMap</span><span class="op" id="7326716">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7326720">if</span>&nbsp;<span class="ident" id="7326723">expected</span><span class="op" id="7326731">,</span>&nbsp;<span class="ident" id="7326733">got</span>&nbsp;<span class="op" id="7326737">:=</span>&nbsp;<span class="string" id="7326740">&#34;text/html&#34;</span><span class="op" id="7326751">,</span>&nbsp;<span class="ident" id="7326753">replay</span><span class="op" id="7326759">.</span><span class="ident" id="7326760">Header</span><span class="op" id="7326766">(</span><span class="op" id="7326767">)</span><span class="op" id="7326768">.</span><span class="ident" id="7326769">Get</span><span class="op" id="7326772">(</span><span class="string" id="7326773">&#34;Content-Type&#34;</span><span class="op" id="7326787">)</span><span class="op" id="7326788">;</span>&nbsp;<span class="ident" id="7326790">got</span>&nbsp;<span class="op" id="7326794">!=</span>&nbsp;<span class="ident" id="7326797">expected</span>&nbsp;<span class="op" id="7326806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7326810">t</span><span class="op" id="7326811">.</span><span class="ident" id="7326812">Errorf</span><span class="op" id="7326818">(</span><span class="string" id="7326819">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7326858">,</span>&nbsp;<span class="ident" id="7326860">got</span><span class="op" id="7326863">,</span>&nbsp;<span class="ident" id="7326865">expected</span><span class="op" id="7326873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7326876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7326879">if</span>&nbsp;<span class="ident" id="7326882">expected</span><span class="op" id="7326890">,</span>&nbsp;<span class="ident" id="7326892">got</span>&nbsp;<span class="op" id="7326896">:=</span>&nbsp;<span class="string" id="7326899">&#34;X-Test-Value&#34;</span><span class="op" id="7326913">,</span>&nbsp;<span class="ident" id="7326915">replay</span><span class="op" id="7326921">.</span><span class="ident" id="7326922">Header</span><span class="op" id="7326928">(</span><span class="op" id="7326929">)</span><span class="op" id="7326930">.</span><span class="ident" id="7326931">Get</span><span class="op" id="7326934">(</span><span class="string" id="7326935">&#34;X-Test-Header&#34;</span><span class="op" id="7326950">)</span><span class="op" id="7326951">;</span>&nbsp;<span class="ident" id="7326953">got</span>&nbsp;<span class="op" id="7326957">!=</span>&nbsp;<span class="ident" id="7326960">expected</span>&nbsp;<span class="op" id="7326969">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7326973">t</span><span class="op" id="7326974">.</span><span class="ident" id="7326975">Errorf</span><span class="op" id="7326981">(</span><span class="string" id="7326982">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7327022">,</span>&nbsp;<span class="ident" id="7327024">got</span><span class="op" id="7327027">,</span>&nbsp;<span class="ident" id="7327029">expected</span><span class="op" id="7327037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7327040">}</span><br>
<span class="lineno"></span><span class="op" id="7327042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7327045">func</span>&nbsp;<span class="ident" id="7327050">TestCGIBasicGetAbsPath</span><span class="op" id="7327072">(</span><span class="ident" id="7327073">t</span>&nbsp;<span class="op" id="7327075">*</span><span class="ident" id="7327076">testing</span><span class="op" id="7327083">.</span><span class="ident" id="7327084">T</span><span class="op" id="7327085">)</span>&nbsp;<span class="op" id="7327087">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327090">check</span><span class="op" id="7327095">(</span><span class="ident" id="7327096">t</span><span class="op" id="7327097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327100">pwd</span><span class="op" id="7327103">,</span>&nbsp;<span class="ident" id="7327105">err</span>&nbsp;<span class="op" id="7327109">:=</span>&nbsp;<span class="ident" id="7327112">os</span><span class="op" id="7327114">.</span><span class="ident" id="7327115">Getwd</span><span class="op" id="7327120">(</span><span class="op" id="7327121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7327124">if</span>&nbsp;<span class="ident" id="7327127">err</span>&nbsp;<span class="op" id="7327131">!=</span>&nbsp;<span class="builtintype" id="7327134">nil</span>&nbsp;<span class="op" id="7327138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327142">t</span><span class="op" id="7327143">.</span><span class="ident" id="7327144">Fatalf</span><span class="op" id="7327150">(</span><span class="string" id="7327151">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7327168">,</span>&nbsp;<span class="ident" id="7327170">err</span><span class="op" id="7327173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7327176">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327179">h</span>&nbsp;<span class="op" id="7327181">:=</span>&nbsp;<span class="op" id="7327184">&amp;</span><span class="ident" id="7327185">Handler</span><span class="op" id="7327192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327196">Path</span><span class="op" id="7327200">:</span>&nbsp;<span class="ident" id="7327202">pwd</span>&nbsp;<span class="op" id="7327206">+</span>&nbsp;<span class="string" id="7327208">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7327228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327232">Root</span><span class="op" id="7327236">:</span>&nbsp;<span class="string" id="7327238">&#34;/test.cgi&#34;</span><span class="op" id="7327249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7327252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327255">expectedMap</span>&nbsp;<span class="op" id="7327267">:=</span>&nbsp;<span class="keyword" id="7327270">map</span><span class="op" id="7327273">[</span><span class="builtintype" id="7327274">string</span><span class="op" id="7327280">]</span><span class="builtintype" id="7327281">string</span><span class="op" id="7327287">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327291">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7327308">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327314">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7327337">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327341">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7327362">:</span>&nbsp;<span class="ident" id="7327364">pwd</span>&nbsp;<span class="op" id="7327368">+</span>&nbsp;<span class="string" id="7327370">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7327390">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327394">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7327411">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327417">&#34;/test.cgi&#34;</span><span class="op" id="7327428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7327431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327434">runCgiTest</span><span class="op" id="7327444">(</span><span class="ident" id="7327445">t</span><span class="op" id="7327446">,</span>&nbsp;<span class="ident" id="7327448">h</span><span class="op" id="7327449">,</span>&nbsp;<span class="string" id="7327451">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7327510">,</span>&nbsp;<span class="ident" id="7327512">expectedMap</span><span class="op" id="7327523">)</span><br>
<span class="lineno">145</span><span class="op" id="7327525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7327528">func</span>&nbsp;<span class="ident" id="7327533">TestPathInfo</span><span class="op" id="7327545">(</span><span class="ident" id="7327546">t</span>&nbsp;<span class="op" id="7327548">*</span><span class="ident" id="7327549">testing</span><span class="op" id="7327556">.</span><span class="ident" id="7327557">T</span><span class="op" id="7327558">)</span>&nbsp;<span class="op" id="7327560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327563">check</span><span class="op" id="7327568">(</span><span class="ident" id="7327569">t</span><span class="op" id="7327570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327573">h</span>&nbsp;<span class="op" id="7327575">:=</span>&nbsp;<span class="op" id="7327578">&amp;</span><span class="ident" id="7327579">Handler</span><span class="op" id="7327586">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327590">Path</span><span class="op" id="7327594">:</span>&nbsp;<span class="string" id="7327596">&#34;testdata/test.cgi&#34;</span><span class="op" id="7327615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327619">Root</span><span class="op" id="7327623">:</span>&nbsp;<span class="string" id="7327625">&#34;/test.cgi&#34;</span><span class="op" id="7327636">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7327639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327642">expectedMap</span>&nbsp;<span class="op" id="7327654">:=</span>&nbsp;<span class="keyword" id="7327657">map</span><span class="op" id="7327660">[</span><span class="builtintype" id="7327661">string</span><span class="op" id="7327667">]</span><span class="builtintype" id="7327668">string</span><span class="op" id="7327674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327678">&#34;param-a&#34;</span><span class="op" id="7327687">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327701">&#34;b&#34;</span><span class="op" id="7327704">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327708">&#34;env-PATH_INFO&#34;</span><span class="op" id="7327723">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327731">&#34;/extrapath&#34;</span><span class="op" id="7327743">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327747">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7327765">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327770">&#34;a=b&#34;</span><span class="op" id="7327775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327779">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7327796">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327802">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="7327827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327831">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7327852">:</span>&nbsp;<span class="string" id="7327854">&#34;testdata/test.cgi&#34;</span><span class="op" id="7327873">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327877">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7327894">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7327900">&#34;/test.cgi&#34;</span><span class="op" id="7327911">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7327914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7327917">runCgiTest</span><span class="op" id="7327927">(</span><span class="ident" id="7327928">t</span><span class="op" id="7327929">,</span>&nbsp;<span class="ident" id="7327931">h</span><span class="op" id="7327932">,</span>&nbsp;<span class="string" id="7327934">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7327995">,</span>&nbsp;<span class="ident" id="7327997">expectedMap</span><span class="op" id="7328008">)</span><br>
<span class="lineno"></span><span class="op" id="7328010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7328013">func</span>&nbsp;<span class="ident" id="7328018">TestPathInfoDirRoot</span><span class="op" id="7328037">(</span><span class="ident" id="7328038">t</span>&nbsp;<span class="op" id="7328040">*</span><span class="ident" id="7328041">testing</span><span class="op" id="7328048">.</span><span class="ident" id="7328049">T</span><span class="op" id="7328050">)</span>&nbsp;<span class="op" id="7328052">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328055">check</span><span class="op" id="7328060">(</span><span class="ident" id="7328061">t</span><span class="op" id="7328062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328065">h</span>&nbsp;<span class="op" id="7328067">:=</span>&nbsp;<span class="op" id="7328070">&amp;</span><span class="ident" id="7328071">Handler</span><span class="op" id="7328078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328082">Path</span><span class="op" id="7328086">:</span>&nbsp;<span class="string" id="7328088">&#34;testdata/test.cgi&#34;</span><span class="op" id="7328107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328111">Root</span><span class="op" id="7328115">:</span>&nbsp;<span class="string" id="7328117">&#34;/myscript/&#34;</span><span class="op" id="7328129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7328132">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328135">expectedMap</span>&nbsp;<span class="op" id="7328147">:=</span>&nbsp;<span class="keyword" id="7328150">map</span><span class="op" id="7328153">[</span><span class="builtintype" id="7328154">string</span><span class="op" id="7328160">]</span><span class="builtintype" id="7328161">string</span><span class="op" id="7328167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328171">&#34;env-PATH_INFO&#34;</span><span class="op" id="7328186">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328194">&#34;bar&#34;</span><span class="op" id="7328199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328203">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7328221">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328226">&#34;a=b&#34;</span><span class="op" id="7328231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328235">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7328252">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328258">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7328277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328281">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7328302">:</span>&nbsp;<span class="string" id="7328304">&#34;testdata/test.cgi&#34;</span><span class="op" id="7328323">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328327">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7328344">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328350">&#34;/myscript/&#34;</span><span class="op" id="7328362">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7328365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328368">runCgiTest</span><span class="op" id="7328378">(</span><span class="ident" id="7328379">t</span><span class="op" id="7328380">,</span>&nbsp;<span class="ident" id="7328382">h</span><span class="op" id="7328383">,</span>&nbsp;<span class="string" id="7328385">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7328440">,</span>&nbsp;<span class="ident" id="7328442">expectedMap</span><span class="op" id="7328453">)</span><br>
<span class="lineno"></span><span class="op" id="7328455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7328458">func</span>&nbsp;<span class="ident" id="7328463">TestDupHeaders</span><span class="op" id="7328477">(</span><span class="ident" id="7328478">t</span>&nbsp;<span class="op" id="7328480">*</span><span class="ident" id="7328481">testing</span><span class="op" id="7328488">.</span><span class="ident" id="7328489">T</span><span class="op" id="7328490">)</span>&nbsp;<span class="op" id="7328492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328495">check</span><span class="op" id="7328500">(</span><span class="ident" id="7328501">t</span><span class="op" id="7328502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328505">h</span>&nbsp;<span class="op" id="7328507">:=</span>&nbsp;<span class="op" id="7328510">&amp;</span><span class="ident" id="7328511">Handler</span><span class="op" id="7328518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328522">Path</span><span class="op" id="7328526">:</span>&nbsp;<span class="string" id="7328528">&#34;testdata/test.cgi&#34;</span><span class="op" id="7328547">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7328550">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328553">expectedMap</span>&nbsp;<span class="op" id="7328565">:=</span>&nbsp;<span class="keyword" id="7328568">map</span><span class="op" id="7328571">[</span><span class="builtintype" id="7328572">string</span><span class="op" id="7328578">]</span><span class="builtintype" id="7328579">string</span><span class="op" id="7328585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328589">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7328606">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328612">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7328631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328635">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7328656">:</span>&nbsp;<span class="string" id="7328658">&#34;testdata/test.cgi&#34;</span><span class="op" id="7328677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328681">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="7328698">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328704">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="7328722">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328726">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="7328742">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328749">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="7328761">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7328764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328767">runCgiTest</span><span class="op" id="7328777">(</span><span class="ident" id="7328778">t</span><span class="op" id="7328779">,</span>&nbsp;<span class="ident" id="7328781">h</span><span class="op" id="7328782">,</span>&nbsp;<span class="string" id="7328784">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="7328818">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328822">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="7328841">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328845">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="7328864">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328868">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="7328883">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328887">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="7328902">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7328906">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="7328929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328933">expectedMap</span><span class="op" id="7328944">)</span><br>
<span class="lineno"></span><span class="op" id="7328946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="7328949">func</span>&nbsp;<span class="ident" id="7328954">TestPathInfoNoRoot</span><span class="op" id="7328972">(</span><span class="ident" id="7328973">t</span>&nbsp;<span class="op" id="7328975">*</span><span class="ident" id="7328976">testing</span><span class="op" id="7328983">.</span><span class="ident" id="7328984">T</span><span class="op" id="7328985">)</span>&nbsp;<span class="op" id="7328987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7328990">check</span><span class="op" id="7328995">(</span><span class="ident" id="7328996">t</span><span class="op" id="7328997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329000">h</span>&nbsp;<span class="op" id="7329002">:=</span>&nbsp;<span class="op" id="7329005">&amp;</span><span class="ident" id="7329006">Handler</span><span class="op" id="7329013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329017">Path</span><span class="op" id="7329021">:</span>&nbsp;<span class="string" id="7329023">&#34;testdata/test.cgi&#34;</span><span class="op" id="7329042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329046">Root</span><span class="op" id="7329050">:</span>&nbsp;<span class="string" id="7329052">&#34;&#34;</span><span class="op" id="7329054">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7329057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329060">expectedMap</span>&nbsp;<span class="op" id="7329072">:=</span>&nbsp;<span class="keyword" id="7329075">map</span><span class="op" id="7329078">[</span><span class="builtintype" id="7329079">string</span><span class="op" id="7329085">]</span><span class="builtintype" id="7329086">string</span><span class="op" id="7329092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329096">&#34;env-PATH_INFO&#34;</span><span class="op" id="7329111">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329119">&#34;/bar&#34;</span><span class="op" id="7329125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329129">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7329147">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329152">&#34;a=b&#34;</span><span class="op" id="7329157">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329161">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7329178">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329184">&#34;/bar?a=b&#34;</span><span class="op" id="7329194">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329198">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7329219">:</span>&nbsp;<span class="string" id="7329221">&#34;testdata/test.cgi&#34;</span><span class="op" id="7329240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329244">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7329261">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329267">&#34;/&#34;</span><span class="op" id="7329270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7329273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329276">runCgiTest</span><span class="op" id="7329286">(</span><span class="ident" id="7329287">t</span><span class="op" id="7329288">,</span>&nbsp;<span class="ident" id="7329290">h</span><span class="op" id="7329291">,</span>&nbsp;<span class="string" id="7329293">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7329339">,</span>&nbsp;<span class="ident" id="7329341">expectedMap</span><span class="op" id="7329352">)</span><br>
<span class="lineno"></span><span class="op" id="7329354">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7329357">func</span>&nbsp;<span class="ident" id="7329362">TestCGIBasicPost</span><span class="op" id="7329378">(</span><span class="ident" id="7329379">t</span>&nbsp;<span class="op" id="7329381">*</span><span class="ident" id="7329382">testing</span><span class="op" id="7329389">.</span><span class="ident" id="7329390">T</span><span class="op" id="7329391">)</span>&nbsp;<span class="op" id="7329393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329396">check</span><span class="op" id="7329401">(</span><span class="ident" id="7329402">t</span><span class="op" id="7329403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329406">postReq</span>&nbsp;<span class="op" id="7329414">:=</span>&nbsp;<span class="string" id="7329417">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329550">h</span>&nbsp;<span class="op" id="7329552">:=</span>&nbsp;<span class="op" id="7329555">&amp;</span><span class="ident" id="7329556">Handler</span><span class="op" id="7329563">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329567">Path</span><span class="op" id="7329571">:</span>&nbsp;<span class="string" id="7329573">&#34;testdata/test.cgi&#34;</span><span class="op" id="7329592">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329596">Root</span><span class="op" id="7329600">:</span>&nbsp;<span class="string" id="7329602">&#34;/test.cgi&#34;</span><span class="op" id="7329613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7329616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329619">expectedMap</span>&nbsp;<span class="op" id="7329631">:=</span>&nbsp;<span class="keyword" id="7329634">map</span><span class="op" id="7329637">[</span><span class="builtintype" id="7329638">string</span><span class="op" id="7329644">]</span><span class="builtintype" id="7329645">string</span><span class="op" id="7329651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329655">&#34;test&#34;</span><span class="op" id="7329661">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329677">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7329688">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329692">&#34;param-postfoo&#34;</span><span class="op" id="7329707">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329714">&#34;postbar&#34;</span><span class="op" id="7329723">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329727">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7329747">:</span>&nbsp;<span class="string" id="7329749">&#34;POST&#34;</span><span class="op" id="7329755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329759">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="7329779">:</span>&nbsp;<span class="string" id="7329781">&#34;15&#34;</span><span class="op" id="7329785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329789">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7329806">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7329811">&#34;/test.cgi?a=b&#34;</span><span class="op" id="7329826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7329829">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7329832">runCgiTest</span><span class="op" id="7329842">(</span><span class="ident" id="7329843">t</span><span class="op" id="7329844">,</span>&nbsp;<span class="ident" id="7329846">h</span><span class="op" id="7329847">,</span>&nbsp;<span class="ident" id="7329849">postReq</span><span class="op" id="7329856">,</span>&nbsp;<span class="ident" id="7329858">expectedMap</span><span class="op" id="7329869">)</span><br>
<span class="lineno"></span><span class="op" id="7329871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7329874">func</span>&nbsp;<span class="ident" id="7329879">chunk</span><span class="op" id="7329884">(</span><span class="ident" id="7329885">s</span>&nbsp;<span class="builtintype" id="7329887">string</span><span class="op" id="7329893">)</span>&nbsp;<span class="builtintype" id="7329895">string</span>&nbsp;<span class="op" id="7329902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7329905">return</span>&nbsp;<span class="ident" id="7329912">fmt</span><span class="op" id="7329915">.</span><span class="ident" id="7329916">Sprintf</span><span class="op" id="7329923">(</span><span class="string" id="7329924">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="7329938">,</span>&nbsp;<span class="builtinfunc" id="7329940">len</span><span class="op" id="7329943">(</span><span class="ident" id="7329944">s</span><span class="op" id="7329945">)</span><span class="op" id="7329946">,</span>&nbsp;<span class="ident" id="7329948">s</span><span class="op" id="7329949">)</span><br>
<span class="lineno">240</span><span class="op" id="7329951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7329954">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="7330002">func</span>&nbsp;<span class="ident" id="7330007">TestCGIPostChunked</span><span class="op" id="7330025">(</span><span class="ident" id="7330026">t</span>&nbsp;<span class="op" id="7330028">*</span><span class="ident" id="7330029">testing</span><span class="op" id="7330036">.</span><span class="ident" id="7330037">T</span><span class="op" id="7330038">)</span>&nbsp;<span class="op" id="7330040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330043">check</span><span class="op" id="7330048">(</span><span class="ident" id="7330049">t</span><span class="op" id="7330050">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330053">postReq</span>&nbsp;<span class="op" id="7330061">:=</span>&nbsp;<span class="string" id="7330064">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="7330189">+</span>&nbsp;<span class="ident" id="7330191">chunk</span><span class="op" id="7330196">(</span><span class="string" id="7330197">&#34;postfoo&#34;</span><span class="op" id="7330206">)</span>&nbsp;<span class="op" id="7330208">+</span>&nbsp;<span class="ident" id="7330210">chunk</span><span class="op" id="7330215">(</span><span class="string" id="7330216">&#34;=&#34;</span><span class="op" id="7330219">)</span>&nbsp;<span class="op" id="7330221">+</span>&nbsp;<span class="ident" id="7330223">chunk</span><span class="op" id="7330228">(</span><span class="string" id="7330229">&#34;postbar&#34;</span><span class="op" id="7330238">)</span>&nbsp;<span class="op" id="7330240">+</span>&nbsp;<span class="ident" id="7330242">chunk</span><span class="op" id="7330247">(</span><span class="string" id="7330248">&#34;&#34;</span><span class="op" id="7330250">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330254">h</span>&nbsp;<span class="op" id="7330256">:=</span>&nbsp;<span class="op" id="7330259">&amp;</span><span class="ident" id="7330260">Handler</span><span class="op" id="7330267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330271">Path</span><span class="op" id="7330275">:</span>&nbsp;<span class="string" id="7330277">&#34;testdata/test.cgi&#34;</span><span class="op" id="7330296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330300">Root</span><span class="op" id="7330304">:</span>&nbsp;<span class="string" id="7330306">&#34;/test.cgi&#34;</span><span class="op" id="7330317">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7330320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330323">expectedMap</span>&nbsp;<span class="op" id="7330335">:=</span>&nbsp;<span class="keyword" id="7330338">map</span><span class="op" id="7330341">[</span><span class="builtintype" id="7330342">string</span><span class="op" id="7330348">]</span><span class="builtintype" id="7330349">string</span><span class="op" id="7330355">{</span><span class="op" id="7330356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330359">resp</span>&nbsp;<span class="op" id="7330364">:=</span>&nbsp;<span class="ident" id="7330367">runCgiTest</span><span class="op" id="7330377">(</span><span class="ident" id="7330378">t</span><span class="op" id="7330379">,</span>&nbsp;<span class="ident" id="7330381">h</span><span class="op" id="7330382">,</span>&nbsp;<span class="ident" id="7330384">postReq</span><span class="op" id="7330391">,</span>&nbsp;<span class="ident" id="7330393">expectedMap</span><span class="op" id="7330404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7330407">if</span>&nbsp;<span class="ident" id="7330410">got</span><span class="op" id="7330413">,</span>&nbsp;<span class="ident" id="7330415">expected</span>&nbsp;<span class="op" id="7330424">:=</span>&nbsp;<span class="ident" id="7330427">resp</span><span class="op" id="7330431">.</span><span class="ident" id="7330432">Code</span><span class="op" id="7330436">,</span>&nbsp;<span class="ident" id="7330438">http</span><span class="op" id="7330442">.</span><span class="ident" id="7330443">StatusBadRequest</span><span class="op" id="7330459">;</span>&nbsp;<span class="ident" id="7330461">got</span>&nbsp;<span class="op" id="7330465">!=</span>&nbsp;<span class="ident" id="7330468">expected</span>&nbsp;<span class="op" id="7330477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330481">t</span><span class="op" id="7330482">.</span><span class="ident" id="7330483">Fatalf</span><span class="op" id="7330489">(</span><span class="string" id="7330490">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7330551">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330556">expected</span><span class="op" id="7330564">,</span>&nbsp;<span class="ident" id="7330566">got</span><span class="op" id="7330569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7330572">}</span><br>
<span class="lineno"></span><span class="op" id="7330574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7330577">func</span>&nbsp;<span class="ident" id="7330582">TestRedirect</span><span class="op" id="7330594">(</span><span class="ident" id="7330595">t</span>&nbsp;<span class="op" id="7330597">*</span><span class="ident" id="7330598">testing</span><span class="op" id="7330605">.</span><span class="ident" id="7330606">T</span><span class="op" id="7330607">)</span>&nbsp;<span class="op" id="7330609">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330612">check</span><span class="op" id="7330617">(</span><span class="ident" id="7330618">t</span><span class="op" id="7330619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330622">h</span>&nbsp;<span class="op" id="7330624">:=</span>&nbsp;<span class="op" id="7330627">&amp;</span><span class="ident" id="7330628">Handler</span><span class="op" id="7330635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330639">Path</span><span class="op" id="7330643">:</span>&nbsp;<span class="string" id="7330645">&#34;testdata/test.cgi&#34;</span><span class="op" id="7330664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330668">Root</span><span class="op" id="7330672">:</span>&nbsp;<span class="string" id="7330674">&#34;/test.cgi&#34;</span><span class="op" id="7330685">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7330688">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330691">rec</span>&nbsp;<span class="op" id="7330695">:=</span>&nbsp;<span class="ident" id="7330698">runCgiTest</span><span class="op" id="7330708">(</span><span class="ident" id="7330709">t</span><span class="op" id="7330710">,</span>&nbsp;<span class="ident" id="7330712">h</span><span class="op" id="7330713">,</span>&nbsp;<span class="string" id="7330715">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7330782">,</span>&nbsp;<span class="builtintype" id="7330784">nil</span><span class="op" id="7330787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7330790">if</span>&nbsp;<span class="ident" id="7330793">e</span><span class="op" id="7330794">,</span>&nbsp;<span class="ident" id="7330796">g</span>&nbsp;<span class="op" id="7330798">:=</span>&nbsp;<span class="num" id="7330801">302</span><span class="op" id="7330804">,</span>&nbsp;<span class="ident" id="7330806">rec</span><span class="op" id="7330809">.</span><span class="ident" id="7330810">Code</span><span class="op" id="7330814">;</span>&nbsp;<span class="ident" id="7330816">e</span>&nbsp;<span class="op" id="7330818">!=</span>&nbsp;<span class="ident" id="7330821">g</span>&nbsp;<span class="op" id="7330823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330827">t</span><span class="op" id="7330828">.</span><span class="ident" id="7330829">Errorf</span><span class="op" id="7330835">(</span><span class="string" id="7330836">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7330869">,</span>&nbsp;<span class="ident" id="7330871">e</span><span class="op" id="7330872">,</span>&nbsp;<span class="ident" id="7330874">g</span><span class="op" id="7330875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7330878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7330881">if</span>&nbsp;<span class="ident" id="7330884">e</span><span class="op" id="7330885">,</span>&nbsp;<span class="ident" id="7330887">g</span>&nbsp;<span class="op" id="7330889">:=</span>&nbsp;<span class="string" id="7330892">&#34;http://foo.com/&#34;</span><span class="op" id="7330909">,</span>&nbsp;<span class="ident" id="7330911">rec</span><span class="op" id="7330914">.</span><span class="ident" id="7330915">Header</span><span class="op" id="7330921">(</span><span class="op" id="7330922">)</span><span class="op" id="7330923">.</span><span class="ident" id="7330924">Get</span><span class="op" id="7330927">(</span><span class="string" id="7330928">&#34;Location&#34;</span><span class="op" id="7330938">)</span><span class="op" id="7330939">;</span>&nbsp;<span class="ident" id="7330941">e</span>&nbsp;<span class="op" id="7330943">!=</span>&nbsp;<span class="ident" id="7330946">g</span>&nbsp;<span class="op" id="7330948">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7330952">t</span><span class="op" id="7330953">.</span><span class="ident" id="7330954">Errorf</span><span class="op" id="7330960">(</span><span class="string" id="7330961">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7331001">,</span>&nbsp;<span class="ident" id="7331003">e</span><span class="op" id="7331004">,</span>&nbsp;<span class="ident" id="7331006">g</span><span class="op" id="7331007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7331010">}</span><br>
<span class="lineno"></span><span class="op" id="7331012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7331015">func</span>&nbsp;<span class="ident" id="7331020">TestInternalRedirect</span><span class="op" id="7331040">(</span><span class="ident" id="7331041">t</span>&nbsp;<span class="op" id="7331043">*</span><span class="ident" id="7331044">testing</span><span class="op" id="7331051">.</span><span class="ident" id="7331052">T</span><span class="op" id="7331053">)</span>&nbsp;<span class="op" id="7331055">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331058">check</span><span class="op" id="7331063">(</span><span class="ident" id="7331064">t</span><span class="op" id="7331065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331068">baseHandler</span>&nbsp;<span class="op" id="7331080">:=</span>&nbsp;<span class="ident" id="7331083">http</span><span class="op" id="7331087">.</span><span class="ident" id="7331088">HandlerFunc</span><span class="op" id="7331099">(</span><span class="keyword" id="7331100">func</span><span class="op" id="7331104">(</span><span class="ident" id="7331105">rw</span>&nbsp;<span class="ident" id="7331108">http</span><span class="op" id="7331112">.</span><span class="ident" id="7331113">ResponseWriter</span><span class="op" id="7331127">,</span>&nbsp;<span class="ident" id="7331129">req</span>&nbsp;<span class="op" id="7331133">*</span><span class="ident" id="7331134">http</span><span class="op" id="7331138">.</span><span class="ident" id="7331139">Request</span><span class="op" id="7331146">)</span>&nbsp;<span class="op" id="7331148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331152">fmt</span><span class="op" id="7331155">.</span><span class="ident" id="7331156">Fprintf</span><span class="op" id="7331163">(</span><span class="ident" id="7331164">rw</span><span class="op" id="7331166">,</span>&nbsp;<span class="string" id="7331168">&#34;basepath=%s\n&#34;</span><span class="op" id="7331183">,</span>&nbsp;<span class="ident" id="7331185">req</span><span class="op" id="7331188">.</span><span class="ident" id="7331189">URL</span><span class="op" id="7331192">.</span><span class="ident" id="7331193">Path</span><span class="op" id="7331197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331201">fmt</span><span class="op" id="7331204">.</span><span class="ident" id="7331205">Fprintf</span><span class="op" id="7331212">(</span><span class="ident" id="7331213">rw</span><span class="op" id="7331215">,</span>&nbsp;<span class="string" id="7331217">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="7331234">,</span>&nbsp;<span class="ident" id="7331236">req</span><span class="op" id="7331239">.</span><span class="ident" id="7331240">RemoteAddr</span><span class="op" id="7331250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7331253">}</span><span class="op" id="7331254">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331257">h</span>&nbsp;<span class="op" id="7331259">:=</span>&nbsp;<span class="op" id="7331262">&amp;</span><span class="ident" id="7331263">Handler</span><span class="op" id="7331270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331274">Path</span><span class="op" id="7331278">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7331295">&#34;testdata/test.cgi&#34;</span><span class="op" id="7331314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331318">Root</span><span class="op" id="7331322">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7331339">&#34;/test.cgi&#34;</span><span class="op" id="7331350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331354">PathLocationHandler</span><span class="op" id="7331373">:</span>&nbsp;<span class="ident" id="7331375">baseHandler</span><span class="op" id="7331386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7331389">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331392">expectedMap</span>&nbsp;<span class="op" id="7331404">:=</span>&nbsp;<span class="keyword" id="7331407">map</span><span class="op" id="7331410">[</span><span class="builtintype" id="7331411">string</span><span class="op" id="7331417">]</span><span class="builtintype" id="7331418">string</span><span class="op" id="7331424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7331428">&#34;basepath&#34;</span><span class="op" id="7331438">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7331442">&#34;/foo&#34;</span><span class="op" id="7331448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7331452">&#34;remoteaddr&#34;</span><span class="op" id="7331464">:</span>&nbsp;<span class="string" id="7331466">&#34;1.2.3.4&#34;</span><span class="op" id="7331475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7331478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331481">runCgiTest</span><span class="op" id="7331491">(</span><span class="ident" id="7331492">t</span><span class="op" id="7331493">,</span>&nbsp;<span class="ident" id="7331495">h</span><span class="op" id="7331496">,</span>&nbsp;<span class="string" id="7331498">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7331554">,</span>&nbsp;<span class="ident" id="7331556">expectedMap</span><span class="op" id="7331567">)</span><br>
<span class="lineno">295</span><span class="op" id="7331569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7331572">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="7331648">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="7331711">func</span>&nbsp;<span class="ident" id="7331716">TestCopyError</span><span class="op" id="7331729">(</span><span class="ident" id="7331730">t</span>&nbsp;<span class="op" id="7331732">*</span><span class="ident" id="7331733">testing</span><span class="op" id="7331740">.</span><span class="ident" id="7331741">T</span><span class="op" id="7331742">)</span>&nbsp;<span class="op" id="7331744">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331747">check</span><span class="op" id="7331752">(</span><span class="ident" id="7331753">t</span><span class="op" id="7331754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7331757">if</span>&nbsp;<span class="ident" id="7331760">runtime</span><span class="op" id="7331767">.</span><span class="ident" id="7331768">GOOS</span>&nbsp;<span class="op" id="7331773">==</span>&nbsp;<span class="string" id="7331776">&#34;windows&#34;</span>&nbsp;<span class="op" id="7331786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331790">t</span><span class="op" id="7331791">.</span><span class="ident" id="7331792">Skipf</span><span class="op" id="7331797">(</span><span class="string" id="7331798">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7331819">,</span>&nbsp;<span class="ident" id="7331821">runtime</span><span class="op" id="7331828">.</span><span class="ident" id="7331829">GOOS</span><span class="op" id="7331833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7331836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331839">h</span>&nbsp;<span class="op" id="7331841">:=</span>&nbsp;<span class="op" id="7331844">&amp;</span><span class="ident" id="7331845">Handler</span><span class="op" id="7331852">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331856">Path</span><span class="op" id="7331860">:</span>&nbsp;<span class="string" id="7331862">&#34;testdata/test.cgi&#34;</span><span class="op" id="7331881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331885">Root</span><span class="op" id="7331889">:</span>&nbsp;<span class="string" id="7331891">&#34;/test.cgi&#34;</span><span class="op" id="7331902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7331905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331908">ts</span>&nbsp;<span class="op" id="7331911">:=</span>&nbsp;<span class="ident" id="7331914">httptest</span><span class="op" id="7331922">.</span><span class="ident" id="7331923">NewServer</span><span class="op" id="7331932">(</span><span class="ident" id="7331933">h</span><span class="op" id="7331934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7331937">defer</span>&nbsp;<span class="ident" id="7331943">ts</span><span class="op" id="7331945">.</span><span class="ident" id="7331946">Close</span><span class="op" id="7331951">(</span><span class="op" id="7331952">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7331956">conn</span><span class="op" id="7331960">,</span>&nbsp;<span class="ident" id="7331962">err</span>&nbsp;<span class="op" id="7331966">:=</span>&nbsp;<span class="ident" id="7331969">net</span><span class="op" id="7331972">.</span><span class="ident" id="7331973">Dial</span><span class="op" id="7331977">(</span><span class="string" id="7331978">&#34;tcp&#34;</span><span class="op" id="7331983">,</span>&nbsp;<span class="ident" id="7331985">ts</span><span class="op" id="7331987">.</span><span class="ident" id="7331988">Listener</span><span class="op" id="7331996">.</span><span class="ident" id="7331997">Addr</span><span class="op" id="7332001">(</span><span class="op" id="7332002">)</span><span class="op" id="7332003">.</span><span class="ident" id="7332004">String</span><span class="op" id="7332010">(</span><span class="op" id="7332011">)</span><span class="op" id="7332012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332015">if</span>&nbsp;<span class="ident" id="7332018">err</span>&nbsp;<span class="op" id="7332022">!=</span>&nbsp;<span class="builtintype" id="7332025">nil</span>&nbsp;<span class="op" id="7332029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332033">t</span><span class="op" id="7332034">.</span><span class="ident" id="7332035">Fatal</span><span class="op" id="7332040">(</span><span class="ident" id="7332041">err</span><span class="op" id="7332044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332047">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332050">req</span><span class="op" id="7332053">,</span>&nbsp;<span class="ident" id="7332055">_</span>&nbsp;<span class="op" id="7332057">:=</span>&nbsp;<span class="ident" id="7332060">http</span><span class="op" id="7332064">.</span><span class="ident" id="7332065">NewRequest</span><span class="op" id="7332075">(</span><span class="string" id="7332076">&#34;GET&#34;</span><span class="op" id="7332081">,</span>&nbsp;<span class="string" id="7332083">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="7332126">,</span>&nbsp;<span class="builtintype" id="7332128">nil</span><span class="op" id="7332131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332134">err</span>&nbsp;<span class="op" id="7332138">=</span>&nbsp;<span class="ident" id="7332140">req</span><span class="op" id="7332143">.</span><span class="ident" id="7332144">Write</span><span class="op" id="7332149">(</span><span class="ident" id="7332150">conn</span><span class="op" id="7332154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332157">if</span>&nbsp;<span class="ident" id="7332160">err</span>&nbsp;<span class="op" id="7332164">!=</span>&nbsp;<span class="builtintype" id="7332167">nil</span>&nbsp;<span class="op" id="7332171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332175">t</span><span class="op" id="7332176">.</span><span class="ident" id="7332177">Fatalf</span><span class="op" id="7332183">(</span><span class="string" id="7332184">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="7332195">,</span>&nbsp;<span class="ident" id="7332197">err</span><span class="op" id="7332200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332203">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332207">res</span><span class="op" id="7332210">,</span>&nbsp;<span class="ident" id="7332212">err</span>&nbsp;<span class="op" id="7332216">:=</span>&nbsp;<span class="ident" id="7332219">http</span><span class="op" id="7332223">.</span><span class="ident" id="7332224">ReadResponse</span><span class="op" id="7332236">(</span><span class="ident" id="7332237">bufio</span><span class="op" id="7332242">.</span><span class="ident" id="7332243">NewReader</span><span class="op" id="7332252">(</span><span class="ident" id="7332253">conn</span><span class="op" id="7332257">)</span><span class="op" id="7332258">,</span>&nbsp;<span class="ident" id="7332260">req</span><span class="op" id="7332263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332266">if</span>&nbsp;<span class="ident" id="7332269">err</span>&nbsp;<span class="op" id="7332273">!=</span>&nbsp;<span class="builtintype" id="7332276">nil</span>&nbsp;<span class="op" id="7332280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332284">t</span><span class="op" id="7332285">.</span><span class="ident" id="7332286">Fatalf</span><span class="op" id="7332292">(</span><span class="string" id="7332293">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="7332311">,</span>&nbsp;<span class="ident" id="7332313">err</span><span class="op" id="7332316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332319">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332323">pidstr</span>&nbsp;<span class="op" id="7332330">:=</span>&nbsp;<span class="ident" id="7332333">res</span><span class="op" id="7332336">.</span><span class="ident" id="7332337">Header</span><span class="op" id="7332343">.</span><span class="ident" id="7332344">Get</span><span class="op" id="7332347">(</span><span class="string" id="7332348">&#34;X-CGI-Pid&#34;</span><span class="op" id="7332359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332362">if</span>&nbsp;<span class="ident" id="7332365">pidstr</span>&nbsp;<span class="op" id="7332372">==</span>&nbsp;<span class="string" id="7332375">&#34;&#34;</span>&nbsp;<span class="op" id="7332378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332382">t</span><span class="op" id="7332383">.</span><span class="ident" id="7332384">Fatalf</span><span class="op" id="7332390">(</span><span class="string" id="7332391">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="7332433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332436">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332439">pid</span><span class="op" id="7332442">,</span>&nbsp;<span class="ident" id="7332444">err</span>&nbsp;<span class="op" id="7332448">:=</span>&nbsp;<span class="ident" id="7332451">strconv</span><span class="op" id="7332458">.</span><span class="ident" id="7332459">Atoi</span><span class="op" id="7332463">(</span><span class="ident" id="7332464">pidstr</span><span class="op" id="7332470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332473">if</span>&nbsp;<span class="ident" id="7332476">err</span>&nbsp;<span class="op" id="7332480">!=</span>&nbsp;<span class="builtintype" id="7332483">nil</span>&nbsp;<span class="op" id="7332487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332491">t</span><span class="op" id="7332492">.</span><span class="ident" id="7332493">Fatalf</span><span class="op" id="7332499">(</span><span class="string" id="7332500">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="7332525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332532">var</span>&nbsp;<span class="ident" id="7332536">buf</span>&nbsp;<span class="op" id="7332540">[</span><span class="num" id="7332541">5000</span><span class="op" id="7332545">]</span><span class="builtintype" id="7332546">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332552">n</span><span class="op" id="7332553">,</span>&nbsp;<span class="ident" id="7332555">err</span>&nbsp;<span class="op" id="7332559">:=</span>&nbsp;<span class="ident" id="7332562">io</span><span class="op" id="7332564">.</span><span class="ident" id="7332565">ReadFull</span><span class="op" id="7332573">(</span><span class="ident" id="7332574">res</span><span class="op" id="7332577">.</span><span class="ident" id="7332578">Body</span><span class="op" id="7332582">,</span>&nbsp;<span class="ident" id="7332584">buf</span><span class="op" id="7332587">[</span><span class="op" id="7332588">:</span><span class="op" id="7332589">]</span><span class="op" id="7332590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332593">if</span>&nbsp;<span class="ident" id="7332596">err</span>&nbsp;<span class="op" id="7332600">!=</span>&nbsp;<span class="builtintype" id="7332603">nil</span>&nbsp;<span class="op" id="7332607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332611">t</span><span class="op" id="7332612">.</span><span class="ident" id="7332613">Fatalf</span><span class="op" id="7332619">(</span><span class="string" id="7332620">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="7332644">,</span>&nbsp;<span class="ident" id="7332646">n</span><span class="op" id="7332647">,</span>&nbsp;<span class="ident" id="7332649">err</span><span class="op" id="7332652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332655">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332659">childRunning</span>&nbsp;<span class="op" id="7332672">:=</span>&nbsp;<span class="keyword" id="7332675">func</span><span class="op" id="7332679">(</span><span class="op" id="7332680">)</span>&nbsp;<span class="builtintype" id="7332682">bool</span>&nbsp;<span class="op" id="7332687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332691">return</span>&nbsp;<span class="ident" id="7332698">isProcessRunning</span><span class="op" id="7332714">(</span><span class="ident" id="7332715">t</span><span class="op" id="7332716">,</span>&nbsp;<span class="ident" id="7332718">pid</span><span class="op" id="7332721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332728">if</span>&nbsp;<span class="op" id="7332731">!</span><span class="ident" id="7332732">childRunning</span><span class="op" id="7332744">(</span><span class="op" id="7332745">)</span>&nbsp;<span class="op" id="7332747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332751">t</span><span class="op" id="7332752">.</span><span class="ident" id="7332753">Fatalf</span><span class="op" id="7332759">(</span><span class="string" id="7332760">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="7332806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332812">conn</span><span class="op" id="7332816">.</span><span class="ident" id="7332817">Close</span><span class="op" id="7332822">(</span><span class="op" id="7332823">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332827">tries</span>&nbsp;<span class="op" id="7332833">:=</span>&nbsp;<span class="num" id="7332836">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332839">for</span>&nbsp;<span class="ident" id="7332843">tries</span>&nbsp;<span class="op" id="7332849">&lt;</span>&nbsp;<span class="num" id="7332851">25</span>&nbsp;<span class="op" id="7332854">&amp;&amp;</span>&nbsp;<span class="ident" id="7332857">childRunning</span><span class="op" id="7332869">(</span><span class="op" id="7332870">)</span>&nbsp;<span class="op" id="7332872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332876">time</span><span class="op" id="7332880">.</span><span class="ident" id="7332881">Sleep</span><span class="op" id="7332886">(</span><span class="num" id="7332887">50</span>&nbsp;<span class="op" id="7332890">*</span>&nbsp;<span class="ident" id="7332892">time</span><span class="op" id="7332896">.</span><span class="ident" id="7332897">Millisecond</span>&nbsp;<span class="op" id="7332909">*</span>&nbsp;<span class="ident" id="7332911">time</span><span class="op" id="7332915">.</span><span class="ident" id="7332916">Duration</span><span class="op" id="7332924">(</span><span class="ident" id="7332925">tries</span><span class="op" id="7332930">)</span><span class="op" id="7332931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332935">tries</span><span class="op" id="7332940">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7332944">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7332947">if</span>&nbsp;<span class="ident" id="7332950">childRunning</span><span class="op" id="7332962">(</span><span class="op" id="7332963">)</span>&nbsp;<span class="op" id="7332965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7332969">t</span><span class="op" id="7332970">.</span><span class="ident" id="7332971">Fatalf</span><span class="op" id="7332977">(</span><span class="string" id="7332978">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="7333022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333025">}</span><br>
<span class="lineno"></span><span class="op" id="7333027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="7333030">func</span>&nbsp;<span class="ident" id="7333035">TestDirUnix</span><span class="op" id="7333046">(</span><span class="ident" id="7333047">t</span>&nbsp;<span class="op" id="7333049">*</span><span class="ident" id="7333050">testing</span><span class="op" id="7333057">.</span><span class="ident" id="7333058">T</span><span class="op" id="7333059">)</span>&nbsp;<span class="op" id="7333061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333064">check</span><span class="op" id="7333069">(</span><span class="ident" id="7333070">t</span><span class="op" id="7333071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7333074">if</span>&nbsp;<span class="ident" id="7333077">runtime</span><span class="op" id="7333084">.</span><span class="ident" id="7333085">GOOS</span>&nbsp;<span class="op" id="7333090">==</span>&nbsp;<span class="string" id="7333093">&#34;windows&#34;</span>&nbsp;<span class="op" id="7333103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333107">t</span><span class="op" id="7333108">.</span><span class="ident" id="7333109">Skipf</span><span class="op" id="7333114">(</span><span class="string" id="7333115">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7333136">,</span>&nbsp;<span class="ident" id="7333138">runtime</span><span class="op" id="7333145">.</span><span class="ident" id="7333146">GOOS</span><span class="op" id="7333150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333153">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333156">cwd</span><span class="op" id="7333159">,</span>&nbsp;<span class="ident" id="7333161">_</span>&nbsp;<span class="op" id="7333163">:=</span>&nbsp;<span class="ident" id="7333166">os</span><span class="op" id="7333168">.</span><span class="ident" id="7333169">Getwd</span><span class="op" id="7333174">(</span><span class="op" id="7333175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333178">h</span>&nbsp;<span class="op" id="7333180">:=</span>&nbsp;<span class="op" id="7333183">&amp;</span><span class="ident" id="7333184">Handler</span><span class="op" id="7333191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333195">Path</span><span class="op" id="7333199">:</span>&nbsp;<span class="string" id="7333201">&#34;testdata/test.cgi&#34;</span><span class="op" id="7333220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333224">Root</span><span class="op" id="7333228">:</span>&nbsp;<span class="string" id="7333230">&#34;/test.cgi&#34;</span><span class="op" id="7333241">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333245">Dir</span><span class="op" id="7333248">:</span>&nbsp;&nbsp;<span class="ident" id="7333251">cwd</span><span class="op" id="7333254">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333260">expectedMap</span>&nbsp;<span class="op" id="7333272">:=</span>&nbsp;<span class="keyword" id="7333275">map</span><span class="op" id="7333278">[</span><span class="builtintype" id="7333279">string</span><span class="op" id="7333285">]</span><span class="builtintype" id="7333286">string</span><span class="op" id="7333292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7333296">&#34;cwd&#34;</span><span class="op" id="7333301">:</span>&nbsp;<span class="ident" id="7333303">cwd</span><span class="op" id="7333306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333312">runCgiTest</span><span class="op" id="7333322">(</span><span class="ident" id="7333323">t</span><span class="op" id="7333324">,</span>&nbsp;<span class="ident" id="7333326">h</span><span class="op" id="7333327">,</span>&nbsp;<span class="string" id="7333329">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7333376">,</span>&nbsp;<span class="ident" id="7333378">expectedMap</span><span class="op" id="7333389">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333393">cwd</span><span class="op" id="7333396">,</span>&nbsp;<span class="ident" id="7333398">_</span>&nbsp;<span class="op" id="7333400">=</span>&nbsp;<span class="ident" id="7333402">os</span><span class="op" id="7333404">.</span><span class="ident" id="7333405">Getwd</span><span class="op" id="7333410">(</span><span class="op" id="7333411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333414">cwd</span>&nbsp;<span class="op" id="7333418">=</span>&nbsp;<span class="ident" id="7333420">filepath</span><span class="op" id="7333428">.</span><span class="ident" id="7333429">Join</span><span class="op" id="7333433">(</span><span class="ident" id="7333434">cwd</span><span class="op" id="7333437">,</span>&nbsp;<span class="string" id="7333439">&#34;testdata&#34;</span><span class="op" id="7333449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333452">h</span>&nbsp;<span class="op" id="7333454">=</span>&nbsp;<span class="op" id="7333456">&amp;</span><span class="ident" id="7333457">Handler</span><span class="op" id="7333464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333468">Path</span><span class="op" id="7333472">:</span>&nbsp;<span class="string" id="7333474">&#34;testdata/test.cgi&#34;</span><span class="op" id="7333493">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333497">Root</span><span class="op" id="7333501">:</span>&nbsp;<span class="string" id="7333503">&#34;/test.cgi&#34;</span><span class="op" id="7333514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333520">expectedMap</span>&nbsp;<span class="op" id="7333532">=</span>&nbsp;<span class="keyword" id="7333534">map</span><span class="op" id="7333537">[</span><span class="builtintype" id="7333538">string</span><span class="op" id="7333544">]</span><span class="builtintype" id="7333545">string</span><span class="op" id="7333551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7333555">&#34;cwd&#34;</span><span class="op" id="7333560">:</span>&nbsp;<span class="ident" id="7333562">cwd</span><span class="op" id="7333565">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333568">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333571">runCgiTest</span><span class="op" id="7333581">(</span><span class="ident" id="7333582">t</span><span class="op" id="7333583">,</span>&nbsp;<span class="ident" id="7333585">h</span><span class="op" id="7333586">,</span>&nbsp;<span class="string" id="7333588">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7333635">,</span>&nbsp;<span class="ident" id="7333637">expectedMap</span><span class="op" id="7333648">)</span><br>
<span class="lineno"></span><span class="op" id="7333650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7333653">func</span>&nbsp;<span class="ident" id="7333658">TestDirWindows</span><span class="op" id="7333672">(</span><span class="ident" id="7333673">t</span>&nbsp;<span class="op" id="7333675">*</span><span class="ident" id="7333676">testing</span><span class="op" id="7333683">.</span><span class="ident" id="7333684">T</span><span class="op" id="7333685">)</span>&nbsp;<span class="op" id="7333687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7333690">if</span>&nbsp;<span class="ident" id="7333693">runtime</span><span class="op" id="7333700">.</span><span class="ident" id="7333701">GOOS</span>&nbsp;<span class="op" id="7333706">!=</span>&nbsp;<span class="string" id="7333709">&#34;windows&#34;</span>&nbsp;<span class="op" id="7333719">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333723">t</span><span class="op" id="7333724">.</span><span class="ident" id="7333725">Skip</span><span class="op" id="7333729">(</span><span class="string" id="7333730">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="7333763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333770">cgifile</span><span class="op" id="7333777">,</span>&nbsp;<span class="ident" id="7333779">_</span>&nbsp;<span class="op" id="7333781">:=</span>&nbsp;<span class="ident" id="7333784">filepath</span><span class="op" id="7333792">.</span><span class="ident" id="7333793">Abs</span><span class="op" id="7333796">(</span><span class="string" id="7333797">&#34;testdata/test.cgi&#34;</span><span class="op" id="7333816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7333820">var</span>&nbsp;<span class="ident" id="7333824">perl</span>&nbsp;<span class="builtintype" id="7333829">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7333837">var</span>&nbsp;<span class="ident" id="7333841">err</span>&nbsp;<span class="builtintype" id="7333845">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333852">perl</span><span class="op" id="7333856">,</span>&nbsp;<span class="ident" id="7333858">err</span>&nbsp;<span class="op" id="7333862">=</span>&nbsp;<span class="ident" id="7333864">exec</span><span class="op" id="7333868">.</span><span class="ident" id="7333869">LookPath</span><span class="op" id="7333877">(</span><span class="string" id="7333878">&#34;perl&#34;</span><span class="op" id="7333884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7333887">if</span>&nbsp;<span class="ident" id="7333890">err</span>&nbsp;<span class="op" id="7333894">!=</span>&nbsp;<span class="builtintype" id="7333897">nil</span>&nbsp;<span class="op" id="7333901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333905">t</span><span class="op" id="7333906">.</span><span class="ident" id="7333907">Skip</span><span class="op" id="7333911">(</span><span class="string" id="7333912">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7333944">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7333947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333950">perl</span><span class="op" id="7333954">,</span>&nbsp;<span class="ident" id="7333956">_</span>&nbsp;<span class="op" id="7333958">=</span>&nbsp;<span class="ident" id="7333960">filepath</span><span class="op" id="7333968">.</span><span class="ident" id="7333969">Abs</span><span class="op" id="7333972">(</span><span class="ident" id="7333973">perl</span><span class="op" id="7333977">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7333981">cwd</span><span class="op" id="7333984">,</span>&nbsp;<span class="ident" id="7333986">_</span>&nbsp;<span class="op" id="7333988">:=</span>&nbsp;<span class="ident" id="7333991">os</span><span class="op" id="7333993">.</span><span class="ident" id="7333994">Getwd</span><span class="op" id="7333999">(</span><span class="op" id="7334000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334003">h</span>&nbsp;<span class="op" id="7334005">:=</span>&nbsp;<span class="op" id="7334008">&amp;</span><span class="ident" id="7334009">Handler</span><span class="op" id="7334016">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334020">Path</span><span class="op" id="7334024">:</span>&nbsp;<span class="ident" id="7334026">perl</span><span class="op" id="7334030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334034">Root</span><span class="op" id="7334038">:</span>&nbsp;<span class="string" id="7334040">&#34;/test.cgi&#34;</span><span class="op" id="7334051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334055">Dir</span><span class="op" id="7334058">:</span>&nbsp;&nbsp;<span class="ident" id="7334061">cwd</span><span class="op" id="7334064">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334068">Args</span><span class="op" id="7334072">:</span>&nbsp;<span class="op" id="7334074">[</span><span class="op" id="7334075">]</span><span class="builtintype" id="7334076">string</span><span class="op" id="7334082">{</span><span class="ident" id="7334083">cgifile</span><span class="op" id="7334090">}</span><span class="op" id="7334091">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334095">Env</span><span class="op" id="7334098">:</span>&nbsp;&nbsp;<span class="op" id="7334101">[</span><span class="op" id="7334102">]</span><span class="builtintype" id="7334103">string</span><span class="op" id="7334109">{</span><span class="string" id="7334110">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7334129">+</span>&nbsp;<span class="ident" id="7334131">cgifile</span><span class="op" id="7334138">}</span><span class="op" id="7334139">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7334142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334145">expectedMap</span>&nbsp;<span class="op" id="7334157">:=</span>&nbsp;<span class="keyword" id="7334160">map</span><span class="op" id="7334163">[</span><span class="builtintype" id="7334164">string</span><span class="op" id="7334170">]</span><span class="builtintype" id="7334171">string</span><span class="op" id="7334177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7334181">&#34;cwd&#34;</span><span class="op" id="7334186">:</span>&nbsp;<span class="ident" id="7334188">cwd</span><span class="op" id="7334191">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7334194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334197">runCgiTest</span><span class="op" id="7334207">(</span><span class="ident" id="7334208">t</span><span class="op" id="7334209">,</span>&nbsp;<span class="ident" id="7334211">h</span><span class="op" id="7334212">,</span>&nbsp;<span class="string" id="7334214">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7334261">,</span>&nbsp;<span class="ident" id="7334263">expectedMap</span><span class="op" id="7334274">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7334278">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7334341">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334369">cwd</span><span class="op" id="7334372">,</span>&nbsp;<span class="ident" id="7334374">_</span>&nbsp;<span class="op" id="7334376">=</span>&nbsp;<span class="ident" id="7334378">filepath</span><span class="op" id="7334386">.</span><span class="ident" id="7334387">Split</span><span class="op" id="7334392">(</span><span class="ident" id="7334393">perl</span><span class="op" id="7334397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7334400">if</span>&nbsp;<span class="ident" id="7334403">cwd</span>&nbsp;<span class="op" id="7334407">!=</span>&nbsp;<span class="string" id="7334410">&#34;&#34;</span>&nbsp;<span class="op" id="7334413">&amp;&amp;</span>&nbsp;<span class="ident" id="7334416">cwd</span><span class="op" id="7334419">[</span><span class="builtinfunc" id="7334420">len</span><span class="op" id="7334423">(</span><span class="ident" id="7334424">cwd</span><span class="op" id="7334427">)</span><span class="op" id="7334428">-</span><span class="num" id="7334429">1</span><span class="op" id="7334430">]</span>&nbsp;<span class="op" id="7334432">==</span>&nbsp;<span class="ident" id="7334435">filepath</span><span class="op" id="7334443">.</span><span class="ident" id="7334444">Separator</span>&nbsp;<span class="op" id="7334454">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334458">cwd</span>&nbsp;<span class="op" id="7334462">=</span>&nbsp;<span class="ident" id="7334464">cwd</span><span class="op" id="7334467">[</span><span class="op" id="7334468">:</span><span class="builtinfunc" id="7334469">len</span><span class="op" id="7334472">(</span><span class="ident" id="7334473">cwd</span><span class="op" id="7334476">)</span><span class="op" id="7334477">-</span><span class="num" id="7334478">1</span><span class="op" id="7334479">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7334482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334485">h</span>&nbsp;<span class="op" id="7334487">=</span>&nbsp;<span class="op" id="7334489">&amp;</span><span class="ident" id="7334490">Handler</span><span class="op" id="7334497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334501">Path</span><span class="op" id="7334505">:</span>&nbsp;<span class="ident" id="7334507">perl</span><span class="op" id="7334511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334515">Root</span><span class="op" id="7334519">:</span>&nbsp;<span class="string" id="7334521">&#34;/test.cgi&#34;</span><span class="op" id="7334532">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334536">Args</span><span class="op" id="7334540">:</span>&nbsp;<span class="op" id="7334542">[</span><span class="op" id="7334543">]</span><span class="builtintype" id="7334544">string</span><span class="op" id="7334550">{</span><span class="ident" id="7334551">cgifile</span><span class="op" id="7334558">}</span><span class="op" id="7334559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334563">Env</span><span class="op" id="7334566">:</span>&nbsp;&nbsp;<span class="op" id="7334569">[</span><span class="op" id="7334570">]</span><span class="builtintype" id="7334571">string</span><span class="op" id="7334577">{</span><span class="string" id="7334578">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7334597">+</span>&nbsp;<span class="ident" id="7334599">cgifile</span><span class="op" id="7334606">}</span><span class="op" id="7334607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7334610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334613">expectedMap</span>&nbsp;<span class="op" id="7334625">=</span>&nbsp;<span class="keyword" id="7334627">map</span><span class="op" id="7334630">[</span><span class="builtintype" id="7334631">string</span><span class="op" id="7334637">]</span><span class="builtintype" id="7334638">string</span><span class="op" id="7334644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7334648">&#34;cwd&#34;</span><span class="op" id="7334653">:</span>&nbsp;<span class="ident" id="7334655">cwd</span><span class="op" id="7334658">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7334661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334664">runCgiTest</span><span class="op" id="7334674">(</span><span class="ident" id="7334675">t</span><span class="op" id="7334676">,</span>&nbsp;<span class="ident" id="7334678">h</span><span class="op" id="7334679">,</span>&nbsp;<span class="string" id="7334681">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7334728">,</span>&nbsp;<span class="ident" id="7334730">expectedMap</span><span class="op" id="7334741">)</span><br>
<span class="lineno"></span><span class="op" id="7334743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7334746">func</span>&nbsp;<span class="ident" id="7334751">TestEnvOverride</span><span class="op" id="7334766">(</span><span class="ident" id="7334767">t</span>&nbsp;<span class="op" id="7334769">*</span><span class="ident" id="7334770">testing</span><span class="op" id="7334777">.</span><span class="ident" id="7334778">T</span><span class="op" id="7334779">)</span>&nbsp;<span class="op" id="7334781">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334784">cgifile</span><span class="op" id="7334791">,</span>&nbsp;<span class="ident" id="7334793">_</span>&nbsp;<span class="op" id="7334795">:=</span>&nbsp;<span class="ident" id="7334798">filepath</span><span class="op" id="7334806">.</span><span class="ident" id="7334807">Abs</span><span class="op" id="7334810">(</span><span class="string" id="7334811">&#34;testdata/test.cgi&#34;</span><span class="op" id="7334830">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7334834">var</span>&nbsp;<span class="ident" id="7334838">perl</span>&nbsp;<span class="builtintype" id="7334843">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7334851">var</span>&nbsp;<span class="ident" id="7334855">err</span>&nbsp;<span class="builtintype" id="7334859">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334866">perl</span><span class="op" id="7334870">,</span>&nbsp;<span class="ident" id="7334872">err</span>&nbsp;<span class="op" id="7334876">=</span>&nbsp;<span class="ident" id="7334878">exec</span><span class="op" id="7334882">.</span><span class="ident" id="7334883">LookPath</span><span class="op" id="7334891">(</span><span class="string" id="7334892">&#34;perl&#34;</span><span class="op" id="7334898">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7334901">if</span>&nbsp;<span class="ident" id="7334904">err</span>&nbsp;<span class="op" id="7334908">!=</span>&nbsp;<span class="builtintype" id="7334911">nil</span>&nbsp;<span class="op" id="7334915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334919">t</span><span class="op" id="7334920">.</span><span class="ident" id="7334921">Skipf</span><span class="op" id="7334926">(</span><span class="string" id="7334927">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7334959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7334962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334965">perl</span><span class="op" id="7334969">,</span>&nbsp;<span class="ident" id="7334971">_</span>&nbsp;<span class="op" id="7334973">=</span>&nbsp;<span class="ident" id="7334975">filepath</span><span class="op" id="7334983">.</span><span class="ident" id="7334984">Abs</span><span class="op" id="7334987">(</span><span class="ident" id="7334988">perl</span><span class="op" id="7334992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7334996">cwd</span><span class="op" id="7334999">,</span>&nbsp;<span class="ident" id="7335001">_</span>&nbsp;<span class="op" id="7335003">:=</span>&nbsp;<span class="ident" id="7335006">os</span><span class="op" id="7335008">.</span><span class="ident" id="7335009">Getwd</span><span class="op" id="7335014">(</span><span class="op" id="7335015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335018">h</span>&nbsp;<span class="op" id="7335020">:=</span>&nbsp;<span class="op" id="7335023">&amp;</span><span class="ident" id="7335024">Handler</span><span class="op" id="7335031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335035">Path</span><span class="op" id="7335039">:</span>&nbsp;<span class="ident" id="7335041">perl</span><span class="op" id="7335045">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335049">Root</span><span class="op" id="7335053">:</span>&nbsp;<span class="string" id="7335055">&#34;/test.cgi&#34;</span><span class="op" id="7335066">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335070">Dir</span><span class="op" id="7335073">:</span>&nbsp;&nbsp;<span class="ident" id="7335076">cwd</span><span class="op" id="7335079">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335083">Args</span><span class="op" id="7335087">:</span>&nbsp;<span class="op" id="7335089">[</span><span class="op" id="7335090">]</span><span class="builtintype" id="7335091">string</span><span class="op" id="7335097">{</span><span class="ident" id="7335098">cgifile</span><span class="op" id="7335105">}</span><span class="op" id="7335106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335110">Env</span><span class="op" id="7335113">:</span>&nbsp;<span class="op" id="7335115">[</span><span class="op" id="7335116">]</span><span class="builtintype" id="7335117">string</span><span class="op" id="7335123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335128">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7335147">+</span>&nbsp;<span class="ident" id="7335149">cgifile</span><span class="op" id="7335156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335161">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="7335183">}</span><span class="op" id="7335184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7335187">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335190">expectedMap</span>&nbsp;<span class="op" id="7335202">:=</span>&nbsp;<span class="keyword" id="7335205">map</span><span class="op" id="7335208">[</span><span class="builtintype" id="7335209">string</span><span class="op" id="7335215">]</span><span class="builtintype" id="7335216">string</span><span class="op" id="7335222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335226">&#34;cwd&#34;</span><span class="op" id="7335231">:</span>&nbsp;<span class="ident" id="7335233">cwd</span><span class="op" id="7335236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335240">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7335261">:</span>&nbsp;<span class="ident" id="7335263">cgifile</span><span class="op" id="7335270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335274">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7335291">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7335297">&#34;/foo/bar&#34;</span><span class="op" id="7335307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7335310">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7335313">runCgiTest</span><span class="op" id="7335323">(</span><span class="ident" id="7335324">t</span><span class="op" id="7335325">,</span>&nbsp;<span class="ident" id="7335327">h</span><span class="op" id="7335328">,</span>&nbsp;<span class="string" id="7335330">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7335377">,</span>&nbsp;<span class="ident" id="7335379">expectedMap</span><span class="op" id="7335390">)</span><br>
<span class="lineno"></span><span class="op" id="7335392">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
