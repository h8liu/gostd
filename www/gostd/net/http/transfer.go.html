<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html" class="current">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3084627">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3084682">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3084736">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3084787">package</span>&nbsp;<span class="ident" id="3084795">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3084801">import</span>&nbsp;<span class="op" id="3084808">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084811">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084820">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084829">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084839">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084846">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084852">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084865">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084886">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084903">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084911">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084922">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3084933">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3084940">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3084943">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3085013">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3085049">var</span>&nbsp;<span class="ident" id="3085053">ErrLineTooLong</span>&nbsp;<span class="op" id="3085068">=</span>&nbsp;<span class="ident" id="3085070">internal</span><span class="op" id="3085078">.</span><span class="ident" id="3085079">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3085095">type</span>&nbsp;<span class="ident" id="3085100">errorReader</span>&nbsp;<span class="keyword" id="3085112">struct</span>&nbsp;<span class="op" id="3085119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085122">err</span>&nbsp;<span class="builtintype" id="3085126">error</span><br>
<span class="lineno"></span><span class="op" id="3085132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3085135">func</span>&nbsp;<span class="op" id="3085140">(</span><span class="ident" id="3085141">r</span>&nbsp;<span class="op" id="3085143">*</span><span class="ident" id="3085144">errorReader</span><span class="op" id="3085155">)</span>&nbsp;<span class="ident" id="3085157">Read</span><span class="op" id="3085161">(</span><span class="ident" id="3085162">p</span>&nbsp;<span class="op" id="3085164">[</span><span class="op" id="3085165">]</span><span class="builtintype" id="3085166">byte</span><span class="op" id="3085170">)</span>&nbsp;<span class="op" id="3085172">(</span><span class="ident" id="3085173">n</span>&nbsp;<span class="builtintype" id="3085175">int</span><span class="op" id="3085178">,</span>&nbsp;<span class="ident" id="3085180">err</span>&nbsp;<span class="builtintype" id="3085184">error</span><span class="op" id="3085189">)</span>&nbsp;<span class="op" id="3085191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3085194">return</span>&nbsp;<span class="num" id="3085201">0</span><span class="op" id="3085202">,</span>&nbsp;<span class="ident" id="3085204">r</span><span class="op" id="3085205">.</span><span class="ident" id="3085206">err</span><br>
<span class="lineno"></span><span class="op" id="3085210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3085213">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3085291">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3085367">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3085434">type</span>&nbsp;<span class="ident" id="3085439">transferWriter</span>&nbsp;<span class="keyword" id="3085454">struct</span>&nbsp;<span class="op" id="3085461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085464">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3085481">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085489">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085506">io</span><span class="op" id="3085508">.</span><span class="ident" id="3085509">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085517">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085534">io</span><span class="op" id="3085536">.</span><span class="ident" id="3085537">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085545">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3085562">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085568">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085585">int64</span>&nbsp;<span class="comment" id="3085591">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085634">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3085651">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085657">TransferEncoding</span>&nbsp;<span class="op" id="3085674">[</span><span class="op" id="3085675">]</span><span class="builtintype" id="3085676">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085684">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085701">Header</span><br>
<span class="lineno"></span><span class="op" id="3085708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3085711">func</span>&nbsp;<span class="ident" id="3085716">newTransferWriter</span><span class="op" id="3085733">(</span><span class="ident" id="3085734">r</span>&nbsp;<span class="keyword" id="3085736">interface</span><span class="op" id="3085745">{</span><span class="op" id="3085746">}</span><span class="op" id="3085747">)</span>&nbsp;<span class="op" id="3085749">(</span><span class="ident" id="3085750">t</span>&nbsp;<span class="op" id="3085752">*</span><span class="ident" id="3085753">transferWriter</span><span class="op" id="3085767">,</span>&nbsp;<span class="ident" id="3085769">err</span>&nbsp;<span class="builtintype" id="3085773">error</span><span class="op" id="3085778">)</span>&nbsp;<span class="op" id="3085780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085783">t</span>&nbsp;<span class="op" id="3085785">=</span>&nbsp;<span class="op" id="3085787">&amp;</span><span class="ident" id="3085788">transferWriter</span><span class="op" id="3085802">{</span><span class="op" id="3085803">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3085807">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3085835">atLeastHTTP11</span>&nbsp;<span class="op" id="3085849">:=</span>&nbsp;<span class="builtintype" id="3085852">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3085859">switch</span>&nbsp;<span class="ident" id="3085866">rr</span>&nbsp;<span class="op" id="3085869">:=</span>&nbsp;<span class="ident" id="3085872">r</span><span class="op" id="3085873">.</span><span class="op" id="3085874">(</span><span class="keyword" id="3085875">type</span><span class="op" id="3085879">)</span>&nbsp;<span class="op" id="3085881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3085884">case</span>&nbsp;<span class="op" id="3085889">*</span><span class="ident" id="3085890">Request</span><span class="op" id="3085897">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3085901">if</span>&nbsp;<span class="ident" id="3085904">rr</span><span class="op" id="3085906">.</span><span class="ident" id="3085907">ContentLength</span>&nbsp;<span class="op" id="3085921">!=</span>&nbsp;<span class="num" id="3085924">0</span>&nbsp;<span class="op" id="3085926">&amp;&amp;</span>&nbsp;<span class="ident" id="3085929">rr</span><span class="op" id="3085931">.</span><span class="ident" id="3085932">Body</span>&nbsp;<span class="op" id="3085937">==</span>&nbsp;<span class="builtintype" id="3085940">nil</span>&nbsp;<span class="op" id="3085944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3085949">return</span>&nbsp;<span class="builtintype" id="3085956">nil</span><span class="op" id="3085959">,</span>&nbsp;<span class="ident" id="3085961">fmt</span><span class="op" id="3085964">.</span><span class="ident" id="3085965">Errorf</span><span class="op" id="3085971">(</span><span class="string" id="3085972">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3086018">,</span>&nbsp;<span class="ident" id="3086020">rr</span><span class="op" id="3086022">.</span><span class="ident" id="3086023">ContentLength</span><span class="op" id="3086036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3086040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086044">t</span><span class="op" id="3086045">.</span><span class="ident" id="3086046">Method</span>&nbsp;<span class="op" id="3086053">=</span>&nbsp;<span class="ident" id="3086055">rr</span><span class="op" id="3086057">.</span><span class="ident" id="3086058">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086067">t</span><span class="op" id="3086068">.</span><span class="ident" id="3086069">Body</span>&nbsp;<span class="op" id="3086074">=</span>&nbsp;<span class="ident" id="3086076">rr</span><span class="op" id="3086078">.</span><span class="ident" id="3086079">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086086">t</span><span class="op" id="3086087">.</span><span class="ident" id="3086088">BodyCloser</span>&nbsp;<span class="op" id="3086099">=</span>&nbsp;<span class="ident" id="3086101">rr</span><span class="op" id="3086103">.</span><span class="ident" id="3086104">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086111">t</span><span class="op" id="3086112">.</span><span class="ident" id="3086113">ContentLength</span>&nbsp;<span class="op" id="3086127">=</span>&nbsp;<span class="ident" id="3086129">rr</span><span class="op" id="3086131">.</span><span class="ident" id="3086132">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086148">t</span><span class="op" id="3086149">.</span><span class="ident" id="3086150">Close</span>&nbsp;<span class="op" id="3086156">=</span>&nbsp;<span class="ident" id="3086158">rr</span><span class="op" id="3086160">.</span><span class="ident" id="3086161">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086169">t</span><span class="op" id="3086170">.</span><span class="ident" id="3086171">TransferEncoding</span>&nbsp;<span class="op" id="3086188">=</span>&nbsp;<span class="ident" id="3086190">rr</span><span class="op" id="3086192">.</span><span class="ident" id="3086193">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086212">t</span><span class="op" id="3086213">.</span><span class="ident" id="3086214">Trailer</span>&nbsp;<span class="op" id="3086222">=</span>&nbsp;<span class="ident" id="3086224">rr</span><span class="op" id="3086226">.</span><span class="ident" id="3086227">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086237">atLeastHTTP11</span>&nbsp;<span class="op" id="3086251">=</span>&nbsp;<span class="ident" id="3086253">rr</span><span class="op" id="3086255">.</span><span class="ident" id="3086256">ProtoAtLeast</span><span class="op" id="3086268">(</span><span class="num" id="3086269">1</span><span class="op" id="3086270">,</span>&nbsp;<span class="num" id="3086272">1</span><span class="op" id="3086273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3086277">if</span>&nbsp;<span class="ident" id="3086280">t</span><span class="op" id="3086281">.</span><span class="ident" id="3086282">Body</span>&nbsp;<span class="op" id="3086287">!=</span>&nbsp;<span class="builtintype" id="3086290">nil</span>&nbsp;<span class="op" id="3086294">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3086297">len</span><span class="op" id="3086300">(</span><span class="ident" id="3086301">t</span><span class="op" id="3086302">.</span><span class="ident" id="3086303">TransferEncoding</span><span class="op" id="3086319">)</span>&nbsp;<span class="op" id="3086321">==</span>&nbsp;<span class="num" id="3086324">0</span>&nbsp;<span class="op" id="3086326">&amp;&amp;</span>&nbsp;<span class="ident" id="3086329">atLeastHTTP11</span>&nbsp;<span class="op" id="3086343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3086348">if</span>&nbsp;<span class="ident" id="3086351">t</span><span class="op" id="3086352">.</span><span class="ident" id="3086353">ContentLength</span>&nbsp;<span class="op" id="3086367">==</span>&nbsp;<span class="num" id="3086370">0</span>&nbsp;<span class="op" id="3086372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3086378">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3086434">var</span>&nbsp;<span class="ident" id="3086438">buf</span>&nbsp;<span class="op" id="3086442">[</span><span class="num" id="3086443">1</span><span class="op" id="3086444">]</span><span class="builtintype" id="3086445">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086454">n</span><span class="op" id="3086455">,</span>&nbsp;<span class="ident" id="3086457">rerr</span>&nbsp;<span class="op" id="3086462">:=</span>&nbsp;<span class="ident" id="3086465">io</span><span class="op" id="3086467">.</span><span class="ident" id="3086468">ReadFull</span><span class="op" id="3086476">(</span><span class="ident" id="3086477">t</span><span class="op" id="3086478">.</span><span class="ident" id="3086479">Body</span><span class="op" id="3086483">,</span>&nbsp;<span class="ident" id="3086485">buf</span><span class="op" id="3086488">[</span><span class="op" id="3086489">:</span><span class="op" id="3086490">]</span><span class="op" id="3086491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3086497">if</span>&nbsp;<span class="ident" id="3086500">rerr</span>&nbsp;<span class="op" id="3086505">!=</span>&nbsp;<span class="builtintype" id="3086508">nil</span>&nbsp;<span class="op" id="3086512">&amp;&amp;</span>&nbsp;<span class="ident" id="3086515">rerr</span>&nbsp;<span class="op" id="3086520">!=</span>&nbsp;<span class="ident" id="3086523">io</span><span class="op" id="3086525">.</span><span class="ident" id="3086526">EOF</span>&nbsp;<span class="op" id="3086530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086537">t</span><span class="op" id="3086538">.</span><span class="ident" id="3086539">ContentLength</span>&nbsp;<span class="op" id="3086553">=</span>&nbsp;<span class="op" id="3086555">-</span><span class="num" id="3086556">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086563">t</span><span class="op" id="3086564">.</span><span class="ident" id="3086565">Body</span>&nbsp;<span class="op" id="3086570">=</span>&nbsp;<span class="op" id="3086572">&amp;</span><span class="ident" id="3086573">errorReader</span><span class="op" id="3086584">{</span><span class="ident" id="3086585">rerr</span><span class="op" id="3086589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3086595">}</span>&nbsp;<span class="keyword" id="3086597">else</span>&nbsp;<span class="keyword" id="3086602">if</span>&nbsp;<span class="ident" id="3086605">n</span>&nbsp;<span class="op" id="3086607">==</span>&nbsp;<span class="num" id="3086610">1</span>&nbsp;<span class="op" id="3086612">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3086619">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3086682">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3086731">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3086792">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086815">t</span><span class="op" id="3086816">.</span><span class="ident" id="3086817">ContentLength</span>&nbsp;<span class="op" id="3086831">=</span>&nbsp;<span class="op" id="3086833">-</span><span class="num" id="3086834">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086841">t</span><span class="op" id="3086842">.</span><span class="ident" id="3086843">Body</span>&nbsp;<span class="op" id="3086848">=</span>&nbsp;<span class="ident" id="3086850">io</span><span class="op" id="3086852">.</span><span class="ident" id="3086853">MultiReader</span><span class="op" id="3086864">(</span><span class="ident" id="3086865">bytes</span><span class="op" id="3086870">.</span><span class="ident" id="3086871">NewReader</span><span class="op" id="3086880">(</span><span class="ident" id="3086881">buf</span><span class="op" id="3086884">[</span><span class="op" id="3086885">:</span><span class="op" id="3086886">]</span><span class="op" id="3086887">)</span><span class="op" id="3086888">,</span>&nbsp;<span class="ident" id="3086890">t</span><span class="op" id="3086891">.</span><span class="ident" id="3086892">Body</span><span class="op" id="3086896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3086902">}</span>&nbsp;<span class="keyword" id="3086904">else</span>&nbsp;<span class="op" id="3086909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3086916">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086948">t</span><span class="op" id="3086949">.</span><span class="ident" id="3086950">Body</span>&nbsp;<span class="op" id="3086955">=</span>&nbsp;<span class="builtintype" id="3086957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3086966">t</span><span class="op" id="3086967">.</span><span class="ident" id="3086968">BodyCloser</span>&nbsp;<span class="op" id="3086979">=</span>&nbsp;<span class="builtintype" id="3086981">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3086989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3086994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3086999">if</span>&nbsp;<span class="ident" id="3087002">t</span><span class="op" id="3087003">.</span><span class="ident" id="3087004">ContentLength</span>&nbsp;<span class="op" id="3087018">&lt;</span>&nbsp;<span class="num" id="3087020">0</span>&nbsp;<span class="op" id="3087022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087028">t</span><span class="op" id="3087029">.</span><span class="ident" id="3087030">TransferEncoding</span>&nbsp;<span class="op" id="3087047">=</span>&nbsp;<span class="op" id="3087049">[</span><span class="op" id="3087050">]</span><span class="builtintype" id="3087051">string</span><span class="op" id="3087057">{</span><span class="string" id="3087058">&#34;chunked&#34;</span><span class="op" id="3087067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087072">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087079">case</span>&nbsp;<span class="op" id="3087084">*</span><span class="ident" id="3087085">Response</span><span class="op" id="3087093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087097">if</span>&nbsp;<span class="ident" id="3087100">rr</span><span class="op" id="3087102">.</span><span class="ident" id="3087103">Request</span>&nbsp;<span class="op" id="3087111">!=</span>&nbsp;<span class="builtintype" id="3087114">nil</span>&nbsp;<span class="op" id="3087118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087123">t</span><span class="op" id="3087124">.</span><span class="ident" id="3087125">Method</span>&nbsp;<span class="op" id="3087132">=</span>&nbsp;<span class="ident" id="3087134">rr</span><span class="op" id="3087136">.</span><span class="ident" id="3087137">Request</span><span class="op" id="3087144">.</span><span class="ident" id="3087145">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087154">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087158">t</span><span class="op" id="3087159">.</span><span class="ident" id="3087160">Body</span>&nbsp;<span class="op" id="3087165">=</span>&nbsp;<span class="ident" id="3087167">rr</span><span class="op" id="3087169">.</span><span class="ident" id="3087170">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087177">t</span><span class="op" id="3087178">.</span><span class="ident" id="3087179">BodyCloser</span>&nbsp;<span class="op" id="3087190">=</span>&nbsp;<span class="ident" id="3087192">rr</span><span class="op" id="3087194">.</span><span class="ident" id="3087195">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087202">t</span><span class="op" id="3087203">.</span><span class="ident" id="3087204">ContentLength</span>&nbsp;<span class="op" id="3087218">=</span>&nbsp;<span class="ident" id="3087220">rr</span><span class="op" id="3087222">.</span><span class="ident" id="3087223">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087239">t</span><span class="op" id="3087240">.</span><span class="ident" id="3087241">Close</span>&nbsp;<span class="op" id="3087247">=</span>&nbsp;<span class="ident" id="3087249">rr</span><span class="op" id="3087251">.</span><span class="ident" id="3087252">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087260">t</span><span class="op" id="3087261">.</span><span class="ident" id="3087262">TransferEncoding</span>&nbsp;<span class="op" id="3087279">=</span>&nbsp;<span class="ident" id="3087281">rr</span><span class="op" id="3087283">.</span><span class="ident" id="3087284">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087303">t</span><span class="op" id="3087304">.</span><span class="ident" id="3087305">Trailer</span>&nbsp;<span class="op" id="3087313">=</span>&nbsp;<span class="ident" id="3087315">rr</span><span class="op" id="3087317">.</span><span class="ident" id="3087318">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087328">atLeastHTTP11</span>&nbsp;<span class="op" id="3087342">=</span>&nbsp;<span class="ident" id="3087344">rr</span><span class="op" id="3087346">.</span><span class="ident" id="3087347">ProtoAtLeast</span><span class="op" id="3087359">(</span><span class="num" id="3087360">1</span><span class="op" id="3087361">,</span>&nbsp;<span class="num" id="3087363">1</span><span class="op" id="3087364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087368">t</span><span class="op" id="3087369">.</span><span class="ident" id="3087370">ResponseToHEAD</span>&nbsp;<span class="op" id="3087385">=</span>&nbsp;<span class="ident" id="3087387">noBodyExpected</span><span class="op" id="3087401">(</span><span class="ident" id="3087402">t</span><span class="op" id="3087403">.</span><span class="ident" id="3087404">Method</span><span class="op" id="3087410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3087417">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087466">if</span>&nbsp;<span class="ident" id="3087469">t</span><span class="op" id="3087470">.</span><span class="ident" id="3087471">ResponseToHEAD</span>&nbsp;<span class="op" id="3087486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087490">t</span><span class="op" id="3087491">.</span><span class="ident" id="3087492">Body</span>&nbsp;<span class="op" id="3087497">=</span>&nbsp;<span class="builtintype" id="3087499">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087505">if</span>&nbsp;<span class="ident" id="3087508">chunked</span><span class="op" id="3087515">(</span><span class="ident" id="3087516">t</span><span class="op" id="3087517">.</span><span class="ident" id="3087518">TransferEncoding</span><span class="op" id="3087534">)</span>&nbsp;<span class="op" id="3087536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087541">t</span><span class="op" id="3087542">.</span><span class="ident" id="3087543">ContentLength</span>&nbsp;<span class="op" id="3087557">=</span>&nbsp;<span class="op" id="3087559">-</span><span class="num" id="3087560">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087567">}</span>&nbsp;<span class="keyword" id="3087569">else</span>&nbsp;<span class="op" id="3087574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087578">if</span>&nbsp;<span class="op" id="3087581">!</span><span class="ident" id="3087582">atLeastHTTP11</span>&nbsp;<span class="op" id="3087596">||</span>&nbsp;<span class="ident" id="3087599">t</span><span class="op" id="3087600">.</span><span class="ident" id="3087601">Body</span>&nbsp;<span class="op" id="3087606">==</span>&nbsp;<span class="builtintype" id="3087609">nil</span>&nbsp;<span class="op" id="3087613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087618">t</span><span class="op" id="3087619">.</span><span class="ident" id="3087620">TransferEncoding</span>&nbsp;<span class="op" id="3087637">=</span>&nbsp;<span class="builtintype" id="3087639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087645">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087649">if</span>&nbsp;<span class="ident" id="3087652">chunked</span><span class="op" id="3087659">(</span><span class="ident" id="3087660">t</span><span class="op" id="3087661">.</span><span class="ident" id="3087662">TransferEncoding</span><span class="op" id="3087678">)</span>&nbsp;<span class="op" id="3087680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087685">t</span><span class="op" id="3087686">.</span><span class="ident" id="3087687">ContentLength</span>&nbsp;<span class="op" id="3087701">=</span>&nbsp;<span class="op" id="3087703">-</span><span class="num" id="3087704">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087708">}</span>&nbsp;<span class="keyword" id="3087710">else</span>&nbsp;<span class="keyword" id="3087715">if</span>&nbsp;<span class="ident" id="3087718">t</span><span class="op" id="3087719">.</span><span class="ident" id="3087720">Body</span>&nbsp;<span class="op" id="3087725">==</span>&nbsp;<span class="builtintype" id="3087728">nil</span>&nbsp;<span class="op" id="3087732">{</span>&nbsp;<span class="comment" id="3087734">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087761">t</span><span class="op" id="3087762">.</span><span class="ident" id="3087763">ContentLength</span>&nbsp;<span class="op" id="3087777">=</span>&nbsp;<span class="num" id="3087779">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087783">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3087790">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087811">if</span>&nbsp;<span class="op" id="3087814">!</span><span class="ident" id="3087815">chunked</span><span class="op" id="3087822">(</span><span class="ident" id="3087823">t</span><span class="op" id="3087824">.</span><span class="ident" id="3087825">TransferEncoding</span><span class="op" id="3087841">)</span>&nbsp;<span class="op" id="3087843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3087847">t</span><span class="op" id="3087848">.</span><span class="ident" id="3087849">Trailer</span>&nbsp;<span class="op" id="3087857">=</span>&nbsp;<span class="builtintype" id="3087859">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3087864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087868">return</span>&nbsp;<span class="ident" id="3087875">t</span><span class="op" id="3087876">,</span>&nbsp;<span class="builtintype" id="3087878">nil</span><br>
<span class="lineno"></span><span class="op" id="3087882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3087885">func</span>&nbsp;<span class="ident" id="3087890">noBodyExpected</span><span class="op" id="3087904">(</span><span class="ident" id="3087905">requestMethod</span>&nbsp;<span class="builtintype" id="3087919">string</span><span class="op" id="3087925">)</span>&nbsp;<span class="builtintype" id="3087927">bool</span>&nbsp;<span class="op" id="3087932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3087935">return</span>&nbsp;<span class="ident" id="3087942">requestMethod</span>&nbsp;<span class="op" id="3087956">==</span>&nbsp;<span class="string" id="3087959">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3087966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3087969">func</span>&nbsp;<span class="op" id="3087974">(</span><span class="ident" id="3087975">t</span>&nbsp;<span class="op" id="3087977">*</span><span class="ident" id="3087978">transferWriter</span><span class="op" id="3087992">)</span>&nbsp;<span class="ident" id="3087994">shouldSendContentLength</span><span class="op" id="3088017">(</span><span class="op" id="3088018">)</span>&nbsp;<span class="builtintype" id="3088020">bool</span>&nbsp;<span class="op" id="3088025">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088028">if</span>&nbsp;<span class="ident" id="3088031">chunked</span><span class="op" id="3088038">(</span><span class="ident" id="3088039">t</span><span class="op" id="3088040">.</span><span class="ident" id="3088041">TransferEncoding</span><span class="op" id="3088057">)</span>&nbsp;<span class="op" id="3088059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088063">return</span>&nbsp;<span class="builtintype" id="3088070">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088080">if</span>&nbsp;<span class="ident" id="3088083">t</span><span class="op" id="3088084">.</span><span class="ident" id="3088085">ContentLength</span>&nbsp;<span class="op" id="3088099">&gt;</span>&nbsp;<span class="num" id="3088101">0</span>&nbsp;<span class="op" id="3088103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088107">return</span>&nbsp;<span class="builtintype" id="3088114">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3088123">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088182">if</span>&nbsp;<span class="ident" id="3088185">t</span><span class="op" id="3088186">.</span><span class="ident" id="3088187">Method</span>&nbsp;<span class="op" id="3088194">==</span>&nbsp;<span class="string" id="3088197">&#34;POST&#34;</span>&nbsp;<span class="op" id="3088204">||</span>&nbsp;<span class="ident" id="3088207">t</span><span class="op" id="3088208">.</span><span class="ident" id="3088209">Method</span>&nbsp;<span class="op" id="3088216">==</span>&nbsp;<span class="string" id="3088219">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3088225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088229">return</span>&nbsp;<span class="builtintype" id="3088236">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088242">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088245">if</span>&nbsp;<span class="ident" id="3088248">t</span><span class="op" id="3088249">.</span><span class="ident" id="3088250">ContentLength</span>&nbsp;<span class="op" id="3088264">==</span>&nbsp;<span class="num" id="3088267">0</span>&nbsp;<span class="op" id="3088269">&amp;&amp;</span>&nbsp;<span class="ident" id="3088272">isIdentity</span><span class="op" id="3088282">(</span><span class="ident" id="3088283">t</span><span class="op" id="3088284">.</span><span class="ident" id="3088285">TransferEncoding</span><span class="op" id="3088301">)</span>&nbsp;<span class="op" id="3088303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088307">return</span>&nbsp;<span class="builtintype" id="3088314">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088324">return</span>&nbsp;<span class="builtintype" id="3088331">false</span><br>
<span class="lineno">150</span><span class="op" id="3088337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3088340">func</span>&nbsp;<span class="op" id="3088345">(</span><span class="ident" id="3088346">t</span>&nbsp;<span class="op" id="3088348">*</span><span class="ident" id="3088349">transferWriter</span><span class="op" id="3088363">)</span>&nbsp;<span class="ident" id="3088365">WriteHeader</span><span class="op" id="3088376">(</span><span class="ident" id="3088377">w</span>&nbsp;<span class="ident" id="3088379">io</span><span class="op" id="3088381">.</span><span class="ident" id="3088382">Writer</span><span class="op" id="3088388">)</span>&nbsp;<span class="builtintype" id="3088390">error</span>&nbsp;<span class="op" id="3088396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088399">if</span>&nbsp;<span class="ident" id="3088402">t</span><span class="op" id="3088403">.</span><span class="ident" id="3088404">Close</span>&nbsp;<span class="op" id="3088410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088414">if</span>&nbsp;<span class="ident" id="3088417">_</span><span class="op" id="3088418">,</span>&nbsp;<span class="ident" id="3088420">err</span>&nbsp;<span class="op" id="3088424">:=</span>&nbsp;<span class="ident" id="3088427">io</span><span class="op" id="3088429">.</span><span class="ident" id="3088430">WriteString</span><span class="op" id="3088441">(</span><span class="ident" id="3088442">w</span><span class="op" id="3088443">,</span>&nbsp;<span class="string" id="3088445">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3088468">)</span><span class="op" id="3088469">;</span>&nbsp;<span class="ident" id="3088471">err</span>&nbsp;<span class="op" id="3088475">!=</span>&nbsp;<span class="builtintype" id="3088478">nil</span>&nbsp;<span class="op" id="3088482">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088487">return</span>&nbsp;<span class="ident" id="3088494">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3088507">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3088576">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3088641">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088663">if</span>&nbsp;<span class="ident" id="3088666">t</span><span class="op" id="3088667">.</span><span class="ident" id="3088668">shouldSendContentLength</span><span class="op" id="3088691">(</span><span class="op" id="3088692">)</span>&nbsp;<span class="op" id="3088694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088698">if</span>&nbsp;<span class="ident" id="3088701">_</span><span class="op" id="3088702">,</span>&nbsp;<span class="ident" id="3088704">err</span>&nbsp;<span class="op" id="3088708">:=</span>&nbsp;<span class="ident" id="3088711">io</span><span class="op" id="3088713">.</span><span class="ident" id="3088714">WriteString</span><span class="op" id="3088725">(</span><span class="ident" id="3088726">w</span><span class="op" id="3088727">,</span>&nbsp;<span class="string" id="3088729">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3088747">)</span><span class="op" id="3088748">;</span>&nbsp;<span class="ident" id="3088750">err</span>&nbsp;<span class="op" id="3088754">!=</span>&nbsp;<span class="builtintype" id="3088757">nil</span>&nbsp;<span class="op" id="3088761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088766">return</span>&nbsp;<span class="ident" id="3088773">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088783">if</span>&nbsp;<span class="ident" id="3088786">_</span><span class="op" id="3088787">,</span>&nbsp;<span class="ident" id="3088789">err</span>&nbsp;<span class="op" id="3088793">:=</span>&nbsp;<span class="ident" id="3088796">io</span><span class="op" id="3088798">.</span><span class="ident" id="3088799">WriteString</span><span class="op" id="3088810">(</span><span class="ident" id="3088811">w</span><span class="op" id="3088812">,</span>&nbsp;<span class="ident" id="3088814">strconv</span><span class="op" id="3088821">.</span><span class="ident" id="3088822">FormatInt</span><span class="op" id="3088831">(</span><span class="ident" id="3088832">t</span><span class="op" id="3088833">.</span><span class="ident" id="3088834">ContentLength</span><span class="op" id="3088847">,</span>&nbsp;<span class="num" id="3088849">10</span><span class="op" id="3088851">)</span><span class="op" id="3088852">+</span><span class="string" id="3088853">&#34;\r\n&#34;</span><span class="op" id="3088859">)</span><span class="op" id="3088860">;</span>&nbsp;<span class="ident" id="3088862">err</span>&nbsp;<span class="op" id="3088866">!=</span>&nbsp;<span class="builtintype" id="3088869">nil</span>&nbsp;<span class="op" id="3088873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088878">return</span>&nbsp;<span class="ident" id="3088885">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3088894">}</span>&nbsp;<span class="keyword" id="3088896">else</span>&nbsp;<span class="keyword" id="3088901">if</span>&nbsp;<span class="ident" id="3088904">chunked</span><span class="op" id="3088911">(</span><span class="ident" id="3088912">t</span><span class="op" id="3088913">.</span><span class="ident" id="3088914">TransferEncoding</span><span class="op" id="3088930">)</span>&nbsp;<span class="op" id="3088932">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3088936">if</span>&nbsp;<span class="ident" id="3088939">_</span><span class="op" id="3088940">,</span>&nbsp;<span class="ident" id="3088942">err</span>&nbsp;<span class="op" id="3088946">:=</span>&nbsp;<span class="ident" id="3088949">io</span><span class="op" id="3088951">.</span><span class="ident" id="3088952">WriteString</span><span class="op" id="3088963">(</span><span class="ident" id="3088964">w</span><span class="op" id="3088965">,</span>&nbsp;<span class="string" id="3088967">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3088999">)</span><span class="op" id="3089000">;</span>&nbsp;<span class="ident" id="3089002">err</span>&nbsp;<span class="op" id="3089006">!=</span>&nbsp;<span class="builtintype" id="3089009">nil</span>&nbsp;<span class="op" id="3089013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089018">return</span>&nbsp;<span class="ident" id="3089025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3089038">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089063">if</span>&nbsp;<span class="ident" id="3089066">t</span><span class="op" id="3089067">.</span><span class="ident" id="3089068">Trailer</span>&nbsp;<span class="op" id="3089076">!=</span>&nbsp;<span class="builtintype" id="3089079">nil</span>&nbsp;<span class="op" id="3089083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089087">keys</span>&nbsp;<span class="op" id="3089092">:=</span>&nbsp;<span class="builtinfunc" id="3089095">make</span><span class="op" id="3089099">(</span><span class="op" id="3089100">[</span><span class="op" id="3089101">]</span><span class="builtintype" id="3089102">string</span><span class="op" id="3089108">,</span>&nbsp;<span class="num" id="3089110">0</span><span class="op" id="3089111">,</span>&nbsp;<span class="builtinfunc" id="3089113">len</span><span class="op" id="3089116">(</span><span class="ident" id="3089117">t</span><span class="op" id="3089118">.</span><span class="ident" id="3089119">Trailer</span><span class="op" id="3089126">)</span><span class="op" id="3089127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089131">for</span>&nbsp;<span class="ident" id="3089135">k</span>&nbsp;<span class="op" id="3089137">:=</span>&nbsp;<span class="keyword" id="3089140">range</span>&nbsp;<span class="ident" id="3089146">t</span><span class="op" id="3089147">.</span><span class="ident" id="3089148">Trailer</span>&nbsp;<span class="op" id="3089156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089161">k</span>&nbsp;<span class="op" id="3089163">=</span>&nbsp;<span class="ident" id="3089165">CanonicalHeaderKey</span><span class="op" id="3089183">(</span><span class="ident" id="3089184">k</span><span class="op" id="3089185">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089190">switch</span>&nbsp;<span class="ident" id="3089197">k</span>&nbsp;<span class="op" id="3089199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089204">case</span>&nbsp;<span class="string" id="3089209">&#34;Transfer-Encoding&#34;</span><span class="op" id="3089228">,</span>&nbsp;<span class="string" id="3089230">&#34;Trailer&#34;</span><span class="op" id="3089239">,</span>&nbsp;<span class="string" id="3089241">&#34;Content-Length&#34;</span><span class="op" id="3089257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089263">return</span>&nbsp;<span class="op" id="3089270">&amp;</span><span class="ident" id="3089271">badStringError</span><span class="op" id="3089285">{</span><span class="string" id="3089286">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3089307">,</span>&nbsp;<span class="ident" id="3089309">k</span><span class="op" id="3089310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089320">keys</span>&nbsp;<span class="op" id="3089325">=</span>&nbsp;<span class="builtinfunc" id="3089327">append</span><span class="op" id="3089333">(</span><span class="ident" id="3089334">keys</span><span class="op" id="3089338">,</span>&nbsp;<span class="ident" id="3089340">k</span><span class="op" id="3089341">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089349">if</span>&nbsp;<span class="builtinfunc" id="3089352">len</span><span class="op" id="3089355">(</span><span class="ident" id="3089356">keys</span><span class="op" id="3089360">)</span>&nbsp;<span class="op" id="3089362">&gt;</span>&nbsp;<span class="num" id="3089364">0</span>&nbsp;<span class="op" id="3089366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089371">sort</span><span class="op" id="3089375">.</span><span class="ident" id="3089376">Strings</span><span class="op" id="3089383">(</span><span class="ident" id="3089384">keys</span><span class="op" id="3089388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3089393">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3089466">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089495">if</span>&nbsp;<span class="ident" id="3089498">_</span><span class="op" id="3089499">,</span>&nbsp;<span class="ident" id="3089501">err</span>&nbsp;<span class="op" id="3089505">:=</span>&nbsp;<span class="ident" id="3089508">io</span><span class="op" id="3089510">.</span><span class="ident" id="3089511">WriteString</span><span class="op" id="3089522">(</span><span class="ident" id="3089523">w</span><span class="op" id="3089524">,</span>&nbsp;<span class="string" id="3089526">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3089537">+</span><span class="ident" id="3089538">strings</span><span class="op" id="3089545">.</span><span class="ident" id="3089546">Join</span><span class="op" id="3089550">(</span><span class="ident" id="3089551">keys</span><span class="op" id="3089555">,</span>&nbsp;<span class="string" id="3089557">&#34;,&#34;</span><span class="op" id="3089560">)</span><span class="op" id="3089561">+</span><span class="string" id="3089562">&#34;\r\n&#34;</span><span class="op" id="3089568">)</span><span class="op" id="3089569">;</span>&nbsp;<span class="ident" id="3089571">err</span>&nbsp;<span class="op" id="3089575">!=</span>&nbsp;<span class="builtintype" id="3089578">nil</span>&nbsp;<span class="op" id="3089582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089588">return</span>&nbsp;<span class="ident" id="3089595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089609">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089613">return</span>&nbsp;<span class="builtintype" id="3089620">nil</span><br>
<span class="lineno"></span><span class="op" id="3089624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3089627">func</span>&nbsp;<span class="op" id="3089632">(</span><span class="ident" id="3089633">t</span>&nbsp;<span class="op" id="3089635">*</span><span class="ident" id="3089636">transferWriter</span><span class="op" id="3089650">)</span>&nbsp;<span class="ident" id="3089652">WriteBody</span><span class="op" id="3089661">(</span><span class="ident" id="3089662">w</span>&nbsp;<span class="ident" id="3089664">io</span><span class="op" id="3089666">.</span><span class="ident" id="3089667">Writer</span><span class="op" id="3089673">)</span>&nbsp;<span class="builtintype" id="3089675">error</span>&nbsp;<span class="op" id="3089681">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089684">var</span>&nbsp;<span class="ident" id="3089688">err</span>&nbsp;<span class="builtintype" id="3089692">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089699">var</span>&nbsp;<span class="ident" id="3089703">ncopy</span>&nbsp;<span class="ident" id="3089709">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3089717">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089732">if</span>&nbsp;<span class="ident" id="3089735">t</span><span class="op" id="3089736">.</span><span class="ident" id="3089737">Body</span>&nbsp;<span class="op" id="3089742">!=</span>&nbsp;<span class="builtintype" id="3089745">nil</span>&nbsp;<span class="op" id="3089749">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089753">if</span>&nbsp;<span class="ident" id="3089756">chunked</span><span class="op" id="3089763">(</span><span class="ident" id="3089764">t</span><span class="op" id="3089765">.</span><span class="ident" id="3089766">TransferEncoding</span><span class="op" id="3089782">)</span>&nbsp;<span class="op" id="3089784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089789">cw</span>&nbsp;<span class="op" id="3089792">:=</span>&nbsp;<span class="ident" id="3089795">internal</span><span class="op" id="3089803">.</span><span class="ident" id="3089804">NewChunkedWriter</span><span class="op" id="3089820">(</span><span class="ident" id="3089821">w</span><span class="op" id="3089822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089827">_</span><span class="op" id="3089828">,</span>&nbsp;<span class="ident" id="3089830">err</span>&nbsp;<span class="op" id="3089834">=</span>&nbsp;<span class="ident" id="3089836">io</span><span class="op" id="3089838">.</span><span class="ident" id="3089839">Copy</span><span class="op" id="3089843">(</span><span class="ident" id="3089844">cw</span><span class="op" id="3089846">,</span>&nbsp;<span class="ident" id="3089848">t</span><span class="op" id="3089849">.</span><span class="ident" id="3089850">Body</span><span class="op" id="3089854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3089859">if</span>&nbsp;<span class="ident" id="3089862">err</span>&nbsp;<span class="op" id="3089866">==</span>&nbsp;<span class="builtintype" id="3089869">nil</span>&nbsp;<span class="op" id="3089873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089879">err</span>&nbsp;<span class="op" id="3089883">=</span>&nbsp;<span class="ident" id="3089885">cw</span><span class="op" id="3089887">.</span><span class="ident" id="3089888">Close</span><span class="op" id="3089893">(</span><span class="op" id="3089894">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089903">}</span>&nbsp;<span class="keyword" id="3089905">else</span>&nbsp;<span class="keyword" id="3089910">if</span>&nbsp;<span class="ident" id="3089913">t</span><span class="op" id="3089914">.</span><span class="ident" id="3089915">ContentLength</span>&nbsp;<span class="op" id="3089929">==</span>&nbsp;<span class="op" id="3089932">-</span><span class="num" id="3089933">1</span>&nbsp;<span class="op" id="3089935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089940">ncopy</span><span class="op" id="3089945">,</span>&nbsp;<span class="ident" id="3089947">err</span>&nbsp;<span class="op" id="3089951">=</span>&nbsp;<span class="ident" id="3089953">io</span><span class="op" id="3089955">.</span><span class="ident" id="3089956">Copy</span><span class="op" id="3089960">(</span><span class="ident" id="3089961">w</span><span class="op" id="3089962">,</span>&nbsp;<span class="ident" id="3089964">t</span><span class="op" id="3089965">.</span><span class="ident" id="3089966">Body</span><span class="op" id="3089970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3089974">}</span>&nbsp;<span class="keyword" id="3089976">else</span>&nbsp;<span class="op" id="3089981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3089986">ncopy</span><span class="op" id="3089991">,</span>&nbsp;<span class="ident" id="3089993">err</span>&nbsp;<span class="op" id="3089997">=</span>&nbsp;<span class="ident" id="3089999">io</span><span class="op" id="3090001">.</span><span class="ident" id="3090002">Copy</span><span class="op" id="3090006">(</span><span class="ident" id="3090007">w</span><span class="op" id="3090008">,</span>&nbsp;<span class="ident" id="3090010">io</span><span class="op" id="3090012">.</span><span class="ident" id="3090013">LimitReader</span><span class="op" id="3090024">(</span><span class="ident" id="3090025">t</span><span class="op" id="3090026">.</span><span class="ident" id="3090027">Body</span><span class="op" id="3090031">,</span>&nbsp;<span class="ident" id="3090033">t</span><span class="op" id="3090034">.</span><span class="ident" id="3090035">ContentLength</span><span class="op" id="3090048">)</span><span class="op" id="3090049">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090054">if</span>&nbsp;<span class="ident" id="3090057">err</span>&nbsp;<span class="op" id="3090061">!=</span>&nbsp;<span class="builtintype" id="3090064">nil</span>&nbsp;<span class="op" id="3090068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090074">return</span>&nbsp;<span class="ident" id="3090081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090093">var</span>&nbsp;<span class="ident" id="3090097">nextra</span>&nbsp;<span class="ident" id="3090104">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090113">nextra</span><span class="op" id="3090119">,</span>&nbsp;<span class="ident" id="3090121">err</span>&nbsp;<span class="op" id="3090125">=</span>&nbsp;<span class="ident" id="3090127">io</span><span class="op" id="3090129">.</span><span class="ident" id="3090130">Copy</span><span class="op" id="3090134">(</span><span class="ident" id="3090135">ioutil</span><span class="op" id="3090141">.</span><span class="ident" id="3090142">Discard</span><span class="op" id="3090149">,</span>&nbsp;<span class="ident" id="3090151">t</span><span class="op" id="3090152">.</span><span class="ident" id="3090153">Body</span><span class="op" id="3090157">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090162">ncopy</span>&nbsp;<span class="op" id="3090168">+=</span>&nbsp;<span class="ident" id="3090171">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090184">if</span>&nbsp;<span class="ident" id="3090187">err</span>&nbsp;<span class="op" id="3090191">!=</span>&nbsp;<span class="builtintype" id="3090194">nil</span>&nbsp;<span class="op" id="3090198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090203">return</span>&nbsp;<span class="ident" id="3090210">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090216">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090220">if</span>&nbsp;<span class="ident" id="3090223">err</span>&nbsp;<span class="op" id="3090227">=</span>&nbsp;<span class="ident" id="3090229">t</span><span class="op" id="3090230">.</span><span class="ident" id="3090231">BodyCloser</span><span class="op" id="3090241">.</span><span class="ident" id="3090242">Close</span><span class="op" id="3090247">(</span><span class="op" id="3090248">)</span><span class="op" id="3090249">;</span>&nbsp;<span class="ident" id="3090251">err</span>&nbsp;<span class="op" id="3090255">!=</span>&nbsp;<span class="builtintype" id="3090258">nil</span>&nbsp;<span class="op" id="3090262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090267">return</span>&nbsp;<span class="ident" id="3090274">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090287">if</span>&nbsp;<span class="op" id="3090290">!</span><span class="ident" id="3090291">t</span><span class="op" id="3090292">.</span><span class="ident" id="3090293">ResponseToHEAD</span>&nbsp;<span class="op" id="3090308">&amp;&amp;</span>&nbsp;<span class="ident" id="3090311">t</span><span class="op" id="3090312">.</span><span class="ident" id="3090313">ContentLength</span>&nbsp;<span class="op" id="3090327">!=</span>&nbsp;<span class="op" id="3090330">-</span><span class="num" id="3090331">1</span>&nbsp;<span class="op" id="3090333">&amp;&amp;</span>&nbsp;<span class="ident" id="3090336">t</span><span class="op" id="3090337">.</span><span class="ident" id="3090338">ContentLength</span>&nbsp;<span class="op" id="3090352">!=</span>&nbsp;<span class="ident" id="3090355">ncopy</span>&nbsp;<span class="op" id="3090361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090365">return</span>&nbsp;<span class="ident" id="3090372">fmt</span><span class="op" id="3090375">.</span><span class="ident" id="3090376">Errorf</span><span class="op" id="3090382">(</span><span class="string" id="3090383">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3090427">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090432">t</span><span class="op" id="3090433">.</span><span class="ident" id="3090434">ContentLength</span><span class="op" id="3090447">,</span>&nbsp;<span class="ident" id="3090449">ncopy</span><span class="op" id="3090454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3090461">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090510">if</span>&nbsp;<span class="ident" id="3090513">chunked</span><span class="op" id="3090520">(</span><span class="ident" id="3090521">t</span><span class="op" id="3090522">.</span><span class="ident" id="3090523">TransferEncoding</span><span class="op" id="3090539">)</span>&nbsp;<span class="op" id="3090541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3090545">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090571">if</span>&nbsp;<span class="ident" id="3090574">t</span><span class="op" id="3090575">.</span><span class="ident" id="3090576">Trailer</span>&nbsp;<span class="op" id="3090584">!=</span>&nbsp;<span class="builtintype" id="3090587">nil</span>&nbsp;<span class="op" id="3090591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090596">if</span>&nbsp;<span class="ident" id="3090599">err</span>&nbsp;<span class="op" id="3090603">:=</span>&nbsp;<span class="ident" id="3090606">t</span><span class="op" id="3090607">.</span><span class="ident" id="3090608">Trailer</span><span class="op" id="3090615">.</span><span class="ident" id="3090616">Write</span><span class="op" id="3090621">(</span><span class="ident" id="3090622">w</span><span class="op" id="3090623">)</span><span class="op" id="3090624">;</span>&nbsp;<span class="ident" id="3090626">err</span>&nbsp;<span class="op" id="3090630">!=</span>&nbsp;<span class="builtintype" id="3090633">nil</span>&nbsp;<span class="op" id="3090637">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090643">return</span>&nbsp;<span class="ident" id="3090650">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3090665">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090696">_</span><span class="op" id="3090697">,</span>&nbsp;<span class="ident" id="3090699">err</span>&nbsp;<span class="op" id="3090703">=</span>&nbsp;<span class="ident" id="3090705">io</span><span class="op" id="3090707">.</span><span class="ident" id="3090708">WriteString</span><span class="op" id="3090719">(</span><span class="ident" id="3090720">w</span><span class="op" id="3090721">,</span>&nbsp;<span class="string" id="3090723">&#34;\r\n&#34;</span><span class="op" id="3090729">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3090732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3090735">return</span>&nbsp;<span class="ident" id="3090742">err</span><br>
<span class="lineno"></span><span class="op" id="3090746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3090749">type</span>&nbsp;<span class="ident" id="3090754">transferReader</span>&nbsp;<span class="keyword" id="3090769">struct</span>&nbsp;<span class="op" id="3090776">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3090779">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090789">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090803">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090811">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3090825">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090830">RequestMethod</span>&nbsp;<span class="builtintype" id="3090844">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090852">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3090866">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090871">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3090885">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3090890">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090901">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090918">io</span><span class="op" id="3090920">.</span><span class="ident" id="3090921">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090933">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090950">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090957">TransferEncoding</span>&nbsp;<span class="op" id="3090974">[</span><span class="op" id="3090975">]</span><span class="builtintype" id="3090976">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3090984">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3091001">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3091007">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3091024">Header</span><br>
<span class="lineno"></span><span class="op" id="3091031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091034">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3091103">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3091149">func</span>&nbsp;<span class="ident" id="3091154">bodyAllowedForStatus</span><span class="op" id="3091174">(</span><span class="ident" id="3091175">status</span>&nbsp;<span class="builtintype" id="3091182">int</span><span class="op" id="3091185">)</span>&nbsp;<span class="builtintype" id="3091187">bool</span>&nbsp;<span class="op" id="3091192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091195">switch</span>&nbsp;<span class="op" id="3091202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091205">case</span>&nbsp;<span class="ident" id="3091210">status</span>&nbsp;<span class="op" id="3091217">&gt;=</span>&nbsp;<span class="num" id="3091220">100</span>&nbsp;<span class="op" id="3091224">&amp;&amp;</span>&nbsp;<span class="ident" id="3091227">status</span>&nbsp;<span class="op" id="3091234">&lt;=</span>&nbsp;<span class="num" id="3091237">199</span><span class="op" id="3091240">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091244">return</span>&nbsp;<span class="builtintype" id="3091251">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091258">case</span>&nbsp;<span class="ident" id="3091263">status</span>&nbsp;<span class="op" id="3091270">==</span>&nbsp;<span class="num" id="3091273">204</span><span class="op" id="3091276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091280">return</span>&nbsp;<span class="builtintype" id="3091287">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091294">case</span>&nbsp;<span class="ident" id="3091299">status</span>&nbsp;<span class="op" id="3091306">==</span>&nbsp;<span class="num" id="3091309">304</span><span class="op" id="3091312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091316">return</span>&nbsp;<span class="builtintype" id="3091323">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3091330">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091333">return</span>&nbsp;<span class="builtintype" id="3091340">true</span><br>
<span class="lineno"></span><span class="op" id="3091345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3091348">var</span>&nbsp;<span class="op" id="3091352">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3091355">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3091379">=</span>&nbsp;<span class="op" id="3091381">[</span><span class="op" id="3091382">]</span><span class="builtintype" id="3091383">string</span><span class="op" id="3091389">{</span><span class="string" id="3091390">&#34;Content-Type&#34;</span><span class="op" id="3091404">,</span>&nbsp;<span class="string" id="3091406">&#34;Content-Length&#34;</span><span class="op" id="3091422">,</span>&nbsp;<span class="string" id="3091424">&#34;Transfer-Encoding&#34;</span><span class="op" id="3091443">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3091446">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3091470">=</span>&nbsp;<span class="op" id="3091472">[</span><span class="op" id="3091473">]</span><span class="builtintype" id="3091474">string</span><span class="op" id="3091480">{</span><span class="string" id="3091481">&#34;Content-Length&#34;</span><span class="op" id="3091497">,</span>&nbsp;<span class="string" id="3091499">&#34;Transfer-Encoding&#34;</span><span class="op" id="3091518">}</span><br>
<span class="lineno"></span><span class="op" id="3091520">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3091523">func</span>&nbsp;<span class="ident" id="3091528">suppressedHeaders</span><span class="op" id="3091545">(</span><span class="ident" id="3091546">status</span>&nbsp;<span class="builtintype" id="3091553">int</span><span class="op" id="3091556">)</span>&nbsp;<span class="op" id="3091558">[</span><span class="op" id="3091559">]</span><span class="builtintype" id="3091560">string</span>&nbsp;<span class="op" id="3091567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091570">switch</span>&nbsp;<span class="op" id="3091577">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091580">case</span>&nbsp;<span class="ident" id="3091585">status</span>&nbsp;<span class="op" id="3091592">==</span>&nbsp;<span class="num" id="3091595">304</span><span class="op" id="3091598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3091602">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091685">return</span>&nbsp;<span class="ident" id="3091692">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091714">case</span>&nbsp;<span class="op" id="3091719">!</span><span class="ident" id="3091720">bodyAllowedForStatus</span><span class="op" id="3091740">(</span><span class="ident" id="3091741">status</span><span class="op" id="3091747">)</span><span class="op" id="3091748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091752">return</span>&nbsp;<span class="ident" id="3091759">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3091784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091787">return</span>&nbsp;<span class="builtintype" id="3091794">nil</span><br>
<span class="lineno"></span><span class="op" id="3091798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3091801">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3091834">func</span>&nbsp;<span class="ident" id="3091839">readTransfer</span><span class="op" id="3091851">(</span><span class="ident" id="3091852">msg</span>&nbsp;<span class="keyword" id="3091856">interface</span><span class="op" id="3091865">{</span><span class="op" id="3091866">}</span><span class="op" id="3091867">,</span>&nbsp;<span class="ident" id="3091869">r</span>&nbsp;<span class="op" id="3091871">*</span><span class="ident" id="3091872">bufio</span><span class="op" id="3091877">.</span><span class="ident" id="3091878">Reader</span><span class="op" id="3091884">)</span>&nbsp;<span class="op" id="3091886">(</span><span class="ident" id="3091887">err</span>&nbsp;<span class="builtintype" id="3091891">error</span><span class="op" id="3091896">)</span>&nbsp;<span class="op" id="3091898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3091901">t</span>&nbsp;<span class="op" id="3091903">:=</span>&nbsp;<span class="op" id="3091906">&amp;</span><span class="ident" id="3091907">transferReader</span><span class="op" id="3091921">{</span><span class="ident" id="3091922">RequestMethod</span><span class="op" id="3091935">:</span>&nbsp;<span class="string" id="3091937">&#34;GET&#34;</span><span class="op" id="3091942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3091946">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3091962">isResponse</span>&nbsp;<span class="op" id="3091973">:=</span>&nbsp;<span class="builtintype" id="3091976">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3091983">switch</span>&nbsp;<span class="ident" id="3091990">rr</span>&nbsp;<span class="op" id="3091993">:=</span>&nbsp;<span class="ident" id="3091996">msg</span><span class="op" id="3091999">.</span><span class="op" id="3092000">(</span><span class="keyword" id="3092001">type</span><span class="op" id="3092005">)</span>&nbsp;<span class="op" id="3092007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092010">case</span>&nbsp;<span class="op" id="3092015">*</span><span class="ident" id="3092016">Response</span><span class="op" id="3092024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092028">t</span><span class="op" id="3092029">.</span><span class="ident" id="3092030">Header</span>&nbsp;<span class="op" id="3092037">=</span>&nbsp;<span class="ident" id="3092039">rr</span><span class="op" id="3092041">.</span><span class="ident" id="3092042">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092051">t</span><span class="op" id="3092052">.</span><span class="ident" id="3092053">StatusCode</span>&nbsp;<span class="op" id="3092064">=</span>&nbsp;<span class="ident" id="3092066">rr</span><span class="op" id="3092068">.</span><span class="ident" id="3092069">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092082">t</span><span class="op" id="3092083">.</span><span class="ident" id="3092084">ProtoMajor</span>&nbsp;<span class="op" id="3092095">=</span>&nbsp;<span class="ident" id="3092097">rr</span><span class="op" id="3092099">.</span><span class="ident" id="3092100">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092113">t</span><span class="op" id="3092114">.</span><span class="ident" id="3092115">ProtoMinor</span>&nbsp;<span class="op" id="3092126">=</span>&nbsp;<span class="ident" id="3092128">rr</span><span class="op" id="3092130">.</span><span class="ident" id="3092131">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092144">t</span><span class="op" id="3092145">.</span><span class="ident" id="3092146">Close</span>&nbsp;<span class="op" id="3092152">=</span>&nbsp;<span class="ident" id="3092154">shouldClose</span><span class="op" id="3092165">(</span><span class="ident" id="3092166">t</span><span class="op" id="3092167">.</span><span class="ident" id="3092168">ProtoMajor</span><span class="op" id="3092178">,</span>&nbsp;<span class="ident" id="3092180">t</span><span class="op" id="3092181">.</span><span class="ident" id="3092182">ProtoMinor</span><span class="op" id="3092192">,</span>&nbsp;<span class="ident" id="3092194">t</span><span class="op" id="3092195">.</span><span class="ident" id="3092196">Header</span><span class="op" id="3092202">,</span>&nbsp;<span class="builtintype" id="3092204">true</span><span class="op" id="3092208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092212">isResponse</span>&nbsp;<span class="op" id="3092223">=</span>&nbsp;<span class="builtintype" id="3092225">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092232">if</span>&nbsp;<span class="ident" id="3092235">rr</span><span class="op" id="3092237">.</span><span class="ident" id="3092238">Request</span>&nbsp;<span class="op" id="3092246">!=</span>&nbsp;<span class="builtintype" id="3092249">nil</span>&nbsp;<span class="op" id="3092253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092258">t</span><span class="op" id="3092259">.</span><span class="ident" id="3092260">RequestMethod</span>&nbsp;<span class="op" id="3092274">=</span>&nbsp;<span class="ident" id="3092276">rr</span><span class="op" id="3092278">.</span><span class="ident" id="3092279">Request</span><span class="op" id="3092286">.</span><span class="ident" id="3092287">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3092296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092299">case</span>&nbsp;<span class="op" id="3092304">*</span><span class="ident" id="3092305">Request</span><span class="op" id="3092312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092316">t</span><span class="op" id="3092317">.</span><span class="ident" id="3092318">Header</span>&nbsp;<span class="op" id="3092325">=</span>&nbsp;<span class="ident" id="3092327">rr</span><span class="op" id="3092329">.</span><span class="ident" id="3092330">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092339">t</span><span class="op" id="3092340">.</span><span class="ident" id="3092341">ProtoMajor</span>&nbsp;<span class="op" id="3092352">=</span>&nbsp;<span class="ident" id="3092354">rr</span><span class="op" id="3092356">.</span><span class="ident" id="3092357">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092370">t</span><span class="op" id="3092371">.</span><span class="ident" id="3092372">ProtoMinor</span>&nbsp;<span class="op" id="3092383">=</span>&nbsp;<span class="ident" id="3092385">rr</span><span class="op" id="3092387">.</span><span class="ident" id="3092388">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3092401">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3092465">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092529">t</span><span class="op" id="3092530">.</span><span class="ident" id="3092531">StatusCode</span>&nbsp;<span class="op" id="3092542">=</span>&nbsp;<span class="num" id="3092544">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092549">default</span><span class="op" id="3092556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3092560">panic</span><span class="op" id="3092565">(</span><span class="string" id="3092566">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3092583">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3092586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3092590">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092614">if</span>&nbsp;<span class="ident" id="3092617">t</span><span class="op" id="3092618">.</span><span class="ident" id="3092619">ProtoMajor</span>&nbsp;<span class="op" id="3092630">==</span>&nbsp;<span class="num" id="3092633">0</span>&nbsp;<span class="op" id="3092635">&amp;&amp;</span>&nbsp;<span class="ident" id="3092638">t</span><span class="op" id="3092639">.</span><span class="ident" id="3092640">ProtoMinor</span>&nbsp;<span class="op" id="3092651">==</span>&nbsp;<span class="num" id="3092654">0</span>&nbsp;<span class="op" id="3092656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092660">t</span><span class="op" id="3092661">.</span><span class="ident" id="3092662">ProtoMajor</span><span class="op" id="3092672">,</span>&nbsp;<span class="ident" id="3092674">t</span><span class="op" id="3092675">.</span><span class="ident" id="3092676">ProtoMinor</span>&nbsp;<span class="op" id="3092687">=</span>&nbsp;<span class="num" id="3092689">1</span><span class="op" id="3092690">,</span>&nbsp;<span class="num" id="3092692">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3092695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3092699">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092737">t</span><span class="op" id="3092738">.</span><span class="ident" id="3092739">TransferEncoding</span><span class="op" id="3092755">,</span>&nbsp;<span class="ident" id="3092757">err</span>&nbsp;<span class="op" id="3092761">=</span>&nbsp;<span class="ident" id="3092763">fixTransferEncoding</span><span class="op" id="3092782">(</span><span class="ident" id="3092783">t</span><span class="op" id="3092784">.</span><span class="ident" id="3092785">RequestMethod</span><span class="op" id="3092798">,</span>&nbsp;<span class="ident" id="3092800">t</span><span class="op" id="3092801">.</span><span class="ident" id="3092802">Header</span><span class="op" id="3092808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092811">if</span>&nbsp;<span class="ident" id="3092814">err</span>&nbsp;<span class="op" id="3092818">!=</span>&nbsp;<span class="builtintype" id="3092821">nil</span>&nbsp;<span class="op" id="3092825">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092829">return</span>&nbsp;<span class="ident" id="3092836">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3092841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3092845">realLength</span><span class="op" id="3092855">,</span>&nbsp;<span class="ident" id="3092857">err</span>&nbsp;<span class="op" id="3092861">:=</span>&nbsp;<span class="ident" id="3092864">fixLength</span><span class="op" id="3092873">(</span><span class="ident" id="3092874">isResponse</span><span class="op" id="3092884">,</span>&nbsp;<span class="ident" id="3092886">t</span><span class="op" id="3092887">.</span><span class="ident" id="3092888">StatusCode</span><span class="op" id="3092898">,</span>&nbsp;<span class="ident" id="3092900">t</span><span class="op" id="3092901">.</span><span class="ident" id="3092902">RequestMethod</span><span class="op" id="3092915">,</span>&nbsp;<span class="ident" id="3092917">t</span><span class="op" id="3092918">.</span><span class="ident" id="3092919">Header</span><span class="op" id="3092925">,</span>&nbsp;<span class="ident" id="3092927">t</span><span class="op" id="3092928">.</span><span class="ident" id="3092929">TransferEncoding</span><span class="op" id="3092945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092948">if</span>&nbsp;<span class="ident" id="3092951">err</span>&nbsp;<span class="op" id="3092955">!=</span>&nbsp;<span class="builtintype" id="3092958">nil</span>&nbsp;<span class="op" id="3092962">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092966">return</span>&nbsp;<span class="ident" id="3092973">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3092978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3092981">if</span>&nbsp;<span class="ident" id="3092984">isResponse</span>&nbsp;<span class="op" id="3092995">&amp;&amp;</span>&nbsp;<span class="ident" id="3092998">t</span><span class="op" id="3092999">.</span><span class="ident" id="3093000">RequestMethod</span>&nbsp;<span class="op" id="3093014">==</span>&nbsp;<span class="string" id="3093017">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3093024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093028">if</span>&nbsp;<span class="ident" id="3093031">n</span><span class="op" id="3093032">,</span>&nbsp;<span class="ident" id="3093034">err</span>&nbsp;<span class="op" id="3093038">:=</span>&nbsp;<span class="ident" id="3093041">parseContentLength</span><span class="op" id="3093059">(</span><span class="ident" id="3093060">t</span><span class="op" id="3093061">.</span><span class="ident" id="3093062">Header</span><span class="op" id="3093068">.</span><span class="ident" id="3093069">get</span><span class="op" id="3093072">(</span><span class="string" id="3093073">&#34;Content-Length&#34;</span><span class="op" id="3093089">)</span><span class="op" id="3093090">)</span><span class="op" id="3093091">;</span>&nbsp;<span class="ident" id="3093093">err</span>&nbsp;<span class="op" id="3093097">!=</span>&nbsp;<span class="builtintype" id="3093100">nil</span>&nbsp;<span class="op" id="3093104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093109">return</span>&nbsp;<span class="ident" id="3093116">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093122">}</span>&nbsp;<span class="keyword" id="3093124">else</span>&nbsp;<span class="op" id="3093129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093134">t</span><span class="op" id="3093135">.</span><span class="ident" id="3093136">ContentLength</span>&nbsp;<span class="op" id="3093150">=</span>&nbsp;<span class="ident" id="3093152">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093159">}</span>&nbsp;<span class="keyword" id="3093161">else</span>&nbsp;<span class="op" id="3093166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093170">t</span><span class="op" id="3093171">.</span><span class="ident" id="3093172">ContentLength</span>&nbsp;<span class="op" id="3093186">=</span>&nbsp;<span class="ident" id="3093188">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093204">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093216">t</span><span class="op" id="3093217">.</span><span class="ident" id="3093218">Trailer</span><span class="op" id="3093225">,</span>&nbsp;<span class="ident" id="3093227">err</span>&nbsp;<span class="op" id="3093231">=</span>&nbsp;<span class="ident" id="3093233">fixTrailer</span><span class="op" id="3093243">(</span><span class="ident" id="3093244">t</span><span class="op" id="3093245">.</span><span class="ident" id="3093246">Header</span><span class="op" id="3093252">,</span>&nbsp;<span class="ident" id="3093254">t</span><span class="op" id="3093255">.</span><span class="ident" id="3093256">TransferEncoding</span><span class="op" id="3093272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093275">if</span>&nbsp;<span class="ident" id="3093278">err</span>&nbsp;<span class="op" id="3093282">!=</span>&nbsp;<span class="builtintype" id="3093285">nil</span>&nbsp;<span class="op" id="3093289">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093293">return</span>&nbsp;<span class="ident" id="3093300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093309">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093387">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093458">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093488">switch</span>&nbsp;<span class="ident" id="3093495">msg</span><span class="op" id="3093498">.</span><span class="op" id="3093499">(</span><span class="keyword" id="3093500">type</span><span class="op" id="3093504">)</span>&nbsp;<span class="op" id="3093506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093509">case</span>&nbsp;<span class="op" id="3093514">*</span><span class="ident" id="3093515">Response</span><span class="op" id="3093523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093527">if</span>&nbsp;<span class="ident" id="3093530">realLength</span>&nbsp;<span class="op" id="3093541">==</span>&nbsp;<span class="op" id="3093544">-</span><span class="num" id="3093545">1</span>&nbsp;<span class="op" id="3093547">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093553">!</span><span class="ident" id="3093554">chunked</span><span class="op" id="3093561">(</span><span class="ident" id="3093562">t</span><span class="op" id="3093563">.</span><span class="ident" id="3093564">TransferEncoding</span><span class="op" id="3093580">)</span>&nbsp;<span class="op" id="3093582">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093588">bodyAllowedForStatus</span><span class="op" id="3093608">(</span><span class="ident" id="3093609">t</span><span class="op" id="3093610">.</span><span class="ident" id="3093611">StatusCode</span><span class="op" id="3093621">)</span>&nbsp;<span class="op" id="3093623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093628">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093650">t</span><span class="op" id="3093651">.</span><span class="ident" id="3093652">Close</span>&nbsp;<span class="op" id="3093658">=</span>&nbsp;<span class="builtintype" id="3093660">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093670">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093674">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3093741">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093817">switch</span>&nbsp;<span class="op" id="3093824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093827">case</span>&nbsp;<span class="ident" id="3093832">chunked</span><span class="op" id="3093839">(</span><span class="ident" id="3093840">t</span><span class="op" id="3093841">.</span><span class="ident" id="3093842">TransferEncoding</span><span class="op" id="3093858">)</span><span class="op" id="3093859">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3093863">if</span>&nbsp;<span class="ident" id="3093866">noBodyExpected</span><span class="op" id="3093880">(</span><span class="ident" id="3093881">t</span><span class="op" id="3093882">.</span><span class="ident" id="3093883">RequestMethod</span><span class="op" id="3093896">)</span>&nbsp;<span class="op" id="3093898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093903">t</span><span class="op" id="3093904">.</span><span class="ident" id="3093905">Body</span>&nbsp;<span class="op" id="3093910">=</span>&nbsp;<span class="ident" id="3093912">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3093924">}</span>&nbsp;<span class="keyword" id="3093926">else</span>&nbsp;<span class="op" id="3093931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3093936">t</span><span class="op" id="3093937">.</span><span class="ident" id="3093938">Body</span>&nbsp;<span class="op" id="3093943">=</span>&nbsp;<span class="op" id="3093945">&amp;</span><span class="ident" id="3093946">body</span><span class="op" id="3093950">{</span><span class="ident" id="3093951">src</span><span class="op" id="3093954">:</span>&nbsp;<span class="ident" id="3093956">internal</span><span class="op" id="3093964">.</span><span class="ident" id="3093965">NewChunkedReader</span><span class="op" id="3093981">(</span><span class="ident" id="3093982">r</span><span class="op" id="3093983">)</span><span class="op" id="3093984">,</span>&nbsp;<span class="ident" id="3093986">hdr</span><span class="op" id="3093989">:</span>&nbsp;<span class="ident" id="3093991">msg</span><span class="op" id="3093994">,</span>&nbsp;<span class="ident" id="3093996">r</span><span class="op" id="3093997">:</span>&nbsp;<span class="ident" id="3093999">r</span><span class="op" id="3094000">,</span>&nbsp;<span class="ident" id="3094002">closing</span><span class="op" id="3094009">:</span>&nbsp;<span class="ident" id="3094011">t</span><span class="op" id="3094012">.</span><span class="ident" id="3094013">Close</span><span class="op" id="3094018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3094022">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094025">case</span>&nbsp;<span class="ident" id="3094030">realLength</span>&nbsp;<span class="op" id="3094041">==</span>&nbsp;<span class="num" id="3094044">0</span><span class="op" id="3094045">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094049">t</span><span class="op" id="3094050">.</span><span class="ident" id="3094051">Body</span>&nbsp;<span class="op" id="3094056">=</span>&nbsp;<span class="ident" id="3094058">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094069">case</span>&nbsp;<span class="ident" id="3094074">realLength</span>&nbsp;<span class="op" id="3094085">&gt;</span>&nbsp;<span class="num" id="3094087">0</span><span class="op" id="3094088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094092">t</span><span class="op" id="3094093">.</span><span class="ident" id="3094094">Body</span>&nbsp;<span class="op" id="3094099">=</span>&nbsp;<span class="op" id="3094101">&amp;</span><span class="ident" id="3094102">body</span><span class="op" id="3094106">{</span><span class="ident" id="3094107">src</span><span class="op" id="3094110">:</span>&nbsp;<span class="ident" id="3094112">io</span><span class="op" id="3094114">.</span><span class="ident" id="3094115">LimitReader</span><span class="op" id="3094126">(</span><span class="ident" id="3094127">r</span><span class="op" id="3094128">,</span>&nbsp;<span class="ident" id="3094130">realLength</span><span class="op" id="3094140">)</span><span class="op" id="3094141">,</span>&nbsp;<span class="ident" id="3094143">closing</span><span class="op" id="3094150">:</span>&nbsp;<span class="ident" id="3094152">t</span><span class="op" id="3094153">.</span><span class="ident" id="3094154">Close</span><span class="op" id="3094159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094162">default</span><span class="op" id="3094169">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3094173">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094240">if</span>&nbsp;<span class="ident" id="3094243">t</span><span class="op" id="3094244">.</span><span class="ident" id="3094245">Close</span>&nbsp;<span class="op" id="3094251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3094256">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094294">t</span><span class="op" id="3094295">.</span><span class="ident" id="3094296">Body</span>&nbsp;<span class="op" id="3094301">=</span>&nbsp;<span class="op" id="3094303">&amp;</span><span class="ident" id="3094304">body</span><span class="op" id="3094308">{</span><span class="ident" id="3094309">src</span><span class="op" id="3094312">:</span>&nbsp;<span class="ident" id="3094314">r</span><span class="op" id="3094315">,</span>&nbsp;<span class="ident" id="3094317">closing</span><span class="op" id="3094324">:</span>&nbsp;<span class="ident" id="3094326">t</span><span class="op" id="3094327">.</span><span class="ident" id="3094328">Close</span><span class="op" id="3094333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3094337">}</span>&nbsp;<span class="keyword" id="3094339">else</span>&nbsp;<span class="op" id="3094344">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3094349">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094393">t</span><span class="op" id="3094394">.</span><span class="ident" id="3094395">Body</span>&nbsp;<span class="op" id="3094400">=</span>&nbsp;<span class="ident" id="3094402">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3094414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3094417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3094421">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094438">switch</span>&nbsp;<span class="ident" id="3094445">rr</span>&nbsp;<span class="op" id="3094448">:=</span>&nbsp;<span class="ident" id="3094451">msg</span><span class="op" id="3094454">.</span><span class="op" id="3094455">(</span><span class="keyword" id="3094456">type</span><span class="op" id="3094460">)</span>&nbsp;<span class="op" id="3094462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094465">case</span>&nbsp;<span class="op" id="3094470">*</span><span class="ident" id="3094471">Request</span><span class="op" id="3094478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094482">rr</span><span class="op" id="3094484">.</span><span class="ident" id="3094485">Body</span>&nbsp;<span class="op" id="3094490">=</span>&nbsp;<span class="ident" id="3094492">t</span><span class="op" id="3094493">.</span><span class="ident" id="3094494">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094501">rr</span><span class="op" id="3094503">.</span><span class="ident" id="3094504">ContentLength</span>&nbsp;<span class="op" id="3094518">=</span>&nbsp;<span class="ident" id="3094520">t</span><span class="op" id="3094521">.</span><span class="ident" id="3094522">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094538">rr</span><span class="op" id="3094540">.</span><span class="ident" id="3094541">TransferEncoding</span>&nbsp;<span class="op" id="3094558">=</span>&nbsp;<span class="ident" id="3094560">t</span><span class="op" id="3094561">.</span><span class="ident" id="3094562">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094581">rr</span><span class="op" id="3094583">.</span><span class="ident" id="3094584">Close</span>&nbsp;<span class="op" id="3094590">=</span>&nbsp;<span class="ident" id="3094592">t</span><span class="op" id="3094593">.</span><span class="ident" id="3094594">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094602">rr</span><span class="op" id="3094604">.</span><span class="ident" id="3094605">Trailer</span>&nbsp;<span class="op" id="3094613">=</span>&nbsp;<span class="ident" id="3094615">t</span><span class="op" id="3094616">.</span><span class="ident" id="3094617">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094626">case</span>&nbsp;<span class="op" id="3094631">*</span><span class="ident" id="3094632">Response</span><span class="op" id="3094640">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094644">rr</span><span class="op" id="3094646">.</span><span class="ident" id="3094647">Body</span>&nbsp;<span class="op" id="3094652">=</span>&nbsp;<span class="ident" id="3094654">t</span><span class="op" id="3094655">.</span><span class="ident" id="3094656">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094663">rr</span><span class="op" id="3094665">.</span><span class="ident" id="3094666">ContentLength</span>&nbsp;<span class="op" id="3094680">=</span>&nbsp;<span class="ident" id="3094682">t</span><span class="op" id="3094683">.</span><span class="ident" id="3094684">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094700">rr</span><span class="op" id="3094702">.</span><span class="ident" id="3094703">TransferEncoding</span>&nbsp;<span class="op" id="3094720">=</span>&nbsp;<span class="ident" id="3094722">t</span><span class="op" id="3094723">.</span><span class="ident" id="3094724">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094743">rr</span><span class="op" id="3094745">.</span><span class="ident" id="3094746">Close</span>&nbsp;<span class="op" id="3094752">=</span>&nbsp;<span class="ident" id="3094754">t</span><span class="op" id="3094755">.</span><span class="ident" id="3094756">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3094764">rr</span><span class="op" id="3094766">.</span><span class="ident" id="3094767">Trailer</span>&nbsp;<span class="op" id="3094775">=</span>&nbsp;<span class="ident" id="3094777">t</span><span class="op" id="3094778">.</span><span class="ident" id="3094779">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3094788">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3094792">return</span>&nbsp;<span class="builtintype" id="3094799">nil</span><br>
<span class="lineno"></span><span class="op" id="3094803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3094806">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3094863">func</span>&nbsp;<span class="ident" id="3094868">chunked</span><span class="op" id="3094875">(</span><span class="ident" id="3094876">te</span>&nbsp;<span class="op" id="3094879">[</span><span class="op" id="3094880">]</span><span class="builtintype" id="3094881">string</span><span class="op" id="3094887">)</span>&nbsp;<span class="builtintype" id="3094889">bool</span>&nbsp;<span class="op" id="3094894">{</span>&nbsp;<span class="keyword" id="3094896">return</span>&nbsp;<span class="builtinfunc" id="3094903">len</span><span class="op" id="3094906">(</span><span class="ident" id="3094907">te</span><span class="op" id="3094909">)</span>&nbsp;<span class="op" id="3094911">&gt;</span>&nbsp;<span class="num" id="3094913">0</span>&nbsp;<span class="op" id="3094915">&amp;&amp;</span>&nbsp;<span class="ident" id="3094918">te</span><span class="op" id="3094920">[</span><span class="num" id="3094921">0</span><span class="op" id="3094922">]</span>&nbsp;<span class="op" id="3094924">==</span>&nbsp;<span class="string" id="3094927">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3094937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3094940">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3094997">func</span>&nbsp;<span class="ident" id="3095002">isIdentity</span><span class="op" id="3095012">(</span><span class="ident" id="3095013">te</span>&nbsp;<span class="op" id="3095016">[</span><span class="op" id="3095017">]</span><span class="builtintype" id="3095018">string</span><span class="op" id="3095024">)</span>&nbsp;<span class="builtintype" id="3095026">bool</span>&nbsp;<span class="op" id="3095031">{</span>&nbsp;<span class="keyword" id="3095033">return</span>&nbsp;<span class="builtinfunc" id="3095040">len</span><span class="op" id="3095043">(</span><span class="ident" id="3095044">te</span><span class="op" id="3095046">)</span>&nbsp;<span class="op" id="3095048">==</span>&nbsp;<span class="num" id="3095051">1</span>&nbsp;<span class="op" id="3095053">&amp;&amp;</span>&nbsp;<span class="ident" id="3095056">te</span><span class="op" id="3095058">[</span><span class="num" id="3095059">0</span><span class="op" id="3095060">]</span>&nbsp;<span class="op" id="3095062">==</span>&nbsp;<span class="string" id="3095065">&#34;identity&#34;</span>&nbsp;<span class="op" id="3095076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3095079">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3095109">func</span>&nbsp;<span class="ident" id="3095114">fixTransferEncoding</span><span class="op" id="3095133">(</span><span class="ident" id="3095134">requestMethod</span>&nbsp;<span class="builtintype" id="3095148">string</span><span class="op" id="3095154">,</span>&nbsp;<span class="ident" id="3095156">header</span>&nbsp;<span class="ident" id="3095163">Header</span><span class="op" id="3095169">)</span>&nbsp;<span class="op" id="3095171">(</span><span class="op" id="3095172">[</span><span class="op" id="3095173">]</span><span class="builtintype" id="3095174">string</span><span class="op" id="3095180">,</span>&nbsp;<span class="builtintype" id="3095182">error</span><span class="op" id="3095187">)</span>&nbsp;<span class="op" id="3095189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3095192">raw</span><span class="op" id="3095195">,</span>&nbsp;<span class="ident" id="3095197">present</span>&nbsp;<span class="op" id="3095205">:=</span>&nbsp;<span class="ident" id="3095208">header</span><span class="op" id="3095214">[</span><span class="string" id="3095215">&#34;Transfer-Encoding&#34;</span><span class="op" id="3095234">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095237">if</span>&nbsp;<span class="op" id="3095240">!</span><span class="ident" id="3095241">present</span>&nbsp;<span class="op" id="3095249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095253">return</span>&nbsp;<span class="builtintype" id="3095260">nil</span><span class="op" id="3095263">,</span>&nbsp;<span class="builtintype" id="3095265">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3095270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3095274">delete</span><span class="op" id="3095280">(</span><span class="ident" id="3095281">header</span><span class="op" id="3095287">,</span>&nbsp;<span class="string" id="3095289">&#34;Transfer-Encoding&#34;</span><span class="op" id="3095308">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3095312">encodings</span>&nbsp;<span class="op" id="3095322">:=</span>&nbsp;<span class="ident" id="3095325">strings</span><span class="op" id="3095332">.</span><span class="ident" id="3095333">Split</span><span class="op" id="3095338">(</span><span class="ident" id="3095339">raw</span><span class="op" id="3095342">[</span><span class="num" id="3095343">0</span><span class="op" id="3095344">]</span><span class="op" id="3095345">,</span>&nbsp;<span class="string" id="3095347">&#34;,&#34;</span><span class="op" id="3095350">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3095353">te</span>&nbsp;<span class="op" id="3095356">:=</span>&nbsp;<span class="builtinfunc" id="3095359">make</span><span class="op" id="3095363">(</span><span class="op" id="3095364">[</span><span class="op" id="3095365">]</span><span class="builtintype" id="3095366">string</span><span class="op" id="3095372">,</span>&nbsp;<span class="num" id="3095374">0</span><span class="op" id="3095375">,</span>&nbsp;<span class="builtinfunc" id="3095377">len</span><span class="op" id="3095380">(</span><span class="ident" id="3095381">encodings</span><span class="op" id="3095390">)</span><span class="op" id="3095391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3095394">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3095457">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3095519">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3095578">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095623">for</span>&nbsp;<span class="ident" id="3095627">_</span><span class="op" id="3095628">,</span>&nbsp;<span class="ident" id="3095630">encoding</span>&nbsp;<span class="op" id="3095639">:=</span>&nbsp;<span class="keyword" id="3095642">range</span>&nbsp;<span class="ident" id="3095648">encodings</span>&nbsp;<span class="op" id="3095658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3095662">encoding</span>&nbsp;<span class="op" id="3095671">=</span>&nbsp;<span class="ident" id="3095673">strings</span><span class="op" id="3095680">.</span><span class="ident" id="3095681">ToLower</span><span class="op" id="3095688">(</span><span class="ident" id="3095689">strings</span><span class="op" id="3095696">.</span><span class="ident" id="3095697">TrimSpace</span><span class="op" id="3095706">(</span><span class="ident" id="3095707">encoding</span><span class="op" id="3095715">)</span><span class="op" id="3095716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3095720">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095761">if</span>&nbsp;<span class="ident" id="3095764">encoding</span>&nbsp;<span class="op" id="3095773">==</span>&nbsp;<span class="string" id="3095776">&#34;identity&#34;</span>&nbsp;<span class="op" id="3095787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095792">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3095800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095804">if</span>&nbsp;<span class="ident" id="3095807">encoding</span>&nbsp;<span class="op" id="3095816">!=</span>&nbsp;<span class="string" id="3095819">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3095829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095834">return</span>&nbsp;<span class="builtintype" id="3095841">nil</span><span class="op" id="3095844">,</span>&nbsp;<span class="op" id="3095846">&amp;</span><span class="ident" id="3095847">badStringError</span><span class="op" id="3095861">{</span><span class="string" id="3095862">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3095893">,</span>&nbsp;<span class="ident" id="3095895">encoding</span><span class="op" id="3095903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3095907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3095911">te</span>&nbsp;<span class="op" id="3095914">=</span>&nbsp;<span class="ident" id="3095916">te</span><span class="op" id="3095918">[</span><span class="num" id="3095919">0</span>&nbsp;<span class="op" id="3095921">:</span>&nbsp;<span class="builtinfunc" id="3095923">len</span><span class="op" id="3095926">(</span><span class="ident" id="3095927">te</span><span class="op" id="3095929">)</span><span class="op" id="3095930">+</span><span class="num" id="3095931">1</span><span class="op" id="3095932">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3095936">te</span><span class="op" id="3095938">[</span><span class="builtinfunc" id="3095939">len</span><span class="op" id="3095942">(</span><span class="ident" id="3095943">te</span><span class="op" id="3095945">)</span><span class="op" id="3095946">-</span><span class="num" id="3095947">1</span><span class="op" id="3095948">]</span>&nbsp;<span class="op" id="3095950">=</span>&nbsp;<span class="ident" id="3095952">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3095962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095965">if</span>&nbsp;<span class="builtinfunc" id="3095968">len</span><span class="op" id="3095971">(</span><span class="ident" id="3095972">te</span><span class="op" id="3095974">)</span>&nbsp;<span class="op" id="3095976">&gt;</span>&nbsp;<span class="num" id="3095978">1</span>&nbsp;<span class="op" id="3095980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3095984">return</span>&nbsp;<span class="builtintype" id="3095991">nil</span><span class="op" id="3095994">,</span>&nbsp;<span class="op" id="3095996">&amp;</span><span class="ident" id="3095997">badStringError</span><span class="op" id="3096011">{</span><span class="string" id="3096012">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3096041">,</span>&nbsp;<span class="ident" id="3096043">strings</span><span class="op" id="3096050">.</span><span class="ident" id="3096051">Join</span><span class="op" id="3096055">(</span><span class="ident" id="3096056">te</span><span class="op" id="3096058">,</span>&nbsp;<span class="string" id="3096060">&#34;,&#34;</span><span class="op" id="3096063">)</span><span class="op" id="3096064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3096067">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096070">if</span>&nbsp;<span class="builtinfunc" id="3096073">len</span><span class="op" id="3096076">(</span><span class="ident" id="3096077">te</span><span class="op" id="3096079">)</span>&nbsp;<span class="op" id="3096081">&gt;</span>&nbsp;<span class="num" id="3096083">0</span>&nbsp;<span class="op" id="3096085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3096089">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3096147">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3096203">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3096218">delete</span><span class="op" id="3096224">(</span><span class="ident" id="3096225">header</span><span class="op" id="3096231">,</span>&nbsp;<span class="string" id="3096233">&#34;Content-Length&#34;</span><span class="op" id="3096249">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096253">return</span>&nbsp;<span class="ident" id="3096260">te</span><span class="op" id="3096262">,</span>&nbsp;<span class="builtintype" id="3096264">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3096269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096273">return</span>&nbsp;<span class="builtintype" id="3096280">nil</span><span class="op" id="3096283">,</span>&nbsp;<span class="builtintype" id="3096285">nil</span><br>
<span class="lineno"></span><span class="op" id="3096289">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3096292">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3096364">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3096435">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3096468">func</span>&nbsp;<span class="ident" id="3096473">fixLength</span><span class="op" id="3096482">(</span><span class="ident" id="3096483">isResponse</span>&nbsp;<span class="builtintype" id="3096494">bool</span><span class="op" id="3096498">,</span>&nbsp;<span class="ident" id="3096500">status</span>&nbsp;<span class="builtintype" id="3096507">int</span><span class="op" id="3096510">,</span>&nbsp;<span class="ident" id="3096512">requestMethod</span>&nbsp;<span class="builtintype" id="3096526">string</span><span class="op" id="3096532">,</span>&nbsp;<span class="ident" id="3096534">header</span>&nbsp;<span class="ident" id="3096541">Header</span><span class="op" id="3096547">,</span>&nbsp;<span class="ident" id="3096549">te</span>&nbsp;<span class="op" id="3096552">[</span><span class="op" id="3096553">]</span><span class="builtintype" id="3096554">string</span><span class="op" id="3096560">)</span>&nbsp;<span class="op" id="3096562">(</span><span class="ident" id="3096563">int64</span><span class="op" id="3096568">,</span>&nbsp;<span class="builtintype" id="3096570">error</span><span class="op" id="3096575">)</span>&nbsp;<span class="op" id="3096577">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3096581">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096624">if</span>&nbsp;<span class="ident" id="3096627">noBodyExpected</span><span class="op" id="3096641">(</span><span class="ident" id="3096642">requestMethod</span><span class="op" id="3096655">)</span>&nbsp;<span class="op" id="3096657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096661">return</span>&nbsp;<span class="num" id="3096668">0</span><span class="op" id="3096669">,</span>&nbsp;<span class="builtintype" id="3096671">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3096676">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096679">if</span>&nbsp;<span class="ident" id="3096682">status</span><span class="op" id="3096688">/</span><span class="num" id="3096689">100</span>&nbsp;<span class="op" id="3096693">==</span>&nbsp;<span class="num" id="3096696">1</span>&nbsp;<span class="op" id="3096698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096702">return</span>&nbsp;<span class="num" id="3096709">0</span><span class="op" id="3096710">,</span>&nbsp;<span class="builtintype" id="3096712">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3096717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096720">switch</span>&nbsp;<span class="ident" id="3096727">status</span>&nbsp;<span class="op" id="3096734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096737">case</span>&nbsp;<span class="num" id="3096742">204</span><span class="op" id="3096745">,</span>&nbsp;<span class="num" id="3096747">304</span><span class="op" id="3096750">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096754">return</span>&nbsp;<span class="num" id="3096761">0</span><span class="op" id="3096762">,</span>&nbsp;<span class="builtintype" id="3096764">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3096769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3096773">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096810">if</span>&nbsp;<span class="ident" id="3096813">chunked</span><span class="op" id="3096820">(</span><span class="ident" id="3096821">te</span><span class="op" id="3096823">)</span>&nbsp;<span class="op" id="3096825">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096829">return</span>&nbsp;<span class="op" id="3096836">-</span><span class="num" id="3096837">1</span><span class="op" id="3096838">,</span>&nbsp;<span class="builtintype" id="3096840">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3096845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3096849">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3096883">cl</span>&nbsp;<span class="op" id="3096886">:=</span>&nbsp;<span class="ident" id="3096889">strings</span><span class="op" id="3096896">.</span><span class="ident" id="3096897">TrimSpace</span><span class="op" id="3096906">(</span><span class="ident" id="3096907">header</span><span class="op" id="3096913">.</span><span class="ident" id="3096914">get</span><span class="op" id="3096917">(</span><span class="string" id="3096918">&#34;Content-Length&#34;</span><span class="op" id="3096934">)</span><span class="op" id="3096935">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096938">if</span>&nbsp;<span class="ident" id="3096941">cl</span>&nbsp;<span class="op" id="3096944">!=</span>&nbsp;<span class="string" id="3096947">&#34;&#34;</span>&nbsp;<span class="op" id="3096950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3096954">n</span><span class="op" id="3096955">,</span>&nbsp;<span class="ident" id="3096957">err</span>&nbsp;<span class="op" id="3096961">:=</span>&nbsp;<span class="ident" id="3096964">parseContentLength</span><span class="op" id="3096982">(</span><span class="ident" id="3096983">cl</span><span class="op" id="3096985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3096989">if</span>&nbsp;<span class="ident" id="3096992">err</span>&nbsp;<span class="op" id="3096996">!=</span>&nbsp;<span class="builtintype" id="3096999">nil</span>&nbsp;<span class="op" id="3097003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097008">return</span>&nbsp;<span class="op" id="3097015">-</span><span class="num" id="3097016">1</span><span class="op" id="3097017">,</span>&nbsp;<span class="ident" id="3097019">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097025">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097029">return</span>&nbsp;<span class="ident" id="3097036">n</span><span class="op" id="3097037">,</span>&nbsp;<span class="builtintype" id="3097039">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097044">}</span>&nbsp;<span class="keyword" id="3097046">else</span>&nbsp;<span class="op" id="3097051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3097055">header</span><span class="op" id="3097061">.</span><span class="ident" id="3097062">Del</span><span class="op" id="3097065">(</span><span class="string" id="3097066">&#34;Content-Length&#34;</span><span class="op" id="3097082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097089">if</span>&nbsp;<span class="op" id="3097092">!</span><span class="ident" id="3097093">isResponse</span>&nbsp;<span class="op" id="3097104">&amp;&amp;</span>&nbsp;<span class="ident" id="3097107">requestMethod</span>&nbsp;<span class="op" id="3097121">==</span>&nbsp;<span class="string" id="3097124">&#34;GET&#34;</span>&nbsp;<span class="op" id="3097130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097134">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097188">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097242">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097297">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097335">return</span>&nbsp;<span class="num" id="3097342">0</span><span class="op" id="3097343">,</span>&nbsp;<span class="builtintype" id="3097345">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097354">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097430">return</span>&nbsp;<span class="op" id="3097437">-</span><span class="num" id="3097438">1</span><span class="op" id="3097439">,</span>&nbsp;<span class="builtintype" id="3097441">nil</span><br>
<span class="lineno">500</span><span class="op" id="3097445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3097448">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3097517">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3097550">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3097585">func</span>&nbsp;<span class="ident" id="3097590">shouldClose</span><span class="op" id="3097601">(</span><span class="ident" id="3097602">major</span><span class="op" id="3097607">,</span>&nbsp;<span class="ident" id="3097609">minor</span>&nbsp;<span class="builtintype" id="3097615">int</span><span class="op" id="3097618">,</span>&nbsp;<span class="ident" id="3097620">header</span>&nbsp;<span class="ident" id="3097627">Header</span><span class="op" id="3097633">,</span>&nbsp;<span class="ident" id="3097635">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3097653">bool</span><span class="op" id="3097657">)</span>&nbsp;<span class="builtintype" id="3097659">bool</span>&nbsp;<span class="op" id="3097664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097667">if</span>&nbsp;<span class="ident" id="3097670">major</span>&nbsp;<span class="op" id="3097676">&lt;</span>&nbsp;<span class="num" id="3097678">1</span>&nbsp;<span class="op" id="3097680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097684">return</span>&nbsp;<span class="builtintype" id="3097691">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097697">}</span>&nbsp;<span class="keyword" id="3097699">else</span>&nbsp;<span class="keyword" id="3097704">if</span>&nbsp;<span class="ident" id="3097707">major</span>&nbsp;<span class="op" id="3097713">==</span>&nbsp;<span class="num" id="3097716">1</span>&nbsp;<span class="op" id="3097718">&amp;&amp;</span>&nbsp;<span class="ident" id="3097721">minor</span>&nbsp;<span class="op" id="3097727">==</span>&nbsp;<span class="num" id="3097730">0</span>&nbsp;<span class="op" id="3097732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097736">if</span>&nbsp;<span class="op" id="3097739">!</span><span class="ident" id="3097740">strings</span><span class="op" id="3097747">.</span><span class="ident" id="3097748">Contains</span><span class="op" id="3097756">(</span><span class="ident" id="3097757">strings</span><span class="op" id="3097764">.</span><span class="ident" id="3097765">ToLower</span><span class="op" id="3097772">(</span><span class="ident" id="3097773">header</span><span class="op" id="3097779">.</span><span class="ident" id="3097780">get</span><span class="op" id="3097783">(</span><span class="string" id="3097784">&#34;Connection&#34;</span><span class="op" id="3097796">)</span><span class="op" id="3097797">)</span><span class="op" id="3097798">,</span>&nbsp;<span class="string" id="3097800">&#34;keep-alive&#34;</span><span class="op" id="3097812">)</span>&nbsp;<span class="op" id="3097814">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097819">return</span>&nbsp;<span class="builtintype" id="3097826">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097837">return</span>&nbsp;<span class="builtintype" id="3097844">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3097851">}</span>&nbsp;<span class="keyword" id="3097853">else</span>&nbsp;<span class="op" id="3097858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097862">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3097927">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3097954">if</span>&nbsp;<span class="ident" id="3097957">strings</span><span class="op" id="3097964">.</span><span class="ident" id="3097965">ToLower</span><span class="op" id="3097972">(</span><span class="ident" id="3097973">header</span><span class="op" id="3097979">.</span><span class="ident" id="3097980">get</span><span class="op" id="3097983">(</span><span class="string" id="3097984">&#34;Connection&#34;</span><span class="op" id="3097996">)</span><span class="op" id="3097997">)</span>&nbsp;<span class="op" id="3097999">==</span>&nbsp;<span class="string" id="3098002">&#34;close&#34;</span>&nbsp;<span class="op" id="3098010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098015">if</span>&nbsp;<span class="ident" id="3098018">removeCloseHeader</span>&nbsp;<span class="op" id="3098036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098042">header</span><span class="op" id="3098048">.</span><span class="ident" id="3098049">Del</span><span class="op" id="3098052">(</span><span class="string" id="3098053">&#34;Connection&#34;</span><span class="op" id="3098065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098070">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098075">return</span>&nbsp;<span class="builtintype" id="3098082">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098095">return</span>&nbsp;<span class="builtintype" id="3098102">false</span><br>
<span class="lineno"></span><span class="op" id="3098108">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3098111">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3098139">func</span>&nbsp;<span class="ident" id="3098144">fixTrailer</span><span class="op" id="3098154">(</span><span class="ident" id="3098155">header</span>&nbsp;<span class="ident" id="3098162">Header</span><span class="op" id="3098168">,</span>&nbsp;<span class="ident" id="3098170">te</span>&nbsp;<span class="op" id="3098173">[</span><span class="op" id="3098174">]</span><span class="builtintype" id="3098175">string</span><span class="op" id="3098181">)</span>&nbsp;<span class="op" id="3098183">(</span><span class="ident" id="3098184">Header</span><span class="op" id="3098190">,</span>&nbsp;<span class="builtintype" id="3098192">error</span><span class="op" id="3098197">)</span>&nbsp;<span class="op" id="3098199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098202">raw</span>&nbsp;<span class="op" id="3098206">:=</span>&nbsp;<span class="ident" id="3098209">header</span><span class="op" id="3098215">.</span><span class="ident" id="3098216">get</span><span class="op" id="3098219">(</span><span class="string" id="3098220">&#34;Trailer&#34;</span><span class="op" id="3098229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098232">if</span>&nbsp;<span class="ident" id="3098235">raw</span>&nbsp;<span class="op" id="3098239">==</span>&nbsp;<span class="string" id="3098242">&#34;&#34;</span>&nbsp;<span class="op" id="3098245">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098249">return</span>&nbsp;<span class="builtintype" id="3098256">nil</span><span class="op" id="3098259">,</span>&nbsp;<span class="builtintype" id="3098261">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098270">header</span><span class="op" id="3098276">.</span><span class="ident" id="3098277">Del</span><span class="op" id="3098280">(</span><span class="string" id="3098281">&#34;Trailer&#34;</span><span class="op" id="3098290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098293">trailer</span>&nbsp;<span class="op" id="3098301">:=</span>&nbsp;<span class="builtinfunc" id="3098304">make</span><span class="op" id="3098308">(</span><span class="ident" id="3098309">Header</span><span class="op" id="3098315">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098318">keys</span>&nbsp;<span class="op" id="3098323">:=</span>&nbsp;<span class="ident" id="3098326">strings</span><span class="op" id="3098333">.</span><span class="ident" id="3098334">Split</span><span class="op" id="3098339">(</span><span class="ident" id="3098340">raw</span><span class="op" id="3098343">,</span>&nbsp;<span class="string" id="3098345">&#34;,&#34;</span><span class="op" id="3098348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098351">for</span>&nbsp;<span class="ident" id="3098355">_</span><span class="op" id="3098356">,</span>&nbsp;<span class="ident" id="3098358">key</span>&nbsp;<span class="op" id="3098362">:=</span>&nbsp;<span class="keyword" id="3098365">range</span>&nbsp;<span class="ident" id="3098371">keys</span>&nbsp;<span class="op" id="3098376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098380">key</span>&nbsp;<span class="op" id="3098384">=</span>&nbsp;<span class="ident" id="3098386">CanonicalHeaderKey</span><span class="op" id="3098404">(</span><span class="ident" id="3098405">strings</span><span class="op" id="3098412">.</span><span class="ident" id="3098413">TrimSpace</span><span class="op" id="3098422">(</span><span class="ident" id="3098423">key</span><span class="op" id="3098426">)</span><span class="op" id="3098427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098431">switch</span>&nbsp;<span class="ident" id="3098438">key</span>&nbsp;<span class="op" id="3098442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098446">case</span>&nbsp;<span class="string" id="3098451">&#34;Transfer-Encoding&#34;</span><span class="op" id="3098470">,</span>&nbsp;<span class="string" id="3098472">&#34;Trailer&#34;</span><span class="op" id="3098481">,</span>&nbsp;<span class="string" id="3098483">&#34;Content-Length&#34;</span><span class="op" id="3098499">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098504">return</span>&nbsp;<span class="builtintype" id="3098511">nil</span><span class="op" id="3098514">,</span>&nbsp;<span class="op" id="3098516">&amp;</span><span class="ident" id="3098517">badStringError</span><span class="op" id="3098531">{</span><span class="string" id="3098532">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3098549">,</span>&nbsp;<span class="ident" id="3098551">key</span><span class="op" id="3098554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098562">trailer</span><span class="op" id="3098569">[</span><span class="ident" id="3098570">key</span><span class="op" id="3098573">]</span>&nbsp;<span class="op" id="3098575">=</span>&nbsp;<span class="builtintype" id="3098577">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098585">if</span>&nbsp;<span class="builtinfunc" id="3098588">len</span><span class="op" id="3098591">(</span><span class="ident" id="3098592">trailer</span><span class="op" id="3098599">)</span>&nbsp;<span class="op" id="3098601">==</span>&nbsp;<span class="num" id="3098604">0</span>&nbsp;<span class="op" id="3098606">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098610">return</span>&nbsp;<span class="builtintype" id="3098617">nil</span><span class="op" id="3098620">,</span>&nbsp;<span class="builtintype" id="3098622">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098630">if</span>&nbsp;<span class="op" id="3098633">!</span><span class="ident" id="3098634">chunked</span><span class="op" id="3098641">(</span><span class="ident" id="3098642">te</span><span class="op" id="3098644">)</span>&nbsp;<span class="op" id="3098646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3098650">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098679">return</span>&nbsp;<span class="builtintype" id="3098686">nil</span><span class="op" id="3098689">,</span>&nbsp;<span class="ident" id="3098691">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3098713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098716">return</span>&nbsp;<span class="ident" id="3098723">trailer</span><span class="op" id="3098730">,</span>&nbsp;<span class="builtintype" id="3098732">nil</span><br>
<span class="lineno"></span><span class="op" id="3098736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3098739">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3098781">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3098832">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3098876">type</span>&nbsp;<span class="ident" id="3098881">body</span>&nbsp;<span class="keyword" id="3098886">struct</span>&nbsp;<span class="op" id="3098893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098896">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098904">io</span><span class="op" id="3098906">.</span><span class="ident" id="3098907">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098915">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3098923">interface</span><span class="op" id="3098932">{</span><span class="op" id="3098933">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3098937">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3098996">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3099004">*</span><span class="ident" id="3099005">bufio</span><span class="op" id="3099010">.</span><span class="ident" id="3099011">Reader</span>&nbsp;<span class="comment" id="3099018">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099068">closing</span>&nbsp;<span class="builtintype" id="3099076">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3099090">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099146">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099153">sync</span><span class="op" id="3099157">.</span><span class="ident" id="3099158">Mutex</span>&nbsp;<span class="comment" id="3099164">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099211">closed</span>&nbsp;<span class="builtintype" id="3099218">bool</span><br>
<span class="lineno">565</span><span class="op" id="3099223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3099226">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3099298">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3099378">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3099442">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3099461">var</span>&nbsp;<span class="ident" id="3099465">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3099487">=</span>&nbsp;<span class="ident" id="3099489">errors</span><span class="op" id="3099495">.</span><span class="ident" id="3099496">New</span><span class="op" id="3099499">(</span><span class="string" id="3099500">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3099535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3099538">func</span>&nbsp;<span class="op" id="3099543">(</span><span class="ident" id="3099544">b</span>&nbsp;<span class="op" id="3099546">*</span><span class="ident" id="3099547">body</span><span class="op" id="3099551">)</span>&nbsp;<span class="ident" id="3099553">Read</span><span class="op" id="3099557">(</span><span class="ident" id="3099558">p</span>&nbsp;<span class="op" id="3099560">[</span><span class="op" id="3099561">]</span><span class="builtintype" id="3099562">byte</span><span class="op" id="3099566">)</span>&nbsp;<span class="op" id="3099568">(</span><span class="ident" id="3099569">n</span>&nbsp;<span class="builtintype" id="3099571">int</span><span class="op" id="3099574">,</span>&nbsp;<span class="ident" id="3099576">err</span>&nbsp;<span class="builtintype" id="3099580">error</span><span class="op" id="3099585">)</span>&nbsp;<span class="op" id="3099587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099590">b</span><span class="op" id="3099591">.</span><span class="ident" id="3099592">mu</span><span class="op" id="3099594">.</span><span class="ident" id="3099595">Lock</span><span class="op" id="3099599">(</span><span class="op" id="3099600">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099603">defer</span>&nbsp;<span class="ident" id="3099609">b</span><span class="op" id="3099610">.</span><span class="ident" id="3099611">mu</span><span class="op" id="3099613">.</span><span class="ident" id="3099614">Unlock</span><span class="op" id="3099620">(</span><span class="op" id="3099621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099624">if</span>&nbsp;<span class="ident" id="3099627">b</span><span class="op" id="3099628">.</span><span class="ident" id="3099629">closed</span>&nbsp;<span class="op" id="3099636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099640">return</span>&nbsp;<span class="num" id="3099647">0</span><span class="op" id="3099648">,</span>&nbsp;<span class="ident" id="3099650">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3099673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099676">return</span>&nbsp;<span class="ident" id="3099683">b</span><span class="op" id="3099684">.</span><span class="ident" id="3099685">readLocked</span><span class="op" id="3099695">(</span><span class="ident" id="3099696">p</span><span class="op" id="3099697">)</span><br>
<span class="lineno">580</span><span class="op" id="3099699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3099702">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3099721">func</span>&nbsp;<span class="op" id="3099726">(</span><span class="ident" id="3099727">b</span>&nbsp;<span class="op" id="3099729">*</span><span class="ident" id="3099730">body</span><span class="op" id="3099734">)</span>&nbsp;<span class="ident" id="3099736">readLocked</span><span class="op" id="3099746">(</span><span class="ident" id="3099747">p</span>&nbsp;<span class="op" id="3099749">[</span><span class="op" id="3099750">]</span><span class="builtintype" id="3099751">byte</span><span class="op" id="3099755">)</span>&nbsp;<span class="op" id="3099757">(</span><span class="ident" id="3099758">n</span>&nbsp;<span class="builtintype" id="3099760">int</span><span class="op" id="3099763">,</span>&nbsp;<span class="ident" id="3099765">err</span>&nbsp;<span class="builtintype" id="3099769">error</span><span class="op" id="3099774">)</span>&nbsp;<span class="op" id="3099776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099779">n</span><span class="op" id="3099780">,</span>&nbsp;<span class="ident" id="3099782">err</span>&nbsp;<span class="op" id="3099786">=</span>&nbsp;<span class="ident" id="3099788">b</span><span class="op" id="3099789">.</span><span class="ident" id="3099790">src</span><span class="op" id="3099793">.</span><span class="ident" id="3099794">Read</span><span class="op" id="3099798">(</span><span class="ident" id="3099799">p</span><span class="op" id="3099800">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099804">if</span>&nbsp;<span class="ident" id="3099807">err</span>&nbsp;<span class="op" id="3099811">==</span>&nbsp;<span class="ident" id="3099814">io</span><span class="op" id="3099816">.</span><span class="ident" id="3099817">EOF</span>&nbsp;<span class="op" id="3099821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3099825">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099862">if</span>&nbsp;<span class="ident" id="3099865">b</span><span class="op" id="3099866">.</span><span class="ident" id="3099867">hdr</span>&nbsp;<span class="op" id="3099871">!=</span>&nbsp;<span class="builtintype" id="3099874">nil</span>&nbsp;<span class="op" id="3099878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099883">if</span>&nbsp;<span class="ident" id="3099886">e</span>&nbsp;<span class="op" id="3099888">:=</span>&nbsp;<span class="ident" id="3099891">b</span><span class="op" id="3099892">.</span><span class="ident" id="3099893">readTrailer</span><span class="op" id="3099904">(</span><span class="op" id="3099905">)</span><span class="op" id="3099906">;</span>&nbsp;<span class="ident" id="3099908">e</span>&nbsp;<span class="op" id="3099910">!=</span>&nbsp;<span class="builtintype" id="3099913">nil</span>&nbsp;<span class="op" id="3099917">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099923">err</span>&nbsp;<span class="op" id="3099927">=</span>&nbsp;<span class="ident" id="3099929">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3099934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3099939">b</span><span class="op" id="3099940">.</span><span class="ident" id="3099941">hdr</span>&nbsp;<span class="op" id="3099945">=</span>&nbsp;<span class="builtintype" id="3099947">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3099953">}</span>&nbsp;<span class="keyword" id="3099955">else</span>&nbsp;<span class="op" id="3099960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3099965">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100042">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100101">if</span>&nbsp;<span class="ident" id="3100104">lr</span><span class="op" id="3100106">,</span>&nbsp;<span class="ident" id="3100108">ok</span>&nbsp;<span class="op" id="3100111">:=</span>&nbsp;<span class="ident" id="3100114">b</span><span class="op" id="3100115">.</span><span class="ident" id="3100116">src</span><span class="op" id="3100119">.</span><span class="op" id="3100120">(</span><span class="op" id="3100121">*</span><span class="ident" id="3100122">io</span><span class="op" id="3100124">.</span><span class="ident" id="3100125">LimitedReader</span><span class="op" id="3100138">)</span><span class="op" id="3100139">;</span>&nbsp;<span class="ident" id="3100141">ok</span>&nbsp;<span class="op" id="3100144">&amp;&amp;</span>&nbsp;<span class="ident" id="3100147">lr</span><span class="op" id="3100149">.</span><span class="ident" id="3100150">N</span>&nbsp;<span class="op" id="3100152">&gt;</span>&nbsp;<span class="num" id="3100154">0</span>&nbsp;<span class="op" id="3100156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3100162">err</span>&nbsp;<span class="op" id="3100166">=</span>&nbsp;<span class="ident" id="3100168">io</span><span class="op" id="3100170">.</span><span class="ident" id="3100171">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100195">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100202">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100264">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100327">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100387">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100448">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100493">if</span>&nbsp;<span class="ident" id="3100496">err</span>&nbsp;<span class="op" id="3100500">==</span>&nbsp;<span class="builtintype" id="3100503">nil</span>&nbsp;<span class="op" id="3100507">&amp;&amp;</span>&nbsp;<span class="ident" id="3100510">n</span>&nbsp;<span class="op" id="3100512">&gt;</span>&nbsp;<span class="num" id="3100514">0</span>&nbsp;<span class="op" id="3100516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100520">if</span>&nbsp;<span class="ident" id="3100523">lr</span><span class="op" id="3100525">,</span>&nbsp;<span class="ident" id="3100527">ok</span>&nbsp;<span class="op" id="3100530">:=</span>&nbsp;<span class="ident" id="3100533">b</span><span class="op" id="3100534">.</span><span class="ident" id="3100535">src</span><span class="op" id="3100538">.</span><span class="op" id="3100539">(</span><span class="op" id="3100540">*</span><span class="ident" id="3100541">io</span><span class="op" id="3100543">.</span><span class="ident" id="3100544">LimitedReader</span><span class="op" id="3100557">)</span><span class="op" id="3100558">;</span>&nbsp;<span class="ident" id="3100560">ok</span>&nbsp;<span class="op" id="3100563">&amp;&amp;</span>&nbsp;<span class="ident" id="3100566">lr</span><span class="op" id="3100568">.</span><span class="ident" id="3100569">N</span>&nbsp;<span class="op" id="3100571">==</span>&nbsp;<span class="num" id="3100574">0</span>&nbsp;<span class="op" id="3100576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3100581">err</span>&nbsp;<span class="op" id="3100585">=</span>&nbsp;<span class="ident" id="3100587">io</span><span class="op" id="3100589">.</span><span class="ident" id="3100590">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100603">return</span>&nbsp;<span class="ident" id="3100610">n</span><span class="op" id="3100611">,</span>&nbsp;<span class="ident" id="3100613">err</span><br>
<span class="lineno"></span><span class="op" id="3100617">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3100620">var</span>&nbsp;<span class="op" id="3100624">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3100627">singleCRLF</span>&nbsp;<span class="op" id="3100638">=</span>&nbsp;<span class="op" id="3100640">[</span><span class="op" id="3100641">]</span><span class="builtintype" id="3100642">byte</span><span class="op" id="3100646">(</span><span class="string" id="3100647">&#34;\r\n&#34;</span><span class="op" id="3100653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3100656">doubleCRLF</span>&nbsp;<span class="op" id="3100667">=</span>&nbsp;<span class="op" id="3100669">[</span><span class="op" id="3100670">]</span><span class="builtintype" id="3100671">byte</span><span class="op" id="3100675">(</span><span class="string" id="3100676">&#34;\r\n\r\n&#34;</span><span class="op" id="3100686">)</span><br>
<span class="lineno"></span><span class="op" id="3100688">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3100691">func</span>&nbsp;<span class="ident" id="3100696">seeUpcomingDoubleCRLF</span><span class="op" id="3100717">(</span><span class="ident" id="3100718">r</span>&nbsp;<span class="op" id="3100720">*</span><span class="ident" id="3100721">bufio</span><span class="op" id="3100726">.</span><span class="ident" id="3100727">Reader</span><span class="op" id="3100733">)</span>&nbsp;<span class="builtintype" id="3100735">bool</span>&nbsp;<span class="op" id="3100740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100743">for</span>&nbsp;<span class="ident" id="3100747">peekSize</span>&nbsp;<span class="op" id="3100756">:=</span>&nbsp;<span class="num" id="3100759">4</span><span class="op" id="3100760">;</span>&nbsp;<span class="op" id="3100762">;</span>&nbsp;<span class="ident" id="3100764">peekSize</span><span class="op" id="3100772">++</span>&nbsp;<span class="op" id="3100775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100779">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3100828">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3100880">buf</span><span class="op" id="3100883">,</span>&nbsp;<span class="ident" id="3100885">err</span>&nbsp;<span class="op" id="3100889">:=</span>&nbsp;<span class="ident" id="3100892">r</span><span class="op" id="3100893">.</span><span class="ident" id="3100894">Peek</span><span class="op" id="3100898">(</span><span class="ident" id="3100899">peekSize</span><span class="op" id="3100907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100911">if</span>&nbsp;<span class="ident" id="3100914">bytes</span><span class="op" id="3100919">.</span><span class="ident" id="3100920">HasSuffix</span><span class="op" id="3100929">(</span><span class="ident" id="3100930">buf</span><span class="op" id="3100933">,</span>&nbsp;<span class="ident" id="3100935">doubleCRLF</span><span class="op" id="3100945">)</span>&nbsp;<span class="op" id="3100947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100952">return</span>&nbsp;<span class="builtintype" id="3100959">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100970">if</span>&nbsp;<span class="ident" id="3100973">err</span>&nbsp;<span class="op" id="3100977">!=</span>&nbsp;<span class="builtintype" id="3100980">nil</span>&nbsp;<span class="op" id="3100984">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3100989">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3100997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3101000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101003">return</span>&nbsp;<span class="builtintype" id="3101010">false</span><br>
<span class="lineno"></span><span class="op" id="3101016">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3101019">var</span>&nbsp;<span class="ident" id="3101023">errTrailerEOF</span>&nbsp;<span class="op" id="3101037">=</span>&nbsp;<span class="ident" id="3101039">errors</span><span class="op" id="3101045">.</span><span class="ident" id="3101046">New</span><span class="op" id="3101049">(</span><span class="string" id="3101050">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3101088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3101091">func</span>&nbsp;<span class="op" id="3101096">(</span><span class="ident" id="3101097">b</span>&nbsp;<span class="op" id="3101099">*</span><span class="ident" id="3101100">body</span><span class="op" id="3101104">)</span>&nbsp;<span class="ident" id="3101106">readTrailer</span><span class="op" id="3101117">(</span><span class="op" id="3101118">)</span>&nbsp;<span class="builtintype" id="3101120">error</span>&nbsp;<span class="op" id="3101126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101129">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3101178">buf</span><span class="op" id="3101181">,</span>&nbsp;<span class="ident" id="3101183">err</span>&nbsp;<span class="op" id="3101187">:=</span>&nbsp;<span class="ident" id="3101190">b</span><span class="op" id="3101191">.</span><span class="ident" id="3101192">r</span><span class="op" id="3101193">.</span><span class="ident" id="3101194">Peek</span><span class="op" id="3101198">(</span><span class="num" id="3101199">2</span><span class="op" id="3101200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101203">if</span>&nbsp;<span class="ident" id="3101206">bytes</span><span class="op" id="3101211">.</span><span class="ident" id="3101212">Equal</span><span class="op" id="3101217">(</span><span class="ident" id="3101218">buf</span><span class="op" id="3101221">,</span>&nbsp;<span class="ident" id="3101223">singleCRLF</span><span class="op" id="3101233">)</span>&nbsp;<span class="op" id="3101235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3101239">b</span><span class="op" id="3101240">.</span><span class="ident" id="3101241">r</span><span class="op" id="3101242">.</span><span class="ident" id="3101243">ReadByte</span><span class="op" id="3101251">(</span><span class="op" id="3101252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3101256">b</span><span class="op" id="3101257">.</span><span class="ident" id="3101258">r</span><span class="op" id="3101259">.</span><span class="ident" id="3101260">ReadByte</span><span class="op" id="3101268">(</span><span class="op" id="3101269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101273">return</span>&nbsp;<span class="builtintype" id="3101280">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3101285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101288">if</span>&nbsp;<span class="builtinfunc" id="3101291">len</span><span class="op" id="3101294">(</span><span class="ident" id="3101295">buf</span><span class="op" id="3101298">)</span>&nbsp;<span class="op" id="3101300">&lt;</span>&nbsp;<span class="num" id="3101302">2</span>&nbsp;<span class="op" id="3101304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101308">return</span>&nbsp;<span class="ident" id="3101315">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3101330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101333">if</span>&nbsp;<span class="ident" id="3101336">err</span>&nbsp;<span class="op" id="3101340">!=</span>&nbsp;<span class="builtintype" id="3101343">nil</span>&nbsp;<span class="op" id="3101347">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101351">return</span>&nbsp;<span class="ident" id="3101358">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3101363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101367">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101431">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101491">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101555">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101617">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101681">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101745">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3101808">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101882">if</span>&nbsp;<span class="op" id="3101885">!</span><span class="ident" id="3101886">seeUpcomingDoubleCRLF</span><span class="op" id="3101907">(</span><span class="ident" id="3101908">b</span><span class="op" id="3101909">.</span><span class="ident" id="3101910">r</span><span class="op" id="3101911">)</span>&nbsp;<span class="op" id="3101913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3101917">return</span>&nbsp;<span class="ident" id="3101924">errors</span><span class="op" id="3101930">.</span><span class="ident" id="3101931">New</span><span class="op" id="3101934">(</span><span class="string" id="3101935">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3101987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3101990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3101994">hdr</span><span class="op" id="3101997">,</span>&nbsp;<span class="ident" id="3101999">err</span>&nbsp;<span class="op" id="3102003">:=</span>&nbsp;<span class="ident" id="3102006">textproto</span><span class="op" id="3102015">.</span><span class="ident" id="3102016">NewReader</span><span class="op" id="3102025">(</span><span class="ident" id="3102026">b</span><span class="op" id="3102027">.</span><span class="ident" id="3102028">r</span><span class="op" id="3102029">)</span><span class="op" id="3102030">.</span><span class="ident" id="3102031">ReadMIMEHeader</span><span class="op" id="3102045">(</span><span class="op" id="3102046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102049">if</span>&nbsp;<span class="ident" id="3102052">err</span>&nbsp;<span class="op" id="3102056">!=</span>&nbsp;<span class="builtintype" id="3102059">nil</span>&nbsp;<span class="op" id="3102063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102067">if</span>&nbsp;<span class="ident" id="3102070">err</span>&nbsp;<span class="op" id="3102074">==</span>&nbsp;<span class="ident" id="3102077">io</span><span class="op" id="3102079">.</span><span class="ident" id="3102080">EOF</span>&nbsp;<span class="op" id="3102084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102089">return</span>&nbsp;<span class="ident" id="3102096">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102112">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102116">return</span>&nbsp;<span class="ident" id="3102123">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102131">switch</span>&nbsp;<span class="ident" id="3102138">rr</span>&nbsp;<span class="op" id="3102141">:=</span>&nbsp;<span class="ident" id="3102144">b</span><span class="op" id="3102145">.</span><span class="ident" id="3102146">hdr</span><span class="op" id="3102149">.</span><span class="op" id="3102150">(</span><span class="keyword" id="3102151">type</span><span class="op" id="3102155">)</span>&nbsp;<span class="op" id="3102157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102160">case</span>&nbsp;<span class="op" id="3102165">*</span><span class="ident" id="3102166">Request</span><span class="op" id="3102173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102177">mergeSetHeader</span><span class="op" id="3102191">(</span><span class="op" id="3102192">&amp;</span><span class="ident" id="3102193">rr</span><span class="op" id="3102195">.</span><span class="ident" id="3102196">Trailer</span><span class="op" id="3102203">,</span>&nbsp;<span class="ident" id="3102205">Header</span><span class="op" id="3102211">(</span><span class="ident" id="3102212">hdr</span><span class="op" id="3102215">)</span><span class="op" id="3102216">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102219">case</span>&nbsp;<span class="op" id="3102224">*</span><span class="ident" id="3102225">Response</span><span class="op" id="3102233">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102237">mergeSetHeader</span><span class="op" id="3102251">(</span><span class="op" id="3102252">&amp;</span><span class="ident" id="3102253">rr</span><span class="op" id="3102255">.</span><span class="ident" id="3102256">Trailer</span><span class="op" id="3102263">,</span>&nbsp;<span class="ident" id="3102265">Header</span><span class="op" id="3102271">(</span><span class="ident" id="3102272">hdr</span><span class="op" id="3102275">)</span><span class="op" id="3102276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102282">return</span>&nbsp;<span class="builtintype" id="3102289">nil</span><br>
<span class="lineno"></span><span class="op" id="3102293">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3102296">func</span>&nbsp;<span class="ident" id="3102301">mergeSetHeader</span><span class="op" id="3102315">(</span><span class="ident" id="3102316">dst</span>&nbsp;<span class="op" id="3102320">*</span><span class="ident" id="3102321">Header</span><span class="op" id="3102327">,</span>&nbsp;<span class="ident" id="3102329">src</span>&nbsp;<span class="ident" id="3102333">Header</span><span class="op" id="3102339">)</span>&nbsp;<span class="op" id="3102341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102344">if</span>&nbsp;<span class="op" id="3102347">*</span><span class="ident" id="3102348">dst</span>&nbsp;<span class="op" id="3102352">==</span>&nbsp;<span class="builtintype" id="3102355">nil</span>&nbsp;<span class="op" id="3102359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102363">*</span><span class="ident" id="3102364">dst</span>&nbsp;<span class="op" id="3102368">=</span>&nbsp;<span class="ident" id="3102370">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102376">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102387">for</span>&nbsp;<span class="ident" id="3102391">k</span><span class="op" id="3102392">,</span>&nbsp;<span class="ident" id="3102394">vv</span>&nbsp;<span class="op" id="3102397">:=</span>&nbsp;<span class="keyword" id="3102400">range</span>&nbsp;<span class="ident" id="3102406">src</span>&nbsp;<span class="op" id="3102410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102414">(</span><span class="op" id="3102415">*</span><span class="ident" id="3102416">dst</span><span class="op" id="3102419">)</span><span class="op" id="3102420">[</span><span class="ident" id="3102421">k</span><span class="op" id="3102422">]</span>&nbsp;<span class="op" id="3102424">=</span>&nbsp;<span class="ident" id="3102426">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102430">}</span><br>
<span class="lineno"></span><span class="op" id="3102432">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3102435">func</span>&nbsp;<span class="op" id="3102440">(</span><span class="ident" id="3102441">b</span>&nbsp;<span class="op" id="3102443">*</span><span class="ident" id="3102444">body</span><span class="op" id="3102448">)</span>&nbsp;<span class="ident" id="3102450">Close</span><span class="op" id="3102455">(</span><span class="op" id="3102456">)</span>&nbsp;<span class="builtintype" id="3102458">error</span>&nbsp;<span class="op" id="3102464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102467">b</span><span class="op" id="3102468">.</span><span class="ident" id="3102469">mu</span><span class="op" id="3102471">.</span><span class="ident" id="3102472">Lock</span><span class="op" id="3102476">(</span><span class="op" id="3102477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102480">defer</span>&nbsp;<span class="ident" id="3102486">b</span><span class="op" id="3102487">.</span><span class="ident" id="3102488">mu</span><span class="op" id="3102490">.</span><span class="ident" id="3102491">Unlock</span><span class="op" id="3102497">(</span><span class="op" id="3102498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102501">if</span>&nbsp;<span class="ident" id="3102504">b</span><span class="op" id="3102505">.</span><span class="ident" id="3102506">closed</span>&nbsp;<span class="op" id="3102513">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102517">return</span>&nbsp;<span class="builtintype" id="3102524">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102532">var</span>&nbsp;<span class="ident" id="3102536">err</span>&nbsp;<span class="builtintype" id="3102540">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102547">switch</span>&nbsp;<span class="op" id="3102554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102557">case</span>&nbsp;<span class="ident" id="3102562">b</span><span class="op" id="3102563">.</span><span class="ident" id="3102564">hdr</span>&nbsp;<span class="op" id="3102568">==</span>&nbsp;<span class="builtintype" id="3102571">nil</span>&nbsp;<span class="op" id="3102575">&amp;&amp;</span>&nbsp;<span class="ident" id="3102578">b</span><span class="op" id="3102579">.</span><span class="ident" id="3102580">closing</span><span class="op" id="3102587">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102591">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102640">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102672">default</span><span class="op" id="3102679">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102683">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3102747">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102800">_</span><span class="op" id="3102801">,</span>&nbsp;<span class="ident" id="3102803">err</span>&nbsp;<span class="op" id="3102807">=</span>&nbsp;<span class="ident" id="3102809">io</span><span class="op" id="3102811">.</span><span class="ident" id="3102812">Copy</span><span class="op" id="3102816">(</span><span class="ident" id="3102817">ioutil</span><span class="op" id="3102823">.</span><span class="ident" id="3102824">Discard</span><span class="op" id="3102831">,</span>&nbsp;<span class="ident" id="3102833">bodyLocked</span><span class="op" id="3102843">{</span><span class="ident" id="3102844">b</span><span class="op" id="3102845">}</span><span class="op" id="3102846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3102849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102852">b</span><span class="op" id="3102853">.</span><span class="ident" id="3102854">closed</span>&nbsp;<span class="op" id="3102861">=</span>&nbsp;<span class="builtintype" id="3102863">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3102869">return</span>&nbsp;<span class="ident" id="3102876">err</span><br>
<span class="lineno"></span><span class="op" id="3102880">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3102883">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3102951">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3102968">type</span>&nbsp;<span class="ident" id="3102973">bodyLocked</span>&nbsp;<span class="keyword" id="3102984">struct</span>&nbsp;<span class="op" id="3102991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3102994">b</span>&nbsp;<span class="op" id="3102996">*</span><span class="ident" id="3102997">body</span><br>
<span class="lineno">715</span><span class="op" id="3103002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3103005">func</span>&nbsp;<span class="op" id="3103010">(</span><span class="ident" id="3103011">bl</span>&nbsp;<span class="ident" id="3103014">bodyLocked</span><span class="op" id="3103024">)</span>&nbsp;<span class="ident" id="3103026">Read</span><span class="op" id="3103030">(</span><span class="ident" id="3103031">p</span>&nbsp;<span class="op" id="3103033">[</span><span class="op" id="3103034">]</span><span class="builtintype" id="3103035">byte</span><span class="op" id="3103039">)</span>&nbsp;<span class="op" id="3103041">(</span><span class="ident" id="3103042">n</span>&nbsp;<span class="builtintype" id="3103044">int</span><span class="op" id="3103047">,</span>&nbsp;<span class="ident" id="3103049">err</span>&nbsp;<span class="builtintype" id="3103053">error</span><span class="op" id="3103058">)</span>&nbsp;<span class="op" id="3103060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103063">if</span>&nbsp;<span class="ident" id="3103066">bl</span><span class="op" id="3103068">.</span><span class="ident" id="3103069">b</span><span class="op" id="3103070">.</span><span class="ident" id="3103071">closed</span>&nbsp;<span class="op" id="3103078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103082">return</span>&nbsp;<span class="num" id="3103089">0</span><span class="op" id="3103090">,</span>&nbsp;<span class="ident" id="3103092">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3103115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103118">return</span>&nbsp;<span class="ident" id="3103125">bl</span><span class="op" id="3103127">.</span><span class="ident" id="3103128">b</span><span class="op" id="3103129">.</span><span class="ident" id="3103130">readLocked</span><span class="op" id="3103140">(</span><span class="ident" id="3103141">p</span><span class="op" id="3103142">)</span><br>
<span class="lineno"></span><span class="op" id="3103144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3103147">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3103220">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3103258">func</span>&nbsp;<span class="ident" id="3103263">parseContentLength</span><span class="op" id="3103281">(</span><span class="ident" id="3103282">cl</span>&nbsp;<span class="builtintype" id="3103285">string</span><span class="op" id="3103291">)</span>&nbsp;<span class="op" id="3103293">(</span><span class="ident" id="3103294">int64</span><span class="op" id="3103299">,</span>&nbsp;<span class="builtintype" id="3103301">error</span><span class="op" id="3103306">)</span>&nbsp;<span class="op" id="3103308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3103311">cl</span>&nbsp;<span class="op" id="3103314">=</span>&nbsp;<span class="ident" id="3103316">strings</span><span class="op" id="3103323">.</span><span class="ident" id="3103324">TrimSpace</span><span class="op" id="3103333">(</span><span class="ident" id="3103334">cl</span><span class="op" id="3103336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103339">if</span>&nbsp;<span class="ident" id="3103342">cl</span>&nbsp;<span class="op" id="3103345">==</span>&nbsp;<span class="string" id="3103348">&#34;&#34;</span>&nbsp;<span class="op" id="3103351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103355">return</span>&nbsp;<span class="op" id="3103362">-</span><span class="num" id="3103363">1</span><span class="op" id="3103364">,</span>&nbsp;<span class="builtintype" id="3103366">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3103371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3103374">n</span><span class="op" id="3103375">,</span>&nbsp;<span class="ident" id="3103377">err</span>&nbsp;<span class="op" id="3103381">:=</span>&nbsp;<span class="ident" id="3103384">strconv</span><span class="op" id="3103391">.</span><span class="ident" id="3103392">ParseInt</span><span class="op" id="3103400">(</span><span class="ident" id="3103401">cl</span><span class="op" id="3103403">,</span>&nbsp;<span class="num" id="3103405">10</span><span class="op" id="3103407">,</span>&nbsp;<span class="num" id="3103409">64</span><span class="op" id="3103411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103414">if</span>&nbsp;<span class="ident" id="3103417">err</span>&nbsp;<span class="op" id="3103421">!=</span>&nbsp;<span class="builtintype" id="3103424">nil</span>&nbsp;<span class="op" id="3103428">||</span>&nbsp;<span class="ident" id="3103431">n</span>&nbsp;<span class="op" id="3103433">&lt;</span>&nbsp;<span class="num" id="3103435">0</span>&nbsp;<span class="op" id="3103437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103441">return</span>&nbsp;<span class="num" id="3103448">0</span><span class="op" id="3103449">,</span>&nbsp;<span class="op" id="3103451">&amp;</span><span class="ident" id="3103452">badStringError</span><span class="op" id="3103466">{</span><span class="string" id="3103467">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3103487">,</span>&nbsp;<span class="ident" id="3103489">cl</span><span class="op" id="3103491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3103494">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3103497">return</span>&nbsp;<span class="ident" id="3103504">n</span><span class="op" id="3103505">,</span>&nbsp;<span class="builtintype" id="3103507">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3103512">}</span>
</div>
</body>
</html>
