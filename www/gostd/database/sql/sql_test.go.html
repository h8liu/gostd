<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html" class="current">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7256133">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7256188">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7256242">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7256293">package</span>&nbsp;<span class="ident" id="7256301">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7256306">import</span>&nbsp;<span class="op" id="7256313">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256316">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256339">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256349">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256356">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256369">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256380">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256391">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256402">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256410">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7256421">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7256428">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7256431">func</span>&nbsp;<span class="ident" id="7256436">init</span><span class="op" id="7256440">(</span><span class="op" id="7256441">)</span>&nbsp;<span class="op" id="7256443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256446">type</span>&nbsp;<span class="ident" id="7256451">dbConn</span>&nbsp;<span class="keyword" id="7256458">struct</span>&nbsp;<span class="op" id="7256465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7256469">db</span>&nbsp;<span class="op" id="7256472">*</span><span class="ident" id="7256473">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7256478">c</span>&nbsp;&nbsp;<span class="op" id="7256481">*</span><span class="ident" id="7256482">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7256494">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7256497">freedFrom</span>&nbsp;<span class="op" id="7256507">:=</span>&nbsp;<span class="builtinfunc" id="7256510">make</span><span class="op" id="7256514">(</span><span class="keyword" id="7256515">map</span><span class="op" id="7256518">[</span><span class="ident" id="7256519">dbConn</span><span class="op" id="7256525">]</span><span class="builtintype" id="7256526">string</span><span class="op" id="7256532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7256535">putConnHook</span>&nbsp;<span class="op" id="7256547">=</span>&nbsp;<span class="keyword" id="7256549">func</span><span class="op" id="7256553">(</span><span class="ident" id="7256554">db</span>&nbsp;<span class="op" id="7256557">*</span><span class="ident" id="7256558">DB</span><span class="op" id="7256560">,</span>&nbsp;<span class="ident" id="7256562">c</span>&nbsp;<span class="op" id="7256564">*</span><span class="ident" id="7256565">driverConn</span><span class="op" id="7256575">)</span>&nbsp;<span class="op" id="7256577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7256581">idx</span>&nbsp;<span class="op" id="7256585">:=</span>&nbsp;<span class="op" id="7256588">-</span><span class="num" id="7256589">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256593">for</span>&nbsp;<span class="ident" id="7256597">i</span><span class="op" id="7256598">,</span>&nbsp;<span class="ident" id="7256600">v</span>&nbsp;<span class="op" id="7256602">:=</span>&nbsp;<span class="keyword" id="7256605">range</span>&nbsp;<span class="ident" id="7256611">db</span><span class="op" id="7256613">.</span><span class="ident" id="7256614">freeConn</span>&nbsp;<span class="op" id="7256623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256628">if</span>&nbsp;<span class="ident" id="7256631">v</span>&nbsp;<span class="op" id="7256633">==</span>&nbsp;<span class="ident" id="7256636">c</span>&nbsp;<span class="op" id="7256638">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7256644">idx</span>&nbsp;<span class="op" id="7256648">=</span>&nbsp;<span class="ident" id="7256650">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256656">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7256665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7256669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7256673">if</span>&nbsp;<span class="ident" id="7256676">idx</span>&nbsp;<span class="op" id="7256680">&gt;=</span>&nbsp;<span class="num" id="7256683">0</span>&nbsp;<span class="op" id="7256685">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7256690">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7256763">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7256830">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7256864">println</span><span class="op" id="7256871">(</span><span class="string" id="7256872">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="7256915">+</span>&nbsp;<span class="ident" id="7256917">freedFrom</span><span class="op" id="7256926">[</span><span class="ident" id="7256927">dbConn</span><span class="op" id="7256933">{</span><span class="ident" id="7256934">db</span><span class="op" id="7256936">,</span>&nbsp;<span class="ident" id="7256938">c</span><span class="op" id="7256939">}</span><span class="op" id="7256940">]</span>&nbsp;<span class="op" id="7256942">+</span>&nbsp;<span class="string" id="7256944">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="7256959">+</span>&nbsp;<span class="ident" id="7256961">stack</span><span class="op" id="7256966">(</span><span class="op" id="7256967">)</span><span class="op" id="7256968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7256973">panic</span><span class="op" id="7256978">(</span><span class="string" id="7256979">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="7257001">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7257005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257009">freedFrom</span><span class="op" id="7257018">[</span><span class="ident" id="7257019">dbConn</span><span class="op" id="7257025">{</span><span class="ident" id="7257026">db</span><span class="op" id="7257028">,</span>&nbsp;<span class="ident" id="7257030">c</span><span class="op" id="7257031">}</span><span class="op" id="7257032">]</span>&nbsp;<span class="op" id="7257034">=</span>&nbsp;<span class="ident" id="7257036">stack</span><span class="op" id="7257041">(</span><span class="op" id="7257042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7257045">}</span><br>
<span class="lineno"></span><span class="op" id="7257047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="7257050">const</span>&nbsp;<span class="ident" id="7257056">fakeDBName</span>&nbsp;<span class="op" id="7257067">=</span>&nbsp;<span class="string" id="7257069">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7257076">var</span>&nbsp;<span class="ident" id="7257080">chrisBirthday</span>&nbsp;<span class="op" id="7257094">=</span>&nbsp;<span class="ident" id="7257096">time</span><span class="op" id="7257100">.</span><span class="ident" id="7257101">Unix</span><span class="op" id="7257105">(</span><span class="num" id="7257106">123456789</span><span class="op" id="7257115">,</span>&nbsp;<span class="num" id="7257117">0</span><span class="op" id="7257118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7257121">func</span>&nbsp;<span class="ident" id="7257126">newTestDB</span><span class="op" id="7257135">(</span><span class="ident" id="7257136">t</span>&nbsp;<span class="ident" id="7257138">testing</span><span class="op" id="7257145">.</span><span class="ident" id="7257146">TB</span><span class="op" id="7257148">,</span>&nbsp;<span class="ident" id="7257150">name</span>&nbsp;<span class="builtintype" id="7257155">string</span><span class="op" id="7257161">)</span>&nbsp;<span class="op" id="7257163">*</span><span class="ident" id="7257164">DB</span>&nbsp;<span class="op" id="7257167">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257170">db</span><span class="op" id="7257172">,</span>&nbsp;<span class="ident" id="7257174">err</span>&nbsp;<span class="op" id="7257178">:=</span>&nbsp;<span class="ident" id="7257181">Open</span><span class="op" id="7257185">(</span><span class="string" id="7257186">&#34;test&#34;</span><span class="op" id="7257192">,</span>&nbsp;<span class="ident" id="7257194">fakeDBName</span><span class="op" id="7257204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7257207">if</span>&nbsp;<span class="ident" id="7257210">err</span>&nbsp;<span class="op" id="7257214">!=</span>&nbsp;<span class="ident" id="7257217">nil</span>&nbsp;<span class="op" id="7257221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257225">t</span><span class="op" id="7257226">.</span><span class="ident" id="7257227">Fatalf</span><span class="op" id="7257233">(</span><span class="string" id="7257234">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7257244">,</span>&nbsp;<span class="ident" id="7257246">err</span><span class="op" id="7257249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7257252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7257255">if</span>&nbsp;<span class="ident" id="7257258">_</span><span class="op" id="7257259">,</span>&nbsp;<span class="ident" id="7257261">err</span>&nbsp;<span class="op" id="7257265">:=</span>&nbsp;<span class="ident" id="7257268">db</span><span class="op" id="7257270">.</span><span class="ident" id="7257271">Exec</span><span class="op" id="7257275">(</span><span class="string" id="7257276">&#34;WIPE&#34;</span><span class="op" id="7257282">)</span><span class="op" id="7257283">;</span>&nbsp;<span class="ident" id="7257285">err</span>&nbsp;<span class="op" id="7257289">!=</span>&nbsp;<span class="ident" id="7257292">nil</span>&nbsp;<span class="op" id="7257296">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257300">t</span><span class="op" id="7257301">.</span><span class="ident" id="7257302">Fatalf</span><span class="op" id="7257308">(</span><span class="string" id="7257309">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7257324">,</span>&nbsp;<span class="ident" id="7257326">err</span><span class="op" id="7257329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7257332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7257335">if</span>&nbsp;<span class="ident" id="7257338">name</span>&nbsp;<span class="op" id="7257343">==</span>&nbsp;<span class="string" id="7257346">&#34;people&#34;</span>&nbsp;<span class="op" id="7257355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257359">exec</span><span class="op" id="7257363">(</span><span class="ident" id="7257364">t</span><span class="op" id="7257365">,</span>&nbsp;<span class="ident" id="7257367">db</span><span class="op" id="7257369">,</span>&nbsp;<span class="string" id="7257371">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="7257444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257448">exec</span><span class="op" id="7257452">(</span><span class="ident" id="7257453">t</span><span class="op" id="7257454">,</span>&nbsp;<span class="ident" id="7257456">db</span><span class="op" id="7257458">,</span>&nbsp;<span class="string" id="7257460">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="7257505">,</span>&nbsp;<span class="num" id="7257507">1</span><span class="op" id="7257508">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257512">exec</span><span class="op" id="7257516">(</span><span class="ident" id="7257517">t</span><span class="op" id="7257518">,</span>&nbsp;<span class="ident" id="7257520">db</span><span class="op" id="7257522">,</span>&nbsp;<span class="string" id="7257524">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="7257567">,</span>&nbsp;<span class="num" id="7257569">2</span><span class="op" id="7257570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257574">exec</span><span class="op" id="7257578">(</span><span class="ident" id="7257579">t</span><span class="op" id="7257580">,</span>&nbsp;<span class="ident" id="7257582">db</span><span class="op" id="7257584">,</span>&nbsp;<span class="string" id="7257586">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7257639">,</span>&nbsp;<span class="num" id="7257641">3</span><span class="op" id="7257642">,</span>&nbsp;<span class="ident" id="7257644">chrisBirthday</span><span class="op" id="7257657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7257660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7257663">if</span>&nbsp;<span class="ident" id="7257666">name</span>&nbsp;<span class="op" id="7257671">==</span>&nbsp;<span class="string" id="7257674">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7257687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7257691">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257750">exec</span><span class="op" id="7257754">(</span><span class="ident" id="7257755">t</span><span class="op" id="7257756">,</span>&nbsp;<span class="ident" id="7257758">db</span><span class="op" id="7257760">,</span>&nbsp;<span class="string" id="7257762">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="7257804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257808">exec</span><span class="op" id="7257812">(</span><span class="ident" id="7257813">t</span><span class="op" id="7257814">,</span>&nbsp;<span class="ident" id="7257816">db</span><span class="op" id="7257818">,</span>&nbsp;<span class="string" id="7257820">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="7257858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7257861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7257864">return</span>&nbsp;<span class="ident" id="7257871">db</span><br>
<span class="lineno"></span><span class="op" id="7257874">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="7257877">func</span>&nbsp;<span class="ident" id="7257882">exec</span><span class="op" id="7257886">(</span><span class="ident" id="7257887">t</span>&nbsp;<span class="ident" id="7257889">testing</span><span class="op" id="7257896">.</span><span class="ident" id="7257897">TB</span><span class="op" id="7257899">,</span>&nbsp;<span class="ident" id="7257901">db</span>&nbsp;<span class="op" id="7257904">*</span><span class="ident" id="7257905">DB</span><span class="op" id="7257907">,</span>&nbsp;<span class="ident" id="7257909">query</span>&nbsp;<span class="builtintype" id="7257915">string</span><span class="op" id="7257921">,</span>&nbsp;<span class="ident" id="7257923">args</span>&nbsp;<span class="op" id="7257928">...</span><span class="keyword" id="7257931">interface</span><span class="op" id="7257940">{</span><span class="op" id="7257941">}</span><span class="op" id="7257942">)</span>&nbsp;<span class="op" id="7257944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7257947">_</span><span class="op" id="7257948">,</span>&nbsp;<span class="ident" id="7257950">err</span>&nbsp;<span class="op" id="7257954">:=</span>&nbsp;<span class="ident" id="7257957">db</span><span class="op" id="7257959">.</span><span class="ident" id="7257960">Exec</span><span class="op" id="7257964">(</span><span class="ident" id="7257965">query</span><span class="op" id="7257970">,</span>&nbsp;<span class="ident" id="7257972">args</span><span class="op" id="7257976">...</span><span class="op" id="7257979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7257982">if</span>&nbsp;<span class="ident" id="7257985">err</span>&nbsp;<span class="op" id="7257989">!=</span>&nbsp;<span class="ident" id="7257992">nil</span>&nbsp;<span class="op" id="7257996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258000">t</span><span class="op" id="7258001">.</span><span class="ident" id="7258002">Fatalf</span><span class="op" id="7258008">(</span><span class="string" id="7258009">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="7258025">,</span>&nbsp;<span class="ident" id="7258027">query</span><span class="op" id="7258032">,</span>&nbsp;<span class="ident" id="7258034">err</span><span class="op" id="7258037">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258040">}</span><br>
<span class="lineno"></span><span class="op" id="7258042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7258045">func</span>&nbsp;<span class="ident" id="7258050">closeDB</span><span class="op" id="7258057">(</span><span class="ident" id="7258058">t</span>&nbsp;<span class="ident" id="7258060">testing</span><span class="op" id="7258067">.</span><span class="ident" id="7258068">TB</span><span class="op" id="7258070">,</span>&nbsp;<span class="ident" id="7258072">db</span>&nbsp;<span class="op" id="7258075">*</span><span class="ident" id="7258076">DB</span><span class="op" id="7258078">)</span>&nbsp;<span class="op" id="7258080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258083">if</span>&nbsp;<span class="ident" id="7258086">e</span>&nbsp;<span class="op" id="7258088">:=</span>&nbsp;<span class="builtinfunc" id="7258091">recover</span><span class="op" id="7258098">(</span><span class="op" id="7258099">)</span><span class="op" id="7258100">;</span>&nbsp;<span class="ident" id="7258102">e</span>&nbsp;<span class="op" id="7258104">!=</span>&nbsp;<span class="ident" id="7258107">nil</span>&nbsp;<span class="op" id="7258111">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258115">fmt</span><span class="op" id="7258118">.</span><span class="ident" id="7258119">Printf</span><span class="op" id="7258125">(</span><span class="string" id="7258126">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="7258139">,</span>&nbsp;<span class="ident" id="7258141">e</span><span class="op" id="7258142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7258146">panic</span><span class="op" id="7258151">(</span><span class="ident" id="7258152">e</span><span class="op" id="7258153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258159">defer</span>&nbsp;<span class="ident" id="7258165">setHookpostCloseConn</span><span class="op" id="7258185">(</span><span class="ident" id="7258186">nil</span><span class="op" id="7258189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258192">setHookpostCloseConn</span><span class="op" id="7258212">(</span><span class="keyword" id="7258213">func</span><span class="op" id="7258217">(</span><span class="ident" id="7258218">_</span>&nbsp;<span class="op" id="7258220">*</span><span class="ident" id="7258221">fakeConn</span><span class="op" id="7258229">,</span>&nbsp;<span class="ident" id="7258231">err</span>&nbsp;<span class="builtintype" id="7258235">error</span><span class="op" id="7258240">)</span>&nbsp;<span class="op" id="7258242">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258246">if</span>&nbsp;<span class="ident" id="7258249">err</span>&nbsp;<span class="op" id="7258253">!=</span>&nbsp;<span class="ident" id="7258256">nil</span>&nbsp;<span class="op" id="7258260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258265">t</span><span class="op" id="7258266">.</span><span class="ident" id="7258267">Errorf</span><span class="op" id="7258273">(</span><span class="string" id="7258274">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7258302">,</span>&nbsp;<span class="ident" id="7258304">err</span><span class="op" id="7258307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258314">}</span><span class="op" id="7258315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258318">for</span>&nbsp;<span class="ident" id="7258322">i</span><span class="op" id="7258323">,</span>&nbsp;<span class="ident" id="7258325">dc</span>&nbsp;<span class="op" id="7258328">:=</span>&nbsp;<span class="keyword" id="7258331">range</span>&nbsp;<span class="ident" id="7258337">db</span><span class="op" id="7258339">.</span><span class="ident" id="7258340">freeConn</span>&nbsp;<span class="op" id="7258349">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258353">if</span>&nbsp;<span class="ident" id="7258356">n</span>&nbsp;<span class="op" id="7258358">:=</span>&nbsp;<span class="builtinfunc" id="7258361">len</span><span class="op" id="7258364">(</span><span class="ident" id="7258365">dc</span><span class="op" id="7258367">.</span><span class="ident" id="7258368">openStmt</span><span class="op" id="7258376">)</span><span class="op" id="7258377">;</span>&nbsp;<span class="ident" id="7258379">n</span>&nbsp;<span class="op" id="7258381">&gt;</span>&nbsp;<span class="num" id="7258383">0</span>&nbsp;<span class="op" id="7258385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7258390">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7258434">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7258483">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7258532">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7258579">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258608">t</span><span class="op" id="7258609">.</span><span class="ident" id="7258610">Errorf</span><span class="op" id="7258616">(</span><span class="string" id="7258617">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7258677">,</span>&nbsp;<span class="ident" id="7258679">i</span><span class="op" id="7258680">,</span>&nbsp;<span class="builtinfunc" id="7258682">len</span><span class="op" id="7258685">(</span><span class="ident" id="7258686">db</span><span class="op" id="7258688">.</span><span class="ident" id="7258689">freeConn</span><span class="op" id="7258697">)</span><span class="op" id="7258698">,</span>&nbsp;<span class="ident" id="7258700">n</span><span class="op" id="7258701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258711">err</span>&nbsp;<span class="op" id="7258715">:=</span>&nbsp;<span class="ident" id="7258718">db</span><span class="op" id="7258720">.</span><span class="ident" id="7258721">Close</span><span class="op" id="7258726">(</span><span class="op" id="7258727">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258730">if</span>&nbsp;<span class="ident" id="7258733">err</span>&nbsp;<span class="op" id="7258737">!=</span>&nbsp;<span class="ident" id="7258740">nil</span>&nbsp;<span class="op" id="7258744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258748">t</span><span class="op" id="7258749">.</span><span class="ident" id="7258750">Fatalf</span><span class="op" id="7258756">(</span><span class="string" id="7258757">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="7258779">,</span>&nbsp;<span class="ident" id="7258781">err</span><span class="op" id="7258784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258790">db</span><span class="op" id="7258792">.</span><span class="ident" id="7258793">mu</span><span class="op" id="7258795">.</span><span class="ident" id="7258796">Lock</span><span class="op" id="7258800">(</span><span class="op" id="7258801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258804">count</span>&nbsp;<span class="op" id="7258810">:=</span>&nbsp;<span class="ident" id="7258813">db</span><span class="op" id="7258815">.</span><span class="ident" id="7258816">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258825">db</span><span class="op" id="7258827">.</span><span class="ident" id="7258828">mu</span><span class="op" id="7258830">.</span><span class="ident" id="7258831">Unlock</span><span class="op" id="7258837">(</span><span class="op" id="7258838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7258841">if</span>&nbsp;<span class="ident" id="7258844">count</span>&nbsp;<span class="op" id="7258850">!=</span>&nbsp;<span class="num" id="7258853">0</span>&nbsp;<span class="op" id="7258855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7258859">t</span><span class="op" id="7258860">.</span><span class="ident" id="7258861">Fatalf</span><span class="op" id="7258867">(</span><span class="string" id="7258868">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="7258912">,</span>&nbsp;<span class="ident" id="7258914">db</span><span class="op" id="7258916">.</span><span class="ident" id="7258917">numOpen</span><span class="op" id="7258924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7258927">}</span><br>
<span class="lineno"></span><span class="op" id="7258929">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="7258932">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="7258999">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="7259032">func</span>&nbsp;<span class="ident" id="7259037">numPrepares</span><span class="op" id="7259048">(</span><span class="ident" id="7259049">t</span>&nbsp;<span class="op" id="7259051">*</span><span class="ident" id="7259052">testing</span><span class="op" id="7259059">.</span><span class="ident" id="7259060">T</span><span class="op" id="7259061">,</span>&nbsp;<span class="ident" id="7259063">db</span>&nbsp;<span class="op" id="7259066">*</span><span class="ident" id="7259067">DB</span><span class="op" id="7259069">)</span>&nbsp;<span class="builtintype" id="7259071">int</span>&nbsp;<span class="op" id="7259075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259078">if</span>&nbsp;<span class="ident" id="7259081">n</span>&nbsp;<span class="op" id="7259083">:=</span>&nbsp;<span class="builtinfunc" id="7259086">len</span><span class="op" id="7259089">(</span><span class="ident" id="7259090">db</span><span class="op" id="7259092">.</span><span class="ident" id="7259093">freeConn</span><span class="op" id="7259101">)</span><span class="op" id="7259102">;</span>&nbsp;<span class="ident" id="7259104">n</span>&nbsp;<span class="op" id="7259106">!=</span>&nbsp;<span class="num" id="7259109">1</span>&nbsp;<span class="op" id="7259111">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259115">t</span><span class="op" id="7259116">.</span><span class="ident" id="7259117">Fatalf</span><span class="op" id="7259123">(</span><span class="string" id="7259124">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7259149">,</span>&nbsp;<span class="ident" id="7259151">n</span><span class="op" id="7259152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7259155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259158">return</span>&nbsp;<span class="ident" id="7259165">db</span><span class="op" id="7259167">.</span><span class="ident" id="7259168">freeConn</span><span class="op" id="7259176">[</span><span class="num" id="7259177">0</span><span class="op" id="7259178">]</span><span class="op" id="7259179">.</span><span class="ident" id="7259180">ci</span><span class="op" id="7259182">.</span><span class="op" id="7259183">(</span><span class="op" id="7259184">*</span><span class="ident" id="7259185">fakeConn</span><span class="op" id="7259193">)</span><span class="op" id="7259194">.</span><span class="ident" id="7259195">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="7259206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="7259209">func</span>&nbsp;<span class="op" id="7259214">(</span><span class="ident" id="7259215">db</span>&nbsp;<span class="op" id="7259218">*</span><span class="ident" id="7259219">DB</span><span class="op" id="7259221">)</span>&nbsp;<span class="ident" id="7259223">numDeps</span><span class="op" id="7259230">(</span><span class="op" id="7259231">)</span>&nbsp;<span class="builtintype" id="7259233">int</span>&nbsp;<span class="op" id="7259237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259240">db</span><span class="op" id="7259242">.</span><span class="ident" id="7259243">mu</span><span class="op" id="7259245">.</span><span class="ident" id="7259246">Lock</span><span class="op" id="7259250">(</span><span class="op" id="7259251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259254">defer</span>&nbsp;<span class="ident" id="7259260">db</span><span class="op" id="7259262">.</span><span class="ident" id="7259263">mu</span><span class="op" id="7259265">.</span><span class="ident" id="7259266">Unlock</span><span class="op" id="7259272">(</span><span class="op" id="7259273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259276">return</span>&nbsp;<span class="builtinfunc" id="7259283">len</span><span class="op" id="7259286">(</span><span class="ident" id="7259287">db</span><span class="op" id="7259289">.</span><span class="ident" id="7259290">dep</span><span class="op" id="7259293">)</span><br>
<span class="lineno"></span><span class="op" id="7259295">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="7259298">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7259368">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="7259413">func</span>&nbsp;<span class="op" id="7259418">(</span><span class="ident" id="7259419">db</span>&nbsp;<span class="op" id="7259422">*</span><span class="ident" id="7259423">DB</span><span class="op" id="7259425">)</span>&nbsp;<span class="ident" id="7259427">numDepsPollUntil</span><span class="op" id="7259443">(</span><span class="ident" id="7259444">want</span>&nbsp;<span class="builtintype" id="7259449">int</span><span class="op" id="7259452">,</span>&nbsp;<span class="ident" id="7259454">d</span>&nbsp;<span class="ident" id="7259456">time</span><span class="op" id="7259460">.</span><span class="ident" id="7259461">Duration</span><span class="op" id="7259469">)</span>&nbsp;<span class="builtintype" id="7259471">int</span>&nbsp;<span class="op" id="7259475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259478">deadline</span>&nbsp;<span class="op" id="7259487">:=</span>&nbsp;<span class="ident" id="7259490">time</span><span class="op" id="7259494">.</span><span class="ident" id="7259495">Now</span><span class="op" id="7259498">(</span><span class="op" id="7259499">)</span><span class="op" id="7259500">.</span><span class="ident" id="7259501">Add</span><span class="op" id="7259504">(</span><span class="ident" id="7259505">d</span><span class="op" id="7259506">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259509">for</span>&nbsp;<span class="op" id="7259513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259517">n</span>&nbsp;<span class="op" id="7259519">:=</span>&nbsp;<span class="ident" id="7259522">db</span><span class="op" id="7259524">.</span><span class="ident" id="7259525">numDeps</span><span class="op" id="7259532">(</span><span class="op" id="7259533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259537">if</span>&nbsp;<span class="ident" id="7259540">n</span>&nbsp;<span class="op" id="7259542">&lt;=</span>&nbsp;<span class="ident" id="7259545">want</span>&nbsp;<span class="op" id="7259550">||</span>&nbsp;<span class="ident" id="7259553">time</span><span class="op" id="7259557">.</span><span class="ident" id="7259558">Now</span><span class="op" id="7259561">(</span><span class="op" id="7259562">)</span><span class="op" id="7259563">.</span><span class="ident" id="7259564">After</span><span class="op" id="7259569">(</span><span class="ident" id="7259570">deadline</span><span class="op" id="7259578">)</span>&nbsp;<span class="op" id="7259580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259585">return</span>&nbsp;<span class="ident" id="7259592">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7259596">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259600">time</span><span class="op" id="7259604">.</span><span class="ident" id="7259605">Sleep</span><span class="op" id="7259610">(</span><span class="num" id="7259611">50</span>&nbsp;<span class="op" id="7259614">*</span>&nbsp;<span class="ident" id="7259616">time</span><span class="op" id="7259620">.</span><span class="ident" id="7259621">Millisecond</span><span class="op" id="7259632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7259635">}</span><br>
<span class="lineno"></span><span class="op" id="7259637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7259640">func</span>&nbsp;<span class="op" id="7259645">(</span><span class="ident" id="7259646">db</span>&nbsp;<span class="op" id="7259649">*</span><span class="ident" id="7259650">DB</span><span class="op" id="7259652">)</span>&nbsp;<span class="ident" id="7259654">numFreeConns</span><span class="op" id="7259666">(</span><span class="op" id="7259667">)</span>&nbsp;<span class="builtintype" id="7259669">int</span>&nbsp;<span class="op" id="7259673">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259676">db</span><span class="op" id="7259678">.</span><span class="ident" id="7259679">mu</span><span class="op" id="7259681">.</span><span class="ident" id="7259682">Lock</span><span class="op" id="7259686">(</span><span class="op" id="7259687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259690">defer</span>&nbsp;<span class="ident" id="7259696">db</span><span class="op" id="7259698">.</span><span class="ident" id="7259699">mu</span><span class="op" id="7259701">.</span><span class="ident" id="7259702">Unlock</span><span class="op" id="7259708">(</span><span class="op" id="7259709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259712">return</span>&nbsp;<span class="builtinfunc" id="7259719">len</span><span class="op" id="7259722">(</span><span class="ident" id="7259723">db</span><span class="op" id="7259725">.</span><span class="ident" id="7259726">freeConn</span><span class="op" id="7259734">)</span><br>
<span class="lineno"></span><span class="op" id="7259736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="7259739">func</span>&nbsp;<span class="op" id="7259744">(</span><span class="ident" id="7259745">db</span>&nbsp;<span class="op" id="7259748">*</span><span class="ident" id="7259749">DB</span><span class="op" id="7259751">)</span>&nbsp;<span class="ident" id="7259753">dumpDeps</span><span class="op" id="7259761">(</span><span class="ident" id="7259762">t</span>&nbsp;<span class="op" id="7259764">*</span><span class="ident" id="7259765">testing</span><span class="op" id="7259772">.</span><span class="ident" id="7259773">T</span><span class="op" id="7259774">)</span>&nbsp;<span class="op" id="7259776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7259779">for</span>&nbsp;<span class="ident" id="7259783">fc</span>&nbsp;<span class="op" id="7259786">:=</span>&nbsp;<span class="keyword" id="7259789">range</span>&nbsp;<span class="ident" id="7259795">db</span><span class="op" id="7259797">.</span><span class="ident" id="7259798">dep</span>&nbsp;<span class="op" id="7259802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259806">db</span><span class="op" id="7259808">.</span><span class="ident" id="7259809">dumpDep</span><span class="op" id="7259816">(</span><span class="ident" id="7259817">t</span><span class="op" id="7259818">,</span>&nbsp;<span class="num" id="7259820">0</span><span class="op" id="7259821">,</span>&nbsp;<span class="ident" id="7259823">fc</span><span class="op" id="7259825">,</span>&nbsp;<span class="keyword" id="7259827">map</span><span class="op" id="7259830">[</span><span class="ident" id="7259831">finalCloser</span><span class="op" id="7259842">]</span><span class="builtintype" id="7259843">bool</span><span class="op" id="7259847">{</span><span class="op" id="7259848">}</span><span class="op" id="7259849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7259852">}</span><br>
<span class="lineno"></span><span class="op" id="7259854">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="7259857">func</span>&nbsp;<span class="op" id="7259862">(</span><span class="ident" id="7259863">db</span>&nbsp;<span class="op" id="7259866">*</span><span class="ident" id="7259867">DB</span><span class="op" id="7259869">)</span>&nbsp;<span class="ident" id="7259871">dumpDep</span><span class="op" id="7259878">(</span><span class="ident" id="7259879">t</span>&nbsp;<span class="op" id="7259881">*</span><span class="ident" id="7259882">testing</span><span class="op" id="7259889">.</span><span class="ident" id="7259890">T</span><span class="op" id="7259891">,</span>&nbsp;<span class="ident" id="7259893">depth</span>&nbsp;<span class="builtintype" id="7259899">int</span><span class="op" id="7259902">,</span>&nbsp;<span class="ident" id="7259904">dep</span>&nbsp;<span class="ident" id="7259908">finalCloser</span><span class="op" id="7259919">,</span>&nbsp;<span class="ident" id="7259921">seen</span>&nbsp;<span class="keyword" id="7259926">map</span><span class="op" id="7259929">[</span><span class="ident" id="7259930">finalCloser</span><span class="op" id="7259941">]</span><span class="builtintype" id="7259942">bool</span><span class="op" id="7259946">)</span>&nbsp;<span class="op" id="7259948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259951">seen</span><span class="op" id="7259955">[</span><span class="ident" id="7259956">dep</span><span class="op" id="7259959">]</span>&nbsp;<span class="op" id="7259961">=</span>&nbsp;<span class="builtintype" id="7259963">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7259969">indent</span>&nbsp;<span class="op" id="7259976">:=</span>&nbsp;<span class="ident" id="7259979">strings</span><span class="op" id="7259986">.</span><span class="ident" id="7259987">Repeat</span><span class="op" id="7259993">(</span><span class="string" id="7259994">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="7259998">,</span>&nbsp;<span class="ident" id="7260000">depth</span><span class="op" id="7260005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260008">ds</span>&nbsp;<span class="op" id="7260011">:=</span>&nbsp;<span class="ident" id="7260014">db</span><span class="op" id="7260016">.</span><span class="ident" id="7260017">dep</span><span class="op" id="7260020">[</span><span class="ident" id="7260021">dep</span><span class="op" id="7260024">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260027">for</span>&nbsp;<span class="ident" id="7260031">k</span>&nbsp;<span class="op" id="7260033">:=</span>&nbsp;<span class="keyword" id="7260036">range</span>&nbsp;<span class="ident" id="7260042">ds</span>&nbsp;<span class="op" id="7260045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260049">t</span><span class="op" id="7260050">.</span><span class="ident" id="7260051">Logf</span><span class="op" id="7260055">(</span><span class="string" id="7260056">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="7260090">,</span>&nbsp;<span class="ident" id="7260092">indent</span><span class="op" id="7260098">,</span>&nbsp;<span class="ident" id="7260100">dep</span><span class="op" id="7260103">,</span>&nbsp;<span class="ident" id="7260105">dep</span><span class="op" id="7260108">,</span>&nbsp;<span class="ident" id="7260110">k</span><span class="op" id="7260111">,</span>&nbsp;<span class="ident" id="7260113">k</span><span class="op" id="7260114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260118">if</span>&nbsp;<span class="ident" id="7260121">fc</span><span class="op" id="7260123">,</span>&nbsp;<span class="ident" id="7260125">ok</span>&nbsp;<span class="op" id="7260128">:=</span>&nbsp;<span class="ident" id="7260131">k</span><span class="op" id="7260132">.</span><span class="op" id="7260133">(</span><span class="ident" id="7260134">finalCloser</span><span class="op" id="7260145">)</span><span class="op" id="7260146">;</span>&nbsp;<span class="ident" id="7260148">ok</span>&nbsp;<span class="op" id="7260151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260156">if</span>&nbsp;<span class="op" id="7260159">!</span><span class="ident" id="7260160">seen</span><span class="op" id="7260164">[</span><span class="ident" id="7260165">fc</span><span class="op" id="7260167">]</span>&nbsp;<span class="op" id="7260169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260175">db</span><span class="op" id="7260177">.</span><span class="ident" id="7260178">dumpDep</span><span class="op" id="7260185">(</span><span class="ident" id="7260186">t</span><span class="op" id="7260187">,</span>&nbsp;<span class="ident" id="7260189">depth</span><span class="op" id="7260194">+</span><span class="num" id="7260195">1</span><span class="op" id="7260196">,</span>&nbsp;<span class="ident" id="7260198">fc</span><span class="op" id="7260200">,</span>&nbsp;<span class="ident" id="7260202">seen</span><span class="op" id="7260206">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260218">}</span><br>
<span class="lineno"></span><span class="op" id="7260220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7260223">func</span>&nbsp;<span class="ident" id="7260228">TestQuery</span><span class="op" id="7260237">(</span><span class="ident" id="7260238">t</span>&nbsp;<span class="op" id="7260240">*</span><span class="ident" id="7260241">testing</span><span class="op" id="7260248">.</span><span class="ident" id="7260249">T</span><span class="op" id="7260250">)</span>&nbsp;<span class="op" id="7260252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260255">db</span>&nbsp;<span class="op" id="7260258">:=</span>&nbsp;<span class="ident" id="7260261">newTestDB</span><span class="op" id="7260270">(</span><span class="ident" id="7260271">t</span><span class="op" id="7260272">,</span>&nbsp;<span class="string" id="7260274">&#34;people&#34;</span><span class="op" id="7260282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260285">defer</span>&nbsp;<span class="ident" id="7260291">closeDB</span><span class="op" id="7260298">(</span><span class="ident" id="7260299">t</span><span class="op" id="7260300">,</span>&nbsp;<span class="ident" id="7260302">db</span><span class="op" id="7260304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260307">prepares0</span>&nbsp;<span class="op" id="7260317">:=</span>&nbsp;<span class="ident" id="7260320">numPrepares</span><span class="op" id="7260331">(</span><span class="ident" id="7260332">t</span><span class="op" id="7260333">,</span>&nbsp;<span class="ident" id="7260335">db</span><span class="op" id="7260337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260340">rows</span><span class="op" id="7260344">,</span>&nbsp;<span class="ident" id="7260346">err</span>&nbsp;<span class="op" id="7260350">:=</span>&nbsp;<span class="ident" id="7260353">db</span><span class="op" id="7260355">.</span><span class="ident" id="7260356">Query</span><span class="op" id="7260361">(</span><span class="string" id="7260362">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7260387">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260390">if</span>&nbsp;<span class="ident" id="7260393">err</span>&nbsp;<span class="op" id="7260397">!=</span>&nbsp;<span class="ident" id="7260400">nil</span>&nbsp;<span class="op" id="7260404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260408">t</span><span class="op" id="7260409">.</span><span class="ident" id="7260410">Fatalf</span><span class="op" id="7260416">(</span><span class="string" id="7260417">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7260428">,</span>&nbsp;<span class="ident" id="7260430">err</span><span class="op" id="7260433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260439">type</span>&nbsp;<span class="ident" id="7260444">row</span>&nbsp;<span class="keyword" id="7260448">struct</span>&nbsp;<span class="op" id="7260455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260459">age</span>&nbsp;&nbsp;<span class="builtintype" id="7260464">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260470">name</span>&nbsp;<span class="builtintype" id="7260475">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260486">got</span>&nbsp;<span class="op" id="7260490">:=</span>&nbsp;<span class="op" id="7260493">[</span><span class="op" id="7260494">]</span><span class="ident" id="7260495">row</span><span class="op" id="7260498">{</span><span class="op" id="7260499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260502">for</span>&nbsp;<span class="ident" id="7260506">rows</span><span class="op" id="7260510">.</span><span class="ident" id="7260511">Next</span><span class="op" id="7260515">(</span><span class="op" id="7260516">)</span>&nbsp;<span class="op" id="7260518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260522">var</span>&nbsp;<span class="ident" id="7260526">r</span>&nbsp;<span class="ident" id="7260528">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260534">err</span>&nbsp;<span class="op" id="7260538">=</span>&nbsp;<span class="ident" id="7260540">rows</span><span class="op" id="7260544">.</span><span class="ident" id="7260545">Scan</span><span class="op" id="7260549">(</span><span class="op" id="7260550">&amp;</span><span class="ident" id="7260551">r</span><span class="op" id="7260552">.</span><span class="ident" id="7260553">age</span><span class="op" id="7260556">,</span>&nbsp;<span class="op" id="7260558">&amp;</span><span class="ident" id="7260559">r</span><span class="op" id="7260560">.</span><span class="ident" id="7260561">name</span><span class="op" id="7260565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260569">if</span>&nbsp;<span class="ident" id="7260572">err</span>&nbsp;<span class="op" id="7260576">!=</span>&nbsp;<span class="ident" id="7260579">nil</span>&nbsp;<span class="op" id="7260583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260588">t</span><span class="op" id="7260589">.</span><span class="ident" id="7260590">Fatalf</span><span class="op" id="7260596">(</span><span class="string" id="7260597">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7260607">,</span>&nbsp;<span class="ident" id="7260609">err</span><span class="op" id="7260612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260620">got</span>&nbsp;<span class="op" id="7260624">=</span>&nbsp;<span class="builtinfunc" id="7260626">append</span><span class="op" id="7260632">(</span><span class="ident" id="7260633">got</span><span class="op" id="7260636">,</span>&nbsp;<span class="ident" id="7260638">r</span><span class="op" id="7260639">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260645">err</span>&nbsp;<span class="op" id="7260649">=</span>&nbsp;<span class="ident" id="7260651">rows</span><span class="op" id="7260655">.</span><span class="ident" id="7260656">Err</span><span class="op" id="7260659">(</span><span class="op" id="7260660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260663">if</span>&nbsp;<span class="ident" id="7260666">err</span>&nbsp;<span class="op" id="7260670">!=</span>&nbsp;<span class="ident" id="7260673">nil</span>&nbsp;<span class="op" id="7260677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260681">t</span><span class="op" id="7260682">.</span><span class="ident" id="7260683">Fatalf</span><span class="op" id="7260689">(</span><span class="string" id="7260690">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="7260699">,</span>&nbsp;<span class="ident" id="7260701">err</span><span class="op" id="7260704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260707">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260710">want</span>&nbsp;<span class="op" id="7260715">:=</span>&nbsp;<span class="op" id="7260718">[</span><span class="op" id="7260719">]</span><span class="ident" id="7260720">row</span><span class="op" id="7260723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260727">{</span><span class="ident" id="7260728">age</span><span class="op" id="7260731">:</span>&nbsp;<span class="num" id="7260733">1</span><span class="op" id="7260734">,</span>&nbsp;<span class="ident" id="7260736">name</span><span class="op" id="7260740">:</span>&nbsp;<span class="string" id="7260742">&#34;Alice&#34;</span><span class="op" id="7260749">}</span><span class="op" id="7260750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260754">{</span><span class="ident" id="7260755">age</span><span class="op" id="7260758">:</span>&nbsp;<span class="num" id="7260760">2</span><span class="op" id="7260761">,</span>&nbsp;<span class="ident" id="7260763">name</span><span class="op" id="7260767">:</span>&nbsp;<span class="string" id="7260769">&#34;Bob&#34;</span><span class="op" id="7260774">}</span><span class="op" id="7260775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260779">{</span><span class="ident" id="7260780">age</span><span class="op" id="7260783">:</span>&nbsp;<span class="num" id="7260785">3</span><span class="op" id="7260786">,</span>&nbsp;<span class="ident" id="7260788">name</span><span class="op" id="7260792">:</span>&nbsp;<span class="string" id="7260794">&#34;Chris&#34;</span><span class="op" id="7260801">}</span><span class="op" id="7260802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260805">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7260808">if</span>&nbsp;<span class="op" id="7260811">!</span><span class="ident" id="7260812">reflect</span><span class="op" id="7260819">.</span><span class="ident" id="7260820">DeepEqual</span><span class="op" id="7260829">(</span><span class="ident" id="7260830">got</span><span class="op" id="7260833">,</span>&nbsp;<span class="ident" id="7260835">want</span><span class="op" id="7260839">)</span>&nbsp;<span class="op" id="7260841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7260845">t</span><span class="op" id="7260846">.</span><span class="ident" id="7260847">Errorf</span><span class="op" id="7260853">(</span><span class="string" id="7260854">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7260887">,</span>&nbsp;<span class="ident" id="7260889">got</span><span class="op" id="7260892">,</span>&nbsp;<span class="ident" id="7260894">want</span><span class="op" id="7260898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7260901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7260905">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7260968">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261005">if</span>&nbsp;<span class="ident" id="7261008">n</span>&nbsp;<span class="op" id="7261010">:=</span>&nbsp;<span class="ident" id="7261013">db</span><span class="op" id="7261015">.</span><span class="ident" id="7261016">numFreeConns</span><span class="op" id="7261028">(</span><span class="op" id="7261029">)</span><span class="op" id="7261030">;</span>&nbsp;<span class="ident" id="7261032">n</span>&nbsp;<span class="op" id="7261034">!=</span>&nbsp;<span class="num" id="7261037">1</span>&nbsp;<span class="op" id="7261039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261043">t</span><span class="op" id="7261044">.</span><span class="ident" id="7261045">Fatalf</span><span class="op" id="7261051">(</span><span class="string" id="7261052">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7261101">,</span>&nbsp;<span class="ident" id="7261103">n</span><span class="op" id="7261104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261110">if</span>&nbsp;<span class="ident" id="7261113">prepares</span>&nbsp;<span class="op" id="7261122">:=</span>&nbsp;<span class="ident" id="7261125">numPrepares</span><span class="op" id="7261136">(</span><span class="ident" id="7261137">t</span><span class="op" id="7261138">,</span>&nbsp;<span class="ident" id="7261140">db</span><span class="op" id="7261142">)</span>&nbsp;<span class="op" id="7261144">-</span>&nbsp;<span class="ident" id="7261146">prepares0</span><span class="op" id="7261155">;</span>&nbsp;<span class="ident" id="7261157">prepares</span>&nbsp;<span class="op" id="7261166">!=</span>&nbsp;<span class="num" id="7261169">1</span>&nbsp;<span class="op" id="7261171">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261175">t</span><span class="op" id="7261176">.</span><span class="ident" id="7261177">Errorf</span><span class="op" id="7261183">(</span><span class="string" id="7261184">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7261224">,</span>&nbsp;<span class="ident" id="7261226">prepares</span><span class="op" id="7261234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261237">}</span><br>
<span class="lineno"></span><span class="op" id="7261239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7261242">func</span>&nbsp;<span class="ident" id="7261247">TestByteOwnership</span><span class="op" id="7261264">(</span><span class="ident" id="7261265">t</span>&nbsp;<span class="op" id="7261267">*</span><span class="ident" id="7261268">testing</span><span class="op" id="7261275">.</span><span class="ident" id="7261276">T</span><span class="op" id="7261277">)</span>&nbsp;<span class="op" id="7261279">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261282">db</span>&nbsp;<span class="op" id="7261285">:=</span>&nbsp;<span class="ident" id="7261288">newTestDB</span><span class="op" id="7261297">(</span><span class="ident" id="7261298">t</span><span class="op" id="7261299">,</span>&nbsp;<span class="string" id="7261301">&#34;people&#34;</span><span class="op" id="7261309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261312">defer</span>&nbsp;<span class="ident" id="7261318">closeDB</span><span class="op" id="7261325">(</span><span class="ident" id="7261326">t</span><span class="op" id="7261327">,</span>&nbsp;<span class="ident" id="7261329">db</span><span class="op" id="7261331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261334">rows</span><span class="op" id="7261338">,</span>&nbsp;<span class="ident" id="7261340">err</span>&nbsp;<span class="op" id="7261344">:=</span>&nbsp;<span class="ident" id="7261347">db</span><span class="op" id="7261349">.</span><span class="ident" id="7261350">Query</span><span class="op" id="7261355">(</span><span class="string" id="7261356">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="7261383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261386">if</span>&nbsp;<span class="ident" id="7261389">err</span>&nbsp;<span class="op" id="7261393">!=</span>&nbsp;<span class="ident" id="7261396">nil</span>&nbsp;<span class="op" id="7261400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261404">t</span><span class="op" id="7261405">.</span><span class="ident" id="7261406">Fatalf</span><span class="op" id="7261412">(</span><span class="string" id="7261413">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7261424">,</span>&nbsp;<span class="ident" id="7261426">err</span><span class="op" id="7261429">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261435">type</span>&nbsp;<span class="ident" id="7261440">row</span>&nbsp;<span class="keyword" id="7261444">struct</span>&nbsp;<span class="op" id="7261451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261455">name</span>&nbsp;&nbsp;<span class="op" id="7261461">[</span><span class="op" id="7261462">]</span><span class="builtintype" id="7261463">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261470">photo</span>&nbsp;<span class="ident" id="7261476">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261486">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261489">got</span>&nbsp;<span class="op" id="7261493">:=</span>&nbsp;<span class="op" id="7261496">[</span><span class="op" id="7261497">]</span><span class="ident" id="7261498">row</span><span class="op" id="7261501">{</span><span class="op" id="7261502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261505">for</span>&nbsp;<span class="ident" id="7261509">rows</span><span class="op" id="7261513">.</span><span class="ident" id="7261514">Next</span><span class="op" id="7261518">(</span><span class="op" id="7261519">)</span>&nbsp;<span class="op" id="7261521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261525">var</span>&nbsp;<span class="ident" id="7261529">r</span>&nbsp;<span class="ident" id="7261531">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261537">err</span>&nbsp;<span class="op" id="7261541">=</span>&nbsp;<span class="ident" id="7261543">rows</span><span class="op" id="7261547">.</span><span class="ident" id="7261548">Scan</span><span class="op" id="7261552">(</span><span class="op" id="7261553">&amp;</span><span class="ident" id="7261554">r</span><span class="op" id="7261555">.</span><span class="ident" id="7261556">name</span><span class="op" id="7261560">,</span>&nbsp;<span class="op" id="7261562">&amp;</span><span class="ident" id="7261563">r</span><span class="op" id="7261564">.</span><span class="ident" id="7261565">photo</span><span class="op" id="7261570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261574">if</span>&nbsp;<span class="ident" id="7261577">err</span>&nbsp;<span class="op" id="7261581">!=</span>&nbsp;<span class="ident" id="7261584">nil</span>&nbsp;<span class="op" id="7261588">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261593">t</span><span class="op" id="7261594">.</span><span class="ident" id="7261595">Fatalf</span><span class="op" id="7261601">(</span><span class="string" id="7261602">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7261612">,</span>&nbsp;<span class="ident" id="7261614">err</span><span class="op" id="7261617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261625">got</span>&nbsp;<span class="op" id="7261629">=</span>&nbsp;<span class="builtinfunc" id="7261631">append</span><span class="op" id="7261637">(</span><span class="ident" id="7261638">got</span><span class="op" id="7261641">,</span>&nbsp;<span class="ident" id="7261643">r</span><span class="op" id="7261644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261650">corruptMemory</span>&nbsp;<span class="op" id="7261664">:=</span>&nbsp;<span class="op" id="7261667">[</span><span class="op" id="7261668">]</span><span class="builtintype" id="7261669">byte</span><span class="op" id="7261673">(</span><span class="string" id="7261674">&#34;\xffPHOTO&#34;</span><span class="op" id="7261685">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261688">want</span>&nbsp;<span class="op" id="7261693">:=</span>&nbsp;<span class="op" id="7261696">[</span><span class="op" id="7261697">]</span><span class="ident" id="7261698">row</span><span class="op" id="7261701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261705">{</span><span class="ident" id="7261706">name</span><span class="op" id="7261710">:</span>&nbsp;<span class="op" id="7261712">[</span><span class="op" id="7261713">]</span><span class="builtintype" id="7261714">byte</span><span class="op" id="7261718">(</span><span class="string" id="7261719">&#34;Alice&#34;</span><span class="op" id="7261726">)</span><span class="op" id="7261727">,</span>&nbsp;<span class="ident" id="7261729">photo</span><span class="op" id="7261734">:</span>&nbsp;<span class="ident" id="7261736">corruptMemory</span><span class="op" id="7261749">}</span><span class="op" id="7261750">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261754">{</span><span class="ident" id="7261755">name</span><span class="op" id="7261759">:</span>&nbsp;<span class="op" id="7261761">[</span><span class="op" id="7261762">]</span><span class="builtintype" id="7261763">byte</span><span class="op" id="7261767">(</span><span class="string" id="7261768">&#34;Bob&#34;</span><span class="op" id="7261773">)</span><span class="op" id="7261774">,</span>&nbsp;<span class="ident" id="7261776">photo</span><span class="op" id="7261781">:</span>&nbsp;<span class="ident" id="7261783">corruptMemory</span><span class="op" id="7261796">}</span><span class="op" id="7261797">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261801">{</span><span class="ident" id="7261802">name</span><span class="op" id="7261806">:</span>&nbsp;<span class="op" id="7261808">[</span><span class="op" id="7261809">]</span><span class="builtintype" id="7261810">byte</span><span class="op" id="7261814">(</span><span class="string" id="7261815">&#34;Chris&#34;</span><span class="op" id="7261822">)</span><span class="op" id="7261823">,</span>&nbsp;<span class="ident" id="7261825">photo</span><span class="op" id="7261830">:</span>&nbsp;<span class="ident" id="7261832">corruptMemory</span><span class="op" id="7261845">}</span><span class="op" id="7261846">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261849">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261852">if</span>&nbsp;<span class="op" id="7261855">!</span><span class="ident" id="7261856">reflect</span><span class="op" id="7261863">.</span><span class="ident" id="7261864">DeepEqual</span><span class="op" id="7261873">(</span><span class="ident" id="7261874">got</span><span class="op" id="7261877">,</span>&nbsp;<span class="ident" id="7261879">want</span><span class="op" id="7261883">)</span>&nbsp;<span class="op" id="7261885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261889">t</span><span class="op" id="7261890">.</span><span class="ident" id="7261891">Errorf</span><span class="op" id="7261897">(</span><span class="string" id="7261898">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7261931">,</span>&nbsp;<span class="ident" id="7261933">got</span><span class="op" id="7261936">,</span>&nbsp;<span class="ident" id="7261938">want</span><span class="op" id="7261942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7261945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7261949">var</span>&nbsp;<span class="ident" id="7261953">photo</span>&nbsp;<span class="ident" id="7261959">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7261969">err</span>&nbsp;<span class="op" id="7261973">=</span>&nbsp;<span class="ident" id="7261975">db</span><span class="op" id="7261977">.</span><span class="ident" id="7261978">QueryRow</span><span class="op" id="7261986">(</span><span class="string" id="7261987">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7262015">,</span>&nbsp;<span class="string" id="7262017">&#34;Alice&#34;</span><span class="op" id="7262024">)</span><span class="op" id="7262025">.</span><span class="ident" id="7262026">Scan</span><span class="op" id="7262030">(</span><span class="op" id="7262031">&amp;</span><span class="ident" id="7262032">photo</span><span class="op" id="7262037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262040">if</span>&nbsp;<span class="ident" id="7262043">err</span>&nbsp;<span class="op" id="7262047">==</span>&nbsp;<span class="ident" id="7262050">nil</span>&nbsp;<span class="op" id="7262054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262058">t</span><span class="op" id="7262059">.</span><span class="ident" id="7262060">Error</span><span class="op" id="7262065">(</span><span class="string" id="7262066">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="7262115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7262118">}</span><br>
<span class="lineno"></span><span class="op" id="7262120">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="7262123">func</span>&nbsp;<span class="ident" id="7262128">TestRowsColumns</span><span class="op" id="7262143">(</span><span class="ident" id="7262144">t</span>&nbsp;<span class="op" id="7262146">*</span><span class="ident" id="7262147">testing</span><span class="op" id="7262154">.</span><span class="ident" id="7262155">T</span><span class="op" id="7262156">)</span>&nbsp;<span class="op" id="7262158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262161">db</span>&nbsp;<span class="op" id="7262164">:=</span>&nbsp;<span class="ident" id="7262167">newTestDB</span><span class="op" id="7262176">(</span><span class="ident" id="7262177">t</span><span class="op" id="7262178">,</span>&nbsp;<span class="string" id="7262180">&#34;people&#34;</span><span class="op" id="7262188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262191">defer</span>&nbsp;<span class="ident" id="7262197">closeDB</span><span class="op" id="7262204">(</span><span class="ident" id="7262205">t</span><span class="op" id="7262206">,</span>&nbsp;<span class="ident" id="7262208">db</span><span class="op" id="7262210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262213">rows</span><span class="op" id="7262217">,</span>&nbsp;<span class="ident" id="7262219">err</span>&nbsp;<span class="op" id="7262223">:=</span>&nbsp;<span class="ident" id="7262226">db</span><span class="op" id="7262228">.</span><span class="ident" id="7262229">Query</span><span class="op" id="7262234">(</span><span class="string" id="7262235">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7262260">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262263">if</span>&nbsp;<span class="ident" id="7262266">err</span>&nbsp;<span class="op" id="7262270">!=</span>&nbsp;<span class="ident" id="7262273">nil</span>&nbsp;<span class="op" id="7262277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262281">t</span><span class="op" id="7262282">.</span><span class="ident" id="7262283">Fatalf</span><span class="op" id="7262289">(</span><span class="string" id="7262290">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7262301">,</span>&nbsp;<span class="ident" id="7262303">err</span><span class="op" id="7262306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7262309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262312">cols</span><span class="op" id="7262316">,</span>&nbsp;<span class="ident" id="7262318">err</span>&nbsp;<span class="op" id="7262322">:=</span>&nbsp;<span class="ident" id="7262325">rows</span><span class="op" id="7262329">.</span><span class="ident" id="7262330">Columns</span><span class="op" id="7262337">(</span><span class="op" id="7262338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262341">if</span>&nbsp;<span class="ident" id="7262344">err</span>&nbsp;<span class="op" id="7262348">!=</span>&nbsp;<span class="ident" id="7262351">nil</span>&nbsp;<span class="op" id="7262355">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262359">t</span><span class="op" id="7262360">.</span><span class="ident" id="7262361">Fatalf</span><span class="op" id="7262367">(</span><span class="string" id="7262368">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="7262381">,</span>&nbsp;<span class="ident" id="7262383">err</span><span class="op" id="7262386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7262389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262392">want</span>&nbsp;<span class="op" id="7262397">:=</span>&nbsp;<span class="op" id="7262400">[</span><span class="op" id="7262401">]</span><span class="builtintype" id="7262402">string</span><span class="op" id="7262408">{</span><span class="string" id="7262409">&#34;age&#34;</span><span class="op" id="7262414">,</span>&nbsp;<span class="string" id="7262416">&#34;name&#34;</span><span class="op" id="7262422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262425">if</span>&nbsp;<span class="op" id="7262428">!</span><span class="ident" id="7262429">reflect</span><span class="op" id="7262436">.</span><span class="ident" id="7262437">DeepEqual</span><span class="op" id="7262446">(</span><span class="ident" id="7262447">cols</span><span class="op" id="7262451">,</span>&nbsp;<span class="ident" id="7262453">want</span><span class="op" id="7262457">)</span>&nbsp;<span class="op" id="7262459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262463">t</span><span class="op" id="7262464">.</span><span class="ident" id="7262465">Errorf</span><span class="op" id="7262471">(</span><span class="string" id="7262472">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7262491">,</span>&nbsp;<span class="ident" id="7262493">cols</span><span class="op" id="7262497">,</span>&nbsp;<span class="ident" id="7262499">want</span><span class="op" id="7262503">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7262506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262509">if</span>&nbsp;<span class="ident" id="7262512">err</span>&nbsp;<span class="op" id="7262516">:=</span>&nbsp;<span class="ident" id="7262519">rows</span><span class="op" id="7262523">.</span><span class="ident" id="7262524">Close</span><span class="op" id="7262529">(</span><span class="op" id="7262530">)</span><span class="op" id="7262531">;</span>&nbsp;<span class="ident" id="7262533">err</span>&nbsp;<span class="op" id="7262537">!=</span>&nbsp;<span class="ident" id="7262540">nil</span>&nbsp;<span class="op" id="7262544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262548">t</span><span class="op" id="7262549">.</span><span class="ident" id="7262550">Errorf</span><span class="op" id="7262556">(</span><span class="string" id="7262557">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="7262581">,</span>&nbsp;<span class="ident" id="7262583">err</span><span class="op" id="7262586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7262589">}</span><br>
<span class="lineno"></span><span class="op" id="7262591">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7262594">func</span>&nbsp;<span class="ident" id="7262599">TestQueryRow</span><span class="op" id="7262611">(</span><span class="ident" id="7262612">t</span>&nbsp;<span class="op" id="7262614">*</span><span class="ident" id="7262615">testing</span><span class="op" id="7262622">.</span><span class="ident" id="7262623">T</span><span class="op" id="7262624">)</span>&nbsp;<span class="op" id="7262626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262629">db</span>&nbsp;<span class="op" id="7262632">:=</span>&nbsp;<span class="ident" id="7262635">newTestDB</span><span class="op" id="7262644">(</span><span class="ident" id="7262645">t</span><span class="op" id="7262646">,</span>&nbsp;<span class="string" id="7262648">&#34;people&#34;</span><span class="op" id="7262656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262659">defer</span>&nbsp;<span class="ident" id="7262665">closeDB</span><span class="op" id="7262672">(</span><span class="ident" id="7262673">t</span><span class="op" id="7262674">,</span>&nbsp;<span class="ident" id="7262676">db</span><span class="op" id="7262678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262681">var</span>&nbsp;<span class="ident" id="7262685">name</span>&nbsp;<span class="builtintype" id="7262690">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262698">var</span>&nbsp;<span class="ident" id="7262702">age</span>&nbsp;<span class="builtintype" id="7262706">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262711">var</span>&nbsp;<span class="ident" id="7262715">birthday</span>&nbsp;<span class="ident" id="7262724">time</span><span class="op" id="7262728">.</span><span class="ident" id="7262729">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262736">err</span>&nbsp;<span class="op" id="7262740">:=</span>&nbsp;<span class="ident" id="7262743">db</span><span class="op" id="7262745">.</span><span class="ident" id="7262746">QueryRow</span><span class="op" id="7262754">(</span><span class="string" id="7262755">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7262785">,</span>&nbsp;<span class="num" id="7262787">3</span><span class="op" id="7262788">)</span><span class="op" id="7262789">.</span><span class="ident" id="7262790">Scan</span><span class="op" id="7262794">(</span><span class="op" id="7262795">&amp;</span><span class="ident" id="7262796">age</span><span class="op" id="7262799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7262802">if</span>&nbsp;<span class="ident" id="7262805">err</span>&nbsp;<span class="op" id="7262809">==</span>&nbsp;<span class="ident" id="7262812">nil</span>&nbsp;<span class="op" id="7262816">||</span>&nbsp;<span class="op" id="7262819">!</span><span class="ident" id="7262820">strings</span><span class="op" id="7262827">.</span><span class="ident" id="7262828">Contains</span><span class="op" id="7262836">(</span><span class="ident" id="7262837">err</span><span class="op" id="7262840">.</span><span class="ident" id="7262841">Error</span><span class="op" id="7262846">(</span><span class="op" id="7262847">)</span><span class="op" id="7262848">,</span>&nbsp;<span class="string" id="7262850">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="7262884">)</span>&nbsp;<span class="op" id="7262886">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262890">t</span><span class="op" id="7262891">.</span><span class="ident" id="7262892">Errorf</span><span class="op" id="7262898">(</span><span class="string" id="7262899">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="7262964">,</span>&nbsp;<span class="ident" id="7262966">err</span><span class="op" id="7262969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7262972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7262976">err</span>&nbsp;<span class="op" id="7262980">=</span>&nbsp;<span class="ident" id="7262982">db</span><span class="op" id="7262984">.</span><span class="ident" id="7262985">QueryRow</span><span class="op" id="7262993">(</span><span class="string" id="7262994">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="7263021">,</span>&nbsp;<span class="num" id="7263023">3</span><span class="op" id="7263024">)</span><span class="op" id="7263025">.</span><span class="ident" id="7263026">Scan</span><span class="op" id="7263030">(</span><span class="op" id="7263031">&amp;</span><span class="ident" id="7263032">birthday</span><span class="op" id="7263040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263043">if</span>&nbsp;<span class="ident" id="7263046">err</span>&nbsp;<span class="op" id="7263050">!=</span>&nbsp;<span class="ident" id="7263053">nil</span>&nbsp;<span class="op" id="7263057">||</span>&nbsp;<span class="op" id="7263060">!</span><span class="ident" id="7263061">birthday</span><span class="op" id="7263069">.</span><span class="ident" id="7263070">Equal</span><span class="op" id="7263075">(</span><span class="ident" id="7263076">chrisBirthday</span><span class="op" id="7263089">)</span>&nbsp;<span class="op" id="7263091">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263095">t</span><span class="op" id="7263096">.</span><span class="ident" id="7263097">Errorf</span><span class="op" id="7263103">(</span><span class="string" id="7263104">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7263144">,</span>&nbsp;<span class="ident" id="7263146">birthday</span><span class="op" id="7263154">,</span>&nbsp;<span class="ident" id="7263156">err</span><span class="op" id="7263159">,</span>&nbsp;<span class="ident" id="7263161">chrisBirthday</span><span class="op" id="7263174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263181">err</span>&nbsp;<span class="op" id="7263185">=</span>&nbsp;<span class="ident" id="7263187">db</span><span class="op" id="7263189">.</span><span class="ident" id="7263190">QueryRow</span><span class="op" id="7263198">(</span><span class="string" id="7263199">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7263229">,</span>&nbsp;<span class="num" id="7263231">2</span><span class="op" id="7263232">)</span><span class="op" id="7263233">.</span><span class="ident" id="7263234">Scan</span><span class="op" id="7263238">(</span><span class="op" id="7263239">&amp;</span><span class="ident" id="7263240">age</span><span class="op" id="7263243">,</span>&nbsp;<span class="op" id="7263245">&amp;</span><span class="ident" id="7263246">name</span><span class="op" id="7263250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263253">if</span>&nbsp;<span class="ident" id="7263256">err</span>&nbsp;<span class="op" id="7263260">!=</span>&nbsp;<span class="ident" id="7263263">nil</span>&nbsp;<span class="op" id="7263267">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263271">t</span><span class="op" id="7263272">.</span><span class="ident" id="7263273">Fatalf</span><span class="op" id="7263279">(</span><span class="string" id="7263280">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7263303">,</span>&nbsp;<span class="ident" id="7263305">err</span><span class="op" id="7263308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263314">if</span>&nbsp;<span class="ident" id="7263317">name</span>&nbsp;<span class="op" id="7263322">!=</span>&nbsp;<span class="string" id="7263325">&#34;Bob&#34;</span>&nbsp;<span class="op" id="7263331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263335">t</span><span class="op" id="7263336">.</span><span class="ident" id="7263337">Errorf</span><span class="op" id="7263343">(</span><span class="string" id="7263344">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7263371">,</span>&nbsp;<span class="ident" id="7263373">name</span><span class="op" id="7263377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263380">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263383">if</span>&nbsp;<span class="ident" id="7263386">age</span>&nbsp;<span class="op" id="7263390">!=</span>&nbsp;<span class="num" id="7263393">2</span>&nbsp;<span class="op" id="7263395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263399">t</span><span class="op" id="7263400">.</span><span class="ident" id="7263401">Errorf</span><span class="op" id="7263407">(</span><span class="string" id="7263408">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7263432">,</span>&nbsp;<span class="ident" id="7263434">age</span><span class="op" id="7263437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263444">err</span>&nbsp;<span class="op" id="7263448">=</span>&nbsp;<span class="ident" id="7263450">db</span><span class="op" id="7263452">.</span><span class="ident" id="7263453">QueryRow</span><span class="op" id="7263461">(</span><span class="string" id="7263462">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="7263493">,</span>&nbsp;<span class="string" id="7263495">&#34;Alice&#34;</span><span class="op" id="7263502">)</span><span class="op" id="7263503">.</span><span class="ident" id="7263504">Scan</span><span class="op" id="7263508">(</span><span class="op" id="7263509">&amp;</span><span class="ident" id="7263510">age</span><span class="op" id="7263513">,</span>&nbsp;<span class="op" id="7263515">&amp;</span><span class="ident" id="7263516">name</span><span class="op" id="7263520">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263523">if</span>&nbsp;<span class="ident" id="7263526">err</span>&nbsp;<span class="op" id="7263530">!=</span>&nbsp;<span class="ident" id="7263533">nil</span>&nbsp;<span class="op" id="7263537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263541">t</span><span class="op" id="7263542">.</span><span class="ident" id="7263543">Fatalf</span><span class="op" id="7263549">(</span><span class="string" id="7263550">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7263574">,</span>&nbsp;<span class="ident" id="7263576">err</span><span class="op" id="7263579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263585">if</span>&nbsp;<span class="ident" id="7263588">name</span>&nbsp;<span class="op" id="7263593">!=</span>&nbsp;<span class="string" id="7263596">&#34;Alice&#34;</span>&nbsp;<span class="op" id="7263604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263608">t</span><span class="op" id="7263609">.</span><span class="ident" id="7263610">Errorf</span><span class="op" id="7263616">(</span><span class="string" id="7263617">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7263646">,</span>&nbsp;<span class="ident" id="7263648">name</span><span class="op" id="7263652">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263658">if</span>&nbsp;<span class="ident" id="7263661">age</span>&nbsp;<span class="op" id="7263665">!=</span>&nbsp;<span class="num" id="7263668">1</span>&nbsp;<span class="op" id="7263670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263674">t</span><span class="op" id="7263675">.</span><span class="ident" id="7263676">Errorf</span><span class="op" id="7263682">(</span><span class="string" id="7263683">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7263707">,</span>&nbsp;<span class="ident" id="7263709">age</span><span class="op" id="7263712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263719">var</span>&nbsp;<span class="ident" id="7263723">photo</span>&nbsp;<span class="op" id="7263729">[</span><span class="op" id="7263730">]</span><span class="builtintype" id="7263731">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263737">err</span>&nbsp;<span class="op" id="7263741">=</span>&nbsp;<span class="ident" id="7263743">db</span><span class="op" id="7263745">.</span><span class="ident" id="7263746">QueryRow</span><span class="op" id="7263754">(</span><span class="string" id="7263755">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7263783">,</span>&nbsp;<span class="string" id="7263785">&#34;Alice&#34;</span><span class="op" id="7263792">)</span><span class="op" id="7263793">.</span><span class="ident" id="7263794">Scan</span><span class="op" id="7263798">(</span><span class="op" id="7263799">&amp;</span><span class="ident" id="7263800">photo</span><span class="op" id="7263805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263808">if</span>&nbsp;<span class="ident" id="7263811">err</span>&nbsp;<span class="op" id="7263815">!=</span>&nbsp;<span class="ident" id="7263818">nil</span>&nbsp;<span class="op" id="7263822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263826">t</span><span class="op" id="7263827">.</span><span class="ident" id="7263828">Fatalf</span><span class="op" id="7263834">(</span><span class="string" id="7263835">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7263860">,</span>&nbsp;<span class="ident" id="7263862">err</span><span class="op" id="7263865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263868">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263871">want</span>&nbsp;<span class="op" id="7263876">:=</span>&nbsp;<span class="op" id="7263879">[</span><span class="op" id="7263880">]</span><span class="builtintype" id="7263881">byte</span><span class="op" id="7263885">(</span><span class="string" id="7263886">&#34;APHOTO&#34;</span><span class="op" id="7263894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7263897">if</span>&nbsp;<span class="op" id="7263900">!</span><span class="ident" id="7263901">reflect</span><span class="op" id="7263908">.</span><span class="ident" id="7263909">DeepEqual</span><span class="op" id="7263918">(</span><span class="ident" id="7263919">photo</span><span class="op" id="7263924">,</span>&nbsp;<span class="ident" id="7263926">want</span><span class="op" id="7263930">)</span>&nbsp;<span class="op" id="7263932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7263936">t</span><span class="op" id="7263937">.</span><span class="ident" id="7263938">Errorf</span><span class="op" id="7263944">(</span><span class="string" id="7263945">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7263966">,</span>&nbsp;<span class="ident" id="7263968">photo</span><span class="op" id="7263973">,</span>&nbsp;<span class="ident" id="7263975">want</span><span class="op" id="7263979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7263982">}</span><br>
<span class="lineno"></span><span class="op" id="7263984">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7263987">func</span>&nbsp;<span class="ident" id="7263992">TestStatementErrorAfterClose</span><span class="op" id="7264020">(</span><span class="ident" id="7264021">t</span>&nbsp;<span class="op" id="7264023">*</span><span class="ident" id="7264024">testing</span><span class="op" id="7264031">.</span><span class="ident" id="7264032">T</span><span class="op" id="7264033">)</span>&nbsp;<span class="op" id="7264035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264038">db</span>&nbsp;<span class="op" id="7264041">:=</span>&nbsp;<span class="ident" id="7264044">newTestDB</span><span class="op" id="7264053">(</span><span class="ident" id="7264054">t</span><span class="op" id="7264055">,</span>&nbsp;<span class="string" id="7264057">&#34;people&#34;</span><span class="op" id="7264065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264068">defer</span>&nbsp;<span class="ident" id="7264074">closeDB</span><span class="op" id="7264081">(</span><span class="ident" id="7264082">t</span><span class="op" id="7264083">,</span>&nbsp;<span class="ident" id="7264085">db</span><span class="op" id="7264087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264090">stmt</span><span class="op" id="7264094">,</span>&nbsp;<span class="ident" id="7264096">err</span>&nbsp;<span class="op" id="7264100">:=</span>&nbsp;<span class="ident" id="7264103">db</span><span class="op" id="7264105">.</span><span class="ident" id="7264106">Prepare</span><span class="op" id="7264113">(</span><span class="string" id="7264114">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7264140">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264143">if</span>&nbsp;<span class="ident" id="7264146">err</span>&nbsp;<span class="op" id="7264150">!=</span>&nbsp;<span class="ident" id="7264153">nil</span>&nbsp;<span class="op" id="7264157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264161">t</span><span class="op" id="7264162">.</span><span class="ident" id="7264163">Fatalf</span><span class="op" id="7264169">(</span><span class="string" id="7264170">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7264183">,</span>&nbsp;<span class="ident" id="7264185">err</span><span class="op" id="7264188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264194">err</span>&nbsp;<span class="op" id="7264198">=</span>&nbsp;<span class="ident" id="7264200">stmt</span><span class="op" id="7264204">.</span><span class="ident" id="7264205">Close</span><span class="op" id="7264210">(</span><span class="op" id="7264211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264214">if</span>&nbsp;<span class="ident" id="7264217">err</span>&nbsp;<span class="op" id="7264221">!=</span>&nbsp;<span class="ident" id="7264224">nil</span>&nbsp;<span class="op" id="7264228">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264232">t</span><span class="op" id="7264233">.</span><span class="ident" id="7264234">Fatalf</span><span class="op" id="7264240">(</span><span class="string" id="7264241">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7264252">,</span>&nbsp;<span class="ident" id="7264254">err</span><span class="op" id="7264257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264263">var</span>&nbsp;<span class="ident" id="7264267">name</span>&nbsp;<span class="builtintype" id="7264272">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264280">err</span>&nbsp;<span class="op" id="7264284">=</span>&nbsp;<span class="ident" id="7264286">stmt</span><span class="op" id="7264290">.</span><span class="ident" id="7264291">QueryRow</span><span class="op" id="7264299">(</span><span class="string" id="7264300">&#34;foo&#34;</span><span class="op" id="7264305">)</span><span class="op" id="7264306">.</span><span class="ident" id="7264307">Scan</span><span class="op" id="7264311">(</span><span class="op" id="7264312">&amp;</span><span class="ident" id="7264313">name</span><span class="op" id="7264317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264320">if</span>&nbsp;<span class="ident" id="7264323">err</span>&nbsp;<span class="op" id="7264327">==</span>&nbsp;<span class="ident" id="7264330">nil</span>&nbsp;<span class="op" id="7264334">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264338">t</span><span class="op" id="7264339">.</span><span class="ident" id="7264340">Errorf</span><span class="op" id="7264346">(</span><span class="string" id="7264347">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="7264399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264402">}</span><br>
<span class="lineno"></span><span class="op" id="7264404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7264407">func</span>&nbsp;<span class="ident" id="7264412">TestStatementQueryRow</span><span class="op" id="7264433">(</span><span class="ident" id="7264434">t</span>&nbsp;<span class="op" id="7264436">*</span><span class="ident" id="7264437">testing</span><span class="op" id="7264444">.</span><span class="ident" id="7264445">T</span><span class="op" id="7264446">)</span>&nbsp;<span class="op" id="7264448">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264451">db</span>&nbsp;<span class="op" id="7264454">:=</span>&nbsp;<span class="ident" id="7264457">newTestDB</span><span class="op" id="7264466">(</span><span class="ident" id="7264467">t</span><span class="op" id="7264468">,</span>&nbsp;<span class="string" id="7264470">&#34;people&#34;</span><span class="op" id="7264478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264481">defer</span>&nbsp;<span class="ident" id="7264487">closeDB</span><span class="op" id="7264494">(</span><span class="ident" id="7264495">t</span><span class="op" id="7264496">,</span>&nbsp;<span class="ident" id="7264498">db</span><span class="op" id="7264500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264503">stmt</span><span class="op" id="7264507">,</span>&nbsp;<span class="ident" id="7264509">err</span>&nbsp;<span class="op" id="7264513">:=</span>&nbsp;<span class="ident" id="7264516">db</span><span class="op" id="7264518">.</span><span class="ident" id="7264519">Prepare</span><span class="op" id="7264526">(</span><span class="string" id="7264527">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7264553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264556">if</span>&nbsp;<span class="ident" id="7264559">err</span>&nbsp;<span class="op" id="7264563">!=</span>&nbsp;<span class="ident" id="7264566">nil</span>&nbsp;<span class="op" id="7264570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264574">t</span><span class="op" id="7264575">.</span><span class="ident" id="7264576">Fatalf</span><span class="op" id="7264582">(</span><span class="string" id="7264583">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7264596">,</span>&nbsp;<span class="ident" id="7264598">err</span><span class="op" id="7264601">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264607">defer</span>&nbsp;<span class="ident" id="7264613">stmt</span><span class="op" id="7264617">.</span><span class="ident" id="7264618">Close</span><span class="op" id="7264623">(</span><span class="op" id="7264624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264627">var</span>&nbsp;<span class="ident" id="7264631">age</span>&nbsp;<span class="builtintype" id="7264635">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264640">for</span>&nbsp;<span class="ident" id="7264644">n</span><span class="op" id="7264645">,</span>&nbsp;<span class="ident" id="7264647">tt</span>&nbsp;<span class="op" id="7264650">:=</span>&nbsp;<span class="keyword" id="7264653">range</span>&nbsp;<span class="op" id="7264659">[</span><span class="op" id="7264660">]</span><span class="keyword" id="7264661">struct</span>&nbsp;<span class="op" id="7264668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264672">name</span>&nbsp;<span class="builtintype" id="7264677">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264686">want</span>&nbsp;<span class="builtintype" id="7264691">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264696">}</span><span class="op" id="7264697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264701">{</span><span class="string" id="7264702">&#34;Alice&#34;</span><span class="op" id="7264709">,</span>&nbsp;<span class="num" id="7264711">1</span><span class="op" id="7264712">}</span><span class="op" id="7264713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264717">{</span><span class="string" id="7264718">&#34;Bob&#34;</span><span class="op" id="7264723">,</span>&nbsp;<span class="num" id="7264725">2</span><span class="op" id="7264726">}</span><span class="op" id="7264727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264731">{</span><span class="string" id="7264732">&#34;Chris&#34;</span><span class="op" id="7264739">,</span>&nbsp;<span class="num" id="7264741">3</span><span class="op" id="7264742">}</span><span class="op" id="7264743">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264746">}</span>&nbsp;<span class="op" id="7264748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7264752">if</span>&nbsp;<span class="ident" id="7264755">err</span>&nbsp;<span class="op" id="7264759">:=</span>&nbsp;<span class="ident" id="7264762">stmt</span><span class="op" id="7264766">.</span><span class="ident" id="7264767">QueryRow</span><span class="op" id="7264775">(</span><span class="ident" id="7264776">tt</span><span class="op" id="7264778">.</span><span class="ident" id="7264779">name</span><span class="op" id="7264783">)</span><span class="op" id="7264784">.</span><span class="ident" id="7264785">Scan</span><span class="op" id="7264789">(</span><span class="op" id="7264790">&amp;</span><span class="ident" id="7264791">age</span><span class="op" id="7264794">)</span><span class="op" id="7264795">;</span>&nbsp;<span class="ident" id="7264797">err</span>&nbsp;<span class="op" id="7264801">!=</span>&nbsp;<span class="ident" id="7264804">nil</span>&nbsp;<span class="op" id="7264808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264813">t</span><span class="op" id="7264814">.</span><span class="ident" id="7264815">Errorf</span><span class="op" id="7264821">(</span><span class="string" id="7264822">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="7264852">,</span>&nbsp;<span class="ident" id="7264854">n</span><span class="op" id="7264855">,</span>&nbsp;<span class="ident" id="7264857">tt</span><span class="op" id="7264859">.</span><span class="ident" id="7264860">name</span><span class="op" id="7264864">,</span>&nbsp;<span class="ident" id="7264866">err</span><span class="op" id="7264869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264873">}</span>&nbsp;<span class="keyword" id="7264875">else</span>&nbsp;<span class="keyword" id="7264880">if</span>&nbsp;<span class="ident" id="7264883">age</span>&nbsp;<span class="op" id="7264887">!=</span>&nbsp;<span class="ident" id="7264890">tt</span><span class="op" id="7264892">.</span><span class="ident" id="7264893">want</span>&nbsp;<span class="op" id="7264898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7264903">t</span><span class="op" id="7264904">.</span><span class="ident" id="7264905">Errorf</span><span class="op" id="7264911">(</span><span class="string" id="7264912">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7264933">,</span>&nbsp;<span class="ident" id="7264935">n</span><span class="op" id="7264936">,</span>&nbsp;<span class="ident" id="7264938">age</span><span class="op" id="7264941">,</span>&nbsp;<span class="ident" id="7264943">tt</span><span class="op" id="7264945">.</span><span class="ident" id="7264946">want</span><span class="op" id="7264950">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7264957">}</span><br>
<span class="lineno"></span><span class="op" id="7264959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7264962">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="7264987">func</span>&nbsp;<span class="ident" id="7264992">TestStatementQueryRowConcurrent</span><span class="op" id="7265023">(</span><span class="ident" id="7265024">t</span>&nbsp;<span class="op" id="7265026">*</span><span class="ident" id="7265027">testing</span><span class="op" id="7265034">.</span><span class="ident" id="7265035">T</span><span class="op" id="7265036">)</span>&nbsp;<span class="op" id="7265038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265041">db</span>&nbsp;<span class="op" id="7265044">:=</span>&nbsp;<span class="ident" id="7265047">newTestDB</span><span class="op" id="7265056">(</span><span class="ident" id="7265057">t</span><span class="op" id="7265058">,</span>&nbsp;<span class="string" id="7265060">&#34;people&#34;</span><span class="op" id="7265068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265071">defer</span>&nbsp;<span class="ident" id="7265077">closeDB</span><span class="op" id="7265084">(</span><span class="ident" id="7265085">t</span><span class="op" id="7265086">,</span>&nbsp;<span class="ident" id="7265088">db</span><span class="op" id="7265090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265093">stmt</span><span class="op" id="7265097">,</span>&nbsp;<span class="ident" id="7265099">err</span>&nbsp;<span class="op" id="7265103">:=</span>&nbsp;<span class="ident" id="7265106">db</span><span class="op" id="7265108">.</span><span class="ident" id="7265109">Prepare</span><span class="op" id="7265116">(</span><span class="string" id="7265117">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7265143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265146">if</span>&nbsp;<span class="ident" id="7265149">err</span>&nbsp;<span class="op" id="7265153">!=</span>&nbsp;<span class="ident" id="7265156">nil</span>&nbsp;<span class="op" id="7265160">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265164">t</span><span class="op" id="7265165">.</span><span class="ident" id="7265166">Fatalf</span><span class="op" id="7265172">(</span><span class="string" id="7265173">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7265186">,</span>&nbsp;<span class="ident" id="7265188">err</span><span class="op" id="7265191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265197">defer</span>&nbsp;<span class="ident" id="7265203">stmt</span><span class="op" id="7265207">.</span><span class="ident" id="7265208">Close</span><span class="op" id="7265213">(</span><span class="op" id="7265214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265218">const</span>&nbsp;<span class="ident" id="7265224">n</span>&nbsp;<span class="op" id="7265226">=</span>&nbsp;<span class="num" id="7265228">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265232">ch</span>&nbsp;<span class="op" id="7265235">:=</span>&nbsp;<span class="builtinfunc" id="7265238">make</span><span class="op" id="7265242">(</span><span class="keyword" id="7265243">chan</span>&nbsp;<span class="builtintype" id="7265248">error</span><span class="op" id="7265253">,</span>&nbsp;<span class="ident" id="7265255">n</span><span class="op" id="7265256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265259">for</span>&nbsp;<span class="ident" id="7265263">i</span>&nbsp;<span class="op" id="7265265">:=</span>&nbsp;<span class="num" id="7265268">0</span><span class="op" id="7265269">;</span>&nbsp;<span class="ident" id="7265271">i</span>&nbsp;<span class="op" id="7265273">&lt;</span>&nbsp;<span class="ident" id="7265275">n</span><span class="op" id="7265276">;</span>&nbsp;<span class="ident" id="7265278">i</span><span class="op" id="7265279">++</span>&nbsp;<span class="op" id="7265282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265286">go</span>&nbsp;<span class="keyword" id="7265289">func</span><span class="op" id="7265293">(</span><span class="op" id="7265294">)</span>&nbsp;<span class="op" id="7265296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265301">var</span>&nbsp;<span class="ident" id="7265305">age</span>&nbsp;<span class="builtintype" id="7265309">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265316">err</span>&nbsp;<span class="op" id="7265320">:=</span>&nbsp;<span class="ident" id="7265323">stmt</span><span class="op" id="7265327">.</span><span class="ident" id="7265328">QueryRow</span><span class="op" id="7265336">(</span><span class="string" id="7265337">&#34;Alice&#34;</span><span class="op" id="7265344">)</span><span class="op" id="7265345">.</span><span class="ident" id="7265346">Scan</span><span class="op" id="7265350">(</span><span class="op" id="7265351">&amp;</span><span class="ident" id="7265352">age</span><span class="op" id="7265355">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265360">if</span>&nbsp;<span class="ident" id="7265363">err</span>&nbsp;<span class="op" id="7265367">==</span>&nbsp;<span class="ident" id="7265370">nil</span>&nbsp;<span class="op" id="7265374">&amp;&amp;</span>&nbsp;<span class="ident" id="7265377">age</span>&nbsp;<span class="op" id="7265381">!=</span>&nbsp;<span class="num" id="7265384">1</span>&nbsp;<span class="op" id="7265386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265392">err</span>&nbsp;<span class="op" id="7265396">=</span>&nbsp;<span class="ident" id="7265398">fmt</span><span class="op" id="7265401">.</span><span class="ident" id="7265402">Errorf</span><span class="op" id="7265408">(</span><span class="string" id="7265409">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="7265428">,</span>&nbsp;<span class="ident" id="7265430">age</span><span class="op" id="7265433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265443">ch</span>&nbsp;<span class="op" id="7265446">&lt;-</span>&nbsp;<span class="ident" id="7265449">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265455">}</span><span class="op" id="7265456">(</span><span class="op" id="7265457">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265463">for</span>&nbsp;<span class="ident" id="7265467">i</span>&nbsp;<span class="op" id="7265469">:=</span>&nbsp;<span class="num" id="7265472">0</span><span class="op" id="7265473">;</span>&nbsp;<span class="ident" id="7265475">i</span>&nbsp;<span class="op" id="7265477">&lt;</span>&nbsp;<span class="ident" id="7265479">n</span><span class="op" id="7265480">;</span>&nbsp;<span class="ident" id="7265482">i</span><span class="op" id="7265483">++</span>&nbsp;<span class="op" id="7265486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265490">if</span>&nbsp;<span class="ident" id="7265493">err</span>&nbsp;<span class="op" id="7265497">:=</span>&nbsp;<span class="op" id="7265500">&lt;-</span><span class="ident" id="7265502">ch</span><span class="op" id="7265504">;</span>&nbsp;<span class="ident" id="7265506">err</span>&nbsp;<span class="op" id="7265510">!=</span>&nbsp;<span class="ident" id="7265513">nil</span>&nbsp;<span class="op" id="7265517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265522">t</span><span class="op" id="7265523">.</span><span class="ident" id="7265524">Error</span><span class="op" id="7265529">(</span><span class="ident" id="7265530">err</span><span class="op" id="7265533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265537">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265540">}</span><br>
<span class="lineno"></span><span class="op" id="7265542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7265545">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="7265577">func</span>&nbsp;<span class="ident" id="7265582">TestBogusPreboundParameters</span><span class="op" id="7265609">(</span><span class="ident" id="7265610">t</span>&nbsp;<span class="op" id="7265612">*</span><span class="ident" id="7265613">testing</span><span class="op" id="7265620">.</span><span class="ident" id="7265621">T</span><span class="op" id="7265622">)</span>&nbsp;<span class="op" id="7265624">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265627">db</span>&nbsp;<span class="op" id="7265630">:=</span>&nbsp;<span class="ident" id="7265633">newTestDB</span><span class="op" id="7265642">(</span><span class="ident" id="7265643">t</span><span class="op" id="7265644">,</span>&nbsp;<span class="string" id="7265646">&#34;foo&#34;</span><span class="op" id="7265651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265654">defer</span>&nbsp;<span class="ident" id="7265660">closeDB</span><span class="op" id="7265667">(</span><span class="ident" id="7265668">t</span><span class="op" id="7265669">,</span>&nbsp;<span class="ident" id="7265671">db</span><span class="op" id="7265673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265676">exec</span><span class="op" id="7265680">(</span><span class="ident" id="7265681">t</span><span class="op" id="7265682">,</span>&nbsp;<span class="ident" id="7265684">db</span><span class="op" id="7265686">,</span>&nbsp;<span class="string" id="7265688">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7265731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265734">_</span><span class="op" id="7265735">,</span>&nbsp;<span class="ident" id="7265737">err</span>&nbsp;<span class="op" id="7265741">:=</span>&nbsp;<span class="ident" id="7265744">db</span><span class="op" id="7265746">.</span><span class="ident" id="7265747">Prepare</span><span class="op" id="7265754">(</span><span class="string" id="7265755">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="7265793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265796">if</span>&nbsp;<span class="ident" id="7265799">err</span>&nbsp;<span class="op" id="7265803">==</span>&nbsp;<span class="ident" id="7265806">nil</span>&nbsp;<span class="op" id="7265810">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265814">t</span><span class="op" id="7265815">.</span><span class="ident" id="7265816">Fatalf</span><span class="op" id="7265822">(</span><span class="string" id="7265823">&#34;expected&nbsp;error&#34;</span><span class="op" id="7265839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7265845">if</span>&nbsp;<span class="ident" id="7265848">err</span><span class="op" id="7265851">.</span><span class="ident" id="7265852">Error</span><span class="op" id="7265857">(</span><span class="op" id="7265858">)</span>&nbsp;<span class="op" id="7265860">!=</span>&nbsp;<span class="string" id="7265863">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="7265924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7265928">t</span><span class="op" id="7265929">.</span><span class="ident" id="7265930">Errorf</span><span class="op" id="7265936">(</span><span class="string" id="7265937">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7265959">,</span>&nbsp;<span class="ident" id="7265961">err</span><span class="op" id="7265964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7265967">}</span><br>
<span class="lineno">400</span><span class="op" id="7265969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7265972">func</span>&nbsp;<span class="ident" id="7265977">TestExec</span><span class="op" id="7265985">(</span><span class="ident" id="7265986">t</span>&nbsp;<span class="op" id="7265988">*</span><span class="ident" id="7265989">testing</span><span class="op" id="7265996">.</span><span class="ident" id="7265997">T</span><span class="op" id="7265998">)</span>&nbsp;<span class="op" id="7266000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266003">db</span>&nbsp;<span class="op" id="7266006">:=</span>&nbsp;<span class="ident" id="7266009">newTestDB</span><span class="op" id="7266018">(</span><span class="ident" id="7266019">t</span><span class="op" id="7266020">,</span>&nbsp;<span class="string" id="7266022">&#34;foo&#34;</span><span class="op" id="7266027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7266030">defer</span>&nbsp;<span class="ident" id="7266036">closeDB</span><span class="op" id="7266043">(</span><span class="ident" id="7266044">t</span><span class="op" id="7266045">,</span>&nbsp;<span class="ident" id="7266047">db</span><span class="op" id="7266049">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266052">exec</span><span class="op" id="7266056">(</span><span class="ident" id="7266057">t</span><span class="op" id="7266058">,</span>&nbsp;<span class="ident" id="7266060">db</span><span class="op" id="7266062">,</span>&nbsp;<span class="string" id="7266064">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7266107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266110">stmt</span><span class="op" id="7266114">,</span>&nbsp;<span class="ident" id="7266116">err</span>&nbsp;<span class="op" id="7266120">:=</span>&nbsp;<span class="ident" id="7266123">db</span><span class="op" id="7266125">.</span><span class="ident" id="7266126">Prepare</span><span class="op" id="7266133">(</span><span class="string" id="7266134">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7266158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7266161">if</span>&nbsp;<span class="ident" id="7266164">err</span>&nbsp;<span class="op" id="7266168">!=</span>&nbsp;<span class="ident" id="7266171">nil</span>&nbsp;<span class="op" id="7266175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266179">t</span><span class="op" id="7266180">.</span><span class="ident" id="7266181">Errorf</span><span class="op" id="7266187">(</span><span class="string" id="7266188">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7266208">,</span>&nbsp;<span class="ident" id="7266210">stmt</span><span class="op" id="7266214">,</span>&nbsp;<span class="ident" id="7266216">err</span><span class="op" id="7266219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266222">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7266225">defer</span>&nbsp;<span class="ident" id="7266231">stmt</span><span class="op" id="7266235">.</span><span class="ident" id="7266236">Close</span><span class="op" id="7266241">(</span><span class="op" id="7266242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7266246">type</span>&nbsp;<span class="ident" id="7266251">execTest</span>&nbsp;<span class="keyword" id="7266260">struct</span>&nbsp;<span class="op" id="7266267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266271">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266279">[</span><span class="op" id="7266280">]</span><span class="keyword" id="7266281">interface</span><span class="op" id="7266290">{</span><span class="op" id="7266291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266295">wantErr</span>&nbsp;<span class="builtintype" id="7266303">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266314">execTests</span>&nbsp;<span class="op" id="7266324">:=</span>&nbsp;<span class="op" id="7266327">[</span><span class="op" id="7266328">]</span><span class="ident" id="7266329">execTest</span><span class="op" id="7266337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7266341">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266352">{</span><span class="op" id="7266353">[</span><span class="op" id="7266354">]</span><span class="keyword" id="7266355">interface</span><span class="op" id="7266364">{</span><span class="op" id="7266365">}</span><span class="op" id="7266366">{</span><span class="string" id="7266367">&#34;Brad&#34;</span><span class="op" id="7266373">,</span>&nbsp;<span class="num" id="7266375">31</span><span class="op" id="7266377">}</span><span class="op" id="7266378">,</span>&nbsp;<span class="string" id="7266380">&#34;&#34;</span><span class="op" id="7266382">}</span><span class="op" id="7266383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266387">{</span><span class="op" id="7266388">[</span><span class="op" id="7266389">]</span><span class="keyword" id="7266390">interface</span><span class="op" id="7266399">{</span><span class="op" id="7266400">}</span><span class="op" id="7266401">{</span><span class="string" id="7266402">&#34;Brad&#34;</span><span class="op" id="7266408">,</span>&nbsp;<span class="ident" id="7266410">int64</span><span class="op" id="7266415">(</span><span class="num" id="7266416">31</span><span class="op" id="7266418">)</span><span class="op" id="7266419">}</span><span class="op" id="7266420">,</span>&nbsp;<span class="string" id="7266422">&#34;&#34;</span><span class="op" id="7266424">}</span><span class="op" id="7266425">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266429">{</span><span class="op" id="7266430">[</span><span class="op" id="7266431">]</span><span class="keyword" id="7266432">interface</span><span class="op" id="7266441">{</span><span class="op" id="7266442">}</span><span class="op" id="7266443">{</span><span class="string" id="7266444">&#34;Bob&#34;</span><span class="op" id="7266449">,</span>&nbsp;<span class="string" id="7266451">&#34;32&#34;</span><span class="op" id="7266455">}</span><span class="op" id="7266456">,</span>&nbsp;<span class="string" id="7266458">&#34;&#34;</span><span class="op" id="7266460">}</span><span class="op" id="7266461">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266465">{</span><span class="op" id="7266466">[</span><span class="op" id="7266467">]</span><span class="keyword" id="7266468">interface</span><span class="op" id="7266477">{</span><span class="op" id="7266478">}</span><span class="op" id="7266479">{</span><span class="num" id="7266480">7</span><span class="op" id="7266481">,</span>&nbsp;<span class="num" id="7266483">9</span><span class="op" id="7266484">}</span><span class="op" id="7266485">,</span>&nbsp;<span class="string" id="7266487">&#34;&#34;</span><span class="op" id="7266489">}</span><span class="op" id="7266490">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7266495">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266521">{</span><span class="op" id="7266522">[</span><span class="op" id="7266523">]</span><span class="keyword" id="7266524">interface</span><span class="op" id="7266533">{</span><span class="op" id="7266534">}</span><span class="op" id="7266535">{</span><span class="string" id="7266536">&#34;Brad&#34;</span><span class="op" id="7266542">,</span>&nbsp;<span class="ident" id="7266544">int64</span><span class="op" id="7266549">(</span><span class="num" id="7266550">0xFFFFFFFF</span><span class="op" id="7266560">)</span><span class="op" id="7266561">}</span><span class="op" id="7266562">,</span>&nbsp;<span class="string" id="7266564">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="7266646">}</span><span class="op" id="7266647">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266651">{</span><span class="op" id="7266652">[</span><span class="op" id="7266653">]</span><span class="keyword" id="7266654">interface</span><span class="op" id="7266663">{</span><span class="op" id="7266664">}</span><span class="op" id="7266665">{</span><span class="string" id="7266666">&#34;Brad&#34;</span><span class="op" id="7266672">,</span>&nbsp;<span class="string" id="7266674">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="7266688">}</span><span class="op" id="7266689">,</span>&nbsp;<span class="string" id="7266691">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="7266791">}</span><span class="op" id="7266792">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7266797">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266824">{</span><span class="op" id="7266825">[</span><span class="op" id="7266826">]</span><span class="keyword" id="7266827">interface</span><span class="op" id="7266836">{</span><span class="op" id="7266837">}</span><span class="op" id="7266838">{</span><span class="op" id="7266839">}</span><span class="op" id="7266840">,</span>&nbsp;<span class="string" id="7266842">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="7266876">}</span><span class="op" id="7266877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266881">{</span><span class="op" id="7266882">[</span><span class="op" id="7266883">]</span><span class="keyword" id="7266884">interface</span><span class="op" id="7266893">{</span><span class="op" id="7266894">}</span><span class="op" id="7266895">{</span><span class="num" id="7266896">1</span><span class="op" id="7266897">,</span>&nbsp;<span class="num" id="7266899">2</span><span class="op" id="7266900">,</span>&nbsp;<span class="num" id="7266902">3</span><span class="op" id="7266903">}</span><span class="op" id="7266904">,</span>&nbsp;<span class="string" id="7266906">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="7266940">}</span><span class="op" id="7266941">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7266944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7266947">for</span>&nbsp;<span class="ident" id="7266951">n</span><span class="op" id="7266952">,</span>&nbsp;<span class="ident" id="7266954">et</span>&nbsp;<span class="op" id="7266957">:=</span>&nbsp;<span class="keyword" id="7266960">range</span>&nbsp;<span class="ident" id="7266966">execTests</span>&nbsp;<span class="op" id="7266976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7266980">_</span><span class="op" id="7266981">,</span>&nbsp;<span class="ident" id="7266983">err</span>&nbsp;<span class="op" id="7266987">:=</span>&nbsp;<span class="ident" id="7266990">stmt</span><span class="op" id="7266994">.</span><span class="ident" id="7266995">Exec</span><span class="op" id="7266999">(</span><span class="ident" id="7267000">et</span><span class="op" id="7267002">.</span><span class="ident" id="7267003">args</span><span class="op" id="7267007">...</span><span class="op" id="7267010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267014">errStr</span>&nbsp;<span class="op" id="7267021">:=</span>&nbsp;<span class="string" id="7267024">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267029">if</span>&nbsp;<span class="ident" id="7267032">err</span>&nbsp;<span class="op" id="7267036">!=</span>&nbsp;<span class="ident" id="7267039">nil</span>&nbsp;<span class="op" id="7267043">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267048">errStr</span>&nbsp;<span class="op" id="7267055">=</span>&nbsp;<span class="ident" id="7267057">err</span><span class="op" id="7267060">.</span><span class="ident" id="7267061">Error</span><span class="op" id="7267066">(</span><span class="op" id="7267067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267075">if</span>&nbsp;<span class="ident" id="7267078">errStr</span>&nbsp;<span class="op" id="7267085">!=</span>&nbsp;<span class="ident" id="7267088">et</span><span class="op" id="7267090">.</span><span class="ident" id="7267091">wantErr</span>&nbsp;<span class="op" id="7267099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267104">t</span><span class="op" id="7267105">.</span><span class="ident" id="7267106">Errorf</span><span class="op" id="7267112">(</span><span class="string" id="7267113">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="7267168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267174">n</span><span class="op" id="7267175">,</span>&nbsp;<span class="ident" id="7267177">et</span><span class="op" id="7267179">.</span><span class="ident" id="7267180">args</span><span class="op" id="7267184">,</span>&nbsp;<span class="ident" id="7267186">errStr</span><span class="op" id="7267192">,</span>&nbsp;<span class="ident" id="7267194">et</span><span class="op" id="7267196">.</span><span class="ident" id="7267197">wantErr</span><span class="op" id="7267204">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267211">}</span><br>
<span class="lineno"></span><span class="op" id="7267213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7267216">func</span>&nbsp;<span class="ident" id="7267221">TestTxPrepare</span><span class="op" id="7267234">(</span><span class="ident" id="7267235">t</span>&nbsp;<span class="op" id="7267237">*</span><span class="ident" id="7267238">testing</span><span class="op" id="7267245">.</span><span class="ident" id="7267246">T</span><span class="op" id="7267247">)</span>&nbsp;<span class="op" id="7267249">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267252">db</span>&nbsp;<span class="op" id="7267255">:=</span>&nbsp;<span class="ident" id="7267258">newTestDB</span><span class="op" id="7267267">(</span><span class="ident" id="7267268">t</span><span class="op" id="7267269">,</span>&nbsp;<span class="string" id="7267271">&#34;&#34;</span><span class="op" id="7267273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267276">defer</span>&nbsp;<span class="ident" id="7267282">closeDB</span><span class="op" id="7267289">(</span><span class="ident" id="7267290">t</span><span class="op" id="7267291">,</span>&nbsp;<span class="ident" id="7267293">db</span><span class="op" id="7267295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267298">exec</span><span class="op" id="7267302">(</span><span class="ident" id="7267303">t</span><span class="op" id="7267304">,</span>&nbsp;<span class="ident" id="7267306">db</span><span class="op" id="7267308">,</span>&nbsp;<span class="string" id="7267310">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7267353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267356">tx</span><span class="op" id="7267358">,</span>&nbsp;<span class="ident" id="7267360">err</span>&nbsp;<span class="op" id="7267364">:=</span>&nbsp;<span class="ident" id="7267367">db</span><span class="op" id="7267369">.</span><span class="ident" id="7267370">Begin</span><span class="op" id="7267375">(</span><span class="op" id="7267376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267379">if</span>&nbsp;<span class="ident" id="7267382">err</span>&nbsp;<span class="op" id="7267386">!=</span>&nbsp;<span class="ident" id="7267389">nil</span>&nbsp;<span class="op" id="7267393">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267397">t</span><span class="op" id="7267398">.</span><span class="ident" id="7267399">Fatalf</span><span class="op" id="7267405">(</span><span class="string" id="7267406">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7267418">,</span>&nbsp;<span class="ident" id="7267420">err</span><span class="op" id="7267423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267429">stmt</span><span class="op" id="7267433">,</span>&nbsp;<span class="ident" id="7267435">err</span>&nbsp;<span class="op" id="7267439">:=</span>&nbsp;<span class="ident" id="7267442">tx</span><span class="op" id="7267444">.</span><span class="ident" id="7267445">Prepare</span><span class="op" id="7267452">(</span><span class="string" id="7267453">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7267477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267480">if</span>&nbsp;<span class="ident" id="7267483">err</span>&nbsp;<span class="op" id="7267487">!=</span>&nbsp;<span class="ident" id="7267490">nil</span>&nbsp;<span class="op" id="7267494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267498">t</span><span class="op" id="7267499">.</span><span class="ident" id="7267500">Fatalf</span><span class="op" id="7267506">(</span><span class="string" id="7267507">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7267527">,</span>&nbsp;<span class="ident" id="7267529">stmt</span><span class="op" id="7267533">,</span>&nbsp;<span class="ident" id="7267535">err</span><span class="op" id="7267538">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267544">defer</span>&nbsp;<span class="ident" id="7267550">stmt</span><span class="op" id="7267554">.</span><span class="ident" id="7267555">Close</span><span class="op" id="7267560">(</span><span class="op" id="7267561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267564">_</span><span class="op" id="7267565">,</span>&nbsp;<span class="ident" id="7267567">err</span>&nbsp;<span class="op" id="7267571">=</span>&nbsp;<span class="ident" id="7267573">stmt</span><span class="op" id="7267577">.</span><span class="ident" id="7267578">Exec</span><span class="op" id="7267582">(</span><span class="string" id="7267583">&#34;Bobby&#34;</span><span class="op" id="7267590">,</span>&nbsp;<span class="num" id="7267592">7</span><span class="op" id="7267593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267596">if</span>&nbsp;<span class="ident" id="7267599">err</span>&nbsp;<span class="op" id="7267603">!=</span>&nbsp;<span class="ident" id="7267606">nil</span>&nbsp;<span class="op" id="7267610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267614">t</span><span class="op" id="7267615">.</span><span class="ident" id="7267616">Fatalf</span><span class="op" id="7267622">(</span><span class="string" id="7267623">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7267634">,</span>&nbsp;<span class="ident" id="7267636">err</span><span class="op" id="7267639">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267645">err</span>&nbsp;<span class="op" id="7267649">=</span>&nbsp;<span class="ident" id="7267651">tx</span><span class="op" id="7267653">.</span><span class="ident" id="7267654">Commit</span><span class="op" id="7267660">(</span><span class="op" id="7267661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267664">if</span>&nbsp;<span class="ident" id="7267667">err</span>&nbsp;<span class="op" id="7267671">!=</span>&nbsp;<span class="ident" id="7267674">nil</span>&nbsp;<span class="op" id="7267678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267682">t</span><span class="op" id="7267683">.</span><span class="ident" id="7267684">Fatalf</span><span class="op" id="7267690">(</span><span class="string" id="7267691">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7267704">,</span>&nbsp;<span class="ident" id="7267706">err</span><span class="op" id="7267709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267712">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7267715">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267761">if</span>&nbsp;<span class="op" id="7267764">!</span><span class="ident" id="7267765">stmt</span><span class="op" id="7267769">.</span><span class="ident" id="7267770">closed</span>&nbsp;<span class="op" id="7267777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267781">t</span><span class="op" id="7267782">.</span><span class="ident" id="7267783">Fatal</span><span class="op" id="7267788">(</span><span class="string" id="7267789">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7267819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7267822">}</span><br>
<span class="lineno"></span><span class="op" id="7267824">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7267827">func</span>&nbsp;<span class="ident" id="7267832">TestTxStmt</span><span class="op" id="7267842">(</span><span class="ident" id="7267843">t</span>&nbsp;<span class="op" id="7267845">*</span><span class="ident" id="7267846">testing</span><span class="op" id="7267853">.</span><span class="ident" id="7267854">T</span><span class="op" id="7267855">)</span>&nbsp;<span class="op" id="7267857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267860">db</span>&nbsp;<span class="op" id="7267863">:=</span>&nbsp;<span class="ident" id="7267866">newTestDB</span><span class="op" id="7267875">(</span><span class="ident" id="7267876">t</span><span class="op" id="7267877">,</span>&nbsp;<span class="string" id="7267879">&#34;&#34;</span><span class="op" id="7267881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7267884">defer</span>&nbsp;<span class="ident" id="7267890">closeDB</span><span class="op" id="7267897">(</span><span class="ident" id="7267898">t</span><span class="op" id="7267899">,</span>&nbsp;<span class="ident" id="7267901">db</span><span class="op" id="7267903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267906">exec</span><span class="op" id="7267910">(</span><span class="ident" id="7267911">t</span><span class="op" id="7267912">,</span>&nbsp;<span class="ident" id="7267914">db</span><span class="op" id="7267916">,</span>&nbsp;<span class="string" id="7267918">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7267961">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7267964">stmt</span><span class="op" id="7267968">,</span>&nbsp;<span class="ident" id="7267970">err</span>&nbsp;<span class="op" id="7267974">:=</span>&nbsp;<span class="ident" id="7267977">db</span><span class="op" id="7267979">.</span><span class="ident" id="7267980">Prepare</span><span class="op" id="7267987">(</span><span class="string" id="7267988">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7268012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268015">if</span>&nbsp;<span class="ident" id="7268018">err</span>&nbsp;<span class="op" id="7268022">!=</span>&nbsp;<span class="ident" id="7268025">nil</span>&nbsp;<span class="op" id="7268029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268033">t</span><span class="op" id="7268034">.</span><span class="ident" id="7268035">Fatalf</span><span class="op" id="7268041">(</span><span class="string" id="7268042">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7268062">,</span>&nbsp;<span class="ident" id="7268064">stmt</span><span class="op" id="7268068">,</span>&nbsp;<span class="ident" id="7268070">err</span><span class="op" id="7268073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268079">defer</span>&nbsp;<span class="ident" id="7268085">stmt</span><span class="op" id="7268089">.</span><span class="ident" id="7268090">Close</span><span class="op" id="7268095">(</span><span class="op" id="7268096">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268099">tx</span><span class="op" id="7268101">,</span>&nbsp;<span class="ident" id="7268103">err</span>&nbsp;<span class="op" id="7268107">:=</span>&nbsp;<span class="ident" id="7268110">db</span><span class="op" id="7268112">.</span><span class="ident" id="7268113">Begin</span><span class="op" id="7268118">(</span><span class="op" id="7268119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268122">if</span>&nbsp;<span class="ident" id="7268125">err</span>&nbsp;<span class="op" id="7268129">!=</span>&nbsp;<span class="ident" id="7268132">nil</span>&nbsp;<span class="op" id="7268136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268140">t</span><span class="op" id="7268141">.</span><span class="ident" id="7268142">Fatalf</span><span class="op" id="7268148">(</span><span class="string" id="7268149">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7268161">,</span>&nbsp;<span class="ident" id="7268163">err</span><span class="op" id="7268166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268172">txs</span>&nbsp;<span class="op" id="7268176">:=</span>&nbsp;<span class="ident" id="7268179">tx</span><span class="op" id="7268181">.</span><span class="ident" id="7268182">Stmt</span><span class="op" id="7268186">(</span><span class="ident" id="7268187">stmt</span><span class="op" id="7268191">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268194">defer</span>&nbsp;<span class="ident" id="7268200">txs</span><span class="op" id="7268203">.</span><span class="ident" id="7268204">Close</span><span class="op" id="7268209">(</span><span class="op" id="7268210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268213">_</span><span class="op" id="7268214">,</span>&nbsp;<span class="ident" id="7268216">err</span>&nbsp;<span class="op" id="7268220">=</span>&nbsp;<span class="ident" id="7268222">txs</span><span class="op" id="7268225">.</span><span class="ident" id="7268226">Exec</span><span class="op" id="7268230">(</span><span class="string" id="7268231">&#34;Bobby&#34;</span><span class="op" id="7268238">,</span>&nbsp;<span class="num" id="7268240">7</span><span class="op" id="7268241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268244">if</span>&nbsp;<span class="ident" id="7268247">err</span>&nbsp;<span class="op" id="7268251">!=</span>&nbsp;<span class="ident" id="7268254">nil</span>&nbsp;<span class="op" id="7268258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268262">t</span><span class="op" id="7268263">.</span><span class="ident" id="7268264">Fatalf</span><span class="op" id="7268270">(</span><span class="string" id="7268271">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7268282">,</span>&nbsp;<span class="ident" id="7268284">err</span><span class="op" id="7268287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268290">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268293">err</span>&nbsp;<span class="op" id="7268297">=</span>&nbsp;<span class="ident" id="7268299">tx</span><span class="op" id="7268301">.</span><span class="ident" id="7268302">Commit</span><span class="op" id="7268308">(</span><span class="op" id="7268309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268312">if</span>&nbsp;<span class="ident" id="7268315">err</span>&nbsp;<span class="op" id="7268319">!=</span>&nbsp;<span class="ident" id="7268322">nil</span>&nbsp;<span class="op" id="7268326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268330">t</span><span class="op" id="7268331">.</span><span class="ident" id="7268332">Fatalf</span><span class="op" id="7268338">(</span><span class="string" id="7268339">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7268352">,</span>&nbsp;<span class="ident" id="7268354">err</span><span class="op" id="7268357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7268363">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268409">if</span>&nbsp;<span class="op" id="7268412">!</span><span class="ident" id="7268413">txs</span><span class="op" id="7268416">.</span><span class="ident" id="7268417">closed</span>&nbsp;<span class="op" id="7268424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268428">t</span><span class="op" id="7268429">.</span><span class="ident" id="7268430">Fatal</span><span class="op" id="7268435">(</span><span class="string" id="7268436">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7268466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268469">}</span><br>
<span class="lineno"></span><span class="op" id="7268471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="7268474">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="7268513">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="7268590">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="7268657">func</span>&nbsp;<span class="ident" id="7268662">TestTxQuery</span><span class="op" id="7268673">(</span><span class="ident" id="7268674">t</span>&nbsp;<span class="op" id="7268676">*</span><span class="ident" id="7268677">testing</span><span class="op" id="7268684">.</span><span class="ident" id="7268685">T</span><span class="op" id="7268686">)</span>&nbsp;<span class="op" id="7268688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268691">db</span>&nbsp;<span class="op" id="7268694">:=</span>&nbsp;<span class="ident" id="7268697">newTestDB</span><span class="op" id="7268706">(</span><span class="ident" id="7268707">t</span><span class="op" id="7268708">,</span>&nbsp;<span class="string" id="7268710">&#34;&#34;</span><span class="op" id="7268712">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268715">defer</span>&nbsp;<span class="ident" id="7268721">closeDB</span><span class="op" id="7268728">(</span><span class="ident" id="7268729">t</span><span class="op" id="7268730">,</span>&nbsp;<span class="ident" id="7268732">db</span><span class="op" id="7268734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268737">exec</span><span class="op" id="7268741">(</span><span class="ident" id="7268742">t</span><span class="op" id="7268743">,</span>&nbsp;<span class="ident" id="7268745">db</span><span class="op" id="7268747">,</span>&nbsp;<span class="string" id="7268749">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7268792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268795">exec</span><span class="op" id="7268799">(</span><span class="ident" id="7268800">t</span><span class="op" id="7268801">,</span>&nbsp;<span class="ident" id="7268803">db</span><span class="op" id="7268805">,</span>&nbsp;<span class="string" id="7268807">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="7268829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268833">tx</span><span class="op" id="7268835">,</span>&nbsp;<span class="ident" id="7268837">err</span>&nbsp;<span class="op" id="7268841">:=</span>&nbsp;<span class="ident" id="7268844">db</span><span class="op" id="7268846">.</span><span class="ident" id="7268847">Begin</span><span class="op" id="7268852">(</span><span class="op" id="7268853">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268856">if</span>&nbsp;<span class="ident" id="7268859">err</span>&nbsp;<span class="op" id="7268863">!=</span>&nbsp;<span class="ident" id="7268866">nil</span>&nbsp;<span class="op" id="7268870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268874">t</span><span class="op" id="7268875">.</span><span class="ident" id="7268876">Fatal</span><span class="op" id="7268881">(</span><span class="ident" id="7268882">err</span><span class="op" id="7268885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268891">defer</span>&nbsp;<span class="ident" id="7268897">tx</span><span class="op" id="7268899">.</span><span class="ident" id="7268900">Rollback</span><span class="op" id="7268908">(</span><span class="op" id="7268909">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268913">r</span><span class="op" id="7268914">,</span>&nbsp;<span class="ident" id="7268916">err</span>&nbsp;<span class="op" id="7268920">:=</span>&nbsp;<span class="ident" id="7268923">tx</span><span class="op" id="7268925">.</span><span class="ident" id="7268926">Query</span><span class="op" id="7268931">(</span><span class="string" id="7268932">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7268949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268952">if</span>&nbsp;<span class="ident" id="7268955">err</span>&nbsp;<span class="op" id="7268959">!=</span>&nbsp;<span class="ident" id="7268962">nil</span>&nbsp;<span class="op" id="7268966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7268970">t</span><span class="op" id="7268971">.</span><span class="ident" id="7268972">Fatal</span><span class="op" id="7268977">(</span><span class="ident" id="7268978">err</span><span class="op" id="7268981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7268984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7268987">defer</span>&nbsp;<span class="ident" id="7268993">r</span><span class="op" id="7268994">.</span><span class="ident" id="7268995">Close</span><span class="op" id="7269000">(</span><span class="op" id="7269001">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269005">if</span>&nbsp;<span class="op" id="7269008">!</span><span class="ident" id="7269009">r</span><span class="op" id="7269010">.</span><span class="ident" id="7269011">Next</span><span class="op" id="7269015">(</span><span class="op" id="7269016">)</span>&nbsp;<span class="op" id="7269018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269022">if</span>&nbsp;<span class="ident" id="7269025">r</span><span class="op" id="7269026">.</span><span class="ident" id="7269027">Err</span><span class="op" id="7269030">(</span><span class="op" id="7269031">)</span>&nbsp;<span class="op" id="7269033">!=</span>&nbsp;<span class="ident" id="7269036">nil</span>&nbsp;<span class="op" id="7269040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269045">t</span><span class="op" id="7269046">.</span><span class="ident" id="7269047">Fatal</span><span class="op" id="7269052">(</span><span class="ident" id="7269053">r</span><span class="op" id="7269054">.</span><span class="ident" id="7269055">Err</span><span class="op" id="7269058">(</span><span class="op" id="7269059">)</span><span class="op" id="7269060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269064">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269068">t</span><span class="op" id="7269069">.</span><span class="ident" id="7269070">Fatal</span><span class="op" id="7269075">(</span><span class="string" id="7269076">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="7269094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269101">var</span>&nbsp;<span class="ident" id="7269105">x</span>&nbsp;<span class="builtintype" id="7269107">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269115">err</span>&nbsp;<span class="op" id="7269119">=</span>&nbsp;<span class="ident" id="7269121">r</span><span class="op" id="7269122">.</span><span class="ident" id="7269123">Scan</span><span class="op" id="7269127">(</span><span class="op" id="7269128">&amp;</span><span class="ident" id="7269129">x</span><span class="op" id="7269130">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269133">if</span>&nbsp;<span class="ident" id="7269136">err</span>&nbsp;<span class="op" id="7269140">!=</span>&nbsp;<span class="ident" id="7269143">nil</span>&nbsp;<span class="op" id="7269147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269151">t</span><span class="op" id="7269152">.</span><span class="ident" id="7269153">Fatal</span><span class="op" id="7269158">(</span><span class="ident" id="7269159">err</span><span class="op" id="7269162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269165">}</span><br>
<span class="lineno"></span><span class="op" id="7269167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7269170">func</span>&nbsp;<span class="ident" id="7269175">TestTxQueryInvalid</span><span class="op" id="7269193">(</span><span class="ident" id="7269194">t</span>&nbsp;<span class="op" id="7269196">*</span><span class="ident" id="7269197">testing</span><span class="op" id="7269204">.</span><span class="ident" id="7269205">T</span><span class="op" id="7269206">)</span>&nbsp;<span class="op" id="7269208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269211">db</span>&nbsp;<span class="op" id="7269214">:=</span>&nbsp;<span class="ident" id="7269217">newTestDB</span><span class="op" id="7269226">(</span><span class="ident" id="7269227">t</span><span class="op" id="7269228">,</span>&nbsp;<span class="string" id="7269230">&#34;&#34;</span><span class="op" id="7269232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269235">defer</span>&nbsp;<span class="ident" id="7269241">closeDB</span><span class="op" id="7269248">(</span><span class="ident" id="7269249">t</span><span class="op" id="7269250">,</span>&nbsp;<span class="ident" id="7269252">db</span><span class="op" id="7269254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269258">tx</span><span class="op" id="7269260">,</span>&nbsp;<span class="ident" id="7269262">err</span>&nbsp;<span class="op" id="7269266">:=</span>&nbsp;<span class="ident" id="7269269">db</span><span class="op" id="7269271">.</span><span class="ident" id="7269272">Begin</span><span class="op" id="7269277">(</span><span class="op" id="7269278">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269281">if</span>&nbsp;<span class="ident" id="7269284">err</span>&nbsp;<span class="op" id="7269288">!=</span>&nbsp;<span class="ident" id="7269291">nil</span>&nbsp;<span class="op" id="7269295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269299">t</span><span class="op" id="7269300">.</span><span class="ident" id="7269301">Fatal</span><span class="op" id="7269306">(</span><span class="ident" id="7269307">err</span><span class="op" id="7269310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269316">defer</span>&nbsp;<span class="ident" id="7269322">tx</span><span class="op" id="7269324">.</span><span class="ident" id="7269325">Rollback</span><span class="op" id="7269333">(</span><span class="op" id="7269334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269338">_</span><span class="op" id="7269339">,</span>&nbsp;<span class="ident" id="7269341">err</span>&nbsp;<span class="op" id="7269345">=</span>&nbsp;<span class="ident" id="7269347">tx</span><span class="op" id="7269349">.</span><span class="ident" id="7269350">Query</span><span class="op" id="7269355">(</span><span class="string" id="7269356">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7269373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269376">if</span>&nbsp;<span class="ident" id="7269379">err</span>&nbsp;<span class="op" id="7269383">==</span>&nbsp;<span class="ident" id="7269386">nil</span>&nbsp;<span class="op" id="7269390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269394">t</span><span class="op" id="7269395">.</span><span class="ident" id="7269396">Fatal</span><span class="op" id="7269401">(</span><span class="string" id="7269402">&#34;Error&nbsp;expected&#34;</span><span class="op" id="7269418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269421">}</span><br>
<span class="lineno"></span><span class="op" id="7269423">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="7269426">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="7269489">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="7269524">func</span>&nbsp;<span class="ident" id="7269529">TestTxErrBadConn</span><span class="op" id="7269545">(</span><span class="ident" id="7269546">t</span>&nbsp;<span class="op" id="7269548">*</span><span class="ident" id="7269549">testing</span><span class="op" id="7269556">.</span><span class="ident" id="7269557">T</span><span class="op" id="7269558">)</span>&nbsp;<span class="op" id="7269560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269563">db</span><span class="op" id="7269565">,</span>&nbsp;<span class="ident" id="7269567">err</span>&nbsp;<span class="op" id="7269571">:=</span>&nbsp;<span class="ident" id="7269574">Open</span><span class="op" id="7269578">(</span><span class="string" id="7269579">&#34;test&#34;</span><span class="op" id="7269585">,</span>&nbsp;<span class="ident" id="7269587">fakeDBName</span><span class="op" id="7269597">+</span><span class="string" id="7269598">&#34;;badConn&#34;</span><span class="op" id="7269608">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269611">if</span>&nbsp;<span class="ident" id="7269614">err</span>&nbsp;<span class="op" id="7269618">!=</span>&nbsp;<span class="ident" id="7269621">nil</span>&nbsp;<span class="op" id="7269625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269629">t</span><span class="op" id="7269630">.</span><span class="ident" id="7269631">Fatalf</span><span class="op" id="7269637">(</span><span class="string" id="7269638">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7269648">,</span>&nbsp;<span class="ident" id="7269650">err</span><span class="op" id="7269653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269659">if</span>&nbsp;<span class="ident" id="7269662">_</span><span class="op" id="7269663">,</span>&nbsp;<span class="ident" id="7269665">err</span>&nbsp;<span class="op" id="7269669">:=</span>&nbsp;<span class="ident" id="7269672">db</span><span class="op" id="7269674">.</span><span class="ident" id="7269675">Exec</span><span class="op" id="7269679">(</span><span class="string" id="7269680">&#34;WIPE&#34;</span><span class="op" id="7269686">)</span><span class="op" id="7269687">;</span>&nbsp;<span class="ident" id="7269689">err</span>&nbsp;<span class="op" id="7269693">!=</span>&nbsp;<span class="ident" id="7269696">nil</span>&nbsp;<span class="op" id="7269700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269704">t</span><span class="op" id="7269705">.</span><span class="ident" id="7269706">Fatalf</span><span class="op" id="7269712">(</span><span class="string" id="7269713">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7269728">,</span>&nbsp;<span class="ident" id="7269730">err</span><span class="op" id="7269733">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269739">defer</span>&nbsp;<span class="ident" id="7269745">closeDB</span><span class="op" id="7269752">(</span><span class="ident" id="7269753">t</span><span class="op" id="7269754">,</span>&nbsp;<span class="ident" id="7269756">db</span><span class="op" id="7269758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269761">exec</span><span class="op" id="7269765">(</span><span class="ident" id="7269766">t</span><span class="op" id="7269767">,</span>&nbsp;<span class="ident" id="7269769">db</span><span class="op" id="7269771">,</span>&nbsp;<span class="string" id="7269773">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7269816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269819">stmt</span><span class="op" id="7269823">,</span>&nbsp;<span class="ident" id="7269825">err</span>&nbsp;<span class="op" id="7269829">:=</span>&nbsp;<span class="ident" id="7269832">db</span><span class="op" id="7269834">.</span><span class="ident" id="7269835">Prepare</span><span class="op" id="7269842">(</span><span class="string" id="7269843">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7269867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269870">if</span>&nbsp;<span class="ident" id="7269873">err</span>&nbsp;<span class="op" id="7269877">!=</span>&nbsp;<span class="ident" id="7269880">nil</span>&nbsp;<span class="op" id="7269884">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269888">t</span><span class="op" id="7269889">.</span><span class="ident" id="7269890">Fatalf</span><span class="op" id="7269896">(</span><span class="string" id="7269897">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7269917">,</span>&nbsp;<span class="ident" id="7269919">stmt</span><span class="op" id="7269923">,</span>&nbsp;<span class="ident" id="7269925">err</span><span class="op" id="7269928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7269931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269934">defer</span>&nbsp;<span class="ident" id="7269940">stmt</span><span class="op" id="7269944">.</span><span class="ident" id="7269945">Close</span><span class="op" id="7269950">(</span><span class="op" id="7269951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269954">tx</span><span class="op" id="7269956">,</span>&nbsp;<span class="ident" id="7269958">err</span>&nbsp;<span class="op" id="7269962">:=</span>&nbsp;<span class="ident" id="7269965">db</span><span class="op" id="7269967">.</span><span class="ident" id="7269968">Begin</span><span class="op" id="7269973">(</span><span class="op" id="7269974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7269977">if</span>&nbsp;<span class="ident" id="7269980">err</span>&nbsp;<span class="op" id="7269984">!=</span>&nbsp;<span class="ident" id="7269987">nil</span>&nbsp;<span class="op" id="7269991">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7269995">t</span><span class="op" id="7269996">.</span><span class="ident" id="7269997">Fatalf</span><span class="op" id="7270003">(</span><span class="string" id="7270004">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7270016">,</span>&nbsp;<span class="ident" id="7270018">err</span><span class="op" id="7270021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270027">txs</span>&nbsp;<span class="op" id="7270031">:=</span>&nbsp;<span class="ident" id="7270034">tx</span><span class="op" id="7270036">.</span><span class="ident" id="7270037">Stmt</span><span class="op" id="7270041">(</span><span class="ident" id="7270042">stmt</span><span class="op" id="7270046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270049">defer</span>&nbsp;<span class="ident" id="7270055">txs</span><span class="op" id="7270058">.</span><span class="ident" id="7270059">Close</span><span class="op" id="7270064">(</span><span class="op" id="7270065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270068">_</span><span class="op" id="7270069">,</span>&nbsp;<span class="ident" id="7270071">err</span>&nbsp;<span class="op" id="7270075">=</span>&nbsp;<span class="ident" id="7270077">txs</span><span class="op" id="7270080">.</span><span class="ident" id="7270081">Exec</span><span class="op" id="7270085">(</span><span class="string" id="7270086">&#34;Bobby&#34;</span><span class="op" id="7270093">,</span>&nbsp;<span class="num" id="7270095">7</span><span class="op" id="7270096">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270099">if</span>&nbsp;<span class="ident" id="7270102">err</span>&nbsp;<span class="op" id="7270106">!=</span>&nbsp;<span class="ident" id="7270109">nil</span>&nbsp;<span class="op" id="7270113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270117">t</span><span class="op" id="7270118">.</span><span class="ident" id="7270119">Fatalf</span><span class="op" id="7270125">(</span><span class="string" id="7270126">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7270137">,</span>&nbsp;<span class="ident" id="7270139">err</span><span class="op" id="7270142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270148">err</span>&nbsp;<span class="op" id="7270152">=</span>&nbsp;<span class="ident" id="7270154">tx</span><span class="op" id="7270156">.</span><span class="ident" id="7270157">Commit</span><span class="op" id="7270163">(</span><span class="op" id="7270164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270167">if</span>&nbsp;<span class="ident" id="7270170">err</span>&nbsp;<span class="op" id="7270174">!=</span>&nbsp;<span class="ident" id="7270177">nil</span>&nbsp;<span class="op" id="7270181">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270185">t</span><span class="op" id="7270186">.</span><span class="ident" id="7270187">Fatalf</span><span class="op" id="7270193">(</span><span class="string" id="7270194">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7270207">,</span>&nbsp;<span class="ident" id="7270209">err</span><span class="op" id="7270212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270215">}</span><br>
<span class="lineno"></span><span class="op" id="7270217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7270220">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="7270289">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="7270313">func</span>&nbsp;<span class="ident" id="7270318">TestIssue2542Deadlock</span><span class="op" id="7270339">(</span><span class="ident" id="7270340">t</span>&nbsp;<span class="op" id="7270342">*</span><span class="ident" id="7270343">testing</span><span class="op" id="7270350">.</span><span class="ident" id="7270351">T</span><span class="op" id="7270352">)</span>&nbsp;<span class="op" id="7270354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270357">db</span>&nbsp;<span class="op" id="7270360">:=</span>&nbsp;<span class="ident" id="7270363">newTestDB</span><span class="op" id="7270372">(</span><span class="ident" id="7270373">t</span><span class="op" id="7270374">,</span>&nbsp;<span class="string" id="7270376">&#34;people&#34;</span><span class="op" id="7270384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270387">closeDB</span><span class="op" id="7270394">(</span><span class="ident" id="7270395">t</span><span class="op" id="7270396">,</span>&nbsp;<span class="ident" id="7270398">db</span><span class="op" id="7270400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270403">for</span>&nbsp;<span class="ident" id="7270407">i</span>&nbsp;<span class="op" id="7270409">:=</span>&nbsp;<span class="num" id="7270412">0</span><span class="op" id="7270413">;</span>&nbsp;<span class="ident" id="7270415">i</span>&nbsp;<span class="op" id="7270417">&lt;</span>&nbsp;<span class="num" id="7270419">2</span><span class="op" id="7270420">;</span>&nbsp;<span class="ident" id="7270422">i</span><span class="op" id="7270423">++</span>&nbsp;<span class="op" id="7270426">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270430">_</span><span class="op" id="7270431">,</span>&nbsp;<span class="ident" id="7270433">err</span>&nbsp;<span class="op" id="7270437">:=</span>&nbsp;<span class="ident" id="7270440">db</span><span class="op" id="7270442">.</span><span class="ident" id="7270443">Query</span><span class="op" id="7270448">(</span><span class="string" id="7270449">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7270474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270478">if</span>&nbsp;<span class="ident" id="7270481">err</span>&nbsp;<span class="op" id="7270485">==</span>&nbsp;<span class="ident" id="7270488">nil</span>&nbsp;<span class="op" id="7270492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270497">t</span><span class="op" id="7270498">.</span><span class="ident" id="7270499">Fatalf</span><span class="op" id="7270505">(</span><span class="string" id="7270506">&#34;expected&nbsp;error&#34;</span><span class="op" id="7270522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270529">}</span><br>
<span class="lineno">595</span><span class="op" id="7270531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7270534">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="7270564">func</span>&nbsp;<span class="ident" id="7270569">TestCloseStmtBeforeRows</span><span class="op" id="7270592">(</span><span class="ident" id="7270593">t</span>&nbsp;<span class="op" id="7270595">*</span><span class="ident" id="7270596">testing</span><span class="op" id="7270603">.</span><span class="ident" id="7270604">T</span><span class="op" id="7270605">)</span>&nbsp;<span class="op" id="7270607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270610">db</span>&nbsp;<span class="op" id="7270613">:=</span>&nbsp;<span class="ident" id="7270616">newTestDB</span><span class="op" id="7270625">(</span><span class="ident" id="7270626">t</span><span class="op" id="7270627">,</span>&nbsp;<span class="string" id="7270629">&#34;people&#34;</span><span class="op" id="7270637">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270640">defer</span>&nbsp;<span class="ident" id="7270646">closeDB</span><span class="op" id="7270653">(</span><span class="ident" id="7270654">t</span><span class="op" id="7270655">,</span>&nbsp;<span class="ident" id="7270657">db</span><span class="op" id="7270659">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270663">s</span><span class="op" id="7270664">,</span>&nbsp;<span class="ident" id="7270666">err</span>&nbsp;<span class="op" id="7270670">:=</span>&nbsp;<span class="ident" id="7270673">db</span><span class="op" id="7270675">.</span><span class="ident" id="7270676">Prepare</span><span class="op" id="7270683">(</span><span class="string" id="7270684">&#34;SELECT|people|name|&#34;</span><span class="op" id="7270705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270708">if</span>&nbsp;<span class="ident" id="7270711">err</span>&nbsp;<span class="op" id="7270715">!=</span>&nbsp;<span class="ident" id="7270718">nil</span>&nbsp;<span class="op" id="7270722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270726">t</span><span class="op" id="7270727">.</span><span class="ident" id="7270728">Fatal</span><span class="op" id="7270733">(</span><span class="ident" id="7270734">err</span><span class="op" id="7270737">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270744">r</span><span class="op" id="7270745">,</span>&nbsp;<span class="ident" id="7270747">err</span>&nbsp;<span class="op" id="7270751">:=</span>&nbsp;<span class="ident" id="7270754">s</span><span class="op" id="7270755">.</span><span class="ident" id="7270756">Query</span><span class="op" id="7270761">(</span><span class="op" id="7270762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270765">if</span>&nbsp;<span class="ident" id="7270768">err</span>&nbsp;<span class="op" id="7270772">!=</span>&nbsp;<span class="ident" id="7270775">nil</span>&nbsp;<span class="op" id="7270779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270783">s</span><span class="op" id="7270784">.</span><span class="ident" id="7270785">Close</span><span class="op" id="7270790">(</span><span class="op" id="7270791">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270795">t</span><span class="op" id="7270796">.</span><span class="ident" id="7270797">Fatal</span><span class="op" id="7270802">(</span><span class="ident" id="7270803">err</span><span class="op" id="7270806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270813">err</span>&nbsp;<span class="op" id="7270817">=</span>&nbsp;<span class="ident" id="7270819">s</span><span class="op" id="7270820">.</span><span class="ident" id="7270821">Close</span><span class="op" id="7270826">(</span><span class="op" id="7270827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7270830">if</span>&nbsp;<span class="ident" id="7270833">err</span>&nbsp;<span class="op" id="7270837">!=</span>&nbsp;<span class="ident" id="7270840">nil</span>&nbsp;<span class="op" id="7270844">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270848">t</span><span class="op" id="7270849">.</span><span class="ident" id="7270850">Fatal</span><span class="op" id="7270855">(</span><span class="ident" id="7270856">err</span><span class="op" id="7270859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7270862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7270866">r</span><span class="op" id="7270867">.</span><span class="ident" id="7270868">Close</span><span class="op" id="7270873">(</span><span class="op" id="7270874">)</span><br>
<span class="lineno"></span><span class="op" id="7270876">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="7270879">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="7270944">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="7270979">func</span>&nbsp;<span class="ident" id="7270984">TestNullByteSlice</span><span class="op" id="7271001">(</span><span class="ident" id="7271002">t</span>&nbsp;<span class="op" id="7271004">*</span><span class="ident" id="7271005">testing</span><span class="op" id="7271012">.</span><span class="ident" id="7271013">T</span><span class="op" id="7271014">)</span>&nbsp;<span class="op" id="7271016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271019">db</span>&nbsp;<span class="op" id="7271022">:=</span>&nbsp;<span class="ident" id="7271025">newTestDB</span><span class="op" id="7271034">(</span><span class="ident" id="7271035">t</span><span class="op" id="7271036">,</span>&nbsp;<span class="string" id="7271038">&#34;&#34;</span><span class="op" id="7271040">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271043">defer</span>&nbsp;<span class="ident" id="7271049">closeDB</span><span class="op" id="7271056">(</span><span class="ident" id="7271057">t</span><span class="op" id="7271058">,</span>&nbsp;<span class="ident" id="7271060">db</span><span class="op" id="7271062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271065">exec</span><span class="op" id="7271069">(</span><span class="ident" id="7271070">t</span><span class="op" id="7271071">,</span>&nbsp;<span class="ident" id="7271073">db</span><span class="op" id="7271075">,</span>&nbsp;<span class="string" id="7271077">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7271112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271115">exec</span><span class="op" id="7271119">(</span><span class="ident" id="7271120">t</span><span class="op" id="7271121">,</span>&nbsp;<span class="ident" id="7271123">db</span><span class="op" id="7271125">,</span>&nbsp;<span class="string" id="7271127">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7271150">,</span>&nbsp;<span class="ident" id="7271152">nil</span><span class="op" id="7271155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271159">var</span>&nbsp;<span class="ident" id="7271163">name</span>&nbsp;<span class="op" id="7271168">[</span><span class="op" id="7271169">]</span><span class="builtintype" id="7271170">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271177">err</span>&nbsp;<span class="op" id="7271181">:=</span>&nbsp;<span class="ident" id="7271184">db</span><span class="op" id="7271186">.</span><span class="ident" id="7271187">QueryRow</span><span class="op" id="7271195">(</span><span class="string" id="7271196">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7271216">,</span>&nbsp;<span class="num" id="7271218">10</span><span class="op" id="7271220">)</span><span class="op" id="7271221">.</span><span class="ident" id="7271222">Scan</span><span class="op" id="7271226">(</span><span class="op" id="7271227">&amp;</span><span class="ident" id="7271228">name</span><span class="op" id="7271232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271235">if</span>&nbsp;<span class="ident" id="7271238">err</span>&nbsp;<span class="op" id="7271242">!=</span>&nbsp;<span class="ident" id="7271245">nil</span>&nbsp;<span class="op" id="7271249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271253">t</span><span class="op" id="7271254">.</span><span class="ident" id="7271255">Fatal</span><span class="op" id="7271260">(</span><span class="ident" id="7271261">err</span><span class="op" id="7271264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7271267">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271270">if</span>&nbsp;<span class="ident" id="7271273">name</span>&nbsp;<span class="op" id="7271278">!=</span>&nbsp;<span class="ident" id="7271281">nil</span>&nbsp;<span class="op" id="7271285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271289">t</span><span class="op" id="7271290">.</span><span class="ident" id="7271291">Fatalf</span><span class="op" id="7271297">(</span><span class="string" id="7271298">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="7271357">,</span>&nbsp;<span class="ident" id="7271359">name</span><span class="op" id="7271363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7271366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271370">exec</span><span class="op" id="7271374">(</span><span class="ident" id="7271375">t</span><span class="op" id="7271376">,</span>&nbsp;<span class="ident" id="7271378">db</span><span class="op" id="7271380">,</span>&nbsp;<span class="string" id="7271382">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="7271405">,</span>&nbsp;<span class="string" id="7271407">&#34;bob&#34;</span><span class="op" id="7271412">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271415">err</span>&nbsp;<span class="op" id="7271419">=</span>&nbsp;<span class="ident" id="7271421">db</span><span class="op" id="7271423">.</span><span class="ident" id="7271424">QueryRow</span><span class="op" id="7271432">(</span><span class="string" id="7271433">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7271453">,</span>&nbsp;<span class="num" id="7271455">11</span><span class="op" id="7271457">)</span><span class="op" id="7271458">.</span><span class="ident" id="7271459">Scan</span><span class="op" id="7271463">(</span><span class="op" id="7271464">&amp;</span><span class="ident" id="7271465">name</span><span class="op" id="7271469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271472">if</span>&nbsp;<span class="ident" id="7271475">err</span>&nbsp;<span class="op" id="7271479">!=</span>&nbsp;<span class="ident" id="7271482">nil</span>&nbsp;<span class="op" id="7271486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271490">t</span><span class="op" id="7271491">.</span><span class="ident" id="7271492">Fatal</span><span class="op" id="7271497">(</span><span class="ident" id="7271498">err</span><span class="op" id="7271501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7271504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271507">if</span>&nbsp;<span class="builtintype" id="7271510">string</span><span class="op" id="7271516">(</span><span class="ident" id="7271517">name</span><span class="op" id="7271521">)</span>&nbsp;<span class="op" id="7271523">!=</span>&nbsp;<span class="string" id="7271526">&#34;bob&#34;</span>&nbsp;<span class="op" id="7271532">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271536">t</span><span class="op" id="7271537">.</span><span class="ident" id="7271538">Fatalf</span><span class="op" id="7271544">(</span><span class="string" id="7271545">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7271581">,</span>&nbsp;<span class="builtintype" id="7271583">string</span><span class="op" id="7271589">(</span><span class="ident" id="7271590">name</span><span class="op" id="7271594">)</span><span class="op" id="7271595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7271598">}</span><br>
<span class="lineno"></span><span class="op" id="7271600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7271603">func</span>&nbsp;<span class="ident" id="7271608">TestPointerParamsAndScans</span><span class="op" id="7271633">(</span><span class="ident" id="7271634">t</span>&nbsp;<span class="op" id="7271636">*</span><span class="ident" id="7271637">testing</span><span class="op" id="7271644">.</span><span class="ident" id="7271645">T</span><span class="op" id="7271646">)</span>&nbsp;<span class="op" id="7271648">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271651">db</span>&nbsp;<span class="op" id="7271654">:=</span>&nbsp;<span class="ident" id="7271657">newTestDB</span><span class="op" id="7271666">(</span><span class="ident" id="7271667">t</span><span class="op" id="7271668">,</span>&nbsp;<span class="string" id="7271670">&#34;&#34;</span><span class="op" id="7271672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271675">defer</span>&nbsp;<span class="ident" id="7271681">closeDB</span><span class="op" id="7271688">(</span><span class="ident" id="7271689">t</span><span class="op" id="7271690">,</span>&nbsp;<span class="ident" id="7271692">db</span><span class="op" id="7271694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271697">exec</span><span class="op" id="7271701">(</span><span class="ident" id="7271702">t</span><span class="op" id="7271703">,</span>&nbsp;<span class="ident" id="7271705">db</span><span class="op" id="7271707">,</span>&nbsp;<span class="string" id="7271709">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7271744">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271748">bob</span>&nbsp;<span class="op" id="7271752">:=</span>&nbsp;<span class="string" id="7271755">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271762">var</span>&nbsp;<span class="ident" id="7271766">name</span>&nbsp;<span class="op" id="7271771">*</span><span class="builtintype" id="7271772">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271781">name</span>&nbsp;<span class="op" id="7271786">=</span>&nbsp;<span class="op" id="7271788">&amp;</span><span class="ident" id="7271789">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271794">exec</span><span class="op" id="7271798">(</span><span class="ident" id="7271799">t</span><span class="op" id="7271800">,</span>&nbsp;<span class="ident" id="7271802">db</span><span class="op" id="7271804">,</span>&nbsp;<span class="string" id="7271806">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7271829">,</span>&nbsp;<span class="ident" id="7271831">name</span><span class="op" id="7271835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271838">name</span>&nbsp;<span class="op" id="7271843">=</span>&nbsp;<span class="ident" id="7271845">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271850">exec</span><span class="op" id="7271854">(</span><span class="ident" id="7271855">t</span><span class="op" id="7271856">,</span>&nbsp;<span class="ident" id="7271858">db</span><span class="op" id="7271860">,</span>&nbsp;<span class="string" id="7271862">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="7271885">,</span>&nbsp;<span class="ident" id="7271887">name</span><span class="op" id="7271891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271895">err</span>&nbsp;<span class="op" id="7271899">:=</span>&nbsp;<span class="ident" id="7271902">db</span><span class="op" id="7271904">.</span><span class="ident" id="7271905">QueryRow</span><span class="op" id="7271913">(</span><span class="string" id="7271914">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7271934">,</span>&nbsp;<span class="num" id="7271936">10</span><span class="op" id="7271938">)</span><span class="op" id="7271939">.</span><span class="ident" id="7271940">Scan</span><span class="op" id="7271944">(</span><span class="op" id="7271945">&amp;</span><span class="ident" id="7271946">name</span><span class="op" id="7271950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7271953">if</span>&nbsp;<span class="ident" id="7271956">err</span>&nbsp;<span class="op" id="7271960">!=</span>&nbsp;<span class="ident" id="7271963">nil</span>&nbsp;<span class="op" id="7271967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7271971">t</span><span class="op" id="7271972">.</span><span class="ident" id="7271973">Fatalf</span><span class="op" id="7271979">(</span><span class="string" id="7271980">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="7272000">,</span>&nbsp;<span class="ident" id="7272002">err</span><span class="op" id="7272005">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272011">if</span>&nbsp;<span class="ident" id="7272014">name</span>&nbsp;<span class="op" id="7272019">==</span>&nbsp;<span class="ident" id="7272022">nil</span>&nbsp;<span class="op" id="7272026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272030">t</span><span class="op" id="7272031">.</span><span class="ident" id="7272032">Errorf</span><span class="op" id="7272038">(</span><span class="string" id="7272039">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7272069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272072">}</span>&nbsp;<span class="keyword" id="7272074">else</span>&nbsp;<span class="keyword" id="7272079">if</span>&nbsp;<span class="op" id="7272082">*</span><span class="ident" id="7272083">name</span>&nbsp;<span class="op" id="7272088">!=</span>&nbsp;<span class="string" id="7272091">&#34;bob&#34;</span>&nbsp;<span class="op" id="7272097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272101">t</span><span class="op" id="7272102">.</span><span class="ident" id="7272103">Errorf</span><span class="op" id="7272109">(</span><span class="string" id="7272110">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7272139">,</span>&nbsp;<span class="op" id="7272141">*</span><span class="ident" id="7272142">name</span><span class="op" id="7272146">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272153">err</span>&nbsp;<span class="op" id="7272157">=</span>&nbsp;<span class="ident" id="7272159">db</span><span class="op" id="7272161">.</span><span class="ident" id="7272162">QueryRow</span><span class="op" id="7272170">(</span><span class="string" id="7272171">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7272191">,</span>&nbsp;<span class="num" id="7272193">20</span><span class="op" id="7272195">)</span><span class="op" id="7272196">.</span><span class="ident" id="7272197">Scan</span><span class="op" id="7272201">(</span><span class="op" id="7272202">&amp;</span><span class="ident" id="7272203">name</span><span class="op" id="7272207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272210">if</span>&nbsp;<span class="ident" id="7272213">err</span>&nbsp;<span class="op" id="7272217">!=</span>&nbsp;<span class="ident" id="7272220">nil</span>&nbsp;<span class="op" id="7272224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272228">t</span><span class="op" id="7272229">.</span><span class="ident" id="7272230">Fatalf</span><span class="op" id="7272236">(</span><span class="string" id="7272237">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="7272257">,</span>&nbsp;<span class="ident" id="7272259">err</span><span class="op" id="7272262">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272268">if</span>&nbsp;<span class="ident" id="7272271">name</span>&nbsp;<span class="op" id="7272276">!=</span>&nbsp;<span class="ident" id="7272279">nil</span>&nbsp;<span class="op" id="7272283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272287">t</span><span class="op" id="7272288">.</span><span class="ident" id="7272289">Errorf</span><span class="op" id="7272295">(</span><span class="string" id="7272296">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7272318">,</span>&nbsp;<span class="op" id="7272320">*</span><span class="ident" id="7272321">name</span><span class="op" id="7272325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272328">}</span><br>
<span class="lineno"></span><span class="op" id="7272330">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="7272333">func</span>&nbsp;<span class="ident" id="7272338">TestQueryRowClosingStmt</span><span class="op" id="7272361">(</span><span class="ident" id="7272362">t</span>&nbsp;<span class="op" id="7272364">*</span><span class="ident" id="7272365">testing</span><span class="op" id="7272372">.</span><span class="ident" id="7272373">T</span><span class="op" id="7272374">)</span>&nbsp;<span class="op" id="7272376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272379">db</span>&nbsp;<span class="op" id="7272382">:=</span>&nbsp;<span class="ident" id="7272385">newTestDB</span><span class="op" id="7272394">(</span><span class="ident" id="7272395">t</span><span class="op" id="7272396">,</span>&nbsp;<span class="string" id="7272398">&#34;people&#34;</span><span class="op" id="7272406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272409">defer</span>&nbsp;<span class="ident" id="7272415">closeDB</span><span class="op" id="7272422">(</span><span class="ident" id="7272423">t</span><span class="op" id="7272424">,</span>&nbsp;<span class="ident" id="7272426">db</span><span class="op" id="7272428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272431">var</span>&nbsp;<span class="ident" id="7272435">name</span>&nbsp;<span class="builtintype" id="7272440">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272448">var</span>&nbsp;<span class="ident" id="7272452">age</span>&nbsp;<span class="builtintype" id="7272456">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272461">err</span>&nbsp;<span class="op" id="7272465">:=</span>&nbsp;<span class="ident" id="7272468">db</span><span class="op" id="7272470">.</span><span class="ident" id="7272471">QueryRow</span><span class="op" id="7272479">(</span><span class="string" id="7272480">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7272510">,</span>&nbsp;<span class="num" id="7272512">3</span><span class="op" id="7272513">)</span><span class="op" id="7272514">.</span><span class="ident" id="7272515">Scan</span><span class="op" id="7272519">(</span><span class="op" id="7272520">&amp;</span><span class="ident" id="7272521">age</span><span class="op" id="7272524">,</span>&nbsp;<span class="op" id="7272526">&amp;</span><span class="ident" id="7272527">name</span><span class="op" id="7272531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272534">if</span>&nbsp;<span class="ident" id="7272537">err</span>&nbsp;<span class="op" id="7272541">!=</span>&nbsp;<span class="ident" id="7272544">nil</span>&nbsp;<span class="op" id="7272548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272552">t</span><span class="op" id="7272553">.</span><span class="ident" id="7272554">Fatal</span><span class="op" id="7272559">(</span><span class="ident" id="7272560">err</span><span class="op" id="7272563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272566">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272569">if</span>&nbsp;<span class="builtinfunc" id="7272572">len</span><span class="op" id="7272575">(</span><span class="ident" id="7272576">db</span><span class="op" id="7272578">.</span><span class="ident" id="7272579">freeConn</span><span class="op" id="7272587">)</span>&nbsp;<span class="op" id="7272589">!=</span>&nbsp;<span class="num" id="7272592">1</span>&nbsp;<span class="op" id="7272594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272598">t</span><span class="op" id="7272599">.</span><span class="ident" id="7272600">Fatalf</span><span class="op" id="7272606">(</span><span class="string" id="7272607">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="7272629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272635">fakeConn</span>&nbsp;<span class="op" id="7272644">:=</span>&nbsp;<span class="ident" id="7272647">db</span><span class="op" id="7272649">.</span><span class="ident" id="7272650">freeConn</span><span class="op" id="7272658">[</span><span class="num" id="7272659">0</span><span class="op" id="7272660">]</span><span class="op" id="7272661">.</span><span class="ident" id="7272662">ci</span><span class="op" id="7272664">.</span><span class="op" id="7272665">(</span><span class="op" id="7272666">*</span><span class="ident" id="7272667">fakeConn</span><span class="op" id="7272675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272678">if</span>&nbsp;<span class="ident" id="7272681">made</span><span class="op" id="7272685">,</span>&nbsp;<span class="ident" id="7272687">closed</span>&nbsp;<span class="op" id="7272694">:=</span>&nbsp;<span class="ident" id="7272697">fakeConn</span><span class="op" id="7272705">.</span><span class="ident" id="7272706">stmtsMade</span><span class="op" id="7272715">,</span>&nbsp;<span class="ident" id="7272717">fakeConn</span><span class="op" id="7272725">.</span><span class="ident" id="7272726">stmtsClosed</span><span class="op" id="7272737">;</span>&nbsp;<span class="ident" id="7272739">made</span>&nbsp;<span class="op" id="7272744">!=</span>&nbsp;<span class="ident" id="7272747">closed</span>&nbsp;<span class="op" id="7272754">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272758">t</span><span class="op" id="7272759">.</span><span class="ident" id="7272760">Errorf</span><span class="op" id="7272766">(</span><span class="string" id="7272767">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="7272813">,</span>&nbsp;<span class="ident" id="7272815">made</span><span class="op" id="7272819">,</span>&nbsp;<span class="ident" id="7272821">closed</span><span class="op" id="7272827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7272830">}</span><br>
<span class="lineno"></span><span class="op" id="7272832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7272835">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="7272854">func</span>&nbsp;<span class="ident" id="7272859">TestIssue6651</span><span class="op" id="7272872">(</span><span class="ident" id="7272873">t</span>&nbsp;<span class="op" id="7272875">*</span><span class="ident" id="7272876">testing</span><span class="op" id="7272883">.</span><span class="ident" id="7272884">T</span><span class="op" id="7272885">)</span>&nbsp;<span class="op" id="7272887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272890">db</span>&nbsp;<span class="op" id="7272893">:=</span>&nbsp;<span class="ident" id="7272896">newTestDB</span><span class="op" id="7272905">(</span><span class="ident" id="7272906">t</span><span class="op" id="7272907">,</span>&nbsp;<span class="string" id="7272909">&#34;people&#34;</span><span class="op" id="7272917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272920">defer</span>&nbsp;<span class="ident" id="7272926">closeDB</span><span class="op" id="7272933">(</span><span class="ident" id="7272934">t</span><span class="op" id="7272935">,</span>&nbsp;<span class="ident" id="7272937">db</span><span class="op" id="7272939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7272943">var</span>&nbsp;<span class="ident" id="7272947">v</span>&nbsp;<span class="builtintype" id="7272949">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272958">want</span>&nbsp;<span class="op" id="7272963">:=</span>&nbsp;<span class="string" id="7272966">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7272988">rowsCursorNextHook</span>&nbsp;<span class="op" id="7273007">=</span>&nbsp;<span class="keyword" id="7273009">func</span><span class="op" id="7273013">(</span><span class="ident" id="7273014">dest</span>&nbsp;<span class="op" id="7273019">[</span><span class="op" id="7273020">]</span><span class="ident" id="7273021">driver</span><span class="op" id="7273027">.</span><span class="ident" id="7273028">Value</span><span class="op" id="7273033">)</span>&nbsp;<span class="builtintype" id="7273035">error</span>&nbsp;<span class="op" id="7273041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7273045">return</span>&nbsp;<span class="ident" id="7273052">fmt</span><span class="op" id="7273055">.</span><span class="ident" id="7273056">Errorf</span><span class="op" id="7273062">(</span><span class="ident" id="7273063">want</span><span class="op" id="7273067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273070">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7273073">defer</span>&nbsp;<span class="keyword" id="7273079">func</span><span class="op" id="7273083">(</span><span class="op" id="7273084">)</span>&nbsp;<span class="op" id="7273086">{</span>&nbsp;<span class="ident" id="7273088">rowsCursorNextHook</span>&nbsp;<span class="op" id="7273107">=</span>&nbsp;<span class="ident" id="7273109">nil</span>&nbsp;<span class="op" id="7273113">}</span><span class="op" id="7273114">(</span><span class="op" id="7273115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273118">err</span>&nbsp;<span class="op" id="7273122">:=</span>&nbsp;<span class="ident" id="7273125">db</span><span class="op" id="7273127">.</span><span class="ident" id="7273128">QueryRow</span><span class="op" id="7273136">(</span><span class="string" id="7273137">&#34;SELECT|people|name|&#34;</span><span class="op" id="7273158">)</span><span class="op" id="7273159">.</span><span class="ident" id="7273160">Scan</span><span class="op" id="7273164">(</span><span class="op" id="7273165">&amp;</span><span class="ident" id="7273166">v</span><span class="op" id="7273167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7273170">if</span>&nbsp;<span class="ident" id="7273173">err</span>&nbsp;<span class="op" id="7273177">==</span>&nbsp;<span class="ident" id="7273180">nil</span>&nbsp;<span class="op" id="7273184">||</span>&nbsp;<span class="ident" id="7273187">err</span><span class="op" id="7273190">.</span><span class="ident" id="7273191">Error</span><span class="op" id="7273196">(</span><span class="op" id="7273197">)</span>&nbsp;<span class="op" id="7273199">!=</span>&nbsp;<span class="ident" id="7273202">want</span>&nbsp;<span class="op" id="7273207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273211">t</span><span class="op" id="7273212">.</span><span class="ident" id="7273213">Errorf</span><span class="op" id="7273219">(</span><span class="string" id="7273220">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7273241">,</span>&nbsp;<span class="ident" id="7273243">err</span><span class="op" id="7273246">,</span>&nbsp;<span class="ident" id="7273248">want</span><span class="op" id="7273252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273255">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273258">rowsCursorNextHook</span>&nbsp;<span class="op" id="7273277">=</span>&nbsp;<span class="ident" id="7273279">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273285">want</span>&nbsp;<span class="op" id="7273290">=</span>&nbsp;<span class="string" id="7273292">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273315">rowsCloseHook</span>&nbsp;<span class="op" id="7273329">=</span>&nbsp;<span class="keyword" id="7273331">func</span><span class="op" id="7273335">(</span><span class="ident" id="7273336">rows</span>&nbsp;<span class="op" id="7273341">*</span><span class="ident" id="7273342">Rows</span><span class="op" id="7273346">,</span>&nbsp;<span class="ident" id="7273348">err</span>&nbsp;<span class="op" id="7273352">*</span><span class="builtintype" id="7273353">error</span><span class="op" id="7273358">)</span>&nbsp;<span class="op" id="7273360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273364">*</span><span class="ident" id="7273365">err</span>&nbsp;<span class="op" id="7273369">=</span>&nbsp;<span class="ident" id="7273371">fmt</span><span class="op" id="7273374">.</span><span class="ident" id="7273375">Errorf</span><span class="op" id="7273381">(</span><span class="ident" id="7273382">want</span><span class="op" id="7273386">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7273392">defer</span>&nbsp;<span class="keyword" id="7273398">func</span><span class="op" id="7273402">(</span><span class="op" id="7273403">)</span>&nbsp;<span class="op" id="7273405">{</span>&nbsp;<span class="ident" id="7273407">rowsCloseHook</span>&nbsp;<span class="op" id="7273421">=</span>&nbsp;<span class="ident" id="7273423">nil</span>&nbsp;<span class="op" id="7273427">}</span><span class="op" id="7273428">(</span><span class="op" id="7273429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273432">err</span>&nbsp;<span class="op" id="7273436">=</span>&nbsp;<span class="ident" id="7273438">db</span><span class="op" id="7273440">.</span><span class="ident" id="7273441">QueryRow</span><span class="op" id="7273449">(</span><span class="string" id="7273450">&#34;SELECT|people|name|&#34;</span><span class="op" id="7273471">)</span><span class="op" id="7273472">.</span><span class="ident" id="7273473">Scan</span><span class="op" id="7273477">(</span><span class="op" id="7273478">&amp;</span><span class="ident" id="7273479">v</span><span class="op" id="7273480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7273483">if</span>&nbsp;<span class="ident" id="7273486">err</span>&nbsp;<span class="op" id="7273490">==</span>&nbsp;<span class="ident" id="7273493">nil</span>&nbsp;<span class="op" id="7273497">||</span>&nbsp;<span class="ident" id="7273500">err</span><span class="op" id="7273503">.</span><span class="ident" id="7273504">Error</span><span class="op" id="7273509">(</span><span class="op" id="7273510">)</span>&nbsp;<span class="op" id="7273512">!=</span>&nbsp;<span class="ident" id="7273515">want</span>&nbsp;<span class="op" id="7273520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273524">t</span><span class="op" id="7273525">.</span><span class="ident" id="7273526">Errorf</span><span class="op" id="7273532">(</span><span class="string" id="7273533">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7273554">,</span>&nbsp;<span class="ident" id="7273556">err</span><span class="op" id="7273559">,</span>&nbsp;<span class="ident" id="7273561">want</span><span class="op" id="7273565">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273568">}</span><br>
<span class="lineno"></span><span class="op" id="7273570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7273573">type</span>&nbsp;<span class="ident" id="7273578">nullTestRow</span>&nbsp;<span class="keyword" id="7273590">struct</span>&nbsp;<span class="op" id="7273597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273600">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7273613">interface</span><span class="op" id="7273622">{</span><span class="op" id="7273623">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273626">notNullParam</span>&nbsp;<span class="keyword" id="7273639">interface</span><span class="op" id="7273648">{</span><span class="op" id="7273649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273652">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="7273665">interface</span><span class="op" id="7273674">{</span><span class="op" id="7273675">}</span><br>
<span class="lineno"></span><span class="op" id="7273677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7273680">type</span>&nbsp;<span class="ident" id="7273685">nullTestSpec</span>&nbsp;<span class="keyword" id="7273698">struct</span>&nbsp;<span class="op" id="7273705">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273708">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7273720">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273728">notNullType</span>&nbsp;<span class="builtintype" id="7273740">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273748">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273760">[</span><span class="num" id="7273761">6</span><span class="op" id="7273762">]</span><span class="ident" id="7273763">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="7273775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="7273778">func</span>&nbsp;<span class="ident" id="7273783">TestNullStringParam</span><span class="op" id="7273802">(</span><span class="ident" id="7273803">t</span>&nbsp;<span class="op" id="7273805">*</span><span class="ident" id="7273806">testing</span><span class="op" id="7273813">.</span><span class="ident" id="7273814">T</span><span class="op" id="7273815">)</span>&nbsp;<span class="op" id="7273817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7273820">spec</span>&nbsp;<span class="op" id="7273825">:=</span>&nbsp;<span class="ident" id="7273828">nullTestSpec</span><span class="op" id="7273840">{</span><span class="string" id="7273841">&#34;nullstring&#34;</span><span class="op" id="7273853">,</span>&nbsp;<span class="string" id="7273855">&#34;string&#34;</span><span class="op" id="7273863">,</span>&nbsp;<span class="op" id="7273865">[</span><span class="num" id="7273866">6</span><span class="op" id="7273867">]</span><span class="ident" id="7273868">nullTestRow</span><span class="op" id="7273879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273883">{</span><span class="ident" id="7273884">NullString</span><span class="op" id="7273894">{</span><span class="string" id="7273895">&#34;aqua&#34;</span><span class="op" id="7273901">,</span>&nbsp;<span class="builtintype" id="7273903">true</span><span class="op" id="7273907">}</span><span class="op" id="7273908">,</span>&nbsp;<span class="string" id="7273910">&#34;&#34;</span><span class="op" id="7273912">,</span>&nbsp;<span class="ident" id="7273914">NullString</span><span class="op" id="7273924">{</span><span class="string" id="7273925">&#34;aqua&#34;</span><span class="op" id="7273931">,</span>&nbsp;<span class="builtintype" id="7273933">true</span><span class="op" id="7273937">}</span><span class="op" id="7273938">}</span><span class="op" id="7273939">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7273943">{</span><span class="ident" id="7273944">NullString</span><span class="op" id="7273954">{</span><span class="string" id="7273955">&#34;brown&#34;</span><span class="op" id="7273962">,</span>&nbsp;<span class="builtintype" id="7273964">false</span><span class="op" id="7273969">}</span><span class="op" id="7273970">,</span>&nbsp;<span class="string" id="7273972">&#34;&#34;</span><span class="op" id="7273974">,</span>&nbsp;<span class="ident" id="7273976">NullString</span><span class="op" id="7273986">{</span><span class="string" id="7273987">&#34;&#34;</span><span class="op" id="7273989">,</span>&nbsp;<span class="builtintype" id="7273991">false</span><span class="op" id="7273996">}</span><span class="op" id="7273997">}</span><span class="op" id="7273998">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274002">{</span><span class="string" id="7274003">&#34;chartreuse&#34;</span><span class="op" id="7274015">,</span>&nbsp;<span class="string" id="7274017">&#34;&#34;</span><span class="op" id="7274019">,</span>&nbsp;<span class="ident" id="7274021">NullString</span><span class="op" id="7274031">{</span><span class="string" id="7274032">&#34;chartreuse&#34;</span><span class="op" id="7274044">,</span>&nbsp;<span class="builtintype" id="7274046">true</span><span class="op" id="7274050">}</span><span class="op" id="7274051">}</span><span class="op" id="7274052">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274056">{</span><span class="ident" id="7274057">NullString</span><span class="op" id="7274067">{</span><span class="string" id="7274068">&#34;darkred&#34;</span><span class="op" id="7274077">,</span>&nbsp;<span class="builtintype" id="7274079">true</span><span class="op" id="7274083">}</span><span class="op" id="7274084">,</span>&nbsp;<span class="string" id="7274086">&#34;&#34;</span><span class="op" id="7274088">,</span>&nbsp;<span class="ident" id="7274090">NullString</span><span class="op" id="7274100">{</span><span class="string" id="7274101">&#34;darkred&#34;</span><span class="op" id="7274110">,</span>&nbsp;<span class="builtintype" id="7274112">true</span><span class="op" id="7274116">}</span><span class="op" id="7274117">}</span><span class="op" id="7274118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274122">{</span><span class="ident" id="7274123">NullString</span><span class="op" id="7274133">{</span><span class="string" id="7274134">&#34;eel&#34;</span><span class="op" id="7274139">,</span>&nbsp;<span class="builtintype" id="7274141">false</span><span class="op" id="7274146">}</span><span class="op" id="7274147">,</span>&nbsp;<span class="string" id="7274149">&#34;&#34;</span><span class="op" id="7274151">,</span>&nbsp;<span class="ident" id="7274153">NullString</span><span class="op" id="7274163">{</span><span class="string" id="7274164">&#34;&#34;</span><span class="op" id="7274166">,</span>&nbsp;<span class="builtintype" id="7274168">false</span><span class="op" id="7274173">}</span><span class="op" id="7274174">}</span><span class="op" id="7274175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274179">{</span><span class="string" id="7274180">&#34;foo&#34;</span><span class="op" id="7274185">,</span>&nbsp;<span class="ident" id="7274187">NullString</span><span class="op" id="7274197">{</span><span class="string" id="7274198">&#34;black&#34;</span><span class="op" id="7274205">,</span>&nbsp;<span class="builtintype" id="7274207">false</span><span class="op" id="7274212">}</span><span class="op" id="7274213">,</span>&nbsp;<span class="ident" id="7274215">nil</span><span class="op" id="7274218">}</span><span class="op" id="7274219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274222">}</span><span class="op" id="7274223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7274226">nullTestRun</span><span class="op" id="7274237">(</span><span class="ident" id="7274238">t</span><span class="op" id="7274239">,</span>&nbsp;<span class="ident" id="7274241">spec</span><span class="op" id="7274245">)</span><br>
<span class="lineno">750</span><span class="op" id="7274247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7274250">func</span>&nbsp;<span class="ident" id="7274255">TestNullInt64Param</span><span class="op" id="7274273">(</span><span class="ident" id="7274274">t</span>&nbsp;<span class="op" id="7274276">*</span><span class="ident" id="7274277">testing</span><span class="op" id="7274284">.</span><span class="ident" id="7274285">T</span><span class="op" id="7274286">)</span>&nbsp;<span class="op" id="7274288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7274291">spec</span>&nbsp;<span class="op" id="7274296">:=</span>&nbsp;<span class="ident" id="7274299">nullTestSpec</span><span class="op" id="7274311">{</span><span class="string" id="7274312">&#34;nullint64&#34;</span><span class="op" id="7274323">,</span>&nbsp;<span class="string" id="7274325">&#34;int64&#34;</span><span class="op" id="7274332">,</span>&nbsp;<span class="op" id="7274334">[</span><span class="num" id="7274335">6</span><span class="op" id="7274336">]</span><span class="ident" id="7274337">nullTestRow</span><span class="op" id="7274348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274352">{</span><span class="ident" id="7274353">NullInt64</span><span class="op" id="7274362">{</span><span class="num" id="7274363">31</span><span class="op" id="7274365">,</span>&nbsp;<span class="builtintype" id="7274367">true</span><span class="op" id="7274371">}</span><span class="op" id="7274372">,</span>&nbsp;<span class="num" id="7274374">1</span><span class="op" id="7274375">,</span>&nbsp;<span class="ident" id="7274377">NullInt64</span><span class="op" id="7274386">{</span><span class="num" id="7274387">31</span><span class="op" id="7274389">,</span>&nbsp;<span class="builtintype" id="7274391">true</span><span class="op" id="7274395">}</span><span class="op" id="7274396">}</span><span class="op" id="7274397">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274401">{</span><span class="ident" id="7274402">NullInt64</span><span class="op" id="7274411">{</span><span class="op" id="7274412">-</span><span class="num" id="7274413">22</span><span class="op" id="7274415">,</span>&nbsp;<span class="builtintype" id="7274417">false</span><span class="op" id="7274422">}</span><span class="op" id="7274423">,</span>&nbsp;<span class="num" id="7274425">1</span><span class="op" id="7274426">,</span>&nbsp;<span class="ident" id="7274428">NullInt64</span><span class="op" id="7274437">{</span><span class="num" id="7274438">0</span><span class="op" id="7274439">,</span>&nbsp;<span class="builtintype" id="7274441">false</span><span class="op" id="7274446">}</span><span class="op" id="7274447">}</span><span class="op" id="7274448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274452">{</span><span class="num" id="7274453">22</span><span class="op" id="7274455">,</span>&nbsp;<span class="num" id="7274457">1</span><span class="op" id="7274458">,</span>&nbsp;<span class="ident" id="7274460">NullInt64</span><span class="op" id="7274469">{</span><span class="num" id="7274470">22</span><span class="op" id="7274472">,</span>&nbsp;<span class="builtintype" id="7274474">true</span><span class="op" id="7274478">}</span><span class="op" id="7274479">}</span><span class="op" id="7274480">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274484">{</span><span class="ident" id="7274485">NullInt64</span><span class="op" id="7274494">{</span><span class="num" id="7274495">33</span><span class="op" id="7274497">,</span>&nbsp;<span class="builtintype" id="7274499">true</span><span class="op" id="7274503">}</span><span class="op" id="7274504">,</span>&nbsp;<span class="num" id="7274506">1</span><span class="op" id="7274507">,</span>&nbsp;<span class="ident" id="7274509">NullInt64</span><span class="op" id="7274518">{</span><span class="num" id="7274519">33</span><span class="op" id="7274521">,</span>&nbsp;<span class="builtintype" id="7274523">true</span><span class="op" id="7274527">}</span><span class="op" id="7274528">}</span><span class="op" id="7274529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274533">{</span><span class="ident" id="7274534">NullInt64</span><span class="op" id="7274543">{</span><span class="num" id="7274544">222</span><span class="op" id="7274547">,</span>&nbsp;<span class="builtintype" id="7274549">false</span><span class="op" id="7274554">}</span><span class="op" id="7274555">,</span>&nbsp;<span class="num" id="7274557">1</span><span class="op" id="7274558">,</span>&nbsp;<span class="ident" id="7274560">NullInt64</span><span class="op" id="7274569">{</span><span class="num" id="7274570">0</span><span class="op" id="7274571">,</span>&nbsp;<span class="builtintype" id="7274573">false</span><span class="op" id="7274578">}</span><span class="op" id="7274579">}</span><span class="op" id="7274580">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274584">{</span><span class="num" id="7274585">0</span><span class="op" id="7274586">,</span>&nbsp;<span class="ident" id="7274588">NullInt64</span><span class="op" id="7274597">{</span><span class="num" id="7274598">31</span><span class="op" id="7274600">,</span>&nbsp;<span class="builtintype" id="7274602">false</span><span class="op" id="7274607">}</span><span class="op" id="7274608">,</span>&nbsp;<span class="ident" id="7274610">nil</span><span class="op" id="7274613">}</span><span class="op" id="7274614">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274617">}</span><span class="op" id="7274618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7274621">nullTestRun</span><span class="op" id="7274632">(</span><span class="ident" id="7274633">t</span><span class="op" id="7274634">,</span>&nbsp;<span class="ident" id="7274636">spec</span><span class="op" id="7274640">)</span><br>
<span class="lineno"></span><span class="op" id="7274642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7274645">func</span>&nbsp;<span class="ident" id="7274650">TestNullFloat64Param</span><span class="op" id="7274670">(</span><span class="ident" id="7274671">t</span>&nbsp;<span class="op" id="7274673">*</span><span class="ident" id="7274674">testing</span><span class="op" id="7274681">.</span><span class="ident" id="7274682">T</span><span class="op" id="7274683">)</span>&nbsp;<span class="op" id="7274685">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7274688">spec</span>&nbsp;<span class="op" id="7274693">:=</span>&nbsp;<span class="ident" id="7274696">nullTestSpec</span><span class="op" id="7274708">{</span><span class="string" id="7274709">&#34;nullfloat64&#34;</span><span class="op" id="7274722">,</span>&nbsp;<span class="string" id="7274724">&#34;float64&#34;</span><span class="op" id="7274733">,</span>&nbsp;<span class="op" id="7274735">[</span><span class="num" id="7274736">6</span><span class="op" id="7274737">]</span><span class="ident" id="7274738">nullTestRow</span><span class="op" id="7274749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274753">{</span><span class="ident" id="7274754">NullFloat64</span><span class="op" id="7274765">{</span><span class="num" id="7274766">31.2</span><span class="op" id="7274770">,</span>&nbsp;<span class="builtintype" id="7274772">true</span><span class="op" id="7274776">}</span><span class="op" id="7274777">,</span>&nbsp;<span class="num" id="7274779">1</span><span class="op" id="7274780">,</span>&nbsp;<span class="ident" id="7274782">NullFloat64</span><span class="op" id="7274793">{</span><span class="num" id="7274794">31.2</span><span class="op" id="7274798">,</span>&nbsp;<span class="builtintype" id="7274800">true</span><span class="op" id="7274804">}</span><span class="op" id="7274805">}</span><span class="op" id="7274806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274810">{</span><span class="ident" id="7274811">NullFloat64</span><span class="op" id="7274822">{</span><span class="num" id="7274823">13.1</span><span class="op" id="7274827">,</span>&nbsp;<span class="builtintype" id="7274829">false</span><span class="op" id="7274834">}</span><span class="op" id="7274835">,</span>&nbsp;<span class="num" id="7274837">1</span><span class="op" id="7274838">,</span>&nbsp;<span class="ident" id="7274840">NullFloat64</span><span class="op" id="7274851">{</span><span class="num" id="7274852">0</span><span class="op" id="7274853">,</span>&nbsp;<span class="builtintype" id="7274855">false</span><span class="op" id="7274860">}</span><span class="op" id="7274861">}</span><span class="op" id="7274862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274866">{</span><span class="op" id="7274867">-</span><span class="num" id="7274868">22.9</span><span class="op" id="7274872">,</span>&nbsp;<span class="num" id="7274874">1</span><span class="op" id="7274875">,</span>&nbsp;<span class="ident" id="7274877">NullFloat64</span><span class="op" id="7274888">{</span><span class="op" id="7274889">-</span><span class="num" id="7274890">22.9</span><span class="op" id="7274894">,</span>&nbsp;<span class="builtintype" id="7274896">true</span><span class="op" id="7274900">}</span><span class="op" id="7274901">}</span><span class="op" id="7274902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274906">{</span><span class="ident" id="7274907">NullFloat64</span><span class="op" id="7274918">{</span><span class="num" id="7274919">33.81</span><span class="op" id="7274924">,</span>&nbsp;<span class="builtintype" id="7274926">true</span><span class="op" id="7274930">}</span><span class="op" id="7274931">,</span>&nbsp;<span class="num" id="7274933">1</span><span class="op" id="7274934">,</span>&nbsp;<span class="ident" id="7274936">NullFloat64</span><span class="op" id="7274947">{</span><span class="num" id="7274948">33.81</span><span class="op" id="7274953">,</span>&nbsp;<span class="builtintype" id="7274955">true</span><span class="op" id="7274959">}</span><span class="op" id="7274960">}</span><span class="op" id="7274961">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7274965">{</span><span class="ident" id="7274966">NullFloat64</span><span class="op" id="7274977">{</span><span class="num" id="7274978">222</span><span class="op" id="7274981">,</span>&nbsp;<span class="builtintype" id="7274983">false</span><span class="op" id="7274988">}</span><span class="op" id="7274989">,</span>&nbsp;<span class="num" id="7274991">1</span><span class="op" id="7274992">,</span>&nbsp;<span class="ident" id="7274994">NullFloat64</span><span class="op" id="7275005">{</span><span class="num" id="7275006">0</span><span class="op" id="7275007">,</span>&nbsp;<span class="builtintype" id="7275009">false</span><span class="op" id="7275014">}</span><span class="op" id="7275015">}</span><span class="op" id="7275016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275020">{</span><span class="num" id="7275021">10</span><span class="op" id="7275023">,</span>&nbsp;<span class="ident" id="7275025">NullFloat64</span><span class="op" id="7275036">{</span><span class="num" id="7275037">31.2</span><span class="op" id="7275041">,</span>&nbsp;<span class="builtintype" id="7275043">false</span><span class="op" id="7275048">}</span><span class="op" id="7275049">,</span>&nbsp;<span class="ident" id="7275051">nil</span><span class="op" id="7275054">}</span><span class="op" id="7275055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275058">}</span><span class="op" id="7275059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275062">nullTestRun</span><span class="op" id="7275073">(</span><span class="ident" id="7275074">t</span><span class="op" id="7275075">,</span>&nbsp;<span class="ident" id="7275077">spec</span><span class="op" id="7275081">)</span><br>
<span class="lineno"></span><span class="op" id="7275083">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="7275086">func</span>&nbsp;<span class="ident" id="7275091">TestNullBoolParam</span><span class="op" id="7275108">(</span><span class="ident" id="7275109">t</span>&nbsp;<span class="op" id="7275111">*</span><span class="ident" id="7275112">testing</span><span class="op" id="7275119">.</span><span class="ident" id="7275120">T</span><span class="op" id="7275121">)</span>&nbsp;<span class="op" id="7275123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275126">spec</span>&nbsp;<span class="op" id="7275131">:=</span>&nbsp;<span class="ident" id="7275134">nullTestSpec</span><span class="op" id="7275146">{</span><span class="string" id="7275147">&#34;nullbool&#34;</span><span class="op" id="7275157">,</span>&nbsp;<span class="string" id="7275159">&#34;bool&#34;</span><span class="op" id="7275165">,</span>&nbsp;<span class="op" id="7275167">[</span><span class="num" id="7275168">6</span><span class="op" id="7275169">]</span><span class="ident" id="7275170">nullTestRow</span><span class="op" id="7275181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275185">{</span><span class="ident" id="7275186">NullBool</span><span class="op" id="7275194">{</span><span class="builtintype" id="7275195">false</span><span class="op" id="7275200">,</span>&nbsp;<span class="builtintype" id="7275202">true</span><span class="op" id="7275206">}</span><span class="op" id="7275207">,</span>&nbsp;<span class="builtintype" id="7275209">true</span><span class="op" id="7275213">,</span>&nbsp;<span class="ident" id="7275215">NullBool</span><span class="op" id="7275223">{</span><span class="builtintype" id="7275224">false</span><span class="op" id="7275229">,</span>&nbsp;<span class="builtintype" id="7275231">true</span><span class="op" id="7275235">}</span><span class="op" id="7275236">}</span><span class="op" id="7275237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275241">{</span><span class="ident" id="7275242">NullBool</span><span class="op" id="7275250">{</span><span class="builtintype" id="7275251">true</span><span class="op" id="7275255">,</span>&nbsp;<span class="builtintype" id="7275257">false</span><span class="op" id="7275262">}</span><span class="op" id="7275263">,</span>&nbsp;<span class="builtintype" id="7275265">false</span><span class="op" id="7275270">,</span>&nbsp;<span class="ident" id="7275272">NullBool</span><span class="op" id="7275280">{</span><span class="builtintype" id="7275281">false</span><span class="op" id="7275286">,</span>&nbsp;<span class="builtintype" id="7275288">false</span><span class="op" id="7275293">}</span><span class="op" id="7275294">}</span><span class="op" id="7275295">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275299">{</span><span class="builtintype" id="7275300">true</span><span class="op" id="7275304">,</span>&nbsp;<span class="builtintype" id="7275306">true</span><span class="op" id="7275310">,</span>&nbsp;<span class="ident" id="7275312">NullBool</span><span class="op" id="7275320">{</span><span class="builtintype" id="7275321">true</span><span class="op" id="7275325">,</span>&nbsp;<span class="builtintype" id="7275327">true</span><span class="op" id="7275331">}</span><span class="op" id="7275332">}</span><span class="op" id="7275333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275337">{</span><span class="ident" id="7275338">NullBool</span><span class="op" id="7275346">{</span><span class="builtintype" id="7275347">true</span><span class="op" id="7275351">,</span>&nbsp;<span class="builtintype" id="7275353">true</span><span class="op" id="7275357">}</span><span class="op" id="7275358">,</span>&nbsp;<span class="builtintype" id="7275360">false</span><span class="op" id="7275365">,</span>&nbsp;<span class="ident" id="7275367">NullBool</span><span class="op" id="7275375">{</span><span class="builtintype" id="7275376">true</span><span class="op" id="7275380">,</span>&nbsp;<span class="builtintype" id="7275382">true</span><span class="op" id="7275386">}</span><span class="op" id="7275387">}</span><span class="op" id="7275388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275392">{</span><span class="ident" id="7275393">NullBool</span><span class="op" id="7275401">{</span><span class="builtintype" id="7275402">true</span><span class="op" id="7275406">,</span>&nbsp;<span class="builtintype" id="7275408">false</span><span class="op" id="7275413">}</span><span class="op" id="7275414">,</span>&nbsp;<span class="builtintype" id="7275416">true</span><span class="op" id="7275420">,</span>&nbsp;<span class="ident" id="7275422">NullBool</span><span class="op" id="7275430">{</span><span class="builtintype" id="7275431">false</span><span class="op" id="7275436">,</span>&nbsp;<span class="builtintype" id="7275438">false</span><span class="op" id="7275443">}</span><span class="op" id="7275444">}</span><span class="op" id="7275445">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275449">{</span><span class="builtintype" id="7275450">true</span><span class="op" id="7275454">,</span>&nbsp;<span class="ident" id="7275456">NullBool</span><span class="op" id="7275464">{</span><span class="builtintype" id="7275465">true</span><span class="op" id="7275469">,</span>&nbsp;<span class="builtintype" id="7275471">false</span><span class="op" id="7275476">}</span><span class="op" id="7275477">,</span>&nbsp;<span class="ident" id="7275479">nil</span><span class="op" id="7275482">}</span><span class="op" id="7275483">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7275486">}</span><span class="op" id="7275487">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275490">nullTestRun</span><span class="op" id="7275501">(</span><span class="ident" id="7275502">t</span><span class="op" id="7275503">,</span>&nbsp;<span class="ident" id="7275505">spec</span><span class="op" id="7275509">)</span><br>
<span class="lineno"></span><span class="op" id="7275511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7275514">func</span>&nbsp;<span class="ident" id="7275519">nullTestRun</span><span class="op" id="7275530">(</span><span class="ident" id="7275531">t</span>&nbsp;<span class="op" id="7275533">*</span><span class="ident" id="7275534">testing</span><span class="op" id="7275541">.</span><span class="ident" id="7275542">T</span><span class="op" id="7275543">,</span>&nbsp;<span class="ident" id="7275545">spec</span>&nbsp;<span class="ident" id="7275550">nullTestSpec</span><span class="op" id="7275562">)</span>&nbsp;<span class="op" id="7275564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275567">db</span>&nbsp;<span class="op" id="7275570">:=</span>&nbsp;<span class="ident" id="7275573">newTestDB</span><span class="op" id="7275582">(</span><span class="ident" id="7275583">t</span><span class="op" id="7275584">,</span>&nbsp;<span class="string" id="7275586">&#34;&#34;</span><span class="op" id="7275588">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7275591">defer</span>&nbsp;<span class="ident" id="7275597">closeDB</span><span class="op" id="7275604">(</span><span class="ident" id="7275605">t</span><span class="op" id="7275606">,</span>&nbsp;<span class="ident" id="7275608">db</span><span class="op" id="7275610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275613">exec</span><span class="op" id="7275617">(</span><span class="ident" id="7275618">t</span><span class="op" id="7275619">,</span>&nbsp;<span class="ident" id="7275621">db</span><span class="op" id="7275623">,</span>&nbsp;<span class="ident" id="7275625">fmt</span><span class="op" id="7275628">.</span><span class="ident" id="7275629">Sprintf</span><span class="op" id="7275636">(</span><span class="string" id="7275637">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="7275689">,</span>&nbsp;<span class="ident" id="7275691">spec</span><span class="op" id="7275695">.</span><span class="ident" id="7275696">nullType</span><span class="op" id="7275704">,</span>&nbsp;<span class="ident" id="7275706">spec</span><span class="op" id="7275710">.</span><span class="ident" id="7275711">notNullType</span><span class="op" id="7275722">)</span><span class="op" id="7275723">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7275727">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275753">exec</span><span class="op" id="7275757">(</span><span class="ident" id="7275758">t</span><span class="op" id="7275759">,</span>&nbsp;<span class="ident" id="7275761">db</span><span class="op" id="7275763">,</span>&nbsp;<span class="string" id="7275765">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7275806">,</span>&nbsp;<span class="num" id="7275808">1</span><span class="op" id="7275809">,</span>&nbsp;<span class="string" id="7275811">&#34;alice&#34;</span><span class="op" id="7275818">,</span>&nbsp;<span class="ident" id="7275820">spec</span><span class="op" id="7275824">.</span><span class="ident" id="7275825">rows</span><span class="op" id="7275829">[</span><span class="num" id="7275830">0</span><span class="op" id="7275831">]</span><span class="op" id="7275832">.</span><span class="ident" id="7275833">nullParam</span><span class="op" id="7275842">,</span>&nbsp;<span class="ident" id="7275844">spec</span><span class="op" id="7275848">.</span><span class="ident" id="7275849">rows</span><span class="op" id="7275853">[</span><span class="num" id="7275854">0</span><span class="op" id="7275855">]</span><span class="op" id="7275856">.</span><span class="ident" id="7275857">notNullParam</span><span class="op" id="7275869">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7275872">exec</span><span class="op" id="7275876">(</span><span class="ident" id="7275877">t</span><span class="op" id="7275878">,</span>&nbsp;<span class="ident" id="7275880">db</span><span class="op" id="7275882">,</span>&nbsp;<span class="string" id="7275884">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7275925">,</span>&nbsp;<span class="num" id="7275927">2</span><span class="op" id="7275928">,</span>&nbsp;<span class="string" id="7275930">&#34;bob&#34;</span><span class="op" id="7275935">,</span>&nbsp;<span class="ident" id="7275937">spec</span><span class="op" id="7275941">.</span><span class="ident" id="7275942">rows</span><span class="op" id="7275946">[</span><span class="num" id="7275947">1</span><span class="op" id="7275948">]</span><span class="op" id="7275949">.</span><span class="ident" id="7275950">nullParam</span><span class="op" id="7275959">,</span>&nbsp;<span class="ident" id="7275961">spec</span><span class="op" id="7275965">.</span><span class="ident" id="7275966">rows</span><span class="op" id="7275970">[</span><span class="num" id="7275971">1</span><span class="op" id="7275972">]</span><span class="op" id="7275973">.</span><span class="ident" id="7275974">notNullParam</span><span class="op" id="7275986">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7275990">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276029">stmt</span><span class="op" id="7276033">,</span>&nbsp;<span class="ident" id="7276035">err</span>&nbsp;<span class="op" id="7276039">:=</span>&nbsp;<span class="ident" id="7276042">db</span><span class="op" id="7276044">.</span><span class="ident" id="7276045">Prepare</span><span class="op" id="7276052">(</span><span class="string" id="7276053">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7276094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276097">if</span>&nbsp;<span class="ident" id="7276100">err</span>&nbsp;<span class="op" id="7276104">!=</span>&nbsp;<span class="ident" id="7276107">nil</span>&nbsp;<span class="op" id="7276111">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276115">t</span><span class="op" id="7276116">.</span><span class="ident" id="7276117">Fatalf</span><span class="op" id="7276123">(</span><span class="string" id="7276124">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7276137">,</span>&nbsp;<span class="ident" id="7276139">err</span><span class="op" id="7276142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7276145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276148">defer</span>&nbsp;<span class="ident" id="7276154">stmt</span><span class="op" id="7276158">.</span><span class="ident" id="7276159">Close</span><span class="op" id="7276164">(</span><span class="op" id="7276165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276168">if</span>&nbsp;<span class="ident" id="7276171">_</span><span class="op" id="7276172">,</span>&nbsp;<span class="ident" id="7276174">err</span>&nbsp;<span class="op" id="7276178">:=</span>&nbsp;<span class="ident" id="7276181">stmt</span><span class="op" id="7276185">.</span><span class="ident" id="7276186">Exec</span><span class="op" id="7276190">(</span><span class="num" id="7276191">3</span><span class="op" id="7276192">,</span>&nbsp;<span class="string" id="7276194">&#34;chris&#34;</span><span class="op" id="7276201">,</span>&nbsp;<span class="ident" id="7276203">spec</span><span class="op" id="7276207">.</span><span class="ident" id="7276208">rows</span><span class="op" id="7276212">[</span><span class="num" id="7276213">2</span><span class="op" id="7276214">]</span><span class="op" id="7276215">.</span><span class="ident" id="7276216">nullParam</span><span class="op" id="7276225">,</span>&nbsp;<span class="ident" id="7276227">spec</span><span class="op" id="7276231">.</span><span class="ident" id="7276232">rows</span><span class="op" id="7276236">[</span><span class="num" id="7276237">2</span><span class="op" id="7276238">]</span><span class="op" id="7276239">.</span><span class="ident" id="7276240">notNullParam</span><span class="op" id="7276252">)</span><span class="op" id="7276253">;</span>&nbsp;<span class="ident" id="7276255">err</span>&nbsp;<span class="op" id="7276259">!=</span>&nbsp;<span class="ident" id="7276262">nil</span>&nbsp;<span class="op" id="7276266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276270">t</span><span class="op" id="7276271">.</span><span class="ident" id="7276272">Errorf</span><span class="op" id="7276278">(</span><span class="string" id="7276279">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="7276302">,</span>&nbsp;<span class="ident" id="7276304">err</span><span class="op" id="7276307">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7276310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276313">if</span>&nbsp;<span class="ident" id="7276316">_</span><span class="op" id="7276317">,</span>&nbsp;<span class="ident" id="7276319">err</span>&nbsp;<span class="op" id="7276323">:=</span>&nbsp;<span class="ident" id="7276326">stmt</span><span class="op" id="7276330">.</span><span class="ident" id="7276331">Exec</span><span class="op" id="7276335">(</span><span class="num" id="7276336">4</span><span class="op" id="7276337">,</span>&nbsp;<span class="string" id="7276339">&#34;dave&#34;</span><span class="op" id="7276345">,</span>&nbsp;<span class="ident" id="7276347">spec</span><span class="op" id="7276351">.</span><span class="ident" id="7276352">rows</span><span class="op" id="7276356">[</span><span class="num" id="7276357">3</span><span class="op" id="7276358">]</span><span class="op" id="7276359">.</span><span class="ident" id="7276360">nullParam</span><span class="op" id="7276369">,</span>&nbsp;<span class="ident" id="7276371">spec</span><span class="op" id="7276375">.</span><span class="ident" id="7276376">rows</span><span class="op" id="7276380">[</span><span class="num" id="7276381">3</span><span class="op" id="7276382">]</span><span class="op" id="7276383">.</span><span class="ident" id="7276384">notNullParam</span><span class="op" id="7276396">)</span><span class="op" id="7276397">;</span>&nbsp;<span class="ident" id="7276399">err</span>&nbsp;<span class="op" id="7276403">!=</span>&nbsp;<span class="ident" id="7276406">nil</span>&nbsp;<span class="op" id="7276410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276414">t</span><span class="op" id="7276415">.</span><span class="ident" id="7276416">Errorf</span><span class="op" id="7276422">(</span><span class="string" id="7276423">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="7276445">,</span>&nbsp;<span class="ident" id="7276447">err</span><span class="op" id="7276450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7276453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276456">if</span>&nbsp;<span class="ident" id="7276459">_</span><span class="op" id="7276460">,</span>&nbsp;<span class="ident" id="7276462">err</span>&nbsp;<span class="op" id="7276466">:=</span>&nbsp;<span class="ident" id="7276469">stmt</span><span class="op" id="7276473">.</span><span class="ident" id="7276474">Exec</span><span class="op" id="7276478">(</span><span class="num" id="7276479">5</span><span class="op" id="7276480">,</span>&nbsp;<span class="string" id="7276482">&#34;eleanor&#34;</span><span class="op" id="7276491">,</span>&nbsp;<span class="ident" id="7276493">spec</span><span class="op" id="7276497">.</span><span class="ident" id="7276498">rows</span><span class="op" id="7276502">[</span><span class="num" id="7276503">4</span><span class="op" id="7276504">]</span><span class="op" id="7276505">.</span><span class="ident" id="7276506">nullParam</span><span class="op" id="7276515">,</span>&nbsp;<span class="ident" id="7276517">spec</span><span class="op" id="7276521">.</span><span class="ident" id="7276522">rows</span><span class="op" id="7276526">[</span><span class="num" id="7276527">4</span><span class="op" id="7276528">]</span><span class="op" id="7276529">.</span><span class="ident" id="7276530">notNullParam</span><span class="op" id="7276542">)</span><span class="op" id="7276543">;</span>&nbsp;<span class="ident" id="7276545">err</span>&nbsp;<span class="op" id="7276549">!=</span>&nbsp;<span class="ident" id="7276552">nil</span>&nbsp;<span class="op" id="7276556">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276560">t</span><span class="op" id="7276561">.</span><span class="ident" id="7276562">Errorf</span><span class="op" id="7276568">(</span><span class="string" id="7276569">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="7276594">,</span>&nbsp;<span class="ident" id="7276596">err</span><span class="op" id="7276599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7276602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7276606">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276647">if</span>&nbsp;<span class="ident" id="7276650">_</span><span class="op" id="7276651">,</span>&nbsp;<span class="ident" id="7276653">err</span>&nbsp;<span class="op" id="7276657">:=</span>&nbsp;<span class="ident" id="7276660">stmt</span><span class="op" id="7276664">.</span><span class="ident" id="7276665">Exec</span><span class="op" id="7276669">(</span><span class="num" id="7276670">6</span><span class="op" id="7276671">,</span>&nbsp;<span class="string" id="7276673">&#34;bob&#34;</span><span class="op" id="7276678">,</span>&nbsp;<span class="ident" id="7276680">spec</span><span class="op" id="7276684">.</span><span class="ident" id="7276685">rows</span><span class="op" id="7276689">[</span><span class="num" id="7276690">5</span><span class="op" id="7276691">]</span><span class="op" id="7276692">.</span><span class="ident" id="7276693">nullParam</span><span class="op" id="7276702">,</span>&nbsp;<span class="ident" id="7276704">spec</span><span class="op" id="7276708">.</span><span class="ident" id="7276709">rows</span><span class="op" id="7276713">[</span><span class="num" id="7276714">5</span><span class="op" id="7276715">]</span><span class="op" id="7276716">.</span><span class="ident" id="7276717">notNullParam</span><span class="op" id="7276729">)</span><span class="op" id="7276730">;</span>&nbsp;<span class="ident" id="7276732">err</span>&nbsp;<span class="op" id="7276736">==</span>&nbsp;<span class="ident" id="7276739">nil</span>&nbsp;<span class="op" id="7276743">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276747">t</span><span class="op" id="7276748">.</span><span class="ident" id="7276749">Errorf</span><span class="op" id="7276755">(</span><span class="string" id="7276756">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="7276819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7276822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7276826">_</span><span class="op" id="7276827">,</span>&nbsp;<span class="ident" id="7276829">err</span>&nbsp;<span class="op" id="7276833">=</span>&nbsp;<span class="ident" id="7276835">db</span><span class="op" id="7276837">.</span><span class="ident" id="7276838">Exec</span><span class="op" id="7276842">(</span><span class="string" id="7276843">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="7276873">,</span>&nbsp;<span class="num" id="7276875">999</span><span class="op" id="7276878">,</span>&nbsp;<span class="ident" id="7276880">nil</span><span class="op" id="7276883">,</span>&nbsp;<span class="ident" id="7276885">nil</span><span class="op" id="7276888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7276891">if</span>&nbsp;<span class="ident" id="7276894">err</span>&nbsp;<span class="op" id="7276898">==</span>&nbsp;<span class="ident" id="7276901">nil</span>&nbsp;<span class="op" id="7276905">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7276909">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7276959">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7277015">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7277067">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7277115">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7277159">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7277219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277223">paramtype</span>&nbsp;<span class="op" id="7277233">:=</span>&nbsp;<span class="ident" id="7277236">reflect</span><span class="op" id="7277243">.</span><span class="ident" id="7277244">TypeOf</span><span class="op" id="7277250">(</span><span class="ident" id="7277251">spec</span><span class="op" id="7277255">.</span><span class="ident" id="7277256">rows</span><span class="op" id="7277260">[</span><span class="num" id="7277261">0</span><span class="op" id="7277262">]</span><span class="op" id="7277263">.</span><span class="ident" id="7277264">nullParam</span><span class="op" id="7277273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277276">bindVal</span>&nbsp;<span class="op" id="7277284">:=</span>&nbsp;<span class="ident" id="7277287">reflect</span><span class="op" id="7277294">.</span><span class="ident" id="7277295">New</span><span class="op" id="7277298">(</span><span class="ident" id="7277299">paramtype</span><span class="op" id="7277308">)</span><span class="op" id="7277309">.</span><span class="ident" id="7277310">Interface</span><span class="op" id="7277319">(</span><span class="op" id="7277320">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7277324">for</span>&nbsp;<span class="ident" id="7277328">i</span>&nbsp;<span class="op" id="7277330">:=</span>&nbsp;<span class="num" id="7277333">0</span><span class="op" id="7277334">;</span>&nbsp;<span class="ident" id="7277336">i</span>&nbsp;<span class="op" id="7277338">&lt;</span>&nbsp;<span class="num" id="7277340">5</span><span class="op" id="7277341">;</span>&nbsp;<span class="ident" id="7277343">i</span><span class="op" id="7277344">++</span>&nbsp;<span class="op" id="7277347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277351">id</span>&nbsp;<span class="op" id="7277354">:=</span>&nbsp;<span class="ident" id="7277357">i</span>&nbsp;<span class="op" id="7277359">+</span>&nbsp;<span class="num" id="7277361">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7277365">if</span>&nbsp;<span class="ident" id="7277368">err</span>&nbsp;<span class="op" id="7277372">:=</span>&nbsp;<span class="ident" id="7277375">db</span><span class="op" id="7277377">.</span><span class="ident" id="7277378">QueryRow</span><span class="op" id="7277386">(</span><span class="string" id="7277387">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="7277408">,</span>&nbsp;<span class="ident" id="7277410">id</span><span class="op" id="7277412">)</span><span class="op" id="7277413">.</span><span class="ident" id="7277414">Scan</span><span class="op" id="7277418">(</span><span class="ident" id="7277419">bindVal</span><span class="op" id="7277426">)</span><span class="op" id="7277427">;</span>&nbsp;<span class="ident" id="7277429">err</span>&nbsp;<span class="op" id="7277433">!=</span>&nbsp;<span class="ident" id="7277436">nil</span>&nbsp;<span class="op" id="7277440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277445">t</span><span class="op" id="7277446">.</span><span class="ident" id="7277447">Errorf</span><span class="op" id="7277453">(</span><span class="string" id="7277454">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="7277470">,</span>&nbsp;<span class="ident" id="7277472">id</span><span class="op" id="7277474">,</span>&nbsp;<span class="ident" id="7277476">err</span><span class="op" id="7277479">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7277483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277487">bindValDeref</span>&nbsp;<span class="op" id="7277500">:=</span>&nbsp;<span class="ident" id="7277503">reflect</span><span class="op" id="7277510">.</span><span class="ident" id="7277511">ValueOf</span><span class="op" id="7277518">(</span><span class="ident" id="7277519">bindVal</span><span class="op" id="7277526">)</span><span class="op" id="7277527">.</span><span class="ident" id="7277528">Elem</span><span class="op" id="7277532">(</span><span class="op" id="7277533">)</span><span class="op" id="7277534">.</span><span class="ident" id="7277535">Interface</span><span class="op" id="7277544">(</span><span class="op" id="7277545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7277549">if</span>&nbsp;<span class="op" id="7277552">!</span><span class="ident" id="7277553">reflect</span><span class="op" id="7277560">.</span><span class="ident" id="7277561">DeepEqual</span><span class="op" id="7277570">(</span><span class="ident" id="7277571">bindValDeref</span><span class="op" id="7277583">,</span>&nbsp;<span class="ident" id="7277585">spec</span><span class="op" id="7277589">.</span><span class="ident" id="7277590">rows</span><span class="op" id="7277594">[</span><span class="ident" id="7277595">i</span><span class="op" id="7277596">]</span><span class="op" id="7277597">.</span><span class="ident" id="7277598">scanNullVal</span><span class="op" id="7277609">)</span>&nbsp;<span class="op" id="7277611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277616">t</span><span class="op" id="7277617">.</span><span class="ident" id="7277618">Errorf</span><span class="op" id="7277624">(</span><span class="string" id="7277625">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7277650">,</span>&nbsp;<span class="ident" id="7277652">id</span><span class="op" id="7277654">,</span>&nbsp;<span class="ident" id="7277656">bindValDeref</span><span class="op" id="7277668">,</span>&nbsp;<span class="ident" id="7277670">spec</span><span class="op" id="7277674">.</span><span class="ident" id="7277675">rows</span><span class="op" id="7277679">[</span><span class="ident" id="7277680">i</span><span class="op" id="7277681">]</span><span class="op" id="7277682">.</span><span class="ident" id="7277683">scanNullVal</span><span class="op" id="7277694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7277698">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7277701">}</span><br>
<span class="lineno"></span><span class="op" id="7277703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7277706">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="7277731">func</span>&nbsp;<span class="ident" id="7277736">TestQueryRowNilScanDest</span><span class="op" id="7277759">(</span><span class="ident" id="7277760">t</span>&nbsp;<span class="op" id="7277762">*</span><span class="ident" id="7277763">testing</span><span class="op" id="7277770">.</span><span class="ident" id="7277771">T</span><span class="op" id="7277772">)</span>&nbsp;<span class="op" id="7277774">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277777">db</span>&nbsp;<span class="op" id="7277780">:=</span>&nbsp;<span class="ident" id="7277783">newTestDB</span><span class="op" id="7277792">(</span><span class="ident" id="7277793">t</span><span class="op" id="7277794">,</span>&nbsp;<span class="string" id="7277796">&#34;people&#34;</span><span class="op" id="7277804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7277807">defer</span>&nbsp;<span class="ident" id="7277813">closeDB</span><span class="op" id="7277820">(</span><span class="ident" id="7277821">t</span><span class="op" id="7277822">,</span>&nbsp;<span class="ident" id="7277824">db</span><span class="op" id="7277826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7277829">var</span>&nbsp;<span class="ident" id="7277833">name</span>&nbsp;<span class="op" id="7277838">*</span><span class="builtintype" id="7277839">string</span>&nbsp;<span class="comment" id="7277846">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277862">err</span>&nbsp;<span class="op" id="7277866">:=</span>&nbsp;<span class="ident" id="7277869">db</span><span class="op" id="7277871">.</span><span class="ident" id="7277872">QueryRow</span><span class="op" id="7277880">(</span><span class="string" id="7277881">&#34;SELECT|people|name|&#34;</span><span class="op" id="7277902">)</span><span class="op" id="7277903">.</span><span class="ident" id="7277904">Scan</span><span class="op" id="7277908">(</span><span class="ident" id="7277909">name</span><span class="op" id="7277913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7277916">want</span>&nbsp;<span class="op" id="7277921">:=</span>&nbsp;<span class="string" id="7277924">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7277989">if</span>&nbsp;<span class="ident" id="7277992">err</span>&nbsp;<span class="op" id="7277996">==</span>&nbsp;<span class="ident" id="7277999">nil</span>&nbsp;<span class="op" id="7278003">||</span>&nbsp;<span class="ident" id="7278006">err</span><span class="op" id="7278009">.</span><span class="ident" id="7278010">Error</span><span class="op" id="7278015">(</span><span class="op" id="7278016">)</span>&nbsp;<span class="op" id="7278018">!=</span>&nbsp;<span class="ident" id="7278021">want</span>&nbsp;<span class="op" id="7278026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278030">t</span><span class="op" id="7278031">.</span><span class="ident" id="7278032">Errorf</span><span class="op" id="7278038">(</span><span class="string" id="7278039">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7278060">,</span>&nbsp;<span class="ident" id="7278062">err</span><span class="op" id="7278065">.</span><span class="ident" id="7278066">Error</span><span class="op" id="7278071">(</span><span class="op" id="7278072">)</span><span class="op" id="7278073">,</span>&nbsp;<span class="ident" id="7278075">want</span><span class="op" id="7278079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278082">}</span><br>
<span class="lineno"></span><span class="op" id="7278084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="7278087">func</span>&nbsp;<span class="ident" id="7278092">TestIssue4902</span><span class="op" id="7278105">(</span><span class="ident" id="7278106">t</span>&nbsp;<span class="op" id="7278108">*</span><span class="ident" id="7278109">testing</span><span class="op" id="7278116">.</span><span class="ident" id="7278117">T</span><span class="op" id="7278118">)</span>&nbsp;<span class="op" id="7278120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278123">db</span>&nbsp;<span class="op" id="7278126">:=</span>&nbsp;<span class="ident" id="7278129">newTestDB</span><span class="op" id="7278138">(</span><span class="ident" id="7278139">t</span><span class="op" id="7278140">,</span>&nbsp;<span class="string" id="7278142">&#34;people&#34;</span><span class="op" id="7278150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278153">defer</span>&nbsp;<span class="ident" id="7278159">closeDB</span><span class="op" id="7278166">(</span><span class="ident" id="7278167">t</span><span class="op" id="7278168">,</span>&nbsp;<span class="ident" id="7278170">db</span><span class="op" id="7278172">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278176">driver</span>&nbsp;<span class="op" id="7278183">:=</span>&nbsp;<span class="ident" id="7278186">db</span><span class="op" id="7278188">.</span><span class="ident" id="7278189">driver</span><span class="op" id="7278195">.</span><span class="op" id="7278196">(</span><span class="op" id="7278197">*</span><span class="ident" id="7278198">fakeDriver</span><span class="op" id="7278208">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278211">opens0</span>&nbsp;<span class="op" id="7278218">:=</span>&nbsp;<span class="ident" id="7278221">driver</span><span class="op" id="7278227">.</span><span class="ident" id="7278228">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278240">var</span>&nbsp;<span class="ident" id="7278244">stmt</span>&nbsp;<span class="op" id="7278249">*</span><span class="ident" id="7278250">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278256">var</span>&nbsp;<span class="ident" id="7278260">err</span>&nbsp;<span class="builtintype" id="7278264">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278271">for</span>&nbsp;<span class="ident" id="7278275">i</span>&nbsp;<span class="op" id="7278277">:=</span>&nbsp;<span class="num" id="7278280">0</span><span class="op" id="7278281">;</span>&nbsp;<span class="ident" id="7278283">i</span>&nbsp;<span class="op" id="7278285">&lt;</span>&nbsp;<span class="num" id="7278287">10</span><span class="op" id="7278289">;</span>&nbsp;<span class="ident" id="7278291">i</span><span class="op" id="7278292">++</span>&nbsp;<span class="op" id="7278295">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278299">stmt</span><span class="op" id="7278303">,</span>&nbsp;<span class="ident" id="7278305">err</span>&nbsp;<span class="op" id="7278309">=</span>&nbsp;<span class="ident" id="7278311">db</span><span class="op" id="7278313">.</span><span class="ident" id="7278314">Prepare</span><span class="op" id="7278321">(</span><span class="string" id="7278322">&#34;SELECT|people|name|&#34;</span><span class="op" id="7278343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278347">if</span>&nbsp;<span class="ident" id="7278350">err</span>&nbsp;<span class="op" id="7278354">!=</span>&nbsp;<span class="ident" id="7278357">nil</span>&nbsp;<span class="op" id="7278361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278366">t</span><span class="op" id="7278367">.</span><span class="ident" id="7278368">Fatal</span><span class="op" id="7278373">(</span><span class="ident" id="7278374">err</span><span class="op" id="7278377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278385">err</span>&nbsp;<span class="op" id="7278389">=</span>&nbsp;<span class="ident" id="7278391">stmt</span><span class="op" id="7278395">.</span><span class="ident" id="7278396">Close</span><span class="op" id="7278401">(</span><span class="op" id="7278402">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278406">if</span>&nbsp;<span class="ident" id="7278409">err</span>&nbsp;<span class="op" id="7278413">!=</span>&nbsp;<span class="ident" id="7278416">nil</span>&nbsp;<span class="op" id="7278420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278425">t</span><span class="op" id="7278426">.</span><span class="ident" id="7278427">Fatal</span><span class="op" id="7278432">(</span><span class="ident" id="7278433">err</span><span class="op" id="7278436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278447">opens</span>&nbsp;<span class="op" id="7278453">:=</span>&nbsp;<span class="ident" id="7278456">driver</span><span class="op" id="7278462">.</span><span class="ident" id="7278463">openCount</span>&nbsp;<span class="op" id="7278473">-</span>&nbsp;<span class="ident" id="7278475">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278483">if</span>&nbsp;<span class="ident" id="7278486">opens</span>&nbsp;<span class="op" id="7278492">&gt;</span>&nbsp;<span class="num" id="7278494">1</span>&nbsp;<span class="op" id="7278496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278500">t</span><span class="op" id="7278501">.</span><span class="ident" id="7278502">Errorf</span><span class="op" id="7278508">(</span><span class="string" id="7278509">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7278532">,</span>&nbsp;<span class="ident" id="7278534">opens</span><span class="op" id="7278539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278543">t</span><span class="op" id="7278544">.</span><span class="ident" id="7278545">Logf</span><span class="op" id="7278549">(</span><span class="string" id="7278550">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7278560">,</span>&nbsp;<span class="ident" id="7278562">db</span><span class="op" id="7278564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278568">t</span><span class="op" id="7278569">.</span><span class="ident" id="7278570">Logf</span><span class="op" id="7278574">(</span><span class="string" id="7278575">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7278589">,</span>&nbsp;<span class="ident" id="7278591">driver</span><span class="op" id="7278597">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278601">t</span><span class="op" id="7278602">.</span><span class="ident" id="7278603">Logf</span><span class="op" id="7278607">(</span><span class="string" id="7278608">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7278620">,</span>&nbsp;<span class="ident" id="7278622">stmt</span><span class="op" id="7278626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278629">}</span><br>
<span class="lineno"></span><span class="op" id="7278631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7278634">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="7278648">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="7278674">func</span>&nbsp;<span class="ident" id="7278679">TestSimultaneousQueries</span><span class="op" id="7278702">(</span><span class="ident" id="7278703">t</span>&nbsp;<span class="op" id="7278705">*</span><span class="ident" id="7278706">testing</span><span class="op" id="7278713">.</span><span class="ident" id="7278714">T</span><span class="op" id="7278715">)</span>&nbsp;<span class="op" id="7278717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278720">db</span>&nbsp;<span class="op" id="7278723">:=</span>&nbsp;<span class="ident" id="7278726">newTestDB</span><span class="op" id="7278735">(</span><span class="ident" id="7278736">t</span><span class="op" id="7278737">,</span>&nbsp;<span class="string" id="7278739">&#34;people&#34;</span><span class="op" id="7278747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278750">defer</span>&nbsp;<span class="ident" id="7278756">closeDB</span><span class="op" id="7278763">(</span><span class="ident" id="7278764">t</span><span class="op" id="7278765">,</span>&nbsp;<span class="ident" id="7278767">db</span><span class="op" id="7278769">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278773">tx</span><span class="op" id="7278775">,</span>&nbsp;<span class="ident" id="7278777">err</span>&nbsp;<span class="op" id="7278781">:=</span>&nbsp;<span class="ident" id="7278784">db</span><span class="op" id="7278786">.</span><span class="ident" id="7278787">Begin</span><span class="op" id="7278792">(</span><span class="op" id="7278793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278796">if</span>&nbsp;<span class="ident" id="7278799">err</span>&nbsp;<span class="op" id="7278803">!=</span>&nbsp;<span class="ident" id="7278806">nil</span>&nbsp;<span class="op" id="7278810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278814">t</span><span class="op" id="7278815">.</span><span class="ident" id="7278816">Fatal</span><span class="op" id="7278821">(</span><span class="ident" id="7278822">err</span><span class="op" id="7278825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278831">defer</span>&nbsp;<span class="ident" id="7278837">tx</span><span class="op" id="7278839">.</span><span class="ident" id="7278840">Rollback</span><span class="op" id="7278848">(</span><span class="op" id="7278849">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278853">r1</span><span class="op" id="7278855">,</span>&nbsp;<span class="ident" id="7278857">err</span>&nbsp;<span class="op" id="7278861">:=</span>&nbsp;<span class="ident" id="7278864">tx</span><span class="op" id="7278866">.</span><span class="ident" id="7278867">Query</span><span class="op" id="7278872">(</span><span class="string" id="7278873">&#34;SELECT|people|name|&#34;</span><span class="op" id="7278894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278897">if</span>&nbsp;<span class="ident" id="7278900">err</span>&nbsp;<span class="op" id="7278904">!=</span>&nbsp;<span class="ident" id="7278907">nil</span>&nbsp;<span class="op" id="7278911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278915">t</span><span class="op" id="7278916">.</span><span class="ident" id="7278917">Fatal</span><span class="op" id="7278922">(</span><span class="ident" id="7278923">err</span><span class="op" id="7278926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7278929">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278932">defer</span>&nbsp;<span class="ident" id="7278938">r1</span><span class="op" id="7278940">.</span><span class="ident" id="7278941">Close</span><span class="op" id="7278946">(</span><span class="op" id="7278947">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7278951">r2</span><span class="op" id="7278953">,</span>&nbsp;<span class="ident" id="7278955">err</span>&nbsp;<span class="op" id="7278959">:=</span>&nbsp;<span class="ident" id="7278962">tx</span><span class="op" id="7278964">.</span><span class="ident" id="7278965">Query</span><span class="op" id="7278970">(</span><span class="string" id="7278971">&#34;SELECT|people|name|&#34;</span><span class="op" id="7278992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7278995">if</span>&nbsp;<span class="ident" id="7278998">err</span>&nbsp;<span class="op" id="7279002">!=</span>&nbsp;<span class="ident" id="7279005">nil</span>&nbsp;<span class="op" id="7279009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279013">t</span><span class="op" id="7279014">.</span><span class="ident" id="7279015">Fatal</span><span class="op" id="7279020">(</span><span class="ident" id="7279021">err</span><span class="op" id="7279024">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279030">defer</span>&nbsp;<span class="ident" id="7279036">r2</span><span class="op" id="7279038">.</span><span class="ident" id="7279039">Close</span><span class="op" id="7279044">(</span><span class="op" id="7279045">)</span><br>
<span class="lineno"></span><span class="op" id="7279047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7279050">func</span>&nbsp;<span class="ident" id="7279055">TestMaxIdleConns</span><span class="op" id="7279071">(</span><span class="ident" id="7279072">t</span>&nbsp;<span class="op" id="7279074">*</span><span class="ident" id="7279075">testing</span><span class="op" id="7279082">.</span><span class="ident" id="7279083">T</span><span class="op" id="7279084">)</span>&nbsp;<span class="op" id="7279086">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279089">db</span>&nbsp;<span class="op" id="7279092">:=</span>&nbsp;<span class="ident" id="7279095">newTestDB</span><span class="op" id="7279104">(</span><span class="ident" id="7279105">t</span><span class="op" id="7279106">,</span>&nbsp;<span class="string" id="7279108">&#34;people&#34;</span><span class="op" id="7279116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279119">defer</span>&nbsp;<span class="ident" id="7279125">closeDB</span><span class="op" id="7279132">(</span><span class="ident" id="7279133">t</span><span class="op" id="7279134">,</span>&nbsp;<span class="ident" id="7279136">db</span><span class="op" id="7279138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279142">tx</span><span class="op" id="7279144">,</span>&nbsp;<span class="ident" id="7279146">err</span>&nbsp;<span class="op" id="7279150">:=</span>&nbsp;<span class="ident" id="7279153">db</span><span class="op" id="7279155">.</span><span class="ident" id="7279156">Begin</span><span class="op" id="7279161">(</span><span class="op" id="7279162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279165">if</span>&nbsp;<span class="ident" id="7279168">err</span>&nbsp;<span class="op" id="7279172">!=</span>&nbsp;<span class="ident" id="7279175">nil</span>&nbsp;<span class="op" id="7279179">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279183">t</span><span class="op" id="7279184">.</span><span class="ident" id="7279185">Fatal</span><span class="op" id="7279190">(</span><span class="ident" id="7279191">err</span><span class="op" id="7279194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279200">tx</span><span class="op" id="7279202">.</span><span class="ident" id="7279203">Commit</span><span class="op" id="7279209">(</span><span class="op" id="7279210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279213">if</span>&nbsp;<span class="ident" id="7279216">got</span>&nbsp;<span class="op" id="7279220">:=</span>&nbsp;<span class="builtinfunc" id="7279223">len</span><span class="op" id="7279226">(</span><span class="ident" id="7279227">db</span><span class="op" id="7279229">.</span><span class="ident" id="7279230">freeConn</span><span class="op" id="7279238">)</span><span class="op" id="7279239">;</span>&nbsp;<span class="ident" id="7279241">got</span>&nbsp;<span class="op" id="7279245">!=</span>&nbsp;<span class="num" id="7279248">1</span>&nbsp;<span class="op" id="7279250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279254">t</span><span class="op" id="7279255">.</span><span class="ident" id="7279256">Errorf</span><span class="op" id="7279262">(</span><span class="string" id="7279263">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7279287">,</span>&nbsp;<span class="ident" id="7279289">got</span><span class="op" id="7279292">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279299">db</span><span class="op" id="7279301">.</span><span class="ident" id="7279302">SetMaxIdleConns</span><span class="op" id="7279317">(</span><span class="num" id="7279318">0</span><span class="op" id="7279319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279323">if</span>&nbsp;<span class="ident" id="7279326">got</span>&nbsp;<span class="op" id="7279330">:=</span>&nbsp;<span class="builtinfunc" id="7279333">len</span><span class="op" id="7279336">(</span><span class="ident" id="7279337">db</span><span class="op" id="7279339">.</span><span class="ident" id="7279340">freeConn</span><span class="op" id="7279348">)</span><span class="op" id="7279349">;</span>&nbsp;<span class="ident" id="7279351">got</span>&nbsp;<span class="op" id="7279355">!=</span>&nbsp;<span class="num" id="7279358">0</span>&nbsp;<span class="op" id="7279360">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279364">t</span><span class="op" id="7279365">.</span><span class="ident" id="7279366">Errorf</span><span class="op" id="7279372">(</span><span class="string" id="7279373">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7279415">,</span>&nbsp;<span class="ident" id="7279417">got</span><span class="op" id="7279420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279427">tx</span><span class="op" id="7279429">,</span>&nbsp;<span class="ident" id="7279431">err</span>&nbsp;<span class="op" id="7279435">=</span>&nbsp;<span class="ident" id="7279437">db</span><span class="op" id="7279439">.</span><span class="ident" id="7279440">Begin</span><span class="op" id="7279445">(</span><span class="op" id="7279446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279449">if</span>&nbsp;<span class="ident" id="7279452">err</span>&nbsp;<span class="op" id="7279456">!=</span>&nbsp;<span class="ident" id="7279459">nil</span>&nbsp;<span class="op" id="7279463">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279467">t</span><span class="op" id="7279468">.</span><span class="ident" id="7279469">Fatal</span><span class="op" id="7279474">(</span><span class="ident" id="7279475">err</span><span class="op" id="7279478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279484">tx</span><span class="op" id="7279486">.</span><span class="ident" id="7279487">Commit</span><span class="op" id="7279493">(</span><span class="op" id="7279494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279497">if</span>&nbsp;<span class="ident" id="7279500">got</span>&nbsp;<span class="op" id="7279504">:=</span>&nbsp;<span class="builtinfunc" id="7279507">len</span><span class="op" id="7279510">(</span><span class="ident" id="7279511">db</span><span class="op" id="7279513">.</span><span class="ident" id="7279514">freeConn</span><span class="op" id="7279522">)</span><span class="op" id="7279523">;</span>&nbsp;<span class="ident" id="7279525">got</span>&nbsp;<span class="op" id="7279529">!=</span>&nbsp;<span class="num" id="7279532">0</span>&nbsp;<span class="op" id="7279534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279538">t</span><span class="op" id="7279539">.</span><span class="ident" id="7279540">Errorf</span><span class="op" id="7279546">(</span><span class="string" id="7279547">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7279571">,</span>&nbsp;<span class="ident" id="7279573">got</span><span class="op" id="7279576">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279579">}</span><br>
<span class="lineno"></span><span class="op" id="7279581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7279584">func</span>&nbsp;<span class="ident" id="7279589">TestMaxOpenConns</span><span class="op" id="7279605">(</span><span class="ident" id="7279606">t</span>&nbsp;<span class="op" id="7279608">*</span><span class="ident" id="7279609">testing</span><span class="op" id="7279616">.</span><span class="ident" id="7279617">T</span><span class="op" id="7279618">)</span>&nbsp;<span class="op" id="7279620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279623">if</span>&nbsp;<span class="ident" id="7279626">testing</span><span class="op" id="7279633">.</span><span class="ident" id="7279634">Short</span><span class="op" id="7279639">(</span><span class="op" id="7279640">)</span>&nbsp;<span class="op" id="7279642">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279646">t</span><span class="op" id="7279647">.</span><span class="ident" id="7279648">Skip</span><span class="op" id="7279652">(</span><span class="string" id="7279653">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7279677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279683">defer</span>&nbsp;<span class="ident" id="7279689">setHookpostCloseConn</span><span class="op" id="7279709">(</span><span class="ident" id="7279710">nil</span><span class="op" id="7279713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279716">setHookpostCloseConn</span><span class="op" id="7279736">(</span><span class="keyword" id="7279737">func</span><span class="op" id="7279741">(</span><span class="ident" id="7279742">_</span>&nbsp;<span class="op" id="7279744">*</span><span class="ident" id="7279745">fakeConn</span><span class="op" id="7279753">,</span>&nbsp;<span class="ident" id="7279755">err</span>&nbsp;<span class="builtintype" id="7279759">error</span><span class="op" id="7279764">)</span>&nbsp;<span class="op" id="7279766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279770">if</span>&nbsp;<span class="ident" id="7279773">err</span>&nbsp;<span class="op" id="7279777">!=</span>&nbsp;<span class="ident" id="7279780">nil</span>&nbsp;<span class="op" id="7279784">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279789">t</span><span class="op" id="7279790">.</span><span class="ident" id="7279791">Errorf</span><span class="op" id="7279797">(</span><span class="string" id="7279798">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7279826">,</span>&nbsp;<span class="ident" id="7279828">err</span><span class="op" id="7279831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7279838">}</span><span class="op" id="7279839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279843">db</span>&nbsp;<span class="op" id="7279846">:=</span>&nbsp;<span class="ident" id="7279849">newTestDB</span><span class="op" id="7279858">(</span><span class="ident" id="7279859">t</span><span class="op" id="7279860">,</span>&nbsp;<span class="string" id="7279862">&#34;magicquery&#34;</span><span class="op" id="7279874">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7279877">defer</span>&nbsp;<span class="ident" id="7279883">closeDB</span><span class="op" id="7279890">(</span><span class="ident" id="7279891">t</span><span class="op" id="7279892">,</span>&nbsp;<span class="ident" id="7279894">db</span><span class="op" id="7279896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7279900">driver</span>&nbsp;<span class="op" id="7279907">:=</span>&nbsp;<span class="ident" id="7279910">db</span><span class="op" id="7279912">.</span><span class="ident" id="7279913">driver</span><span class="op" id="7279919">.</span><span class="op" id="7279920">(</span><span class="op" id="7279921">*</span><span class="ident" id="7279922">fakeDriver</span><span class="op" id="7279932">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7279936">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7280008">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280031">db</span><span class="op" id="7280033">.</span><span class="ident" id="7280034">SetMaxIdleConns</span><span class="op" id="7280049">(</span><span class="num" id="7280050">0</span><span class="op" id="7280051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280055">if</span>&nbsp;<span class="ident" id="7280058">g</span><span class="op" id="7280059">,</span>&nbsp;<span class="ident" id="7280061">w</span>&nbsp;<span class="op" id="7280063">:=</span>&nbsp;<span class="ident" id="7280066">db</span><span class="op" id="7280068">.</span><span class="ident" id="7280069">numFreeConns</span><span class="op" id="7280081">(</span><span class="op" id="7280082">)</span><span class="op" id="7280083">,</span>&nbsp;<span class="num" id="7280085">0</span><span class="op" id="7280086">;</span>&nbsp;<span class="ident" id="7280088">g</span>&nbsp;<span class="op" id="7280090">!=</span>&nbsp;<span class="ident" id="7280093">w</span>&nbsp;<span class="op" id="7280095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280099">t</span><span class="op" id="7280100">.</span><span class="ident" id="7280101">Errorf</span><span class="op" id="7280107">(</span><span class="string" id="7280108">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7280134">,</span>&nbsp;<span class="ident" id="7280136">g</span><span class="op" id="7280137">,</span>&nbsp;<span class="ident" id="7280139">w</span><span class="op" id="7280140">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280147">if</span>&nbsp;<span class="ident" id="7280150">n</span>&nbsp;<span class="op" id="7280152">:=</span>&nbsp;<span class="ident" id="7280155">db</span><span class="op" id="7280157">.</span><span class="ident" id="7280158">numDepsPollUntil</span><span class="op" id="7280174">(</span><span class="num" id="7280175">0</span><span class="op" id="7280176">,</span>&nbsp;<span class="ident" id="7280178">time</span><span class="op" id="7280182">.</span><span class="ident" id="7280183">Second</span><span class="op" id="7280189">)</span><span class="op" id="7280190">;</span>&nbsp;<span class="ident" id="7280192">n</span>&nbsp;<span class="op" id="7280194">&gt;</span>&nbsp;<span class="num" id="7280196">0</span>&nbsp;<span class="op" id="7280198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280202">t</span><span class="op" id="7280203">.</span><span class="ident" id="7280204">Errorf</span><span class="op" id="7280210">(</span><span class="string" id="7280211">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7280252">,</span>&nbsp;<span class="ident" id="7280254">n</span><span class="op" id="7280255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280259">db</span><span class="op" id="7280261">.</span><span class="ident" id="7280262">dumpDeps</span><span class="op" id="7280270">(</span><span class="ident" id="7280271">t</span><span class="op" id="7280272">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280279">driver</span><span class="op" id="7280285">.</span><span class="ident" id="7280286">mu</span><span class="op" id="7280288">.</span><span class="ident" id="7280289">Lock</span><span class="op" id="7280293">(</span><span class="op" id="7280294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280297">opens0</span>&nbsp;<span class="op" id="7280304">:=</span>&nbsp;<span class="ident" id="7280307">driver</span><span class="op" id="7280313">.</span><span class="ident" id="7280314">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280325">closes0</span>&nbsp;<span class="op" id="7280333">:=</span>&nbsp;<span class="ident" id="7280336">driver</span><span class="op" id="7280342">.</span><span class="ident" id="7280343">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280355">driver</span><span class="op" id="7280361">.</span><span class="ident" id="7280362">mu</span><span class="op" id="7280364">.</span><span class="ident" id="7280365">Unlock</span><span class="op" id="7280371">(</span><span class="op" id="7280372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280376">db</span><span class="op" id="7280378">.</span><span class="ident" id="7280379">SetMaxIdleConns</span><span class="op" id="7280394">(</span><span class="num" id="7280395">10</span><span class="op" id="7280397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280400">db</span><span class="op" id="7280402">.</span><span class="ident" id="7280403">SetMaxOpenConns</span><span class="op" id="7280418">(</span><span class="num" id="7280419">10</span><span class="op" id="7280421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280425">stmt</span><span class="op" id="7280429">,</span>&nbsp;<span class="ident" id="7280431">err</span>&nbsp;<span class="op" id="7280435">:=</span>&nbsp;<span class="ident" id="7280438">db</span><span class="op" id="7280440">.</span><span class="ident" id="7280441">Prepare</span><span class="op" id="7280448">(</span><span class="string" id="7280449">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7280485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280488">if</span>&nbsp;<span class="ident" id="7280491">err</span>&nbsp;<span class="op" id="7280495">!=</span>&nbsp;<span class="ident" id="7280498">nil</span>&nbsp;<span class="op" id="7280502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280506">t</span><span class="op" id="7280507">.</span><span class="ident" id="7280508">Fatal</span><span class="op" id="7280513">(</span><span class="ident" id="7280514">err</span><span class="op" id="7280517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7280524">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280560">const</span>&nbsp;<span class="op" id="7280566">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280570">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280582">=</span>&nbsp;<span class="num" id="7280584">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280589">sleepMillis</span>&nbsp;<span class="op" id="7280601">=</span>&nbsp;<span class="num" id="7280603">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280608">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280620">=</span>&nbsp;<span class="num" id="7280622">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280628">var</span>&nbsp;<span class="ident" id="7280632">wg</span>&nbsp;<span class="ident" id="7280635">sync</span><span class="op" id="7280639">.</span><span class="ident" id="7280640">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280651">for</span>&nbsp;<span class="ident" id="7280655">batch</span>&nbsp;<span class="op" id="7280661">:=</span>&nbsp;<span class="num" id="7280664">0</span><span class="op" id="7280665">;</span>&nbsp;<span class="ident" id="7280667">batch</span>&nbsp;<span class="op" id="7280673">&lt;</span>&nbsp;<span class="ident" id="7280675">nbatch</span><span class="op" id="7280681">;</span>&nbsp;<span class="ident" id="7280683">batch</span><span class="op" id="7280688">++</span>&nbsp;<span class="op" id="7280691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280695">for</span>&nbsp;<span class="ident" id="7280699">i</span>&nbsp;<span class="op" id="7280701">:=</span>&nbsp;<span class="num" id="7280704">0</span><span class="op" id="7280705">;</span>&nbsp;<span class="ident" id="7280707">i</span>&nbsp;<span class="op" id="7280709">&lt;</span>&nbsp;<span class="ident" id="7280711">nquery</span><span class="op" id="7280717">;</span>&nbsp;<span class="ident" id="7280719">i</span><span class="op" id="7280720">++</span>&nbsp;<span class="op" id="7280723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280728">wg</span><span class="op" id="7280730">.</span><span class="ident" id="7280731">Add</span><span class="op" id="7280734">(</span><span class="num" id="7280735">1</span><span class="op" id="7280736">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280741">go</span>&nbsp;<span class="keyword" id="7280744">func</span><span class="op" id="7280748">(</span><span class="op" id="7280749">)</span>&nbsp;<span class="op" id="7280751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280757">defer</span>&nbsp;<span class="ident" id="7280763">wg</span><span class="op" id="7280765">.</span><span class="ident" id="7280766">Done</span><span class="op" id="7280770">(</span><span class="op" id="7280771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280777">var</span>&nbsp;<span class="ident" id="7280781">op</span>&nbsp;<span class="builtintype" id="7280784">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7280795">if</span>&nbsp;<span class="ident" id="7280798">err</span>&nbsp;<span class="op" id="7280802">:=</span>&nbsp;<span class="ident" id="7280805">stmt</span><span class="op" id="7280809">.</span><span class="ident" id="7280810">QueryRow</span><span class="op" id="7280818">(</span><span class="string" id="7280819">&#34;sleep&#34;</span><span class="op" id="7280826">,</span>&nbsp;<span class="ident" id="7280828">sleepMillis</span><span class="op" id="7280839">)</span><span class="op" id="7280840">.</span><span class="ident" id="7280841">Scan</span><span class="op" id="7280845">(</span><span class="op" id="7280846">&amp;</span><span class="ident" id="7280847">op</span><span class="op" id="7280849">)</span><span class="op" id="7280850">;</span>&nbsp;<span class="ident" id="7280852">err</span>&nbsp;<span class="op" id="7280856">!=</span>&nbsp;<span class="ident" id="7280859">nil</span>&nbsp;<span class="op" id="7280863">&amp;&amp;</span>&nbsp;<span class="ident" id="7280866">err</span>&nbsp;<span class="op" id="7280870">!=</span>&nbsp;<span class="ident" id="7280873">ErrNoRows</span>&nbsp;<span class="op" id="7280883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7280890">t</span><span class="op" id="7280891">.</span><span class="ident" id="7280892">Error</span><span class="op" id="7280897">(</span><span class="ident" id="7280898">err</span><span class="op" id="7280901">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280912">}</span><span class="op" id="7280913">(</span><span class="op" id="7280914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7280918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7280922">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7280979">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7281036">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281057">time</span><span class="op" id="7281061">.</span><span class="ident" id="7281062">Sleep</span><span class="op" id="7281067">(</span><span class="num" id="7281068">2</span>&nbsp;<span class="op" id="7281070">*</span>&nbsp;<span class="ident" id="7281072">sleepMillis</span>&nbsp;<span class="op" id="7281084">*</span>&nbsp;<span class="ident" id="7281086">time</span><span class="op" id="7281090">.</span><span class="ident" id="7281091">Millisecond</span><span class="op" id="7281102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281108">wg</span><span class="op" id="7281110">.</span><span class="ident" id="7281111">Wait</span><span class="op" id="7281115">(</span><span class="op" id="7281116">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281120">if</span>&nbsp;<span class="ident" id="7281123">g</span><span class="op" id="7281124">,</span>&nbsp;<span class="ident" id="7281126">w</span>&nbsp;<span class="op" id="7281128">:=</span>&nbsp;<span class="ident" id="7281131">db</span><span class="op" id="7281133">.</span><span class="ident" id="7281134">numFreeConns</span><span class="op" id="7281146">(</span><span class="op" id="7281147">)</span><span class="op" id="7281148">,</span>&nbsp;<span class="num" id="7281150">10</span><span class="op" id="7281152">;</span>&nbsp;<span class="ident" id="7281154">g</span>&nbsp;<span class="op" id="7281156">!=</span>&nbsp;<span class="ident" id="7281159">w</span>&nbsp;<span class="op" id="7281161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281165">t</span><span class="op" id="7281166">.</span><span class="ident" id="7281167">Errorf</span><span class="op" id="7281173">(</span><span class="string" id="7281174">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7281200">,</span>&nbsp;<span class="ident" id="7281202">g</span><span class="op" id="7281203">,</span>&nbsp;<span class="ident" id="7281205">w</span><span class="op" id="7281206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281213">if</span>&nbsp;<span class="ident" id="7281216">n</span>&nbsp;<span class="op" id="7281218">:=</span>&nbsp;<span class="ident" id="7281221">db</span><span class="op" id="7281223">.</span><span class="ident" id="7281224">numDepsPollUntil</span><span class="op" id="7281240">(</span><span class="num" id="7281241">20</span><span class="op" id="7281243">,</span>&nbsp;<span class="ident" id="7281245">time</span><span class="op" id="7281249">.</span><span class="ident" id="7281250">Second</span><span class="op" id="7281256">)</span><span class="op" id="7281257">;</span>&nbsp;<span class="ident" id="7281259">n</span>&nbsp;<span class="op" id="7281261">&gt;</span>&nbsp;<span class="num" id="7281263">20</span>&nbsp;<span class="op" id="7281266">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281270">t</span><span class="op" id="7281271">.</span><span class="ident" id="7281272">Errorf</span><span class="op" id="7281278">(</span><span class="string" id="7281279">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="7281324">,</span>&nbsp;<span class="ident" id="7281326">n</span><span class="op" id="7281327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281331">db</span><span class="op" id="7281333">.</span><span class="ident" id="7281334">dumpDeps</span><span class="op" id="7281342">(</span><span class="ident" id="7281343">t</span><span class="op" id="7281344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281351">driver</span><span class="op" id="7281357">.</span><span class="ident" id="7281358">mu</span><span class="op" id="7281360">.</span><span class="ident" id="7281361">Lock</span><span class="op" id="7281365">(</span><span class="op" id="7281366">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281369">opens</span>&nbsp;<span class="op" id="7281375">:=</span>&nbsp;<span class="ident" id="7281378">driver</span><span class="op" id="7281384">.</span><span class="ident" id="7281385">openCount</span>&nbsp;<span class="op" id="7281395">-</span>&nbsp;<span class="ident" id="7281397">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281405">closes</span>&nbsp;<span class="op" id="7281412">:=</span>&nbsp;<span class="ident" id="7281415">driver</span><span class="op" id="7281421">.</span><span class="ident" id="7281422">closeCount</span>&nbsp;<span class="op" id="7281433">-</span>&nbsp;<span class="ident" id="7281435">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281444">driver</span><span class="op" id="7281450">.</span><span class="ident" id="7281451">mu</span><span class="op" id="7281453">.</span><span class="ident" id="7281454">Unlock</span><span class="op" id="7281460">(</span><span class="op" id="7281461">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281465">if</span>&nbsp;<span class="ident" id="7281468">opens</span>&nbsp;<span class="op" id="7281474">&gt;</span>&nbsp;<span class="num" id="7281476">10</span>&nbsp;<span class="op" id="7281479">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281483">t</span><span class="op" id="7281484">.</span><span class="ident" id="7281485">Logf</span><span class="op" id="7281489">(</span><span class="string" id="7281490">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7281507">,</span>&nbsp;<span class="ident" id="7281509">opens</span><span class="op" id="7281514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281518">t</span><span class="op" id="7281519">.</span><span class="ident" id="7281520">Logf</span><span class="op" id="7281524">(</span><span class="string" id="7281525">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7281543">,</span>&nbsp;<span class="ident" id="7281545">closes</span><span class="op" id="7281551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281555">t</span><span class="op" id="7281556">.</span><span class="ident" id="7281557">Errorf</span><span class="op" id="7281563">(</span><span class="string" id="7281564">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7281604">,</span>&nbsp;<span class="ident" id="7281606">opens</span><span class="op" id="7281611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281615">db</span><span class="op" id="7281617">.</span><span class="ident" id="7281618">dumpDeps</span><span class="op" id="7281626">(</span><span class="ident" id="7281627">t</span><span class="op" id="7281628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281631">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281635">if</span>&nbsp;<span class="ident" id="7281638">err</span>&nbsp;<span class="op" id="7281642">:=</span>&nbsp;<span class="ident" id="7281645">stmt</span><span class="op" id="7281649">.</span><span class="ident" id="7281650">Close</span><span class="op" id="7281655">(</span><span class="op" id="7281656">)</span><span class="op" id="7281657">;</span>&nbsp;<span class="ident" id="7281659">err</span>&nbsp;<span class="op" id="7281663">!=</span>&nbsp;<span class="ident" id="7281666">nil</span>&nbsp;<span class="op" id="7281670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281674">t</span><span class="op" id="7281675">.</span><span class="ident" id="7281676">Fatal</span><span class="op" id="7281681">(</span><span class="ident" id="7281682">err</span><span class="op" id="7281685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281692">if</span>&nbsp;<span class="ident" id="7281695">g</span><span class="op" id="7281696">,</span>&nbsp;<span class="ident" id="7281698">w</span>&nbsp;<span class="op" id="7281700">:=</span>&nbsp;<span class="ident" id="7281703">db</span><span class="op" id="7281705">.</span><span class="ident" id="7281706">numFreeConns</span><span class="op" id="7281718">(</span><span class="op" id="7281719">)</span><span class="op" id="7281720">,</span>&nbsp;<span class="num" id="7281722">10</span><span class="op" id="7281724">;</span>&nbsp;<span class="ident" id="7281726">g</span>&nbsp;<span class="op" id="7281728">!=</span>&nbsp;<span class="ident" id="7281731">w</span>&nbsp;<span class="op" id="7281733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281737">t</span><span class="op" id="7281738">.</span><span class="ident" id="7281739">Errorf</span><span class="op" id="7281745">(</span><span class="string" id="7281746">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7281772">,</span>&nbsp;<span class="ident" id="7281774">g</span><span class="op" id="7281775">,</span>&nbsp;<span class="ident" id="7281777">w</span><span class="op" id="7281778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281785">if</span>&nbsp;<span class="ident" id="7281788">n</span>&nbsp;<span class="op" id="7281790">:=</span>&nbsp;<span class="ident" id="7281793">db</span><span class="op" id="7281795">.</span><span class="ident" id="7281796">numDepsPollUntil</span><span class="op" id="7281812">(</span><span class="num" id="7281813">10</span><span class="op" id="7281815">,</span>&nbsp;<span class="ident" id="7281817">time</span><span class="op" id="7281821">.</span><span class="ident" id="7281822">Second</span><span class="op" id="7281828">)</span><span class="op" id="7281829">;</span>&nbsp;<span class="ident" id="7281831">n</span>&nbsp;<span class="op" id="7281833">&gt;</span>&nbsp;<span class="num" id="7281835">10</span>&nbsp;<span class="op" id="7281838">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281842">t</span><span class="op" id="7281843">.</span><span class="ident" id="7281844">Errorf</span><span class="op" id="7281850">(</span><span class="string" id="7281851">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7281896">,</span>&nbsp;<span class="ident" id="7281898">n</span><span class="op" id="7281899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281903">db</span><span class="op" id="7281905">.</span><span class="ident" id="7281906">dumpDeps</span><span class="op" id="7281914">(</span><span class="ident" id="7281915">t</span><span class="op" id="7281916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7281919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281923">db</span><span class="op" id="7281925">.</span><span class="ident" id="7281926">SetMaxOpenConns</span><span class="op" id="7281941">(</span><span class="num" id="7281942">5</span><span class="op" id="7281943">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7281947">if</span>&nbsp;<span class="ident" id="7281950">g</span><span class="op" id="7281951">,</span>&nbsp;<span class="ident" id="7281953">w</span>&nbsp;<span class="op" id="7281955">:=</span>&nbsp;<span class="ident" id="7281958">db</span><span class="op" id="7281960">.</span><span class="ident" id="7281961">numFreeConns</span><span class="op" id="7281973">(</span><span class="op" id="7281974">)</span><span class="op" id="7281975">,</span>&nbsp;<span class="num" id="7281977">5</span><span class="op" id="7281978">;</span>&nbsp;<span class="ident" id="7281980">g</span>&nbsp;<span class="op" id="7281982">!=</span>&nbsp;<span class="ident" id="7281985">w</span>&nbsp;<span class="op" id="7281987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7281991">t</span><span class="op" id="7281992">.</span><span class="ident" id="7281993">Errorf</span><span class="op" id="7281999">(</span><span class="string" id="7282000">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7282026">,</span>&nbsp;<span class="ident" id="7282028">g</span><span class="op" id="7282029">,</span>&nbsp;<span class="ident" id="7282031">w</span><span class="op" id="7282032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282039">if</span>&nbsp;<span class="ident" id="7282042">n</span>&nbsp;<span class="op" id="7282044">:=</span>&nbsp;<span class="ident" id="7282047">db</span><span class="op" id="7282049">.</span><span class="ident" id="7282050">numDepsPollUntil</span><span class="op" id="7282066">(</span><span class="num" id="7282067">5</span><span class="op" id="7282068">,</span>&nbsp;<span class="ident" id="7282070">time</span><span class="op" id="7282074">.</span><span class="ident" id="7282075">Second</span><span class="op" id="7282081">)</span><span class="op" id="7282082">;</span>&nbsp;<span class="ident" id="7282084">n</span>&nbsp;<span class="op" id="7282086">&gt;</span>&nbsp;<span class="num" id="7282088">5</span>&nbsp;<span class="op" id="7282090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282094">t</span><span class="op" id="7282095">.</span><span class="ident" id="7282096">Errorf</span><span class="op" id="7282102">(</span><span class="string" id="7282103">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7282144">,</span>&nbsp;<span class="ident" id="7282146">n</span><span class="op" id="7282147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282151">db</span><span class="op" id="7282153">.</span><span class="ident" id="7282154">dumpDeps</span><span class="op" id="7282162">(</span><span class="ident" id="7282163">t</span><span class="op" id="7282164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282171">db</span><span class="op" id="7282173">.</span><span class="ident" id="7282174">SetMaxOpenConns</span><span class="op" id="7282189">(</span><span class="num" id="7282190">0</span><span class="op" id="7282191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282195">if</span>&nbsp;<span class="ident" id="7282198">g</span><span class="op" id="7282199">,</span>&nbsp;<span class="ident" id="7282201">w</span>&nbsp;<span class="op" id="7282203">:=</span>&nbsp;<span class="ident" id="7282206">db</span><span class="op" id="7282208">.</span><span class="ident" id="7282209">numFreeConns</span><span class="op" id="7282221">(</span><span class="op" id="7282222">)</span><span class="op" id="7282223">,</span>&nbsp;<span class="num" id="7282225">5</span><span class="op" id="7282226">;</span>&nbsp;<span class="ident" id="7282228">g</span>&nbsp;<span class="op" id="7282230">!=</span>&nbsp;<span class="ident" id="7282233">w</span>&nbsp;<span class="op" id="7282235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282239">t</span><span class="op" id="7282240">.</span><span class="ident" id="7282241">Errorf</span><span class="op" id="7282247">(</span><span class="string" id="7282248">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7282274">,</span>&nbsp;<span class="ident" id="7282276">g</span><span class="op" id="7282277">,</span>&nbsp;<span class="ident" id="7282279">w</span><span class="op" id="7282280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282283">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282287">if</span>&nbsp;<span class="ident" id="7282290">n</span>&nbsp;<span class="op" id="7282292">:=</span>&nbsp;<span class="ident" id="7282295">db</span><span class="op" id="7282297">.</span><span class="ident" id="7282298">numDepsPollUntil</span><span class="op" id="7282314">(</span><span class="num" id="7282315">5</span><span class="op" id="7282316">,</span>&nbsp;<span class="ident" id="7282318">time</span><span class="op" id="7282322">.</span><span class="ident" id="7282323">Second</span><span class="op" id="7282329">)</span><span class="op" id="7282330">;</span>&nbsp;<span class="ident" id="7282332">n</span>&nbsp;<span class="op" id="7282334">&gt;</span>&nbsp;<span class="num" id="7282336">5</span>&nbsp;<span class="op" id="7282338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282342">t</span><span class="op" id="7282343">.</span><span class="ident" id="7282344">Errorf</span><span class="op" id="7282350">(</span><span class="string" id="7282351">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7282392">,</span>&nbsp;<span class="ident" id="7282394">n</span><span class="op" id="7282395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282399">db</span><span class="op" id="7282401">.</span><span class="ident" id="7282402">dumpDeps</span><span class="op" id="7282410">(</span><span class="ident" id="7282411">t</span><span class="op" id="7282412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282415">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282419">db</span><span class="op" id="7282421">.</span><span class="ident" id="7282422">SetMaxIdleConns</span><span class="op" id="7282437">(</span><span class="num" id="7282438">0</span><span class="op" id="7282439">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282443">if</span>&nbsp;<span class="ident" id="7282446">g</span><span class="op" id="7282447">,</span>&nbsp;<span class="ident" id="7282449">w</span>&nbsp;<span class="op" id="7282451">:=</span>&nbsp;<span class="ident" id="7282454">db</span><span class="op" id="7282456">.</span><span class="ident" id="7282457">numFreeConns</span><span class="op" id="7282469">(</span><span class="op" id="7282470">)</span><span class="op" id="7282471">,</span>&nbsp;<span class="num" id="7282473">0</span><span class="op" id="7282474">;</span>&nbsp;<span class="ident" id="7282476">g</span>&nbsp;<span class="op" id="7282478">!=</span>&nbsp;<span class="ident" id="7282481">w</span>&nbsp;<span class="op" id="7282483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282487">t</span><span class="op" id="7282488">.</span><span class="ident" id="7282489">Errorf</span><span class="op" id="7282495">(</span><span class="string" id="7282496">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7282522">,</span>&nbsp;<span class="ident" id="7282524">g</span><span class="op" id="7282525">,</span>&nbsp;<span class="ident" id="7282527">w</span><span class="op" id="7282528">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282535">if</span>&nbsp;<span class="ident" id="7282538">n</span>&nbsp;<span class="op" id="7282540">:=</span>&nbsp;<span class="ident" id="7282543">db</span><span class="op" id="7282545">.</span><span class="ident" id="7282546">numDepsPollUntil</span><span class="op" id="7282562">(</span><span class="num" id="7282563">0</span><span class="op" id="7282564">,</span>&nbsp;<span class="ident" id="7282566">time</span><span class="op" id="7282570">.</span><span class="ident" id="7282571">Second</span><span class="op" id="7282577">)</span><span class="op" id="7282578">;</span>&nbsp;<span class="ident" id="7282580">n</span>&nbsp;<span class="op" id="7282582">&gt;</span>&nbsp;<span class="num" id="7282584">0</span>&nbsp;<span class="op" id="7282586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282590">t</span><span class="op" id="7282591">.</span><span class="ident" id="7282592">Errorf</span><span class="op" id="7282598">(</span><span class="string" id="7282599">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7282640">,</span>&nbsp;<span class="ident" id="7282642">n</span><span class="op" id="7282643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282647">db</span><span class="op" id="7282649">.</span><span class="ident" id="7282650">dumpDeps</span><span class="op" id="7282658">(</span><span class="ident" id="7282659">t</span><span class="op" id="7282660">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282663">}</span><br>
<span class="lineno"></span><span class="op" id="7282665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7282668">func</span>&nbsp;<span class="ident" id="7282673">TestSingleOpenConn</span><span class="op" id="7282691">(</span><span class="ident" id="7282692">t</span>&nbsp;<span class="op" id="7282694">*</span><span class="ident" id="7282695">testing</span><span class="op" id="7282702">.</span><span class="ident" id="7282703">T</span><span class="op" id="7282704">)</span>&nbsp;<span class="op" id="7282706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282709">db</span>&nbsp;<span class="op" id="7282712">:=</span>&nbsp;<span class="ident" id="7282715">newTestDB</span><span class="op" id="7282724">(</span><span class="ident" id="7282725">t</span><span class="op" id="7282726">,</span>&nbsp;<span class="string" id="7282728">&#34;people&#34;</span><span class="op" id="7282736">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282739">defer</span>&nbsp;<span class="ident" id="7282745">closeDB</span><span class="op" id="7282752">(</span><span class="ident" id="7282753">t</span><span class="op" id="7282754">,</span>&nbsp;<span class="ident" id="7282756">db</span><span class="op" id="7282758">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282762">db</span><span class="op" id="7282764">.</span><span class="ident" id="7282765">SetMaxOpenConns</span><span class="op" id="7282780">(</span><span class="num" id="7282781">1</span><span class="op" id="7282782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282786">rows</span><span class="op" id="7282790">,</span>&nbsp;<span class="ident" id="7282792">err</span>&nbsp;<span class="op" id="7282796">:=</span>&nbsp;<span class="ident" id="7282799">db</span><span class="op" id="7282801">.</span><span class="ident" id="7282802">Query</span><span class="op" id="7282807">(</span><span class="string" id="7282808">&#34;SELECT|people|name|&#34;</span><span class="op" id="7282829">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282832">if</span>&nbsp;<span class="ident" id="7282835">err</span>&nbsp;<span class="op" id="7282839">!=</span>&nbsp;<span class="ident" id="7282842">nil</span>&nbsp;<span class="op" id="7282846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282850">t</span><span class="op" id="7282851">.</span><span class="ident" id="7282852">Fatal</span><span class="op" id="7282857">(</span><span class="ident" id="7282858">err</span><span class="op" id="7282861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282867">if</span>&nbsp;<span class="ident" id="7282870">err</span>&nbsp;<span class="op" id="7282874">=</span>&nbsp;<span class="ident" id="7282876">rows</span><span class="op" id="7282880">.</span><span class="ident" id="7282881">Close</span><span class="op" id="7282886">(</span><span class="op" id="7282887">)</span><span class="op" id="7282888">;</span>&nbsp;<span class="ident" id="7282890">err</span>&nbsp;<span class="op" id="7282894">!=</span>&nbsp;<span class="ident" id="7282897">nil</span>&nbsp;<span class="op" id="7282901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282905">t</span><span class="op" id="7282906">.</span><span class="ident" id="7282907">Fatal</span><span class="op" id="7282912">(</span><span class="ident" id="7282913">err</span><span class="op" id="7282916">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7282919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7282922">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7282945">rows</span><span class="op" id="7282949">,</span>&nbsp;<span class="ident" id="7282951">err</span>&nbsp;<span class="op" id="7282955">=</span>&nbsp;<span class="ident" id="7282957">db</span><span class="op" id="7282959">.</span><span class="ident" id="7282960">Query</span><span class="op" id="7282965">(</span><span class="string" id="7282966">&#34;SELECT|people|name|&#34;</span><span class="op" id="7282987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7282990">if</span>&nbsp;<span class="ident" id="7282993">err</span>&nbsp;<span class="op" id="7282997">!=</span>&nbsp;<span class="ident" id="7283000">nil</span>&nbsp;<span class="op" id="7283004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283008">t</span><span class="op" id="7283009">.</span><span class="ident" id="7283010">Fatal</span><span class="op" id="7283015">(</span><span class="ident" id="7283016">err</span><span class="op" id="7283019">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283025">if</span>&nbsp;<span class="ident" id="7283028">err</span>&nbsp;<span class="op" id="7283032">=</span>&nbsp;<span class="ident" id="7283034">rows</span><span class="op" id="7283038">.</span><span class="ident" id="7283039">Close</span><span class="op" id="7283044">(</span><span class="op" id="7283045">)</span><span class="op" id="7283046">;</span>&nbsp;<span class="ident" id="7283048">err</span>&nbsp;<span class="op" id="7283052">!=</span>&nbsp;<span class="ident" id="7283055">nil</span>&nbsp;<span class="op" id="7283059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283063">t</span><span class="op" id="7283064">.</span><span class="ident" id="7283065">Fatal</span><span class="op" id="7283070">(</span><span class="ident" id="7283071">err</span><span class="op" id="7283074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283077">}</span><br>
<span class="lineno"></span><span class="op" id="7283079">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="7283082">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="7283107">func</span>&nbsp;<span class="ident" id="7283112">TestStmtCloseDeps</span><span class="op" id="7283129">(</span><span class="ident" id="7283130">t</span>&nbsp;<span class="op" id="7283132">*</span><span class="ident" id="7283133">testing</span><span class="op" id="7283140">.</span><span class="ident" id="7283141">T</span><span class="op" id="7283142">)</span>&nbsp;<span class="op" id="7283144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283147">if</span>&nbsp;<span class="ident" id="7283150">testing</span><span class="op" id="7283157">.</span><span class="ident" id="7283158">Short</span><span class="op" id="7283163">(</span><span class="op" id="7283164">)</span>&nbsp;<span class="op" id="7283166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283170">t</span><span class="op" id="7283171">.</span><span class="ident" id="7283172">Skip</span><span class="op" id="7283176">(</span><span class="string" id="7283177">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7283201">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283207">defer</span>&nbsp;<span class="ident" id="7283213">setHookpostCloseConn</span><span class="op" id="7283233">(</span><span class="ident" id="7283234">nil</span><span class="op" id="7283237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283240">setHookpostCloseConn</span><span class="op" id="7283260">(</span><span class="keyword" id="7283261">func</span><span class="op" id="7283265">(</span><span class="ident" id="7283266">_</span>&nbsp;<span class="op" id="7283268">*</span><span class="ident" id="7283269">fakeConn</span><span class="op" id="7283277">,</span>&nbsp;<span class="ident" id="7283279">err</span>&nbsp;<span class="builtintype" id="7283283">error</span><span class="op" id="7283288">)</span>&nbsp;<span class="op" id="7283290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283294">if</span>&nbsp;<span class="ident" id="7283297">err</span>&nbsp;<span class="op" id="7283301">!=</span>&nbsp;<span class="ident" id="7283304">nil</span>&nbsp;<span class="op" id="7283308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283313">t</span><span class="op" id="7283314">.</span><span class="ident" id="7283315">Errorf</span><span class="op" id="7283321">(</span><span class="string" id="7283322">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7283350">,</span>&nbsp;<span class="ident" id="7283352">err</span><span class="op" id="7283355">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283362">}</span><span class="op" id="7283363">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283367">db</span>&nbsp;<span class="op" id="7283370">:=</span>&nbsp;<span class="ident" id="7283373">newTestDB</span><span class="op" id="7283382">(</span><span class="ident" id="7283383">t</span><span class="op" id="7283384">,</span>&nbsp;<span class="string" id="7283386">&#34;magicquery&#34;</span><span class="op" id="7283398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283401">defer</span>&nbsp;<span class="ident" id="7283407">closeDB</span><span class="op" id="7283414">(</span><span class="ident" id="7283415">t</span><span class="op" id="7283416">,</span>&nbsp;<span class="ident" id="7283418">db</span><span class="op" id="7283420">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283424">driver</span>&nbsp;<span class="op" id="7283431">:=</span>&nbsp;<span class="ident" id="7283434">db</span><span class="op" id="7283436">.</span><span class="ident" id="7283437">driver</span><span class="op" id="7283443">.</span><span class="op" id="7283444">(</span><span class="op" id="7283445">*</span><span class="ident" id="7283446">fakeDriver</span><span class="op" id="7283456">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283460">driver</span><span class="op" id="7283466">.</span><span class="ident" id="7283467">mu</span><span class="op" id="7283469">.</span><span class="ident" id="7283470">Lock</span><span class="op" id="7283474">(</span><span class="op" id="7283475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283478">opens0</span>&nbsp;<span class="op" id="7283485">:=</span>&nbsp;<span class="ident" id="7283488">driver</span><span class="op" id="7283494">.</span><span class="ident" id="7283495">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283506">closes0</span>&nbsp;<span class="op" id="7283514">:=</span>&nbsp;<span class="ident" id="7283517">driver</span><span class="op" id="7283523">.</span><span class="ident" id="7283524">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283536">driver</span><span class="op" id="7283542">.</span><span class="ident" id="7283543">mu</span><span class="op" id="7283545">.</span><span class="ident" id="7283546">Unlock</span><span class="op" id="7283552">(</span><span class="op" id="7283553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283556">openDelta0</span>&nbsp;<span class="op" id="7283567">:=</span>&nbsp;<span class="ident" id="7283570">opens0</span>&nbsp;<span class="op" id="7283577">-</span>&nbsp;<span class="ident" id="7283579">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283589">stmt</span><span class="op" id="7283593">,</span>&nbsp;<span class="ident" id="7283595">err</span>&nbsp;<span class="op" id="7283599">:=</span>&nbsp;<span class="ident" id="7283602">db</span><span class="op" id="7283604">.</span><span class="ident" id="7283605">Prepare</span><span class="op" id="7283612">(</span><span class="string" id="7283613">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7283649">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283652">if</span>&nbsp;<span class="ident" id="7283655">err</span>&nbsp;<span class="op" id="7283659">!=</span>&nbsp;<span class="ident" id="7283662">nil</span>&nbsp;<span class="op" id="7283666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283670">t</span><span class="op" id="7283671">.</span><span class="ident" id="7283672">Fatal</span><span class="op" id="7283677">(</span><span class="ident" id="7283678">err</span><span class="op" id="7283681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7283688">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283724">const</span>&nbsp;<span class="op" id="7283730">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283734">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283746">=</span>&nbsp;<span class="num" id="7283748">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283753">sleepMillis</span>&nbsp;<span class="op" id="7283765">=</span>&nbsp;<span class="num" id="7283767">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283772">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283784">=</span>&nbsp;<span class="num" id="7283786">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7283789">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283792">var</span>&nbsp;<span class="ident" id="7283796">wg</span>&nbsp;<span class="ident" id="7283799">sync</span><span class="op" id="7283803">.</span><span class="ident" id="7283804">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283815">for</span>&nbsp;<span class="ident" id="7283819">batch</span>&nbsp;<span class="op" id="7283825">:=</span>&nbsp;<span class="num" id="7283828">0</span><span class="op" id="7283829">;</span>&nbsp;<span class="ident" id="7283831">batch</span>&nbsp;<span class="op" id="7283837">&lt;</span>&nbsp;<span class="ident" id="7283839">nbatch</span><span class="op" id="7283845">;</span>&nbsp;<span class="ident" id="7283847">batch</span><span class="op" id="7283852">++</span>&nbsp;<span class="op" id="7283855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283859">for</span>&nbsp;<span class="ident" id="7283863">i</span>&nbsp;<span class="op" id="7283865">:=</span>&nbsp;<span class="num" id="7283868">0</span><span class="op" id="7283869">;</span>&nbsp;<span class="ident" id="7283871">i</span>&nbsp;<span class="op" id="7283873">&lt;</span>&nbsp;<span class="ident" id="7283875">nquery</span><span class="op" id="7283881">;</span>&nbsp;<span class="ident" id="7283883">i</span><span class="op" id="7283884">++</span>&nbsp;<span class="op" id="7283887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7283892">wg</span><span class="op" id="7283894">.</span><span class="ident" id="7283895">Add</span><span class="op" id="7283898">(</span><span class="num" id="7283899">1</span><span class="op" id="7283900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283905">go</span>&nbsp;<span class="keyword" id="7283908">func</span><span class="op" id="7283912">(</span><span class="op" id="7283913">)</span>&nbsp;<span class="op" id="7283915">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283921">defer</span>&nbsp;<span class="ident" id="7283927">wg</span><span class="op" id="7283929">.</span><span class="ident" id="7283930">Done</span><span class="op" id="7283934">(</span><span class="op" id="7283935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283941">var</span>&nbsp;<span class="ident" id="7283945">op</span>&nbsp;<span class="builtintype" id="7283948">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7283959">if</span>&nbsp;<span class="ident" id="7283962">err</span>&nbsp;<span class="op" id="7283966">:=</span>&nbsp;<span class="ident" id="7283969">stmt</span><span class="op" id="7283973">.</span><span class="ident" id="7283974">QueryRow</span><span class="op" id="7283982">(</span><span class="string" id="7283983">&#34;sleep&#34;</span><span class="op" id="7283990">,</span>&nbsp;<span class="ident" id="7283992">sleepMillis</span><span class="op" id="7284003">)</span><span class="op" id="7284004">.</span><span class="ident" id="7284005">Scan</span><span class="op" id="7284009">(</span><span class="op" id="7284010">&amp;</span><span class="ident" id="7284011">op</span><span class="op" id="7284013">)</span><span class="op" id="7284014">;</span>&nbsp;<span class="ident" id="7284016">err</span>&nbsp;<span class="op" id="7284020">!=</span>&nbsp;<span class="ident" id="7284023">nil</span>&nbsp;<span class="op" id="7284027">&amp;&amp;</span>&nbsp;<span class="ident" id="7284030">err</span>&nbsp;<span class="op" id="7284034">!=</span>&nbsp;<span class="ident" id="7284037">ErrNoRows</span>&nbsp;<span class="op" id="7284047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284054">t</span><span class="op" id="7284055">.</span><span class="ident" id="7284056">Error</span><span class="op" id="7284061">(</span><span class="ident" id="7284062">err</span><span class="op" id="7284065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284071">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284076">}</span><span class="op" id="7284077">(</span><span class="op" id="7284078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7284086">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7284143">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7284200">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284221">time</span><span class="op" id="7284225">.</span><span class="ident" id="7284226">Sleep</span><span class="op" id="7284231">(</span><span class="num" id="7284232">2</span>&nbsp;<span class="op" id="7284234">*</span>&nbsp;<span class="ident" id="7284236">sleepMillis</span>&nbsp;<span class="op" id="7284248">*</span>&nbsp;<span class="ident" id="7284250">time</span><span class="op" id="7284254">.</span><span class="ident" id="7284255">Millisecond</span><span class="op" id="7284266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284272">wg</span><span class="op" id="7284274">.</span><span class="ident" id="7284275">Wait</span><span class="op" id="7284279">(</span><span class="op" id="7284280">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7284284">if</span>&nbsp;<span class="ident" id="7284287">g</span><span class="op" id="7284288">,</span>&nbsp;<span class="ident" id="7284290">w</span>&nbsp;<span class="op" id="7284292">:=</span>&nbsp;<span class="ident" id="7284295">db</span><span class="op" id="7284297">.</span><span class="ident" id="7284298">numFreeConns</span><span class="op" id="7284310">(</span><span class="op" id="7284311">)</span><span class="op" id="7284312">,</span>&nbsp;<span class="num" id="7284314">2</span><span class="op" id="7284315">;</span>&nbsp;<span class="ident" id="7284317">g</span>&nbsp;<span class="op" id="7284319">!=</span>&nbsp;<span class="ident" id="7284322">w</span>&nbsp;<span class="op" id="7284324">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284328">t</span><span class="op" id="7284329">.</span><span class="ident" id="7284330">Errorf</span><span class="op" id="7284336">(</span><span class="string" id="7284337">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7284363">,</span>&nbsp;<span class="ident" id="7284365">g</span><span class="op" id="7284366">,</span>&nbsp;<span class="ident" id="7284368">w</span><span class="op" id="7284369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7284376">if</span>&nbsp;<span class="ident" id="7284379">n</span>&nbsp;<span class="op" id="7284381">:=</span>&nbsp;<span class="ident" id="7284384">db</span><span class="op" id="7284386">.</span><span class="ident" id="7284387">numDepsPollUntil</span><span class="op" id="7284403">(</span><span class="num" id="7284404">4</span><span class="op" id="7284405">,</span>&nbsp;<span class="ident" id="7284407">time</span><span class="op" id="7284411">.</span><span class="ident" id="7284412">Second</span><span class="op" id="7284418">)</span><span class="op" id="7284419">;</span>&nbsp;<span class="ident" id="7284421">n</span>&nbsp;<span class="op" id="7284423">&gt;</span>&nbsp;<span class="num" id="7284425">4</span>&nbsp;<span class="op" id="7284427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284431">t</span><span class="op" id="7284432">.</span><span class="ident" id="7284433">Errorf</span><span class="op" id="7284439">(</span><span class="string" id="7284440">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="7284484">,</span>&nbsp;<span class="ident" id="7284486">n</span><span class="op" id="7284487">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284491">db</span><span class="op" id="7284493">.</span><span class="ident" id="7284494">dumpDeps</span><span class="op" id="7284502">(</span><span class="ident" id="7284503">t</span><span class="op" id="7284504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284511">driver</span><span class="op" id="7284517">.</span><span class="ident" id="7284518">mu</span><span class="op" id="7284520">.</span><span class="ident" id="7284521">Lock</span><span class="op" id="7284525">(</span><span class="op" id="7284526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284529">opens</span>&nbsp;<span class="op" id="7284535">:=</span>&nbsp;<span class="ident" id="7284538">driver</span><span class="op" id="7284544">.</span><span class="ident" id="7284545">openCount</span>&nbsp;<span class="op" id="7284555">-</span>&nbsp;<span class="ident" id="7284557">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284565">closes</span>&nbsp;<span class="op" id="7284572">:=</span>&nbsp;<span class="ident" id="7284575">driver</span><span class="op" id="7284581">.</span><span class="ident" id="7284582">closeCount</span>&nbsp;<span class="op" id="7284593">-</span>&nbsp;<span class="ident" id="7284595">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284604">openDelta</span>&nbsp;<span class="op" id="7284614">:=</span>&nbsp;<span class="op" id="7284617">(</span><span class="ident" id="7284618">driver</span><span class="op" id="7284624">.</span><span class="ident" id="7284625">openCount</span>&nbsp;<span class="op" id="7284635">-</span>&nbsp;<span class="ident" id="7284637">driver</span><span class="op" id="7284643">.</span><span class="ident" id="7284644">closeCount</span><span class="op" id="7284654">)</span>&nbsp;<span class="op" id="7284656">-</span>&nbsp;<span class="ident" id="7284658">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284670">driver</span><span class="op" id="7284676">.</span><span class="ident" id="7284677">mu</span><span class="op" id="7284679">.</span><span class="ident" id="7284680">Unlock</span><span class="op" id="7284686">(</span><span class="op" id="7284687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7284691">if</span>&nbsp;<span class="ident" id="7284694">openDelta</span>&nbsp;<span class="op" id="7284704">&gt;</span>&nbsp;<span class="num" id="7284706">2</span>&nbsp;<span class="op" id="7284708">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284712">t</span><span class="op" id="7284713">.</span><span class="ident" id="7284714">Logf</span><span class="op" id="7284718">(</span><span class="string" id="7284719">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7284736">,</span>&nbsp;<span class="ident" id="7284738">opens</span><span class="op" id="7284743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284747">t</span><span class="op" id="7284748">.</span><span class="ident" id="7284749">Logf</span><span class="op" id="7284753">(</span><span class="string" id="7284754">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7284772">,</span>&nbsp;<span class="ident" id="7284774">closes</span><span class="op" id="7284780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284784">t</span><span class="op" id="7284785">.</span><span class="ident" id="7284786">Logf</span><span class="op" id="7284790">(</span><span class="string" id="7284791">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7284808">,</span>&nbsp;<span class="ident" id="7284810">openDelta</span><span class="op" id="7284819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284823">t</span><span class="op" id="7284824">.</span><span class="ident" id="7284825">Errorf</span><span class="op" id="7284831">(</span><span class="string" id="7284832">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7284871">,</span>&nbsp;<span class="ident" id="7284873">openDelta</span><span class="op" id="7284882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284886">db</span><span class="op" id="7284888">.</span><span class="ident" id="7284889">dumpDeps</span><span class="op" id="7284897">(</span><span class="ident" id="7284898">t</span><span class="op" id="7284899">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7284902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7284906">if</span>&nbsp;<span class="builtinfunc" id="7284909">len</span><span class="op" id="7284912">(</span><span class="ident" id="7284913">stmt</span><span class="op" id="7284917">.</span><span class="ident" id="7284918">css</span><span class="op" id="7284921">)</span>&nbsp;<span class="op" id="7284923">&gt;</span>&nbsp;<span class="ident" id="7284925">nquery</span>&nbsp;<span class="op" id="7284932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7284936">t</span><span class="op" id="7284937">.</span><span class="ident" id="7284938">Errorf</span><span class="op" id="7284944">(</span><span class="string" id="7284945">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="7284977">,</span>&nbsp;<span class="builtinfunc" id="7284979">len</span><span class="op" id="7284982">(</span><span class="ident" id="7284983">stmt</span><span class="op" id="7284987">.</span><span class="ident" id="7284988">css</span><span class="op" id="7284991">)</span><span class="op" id="7284992">,</span>&nbsp;<span class="ident" id="7284994">nquery</span><span class="op" id="7285000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285003">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285007">if</span>&nbsp;<span class="ident" id="7285010">err</span>&nbsp;<span class="op" id="7285014">:=</span>&nbsp;<span class="ident" id="7285017">stmt</span><span class="op" id="7285021">.</span><span class="ident" id="7285022">Close</span><span class="op" id="7285027">(</span><span class="op" id="7285028">)</span><span class="op" id="7285029">;</span>&nbsp;<span class="ident" id="7285031">err</span>&nbsp;<span class="op" id="7285035">!=</span>&nbsp;<span class="ident" id="7285038">nil</span>&nbsp;<span class="op" id="7285042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285046">t</span><span class="op" id="7285047">.</span><span class="ident" id="7285048">Fatal</span><span class="op" id="7285053">(</span><span class="ident" id="7285054">err</span><span class="op" id="7285057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285064">if</span>&nbsp;<span class="ident" id="7285067">g</span><span class="op" id="7285068">,</span>&nbsp;<span class="ident" id="7285070">w</span>&nbsp;<span class="op" id="7285072">:=</span>&nbsp;<span class="ident" id="7285075">db</span><span class="op" id="7285077">.</span><span class="ident" id="7285078">numFreeConns</span><span class="op" id="7285090">(</span><span class="op" id="7285091">)</span><span class="op" id="7285092">,</span>&nbsp;<span class="num" id="7285094">2</span><span class="op" id="7285095">;</span>&nbsp;<span class="ident" id="7285097">g</span>&nbsp;<span class="op" id="7285099">!=</span>&nbsp;<span class="ident" id="7285102">w</span>&nbsp;<span class="op" id="7285104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285108">t</span><span class="op" id="7285109">.</span><span class="ident" id="7285110">Errorf</span><span class="op" id="7285116">(</span><span class="string" id="7285117">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7285143">,</span>&nbsp;<span class="ident" id="7285145">g</span><span class="op" id="7285146">,</span>&nbsp;<span class="ident" id="7285148">w</span><span class="op" id="7285149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285156">if</span>&nbsp;<span class="ident" id="7285159">n</span>&nbsp;<span class="op" id="7285161">:=</span>&nbsp;<span class="ident" id="7285164">db</span><span class="op" id="7285166">.</span><span class="ident" id="7285167">numDepsPollUntil</span><span class="op" id="7285183">(</span><span class="num" id="7285184">2</span><span class="op" id="7285185">,</span>&nbsp;<span class="ident" id="7285187">time</span><span class="op" id="7285191">.</span><span class="ident" id="7285192">Second</span><span class="op" id="7285198">)</span><span class="op" id="7285199">;</span>&nbsp;<span class="ident" id="7285201">n</span>&nbsp;<span class="op" id="7285203">&gt;</span>&nbsp;<span class="num" id="7285205">2</span>&nbsp;<span class="op" id="7285207">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285211">t</span><span class="op" id="7285212">.</span><span class="ident" id="7285213">Errorf</span><span class="op" id="7285219">(</span><span class="string" id="7285220">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7285264">,</span>&nbsp;<span class="ident" id="7285266">n</span><span class="op" id="7285267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285271">db</span><span class="op" id="7285273">.</span><span class="ident" id="7285274">dumpDeps</span><span class="op" id="7285282">(</span><span class="ident" id="7285283">t</span><span class="op" id="7285284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285291">db</span><span class="op" id="7285293">.</span><span class="ident" id="7285294">SetMaxIdleConns</span><span class="op" id="7285309">(</span><span class="num" id="7285310">0</span><span class="op" id="7285311">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285315">if</span>&nbsp;<span class="ident" id="7285318">g</span><span class="op" id="7285319">,</span>&nbsp;<span class="ident" id="7285321">w</span>&nbsp;<span class="op" id="7285323">:=</span>&nbsp;<span class="ident" id="7285326">db</span><span class="op" id="7285328">.</span><span class="ident" id="7285329">numFreeConns</span><span class="op" id="7285341">(</span><span class="op" id="7285342">)</span><span class="op" id="7285343">,</span>&nbsp;<span class="num" id="7285345">0</span><span class="op" id="7285346">;</span>&nbsp;<span class="ident" id="7285348">g</span>&nbsp;<span class="op" id="7285350">!=</span>&nbsp;<span class="ident" id="7285353">w</span>&nbsp;<span class="op" id="7285355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285359">t</span><span class="op" id="7285360">.</span><span class="ident" id="7285361">Errorf</span><span class="op" id="7285367">(</span><span class="string" id="7285368">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7285394">,</span>&nbsp;<span class="ident" id="7285396">g</span><span class="op" id="7285397">,</span>&nbsp;<span class="ident" id="7285399">w</span><span class="op" id="7285400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285407">if</span>&nbsp;<span class="ident" id="7285410">n</span>&nbsp;<span class="op" id="7285412">:=</span>&nbsp;<span class="ident" id="7285415">db</span><span class="op" id="7285417">.</span><span class="ident" id="7285418">numDepsPollUntil</span><span class="op" id="7285434">(</span><span class="num" id="7285435">0</span><span class="op" id="7285436">,</span>&nbsp;<span class="ident" id="7285438">time</span><span class="op" id="7285442">.</span><span class="ident" id="7285443">Second</span><span class="op" id="7285449">)</span><span class="op" id="7285450">;</span>&nbsp;<span class="ident" id="7285452">n</span>&nbsp;<span class="op" id="7285454">&gt;</span>&nbsp;<span class="num" id="7285456">0</span>&nbsp;<span class="op" id="7285458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285462">t</span><span class="op" id="7285463">.</span><span class="ident" id="7285464">Errorf</span><span class="op" id="7285470">(</span><span class="string" id="7285471">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7285512">,</span>&nbsp;<span class="ident" id="7285514">n</span><span class="op" id="7285515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285519">db</span><span class="op" id="7285521">.</span><span class="ident" id="7285522">dumpDeps</span><span class="op" id="7285530">(</span><span class="ident" id="7285531">t</span><span class="op" id="7285532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285535">}</span><br>
<span class="lineno"></span><span class="op" id="7285537">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="7285540">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="7285565">func</span>&nbsp;<span class="ident" id="7285570">TestCloseConnBeforeStmts</span><span class="op" id="7285594">(</span><span class="ident" id="7285595">t</span>&nbsp;<span class="op" id="7285597">*</span><span class="ident" id="7285598">testing</span><span class="op" id="7285605">.</span><span class="ident" id="7285606">T</span><span class="op" id="7285607">)</span>&nbsp;<span class="op" id="7285609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285612">db</span>&nbsp;<span class="op" id="7285615">:=</span>&nbsp;<span class="ident" id="7285618">newTestDB</span><span class="op" id="7285627">(</span><span class="ident" id="7285628">t</span><span class="op" id="7285629">,</span>&nbsp;<span class="string" id="7285631">&#34;people&#34;</span><span class="op" id="7285639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285642">defer</span>&nbsp;<span class="ident" id="7285648">closeDB</span><span class="op" id="7285655">(</span><span class="ident" id="7285656">t</span><span class="op" id="7285657">,</span>&nbsp;<span class="ident" id="7285659">db</span><span class="op" id="7285661">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285665">defer</span>&nbsp;<span class="ident" id="7285671">setHookpostCloseConn</span><span class="op" id="7285691">(</span><span class="ident" id="7285692">nil</span><span class="op" id="7285695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285698">setHookpostCloseConn</span><span class="op" id="7285718">(</span><span class="keyword" id="7285719">func</span><span class="op" id="7285723">(</span><span class="ident" id="7285724">_</span>&nbsp;<span class="op" id="7285726">*</span><span class="ident" id="7285727">fakeConn</span><span class="op" id="7285735">,</span>&nbsp;<span class="ident" id="7285737">err</span>&nbsp;<span class="builtintype" id="7285741">error</span><span class="op" id="7285746">)</span>&nbsp;<span class="op" id="7285748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285752">if</span>&nbsp;<span class="ident" id="7285755">err</span>&nbsp;<span class="op" id="7285759">!=</span>&nbsp;<span class="ident" id="7285762">nil</span>&nbsp;<span class="op" id="7285766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285771">t</span><span class="op" id="7285772">.</span><span class="ident" id="7285773">Errorf</span><span class="op" id="7285779">(</span><span class="string" id="7285780">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="7285817">,</span>&nbsp;<span class="ident" id="7285819">err</span><span class="op" id="7285822">,</span>&nbsp;<span class="ident" id="7285824">stack</span><span class="op" id="7285829">(</span><span class="op" id="7285830">)</span><span class="op" id="7285831">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285836">db</span><span class="op" id="7285838">.</span><span class="ident" id="7285839">dumpDeps</span><span class="op" id="7285847">(</span><span class="ident" id="7285848">t</span><span class="op" id="7285849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285854">t</span><span class="op" id="7285855">.</span><span class="ident" id="7285856">Errorf</span><span class="op" id="7285862">(</span><span class="string" id="7285863">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7285873">,</span>&nbsp;<span class="ident" id="7285875">db</span><span class="op" id="7285877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285884">}</span><span class="op" id="7285885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285889">stmt</span><span class="op" id="7285893">,</span>&nbsp;<span class="ident" id="7285895">err</span>&nbsp;<span class="op" id="7285899">:=</span>&nbsp;<span class="ident" id="7285902">db</span><span class="op" id="7285904">.</span><span class="ident" id="7285905">Prepare</span><span class="op" id="7285912">(</span><span class="string" id="7285913">&#34;SELECT|people|name|&#34;</span><span class="op" id="7285934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285937">if</span>&nbsp;<span class="ident" id="7285940">err</span>&nbsp;<span class="op" id="7285944">!=</span>&nbsp;<span class="ident" id="7285947">nil</span>&nbsp;<span class="op" id="7285951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7285955">t</span><span class="op" id="7285956">.</span><span class="ident" id="7285957">Fatal</span><span class="op" id="7285962">(</span><span class="ident" id="7285963">err</span><span class="op" id="7285966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7285969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7285973">if</span>&nbsp;<span class="builtinfunc" id="7285976">len</span><span class="op" id="7285979">(</span><span class="ident" id="7285980">db</span><span class="op" id="7285982">.</span><span class="ident" id="7285983">freeConn</span><span class="op" id="7285991">)</span>&nbsp;<span class="op" id="7285993">!=</span>&nbsp;<span class="num" id="7285996">1</span>&nbsp;<span class="op" id="7285998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286002">t</span><span class="op" id="7286003">.</span><span class="ident" id="7286004">Fatalf</span><span class="op" id="7286010">(</span><span class="string" id="7286011">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7286040">,</span>&nbsp;<span class="builtinfunc" id="7286042">len</span><span class="op" id="7286045">(</span><span class="ident" id="7286046">db</span><span class="op" id="7286048">.</span><span class="ident" id="7286049">freeConn</span><span class="op" id="7286057">)</span><span class="op" id="7286058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286064">dc</span>&nbsp;<span class="op" id="7286067">:=</span>&nbsp;<span class="ident" id="7286070">db</span><span class="op" id="7286072">.</span><span class="ident" id="7286073">freeConn</span><span class="op" id="7286081">[</span><span class="num" id="7286082">0</span><span class="op" id="7286083">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286086">if</span>&nbsp;<span class="ident" id="7286089">dc</span><span class="op" id="7286091">.</span><span class="ident" id="7286092">closed</span>&nbsp;<span class="op" id="7286099">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286103">t</span><span class="op" id="7286104">.</span><span class="ident" id="7286105">Errorf</span><span class="op" id="7286111">(</span><span class="string" id="7286112">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7286138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286145">if</span>&nbsp;<span class="ident" id="7286148">n</span>&nbsp;<span class="op" id="7286150">:=</span>&nbsp;<span class="builtinfunc" id="7286153">len</span><span class="op" id="7286156">(</span><span class="ident" id="7286157">dc</span><span class="op" id="7286159">.</span><span class="ident" id="7286160">openStmt</span><span class="op" id="7286168">)</span><span class="op" id="7286169">;</span>&nbsp;<span class="ident" id="7286171">n</span>&nbsp;<span class="op" id="7286173">!=</span>&nbsp;<span class="num" id="7286176">1</span>&nbsp;<span class="op" id="7286178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286182">t</span><span class="op" id="7286183">.</span><span class="ident" id="7286184">Errorf</span><span class="op" id="7286190">(</span><span class="string" id="7286191">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7286229">,</span>&nbsp;<span class="ident" id="7286231">n</span><span class="op" id="7286232">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286238">err</span>&nbsp;<span class="op" id="7286242">=</span>&nbsp;<span class="ident" id="7286244">db</span><span class="op" id="7286246">.</span><span class="ident" id="7286247">Close</span><span class="op" id="7286252">(</span><span class="op" id="7286253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286256">if</span>&nbsp;<span class="ident" id="7286259">err</span>&nbsp;<span class="op" id="7286263">!=</span>&nbsp;<span class="ident" id="7286266">nil</span>&nbsp;<span class="op" id="7286270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286274">t</span><span class="op" id="7286275">.</span><span class="ident" id="7286276">Errorf</span><span class="op" id="7286282">(</span><span class="string" id="7286283">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7286298">,</span>&nbsp;<span class="ident" id="7286300">err</span><span class="op" id="7286303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286306">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286309">if</span>&nbsp;<span class="op" id="7286312">!</span><span class="ident" id="7286313">dc</span><span class="op" id="7286315">.</span><span class="ident" id="7286316">closed</span>&nbsp;<span class="op" id="7286323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286327">t</span><span class="op" id="7286328">.</span><span class="ident" id="7286329">Errorf</span><span class="op" id="7286335">(</span><span class="string" id="7286336">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7286381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286387">if</span>&nbsp;<span class="ident" id="7286390">n</span>&nbsp;<span class="op" id="7286392">:=</span>&nbsp;<span class="builtinfunc" id="7286395">len</span><span class="op" id="7286398">(</span><span class="ident" id="7286399">dc</span><span class="op" id="7286401">.</span><span class="ident" id="7286402">openStmt</span><span class="op" id="7286410">)</span><span class="op" id="7286411">;</span>&nbsp;<span class="ident" id="7286413">n</span>&nbsp;<span class="op" id="7286415">!=</span>&nbsp;<span class="num" id="7286418">0</span>&nbsp;<span class="op" id="7286420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286424">t</span><span class="op" id="7286425">.</span><span class="ident" id="7286426">Errorf</span><span class="op" id="7286432">(</span><span class="string" id="7286433">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7286471">,</span>&nbsp;<span class="ident" id="7286473">n</span><span class="op" id="7286474">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286481">err</span>&nbsp;<span class="op" id="7286485">=</span>&nbsp;<span class="ident" id="7286487">stmt</span><span class="op" id="7286491">.</span><span class="ident" id="7286492">Close</span><span class="op" id="7286497">(</span><span class="op" id="7286498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286501">if</span>&nbsp;<span class="ident" id="7286504">err</span>&nbsp;<span class="op" id="7286508">!=</span>&nbsp;<span class="ident" id="7286511">nil</span>&nbsp;<span class="op" id="7286515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286519">t</span><span class="op" id="7286520">.</span><span class="ident" id="7286521">Errorf</span><span class="op" id="7286527">(</span><span class="string" id="7286528">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7286545">,</span>&nbsp;<span class="ident" id="7286547">err</span><span class="op" id="7286550">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286557">if</span>&nbsp;<span class="op" id="7286560">!</span><span class="ident" id="7286561">dc</span><span class="op" id="7286563">.</span><span class="ident" id="7286564">closed</span>&nbsp;<span class="op" id="7286571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286575">t</span><span class="op" id="7286576">.</span><span class="ident" id="7286577">Errorf</span><span class="op" id="7286583">(</span><span class="string" id="7286584">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7286607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286610">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286613">if</span>&nbsp;<span class="ident" id="7286616">dc</span><span class="op" id="7286618">.</span><span class="ident" id="7286619">ci</span>&nbsp;<span class="op" id="7286622">!=</span>&nbsp;<span class="ident" id="7286625">nil</span>&nbsp;<span class="op" id="7286629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286633">t</span><span class="op" id="7286634">.</span><span class="ident" id="7286635">Errorf</span><span class="op" id="7286641">(</span><span class="string" id="7286642">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="7286703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7286706">}</span><br>
<span class="lineno"></span><span class="op" id="7286708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="7286711">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="7286781">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="7286811">func</span>&nbsp;<span class="ident" id="7286816">TestRowsCloseOrder</span><span class="op" id="7286834">(</span><span class="ident" id="7286835">t</span>&nbsp;<span class="op" id="7286837">*</span><span class="ident" id="7286838">testing</span><span class="op" id="7286845">.</span><span class="ident" id="7286846">T</span><span class="op" id="7286847">)</span>&nbsp;<span class="op" id="7286849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286852">db</span>&nbsp;<span class="op" id="7286855">:=</span>&nbsp;<span class="ident" id="7286858">newTestDB</span><span class="op" id="7286867">(</span><span class="ident" id="7286868">t</span><span class="op" id="7286869">,</span>&nbsp;<span class="string" id="7286871">&#34;people&#34;</span><span class="op" id="7286879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286882">defer</span>&nbsp;<span class="ident" id="7286888">closeDB</span><span class="op" id="7286895">(</span><span class="ident" id="7286896">t</span><span class="op" id="7286897">,</span>&nbsp;<span class="ident" id="7286899">db</span><span class="op" id="7286901">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286905">db</span><span class="op" id="7286907">.</span><span class="ident" id="7286908">SetMaxIdleConns</span><span class="op" id="7286923">(</span><span class="num" id="7286924">0</span><span class="op" id="7286925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286928">setStrictFakeConnClose</span><span class="op" id="7286950">(</span><span class="ident" id="7286951">t</span><span class="op" id="7286952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7286955">defer</span>&nbsp;<span class="ident" id="7286961">setStrictFakeConnClose</span><span class="op" id="7286983">(</span><span class="ident" id="7286984">nil</span><span class="op" id="7286987">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7286991">rows</span><span class="op" id="7286995">,</span>&nbsp;<span class="ident" id="7286997">err</span>&nbsp;<span class="op" id="7287001">:=</span>&nbsp;<span class="ident" id="7287004">db</span><span class="op" id="7287006">.</span><span class="ident" id="7287007">Query</span><span class="op" id="7287012">(</span><span class="string" id="7287013">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7287038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287041">if</span>&nbsp;<span class="ident" id="7287044">err</span>&nbsp;<span class="op" id="7287048">!=</span>&nbsp;<span class="ident" id="7287051">nil</span>&nbsp;<span class="op" id="7287055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287059">t</span><span class="op" id="7287060">.</span><span class="ident" id="7287061">Fatal</span><span class="op" id="7287066">(</span><span class="ident" id="7287067">err</span><span class="op" id="7287070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287076">err</span>&nbsp;<span class="op" id="7287080">=</span>&nbsp;<span class="ident" id="7287082">rows</span><span class="op" id="7287086">.</span><span class="ident" id="7287087">Close</span><span class="op" id="7287092">(</span><span class="op" id="7287093">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287096">if</span>&nbsp;<span class="ident" id="7287099">err</span>&nbsp;<span class="op" id="7287103">!=</span>&nbsp;<span class="ident" id="7287106">nil</span>&nbsp;<span class="op" id="7287110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287114">t</span><span class="op" id="7287115">.</span><span class="ident" id="7287116">Fatal</span><span class="op" id="7287121">(</span><span class="ident" id="7287122">err</span><span class="op" id="7287125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287128">}</span><br>
<span class="lineno"></span><span class="op" id="7287130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="7287133">func</span>&nbsp;<span class="ident" id="7287138">TestRowsImplicitClose</span><span class="op" id="7287159">(</span><span class="ident" id="7287160">t</span>&nbsp;<span class="op" id="7287162">*</span><span class="ident" id="7287163">testing</span><span class="op" id="7287170">.</span><span class="ident" id="7287171">T</span><span class="op" id="7287172">)</span>&nbsp;<span class="op" id="7287174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287177">db</span>&nbsp;<span class="op" id="7287180">:=</span>&nbsp;<span class="ident" id="7287183">newTestDB</span><span class="op" id="7287192">(</span><span class="ident" id="7287193">t</span><span class="op" id="7287194">,</span>&nbsp;<span class="string" id="7287196">&#34;people&#34;</span><span class="op" id="7287204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287207">defer</span>&nbsp;<span class="ident" id="7287213">closeDB</span><span class="op" id="7287220">(</span><span class="ident" id="7287221">t</span><span class="op" id="7287222">,</span>&nbsp;<span class="ident" id="7287224">db</span><span class="op" id="7287226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287230">rows</span><span class="op" id="7287234">,</span>&nbsp;<span class="ident" id="7287236">err</span>&nbsp;<span class="op" id="7287240">:=</span>&nbsp;<span class="ident" id="7287243">db</span><span class="op" id="7287245">.</span><span class="ident" id="7287246">Query</span><span class="op" id="7287251">(</span><span class="string" id="7287252">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7287277">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287280">if</span>&nbsp;<span class="ident" id="7287283">err</span>&nbsp;<span class="op" id="7287287">!=</span>&nbsp;<span class="ident" id="7287290">nil</span>&nbsp;<span class="op" id="7287294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287298">t</span><span class="op" id="7287299">.</span><span class="ident" id="7287300">Fatal</span><span class="op" id="7287305">(</span><span class="ident" id="7287306">err</span><span class="op" id="7287309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287316">want</span><span class="op" id="7287320">,</span>&nbsp;<span class="ident" id="7287322">fail</span>&nbsp;<span class="op" id="7287327">:=</span>&nbsp;<span class="num" id="7287330">2</span><span class="op" id="7287331">,</span>&nbsp;<span class="ident" id="7287333">errors</span><span class="op" id="7287339">.</span><span class="ident" id="7287340">New</span><span class="op" id="7287343">(</span><span class="string" id="7287344">&#34;fail&#34;</span><span class="op" id="7287350">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287353">r</span>&nbsp;<span class="op" id="7287355">:=</span>&nbsp;<span class="ident" id="7287358">rows</span><span class="op" id="7287362">.</span><span class="ident" id="7287363">rowsi</span><span class="op" id="7287368">.</span><span class="op" id="7287369">(</span><span class="op" id="7287370">*</span><span class="ident" id="7287371">rowsCursor</span><span class="op" id="7287381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287384">r</span><span class="op" id="7287385">.</span><span class="ident" id="7287386">errPos</span><span class="op" id="7287392">,</span>&nbsp;<span class="ident" id="7287394">r</span><span class="op" id="7287395">.</span><span class="ident" id="7287396">err</span>&nbsp;<span class="op" id="7287400">=</span>&nbsp;<span class="ident" id="7287402">want</span><span class="op" id="7287406">,</span>&nbsp;<span class="ident" id="7287408">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287415">got</span>&nbsp;<span class="op" id="7287419">:=</span>&nbsp;<span class="num" id="7287422">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287425">for</span>&nbsp;<span class="ident" id="7287429">rows</span><span class="op" id="7287433">.</span><span class="ident" id="7287434">Next</span><span class="op" id="7287438">(</span><span class="op" id="7287439">)</span>&nbsp;<span class="op" id="7287441">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287445">got</span><span class="op" id="7287448">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287455">if</span>&nbsp;<span class="ident" id="7287458">got</span>&nbsp;<span class="op" id="7287462">!=</span>&nbsp;<span class="ident" id="7287465">want</span>&nbsp;<span class="op" id="7287470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287474">t</span><span class="op" id="7287475">.</span><span class="ident" id="7287476">Errorf</span><span class="op" id="7287482">(</span><span class="string" id="7287483">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7287505">,</span>&nbsp;<span class="ident" id="7287507">got</span><span class="op" id="7287510">,</span>&nbsp;<span class="ident" id="7287512">want</span><span class="op" id="7287516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287519">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287522">if</span>&nbsp;<span class="ident" id="7287525">err</span>&nbsp;<span class="op" id="7287529">:=</span>&nbsp;<span class="ident" id="7287532">rows</span><span class="op" id="7287536">.</span><span class="ident" id="7287537">Err</span><span class="op" id="7287540">(</span><span class="op" id="7287541">)</span><span class="op" id="7287542">;</span>&nbsp;<span class="ident" id="7287544">err</span>&nbsp;<span class="op" id="7287548">!=</span>&nbsp;<span class="ident" id="7287551">fail</span>&nbsp;<span class="op" id="7287556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287560">t</span><span class="op" id="7287561">.</span><span class="ident" id="7287562">Errorf</span><span class="op" id="7287568">(</span><span class="string" id="7287569">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7287592">,</span>&nbsp;<span class="ident" id="7287594">err</span><span class="op" id="7287597">,</span>&nbsp;<span class="ident" id="7287599">fail</span><span class="op" id="7287603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287609">if</span>&nbsp;<span class="op" id="7287612">!</span><span class="ident" id="7287613">r</span><span class="op" id="7287614">.</span><span class="ident" id="7287615">closed</span>&nbsp;<span class="op" id="7287622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287626">t</span><span class="op" id="7287627">.</span><span class="ident" id="7287628">Errorf</span><span class="op" id="7287634">(</span><span class="string" id="7287635">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="7287665">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287668">}</span><br>
<span class="lineno"></span><span class="op" id="7287670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7287673">func</span>&nbsp;<span class="ident" id="7287678">TestStmtCloseOrder</span><span class="op" id="7287696">(</span><span class="ident" id="7287697">t</span>&nbsp;<span class="op" id="7287699">*</span><span class="ident" id="7287700">testing</span><span class="op" id="7287707">.</span><span class="ident" id="7287708">T</span><span class="op" id="7287709">)</span>&nbsp;<span class="op" id="7287711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287714">db</span>&nbsp;<span class="op" id="7287717">:=</span>&nbsp;<span class="ident" id="7287720">newTestDB</span><span class="op" id="7287729">(</span><span class="ident" id="7287730">t</span><span class="op" id="7287731">,</span>&nbsp;<span class="string" id="7287733">&#34;people&#34;</span><span class="op" id="7287741">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287744">defer</span>&nbsp;<span class="ident" id="7287750">closeDB</span><span class="op" id="7287757">(</span><span class="ident" id="7287758">t</span><span class="op" id="7287759">,</span>&nbsp;<span class="ident" id="7287761">db</span><span class="op" id="7287763">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287767">db</span><span class="op" id="7287769">.</span><span class="ident" id="7287770">SetMaxIdleConns</span><span class="op" id="7287785">(</span><span class="num" id="7287786">0</span><span class="op" id="7287787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287790">setStrictFakeConnClose</span><span class="op" id="7287812">(</span><span class="ident" id="7287813">t</span><span class="op" id="7287814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287817">defer</span>&nbsp;<span class="ident" id="7287823">setStrictFakeConnClose</span><span class="op" id="7287845">(</span><span class="ident" id="7287846">nil</span><span class="op" id="7287849">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287853">_</span><span class="op" id="7287854">,</span>&nbsp;<span class="ident" id="7287856">err</span>&nbsp;<span class="op" id="7287860">:=</span>&nbsp;<span class="ident" id="7287863">db</span><span class="op" id="7287865">.</span><span class="ident" id="7287866">Query</span><span class="op" id="7287871">(</span><span class="string" id="7287872">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="7287899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7287902">if</span>&nbsp;<span class="ident" id="7287905">err</span>&nbsp;<span class="op" id="7287909">==</span>&nbsp;<span class="ident" id="7287912">nil</span>&nbsp;<span class="op" id="7287916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7287920">t</span><span class="op" id="7287921">.</span><span class="ident" id="7287922">Fatal</span><span class="op" id="7287927">(</span><span class="string" id="7287928">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="7287968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7287971">}</span><br>
<span class="lineno">1315</span><span class="op" id="7287973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7287976">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="7288001">func</span>&nbsp;<span class="ident" id="7288006">TestErrBadConnReconnect</span><span class="op" id="7288029">(</span><span class="ident" id="7288030">t</span>&nbsp;<span class="op" id="7288032">*</span><span class="ident" id="7288033">testing</span><span class="op" id="7288040">.</span><span class="ident" id="7288041">T</span><span class="op" id="7288042">)</span>&nbsp;<span class="op" id="7288044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288047">db</span>&nbsp;<span class="op" id="7288050">:=</span>&nbsp;<span class="ident" id="7288053">newTestDB</span><span class="op" id="7288062">(</span><span class="ident" id="7288063">t</span><span class="op" id="7288064">,</span>&nbsp;<span class="string" id="7288066">&#34;foo&#34;</span><span class="op" id="7288071">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288074">defer</span>&nbsp;<span class="ident" id="7288080">closeDB</span><span class="op" id="7288087">(</span><span class="ident" id="7288088">t</span><span class="op" id="7288089">,</span>&nbsp;<span class="ident" id="7288091">db</span><span class="op" id="7288093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288096">exec</span><span class="op" id="7288100">(</span><span class="ident" id="7288101">t</span><span class="op" id="7288102">,</span>&nbsp;<span class="ident" id="7288104">db</span><span class="op" id="7288106">,</span>&nbsp;<span class="string" id="7288108">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7288151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288155">simulateBadConn</span>&nbsp;<span class="op" id="7288171">:=</span>&nbsp;<span class="keyword" id="7288174">func</span><span class="op" id="7288178">(</span><span class="ident" id="7288179">name</span>&nbsp;<span class="builtintype" id="7288184">string</span><span class="op" id="7288190">,</span>&nbsp;<span class="ident" id="7288192">hook</span>&nbsp;<span class="op" id="7288197">*</span><span class="keyword" id="7288198">func</span><span class="op" id="7288202">(</span><span class="op" id="7288203">)</span>&nbsp;<span class="builtintype" id="7288205">bool</span><span class="op" id="7288209">,</span>&nbsp;<span class="ident" id="7288211">op</span>&nbsp;<span class="keyword" id="7288214">func</span><span class="op" id="7288218">(</span><span class="op" id="7288219">)</span>&nbsp;<span class="builtintype" id="7288221">error</span><span class="op" id="7288226">)</span>&nbsp;<span class="op" id="7288228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288232">broken</span><span class="op" id="7288238">,</span>&nbsp;<span class="ident" id="7288240">retried</span>&nbsp;<span class="op" id="7288248">:=</span>&nbsp;<span class="builtintype" id="7288251">false</span><span class="op" id="7288256">,</span>&nbsp;<span class="builtintype" id="7288258">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288266">numOpen</span>&nbsp;<span class="op" id="7288274">:=</span>&nbsp;<span class="ident" id="7288277">db</span><span class="op" id="7288279">.</span><span class="ident" id="7288280">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7288291">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288342">*</span><span class="ident" id="7288343">hook</span>&nbsp;<span class="op" id="7288348">=</span>&nbsp;<span class="keyword" id="7288350">func</span><span class="op" id="7288354">(</span><span class="op" id="7288355">)</span>&nbsp;<span class="builtintype" id="7288357">bool</span>&nbsp;<span class="op" id="7288362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288367">if</span>&nbsp;<span class="op" id="7288370">!</span><span class="ident" id="7288371">broken</span>&nbsp;<span class="op" id="7288378">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288384">broken</span>&nbsp;<span class="op" id="7288391">=</span>&nbsp;<span class="builtintype" id="7288393">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288402">return</span>&nbsp;<span class="builtintype" id="7288409">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288422">retried</span>&nbsp;<span class="op" id="7288430">=</span>&nbsp;<span class="builtintype" id="7288432">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288440">return</span>&nbsp;<span class="builtintype" id="7288447">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288460">if</span>&nbsp;<span class="ident" id="7288463">err</span>&nbsp;<span class="op" id="7288467">:=</span>&nbsp;<span class="ident" id="7288470">op</span><span class="op" id="7288472">(</span><span class="op" id="7288473">)</span><span class="op" id="7288474">;</span>&nbsp;<span class="ident" id="7288476">err</span>&nbsp;<span class="op" id="7288480">!=</span>&nbsp;<span class="ident" id="7288483">nil</span>&nbsp;<span class="op" id="7288487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288492">t</span><span class="op" id="7288493">.</span><span class="ident" id="7288494">Errorf</span><span class="op" id="7288500">(</span><span class="ident" id="7288501">name</span><span class="op" id="7288505">+</span><span class="string" id="7288506">&#34;:&nbsp;%v&#34;</span><span class="op" id="7288512">,</span>&nbsp;<span class="ident" id="7288514">err</span><span class="op" id="7288517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288522">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288536">if</span>&nbsp;<span class="op" id="7288539">!</span><span class="ident" id="7288540">broken</span>&nbsp;<span class="op" id="7288547">||</span>&nbsp;<span class="op" id="7288550">!</span><span class="ident" id="7288551">retried</span>&nbsp;<span class="op" id="7288559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288564">t</span><span class="op" id="7288565">.</span><span class="ident" id="7288566">Error</span><span class="op" id="7288571">(</span><span class="ident" id="7288572">name</span>&nbsp;<span class="op" id="7288577">+</span>&nbsp;<span class="string" id="7288579">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="7288619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288623">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288627">*</span><span class="ident" id="7288628">hook</span>&nbsp;<span class="op" id="7288633">=</span>&nbsp;<span class="ident" id="7288635">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288642">if</span>&nbsp;<span class="ident" id="7288645">numOpen</span>&nbsp;<span class="op" id="7288653">!=</span>&nbsp;<span class="ident" id="7288656">db</span><span class="op" id="7288658">.</span><span class="ident" id="7288659">numOpen</span>&nbsp;<span class="op" id="7288667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288672">t</span><span class="op" id="7288673">.</span><span class="ident" id="7288674">Errorf</span><span class="op" id="7288680">(</span><span class="ident" id="7288681">name</span><span class="op" id="7288685">+</span><span class="string" id="7288686">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="7288714">,</span>&nbsp;<span class="ident" id="7288716">db</span><span class="op" id="7288718">.</span><span class="ident" id="7288719">numOpen</span><span class="op" id="7288726">-</span><span class="ident" id="7288727">numOpen</span><span class="op" id="7288734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288739">numOpen</span>&nbsp;<span class="op" id="7288747">=</span>&nbsp;<span class="ident" id="7288749">db</span><span class="op" id="7288751">.</span><span class="ident" id="7288752">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7288769">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288781">dbExec</span>&nbsp;<span class="op" id="7288788">:=</span>&nbsp;<span class="keyword" id="7288791">func</span><span class="op" id="7288795">(</span><span class="op" id="7288796">)</span>&nbsp;<span class="builtintype" id="7288798">error</span>&nbsp;<span class="op" id="7288804">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288808">_</span><span class="op" id="7288809">,</span>&nbsp;<span class="ident" id="7288811">err</span>&nbsp;<span class="op" id="7288815">:=</span>&nbsp;<span class="ident" id="7288818">db</span><span class="op" id="7288820">.</span><span class="ident" id="7288821">Exec</span><span class="op" id="7288825">(</span><span class="string" id="7288826">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7288857">,</span>&nbsp;<span class="string" id="7288859">&#34;Gordon&#34;</span><span class="op" id="7288867">,</span>&nbsp;<span class="num" id="7288869">3</span><span class="op" id="7288870">,</span>&nbsp;<span class="builtintype" id="7288872">true</span><span class="op" id="7288876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7288880">return</span>&nbsp;<span class="ident" id="7288887">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7288892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288895">simulateBadConn</span><span class="op" id="7288910">(</span><span class="string" id="7288911">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="7288928">,</span>&nbsp;<span class="op" id="7288930">&amp;</span><span class="ident" id="7288931">hookPrepareBadConn</span><span class="op" id="7288949">,</span>&nbsp;<span class="ident" id="7288951">dbExec</span><span class="op" id="7288957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7288960">simulateBadConn</span><span class="op" id="7288975">(</span><span class="string" id="7288976">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="7288990">,</span>&nbsp;<span class="op" id="7288992">&amp;</span><span class="ident" id="7288993">hookExecBadConn</span><span class="op" id="7289008">,</span>&nbsp;<span class="ident" id="7289010">dbExec</span><span class="op" id="7289016">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7289020">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289033">dbQuery</span>&nbsp;<span class="op" id="7289041">:=</span>&nbsp;<span class="keyword" id="7289044">func</span><span class="op" id="7289048">(</span><span class="op" id="7289049">)</span>&nbsp;<span class="builtintype" id="7289051">error</span>&nbsp;<span class="op" id="7289057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289061">rows</span><span class="op" id="7289065">,</span>&nbsp;<span class="ident" id="7289067">err</span>&nbsp;<span class="op" id="7289071">:=</span>&nbsp;<span class="ident" id="7289074">db</span><span class="op" id="7289076">.</span><span class="ident" id="7289077">Query</span><span class="op" id="7289082">(</span><span class="string" id="7289083">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7289104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289108">if</span>&nbsp;<span class="ident" id="7289111">err</span>&nbsp;<span class="op" id="7289115">==</span>&nbsp;<span class="ident" id="7289118">nil</span>&nbsp;<span class="op" id="7289122">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289127">err</span>&nbsp;<span class="op" id="7289131">=</span>&nbsp;<span class="ident" id="7289133">rows</span><span class="op" id="7289137">.</span><span class="ident" id="7289138">Close</span><span class="op" id="7289143">(</span><span class="op" id="7289144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289152">return</span>&nbsp;<span class="ident" id="7289159">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289167">simulateBadConn</span><span class="op" id="7289182">(</span><span class="string" id="7289183">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="7289201">,</span>&nbsp;<span class="op" id="7289203">&amp;</span><span class="ident" id="7289204">hookPrepareBadConn</span><span class="op" id="7289222">,</span>&nbsp;<span class="ident" id="7289224">dbQuery</span><span class="op" id="7289231">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289234">simulateBadConn</span><span class="op" id="7289249">(</span><span class="string" id="7289250">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="7289266">,</span>&nbsp;<span class="op" id="7289268">&amp;</span><span class="ident" id="7289269">hookQueryBadConn</span><span class="op" id="7289285">,</span>&nbsp;<span class="ident" id="7289287">dbQuery</span><span class="op" id="7289294">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7289298">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289313">simulateBadConn</span><span class="op" id="7289328">(</span><span class="string" id="7289329">&#34;db.Prepare&#34;</span><span class="op" id="7289341">,</span>&nbsp;<span class="op" id="7289343">&amp;</span><span class="ident" id="7289344">hookPrepareBadConn</span><span class="op" id="7289362">,</span>&nbsp;<span class="keyword" id="7289364">func</span><span class="op" id="7289368">(</span><span class="op" id="7289369">)</span>&nbsp;<span class="builtintype" id="7289371">error</span>&nbsp;<span class="op" id="7289377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289381">stmt</span><span class="op" id="7289385">,</span>&nbsp;<span class="ident" id="7289387">err</span>&nbsp;<span class="op" id="7289391">:=</span>&nbsp;<span class="ident" id="7289394">db</span><span class="op" id="7289396">.</span><span class="ident" id="7289397">Prepare</span><span class="op" id="7289404">(</span><span class="string" id="7289405">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7289436">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289440">if</span>&nbsp;<span class="ident" id="7289443">err</span>&nbsp;<span class="op" id="7289447">!=</span>&nbsp;<span class="ident" id="7289450">nil</span>&nbsp;<span class="op" id="7289454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289459">return</span>&nbsp;<span class="ident" id="7289466">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289476">stmt</span><span class="op" id="7289480">.</span><span class="ident" id="7289481">Close</span><span class="op" id="7289486">(</span><span class="op" id="7289487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289491">return</span>&nbsp;<span class="ident" id="7289498">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289503">}</span><span class="op" id="7289504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7289508">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289581">forcePrepare</span>&nbsp;<span class="op" id="7289594">:=</span>&nbsp;<span class="keyword" id="7289597">func</span><span class="op" id="7289601">(</span><span class="ident" id="7289602">stmt</span>&nbsp;<span class="op" id="7289607">*</span><span class="ident" id="7289608">Stmt</span><span class="op" id="7289612">)</span>&nbsp;<span class="op" id="7289614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289618">stmt</span><span class="op" id="7289622">.</span><span class="ident" id="7289623">css</span>&nbsp;<span class="op" id="7289627">=</span>&nbsp;<span class="ident" id="7289629">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7289638">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289652">stmt1</span><span class="op" id="7289657">,</span>&nbsp;<span class="ident" id="7289659">err</span>&nbsp;<span class="op" id="7289663">:=</span>&nbsp;<span class="ident" id="7289666">db</span><span class="op" id="7289668">.</span><span class="ident" id="7289669">Prepare</span><span class="op" id="7289676">(</span><span class="string" id="7289677">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7289708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289711">if</span>&nbsp;<span class="ident" id="7289714">err</span>&nbsp;<span class="op" id="7289718">!=</span>&nbsp;<span class="ident" id="7289721">nil</span>&nbsp;<span class="op" id="7289725">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289729">t</span><span class="op" id="7289730">.</span><span class="ident" id="7289731">Fatalf</span><span class="op" id="7289737">(</span><span class="string" id="7289738">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7289751">,</span>&nbsp;<span class="ident" id="7289753">err</span><span class="op" id="7289756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289762">defer</span>&nbsp;<span class="ident" id="7289768">stmt1</span><span class="op" id="7289773">.</span><span class="ident" id="7289774">Close</span><span class="op" id="7289779">(</span><span class="op" id="7289780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7289783">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289828">forcePrepare</span><span class="op" id="7289840">(</span><span class="ident" id="7289841">stmt1</span><span class="op" id="7289846">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289850">stmtExec</span>&nbsp;<span class="op" id="7289859">:=</span>&nbsp;<span class="keyword" id="7289862">func</span><span class="op" id="7289866">(</span><span class="op" id="7289867">)</span>&nbsp;<span class="builtintype" id="7289869">error</span>&nbsp;<span class="op" id="7289875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289879">_</span><span class="op" id="7289880">,</span>&nbsp;<span class="ident" id="7289882">err</span>&nbsp;<span class="op" id="7289886">:=</span>&nbsp;<span class="ident" id="7289889">stmt1</span><span class="op" id="7289894">.</span><span class="ident" id="7289895">Exec</span><span class="op" id="7289899">(</span><span class="string" id="7289900">&#34;Gopher&#34;</span><span class="op" id="7289908">,</span>&nbsp;<span class="num" id="7289910">3</span><span class="op" id="7289911">,</span>&nbsp;<span class="builtintype" id="7289913">false</span><span class="op" id="7289918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7289922">return</span>&nbsp;<span class="ident" id="7289929">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7289934">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7289937">simulateBadConn</span><span class="op" id="7289952">(</span><span class="string" id="7289953">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="7289972">,</span>&nbsp;<span class="op" id="7289974">&amp;</span><span class="ident" id="7289975">hookPrepareBadConn</span><span class="op" id="7289993">,</span>&nbsp;<span class="ident" id="7289995">stmtExec</span><span class="op" id="7290003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290006">simulateBadConn</span><span class="op" id="7290021">(</span><span class="string" id="7290022">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="7290038">,</span>&nbsp;<span class="op" id="7290040">&amp;</span><span class="ident" id="7290041">hookExecBadConn</span><span class="op" id="7290056">,</span>&nbsp;<span class="ident" id="7290058">stmtExec</span><span class="op" id="7290066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7290070">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290085">stmt2</span><span class="op" id="7290090">,</span>&nbsp;<span class="ident" id="7290092">err</span>&nbsp;<span class="op" id="7290096">:=</span>&nbsp;<span class="ident" id="7290099">db</span><span class="op" id="7290101">.</span><span class="ident" id="7290102">Prepare</span><span class="op" id="7290109">(</span><span class="string" id="7290110">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7290131">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290134">if</span>&nbsp;<span class="ident" id="7290137">err</span>&nbsp;<span class="op" id="7290141">!=</span>&nbsp;<span class="ident" id="7290144">nil</span>&nbsp;<span class="op" id="7290148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290152">t</span><span class="op" id="7290153">.</span><span class="ident" id="7290154">Fatalf</span><span class="op" id="7290160">(</span><span class="string" id="7290161">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7290174">,</span>&nbsp;<span class="ident" id="7290176">err</span><span class="op" id="7290179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7290182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290185">defer</span>&nbsp;<span class="ident" id="7290191">stmt2</span><span class="op" id="7290196">.</span><span class="ident" id="7290197">Close</span><span class="op" id="7290202">(</span><span class="op" id="7290203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7290206">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290251">forcePrepare</span><span class="op" id="7290263">(</span><span class="ident" id="7290264">stmt2</span><span class="op" id="7290269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290273">stmtQuery</span>&nbsp;<span class="op" id="7290283">:=</span>&nbsp;<span class="keyword" id="7290286">func</span><span class="op" id="7290290">(</span><span class="op" id="7290291">)</span>&nbsp;<span class="builtintype" id="7290293">error</span>&nbsp;<span class="op" id="7290299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290303">rows</span><span class="op" id="7290307">,</span>&nbsp;<span class="ident" id="7290309">err</span>&nbsp;<span class="op" id="7290313">:=</span>&nbsp;<span class="ident" id="7290316">stmt2</span><span class="op" id="7290321">.</span><span class="ident" id="7290322">Query</span><span class="op" id="7290327">(</span><span class="op" id="7290328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290332">if</span>&nbsp;<span class="ident" id="7290335">err</span>&nbsp;<span class="op" id="7290339">==</span>&nbsp;<span class="ident" id="7290342">nil</span>&nbsp;<span class="op" id="7290346">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290351">err</span>&nbsp;<span class="op" id="7290355">=</span>&nbsp;<span class="ident" id="7290357">rows</span><span class="op" id="7290361">.</span><span class="ident" id="7290362">Close</span><span class="op" id="7290367">(</span><span class="op" id="7290368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7290372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290376">return</span>&nbsp;<span class="ident" id="7290383">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7290388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290391">simulateBadConn</span><span class="op" id="7290406">(</span><span class="string" id="7290407">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="7290427">,</span>&nbsp;<span class="op" id="7290429">&amp;</span><span class="ident" id="7290430">hookPrepareBadConn</span><span class="op" id="7290448">,</span>&nbsp;<span class="ident" id="7290450">stmtQuery</span><span class="op" id="7290459">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290462">simulateBadConn</span><span class="op" id="7290477">(</span><span class="string" id="7290478">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="7290495">,</span>&nbsp;<span class="op" id="7290497">&amp;</span><span class="ident" id="7290498">hookQueryBadConn</span><span class="op" id="7290514">,</span>&nbsp;<span class="ident" id="7290516">stmtQuery</span><span class="op" id="7290525">)</span><br>
<span class="lineno"></span><span class="op" id="7290527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290530">type</span>&nbsp;<span class="ident" id="7290535">concurrentTest</span>&nbsp;<span class="keyword" id="7290550">interface</span>&nbsp;<span class="op" id="7290560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290563">init</span><span class="op" id="7290567">(</span><span class="ident" id="7290568">t</span>&nbsp;<span class="ident" id="7290570">testing</span><span class="op" id="7290577">.</span><span class="ident" id="7290578">TB</span><span class="op" id="7290580">,</span>&nbsp;<span class="ident" id="7290582">db</span>&nbsp;<span class="op" id="7290585">*</span><span class="ident" id="7290586">DB</span><span class="op" id="7290588">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290591">finish</span><span class="op" id="7290597">(</span><span class="ident" id="7290598">t</span>&nbsp;<span class="ident" id="7290600">testing</span><span class="op" id="7290607">.</span><span class="ident" id="7290608">TB</span><span class="op" id="7290610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290613">test</span><span class="op" id="7290617">(</span><span class="ident" id="7290618">t</span>&nbsp;<span class="ident" id="7290620">testing</span><span class="op" id="7290627">.</span><span class="ident" id="7290628">TB</span><span class="op" id="7290630">)</span>&nbsp;<span class="builtintype" id="7290632">error</span><br>
<span class="lineno"></span><span class="op" id="7290638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290641">type</span>&nbsp;<span class="ident" id="7290646">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="7290668">struct</span>&nbsp;<span class="op" id="7290675">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290678">db</span>&nbsp;<span class="op" id="7290681">*</span><span class="ident" id="7290682">DB</span><br>
<span class="lineno"></span><span class="op" id="7290685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290688">func</span>&nbsp;<span class="op" id="7290693">(</span><span class="ident" id="7290694">c</span>&nbsp;<span class="op" id="7290696">*</span><span class="ident" id="7290697">concurrentDBQueryTest</span><span class="op" id="7290718">)</span>&nbsp;<span class="ident" id="7290720">init</span><span class="op" id="7290724">(</span><span class="ident" id="7290725">t</span>&nbsp;<span class="ident" id="7290727">testing</span><span class="op" id="7290734">.</span><span class="ident" id="7290735">TB</span><span class="op" id="7290737">,</span>&nbsp;<span class="ident" id="7290739">db</span>&nbsp;<span class="op" id="7290742">*</span><span class="ident" id="7290743">DB</span><span class="op" id="7290745">)</span>&nbsp;<span class="op" id="7290747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290750">c</span><span class="op" id="7290751">.</span><span class="ident" id="7290752">db</span>&nbsp;<span class="op" id="7290755">=</span>&nbsp;<span class="ident" id="7290757">db</span><br>
<span class="lineno">1435</span><span class="op" id="7290760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7290763">func</span>&nbsp;<span class="op" id="7290768">(</span><span class="ident" id="7290769">c</span>&nbsp;<span class="op" id="7290771">*</span><span class="ident" id="7290772">concurrentDBQueryTest</span><span class="op" id="7290793">)</span>&nbsp;<span class="ident" id="7290795">finish</span><span class="op" id="7290801">(</span><span class="ident" id="7290802">t</span>&nbsp;<span class="ident" id="7290804">testing</span><span class="op" id="7290811">.</span><span class="ident" id="7290812">TB</span><span class="op" id="7290814">)</span>&nbsp;<span class="op" id="7290816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290819">c</span><span class="op" id="7290820">.</span><span class="ident" id="7290821">db</span>&nbsp;<span class="op" id="7290824">=</span>&nbsp;<span class="ident" id="7290826">nil</span><br>
<span class="lineno"></span><span class="op" id="7290830">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="7290833">func</span>&nbsp;<span class="op" id="7290838">(</span><span class="ident" id="7290839">c</span>&nbsp;<span class="op" id="7290841">*</span><span class="ident" id="7290842">concurrentDBQueryTest</span><span class="op" id="7290863">)</span>&nbsp;<span class="ident" id="7290865">test</span><span class="op" id="7290869">(</span><span class="ident" id="7290870">t</span>&nbsp;<span class="ident" id="7290872">testing</span><span class="op" id="7290879">.</span><span class="ident" id="7290880">TB</span><span class="op" id="7290882">)</span>&nbsp;<span class="builtintype" id="7290884">error</span>&nbsp;<span class="op" id="7290890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290893">rows</span><span class="op" id="7290897">,</span>&nbsp;<span class="ident" id="7290899">err</span>&nbsp;<span class="op" id="7290903">:=</span>&nbsp;<span class="ident" id="7290906">c</span><span class="op" id="7290907">.</span><span class="ident" id="7290908">db</span><span class="op" id="7290910">.</span><span class="ident" id="7290911">Query</span><span class="op" id="7290916">(</span><span class="string" id="7290917">&#34;SELECT|people|name|&#34;</span><span class="op" id="7290938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290941">if</span>&nbsp;<span class="ident" id="7290944">err</span>&nbsp;<span class="op" id="7290948">!=</span>&nbsp;<span class="ident" id="7290951">nil</span>&nbsp;<span class="op" id="7290955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7290959">t</span><span class="op" id="7290960">.</span><span class="ident" id="7290961">Error</span><span class="op" id="7290966">(</span><span class="ident" id="7290967">err</span><span class="op" id="7290970">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290974">return</span>&nbsp;<span class="ident" id="7290981">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7290986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7290989">var</span>&nbsp;<span class="ident" id="7290993">name</span>&nbsp;<span class="builtintype" id="7290998">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291006">for</span>&nbsp;<span class="ident" id="7291010">rows</span><span class="op" id="7291014">.</span><span class="ident" id="7291015">Next</span><span class="op" id="7291019">(</span><span class="op" id="7291020">)</span>&nbsp;<span class="op" id="7291022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291026">rows</span><span class="op" id="7291030">.</span><span class="ident" id="7291031">Scan</span><span class="op" id="7291035">(</span><span class="op" id="7291036">&amp;</span><span class="ident" id="7291037">name</span><span class="op" id="7291041">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7291044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291047">rows</span><span class="op" id="7291051">.</span><span class="ident" id="7291052">Close</span><span class="op" id="7291057">(</span><span class="op" id="7291058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291061">return</span>&nbsp;<span class="ident" id="7291068">nil</span><br>
<span class="lineno"></span><span class="op" id="7291072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="7291075">type</span>&nbsp;<span class="ident" id="7291080">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="7291101">struct</span>&nbsp;<span class="op" id="7291108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291111">db</span>&nbsp;<span class="op" id="7291114">*</span><span class="ident" id="7291115">DB</span><br>
<span class="lineno"></span><span class="op" id="7291118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291121">func</span>&nbsp;<span class="op" id="7291126">(</span><span class="ident" id="7291127">c</span>&nbsp;<span class="op" id="7291129">*</span><span class="ident" id="7291130">concurrentDBExecTest</span><span class="op" id="7291150">)</span>&nbsp;<span class="ident" id="7291152">init</span><span class="op" id="7291156">(</span><span class="ident" id="7291157">t</span>&nbsp;<span class="ident" id="7291159">testing</span><span class="op" id="7291166">.</span><span class="ident" id="7291167">TB</span><span class="op" id="7291169">,</span>&nbsp;<span class="ident" id="7291171">db</span>&nbsp;<span class="op" id="7291174">*</span><span class="ident" id="7291175">DB</span><span class="op" id="7291177">)</span>&nbsp;<span class="op" id="7291179">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291182">c</span><span class="op" id="7291183">.</span><span class="ident" id="7291184">db</span>&nbsp;<span class="op" id="7291187">=</span>&nbsp;<span class="ident" id="7291189">db</span><br>
<span class="lineno"></span><span class="op" id="7291192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291195">func</span>&nbsp;<span class="op" id="7291200">(</span><span class="ident" id="7291201">c</span>&nbsp;<span class="op" id="7291203">*</span><span class="ident" id="7291204">concurrentDBExecTest</span><span class="op" id="7291224">)</span>&nbsp;<span class="ident" id="7291226">finish</span><span class="op" id="7291232">(</span><span class="ident" id="7291233">t</span>&nbsp;<span class="ident" id="7291235">testing</span><span class="op" id="7291242">.</span><span class="ident" id="7291243">TB</span><span class="op" id="7291245">)</span>&nbsp;<span class="op" id="7291247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291250">c</span><span class="op" id="7291251">.</span><span class="ident" id="7291252">db</span>&nbsp;<span class="op" id="7291255">=</span>&nbsp;<span class="ident" id="7291257">nil</span><br>
<span class="lineno">1465</span><span class="op" id="7291261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291264">func</span>&nbsp;<span class="op" id="7291269">(</span><span class="ident" id="7291270">c</span>&nbsp;<span class="op" id="7291272">*</span><span class="ident" id="7291273">concurrentDBExecTest</span><span class="op" id="7291293">)</span>&nbsp;<span class="ident" id="7291295">test</span><span class="op" id="7291299">(</span><span class="ident" id="7291300">t</span>&nbsp;<span class="ident" id="7291302">testing</span><span class="op" id="7291309">.</span><span class="ident" id="7291310">TB</span><span class="op" id="7291312">)</span>&nbsp;<span class="builtintype" id="7291314">error</span>&nbsp;<span class="op" id="7291320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291323">_</span><span class="op" id="7291324">,</span>&nbsp;<span class="ident" id="7291326">err</span>&nbsp;<span class="op" id="7291330">:=</span>&nbsp;<span class="ident" id="7291333">c</span><span class="op" id="7291334">.</span><span class="ident" id="7291335">db</span><span class="op" id="7291337">.</span><span class="ident" id="7291338">Exec</span><span class="op" id="7291342">(</span><span class="string" id="7291343">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7291396">,</span>&nbsp;<span class="num" id="7291398">3</span><span class="op" id="7291399">,</span>&nbsp;<span class="ident" id="7291401">chrisBirthday</span><span class="op" id="7291414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291417">if</span>&nbsp;<span class="ident" id="7291420">err</span>&nbsp;<span class="op" id="7291424">!=</span>&nbsp;<span class="ident" id="7291427">nil</span>&nbsp;<span class="op" id="7291431">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291435">t</span><span class="op" id="7291436">.</span><span class="ident" id="7291437">Error</span><span class="op" id="7291442">(</span><span class="ident" id="7291443">err</span><span class="op" id="7291446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291450">return</span>&nbsp;<span class="ident" id="7291457">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7291462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291465">return</span>&nbsp;<span class="ident" id="7291472">nil</span><br>
<span class="lineno"></span><span class="op" id="7291476">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="7291479">type</span>&nbsp;<span class="ident" id="7291484">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="7291508">struct</span>&nbsp;<span class="op" id="7291515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291518">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7291523">*</span><span class="ident" id="7291524">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291528">stmt</span>&nbsp;<span class="op" id="7291533">*</span><span class="ident" id="7291534">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7291539">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="7291542">func</span>&nbsp;<span class="op" id="7291547">(</span><span class="ident" id="7291548">c</span>&nbsp;<span class="op" id="7291550">*</span><span class="ident" id="7291551">concurrentStmtQueryTest</span><span class="op" id="7291574">)</span>&nbsp;<span class="ident" id="7291576">init</span><span class="op" id="7291580">(</span><span class="ident" id="7291581">t</span>&nbsp;<span class="ident" id="7291583">testing</span><span class="op" id="7291590">.</span><span class="ident" id="7291591">TB</span><span class="op" id="7291593">,</span>&nbsp;<span class="ident" id="7291595">db</span>&nbsp;<span class="op" id="7291598">*</span><span class="ident" id="7291599">DB</span><span class="op" id="7291601">)</span>&nbsp;<span class="op" id="7291603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291606">c</span><span class="op" id="7291607">.</span><span class="ident" id="7291608">db</span>&nbsp;<span class="op" id="7291611">=</span>&nbsp;<span class="ident" id="7291613">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291617">var</span>&nbsp;<span class="ident" id="7291621">err</span>&nbsp;<span class="builtintype" id="7291625">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291632">c</span><span class="op" id="7291633">.</span><span class="ident" id="7291634">stmt</span><span class="op" id="7291638">,</span>&nbsp;<span class="ident" id="7291640">err</span>&nbsp;<span class="op" id="7291644">=</span>&nbsp;<span class="ident" id="7291646">db</span><span class="op" id="7291648">.</span><span class="ident" id="7291649">Prepare</span><span class="op" id="7291656">(</span><span class="string" id="7291657">&#34;SELECT|people|name|&#34;</span><span class="op" id="7291678">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291681">if</span>&nbsp;<span class="ident" id="7291684">err</span>&nbsp;<span class="op" id="7291688">!=</span>&nbsp;<span class="ident" id="7291691">nil</span>&nbsp;<span class="op" id="7291695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291699">t</span><span class="op" id="7291700">.</span><span class="ident" id="7291701">Fatal</span><span class="op" id="7291706">(</span><span class="ident" id="7291707">err</span><span class="op" id="7291710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7291713">}</span><br>
<span class="lineno"></span><span class="op" id="7291715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="7291718">func</span>&nbsp;<span class="op" id="7291723">(</span><span class="ident" id="7291724">c</span>&nbsp;<span class="op" id="7291726">*</span><span class="ident" id="7291727">concurrentStmtQueryTest</span><span class="op" id="7291750">)</span>&nbsp;<span class="ident" id="7291752">finish</span><span class="op" id="7291758">(</span><span class="ident" id="7291759">t</span>&nbsp;<span class="ident" id="7291761">testing</span><span class="op" id="7291768">.</span><span class="ident" id="7291769">TB</span><span class="op" id="7291771">)</span>&nbsp;<span class="op" id="7291773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291776">if</span>&nbsp;<span class="ident" id="7291779">c</span><span class="op" id="7291780">.</span><span class="ident" id="7291781">stmt</span>&nbsp;<span class="op" id="7291786">!=</span>&nbsp;<span class="ident" id="7291789">nil</span>&nbsp;<span class="op" id="7291793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291797">c</span><span class="op" id="7291798">.</span><span class="ident" id="7291799">stmt</span><span class="op" id="7291803">.</span><span class="ident" id="7291804">Close</span><span class="op" id="7291809">(</span><span class="op" id="7291810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291814">c</span><span class="op" id="7291815">.</span><span class="ident" id="7291816">stmt</span>&nbsp;<span class="op" id="7291821">=</span>&nbsp;<span class="ident" id="7291823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7291828">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291831">c</span><span class="op" id="7291832">.</span><span class="ident" id="7291833">db</span>&nbsp;<span class="op" id="7291836">=</span>&nbsp;<span class="ident" id="7291838">nil</span><br>
<span class="lineno"></span><span class="op" id="7291842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7291845">func</span>&nbsp;<span class="op" id="7291850">(</span><span class="ident" id="7291851">c</span>&nbsp;<span class="op" id="7291853">*</span><span class="ident" id="7291854">concurrentStmtQueryTest</span><span class="op" id="7291877">)</span>&nbsp;<span class="ident" id="7291879">test</span><span class="op" id="7291883">(</span><span class="ident" id="7291884">t</span>&nbsp;<span class="ident" id="7291886">testing</span><span class="op" id="7291893">.</span><span class="ident" id="7291894">TB</span><span class="op" id="7291896">)</span>&nbsp;<span class="builtintype" id="7291898">error</span>&nbsp;<span class="op" id="7291904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291907">rows</span><span class="op" id="7291911">,</span>&nbsp;<span class="ident" id="7291913">err</span>&nbsp;<span class="op" id="7291917">:=</span>&nbsp;<span class="ident" id="7291920">c</span><span class="op" id="7291921">.</span><span class="ident" id="7291922">stmt</span><span class="op" id="7291926">.</span><span class="ident" id="7291927">Query</span><span class="op" id="7291932">(</span><span class="op" id="7291933">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291936">if</span>&nbsp;<span class="ident" id="7291939">err</span>&nbsp;<span class="op" id="7291943">!=</span>&nbsp;<span class="ident" id="7291946">nil</span>&nbsp;<span class="op" id="7291950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7291954">t</span><span class="op" id="7291955">.</span><span class="ident" id="7291956">Errorf</span><span class="op" id="7291962">(</span><span class="string" id="7291963">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7291984">,</span>&nbsp;<span class="ident" id="7291986">err</span><span class="op" id="7291989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7291993">return</span>&nbsp;<span class="ident" id="7292000">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292009">var</span>&nbsp;<span class="ident" id="7292013">name</span>&nbsp;<span class="builtintype" id="7292018">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292026">for</span>&nbsp;<span class="ident" id="7292030">rows</span><span class="op" id="7292034">.</span><span class="ident" id="7292035">Next</span><span class="op" id="7292039">(</span><span class="op" id="7292040">)</span>&nbsp;<span class="op" id="7292042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292046">rows</span><span class="op" id="7292050">.</span><span class="ident" id="7292051">Scan</span><span class="op" id="7292055">(</span><span class="op" id="7292056">&amp;</span><span class="ident" id="7292057">name</span><span class="op" id="7292061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292067">rows</span><span class="op" id="7292071">.</span><span class="ident" id="7292072">Close</span><span class="op" id="7292077">(</span><span class="op" id="7292078">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292081">return</span>&nbsp;<span class="ident" id="7292088">nil</span><br>
<span class="lineno"></span><span class="op" id="7292092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292095">type</span>&nbsp;<span class="ident" id="7292100">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="7292123">struct</span>&nbsp;<span class="op" id="7292130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292133">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7292138">*</span><span class="ident" id="7292139">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292143">stmt</span>&nbsp;<span class="op" id="7292148">*</span><span class="ident" id="7292149">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7292154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292157">func</span>&nbsp;<span class="op" id="7292162">(</span><span class="ident" id="7292163">c</span>&nbsp;<span class="op" id="7292165">*</span><span class="ident" id="7292166">concurrentStmtExecTest</span><span class="op" id="7292188">)</span>&nbsp;<span class="ident" id="7292190">init</span><span class="op" id="7292194">(</span><span class="ident" id="7292195">t</span>&nbsp;<span class="ident" id="7292197">testing</span><span class="op" id="7292204">.</span><span class="ident" id="7292205">TB</span><span class="op" id="7292207">,</span>&nbsp;<span class="ident" id="7292209">db</span>&nbsp;<span class="op" id="7292212">*</span><span class="ident" id="7292213">DB</span><span class="op" id="7292215">)</span>&nbsp;<span class="op" id="7292217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292220">c</span><span class="op" id="7292221">.</span><span class="ident" id="7292222">db</span>&nbsp;<span class="op" id="7292225">=</span>&nbsp;<span class="ident" id="7292227">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292231">var</span>&nbsp;<span class="ident" id="7292235">err</span>&nbsp;<span class="builtintype" id="7292239">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292246">c</span><span class="op" id="7292247">.</span><span class="ident" id="7292248">stmt</span><span class="op" id="7292252">,</span>&nbsp;<span class="ident" id="7292254">err</span>&nbsp;<span class="op" id="7292258">=</span>&nbsp;<span class="ident" id="7292260">db</span><span class="op" id="7292262">.</span><span class="ident" id="7292263">Prepare</span><span class="op" id="7292270">(</span><span class="string" id="7292271">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7292324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292327">if</span>&nbsp;<span class="ident" id="7292330">err</span>&nbsp;<span class="op" id="7292334">!=</span>&nbsp;<span class="ident" id="7292337">nil</span>&nbsp;<span class="op" id="7292341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292345">t</span><span class="op" id="7292346">.</span><span class="ident" id="7292347">Fatal</span><span class="op" id="7292352">(</span><span class="ident" id="7292353">err</span><span class="op" id="7292356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292359">}</span><br>
<span class="lineno">1525</span><span class="op" id="7292361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292364">func</span>&nbsp;<span class="op" id="7292369">(</span><span class="ident" id="7292370">c</span>&nbsp;<span class="op" id="7292372">*</span><span class="ident" id="7292373">concurrentStmtExecTest</span><span class="op" id="7292395">)</span>&nbsp;<span class="ident" id="7292397">finish</span><span class="op" id="7292403">(</span><span class="ident" id="7292404">t</span>&nbsp;<span class="ident" id="7292406">testing</span><span class="op" id="7292413">.</span><span class="ident" id="7292414">TB</span><span class="op" id="7292416">)</span>&nbsp;<span class="op" id="7292418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292421">if</span>&nbsp;<span class="ident" id="7292424">c</span><span class="op" id="7292425">.</span><span class="ident" id="7292426">stmt</span>&nbsp;<span class="op" id="7292431">!=</span>&nbsp;<span class="ident" id="7292434">nil</span>&nbsp;<span class="op" id="7292438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292442">c</span><span class="op" id="7292443">.</span><span class="ident" id="7292444">stmt</span><span class="op" id="7292448">.</span><span class="ident" id="7292449">Close</span><span class="op" id="7292454">(</span><span class="op" id="7292455">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292459">c</span><span class="op" id="7292460">.</span><span class="ident" id="7292461">stmt</span>&nbsp;<span class="op" id="7292466">=</span>&nbsp;<span class="ident" id="7292468">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292476">c</span><span class="op" id="7292477">.</span><span class="ident" id="7292478">db</span>&nbsp;<span class="op" id="7292481">=</span>&nbsp;<span class="ident" id="7292483">nil</span><br>
<span class="lineno"></span><span class="op" id="7292487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="7292490">func</span>&nbsp;<span class="op" id="7292495">(</span><span class="ident" id="7292496">c</span>&nbsp;<span class="op" id="7292498">*</span><span class="ident" id="7292499">concurrentStmtExecTest</span><span class="op" id="7292521">)</span>&nbsp;<span class="ident" id="7292523">test</span><span class="op" id="7292527">(</span><span class="ident" id="7292528">t</span>&nbsp;<span class="ident" id="7292530">testing</span><span class="op" id="7292537">.</span><span class="ident" id="7292538">TB</span><span class="op" id="7292540">)</span>&nbsp;<span class="builtintype" id="7292542">error</span>&nbsp;<span class="op" id="7292548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292551">_</span><span class="op" id="7292552">,</span>&nbsp;<span class="ident" id="7292554">err</span>&nbsp;<span class="op" id="7292558">:=</span>&nbsp;<span class="ident" id="7292561">c</span><span class="op" id="7292562">.</span><span class="ident" id="7292563">stmt</span><span class="op" id="7292567">.</span><span class="ident" id="7292568">Exec</span><span class="op" id="7292572">(</span><span class="num" id="7292573">3</span><span class="op" id="7292574">,</span>&nbsp;<span class="ident" id="7292576">chrisBirthday</span><span class="op" id="7292589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292592">if</span>&nbsp;<span class="ident" id="7292595">err</span>&nbsp;<span class="op" id="7292599">!=</span>&nbsp;<span class="ident" id="7292602">nil</span>&nbsp;<span class="op" id="7292606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292610">t</span><span class="op" id="7292611">.</span><span class="ident" id="7292612">Errorf</span><span class="op" id="7292618">(</span><span class="string" id="7292619">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7292639">,</span>&nbsp;<span class="ident" id="7292641">err</span><span class="op" id="7292644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292648">return</span>&nbsp;<span class="ident" id="7292655">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292663">return</span>&nbsp;<span class="ident" id="7292670">nil</span><br>
<span class="lineno"></span><span class="op" id="7292674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292677">type</span>&nbsp;<span class="ident" id="7292682">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="7292704">struct</span>&nbsp;<span class="op" id="7292711">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292714">db</span>&nbsp;<span class="op" id="7292717">*</span><span class="ident" id="7292718">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292722">tx</span>&nbsp;<span class="op" id="7292725">*</span><span class="ident" id="7292726">Tx</span><br>
<span class="lineno"></span><span class="op" id="7292729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292732">func</span>&nbsp;<span class="op" id="7292737">(</span><span class="ident" id="7292738">c</span>&nbsp;<span class="op" id="7292740">*</span><span class="ident" id="7292741">concurrentTxQueryTest</span><span class="op" id="7292762">)</span>&nbsp;<span class="ident" id="7292764">init</span><span class="op" id="7292768">(</span><span class="ident" id="7292769">t</span>&nbsp;<span class="ident" id="7292771">testing</span><span class="op" id="7292778">.</span><span class="ident" id="7292779">TB</span><span class="op" id="7292781">,</span>&nbsp;<span class="ident" id="7292783">db</span>&nbsp;<span class="op" id="7292786">*</span><span class="ident" id="7292787">DB</span><span class="op" id="7292789">)</span>&nbsp;<span class="op" id="7292791">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292794">c</span><span class="op" id="7292795">.</span><span class="ident" id="7292796">db</span>&nbsp;<span class="op" id="7292799">=</span>&nbsp;<span class="ident" id="7292801">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292805">var</span>&nbsp;<span class="ident" id="7292809">err</span>&nbsp;<span class="builtintype" id="7292813">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292820">c</span><span class="op" id="7292821">.</span><span class="ident" id="7292822">tx</span><span class="op" id="7292824">,</span>&nbsp;<span class="ident" id="7292826">err</span>&nbsp;<span class="op" id="7292830">=</span>&nbsp;<span class="ident" id="7292832">c</span><span class="op" id="7292833">.</span><span class="ident" id="7292834">db</span><span class="op" id="7292836">.</span><span class="ident" id="7292837">Begin</span><span class="op" id="7292842">(</span><span class="op" id="7292843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292846">if</span>&nbsp;<span class="ident" id="7292849">err</span>&nbsp;<span class="op" id="7292853">!=</span>&nbsp;<span class="ident" id="7292856">nil</span>&nbsp;<span class="op" id="7292860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292864">t</span><span class="op" id="7292865">.</span><span class="ident" id="7292866">Fatal</span><span class="op" id="7292871">(</span><span class="ident" id="7292872">err</span><span class="op" id="7292875">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292878">}</span><br>
<span class="lineno"></span><span class="op" id="7292880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7292883">func</span>&nbsp;<span class="op" id="7292888">(</span><span class="ident" id="7292889">c</span>&nbsp;<span class="op" id="7292891">*</span><span class="ident" id="7292892">concurrentTxQueryTest</span><span class="op" id="7292913">)</span>&nbsp;<span class="ident" id="7292915">finish</span><span class="op" id="7292921">(</span><span class="ident" id="7292922">t</span>&nbsp;<span class="ident" id="7292924">testing</span><span class="op" id="7292931">.</span><span class="ident" id="7292932">TB</span><span class="op" id="7292934">)</span>&nbsp;<span class="op" id="7292936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7292939">if</span>&nbsp;<span class="ident" id="7292942">c</span><span class="op" id="7292943">.</span><span class="ident" id="7292944">tx</span>&nbsp;<span class="op" id="7292947">!=</span>&nbsp;<span class="ident" id="7292950">nil</span>&nbsp;<span class="op" id="7292954">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292958">c</span><span class="op" id="7292959">.</span><span class="ident" id="7292960">tx</span><span class="op" id="7292962">.</span><span class="ident" id="7292963">Rollback</span><span class="op" id="7292971">(</span><span class="op" id="7292972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292976">c</span><span class="op" id="7292977">.</span><span class="ident" id="7292978">tx</span>&nbsp;<span class="op" id="7292981">=</span>&nbsp;<span class="ident" id="7292983">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7292988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7292991">c</span><span class="op" id="7292992">.</span><span class="ident" id="7292993">db</span>&nbsp;<span class="op" id="7292996">=</span>&nbsp;<span class="ident" id="7292998">nil</span><br>
<span class="lineno"></span><span class="op" id="7293002">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="7293005">func</span>&nbsp;<span class="op" id="7293010">(</span><span class="ident" id="7293011">c</span>&nbsp;<span class="op" id="7293013">*</span><span class="ident" id="7293014">concurrentTxQueryTest</span><span class="op" id="7293035">)</span>&nbsp;<span class="ident" id="7293037">test</span><span class="op" id="7293041">(</span><span class="ident" id="7293042">t</span>&nbsp;<span class="ident" id="7293044">testing</span><span class="op" id="7293051">.</span><span class="ident" id="7293052">TB</span><span class="op" id="7293054">)</span>&nbsp;<span class="builtintype" id="7293056">error</span>&nbsp;<span class="op" id="7293062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293065">rows</span><span class="op" id="7293069">,</span>&nbsp;<span class="ident" id="7293071">err</span>&nbsp;<span class="op" id="7293075">:=</span>&nbsp;<span class="ident" id="7293078">c</span><span class="op" id="7293079">.</span><span class="ident" id="7293080">db</span><span class="op" id="7293082">.</span><span class="ident" id="7293083">Query</span><span class="op" id="7293088">(</span><span class="string" id="7293089">&#34;SELECT|people|name|&#34;</span><span class="op" id="7293110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293113">if</span>&nbsp;<span class="ident" id="7293116">err</span>&nbsp;<span class="op" id="7293120">!=</span>&nbsp;<span class="ident" id="7293123">nil</span>&nbsp;<span class="op" id="7293127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293131">t</span><span class="op" id="7293132">.</span><span class="ident" id="7293133">Error</span><span class="op" id="7293138">(</span><span class="ident" id="7293139">err</span><span class="op" id="7293142">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293146">return</span>&nbsp;<span class="ident" id="7293153">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7293158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293161">var</span>&nbsp;<span class="ident" id="7293165">name</span>&nbsp;<span class="builtintype" id="7293170">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293178">for</span>&nbsp;<span class="ident" id="7293182">rows</span><span class="op" id="7293186">.</span><span class="ident" id="7293187">Next</span><span class="op" id="7293191">(</span><span class="op" id="7293192">)</span>&nbsp;<span class="op" id="7293194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293198">rows</span><span class="op" id="7293202">.</span><span class="ident" id="7293203">Scan</span><span class="op" id="7293207">(</span><span class="op" id="7293208">&amp;</span><span class="ident" id="7293209">name</span><span class="op" id="7293213">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7293216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293219">rows</span><span class="op" id="7293223">.</span><span class="ident" id="7293224">Close</span><span class="op" id="7293229">(</span><span class="op" id="7293230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293233">return</span>&nbsp;<span class="ident" id="7293240">nil</span><br>
<span class="lineno"></span><span class="op" id="7293244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="7293247">type</span>&nbsp;<span class="ident" id="7293252">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="7293273">struct</span>&nbsp;<span class="op" id="7293280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293283">db</span>&nbsp;<span class="op" id="7293286">*</span><span class="ident" id="7293287">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293291">tx</span>&nbsp;<span class="op" id="7293294">*</span><span class="ident" id="7293295">Tx</span><br>
<span class="lineno"></span><span class="op" id="7293298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="7293301">func</span>&nbsp;<span class="op" id="7293306">(</span><span class="ident" id="7293307">c</span>&nbsp;<span class="op" id="7293309">*</span><span class="ident" id="7293310">concurrentTxExecTest</span><span class="op" id="7293330">)</span>&nbsp;<span class="ident" id="7293332">init</span><span class="op" id="7293336">(</span><span class="ident" id="7293337">t</span>&nbsp;<span class="ident" id="7293339">testing</span><span class="op" id="7293346">.</span><span class="ident" id="7293347">TB</span><span class="op" id="7293349">,</span>&nbsp;<span class="ident" id="7293351">db</span>&nbsp;<span class="op" id="7293354">*</span><span class="ident" id="7293355">DB</span><span class="op" id="7293357">)</span>&nbsp;<span class="op" id="7293359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293362">c</span><span class="op" id="7293363">.</span><span class="ident" id="7293364">db</span>&nbsp;<span class="op" id="7293367">=</span>&nbsp;<span class="ident" id="7293369">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293373">var</span>&nbsp;<span class="ident" id="7293377">err</span>&nbsp;<span class="builtintype" id="7293381">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293388">c</span><span class="op" id="7293389">.</span><span class="ident" id="7293390">tx</span><span class="op" id="7293392">,</span>&nbsp;<span class="ident" id="7293394">err</span>&nbsp;<span class="op" id="7293398">=</span>&nbsp;<span class="ident" id="7293400">c</span><span class="op" id="7293401">.</span><span class="ident" id="7293402">db</span><span class="op" id="7293404">.</span><span class="ident" id="7293405">Begin</span><span class="op" id="7293410">(</span><span class="op" id="7293411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293414">if</span>&nbsp;<span class="ident" id="7293417">err</span>&nbsp;<span class="op" id="7293421">!=</span>&nbsp;<span class="ident" id="7293424">nil</span>&nbsp;<span class="op" id="7293428">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293432">t</span><span class="op" id="7293433">.</span><span class="ident" id="7293434">Fatal</span><span class="op" id="7293439">(</span><span class="ident" id="7293440">err</span><span class="op" id="7293443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7293446">}</span><br>
<span class="lineno"></span><span class="op" id="7293448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7293451">func</span>&nbsp;<span class="op" id="7293456">(</span><span class="ident" id="7293457">c</span>&nbsp;<span class="op" id="7293459">*</span><span class="ident" id="7293460">concurrentTxExecTest</span><span class="op" id="7293480">)</span>&nbsp;<span class="ident" id="7293482">finish</span><span class="op" id="7293488">(</span><span class="ident" id="7293489">t</span>&nbsp;<span class="ident" id="7293491">testing</span><span class="op" id="7293498">.</span><span class="ident" id="7293499">TB</span><span class="op" id="7293501">)</span>&nbsp;<span class="op" id="7293503">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293506">if</span>&nbsp;<span class="ident" id="7293509">c</span><span class="op" id="7293510">.</span><span class="ident" id="7293511">tx</span>&nbsp;<span class="op" id="7293514">!=</span>&nbsp;<span class="ident" id="7293517">nil</span>&nbsp;<span class="op" id="7293521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293525">c</span><span class="op" id="7293526">.</span><span class="ident" id="7293527">tx</span><span class="op" id="7293529">.</span><span class="ident" id="7293530">Rollback</span><span class="op" id="7293538">(</span><span class="op" id="7293539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293543">c</span><span class="op" id="7293544">.</span><span class="ident" id="7293545">tx</span>&nbsp;<span class="op" id="7293548">=</span>&nbsp;<span class="ident" id="7293550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7293555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293558">c</span><span class="op" id="7293559">.</span><span class="ident" id="7293560">db</span>&nbsp;<span class="op" id="7293563">=</span>&nbsp;<span class="ident" id="7293565">nil</span><br>
<span class="lineno">1600</span><span class="op" id="7293569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7293572">func</span>&nbsp;<span class="op" id="7293577">(</span><span class="ident" id="7293578">c</span>&nbsp;<span class="op" id="7293580">*</span><span class="ident" id="7293581">concurrentTxExecTest</span><span class="op" id="7293601">)</span>&nbsp;<span class="ident" id="7293603">test</span><span class="op" id="7293607">(</span><span class="ident" id="7293608">t</span>&nbsp;<span class="ident" id="7293610">testing</span><span class="op" id="7293617">.</span><span class="ident" id="7293618">TB</span><span class="op" id="7293620">)</span>&nbsp;<span class="builtintype" id="7293622">error</span>&nbsp;<span class="op" id="7293628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293631">_</span><span class="op" id="7293632">,</span>&nbsp;<span class="ident" id="7293634">err</span>&nbsp;<span class="op" id="7293638">:=</span>&nbsp;<span class="ident" id="7293641">c</span><span class="op" id="7293642">.</span><span class="ident" id="7293643">tx</span><span class="op" id="7293645">.</span><span class="ident" id="7293646">Exec</span><span class="op" id="7293650">(</span><span class="string" id="7293651">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7293704">,</span>&nbsp;<span class="num" id="7293706">3</span><span class="op" id="7293707">,</span>&nbsp;<span class="ident" id="7293709">chrisBirthday</span><span class="op" id="7293722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293725">if</span>&nbsp;<span class="ident" id="7293728">err</span>&nbsp;<span class="op" id="7293732">!=</span>&nbsp;<span class="ident" id="7293735">nil</span>&nbsp;<span class="op" id="7293739">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293743">t</span><span class="op" id="7293744">.</span><span class="ident" id="7293745">Error</span><span class="op" id="7293750">(</span><span class="ident" id="7293751">err</span><span class="op" id="7293754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293758">return</span>&nbsp;<span class="ident" id="7293765">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7293770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293773">return</span>&nbsp;<span class="ident" id="7293780">nil</span><br>
<span class="lineno"></span><span class="op" id="7293784">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="7293787">type</span>&nbsp;<span class="ident" id="7293792">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="7293818">struct</span>&nbsp;<span class="op" id="7293825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293828">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7293833">*</span><span class="ident" id="7293834">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293838">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7293843">*</span><span class="ident" id="7293844">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293848">stmt</span>&nbsp;<span class="op" id="7293853">*</span><span class="ident" id="7293854">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="7293859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7293862">func</span>&nbsp;<span class="op" id="7293867">(</span><span class="ident" id="7293868">c</span>&nbsp;<span class="op" id="7293870">*</span><span class="ident" id="7293871">concurrentTxStmtQueryTest</span><span class="op" id="7293896">)</span>&nbsp;<span class="ident" id="7293898">init</span><span class="op" id="7293902">(</span><span class="ident" id="7293903">t</span>&nbsp;<span class="ident" id="7293905">testing</span><span class="op" id="7293912">.</span><span class="ident" id="7293913">TB</span><span class="op" id="7293915">,</span>&nbsp;<span class="ident" id="7293917">db</span>&nbsp;<span class="op" id="7293920">*</span><span class="ident" id="7293921">DB</span><span class="op" id="7293923">)</span>&nbsp;<span class="op" id="7293925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293928">c</span><span class="op" id="7293929">.</span><span class="ident" id="7293930">db</span>&nbsp;<span class="op" id="7293933">=</span>&nbsp;<span class="ident" id="7293935">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293939">var</span>&nbsp;<span class="ident" id="7293943">err</span>&nbsp;<span class="builtintype" id="7293947">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293954">c</span><span class="op" id="7293955">.</span><span class="ident" id="7293956">tx</span><span class="op" id="7293958">,</span>&nbsp;<span class="ident" id="7293960">err</span>&nbsp;<span class="op" id="7293964">=</span>&nbsp;<span class="ident" id="7293966">c</span><span class="op" id="7293967">.</span><span class="ident" id="7293968">db</span><span class="op" id="7293970">.</span><span class="ident" id="7293971">Begin</span><span class="op" id="7293976">(</span><span class="op" id="7293977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7293980">if</span>&nbsp;<span class="ident" id="7293983">err</span>&nbsp;<span class="op" id="7293987">!=</span>&nbsp;<span class="ident" id="7293990">nil</span>&nbsp;<span class="op" id="7293994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7293998">t</span><span class="op" id="7293999">.</span><span class="ident" id="7294000">Fatal</span><span class="op" id="7294005">(</span><span class="ident" id="7294006">err</span><span class="op" id="7294009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294015">c</span><span class="op" id="7294016">.</span><span class="ident" id="7294017">stmt</span><span class="op" id="7294021">,</span>&nbsp;<span class="ident" id="7294023">err</span>&nbsp;<span class="op" id="7294027">=</span>&nbsp;<span class="ident" id="7294029">c</span><span class="op" id="7294030">.</span><span class="ident" id="7294031">tx</span><span class="op" id="7294033">.</span><span class="ident" id="7294034">Prepare</span><span class="op" id="7294041">(</span><span class="string" id="7294042">&#34;SELECT|people|name|&#34;</span><span class="op" id="7294063">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294066">if</span>&nbsp;<span class="ident" id="7294069">err</span>&nbsp;<span class="op" id="7294073">!=</span>&nbsp;<span class="ident" id="7294076">nil</span>&nbsp;<span class="op" id="7294080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294084">t</span><span class="op" id="7294085">.</span><span class="ident" id="7294086">Fatal</span><span class="op" id="7294091">(</span><span class="ident" id="7294092">err</span><span class="op" id="7294095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294098">}</span><br>
<span class="lineno"></span><span class="op" id="7294100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="7294103">func</span>&nbsp;<span class="op" id="7294108">(</span><span class="ident" id="7294109">c</span>&nbsp;<span class="op" id="7294111">*</span><span class="ident" id="7294112">concurrentTxStmtQueryTest</span><span class="op" id="7294137">)</span>&nbsp;<span class="ident" id="7294139">finish</span><span class="op" id="7294145">(</span><span class="ident" id="7294146">t</span>&nbsp;<span class="ident" id="7294148">testing</span><span class="op" id="7294155">.</span><span class="ident" id="7294156">TB</span><span class="op" id="7294158">)</span>&nbsp;<span class="op" id="7294160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294163">if</span>&nbsp;<span class="ident" id="7294166">c</span><span class="op" id="7294167">.</span><span class="ident" id="7294168">stmt</span>&nbsp;<span class="op" id="7294173">!=</span>&nbsp;<span class="ident" id="7294176">nil</span>&nbsp;<span class="op" id="7294180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294184">c</span><span class="op" id="7294185">.</span><span class="ident" id="7294186">stmt</span><span class="op" id="7294190">.</span><span class="ident" id="7294191">Close</span><span class="op" id="7294196">(</span><span class="op" id="7294197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294201">c</span><span class="op" id="7294202">.</span><span class="ident" id="7294203">stmt</span>&nbsp;<span class="op" id="7294208">=</span>&nbsp;<span class="ident" id="7294210">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294215">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294218">if</span>&nbsp;<span class="ident" id="7294221">c</span><span class="op" id="7294222">.</span><span class="ident" id="7294223">tx</span>&nbsp;<span class="op" id="7294226">!=</span>&nbsp;<span class="ident" id="7294229">nil</span>&nbsp;<span class="op" id="7294233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294237">c</span><span class="op" id="7294238">.</span><span class="ident" id="7294239">tx</span><span class="op" id="7294241">.</span><span class="ident" id="7294242">Rollback</span><span class="op" id="7294250">(</span><span class="op" id="7294251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294255">c</span><span class="op" id="7294256">.</span><span class="ident" id="7294257">tx</span>&nbsp;<span class="op" id="7294260">=</span>&nbsp;<span class="ident" id="7294262">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294270">c</span><span class="op" id="7294271">.</span><span class="ident" id="7294272">db</span>&nbsp;<span class="op" id="7294275">=</span>&nbsp;<span class="ident" id="7294277">nil</span><br>
<span class="lineno">1640</span><span class="op" id="7294281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7294284">func</span>&nbsp;<span class="op" id="7294289">(</span><span class="ident" id="7294290">c</span>&nbsp;<span class="op" id="7294292">*</span><span class="ident" id="7294293">concurrentTxStmtQueryTest</span><span class="op" id="7294318">)</span>&nbsp;<span class="ident" id="7294320">test</span><span class="op" id="7294324">(</span><span class="ident" id="7294325">t</span>&nbsp;<span class="ident" id="7294327">testing</span><span class="op" id="7294334">.</span><span class="ident" id="7294335">TB</span><span class="op" id="7294337">)</span>&nbsp;<span class="builtintype" id="7294339">error</span>&nbsp;<span class="op" id="7294345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294348">rows</span><span class="op" id="7294352">,</span>&nbsp;<span class="ident" id="7294354">err</span>&nbsp;<span class="op" id="7294358">:=</span>&nbsp;<span class="ident" id="7294361">c</span><span class="op" id="7294362">.</span><span class="ident" id="7294363">stmt</span><span class="op" id="7294367">.</span><span class="ident" id="7294368">Query</span><span class="op" id="7294373">(</span><span class="op" id="7294374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294377">if</span>&nbsp;<span class="ident" id="7294380">err</span>&nbsp;<span class="op" id="7294384">!=</span>&nbsp;<span class="ident" id="7294387">nil</span>&nbsp;<span class="op" id="7294391">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294395">t</span><span class="op" id="7294396">.</span><span class="ident" id="7294397">Errorf</span><span class="op" id="7294403">(</span><span class="string" id="7294404">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7294425">,</span>&nbsp;<span class="ident" id="7294427">err</span><span class="op" id="7294430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294434">return</span>&nbsp;<span class="ident" id="7294441">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294450">var</span>&nbsp;<span class="ident" id="7294454">name</span>&nbsp;<span class="builtintype" id="7294459">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294467">for</span>&nbsp;<span class="ident" id="7294471">rows</span><span class="op" id="7294475">.</span><span class="ident" id="7294476">Next</span><span class="op" id="7294480">(</span><span class="op" id="7294481">)</span>&nbsp;<span class="op" id="7294483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294487">rows</span><span class="op" id="7294491">.</span><span class="ident" id="7294492">Scan</span><span class="op" id="7294496">(</span><span class="op" id="7294497">&amp;</span><span class="ident" id="7294498">name</span><span class="op" id="7294502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294508">rows</span><span class="op" id="7294512">.</span><span class="ident" id="7294513">Close</span><span class="op" id="7294518">(</span><span class="op" id="7294519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294522">return</span>&nbsp;<span class="ident" id="7294529">nil</span><br>
<span class="lineno">1655</span><span class="op" id="7294533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7294536">type</span>&nbsp;<span class="ident" id="7294541">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="7294566">struct</span>&nbsp;<span class="op" id="7294573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294576">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7294581">*</span><span class="ident" id="7294582">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294586">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7294591">*</span><span class="ident" id="7294592">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294596">stmt</span>&nbsp;<span class="op" id="7294601">*</span><span class="ident" id="7294602">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7294607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7294610">func</span>&nbsp;<span class="op" id="7294615">(</span><span class="ident" id="7294616">c</span>&nbsp;<span class="op" id="7294618">*</span><span class="ident" id="7294619">concurrentTxStmtExecTest</span><span class="op" id="7294643">)</span>&nbsp;<span class="ident" id="7294645">init</span><span class="op" id="7294649">(</span><span class="ident" id="7294650">t</span>&nbsp;<span class="ident" id="7294652">testing</span><span class="op" id="7294659">.</span><span class="ident" id="7294660">TB</span><span class="op" id="7294662">,</span>&nbsp;<span class="ident" id="7294664">db</span>&nbsp;<span class="op" id="7294667">*</span><span class="ident" id="7294668">DB</span><span class="op" id="7294670">)</span>&nbsp;<span class="op" id="7294672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294675">c</span><span class="op" id="7294676">.</span><span class="ident" id="7294677">db</span>&nbsp;<span class="op" id="7294680">=</span>&nbsp;<span class="ident" id="7294682">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294686">var</span>&nbsp;<span class="ident" id="7294690">err</span>&nbsp;<span class="builtintype" id="7294694">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294701">c</span><span class="op" id="7294702">.</span><span class="ident" id="7294703">tx</span><span class="op" id="7294705">,</span>&nbsp;<span class="ident" id="7294707">err</span>&nbsp;<span class="op" id="7294711">=</span>&nbsp;<span class="ident" id="7294713">c</span><span class="op" id="7294714">.</span><span class="ident" id="7294715">db</span><span class="op" id="7294717">.</span><span class="ident" id="7294718">Begin</span><span class="op" id="7294723">(</span><span class="op" id="7294724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294727">if</span>&nbsp;<span class="ident" id="7294730">err</span>&nbsp;<span class="op" id="7294734">!=</span>&nbsp;<span class="ident" id="7294737">nil</span>&nbsp;<span class="op" id="7294741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294745">t</span><span class="op" id="7294746">.</span><span class="ident" id="7294747">Fatal</span><span class="op" id="7294752">(</span><span class="ident" id="7294753">err</span><span class="op" id="7294756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294759">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294762">c</span><span class="op" id="7294763">.</span><span class="ident" id="7294764">stmt</span><span class="op" id="7294768">,</span>&nbsp;<span class="ident" id="7294770">err</span>&nbsp;<span class="op" id="7294774">=</span>&nbsp;<span class="ident" id="7294776">c</span><span class="op" id="7294777">.</span><span class="ident" id="7294778">tx</span><span class="op" id="7294780">.</span><span class="ident" id="7294781">Prepare</span><span class="op" id="7294788">(</span><span class="string" id="7294789">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7294842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294845">if</span>&nbsp;<span class="ident" id="7294848">err</span>&nbsp;<span class="op" id="7294852">!=</span>&nbsp;<span class="ident" id="7294855">nil</span>&nbsp;<span class="op" id="7294859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294863">t</span><span class="op" id="7294864">.</span><span class="ident" id="7294865">Fatal</span><span class="op" id="7294870">(</span><span class="ident" id="7294871">err</span><span class="op" id="7294874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294877">}</span><br>
<span class="lineno"></span><span class="op" id="7294879">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="7294882">func</span>&nbsp;<span class="op" id="7294887">(</span><span class="ident" id="7294888">c</span>&nbsp;<span class="op" id="7294890">*</span><span class="ident" id="7294891">concurrentTxStmtExecTest</span><span class="op" id="7294915">)</span>&nbsp;<span class="ident" id="7294917">finish</span><span class="op" id="7294923">(</span><span class="ident" id="7294924">t</span>&nbsp;<span class="ident" id="7294926">testing</span><span class="op" id="7294933">.</span><span class="ident" id="7294934">TB</span><span class="op" id="7294936">)</span>&nbsp;<span class="op" id="7294938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294941">if</span>&nbsp;<span class="ident" id="7294944">c</span><span class="op" id="7294945">.</span><span class="ident" id="7294946">stmt</span>&nbsp;<span class="op" id="7294951">!=</span>&nbsp;<span class="ident" id="7294954">nil</span>&nbsp;<span class="op" id="7294958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294962">c</span><span class="op" id="7294963">.</span><span class="ident" id="7294964">stmt</span><span class="op" id="7294968">.</span><span class="ident" id="7294969">Close</span><span class="op" id="7294974">(</span><span class="op" id="7294975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7294979">c</span><span class="op" id="7294980">.</span><span class="ident" id="7294981">stmt</span>&nbsp;<span class="op" id="7294986">=</span>&nbsp;<span class="ident" id="7294988">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7294993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7294996">if</span>&nbsp;<span class="ident" id="7294999">c</span><span class="op" id="7295000">.</span><span class="ident" id="7295001">tx</span>&nbsp;<span class="op" id="7295004">!=</span>&nbsp;<span class="ident" id="7295007">nil</span>&nbsp;<span class="op" id="7295011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295015">c</span><span class="op" id="7295016">.</span><span class="ident" id="7295017">tx</span><span class="op" id="7295019">.</span><span class="ident" id="7295020">Rollback</span><span class="op" id="7295028">(</span><span class="op" id="7295029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295033">c</span><span class="op" id="7295034">.</span><span class="ident" id="7295035">tx</span>&nbsp;<span class="op" id="7295038">=</span>&nbsp;<span class="ident" id="7295040">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7295045">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295048">c</span><span class="op" id="7295049">.</span><span class="ident" id="7295050">db</span>&nbsp;<span class="op" id="7295053">=</span>&nbsp;<span class="ident" id="7295055">nil</span><br>
<span class="lineno"></span><span class="op" id="7295059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295062">func</span>&nbsp;<span class="op" id="7295067">(</span><span class="ident" id="7295068">c</span>&nbsp;<span class="op" id="7295070">*</span><span class="ident" id="7295071">concurrentTxStmtExecTest</span><span class="op" id="7295095">)</span>&nbsp;<span class="ident" id="7295097">test</span><span class="op" id="7295101">(</span><span class="ident" id="7295102">t</span>&nbsp;<span class="ident" id="7295104">testing</span><span class="op" id="7295111">.</span><span class="ident" id="7295112">TB</span><span class="op" id="7295114">)</span>&nbsp;<span class="builtintype" id="7295116">error</span>&nbsp;<span class="op" id="7295122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295125">_</span><span class="op" id="7295126">,</span>&nbsp;<span class="ident" id="7295128">err</span>&nbsp;<span class="op" id="7295132">:=</span>&nbsp;<span class="ident" id="7295135">c</span><span class="op" id="7295136">.</span><span class="ident" id="7295137">stmt</span><span class="op" id="7295141">.</span><span class="ident" id="7295142">Exec</span><span class="op" id="7295146">(</span><span class="num" id="7295147">3</span><span class="op" id="7295148">,</span>&nbsp;<span class="ident" id="7295150">chrisBirthday</span><span class="op" id="7295163">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7295166">if</span>&nbsp;<span class="ident" id="7295169">err</span>&nbsp;<span class="op" id="7295173">!=</span>&nbsp;<span class="ident" id="7295176">nil</span>&nbsp;<span class="op" id="7295180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295184">t</span><span class="op" id="7295185">.</span><span class="ident" id="7295186">Errorf</span><span class="op" id="7295192">(</span><span class="string" id="7295193">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7295213">,</span>&nbsp;<span class="ident" id="7295215">err</span><span class="op" id="7295218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7295222">return</span>&nbsp;<span class="ident" id="7295229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7295234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7295237">return</span>&nbsp;<span class="ident" id="7295244">nil</span><br>
<span class="lineno">1695</span><span class="op" id="7295248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295251">type</span>&nbsp;<span class="ident" id="7295256">concurrentRandomTest</span>&nbsp;<span class="keyword" id="7295277">struct</span>&nbsp;<span class="op" id="7295284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295287">tests</span>&nbsp;<span class="op" id="7295293">[</span><span class="op" id="7295294">]</span><span class="ident" id="7295295">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="7295310">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="7295313">func</span>&nbsp;<span class="op" id="7295318">(</span><span class="ident" id="7295319">c</span>&nbsp;<span class="op" id="7295321">*</span><span class="ident" id="7295322">concurrentRandomTest</span><span class="op" id="7295342">)</span>&nbsp;<span class="ident" id="7295344">init</span><span class="op" id="7295348">(</span><span class="ident" id="7295349">t</span>&nbsp;<span class="ident" id="7295351">testing</span><span class="op" id="7295358">.</span><span class="ident" id="7295359">TB</span><span class="op" id="7295361">,</span>&nbsp;<span class="ident" id="7295363">db</span>&nbsp;<span class="op" id="7295366">*</span><span class="ident" id="7295367">DB</span><span class="op" id="7295369">)</span>&nbsp;<span class="op" id="7295371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295374">c</span><span class="op" id="7295375">.</span><span class="ident" id="7295376">tests</span>&nbsp;<span class="op" id="7295382">=</span>&nbsp;<span class="op" id="7295384">[</span><span class="op" id="7295385">]</span><span class="ident" id="7295386">concurrentTest</span><span class="op" id="7295400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295404">new</span><span class="op" id="7295407">(</span><span class="ident" id="7295408">concurrentDBQueryTest</span><span class="op" id="7295429">)</span><span class="op" id="7295430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295434">new</span><span class="op" id="7295437">(</span><span class="ident" id="7295438">concurrentDBExecTest</span><span class="op" id="7295458">)</span><span class="op" id="7295459">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295463">new</span><span class="op" id="7295466">(</span><span class="ident" id="7295467">concurrentStmtQueryTest</span><span class="op" id="7295490">)</span><span class="op" id="7295491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295495">new</span><span class="op" id="7295498">(</span><span class="ident" id="7295499">concurrentStmtExecTest</span><span class="op" id="7295521">)</span><span class="op" id="7295522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295526">new</span><span class="op" id="7295529">(</span><span class="ident" id="7295530">concurrentTxQueryTest</span><span class="op" id="7295551">)</span><span class="op" id="7295552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295556">new</span><span class="op" id="7295559">(</span><span class="ident" id="7295560">concurrentTxExecTest</span><span class="op" id="7295580">)</span><span class="op" id="7295581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295585">new</span><span class="op" id="7295588">(</span><span class="ident" id="7295589">concurrentTxStmtQueryTest</span><span class="op" id="7295614">)</span><span class="op" id="7295615">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7295619">new</span><span class="op" id="7295622">(</span><span class="ident" id="7295623">concurrentTxStmtExecTest</span><span class="op" id="7295647">)</span><span class="op" id="7295648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7295651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7295654">for</span>&nbsp;<span class="ident" id="7295658">_</span><span class="op" id="7295659">,</span>&nbsp;<span class="ident" id="7295661">ct</span>&nbsp;<span class="op" id="7295664">:=</span>&nbsp;<span class="keyword" id="7295667">range</span>&nbsp;<span class="ident" id="7295673">c</span><span class="op" id="7295674">.</span><span class="ident" id="7295675">tests</span>&nbsp;<span class="op" id="7295681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295685">ct</span><span class="op" id="7295687">.</span><span class="ident" id="7295688">init</span><span class="op" id="7295692">(</span><span class="ident" id="7295693">t</span><span class="op" id="7295694">,</span>&nbsp;<span class="ident" id="7295696">db</span><span class="op" id="7295698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7295701">}</span><br>
<span class="lineno">1715</span><span class="op" id="7295703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295706">func</span>&nbsp;<span class="op" id="7295711">(</span><span class="ident" id="7295712">c</span>&nbsp;<span class="op" id="7295714">*</span><span class="ident" id="7295715">concurrentRandomTest</span><span class="op" id="7295735">)</span>&nbsp;<span class="ident" id="7295737">finish</span><span class="op" id="7295743">(</span><span class="ident" id="7295744">t</span>&nbsp;<span class="ident" id="7295746">testing</span><span class="op" id="7295753">.</span><span class="ident" id="7295754">TB</span><span class="op" id="7295756">)</span>&nbsp;<span class="op" id="7295758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7295761">for</span>&nbsp;<span class="ident" id="7295765">_</span><span class="op" id="7295766">,</span>&nbsp;<span class="ident" id="7295768">ct</span>&nbsp;<span class="op" id="7295771">:=</span>&nbsp;<span class="keyword" id="7295774">range</span>&nbsp;<span class="ident" id="7295780">c</span><span class="op" id="7295781">.</span><span class="ident" id="7295782">tests</span>&nbsp;<span class="op" id="7295788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295792">ct</span><span class="op" id="7295794">.</span><span class="ident" id="7295795">finish</span><span class="op" id="7295801">(</span><span class="ident" id="7295802">t</span><span class="op" id="7295803">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7295806">}</span><br>
<span class="lineno"></span><span class="op" id="7295808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295811">func</span>&nbsp;<span class="op" id="7295816">(</span><span class="ident" id="7295817">c</span>&nbsp;<span class="op" id="7295819">*</span><span class="ident" id="7295820">concurrentRandomTest</span><span class="op" id="7295840">)</span>&nbsp;<span class="ident" id="7295842">test</span><span class="op" id="7295846">(</span><span class="ident" id="7295847">t</span>&nbsp;<span class="ident" id="7295849">testing</span><span class="op" id="7295856">.</span><span class="ident" id="7295857">TB</span><span class="op" id="7295859">)</span>&nbsp;<span class="builtintype" id="7295861">error</span>&nbsp;<span class="op" id="7295867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295870">ct</span>&nbsp;<span class="op" id="7295873">:=</span>&nbsp;<span class="ident" id="7295876">c</span><span class="op" id="7295877">.</span><span class="ident" id="7295878">tests</span><span class="op" id="7295883">[</span><span class="ident" id="7295884">rand</span><span class="op" id="7295888">.</span><span class="ident" id="7295889">Intn</span><span class="op" id="7295893">(</span><span class="builtinfunc" id="7295894">len</span><span class="op" id="7295897">(</span><span class="ident" id="7295898">c</span><span class="op" id="7295899">.</span><span class="ident" id="7295900">tests</span><span class="op" id="7295905">)</span><span class="op" id="7295906">)</span><span class="op" id="7295907">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7295910">return</span>&nbsp;<span class="ident" id="7295917">ct</span><span class="op" id="7295919">.</span><span class="ident" id="7295920">test</span><span class="op" id="7295924">(</span><span class="ident" id="7295925">t</span><span class="op" id="7295926">)</span><br>
<span class="lineno"></span><span class="op" id="7295928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7295931">func</span>&nbsp;<span class="ident" id="7295936">doConcurrentTest</span><span class="op" id="7295952">(</span><span class="ident" id="7295953">t</span>&nbsp;<span class="ident" id="7295955">testing</span><span class="op" id="7295962">.</span><span class="ident" id="7295963">TB</span><span class="op" id="7295965">,</span>&nbsp;<span class="ident" id="7295967">ct</span>&nbsp;<span class="ident" id="7295970">concurrentTest</span><span class="op" id="7295984">)</span>&nbsp;<span class="op" id="7295986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7295989">maxProcs</span><span class="op" id="7295997">,</span>&nbsp;<span class="ident" id="7295999">numReqs</span>&nbsp;<span class="op" id="7296007">:=</span>&nbsp;<span class="num" id="7296010">1</span><span class="op" id="7296011">,</span>&nbsp;<span class="num" id="7296013">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296018">if</span>&nbsp;<span class="ident" id="7296021">testing</span><span class="op" id="7296028">.</span><span class="ident" id="7296029">Short</span><span class="op" id="7296034">(</span><span class="op" id="7296035">)</span>&nbsp;<span class="op" id="7296037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296041">maxProcs</span><span class="op" id="7296049">,</span>&nbsp;<span class="ident" id="7296051">numReqs</span>&nbsp;<span class="op" id="7296059">=</span>&nbsp;<span class="num" id="7296061">4</span><span class="op" id="7296062">,</span>&nbsp;<span class="num" id="7296064">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296071">defer</span>&nbsp;<span class="ident" id="7296077">runtime</span><span class="op" id="7296084">.</span><span class="ident" id="7296085">GOMAXPROCS</span><span class="op" id="7296095">(</span><span class="ident" id="7296096">runtime</span><span class="op" id="7296103">.</span><span class="ident" id="7296104">GOMAXPROCS</span><span class="op" id="7296114">(</span><span class="ident" id="7296115">maxProcs</span><span class="op" id="7296123">)</span><span class="op" id="7296124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296128">db</span>&nbsp;<span class="op" id="7296131">:=</span>&nbsp;<span class="ident" id="7296134">newTestDB</span><span class="op" id="7296143">(</span><span class="ident" id="7296144">t</span><span class="op" id="7296145">,</span>&nbsp;<span class="string" id="7296147">&#34;people&#34;</span><span class="op" id="7296155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296158">defer</span>&nbsp;<span class="ident" id="7296164">closeDB</span><span class="op" id="7296171">(</span><span class="ident" id="7296172">t</span><span class="op" id="7296173">,</span>&nbsp;<span class="ident" id="7296175">db</span><span class="op" id="7296177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296181">ct</span><span class="op" id="7296183">.</span><span class="ident" id="7296184">init</span><span class="op" id="7296188">(</span><span class="ident" id="7296189">t</span><span class="op" id="7296190">,</span>&nbsp;<span class="ident" id="7296192">db</span><span class="op" id="7296194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296197">defer</span>&nbsp;<span class="ident" id="7296203">ct</span><span class="op" id="7296205">.</span><span class="ident" id="7296206">finish</span><span class="op" id="7296212">(</span><span class="ident" id="7296213">t</span><span class="op" id="7296214">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296218">var</span>&nbsp;<span class="ident" id="7296222">wg</span>&nbsp;<span class="ident" id="7296225">sync</span><span class="op" id="7296229">.</span><span class="ident" id="7296230">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296241">wg</span><span class="op" id="7296243">.</span><span class="ident" id="7296244">Add</span><span class="op" id="7296247">(</span><span class="ident" id="7296248">numReqs</span><span class="op" id="7296255">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296259">reqs</span>&nbsp;<span class="op" id="7296264">:=</span>&nbsp;<span class="builtinfunc" id="7296267">make</span><span class="op" id="7296271">(</span><span class="keyword" id="7296272">chan</span>&nbsp;<span class="builtintype" id="7296277">bool</span><span class="op" id="7296281">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296284">defer</span>&nbsp;<span class="builtinfunc" id="7296290">close</span><span class="op" id="7296295">(</span><span class="ident" id="7296296">reqs</span><span class="op" id="7296300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296304">for</span>&nbsp;<span class="ident" id="7296308">i</span>&nbsp;<span class="op" id="7296310">:=</span>&nbsp;<span class="num" id="7296313">0</span><span class="op" id="7296314">;</span>&nbsp;<span class="ident" id="7296316">i</span>&nbsp;<span class="op" id="7296318">&lt;</span>&nbsp;<span class="ident" id="7296320">maxProcs</span><span class="op" id="7296328">*</span><span class="num" id="7296329">2</span><span class="op" id="7296330">;</span>&nbsp;<span class="ident" id="7296332">i</span><span class="op" id="7296333">++</span>&nbsp;<span class="op" id="7296336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296340">go</span>&nbsp;<span class="keyword" id="7296343">func</span><span class="op" id="7296347">(</span><span class="op" id="7296348">)</span>&nbsp;<span class="op" id="7296350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296355">for</span>&nbsp;<span class="keyword" id="7296359">range</span>&nbsp;<span class="ident" id="7296365">reqs</span>&nbsp;<span class="op" id="7296370">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296376">err</span>&nbsp;<span class="op" id="7296380">:=</span>&nbsp;<span class="ident" id="7296383">ct</span><span class="op" id="7296385">.</span><span class="ident" id="7296386">test</span><span class="op" id="7296390">(</span><span class="ident" id="7296391">t</span><span class="op" id="7296392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296398">if</span>&nbsp;<span class="ident" id="7296401">err</span>&nbsp;<span class="op" id="7296405">!=</span>&nbsp;<span class="ident" id="7296408">nil</span>&nbsp;<span class="op" id="7296412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296419">wg</span><span class="op" id="7296421">.</span><span class="ident" id="7296422">Done</span><span class="op" id="7296426">(</span><span class="op" id="7296427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296434">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296447">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296453">wg</span><span class="op" id="7296455">.</span><span class="ident" id="7296456">Done</span><span class="op" id="7296460">(</span><span class="op" id="7296461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296470">}</span><span class="op" id="7296471">(</span><span class="op" id="7296472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296479">for</span>&nbsp;<span class="ident" id="7296483">i</span>&nbsp;<span class="op" id="7296485">:=</span>&nbsp;<span class="num" id="7296488">0</span><span class="op" id="7296489">;</span>&nbsp;<span class="ident" id="7296491">i</span>&nbsp;<span class="op" id="7296493">&lt;</span>&nbsp;<span class="ident" id="7296495">numReqs</span><span class="op" id="7296502">;</span>&nbsp;<span class="ident" id="7296504">i</span><span class="op" id="7296505">++</span>&nbsp;<span class="op" id="7296508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296512">reqs</span>&nbsp;<span class="op" id="7296517">&lt;-</span>&nbsp;<span class="builtintype" id="7296520">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296530">wg</span><span class="op" id="7296532">.</span><span class="ident" id="7296533">Wait</span><span class="op" id="7296537">(</span><span class="op" id="7296538">)</span><br>
<span class="lineno">1765</span><span class="op" id="7296540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7296543">func</span>&nbsp;<span class="ident" id="7296548">manyConcurrentQueries</span><span class="op" id="7296569">(</span><span class="ident" id="7296570">t</span>&nbsp;<span class="ident" id="7296572">testing</span><span class="op" id="7296579">.</span><span class="ident" id="7296580">TB</span><span class="op" id="7296582">)</span>&nbsp;<span class="op" id="7296584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296587">maxProcs</span><span class="op" id="7296595">,</span>&nbsp;<span class="ident" id="7296597">numReqs</span>&nbsp;<span class="op" id="7296605">:=</span>&nbsp;<span class="num" id="7296608">16</span><span class="op" id="7296610">,</span>&nbsp;<span class="num" id="7296612">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296617">if</span>&nbsp;<span class="ident" id="7296620">testing</span><span class="op" id="7296627">.</span><span class="ident" id="7296628">Short</span><span class="op" id="7296633">(</span><span class="op" id="7296634">)</span>&nbsp;<span class="op" id="7296636">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296640">maxProcs</span><span class="op" id="7296648">,</span>&nbsp;<span class="ident" id="7296650">numReqs</span>&nbsp;<span class="op" id="7296658">=</span>&nbsp;<span class="num" id="7296660">4</span><span class="op" id="7296661">,</span>&nbsp;<span class="num" id="7296663">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296670">defer</span>&nbsp;<span class="ident" id="7296676">runtime</span><span class="op" id="7296683">.</span><span class="ident" id="7296684">GOMAXPROCS</span><span class="op" id="7296694">(</span><span class="ident" id="7296695">runtime</span><span class="op" id="7296702">.</span><span class="ident" id="7296703">GOMAXPROCS</span><span class="op" id="7296713">(</span><span class="ident" id="7296714">maxProcs</span><span class="op" id="7296722">)</span><span class="op" id="7296723">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296727">db</span>&nbsp;<span class="op" id="7296730">:=</span>&nbsp;<span class="ident" id="7296733">newTestDB</span><span class="op" id="7296742">(</span><span class="ident" id="7296743">t</span><span class="op" id="7296744">,</span>&nbsp;<span class="string" id="7296746">&#34;people&#34;</span><span class="op" id="7296754">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296757">defer</span>&nbsp;<span class="ident" id="7296763">closeDB</span><span class="op" id="7296770">(</span><span class="ident" id="7296771">t</span><span class="op" id="7296772">,</span>&nbsp;<span class="ident" id="7296774">db</span><span class="op" id="7296776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296780">stmt</span><span class="op" id="7296784">,</span>&nbsp;<span class="ident" id="7296786">err</span>&nbsp;<span class="op" id="7296790">:=</span>&nbsp;<span class="ident" id="7296793">db</span><span class="op" id="7296795">.</span><span class="ident" id="7296796">Prepare</span><span class="op" id="7296803">(</span><span class="string" id="7296804">&#34;SELECT|people|name|&#34;</span><span class="op" id="7296825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296828">if</span>&nbsp;<span class="ident" id="7296831">err</span>&nbsp;<span class="op" id="7296835">!=</span>&nbsp;<span class="ident" id="7296838">nil</span>&nbsp;<span class="op" id="7296842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296846">t</span><span class="op" id="7296847">.</span><span class="ident" id="7296848">Fatal</span><span class="op" id="7296853">(</span><span class="ident" id="7296854">err</span><span class="op" id="7296857">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7296860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296863">defer</span>&nbsp;<span class="ident" id="7296869">stmt</span><span class="op" id="7296873">.</span><span class="ident" id="7296874">Close</span><span class="op" id="7296879">(</span><span class="op" id="7296880">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296884">var</span>&nbsp;<span class="ident" id="7296888">wg</span>&nbsp;<span class="ident" id="7296891">sync</span><span class="op" id="7296895">.</span><span class="ident" id="7296896">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296907">wg</span><span class="op" id="7296909">.</span><span class="ident" id="7296910">Add</span><span class="op" id="7296913">(</span><span class="ident" id="7296914">numReqs</span><span class="op" id="7296921">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7296925">reqs</span>&nbsp;<span class="op" id="7296930">:=</span>&nbsp;<span class="builtinfunc" id="7296933">make</span><span class="op" id="7296937">(</span><span class="keyword" id="7296938">chan</span>&nbsp;<span class="builtintype" id="7296943">bool</span><span class="op" id="7296947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296950">defer</span>&nbsp;<span class="builtinfunc" id="7296956">close</span><span class="op" id="7296961">(</span><span class="ident" id="7296962">reqs</span><span class="op" id="7296966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7296970">for</span>&nbsp;<span class="ident" id="7296974">i</span>&nbsp;<span class="op" id="7296976">:=</span>&nbsp;<span class="num" id="7296979">0</span><span class="op" id="7296980">;</span>&nbsp;<span class="ident" id="7296982">i</span>&nbsp;<span class="op" id="7296984">&lt;</span>&nbsp;<span class="ident" id="7296986">maxProcs</span><span class="op" id="7296994">*</span><span class="num" id="7296995">2</span><span class="op" id="7296996">;</span>&nbsp;<span class="ident" id="7296998">i</span><span class="op" id="7296999">++</span>&nbsp;<span class="op" id="7297002">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297006">go</span>&nbsp;<span class="keyword" id="7297009">func</span><span class="op" id="7297013">(</span><span class="op" id="7297014">)</span>&nbsp;<span class="op" id="7297016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297021">for</span>&nbsp;<span class="keyword" id="7297025">range</span>&nbsp;<span class="ident" id="7297031">reqs</span>&nbsp;<span class="op" id="7297036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297042">rows</span><span class="op" id="7297046">,</span>&nbsp;<span class="ident" id="7297048">err</span>&nbsp;<span class="op" id="7297052">:=</span>&nbsp;<span class="ident" id="7297055">stmt</span><span class="op" id="7297059">.</span><span class="ident" id="7297060">Query</span><span class="op" id="7297065">(</span><span class="op" id="7297066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297072">if</span>&nbsp;<span class="ident" id="7297075">err</span>&nbsp;<span class="op" id="7297079">!=</span>&nbsp;<span class="ident" id="7297082">nil</span>&nbsp;<span class="op" id="7297086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297093">t</span><span class="op" id="7297094">.</span><span class="ident" id="7297095">Errorf</span><span class="op" id="7297101">(</span><span class="string" id="7297102">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7297123">,</span>&nbsp;<span class="ident" id="7297125">err</span><span class="op" id="7297128">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297135">wg</span><span class="op" id="7297137">.</span><span class="ident" id="7297138">Done</span><span class="op" id="7297142">(</span><span class="op" id="7297143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297150">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297170">var</span>&nbsp;<span class="ident" id="7297174">name</span>&nbsp;<span class="builtintype" id="7297179">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297190">for</span>&nbsp;<span class="ident" id="7297194">rows</span><span class="op" id="7297198">.</span><span class="ident" id="7297199">Next</span><span class="op" id="7297203">(</span><span class="op" id="7297204">)</span>&nbsp;<span class="op" id="7297206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297213">rows</span><span class="op" id="7297217">.</span><span class="ident" id="7297218">Scan</span><span class="op" id="7297222">(</span><span class="op" id="7297223">&amp;</span><span class="ident" id="7297224">name</span><span class="op" id="7297228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297240">rows</span><span class="op" id="7297244">.</span><span class="ident" id="7297245">Close</span><span class="op" id="7297250">(</span><span class="op" id="7297251">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297258">wg</span><span class="op" id="7297260">.</span><span class="ident" id="7297261">Done</span><span class="op" id="7297265">(</span><span class="op" id="7297266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297275">}</span><span class="op" id="7297276">(</span><span class="op" id="7297277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297284">for</span>&nbsp;<span class="ident" id="7297288">i</span>&nbsp;<span class="op" id="7297290">:=</span>&nbsp;<span class="num" id="7297293">0</span><span class="op" id="7297294">;</span>&nbsp;<span class="ident" id="7297296">i</span>&nbsp;<span class="op" id="7297298">&lt;</span>&nbsp;<span class="ident" id="7297300">numReqs</span><span class="op" id="7297307">;</span>&nbsp;<span class="ident" id="7297309">i</span><span class="op" id="7297310">++</span>&nbsp;<span class="op" id="7297313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297317">reqs</span>&nbsp;<span class="op" id="7297322">&lt;-</span>&nbsp;<span class="builtintype" id="7297325">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297335">wg</span><span class="op" id="7297337">.</span><span class="ident" id="7297338">Wait</span><span class="op" id="7297342">(</span><span class="op" id="7297343">)</span><br>
<span class="lineno">1815</span><span class="op" id="7297345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7297348">func</span>&nbsp;<span class="ident" id="7297353">TestIssue6081</span><span class="op" id="7297366">(</span><span class="ident" id="7297367">t</span>&nbsp;<span class="op" id="7297369">*</span><span class="ident" id="7297370">testing</span><span class="op" id="7297377">.</span><span class="ident" id="7297378">T</span><span class="op" id="7297379">)</span>&nbsp;<span class="op" id="7297381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297384">db</span>&nbsp;<span class="op" id="7297387">:=</span>&nbsp;<span class="ident" id="7297390">newTestDB</span><span class="op" id="7297399">(</span><span class="ident" id="7297400">t</span><span class="op" id="7297401">,</span>&nbsp;<span class="string" id="7297403">&#34;people&#34;</span><span class="op" id="7297411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297414">defer</span>&nbsp;<span class="ident" id="7297420">closeDB</span><span class="op" id="7297427">(</span><span class="ident" id="7297428">t</span><span class="op" id="7297429">,</span>&nbsp;<span class="ident" id="7297431">db</span><span class="op" id="7297433">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297437">drv</span>&nbsp;<span class="op" id="7297441">:=</span>&nbsp;<span class="ident" id="7297444">db</span><span class="op" id="7297446">.</span><span class="ident" id="7297447">driver</span><span class="op" id="7297453">.</span><span class="op" id="7297454">(</span><span class="op" id="7297455">*</span><span class="ident" id="7297456">fakeDriver</span><span class="op" id="7297466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297469">drv</span><span class="op" id="7297472">.</span><span class="ident" id="7297473">mu</span><span class="op" id="7297475">.</span><span class="ident" id="7297476">Lock</span><span class="op" id="7297480">(</span><span class="op" id="7297481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297484">opens0</span>&nbsp;<span class="op" id="7297491">:=</span>&nbsp;<span class="ident" id="7297494">drv</span><span class="op" id="7297497">.</span><span class="ident" id="7297498">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297509">closes0</span>&nbsp;<span class="op" id="7297517">:=</span>&nbsp;<span class="ident" id="7297520">drv</span><span class="op" id="7297523">.</span><span class="ident" id="7297524">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297536">drv</span><span class="op" id="7297539">.</span><span class="ident" id="7297540">mu</span><span class="op" id="7297542">.</span><span class="ident" id="7297543">Unlock</span><span class="op" id="7297549">(</span><span class="op" id="7297550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297554">stmt</span><span class="op" id="7297558">,</span>&nbsp;<span class="ident" id="7297560">err</span>&nbsp;<span class="op" id="7297564">:=</span>&nbsp;<span class="ident" id="7297567">db</span><span class="op" id="7297569">.</span><span class="ident" id="7297570">Prepare</span><span class="op" id="7297577">(</span><span class="string" id="7297578">&#34;SELECT|people|name|&#34;</span><span class="op" id="7297599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297602">if</span>&nbsp;<span class="ident" id="7297605">err</span>&nbsp;<span class="op" id="7297609">!=</span>&nbsp;<span class="ident" id="7297612">nil</span>&nbsp;<span class="op" id="7297616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297620">t</span><span class="op" id="7297621">.</span><span class="ident" id="7297622">Fatal</span><span class="op" id="7297627">(</span><span class="ident" id="7297628">err</span><span class="op" id="7297631">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297637">rowsCloseHook</span>&nbsp;<span class="op" id="7297651">=</span>&nbsp;<span class="keyword" id="7297653">func</span><span class="op" id="7297657">(</span><span class="ident" id="7297658">rows</span>&nbsp;<span class="op" id="7297663">*</span><span class="ident" id="7297664">Rows</span><span class="op" id="7297668">,</span>&nbsp;<span class="ident" id="7297670">err</span>&nbsp;<span class="op" id="7297674">*</span><span class="builtintype" id="7297675">error</span><span class="op" id="7297680">)</span>&nbsp;<span class="op" id="7297682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297686">*</span><span class="ident" id="7297687">err</span>&nbsp;<span class="op" id="7297691">=</span>&nbsp;<span class="ident" id="7297693">driver</span><span class="op" id="7297699">.</span><span class="ident" id="7297700">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297715">defer</span>&nbsp;<span class="keyword" id="7297721">func</span><span class="op" id="7297725">(</span><span class="op" id="7297726">)</span>&nbsp;<span class="op" id="7297728">{</span>&nbsp;<span class="ident" id="7297730">rowsCloseHook</span>&nbsp;<span class="op" id="7297744">=</span>&nbsp;<span class="ident" id="7297746">nil</span>&nbsp;<span class="op" id="7297750">}</span><span class="op" id="7297751">(</span><span class="op" id="7297752">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297755">for</span>&nbsp;<span class="ident" id="7297759">i</span>&nbsp;<span class="op" id="7297761">:=</span>&nbsp;<span class="num" id="7297764">0</span><span class="op" id="7297765">;</span>&nbsp;<span class="ident" id="7297767">i</span>&nbsp;<span class="op" id="7297769">&lt;</span>&nbsp;<span class="num" id="7297771">10</span><span class="op" id="7297773">;</span>&nbsp;<span class="ident" id="7297775">i</span><span class="op" id="7297776">++</span>&nbsp;<span class="op" id="7297779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297783">rows</span><span class="op" id="7297787">,</span>&nbsp;<span class="ident" id="7297789">err</span>&nbsp;<span class="op" id="7297793">:=</span>&nbsp;<span class="ident" id="7297796">stmt</span><span class="op" id="7297800">.</span><span class="ident" id="7297801">Query</span><span class="op" id="7297806">(</span><span class="op" id="7297807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297811">if</span>&nbsp;<span class="ident" id="7297814">err</span>&nbsp;<span class="op" id="7297818">!=</span>&nbsp;<span class="ident" id="7297821">nil</span>&nbsp;<span class="op" id="7297825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297830">t</span><span class="op" id="7297831">.</span><span class="ident" id="7297832">Fatal</span><span class="op" id="7297837">(</span><span class="ident" id="7297838">err</span><span class="op" id="7297841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297845">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297849">rows</span><span class="op" id="7297853">.</span><span class="ident" id="7297854">Close</span><span class="op" id="7297859">(</span><span class="op" id="7297860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297866">if</span>&nbsp;<span class="ident" id="7297869">n</span>&nbsp;<span class="op" id="7297871">:=</span>&nbsp;<span class="builtinfunc" id="7297874">len</span><span class="op" id="7297877">(</span><span class="ident" id="7297878">stmt</span><span class="op" id="7297882">.</span><span class="ident" id="7297883">css</span><span class="op" id="7297886">)</span><span class="op" id="7297887">;</span>&nbsp;<span class="ident" id="7297889">n</span>&nbsp;<span class="op" id="7297891">&gt;</span>&nbsp;<span class="num" id="7297893">1</span>&nbsp;<span class="op" id="7297895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297899">t</span><span class="op" id="7297900">.</span><span class="ident" id="7297901">Errorf</span><span class="op" id="7297907">(</span><span class="string" id="7297908">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7297940">,</span>&nbsp;<span class="ident" id="7297942">n</span><span class="op" id="7297943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7297946">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297949">stmt</span><span class="op" id="7297953">.</span><span class="ident" id="7297954">Close</span><span class="op" id="7297959">(</span><span class="op" id="7297960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7297963">if</span>&nbsp;<span class="ident" id="7297966">n</span>&nbsp;<span class="op" id="7297968">:=</span>&nbsp;<span class="builtinfunc" id="7297971">len</span><span class="op" id="7297974">(</span><span class="ident" id="7297975">stmt</span><span class="op" id="7297979">.</span><span class="ident" id="7297980">css</span><span class="op" id="7297983">)</span><span class="op" id="7297984">;</span>&nbsp;<span class="ident" id="7297986">n</span>&nbsp;<span class="op" id="7297988">!=</span>&nbsp;<span class="num" id="7297991">0</span>&nbsp;<span class="op" id="7297993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7297997">t</span><span class="op" id="7297998">.</span><span class="ident" id="7297999">Errorf</span><span class="op" id="7298005">(</span><span class="string" id="7298006">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7298047">,</span>&nbsp;<span class="ident" id="7298049">n</span><span class="op" id="7298050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7298053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298057">drv</span><span class="op" id="7298060">.</span><span class="ident" id="7298061">mu</span><span class="op" id="7298063">.</span><span class="ident" id="7298064">Lock</span><span class="op" id="7298068">(</span><span class="op" id="7298069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298072">opens</span>&nbsp;<span class="op" id="7298078">:=</span>&nbsp;<span class="ident" id="7298081">drv</span><span class="op" id="7298084">.</span><span class="ident" id="7298085">openCount</span>&nbsp;<span class="op" id="7298095">-</span>&nbsp;<span class="ident" id="7298097">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298105">closes</span>&nbsp;<span class="op" id="7298112">:=</span>&nbsp;<span class="ident" id="7298115">drv</span><span class="op" id="7298118">.</span><span class="ident" id="7298119">closeCount</span>&nbsp;<span class="op" id="7298130">-</span>&nbsp;<span class="ident" id="7298132">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298141">drv</span><span class="op" id="7298144">.</span><span class="ident" id="7298145">mu</span><span class="op" id="7298147">.</span><span class="ident" id="7298148">Unlock</span><span class="op" id="7298154">(</span><span class="op" id="7298155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7298158">if</span>&nbsp;<span class="ident" id="7298161">opens</span>&nbsp;<span class="op" id="7298167">&lt;</span>&nbsp;<span class="num" id="7298169">9</span>&nbsp;<span class="op" id="7298171">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298175">t</span><span class="op" id="7298176">.</span><span class="ident" id="7298177">Errorf</span><span class="op" id="7298183">(</span><span class="string" id="7298184">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7298207">,</span>&nbsp;<span class="ident" id="7298209">opens</span><span class="op" id="7298214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7298217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7298220">if</span>&nbsp;<span class="ident" id="7298223">closes</span>&nbsp;<span class="op" id="7298230">&lt;</span>&nbsp;<span class="num" id="7298232">9</span>&nbsp;<span class="op" id="7298234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298238">t</span><span class="op" id="7298239">.</span><span class="ident" id="7298240">Errorf</span><span class="op" id="7298246">(</span><span class="string" id="7298247">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7298271">,</span>&nbsp;<span class="ident" id="7298273">closes</span><span class="op" id="7298279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7298282">}</span><br>
<span class="lineno">1860</span><span class="op" id="7298284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7298287">func</span>&nbsp;<span class="ident" id="7298292">TestConcurrency</span><span class="op" id="7298307">(</span><span class="ident" id="7298308">t</span>&nbsp;<span class="op" id="7298310">*</span><span class="ident" id="7298311">testing</span><span class="op" id="7298318">.</span><span class="ident" id="7298319">T</span><span class="op" id="7298320">)</span>&nbsp;<span class="op" id="7298322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298325">doConcurrentTest</span><span class="op" id="7298341">(</span><span class="ident" id="7298342">t</span><span class="op" id="7298343">,</span>&nbsp;<span class="builtinfunc" id="7298345">new</span><span class="op" id="7298348">(</span><span class="ident" id="7298349">concurrentDBQueryTest</span><span class="op" id="7298370">)</span><span class="op" id="7298371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298374">doConcurrentTest</span><span class="op" id="7298390">(</span><span class="ident" id="7298391">t</span><span class="op" id="7298392">,</span>&nbsp;<span class="builtinfunc" id="7298394">new</span><span class="op" id="7298397">(</span><span class="ident" id="7298398">concurrentDBExecTest</span><span class="op" id="7298418">)</span><span class="op" id="7298419">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298422">doConcurrentTest</span><span class="op" id="7298438">(</span><span class="ident" id="7298439">t</span><span class="op" id="7298440">,</span>&nbsp;<span class="builtinfunc" id="7298442">new</span><span class="op" id="7298445">(</span><span class="ident" id="7298446">concurrentStmtQueryTest</span><span class="op" id="7298469">)</span><span class="op" id="7298470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298473">doConcurrentTest</span><span class="op" id="7298489">(</span><span class="ident" id="7298490">t</span><span class="op" id="7298491">,</span>&nbsp;<span class="builtinfunc" id="7298493">new</span><span class="op" id="7298496">(</span><span class="ident" id="7298497">concurrentStmtExecTest</span><span class="op" id="7298519">)</span><span class="op" id="7298520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298523">doConcurrentTest</span><span class="op" id="7298539">(</span><span class="ident" id="7298540">t</span><span class="op" id="7298541">,</span>&nbsp;<span class="builtinfunc" id="7298543">new</span><span class="op" id="7298546">(</span><span class="ident" id="7298547">concurrentTxQueryTest</span><span class="op" id="7298568">)</span><span class="op" id="7298569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298572">doConcurrentTest</span><span class="op" id="7298588">(</span><span class="ident" id="7298589">t</span><span class="op" id="7298590">,</span>&nbsp;<span class="builtinfunc" id="7298592">new</span><span class="op" id="7298595">(</span><span class="ident" id="7298596">concurrentTxExecTest</span><span class="op" id="7298616">)</span><span class="op" id="7298617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298620">doConcurrentTest</span><span class="op" id="7298636">(</span><span class="ident" id="7298637">t</span><span class="op" id="7298638">,</span>&nbsp;<span class="builtinfunc" id="7298640">new</span><span class="op" id="7298643">(</span><span class="ident" id="7298644">concurrentTxStmtQueryTest</span><span class="op" id="7298669">)</span><span class="op" id="7298670">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298673">doConcurrentTest</span><span class="op" id="7298689">(</span><span class="ident" id="7298690">t</span><span class="op" id="7298691">,</span>&nbsp;<span class="builtinfunc" id="7298693">new</span><span class="op" id="7298696">(</span><span class="ident" id="7298697">concurrentTxStmtExecTest</span><span class="op" id="7298721">)</span><span class="op" id="7298722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298725">doConcurrentTest</span><span class="op" id="7298741">(</span><span class="ident" id="7298742">t</span><span class="op" id="7298743">,</span>&nbsp;<span class="builtinfunc" id="7298745">new</span><span class="op" id="7298748">(</span><span class="ident" id="7298749">concurrentRandomTest</span><span class="op" id="7298769">)</span><span class="op" id="7298770">)</span><br>
<span class="lineno"></span><span class="op" id="7298772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7298775">func</span>&nbsp;<span class="ident" id="7298780">TestConnectionLeak</span><span class="op" id="7298798">(</span><span class="ident" id="7298799">t</span>&nbsp;<span class="op" id="7298801">*</span><span class="ident" id="7298802">testing</span><span class="op" id="7298809">.</span><span class="ident" id="7298810">T</span><span class="op" id="7298811">)</span>&nbsp;<span class="op" id="7298813">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298816">db</span>&nbsp;<span class="op" id="7298819">:=</span>&nbsp;<span class="ident" id="7298822">newTestDB</span><span class="op" id="7298831">(</span><span class="ident" id="7298832">t</span><span class="op" id="7298833">,</span>&nbsp;<span class="string" id="7298835">&#34;people&#34;</span><span class="op" id="7298843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7298846">defer</span>&nbsp;<span class="ident" id="7298852">closeDB</span><span class="op" id="7298859">(</span><span class="ident" id="7298860">t</span><span class="op" id="7298861">,</span>&nbsp;<span class="ident" id="7298863">db</span><span class="op" id="7298865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7298868">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7298909">rows</span>&nbsp;<span class="op" id="7298914">:=</span>&nbsp;<span class="builtinfunc" id="7298917">make</span><span class="op" id="7298921">(</span><span class="op" id="7298922">[</span><span class="op" id="7298923">]</span><span class="op" id="7298924">*</span><span class="ident" id="7298925">Rows</span><span class="op" id="7298929">,</span>&nbsp;<span class="ident" id="7298931">defaultMaxIdleConns</span><span class="op" id="7298950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7298953">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299019">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299089">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299106">db</span><span class="op" id="7299108">.</span><span class="ident" id="7299109">SetMaxOpenConns</span><span class="op" id="7299124">(</span><span class="builtinfunc" id="7299125">len</span><span class="op" id="7299128">(</span><span class="ident" id="7299129">rows</span><span class="op" id="7299133">)</span>&nbsp;<span class="op" id="7299135">+</span>&nbsp;<span class="num" id="7299137">1</span><span class="op" id="7299138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299141">for</span>&nbsp;<span class="ident" id="7299145">ii</span>&nbsp;<span class="op" id="7299148">:=</span>&nbsp;<span class="keyword" id="7299151">range</span>&nbsp;<span class="ident" id="7299157">rows</span>&nbsp;<span class="op" id="7299162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299166">r</span><span class="op" id="7299167">,</span>&nbsp;<span class="ident" id="7299169">err</span>&nbsp;<span class="op" id="7299173">:=</span>&nbsp;<span class="ident" id="7299176">db</span><span class="op" id="7299178">.</span><span class="ident" id="7299179">Query</span><span class="op" id="7299184">(</span><span class="string" id="7299185">&#34;SELECT|people|name|&#34;</span><span class="op" id="7299206">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299210">if</span>&nbsp;<span class="ident" id="7299213">err</span>&nbsp;<span class="op" id="7299217">!=</span>&nbsp;<span class="ident" id="7299220">nil</span>&nbsp;<span class="op" id="7299224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299229">t</span><span class="op" id="7299230">.</span><span class="ident" id="7299231">Fatal</span><span class="op" id="7299236">(</span><span class="ident" id="7299237">err</span><span class="op" id="7299240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7299244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299248">r</span><span class="op" id="7299249">.</span><span class="ident" id="7299250">Next</span><span class="op" id="7299254">(</span><span class="op" id="7299255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299259">if</span>&nbsp;<span class="ident" id="7299262">err</span>&nbsp;<span class="op" id="7299266">:=</span>&nbsp;<span class="ident" id="7299269">r</span><span class="op" id="7299270">.</span><span class="ident" id="7299271">Err</span><span class="op" id="7299274">(</span><span class="op" id="7299275">)</span><span class="op" id="7299276">;</span>&nbsp;<span class="ident" id="7299278">err</span>&nbsp;<span class="op" id="7299282">!=</span>&nbsp;<span class="ident" id="7299285">nil</span>&nbsp;<span class="op" id="7299289">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299294">t</span><span class="op" id="7299295">.</span><span class="ident" id="7299296">Fatal</span><span class="op" id="7299301">(</span><span class="ident" id="7299302">err</span><span class="op" id="7299305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7299309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299313">rows</span><span class="op" id="7299317">[</span><span class="ident" id="7299318">ii</span><span class="op" id="7299320">]</span>&nbsp;<span class="op" id="7299322">=</span>&nbsp;<span class="ident" id="7299324">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7299327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299330">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299389">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299453">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299489">drv</span>&nbsp;<span class="op" id="7299493">:=</span>&nbsp;<span class="ident" id="7299496">db</span><span class="op" id="7299498">.</span><span class="ident" id="7299499">driver</span><span class="op" id="7299505">.</span><span class="op" id="7299506">(</span><span class="op" id="7299507">*</span><span class="ident" id="7299508">fakeDriver</span><span class="op" id="7299518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299521">drv</span><span class="op" id="7299524">.</span><span class="ident" id="7299525">waitCh</span>&nbsp;<span class="op" id="7299532">=</span>&nbsp;<span class="builtinfunc" id="7299534">make</span><span class="op" id="7299538">(</span><span class="keyword" id="7299539">chan</span>&nbsp;<span class="keyword" id="7299544">struct</span><span class="op" id="7299550">{</span><span class="op" id="7299551">}</span><span class="op" id="7299552">,</span>&nbsp;<span class="num" id="7299554">1</span><span class="op" id="7299555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299558">drv</span><span class="op" id="7299561">.</span><span class="ident" id="7299562">waitingCh</span>&nbsp;<span class="op" id="7299572">=</span>&nbsp;<span class="builtinfunc" id="7299574">make</span><span class="op" id="7299578">(</span><span class="keyword" id="7299579">chan</span>&nbsp;<span class="keyword" id="7299584">struct</span><span class="op" id="7299590">{</span><span class="op" id="7299591">}</span><span class="op" id="7299592">,</span>&nbsp;<span class="num" id="7299594">1</span><span class="op" id="7299595">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299598">var</span>&nbsp;<span class="ident" id="7299602">wg</span>&nbsp;<span class="ident" id="7299605">sync</span><span class="op" id="7299609">.</span><span class="ident" id="7299610">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299621">wg</span><span class="op" id="7299623">.</span><span class="ident" id="7299624">Add</span><span class="op" id="7299627">(</span><span class="num" id="7299628">1</span><span class="op" id="7299629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299632">go</span>&nbsp;<span class="keyword" id="7299635">func</span><span class="op" id="7299639">(</span><span class="op" id="7299640">)</span>&nbsp;<span class="op" id="7299642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299646">r</span><span class="op" id="7299647">,</span>&nbsp;<span class="ident" id="7299649">err</span>&nbsp;<span class="op" id="7299653">:=</span>&nbsp;<span class="ident" id="7299656">db</span><span class="op" id="7299658">.</span><span class="ident" id="7299659">Query</span><span class="op" id="7299664">(</span><span class="string" id="7299665">&#34;SELECT|people|name|&#34;</span><span class="op" id="7299686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299690">if</span>&nbsp;<span class="ident" id="7299693">err</span>&nbsp;<span class="op" id="7299697">!=</span>&nbsp;<span class="ident" id="7299700">nil</span>&nbsp;<span class="op" id="7299704">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299709">t</span><span class="op" id="7299710">.</span><span class="ident" id="7299711">Fatal</span><span class="op" id="7299716">(</span><span class="ident" id="7299717">err</span><span class="op" id="7299720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7299724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299728">r</span><span class="op" id="7299729">.</span><span class="ident" id="7299730">Close</span><span class="op" id="7299735">(</span><span class="op" id="7299736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299740">wg</span><span class="op" id="7299742">.</span><span class="ident" id="7299743">Done</span><span class="op" id="7299747">(</span><span class="op" id="7299748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7299751">}</span><span class="op" id="7299752">(</span><span class="op" id="7299753">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299756">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7299825">&lt;-</span><span class="ident" id="7299827">drv</span><span class="op" id="7299830">.</span><span class="ident" id="7299831">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299842">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7299909">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7299969">for</span>&nbsp;<span class="ident" id="7299973">_</span><span class="op" id="7299974">,</span>&nbsp;<span class="ident" id="7299976">v</span>&nbsp;<span class="op" id="7299978">:=</span>&nbsp;<span class="keyword" id="7299981">range</span>&nbsp;<span class="ident" id="7299987">rows</span>&nbsp;<span class="op" id="7299992">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7299996">v</span><span class="op" id="7299997">.</span><span class="ident" id="7299998">Close</span><span class="op" id="7300003">(</span><span class="op" id="7300004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7300007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7300010">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7300081">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7300152">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7300221">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300237">drv</span><span class="op" id="7300240">.</span><span class="ident" id="7300241">waitCh</span>&nbsp;<span class="op" id="7300248">&lt;-</span>&nbsp;<span class="keyword" id="7300251">struct</span><span class="op" id="7300257">{</span><span class="op" id="7300258">}</span><span class="op" id="7300259">{</span><span class="op" id="7300260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300263">wg</span><span class="op" id="7300265">.</span><span class="ident" id="7300266">Wait</span><span class="op" id="7300270">(</span><span class="op" id="7300271">)</span><br>
<span class="lineno"></span><span class="op" id="7300273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="7300276">func</span>&nbsp;<span class="ident" id="7300281">BenchmarkConcurrentDBExec</span><span class="op" id="7300306">(</span><span class="ident" id="7300307">b</span>&nbsp;<span class="op" id="7300309">*</span><span class="ident" id="7300310">testing</span><span class="op" id="7300317">.</span><span class="ident" id="7300318">B</span><span class="op" id="7300319">)</span>&nbsp;<span class="op" id="7300321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300324">b</span><span class="op" id="7300325">.</span><span class="ident" id="7300326">ReportAllocs</span><span class="op" id="7300338">(</span><span class="op" id="7300339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300342">ct</span>&nbsp;<span class="op" id="7300345">:=</span>&nbsp;<span class="builtinfunc" id="7300348">new</span><span class="op" id="7300351">(</span><span class="ident" id="7300352">concurrentDBExecTest</span><span class="op" id="7300372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7300375">for</span>&nbsp;<span class="ident" id="7300379">i</span>&nbsp;<span class="op" id="7300381">:=</span>&nbsp;<span class="num" id="7300384">0</span><span class="op" id="7300385">;</span>&nbsp;<span class="ident" id="7300387">i</span>&nbsp;<span class="op" id="7300389">&lt;</span>&nbsp;<span class="ident" id="7300391">b</span><span class="op" id="7300392">.</span><span class="ident" id="7300393">N</span><span class="op" id="7300394">;</span>&nbsp;<span class="ident" id="7300396">i</span><span class="op" id="7300397">++</span>&nbsp;<span class="op" id="7300400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300404">doConcurrentTest</span><span class="op" id="7300420">(</span><span class="ident" id="7300421">b</span><span class="op" id="7300422">,</span>&nbsp;<span class="ident" id="7300424">ct</span><span class="op" id="7300426">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7300429">}</span><br>
<span class="lineno"></span><span class="op" id="7300431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7300434">func</span>&nbsp;<span class="ident" id="7300439">BenchmarkConcurrentStmtQuery</span><span class="op" id="7300467">(</span><span class="ident" id="7300468">b</span>&nbsp;<span class="op" id="7300470">*</span><span class="ident" id="7300471">testing</span><span class="op" id="7300478">.</span><span class="ident" id="7300479">B</span><span class="op" id="7300480">)</span>&nbsp;<span class="op" id="7300482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300485">b</span><span class="op" id="7300486">.</span><span class="ident" id="7300487">ReportAllocs</span><span class="op" id="7300499">(</span><span class="op" id="7300500">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300503">ct</span>&nbsp;<span class="op" id="7300506">:=</span>&nbsp;<span class="builtinfunc" id="7300509">new</span><span class="op" id="7300512">(</span><span class="ident" id="7300513">concurrentStmtQueryTest</span><span class="op" id="7300536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7300539">for</span>&nbsp;<span class="ident" id="7300543">i</span>&nbsp;<span class="op" id="7300545">:=</span>&nbsp;<span class="num" id="7300548">0</span><span class="op" id="7300549">;</span>&nbsp;<span class="ident" id="7300551">i</span>&nbsp;<span class="op" id="7300553">&lt;</span>&nbsp;<span class="ident" id="7300555">b</span><span class="op" id="7300556">.</span><span class="ident" id="7300557">N</span><span class="op" id="7300558">;</span>&nbsp;<span class="ident" id="7300560">i</span><span class="op" id="7300561">++</span>&nbsp;<span class="op" id="7300564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300568">doConcurrentTest</span><span class="op" id="7300584">(</span><span class="ident" id="7300585">b</span><span class="op" id="7300586">,</span>&nbsp;<span class="ident" id="7300588">ct</span><span class="op" id="7300590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7300593">}</span><br>
<span class="lineno"></span><span class="op" id="7300595">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="7300598">func</span>&nbsp;<span class="ident" id="7300603">BenchmarkConcurrentStmtExec</span><span class="op" id="7300630">(</span><span class="ident" id="7300631">b</span>&nbsp;<span class="op" id="7300633">*</span><span class="ident" id="7300634">testing</span><span class="op" id="7300641">.</span><span class="ident" id="7300642">B</span><span class="op" id="7300643">)</span>&nbsp;<span class="op" id="7300645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300648">b</span><span class="op" id="7300649">.</span><span class="ident" id="7300650">ReportAllocs</span><span class="op" id="7300662">(</span><span class="op" id="7300663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300666">ct</span>&nbsp;<span class="op" id="7300669">:=</span>&nbsp;<span class="builtinfunc" id="7300672">new</span><span class="op" id="7300675">(</span><span class="ident" id="7300676">concurrentStmtExecTest</span><span class="op" id="7300698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7300701">for</span>&nbsp;<span class="ident" id="7300705">i</span>&nbsp;<span class="op" id="7300707">:=</span>&nbsp;<span class="num" id="7300710">0</span><span class="op" id="7300711">;</span>&nbsp;<span class="ident" id="7300713">i</span>&nbsp;<span class="op" id="7300715">&lt;</span>&nbsp;<span class="ident" id="7300717">b</span><span class="op" id="7300718">.</span><span class="ident" id="7300719">N</span><span class="op" id="7300720">;</span>&nbsp;<span class="ident" id="7300722">i</span><span class="op" id="7300723">++</span>&nbsp;<span class="op" id="7300726">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300730">doConcurrentTest</span><span class="op" id="7300746">(</span><span class="ident" id="7300747">b</span><span class="op" id="7300748">,</span>&nbsp;<span class="ident" id="7300750">ct</span><span class="op" id="7300752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7300755">}</span><br>
<span class="lineno"></span><span class="op" id="7300757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7300760">func</span>&nbsp;<span class="ident" id="7300765">BenchmarkConcurrentTxQuery</span><span class="op" id="7300791">(</span><span class="ident" id="7300792">b</span>&nbsp;<span class="op" id="7300794">*</span><span class="ident" id="7300795">testing</span><span class="op" id="7300802">.</span><span class="ident" id="7300803">B</span><span class="op" id="7300804">)</span>&nbsp;<span class="op" id="7300806">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300809">b</span><span class="op" id="7300810">.</span><span class="ident" id="7300811">ReportAllocs</span><span class="op" id="7300823">(</span><span class="op" id="7300824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300827">ct</span>&nbsp;<span class="op" id="7300830">:=</span>&nbsp;<span class="builtinfunc" id="7300833">new</span><span class="op" id="7300836">(</span><span class="ident" id="7300837">concurrentTxQueryTest</span><span class="op" id="7300858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7300861">for</span>&nbsp;<span class="ident" id="7300865">i</span>&nbsp;<span class="op" id="7300867">:=</span>&nbsp;<span class="num" id="7300870">0</span><span class="op" id="7300871">;</span>&nbsp;<span class="ident" id="7300873">i</span>&nbsp;<span class="op" id="7300875">&lt;</span>&nbsp;<span class="ident" id="7300877">b</span><span class="op" id="7300878">.</span><span class="ident" id="7300879">N</span><span class="op" id="7300880">;</span>&nbsp;<span class="ident" id="7300882">i</span><span class="op" id="7300883">++</span>&nbsp;<span class="op" id="7300886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300890">doConcurrentTest</span><span class="op" id="7300906">(</span><span class="ident" id="7300907">b</span><span class="op" id="7300908">,</span>&nbsp;<span class="ident" id="7300910">ct</span><span class="op" id="7300912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7300915">}</span><br>
<span class="lineno">1955</span><span class="op" id="7300917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7300920">func</span>&nbsp;<span class="ident" id="7300925">BenchmarkConcurrentTxExec</span><span class="op" id="7300950">(</span><span class="ident" id="7300951">b</span>&nbsp;<span class="op" id="7300953">*</span><span class="ident" id="7300954">testing</span><span class="op" id="7300961">.</span><span class="ident" id="7300962">B</span><span class="op" id="7300963">)</span>&nbsp;<span class="op" id="7300965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300968">b</span><span class="op" id="7300969">.</span><span class="ident" id="7300970">ReportAllocs</span><span class="op" id="7300982">(</span><span class="op" id="7300983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7300986">ct</span>&nbsp;<span class="op" id="7300989">:=</span>&nbsp;<span class="builtinfunc" id="7300992">new</span><span class="op" id="7300995">(</span><span class="ident" id="7300996">concurrentTxExecTest</span><span class="op" id="7301016">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7301019">for</span>&nbsp;<span class="ident" id="7301023">i</span>&nbsp;<span class="op" id="7301025">:=</span>&nbsp;<span class="num" id="7301028">0</span><span class="op" id="7301029">;</span>&nbsp;<span class="ident" id="7301031">i</span>&nbsp;<span class="op" id="7301033">&lt;</span>&nbsp;<span class="ident" id="7301035">b</span><span class="op" id="7301036">.</span><span class="ident" id="7301037">N</span><span class="op" id="7301038">;</span>&nbsp;<span class="ident" id="7301040">i</span><span class="op" id="7301041">++</span>&nbsp;<span class="op" id="7301044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301048">doConcurrentTest</span><span class="op" id="7301064">(</span><span class="ident" id="7301065">b</span><span class="op" id="7301066">,</span>&nbsp;<span class="ident" id="7301068">ct</span><span class="op" id="7301070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7301073">}</span><br>
<span class="lineno"></span><span class="op" id="7301075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="7301078">func</span>&nbsp;<span class="ident" id="7301083">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="7301113">(</span><span class="ident" id="7301114">b</span>&nbsp;<span class="op" id="7301116">*</span><span class="ident" id="7301117">testing</span><span class="op" id="7301124">.</span><span class="ident" id="7301125">B</span><span class="op" id="7301126">)</span>&nbsp;<span class="op" id="7301128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301131">b</span><span class="op" id="7301132">.</span><span class="ident" id="7301133">ReportAllocs</span><span class="op" id="7301145">(</span><span class="op" id="7301146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301149">ct</span>&nbsp;<span class="op" id="7301152">:=</span>&nbsp;<span class="builtinfunc" id="7301155">new</span><span class="op" id="7301158">(</span><span class="ident" id="7301159">concurrentTxStmtQueryTest</span><span class="op" id="7301184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7301187">for</span>&nbsp;<span class="ident" id="7301191">i</span>&nbsp;<span class="op" id="7301193">:=</span>&nbsp;<span class="num" id="7301196">0</span><span class="op" id="7301197">;</span>&nbsp;<span class="ident" id="7301199">i</span>&nbsp;<span class="op" id="7301201">&lt;</span>&nbsp;<span class="ident" id="7301203">b</span><span class="op" id="7301204">.</span><span class="ident" id="7301205">N</span><span class="op" id="7301206">;</span>&nbsp;<span class="ident" id="7301208">i</span><span class="op" id="7301209">++</span>&nbsp;<span class="op" id="7301212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301216">doConcurrentTest</span><span class="op" id="7301232">(</span><span class="ident" id="7301233">b</span><span class="op" id="7301234">,</span>&nbsp;<span class="ident" id="7301236">ct</span><span class="op" id="7301238">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7301241">}</span><br>
<span class="lineno"></span><span class="op" id="7301243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7301246">func</span>&nbsp;<span class="ident" id="7301251">BenchmarkConcurrentTxStmtExec</span><span class="op" id="7301280">(</span><span class="ident" id="7301281">b</span>&nbsp;<span class="op" id="7301283">*</span><span class="ident" id="7301284">testing</span><span class="op" id="7301291">.</span><span class="ident" id="7301292">B</span><span class="op" id="7301293">)</span>&nbsp;<span class="op" id="7301295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301298">b</span><span class="op" id="7301299">.</span><span class="ident" id="7301300">ReportAllocs</span><span class="op" id="7301312">(</span><span class="op" id="7301313">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301316">ct</span>&nbsp;<span class="op" id="7301319">:=</span>&nbsp;<span class="builtinfunc" id="7301322">new</span><span class="op" id="7301325">(</span><span class="ident" id="7301326">concurrentTxStmtExecTest</span><span class="op" id="7301350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7301353">for</span>&nbsp;<span class="ident" id="7301357">i</span>&nbsp;<span class="op" id="7301359">:=</span>&nbsp;<span class="num" id="7301362">0</span><span class="op" id="7301363">;</span>&nbsp;<span class="ident" id="7301365">i</span>&nbsp;<span class="op" id="7301367">&lt;</span>&nbsp;<span class="ident" id="7301369">b</span><span class="op" id="7301370">.</span><span class="ident" id="7301371">N</span><span class="op" id="7301372">;</span>&nbsp;<span class="ident" id="7301374">i</span><span class="op" id="7301375">++</span>&nbsp;<span class="op" id="7301378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301382">doConcurrentTest</span><span class="op" id="7301398">(</span><span class="ident" id="7301399">b</span><span class="op" id="7301400">,</span>&nbsp;<span class="ident" id="7301402">ct</span><span class="op" id="7301404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7301407">}</span><br>
<span class="lineno"></span><span class="op" id="7301409">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="7301412">func</span>&nbsp;<span class="ident" id="7301417">BenchmarkConcurrentRandom</span><span class="op" id="7301442">(</span><span class="ident" id="7301443">b</span>&nbsp;<span class="op" id="7301445">*</span><span class="ident" id="7301446">testing</span><span class="op" id="7301453">.</span><span class="ident" id="7301454">B</span><span class="op" id="7301455">)</span>&nbsp;<span class="op" id="7301457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301460">b</span><span class="op" id="7301461">.</span><span class="ident" id="7301462">ReportAllocs</span><span class="op" id="7301474">(</span><span class="op" id="7301475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301478">ct</span>&nbsp;<span class="op" id="7301481">:=</span>&nbsp;<span class="builtinfunc" id="7301484">new</span><span class="op" id="7301487">(</span><span class="ident" id="7301488">concurrentRandomTest</span><span class="op" id="7301508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7301511">for</span>&nbsp;<span class="ident" id="7301515">i</span>&nbsp;<span class="op" id="7301517">:=</span>&nbsp;<span class="num" id="7301520">0</span><span class="op" id="7301521">;</span>&nbsp;<span class="ident" id="7301523">i</span>&nbsp;<span class="op" id="7301525">&lt;</span>&nbsp;<span class="ident" id="7301527">b</span><span class="op" id="7301528">.</span><span class="ident" id="7301529">N</span><span class="op" id="7301530">;</span>&nbsp;<span class="ident" id="7301532">i</span><span class="op" id="7301533">++</span>&nbsp;<span class="op" id="7301536">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7301540">doConcurrentTest</span><span class="op" id="7301556">(</span><span class="ident" id="7301557">b</span><span class="op" id="7301558">,</span>&nbsp;<span class="ident" id="7301560">ct</span><span class="op" id="7301562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7301565">}</span><br>
<span class="lineno"></span><span class="op" id="7301567">}</span>
</div>
</body>
</html>
