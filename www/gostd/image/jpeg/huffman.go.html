<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5886925">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5886980">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5887034">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5887085">package</span>&nbsp;<span class="ident" id="5887093">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5887099">import</span>&nbsp;<span class="op" id="5887106">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5887109">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5887114">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="5887117">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5887195">const</span>&nbsp;<span class="ident" id="5887201">maxCodeLength</span>&nbsp;<span class="op" id="5887215">=</span>&nbsp;<span class="num" id="5887217">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5887221">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="5887296">const</span>&nbsp;<span class="ident" id="5887302">maxNCodes</span>&nbsp;<span class="op" id="5887312">=</span>&nbsp;<span class="num" id="5887314">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5887319">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="5887388">const</span>&nbsp;<span class="ident" id="5887394">lutSize</span>&nbsp;<span class="op" id="5887402">=</span>&nbsp;<span class="num" id="5887404">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5887407">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="5887464">type</span>&nbsp;<span class="ident" id="5887469">huffman</span>&nbsp;<span class="keyword" id="5887477">struct</span>&nbsp;<span class="op" id="5887484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887487">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887534">nCodes</span>&nbsp;<span class="builtintype" id="5887541">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887548">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887622">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887694">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887767">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887785">lut</span>&nbsp;<span class="op" id="5887789">[</span><span class="num" id="5887790">1</span>&nbsp;<span class="op" id="5887792">&lt;&lt;</span>&nbsp;<span class="ident" id="5887795">lutSize</span><span class="op" id="5887802">]</span><span class="builtintype" id="5887803">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887811">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887870">vals</span>&nbsp;<span class="op" id="5887875">[</span><span class="ident" id="5887876">maxNCodes</span><span class="op" id="5887885">]</span><span class="builtintype" id="5887886">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887893">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5887964">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5887990">minCodes</span>&nbsp;<span class="op" id="5887999">[</span><span class="ident" id="5888000">maxCodeLength</span><span class="op" id="5888013">]</span><span class="builtintype" id="5888014">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888021">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888092">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888118">maxCodes</span>&nbsp;<span class="op" id="5888127">[</span><span class="ident" id="5888128">maxCodeLength</span><span class="op" id="5888141">]</span><span class="builtintype" id="5888142">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5888149">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888207">valsIndices</span>&nbsp;<span class="op" id="5888219">[</span><span class="ident" id="5888220">maxCodeLength</span><span class="op" id="5888233">]</span><span class="builtintype" id="5888234">int32</span><br>
<span class="lineno"></span><span class="op" id="5888240">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5888243">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="5888319">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5888336">var</span>&nbsp;<span class="ident" id="5888340">errShortHuffmanData</span>&nbsp;<span class="op" id="5888360">=</span>&nbsp;<span class="ident" id="5888362">FormatError</span><span class="op" id="5888373">(</span><span class="string" id="5888374">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="5888394">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5888397">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5888475">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="5888552">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="5888627">func</span>&nbsp;<span class="op" id="5888632">(</span><span class="ident" id="5888633">d</span>&nbsp;<span class="op" id="5888635">*</span><span class="ident" id="5888636">decoder</span><span class="op" id="5888643">)</span>&nbsp;<span class="ident" id="5888645">ensureNBits</span><span class="op" id="5888656">(</span><span class="ident" id="5888657">n</span>&nbsp;<span class="builtintype" id="5888659">int32</span><span class="op" id="5888664">)</span>&nbsp;<span class="builtintype" id="5888666">error</span>&nbsp;<span class="op" id="5888672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888675">for</span>&nbsp;<span class="op" id="5888679">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888683">c</span><span class="op" id="5888684">,</span>&nbsp;<span class="ident" id="5888686">err</span>&nbsp;<span class="op" id="5888690">:=</span>&nbsp;<span class="ident" id="5888693">d</span><span class="op" id="5888694">.</span><span class="ident" id="5888695">readByteStuffedByte</span><span class="op" id="5888714">(</span><span class="op" id="5888715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888719">if</span>&nbsp;<span class="ident" id="5888722">err</span>&nbsp;<span class="op" id="5888726">!=</span>&nbsp;<span class="ident" id="5888729">nil</span>&nbsp;<span class="op" id="5888733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888738">if</span>&nbsp;<span class="ident" id="5888741">err</span>&nbsp;<span class="op" id="5888745">==</span>&nbsp;<span class="ident" id="5888748">io</span><span class="op" id="5888750">.</span><span class="ident" id="5888751">EOF</span>&nbsp;<span class="op" id="5888755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888761">return</span>&nbsp;<span class="ident" id="5888768">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888791">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888796">return</span>&nbsp;<span class="ident" id="5888803">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888813">d</span><span class="op" id="5888814">.</span><span class="ident" id="5888815">bits</span><span class="op" id="5888819">.</span><span class="ident" id="5888820">a</span>&nbsp;<span class="op" id="5888822">=</span>&nbsp;<span class="ident" id="5888824">d</span><span class="op" id="5888825">.</span><span class="ident" id="5888826">bits</span><span class="op" id="5888830">.</span><span class="ident" id="5888831">a</span><span class="op" id="5888832">&lt;&lt;</span><span class="num" id="5888834">8</span>&nbsp;<span class="op" id="5888836">|</span>&nbsp;<span class="builtintype" id="5888838">uint32</span><span class="op" id="5888844">(</span><span class="ident" id="5888845">c</span><span class="op" id="5888846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888850">d</span><span class="op" id="5888851">.</span><span class="ident" id="5888852">bits</span><span class="op" id="5888856">.</span><span class="ident" id="5888857">n</span>&nbsp;<span class="op" id="5888859">+=</span>&nbsp;<span class="num" id="5888862">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888866">if</span>&nbsp;<span class="ident" id="5888869">d</span><span class="op" id="5888870">.</span><span class="ident" id="5888871">bits</span><span class="op" id="5888875">.</span><span class="ident" id="5888876">m</span>&nbsp;<span class="op" id="5888878">==</span>&nbsp;<span class="num" id="5888881">0</span>&nbsp;<span class="op" id="5888883">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888888">d</span><span class="op" id="5888889">.</span><span class="ident" id="5888890">bits</span><span class="op" id="5888894">.</span><span class="ident" id="5888895">m</span>&nbsp;<span class="op" id="5888897">=</span>&nbsp;<span class="num" id="5888899">1</span>&nbsp;<span class="op" id="5888901">&lt;&lt;</span>&nbsp;<span class="num" id="5888904">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888908">}</span>&nbsp;<span class="keyword" id="5888910">else</span>&nbsp;<span class="op" id="5888915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5888920">d</span><span class="op" id="5888921">.</span><span class="ident" id="5888922">bits</span><span class="op" id="5888926">.</span><span class="ident" id="5888927">m</span>&nbsp;<span class="op" id="5888929">&lt;&lt;=</span>&nbsp;<span class="num" id="5888933">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888941">if</span>&nbsp;<span class="ident" id="5888944">d</span><span class="op" id="5888945">.</span><span class="ident" id="5888946">bits</span><span class="op" id="5888950">.</span><span class="ident" id="5888951">n</span>&nbsp;<span class="op" id="5888953">&gt;=</span>&nbsp;<span class="ident" id="5888956">n</span>&nbsp;<span class="op" id="5888958">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888963">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5888974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5888977">return</span>&nbsp;<span class="ident" id="5888984">nil</span><br>
<span class="lineno"></span><span class="op" id="5888988">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5888991">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="5889071">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="5889083">func</span>&nbsp;<span class="op" id="5889088">(</span><span class="ident" id="5889089">d</span>&nbsp;<span class="op" id="5889091">*</span><span class="ident" id="5889092">decoder</span><span class="op" id="5889099">)</span>&nbsp;<span class="ident" id="5889101">receiveExtend</span><span class="op" id="5889114">(</span><span class="ident" id="5889115">t</span>&nbsp;<span class="builtintype" id="5889117">uint8</span><span class="op" id="5889122">)</span>&nbsp;<span class="op" id="5889124">(</span><span class="builtintype" id="5889125">int32</span><span class="op" id="5889130">,</span>&nbsp;<span class="builtintype" id="5889132">error</span><span class="op" id="5889137">)</span>&nbsp;<span class="op" id="5889139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889142">if</span>&nbsp;<span class="ident" id="5889145">d</span><span class="op" id="5889146">.</span><span class="ident" id="5889147">bits</span><span class="op" id="5889151">.</span><span class="ident" id="5889152">n</span>&nbsp;<span class="op" id="5889154">&lt;</span>&nbsp;<span class="builtintype" id="5889156">int32</span><span class="op" id="5889161">(</span><span class="ident" id="5889162">t</span><span class="op" id="5889163">)</span>&nbsp;<span class="op" id="5889165">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889169">if</span>&nbsp;<span class="ident" id="5889172">err</span>&nbsp;<span class="op" id="5889176">:=</span>&nbsp;<span class="ident" id="5889179">d</span><span class="op" id="5889180">.</span><span class="ident" id="5889181">ensureNBits</span><span class="op" id="5889192">(</span><span class="builtintype" id="5889193">int32</span><span class="op" id="5889198">(</span><span class="ident" id="5889199">t</span><span class="op" id="5889200">)</span><span class="op" id="5889201">)</span><span class="op" id="5889202">;</span>&nbsp;<span class="ident" id="5889204">err</span>&nbsp;<span class="op" id="5889208">!=</span>&nbsp;<span class="ident" id="5889211">nil</span>&nbsp;<span class="op" id="5889215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889220">return</span>&nbsp;<span class="num" id="5889227">0</span><span class="op" id="5889228">,</span>&nbsp;<span class="ident" id="5889230">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889242">d</span><span class="op" id="5889243">.</span><span class="ident" id="5889244">bits</span><span class="op" id="5889248">.</span><span class="ident" id="5889249">n</span>&nbsp;<span class="op" id="5889251">-=</span>&nbsp;<span class="builtintype" id="5889254">int32</span><span class="op" id="5889259">(</span><span class="ident" id="5889260">t</span><span class="op" id="5889261">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889264">d</span><span class="op" id="5889265">.</span><span class="ident" id="5889266">bits</span><span class="op" id="5889270">.</span><span class="ident" id="5889271">m</span>&nbsp;<span class="op" id="5889273">&gt;&gt;=</span>&nbsp;<span class="ident" id="5889277">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889280">s</span>&nbsp;<span class="op" id="5889282">:=</span>&nbsp;<span class="builtintype" id="5889285">int32</span><span class="op" id="5889290">(</span><span class="num" id="5889291">1</span><span class="op" id="5889292">)</span>&nbsp;<span class="op" id="5889294">&lt;&lt;</span>&nbsp;<span class="ident" id="5889297">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889300">x</span>&nbsp;<span class="op" id="5889302">:=</span>&nbsp;<span class="builtintype" id="5889305">int32</span><span class="op" id="5889310">(</span><span class="ident" id="5889311">d</span><span class="op" id="5889312">.</span><span class="ident" id="5889313">bits</span><span class="op" id="5889317">.</span><span class="ident" id="5889318">a</span><span class="op" id="5889319">&gt;&gt;</span><span class="builtintype" id="5889321">uint8</span><span class="op" id="5889326">(</span><span class="ident" id="5889327">d</span><span class="op" id="5889328">.</span><span class="ident" id="5889329">bits</span><span class="op" id="5889333">.</span><span class="ident" id="5889334">n</span><span class="op" id="5889335">)</span><span class="op" id="5889336">)</span>&nbsp;<span class="op" id="5889338">&amp;</span>&nbsp;<span class="op" id="5889340">(</span><span class="ident" id="5889341">s</span>&nbsp;<span class="op" id="5889343">-</span>&nbsp;<span class="num" id="5889345">1</span><span class="op" id="5889346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889349">if</span>&nbsp;<span class="ident" id="5889352">x</span>&nbsp;<span class="op" id="5889354">&lt;</span>&nbsp;<span class="ident" id="5889356">s</span><span class="op" id="5889357">&gt;&gt;</span><span class="num" id="5889359">1</span>&nbsp;<span class="op" id="5889361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889365">x</span>&nbsp;<span class="op" id="5889367">+=</span>&nbsp;<span class="op" id="5889370">(</span><span class="op" id="5889371">(</span><span class="op" id="5889372">-</span><span class="num" id="5889373">1</span><span class="op" id="5889374">)</span>&nbsp;<span class="op" id="5889376">&lt;&lt;</span>&nbsp;<span class="ident" id="5889379">t</span><span class="op" id="5889380">)</span>&nbsp;<span class="op" id="5889382">+</span>&nbsp;<span class="num" id="5889384">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889390">return</span>&nbsp;<span class="ident" id="5889397">x</span><span class="op" id="5889398">,</span>&nbsp;<span class="ident" id="5889400">nil</span><br>
<span class="lineno"></span><span class="op" id="5889404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5889407">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="5889488">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5889547">func</span>&nbsp;<span class="op" id="5889552">(</span><span class="ident" id="5889553">d</span>&nbsp;<span class="op" id="5889555">*</span><span class="ident" id="5889556">decoder</span><span class="op" id="5889563">)</span>&nbsp;<span class="ident" id="5889565">processDHT</span><span class="op" id="5889575">(</span><span class="ident" id="5889576">n</span>&nbsp;<span class="builtintype" id="5889578">int</span><span class="op" id="5889581">)</span>&nbsp;<span class="builtintype" id="5889583">error</span>&nbsp;<span class="op" id="5889589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889592">for</span>&nbsp;<span class="ident" id="5889596">n</span>&nbsp;<span class="op" id="5889598">&gt;</span>&nbsp;<span class="num" id="5889600">0</span>&nbsp;<span class="op" id="5889602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889606">if</span>&nbsp;<span class="ident" id="5889609">n</span>&nbsp;<span class="op" id="5889611">&lt;</span>&nbsp;<span class="num" id="5889613">17</span>&nbsp;<span class="op" id="5889616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889621">return</span>&nbsp;<span class="ident" id="5889628">FormatError</span><span class="op" id="5889639">(</span><span class="string" id="5889640">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5889662">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889670">if</span>&nbsp;<span class="ident" id="5889673">err</span>&nbsp;<span class="op" id="5889677">:=</span>&nbsp;<span class="ident" id="5889680">d</span><span class="op" id="5889681">.</span><span class="ident" id="5889682">readFull</span><span class="op" id="5889690">(</span><span class="ident" id="5889691">d</span><span class="op" id="5889692">.</span><span class="ident" id="5889693">tmp</span><span class="op" id="5889696">[</span><span class="op" id="5889697">:</span><span class="num" id="5889698">17</span><span class="op" id="5889700">]</span><span class="op" id="5889701">)</span><span class="op" id="5889702">;</span>&nbsp;<span class="ident" id="5889704">err</span>&nbsp;<span class="op" id="5889708">!=</span>&nbsp;<span class="ident" id="5889711">nil</span>&nbsp;<span class="op" id="5889715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889720">return</span>&nbsp;<span class="ident" id="5889727">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889737">tc</span>&nbsp;<span class="op" id="5889740">:=</span>&nbsp;<span class="ident" id="5889743">d</span><span class="op" id="5889744">.</span><span class="ident" id="5889745">tmp</span><span class="op" id="5889748">[</span><span class="num" id="5889749">0</span><span class="op" id="5889750">]</span>&nbsp;<span class="op" id="5889752">&gt;&gt;</span>&nbsp;<span class="num" id="5889755">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889759">if</span>&nbsp;<span class="ident" id="5889762">tc</span>&nbsp;<span class="op" id="5889765">&gt;</span>&nbsp;<span class="ident" id="5889767">maxTc</span>&nbsp;<span class="op" id="5889773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889778">return</span>&nbsp;<span class="ident" id="5889785">FormatError</span><span class="op" id="5889796">(</span><span class="string" id="5889797">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="5889811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889819">th</span>&nbsp;<span class="op" id="5889822">:=</span>&nbsp;<span class="ident" id="5889825">d</span><span class="op" id="5889826">.</span><span class="ident" id="5889827">tmp</span><span class="op" id="5889830">[</span><span class="num" id="5889831">0</span><span class="op" id="5889832">]</span>&nbsp;<span class="op" id="5889834">&amp;</span>&nbsp;<span class="num" id="5889836">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889843">if</span>&nbsp;<span class="ident" id="5889846">th</span>&nbsp;<span class="op" id="5889849">&gt;</span>&nbsp;<span class="ident" id="5889851">maxTh</span>&nbsp;<span class="op" id="5889857">||</span>&nbsp;<span class="op" id="5889860">!</span><span class="ident" id="5889861">d</span><span class="op" id="5889862">.</span><span class="ident" id="5889863">progressive</span>&nbsp;<span class="op" id="5889875">&amp;&amp;</span>&nbsp;<span class="ident" id="5889878">th</span>&nbsp;<span class="op" id="5889881">&gt;</span>&nbsp;<span class="num" id="5889883">1</span>&nbsp;<span class="op" id="5889885">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5889890">return</span>&nbsp;<span class="ident" id="5889897">FormatError</span><span class="op" id="5889908">(</span><span class="string" id="5889909">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="5889923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5889927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5889931">h</span>&nbsp;<span class="op" id="5889933">:=</span>&nbsp;<span class="op" id="5889936">&amp;</span><span class="ident" id="5889937">d</span><span class="op" id="5889938">.</span><span class="ident" id="5889939">huff</span><span class="op" id="5889943">[</span><span class="ident" id="5889944">tc</span><span class="op" id="5889946">]</span><span class="op" id="5889947">[</span><span class="ident" id="5889948">th</span><span class="op" id="5889950">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5889955">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890006">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890064">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890108">h</span><span class="op" id="5890109">.</span><span class="ident" id="5890110">nCodes</span>&nbsp;<span class="op" id="5890117">=</span>&nbsp;<span class="num" id="5890119">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890123">var</span>&nbsp;<span class="ident" id="5890127">nCodes</span>&nbsp;<span class="op" id="5890134">[</span><span class="ident" id="5890135">maxCodeLength</span><span class="op" id="5890148">]</span><span class="builtintype" id="5890149">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890157">for</span>&nbsp;<span class="ident" id="5890161">i</span>&nbsp;<span class="op" id="5890163">:=</span>&nbsp;<span class="keyword" id="5890166">range</span>&nbsp;<span class="ident" id="5890172">nCodes</span>&nbsp;<span class="op" id="5890179">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890184">nCodes</span><span class="op" id="5890190">[</span><span class="ident" id="5890191">i</span><span class="op" id="5890192">]</span>&nbsp;<span class="op" id="5890194">=</span>&nbsp;<span class="builtintype" id="5890196">int32</span><span class="op" id="5890201">(</span><span class="ident" id="5890202">d</span><span class="op" id="5890203">.</span><span class="ident" id="5890204">tmp</span><span class="op" id="5890207">[</span><span class="ident" id="5890208">i</span><span class="op" id="5890209">+</span><span class="num" id="5890210">1</span><span class="op" id="5890211">]</span><span class="op" id="5890212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890217">h</span><span class="op" id="5890218">.</span><span class="ident" id="5890219">nCodes</span>&nbsp;<span class="op" id="5890226">+=</span>&nbsp;<span class="ident" id="5890229">nCodes</span><span class="op" id="5890235">[</span><span class="ident" id="5890236">i</span><span class="op" id="5890237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890245">if</span>&nbsp;<span class="ident" id="5890248">h</span><span class="op" id="5890249">.</span><span class="ident" id="5890250">nCodes</span>&nbsp;<span class="op" id="5890257">==</span>&nbsp;<span class="num" id="5890260">0</span>&nbsp;<span class="op" id="5890262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890267">return</span>&nbsp;<span class="ident" id="5890274">FormatError</span><span class="op" id="5890285">(</span><span class="string" id="5890286">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="5890317">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890325">if</span>&nbsp;<span class="ident" id="5890328">h</span><span class="op" id="5890329">.</span><span class="ident" id="5890330">nCodes</span>&nbsp;<span class="op" id="5890337">&gt;</span>&nbsp;<span class="ident" id="5890339">maxNCodes</span>&nbsp;<span class="op" id="5890349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890354">return</span>&nbsp;<span class="ident" id="5890361">FormatError</span><span class="op" id="5890372">(</span><span class="string" id="5890373">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="5890409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890417">n</span>&nbsp;<span class="op" id="5890419">-=</span>&nbsp;<span class="builtintype" id="5890422">int</span><span class="op" id="5890425">(</span><span class="ident" id="5890426">h</span><span class="op" id="5890427">.</span><span class="ident" id="5890428">nCodes</span><span class="op" id="5890434">)</span>&nbsp;<span class="op" id="5890436">+</span>&nbsp;<span class="num" id="5890438">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890443">if</span>&nbsp;<span class="ident" id="5890446">n</span>&nbsp;<span class="op" id="5890448">&lt;</span>&nbsp;<span class="num" id="5890450">0</span>&nbsp;<span class="op" id="5890452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890457">return</span>&nbsp;<span class="ident" id="5890464">FormatError</span><span class="op" id="5890475">(</span><span class="string" id="5890476">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5890498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890506">if</span>&nbsp;<span class="ident" id="5890509">err</span>&nbsp;<span class="op" id="5890513">:=</span>&nbsp;<span class="ident" id="5890516">d</span><span class="op" id="5890517">.</span><span class="ident" id="5890518">readFull</span><span class="op" id="5890526">(</span><span class="ident" id="5890527">h</span><span class="op" id="5890528">.</span><span class="ident" id="5890529">vals</span><span class="op" id="5890533">[</span><span class="op" id="5890534">:</span><span class="ident" id="5890535">h</span><span class="op" id="5890536">.</span><span class="ident" id="5890537">nCodes</span><span class="op" id="5890543">]</span><span class="op" id="5890544">)</span><span class="op" id="5890545">;</span>&nbsp;<span class="ident" id="5890547">err</span>&nbsp;<span class="op" id="5890551">!=</span>&nbsp;<span class="ident" id="5890554">nil</span>&nbsp;<span class="op" id="5890558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890563">return</span>&nbsp;<span class="ident" id="5890570">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890581">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890612">for</span>&nbsp;<span class="ident" id="5890616">i</span>&nbsp;<span class="op" id="5890618">:=</span>&nbsp;<span class="keyword" id="5890621">range</span>&nbsp;<span class="ident" id="5890627">h</span><span class="op" id="5890628">.</span><span class="ident" id="5890629">lut</span>&nbsp;<span class="op" id="5890633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890638">h</span><span class="op" id="5890639">.</span><span class="ident" id="5890640">lut</span><span class="op" id="5890643">[</span><span class="ident" id="5890644">i</span><span class="op" id="5890645">]</span>&nbsp;<span class="op" id="5890647">=</span>&nbsp;<span class="num" id="5890649">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5890653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890657">var</span>&nbsp;<span class="ident" id="5890661">x</span><span class="op" id="5890662">,</span>&nbsp;<span class="ident" id="5890664">code</span>&nbsp;<span class="builtintype" id="5890669">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890678">for</span>&nbsp;<span class="ident" id="5890682">i</span>&nbsp;<span class="op" id="5890684">:=</span>&nbsp;<span class="builtintype" id="5890687">uint32</span><span class="op" id="5890693">(</span><span class="num" id="5890694">0</span><span class="op" id="5890695">)</span><span class="op" id="5890696">;</span>&nbsp;<span class="ident" id="5890698">i</span>&nbsp;<span class="op" id="5890700">&lt;</span>&nbsp;<span class="ident" id="5890702">lutSize</span><span class="op" id="5890709">;</span>&nbsp;<span class="ident" id="5890711">i</span><span class="op" id="5890712">++</span>&nbsp;<span class="op" id="5890715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5890720">code</span>&nbsp;<span class="op" id="5890725">&lt;&lt;=</span>&nbsp;<span class="num" id="5890729">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5890734">for</span>&nbsp;<span class="ident" id="5890738">j</span>&nbsp;<span class="op" id="5890740">:=</span>&nbsp;<span class="builtintype" id="5890743">int32</span><span class="op" id="5890748">(</span><span class="num" id="5890749">0</span><span class="op" id="5890750">)</span><span class="op" id="5890751">;</span>&nbsp;<span class="ident" id="5890753">j</span>&nbsp;<span class="op" id="5890755">&lt;</span>&nbsp;<span class="ident" id="5890757">nCodes</span><span class="op" id="5890763">[</span><span class="ident" id="5890764">i</span><span class="op" id="5890765">]</span><span class="op" id="5890766">;</span>&nbsp;<span class="ident" id="5890768">j</span><span class="op" id="5890769">++</span>&nbsp;<span class="op" id="5890772">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890778">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890836">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890892">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5890942">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891000">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891049">base</span>&nbsp;<span class="op" id="5891054">:=</span>&nbsp;<span class="builtintype" id="5891057">uint8</span><span class="op" id="5891062">(</span><span class="ident" id="5891063">code</span>&nbsp;<span class="op" id="5891068">&lt;&lt;</span>&nbsp;<span class="op" id="5891071">(</span><span class="num" id="5891072">7</span>&nbsp;<span class="op" id="5891074">-</span>&nbsp;<span class="ident" id="5891076">i</span><span class="op" id="5891077">)</span><span class="op" id="5891078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891084">lutValue</span>&nbsp;<span class="op" id="5891093">:=</span>&nbsp;<span class="builtintype" id="5891096">uint16</span><span class="op" id="5891102">(</span><span class="ident" id="5891103">h</span><span class="op" id="5891104">.</span><span class="ident" id="5891105">vals</span><span class="op" id="5891109">[</span><span class="ident" id="5891110">x</span><span class="op" id="5891111">]</span><span class="op" id="5891112">)</span><span class="op" id="5891113">&lt;&lt;</span><span class="num" id="5891115">8</span>&nbsp;<span class="op" id="5891117">|</span>&nbsp;<span class="builtintype" id="5891119">uint16</span><span class="op" id="5891125">(</span><span class="num" id="5891126">2</span><span class="op" id="5891127">+</span><span class="ident" id="5891128">i</span><span class="op" id="5891129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891135">for</span>&nbsp;<span class="ident" id="5891139">k</span>&nbsp;<span class="op" id="5891141">:=</span>&nbsp;<span class="builtintype" id="5891144">uint8</span><span class="op" id="5891149">(</span><span class="num" id="5891150">0</span><span class="op" id="5891151">)</span><span class="op" id="5891152">;</span>&nbsp;<span class="ident" id="5891154">k</span>&nbsp;<span class="op" id="5891156">&lt;</span>&nbsp;<span class="num" id="5891158">1</span><span class="op" id="5891159">&lt;&lt;</span><span class="op" id="5891161">(</span><span class="num" id="5891162">7</span><span class="op" id="5891163">-</span><span class="ident" id="5891164">i</span><span class="op" id="5891165">)</span><span class="op" id="5891166">;</span>&nbsp;<span class="ident" id="5891168">k</span><span class="op" id="5891169">++</span>&nbsp;<span class="op" id="5891172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891179">h</span><span class="op" id="5891180">.</span><span class="ident" id="5891181">lut</span><span class="op" id="5891184">[</span><span class="ident" id="5891185">base</span><span class="op" id="5891189">|</span><span class="ident" id="5891190">k</span><span class="op" id="5891191">]</span>&nbsp;<span class="op" id="5891193">=</span>&nbsp;<span class="ident" id="5891195">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891208">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891214">code</span><span class="op" id="5891218">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891225">x</span><span class="op" id="5891226">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891241">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891290">var</span>&nbsp;<span class="ident" id="5891294">c</span><span class="op" id="5891295">,</span>&nbsp;<span class="ident" id="5891297">index</span>&nbsp;<span class="builtintype" id="5891303">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891311">for</span>&nbsp;<span class="ident" id="5891315">i</span><span class="op" id="5891316">,</span>&nbsp;<span class="ident" id="5891318">n</span>&nbsp;<span class="op" id="5891320">:=</span>&nbsp;<span class="keyword" id="5891323">range</span>&nbsp;<span class="ident" id="5891329">nCodes</span>&nbsp;<span class="op" id="5891336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891341">if</span>&nbsp;<span class="ident" id="5891344">n</span>&nbsp;<span class="op" id="5891346">==</span>&nbsp;<span class="num" id="5891349">0</span>&nbsp;<span class="op" id="5891351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891357">h</span><span class="op" id="5891358">.</span><span class="ident" id="5891359">minCodes</span><span class="op" id="5891367">[</span><span class="ident" id="5891368">i</span><span class="op" id="5891369">]</span>&nbsp;<span class="op" id="5891371">=</span>&nbsp;<span class="op" id="5891373">-</span><span class="num" id="5891374">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891380">h</span><span class="op" id="5891381">.</span><span class="ident" id="5891382">maxCodes</span><span class="op" id="5891390">[</span><span class="ident" id="5891391">i</span><span class="op" id="5891392">]</span>&nbsp;<span class="op" id="5891394">=</span>&nbsp;<span class="op" id="5891396">-</span><span class="num" id="5891397">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891403">h</span><span class="op" id="5891404">.</span><span class="ident" id="5891405">valsIndices</span><span class="op" id="5891416">[</span><span class="ident" id="5891417">i</span><span class="op" id="5891418">]</span>&nbsp;<span class="op" id="5891420">=</span>&nbsp;<span class="op" id="5891422">-</span><span class="num" id="5891423">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891428">}</span>&nbsp;<span class="keyword" id="5891430">else</span>&nbsp;<span class="op" id="5891435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891441">h</span><span class="op" id="5891442">.</span><span class="ident" id="5891443">minCodes</span><span class="op" id="5891451">[</span><span class="ident" id="5891452">i</span><span class="op" id="5891453">]</span>&nbsp;<span class="op" id="5891455">=</span>&nbsp;<span class="ident" id="5891457">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891463">h</span><span class="op" id="5891464">.</span><span class="ident" id="5891465">maxCodes</span><span class="op" id="5891473">[</span><span class="ident" id="5891474">i</span><span class="op" id="5891475">]</span>&nbsp;<span class="op" id="5891477">=</span>&nbsp;<span class="ident" id="5891479">c</span>&nbsp;<span class="op" id="5891481">+</span>&nbsp;<span class="ident" id="5891483">n</span>&nbsp;<span class="op" id="5891485">-</span>&nbsp;<span class="num" id="5891487">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891493">h</span><span class="op" id="5891494">.</span><span class="ident" id="5891495">valsIndices</span><span class="op" id="5891506">[</span><span class="ident" id="5891507">i</span><span class="op" id="5891508">]</span>&nbsp;<span class="op" id="5891510">=</span>&nbsp;<span class="ident" id="5891512">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891522">c</span>&nbsp;<span class="op" id="5891524">+=</span>&nbsp;<span class="ident" id="5891527">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891533">index</span>&nbsp;<span class="op" id="5891539">+=</span>&nbsp;<span class="ident" id="5891542">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5891552">c</span>&nbsp;<span class="op" id="5891554">&lt;&lt;=</span>&nbsp;<span class="num" id="5891558">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891568">return</span>&nbsp;<span class="ident" id="5891575">nil</span><br>
<span class="lineno"></span><span class="op" id="5891579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5891582">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="5891657">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="5891684">func</span>&nbsp;<span class="op" id="5891689">(</span><span class="ident" id="5891690">d</span>&nbsp;<span class="op" id="5891692">*</span><span class="ident" id="5891693">decoder</span><span class="op" id="5891700">)</span>&nbsp;<span class="ident" id="5891702">decodeHuffman</span><span class="op" id="5891715">(</span><span class="ident" id="5891716">h</span>&nbsp;<span class="op" id="5891718">*</span><span class="ident" id="5891719">huffman</span><span class="op" id="5891726">)</span>&nbsp;<span class="op" id="5891728">(</span><span class="builtintype" id="5891729">uint8</span><span class="op" id="5891734">,</span>&nbsp;<span class="builtintype" id="5891736">error</span><span class="op" id="5891741">)</span>&nbsp;<span class="op" id="5891743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891746">if</span>&nbsp;<span class="ident" id="5891749">h</span><span class="op" id="5891750">.</span><span class="ident" id="5891751">nCodes</span>&nbsp;<span class="op" id="5891758">==</span>&nbsp;<span class="num" id="5891761">0</span>&nbsp;<span class="op" id="5891763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891767">return</span>&nbsp;<span class="num" id="5891774">0</span><span class="op" id="5891775">,</span>&nbsp;<span class="ident" id="5891777">FormatError</span><span class="op" id="5891788">(</span><span class="string" id="5891789">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="5891818">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891825">if</span>&nbsp;<span class="ident" id="5891828">d</span><span class="op" id="5891829">.</span><span class="ident" id="5891830">bits</span><span class="op" id="5891834">.</span><span class="ident" id="5891835">n</span>&nbsp;<span class="op" id="5891837">&lt;</span>&nbsp;<span class="num" id="5891839">8</span>&nbsp;<span class="op" id="5891841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891845">if</span>&nbsp;<span class="ident" id="5891848">err</span>&nbsp;<span class="op" id="5891852">:=</span>&nbsp;<span class="ident" id="5891855">d</span><span class="op" id="5891856">.</span><span class="ident" id="5891857">ensureNBits</span><span class="op" id="5891868">(</span><span class="num" id="5891869">8</span><span class="op" id="5891870">)</span><span class="op" id="5891871">;</span>&nbsp;<span class="ident" id="5891873">err</span>&nbsp;<span class="op" id="5891877">!=</span>&nbsp;<span class="ident" id="5891880">nil</span>&nbsp;<span class="op" id="5891884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891889">if</span>&nbsp;<span class="ident" id="5891892">err</span>&nbsp;<span class="op" id="5891896">!=</span>&nbsp;<span class="ident" id="5891899">errMissingFF00</span>&nbsp;<span class="op" id="5891914">&amp;&amp;</span>&nbsp;<span class="ident" id="5891917">err</span>&nbsp;<span class="op" id="5891921">!=</span>&nbsp;<span class="ident" id="5891924">errShortHuffmanData</span>&nbsp;<span class="op" id="5891944">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5891950">return</span>&nbsp;<span class="num" id="5891957">0</span><span class="op" id="5891958">,</span>&nbsp;<span class="ident" id="5891960">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5891967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5891972">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5892044">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5892115">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892178">d</span><span class="op" id="5892179">.</span><span class="ident" id="5892180">unreadByteStuffedByte</span><span class="op" id="5892201">(</span><span class="op" id="5892202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892207">goto</span>&nbsp;<span class="ident" id="5892212">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892229">if</span>&nbsp;<span class="ident" id="5892232">v</span>&nbsp;<span class="op" id="5892234">:=</span>&nbsp;<span class="ident" id="5892237">h</span><span class="op" id="5892238">.</span><span class="ident" id="5892239">lut</span><span class="op" id="5892242">[</span><span class="op" id="5892243">(</span><span class="ident" id="5892244">d</span><span class="op" id="5892245">.</span><span class="ident" id="5892246">bits</span><span class="op" id="5892250">.</span><span class="ident" id="5892251">a</span><span class="op" id="5892252">&gt;&gt;</span><span class="builtintype" id="5892254">uint32</span><span class="op" id="5892260">(</span><span class="ident" id="5892261">d</span><span class="op" id="5892262">.</span><span class="ident" id="5892263">bits</span><span class="op" id="5892267">.</span><span class="ident" id="5892268">n</span><span class="op" id="5892269">-</span><span class="ident" id="5892270">lutSize</span><span class="op" id="5892277">)</span><span class="op" id="5892278">)</span><span class="op" id="5892279">&amp;</span><span class="num" id="5892280">0xff</span><span class="op" id="5892284">]</span><span class="op" id="5892285">;</span>&nbsp;<span class="ident" id="5892287">v</span>&nbsp;<span class="op" id="5892289">!=</span>&nbsp;<span class="num" id="5892292">0</span>&nbsp;<span class="op" id="5892294">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892298">n</span>&nbsp;<span class="op" id="5892300">:=</span>&nbsp;<span class="op" id="5892303">(</span><span class="ident" id="5892304">v</span>&nbsp;<span class="op" id="5892306">&amp;</span>&nbsp;<span class="num" id="5892308">0xff</span><span class="op" id="5892312">)</span>&nbsp;<span class="op" id="5892314">-</span>&nbsp;<span class="num" id="5892316">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892320">d</span><span class="op" id="5892321">.</span><span class="ident" id="5892322">bits</span><span class="op" id="5892326">.</span><span class="ident" id="5892327">n</span>&nbsp;<span class="op" id="5892329">-=</span>&nbsp;<span class="builtintype" id="5892332">int32</span><span class="op" id="5892337">(</span><span class="ident" id="5892338">n</span><span class="op" id="5892339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892343">d</span><span class="op" id="5892344">.</span><span class="ident" id="5892345">bits</span><span class="op" id="5892349">.</span><span class="ident" id="5892350">m</span>&nbsp;<span class="op" id="5892352">&gt;&gt;=</span>&nbsp;<span class="ident" id="5892356">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892360">return</span>&nbsp;<span class="builtintype" id="5892367">uint8</span><span class="op" id="5892372">(</span><span class="ident" id="5892373">v</span>&nbsp;<span class="op" id="5892375">&gt;&gt;</span>&nbsp;<span class="num" id="5892378">8</span><span class="op" id="5892379">)</span><span class="op" id="5892380">,</span>&nbsp;<span class="ident" id="5892382">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892387">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="5892390">slowPath</span><span class="op" id="5892398">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892401">for</span>&nbsp;<span class="ident" id="5892405">i</span><span class="op" id="5892406">,</span>&nbsp;<span class="ident" id="5892408">code</span>&nbsp;<span class="op" id="5892413">:=</span>&nbsp;<span class="num" id="5892416">0</span><span class="op" id="5892417">,</span>&nbsp;<span class="builtintype" id="5892419">int32</span><span class="op" id="5892424">(</span><span class="num" id="5892425">0</span><span class="op" id="5892426">)</span><span class="op" id="5892427">;</span>&nbsp;<span class="ident" id="5892429">i</span>&nbsp;<span class="op" id="5892431">&lt;</span>&nbsp;<span class="ident" id="5892433">maxCodeLength</span><span class="op" id="5892446">;</span>&nbsp;<span class="ident" id="5892448">i</span><span class="op" id="5892449">++</span>&nbsp;<span class="op" id="5892452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892456">if</span>&nbsp;<span class="ident" id="5892459">d</span><span class="op" id="5892460">.</span><span class="ident" id="5892461">bits</span><span class="op" id="5892465">.</span><span class="ident" id="5892466">n</span>&nbsp;<span class="op" id="5892468">==</span>&nbsp;<span class="num" id="5892471">0</span>&nbsp;<span class="op" id="5892473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892478">if</span>&nbsp;<span class="ident" id="5892481">err</span>&nbsp;<span class="op" id="5892485">:=</span>&nbsp;<span class="ident" id="5892488">d</span><span class="op" id="5892489">.</span><span class="ident" id="5892490">ensureNBits</span><span class="op" id="5892501">(</span><span class="num" id="5892502">1</span><span class="op" id="5892503">)</span><span class="op" id="5892504">;</span>&nbsp;<span class="ident" id="5892506">err</span>&nbsp;<span class="op" id="5892510">!=</span>&nbsp;<span class="ident" id="5892513">nil</span>&nbsp;<span class="op" id="5892517">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892523">return</span>&nbsp;<span class="num" id="5892530">0</span><span class="op" id="5892531">,</span>&nbsp;<span class="ident" id="5892533">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892548">if</span>&nbsp;<span class="ident" id="5892551">d</span><span class="op" id="5892552">.</span><span class="ident" id="5892553">bits</span><span class="op" id="5892557">.</span><span class="ident" id="5892558">a</span><span class="op" id="5892559">&amp;</span><span class="ident" id="5892560">d</span><span class="op" id="5892561">.</span><span class="ident" id="5892562">bits</span><span class="op" id="5892566">.</span><span class="ident" id="5892567">m</span>&nbsp;<span class="op" id="5892569">!=</span>&nbsp;<span class="num" id="5892572">0</span>&nbsp;<span class="op" id="5892574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892579">code</span>&nbsp;<span class="op" id="5892584">|=</span>&nbsp;<span class="num" id="5892587">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892595">d</span><span class="op" id="5892596">.</span><span class="ident" id="5892597">bits</span><span class="op" id="5892601">.</span><span class="ident" id="5892602">n</span><span class="op" id="5892603">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892608">d</span><span class="op" id="5892609">.</span><span class="ident" id="5892610">bits</span><span class="op" id="5892614">.</span><span class="ident" id="5892615">m</span>&nbsp;<span class="op" id="5892617">&gt;&gt;=</span>&nbsp;<span class="num" id="5892621">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892625">if</span>&nbsp;<span class="ident" id="5892628">code</span>&nbsp;<span class="op" id="5892633">&lt;=</span>&nbsp;<span class="ident" id="5892636">h</span><span class="op" id="5892637">.</span><span class="ident" id="5892638">maxCodes</span><span class="op" id="5892646">[</span><span class="ident" id="5892647">i</span><span class="op" id="5892648">]</span>&nbsp;<span class="op" id="5892650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892655">return</span>&nbsp;<span class="ident" id="5892662">h</span><span class="op" id="5892663">.</span><span class="ident" id="5892664">vals</span><span class="op" id="5892668">[</span><span class="ident" id="5892669">h</span><span class="op" id="5892670">.</span><span class="ident" id="5892671">valsIndices</span><span class="op" id="5892682">[</span><span class="ident" id="5892683">i</span><span class="op" id="5892684">]</span><span class="op" id="5892685">+</span><span class="ident" id="5892686">code</span><span class="op" id="5892690">-</span><span class="ident" id="5892691">h</span><span class="op" id="5892692">.</span><span class="ident" id="5892693">minCodes</span><span class="op" id="5892701">[</span><span class="ident" id="5892702">i</span><span class="op" id="5892703">]</span><span class="op" id="5892704">]</span><span class="op" id="5892705">,</span>&nbsp;<span class="ident" id="5892707">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892717">code</span>&nbsp;<span class="op" id="5892722">&lt;&lt;=</span>&nbsp;<span class="num" id="5892726">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892732">return</span>&nbsp;<span class="num" id="5892739">0</span><span class="op" id="5892740">,</span>&nbsp;<span class="ident" id="5892742">FormatError</span><span class="op" id="5892753">(</span><span class="string" id="5892754">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="5892772">)</span><br>
<span class="lineno"></span><span class="op" id="5892774">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="5892777">func</span>&nbsp;<span class="op" id="5892782">(</span><span class="ident" id="5892783">d</span>&nbsp;<span class="op" id="5892785">*</span><span class="ident" id="5892786">decoder</span><span class="op" id="5892793">)</span>&nbsp;<span class="ident" id="5892795">decodeBit</span><span class="op" id="5892804">(</span><span class="op" id="5892805">)</span>&nbsp;<span class="op" id="5892807">(</span><span class="builtintype" id="5892808">bool</span><span class="op" id="5892812">,</span>&nbsp;<span class="builtintype" id="5892814">error</span><span class="op" id="5892819">)</span>&nbsp;<span class="op" id="5892821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892824">if</span>&nbsp;<span class="ident" id="5892827">d</span><span class="op" id="5892828">.</span><span class="ident" id="5892829">bits</span><span class="op" id="5892833">.</span><span class="ident" id="5892834">n</span>&nbsp;<span class="op" id="5892836">==</span>&nbsp;<span class="num" id="5892839">0</span>&nbsp;<span class="op" id="5892841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892845">if</span>&nbsp;<span class="ident" id="5892848">err</span>&nbsp;<span class="op" id="5892852">:=</span>&nbsp;<span class="ident" id="5892855">d</span><span class="op" id="5892856">.</span><span class="ident" id="5892857">ensureNBits</span><span class="op" id="5892868">(</span><span class="num" id="5892869">1</span><span class="op" id="5892870">)</span><span class="op" id="5892871">;</span>&nbsp;<span class="ident" id="5892873">err</span>&nbsp;<span class="op" id="5892877">!=</span>&nbsp;<span class="ident" id="5892880">nil</span>&nbsp;<span class="op" id="5892884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892889">return</span>&nbsp;<span class="builtintype" id="5892896">false</span><span class="op" id="5892901">,</span>&nbsp;<span class="ident" id="5892903">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5892912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892915">ret</span>&nbsp;<span class="op" id="5892919">:=</span>&nbsp;<span class="ident" id="5892922">d</span><span class="op" id="5892923">.</span><span class="ident" id="5892924">bits</span><span class="op" id="5892928">.</span><span class="ident" id="5892929">a</span><span class="op" id="5892930">&amp;</span><span class="ident" id="5892931">d</span><span class="op" id="5892932">.</span><span class="ident" id="5892933">bits</span><span class="op" id="5892937">.</span><span class="ident" id="5892938">m</span>&nbsp;<span class="op" id="5892940">!=</span>&nbsp;<span class="num" id="5892943">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892946">d</span><span class="op" id="5892947">.</span><span class="ident" id="5892948">bits</span><span class="op" id="5892952">.</span><span class="ident" id="5892953">n</span><span class="op" id="5892954">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5892958">d</span><span class="op" id="5892959">.</span><span class="ident" id="5892960">bits</span><span class="op" id="5892964">.</span><span class="ident" id="5892965">m</span>&nbsp;<span class="op" id="5892967">&gt;&gt;=</span>&nbsp;<span class="num" id="5892971">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5892974">return</span>&nbsp;<span class="ident" id="5892981">ret</span><span class="op" id="5892984">,</span>&nbsp;<span class="ident" id="5892986">nil</span><br>
<span class="lineno"></span><span class="op" id="5892990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5892993">func</span>&nbsp;<span class="op" id="5892998">(</span><span class="ident" id="5892999">d</span>&nbsp;<span class="op" id="5893001">*</span><span class="ident" id="5893002">decoder</span><span class="op" id="5893009">)</span>&nbsp;<span class="ident" id="5893011">decodeBits</span><span class="op" id="5893021">(</span><span class="ident" id="5893022">n</span>&nbsp;<span class="builtintype" id="5893024">int32</span><span class="op" id="5893029">)</span>&nbsp;<span class="op" id="5893031">(</span><span class="builtintype" id="5893032">uint32</span><span class="op" id="5893038">,</span>&nbsp;<span class="builtintype" id="5893040">error</span><span class="op" id="5893045">)</span>&nbsp;<span class="op" id="5893047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893050">if</span>&nbsp;<span class="ident" id="5893053">d</span><span class="op" id="5893054">.</span><span class="ident" id="5893055">bits</span><span class="op" id="5893059">.</span><span class="ident" id="5893060">n</span>&nbsp;<span class="op" id="5893062">&lt;</span>&nbsp;<span class="ident" id="5893064">n</span>&nbsp;<span class="op" id="5893066">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893070">if</span>&nbsp;<span class="ident" id="5893073">err</span>&nbsp;<span class="op" id="5893077">:=</span>&nbsp;<span class="ident" id="5893080">d</span><span class="op" id="5893081">.</span><span class="ident" id="5893082">ensureNBits</span><span class="op" id="5893093">(</span><span class="ident" id="5893094">n</span><span class="op" id="5893095">)</span><span class="op" id="5893096">;</span>&nbsp;<span class="ident" id="5893098">err</span>&nbsp;<span class="op" id="5893102">!=</span>&nbsp;<span class="ident" id="5893105">nil</span>&nbsp;<span class="op" id="5893109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893114">return</span>&nbsp;<span class="num" id="5893121">0</span><span class="op" id="5893122">,</span>&nbsp;<span class="ident" id="5893124">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5893133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893136">ret</span>&nbsp;<span class="op" id="5893140">:=</span>&nbsp;<span class="ident" id="5893143">d</span><span class="op" id="5893144">.</span><span class="ident" id="5893145">bits</span><span class="op" id="5893149">.</span><span class="ident" id="5893150">a</span>&nbsp;<span class="op" id="5893152">&gt;&gt;</span>&nbsp;<span class="builtintype" id="5893155">uint32</span><span class="op" id="5893161">(</span><span class="ident" id="5893162">d</span><span class="op" id="5893163">.</span><span class="ident" id="5893164">bits</span><span class="op" id="5893168">.</span><span class="ident" id="5893169">n</span><span class="op" id="5893170">-</span><span class="ident" id="5893171">n</span><span class="op" id="5893172">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893175">ret</span>&nbsp;<span class="op" id="5893179">&amp;=</span>&nbsp;<span class="op" id="5893182">(</span><span class="num" id="5893183">1</span>&nbsp;<span class="op" id="5893185">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5893188">uint32</span><span class="op" id="5893194">(</span><span class="ident" id="5893195">n</span><span class="op" id="5893196">)</span><span class="op" id="5893197">)</span>&nbsp;<span class="op" id="5893199">-</span>&nbsp;<span class="num" id="5893201">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893204">d</span><span class="op" id="5893205">.</span><span class="ident" id="5893206">bits</span><span class="op" id="5893210">.</span><span class="ident" id="5893211">n</span>&nbsp;<span class="op" id="5893213">-=</span>&nbsp;<span class="ident" id="5893216">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5893219">d</span><span class="op" id="5893220">.</span><span class="ident" id="5893221">bits</span><span class="op" id="5893225">.</span><span class="ident" id="5893226">m</span>&nbsp;<span class="op" id="5893228">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="5893232">uint32</span><span class="op" id="5893238">(</span><span class="ident" id="5893239">n</span><span class="op" id="5893240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5893243">return</span>&nbsp;<span class="ident" id="5893250">ret</span><span class="op" id="5893253">,</span>&nbsp;<span class="ident" id="5893255">nil</span><br>
<span class="lineno"></span><span class="op" id="5893259">}</span>
</div>
</body>
</html>
