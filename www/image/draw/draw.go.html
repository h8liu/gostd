<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5578453">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5578509">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5578563">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5578614">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5578668">//</span><br>
<span class="lineno"></span><span class="comment" id="5578671">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5578743">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5578793">package</span>&nbsp;<span class="ident" id="5578801">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5578807">import</span>&nbsp;<span class="op" id="5578814">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5578817">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5578826">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5578840">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5578843">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5578905">const</span>&nbsp;<span class="ident" id="5578911">m</span>&nbsp;<span class="op" id="5578913">=</span>&nbsp;<span class="num" id="5578915">1</span><span class="op" id="5578916">&lt;&lt;</span><span class="num" id="5578918">16</span>&nbsp;<span class="op" id="5578921">-</span>&nbsp;<span class="num" id="5578923">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5578926">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5578997">type</span>&nbsp;<span class="ident" id="5579002">Image</span>&nbsp;<span class="keyword" id="5579008">interface</span>&nbsp;<span class="op" id="5579018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579021">image</span><span class="op" id="5579026">.</span><span class="ident" id="5579027">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579034">Set</span><span class="op" id="5579037">(</span><span class="ident" id="5579038">x</span><span class="op" id="5579039">,</span>&nbsp;<span class="ident" id="5579041">y</span>&nbsp;<span class="builtintype" id="5579043">int</span><span class="op" id="5579046">,</span>&nbsp;<span class="ident" id="5579048">c</span>&nbsp;<span class="ident" id="5579050">color</span><span class="op" id="5579055">.</span><span class="ident" id="5579056">Color</span><span class="op" id="5579061">)</span><br>
<span class="lineno"></span><span class="op" id="5579063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5579066">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5579112">type</span>&nbsp;<span class="ident" id="5579117">Quantizer</span>&nbsp;<span class="keyword" id="5579127">interface</span>&nbsp;<span class="op" id="5579137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579140">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579211">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579278">Quantize</span><span class="op" id="5579286">(</span><span class="ident" id="5579287">p</span>&nbsp;<span class="ident" id="5579289">color</span><span class="op" id="5579294">.</span><span class="ident" id="5579295">Palette</span><span class="op" id="5579302">,</span>&nbsp;<span class="ident" id="5579304">m</span>&nbsp;<span class="ident" id="5579306">image</span><span class="op" id="5579311">.</span><span class="ident" id="5579312">Image</span><span class="op" id="5579317">)</span>&nbsp;<span class="ident" id="5579319">color</span><span class="op" id="5579324">.</span><span class="ident" id="5579325">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5579333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5579336">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5579381">type</span>&nbsp;<span class="ident" id="5579386">Op</span>&nbsp;<span class="builtintype" id="5579389">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5579394">const</span>&nbsp;<span class="op" id="5579400">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579403">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579450">Over</span>&nbsp;<span class="ident" id="5579455">Op</span>&nbsp;<span class="op" id="5579458">=</span>&nbsp;<span class="ident" id="5579460">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579466">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579501">Src</span><br>
<span class="lineno">40</span><span class="op" id="5579505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5579508">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5579587">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5579594">func</span>&nbsp;<span class="op" id="5579599">(</span><span class="ident" id="5579600">op</span>&nbsp;<span class="ident" id="5579603">Op</span><span class="op" id="5579605">)</span>&nbsp;<span class="ident" id="5579607">Draw</span><span class="op" id="5579611">(</span><span class="ident" id="5579612">dst</span>&nbsp;<span class="ident" id="5579616">Image</span><span class="op" id="5579621">,</span>&nbsp;<span class="ident" id="5579623">r</span>&nbsp;<span class="ident" id="5579625">image</span><span class="op" id="5579630">.</span><span class="ident" id="5579631">Rectangle</span><span class="op" id="5579640">,</span>&nbsp;<span class="ident" id="5579642">src</span>&nbsp;<span class="ident" id="5579646">image</span><span class="op" id="5579651">.</span><span class="ident" id="5579652">Image</span><span class="op" id="5579657">,</span>&nbsp;<span class="ident" id="5579659">sp</span>&nbsp;<span class="ident" id="5579662">image</span><span class="op" id="5579667">.</span><span class="ident" id="5579668">Point</span><span class="op" id="5579673">)</span>&nbsp;<span class="op" id="5579675">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579678">DrawMask</span><span class="op" id="5579686">(</span><span class="ident" id="5579687">dst</span><span class="op" id="5579690">,</span>&nbsp;<span class="ident" id="5579692">r</span><span class="op" id="5579693">,</span>&nbsp;<span class="ident" id="5579695">src</span><span class="op" id="5579698">,</span>&nbsp;<span class="ident" id="5579700">sp</span><span class="op" id="5579702">,</span>&nbsp;<span class="ident" id="5579704">nil</span><span class="op" id="5579707">,</span>&nbsp;<span class="ident" id="5579709">image</span><span class="op" id="5579714">.</span><span class="ident" id="5579715">Point</span><span class="op" id="5579720">{</span><span class="op" id="5579721">}</span><span class="op" id="5579722">,</span>&nbsp;<span class="ident" id="5579724">op</span><span class="op" id="5579726">)</span><br>
<span class="lineno"></span><span class="op" id="5579728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5579731">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5579767">type</span>&nbsp;<span class="ident" id="5579772">Drawer</span>&nbsp;<span class="keyword" id="5579779">interface</span>&nbsp;<span class="op" id="5579789">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579792">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5579858">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5579920">Draw</span><span class="op" id="5579924">(</span><span class="ident" id="5579925">dst</span>&nbsp;<span class="ident" id="5579929">Image</span><span class="op" id="5579934">,</span>&nbsp;<span class="ident" id="5579936">r</span>&nbsp;<span class="ident" id="5579938">image</span><span class="op" id="5579943">.</span><span class="ident" id="5579944">Rectangle</span><span class="op" id="5579953">,</span>&nbsp;<span class="ident" id="5579955">src</span>&nbsp;<span class="ident" id="5579959">image</span><span class="op" id="5579964">.</span><span class="ident" id="5579965">Image</span><span class="op" id="5579970">,</span>&nbsp;<span class="ident" id="5579972">sp</span>&nbsp;<span class="ident" id="5579975">image</span><span class="op" id="5579980">.</span><span class="ident" id="5579981">Point</span><span class="op" id="5579986">)</span><br>
<span class="lineno"></span><span class="op" id="5579988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5579991">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5580067">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5580081">var</span>&nbsp;<span class="ident" id="5580085">FloydSteinberg</span>&nbsp;<span class="ident" id="5580100">Drawer</span>&nbsp;<span class="op" id="5580107">=</span>&nbsp;<span class="ident" id="5580109">floydSteinberg</span><span class="op" id="5580123">{</span><span class="op" id="5580124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5580127">type</span>&nbsp;<span class="ident" id="5580132">floydSteinberg</span>&nbsp;<span class="keyword" id="5580147">struct</span><span class="op" id="5580153">{</span><span class="op" id="5580154">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5580157">func</span>&nbsp;<span class="op" id="5580162">(</span><span class="ident" id="5580163">floydSteinberg</span><span class="op" id="5580177">)</span>&nbsp;<span class="ident" id="5580179">Draw</span><span class="op" id="5580183">(</span><span class="ident" id="5580184">dst</span>&nbsp;<span class="ident" id="5580188">Image</span><span class="op" id="5580193">,</span>&nbsp;<span class="ident" id="5580195">r</span>&nbsp;<span class="ident" id="5580197">image</span><span class="op" id="5580202">.</span><span class="ident" id="5580203">Rectangle</span><span class="op" id="5580212">,</span>&nbsp;<span class="ident" id="5580214">src</span>&nbsp;<span class="ident" id="5580218">image</span><span class="op" id="5580223">.</span><span class="ident" id="5580224">Image</span><span class="op" id="5580229">,</span>&nbsp;<span class="ident" id="5580231">sp</span>&nbsp;<span class="ident" id="5580234">image</span><span class="op" id="5580239">.</span><span class="ident" id="5580240">Point</span><span class="op" id="5580245">)</span>&nbsp;<span class="op" id="5580247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580250">clip</span><span class="op" id="5580254">(</span><span class="ident" id="5580255">dst</span><span class="op" id="5580258">,</span>&nbsp;<span class="op" id="5580260">&amp;</span><span class="ident" id="5580261">r</span><span class="op" id="5580262">,</span>&nbsp;<span class="ident" id="5580264">src</span><span class="op" id="5580267">,</span>&nbsp;<span class="op" id="5580269">&amp;</span><span class="ident" id="5580270">sp</span><span class="op" id="5580272">,</span>&nbsp;<span class="ident" id="5580274">nil</span><span class="op" id="5580277">,</span>&nbsp;<span class="ident" id="5580279">nil</span><span class="op" id="5580282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580285">if</span>&nbsp;<span class="ident" id="5580288">r</span><span class="op" id="5580289">.</span><span class="ident" id="5580290">Empty</span><span class="op" id="5580295">(</span><span class="op" id="5580296">)</span>&nbsp;<span class="op" id="5580298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580302">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580313">drawPaletted</span><span class="op" id="5580325">(</span><span class="ident" id="5580326">dst</span><span class="op" id="5580329">,</span>&nbsp;<span class="ident" id="5580331">r</span><span class="op" id="5580332">,</span>&nbsp;<span class="ident" id="5580334">src</span><span class="op" id="5580337">,</span>&nbsp;<span class="ident" id="5580339">sp</span><span class="op" id="5580341">,</span>&nbsp;<span class="ident" id="5580343">true</span><span class="op" id="5580347">)</span><br>
<span class="lineno"></span><span class="op" id="5580349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5580352">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5580424">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5580501">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5580544">func</span>&nbsp;<span class="ident" id="5580549">clip</span><span class="op" id="5580553">(</span><span class="ident" id="5580554">dst</span>&nbsp;<span class="ident" id="5580558">Image</span><span class="op" id="5580563">,</span>&nbsp;<span class="ident" id="5580565">r</span>&nbsp;<span class="op" id="5580567">*</span><span class="ident" id="5580568">image</span><span class="op" id="5580573">.</span><span class="ident" id="5580574">Rectangle</span><span class="op" id="5580583">,</span>&nbsp;<span class="ident" id="5580585">src</span>&nbsp;<span class="ident" id="5580589">image</span><span class="op" id="5580594">.</span><span class="ident" id="5580595">Image</span><span class="op" id="5580600">,</span>&nbsp;<span class="ident" id="5580602">sp</span>&nbsp;<span class="op" id="5580605">*</span><span class="ident" id="5580606">image</span><span class="op" id="5580611">.</span><span class="ident" id="5580612">Point</span><span class="op" id="5580617">,</span>&nbsp;<span class="ident" id="5580619">mask</span>&nbsp;<span class="ident" id="5580624">image</span><span class="op" id="5580629">.</span><span class="ident" id="5580630">Image</span><span class="op" id="5580635">,</span>&nbsp;<span class="ident" id="5580637">mp</span>&nbsp;<span class="op" id="5580640">*</span><span class="ident" id="5580641">image</span><span class="op" id="5580646">.</span><span class="ident" id="5580647">Point</span><span class="op" id="5580652">)</span>&nbsp;<span class="op" id="5580654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580657">orig</span>&nbsp;<span class="op" id="5580662">:=</span>&nbsp;<span class="ident" id="5580665">r</span><span class="op" id="5580666">.</span><span class="ident" id="5580667">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580672">*</span><span class="ident" id="5580673">r</span>&nbsp;<span class="op" id="5580675">=</span>&nbsp;<span class="ident" id="5580677">r</span><span class="op" id="5580678">.</span><span class="ident" id="5580679">Intersect</span><span class="op" id="5580688">(</span><span class="ident" id="5580689">dst</span><span class="op" id="5580692">.</span><span class="ident" id="5580693">Bounds</span><span class="op" id="5580699">(</span><span class="op" id="5580700">)</span><span class="op" id="5580701">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580704">*</span><span class="ident" id="5580705">r</span>&nbsp;<span class="op" id="5580707">=</span>&nbsp;<span class="ident" id="5580709">r</span><span class="op" id="5580710">.</span><span class="ident" id="5580711">Intersect</span><span class="op" id="5580720">(</span><span class="ident" id="5580721">src</span><span class="op" id="5580724">.</span><span class="ident" id="5580725">Bounds</span><span class="op" id="5580731">(</span><span class="op" id="5580732">)</span><span class="op" id="5580733">.</span><span class="ident" id="5580734">Add</span><span class="op" id="5580737">(</span><span class="ident" id="5580738">orig</span><span class="op" id="5580742">.</span><span class="ident" id="5580743">Sub</span><span class="op" id="5580746">(</span><span class="op" id="5580747">*</span><span class="ident" id="5580748">sp</span><span class="op" id="5580750">)</span><span class="op" id="5580751">)</span><span class="op" id="5580752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580755">if</span>&nbsp;<span class="ident" id="5580758">mask</span>&nbsp;<span class="op" id="5580763">!=</span>&nbsp;<span class="ident" id="5580766">nil</span>&nbsp;<span class="op" id="5580770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580774">*</span><span class="ident" id="5580775">r</span>&nbsp;<span class="op" id="5580777">=</span>&nbsp;<span class="ident" id="5580779">r</span><span class="op" id="5580780">.</span><span class="ident" id="5580781">Intersect</span><span class="op" id="5580790">(</span><span class="ident" id="5580791">mask</span><span class="op" id="5580795">.</span><span class="ident" id="5580796">Bounds</span><span class="op" id="5580802">(</span><span class="op" id="5580803">)</span><span class="op" id="5580804">.</span><span class="ident" id="5580805">Add</span><span class="op" id="5580808">(</span><span class="ident" id="5580809">orig</span><span class="op" id="5580813">.</span><span class="ident" id="5580814">Sub</span><span class="op" id="5580817">(</span><span class="op" id="5580818">*</span><span class="ident" id="5580819">mp</span><span class="op" id="5580821">)</span><span class="op" id="5580822">)</span><span class="op" id="5580823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580829">dx</span>&nbsp;<span class="op" id="5580832">:=</span>&nbsp;<span class="ident" id="5580835">r</span><span class="op" id="5580836">.</span><span class="ident" id="5580837">Min</span><span class="op" id="5580840">.</span><span class="ident" id="5580841">X</span>&nbsp;<span class="op" id="5580843">-</span>&nbsp;<span class="ident" id="5580845">orig</span><span class="op" id="5580849">.</span><span class="ident" id="5580850">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5580853">dy</span>&nbsp;<span class="op" id="5580856">:=</span>&nbsp;<span class="ident" id="5580859">r</span><span class="op" id="5580860">.</span><span class="ident" id="5580861">Min</span><span class="op" id="5580864">.</span><span class="ident" id="5580865">Y</span>&nbsp;<span class="op" id="5580867">-</span>&nbsp;<span class="ident" id="5580869">orig</span><span class="op" id="5580873">.</span><span class="ident" id="5580874">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580877">if</span>&nbsp;<span class="ident" id="5580880">dx</span>&nbsp;<span class="op" id="5580883">==</span>&nbsp;<span class="num" id="5580886">0</span>&nbsp;<span class="op" id="5580888">&amp;&amp;</span>&nbsp;<span class="ident" id="5580891">dy</span>&nbsp;<span class="op" id="5580894">==</span>&nbsp;<span class="num" id="5580897">0</span>&nbsp;<span class="op" id="5580899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5580903">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580914">(</span><span class="op" id="5580915">*</span><span class="ident" id="5580916">sp</span><span class="op" id="5580918">)</span><span class="op" id="5580919">.</span><span class="ident" id="5580920">X</span>&nbsp;<span class="op" id="5580922">+=</span>&nbsp;<span class="ident" id="5580925">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580929">(</span><span class="op" id="5580930">*</span><span class="ident" id="5580931">sp</span><span class="op" id="5580933">)</span><span class="op" id="5580934">.</span><span class="ident" id="5580935">Y</span>&nbsp;<span class="op" id="5580937">+=</span>&nbsp;<span class="ident" id="5580940">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580944">(</span><span class="op" id="5580945">*</span><span class="ident" id="5580946">mp</span><span class="op" id="5580948">)</span><span class="op" id="5580949">.</span><span class="ident" id="5580950">X</span>&nbsp;<span class="op" id="5580952">+=</span>&nbsp;<span class="ident" id="5580955">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5580959">(</span><span class="op" id="5580960">*</span><span class="ident" id="5580961">mp</span><span class="op" id="5580963">)</span><span class="op" id="5580964">.</span><span class="ident" id="5580965">Y</span>&nbsp;<span class="op" id="5580967">+=</span>&nbsp;<span class="ident" id="5580970">dy</span><br>
<span class="lineno"></span><span class="op" id="5580973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5580976">func</span>&nbsp;<span class="ident" id="5580981">processBackward</span><span class="op" id="5580996">(</span><span class="ident" id="5580997">dst</span>&nbsp;<span class="ident" id="5581001">Image</span><span class="op" id="5581006">,</span>&nbsp;<span class="ident" id="5581008">r</span>&nbsp;<span class="ident" id="5581010">image</span><span class="op" id="5581015">.</span><span class="ident" id="5581016">Rectangle</span><span class="op" id="5581025">,</span>&nbsp;<span class="ident" id="5581027">src</span>&nbsp;<span class="ident" id="5581031">image</span><span class="op" id="5581036">.</span><span class="ident" id="5581037">Image</span><span class="op" id="5581042">,</span>&nbsp;<span class="ident" id="5581044">sp</span>&nbsp;<span class="ident" id="5581047">image</span><span class="op" id="5581052">.</span><span class="ident" id="5581053">Point</span><span class="op" id="5581058">)</span>&nbsp;<span class="builtintype" id="5581060">bool</span>&nbsp;<span class="op" id="5581065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581068">return</span>&nbsp;<span class="ident" id="5581075">image</span><span class="op" id="5581080">.</span><span class="ident" id="5581081">Image</span><span class="op" id="5581086">(</span><span class="ident" id="5581087">dst</span><span class="op" id="5581090">)</span>&nbsp;<span class="op" id="5581092">==</span>&nbsp;<span class="ident" id="5581095">src</span>&nbsp;<span class="op" id="5581099">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581104">r</span><span class="op" id="5581105">.</span><span class="ident" id="5581106">Overlaps</span><span class="op" id="5581114">(</span><span class="ident" id="5581115">r</span><span class="op" id="5581116">.</span><span class="ident" id="5581117">Add</span><span class="op" id="5581120">(</span><span class="ident" id="5581121">sp</span><span class="op" id="5581123">.</span><span class="ident" id="5581124">Sub</span><span class="op" id="5581127">(</span><span class="ident" id="5581128">r</span><span class="op" id="5581129">.</span><span class="ident" id="5581130">Min</span><span class="op" id="5581133">)</span><span class="op" id="5581134">)</span><span class="op" id="5581135">)</span>&nbsp;<span class="op" id="5581137">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581142">(</span><span class="ident" id="5581143">sp</span><span class="op" id="5581145">.</span><span class="ident" id="5581146">Y</span>&nbsp;<span class="op" id="5581148">&lt;</span>&nbsp;<span class="ident" id="5581150">r</span><span class="op" id="5581151">.</span><span class="ident" id="5581152">Min</span><span class="op" id="5581155">.</span><span class="ident" id="5581156">Y</span>&nbsp;<span class="op" id="5581158">||</span>&nbsp;<span class="op" id="5581161">(</span><span class="ident" id="5581162">sp</span><span class="op" id="5581164">.</span><span class="ident" id="5581165">Y</span>&nbsp;<span class="op" id="5581167">==</span>&nbsp;<span class="ident" id="5581170">r</span><span class="op" id="5581171">.</span><span class="ident" id="5581172">Min</span><span class="op" id="5581175">.</span><span class="ident" id="5581176">Y</span>&nbsp;<span class="op" id="5581178">&amp;&amp;</span>&nbsp;<span class="ident" id="5581181">sp</span><span class="op" id="5581183">.</span><span class="ident" id="5581184">X</span>&nbsp;<span class="op" id="5581186">&lt;</span>&nbsp;<span class="ident" id="5581188">r</span><span class="op" id="5581189">.</span><span class="ident" id="5581190">Min</span><span class="op" id="5581193">.</span><span class="ident" id="5581194">X</span><span class="op" id="5581195">)</span><span class="op" id="5581196">)</span><br>
<span class="lineno"></span><span class="op" id="5581198">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5581201">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5581241">func</span>&nbsp;<span class="ident" id="5581246">Draw</span><span class="op" id="5581250">(</span><span class="ident" id="5581251">dst</span>&nbsp;<span class="ident" id="5581255">Image</span><span class="op" id="5581260">,</span>&nbsp;<span class="ident" id="5581262">r</span>&nbsp;<span class="ident" id="5581264">image</span><span class="op" id="5581269">.</span><span class="ident" id="5581270">Rectangle</span><span class="op" id="5581279">,</span>&nbsp;<span class="ident" id="5581281">src</span>&nbsp;<span class="ident" id="5581285">image</span><span class="op" id="5581290">.</span><span class="ident" id="5581291">Image</span><span class="op" id="5581296">,</span>&nbsp;<span class="ident" id="5581298">sp</span>&nbsp;<span class="ident" id="5581301">image</span><span class="op" id="5581306">.</span><span class="ident" id="5581307">Point</span><span class="op" id="5581312">,</span>&nbsp;<span class="ident" id="5581314">op</span>&nbsp;<span class="ident" id="5581317">Op</span><span class="op" id="5581319">)</span>&nbsp;<span class="op" id="5581321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581324">DrawMask</span><span class="op" id="5581332">(</span><span class="ident" id="5581333">dst</span><span class="op" id="5581336">,</span>&nbsp;<span class="ident" id="5581338">r</span><span class="op" id="5581339">,</span>&nbsp;<span class="ident" id="5581341">src</span><span class="op" id="5581344">,</span>&nbsp;<span class="ident" id="5581346">sp</span><span class="op" id="5581348">,</span>&nbsp;<span class="ident" id="5581350">nil</span><span class="op" id="5581353">,</span>&nbsp;<span class="ident" id="5581355">image</span><span class="op" id="5581360">.</span><span class="ident" id="5581361">Point</span><span class="op" id="5581366">{</span><span class="op" id="5581367">}</span><span class="op" id="5581368">,</span>&nbsp;<span class="ident" id="5581370">op</span><span class="op" id="5581372">)</span><br>
<span class="lineno"></span><span class="op" id="5581374">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5581377">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5581473">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5581562">func</span>&nbsp;<span class="ident" id="5581567">DrawMask</span><span class="op" id="5581575">(</span><span class="ident" id="5581576">dst</span>&nbsp;<span class="ident" id="5581580">Image</span><span class="op" id="5581585">,</span>&nbsp;<span class="ident" id="5581587">r</span>&nbsp;<span class="ident" id="5581589">image</span><span class="op" id="5581594">.</span><span class="ident" id="5581595">Rectangle</span><span class="op" id="5581604">,</span>&nbsp;<span class="ident" id="5581606">src</span>&nbsp;<span class="ident" id="5581610">image</span><span class="op" id="5581615">.</span><span class="ident" id="5581616">Image</span><span class="op" id="5581621">,</span>&nbsp;<span class="ident" id="5581623">sp</span>&nbsp;<span class="ident" id="5581626">image</span><span class="op" id="5581631">.</span><span class="ident" id="5581632">Point</span><span class="op" id="5581637">,</span>&nbsp;<span class="ident" id="5581639">mask</span>&nbsp;<span class="ident" id="5581644">image</span><span class="op" id="5581649">.</span><span class="ident" id="5581650">Image</span><span class="op" id="5581655">,</span>&nbsp;<span class="ident" id="5581657">mp</span>&nbsp;<span class="ident" id="5581660">image</span><span class="op" id="5581665">.</span><span class="ident" id="5581666">Point</span><span class="op" id="5581671">,</span>&nbsp;<span class="ident" id="5581673">op</span>&nbsp;<span class="ident" id="5581676">Op</span><span class="op" id="5581678">)</span>&nbsp;<span class="op" id="5581680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5581683">clip</span><span class="op" id="5581687">(</span><span class="ident" id="5581688">dst</span><span class="op" id="5581691">,</span>&nbsp;<span class="op" id="5581693">&amp;</span><span class="ident" id="5581694">r</span><span class="op" id="5581695">,</span>&nbsp;<span class="ident" id="5581697">src</span><span class="op" id="5581700">,</span>&nbsp;<span class="op" id="5581702">&amp;</span><span class="ident" id="5581703">sp</span><span class="op" id="5581705">,</span>&nbsp;<span class="ident" id="5581707">mask</span><span class="op" id="5581711">,</span>&nbsp;<span class="op" id="5581713">&amp;</span><span class="ident" id="5581714">mp</span><span class="op" id="5581716">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581719">if</span>&nbsp;<span class="ident" id="5581722">r</span><span class="op" id="5581723">.</span><span class="ident" id="5581724">Empty</span><span class="op" id="5581729">(</span><span class="op" id="5581730">)</span>&nbsp;<span class="op" id="5581732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581736">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5581744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5581748">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581861">switch</span>&nbsp;<span class="ident" id="5581868">dst0</span>&nbsp;<span class="op" id="5581873">:=</span>&nbsp;<span class="ident" id="5581876">dst</span><span class="op" id="5581879">.</span><span class="op" id="5581880">(</span><span class="keyword" id="5581881">type</span><span class="op" id="5581885">)</span>&nbsp;<span class="op" id="5581887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581890">case</span>&nbsp;<span class="op" id="5581895">*</span><span class="ident" id="5581896">image</span><span class="op" id="5581901">.</span><span class="ident" id="5581902">RGBA</span><span class="op" id="5581906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581910">if</span>&nbsp;<span class="ident" id="5581913">op</span>&nbsp;<span class="op" id="5581916">==</span>&nbsp;<span class="ident" id="5581919">Over</span>&nbsp;<span class="op" id="5581924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581929">if</span>&nbsp;<span class="ident" id="5581932">mask</span>&nbsp;<span class="op" id="5581937">==</span>&nbsp;<span class="ident" id="5581940">nil</span>&nbsp;<span class="op" id="5581944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581950">switch</span>&nbsp;<span class="ident" id="5581957">src0</span>&nbsp;<span class="op" id="5581962">:=</span>&nbsp;<span class="ident" id="5581965">src</span><span class="op" id="5581968">.</span><span class="op" id="5581969">(</span><span class="keyword" id="5581970">type</span><span class="op" id="5581974">)</span>&nbsp;<span class="op" id="5581976">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5581982">case</span>&nbsp;<span class="op" id="5581987">*</span><span class="ident" id="5581988">image</span><span class="op" id="5581993">.</span><span class="ident" id="5581994">Uniform</span><span class="op" id="5582001">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582008">drawFillOver</span><span class="op" id="5582020">(</span><span class="ident" id="5582021">dst0</span><span class="op" id="5582025">,</span>&nbsp;<span class="ident" id="5582027">r</span><span class="op" id="5582028">,</span>&nbsp;<span class="ident" id="5582030">src0</span><span class="op" id="5582034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582041">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582052">case</span>&nbsp;<span class="op" id="5582057">*</span><span class="ident" id="5582058">image</span><span class="op" id="5582063">.</span><span class="ident" id="5582064">RGBA</span><span class="op" id="5582068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582075">drawCopyOver</span><span class="op" id="5582087">(</span><span class="ident" id="5582088">dst0</span><span class="op" id="5582092">,</span>&nbsp;<span class="ident" id="5582094">r</span><span class="op" id="5582095">,</span>&nbsp;<span class="ident" id="5582097">src0</span><span class="op" id="5582101">,</span>&nbsp;<span class="ident" id="5582103">sp</span><span class="op" id="5582105">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582112">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582123">case</span>&nbsp;<span class="op" id="5582128">*</span><span class="ident" id="5582129">image</span><span class="op" id="5582134">.</span><span class="ident" id="5582135">NRGBA</span><span class="op" id="5582140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582147">drawNRGBAOver</span><span class="op" id="5582160">(</span><span class="ident" id="5582161">dst0</span><span class="op" id="5582165">,</span>&nbsp;<span class="ident" id="5582167">r</span><span class="op" id="5582168">,</span>&nbsp;<span class="ident" id="5582170">src0</span><span class="op" id="5582174">,</span>&nbsp;<span class="ident" id="5582176">sp</span><span class="op" id="5582178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582185">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582196">case</span>&nbsp;<span class="op" id="5582201">*</span><span class="ident" id="5582202">image</span><span class="op" id="5582207">.</span><span class="ident" id="5582208">YCbCr</span><span class="op" id="5582213">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582220">if</span>&nbsp;<span class="ident" id="5582223">drawYCbCr</span><span class="op" id="5582232">(</span><span class="ident" id="5582233">dst0</span><span class="op" id="5582237">,</span>&nbsp;<span class="ident" id="5582239">r</span><span class="op" id="5582240">,</span>&nbsp;<span class="ident" id="5582242">src0</span><span class="op" id="5582246">,</span>&nbsp;<span class="ident" id="5582248">sp</span><span class="op" id="5582250">)</span>&nbsp;<span class="op" id="5582252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582260">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582283">}</span>&nbsp;<span class="keyword" id="5582285">else</span>&nbsp;<span class="keyword" id="5582290">if</span>&nbsp;<span class="ident" id="5582293">mask0</span><span class="op" id="5582298">,</span>&nbsp;<span class="ident" id="5582300">ok</span>&nbsp;<span class="op" id="5582303">:=</span>&nbsp;<span class="ident" id="5582306">mask</span><span class="op" id="5582310">.</span><span class="op" id="5582311">(</span><span class="op" id="5582312">*</span><span class="ident" id="5582313">image</span><span class="op" id="5582318">.</span><span class="ident" id="5582319">Alpha</span><span class="op" id="5582324">)</span><span class="op" id="5582325">;</span>&nbsp;<span class="ident" id="5582327">ok</span>&nbsp;<span class="op" id="5582330">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582336">switch</span>&nbsp;<span class="ident" id="5582343">src0</span>&nbsp;<span class="op" id="5582348">:=</span>&nbsp;<span class="ident" id="5582351">src</span><span class="op" id="5582354">.</span><span class="op" id="5582355">(</span><span class="keyword" id="5582356">type</span><span class="op" id="5582360">)</span>&nbsp;<span class="op" id="5582362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582368">case</span>&nbsp;<span class="op" id="5582373">*</span><span class="ident" id="5582374">image</span><span class="op" id="5582379">.</span><span class="ident" id="5582380">Uniform</span><span class="op" id="5582387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582394">drawGlyphOver</span><span class="op" id="5582407">(</span><span class="ident" id="5582408">dst0</span><span class="op" id="5582412">,</span>&nbsp;<span class="ident" id="5582414">r</span><span class="op" id="5582415">,</span>&nbsp;<span class="ident" id="5582417">src0</span><span class="op" id="5582421">,</span>&nbsp;<span class="ident" id="5582423">mask0</span><span class="op" id="5582428">,</span>&nbsp;<span class="ident" id="5582430">mp</span><span class="op" id="5582432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582439">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582450">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582459">}</span>&nbsp;<span class="keyword" id="5582461">else</span>&nbsp;<span class="op" id="5582466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582471">if</span>&nbsp;<span class="ident" id="5582474">mask</span>&nbsp;<span class="op" id="5582479">==</span>&nbsp;<span class="ident" id="5582482">nil</span>&nbsp;<span class="op" id="5582486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582492">switch</span>&nbsp;<span class="ident" id="5582499">src0</span>&nbsp;<span class="op" id="5582504">:=</span>&nbsp;<span class="ident" id="5582507">src</span><span class="op" id="5582510">.</span><span class="op" id="5582511">(</span><span class="keyword" id="5582512">type</span><span class="op" id="5582516">)</span>&nbsp;<span class="op" id="5582518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582524">case</span>&nbsp;<span class="op" id="5582529">*</span><span class="ident" id="5582530">image</span><span class="op" id="5582535">.</span><span class="ident" id="5582536">Uniform</span><span class="op" id="5582543">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582550">drawFillSrc</span><span class="op" id="5582561">(</span><span class="ident" id="5582562">dst0</span><span class="op" id="5582566">,</span>&nbsp;<span class="ident" id="5582568">r</span><span class="op" id="5582569">,</span>&nbsp;<span class="ident" id="5582571">src0</span><span class="op" id="5582575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582593">case</span>&nbsp;<span class="op" id="5582598">*</span><span class="ident" id="5582599">image</span><span class="op" id="5582604">.</span><span class="ident" id="5582605">RGBA</span><span class="op" id="5582609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582616">drawCopySrc</span><span class="op" id="5582627">(</span><span class="ident" id="5582628">dst0</span><span class="op" id="5582632">,</span>&nbsp;<span class="ident" id="5582634">r</span><span class="op" id="5582635">,</span>&nbsp;<span class="ident" id="5582637">src0</span><span class="op" id="5582641">,</span>&nbsp;<span class="ident" id="5582643">sp</span><span class="op" id="5582645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582652">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582663">case</span>&nbsp;<span class="op" id="5582668">*</span><span class="ident" id="5582669">image</span><span class="op" id="5582674">.</span><span class="ident" id="5582675">NRGBA</span><span class="op" id="5582680">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582687">drawNRGBASrc</span><span class="op" id="5582699">(</span><span class="ident" id="5582700">dst0</span><span class="op" id="5582704">,</span>&nbsp;<span class="ident" id="5582706">r</span><span class="op" id="5582707">,</span>&nbsp;<span class="ident" id="5582709">src0</span><span class="op" id="5582713">,</span>&nbsp;<span class="ident" id="5582715">sp</span><span class="op" id="5582717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582724">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582735">case</span>&nbsp;<span class="op" id="5582740">*</span><span class="ident" id="5582741">image</span><span class="op" id="5582746">.</span><span class="ident" id="5582747">YCbCr</span><span class="op" id="5582752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582759">if</span>&nbsp;<span class="ident" id="5582762">drawYCbCr</span><span class="op" id="5582771">(</span><span class="ident" id="5582772">dst0</span><span class="op" id="5582776">,</span>&nbsp;<span class="ident" id="5582778">r</span><span class="op" id="5582779">,</span>&nbsp;<span class="ident" id="5582781">src0</span><span class="op" id="5582785">,</span>&nbsp;<span class="ident" id="5582787">sp</span><span class="op" id="5582789">)</span>&nbsp;<span class="op" id="5582791">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582799">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5582826">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582830">drawRGBA</span><span class="op" id="5582838">(</span><span class="ident" id="5582839">dst0</span><span class="op" id="5582843">,</span>&nbsp;<span class="ident" id="5582845">r</span><span class="op" id="5582846">,</span>&nbsp;<span class="ident" id="5582848">src</span><span class="op" id="5582851">,</span>&nbsp;<span class="ident" id="5582853">sp</span><span class="op" id="5582855">,</span>&nbsp;<span class="ident" id="5582857">mask</span><span class="op" id="5582861">,</span>&nbsp;<span class="ident" id="5582863">mp</span><span class="op" id="5582865">,</span>&nbsp;<span class="ident" id="5582867">op</span><span class="op" id="5582869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582873">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582881">case</span>&nbsp;<span class="op" id="5582886">*</span><span class="ident" id="5582887">image</span><span class="op" id="5582892">.</span><span class="ident" id="5582893">Paletted</span><span class="op" id="5582901">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5582905">if</span>&nbsp;<span class="ident" id="5582908">op</span>&nbsp;<span class="op" id="5582911">==</span>&nbsp;<span class="ident" id="5582914">Src</span>&nbsp;<span class="op" id="5582918">&amp;&amp;</span>&nbsp;<span class="ident" id="5582921">mask</span>&nbsp;<span class="op" id="5582926">==</span>&nbsp;<span class="ident" id="5582929">nil</span>&nbsp;<span class="op" id="5582933">&amp;&amp;</span>&nbsp;<span class="op" id="5582936">!</span><span class="ident" id="5582937">processBackward</span><span class="op" id="5582952">(</span><span class="ident" id="5582953">dst</span><span class="op" id="5582956">,</span>&nbsp;<span class="ident" id="5582958">r</span><span class="op" id="5582959">,</span>&nbsp;<span class="ident" id="5582961">src</span><span class="op" id="5582964">,</span>&nbsp;<span class="ident" id="5582966">sp</span><span class="op" id="5582968">)</span>&nbsp;<span class="op" id="5582970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5582975">drawPaletted</span><span class="op" id="5582987">(</span><span class="ident" id="5582988">dst0</span><span class="op" id="5582992">,</span>&nbsp;<span class="ident" id="5582994">r</span><span class="op" id="5582995">,</span>&nbsp;<span class="ident" id="5582997">src</span><span class="op" id="5583000">,</span>&nbsp;<span class="ident" id="5583002">sp</span><span class="op" id="5583004">,</span>&nbsp;<span class="ident" id="5583006">false</span><span class="op" id="5583011">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583022">x0</span><span class="op" id="5583024">,</span>&nbsp;<span class="ident" id="5583026">x1</span><span class="op" id="5583028">,</span>&nbsp;<span class="ident" id="5583030">dx</span>&nbsp;<span class="op" id="5583033">:=</span>&nbsp;<span class="ident" id="5583036">r</span><span class="op" id="5583037">.</span><span class="ident" id="5583038">Min</span><span class="op" id="5583041">.</span><span class="ident" id="5583042">X</span><span class="op" id="5583043">,</span>&nbsp;<span class="ident" id="5583045">r</span><span class="op" id="5583046">.</span><span class="ident" id="5583047">Max</span><span class="op" id="5583050">.</span><span class="ident" id="5583051">X</span><span class="op" id="5583052">,</span>&nbsp;<span class="num" id="5583054">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583057">y0</span><span class="op" id="5583059">,</span>&nbsp;<span class="ident" id="5583061">y1</span><span class="op" id="5583063">,</span>&nbsp;<span class="ident" id="5583065">dy</span>&nbsp;<span class="op" id="5583068">:=</span>&nbsp;<span class="ident" id="5583071">r</span><span class="op" id="5583072">.</span><span class="ident" id="5583073">Min</span><span class="op" id="5583076">.</span><span class="ident" id="5583077">Y</span><span class="op" id="5583078">,</span>&nbsp;<span class="ident" id="5583080">r</span><span class="op" id="5583081">.</span><span class="ident" id="5583082">Max</span><span class="op" id="5583085">.</span><span class="ident" id="5583086">Y</span><span class="op" id="5583087">,</span>&nbsp;<span class="num" id="5583089">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583092">if</span>&nbsp;<span class="ident" id="5583095">processBackward</span><span class="op" id="5583110">(</span><span class="ident" id="5583111">dst</span><span class="op" id="5583114">,</span>&nbsp;<span class="ident" id="5583116">r</span><span class="op" id="5583117">,</span>&nbsp;<span class="ident" id="5583119">src</span><span class="op" id="5583122">,</span>&nbsp;<span class="ident" id="5583124">sp</span><span class="op" id="5583126">)</span>&nbsp;<span class="op" id="5583128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583132">x0</span><span class="op" id="5583134">,</span>&nbsp;<span class="ident" id="5583136">x1</span><span class="op" id="5583138">,</span>&nbsp;<span class="ident" id="5583140">dx</span>&nbsp;<span class="op" id="5583143">=</span>&nbsp;<span class="ident" id="5583145">x1</span><span class="op" id="5583147">-</span><span class="num" id="5583148">1</span><span class="op" id="5583149">,</span>&nbsp;<span class="ident" id="5583151">x0</span><span class="op" id="5583153">-</span><span class="num" id="5583154">1</span><span class="op" id="5583155">,</span>&nbsp;<span class="op" id="5583157">-</span><span class="num" id="5583158">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583162">y0</span><span class="op" id="5583164">,</span>&nbsp;<span class="ident" id="5583166">y1</span><span class="op" id="5583168">,</span>&nbsp;<span class="ident" id="5583170">dy</span>&nbsp;<span class="op" id="5583173">=</span>&nbsp;<span class="ident" id="5583175">y1</span><span class="op" id="5583177">-</span><span class="num" id="5583178">1</span><span class="op" id="5583179">,</span>&nbsp;<span class="ident" id="5583181">y0</span><span class="op" id="5583183">-</span><span class="num" id="5583184">1</span><span class="op" id="5583185">,</span>&nbsp;<span class="op" id="5583187">-</span><span class="num" id="5583188">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583195">var</span>&nbsp;<span class="ident" id="5583199">out</span>&nbsp;<span class="ident" id="5583203">color</span><span class="op" id="5583208">.</span><span class="ident" id="5583209">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583217">sy</span>&nbsp;<span class="op" id="5583220">:=</span>&nbsp;<span class="ident" id="5583223">sp</span><span class="op" id="5583225">.</span><span class="ident" id="5583226">Y</span>&nbsp;<span class="op" id="5583228">+</span>&nbsp;<span class="ident" id="5583230">y0</span>&nbsp;<span class="op" id="5583233">-</span>&nbsp;<span class="ident" id="5583235">r</span><span class="op" id="5583236">.</span><span class="ident" id="5583237">Min</span><span class="op" id="5583240">.</span><span class="ident" id="5583241">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583244">my</span>&nbsp;<span class="op" id="5583247">:=</span>&nbsp;<span class="ident" id="5583250">mp</span><span class="op" id="5583252">.</span><span class="ident" id="5583253">Y</span>&nbsp;<span class="op" id="5583255">+</span>&nbsp;<span class="ident" id="5583257">y0</span>&nbsp;<span class="op" id="5583260">-</span>&nbsp;<span class="ident" id="5583262">r</span><span class="op" id="5583263">.</span><span class="ident" id="5583264">Min</span><span class="op" id="5583267">.</span><span class="ident" id="5583268">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583271">for</span>&nbsp;<span class="ident" id="5583275">y</span>&nbsp;<span class="op" id="5583277">:=</span>&nbsp;<span class="ident" id="5583280">y0</span><span class="op" id="5583282">;</span>&nbsp;<span class="ident" id="5583284">y</span>&nbsp;<span class="op" id="5583286">!=</span>&nbsp;<span class="ident" id="5583289">y1</span><span class="op" id="5583291">;</span>&nbsp;<span class="ident" id="5583293">y</span><span class="op" id="5583294">,</span>&nbsp;<span class="ident" id="5583296">sy</span><span class="op" id="5583298">,</span>&nbsp;<span class="ident" id="5583300">my</span>&nbsp;<span class="op" id="5583303">=</span>&nbsp;<span class="ident" id="5583305">y</span><span class="op" id="5583306">+</span><span class="ident" id="5583307">dy</span><span class="op" id="5583309">,</span>&nbsp;<span class="ident" id="5583311">sy</span><span class="op" id="5583313">+</span><span class="ident" id="5583314">dy</span><span class="op" id="5583316">,</span>&nbsp;<span class="ident" id="5583318">my</span><span class="op" id="5583320">+</span><span class="ident" id="5583321">dy</span>&nbsp;<span class="op" id="5583324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583328">sx</span>&nbsp;<span class="op" id="5583331">:=</span>&nbsp;<span class="ident" id="5583334">sp</span><span class="op" id="5583336">.</span><span class="ident" id="5583337">X</span>&nbsp;<span class="op" id="5583339">+</span>&nbsp;<span class="ident" id="5583341">x0</span>&nbsp;<span class="op" id="5583344">-</span>&nbsp;<span class="ident" id="5583346">r</span><span class="op" id="5583347">.</span><span class="ident" id="5583348">Min</span><span class="op" id="5583351">.</span><span class="ident" id="5583352">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583356">mx</span>&nbsp;<span class="op" id="5583359">:=</span>&nbsp;<span class="ident" id="5583362">mp</span><span class="op" id="5583364">.</span><span class="ident" id="5583365">X</span>&nbsp;<span class="op" id="5583367">+</span>&nbsp;<span class="ident" id="5583369">x0</span>&nbsp;<span class="op" id="5583372">-</span>&nbsp;<span class="ident" id="5583374">r</span><span class="op" id="5583375">.</span><span class="ident" id="5583376">Min</span><span class="op" id="5583379">.</span><span class="ident" id="5583380">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583384">for</span>&nbsp;<span class="ident" id="5583388">x</span>&nbsp;<span class="op" id="5583390">:=</span>&nbsp;<span class="ident" id="5583393">x0</span><span class="op" id="5583395">;</span>&nbsp;<span class="ident" id="5583397">x</span>&nbsp;<span class="op" id="5583399">!=</span>&nbsp;<span class="ident" id="5583402">x1</span><span class="op" id="5583404">;</span>&nbsp;<span class="ident" id="5583406">x</span><span class="op" id="5583407">,</span>&nbsp;<span class="ident" id="5583409">sx</span><span class="op" id="5583411">,</span>&nbsp;<span class="ident" id="5583413">mx</span>&nbsp;<span class="op" id="5583416">=</span>&nbsp;<span class="ident" id="5583418">x</span><span class="op" id="5583419">+</span><span class="ident" id="5583420">dx</span><span class="op" id="5583422">,</span>&nbsp;<span class="ident" id="5583424">sx</span><span class="op" id="5583426">+</span><span class="ident" id="5583427">dx</span><span class="op" id="5583429">,</span>&nbsp;<span class="ident" id="5583431">mx</span><span class="op" id="5583433">+</span><span class="ident" id="5583434">dx</span>&nbsp;<span class="op" id="5583437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583442">ma</span>&nbsp;<span class="op" id="5583445">:=</span>&nbsp;<span class="builtintype" id="5583448">uint32</span><span class="op" id="5583454">(</span><span class="ident" id="5583455">m</span><span class="op" id="5583456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583461">if</span>&nbsp;<span class="ident" id="5583464">mask</span>&nbsp;<span class="op" id="5583469">!=</span>&nbsp;<span class="ident" id="5583472">nil</span>&nbsp;<span class="op" id="5583476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583482">_</span><span class="op" id="5583483">,</span>&nbsp;<span class="ident" id="5583485">_</span><span class="op" id="5583486">,</span>&nbsp;<span class="ident" id="5583488">_</span><span class="op" id="5583489">,</span>&nbsp;<span class="ident" id="5583491">ma</span>&nbsp;<span class="op" id="5583494">=</span>&nbsp;<span class="ident" id="5583496">mask</span><span class="op" id="5583500">.</span><span class="ident" id="5583501">At</span><span class="op" id="5583503">(</span><span class="ident" id="5583504">mx</span><span class="op" id="5583506">,</span>&nbsp;<span class="ident" id="5583508">my</span><span class="op" id="5583510">)</span><span class="op" id="5583511">.</span><span class="ident" id="5583512">RGBA</span><span class="op" id="5583516">(</span><span class="op" id="5583517">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583527">switch</span>&nbsp;<span class="op" id="5583534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583539">case</span>&nbsp;<span class="ident" id="5583544">ma</span>&nbsp;<span class="op" id="5583547">==</span>&nbsp;<span class="num" id="5583550">0</span><span class="op" id="5583551">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583557">if</span>&nbsp;<span class="ident" id="5583560">op</span>&nbsp;<span class="op" id="5583563">==</span>&nbsp;<span class="ident" id="5583566">Over</span>&nbsp;<span class="op" id="5583571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5583578">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583592">}</span>&nbsp;<span class="keyword" id="5583594">else</span>&nbsp;<span class="op" id="5583599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583606">dst</span><span class="op" id="5583609">.</span><span class="ident" id="5583610">Set</span><span class="op" id="5583613">(</span><span class="ident" id="5583614">x</span><span class="op" id="5583615">,</span>&nbsp;<span class="ident" id="5583617">y</span><span class="op" id="5583618">,</span>&nbsp;<span class="ident" id="5583620">color</span><span class="op" id="5583625">.</span><span class="ident" id="5583626">Transparent</span><span class="op" id="5583637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5583643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583648">case</span>&nbsp;<span class="ident" id="5583653">ma</span>&nbsp;<span class="op" id="5583656">==</span>&nbsp;<span class="ident" id="5583659">m</span>&nbsp;<span class="op" id="5583661">&amp;&amp;</span>&nbsp;<span class="ident" id="5583664">op</span>&nbsp;<span class="op" id="5583667">==</span>&nbsp;<span class="ident" id="5583670">Src</span><span class="op" id="5583673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583679">dst</span><span class="op" id="5583682">.</span><span class="ident" id="5583683">Set</span><span class="op" id="5583686">(</span><span class="ident" id="5583687">x</span><span class="op" id="5583688">,</span>&nbsp;<span class="ident" id="5583690">y</span><span class="op" id="5583691">,</span>&nbsp;<span class="ident" id="5583693">src</span><span class="op" id="5583696">.</span><span class="ident" id="5583697">At</span><span class="op" id="5583699">(</span><span class="ident" id="5583700">sx</span><span class="op" id="5583702">,</span>&nbsp;<span class="ident" id="5583704">sy</span><span class="op" id="5583706">)</span><span class="op" id="5583707">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583712">default</span><span class="op" id="5583719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583725">sr</span><span class="op" id="5583727">,</span>&nbsp;<span class="ident" id="5583729">sg</span><span class="op" id="5583731">,</span>&nbsp;<span class="ident" id="5583733">sb</span><span class="op" id="5583735">,</span>&nbsp;<span class="ident" id="5583737">sa</span>&nbsp;<span class="op" id="5583740">:=</span>&nbsp;<span class="ident" id="5583743">src</span><span class="op" id="5583746">.</span><span class="ident" id="5583747">At</span><span class="op" id="5583749">(</span><span class="ident" id="5583750">sx</span><span class="op" id="5583752">,</span>&nbsp;<span class="ident" id="5583754">sy</span><span class="op" id="5583756">)</span><span class="op" id="5583757">.</span><span class="ident" id="5583758">RGBA</span><span class="op" id="5583762">(</span><span class="op" id="5583763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5583769">if</span>&nbsp;<span class="ident" id="5583772">op</span>&nbsp;<span class="op" id="5583775">==</span>&nbsp;<span class="ident" id="5583778">Over</span>&nbsp;<span class="op" id="5583783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583790">dr</span><span class="op" id="5583792">,</span>&nbsp;<span class="ident" id="5583794">dg</span><span class="op" id="5583796">,</span>&nbsp;<span class="ident" id="5583798">db</span><span class="op" id="5583800">,</span>&nbsp;<span class="ident" id="5583802">da</span>&nbsp;<span class="op" id="5583805">:=</span>&nbsp;<span class="ident" id="5583808">dst</span><span class="op" id="5583811">.</span><span class="ident" id="5583812">At</span><span class="op" id="5583814">(</span><span class="ident" id="5583815">x</span><span class="op" id="5583816">,</span>&nbsp;<span class="ident" id="5583818">y</span><span class="op" id="5583819">)</span><span class="op" id="5583820">.</span><span class="ident" id="5583821">RGBA</span><span class="op" id="5583825">(</span><span class="op" id="5583826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583833">a</span>&nbsp;<span class="op" id="5583835">:=</span>&nbsp;<span class="ident" id="5583838">m</span>&nbsp;<span class="op" id="5583840">-</span>&nbsp;<span class="op" id="5583842">(</span><span class="ident" id="5583843">sa</span>&nbsp;<span class="op" id="5583846">*</span>&nbsp;<span class="ident" id="5583848">ma</span>&nbsp;<span class="op" id="5583851">/</span>&nbsp;<span class="ident" id="5583853">m</span><span class="op" id="5583854">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583861">out</span><span class="op" id="5583864">.</span><span class="ident" id="5583865">R</span>&nbsp;<span class="op" id="5583867">=</span>&nbsp;<span class="builtintype" id="5583869">uint16</span><span class="op" id="5583875">(</span><span class="op" id="5583876">(</span><span class="ident" id="5583877">dr</span><span class="op" id="5583879">*</span><span class="ident" id="5583880">a</span>&nbsp;<span class="op" id="5583882">+</span>&nbsp;<span class="ident" id="5583884">sr</span><span class="op" id="5583886">*</span><span class="ident" id="5583887">ma</span><span class="op" id="5583889">)</span>&nbsp;<span class="op" id="5583891">/</span>&nbsp;<span class="ident" id="5583893">m</span><span class="op" id="5583894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583901">out</span><span class="op" id="5583904">.</span><span class="ident" id="5583905">G</span>&nbsp;<span class="op" id="5583907">=</span>&nbsp;<span class="builtintype" id="5583909">uint16</span><span class="op" id="5583915">(</span><span class="op" id="5583916">(</span><span class="ident" id="5583917">dg</span><span class="op" id="5583919">*</span><span class="ident" id="5583920">a</span>&nbsp;<span class="op" id="5583922">+</span>&nbsp;<span class="ident" id="5583924">sg</span><span class="op" id="5583926">*</span><span class="ident" id="5583927">ma</span><span class="op" id="5583929">)</span>&nbsp;<span class="op" id="5583931">/</span>&nbsp;<span class="ident" id="5583933">m</span><span class="op" id="5583934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583941">out</span><span class="op" id="5583944">.</span><span class="ident" id="5583945">B</span>&nbsp;<span class="op" id="5583947">=</span>&nbsp;<span class="builtintype" id="5583949">uint16</span><span class="op" id="5583955">(</span><span class="op" id="5583956">(</span><span class="ident" id="5583957">db</span><span class="op" id="5583959">*</span><span class="ident" id="5583960">a</span>&nbsp;<span class="op" id="5583962">+</span>&nbsp;<span class="ident" id="5583964">sb</span><span class="op" id="5583966">*</span><span class="ident" id="5583967">ma</span><span class="op" id="5583969">)</span>&nbsp;<span class="op" id="5583971">/</span>&nbsp;<span class="ident" id="5583973">m</span><span class="op" id="5583974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5583981">out</span><span class="op" id="5583984">.</span><span class="ident" id="5583985">A</span>&nbsp;<span class="op" id="5583987">=</span>&nbsp;<span class="builtintype" id="5583989">uint16</span><span class="op" id="5583995">(</span><span class="op" id="5583996">(</span><span class="ident" id="5583997">da</span><span class="op" id="5583999">*</span><span class="ident" id="5584000">a</span>&nbsp;<span class="op" id="5584002">+</span>&nbsp;<span class="ident" id="5584004">sa</span><span class="op" id="5584006">*</span><span class="ident" id="5584007">ma</span><span class="op" id="5584009">)</span>&nbsp;<span class="op" id="5584011">/</span>&nbsp;<span class="ident" id="5584013">m</span><span class="op" id="5584014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584020">}</span>&nbsp;<span class="keyword" id="5584022">else</span>&nbsp;<span class="op" id="5584027">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584034">out</span><span class="op" id="5584037">.</span><span class="ident" id="5584038">R</span>&nbsp;<span class="op" id="5584040">=</span>&nbsp;<span class="builtintype" id="5584042">uint16</span><span class="op" id="5584048">(</span><span class="ident" id="5584049">sr</span>&nbsp;<span class="op" id="5584052">*</span>&nbsp;<span class="ident" id="5584054">ma</span>&nbsp;<span class="op" id="5584057">/</span>&nbsp;<span class="ident" id="5584059">m</span><span class="op" id="5584060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584067">out</span><span class="op" id="5584070">.</span><span class="ident" id="5584071">G</span>&nbsp;<span class="op" id="5584073">=</span>&nbsp;<span class="builtintype" id="5584075">uint16</span><span class="op" id="5584081">(</span><span class="ident" id="5584082">sg</span>&nbsp;<span class="op" id="5584085">*</span>&nbsp;<span class="ident" id="5584087">ma</span>&nbsp;<span class="op" id="5584090">/</span>&nbsp;<span class="ident" id="5584092">m</span><span class="op" id="5584093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584100">out</span><span class="op" id="5584103">.</span><span class="ident" id="5584104">B</span>&nbsp;<span class="op" id="5584106">=</span>&nbsp;<span class="builtintype" id="5584108">uint16</span><span class="op" id="5584114">(</span><span class="ident" id="5584115">sb</span>&nbsp;<span class="op" id="5584118">*</span>&nbsp;<span class="ident" id="5584120">ma</span>&nbsp;<span class="op" id="5584123">/</span>&nbsp;<span class="ident" id="5584125">m</span><span class="op" id="5584126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584133">out</span><span class="op" id="5584136">.</span><span class="ident" id="5584137">A</span>&nbsp;<span class="op" id="5584139">=</span>&nbsp;<span class="builtintype" id="5584141">uint16</span><span class="op" id="5584147">(</span><span class="ident" id="5584148">sa</span>&nbsp;<span class="op" id="5584151">*</span>&nbsp;<span class="ident" id="5584153">ma</span>&nbsp;<span class="op" id="5584156">/</span>&nbsp;<span class="ident" id="5584158">m</span><span class="op" id="5584159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584165">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584171">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584232">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584297">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584360">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584421">dst</span><span class="op" id="5584424">.</span><span class="ident" id="5584425">Set</span><span class="op" id="5584428">(</span><span class="ident" id="5584429">x</span><span class="op" id="5584430">,</span>&nbsp;<span class="ident" id="5584432">y</span><span class="op" id="5584433">,</span>&nbsp;<span class="op" id="5584435">&amp;</span><span class="ident" id="5584436">out</span><span class="op" id="5584439">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5584451">}</span><br>
<span class="lineno"></span><span class="op" id="5584453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5584456">func</span>&nbsp;<span class="ident" id="5584461">drawFillOver</span><span class="op" id="5584473">(</span><span class="ident" id="5584474">dst</span>&nbsp;<span class="op" id="5584478">*</span><span class="ident" id="5584479">image</span><span class="op" id="5584484">.</span><span class="ident" id="5584485">RGBA</span><span class="op" id="5584489">,</span>&nbsp;<span class="ident" id="5584491">r</span>&nbsp;<span class="ident" id="5584493">image</span><span class="op" id="5584498">.</span><span class="ident" id="5584499">Rectangle</span><span class="op" id="5584508">,</span>&nbsp;<span class="ident" id="5584510">src</span>&nbsp;<span class="op" id="5584514">*</span><span class="ident" id="5584515">image</span><span class="op" id="5584520">.</span><span class="ident" id="5584521">Uniform</span><span class="op" id="5584528">)</span>&nbsp;<span class="op" id="5584530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584533">sr</span><span class="op" id="5584535">,</span>&nbsp;<span class="ident" id="5584537">sg</span><span class="op" id="5584539">,</span>&nbsp;<span class="ident" id="5584541">sb</span><span class="op" id="5584543">,</span>&nbsp;<span class="ident" id="5584545">sa</span>&nbsp;<span class="op" id="5584548">:=</span>&nbsp;<span class="ident" id="5584551">src</span><span class="op" id="5584554">.</span><span class="ident" id="5584555">RGBA</span><span class="op" id="5584559">(</span><span class="op" id="5584560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5584563">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584621">a</span>&nbsp;<span class="op" id="5584623">:=</span>&nbsp;<span class="op" id="5584626">(</span><span class="ident" id="5584627">m</span>&nbsp;<span class="op" id="5584629">-</span>&nbsp;<span class="ident" id="5584631">sa</span><span class="op" id="5584633">)</span>&nbsp;<span class="op" id="5584635">*</span>&nbsp;<span class="num" id="5584637">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584644">i0</span>&nbsp;<span class="op" id="5584647">:=</span>&nbsp;<span class="ident" id="5584650">dst</span><span class="op" id="5584653">.</span><span class="ident" id="5584654">PixOffset</span><span class="op" id="5584663">(</span><span class="ident" id="5584664">r</span><span class="op" id="5584665">.</span><span class="ident" id="5584666">Min</span><span class="op" id="5584669">.</span><span class="ident" id="5584670">X</span><span class="op" id="5584671">,</span>&nbsp;<span class="ident" id="5584673">r</span><span class="op" id="5584674">.</span><span class="ident" id="5584675">Min</span><span class="op" id="5584678">.</span><span class="ident" id="5584679">Y</span><span class="op" id="5584680">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584683">i1</span>&nbsp;<span class="op" id="5584686">:=</span>&nbsp;<span class="ident" id="5584689">i0</span>&nbsp;<span class="op" id="5584692">+</span>&nbsp;<span class="ident" id="5584694">r</span><span class="op" id="5584695">.</span><span class="ident" id="5584696">Dx</span><span class="op" id="5584698">(</span><span class="op" id="5584699">)</span><span class="op" id="5584700">*</span><span class="num" id="5584701">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584704">for</span>&nbsp;<span class="ident" id="5584708">y</span>&nbsp;<span class="op" id="5584710">:=</span>&nbsp;<span class="ident" id="5584713">r</span><span class="op" id="5584714">.</span><span class="ident" id="5584715">Min</span><span class="op" id="5584718">.</span><span class="ident" id="5584719">Y</span><span class="op" id="5584720">;</span>&nbsp;<span class="ident" id="5584722">y</span>&nbsp;<span class="op" id="5584724">!=</span>&nbsp;<span class="ident" id="5584727">r</span><span class="op" id="5584728">.</span><span class="ident" id="5584729">Max</span><span class="op" id="5584732">.</span><span class="ident" id="5584733">Y</span><span class="op" id="5584734">;</span>&nbsp;<span class="ident" id="5584736">y</span><span class="op" id="5584737">++</span>&nbsp;<span class="op" id="5584740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5584744">for</span>&nbsp;<span class="ident" id="5584748">i</span>&nbsp;<span class="op" id="5584750">:=</span>&nbsp;<span class="ident" id="5584753">i0</span><span class="op" id="5584755">;</span>&nbsp;<span class="ident" id="5584757">i</span>&nbsp;<span class="op" id="5584759">&lt;</span>&nbsp;<span class="ident" id="5584761">i1</span><span class="op" id="5584763">;</span>&nbsp;<span class="ident" id="5584765">i</span>&nbsp;<span class="op" id="5584767">+=</span>&nbsp;<span class="num" id="5584770">4</span>&nbsp;<span class="op" id="5584772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584777">dr</span>&nbsp;<span class="op" id="5584780">:=</span>&nbsp;<span class="builtintype" id="5584783">uint32</span><span class="op" id="5584789">(</span><span class="ident" id="5584790">dst</span><span class="op" id="5584793">.</span><span class="ident" id="5584794">Pix</span><span class="op" id="5584797">[</span><span class="ident" id="5584798">i</span><span class="op" id="5584799">+</span><span class="num" id="5584800">0</span><span class="op" id="5584801">]</span><span class="op" id="5584802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584807">dg</span>&nbsp;<span class="op" id="5584810">:=</span>&nbsp;<span class="builtintype" id="5584813">uint32</span><span class="op" id="5584819">(</span><span class="ident" id="5584820">dst</span><span class="op" id="5584823">.</span><span class="ident" id="5584824">Pix</span><span class="op" id="5584827">[</span><span class="ident" id="5584828">i</span><span class="op" id="5584829">+</span><span class="num" id="5584830">1</span><span class="op" id="5584831">]</span><span class="op" id="5584832">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584837">db</span>&nbsp;<span class="op" id="5584840">:=</span>&nbsp;<span class="builtintype" id="5584843">uint32</span><span class="op" id="5584849">(</span><span class="ident" id="5584850">dst</span><span class="op" id="5584853">.</span><span class="ident" id="5584854">Pix</span><span class="op" id="5584857">[</span><span class="ident" id="5584858">i</span><span class="op" id="5584859">+</span><span class="num" id="5584860">2</span><span class="op" id="5584861">]</span><span class="op" id="5584862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584867">da</span>&nbsp;<span class="op" id="5584870">:=</span>&nbsp;<span class="builtintype" id="5584873">uint32</span><span class="op" id="5584879">(</span><span class="ident" id="5584880">dst</span><span class="op" id="5584883">.</span><span class="ident" id="5584884">Pix</span><span class="op" id="5584887">[</span><span class="ident" id="5584888">i</span><span class="op" id="5584889">+</span><span class="num" id="5584890">3</span><span class="op" id="5584891">]</span><span class="op" id="5584892">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584898">dst</span><span class="op" id="5584901">.</span><span class="ident" id="5584902">Pix</span><span class="op" id="5584905">[</span><span class="ident" id="5584906">i</span><span class="op" id="5584907">+</span><span class="num" id="5584908">0</span><span class="op" id="5584909">]</span>&nbsp;<span class="op" id="5584911">=</span>&nbsp;<span class="builtintype" id="5584913">uint8</span><span class="op" id="5584918">(</span><span class="op" id="5584919">(</span><span class="ident" id="5584920">dr</span><span class="op" id="5584922">*</span><span class="ident" id="5584923">a</span><span class="op" id="5584924">/</span><span class="ident" id="5584925">m</span>&nbsp;<span class="op" id="5584927">+</span>&nbsp;<span class="ident" id="5584929">sr</span><span class="op" id="5584931">)</span>&nbsp;<span class="op" id="5584933">&gt;&gt;</span>&nbsp;<span class="num" id="5584936">8</span><span class="op" id="5584937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584942">dst</span><span class="op" id="5584945">.</span><span class="ident" id="5584946">Pix</span><span class="op" id="5584949">[</span><span class="ident" id="5584950">i</span><span class="op" id="5584951">+</span><span class="num" id="5584952">1</span><span class="op" id="5584953">]</span>&nbsp;<span class="op" id="5584955">=</span>&nbsp;<span class="builtintype" id="5584957">uint8</span><span class="op" id="5584962">(</span><span class="op" id="5584963">(</span><span class="ident" id="5584964">dg</span><span class="op" id="5584966">*</span><span class="ident" id="5584967">a</span><span class="op" id="5584968">/</span><span class="ident" id="5584969">m</span>&nbsp;<span class="op" id="5584971">+</span>&nbsp;<span class="ident" id="5584973">sg</span><span class="op" id="5584975">)</span>&nbsp;<span class="op" id="5584977">&gt;&gt;</span>&nbsp;<span class="num" id="5584980">8</span><span class="op" id="5584981">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5584986">dst</span><span class="op" id="5584989">.</span><span class="ident" id="5584990">Pix</span><span class="op" id="5584993">[</span><span class="ident" id="5584994">i</span><span class="op" id="5584995">+</span><span class="num" id="5584996">2</span><span class="op" id="5584997">]</span>&nbsp;<span class="op" id="5584999">=</span>&nbsp;<span class="builtintype" id="5585001">uint8</span><span class="op" id="5585006">(</span><span class="op" id="5585007">(</span><span class="ident" id="5585008">db</span><span class="op" id="5585010">*</span><span class="ident" id="5585011">a</span><span class="op" id="5585012">/</span><span class="ident" id="5585013">m</span>&nbsp;<span class="op" id="5585015">+</span>&nbsp;<span class="ident" id="5585017">sb</span><span class="op" id="5585019">)</span>&nbsp;<span class="op" id="5585021">&gt;&gt;</span>&nbsp;<span class="num" id="5585024">8</span><span class="op" id="5585025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585030">dst</span><span class="op" id="5585033">.</span><span class="ident" id="5585034">Pix</span><span class="op" id="5585037">[</span><span class="ident" id="5585038">i</span><span class="op" id="5585039">+</span><span class="num" id="5585040">3</span><span class="op" id="5585041">]</span>&nbsp;<span class="op" id="5585043">=</span>&nbsp;<span class="builtintype" id="5585045">uint8</span><span class="op" id="5585050">(</span><span class="op" id="5585051">(</span><span class="ident" id="5585052">da</span><span class="op" id="5585054">*</span><span class="ident" id="5585055">a</span><span class="op" id="5585056">/</span><span class="ident" id="5585057">m</span>&nbsp;<span class="op" id="5585059">+</span>&nbsp;<span class="ident" id="5585061">sa</span><span class="op" id="5585063">)</span>&nbsp;<span class="op" id="5585065">&gt;&gt;</span>&nbsp;<span class="num" id="5585068">8</span><span class="op" id="5585069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585077">i0</span>&nbsp;<span class="op" id="5585080">+=</span>&nbsp;<span class="ident" id="5585083">dst</span><span class="op" id="5585086">.</span><span class="ident" id="5585087">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585096">i1</span>&nbsp;<span class="op" id="5585099">+=</span>&nbsp;<span class="ident" id="5585102">dst</span><span class="op" id="5585105">.</span><span class="ident" id="5585106">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585114">}</span><br>
<span class="lineno"></span><span class="op" id="5585116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5585119">func</span>&nbsp;<span class="ident" id="5585124">drawFillSrc</span><span class="op" id="5585135">(</span><span class="ident" id="5585136">dst</span>&nbsp;<span class="op" id="5585140">*</span><span class="ident" id="5585141">image</span><span class="op" id="5585146">.</span><span class="ident" id="5585147">RGBA</span><span class="op" id="5585151">,</span>&nbsp;<span class="ident" id="5585153">r</span>&nbsp;<span class="ident" id="5585155">image</span><span class="op" id="5585160">.</span><span class="ident" id="5585161">Rectangle</span><span class="op" id="5585170">,</span>&nbsp;<span class="ident" id="5585172">src</span>&nbsp;<span class="op" id="5585176">*</span><span class="ident" id="5585177">image</span><span class="op" id="5585182">.</span><span class="ident" id="5585183">Uniform</span><span class="op" id="5585190">)</span>&nbsp;<span class="op" id="5585192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585195">sr</span><span class="op" id="5585197">,</span>&nbsp;<span class="ident" id="5585199">sg</span><span class="op" id="5585201">,</span>&nbsp;<span class="ident" id="5585203">sb</span><span class="op" id="5585205">,</span>&nbsp;<span class="ident" id="5585207">sa</span>&nbsp;<span class="op" id="5585210">:=</span>&nbsp;<span class="ident" id="5585213">src</span><span class="op" id="5585216">.</span><span class="ident" id="5585217">RGBA</span><span class="op" id="5585221">(</span><span class="op" id="5585222">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5585225">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5585327">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5585431">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585502">i0</span>&nbsp;<span class="op" id="5585505">:=</span>&nbsp;<span class="ident" id="5585508">dst</span><span class="op" id="5585511">.</span><span class="ident" id="5585512">PixOffset</span><span class="op" id="5585521">(</span><span class="ident" id="5585522">r</span><span class="op" id="5585523">.</span><span class="ident" id="5585524">Min</span><span class="op" id="5585527">.</span><span class="ident" id="5585528">X</span><span class="op" id="5585529">,</span>&nbsp;<span class="ident" id="5585531">r</span><span class="op" id="5585532">.</span><span class="ident" id="5585533">Min</span><span class="op" id="5585536">.</span><span class="ident" id="5585537">Y</span><span class="op" id="5585538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585541">i1</span>&nbsp;<span class="op" id="5585544">:=</span>&nbsp;<span class="ident" id="5585547">i0</span>&nbsp;<span class="op" id="5585550">+</span>&nbsp;<span class="ident" id="5585552">r</span><span class="op" id="5585553">.</span><span class="ident" id="5585554">Dx</span><span class="op" id="5585556">(</span><span class="op" id="5585557">)</span><span class="op" id="5585558">*</span><span class="num" id="5585559">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585562">for</span>&nbsp;<span class="ident" id="5585566">i</span>&nbsp;<span class="op" id="5585568">:=</span>&nbsp;<span class="ident" id="5585571">i0</span><span class="op" id="5585573">;</span>&nbsp;<span class="ident" id="5585575">i</span>&nbsp;<span class="op" id="5585577">&lt;</span>&nbsp;<span class="ident" id="5585579">i1</span><span class="op" id="5585581">;</span>&nbsp;<span class="ident" id="5585583">i</span>&nbsp;<span class="op" id="5585585">+=</span>&nbsp;<span class="num" id="5585588">4</span>&nbsp;<span class="op" id="5585590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585594">dst</span><span class="op" id="5585597">.</span><span class="ident" id="5585598">Pix</span><span class="op" id="5585601">[</span><span class="ident" id="5585602">i</span><span class="op" id="5585603">+</span><span class="num" id="5585604">0</span><span class="op" id="5585605">]</span>&nbsp;<span class="op" id="5585607">=</span>&nbsp;<span class="builtintype" id="5585609">uint8</span><span class="op" id="5585614">(</span><span class="ident" id="5585615">sr</span>&nbsp;<span class="op" id="5585618">&gt;&gt;</span>&nbsp;<span class="num" id="5585621">8</span><span class="op" id="5585622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585626">dst</span><span class="op" id="5585629">.</span><span class="ident" id="5585630">Pix</span><span class="op" id="5585633">[</span><span class="ident" id="5585634">i</span><span class="op" id="5585635">+</span><span class="num" id="5585636">1</span><span class="op" id="5585637">]</span>&nbsp;<span class="op" id="5585639">=</span>&nbsp;<span class="builtintype" id="5585641">uint8</span><span class="op" id="5585646">(</span><span class="ident" id="5585647">sg</span>&nbsp;<span class="op" id="5585650">&gt;&gt;</span>&nbsp;<span class="num" id="5585653">8</span><span class="op" id="5585654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585658">dst</span><span class="op" id="5585661">.</span><span class="ident" id="5585662">Pix</span><span class="op" id="5585665">[</span><span class="ident" id="5585666">i</span><span class="op" id="5585667">+</span><span class="num" id="5585668">2</span><span class="op" id="5585669">]</span>&nbsp;<span class="op" id="5585671">=</span>&nbsp;<span class="builtintype" id="5585673">uint8</span><span class="op" id="5585678">(</span><span class="ident" id="5585679">sb</span>&nbsp;<span class="op" id="5585682">&gt;&gt;</span>&nbsp;<span class="num" id="5585685">8</span><span class="op" id="5585686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585690">dst</span><span class="op" id="5585693">.</span><span class="ident" id="5585694">Pix</span><span class="op" id="5585697">[</span><span class="ident" id="5585698">i</span><span class="op" id="5585699">+</span><span class="num" id="5585700">3</span><span class="op" id="5585701">]</span>&nbsp;<span class="op" id="5585703">=</span>&nbsp;<span class="builtintype" id="5585705">uint8</span><span class="op" id="5585710">(</span><span class="ident" id="5585711">sa</span>&nbsp;<span class="op" id="5585714">&gt;&gt;</span>&nbsp;<span class="num" id="5585717">8</span><span class="op" id="5585718">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585724">firstRow</span>&nbsp;<span class="op" id="5585733">:=</span>&nbsp;<span class="ident" id="5585736">dst</span><span class="op" id="5585739">.</span><span class="ident" id="5585740">Pix</span><span class="op" id="5585743">[</span><span class="ident" id="5585744">i0</span><span class="op" id="5585746">:</span><span class="ident" id="5585747">i1</span><span class="op" id="5585749">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5585752">for</span>&nbsp;<span class="ident" id="5585756">y</span>&nbsp;<span class="op" id="5585758">:=</span>&nbsp;<span class="ident" id="5585761">r</span><span class="op" id="5585762">.</span><span class="ident" id="5585763">Min</span><span class="op" id="5585766">.</span><span class="ident" id="5585767">Y</span>&nbsp;<span class="op" id="5585769">+</span>&nbsp;<span class="num" id="5585771">1</span><span class="op" id="5585772">;</span>&nbsp;<span class="ident" id="5585774">y</span>&nbsp;<span class="op" id="5585776">&lt;</span>&nbsp;<span class="ident" id="5585778">r</span><span class="op" id="5585779">.</span><span class="ident" id="5585780">Max</span><span class="op" id="5585783">.</span><span class="ident" id="5585784">Y</span><span class="op" id="5585785">;</span>&nbsp;<span class="ident" id="5585787">y</span><span class="op" id="5585788">++</span>&nbsp;<span class="op" id="5585791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585795">i0</span>&nbsp;<span class="op" id="5585798">+=</span>&nbsp;<span class="ident" id="5585801">dst</span><span class="op" id="5585804">.</span><span class="ident" id="5585805">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585814">i1</span>&nbsp;<span class="op" id="5585817">+=</span>&nbsp;<span class="ident" id="5585820">dst</span><span class="op" id="5585823">.</span><span class="ident" id="5585824">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5585833">copy</span><span class="op" id="5585837">(</span><span class="ident" id="5585838">dst</span><span class="op" id="5585841">.</span><span class="ident" id="5585842">Pix</span><span class="op" id="5585845">[</span><span class="ident" id="5585846">i0</span><span class="op" id="5585848">:</span><span class="ident" id="5585849">i1</span><span class="op" id="5585851">]</span><span class="op" id="5585852">,</span>&nbsp;<span class="ident" id="5585854">firstRow</span><span class="op" id="5585862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5585865">}</span><br>
<span class="lineno"></span><span class="op" id="5585867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5585870">func</span>&nbsp;<span class="ident" id="5585875">drawCopyOver</span><span class="op" id="5585887">(</span><span class="ident" id="5585888">dst</span>&nbsp;<span class="op" id="5585892">*</span><span class="ident" id="5585893">image</span><span class="op" id="5585898">.</span><span class="ident" id="5585899">RGBA</span><span class="op" id="5585903">,</span>&nbsp;<span class="ident" id="5585905">r</span>&nbsp;<span class="ident" id="5585907">image</span><span class="op" id="5585912">.</span><span class="ident" id="5585913">Rectangle</span><span class="op" id="5585922">,</span>&nbsp;<span class="ident" id="5585924">src</span>&nbsp;<span class="op" id="5585928">*</span><span class="ident" id="5585929">image</span><span class="op" id="5585934">.</span><span class="ident" id="5585935">RGBA</span><span class="op" id="5585939">,</span>&nbsp;<span class="ident" id="5585941">sp</span>&nbsp;<span class="ident" id="5585944">image</span><span class="op" id="5585949">.</span><span class="ident" id="5585950">Point</span><span class="op" id="5585955">)</span>&nbsp;<span class="op" id="5585957">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585960">dx</span><span class="op" id="5585962">,</span>&nbsp;<span class="ident" id="5585964">dy</span>&nbsp;<span class="op" id="5585967">:=</span>&nbsp;<span class="ident" id="5585970">r</span><span class="op" id="5585971">.</span><span class="ident" id="5585972">Dx</span><span class="op" id="5585974">(</span><span class="op" id="5585975">)</span><span class="op" id="5585976">,</span>&nbsp;<span class="ident" id="5585978">r</span><span class="op" id="5585979">.</span><span class="ident" id="5585980">Dy</span><span class="op" id="5585982">(</span><span class="op" id="5585983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5585986">d0</span>&nbsp;<span class="op" id="5585989">:=</span>&nbsp;<span class="ident" id="5585992">dst</span><span class="op" id="5585995">.</span><span class="ident" id="5585996">PixOffset</span><span class="op" id="5586005">(</span><span class="ident" id="5586006">r</span><span class="op" id="5586007">.</span><span class="ident" id="5586008">Min</span><span class="op" id="5586011">.</span><span class="ident" id="5586012">X</span><span class="op" id="5586013">,</span>&nbsp;<span class="ident" id="5586015">r</span><span class="op" id="5586016">.</span><span class="ident" id="5586017">Min</span><span class="op" id="5586020">.</span><span class="ident" id="5586021">Y</span><span class="op" id="5586022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586025">s0</span>&nbsp;<span class="op" id="5586028">:=</span>&nbsp;<span class="ident" id="5586031">src</span><span class="op" id="5586034">.</span><span class="ident" id="5586035">PixOffset</span><span class="op" id="5586044">(</span><span class="ident" id="5586045">sp</span><span class="op" id="5586047">.</span><span class="ident" id="5586048">X</span><span class="op" id="5586049">,</span>&nbsp;<span class="ident" id="5586051">sp</span><span class="op" id="5586053">.</span><span class="ident" id="5586054">Y</span><span class="op" id="5586055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586058">var</span>&nbsp;<span class="op" id="5586062">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586066">ddelta</span><span class="op" id="5586072">,</span>&nbsp;<span class="ident" id="5586074">sdelta</span>&nbsp;<span class="builtintype" id="5586081">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586087">i0</span><span class="op" id="5586089">,</span>&nbsp;<span class="ident" id="5586091">i1</span><span class="op" id="5586093">,</span>&nbsp;<span class="ident" id="5586095">idelta</span>&nbsp;<span class="builtintype" id="5586102">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586110">if</span>&nbsp;<span class="ident" id="5586113">r</span><span class="op" id="5586114">.</span><span class="ident" id="5586115">Min</span><span class="op" id="5586118">.</span><span class="ident" id="5586119">Y</span>&nbsp;<span class="op" id="5586121">&lt;</span>&nbsp;<span class="ident" id="5586123">sp</span><span class="op" id="5586125">.</span><span class="ident" id="5586126">Y</span>&nbsp;<span class="op" id="5586128">||</span>&nbsp;<span class="ident" id="5586131">r</span><span class="op" id="5586132">.</span><span class="ident" id="5586133">Min</span><span class="op" id="5586136">.</span><span class="ident" id="5586137">Y</span>&nbsp;<span class="op" id="5586139">==</span>&nbsp;<span class="ident" id="5586142">sp</span><span class="op" id="5586144">.</span><span class="ident" id="5586145">Y</span>&nbsp;<span class="op" id="5586147">&amp;&amp;</span>&nbsp;<span class="ident" id="5586150">r</span><span class="op" id="5586151">.</span><span class="ident" id="5586152">Min</span><span class="op" id="5586155">.</span><span class="ident" id="5586156">X</span>&nbsp;<span class="op" id="5586158">&lt;=</span>&nbsp;<span class="ident" id="5586161">sp</span><span class="op" id="5586163">.</span><span class="ident" id="5586164">X</span>&nbsp;<span class="op" id="5586166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586170">ddelta</span>&nbsp;<span class="op" id="5586177">=</span>&nbsp;<span class="ident" id="5586179">dst</span><span class="op" id="5586182">.</span><span class="ident" id="5586183">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586192">sdelta</span>&nbsp;<span class="op" id="5586199">=</span>&nbsp;<span class="ident" id="5586201">src</span><span class="op" id="5586204">.</span><span class="ident" id="5586205">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586214">i0</span><span class="op" id="5586216">,</span>&nbsp;<span class="ident" id="5586218">i1</span><span class="op" id="5586220">,</span>&nbsp;<span class="ident" id="5586222">idelta</span>&nbsp;<span class="op" id="5586229">=</span>&nbsp;<span class="num" id="5586231">0</span><span class="op" id="5586232">,</span>&nbsp;<span class="ident" id="5586234">dx</span><span class="op" id="5586236">*</span><span class="num" id="5586237">4</span><span class="op" id="5586238">,</span>&nbsp;<span class="op" id="5586240">+</span><span class="num" id="5586241">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586244">}</span>&nbsp;<span class="keyword" id="5586246">else</span>&nbsp;<span class="op" id="5586251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586255">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586363">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586463">d0</span>&nbsp;<span class="op" id="5586466">+=</span>&nbsp;<span class="op" id="5586469">(</span><span class="ident" id="5586470">dy</span>&nbsp;<span class="op" id="5586473">-</span>&nbsp;<span class="num" id="5586475">1</span><span class="op" id="5586476">)</span>&nbsp;<span class="op" id="5586478">*</span>&nbsp;<span class="ident" id="5586480">dst</span><span class="op" id="5586483">.</span><span class="ident" id="5586484">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586493">s0</span>&nbsp;<span class="op" id="5586496">+=</span>&nbsp;<span class="op" id="5586499">(</span><span class="ident" id="5586500">dy</span>&nbsp;<span class="op" id="5586503">-</span>&nbsp;<span class="num" id="5586505">1</span><span class="op" id="5586506">)</span>&nbsp;<span class="op" id="5586508">*</span>&nbsp;<span class="ident" id="5586510">src</span><span class="op" id="5586513">.</span><span class="ident" id="5586514">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586523">ddelta</span>&nbsp;<span class="op" id="5586530">=</span>&nbsp;<span class="op" id="5586532">-</span><span class="ident" id="5586533">dst</span><span class="op" id="5586536">.</span><span class="ident" id="5586537">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586546">sdelta</span>&nbsp;<span class="op" id="5586553">=</span>&nbsp;<span class="op" id="5586555">-</span><span class="ident" id="5586556">src</span><span class="op" id="5586559">.</span><span class="ident" id="5586560">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586569">i0</span><span class="op" id="5586571">,</span>&nbsp;<span class="ident" id="5586573">i1</span><span class="op" id="5586575">,</span>&nbsp;<span class="ident" id="5586577">idelta</span>&nbsp;<span class="op" id="5586584">=</span>&nbsp;<span class="op" id="5586586">(</span><span class="ident" id="5586587">dx</span><span class="op" id="5586589">-</span><span class="num" id="5586590">1</span><span class="op" id="5586591">)</span><span class="op" id="5586592">*</span><span class="num" id="5586593">4</span><span class="op" id="5586594">,</span>&nbsp;<span class="op" id="5586596">-</span><span class="num" id="5586597">4</span><span class="op" id="5586598">,</span>&nbsp;<span class="op" id="5586600">-</span><span class="num" id="5586601">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5586604">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586607">for</span>&nbsp;<span class="op" id="5586611">;</span>&nbsp;<span class="ident" id="5586613">dy</span>&nbsp;<span class="op" id="5586616">&gt;</span>&nbsp;<span class="num" id="5586618">0</span><span class="op" id="5586619">;</span>&nbsp;<span class="ident" id="5586621">dy</span><span class="op" id="5586623">--</span>&nbsp;<span class="op" id="5586626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586630">dpix</span>&nbsp;<span class="op" id="5586635">:=</span>&nbsp;<span class="ident" id="5586638">dst</span><span class="op" id="5586641">.</span><span class="ident" id="5586642">Pix</span><span class="op" id="5586645">[</span><span class="ident" id="5586646">d0</span><span class="op" id="5586648">:</span><span class="op" id="5586649">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586653">spix</span>&nbsp;<span class="op" id="5586658">:=</span>&nbsp;<span class="ident" id="5586661">src</span><span class="op" id="5586664">.</span><span class="ident" id="5586665">Pix</span><span class="op" id="5586668">[</span><span class="ident" id="5586669">s0</span><span class="op" id="5586671">:</span><span class="op" id="5586672">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5586676">for</span>&nbsp;<span class="ident" id="5586680">i</span>&nbsp;<span class="op" id="5586682">:=</span>&nbsp;<span class="ident" id="5586685">i0</span><span class="op" id="5586687">;</span>&nbsp;<span class="ident" id="5586689">i</span>&nbsp;<span class="op" id="5586691">!=</span>&nbsp;<span class="ident" id="5586694">i1</span><span class="op" id="5586696">;</span>&nbsp;<span class="ident" id="5586698">i</span>&nbsp;<span class="op" id="5586700">+=</span>&nbsp;<span class="ident" id="5586703">idelta</span>&nbsp;<span class="op" id="5586710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586715">sr</span>&nbsp;<span class="op" id="5586718">:=</span>&nbsp;<span class="builtintype" id="5586721">uint32</span><span class="op" id="5586727">(</span><span class="ident" id="5586728">spix</span><span class="op" id="5586732">[</span><span class="ident" id="5586733">i</span><span class="op" id="5586734">+</span><span class="num" id="5586735">0</span><span class="op" id="5586736">]</span><span class="op" id="5586737">)</span>&nbsp;<span class="op" id="5586739">*</span>&nbsp;<span class="num" id="5586741">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586750">sg</span>&nbsp;<span class="op" id="5586753">:=</span>&nbsp;<span class="builtintype" id="5586756">uint32</span><span class="op" id="5586762">(</span><span class="ident" id="5586763">spix</span><span class="op" id="5586767">[</span><span class="ident" id="5586768">i</span><span class="op" id="5586769">+</span><span class="num" id="5586770">1</span><span class="op" id="5586771">]</span><span class="op" id="5586772">)</span>&nbsp;<span class="op" id="5586774">*</span>&nbsp;<span class="num" id="5586776">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586785">sb</span>&nbsp;<span class="op" id="5586788">:=</span>&nbsp;<span class="builtintype" id="5586791">uint32</span><span class="op" id="5586797">(</span><span class="ident" id="5586798">spix</span><span class="op" id="5586802">[</span><span class="ident" id="5586803">i</span><span class="op" id="5586804">+</span><span class="num" id="5586805">2</span><span class="op" id="5586806">]</span><span class="op" id="5586807">)</span>&nbsp;<span class="op" id="5586809">*</span>&nbsp;<span class="num" id="5586811">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586820">sa</span>&nbsp;<span class="op" id="5586823">:=</span>&nbsp;<span class="builtintype" id="5586826">uint32</span><span class="op" id="5586832">(</span><span class="ident" id="5586833">spix</span><span class="op" id="5586837">[</span><span class="ident" id="5586838">i</span><span class="op" id="5586839">+</span><span class="num" id="5586840">3</span><span class="op" id="5586841">]</span><span class="op" id="5586842">)</span>&nbsp;<span class="op" id="5586844">*</span>&nbsp;<span class="num" id="5586846">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586856">dr</span>&nbsp;<span class="op" id="5586859">:=</span>&nbsp;<span class="builtintype" id="5586862">uint32</span><span class="op" id="5586868">(</span><span class="ident" id="5586869">dpix</span><span class="op" id="5586873">[</span><span class="ident" id="5586874">i</span><span class="op" id="5586875">+</span><span class="num" id="5586876">0</span><span class="op" id="5586877">]</span><span class="op" id="5586878">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586883">dg</span>&nbsp;<span class="op" id="5586886">:=</span>&nbsp;<span class="builtintype" id="5586889">uint32</span><span class="op" id="5586895">(</span><span class="ident" id="5586896">dpix</span><span class="op" id="5586900">[</span><span class="ident" id="5586901">i</span><span class="op" id="5586902">+</span><span class="num" id="5586903">1</span><span class="op" id="5586904">]</span><span class="op" id="5586905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586910">db</span>&nbsp;<span class="op" id="5586913">:=</span>&nbsp;<span class="builtintype" id="5586916">uint32</span><span class="op" id="5586922">(</span><span class="ident" id="5586923">dpix</span><span class="op" id="5586927">[</span><span class="ident" id="5586928">i</span><span class="op" id="5586929">+</span><span class="num" id="5586930">2</span><span class="op" id="5586931">]</span><span class="op" id="5586932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5586937">da</span>&nbsp;<span class="op" id="5586940">:=</span>&nbsp;<span class="builtintype" id="5586943">uint32</span><span class="op" id="5586949">(</span><span class="ident" id="5586950">dpix</span><span class="op" id="5586954">[</span><span class="ident" id="5586955">i</span><span class="op" id="5586956">+</span><span class="num" id="5586957">3</span><span class="op" id="5586958">]</span><span class="op" id="5586959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5586965">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587025">a</span>&nbsp;<span class="op" id="5587027">:=</span>&nbsp;<span class="op" id="5587030">(</span><span class="ident" id="5587031">m</span>&nbsp;<span class="op" id="5587033">-</span>&nbsp;<span class="ident" id="5587035">sa</span><span class="op" id="5587037">)</span>&nbsp;<span class="op" id="5587039">*</span>&nbsp;<span class="num" id="5587041">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587051">dpix</span><span class="op" id="5587055">[</span><span class="ident" id="5587056">i</span><span class="op" id="5587057">+</span><span class="num" id="5587058">0</span><span class="op" id="5587059">]</span>&nbsp;<span class="op" id="5587061">=</span>&nbsp;<span class="builtintype" id="5587063">uint8</span><span class="op" id="5587068">(</span><span class="op" id="5587069">(</span><span class="ident" id="5587070">dr</span><span class="op" id="5587072">*</span><span class="ident" id="5587073">a</span><span class="op" id="5587074">/</span><span class="ident" id="5587075">m</span>&nbsp;<span class="op" id="5587077">+</span>&nbsp;<span class="ident" id="5587079">sr</span><span class="op" id="5587081">)</span>&nbsp;<span class="op" id="5587083">&gt;&gt;</span>&nbsp;<span class="num" id="5587086">8</span><span class="op" id="5587087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587092">dpix</span><span class="op" id="5587096">[</span><span class="ident" id="5587097">i</span><span class="op" id="5587098">+</span><span class="num" id="5587099">1</span><span class="op" id="5587100">]</span>&nbsp;<span class="op" id="5587102">=</span>&nbsp;<span class="builtintype" id="5587104">uint8</span><span class="op" id="5587109">(</span><span class="op" id="5587110">(</span><span class="ident" id="5587111">dg</span><span class="op" id="5587113">*</span><span class="ident" id="5587114">a</span><span class="op" id="5587115">/</span><span class="ident" id="5587116">m</span>&nbsp;<span class="op" id="5587118">+</span>&nbsp;<span class="ident" id="5587120">sg</span><span class="op" id="5587122">)</span>&nbsp;<span class="op" id="5587124">&gt;&gt;</span>&nbsp;<span class="num" id="5587127">8</span><span class="op" id="5587128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587133">dpix</span><span class="op" id="5587137">[</span><span class="ident" id="5587138">i</span><span class="op" id="5587139">+</span><span class="num" id="5587140">2</span><span class="op" id="5587141">]</span>&nbsp;<span class="op" id="5587143">=</span>&nbsp;<span class="builtintype" id="5587145">uint8</span><span class="op" id="5587150">(</span><span class="op" id="5587151">(</span><span class="ident" id="5587152">db</span><span class="op" id="5587154">*</span><span class="ident" id="5587155">a</span><span class="op" id="5587156">/</span><span class="ident" id="5587157">m</span>&nbsp;<span class="op" id="5587159">+</span>&nbsp;<span class="ident" id="5587161">sb</span><span class="op" id="5587163">)</span>&nbsp;<span class="op" id="5587165">&gt;&gt;</span>&nbsp;<span class="num" id="5587168">8</span><span class="op" id="5587169">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587174">dpix</span><span class="op" id="5587178">[</span><span class="ident" id="5587179">i</span><span class="op" id="5587180">+</span><span class="num" id="5587181">3</span><span class="op" id="5587182">]</span>&nbsp;<span class="op" id="5587184">=</span>&nbsp;<span class="builtintype" id="5587186">uint8</span><span class="op" id="5587191">(</span><span class="op" id="5587192">(</span><span class="ident" id="5587193">da</span><span class="op" id="5587195">*</span><span class="ident" id="5587196">a</span><span class="op" id="5587197">/</span><span class="ident" id="5587198">m</span>&nbsp;<span class="op" id="5587200">+</span>&nbsp;<span class="ident" id="5587202">sa</span><span class="op" id="5587204">)</span>&nbsp;<span class="op" id="5587206">&gt;&gt;</span>&nbsp;<span class="num" id="5587209">8</span><span class="op" id="5587210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587218">d0</span>&nbsp;<span class="op" id="5587221">+=</span>&nbsp;<span class="ident" id="5587224">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587233">s0</span>&nbsp;<span class="op" id="5587236">+=</span>&nbsp;<span class="ident" id="5587239">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587247">}</span><br>
<span class="lineno">305</span><span class="op" id="5587249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5587252">func</span>&nbsp;<span class="ident" id="5587257">drawCopySrc</span><span class="op" id="5587268">(</span><span class="ident" id="5587269">dst</span>&nbsp;<span class="op" id="5587273">*</span><span class="ident" id="5587274">image</span><span class="op" id="5587279">.</span><span class="ident" id="5587280">RGBA</span><span class="op" id="5587284">,</span>&nbsp;<span class="ident" id="5587286">r</span>&nbsp;<span class="ident" id="5587288">image</span><span class="op" id="5587293">.</span><span class="ident" id="5587294">Rectangle</span><span class="op" id="5587303">,</span>&nbsp;<span class="ident" id="5587305">src</span>&nbsp;<span class="op" id="5587309">*</span><span class="ident" id="5587310">image</span><span class="op" id="5587315">.</span><span class="ident" id="5587316">RGBA</span><span class="op" id="5587320">,</span>&nbsp;<span class="ident" id="5587322">sp</span>&nbsp;<span class="ident" id="5587325">image</span><span class="op" id="5587330">.</span><span class="ident" id="5587331">Point</span><span class="op" id="5587336">)</span>&nbsp;<span class="op" id="5587338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587341">n</span><span class="op" id="5587342">,</span>&nbsp;<span class="ident" id="5587344">dy</span>&nbsp;<span class="op" id="5587347">:=</span>&nbsp;<span class="num" id="5587350">4</span><span class="op" id="5587351">*</span><span class="ident" id="5587352">r</span><span class="op" id="5587353">.</span><span class="ident" id="5587354">Dx</span><span class="op" id="5587356">(</span><span class="op" id="5587357">)</span><span class="op" id="5587358">,</span>&nbsp;<span class="ident" id="5587360">r</span><span class="op" id="5587361">.</span><span class="ident" id="5587362">Dy</span><span class="op" id="5587364">(</span><span class="op" id="5587365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587368">d0</span>&nbsp;<span class="op" id="5587371">:=</span>&nbsp;<span class="ident" id="5587374">dst</span><span class="op" id="5587377">.</span><span class="ident" id="5587378">PixOffset</span><span class="op" id="5587387">(</span><span class="ident" id="5587388">r</span><span class="op" id="5587389">.</span><span class="ident" id="5587390">Min</span><span class="op" id="5587393">.</span><span class="ident" id="5587394">X</span><span class="op" id="5587395">,</span>&nbsp;<span class="ident" id="5587397">r</span><span class="op" id="5587398">.</span><span class="ident" id="5587399">Min</span><span class="op" id="5587402">.</span><span class="ident" id="5587403">Y</span><span class="op" id="5587404">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587407">s0</span>&nbsp;<span class="op" id="5587410">:=</span>&nbsp;<span class="ident" id="5587413">src</span><span class="op" id="5587416">.</span><span class="ident" id="5587417">PixOffset</span><span class="op" id="5587426">(</span><span class="ident" id="5587427">sp</span><span class="op" id="5587429">.</span><span class="ident" id="5587430">X</span><span class="op" id="5587431">,</span>&nbsp;<span class="ident" id="5587433">sp</span><span class="op" id="5587435">.</span><span class="ident" id="5587436">Y</span><span class="op" id="5587437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587440">var</span>&nbsp;<span class="ident" id="5587444">ddelta</span><span class="op" id="5587450">,</span>&nbsp;<span class="ident" id="5587452">sdelta</span>&nbsp;<span class="builtintype" id="5587459">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587464">if</span>&nbsp;<span class="ident" id="5587467">r</span><span class="op" id="5587468">.</span><span class="ident" id="5587469">Min</span><span class="op" id="5587472">.</span><span class="ident" id="5587473">Y</span>&nbsp;<span class="op" id="5587475">&lt;=</span>&nbsp;<span class="ident" id="5587478">sp</span><span class="op" id="5587480">.</span><span class="ident" id="5587481">Y</span>&nbsp;<span class="op" id="5587483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587487">ddelta</span>&nbsp;<span class="op" id="5587494">=</span>&nbsp;<span class="ident" id="5587496">dst</span><span class="op" id="5587499">.</span><span class="ident" id="5587500">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587509">sdelta</span>&nbsp;<span class="op" id="5587516">=</span>&nbsp;<span class="ident" id="5587518">src</span><span class="op" id="5587521">.</span><span class="ident" id="5587522">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587530">}</span>&nbsp;<span class="keyword" id="5587532">else</span>&nbsp;<span class="op" id="5587537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5587541">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5587641">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5587737">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587833">d0</span>&nbsp;<span class="op" id="5587836">+=</span>&nbsp;<span class="op" id="5587839">(</span><span class="ident" id="5587840">dy</span>&nbsp;<span class="op" id="5587843">-</span>&nbsp;<span class="num" id="5587845">1</span><span class="op" id="5587846">)</span>&nbsp;<span class="op" id="5587848">*</span>&nbsp;<span class="ident" id="5587850">dst</span><span class="op" id="5587853">.</span><span class="ident" id="5587854">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587863">s0</span>&nbsp;<span class="op" id="5587866">+=</span>&nbsp;<span class="op" id="5587869">(</span><span class="ident" id="5587870">dy</span>&nbsp;<span class="op" id="5587873">-</span>&nbsp;<span class="num" id="5587875">1</span><span class="op" id="5587876">)</span>&nbsp;<span class="op" id="5587878">*</span>&nbsp;<span class="ident" id="5587880">src</span><span class="op" id="5587883">.</span><span class="ident" id="5587884">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587893">ddelta</span>&nbsp;<span class="op" id="5587900">=</span>&nbsp;<span class="op" id="5587902">-</span><span class="ident" id="5587903">dst</span><span class="op" id="5587906">.</span><span class="ident" id="5587907">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5587916">sdelta</span>&nbsp;<span class="op" id="5587923">=</span>&nbsp;<span class="op" id="5587925">-</span><span class="ident" id="5587926">src</span><span class="op" id="5587929">.</span><span class="ident" id="5587930">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5587938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5587941">for</span>&nbsp;<span class="op" id="5587945">;</span>&nbsp;<span class="ident" id="5587947">dy</span>&nbsp;<span class="op" id="5587950">&gt;</span>&nbsp;<span class="num" id="5587952">0</span><span class="op" id="5587953">;</span>&nbsp;<span class="ident" id="5587955">dy</span><span class="op" id="5587957">--</span>&nbsp;<span class="op" id="5587960">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5587964">copy</span><span class="op" id="5587968">(</span><span class="ident" id="5587969">dst</span><span class="op" id="5587972">.</span><span class="ident" id="5587973">Pix</span><span class="op" id="5587976">[</span><span class="ident" id="5587977">d0</span><span class="op" id="5587979">:</span><span class="ident" id="5587980">d0</span><span class="op" id="5587982">+</span><span class="ident" id="5587983">n</span><span class="op" id="5587984">]</span><span class="op" id="5587985">,</span>&nbsp;<span class="ident" id="5587987">src</span><span class="op" id="5587990">.</span><span class="ident" id="5587991">Pix</span><span class="op" id="5587994">[</span><span class="ident" id="5587995">s0</span><span class="op" id="5587997">:</span><span class="ident" id="5587998">s0</span><span class="op" id="5588000">+</span><span class="ident" id="5588001">n</span><span class="op" id="5588002">]</span><span class="op" id="5588003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588007">d0</span>&nbsp;<span class="op" id="5588010">+=</span>&nbsp;<span class="ident" id="5588013">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588022">s0</span>&nbsp;<span class="op" id="5588025">+=</span>&nbsp;<span class="ident" id="5588028">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5588036">}</span><br>
<span class="lineno"></span><span class="op" id="5588038">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5588041">func</span>&nbsp;<span class="ident" id="5588046">drawNRGBAOver</span><span class="op" id="5588059">(</span><span class="ident" id="5588060">dst</span>&nbsp;<span class="op" id="5588064">*</span><span class="ident" id="5588065">image</span><span class="op" id="5588070">.</span><span class="ident" id="5588071">RGBA</span><span class="op" id="5588075">,</span>&nbsp;<span class="ident" id="5588077">r</span>&nbsp;<span class="ident" id="5588079">image</span><span class="op" id="5588084">.</span><span class="ident" id="5588085">Rectangle</span><span class="op" id="5588094">,</span>&nbsp;<span class="ident" id="5588096">src</span>&nbsp;<span class="op" id="5588100">*</span><span class="ident" id="5588101">image</span><span class="op" id="5588106">.</span><span class="ident" id="5588107">NRGBA</span><span class="op" id="5588112">,</span>&nbsp;<span class="ident" id="5588114">sp</span>&nbsp;<span class="ident" id="5588117">image</span><span class="op" id="5588122">.</span><span class="ident" id="5588123">Point</span><span class="op" id="5588128">)</span>&nbsp;<span class="op" id="5588130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588133">i0</span>&nbsp;<span class="op" id="5588136">:=</span>&nbsp;<span class="op" id="5588139">(</span><span class="ident" id="5588140">r</span><span class="op" id="5588141">.</span><span class="ident" id="5588142">Min</span><span class="op" id="5588145">.</span><span class="ident" id="5588146">X</span>&nbsp;<span class="op" id="5588148">-</span>&nbsp;<span class="ident" id="5588150">dst</span><span class="op" id="5588153">.</span><span class="ident" id="5588154">Rect</span><span class="op" id="5588158">.</span><span class="ident" id="5588159">Min</span><span class="op" id="5588162">.</span><span class="ident" id="5588163">X</span><span class="op" id="5588164">)</span>&nbsp;<span class="op" id="5588166">*</span>&nbsp;<span class="num" id="5588168">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588171">i1</span>&nbsp;<span class="op" id="5588174">:=</span>&nbsp;<span class="op" id="5588177">(</span><span class="ident" id="5588178">r</span><span class="op" id="5588179">.</span><span class="ident" id="5588180">Max</span><span class="op" id="5588183">.</span><span class="ident" id="5588184">X</span>&nbsp;<span class="op" id="5588186">-</span>&nbsp;<span class="ident" id="5588188">dst</span><span class="op" id="5588191">.</span><span class="ident" id="5588192">Rect</span><span class="op" id="5588196">.</span><span class="ident" id="5588197">Min</span><span class="op" id="5588200">.</span><span class="ident" id="5588201">X</span><span class="op" id="5588202">)</span>&nbsp;<span class="op" id="5588204">*</span>&nbsp;<span class="num" id="5588206">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588209">si0</span>&nbsp;<span class="op" id="5588213">:=</span>&nbsp;<span class="op" id="5588216">(</span><span class="ident" id="5588217">sp</span><span class="op" id="5588219">.</span><span class="ident" id="5588220">X</span>&nbsp;<span class="op" id="5588222">-</span>&nbsp;<span class="ident" id="5588224">src</span><span class="op" id="5588227">.</span><span class="ident" id="5588228">Rect</span><span class="op" id="5588232">.</span><span class="ident" id="5588233">Min</span><span class="op" id="5588236">.</span><span class="ident" id="5588237">X</span><span class="op" id="5588238">)</span>&nbsp;<span class="op" id="5588240">*</span>&nbsp;<span class="num" id="5588242">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588245">yMax</span>&nbsp;<span class="op" id="5588250">:=</span>&nbsp;<span class="ident" id="5588253">r</span><span class="op" id="5588254">.</span><span class="ident" id="5588255">Max</span><span class="op" id="5588258">.</span><span class="ident" id="5588259">Y</span>&nbsp;<span class="op" id="5588261">-</span>&nbsp;<span class="ident" id="5588263">dst</span><span class="op" id="5588266">.</span><span class="ident" id="5588267">Rect</span><span class="op" id="5588271">.</span><span class="ident" id="5588272">Min</span><span class="op" id="5588275">.</span><span class="ident" id="5588276">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588280">y</span>&nbsp;<span class="op" id="5588282">:=</span>&nbsp;<span class="ident" id="5588285">r</span><span class="op" id="5588286">.</span><span class="ident" id="5588287">Min</span><span class="op" id="5588290">.</span><span class="ident" id="5588291">Y</span>&nbsp;<span class="op" id="5588293">-</span>&nbsp;<span class="ident" id="5588295">dst</span><span class="op" id="5588298">.</span><span class="ident" id="5588299">Rect</span><span class="op" id="5588303">.</span><span class="ident" id="5588304">Min</span><span class="op" id="5588307">.</span><span class="ident" id="5588308">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588311">sy</span>&nbsp;<span class="op" id="5588314">:=</span>&nbsp;<span class="ident" id="5588317">sp</span><span class="op" id="5588319">.</span><span class="ident" id="5588320">Y</span>&nbsp;<span class="op" id="5588322">-</span>&nbsp;<span class="ident" id="5588324">src</span><span class="op" id="5588327">.</span><span class="ident" id="5588328">Rect</span><span class="op" id="5588332">.</span><span class="ident" id="5588333">Min</span><span class="op" id="5588336">.</span><span class="ident" id="5588337">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588340">for</span>&nbsp;<span class="op" id="5588344">;</span>&nbsp;<span class="ident" id="5588346">y</span>&nbsp;<span class="op" id="5588348">!=</span>&nbsp;<span class="ident" id="5588351">yMax</span><span class="op" id="5588355">;</span>&nbsp;<span class="ident" id="5588357">y</span><span class="op" id="5588358">,</span>&nbsp;<span class="ident" id="5588360">sy</span>&nbsp;<span class="op" id="5588363">=</span>&nbsp;<span class="ident" id="5588365">y</span><span class="op" id="5588366">+</span><span class="num" id="5588367">1</span><span class="op" id="5588368">,</span>&nbsp;<span class="ident" id="5588370">sy</span><span class="op" id="5588372">+</span><span class="num" id="5588373">1</span>&nbsp;<span class="op" id="5588375">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588379">dpix</span>&nbsp;<span class="op" id="5588384">:=</span>&nbsp;<span class="ident" id="5588387">dst</span><span class="op" id="5588390">.</span><span class="ident" id="5588391">Pix</span><span class="op" id="5588394">[</span><span class="ident" id="5588395">y</span><span class="op" id="5588396">*</span><span class="ident" id="5588397">dst</span><span class="op" id="5588400">.</span><span class="ident" id="5588401">Stride</span><span class="op" id="5588407">:</span><span class="op" id="5588408">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588412">spix</span>&nbsp;<span class="op" id="5588417">:=</span>&nbsp;<span class="ident" id="5588420">src</span><span class="op" id="5588423">.</span><span class="ident" id="5588424">Pix</span><span class="op" id="5588427">[</span><span class="ident" id="5588428">sy</span><span class="op" id="5588430">*</span><span class="ident" id="5588431">src</span><span class="op" id="5588434">.</span><span class="ident" id="5588435">Stride</span><span class="op" id="5588441">:</span><span class="op" id="5588442">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5588447">for</span>&nbsp;<span class="ident" id="5588451">i</span><span class="op" id="5588452">,</span>&nbsp;<span class="ident" id="5588454">si</span>&nbsp;<span class="op" id="5588457">:=</span>&nbsp;<span class="ident" id="5588460">i0</span><span class="op" id="5588462">,</span>&nbsp;<span class="ident" id="5588464">si0</span><span class="op" id="5588467">;</span>&nbsp;<span class="ident" id="5588469">i</span>&nbsp;<span class="op" id="5588471">&lt;</span>&nbsp;<span class="ident" id="5588473">i1</span><span class="op" id="5588475">;</span>&nbsp;<span class="ident" id="5588477">i</span><span class="op" id="5588478">,</span>&nbsp;<span class="ident" id="5588480">si</span>&nbsp;<span class="op" id="5588483">=</span>&nbsp;<span class="ident" id="5588485">i</span><span class="op" id="5588486">+</span><span class="num" id="5588487">4</span><span class="op" id="5588488">,</span>&nbsp;<span class="ident" id="5588490">si</span><span class="op" id="5588492">+</span><span class="num" id="5588493">4</span>&nbsp;<span class="op" id="5588495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5588500">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588568">sa</span>&nbsp;<span class="op" id="5588571">:=</span>&nbsp;<span class="builtintype" id="5588574">uint32</span><span class="op" id="5588580">(</span><span class="ident" id="5588581">spix</span><span class="op" id="5588585">[</span><span class="ident" id="5588586">si</span><span class="op" id="5588588">+</span><span class="num" id="5588589">3</span><span class="op" id="5588590">]</span><span class="op" id="5588591">)</span>&nbsp;<span class="op" id="5588593">*</span>&nbsp;<span class="num" id="5588595">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588604">sr</span>&nbsp;<span class="op" id="5588607">:=</span>&nbsp;<span class="builtintype" id="5588610">uint32</span><span class="op" id="5588616">(</span><span class="ident" id="5588617">spix</span><span class="op" id="5588621">[</span><span class="ident" id="5588622">si</span><span class="op" id="5588624">+</span><span class="num" id="5588625">0</span><span class="op" id="5588626">]</span><span class="op" id="5588627">)</span>&nbsp;<span class="op" id="5588629">*</span>&nbsp;<span class="ident" id="5588631">sa</span>&nbsp;<span class="op" id="5588634">/</span>&nbsp;<span class="num" id="5588636">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588644">sg</span>&nbsp;<span class="op" id="5588647">:=</span>&nbsp;<span class="builtintype" id="5588650">uint32</span><span class="op" id="5588656">(</span><span class="ident" id="5588657">spix</span><span class="op" id="5588661">[</span><span class="ident" id="5588662">si</span><span class="op" id="5588664">+</span><span class="num" id="5588665">1</span><span class="op" id="5588666">]</span><span class="op" id="5588667">)</span>&nbsp;<span class="op" id="5588669">*</span>&nbsp;<span class="ident" id="5588671">sa</span>&nbsp;<span class="op" id="5588674">/</span>&nbsp;<span class="num" id="5588676">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588684">sb</span>&nbsp;<span class="op" id="5588687">:=</span>&nbsp;<span class="builtintype" id="5588690">uint32</span><span class="op" id="5588696">(</span><span class="ident" id="5588697">spix</span><span class="op" id="5588701">[</span><span class="ident" id="5588702">si</span><span class="op" id="5588704">+</span><span class="num" id="5588705">2</span><span class="op" id="5588706">]</span><span class="op" id="5588707">)</span>&nbsp;<span class="op" id="5588709">*</span>&nbsp;<span class="ident" id="5588711">sa</span>&nbsp;<span class="op" id="5588714">/</span>&nbsp;<span class="num" id="5588716">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588725">dr</span>&nbsp;<span class="op" id="5588728">:=</span>&nbsp;<span class="builtintype" id="5588731">uint32</span><span class="op" id="5588737">(</span><span class="ident" id="5588738">dpix</span><span class="op" id="5588742">[</span><span class="ident" id="5588743">i</span><span class="op" id="5588744">+</span><span class="num" id="5588745">0</span><span class="op" id="5588746">]</span><span class="op" id="5588747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588752">dg</span>&nbsp;<span class="op" id="5588755">:=</span>&nbsp;<span class="builtintype" id="5588758">uint32</span><span class="op" id="5588764">(</span><span class="ident" id="5588765">dpix</span><span class="op" id="5588769">[</span><span class="ident" id="5588770">i</span><span class="op" id="5588771">+</span><span class="num" id="5588772">1</span><span class="op" id="5588773">]</span><span class="op" id="5588774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588779">db</span>&nbsp;<span class="op" id="5588782">:=</span>&nbsp;<span class="builtintype" id="5588785">uint32</span><span class="op" id="5588791">(</span><span class="ident" id="5588792">dpix</span><span class="op" id="5588796">[</span><span class="ident" id="5588797">i</span><span class="op" id="5588798">+</span><span class="num" id="5588799">2</span><span class="op" id="5588800">]</span><span class="op" id="5588801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588806">da</span>&nbsp;<span class="op" id="5588809">:=</span>&nbsp;<span class="builtintype" id="5588812">uint32</span><span class="op" id="5588818">(</span><span class="ident" id="5588819">dpix</span><span class="op" id="5588823">[</span><span class="ident" id="5588824">i</span><span class="op" id="5588825">+</span><span class="num" id="5588826">3</span><span class="op" id="5588827">]</span><span class="op" id="5588828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5588834">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588894">a</span>&nbsp;<span class="op" id="5588896">:=</span>&nbsp;<span class="op" id="5588899">(</span><span class="ident" id="5588900">m</span>&nbsp;<span class="op" id="5588902">-</span>&nbsp;<span class="ident" id="5588904">sa</span><span class="op" id="5588906">)</span>&nbsp;<span class="op" id="5588908">*</span>&nbsp;<span class="num" id="5588910">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588920">dpix</span><span class="op" id="5588924">[</span><span class="ident" id="5588925">i</span><span class="op" id="5588926">+</span><span class="num" id="5588927">0</span><span class="op" id="5588928">]</span>&nbsp;<span class="op" id="5588930">=</span>&nbsp;<span class="builtintype" id="5588932">uint8</span><span class="op" id="5588937">(</span><span class="op" id="5588938">(</span><span class="ident" id="5588939">dr</span><span class="op" id="5588941">*</span><span class="ident" id="5588942">a</span><span class="op" id="5588943">/</span><span class="ident" id="5588944">m</span>&nbsp;<span class="op" id="5588946">+</span>&nbsp;<span class="ident" id="5588948">sr</span><span class="op" id="5588950">)</span>&nbsp;<span class="op" id="5588952">&gt;&gt;</span>&nbsp;<span class="num" id="5588955">8</span><span class="op" id="5588956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5588961">dpix</span><span class="op" id="5588965">[</span><span class="ident" id="5588966">i</span><span class="op" id="5588967">+</span><span class="num" id="5588968">1</span><span class="op" id="5588969">]</span>&nbsp;<span class="op" id="5588971">=</span>&nbsp;<span class="builtintype" id="5588973">uint8</span><span class="op" id="5588978">(</span><span class="op" id="5588979">(</span><span class="ident" id="5588980">dg</span><span class="op" id="5588982">*</span><span class="ident" id="5588983">a</span><span class="op" id="5588984">/</span><span class="ident" id="5588985">m</span>&nbsp;<span class="op" id="5588987">+</span>&nbsp;<span class="ident" id="5588989">sg</span><span class="op" id="5588991">)</span>&nbsp;<span class="op" id="5588993">&gt;&gt;</span>&nbsp;<span class="num" id="5588996">8</span><span class="op" id="5588997">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589002">dpix</span><span class="op" id="5589006">[</span><span class="ident" id="5589007">i</span><span class="op" id="5589008">+</span><span class="num" id="5589009">2</span><span class="op" id="5589010">]</span>&nbsp;<span class="op" id="5589012">=</span>&nbsp;<span class="builtintype" id="5589014">uint8</span><span class="op" id="5589019">(</span><span class="op" id="5589020">(</span><span class="ident" id="5589021">db</span><span class="op" id="5589023">*</span><span class="ident" id="5589024">a</span><span class="op" id="5589025">/</span><span class="ident" id="5589026">m</span>&nbsp;<span class="op" id="5589028">+</span>&nbsp;<span class="ident" id="5589030">sb</span><span class="op" id="5589032">)</span>&nbsp;<span class="op" id="5589034">&gt;&gt;</span>&nbsp;<span class="num" id="5589037">8</span><span class="op" id="5589038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589043">dpix</span><span class="op" id="5589047">[</span><span class="ident" id="5589048">i</span><span class="op" id="5589049">+</span><span class="num" id="5589050">3</span><span class="op" id="5589051">]</span>&nbsp;<span class="op" id="5589053">=</span>&nbsp;<span class="builtintype" id="5589055">uint8</span><span class="op" id="5589060">(</span><span class="op" id="5589061">(</span><span class="ident" id="5589062">da</span><span class="op" id="5589064">*</span><span class="ident" id="5589065">a</span><span class="op" id="5589066">/</span><span class="ident" id="5589067">m</span>&nbsp;<span class="op" id="5589069">+</span>&nbsp;<span class="ident" id="5589071">sa</span><span class="op" id="5589073">)</span>&nbsp;<span class="op" id="5589075">&gt;&gt;</span>&nbsp;<span class="num" id="5589078">8</span><span class="op" id="5589079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589086">}</span><br>
<span class="lineno"></span><span class="op" id="5589088">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5589091">func</span>&nbsp;<span class="ident" id="5589096">drawNRGBASrc</span><span class="op" id="5589108">(</span><span class="ident" id="5589109">dst</span>&nbsp;<span class="op" id="5589113">*</span><span class="ident" id="5589114">image</span><span class="op" id="5589119">.</span><span class="ident" id="5589120">RGBA</span><span class="op" id="5589124">,</span>&nbsp;<span class="ident" id="5589126">r</span>&nbsp;<span class="ident" id="5589128">image</span><span class="op" id="5589133">.</span><span class="ident" id="5589134">Rectangle</span><span class="op" id="5589143">,</span>&nbsp;<span class="ident" id="5589145">src</span>&nbsp;<span class="op" id="5589149">*</span><span class="ident" id="5589150">image</span><span class="op" id="5589155">.</span><span class="ident" id="5589156">NRGBA</span><span class="op" id="5589161">,</span>&nbsp;<span class="ident" id="5589163">sp</span>&nbsp;<span class="ident" id="5589166">image</span><span class="op" id="5589171">.</span><span class="ident" id="5589172">Point</span><span class="op" id="5589177">)</span>&nbsp;<span class="op" id="5589179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589182">i0</span>&nbsp;<span class="op" id="5589185">:=</span>&nbsp;<span class="op" id="5589188">(</span><span class="ident" id="5589189">r</span><span class="op" id="5589190">.</span><span class="ident" id="5589191">Min</span><span class="op" id="5589194">.</span><span class="ident" id="5589195">X</span>&nbsp;<span class="op" id="5589197">-</span>&nbsp;<span class="ident" id="5589199">dst</span><span class="op" id="5589202">.</span><span class="ident" id="5589203">Rect</span><span class="op" id="5589207">.</span><span class="ident" id="5589208">Min</span><span class="op" id="5589211">.</span><span class="ident" id="5589212">X</span><span class="op" id="5589213">)</span>&nbsp;<span class="op" id="5589215">*</span>&nbsp;<span class="num" id="5589217">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589220">i1</span>&nbsp;<span class="op" id="5589223">:=</span>&nbsp;<span class="op" id="5589226">(</span><span class="ident" id="5589227">r</span><span class="op" id="5589228">.</span><span class="ident" id="5589229">Max</span><span class="op" id="5589232">.</span><span class="ident" id="5589233">X</span>&nbsp;<span class="op" id="5589235">-</span>&nbsp;<span class="ident" id="5589237">dst</span><span class="op" id="5589240">.</span><span class="ident" id="5589241">Rect</span><span class="op" id="5589245">.</span><span class="ident" id="5589246">Min</span><span class="op" id="5589249">.</span><span class="ident" id="5589250">X</span><span class="op" id="5589251">)</span>&nbsp;<span class="op" id="5589253">*</span>&nbsp;<span class="num" id="5589255">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589258">si0</span>&nbsp;<span class="op" id="5589262">:=</span>&nbsp;<span class="op" id="5589265">(</span><span class="ident" id="5589266">sp</span><span class="op" id="5589268">.</span><span class="ident" id="5589269">X</span>&nbsp;<span class="op" id="5589271">-</span>&nbsp;<span class="ident" id="5589273">src</span><span class="op" id="5589276">.</span><span class="ident" id="5589277">Rect</span><span class="op" id="5589281">.</span><span class="ident" id="5589282">Min</span><span class="op" id="5589285">.</span><span class="ident" id="5589286">X</span><span class="op" id="5589287">)</span>&nbsp;<span class="op" id="5589289">*</span>&nbsp;<span class="num" id="5589291">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589294">yMax</span>&nbsp;<span class="op" id="5589299">:=</span>&nbsp;<span class="ident" id="5589302">r</span><span class="op" id="5589303">.</span><span class="ident" id="5589304">Max</span><span class="op" id="5589307">.</span><span class="ident" id="5589308">Y</span>&nbsp;<span class="op" id="5589310">-</span>&nbsp;<span class="ident" id="5589312">dst</span><span class="op" id="5589315">.</span><span class="ident" id="5589316">Rect</span><span class="op" id="5589320">.</span><span class="ident" id="5589321">Min</span><span class="op" id="5589324">.</span><span class="ident" id="5589325">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589329">y</span>&nbsp;<span class="op" id="5589331">:=</span>&nbsp;<span class="ident" id="5589334">r</span><span class="op" id="5589335">.</span><span class="ident" id="5589336">Min</span><span class="op" id="5589339">.</span><span class="ident" id="5589340">Y</span>&nbsp;<span class="op" id="5589342">-</span>&nbsp;<span class="ident" id="5589344">dst</span><span class="op" id="5589347">.</span><span class="ident" id="5589348">Rect</span><span class="op" id="5589352">.</span><span class="ident" id="5589353">Min</span><span class="op" id="5589356">.</span><span class="ident" id="5589357">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589360">sy</span>&nbsp;<span class="op" id="5589363">:=</span>&nbsp;<span class="ident" id="5589366">sp</span><span class="op" id="5589368">.</span><span class="ident" id="5589369">Y</span>&nbsp;<span class="op" id="5589371">-</span>&nbsp;<span class="ident" id="5589373">src</span><span class="op" id="5589376">.</span><span class="ident" id="5589377">Rect</span><span class="op" id="5589381">.</span><span class="ident" id="5589382">Min</span><span class="op" id="5589385">.</span><span class="ident" id="5589386">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589389">for</span>&nbsp;<span class="op" id="5589393">;</span>&nbsp;<span class="ident" id="5589395">y</span>&nbsp;<span class="op" id="5589397">!=</span>&nbsp;<span class="ident" id="5589400">yMax</span><span class="op" id="5589404">;</span>&nbsp;<span class="ident" id="5589406">y</span><span class="op" id="5589407">,</span>&nbsp;<span class="ident" id="5589409">sy</span>&nbsp;<span class="op" id="5589412">=</span>&nbsp;<span class="ident" id="5589414">y</span><span class="op" id="5589415">+</span><span class="num" id="5589416">1</span><span class="op" id="5589417">,</span>&nbsp;<span class="ident" id="5589419">sy</span><span class="op" id="5589421">+</span><span class="num" id="5589422">1</span>&nbsp;<span class="op" id="5589424">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589428">dpix</span>&nbsp;<span class="op" id="5589433">:=</span>&nbsp;<span class="ident" id="5589436">dst</span><span class="op" id="5589439">.</span><span class="ident" id="5589440">Pix</span><span class="op" id="5589443">[</span><span class="ident" id="5589444">y</span><span class="op" id="5589445">*</span><span class="ident" id="5589446">dst</span><span class="op" id="5589449">.</span><span class="ident" id="5589450">Stride</span><span class="op" id="5589456">:</span><span class="op" id="5589457">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589461">spix</span>&nbsp;<span class="op" id="5589466">:=</span>&nbsp;<span class="ident" id="5589469">src</span><span class="op" id="5589472">.</span><span class="ident" id="5589473">Pix</span><span class="op" id="5589476">[</span><span class="ident" id="5589477">sy</span><span class="op" id="5589479">*</span><span class="ident" id="5589480">src</span><span class="op" id="5589483">.</span><span class="ident" id="5589484">Stride</span><span class="op" id="5589490">:</span><span class="op" id="5589491">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5589496">for</span>&nbsp;<span class="ident" id="5589500">i</span><span class="op" id="5589501">,</span>&nbsp;<span class="ident" id="5589503">si</span>&nbsp;<span class="op" id="5589506">:=</span>&nbsp;<span class="ident" id="5589509">i0</span><span class="op" id="5589511">,</span>&nbsp;<span class="ident" id="5589513">si0</span><span class="op" id="5589516">;</span>&nbsp;<span class="ident" id="5589518">i</span>&nbsp;<span class="op" id="5589520">&lt;</span>&nbsp;<span class="ident" id="5589522">i1</span><span class="op" id="5589524">;</span>&nbsp;<span class="ident" id="5589526">i</span><span class="op" id="5589527">,</span>&nbsp;<span class="ident" id="5589529">si</span>&nbsp;<span class="op" id="5589532">=</span>&nbsp;<span class="ident" id="5589534">i</span><span class="op" id="5589535">+</span><span class="num" id="5589536">4</span><span class="op" id="5589537">,</span>&nbsp;<span class="ident" id="5589539">si</span><span class="op" id="5589541">+</span><span class="num" id="5589542">4</span>&nbsp;<span class="op" id="5589544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5589549">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589617">sa</span>&nbsp;<span class="op" id="5589620">:=</span>&nbsp;<span class="builtintype" id="5589623">uint32</span><span class="op" id="5589629">(</span><span class="ident" id="5589630">spix</span><span class="op" id="5589634">[</span><span class="ident" id="5589635">si</span><span class="op" id="5589637">+</span><span class="num" id="5589638">3</span><span class="op" id="5589639">]</span><span class="op" id="5589640">)</span>&nbsp;<span class="op" id="5589642">*</span>&nbsp;<span class="num" id="5589644">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589653">sr</span>&nbsp;<span class="op" id="5589656">:=</span>&nbsp;<span class="builtintype" id="5589659">uint32</span><span class="op" id="5589665">(</span><span class="ident" id="5589666">spix</span><span class="op" id="5589670">[</span><span class="ident" id="5589671">si</span><span class="op" id="5589673">+</span><span class="num" id="5589674">0</span><span class="op" id="5589675">]</span><span class="op" id="5589676">)</span>&nbsp;<span class="op" id="5589678">*</span>&nbsp;<span class="ident" id="5589680">sa</span>&nbsp;<span class="op" id="5589683">/</span>&nbsp;<span class="num" id="5589685">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589693">sg</span>&nbsp;<span class="op" id="5589696">:=</span>&nbsp;<span class="builtintype" id="5589699">uint32</span><span class="op" id="5589705">(</span><span class="ident" id="5589706">spix</span><span class="op" id="5589710">[</span><span class="ident" id="5589711">si</span><span class="op" id="5589713">+</span><span class="num" id="5589714">1</span><span class="op" id="5589715">]</span><span class="op" id="5589716">)</span>&nbsp;<span class="op" id="5589718">*</span>&nbsp;<span class="ident" id="5589720">sa</span>&nbsp;<span class="op" id="5589723">/</span>&nbsp;<span class="num" id="5589725">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589733">sb</span>&nbsp;<span class="op" id="5589736">:=</span>&nbsp;<span class="builtintype" id="5589739">uint32</span><span class="op" id="5589745">(</span><span class="ident" id="5589746">spix</span><span class="op" id="5589750">[</span><span class="ident" id="5589751">si</span><span class="op" id="5589753">+</span><span class="num" id="5589754">2</span><span class="op" id="5589755">]</span><span class="op" id="5589756">)</span>&nbsp;<span class="op" id="5589758">*</span>&nbsp;<span class="ident" id="5589760">sa</span>&nbsp;<span class="op" id="5589763">/</span>&nbsp;<span class="num" id="5589765">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589774">dpix</span><span class="op" id="5589778">[</span><span class="ident" id="5589779">i</span><span class="op" id="5589780">+</span><span class="num" id="5589781">0</span><span class="op" id="5589782">]</span>&nbsp;<span class="op" id="5589784">=</span>&nbsp;<span class="builtintype" id="5589786">uint8</span><span class="op" id="5589791">(</span><span class="ident" id="5589792">sr</span>&nbsp;<span class="op" id="5589795">&gt;&gt;</span>&nbsp;<span class="num" id="5589798">8</span><span class="op" id="5589799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589804">dpix</span><span class="op" id="5589808">[</span><span class="ident" id="5589809">i</span><span class="op" id="5589810">+</span><span class="num" id="5589811">1</span><span class="op" id="5589812">]</span>&nbsp;<span class="op" id="5589814">=</span>&nbsp;<span class="builtintype" id="5589816">uint8</span><span class="op" id="5589821">(</span><span class="ident" id="5589822">sg</span>&nbsp;<span class="op" id="5589825">&gt;&gt;</span>&nbsp;<span class="num" id="5589828">8</span><span class="op" id="5589829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589834">dpix</span><span class="op" id="5589838">[</span><span class="ident" id="5589839">i</span><span class="op" id="5589840">+</span><span class="num" id="5589841">2</span><span class="op" id="5589842">]</span>&nbsp;<span class="op" id="5589844">=</span>&nbsp;<span class="builtintype" id="5589846">uint8</span><span class="op" id="5589851">(</span><span class="ident" id="5589852">sb</span>&nbsp;<span class="op" id="5589855">&gt;&gt;</span>&nbsp;<span class="num" id="5589858">8</span><span class="op" id="5589859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5589864">dpix</span><span class="op" id="5589868">[</span><span class="ident" id="5589869">i</span><span class="op" id="5589870">+</span><span class="num" id="5589871">3</span><span class="op" id="5589872">]</span>&nbsp;<span class="op" id="5589874">=</span>&nbsp;<span class="builtintype" id="5589876">uint8</span><span class="op" id="5589881">(</span><span class="ident" id="5589882">sa</span>&nbsp;<span class="op" id="5589885">&gt;&gt;</span>&nbsp;<span class="num" id="5589888">8</span><span class="op" id="5589889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589893">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5589896">}</span><br>
<span class="lineno"></span><span class="op" id="5589898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5589901">func</span>&nbsp;<span class="ident" id="5589906">drawYCbCr</span><span class="op" id="5589915">(</span><span class="ident" id="5589916">dst</span>&nbsp;<span class="op" id="5589920">*</span><span class="ident" id="5589921">image</span><span class="op" id="5589926">.</span><span class="ident" id="5589927">RGBA</span><span class="op" id="5589931">,</span>&nbsp;<span class="ident" id="5589933">r</span>&nbsp;<span class="ident" id="5589935">image</span><span class="op" id="5589940">.</span><span class="ident" id="5589941">Rectangle</span><span class="op" id="5589950">,</span>&nbsp;<span class="ident" id="5589952">src</span>&nbsp;<span class="op" id="5589956">*</span><span class="ident" id="5589957">image</span><span class="op" id="5589962">.</span><span class="ident" id="5589963">YCbCr</span><span class="op" id="5589968">,</span>&nbsp;<span class="ident" id="5589970">sp</span>&nbsp;<span class="ident" id="5589973">image</span><span class="op" id="5589978">.</span><span class="ident" id="5589979">Point</span><span class="op" id="5589984">)</span>&nbsp;<span class="op" id="5589986">(</span><span class="ident" id="5589987">ok</span>&nbsp;<span class="builtintype" id="5589990">bool</span><span class="op" id="5589994">)</span>&nbsp;<span class="op" id="5589996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5589999">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5590079">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590142">x0</span>&nbsp;<span class="op" id="5590145">:=</span>&nbsp;<span class="op" id="5590148">(</span><span class="ident" id="5590149">r</span><span class="op" id="5590150">.</span><span class="ident" id="5590151">Min</span><span class="op" id="5590154">.</span><span class="ident" id="5590155">X</span>&nbsp;<span class="op" id="5590157">-</span>&nbsp;<span class="ident" id="5590159">dst</span><span class="op" id="5590162">.</span><span class="ident" id="5590163">Rect</span><span class="op" id="5590167">.</span><span class="ident" id="5590168">Min</span><span class="op" id="5590171">.</span><span class="ident" id="5590172">X</span><span class="op" id="5590173">)</span>&nbsp;<span class="op" id="5590175">*</span>&nbsp;<span class="num" id="5590177">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590180">x1</span>&nbsp;<span class="op" id="5590183">:=</span>&nbsp;<span class="op" id="5590186">(</span><span class="ident" id="5590187">r</span><span class="op" id="5590188">.</span><span class="ident" id="5590189">Max</span><span class="op" id="5590192">.</span><span class="ident" id="5590193">X</span>&nbsp;<span class="op" id="5590195">-</span>&nbsp;<span class="ident" id="5590197">dst</span><span class="op" id="5590200">.</span><span class="ident" id="5590201">Rect</span><span class="op" id="5590205">.</span><span class="ident" id="5590206">Min</span><span class="op" id="5590209">.</span><span class="ident" id="5590210">X</span><span class="op" id="5590211">)</span>&nbsp;<span class="op" id="5590213">*</span>&nbsp;<span class="num" id="5590215">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590218">y0</span>&nbsp;<span class="op" id="5590221">:=</span>&nbsp;<span class="ident" id="5590224">r</span><span class="op" id="5590225">.</span><span class="ident" id="5590226">Min</span><span class="op" id="5590229">.</span><span class="ident" id="5590230">Y</span>&nbsp;<span class="op" id="5590232">-</span>&nbsp;<span class="ident" id="5590234">dst</span><span class="op" id="5590237">.</span><span class="ident" id="5590238">Rect</span><span class="op" id="5590242">.</span><span class="ident" id="5590243">Min</span><span class="op" id="5590246">.</span><span class="ident" id="5590247">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590250">y1</span>&nbsp;<span class="op" id="5590253">:=</span>&nbsp;<span class="ident" id="5590256">r</span><span class="op" id="5590257">.</span><span class="ident" id="5590258">Max</span><span class="op" id="5590261">.</span><span class="ident" id="5590262">Y</span>&nbsp;<span class="op" id="5590264">-</span>&nbsp;<span class="ident" id="5590266">dst</span><span class="op" id="5590269">.</span><span class="ident" id="5590270">Rect</span><span class="op" id="5590274">.</span><span class="ident" id="5590275">Min</span><span class="op" id="5590278">.</span><span class="ident" id="5590279">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590282">switch</span>&nbsp;<span class="ident" id="5590289">src</span><span class="op" id="5590292">.</span><span class="ident" id="5590293">SubsampleRatio</span>&nbsp;<span class="op" id="5590308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590311">case</span>&nbsp;<span class="ident" id="5590316">image</span><span class="op" id="5590321">.</span><span class="ident" id="5590322">YCbCrSubsampleRatio444</span><span class="op" id="5590344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590348">for</span>&nbsp;<span class="ident" id="5590352">y</span><span class="op" id="5590353">,</span>&nbsp;<span class="ident" id="5590355">sy</span>&nbsp;<span class="op" id="5590358">:=</span>&nbsp;<span class="ident" id="5590361">y0</span><span class="op" id="5590363">,</span>&nbsp;<span class="ident" id="5590365">sp</span><span class="op" id="5590367">.</span><span class="ident" id="5590368">Y</span><span class="op" id="5590369">;</span>&nbsp;<span class="ident" id="5590371">y</span>&nbsp;<span class="op" id="5590373">!=</span>&nbsp;<span class="ident" id="5590376">y1</span><span class="op" id="5590378">;</span>&nbsp;<span class="ident" id="5590380">y</span><span class="op" id="5590381">,</span>&nbsp;<span class="ident" id="5590383">sy</span>&nbsp;<span class="op" id="5590386">=</span>&nbsp;<span class="ident" id="5590388">y</span><span class="op" id="5590389">+</span><span class="num" id="5590390">1</span><span class="op" id="5590391">,</span>&nbsp;<span class="ident" id="5590393">sy</span><span class="op" id="5590395">+</span><span class="num" id="5590396">1</span>&nbsp;<span class="op" id="5590398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590403">dpix</span>&nbsp;<span class="op" id="5590408">:=</span>&nbsp;<span class="ident" id="5590411">dst</span><span class="op" id="5590414">.</span><span class="ident" id="5590415">Pix</span><span class="op" id="5590418">[</span><span class="ident" id="5590419">y</span><span class="op" id="5590420">*</span><span class="ident" id="5590421">dst</span><span class="op" id="5590424">.</span><span class="ident" id="5590425">Stride</span><span class="op" id="5590431">:</span><span class="op" id="5590432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590437">yi</span>&nbsp;<span class="op" id="5590440">:=</span>&nbsp;<span class="op" id="5590443">(</span><span class="ident" id="5590444">sy</span><span class="op" id="5590446">-</span><span class="ident" id="5590447">src</span><span class="op" id="5590450">.</span><span class="ident" id="5590451">Rect</span><span class="op" id="5590455">.</span><span class="ident" id="5590456">Min</span><span class="op" id="5590459">.</span><span class="ident" id="5590460">Y</span><span class="op" id="5590461">)</span><span class="op" id="5590462">*</span><span class="ident" id="5590463">src</span><span class="op" id="5590466">.</span><span class="ident" id="5590467">YStride</span>&nbsp;<span class="op" id="5590475">+</span>&nbsp;<span class="op" id="5590477">(</span><span class="ident" id="5590478">sp</span><span class="op" id="5590480">.</span><span class="ident" id="5590481">X</span>&nbsp;<span class="op" id="5590483">-</span>&nbsp;<span class="ident" id="5590485">src</span><span class="op" id="5590488">.</span><span class="ident" id="5590489">Rect</span><span class="op" id="5590493">.</span><span class="ident" id="5590494">Min</span><span class="op" id="5590497">.</span><span class="ident" id="5590498">X</span><span class="op" id="5590499">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590504">ci</span>&nbsp;<span class="op" id="5590507">:=</span>&nbsp;<span class="op" id="5590510">(</span><span class="ident" id="5590511">sy</span><span class="op" id="5590513">-</span><span class="ident" id="5590514">src</span><span class="op" id="5590517">.</span><span class="ident" id="5590518">Rect</span><span class="op" id="5590522">.</span><span class="ident" id="5590523">Min</span><span class="op" id="5590526">.</span><span class="ident" id="5590527">Y</span><span class="op" id="5590528">)</span><span class="op" id="5590529">*</span><span class="ident" id="5590530">src</span><span class="op" id="5590533">.</span><span class="ident" id="5590534">CStride</span>&nbsp;<span class="op" id="5590542">+</span>&nbsp;<span class="op" id="5590544">(</span><span class="ident" id="5590545">sp</span><span class="op" id="5590547">.</span><span class="ident" id="5590548">X</span>&nbsp;<span class="op" id="5590550">-</span>&nbsp;<span class="ident" id="5590552">src</span><span class="op" id="5590555">.</span><span class="ident" id="5590556">Rect</span><span class="op" id="5590560">.</span><span class="ident" id="5590561">Min</span><span class="op" id="5590564">.</span><span class="ident" id="5590565">X</span><span class="op" id="5590566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590571">for</span>&nbsp;<span class="ident" id="5590575">x</span>&nbsp;<span class="op" id="5590577">:=</span>&nbsp;<span class="ident" id="5590580">x0</span><span class="op" id="5590582">;</span>&nbsp;<span class="ident" id="5590584">x</span>&nbsp;<span class="op" id="5590586">!=</span>&nbsp;<span class="ident" id="5590589">x1</span><span class="op" id="5590591">;</span>&nbsp;<span class="ident" id="5590593">x</span><span class="op" id="5590594">,</span>&nbsp;<span class="ident" id="5590596">yi</span><span class="op" id="5590598">,</span>&nbsp;<span class="ident" id="5590600">ci</span>&nbsp;<span class="op" id="5590603">=</span>&nbsp;<span class="ident" id="5590605">x</span><span class="op" id="5590606">+</span><span class="num" id="5590607">4</span><span class="op" id="5590608">,</span>&nbsp;<span class="ident" id="5590610">yi</span><span class="op" id="5590612">+</span><span class="num" id="5590613">1</span><span class="op" id="5590614">,</span>&nbsp;<span class="ident" id="5590616">ci</span><span class="op" id="5590618">+</span><span class="num" id="5590619">1</span>&nbsp;<span class="op" id="5590621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590627">rr</span><span class="op" id="5590629">,</span>&nbsp;<span class="ident" id="5590631">gg</span><span class="op" id="5590633">,</span>&nbsp;<span class="ident" id="5590635">bb</span>&nbsp;<span class="op" id="5590638">:=</span>&nbsp;<span class="ident" id="5590641">color</span><span class="op" id="5590646">.</span><span class="ident" id="5590647">YCbCrToRGB</span><span class="op" id="5590657">(</span><span class="ident" id="5590658">src</span><span class="op" id="5590661">.</span><span class="ident" id="5590662">Y</span><span class="op" id="5590663">[</span><span class="ident" id="5590664">yi</span><span class="op" id="5590666">]</span><span class="op" id="5590667">,</span>&nbsp;<span class="ident" id="5590669">src</span><span class="op" id="5590672">.</span><span class="ident" id="5590673">Cb</span><span class="op" id="5590675">[</span><span class="ident" id="5590676">ci</span><span class="op" id="5590678">]</span><span class="op" id="5590679">,</span>&nbsp;<span class="ident" id="5590681">src</span><span class="op" id="5590684">.</span><span class="ident" id="5590685">Cr</span><span class="op" id="5590687">[</span><span class="ident" id="5590688">ci</span><span class="op" id="5590690">]</span><span class="op" id="5590691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590697">dpix</span><span class="op" id="5590701">[</span><span class="ident" id="5590702">x</span><span class="op" id="5590703">+</span><span class="num" id="5590704">0</span><span class="op" id="5590705">]</span>&nbsp;<span class="op" id="5590707">=</span>&nbsp;<span class="ident" id="5590709">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590716">dpix</span><span class="op" id="5590720">[</span><span class="ident" id="5590721">x</span><span class="op" id="5590722">+</span><span class="num" id="5590723">1</span><span class="op" id="5590724">]</span>&nbsp;<span class="op" id="5590726">=</span>&nbsp;<span class="ident" id="5590728">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590735">dpix</span><span class="op" id="5590739">[</span><span class="ident" id="5590740">x</span><span class="op" id="5590741">+</span><span class="num" id="5590742">2</span><span class="op" id="5590743">]</span>&nbsp;<span class="op" id="5590745">=</span>&nbsp;<span class="ident" id="5590747">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590754">dpix</span><span class="op" id="5590758">[</span><span class="ident" id="5590759">x</span><span class="op" id="5590760">+</span><span class="num" id="5590761">3</span><span class="op" id="5590762">]</span>&nbsp;<span class="op" id="5590764">=</span>&nbsp;<span class="num" id="5590766">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5590773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5590777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590780">case</span>&nbsp;<span class="ident" id="5590785">image</span><span class="op" id="5590790">.</span><span class="ident" id="5590791">YCbCrSubsampleRatio422</span><span class="op" id="5590813">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5590817">for</span>&nbsp;<span class="ident" id="5590821">y</span><span class="op" id="5590822">,</span>&nbsp;<span class="ident" id="5590824">sy</span>&nbsp;<span class="op" id="5590827">:=</span>&nbsp;<span class="ident" id="5590830">y0</span><span class="op" id="5590832">,</span>&nbsp;<span class="ident" id="5590834">sp</span><span class="op" id="5590836">.</span><span class="ident" id="5590837">Y</span><span class="op" id="5590838">;</span>&nbsp;<span class="ident" id="5590840">y</span>&nbsp;<span class="op" id="5590842">!=</span>&nbsp;<span class="ident" id="5590845">y1</span><span class="op" id="5590847">;</span>&nbsp;<span class="ident" id="5590849">y</span><span class="op" id="5590850">,</span>&nbsp;<span class="ident" id="5590852">sy</span>&nbsp;<span class="op" id="5590855">=</span>&nbsp;<span class="ident" id="5590857">y</span><span class="op" id="5590858">+</span><span class="num" id="5590859">1</span><span class="op" id="5590860">,</span>&nbsp;<span class="ident" id="5590862">sy</span><span class="op" id="5590864">+</span><span class="num" id="5590865">1</span>&nbsp;<span class="op" id="5590867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590872">dpix</span>&nbsp;<span class="op" id="5590877">:=</span>&nbsp;<span class="ident" id="5590880">dst</span><span class="op" id="5590883">.</span><span class="ident" id="5590884">Pix</span><span class="op" id="5590887">[</span><span class="ident" id="5590888">y</span><span class="op" id="5590889">*</span><span class="ident" id="5590890">dst</span><span class="op" id="5590893">.</span><span class="ident" id="5590894">Stride</span><span class="op" id="5590900">:</span><span class="op" id="5590901">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590906">yi</span>&nbsp;<span class="op" id="5590909">:=</span>&nbsp;<span class="op" id="5590912">(</span><span class="ident" id="5590913">sy</span><span class="op" id="5590915">-</span><span class="ident" id="5590916">src</span><span class="op" id="5590919">.</span><span class="ident" id="5590920">Rect</span><span class="op" id="5590924">.</span><span class="ident" id="5590925">Min</span><span class="op" id="5590928">.</span><span class="ident" id="5590929">Y</span><span class="op" id="5590930">)</span><span class="op" id="5590931">*</span><span class="ident" id="5590932">src</span><span class="op" id="5590935">.</span><span class="ident" id="5590936">YStride</span>&nbsp;<span class="op" id="5590944">+</span>&nbsp;<span class="op" id="5590946">(</span><span class="ident" id="5590947">sp</span><span class="op" id="5590949">.</span><span class="ident" id="5590950">X</span>&nbsp;<span class="op" id="5590952">-</span>&nbsp;<span class="ident" id="5590954">src</span><span class="op" id="5590957">.</span><span class="ident" id="5590958">Rect</span><span class="op" id="5590962">.</span><span class="ident" id="5590963">Min</span><span class="op" id="5590966">.</span><span class="ident" id="5590967">X</span><span class="op" id="5590968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5590973">ciBase</span>&nbsp;<span class="op" id="5590980">:=</span>&nbsp;<span class="op" id="5590983">(</span><span class="ident" id="5590984">sy</span><span class="op" id="5590986">-</span><span class="ident" id="5590987">src</span><span class="op" id="5590990">.</span><span class="ident" id="5590991">Rect</span><span class="op" id="5590995">.</span><span class="ident" id="5590996">Min</span><span class="op" id="5590999">.</span><span class="ident" id="5591000">Y</span><span class="op" id="5591001">)</span><span class="op" id="5591002">*</span><span class="ident" id="5591003">src</span><span class="op" id="5591006">.</span><span class="ident" id="5591007">CStride</span>&nbsp;<span class="op" id="5591015">-</span>&nbsp;<span class="ident" id="5591017">src</span><span class="op" id="5591020">.</span><span class="ident" id="5591021">Rect</span><span class="op" id="5591025">.</span><span class="ident" id="5591026">Min</span><span class="op" id="5591029">.</span><span class="ident" id="5591030">X</span><span class="op" id="5591031">/</span><span class="num" id="5591032">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5591037">for</span>&nbsp;<span class="ident" id="5591041">x</span><span class="op" id="5591042">,</span>&nbsp;<span class="ident" id="5591044">sx</span>&nbsp;<span class="op" id="5591047">:=</span>&nbsp;<span class="ident" id="5591050">x0</span><span class="op" id="5591052">,</span>&nbsp;<span class="ident" id="5591054">sp</span><span class="op" id="5591056">.</span><span class="ident" id="5591057">X</span><span class="op" id="5591058">;</span>&nbsp;<span class="ident" id="5591060">x</span>&nbsp;<span class="op" id="5591062">!=</span>&nbsp;<span class="ident" id="5591065">x1</span><span class="op" id="5591067">;</span>&nbsp;<span class="ident" id="5591069">x</span><span class="op" id="5591070">,</span>&nbsp;<span class="ident" id="5591072">sx</span><span class="op" id="5591074">,</span>&nbsp;<span class="ident" id="5591076">yi</span>&nbsp;<span class="op" id="5591079">=</span>&nbsp;<span class="ident" id="5591081">x</span><span class="op" id="5591082">+</span><span class="num" id="5591083">4</span><span class="op" id="5591084">,</span>&nbsp;<span class="ident" id="5591086">sx</span><span class="op" id="5591088">+</span><span class="num" id="5591089">1</span><span class="op" id="5591090">,</span>&nbsp;<span class="ident" id="5591092">yi</span><span class="op" id="5591094">+</span><span class="num" id="5591095">1</span>&nbsp;<span class="op" id="5591097">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591103">ci</span>&nbsp;<span class="op" id="5591106">:=</span>&nbsp;<span class="ident" id="5591109">ciBase</span>&nbsp;<span class="op" id="5591116">+</span>&nbsp;<span class="ident" id="5591118">sx</span><span class="op" id="5591120">/</span><span class="num" id="5591121">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591127">rr</span><span class="op" id="5591129">,</span>&nbsp;<span class="ident" id="5591131">gg</span><span class="op" id="5591133">,</span>&nbsp;<span class="ident" id="5591135">bb</span>&nbsp;<span class="op" id="5591138">:=</span>&nbsp;<span class="ident" id="5591141">color</span><span class="op" id="5591146">.</span><span class="ident" id="5591147">YCbCrToRGB</span><span class="op" id="5591157">(</span><span class="ident" id="5591158">src</span><span class="op" id="5591161">.</span><span class="ident" id="5591162">Y</span><span class="op" id="5591163">[</span><span class="ident" id="5591164">yi</span><span class="op" id="5591166">]</span><span class="op" id="5591167">,</span>&nbsp;<span class="ident" id="5591169">src</span><span class="op" id="5591172">.</span><span class="ident" id="5591173">Cb</span><span class="op" id="5591175">[</span><span class="ident" id="5591176">ci</span><span class="op" id="5591178">]</span><span class="op" id="5591179">,</span>&nbsp;<span class="ident" id="5591181">src</span><span class="op" id="5591184">.</span><span class="ident" id="5591185">Cr</span><span class="op" id="5591187">[</span><span class="ident" id="5591188">ci</span><span class="op" id="5591190">]</span><span class="op" id="5591191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591197">dpix</span><span class="op" id="5591201">[</span><span class="ident" id="5591202">x</span><span class="op" id="5591203">+</span><span class="num" id="5591204">0</span><span class="op" id="5591205">]</span>&nbsp;<span class="op" id="5591207">=</span>&nbsp;<span class="ident" id="5591209">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591216">dpix</span><span class="op" id="5591220">[</span><span class="ident" id="5591221">x</span><span class="op" id="5591222">+</span><span class="num" id="5591223">1</span><span class="op" id="5591224">]</span>&nbsp;<span class="op" id="5591226">=</span>&nbsp;<span class="ident" id="5591228">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591235">dpix</span><span class="op" id="5591239">[</span><span class="ident" id="5591240">x</span><span class="op" id="5591241">+</span><span class="num" id="5591242">2</span><span class="op" id="5591243">]</span>&nbsp;<span class="op" id="5591245">=</span>&nbsp;<span class="ident" id="5591247">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591254">dpix</span><span class="op" id="5591258">[</span><span class="ident" id="5591259">x</span><span class="op" id="5591260">+</span><span class="num" id="5591261">3</span><span class="op" id="5591262">]</span>&nbsp;<span class="op" id="5591264">=</span>&nbsp;<span class="num" id="5591266">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5591273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5591277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5591280">case</span>&nbsp;<span class="ident" id="5591285">image</span><span class="op" id="5591290">.</span><span class="ident" id="5591291">YCbCrSubsampleRatio420</span><span class="op" id="5591313">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5591317">for</span>&nbsp;<span class="ident" id="5591321">y</span><span class="op" id="5591322">,</span>&nbsp;<span class="ident" id="5591324">sy</span>&nbsp;<span class="op" id="5591327">:=</span>&nbsp;<span class="ident" id="5591330">y0</span><span class="op" id="5591332">,</span>&nbsp;<span class="ident" id="5591334">sp</span><span class="op" id="5591336">.</span><span class="ident" id="5591337">Y</span><span class="op" id="5591338">;</span>&nbsp;<span class="ident" id="5591340">y</span>&nbsp;<span class="op" id="5591342">!=</span>&nbsp;<span class="ident" id="5591345">y1</span><span class="op" id="5591347">;</span>&nbsp;<span class="ident" id="5591349">y</span><span class="op" id="5591350">,</span>&nbsp;<span class="ident" id="5591352">sy</span>&nbsp;<span class="op" id="5591355">=</span>&nbsp;<span class="ident" id="5591357">y</span><span class="op" id="5591358">+</span><span class="num" id="5591359">1</span><span class="op" id="5591360">,</span>&nbsp;<span class="ident" id="5591362">sy</span><span class="op" id="5591364">+</span><span class="num" id="5591365">1</span>&nbsp;<span class="op" id="5591367">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591372">dpix</span>&nbsp;<span class="op" id="5591377">:=</span>&nbsp;<span class="ident" id="5591380">dst</span><span class="op" id="5591383">.</span><span class="ident" id="5591384">Pix</span><span class="op" id="5591387">[</span><span class="ident" id="5591388">y</span><span class="op" id="5591389">*</span><span class="ident" id="5591390">dst</span><span class="op" id="5591393">.</span><span class="ident" id="5591394">Stride</span><span class="op" id="5591400">:</span><span class="op" id="5591401">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591406">yi</span>&nbsp;<span class="op" id="5591409">:=</span>&nbsp;<span class="op" id="5591412">(</span><span class="ident" id="5591413">sy</span><span class="op" id="5591415">-</span><span class="ident" id="5591416">src</span><span class="op" id="5591419">.</span><span class="ident" id="5591420">Rect</span><span class="op" id="5591424">.</span><span class="ident" id="5591425">Min</span><span class="op" id="5591428">.</span><span class="ident" id="5591429">Y</span><span class="op" id="5591430">)</span><span class="op" id="5591431">*</span><span class="ident" id="5591432">src</span><span class="op" id="5591435">.</span><span class="ident" id="5591436">YStride</span>&nbsp;<span class="op" id="5591444">+</span>&nbsp;<span class="op" id="5591446">(</span><span class="ident" id="5591447">sp</span><span class="op" id="5591449">.</span><span class="ident" id="5591450">X</span>&nbsp;<span class="op" id="5591452">-</span>&nbsp;<span class="ident" id="5591454">src</span><span class="op" id="5591457">.</span><span class="ident" id="5591458">Rect</span><span class="op" id="5591462">.</span><span class="ident" id="5591463">Min</span><span class="op" id="5591466">.</span><span class="ident" id="5591467">X</span><span class="op" id="5591468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591473">ciBase</span>&nbsp;<span class="op" id="5591480">:=</span>&nbsp;<span class="op" id="5591483">(</span><span class="ident" id="5591484">sy</span><span class="op" id="5591486">/</span><span class="num" id="5591487">2</span><span class="op" id="5591488">-</span><span class="ident" id="5591489">src</span><span class="op" id="5591492">.</span><span class="ident" id="5591493">Rect</span><span class="op" id="5591497">.</span><span class="ident" id="5591498">Min</span><span class="op" id="5591501">.</span><span class="ident" id="5591502">Y</span><span class="op" id="5591503">/</span><span class="num" id="5591504">2</span><span class="op" id="5591505">)</span><span class="op" id="5591506">*</span><span class="ident" id="5591507">src</span><span class="op" id="5591510">.</span><span class="ident" id="5591511">CStride</span>&nbsp;<span class="op" id="5591519">-</span>&nbsp;<span class="ident" id="5591521">src</span><span class="op" id="5591524">.</span><span class="ident" id="5591525">Rect</span><span class="op" id="5591529">.</span><span class="ident" id="5591530">Min</span><span class="op" id="5591533">.</span><span class="ident" id="5591534">X</span><span class="op" id="5591535">/</span><span class="num" id="5591536">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5591541">for</span>&nbsp;<span class="ident" id="5591545">x</span><span class="op" id="5591546">,</span>&nbsp;<span class="ident" id="5591548">sx</span>&nbsp;<span class="op" id="5591551">:=</span>&nbsp;<span class="ident" id="5591554">x0</span><span class="op" id="5591556">,</span>&nbsp;<span class="ident" id="5591558">sp</span><span class="op" id="5591560">.</span><span class="ident" id="5591561">X</span><span class="op" id="5591562">;</span>&nbsp;<span class="ident" id="5591564">x</span>&nbsp;<span class="op" id="5591566">!=</span>&nbsp;<span class="ident" id="5591569">x1</span><span class="op" id="5591571">;</span>&nbsp;<span class="ident" id="5591573">x</span><span class="op" id="5591574">,</span>&nbsp;<span class="ident" id="5591576">sx</span><span class="op" id="5591578">,</span>&nbsp;<span class="ident" id="5591580">yi</span>&nbsp;<span class="op" id="5591583">=</span>&nbsp;<span class="ident" id="5591585">x</span><span class="op" id="5591586">+</span><span class="num" id="5591587">4</span><span class="op" id="5591588">,</span>&nbsp;<span class="ident" id="5591590">sx</span><span class="op" id="5591592">+</span><span class="num" id="5591593">1</span><span class="op" id="5591594">,</span>&nbsp;<span class="ident" id="5591596">yi</span><span class="op" id="5591598">+</span><span class="num" id="5591599">1</span>&nbsp;<span class="op" id="5591601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591607">ci</span>&nbsp;<span class="op" id="5591610">:=</span>&nbsp;<span class="ident" id="5591613">ciBase</span>&nbsp;<span class="op" id="5591620">+</span>&nbsp;<span class="ident" id="5591622">sx</span><span class="op" id="5591624">/</span><span class="num" id="5591625">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591631">rr</span><span class="op" id="5591633">,</span>&nbsp;<span class="ident" id="5591635">gg</span><span class="op" id="5591637">,</span>&nbsp;<span class="ident" id="5591639">bb</span>&nbsp;<span class="op" id="5591642">:=</span>&nbsp;<span class="ident" id="5591645">color</span><span class="op" id="5591650">.</span><span class="ident" id="5591651">YCbCrToRGB</span><span class="op" id="5591661">(</span><span class="ident" id="5591662">src</span><span class="op" id="5591665">.</span><span class="ident" id="5591666">Y</span><span class="op" id="5591667">[</span><span class="ident" id="5591668">yi</span><span class="op" id="5591670">]</span><span class="op" id="5591671">,</span>&nbsp;<span class="ident" id="5591673">src</span><span class="op" id="5591676">.</span><span class="ident" id="5591677">Cb</span><span class="op" id="5591679">[</span><span class="ident" id="5591680">ci</span><span class="op" id="5591682">]</span><span class="op" id="5591683">,</span>&nbsp;<span class="ident" id="5591685">src</span><span class="op" id="5591688">.</span><span class="ident" id="5591689">Cr</span><span class="op" id="5591691">[</span><span class="ident" id="5591692">ci</span><span class="op" id="5591694">]</span><span class="op" id="5591695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591701">dpix</span><span class="op" id="5591705">[</span><span class="ident" id="5591706">x</span><span class="op" id="5591707">+</span><span class="num" id="5591708">0</span><span class="op" id="5591709">]</span>&nbsp;<span class="op" id="5591711">=</span>&nbsp;<span class="ident" id="5591713">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591720">dpix</span><span class="op" id="5591724">[</span><span class="ident" id="5591725">x</span><span class="op" id="5591726">+</span><span class="num" id="5591727">1</span><span class="op" id="5591728">]</span>&nbsp;<span class="op" id="5591730">=</span>&nbsp;<span class="ident" id="5591732">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591739">dpix</span><span class="op" id="5591743">[</span><span class="ident" id="5591744">x</span><span class="op" id="5591745">+</span><span class="num" id="5591746">2</span><span class="op" id="5591747">]</span>&nbsp;<span class="op" id="5591749">=</span>&nbsp;<span class="ident" id="5591751">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591758">dpix</span><span class="op" id="5591762">[</span><span class="ident" id="5591763">x</span><span class="op" id="5591764">+</span><span class="num" id="5591765">3</span><span class="op" id="5591766">]</span>&nbsp;<span class="op" id="5591768">=</span>&nbsp;<span class="num" id="5591770">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5591777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5591781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5591784">case</span>&nbsp;<span class="ident" id="5591789">image</span><span class="op" id="5591794">.</span><span class="ident" id="5591795">YCbCrSubsampleRatio440</span><span class="op" id="5591817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5591821">for</span>&nbsp;<span class="ident" id="5591825">y</span><span class="op" id="5591826">,</span>&nbsp;<span class="ident" id="5591828">sy</span>&nbsp;<span class="op" id="5591831">:=</span>&nbsp;<span class="ident" id="5591834">y0</span><span class="op" id="5591836">,</span>&nbsp;<span class="ident" id="5591838">sp</span><span class="op" id="5591840">.</span><span class="ident" id="5591841">Y</span><span class="op" id="5591842">;</span>&nbsp;<span class="ident" id="5591844">y</span>&nbsp;<span class="op" id="5591846">!=</span>&nbsp;<span class="ident" id="5591849">y1</span><span class="op" id="5591851">;</span>&nbsp;<span class="ident" id="5591853">y</span><span class="op" id="5591854">,</span>&nbsp;<span class="ident" id="5591856">sy</span>&nbsp;<span class="op" id="5591859">=</span>&nbsp;<span class="ident" id="5591861">y</span><span class="op" id="5591862">+</span><span class="num" id="5591863">1</span><span class="op" id="5591864">,</span>&nbsp;<span class="ident" id="5591866">sy</span><span class="op" id="5591868">+</span><span class="num" id="5591869">1</span>&nbsp;<span class="op" id="5591871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591876">dpix</span>&nbsp;<span class="op" id="5591881">:=</span>&nbsp;<span class="ident" id="5591884">dst</span><span class="op" id="5591887">.</span><span class="ident" id="5591888">Pix</span><span class="op" id="5591891">[</span><span class="ident" id="5591892">y</span><span class="op" id="5591893">*</span><span class="ident" id="5591894">dst</span><span class="op" id="5591897">.</span><span class="ident" id="5591898">Stride</span><span class="op" id="5591904">:</span><span class="op" id="5591905">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591910">yi</span>&nbsp;<span class="op" id="5591913">:=</span>&nbsp;<span class="op" id="5591916">(</span><span class="ident" id="5591917">sy</span><span class="op" id="5591919">-</span><span class="ident" id="5591920">src</span><span class="op" id="5591923">.</span><span class="ident" id="5591924">Rect</span><span class="op" id="5591928">.</span><span class="ident" id="5591929">Min</span><span class="op" id="5591932">.</span><span class="ident" id="5591933">Y</span><span class="op" id="5591934">)</span><span class="op" id="5591935">*</span><span class="ident" id="5591936">src</span><span class="op" id="5591939">.</span><span class="ident" id="5591940">YStride</span>&nbsp;<span class="op" id="5591948">+</span>&nbsp;<span class="op" id="5591950">(</span><span class="ident" id="5591951">sp</span><span class="op" id="5591953">.</span><span class="ident" id="5591954">X</span>&nbsp;<span class="op" id="5591956">-</span>&nbsp;<span class="ident" id="5591958">src</span><span class="op" id="5591961">.</span><span class="ident" id="5591962">Rect</span><span class="op" id="5591966">.</span><span class="ident" id="5591967">Min</span><span class="op" id="5591970">.</span><span class="ident" id="5591971">X</span><span class="op" id="5591972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5591977">ci</span>&nbsp;<span class="op" id="5591980">:=</span>&nbsp;<span class="op" id="5591983">(</span><span class="ident" id="5591984">sy</span><span class="op" id="5591986">/</span><span class="num" id="5591987">2</span><span class="op" id="5591988">-</span><span class="ident" id="5591989">src</span><span class="op" id="5591992">.</span><span class="ident" id="5591993">Rect</span><span class="op" id="5591997">.</span><span class="ident" id="5591998">Min</span><span class="op" id="5592001">.</span><span class="ident" id="5592002">Y</span><span class="op" id="5592003">/</span><span class="num" id="5592004">2</span><span class="op" id="5592005">)</span><span class="op" id="5592006">*</span><span class="ident" id="5592007">src</span><span class="op" id="5592010">.</span><span class="ident" id="5592011">CStride</span>&nbsp;<span class="op" id="5592019">+</span>&nbsp;<span class="op" id="5592021">(</span><span class="ident" id="5592022">sp</span><span class="op" id="5592024">.</span><span class="ident" id="5592025">X</span>&nbsp;<span class="op" id="5592027">-</span>&nbsp;<span class="ident" id="5592029">src</span><span class="op" id="5592032">.</span><span class="ident" id="5592033">Rect</span><span class="op" id="5592037">.</span><span class="ident" id="5592038">Min</span><span class="op" id="5592041">.</span><span class="ident" id="5592042">X</span><span class="op" id="5592043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592048">for</span>&nbsp;<span class="ident" id="5592052">x</span>&nbsp;<span class="op" id="5592054">:=</span>&nbsp;<span class="ident" id="5592057">x0</span><span class="op" id="5592059">;</span>&nbsp;<span class="ident" id="5592061">x</span>&nbsp;<span class="op" id="5592063">!=</span>&nbsp;<span class="ident" id="5592066">x1</span><span class="op" id="5592068">;</span>&nbsp;<span class="ident" id="5592070">x</span><span class="op" id="5592071">,</span>&nbsp;<span class="ident" id="5592073">yi</span><span class="op" id="5592075">,</span>&nbsp;<span class="ident" id="5592077">ci</span>&nbsp;<span class="op" id="5592080">=</span>&nbsp;<span class="ident" id="5592082">x</span><span class="op" id="5592083">+</span><span class="num" id="5592084">4</span><span class="op" id="5592085">,</span>&nbsp;<span class="ident" id="5592087">yi</span><span class="op" id="5592089">+</span><span class="num" id="5592090">1</span><span class="op" id="5592091">,</span>&nbsp;<span class="ident" id="5592093">ci</span><span class="op" id="5592095">+</span><span class="num" id="5592096">1</span>&nbsp;<span class="op" id="5592098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592104">rr</span><span class="op" id="5592106">,</span>&nbsp;<span class="ident" id="5592108">gg</span><span class="op" id="5592110">,</span>&nbsp;<span class="ident" id="5592112">bb</span>&nbsp;<span class="op" id="5592115">:=</span>&nbsp;<span class="ident" id="5592118">color</span><span class="op" id="5592123">.</span><span class="ident" id="5592124">YCbCrToRGB</span><span class="op" id="5592134">(</span><span class="ident" id="5592135">src</span><span class="op" id="5592138">.</span><span class="ident" id="5592139">Y</span><span class="op" id="5592140">[</span><span class="ident" id="5592141">yi</span><span class="op" id="5592143">]</span><span class="op" id="5592144">,</span>&nbsp;<span class="ident" id="5592146">src</span><span class="op" id="5592149">.</span><span class="ident" id="5592150">Cb</span><span class="op" id="5592152">[</span><span class="ident" id="5592153">ci</span><span class="op" id="5592155">]</span><span class="op" id="5592156">,</span>&nbsp;<span class="ident" id="5592158">src</span><span class="op" id="5592161">.</span><span class="ident" id="5592162">Cr</span><span class="op" id="5592164">[</span><span class="ident" id="5592165">ci</span><span class="op" id="5592167">]</span><span class="op" id="5592168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592174">dpix</span><span class="op" id="5592178">[</span><span class="ident" id="5592179">x</span><span class="op" id="5592180">+</span><span class="num" id="5592181">0</span><span class="op" id="5592182">]</span>&nbsp;<span class="op" id="5592184">=</span>&nbsp;<span class="ident" id="5592186">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592193">dpix</span><span class="op" id="5592197">[</span><span class="ident" id="5592198">x</span><span class="op" id="5592199">+</span><span class="num" id="5592200">1</span><span class="op" id="5592201">]</span>&nbsp;<span class="op" id="5592203">=</span>&nbsp;<span class="ident" id="5592205">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592212">dpix</span><span class="op" id="5592216">[</span><span class="ident" id="5592217">x</span><span class="op" id="5592218">+</span><span class="num" id="5592219">2</span><span class="op" id="5592220">]</span>&nbsp;<span class="op" id="5592222">=</span>&nbsp;<span class="ident" id="5592224">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592231">dpix</span><span class="op" id="5592235">[</span><span class="ident" id="5592236">x</span><span class="op" id="5592237">+</span><span class="num" id="5592238">3</span><span class="op" id="5592239">]</span>&nbsp;<span class="op" id="5592241">=</span>&nbsp;<span class="num" id="5592243">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5592250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5592254">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592257">default</span><span class="op" id="5592264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592268">return</span>&nbsp;<span class="ident" id="5592275">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5592282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592285">return</span>&nbsp;<span class="ident" id="5592292">true</span><br>
<span class="lineno"></span><span class="op" id="5592297">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5592300">func</span>&nbsp;<span class="ident" id="5592305">drawGlyphOver</span><span class="op" id="5592318">(</span><span class="ident" id="5592319">dst</span>&nbsp;<span class="op" id="5592323">*</span><span class="ident" id="5592324">image</span><span class="op" id="5592329">.</span><span class="ident" id="5592330">RGBA</span><span class="op" id="5592334">,</span>&nbsp;<span class="ident" id="5592336">r</span>&nbsp;<span class="ident" id="5592338">image</span><span class="op" id="5592343">.</span><span class="ident" id="5592344">Rectangle</span><span class="op" id="5592353">,</span>&nbsp;<span class="ident" id="5592355">src</span>&nbsp;<span class="op" id="5592359">*</span><span class="ident" id="5592360">image</span><span class="op" id="5592365">.</span><span class="ident" id="5592366">Uniform</span><span class="op" id="5592373">,</span>&nbsp;<span class="ident" id="5592375">mask</span>&nbsp;<span class="op" id="5592380">*</span><span class="ident" id="5592381">image</span><span class="op" id="5592386">.</span><span class="ident" id="5592387">Alpha</span><span class="op" id="5592392">,</span>&nbsp;<span class="ident" id="5592394">mp</span>&nbsp;<span class="ident" id="5592397">image</span><span class="op" id="5592402">.</span><span class="ident" id="5592403">Point</span><span class="op" id="5592408">)</span>&nbsp;<span class="op" id="5592410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592413">i0</span>&nbsp;<span class="op" id="5592416">:=</span>&nbsp;<span class="ident" id="5592419">dst</span><span class="op" id="5592422">.</span><span class="ident" id="5592423">PixOffset</span><span class="op" id="5592432">(</span><span class="ident" id="5592433">r</span><span class="op" id="5592434">.</span><span class="ident" id="5592435">Min</span><span class="op" id="5592438">.</span><span class="ident" id="5592439">X</span><span class="op" id="5592440">,</span>&nbsp;<span class="ident" id="5592442">r</span><span class="op" id="5592443">.</span><span class="ident" id="5592444">Min</span><span class="op" id="5592447">.</span><span class="ident" id="5592448">Y</span><span class="op" id="5592449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592452">i1</span>&nbsp;<span class="op" id="5592455">:=</span>&nbsp;<span class="ident" id="5592458">i0</span>&nbsp;<span class="op" id="5592461">+</span>&nbsp;<span class="ident" id="5592463">r</span><span class="op" id="5592464">.</span><span class="ident" id="5592465">Dx</span><span class="op" id="5592467">(</span><span class="op" id="5592468">)</span><span class="op" id="5592469">*</span><span class="num" id="5592470">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592473">mi0</span>&nbsp;<span class="op" id="5592477">:=</span>&nbsp;<span class="ident" id="5592480">mask</span><span class="op" id="5592484">.</span><span class="ident" id="5592485">PixOffset</span><span class="op" id="5592494">(</span><span class="ident" id="5592495">mp</span><span class="op" id="5592497">.</span><span class="ident" id="5592498">X</span><span class="op" id="5592499">,</span>&nbsp;<span class="ident" id="5592501">mp</span><span class="op" id="5592503">.</span><span class="ident" id="5592504">Y</span><span class="op" id="5592505">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592508">sr</span><span class="op" id="5592510">,</span>&nbsp;<span class="ident" id="5592512">sg</span><span class="op" id="5592514">,</span>&nbsp;<span class="ident" id="5592516">sb</span><span class="op" id="5592518">,</span>&nbsp;<span class="ident" id="5592520">sa</span>&nbsp;<span class="op" id="5592523">:=</span>&nbsp;<span class="ident" id="5592526">src</span><span class="op" id="5592529">.</span><span class="ident" id="5592530">RGBA</span><span class="op" id="5592534">(</span><span class="op" id="5592535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592538">for</span>&nbsp;<span class="ident" id="5592542">y</span><span class="op" id="5592543">,</span>&nbsp;<span class="ident" id="5592545">my</span>&nbsp;<span class="op" id="5592548">:=</span>&nbsp;<span class="ident" id="5592551">r</span><span class="op" id="5592552">.</span><span class="ident" id="5592553">Min</span><span class="op" id="5592556">.</span><span class="ident" id="5592557">Y</span><span class="op" id="5592558">,</span>&nbsp;<span class="ident" id="5592560">mp</span><span class="op" id="5592562">.</span><span class="ident" id="5592563">Y</span><span class="op" id="5592564">;</span>&nbsp;<span class="ident" id="5592566">y</span>&nbsp;<span class="op" id="5592568">!=</span>&nbsp;<span class="ident" id="5592571">r</span><span class="op" id="5592572">.</span><span class="ident" id="5592573">Max</span><span class="op" id="5592576">.</span><span class="ident" id="5592577">Y</span><span class="op" id="5592578">;</span>&nbsp;<span class="ident" id="5592580">y</span><span class="op" id="5592581">,</span>&nbsp;<span class="ident" id="5592583">my</span>&nbsp;<span class="op" id="5592586">=</span>&nbsp;<span class="ident" id="5592588">y</span><span class="op" id="5592589">+</span><span class="num" id="5592590">1</span><span class="op" id="5592591">,</span>&nbsp;<span class="ident" id="5592593">my</span><span class="op" id="5592595">+</span><span class="num" id="5592596">1</span>&nbsp;<span class="op" id="5592598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592602">for</span>&nbsp;<span class="ident" id="5592606">i</span><span class="op" id="5592607">,</span>&nbsp;<span class="ident" id="5592609">mi</span>&nbsp;<span class="op" id="5592612">:=</span>&nbsp;<span class="ident" id="5592615">i0</span><span class="op" id="5592617">,</span>&nbsp;<span class="ident" id="5592619">mi0</span><span class="op" id="5592622">;</span>&nbsp;<span class="ident" id="5592624">i</span>&nbsp;<span class="op" id="5592626">&lt;</span>&nbsp;<span class="ident" id="5592628">i1</span><span class="op" id="5592630">;</span>&nbsp;<span class="ident" id="5592632">i</span><span class="op" id="5592633">,</span>&nbsp;<span class="ident" id="5592635">mi</span>&nbsp;<span class="op" id="5592638">=</span>&nbsp;<span class="ident" id="5592640">i</span><span class="op" id="5592641">+</span><span class="num" id="5592642">4</span><span class="op" id="5592643">,</span>&nbsp;<span class="ident" id="5592645">mi</span><span class="op" id="5592647">+</span><span class="num" id="5592648">1</span>&nbsp;<span class="op" id="5592650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592655">ma</span>&nbsp;<span class="op" id="5592658">:=</span>&nbsp;<span class="builtintype" id="5592661">uint32</span><span class="op" id="5592667">(</span><span class="ident" id="5592668">mask</span><span class="op" id="5592672">.</span><span class="ident" id="5592673">Pix</span><span class="op" id="5592676">[</span><span class="ident" id="5592677">mi</span><span class="op" id="5592679">]</span><span class="op" id="5592680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592685">if</span>&nbsp;<span class="ident" id="5592688">ma</span>&nbsp;<span class="op" id="5592691">==</span>&nbsp;<span class="num" id="5592694">0</span>&nbsp;<span class="op" id="5592696">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5592702">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5592714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592719">ma</span>&nbsp;<span class="op" id="5592722">|=</span>&nbsp;<span class="ident" id="5592725">ma</span>&nbsp;<span class="op" id="5592728">&lt;&lt;</span>&nbsp;<span class="num" id="5592731">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592737">dr</span>&nbsp;<span class="op" id="5592740">:=</span>&nbsp;<span class="builtintype" id="5592743">uint32</span><span class="op" id="5592749">(</span><span class="ident" id="5592750">dst</span><span class="op" id="5592753">.</span><span class="ident" id="5592754">Pix</span><span class="op" id="5592757">[</span><span class="ident" id="5592758">i</span><span class="op" id="5592759">+</span><span class="num" id="5592760">0</span><span class="op" id="5592761">]</span><span class="op" id="5592762">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592767">dg</span>&nbsp;<span class="op" id="5592770">:=</span>&nbsp;<span class="builtintype" id="5592773">uint32</span><span class="op" id="5592779">(</span><span class="ident" id="5592780">dst</span><span class="op" id="5592783">.</span><span class="ident" id="5592784">Pix</span><span class="op" id="5592787">[</span><span class="ident" id="5592788">i</span><span class="op" id="5592789">+</span><span class="num" id="5592790">1</span><span class="op" id="5592791">]</span><span class="op" id="5592792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592797">db</span>&nbsp;<span class="op" id="5592800">:=</span>&nbsp;<span class="builtintype" id="5592803">uint32</span><span class="op" id="5592809">(</span><span class="ident" id="5592810">dst</span><span class="op" id="5592813">.</span><span class="ident" id="5592814">Pix</span><span class="op" id="5592817">[</span><span class="ident" id="5592818">i</span><span class="op" id="5592819">+</span><span class="num" id="5592820">2</span><span class="op" id="5592821">]</span><span class="op" id="5592822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592827">da</span>&nbsp;<span class="op" id="5592830">:=</span>&nbsp;<span class="builtintype" id="5592833">uint32</span><span class="op" id="5592839">(</span><span class="ident" id="5592840">dst</span><span class="op" id="5592843">.</span><span class="ident" id="5592844">Pix</span><span class="op" id="5592847">[</span><span class="ident" id="5592848">i</span><span class="op" id="5592849">+</span><span class="num" id="5592850">3</span><span class="op" id="5592851">]</span><span class="op" id="5592852">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5592858">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592918">a</span>&nbsp;<span class="op" id="5592920">:=</span>&nbsp;<span class="op" id="5592923">(</span><span class="ident" id="5592924">m</span>&nbsp;<span class="op" id="5592926">-</span>&nbsp;<span class="op" id="5592928">(</span><span class="ident" id="5592929">sa</span>&nbsp;<span class="op" id="5592932">*</span>&nbsp;<span class="ident" id="5592934">ma</span>&nbsp;<span class="op" id="5592937">/</span>&nbsp;<span class="ident" id="5592939">m</span><span class="op" id="5592940">)</span><span class="op" id="5592941">)</span>&nbsp;<span class="op" id="5592943">*</span>&nbsp;<span class="num" id="5592945">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5592955">dst</span><span class="op" id="5592958">.</span><span class="ident" id="5592959">Pix</span><span class="op" id="5592962">[</span><span class="ident" id="5592963">i</span><span class="op" id="5592964">+</span><span class="num" id="5592965">0</span><span class="op" id="5592966">]</span>&nbsp;<span class="op" id="5592968">=</span>&nbsp;<span class="builtintype" id="5592970">uint8</span><span class="op" id="5592975">(</span><span class="op" id="5592976">(</span><span class="ident" id="5592977">dr</span><span class="op" id="5592979">*</span><span class="ident" id="5592980">a</span>&nbsp;<span class="op" id="5592982">+</span>&nbsp;<span class="ident" id="5592984">sr</span><span class="op" id="5592986">*</span><span class="ident" id="5592987">ma</span><span class="op" id="5592989">)</span>&nbsp;<span class="op" id="5592991">/</span>&nbsp;<span class="ident" id="5592993">m</span>&nbsp;<span class="op" id="5592995">&gt;&gt;</span>&nbsp;<span class="num" id="5592998">8</span><span class="op" id="5592999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593004">dst</span><span class="op" id="5593007">.</span><span class="ident" id="5593008">Pix</span><span class="op" id="5593011">[</span><span class="ident" id="5593012">i</span><span class="op" id="5593013">+</span><span class="num" id="5593014">1</span><span class="op" id="5593015">]</span>&nbsp;<span class="op" id="5593017">=</span>&nbsp;<span class="builtintype" id="5593019">uint8</span><span class="op" id="5593024">(</span><span class="op" id="5593025">(</span><span class="ident" id="5593026">dg</span><span class="op" id="5593028">*</span><span class="ident" id="5593029">a</span>&nbsp;<span class="op" id="5593031">+</span>&nbsp;<span class="ident" id="5593033">sg</span><span class="op" id="5593035">*</span><span class="ident" id="5593036">ma</span><span class="op" id="5593038">)</span>&nbsp;<span class="op" id="5593040">/</span>&nbsp;<span class="ident" id="5593042">m</span>&nbsp;<span class="op" id="5593044">&gt;&gt;</span>&nbsp;<span class="num" id="5593047">8</span><span class="op" id="5593048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593053">dst</span><span class="op" id="5593056">.</span><span class="ident" id="5593057">Pix</span><span class="op" id="5593060">[</span><span class="ident" id="5593061">i</span><span class="op" id="5593062">+</span><span class="num" id="5593063">2</span><span class="op" id="5593064">]</span>&nbsp;<span class="op" id="5593066">=</span>&nbsp;<span class="builtintype" id="5593068">uint8</span><span class="op" id="5593073">(</span><span class="op" id="5593074">(</span><span class="ident" id="5593075">db</span><span class="op" id="5593077">*</span><span class="ident" id="5593078">a</span>&nbsp;<span class="op" id="5593080">+</span>&nbsp;<span class="ident" id="5593082">sb</span><span class="op" id="5593084">*</span><span class="ident" id="5593085">ma</span><span class="op" id="5593087">)</span>&nbsp;<span class="op" id="5593089">/</span>&nbsp;<span class="ident" id="5593091">m</span>&nbsp;<span class="op" id="5593093">&gt;&gt;</span>&nbsp;<span class="num" id="5593096">8</span><span class="op" id="5593097">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593102">dst</span><span class="op" id="5593105">.</span><span class="ident" id="5593106">Pix</span><span class="op" id="5593109">[</span><span class="ident" id="5593110">i</span><span class="op" id="5593111">+</span><span class="num" id="5593112">3</span><span class="op" id="5593113">]</span>&nbsp;<span class="op" id="5593115">=</span>&nbsp;<span class="builtintype" id="5593117">uint8</span><span class="op" id="5593122">(</span><span class="op" id="5593123">(</span><span class="ident" id="5593124">da</span><span class="op" id="5593126">*</span><span class="ident" id="5593127">a</span>&nbsp;<span class="op" id="5593129">+</span>&nbsp;<span class="ident" id="5593131">sa</span><span class="op" id="5593133">*</span><span class="ident" id="5593134">ma</span><span class="op" id="5593136">)</span>&nbsp;<span class="op" id="5593138">/</span>&nbsp;<span class="ident" id="5593140">m</span>&nbsp;<span class="op" id="5593142">&gt;&gt;</span>&nbsp;<span class="num" id="5593145">8</span><span class="op" id="5593146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5593150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593154">i0</span>&nbsp;<span class="op" id="5593157">+=</span>&nbsp;<span class="ident" id="5593160">dst</span><span class="op" id="5593163">.</span><span class="ident" id="5593164">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593173">i1</span>&nbsp;<span class="op" id="5593176">+=</span>&nbsp;<span class="ident" id="5593179">dst</span><span class="op" id="5593182">.</span><span class="ident" id="5593183">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593192">mi0</span>&nbsp;<span class="op" id="5593196">+=</span>&nbsp;<span class="ident" id="5593199">mask</span><span class="op" id="5593203">.</span><span class="ident" id="5593204">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5593212">}</span><br>
<span class="lineno"></span><span class="op" id="5593214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5593217">func</span>&nbsp;<span class="ident" id="5593222">drawRGBA</span><span class="op" id="5593230">(</span><span class="ident" id="5593231">dst</span>&nbsp;<span class="op" id="5593235">*</span><span class="ident" id="5593236">image</span><span class="op" id="5593241">.</span><span class="ident" id="5593242">RGBA</span><span class="op" id="5593246">,</span>&nbsp;<span class="ident" id="5593248">r</span>&nbsp;<span class="ident" id="5593250">image</span><span class="op" id="5593255">.</span><span class="ident" id="5593256">Rectangle</span><span class="op" id="5593265">,</span>&nbsp;<span class="ident" id="5593267">src</span>&nbsp;<span class="ident" id="5593271">image</span><span class="op" id="5593276">.</span><span class="ident" id="5593277">Image</span><span class="op" id="5593282">,</span>&nbsp;<span class="ident" id="5593284">sp</span>&nbsp;<span class="ident" id="5593287">image</span><span class="op" id="5593292">.</span><span class="ident" id="5593293">Point</span><span class="op" id="5593298">,</span>&nbsp;<span class="ident" id="5593300">mask</span>&nbsp;<span class="ident" id="5593305">image</span><span class="op" id="5593310">.</span><span class="ident" id="5593311">Image</span><span class="op" id="5593316">,</span>&nbsp;<span class="ident" id="5593318">mp</span>&nbsp;<span class="ident" id="5593321">image</span><span class="op" id="5593326">.</span><span class="ident" id="5593327">Point</span><span class="op" id="5593332">,</span>&nbsp;<span class="ident" id="5593334">op</span>&nbsp;<span class="ident" id="5593337">Op</span><span class="op" id="5593339">)</span>&nbsp;<span class="op" id="5593341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593344">x0</span><span class="op" id="5593346">,</span>&nbsp;<span class="ident" id="5593348">x1</span><span class="op" id="5593350">,</span>&nbsp;<span class="ident" id="5593352">dx</span>&nbsp;<span class="op" id="5593355">:=</span>&nbsp;<span class="ident" id="5593358">r</span><span class="op" id="5593359">.</span><span class="ident" id="5593360">Min</span><span class="op" id="5593363">.</span><span class="ident" id="5593364">X</span><span class="op" id="5593365">,</span>&nbsp;<span class="ident" id="5593367">r</span><span class="op" id="5593368">.</span><span class="ident" id="5593369">Max</span><span class="op" id="5593372">.</span><span class="ident" id="5593373">X</span><span class="op" id="5593374">,</span>&nbsp;<span class="num" id="5593376">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593379">y0</span><span class="op" id="5593381">,</span>&nbsp;<span class="ident" id="5593383">y1</span><span class="op" id="5593385">,</span>&nbsp;<span class="ident" id="5593387">dy</span>&nbsp;<span class="op" id="5593390">:=</span>&nbsp;<span class="ident" id="5593393">r</span><span class="op" id="5593394">.</span><span class="ident" id="5593395">Min</span><span class="op" id="5593398">.</span><span class="ident" id="5593399">Y</span><span class="op" id="5593400">,</span>&nbsp;<span class="ident" id="5593402">r</span><span class="op" id="5593403">.</span><span class="ident" id="5593404">Max</span><span class="op" id="5593407">.</span><span class="ident" id="5593408">Y</span><span class="op" id="5593409">,</span>&nbsp;<span class="num" id="5593411">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5593414">if</span>&nbsp;<span class="ident" id="5593417">image</span><span class="op" id="5593422">.</span><span class="ident" id="5593423">Image</span><span class="op" id="5593428">(</span><span class="ident" id="5593429">dst</span><span class="op" id="5593432">)</span>&nbsp;<span class="op" id="5593434">==</span>&nbsp;<span class="ident" id="5593437">src</span>&nbsp;<span class="op" id="5593441">&amp;&amp;</span>&nbsp;<span class="ident" id="5593444">r</span><span class="op" id="5593445">.</span><span class="ident" id="5593446">Overlaps</span><span class="op" id="5593454">(</span><span class="ident" id="5593455">r</span><span class="op" id="5593456">.</span><span class="ident" id="5593457">Add</span><span class="op" id="5593460">(</span><span class="ident" id="5593461">sp</span><span class="op" id="5593463">.</span><span class="ident" id="5593464">Sub</span><span class="op" id="5593467">(</span><span class="ident" id="5593468">r</span><span class="op" id="5593469">.</span><span class="ident" id="5593470">Min</span><span class="op" id="5593473">)</span><span class="op" id="5593474">)</span><span class="op" id="5593475">)</span>&nbsp;<span class="op" id="5593477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5593481">if</span>&nbsp;<span class="ident" id="5593484">sp</span><span class="op" id="5593486">.</span><span class="ident" id="5593487">Y</span>&nbsp;<span class="op" id="5593489">&lt;</span>&nbsp;<span class="ident" id="5593491">r</span><span class="op" id="5593492">.</span><span class="ident" id="5593493">Min</span><span class="op" id="5593496">.</span><span class="ident" id="5593497">Y</span>&nbsp;<span class="op" id="5593499">||</span>&nbsp;<span class="ident" id="5593502">sp</span><span class="op" id="5593504">.</span><span class="ident" id="5593505">Y</span>&nbsp;<span class="op" id="5593507">==</span>&nbsp;<span class="ident" id="5593510">r</span><span class="op" id="5593511">.</span><span class="ident" id="5593512">Min</span><span class="op" id="5593515">.</span><span class="ident" id="5593516">Y</span>&nbsp;<span class="op" id="5593518">&amp;&amp;</span>&nbsp;<span class="ident" id="5593521">sp</span><span class="op" id="5593523">.</span><span class="ident" id="5593524">X</span>&nbsp;<span class="op" id="5593526">&lt;</span>&nbsp;<span class="ident" id="5593528">r</span><span class="op" id="5593529">.</span><span class="ident" id="5593530">Min</span><span class="op" id="5593533">.</span><span class="ident" id="5593534">X</span>&nbsp;<span class="op" id="5593536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593541">x0</span><span class="op" id="5593543">,</span>&nbsp;<span class="ident" id="5593545">x1</span><span class="op" id="5593547">,</span>&nbsp;<span class="ident" id="5593549">dx</span>&nbsp;<span class="op" id="5593552">=</span>&nbsp;<span class="ident" id="5593554">x1</span><span class="op" id="5593556">-</span><span class="num" id="5593557">1</span><span class="op" id="5593558">,</span>&nbsp;<span class="ident" id="5593560">x0</span><span class="op" id="5593562">-</span><span class="num" id="5593563">1</span><span class="op" id="5593564">,</span>&nbsp;<span class="op" id="5593566">-</span><span class="num" id="5593567">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593572">y0</span><span class="op" id="5593574">,</span>&nbsp;<span class="ident" id="5593576">y1</span><span class="op" id="5593578">,</span>&nbsp;<span class="ident" id="5593580">dy</span>&nbsp;<span class="op" id="5593583">=</span>&nbsp;<span class="ident" id="5593585">y1</span><span class="op" id="5593587">-</span><span class="num" id="5593588">1</span><span class="op" id="5593589">,</span>&nbsp;<span class="ident" id="5593591">y0</span><span class="op" id="5593593">-</span><span class="num" id="5593594">1</span><span class="op" id="5593595">,</span>&nbsp;<span class="op" id="5593597">-</span><span class="num" id="5593598">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5593602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5593605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593609">sy</span>&nbsp;<span class="op" id="5593612">:=</span>&nbsp;<span class="ident" id="5593615">sp</span><span class="op" id="5593617">.</span><span class="ident" id="5593618">Y</span>&nbsp;<span class="op" id="5593620">+</span>&nbsp;<span class="ident" id="5593622">y0</span>&nbsp;<span class="op" id="5593625">-</span>&nbsp;<span class="ident" id="5593627">r</span><span class="op" id="5593628">.</span><span class="ident" id="5593629">Min</span><span class="op" id="5593632">.</span><span class="ident" id="5593633">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593636">my</span>&nbsp;<span class="op" id="5593639">:=</span>&nbsp;<span class="ident" id="5593642">mp</span><span class="op" id="5593644">.</span><span class="ident" id="5593645">Y</span>&nbsp;<span class="op" id="5593647">+</span>&nbsp;<span class="ident" id="5593649">y0</span>&nbsp;<span class="op" id="5593652">-</span>&nbsp;<span class="ident" id="5593654">r</span><span class="op" id="5593655">.</span><span class="ident" id="5593656">Min</span><span class="op" id="5593659">.</span><span class="ident" id="5593660">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593663">sx0</span>&nbsp;<span class="op" id="5593667">:=</span>&nbsp;<span class="ident" id="5593670">sp</span><span class="op" id="5593672">.</span><span class="ident" id="5593673">X</span>&nbsp;<span class="op" id="5593675">+</span>&nbsp;<span class="ident" id="5593677">x0</span>&nbsp;<span class="op" id="5593680">-</span>&nbsp;<span class="ident" id="5593682">r</span><span class="op" id="5593683">.</span><span class="ident" id="5593684">Min</span><span class="op" id="5593687">.</span><span class="ident" id="5593688">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593691">mx0</span>&nbsp;<span class="op" id="5593695">:=</span>&nbsp;<span class="ident" id="5593698">mp</span><span class="op" id="5593700">.</span><span class="ident" id="5593701">X</span>&nbsp;<span class="op" id="5593703">+</span>&nbsp;<span class="ident" id="5593705">x0</span>&nbsp;<span class="op" id="5593708">-</span>&nbsp;<span class="ident" id="5593710">r</span><span class="op" id="5593711">.</span><span class="ident" id="5593712">Min</span><span class="op" id="5593715">.</span><span class="ident" id="5593716">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593719">sx1</span>&nbsp;<span class="op" id="5593723">:=</span>&nbsp;<span class="ident" id="5593726">sx0</span>&nbsp;<span class="op" id="5593730">+</span>&nbsp;<span class="op" id="5593732">(</span><span class="ident" id="5593733">x1</span>&nbsp;<span class="op" id="5593736">-</span>&nbsp;<span class="ident" id="5593738">x0</span><span class="op" id="5593740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593743">i0</span>&nbsp;<span class="op" id="5593746">:=</span>&nbsp;<span class="ident" id="5593749">dst</span><span class="op" id="5593752">.</span><span class="ident" id="5593753">PixOffset</span><span class="op" id="5593762">(</span><span class="ident" id="5593763">x0</span><span class="op" id="5593765">,</span>&nbsp;<span class="ident" id="5593767">y0</span><span class="op" id="5593769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593772">di</span>&nbsp;<span class="op" id="5593775">:=</span>&nbsp;<span class="ident" id="5593778">dx</span>&nbsp;<span class="op" id="5593781">*</span>&nbsp;<span class="num" id="5593783">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5593786">for</span>&nbsp;<span class="ident" id="5593790">y</span>&nbsp;<span class="op" id="5593792">:=</span>&nbsp;<span class="ident" id="5593795">y0</span><span class="op" id="5593797">;</span>&nbsp;<span class="ident" id="5593799">y</span>&nbsp;<span class="op" id="5593801">!=</span>&nbsp;<span class="ident" id="5593804">y1</span><span class="op" id="5593806">;</span>&nbsp;<span class="ident" id="5593808">y</span><span class="op" id="5593809">,</span>&nbsp;<span class="ident" id="5593811">sy</span><span class="op" id="5593813">,</span>&nbsp;<span class="ident" id="5593815">my</span>&nbsp;<span class="op" id="5593818">=</span>&nbsp;<span class="ident" id="5593820">y</span><span class="op" id="5593821">+</span><span class="ident" id="5593822">dy</span><span class="op" id="5593824">,</span>&nbsp;<span class="ident" id="5593826">sy</span><span class="op" id="5593828">+</span><span class="ident" id="5593829">dy</span><span class="op" id="5593831">,</span>&nbsp;<span class="ident" id="5593833">my</span><span class="op" id="5593835">+</span><span class="ident" id="5593836">dy</span>&nbsp;<span class="op" id="5593839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5593843">for</span>&nbsp;<span class="ident" id="5593847">i</span><span class="op" id="5593848">,</span>&nbsp;<span class="ident" id="5593850">sx</span><span class="op" id="5593852">,</span>&nbsp;<span class="ident" id="5593854">mx</span>&nbsp;<span class="op" id="5593857">:=</span>&nbsp;<span class="ident" id="5593860">i0</span><span class="op" id="5593862">,</span>&nbsp;<span class="ident" id="5593864">sx0</span><span class="op" id="5593867">,</span>&nbsp;<span class="ident" id="5593869">mx0</span><span class="op" id="5593872">;</span>&nbsp;<span class="ident" id="5593874">sx</span>&nbsp;<span class="op" id="5593877">!=</span>&nbsp;<span class="ident" id="5593880">sx1</span><span class="op" id="5593883">;</span>&nbsp;<span class="ident" id="5593885">i</span><span class="op" id="5593886">,</span>&nbsp;<span class="ident" id="5593888">sx</span><span class="op" id="5593890">,</span>&nbsp;<span class="ident" id="5593892">mx</span>&nbsp;<span class="op" id="5593895">=</span>&nbsp;<span class="ident" id="5593897">i</span><span class="op" id="5593898">+</span><span class="ident" id="5593899">di</span><span class="op" id="5593901">,</span>&nbsp;<span class="ident" id="5593903">sx</span><span class="op" id="5593905">+</span><span class="ident" id="5593906">dx</span><span class="op" id="5593908">,</span>&nbsp;<span class="ident" id="5593910">mx</span><span class="op" id="5593912">+</span><span class="ident" id="5593913">dx</span>&nbsp;<span class="op" id="5593916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593921">ma</span>&nbsp;<span class="op" id="5593924">:=</span>&nbsp;<span class="builtintype" id="5593927">uint32</span><span class="op" id="5593933">(</span><span class="ident" id="5593934">m</span><span class="op" id="5593935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5593940">if</span>&nbsp;<span class="ident" id="5593943">mask</span>&nbsp;<span class="op" id="5593948">!=</span>&nbsp;<span class="ident" id="5593951">nil</span>&nbsp;<span class="op" id="5593955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5593961">_</span><span class="op" id="5593962">,</span>&nbsp;<span class="ident" id="5593964">_</span><span class="op" id="5593965">,</span>&nbsp;<span class="ident" id="5593967">_</span><span class="op" id="5593968">,</span>&nbsp;<span class="ident" id="5593970">ma</span>&nbsp;<span class="op" id="5593973">=</span>&nbsp;<span class="ident" id="5593975">mask</span><span class="op" id="5593979">.</span><span class="ident" id="5593980">At</span><span class="op" id="5593982">(</span><span class="ident" id="5593983">mx</span><span class="op" id="5593985">,</span>&nbsp;<span class="ident" id="5593987">my</span><span class="op" id="5593989">)</span><span class="op" id="5593990">.</span><span class="ident" id="5593991">RGBA</span><span class="op" id="5593995">(</span><span class="op" id="5593996">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5594001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594006">sr</span><span class="op" id="5594008">,</span>&nbsp;<span class="ident" id="5594010">sg</span><span class="op" id="5594012">,</span>&nbsp;<span class="ident" id="5594014">sb</span><span class="op" id="5594016">,</span>&nbsp;<span class="ident" id="5594018">sa</span>&nbsp;<span class="op" id="5594021">:=</span>&nbsp;<span class="ident" id="5594024">src</span><span class="op" id="5594027">.</span><span class="ident" id="5594028">At</span><span class="op" id="5594030">(</span><span class="ident" id="5594031">sx</span><span class="op" id="5594033">,</span>&nbsp;<span class="ident" id="5594035">sy</span><span class="op" id="5594037">)</span><span class="op" id="5594038">.</span><span class="ident" id="5594039">RGBA</span><span class="op" id="5594043">(</span><span class="op" id="5594044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5594049">if</span>&nbsp;<span class="ident" id="5594052">op</span>&nbsp;<span class="op" id="5594055">==</span>&nbsp;<span class="ident" id="5594058">Over</span>&nbsp;<span class="op" id="5594063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594069">dr</span>&nbsp;<span class="op" id="5594072">:=</span>&nbsp;<span class="builtintype" id="5594075">uint32</span><span class="op" id="5594081">(</span><span class="ident" id="5594082">dst</span><span class="op" id="5594085">.</span><span class="ident" id="5594086">Pix</span><span class="op" id="5594089">[</span><span class="ident" id="5594090">i</span><span class="op" id="5594091">+</span><span class="num" id="5594092">0</span><span class="op" id="5594093">]</span><span class="op" id="5594094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594100">dg</span>&nbsp;<span class="op" id="5594103">:=</span>&nbsp;<span class="builtintype" id="5594106">uint32</span><span class="op" id="5594112">(</span><span class="ident" id="5594113">dst</span><span class="op" id="5594116">.</span><span class="ident" id="5594117">Pix</span><span class="op" id="5594120">[</span><span class="ident" id="5594121">i</span><span class="op" id="5594122">+</span><span class="num" id="5594123">1</span><span class="op" id="5594124">]</span><span class="op" id="5594125">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594131">db</span>&nbsp;<span class="op" id="5594134">:=</span>&nbsp;<span class="builtintype" id="5594137">uint32</span><span class="op" id="5594143">(</span><span class="ident" id="5594144">dst</span><span class="op" id="5594147">.</span><span class="ident" id="5594148">Pix</span><span class="op" id="5594151">[</span><span class="ident" id="5594152">i</span><span class="op" id="5594153">+</span><span class="num" id="5594154">2</span><span class="op" id="5594155">]</span><span class="op" id="5594156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594162">da</span>&nbsp;<span class="op" id="5594165">:=</span>&nbsp;<span class="builtintype" id="5594168">uint32</span><span class="op" id="5594174">(</span><span class="ident" id="5594175">dst</span><span class="op" id="5594178">.</span><span class="ident" id="5594179">Pix</span><span class="op" id="5594182">[</span><span class="ident" id="5594183">i</span><span class="op" id="5594184">+</span><span class="num" id="5594185">3</span><span class="op" id="5594186">]</span><span class="op" id="5594187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594194">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594274">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594332">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594353">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594419">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5594484">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594556">a</span>&nbsp;<span class="op" id="5594558">:=</span>&nbsp;<span class="op" id="5594561">(</span><span class="ident" id="5594562">m</span>&nbsp;<span class="op" id="5594564">-</span>&nbsp;<span class="op" id="5594566">(</span><span class="ident" id="5594567">sa</span>&nbsp;<span class="op" id="5594570">*</span>&nbsp;<span class="ident" id="5594572">ma</span>&nbsp;<span class="op" id="5594575">/</span>&nbsp;<span class="ident" id="5594577">m</span><span class="op" id="5594578">)</span><span class="op" id="5594579">)</span>&nbsp;<span class="op" id="5594581">*</span>&nbsp;<span class="num" id="5594583">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594594">dst</span><span class="op" id="5594597">.</span><span class="ident" id="5594598">Pix</span><span class="op" id="5594601">[</span><span class="ident" id="5594602">i</span><span class="op" id="5594603">+</span><span class="num" id="5594604">0</span><span class="op" id="5594605">]</span>&nbsp;<span class="op" id="5594607">=</span>&nbsp;<span class="builtintype" id="5594609">uint8</span><span class="op" id="5594614">(</span><span class="op" id="5594615">(</span><span class="ident" id="5594616">dr</span><span class="op" id="5594618">*</span><span class="ident" id="5594619">a</span>&nbsp;<span class="op" id="5594621">+</span>&nbsp;<span class="ident" id="5594623">sr</span><span class="op" id="5594625">*</span><span class="ident" id="5594626">ma</span><span class="op" id="5594628">)</span>&nbsp;<span class="op" id="5594630">/</span>&nbsp;<span class="ident" id="5594632">m</span>&nbsp;<span class="op" id="5594634">&gt;&gt;</span>&nbsp;<span class="num" id="5594637">8</span><span class="op" id="5594638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594644">dst</span><span class="op" id="5594647">.</span><span class="ident" id="5594648">Pix</span><span class="op" id="5594651">[</span><span class="ident" id="5594652">i</span><span class="op" id="5594653">+</span><span class="num" id="5594654">1</span><span class="op" id="5594655">]</span>&nbsp;<span class="op" id="5594657">=</span>&nbsp;<span class="builtintype" id="5594659">uint8</span><span class="op" id="5594664">(</span><span class="op" id="5594665">(</span><span class="ident" id="5594666">dg</span><span class="op" id="5594668">*</span><span class="ident" id="5594669">a</span>&nbsp;<span class="op" id="5594671">+</span>&nbsp;<span class="ident" id="5594673">sg</span><span class="op" id="5594675">*</span><span class="ident" id="5594676">ma</span><span class="op" id="5594678">)</span>&nbsp;<span class="op" id="5594680">/</span>&nbsp;<span class="ident" id="5594682">m</span>&nbsp;<span class="op" id="5594684">&gt;&gt;</span>&nbsp;<span class="num" id="5594687">8</span><span class="op" id="5594688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594694">dst</span><span class="op" id="5594697">.</span><span class="ident" id="5594698">Pix</span><span class="op" id="5594701">[</span><span class="ident" id="5594702">i</span><span class="op" id="5594703">+</span><span class="num" id="5594704">2</span><span class="op" id="5594705">]</span>&nbsp;<span class="op" id="5594707">=</span>&nbsp;<span class="builtintype" id="5594709">uint8</span><span class="op" id="5594714">(</span><span class="op" id="5594715">(</span><span class="ident" id="5594716">db</span><span class="op" id="5594718">*</span><span class="ident" id="5594719">a</span>&nbsp;<span class="op" id="5594721">+</span>&nbsp;<span class="ident" id="5594723">sb</span><span class="op" id="5594725">*</span><span class="ident" id="5594726">ma</span><span class="op" id="5594728">)</span>&nbsp;<span class="op" id="5594730">/</span>&nbsp;<span class="ident" id="5594732">m</span>&nbsp;<span class="op" id="5594734">&gt;&gt;</span>&nbsp;<span class="num" id="5594737">8</span><span class="op" id="5594738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594744">dst</span><span class="op" id="5594747">.</span><span class="ident" id="5594748">Pix</span><span class="op" id="5594751">[</span><span class="ident" id="5594752">i</span><span class="op" id="5594753">+</span><span class="num" id="5594754">3</span><span class="op" id="5594755">]</span>&nbsp;<span class="op" id="5594757">=</span>&nbsp;<span class="builtintype" id="5594759">uint8</span><span class="op" id="5594764">(</span><span class="op" id="5594765">(</span><span class="ident" id="5594766">da</span><span class="op" id="5594768">*</span><span class="ident" id="5594769">a</span>&nbsp;<span class="op" id="5594771">+</span>&nbsp;<span class="ident" id="5594773">sa</span><span class="op" id="5594775">*</span><span class="ident" id="5594776">ma</span><span class="op" id="5594778">)</span>&nbsp;<span class="op" id="5594780">/</span>&nbsp;<span class="ident" id="5594782">m</span>&nbsp;<span class="op" id="5594784">&gt;&gt;</span>&nbsp;<span class="num" id="5594787">8</span><span class="op" id="5594788">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5594794">}</span>&nbsp;<span class="keyword" id="5594796">else</span>&nbsp;<span class="op" id="5594801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594807">dst</span><span class="op" id="5594810">.</span><span class="ident" id="5594811">Pix</span><span class="op" id="5594814">[</span><span class="ident" id="5594815">i</span><span class="op" id="5594816">+</span><span class="num" id="5594817">0</span><span class="op" id="5594818">]</span>&nbsp;<span class="op" id="5594820">=</span>&nbsp;<span class="builtintype" id="5594822">uint8</span><span class="op" id="5594827">(</span><span class="ident" id="5594828">sr</span>&nbsp;<span class="op" id="5594831">*</span>&nbsp;<span class="ident" id="5594833">ma</span>&nbsp;<span class="op" id="5594836">/</span>&nbsp;<span class="ident" id="5594838">m</span>&nbsp;<span class="op" id="5594840">&gt;&gt;</span>&nbsp;<span class="num" id="5594843">8</span><span class="op" id="5594844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594850">dst</span><span class="op" id="5594853">.</span><span class="ident" id="5594854">Pix</span><span class="op" id="5594857">[</span><span class="ident" id="5594858">i</span><span class="op" id="5594859">+</span><span class="num" id="5594860">1</span><span class="op" id="5594861">]</span>&nbsp;<span class="op" id="5594863">=</span>&nbsp;<span class="builtintype" id="5594865">uint8</span><span class="op" id="5594870">(</span><span class="ident" id="5594871">sg</span>&nbsp;<span class="op" id="5594874">*</span>&nbsp;<span class="ident" id="5594876">ma</span>&nbsp;<span class="op" id="5594879">/</span>&nbsp;<span class="ident" id="5594881">m</span>&nbsp;<span class="op" id="5594883">&gt;&gt;</span>&nbsp;<span class="num" id="5594886">8</span><span class="op" id="5594887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594893">dst</span><span class="op" id="5594896">.</span><span class="ident" id="5594897">Pix</span><span class="op" id="5594900">[</span><span class="ident" id="5594901">i</span><span class="op" id="5594902">+</span><span class="num" id="5594903">2</span><span class="op" id="5594904">]</span>&nbsp;<span class="op" id="5594906">=</span>&nbsp;<span class="builtintype" id="5594908">uint8</span><span class="op" id="5594913">(</span><span class="ident" id="5594914">sb</span>&nbsp;<span class="op" id="5594917">*</span>&nbsp;<span class="ident" id="5594919">ma</span>&nbsp;<span class="op" id="5594922">/</span>&nbsp;<span class="ident" id="5594924">m</span>&nbsp;<span class="op" id="5594926">&gt;&gt;</span>&nbsp;<span class="num" id="5594929">8</span><span class="op" id="5594930">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594936">dst</span><span class="op" id="5594939">.</span><span class="ident" id="5594940">Pix</span><span class="op" id="5594943">[</span><span class="ident" id="5594944">i</span><span class="op" id="5594945">+</span><span class="num" id="5594946">3</span><span class="op" id="5594947">]</span>&nbsp;<span class="op" id="5594949">=</span>&nbsp;<span class="builtintype" id="5594951">uint8</span><span class="op" id="5594956">(</span><span class="ident" id="5594957">sa</span>&nbsp;<span class="op" id="5594960">*</span>&nbsp;<span class="ident" id="5594962">ma</span>&nbsp;<span class="op" id="5594965">/</span>&nbsp;<span class="ident" id="5594967">m</span>&nbsp;<span class="op" id="5594969">&gt;&gt;</span>&nbsp;<span class="num" id="5594972">8</span><span class="op" id="5594973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5594978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5594982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5594986">i0</span>&nbsp;<span class="op" id="5594989">+=</span>&nbsp;<span class="ident" id="5594992">dy</span>&nbsp;<span class="op" id="5594995">*</span>&nbsp;<span class="ident" id="5594997">dst</span><span class="op" id="5595000">.</span><span class="ident" id="5595001">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595009">}</span><br>
<span class="lineno">545</span><span class="op" id="5595011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5595014">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5595061">func</span>&nbsp;<span class="ident" id="5595066">clamp</span><span class="op" id="5595071">(</span><span class="ident" id="5595072">i</span>&nbsp;<span class="builtintype" id="5595074">int32</span><span class="op" id="5595079">)</span>&nbsp;<span class="builtintype" id="5595081">int32</span>&nbsp;<span class="op" id="5595087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595090">if</span>&nbsp;<span class="ident" id="5595093">i</span>&nbsp;<span class="op" id="5595095">&lt;</span>&nbsp;<span class="num" id="5595097">0</span>&nbsp;<span class="op" id="5595099">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595103">return</span>&nbsp;<span class="num" id="5595110">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595116">if</span>&nbsp;<span class="ident" id="5595119">i</span>&nbsp;<span class="op" id="5595121">&gt;</span>&nbsp;<span class="num" id="5595123">0xffff</span>&nbsp;<span class="op" id="5595130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595134">return</span>&nbsp;<span class="num" id="5595141">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5595149">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595152">return</span>&nbsp;<span class="ident" id="5595159">i</span><br>
<span class="lineno"></span><span class="op" id="5595161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5595164">func</span>&nbsp;<span class="ident" id="5595169">drawPaletted</span><span class="op" id="5595181">(</span><span class="ident" id="5595182">dst</span>&nbsp;<span class="ident" id="5595186">Image</span><span class="op" id="5595191">,</span>&nbsp;<span class="ident" id="5595193">r</span>&nbsp;<span class="ident" id="5595195">image</span><span class="op" id="5595200">.</span><span class="ident" id="5595201">Rectangle</span><span class="op" id="5595210">,</span>&nbsp;<span class="ident" id="5595212">src</span>&nbsp;<span class="ident" id="5595216">image</span><span class="op" id="5595221">.</span><span class="ident" id="5595222">Image</span><span class="op" id="5595227">,</span>&nbsp;<span class="ident" id="5595229">sp</span>&nbsp;<span class="ident" id="5595232">image</span><span class="op" id="5595237">.</span><span class="ident" id="5595238">Point</span><span class="op" id="5595243">,</span>&nbsp;<span class="ident" id="5595245">floydSteinberg</span>&nbsp;<span class="builtintype" id="5595260">bool</span><span class="op" id="5595264">)</span>&nbsp;<span class="op" id="5595266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595269">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595336">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595401">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595464">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595534">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595605">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5595676">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595722">palette</span><span class="op" id="5595729">,</span>&nbsp;<span class="ident" id="5595731">pix</span><span class="op" id="5595734">,</span>&nbsp;<span class="ident" id="5595736">stride</span>&nbsp;<span class="op" id="5595743">:=</span>&nbsp;<span class="op" id="5595746">[</span><span class="op" id="5595747">]</span><span class="op" id="5595748">[</span><span class="num" id="5595749">3</span><span class="op" id="5595750">]</span><span class="builtintype" id="5595751">int32</span><span class="op" id="5595756">(</span><span class="ident" id="5595757">nil</span><span class="op" id="5595760">)</span><span class="op" id="5595761">,</span>&nbsp;<span class="op" id="5595763">[</span><span class="op" id="5595764">]</span><span class="builtintype" id="5595765">byte</span><span class="op" id="5595769">(</span><span class="ident" id="5595770">nil</span><span class="op" id="5595773">)</span><span class="op" id="5595774">,</span>&nbsp;<span class="num" id="5595776">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595779">if</span>&nbsp;<span class="ident" id="5595782">p</span><span class="op" id="5595783">,</span>&nbsp;<span class="ident" id="5595785">ok</span>&nbsp;<span class="op" id="5595788">:=</span>&nbsp;<span class="ident" id="5595791">dst</span><span class="op" id="5595794">.</span><span class="op" id="5595795">(</span><span class="op" id="5595796">*</span><span class="ident" id="5595797">image</span><span class="op" id="5595802">.</span><span class="ident" id="5595803">Paletted</span><span class="op" id="5595811">)</span><span class="op" id="5595812">;</span>&nbsp;<span class="ident" id="5595814">ok</span>&nbsp;<span class="op" id="5595817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595821">palette</span>&nbsp;<span class="op" id="5595829">=</span>&nbsp;<span class="builtinfunc" id="5595831">make</span><span class="op" id="5595835">(</span><span class="op" id="5595836">[</span><span class="op" id="5595837">]</span><span class="op" id="5595838">[</span><span class="num" id="5595839">3</span><span class="op" id="5595840">]</span><span class="builtintype" id="5595841">int32</span><span class="op" id="5595846">,</span>&nbsp;<span class="builtinfunc" id="5595848">len</span><span class="op" id="5595851">(</span><span class="ident" id="5595852">p</span><span class="op" id="5595853">.</span><span class="ident" id="5595854">Palette</span><span class="op" id="5595861">)</span><span class="op" id="5595862">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5595866">for</span>&nbsp;<span class="ident" id="5595870">i</span><span class="op" id="5595871">,</span>&nbsp;<span class="ident" id="5595873">col</span>&nbsp;<span class="op" id="5595877">:=</span>&nbsp;<span class="keyword" id="5595880">range</span>&nbsp;<span class="ident" id="5595886">p</span><span class="op" id="5595887">.</span><span class="ident" id="5595888">Palette</span>&nbsp;<span class="op" id="5595896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595901">r</span><span class="op" id="5595902">,</span>&nbsp;<span class="ident" id="5595904">g</span><span class="op" id="5595905">,</span>&nbsp;<span class="ident" id="5595907">b</span><span class="op" id="5595908">,</span>&nbsp;<span class="ident" id="5595910">_</span>&nbsp;<span class="op" id="5595912">:=</span>&nbsp;<span class="ident" id="5595915">col</span><span class="op" id="5595918">.</span><span class="ident" id="5595919">RGBA</span><span class="op" id="5595923">(</span><span class="op" id="5595924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595929">palette</span><span class="op" id="5595936">[</span><span class="ident" id="5595937">i</span><span class="op" id="5595938">]</span><span class="op" id="5595939">[</span><span class="num" id="5595940">0</span><span class="op" id="5595941">]</span>&nbsp;<span class="op" id="5595943">=</span>&nbsp;<span class="builtintype" id="5595945">int32</span><span class="op" id="5595950">(</span><span class="ident" id="5595951">r</span><span class="op" id="5595952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595957">palette</span><span class="op" id="5595964">[</span><span class="ident" id="5595965">i</span><span class="op" id="5595966">]</span><span class="op" id="5595967">[</span><span class="num" id="5595968">1</span><span class="op" id="5595969">]</span>&nbsp;<span class="op" id="5595971">=</span>&nbsp;<span class="builtintype" id="5595973">int32</span><span class="op" id="5595978">(</span><span class="ident" id="5595979">g</span><span class="op" id="5595980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5595985">palette</span><span class="op" id="5595992">[</span><span class="ident" id="5595993">i</span><span class="op" id="5595994">]</span><span class="op" id="5595995">[</span><span class="num" id="5595996">2</span><span class="op" id="5595997">]</span>&nbsp;<span class="op" id="5595999">=</span>&nbsp;<span class="builtintype" id="5596001">int32</span><span class="op" id="5596006">(</span><span class="ident" id="5596007">b</span><span class="op" id="5596008">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5596012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596016">pix</span><span class="op" id="5596019">,</span>&nbsp;<span class="ident" id="5596021">stride</span>&nbsp;<span class="op" id="5596028">=</span>&nbsp;<span class="ident" id="5596030">p</span><span class="op" id="5596031">.</span><span class="ident" id="5596032">Pix</span><span class="op" id="5596035">[</span><span class="ident" id="5596036">p</span><span class="op" id="5596037">.</span><span class="ident" id="5596038">PixOffset</span><span class="op" id="5596047">(</span><span class="ident" id="5596048">r</span><span class="op" id="5596049">.</span><span class="ident" id="5596050">Min</span><span class="op" id="5596053">.</span><span class="ident" id="5596054">X</span><span class="op" id="5596055">,</span>&nbsp;<span class="ident" id="5596057">r</span><span class="op" id="5596058">.</span><span class="ident" id="5596059">Min</span><span class="op" id="5596062">.</span><span class="ident" id="5596063">Y</span><span class="op" id="5596064">)</span><span class="op" id="5596065">:</span><span class="op" id="5596066">]</span><span class="op" id="5596067">,</span>&nbsp;<span class="ident" id="5596069">p</span><span class="op" id="5596070">.</span><span class="ident" id="5596071">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5596079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596083">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596158">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596233">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596289">var</span>&nbsp;<span class="ident" id="5596293">quantErrorCurr</span><span class="op" id="5596307">,</span>&nbsp;<span class="ident" id="5596309">quantErrorNext</span>&nbsp;<span class="op" id="5596324">[</span><span class="op" id="5596325">]</span><span class="op" id="5596326">[</span><span class="num" id="5596327">3</span><span class="op" id="5596328">]</span><span class="builtintype" id="5596329">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596336">if</span>&nbsp;<span class="ident" id="5596339">floydSteinberg</span>&nbsp;<span class="op" id="5596354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596358">quantErrorCurr</span>&nbsp;<span class="op" id="5596373">=</span>&nbsp;<span class="builtinfunc" id="5596375">make</span><span class="op" id="5596379">(</span><span class="op" id="5596380">[</span><span class="op" id="5596381">]</span><span class="op" id="5596382">[</span><span class="num" id="5596383">3</span><span class="op" id="5596384">]</span><span class="builtintype" id="5596385">int32</span><span class="op" id="5596390">,</span>&nbsp;<span class="ident" id="5596392">r</span><span class="op" id="5596393">.</span><span class="ident" id="5596394">Dx</span><span class="op" id="5596396">(</span><span class="op" id="5596397">)</span><span class="op" id="5596398">+</span><span class="num" id="5596399">2</span><span class="op" id="5596400">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596404">quantErrorNext</span>&nbsp;<span class="op" id="5596419">=</span>&nbsp;<span class="builtinfunc" id="5596421">make</span><span class="op" id="5596425">(</span><span class="op" id="5596426">[</span><span class="op" id="5596427">]</span><span class="op" id="5596428">[</span><span class="num" id="5596429">3</span><span class="op" id="5596430">]</span><span class="builtintype" id="5596431">int32</span><span class="op" id="5596436">,</span>&nbsp;<span class="ident" id="5596438">r</span><span class="op" id="5596439">.</span><span class="ident" id="5596440">Dx</span><span class="op" id="5596442">(</span><span class="op" id="5596443">)</span><span class="op" id="5596444">+</span><span class="num" id="5596445">2</span><span class="op" id="5596446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5596449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596453">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596486">out</span>&nbsp;<span class="op" id="5596490">:=</span>&nbsp;<span class="ident" id="5596493">color</span><span class="op" id="5596498">.</span><span class="ident" id="5596499">RGBA64</span><span class="op" id="5596505">{</span><span class="ident" id="5596506">A</span><span class="op" id="5596507">:</span>&nbsp;<span class="num" id="5596509">0xffff</span><span class="op" id="5596515">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596518">for</span>&nbsp;<span class="ident" id="5596522">y</span>&nbsp;<span class="op" id="5596524">:=</span>&nbsp;<span class="num" id="5596527">0</span><span class="op" id="5596528">;</span>&nbsp;<span class="ident" id="5596530">y</span>&nbsp;<span class="op" id="5596532">!=</span>&nbsp;<span class="ident" id="5596535">r</span><span class="op" id="5596536">.</span><span class="ident" id="5596537">Dy</span><span class="op" id="5596539">(</span><span class="op" id="5596540">)</span><span class="op" id="5596541">;</span>&nbsp;<span class="ident" id="5596543">y</span><span class="op" id="5596544">++</span>&nbsp;<span class="op" id="5596547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596551">for</span>&nbsp;<span class="ident" id="5596555">x</span>&nbsp;<span class="op" id="5596557">:=</span>&nbsp;<span class="num" id="5596560">0</span><span class="op" id="5596561">;</span>&nbsp;<span class="ident" id="5596563">x</span>&nbsp;<span class="op" id="5596565">!=</span>&nbsp;<span class="ident" id="5596568">r</span><span class="op" id="5596569">.</span><span class="ident" id="5596570">Dx</span><span class="op" id="5596572">(</span><span class="op" id="5596573">)</span><span class="op" id="5596574">;</span>&nbsp;<span class="ident" id="5596576">x</span><span class="op" id="5596577">++</span>&nbsp;<span class="op" id="5596580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596585">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596643">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596681">sr</span><span class="op" id="5596683">,</span>&nbsp;<span class="ident" id="5596685">sg</span><span class="op" id="5596687">,</span>&nbsp;<span class="ident" id="5596689">sb</span><span class="op" id="5596691">,</span>&nbsp;<span class="ident" id="5596693">_</span>&nbsp;<span class="op" id="5596695">:=</span>&nbsp;<span class="ident" id="5596698">src</span><span class="op" id="5596701">.</span><span class="ident" id="5596702">At</span><span class="op" id="5596704">(</span><span class="ident" id="5596705">sp</span><span class="op" id="5596707">.</span><span class="ident" id="5596708">X</span><span class="op" id="5596709">+</span><span class="ident" id="5596710">x</span><span class="op" id="5596711">,</span>&nbsp;<span class="ident" id="5596713">sp</span><span class="op" id="5596715">.</span><span class="ident" id="5596716">Y</span><span class="op" id="5596717">+</span><span class="ident" id="5596718">y</span><span class="op" id="5596719">)</span><span class="op" id="5596720">.</span><span class="ident" id="5596721">RGBA</span><span class="op" id="5596725">(</span><span class="op" id="5596726">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596731">er</span><span class="op" id="5596733">,</span>&nbsp;<span class="ident" id="5596735">eg</span><span class="op" id="5596737">,</span>&nbsp;<span class="ident" id="5596739">eb</span>&nbsp;<span class="op" id="5596742">:=</span>&nbsp;<span class="builtintype" id="5596745">int32</span><span class="op" id="5596750">(</span><span class="ident" id="5596751">sr</span><span class="op" id="5596753">)</span><span class="op" id="5596754">,</span>&nbsp;<span class="builtintype" id="5596756">int32</span><span class="op" id="5596761">(</span><span class="ident" id="5596762">sg</span><span class="op" id="5596764">)</span><span class="op" id="5596765">,</span>&nbsp;<span class="builtintype" id="5596767">int32</span><span class="op" id="5596772">(</span><span class="ident" id="5596773">sb</span><span class="op" id="5596775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596780">if</span>&nbsp;<span class="ident" id="5596783">floydSteinberg</span>&nbsp;<span class="op" id="5596798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596804">er</span>&nbsp;<span class="op" id="5596807">=</span>&nbsp;<span class="ident" id="5596809">clamp</span><span class="op" id="5596814">(</span><span class="ident" id="5596815">er</span>&nbsp;<span class="op" id="5596818">+</span>&nbsp;<span class="ident" id="5596820">quantErrorCurr</span><span class="op" id="5596834">[</span><span class="ident" id="5596835">x</span><span class="op" id="5596836">+</span><span class="num" id="5596837">1</span><span class="op" id="5596838">]</span><span class="op" id="5596839">[</span><span class="num" id="5596840">0</span><span class="op" id="5596841">]</span><span class="op" id="5596842">/</span><span class="num" id="5596843">16</span><span class="op" id="5596845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596851">eg</span>&nbsp;<span class="op" id="5596854">=</span>&nbsp;<span class="ident" id="5596856">clamp</span><span class="op" id="5596861">(</span><span class="ident" id="5596862">eg</span>&nbsp;<span class="op" id="5596865">+</span>&nbsp;<span class="ident" id="5596867">quantErrorCurr</span><span class="op" id="5596881">[</span><span class="ident" id="5596882">x</span><span class="op" id="5596883">+</span><span class="num" id="5596884">1</span><span class="op" id="5596885">]</span><span class="op" id="5596886">[</span><span class="num" id="5596887">1</span><span class="op" id="5596888">]</span><span class="op" id="5596889">/</span><span class="num" id="5596890">16</span><span class="op" id="5596892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5596898">eb</span>&nbsp;<span class="op" id="5596901">=</span>&nbsp;<span class="ident" id="5596903">clamp</span><span class="op" id="5596908">(</span><span class="ident" id="5596909">eb</span>&nbsp;<span class="op" id="5596912">+</span>&nbsp;<span class="ident" id="5596914">quantErrorCurr</span><span class="op" id="5596928">[</span><span class="ident" id="5596929">x</span><span class="op" id="5596930">+</span><span class="num" id="5596931">1</span><span class="op" id="5596932">]</span><span class="op" id="5596933">[</span><span class="num" id="5596934">2</span><span class="op" id="5596935">]</span><span class="op" id="5596936">/</span><span class="num" id="5596937">16</span><span class="op" id="5596939">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5596944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5596950">if</span>&nbsp;<span class="ident" id="5596953">palette</span>&nbsp;<span class="op" id="5596961">!=</span>&nbsp;<span class="ident" id="5596964">nil</span>&nbsp;<span class="op" id="5596968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5596974">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597042">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597110">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597179">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597231">bestIndex</span><span class="op" id="5597240">,</span>&nbsp;<span class="ident" id="5597242">bestSSD</span>&nbsp;<span class="op" id="5597250">:=</span>&nbsp;<span class="num" id="5597253">0</span><span class="op" id="5597254">,</span>&nbsp;<span class="builtintype" id="5597256">uint32</span><span class="op" id="5597262">(</span><span class="num" id="5597263">1</span><span class="op" id="5597264">&lt;&lt;</span><span class="num" id="5597266">32</span><span class="op" id="5597268">-</span><span class="num" id="5597269">1</span><span class="op" id="5597270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597276">for</span>&nbsp;<span class="ident" id="5597280">index</span><span class="op" id="5597285">,</span>&nbsp;<span class="ident" id="5597287">p</span>&nbsp;<span class="op" id="5597289">:=</span>&nbsp;<span class="keyword" id="5597292">range</span>&nbsp;<span class="ident" id="5597298">palette</span>&nbsp;<span class="op" id="5597306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597313">delta</span>&nbsp;<span class="op" id="5597319">:=</span>&nbsp;<span class="op" id="5597322">(</span><span class="ident" id="5597323">er</span>&nbsp;<span class="op" id="5597326">-</span>&nbsp;<span class="ident" id="5597328">p</span><span class="op" id="5597329">[</span><span class="num" id="5597330">0</span><span class="op" id="5597331">]</span><span class="op" id="5597332">)</span>&nbsp;<span class="op" id="5597334">&gt;&gt;</span>&nbsp;<span class="num" id="5597337">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597344">ssd</span>&nbsp;<span class="op" id="5597348">:=</span>&nbsp;<span class="builtintype" id="5597351">uint32</span><span class="op" id="5597357">(</span><span class="ident" id="5597358">delta</span>&nbsp;<span class="op" id="5597364">*</span>&nbsp;<span class="ident" id="5597366">delta</span><span class="op" id="5597371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597378">delta</span>&nbsp;<span class="op" id="5597384">=</span>&nbsp;<span class="op" id="5597386">(</span><span class="ident" id="5597387">eg</span>&nbsp;<span class="op" id="5597390">-</span>&nbsp;<span class="ident" id="5597392">p</span><span class="op" id="5597393">[</span><span class="num" id="5597394">1</span><span class="op" id="5597395">]</span><span class="op" id="5597396">)</span>&nbsp;<span class="op" id="5597398">&gt;&gt;</span>&nbsp;<span class="num" id="5597401">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597408">ssd</span>&nbsp;<span class="op" id="5597412">+=</span>&nbsp;<span class="builtintype" id="5597415">uint32</span><span class="op" id="5597421">(</span><span class="ident" id="5597422">delta</span>&nbsp;<span class="op" id="5597428">*</span>&nbsp;<span class="ident" id="5597430">delta</span><span class="op" id="5597435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597442">delta</span>&nbsp;<span class="op" id="5597448">=</span>&nbsp;<span class="op" id="5597450">(</span><span class="ident" id="5597451">eb</span>&nbsp;<span class="op" id="5597454">-</span>&nbsp;<span class="ident" id="5597456">p</span><span class="op" id="5597457">[</span><span class="num" id="5597458">2</span><span class="op" id="5597459">]</span><span class="op" id="5597460">)</span>&nbsp;<span class="op" id="5597462">&gt;&gt;</span>&nbsp;<span class="num" id="5597465">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597472">ssd</span>&nbsp;<span class="op" id="5597476">+=</span>&nbsp;<span class="builtintype" id="5597479">uint32</span><span class="op" id="5597485">(</span><span class="ident" id="5597486">delta</span>&nbsp;<span class="op" id="5597492">*</span>&nbsp;<span class="ident" id="5597494">delta</span><span class="op" id="5597499">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597506">if</span>&nbsp;<span class="ident" id="5597509">ssd</span>&nbsp;<span class="op" id="5597513">&lt;</span>&nbsp;<span class="ident" id="5597515">bestSSD</span>&nbsp;<span class="op" id="5597523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597531">bestIndex</span><span class="op" id="5597540">,</span>&nbsp;<span class="ident" id="5597542">bestSSD</span>&nbsp;<span class="op" id="5597550">=</span>&nbsp;<span class="ident" id="5597552">index</span><span class="op" id="5597557">,</span>&nbsp;<span class="ident" id="5597559">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597569">if</span>&nbsp;<span class="ident" id="5597572">ssd</span>&nbsp;<span class="op" id="5597576">==</span>&nbsp;<span class="num" id="5597579">0</span>&nbsp;<span class="op" id="5597581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597590">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597602">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597621">pix</span><span class="op" id="5597624">[</span><span class="ident" id="5597625">y</span><span class="op" id="5597626">*</span><span class="ident" id="5597627">stride</span><span class="op" id="5597633">+</span><span class="ident" id="5597634">x</span><span class="op" id="5597635">]</span>&nbsp;<span class="op" id="5597637">=</span>&nbsp;<span class="builtintype" id="5597639">byte</span><span class="op" id="5597643">(</span><span class="ident" id="5597644">bestIndex</span><span class="op" id="5597653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597660">if</span>&nbsp;<span class="op" id="5597663">!</span><span class="ident" id="5597664">floydSteinberg</span>&nbsp;<span class="op" id="5597679">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5597686">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597705">er</span>&nbsp;<span class="op" id="5597708">-=</span>&nbsp;<span class="builtintype" id="5597711">int32</span><span class="op" id="5597716">(</span><span class="ident" id="5597717">palette</span><span class="op" id="5597724">[</span><span class="ident" id="5597725">bestIndex</span><span class="op" id="5597734">]</span><span class="op" id="5597735">[</span><span class="num" id="5597736">0</span><span class="op" id="5597737">]</span><span class="op" id="5597738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597744">eg</span>&nbsp;<span class="op" id="5597747">-=</span>&nbsp;<span class="builtintype" id="5597750">int32</span><span class="op" id="5597755">(</span><span class="ident" id="5597756">palette</span><span class="op" id="5597763">[</span><span class="ident" id="5597764">bestIndex</span><span class="op" id="5597773">]</span><span class="op" id="5597774">[</span><span class="num" id="5597775">1</span><span class="op" id="5597776">]</span><span class="op" id="5597777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597783">eb</span>&nbsp;<span class="op" id="5597786">-=</span>&nbsp;<span class="builtintype" id="5597789">int32</span><span class="op" id="5597794">(</span><span class="ident" id="5597795">palette</span><span class="op" id="5597802">[</span><span class="ident" id="5597803">bestIndex</span><span class="op" id="5597812">]</span><span class="op" id="5597813">[</span><span class="num" id="5597814">2</span><span class="op" id="5597815">]</span><span class="op" id="5597816">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5597822">}</span>&nbsp;<span class="keyword" id="5597824">else</span>&nbsp;<span class="op" id="5597829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597835">out</span><span class="op" id="5597838">.</span><span class="ident" id="5597839">R</span>&nbsp;<span class="op" id="5597841">=</span>&nbsp;<span class="builtintype" id="5597843">uint16</span><span class="op" id="5597849">(</span><span class="ident" id="5597850">er</span><span class="op" id="5597852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597858">out</span><span class="op" id="5597861">.</span><span class="ident" id="5597862">G</span>&nbsp;<span class="op" id="5597864">=</span>&nbsp;<span class="builtintype" id="5597866">uint16</span><span class="op" id="5597872">(</span><span class="ident" id="5597873">eg</span><span class="op" id="5597875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5597881">out</span><span class="op" id="5597884">.</span><span class="ident" id="5597885">B</span>&nbsp;<span class="op" id="5597887">=</span>&nbsp;<span class="builtintype" id="5597889">uint16</span><span class="op" id="5597895">(</span><span class="ident" id="5597896">eb</span><span class="op" id="5597898">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597904">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5597965">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598030">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598093">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598154">dst</span><span class="op" id="5598157">.</span><span class="ident" id="5598158">Set</span><span class="op" id="5598161">(</span><span class="ident" id="5598162">r</span><span class="op" id="5598163">.</span><span class="ident" id="5598164">Min</span><span class="op" id="5598167">.</span><span class="ident" id="5598168">X</span><span class="op" id="5598169">+</span><span class="ident" id="5598170">x</span><span class="op" id="5598171">,</span>&nbsp;<span class="ident" id="5598173">r</span><span class="op" id="5598174">.</span><span class="ident" id="5598175">Min</span><span class="op" id="5598178">.</span><span class="ident" id="5598179">Y</span><span class="op" id="5598180">+</span><span class="ident" id="5598181">y</span><span class="op" id="5598182">,</span>&nbsp;<span class="op" id="5598184">&amp;</span><span class="ident" id="5598185">out</span><span class="op" id="5598188">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598195">if</span>&nbsp;<span class="op" id="5598198">!</span><span class="ident" id="5598199">floydSteinberg</span>&nbsp;<span class="op" id="5598214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598221">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598240">sr</span><span class="op" id="5598242">,</span>&nbsp;<span class="ident" id="5598244">sg</span><span class="op" id="5598246">,</span>&nbsp;<span class="ident" id="5598248">sb</span><span class="op" id="5598250">,</span>&nbsp;<span class="ident" id="5598252">_</span>&nbsp;<span class="op" id="5598254">=</span>&nbsp;<span class="ident" id="5598256">dst</span><span class="op" id="5598259">.</span><span class="ident" id="5598260">At</span><span class="op" id="5598262">(</span><span class="ident" id="5598263">r</span><span class="op" id="5598264">.</span><span class="ident" id="5598265">Min</span><span class="op" id="5598268">.</span><span class="ident" id="5598269">X</span><span class="op" id="5598270">+</span><span class="ident" id="5598271">x</span><span class="op" id="5598272">,</span>&nbsp;<span class="ident" id="5598274">r</span><span class="op" id="5598275">.</span><span class="ident" id="5598276">Min</span><span class="op" id="5598279">.</span><span class="ident" id="5598280">Y</span><span class="op" id="5598281">+</span><span class="ident" id="5598282">y</span><span class="op" id="5598283">)</span><span class="op" id="5598284">.</span><span class="ident" id="5598285">RGBA</span><span class="op" id="5598289">(</span><span class="op" id="5598290">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598296">er</span>&nbsp;<span class="op" id="5598299">-=</span>&nbsp;<span class="builtintype" id="5598302">int32</span><span class="op" id="5598307">(</span><span class="ident" id="5598308">sr</span><span class="op" id="5598310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598316">eg</span>&nbsp;<span class="op" id="5598319">-=</span>&nbsp;<span class="builtintype" id="5598322">int32</span><span class="op" id="5598327">(</span><span class="ident" id="5598328">sg</span><span class="op" id="5598330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598336">eb</span>&nbsp;<span class="op" id="5598339">-=</span>&nbsp;<span class="builtintype" id="5598342">int32</span><span class="op" id="5598347">(</span><span class="ident" id="5598348">sb</span><span class="op" id="5598350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598361">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598417">quantErrorNext</span><span class="op" id="5598431">[</span><span class="ident" id="5598432">x</span><span class="op" id="5598433">+</span><span class="num" id="5598434">0</span><span class="op" id="5598435">]</span><span class="op" id="5598436">[</span><span class="num" id="5598437">0</span><span class="op" id="5598438">]</span>&nbsp;<span class="op" id="5598440">+=</span>&nbsp;<span class="ident" id="5598443">er</span>&nbsp;<span class="op" id="5598446">*</span>&nbsp;<span class="num" id="5598448">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598453">quantErrorNext</span><span class="op" id="5598467">[</span><span class="ident" id="5598468">x</span><span class="op" id="5598469">+</span><span class="num" id="5598470">0</span><span class="op" id="5598471">]</span><span class="op" id="5598472">[</span><span class="num" id="5598473">1</span><span class="op" id="5598474">]</span>&nbsp;<span class="op" id="5598476">+=</span>&nbsp;<span class="ident" id="5598479">eg</span>&nbsp;<span class="op" id="5598482">*</span>&nbsp;<span class="num" id="5598484">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598489">quantErrorNext</span><span class="op" id="5598503">[</span><span class="ident" id="5598504">x</span><span class="op" id="5598505">+</span><span class="num" id="5598506">0</span><span class="op" id="5598507">]</span><span class="op" id="5598508">[</span><span class="num" id="5598509">2</span><span class="op" id="5598510">]</span>&nbsp;<span class="op" id="5598512">+=</span>&nbsp;<span class="ident" id="5598515">eb</span>&nbsp;<span class="op" id="5598518">*</span>&nbsp;<span class="num" id="5598520">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598525">quantErrorNext</span><span class="op" id="5598539">[</span><span class="ident" id="5598540">x</span><span class="op" id="5598541">+</span><span class="num" id="5598542">1</span><span class="op" id="5598543">]</span><span class="op" id="5598544">[</span><span class="num" id="5598545">0</span><span class="op" id="5598546">]</span>&nbsp;<span class="op" id="5598548">+=</span>&nbsp;<span class="ident" id="5598551">er</span>&nbsp;<span class="op" id="5598554">*</span>&nbsp;<span class="num" id="5598556">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598561">quantErrorNext</span><span class="op" id="5598575">[</span><span class="ident" id="5598576">x</span><span class="op" id="5598577">+</span><span class="num" id="5598578">1</span><span class="op" id="5598579">]</span><span class="op" id="5598580">[</span><span class="num" id="5598581">1</span><span class="op" id="5598582">]</span>&nbsp;<span class="op" id="5598584">+=</span>&nbsp;<span class="ident" id="5598587">eg</span>&nbsp;<span class="op" id="5598590">*</span>&nbsp;<span class="num" id="5598592">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598597">quantErrorNext</span><span class="op" id="5598611">[</span><span class="ident" id="5598612">x</span><span class="op" id="5598613">+</span><span class="num" id="5598614">1</span><span class="op" id="5598615">]</span><span class="op" id="5598616">[</span><span class="num" id="5598617">2</span><span class="op" id="5598618">]</span>&nbsp;<span class="op" id="5598620">+=</span>&nbsp;<span class="ident" id="5598623">eb</span>&nbsp;<span class="op" id="5598626">*</span>&nbsp;<span class="num" id="5598628">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598633">quantErrorNext</span><span class="op" id="5598647">[</span><span class="ident" id="5598648">x</span><span class="op" id="5598649">+</span><span class="num" id="5598650">2</span><span class="op" id="5598651">]</span><span class="op" id="5598652">[</span><span class="num" id="5598653">0</span><span class="op" id="5598654">]</span>&nbsp;<span class="op" id="5598656">+=</span>&nbsp;<span class="ident" id="5598659">er</span>&nbsp;<span class="op" id="5598662">*</span>&nbsp;<span class="num" id="5598664">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598669">quantErrorNext</span><span class="op" id="5598683">[</span><span class="ident" id="5598684">x</span><span class="op" id="5598685">+</span><span class="num" id="5598686">2</span><span class="op" id="5598687">]</span><span class="op" id="5598688">[</span><span class="num" id="5598689">1</span><span class="op" id="5598690">]</span>&nbsp;<span class="op" id="5598692">+=</span>&nbsp;<span class="ident" id="5598695">eg</span>&nbsp;<span class="op" id="5598698">*</span>&nbsp;<span class="num" id="5598700">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598705">quantErrorNext</span><span class="op" id="5598719">[</span><span class="ident" id="5598720">x</span><span class="op" id="5598721">+</span><span class="num" id="5598722">2</span><span class="op" id="5598723">]</span><span class="op" id="5598724">[</span><span class="num" id="5598725">2</span><span class="op" id="5598726">]</span>&nbsp;<span class="op" id="5598728">+=</span>&nbsp;<span class="ident" id="5598731">eb</span>&nbsp;<span class="op" id="5598734">*</span>&nbsp;<span class="num" id="5598736">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598741">quantErrorCurr</span><span class="op" id="5598755">[</span><span class="ident" id="5598756">x</span><span class="op" id="5598757">+</span><span class="num" id="5598758">2</span><span class="op" id="5598759">]</span><span class="op" id="5598760">[</span><span class="num" id="5598761">0</span><span class="op" id="5598762">]</span>&nbsp;<span class="op" id="5598764">+=</span>&nbsp;<span class="ident" id="5598767">er</span>&nbsp;<span class="op" id="5598770">*</span>&nbsp;<span class="num" id="5598772">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598777">quantErrorCurr</span><span class="op" id="5598791">[</span><span class="ident" id="5598792">x</span><span class="op" id="5598793">+</span><span class="num" id="5598794">2</span><span class="op" id="5598795">]</span><span class="op" id="5598796">[</span><span class="num" id="5598797">1</span><span class="op" id="5598798">]</span>&nbsp;<span class="op" id="5598800">+=</span>&nbsp;<span class="ident" id="5598803">eg</span>&nbsp;<span class="op" id="5598806">*</span>&nbsp;<span class="num" id="5598808">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598813">quantErrorCurr</span><span class="op" id="5598827">[</span><span class="ident" id="5598828">x</span><span class="op" id="5598829">+</span><span class="num" id="5598830">2</span><span class="op" id="5598831">]</span><span class="op" id="5598832">[</span><span class="num" id="5598833">2</span><span class="op" id="5598834">]</span>&nbsp;<span class="op" id="5598836">+=</span>&nbsp;<span class="ident" id="5598839">eb</span>&nbsp;<span class="op" id="5598842">*</span>&nbsp;<span class="num" id="5598844">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5598848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5598853">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598898">if</span>&nbsp;<span class="ident" id="5598901">floydSteinberg</span>&nbsp;<span class="op" id="5598916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5598921">quantErrorCurr</span><span class="op" id="5598935">,</span>&nbsp;<span class="ident" id="5598937">quantErrorNext</span>&nbsp;<span class="op" id="5598952">=</span>&nbsp;<span class="ident" id="5598954">quantErrorNext</span><span class="op" id="5598968">,</span>&nbsp;<span class="ident" id="5598970">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5598988">for</span>&nbsp;<span class="ident" id="5598992">i</span>&nbsp;<span class="op" id="5598994">:=</span>&nbsp;<span class="keyword" id="5598997">range</span>&nbsp;<span class="ident" id="5599003">quantErrorNext</span>&nbsp;<span class="op" id="5599018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5599024">quantErrorNext</span><span class="op" id="5599038">[</span><span class="ident" id="5599039">i</span><span class="op" id="5599040">]</span>&nbsp;<span class="op" id="5599042">=</span>&nbsp;<span class="op" id="5599044">[</span><span class="num" id="5599045">3</span><span class="op" id="5599046">]</span><span class="builtintype" id="5599047">int32</span><span class="op" id="5599052">{</span><span class="op" id="5599053">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5599065">}</span><br>
<span class="lineno"></span><span class="op" id="5599067">}</span>
</div>
</body>
</html>
