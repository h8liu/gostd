<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html" class="current">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8352240">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8352295">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8352349">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8352400">package</span>&nbsp;<span class="ident" id="8352408">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8352413">import</span>&nbsp;<span class="op" id="8352420">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352423">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352446">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352456">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352463">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352469">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352476">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352484">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352495">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352506">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352514">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8352525">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8352532">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8352535">var</span>&nbsp;<span class="ident" id="8352539">_</span>&nbsp;<span class="op" id="8352541">=</span>&nbsp;<span class="ident" id="8352543">log</span><span class="op" id="8352546">.</span><span class="ident" id="8352547">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8352555">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="8352623">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="8352655">//</span><br>
<span class="lineno"></span><span class="comment" id="8352658">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="8352723">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="8352790">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="8352802">//</span><br>
<span class="lineno">30</span><span class="comment" id="8352805">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="8352815">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="8352869">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="8352930">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="8352979">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="8353052">//</span><br>
<span class="lineno"></span><span class="comment" id="8353055">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="8353120">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="8353179">type</span>&nbsp;<span class="ident" id="8353184">fakeDriver</span>&nbsp;<span class="keyword" id="8353195">struct</span>&nbsp;<span class="op" id="8353202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353205">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353216">sync</span><span class="op" id="8353220">.</span><span class="ident" id="8353221">Mutex</span>&nbsp;<span class="comment" id="8353227">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353257">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="8353268">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8353279">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353294">closeCount</span>&nbsp;<span class="builtintype" id="8353305">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8353316">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353332">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353343">chan</span>&nbsp;<span class="keyword" id="8353348">struct</span><span class="op" id="8353354">{</span><span class="op" id="8353355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353358">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="8353369">chan</span>&nbsp;<span class="keyword" id="8353374">struct</span><span class="op" id="8353380">{</span><span class="op" id="8353381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353384">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353395">map</span><span class="op" id="8353398">[</span><span class="builtintype" id="8353399">string</span><span class="op" id="8353405">]</span><span class="op" id="8353406">*</span><span class="ident" id="8353407">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="8353414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8353417">type</span>&nbsp;<span class="ident" id="8353422">fakeDB</span>&nbsp;<span class="keyword" id="8353429">struct</span>&nbsp;<span class="op" id="8353436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353439">name</span>&nbsp;<span class="builtintype" id="8353444">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353453">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353461">sync</span><span class="op" id="8353465">.</span><span class="ident" id="8353466">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353473">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8353481">[</span><span class="op" id="8353482">]</span><span class="op" id="8353483">*</span><span class="ident" id="8353484">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353494">tables</span>&nbsp;&nbsp;<span class="keyword" id="8353502">map</span><span class="op" id="8353505">[</span><span class="builtintype" id="8353506">string</span><span class="op" id="8353512">]</span><span class="op" id="8353513">*</span><span class="ident" id="8353514">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353521">badConn</span>&nbsp;<span class="builtintype" id="8353529">bool</span><br>
<span class="lineno"></span><span class="op" id="8353534">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="8353537">type</span>&nbsp;<span class="ident" id="8353542">table</span>&nbsp;<span class="keyword" id="8353548">struct</span>&nbsp;<span class="op" id="8353555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353558">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353566">sync</span><span class="op" id="8353570">.</span><span class="ident" id="8353571">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353578">colname</span>&nbsp;<span class="op" id="8353586">[</span><span class="op" id="8353587">]</span><span class="builtintype" id="8353588">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353596">coltype</span>&nbsp;<span class="op" id="8353604">[</span><span class="op" id="8353605">]</span><span class="builtintype" id="8353606">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353614">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8353622">[</span><span class="op" id="8353623">]</span><span class="op" id="8353624">*</span><span class="ident" id="8353625">row</span><br>
<span class="lineno"></span><span class="op" id="8353629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8353632">func</span>&nbsp;<span class="op" id="8353637">(</span><span class="ident" id="8353638">t</span>&nbsp;<span class="op" id="8353640">*</span><span class="ident" id="8353641">table</span><span class="op" id="8353646">)</span>&nbsp;<span class="ident" id="8353648">columnIndex</span><span class="op" id="8353659">(</span><span class="ident" id="8353660">name</span>&nbsp;<span class="builtintype" id="8353665">string</span><span class="op" id="8353671">)</span>&nbsp;<span class="builtintype" id="8353673">int</span>&nbsp;<span class="op" id="8353677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353680">for</span>&nbsp;<span class="ident" id="8353684">n</span><span class="op" id="8353685">,</span>&nbsp;<span class="ident" id="8353687">nname</span>&nbsp;<span class="op" id="8353693">:=</span>&nbsp;<span class="keyword" id="8353696">range</span>&nbsp;<span class="ident" id="8353702">t</span><span class="op" id="8353703">.</span><span class="ident" id="8353704">colname</span>&nbsp;<span class="op" id="8353712">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353716">if</span>&nbsp;<span class="ident" id="8353719">name</span>&nbsp;<span class="op" id="8353724">==</span>&nbsp;<span class="ident" id="8353727">nname</span>&nbsp;<span class="op" id="8353733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353738">return</span>&nbsp;<span class="ident" id="8353745">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8353749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8353752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353755">return</span>&nbsp;<span class="op" id="8353762">-</span><span class="num" id="8353763">1</span><br>
<span class="lineno">70</span><span class="op" id="8353765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8353768">type</span>&nbsp;<span class="ident" id="8353773">row</span>&nbsp;<span class="keyword" id="8353777">struct</span>&nbsp;<span class="op" id="8353784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353787">cols</span>&nbsp;<span class="op" id="8353792">[</span><span class="op" id="8353793">]</span><span class="keyword" id="8353794">interface</span><span class="op" id="8353803">{</span><span class="op" id="8353804">}</span>&nbsp;<span class="comment" id="8353806">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="8353858">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="8353861">func</span>&nbsp;<span class="op" id="8353866">(</span><span class="ident" id="8353867">r</span>&nbsp;<span class="op" id="8353869">*</span><span class="ident" id="8353870">row</span><span class="op" id="8353873">)</span>&nbsp;<span class="ident" id="8353875">clone</span><span class="op" id="8353880">(</span><span class="op" id="8353881">)</span>&nbsp;<span class="op" id="8353883">*</span><span class="ident" id="8353884">row</span>&nbsp;<span class="op" id="8353888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8353891">nrow</span>&nbsp;<span class="op" id="8353896">:=</span>&nbsp;<span class="op" id="8353899">&amp;</span><span class="ident" id="8353900">row</span><span class="op" id="8353903">{</span><span class="ident" id="8353904">cols</span><span class="op" id="8353908">:</span>&nbsp;<span class="builtinfunc" id="8353910">make</span><span class="op" id="8353914">(</span><span class="op" id="8353915">[</span><span class="op" id="8353916">]</span><span class="keyword" id="8353917">interface</span><span class="op" id="8353926">{</span><span class="op" id="8353927">}</span><span class="op" id="8353928">,</span>&nbsp;<span class="builtinfunc" id="8353930">len</span><span class="op" id="8353933">(</span><span class="ident" id="8353934">r</span><span class="op" id="8353935">.</span><span class="ident" id="8353936">cols</span><span class="op" id="8353940">)</span><span class="op" id="8353941">)</span><span class="op" id="8353942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8353945">copy</span><span class="op" id="8353949">(</span><span class="ident" id="8353950">nrow</span><span class="op" id="8353954">.</span><span class="ident" id="8353955">cols</span><span class="op" id="8353959">,</span>&nbsp;<span class="ident" id="8353961">r</span><span class="op" id="8353962">.</span><span class="ident" id="8353963">cols</span><span class="op" id="8353967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8353970">return</span>&nbsp;<span class="ident" id="8353977">nrow</span><br>
<span class="lineno">80</span><span class="op" id="8353982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8353985">type</span>&nbsp;<span class="ident" id="8353990">fakeConn</span>&nbsp;<span class="keyword" id="8353999">struct</span>&nbsp;<span class="op" id="8354006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354009">db</span>&nbsp;<span class="op" id="8354012">*</span><span class="ident" id="8354013">fakeDB</span>&nbsp;<span class="comment" id="8354020">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354054">currTx</span>&nbsp;<span class="op" id="8354061">*</span><span class="ident" id="8354062">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8354071">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354092">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354104">sync</span><span class="op" id="8354108">.</span><span class="ident" id="8354109">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354116">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8354128">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354133">stmtsClosed</span>&nbsp;<span class="builtintype" id="8354145">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354150">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="8354162">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354167">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8354179">bool</span><br>
<span class="lineno"></span><span class="op" id="8354184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8354187">func</span>&nbsp;<span class="op" id="8354192">(</span><span class="ident" id="8354193">c</span>&nbsp;<span class="op" id="8354195">*</span><span class="ident" id="8354196">fakeConn</span><span class="op" id="8354204">)</span>&nbsp;<span class="ident" id="8354206">incrStat</span><span class="op" id="8354214">(</span><span class="ident" id="8354215">v</span>&nbsp;<span class="op" id="8354217">*</span><span class="builtintype" id="8354218">int</span><span class="op" id="8354221">)</span>&nbsp;<span class="op" id="8354223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354226">c</span><span class="op" id="8354227">.</span><span class="ident" id="8354228">mu</span><span class="op" id="8354230">.</span><span class="ident" id="8354231">Lock</span><span class="op" id="8354235">(</span><span class="op" id="8354236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8354239">*</span><span class="ident" id="8354240">v</span><span class="op" id="8354241">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354245">c</span><span class="op" id="8354246">.</span><span class="ident" id="8354247">mu</span><span class="op" id="8354249">.</span><span class="ident" id="8354250">Unlock</span><span class="op" id="8354256">(</span><span class="op" id="8354257">)</span><br>
<span class="lineno"></span><span class="op" id="8354259">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8354262">type</span>&nbsp;<span class="ident" id="8354267">fakeTx</span>&nbsp;<span class="keyword" id="8354274">struct</span>&nbsp;<span class="op" id="8354281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354284">c</span>&nbsp;<span class="op" id="8354286">*</span><span class="ident" id="8354287">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="8354296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="8354299">type</span>&nbsp;<span class="ident" id="8354304">fakeStmt</span>&nbsp;<span class="keyword" id="8354313">struct</span>&nbsp;<span class="op" id="8354320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354323">c</span>&nbsp;<span class="op" id="8354325">*</span><span class="ident" id="8354326">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354336">q</span>&nbsp;<span class="builtintype" id="8354338">string</span>&nbsp;<span class="comment" id="8354345">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354369">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8354375">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354383">table</span>&nbsp;<span class="builtintype" id="8354389">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354398">closed</span>&nbsp;<span class="builtintype" id="8354405">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354412">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8354425">[</span><span class="op" id="8354426">]</span><span class="builtintype" id="8354427">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8354439">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354493">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8354506">[</span><span class="op" id="8354507">]</span><span class="builtintype" id="8354508">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8354520">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354539">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8354552">[</span><span class="op" id="8354553">]</span><span class="keyword" id="8354554">interface</span><span class="op" id="8354563">{</span><span class="op" id="8354564">}</span>&nbsp;<span class="comment" id="8354566">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354627">placeholders</span>&nbsp;<span class="builtintype" id="8354640">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8354654">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354701">whereCol</span>&nbsp;<span class="op" id="8354710">[</span><span class="op" id="8354711">]</span><span class="builtintype" id="8354712">string</span>&nbsp;<span class="comment" id="8354719">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354758">placeholderConverter</span>&nbsp;<span class="op" id="8354779">[</span><span class="op" id="8354780">]</span><span class="ident" id="8354781">driver</span><span class="op" id="8354787">.</span><span class="ident" id="8354788">ValueConverter</span>&nbsp;<span class="comment" id="8354803">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="8354821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8354824">var</span>&nbsp;<span class="ident" id="8354828">fdriver</span>&nbsp;<span class="ident" id="8354836">driver</span><span class="op" id="8354842">.</span><span class="ident" id="8354843">Driver</span>&nbsp;<span class="op" id="8354850">=</span>&nbsp;<span class="op" id="8354852">&amp;</span><span class="ident" id="8354853">fakeDriver</span><span class="op" id="8354863">{</span><span class="op" id="8354864">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="8354867">func</span>&nbsp;<span class="ident" id="8354872">init</span><span class="op" id="8354876">(</span><span class="op" id="8354877">)</span>&nbsp;<span class="op" id="8354879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8354882">Register</span><span class="op" id="8354890">(</span><span class="string" id="8354891">&#34;test&#34;</span><span class="op" id="8354897">,</span>&nbsp;<span class="ident" id="8354899">fdriver</span><span class="op" id="8354906">)</span><br>
<span class="lineno"></span><span class="op" id="8354908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="8354911">func</span>&nbsp;<span class="ident" id="8354916">contains</span><span class="op" id="8354924">(</span><span class="ident" id="8354925">list</span>&nbsp;<span class="op" id="8354930">[</span><span class="op" id="8354931">]</span><span class="builtintype" id="8354932">string</span><span class="op" id="8354938">,</span>&nbsp;<span class="ident" id="8354940">y</span>&nbsp;<span class="builtintype" id="8354942">string</span><span class="op" id="8354948">)</span>&nbsp;<span class="builtintype" id="8354950">bool</span>&nbsp;<span class="op" id="8354955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8354958">for</span>&nbsp;<span class="ident" id="8354962">_</span><span class="op" id="8354963">,</span>&nbsp;<span class="ident" id="8354965">x</span>&nbsp;<span class="op" id="8354967">:=</span>&nbsp;<span class="keyword" id="8354970">range</span>&nbsp;<span class="ident" id="8354976">list</span>&nbsp;<span class="op" id="8354981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8354985">if</span>&nbsp;<span class="ident" id="8354988">x</span>&nbsp;<span class="op" id="8354990">==</span>&nbsp;<span class="ident" id="8354993">y</span>&nbsp;<span class="op" id="8354995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355000">return</span>&nbsp;<span class="builtintype" id="8355007">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8355014">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8355017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355020">return</span>&nbsp;<span class="builtintype" id="8355027">false</span><br>
<span class="lineno"></span><span class="op" id="8355033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8355036">type</span>&nbsp;<span class="ident" id="8355041">Dummy</span>&nbsp;<span class="keyword" id="8355047">struct</span>&nbsp;<span class="op" id="8355054">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355057">driver</span><span class="op" id="8355063">.</span><span class="ident" id="8355064">Driver</span><br>
<span class="lineno"></span><span class="op" id="8355071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8355074">func</span>&nbsp;<span class="ident" id="8355079">TestDrivers</span><span class="op" id="8355090">(</span><span class="ident" id="8355091">t</span>&nbsp;<span class="op" id="8355093">*</span><span class="ident" id="8355094">testing</span><span class="op" id="8355101">.</span><span class="ident" id="8355102">T</span><span class="op" id="8355103">)</span>&nbsp;<span class="op" id="8355105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355108">unregisterAllDrivers</span><span class="op" id="8355128">(</span><span class="op" id="8355129">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355132">Register</span><span class="op" id="8355140">(</span><span class="string" id="8355141">&#34;test&#34;</span><span class="op" id="8355147">,</span>&nbsp;<span class="ident" id="8355149">fdriver</span><span class="op" id="8355156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355159">Register</span><span class="op" id="8355167">(</span><span class="string" id="8355168">&#34;invalid&#34;</span><span class="op" id="8355177">,</span>&nbsp;<span class="ident" id="8355179">Dummy</span><span class="op" id="8355184">{</span><span class="op" id="8355185">}</span><span class="op" id="8355186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355189">all</span>&nbsp;<span class="op" id="8355193">:=</span>&nbsp;<span class="ident" id="8355196">Drivers</span><span class="op" id="8355203">(</span><span class="op" id="8355204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355207">if</span>&nbsp;<span class="builtinfunc" id="8355210">len</span><span class="op" id="8355213">(</span><span class="ident" id="8355214">all</span><span class="op" id="8355217">)</span>&nbsp;<span class="op" id="8355219">&lt;</span>&nbsp;<span class="num" id="8355221">2</span>&nbsp;<span class="op" id="8355223">||</span>&nbsp;<span class="op" id="8355226">!</span><span class="ident" id="8355227">sort</span><span class="op" id="8355231">.</span><span class="ident" id="8355232">StringsAreSorted</span><span class="op" id="8355248">(</span><span class="ident" id="8355249">all</span><span class="op" id="8355252">)</span>&nbsp;<span class="op" id="8355254">||</span>&nbsp;<span class="op" id="8355257">!</span><span class="ident" id="8355258">contains</span><span class="op" id="8355266">(</span><span class="ident" id="8355267">all</span><span class="op" id="8355270">,</span>&nbsp;<span class="string" id="8355272">&#34;test&#34;</span><span class="op" id="8355278">)</span>&nbsp;<span class="op" id="8355280">||</span>&nbsp;<span class="op" id="8355283">!</span><span class="ident" id="8355284">contains</span><span class="op" id="8355292">(</span><span class="ident" id="8355293">all</span><span class="op" id="8355296">,</span>&nbsp;<span class="string" id="8355298">&#34;invalid&#34;</span><span class="op" id="8355307">)</span>&nbsp;<span class="op" id="8355309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355313">t</span><span class="op" id="8355314">.</span><span class="ident" id="8355315">Fatalf</span><span class="op" id="8355321">(</span><span class="string" id="8355322">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="8355384">,</span>&nbsp;<span class="ident" id="8355386">all</span><span class="op" id="8355389">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8355392">}</span><br>
<span class="lineno"></span><span class="op" id="8355394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8355397">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="8355420">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="8355435">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="8355505">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="8355578">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="8355628">func</span>&nbsp;<span class="op" id="8355633">(</span><span class="ident" id="8355634">d</span>&nbsp;<span class="op" id="8355636">*</span><span class="ident" id="8355637">fakeDriver</span><span class="op" id="8355647">)</span>&nbsp;<span class="ident" id="8355649">Open</span><span class="op" id="8355653">(</span><span class="ident" id="8355654">dsn</span>&nbsp;<span class="builtintype" id="8355658">string</span><span class="op" id="8355664">)</span>&nbsp;<span class="op" id="8355666">(</span><span class="ident" id="8355667">driver</span><span class="op" id="8355673">.</span><span class="ident" id="8355674">Conn</span><span class="op" id="8355678">,</span>&nbsp;<span class="builtintype" id="8355680">error</span><span class="op" id="8355685">)</span>&nbsp;<span class="op" id="8355687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355690">parts</span>&nbsp;<span class="op" id="8355696">:=</span>&nbsp;<span class="ident" id="8355699">strings</span><span class="op" id="8355706">.</span><span class="ident" id="8355707">Split</span><span class="op" id="8355712">(</span><span class="ident" id="8355713">dsn</span><span class="op" id="8355716">,</span>&nbsp;<span class="string" id="8355718">&#34;;&#34;</span><span class="op" id="8355721">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355724">if</span>&nbsp;<span class="builtinfunc" id="8355727">len</span><span class="op" id="8355730">(</span><span class="ident" id="8355731">parts</span><span class="op" id="8355736">)</span>&nbsp;<span class="op" id="8355738">&lt;</span>&nbsp;<span class="num" id="8355740">1</span>&nbsp;<span class="op" id="8355742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355746">return</span>&nbsp;<span class="builtintype" id="8355753">nil</span><span class="op" id="8355756">,</span>&nbsp;<span class="ident" id="8355758">errors</span><span class="op" id="8355764">.</span><span class="ident" id="8355765">New</span><span class="op" id="8355768">(</span><span class="string" id="8355769">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="8355795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8355798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355801">name</span>&nbsp;<span class="op" id="8355806">:=</span>&nbsp;<span class="ident" id="8355809">parts</span><span class="op" id="8355814">[</span><span class="num" id="8355815">0</span><span class="op" id="8355816">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355820">db</span>&nbsp;<span class="op" id="8355823">:=</span>&nbsp;<span class="ident" id="8355826">d</span><span class="op" id="8355827">.</span><span class="ident" id="8355828">getDB</span><span class="op" id="8355833">(</span><span class="ident" id="8355834">name</span><span class="op" id="8355838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355842">d</span><span class="op" id="8355843">.</span><span class="ident" id="8355844">mu</span><span class="op" id="8355846">.</span><span class="ident" id="8355847">Lock</span><span class="op" id="8355851">(</span><span class="op" id="8355852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355855">d</span><span class="op" id="8355856">.</span><span class="ident" id="8355857">openCount</span><span class="op" id="8355866">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355870">d</span><span class="op" id="8355871">.</span><span class="ident" id="8355872">mu</span><span class="op" id="8355874">.</span><span class="ident" id="8355875">Unlock</span><span class="op" id="8355881">(</span><span class="op" id="8355882">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355885">conn</span>&nbsp;<span class="op" id="8355890">:=</span>&nbsp;<span class="op" id="8355893">&amp;</span><span class="ident" id="8355894">fakeConn</span><span class="op" id="8355902">{</span><span class="ident" id="8355903">db</span><span class="op" id="8355905">:</span>&nbsp;<span class="ident" id="8355907">db</span><span class="op" id="8355909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355913">if</span>&nbsp;<span class="builtinfunc" id="8355916">len</span><span class="op" id="8355919">(</span><span class="ident" id="8355920">parts</span><span class="op" id="8355925">)</span>&nbsp;<span class="op" id="8355927">&gt;=</span>&nbsp;<span class="num" id="8355930">2</span>&nbsp;<span class="op" id="8355932">&amp;&amp;</span>&nbsp;<span class="ident" id="8355935">parts</span><span class="op" id="8355940">[</span><span class="num" id="8355941">1</span><span class="op" id="8355942">]</span>&nbsp;<span class="op" id="8355944">==</span>&nbsp;<span class="string" id="8355947">&#34;badConn&#34;</span>&nbsp;<span class="op" id="8355957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8355961">conn</span><span class="op" id="8355965">.</span><span class="ident" id="8355966">bad</span>&nbsp;<span class="op" id="8355970">=</span>&nbsp;<span class="builtintype" id="8355972">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8355978">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8355981">if</span>&nbsp;<span class="ident" id="8355984">d</span><span class="op" id="8355985">.</span><span class="ident" id="8355986">waitCh</span>&nbsp;<span class="op" id="8355993">!=</span>&nbsp;<span class="builtintype" id="8355996">nil</span>&nbsp;<span class="op" id="8356000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356004">d</span><span class="op" id="8356005">.</span><span class="ident" id="8356006">waitingCh</span>&nbsp;<span class="op" id="8356016">&lt;-</span>&nbsp;<span class="keyword" id="8356019">struct</span><span class="op" id="8356025">{</span><span class="op" id="8356026">}</span><span class="op" id="8356027">{</span><span class="op" id="8356028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356032">&lt;-</span><span class="ident" id="8356034">d</span><span class="op" id="8356035">.</span><span class="ident" id="8356036">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356045">d</span><span class="op" id="8356046">.</span><span class="ident" id="8356047">waitCh</span>&nbsp;<span class="op" id="8356054">=</span>&nbsp;<span class="builtintype" id="8356056">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356062">d</span><span class="op" id="8356063">.</span><span class="ident" id="8356064">waitingCh</span>&nbsp;<span class="op" id="8356074">=</span>&nbsp;<span class="builtintype" id="8356076">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356084">return</span>&nbsp;<span class="ident" id="8356091">conn</span><span class="op" id="8356095">,</span>&nbsp;<span class="builtintype" id="8356097">nil</span><br>
<span class="lineno"></span><span class="op" id="8356101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8356104">func</span>&nbsp;<span class="op" id="8356109">(</span><span class="ident" id="8356110">d</span>&nbsp;<span class="op" id="8356112">*</span><span class="ident" id="8356113">fakeDriver</span><span class="op" id="8356123">)</span>&nbsp;<span class="ident" id="8356125">getDB</span><span class="op" id="8356130">(</span><span class="ident" id="8356131">name</span>&nbsp;<span class="builtintype" id="8356136">string</span><span class="op" id="8356142">)</span>&nbsp;<span class="op" id="8356144">*</span><span class="ident" id="8356145">fakeDB</span>&nbsp;<span class="op" id="8356152">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356155">d</span><span class="op" id="8356156">.</span><span class="ident" id="8356157">mu</span><span class="op" id="8356159">.</span><span class="ident" id="8356160">Lock</span><span class="op" id="8356164">(</span><span class="op" id="8356165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356168">defer</span>&nbsp;<span class="ident" id="8356174">d</span><span class="op" id="8356175">.</span><span class="ident" id="8356176">mu</span><span class="op" id="8356178">.</span><span class="ident" id="8356179">Unlock</span><span class="op" id="8356185">(</span><span class="op" id="8356186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356189">if</span>&nbsp;<span class="ident" id="8356192">d</span><span class="op" id="8356193">.</span><span class="ident" id="8356194">dbs</span>&nbsp;<span class="op" id="8356198">==</span>&nbsp;<span class="builtintype" id="8356201">nil</span>&nbsp;<span class="op" id="8356205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356209">d</span><span class="op" id="8356210">.</span><span class="ident" id="8356211">dbs</span>&nbsp;<span class="op" id="8356215">=</span>&nbsp;<span class="builtinfunc" id="8356217">make</span><span class="op" id="8356221">(</span><span class="keyword" id="8356222">map</span><span class="op" id="8356225">[</span><span class="builtintype" id="8356226">string</span><span class="op" id="8356232">]</span><span class="op" id="8356233">*</span><span class="ident" id="8356234">fakeDB</span><span class="op" id="8356240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356243">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356246">db</span><span class="op" id="8356248">,</span>&nbsp;<span class="ident" id="8356250">ok</span>&nbsp;<span class="op" id="8356253">:=</span>&nbsp;<span class="ident" id="8356256">d</span><span class="op" id="8356257">.</span><span class="ident" id="8356258">dbs</span><span class="op" id="8356261">[</span><span class="ident" id="8356262">name</span><span class="op" id="8356266">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356269">if</span>&nbsp;<span class="op" id="8356272">!</span><span class="ident" id="8356273">ok</span>&nbsp;<span class="op" id="8356276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356280">db</span>&nbsp;<span class="op" id="8356283">=</span>&nbsp;<span class="op" id="8356285">&amp;</span><span class="ident" id="8356286">fakeDB</span><span class="op" id="8356292">{</span><span class="ident" id="8356293">name</span><span class="op" id="8356297">:</span>&nbsp;<span class="ident" id="8356299">name</span><span class="op" id="8356303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356307">d</span><span class="op" id="8356308">.</span><span class="ident" id="8356309">dbs</span><span class="op" id="8356312">[</span><span class="ident" id="8356313">name</span><span class="op" id="8356317">]</span>&nbsp;<span class="op" id="8356319">=</span>&nbsp;<span class="ident" id="8356321">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356325">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356328">return</span>&nbsp;<span class="ident" id="8356335">db</span><br>
<span class="lineno"></span><span class="op" id="8356338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8356341">func</span>&nbsp;<span class="op" id="8356346">(</span><span class="ident" id="8356347">db</span>&nbsp;<span class="op" id="8356350">*</span><span class="ident" id="8356351">fakeDB</span><span class="op" id="8356357">)</span>&nbsp;<span class="ident" id="8356359">wipe</span><span class="op" id="8356363">(</span><span class="op" id="8356364">)</span>&nbsp;<span class="op" id="8356366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356369">db</span><span class="op" id="8356371">.</span><span class="ident" id="8356372">mu</span><span class="op" id="8356374">.</span><span class="ident" id="8356375">Lock</span><span class="op" id="8356379">(</span><span class="op" id="8356380">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356383">defer</span>&nbsp;<span class="ident" id="8356389">db</span><span class="op" id="8356391">.</span><span class="ident" id="8356392">mu</span><span class="op" id="8356394">.</span><span class="ident" id="8356395">Unlock</span><span class="op" id="8356401">(</span><span class="op" id="8356402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356405">db</span><span class="op" id="8356407">.</span><span class="ident" id="8356408">tables</span>&nbsp;<span class="op" id="8356415">=</span>&nbsp;<span class="builtintype" id="8356417">nil</span><br>
<span class="lineno"></span><span class="op" id="8356421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8356424">func</span>&nbsp;<span class="op" id="8356429">(</span><span class="ident" id="8356430">db</span>&nbsp;<span class="op" id="8356433">*</span><span class="ident" id="8356434">fakeDB</span><span class="op" id="8356440">)</span>&nbsp;<span class="ident" id="8356442">createTable</span><span class="op" id="8356453">(</span><span class="ident" id="8356454">name</span>&nbsp;<span class="builtintype" id="8356459">string</span><span class="op" id="8356465">,</span>&nbsp;<span class="ident" id="8356467">columnNames</span><span class="op" id="8356478">,</span>&nbsp;<span class="ident" id="8356480">columnTypes</span>&nbsp;<span class="op" id="8356492">[</span><span class="op" id="8356493">]</span><span class="builtintype" id="8356494">string</span><span class="op" id="8356500">)</span>&nbsp;<span class="builtintype" id="8356502">error</span>&nbsp;<span class="op" id="8356508">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356511">db</span><span class="op" id="8356513">.</span><span class="ident" id="8356514">mu</span><span class="op" id="8356516">.</span><span class="ident" id="8356517">Lock</span><span class="op" id="8356521">(</span><span class="op" id="8356522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356525">defer</span>&nbsp;<span class="ident" id="8356531">db</span><span class="op" id="8356533">.</span><span class="ident" id="8356534">mu</span><span class="op" id="8356536">.</span><span class="ident" id="8356537">Unlock</span><span class="op" id="8356543">(</span><span class="op" id="8356544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356547">if</span>&nbsp;<span class="ident" id="8356550">db</span><span class="op" id="8356552">.</span><span class="ident" id="8356553">tables</span>&nbsp;<span class="op" id="8356560">==</span>&nbsp;<span class="builtintype" id="8356563">nil</span>&nbsp;<span class="op" id="8356567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356571">db</span><span class="op" id="8356573">.</span><span class="ident" id="8356574">tables</span>&nbsp;<span class="op" id="8356581">=</span>&nbsp;<span class="builtinfunc" id="8356583">make</span><span class="op" id="8356587">(</span><span class="keyword" id="8356588">map</span><span class="op" id="8356591">[</span><span class="builtintype" id="8356592">string</span><span class="op" id="8356598">]</span><span class="op" id="8356599">*</span><span class="ident" id="8356600">table</span><span class="op" id="8356605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356608">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356611">if</span>&nbsp;<span class="ident" id="8356614">_</span><span class="op" id="8356615">,</span>&nbsp;<span class="ident" id="8356617">exist</span>&nbsp;<span class="op" id="8356623">:=</span>&nbsp;<span class="ident" id="8356626">db</span><span class="op" id="8356628">.</span><span class="ident" id="8356629">tables</span><span class="op" id="8356635">[</span><span class="ident" id="8356636">name</span><span class="op" id="8356640">]</span><span class="op" id="8356641">;</span>&nbsp;<span class="ident" id="8356643">exist</span>&nbsp;<span class="op" id="8356649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356653">return</span>&nbsp;<span class="ident" id="8356660">fmt</span><span class="op" id="8356663">.</span><span class="ident" id="8356664">Errorf</span><span class="op" id="8356670">(</span><span class="string" id="8356671">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="8356696">,</span>&nbsp;<span class="ident" id="8356698">name</span><span class="op" id="8356702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356708">if</span>&nbsp;<span class="builtinfunc" id="8356711">len</span><span class="op" id="8356714">(</span><span class="ident" id="8356715">columnNames</span><span class="op" id="8356726">)</span>&nbsp;<span class="op" id="8356728">!=</span>&nbsp;<span class="builtinfunc" id="8356731">len</span><span class="op" id="8356734">(</span><span class="ident" id="8356735">columnTypes</span><span class="op" id="8356746">)</span>&nbsp;<span class="op" id="8356748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356752">return</span>&nbsp;<span class="ident" id="8356759">fmt</span><span class="op" id="8356762">.</span><span class="ident" id="8356763">Errorf</span><span class="op" id="8356769">(</span><span class="string" id="8356770">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="8356825">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356830">name</span><span class="op" id="8356834">,</span>&nbsp;<span class="builtinfunc" id="8356836">len</span><span class="op" id="8356839">(</span><span class="ident" id="8356840">columnNames</span><span class="op" id="8356851">)</span><span class="op" id="8356852">,</span>&nbsp;<span class="builtinfunc" id="8356854">len</span><span class="op" id="8356857">(</span><span class="ident" id="8356858">columnTypes</span><span class="op" id="8356869">)</span><span class="op" id="8356870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8356873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8356876">db</span><span class="op" id="8356878">.</span><span class="ident" id="8356879">tables</span><span class="op" id="8356885">[</span><span class="ident" id="8356886">name</span><span class="op" id="8356890">]</span>&nbsp;<span class="op" id="8356892">=</span>&nbsp;<span class="op" id="8356894">&amp;</span><span class="ident" id="8356895">table</span><span class="op" id="8356900">{</span><span class="ident" id="8356901">colname</span><span class="op" id="8356908">:</span>&nbsp;<span class="ident" id="8356910">columnNames</span><span class="op" id="8356921">,</span>&nbsp;<span class="ident" id="8356923">coltype</span><span class="op" id="8356930">:</span>&nbsp;<span class="ident" id="8356932">columnTypes</span><span class="op" id="8356943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8356946">return</span>&nbsp;<span class="builtintype" id="8356953">nil</span><br>
<span class="lineno"></span><span class="op" id="8356957">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="8356960">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="8356999">func</span>&nbsp;<span class="op" id="8357004">(</span><span class="ident" id="8357005">db</span>&nbsp;<span class="op" id="8357008">*</span><span class="ident" id="8357009">fakeDB</span><span class="op" id="8357015">)</span>&nbsp;<span class="ident" id="8357017">table</span><span class="op" id="8357022">(</span><span class="ident" id="8357023">table</span>&nbsp;<span class="builtintype" id="8357029">string</span><span class="op" id="8357035">)</span>&nbsp;<span class="op" id="8357037">(</span><span class="op" id="8357038">*</span><span class="ident" id="8357039">table</span><span class="op" id="8357044">,</span>&nbsp;<span class="builtintype" id="8357046">bool</span><span class="op" id="8357050">)</span>&nbsp;<span class="op" id="8357052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357055">if</span>&nbsp;<span class="ident" id="8357058">db</span><span class="op" id="8357060">.</span><span class="ident" id="8357061">tables</span>&nbsp;<span class="op" id="8357068">==</span>&nbsp;<span class="builtintype" id="8357071">nil</span>&nbsp;<span class="op" id="8357075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357079">return</span>&nbsp;<span class="builtintype" id="8357086">nil</span><span class="op" id="8357089">,</span>&nbsp;<span class="builtintype" id="8357091">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357101">t</span><span class="op" id="8357102">,</span>&nbsp;<span class="ident" id="8357104">ok</span>&nbsp;<span class="op" id="8357107">:=</span>&nbsp;<span class="ident" id="8357110">db</span><span class="op" id="8357112">.</span><span class="ident" id="8357113">tables</span><span class="op" id="8357119">[</span><span class="ident" id="8357120">table</span><span class="op" id="8357125">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357128">return</span>&nbsp;<span class="ident" id="8357135">t</span><span class="op" id="8357136">,</span>&nbsp;<span class="ident" id="8357138">ok</span><br>
<span class="lineno"></span><span class="op" id="8357141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="8357144">func</span>&nbsp;<span class="op" id="8357149">(</span><span class="ident" id="8357150">db</span>&nbsp;<span class="op" id="8357153">*</span><span class="ident" id="8357154">fakeDB</span><span class="op" id="8357160">)</span>&nbsp;<span class="ident" id="8357162">columnType</span><span class="op" id="8357172">(</span><span class="ident" id="8357173">table</span><span class="op" id="8357178">,</span>&nbsp;<span class="ident" id="8357180">column</span>&nbsp;<span class="builtintype" id="8357187">string</span><span class="op" id="8357193">)</span>&nbsp;<span class="op" id="8357195">(</span><span class="ident" id="8357196">typ</span>&nbsp;<span class="builtintype" id="8357200">string</span><span class="op" id="8357206">,</span>&nbsp;<span class="ident" id="8357208">ok</span>&nbsp;<span class="builtintype" id="8357211">bool</span><span class="op" id="8357215">)</span>&nbsp;<span class="op" id="8357217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357220">db</span><span class="op" id="8357222">.</span><span class="ident" id="8357223">mu</span><span class="op" id="8357225">.</span><span class="ident" id="8357226">Lock</span><span class="op" id="8357230">(</span><span class="op" id="8357231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357234">defer</span>&nbsp;<span class="ident" id="8357240">db</span><span class="op" id="8357242">.</span><span class="ident" id="8357243">mu</span><span class="op" id="8357245">.</span><span class="ident" id="8357246">Unlock</span><span class="op" id="8357252">(</span><span class="op" id="8357253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357256">t</span><span class="op" id="8357257">,</span>&nbsp;<span class="ident" id="8357259">ok</span>&nbsp;<span class="op" id="8357262">:=</span>&nbsp;<span class="ident" id="8357265">db</span><span class="op" id="8357267">.</span><span class="ident" id="8357268">table</span><span class="op" id="8357273">(</span><span class="ident" id="8357274">table</span><span class="op" id="8357279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357282">if</span>&nbsp;<span class="op" id="8357285">!</span><span class="ident" id="8357286">ok</span>&nbsp;<span class="op" id="8357289">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357293">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357304">for</span>&nbsp;<span class="ident" id="8357308">n</span><span class="op" id="8357309">,</span>&nbsp;<span class="ident" id="8357311">cname</span>&nbsp;<span class="op" id="8357317">:=</span>&nbsp;<span class="keyword" id="8357320">range</span>&nbsp;<span class="ident" id="8357326">t</span><span class="op" id="8357327">.</span><span class="ident" id="8357328">colname</span>&nbsp;<span class="op" id="8357336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357340">if</span>&nbsp;<span class="ident" id="8357343">cname</span>&nbsp;<span class="op" id="8357349">==</span>&nbsp;<span class="ident" id="8357352">column</span>&nbsp;<span class="op" id="8357359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357364">return</span>&nbsp;<span class="ident" id="8357371">t</span><span class="op" id="8357372">.</span><span class="ident" id="8357373">coltype</span><span class="op" id="8357380">[</span><span class="ident" id="8357381">n</span><span class="op" id="8357382">]</span><span class="op" id="8357383">,</span>&nbsp;<span class="builtintype" id="8357385">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357398">return</span>&nbsp;<span class="string" id="8357405">&#34;&#34;</span><span class="op" id="8357407">,</span>&nbsp;<span class="builtintype" id="8357409">false</span><br>
<span class="lineno"></span><span class="op" id="8357415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="8357418">func</span>&nbsp;<span class="op" id="8357423">(</span><span class="ident" id="8357424">c</span>&nbsp;<span class="op" id="8357426">*</span><span class="ident" id="8357427">fakeConn</span><span class="op" id="8357435">)</span>&nbsp;<span class="ident" id="8357437">isBad</span><span class="op" id="8357442">(</span><span class="op" id="8357443">)</span>&nbsp;<span class="builtintype" id="8357445">bool</span>&nbsp;<span class="op" id="8357450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8357453">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357496">if</span>&nbsp;<span class="op" id="8357499">!</span><span class="ident" id="8357500">c</span><span class="op" id="8357501">.</span><span class="ident" id="8357502">bad</span>&nbsp;<span class="op" id="8357506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357510">return</span>&nbsp;<span class="builtintype" id="8357517">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357524">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8357527">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357575">c</span><span class="op" id="8357576">.</span><span class="ident" id="8357577">db</span><span class="op" id="8357579">.</span><span class="ident" id="8357580">badConn</span>&nbsp;<span class="op" id="8357588">=</span>&nbsp;<span class="op" id="8357590">!</span><span class="ident" id="8357591">c</span><span class="op" id="8357592">.</span><span class="ident" id="8357593">db</span><span class="op" id="8357595">.</span><span class="ident" id="8357596">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357605">return</span>&nbsp;<span class="ident" id="8357612">c</span><span class="op" id="8357613">.</span><span class="ident" id="8357614">db</span><span class="op" id="8357616">.</span><span class="ident" id="8357617">badConn</span><br>
<span class="lineno"></span><span class="op" id="8357625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="8357628">func</span>&nbsp;<span class="op" id="8357633">(</span><span class="ident" id="8357634">c</span>&nbsp;<span class="op" id="8357636">*</span><span class="ident" id="8357637">fakeConn</span><span class="op" id="8357645">)</span>&nbsp;<span class="ident" id="8357647">Begin</span><span class="op" id="8357652">(</span><span class="op" id="8357653">)</span>&nbsp;<span class="op" id="8357655">(</span><span class="ident" id="8357656">driver</span><span class="op" id="8357662">.</span><span class="ident" id="8357663">Tx</span><span class="op" id="8357665">,</span>&nbsp;<span class="builtintype" id="8357667">error</span><span class="op" id="8357672">)</span>&nbsp;<span class="op" id="8357674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357677">if</span>&nbsp;<span class="ident" id="8357680">c</span><span class="op" id="8357681">.</span><span class="ident" id="8357682">isBad</span><span class="op" id="8357687">(</span><span class="op" id="8357688">)</span>&nbsp;<span class="op" id="8357690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357694">return</span>&nbsp;<span class="builtintype" id="8357701">nil</span><span class="op" id="8357704">,</span>&nbsp;<span class="ident" id="8357706">driver</span><span class="op" id="8357712">.</span><span class="ident" id="8357713">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357728">if</span>&nbsp;<span class="ident" id="8357731">c</span><span class="op" id="8357732">.</span><span class="ident" id="8357733">currTx</span>&nbsp;<span class="op" id="8357740">!=</span>&nbsp;<span class="builtintype" id="8357743">nil</span>&nbsp;<span class="op" id="8357747">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357751">return</span>&nbsp;<span class="builtintype" id="8357758">nil</span><span class="op" id="8357761">,</span>&nbsp;<span class="ident" id="8357763">errors</span><span class="op" id="8357769">.</span><span class="ident" id="8357770">New</span><span class="op" id="8357773">(</span><span class="string" id="8357774">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="8357800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8357803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357806">c</span><span class="op" id="8357807">.</span><span class="ident" id="8357808">currTx</span>&nbsp;<span class="op" id="8357815">=</span>&nbsp;<span class="op" id="8357817">&amp;</span><span class="ident" id="8357818">fakeTx</span><span class="op" id="8357824">{</span><span class="ident" id="8357825">c</span><span class="op" id="8357826">:</span>&nbsp;<span class="ident" id="8357828">c</span><span class="op" id="8357829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8357832">return</span>&nbsp;<span class="ident" id="8357839">c</span><span class="op" id="8357840">.</span><span class="ident" id="8357841">currTx</span><span class="op" id="8357847">,</span>&nbsp;<span class="builtintype" id="8357849">nil</span><br>
<span class="lineno"></span><span class="op" id="8357853">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="8357856">var</span>&nbsp;<span class="ident" id="8357860">hookPostCloseConn</span>&nbsp;<span class="keyword" id="8357878">struct</span>&nbsp;<span class="op" id="8357885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357888">sync</span><span class="op" id="8357892">.</span><span class="ident" id="8357893">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357900">fn</span>&nbsp;<span class="keyword" id="8357903">func</span><span class="op" id="8357907">(</span><span class="op" id="8357908">*</span><span class="ident" id="8357909">fakeConn</span><span class="op" id="8357917">,</span>&nbsp;<span class="builtintype" id="8357919">error</span><span class="op" id="8357924">)</span><br>
<span class="lineno"></span><span class="op" id="8357926">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="8357929">func</span>&nbsp;<span class="ident" id="8357934">setHookpostCloseConn</span><span class="op" id="8357954">(</span><span class="ident" id="8357955">fn</span>&nbsp;<span class="keyword" id="8357958">func</span><span class="op" id="8357962">(</span><span class="op" id="8357963">*</span><span class="ident" id="8357964">fakeConn</span><span class="op" id="8357972">,</span>&nbsp;<span class="builtintype" id="8357974">error</span><span class="op" id="8357979">)</span><span class="op" id="8357980">)</span>&nbsp;<span class="op" id="8357982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8357985">hookPostCloseConn</span><span class="op" id="8358002">.</span><span class="ident" id="8358003">Lock</span><span class="op" id="8358007">(</span><span class="op" id="8358008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358011">defer</span>&nbsp;<span class="ident" id="8358017">hookPostCloseConn</span><span class="op" id="8358034">.</span><span class="ident" id="8358035">Unlock</span><span class="op" id="8358041">(</span><span class="op" id="8358042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358045">hookPostCloseConn</span><span class="op" id="8358062">.</span><span class="ident" id="8358063">fn</span>&nbsp;<span class="op" id="8358066">=</span>&nbsp;<span class="ident" id="8358068">fn</span><br>
<span class="lineno">275</span><span class="op" id="8358071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8358074">var</span>&nbsp;<span class="ident" id="8358078">testStrictClose</span>&nbsp;<span class="op" id="8358094">*</span><span class="ident" id="8358095">testing</span><span class="op" id="8358102">.</span><span class="ident" id="8358103">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8358106">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="8358176">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="8358226">func</span>&nbsp;<span class="ident" id="8358231">setStrictFakeConnClose</span><span class="op" id="8358253">(</span><span class="ident" id="8358254">t</span>&nbsp;<span class="op" id="8358256">*</span><span class="ident" id="8358257">testing</span><span class="op" id="8358264">.</span><span class="ident" id="8358265">T</span><span class="op" id="8358266">)</span>&nbsp;<span class="op" id="8358268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358271">testStrictClose</span>&nbsp;<span class="op" id="8358287">=</span>&nbsp;<span class="ident" id="8358289">t</span><br>
<span class="lineno"></span><span class="op" id="8358291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="8358294">func</span>&nbsp;<span class="op" id="8358299">(</span><span class="ident" id="8358300">c</span>&nbsp;<span class="op" id="8358302">*</span><span class="ident" id="8358303">fakeConn</span><span class="op" id="8358311">)</span>&nbsp;<span class="ident" id="8358313">Close</span><span class="op" id="8358318">(</span><span class="op" id="8358319">)</span>&nbsp;<span class="op" id="8358321">(</span><span class="ident" id="8358322">err</span>&nbsp;<span class="builtintype" id="8358326">error</span><span class="op" id="8358331">)</span>&nbsp;<span class="op" id="8358333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358336">drv</span>&nbsp;<span class="op" id="8358340">:=</span>&nbsp;<span class="ident" id="8358343">fdriver</span><span class="op" id="8358350">.</span><span class="op" id="8358351">(</span><span class="op" id="8358352">*</span><span class="ident" id="8358353">fakeDriver</span><span class="op" id="8358363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358366">defer</span>&nbsp;<span class="keyword" id="8358372">func</span><span class="op" id="8358376">(</span><span class="op" id="8358377">)</span>&nbsp;<span class="op" id="8358379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358383">if</span>&nbsp;<span class="ident" id="8358386">err</span>&nbsp;<span class="op" id="8358390">!=</span>&nbsp;<span class="builtintype" id="8358393">nil</span>&nbsp;<span class="op" id="8358397">&amp;&amp;</span>&nbsp;<span class="ident" id="8358400">testStrictClose</span>&nbsp;<span class="op" id="8358416">!=</span>&nbsp;<span class="builtintype" id="8358419">nil</span>&nbsp;<span class="op" id="8358423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358428">testStrictClose</span><span class="op" id="8358443">.</span><span class="ident" id="8358444">Errorf</span><span class="op" id="8358450">(</span><span class="string" id="8358451">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8358488">,</span>&nbsp;<span class="ident" id="8358490">err</span><span class="op" id="8358493">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358501">hookPostCloseConn</span><span class="op" id="8358518">.</span><span class="ident" id="8358519">Lock</span><span class="op" id="8358523">(</span><span class="op" id="8358524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358528">fn</span>&nbsp;<span class="op" id="8358531">:=</span>&nbsp;<span class="ident" id="8358534">hookPostCloseConn</span><span class="op" id="8358551">.</span><span class="ident" id="8358552">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358557">hookPostCloseConn</span><span class="op" id="8358574">.</span><span class="ident" id="8358575">Unlock</span><span class="op" id="8358581">(</span><span class="op" id="8358582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358586">if</span>&nbsp;<span class="ident" id="8358589">fn</span>&nbsp;<span class="op" id="8358592">!=</span>&nbsp;<span class="builtintype" id="8358595">nil</span>&nbsp;<span class="op" id="8358599">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358604">fn</span><span class="op" id="8358606">(</span><span class="ident" id="8358607">c</span><span class="op" id="8358608">,</span>&nbsp;<span class="ident" id="8358610">err</span><span class="op" id="8358613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358621">if</span>&nbsp;<span class="ident" id="8358624">err</span>&nbsp;<span class="op" id="8358628">==</span>&nbsp;<span class="builtintype" id="8358631">nil</span>&nbsp;<span class="op" id="8358635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358640">drv</span><span class="op" id="8358643">.</span><span class="ident" id="8358644">mu</span><span class="op" id="8358646">.</span><span class="ident" id="8358647">Lock</span><span class="op" id="8358651">(</span><span class="op" id="8358652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358657">drv</span><span class="op" id="8358660">.</span><span class="ident" id="8358661">closeCount</span><span class="op" id="8358671">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358677">drv</span><span class="op" id="8358680">.</span><span class="ident" id="8358681">mu</span><span class="op" id="8358683">.</span><span class="ident" id="8358684">Unlock</span><span class="op" id="8358690">(</span><span class="op" id="8358691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358698">}</span><span class="op" id="8358699">(</span><span class="op" id="8358700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358703">if</span>&nbsp;<span class="ident" id="8358706">c</span><span class="op" id="8358707">.</span><span class="ident" id="8358708">currTx</span>&nbsp;<span class="op" id="8358715">!=</span>&nbsp;<span class="builtintype" id="8358718">nil</span>&nbsp;<span class="op" id="8358722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358726">return</span>&nbsp;<span class="ident" id="8358733">errors</span><span class="op" id="8358739">.</span><span class="ident" id="8358740">New</span><span class="op" id="8358743">(</span><span class="string" id="8358744">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="8358784">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358790">if</span>&nbsp;<span class="ident" id="8358793">c</span><span class="op" id="8358794">.</span><span class="ident" id="8358795">db</span>&nbsp;<span class="op" id="8358798">==</span>&nbsp;<span class="builtintype" id="8358801">nil</span>&nbsp;<span class="op" id="8358805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358809">return</span>&nbsp;<span class="ident" id="8358816">errors</span><span class="op" id="8358822">.</span><span class="ident" id="8358823">New</span><span class="op" id="8358826">(</span><span class="string" id="8358827">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="8358865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358871">if</span>&nbsp;<span class="ident" id="8358874">c</span><span class="op" id="8358875">.</span><span class="ident" id="8358876">stmtsMade</span>&nbsp;<span class="op" id="8358886">&gt;</span>&nbsp;<span class="ident" id="8358888">c</span><span class="op" id="8358889">.</span><span class="ident" id="8358890">stmtsClosed</span>&nbsp;<span class="op" id="8358902">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358906">return</span>&nbsp;<span class="ident" id="8358913">errors</span><span class="op" id="8358919">.</span><span class="ident" id="8358920">New</span><span class="op" id="8358923">(</span><span class="string" id="8358924">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="8358960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8358963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8358966">c</span><span class="op" id="8358967">.</span><span class="ident" id="8358968">db</span>&nbsp;<span class="op" id="8358971">=</span>&nbsp;<span class="builtintype" id="8358973">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8358978">return</span>&nbsp;<span class="builtintype" id="8358985">nil</span><br>
<span class="lineno"></span><span class="op" id="8358989">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="8358992">func</span>&nbsp;<span class="ident" id="8358997">checkSubsetTypes</span><span class="op" id="8359013">(</span><span class="ident" id="8359014">args</span>&nbsp;<span class="op" id="8359019">[</span><span class="op" id="8359020">]</span><span class="ident" id="8359021">driver</span><span class="op" id="8359027">.</span><span class="ident" id="8359028">Value</span><span class="op" id="8359033">)</span>&nbsp;<span class="builtintype" id="8359035">error</span>&nbsp;<span class="op" id="8359041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359044">for</span>&nbsp;<span class="ident" id="8359048">n</span><span class="op" id="8359049">,</span>&nbsp;<span class="ident" id="8359051">arg</span>&nbsp;<span class="op" id="8359055">:=</span>&nbsp;<span class="keyword" id="8359058">range</span>&nbsp;<span class="ident" id="8359064">args</span>&nbsp;<span class="op" id="8359069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359073">switch</span>&nbsp;<span class="ident" id="8359080">arg</span><span class="op" id="8359083">.</span><span class="op" id="8359084">(</span><span class="keyword" id="8359085">type</span><span class="op" id="8359089">)</span>&nbsp;<span class="op" id="8359091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359095">case</span>&nbsp;<span class="builtintype" id="8359100">int64</span><span class="op" id="8359105">,</span>&nbsp;<span class="builtintype" id="8359107">float64</span><span class="op" id="8359114">,</span>&nbsp;<span class="builtintype" id="8359116">bool</span><span class="op" id="8359120">,</span>&nbsp;<span class="builtintype" id="8359122">nil</span><span class="op" id="8359125">,</span>&nbsp;<span class="op" id="8359127">[</span><span class="op" id="8359128">]</span><span class="builtintype" id="8359129">byte</span><span class="op" id="8359133">,</span>&nbsp;<span class="builtintype" id="8359135">string</span><span class="op" id="8359141">,</span>&nbsp;<span class="ident" id="8359143">time</span><span class="op" id="8359147">.</span><span class="ident" id="8359148">Time</span><span class="op" id="8359152">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359156">default</span><span class="op" id="8359163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359168">return</span>&nbsp;<span class="ident" id="8359175">fmt</span><span class="op" id="8359178">.</span><span class="ident" id="8359179">Errorf</span><span class="op" id="8359185">(</span><span class="string" id="8359186">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="8359234">,</span>&nbsp;<span class="ident" id="8359236">n</span><span class="op" id="8359237">+</span><span class="num" id="8359238">1</span><span class="op" id="8359239">,</span>&nbsp;<span class="ident" id="8359241">arg</span><span class="op" id="8359244">,</span>&nbsp;<span class="ident" id="8359246">arg</span><span class="op" id="8359249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8359253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8359256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359259">return</span>&nbsp;<span class="builtintype" id="8359266">nil</span><br>
<span class="lineno">325</span><span class="op" id="8359270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8359273">func</span>&nbsp;<span class="op" id="8359278">(</span><span class="ident" id="8359279">c</span>&nbsp;<span class="op" id="8359281">*</span><span class="ident" id="8359282">fakeConn</span><span class="op" id="8359290">)</span>&nbsp;<span class="ident" id="8359292">Exec</span><span class="op" id="8359296">(</span><span class="ident" id="8359297">query</span>&nbsp;<span class="builtintype" id="8359303">string</span><span class="op" id="8359309">,</span>&nbsp;<span class="ident" id="8359311">args</span>&nbsp;<span class="op" id="8359316">[</span><span class="op" id="8359317">]</span><span class="ident" id="8359318">driver</span><span class="op" id="8359324">.</span><span class="ident" id="8359325">Value</span><span class="op" id="8359330">)</span>&nbsp;<span class="op" id="8359332">(</span><span class="ident" id="8359333">driver</span><span class="op" id="8359339">.</span><span class="ident" id="8359340">Result</span><span class="op" id="8359346">,</span>&nbsp;<span class="builtintype" id="8359348">error</span><span class="op" id="8359353">)</span>&nbsp;<span class="op" id="8359355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359358">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359419">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359480">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359539">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8359566">err</span>&nbsp;<span class="op" id="8359570">:=</span>&nbsp;<span class="ident" id="8359573">checkSubsetTypes</span><span class="op" id="8359589">(</span><span class="ident" id="8359590">args</span><span class="op" id="8359594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359597">if</span>&nbsp;<span class="ident" id="8359600">err</span>&nbsp;<span class="op" id="8359604">!=</span>&nbsp;<span class="builtintype" id="8359607">nil</span>&nbsp;<span class="op" id="8359611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359615">return</span>&nbsp;<span class="builtintype" id="8359622">nil</span><span class="op" id="8359625">,</span>&nbsp;<span class="ident" id="8359627">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8359632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359635">return</span>&nbsp;<span class="builtintype" id="8359642">nil</span><span class="op" id="8359645">,</span>&nbsp;<span class="ident" id="8359647">driver</span><span class="op" id="8359653">.</span><span class="ident" id="8359654">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="8359662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8359665">func</span>&nbsp;<span class="op" id="8359670">(</span><span class="ident" id="8359671">c</span>&nbsp;<span class="op" id="8359673">*</span><span class="ident" id="8359674">fakeConn</span><span class="op" id="8359682">)</span>&nbsp;<span class="ident" id="8359684">Query</span><span class="op" id="8359689">(</span><span class="ident" id="8359690">query</span>&nbsp;<span class="builtintype" id="8359696">string</span><span class="op" id="8359702">,</span>&nbsp;<span class="ident" id="8359704">args</span>&nbsp;<span class="op" id="8359709">[</span><span class="op" id="8359710">]</span><span class="ident" id="8359711">driver</span><span class="op" id="8359717">.</span><span class="ident" id="8359718">Value</span><span class="op" id="8359723">)</span>&nbsp;<span class="op" id="8359725">(</span><span class="ident" id="8359726">driver</span><span class="op" id="8359732">.</span><span class="ident" id="8359733">Rows</span><span class="op" id="8359737">,</span>&nbsp;<span class="builtintype" id="8359739">error</span><span class="op" id="8359744">)</span>&nbsp;<span class="op" id="8359746">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359749">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359810">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359871">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8359930">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8359957">err</span>&nbsp;<span class="op" id="8359961">:=</span>&nbsp;<span class="ident" id="8359964">checkSubsetTypes</span><span class="op" id="8359980">(</span><span class="ident" id="8359981">args</span><span class="op" id="8359985">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8359988">if</span>&nbsp;<span class="ident" id="8359991">err</span>&nbsp;<span class="op" id="8359995">!=</span>&nbsp;<span class="builtintype" id="8359998">nil</span>&nbsp;<span class="op" id="8360002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360006">return</span>&nbsp;<span class="builtintype" id="8360013">nil</span><span class="op" id="8360016">,</span>&nbsp;<span class="ident" id="8360018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8360023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360026">return</span>&nbsp;<span class="builtintype" id="8360033">nil</span><span class="op" id="8360036">,</span>&nbsp;<span class="ident" id="8360038">driver</span><span class="op" id="8360044">.</span><span class="ident" id="8360045">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="8360053">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="8360056">func</span>&nbsp;<span class="ident" id="8360061">errf</span><span class="op" id="8360065">(</span><span class="ident" id="8360066">msg</span>&nbsp;<span class="builtintype" id="8360070">string</span><span class="op" id="8360076">,</span>&nbsp;<span class="ident" id="8360078">args</span>&nbsp;<span class="op" id="8360083">...</span><span class="keyword" id="8360086">interface</span><span class="op" id="8360095">{</span><span class="op" id="8360096">}</span><span class="op" id="8360097">)</span>&nbsp;<span class="builtintype" id="8360099">error</span>&nbsp;<span class="op" id="8360105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360108">return</span>&nbsp;<span class="ident" id="8360115">errors</span><span class="op" id="8360121">.</span><span class="ident" id="8360122">New</span><span class="op" id="8360125">(</span><span class="string" id="8360126">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="8360137">+</span>&nbsp;<span class="ident" id="8360139">fmt</span><span class="op" id="8360142">.</span><span class="ident" id="8360143">Sprintf</span><span class="op" id="8360150">(</span><span class="ident" id="8360151">msg</span><span class="op" id="8360154">,</span>&nbsp;<span class="ident" id="8360156">args</span><span class="op" id="8360160">...</span><span class="op" id="8360163">)</span><span class="op" id="8360164">)</span><br>
<span class="lineno"></span><span class="op" id="8360166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="8360169">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="8360233">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="8360290">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="8360324">func</span>&nbsp;<span class="op" id="8360329">(</span><span class="ident" id="8360330">c</span>&nbsp;<span class="op" id="8360332">*</span><span class="ident" id="8360333">fakeConn</span><span class="op" id="8360341">)</span>&nbsp;<span class="ident" id="8360343">prepareSelect</span><span class="op" id="8360356">(</span><span class="ident" id="8360357">stmt</span>&nbsp;<span class="op" id="8360362">*</span><span class="ident" id="8360363">fakeStmt</span><span class="op" id="8360371">,</span>&nbsp;<span class="ident" id="8360373">parts</span>&nbsp;<span class="op" id="8360379">[</span><span class="op" id="8360380">]</span><span class="builtintype" id="8360381">string</span><span class="op" id="8360387">)</span>&nbsp;<span class="op" id="8360389">(</span><span class="ident" id="8360390">driver</span><span class="op" id="8360396">.</span><span class="ident" id="8360397">Stmt</span><span class="op" id="8360401">,</span>&nbsp;<span class="builtintype" id="8360403">error</span><span class="op" id="8360408">)</span>&nbsp;<span class="op" id="8360410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360413">if</span>&nbsp;<span class="builtinfunc" id="8360416">len</span><span class="op" id="8360419">(</span><span class="ident" id="8360420">parts</span><span class="op" id="8360425">)</span>&nbsp;<span class="op" id="8360427">!=</span>&nbsp;<span class="num" id="8360430">3</span>&nbsp;<span class="op" id="8360432">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360436">stmt</span><span class="op" id="8360440">.</span><span class="ident" id="8360441">Close</span><span class="op" id="8360446">(</span><span class="op" id="8360447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360451">return</span>&nbsp;<span class="builtintype" id="8360458">nil</span><span class="op" id="8360461">,</span>&nbsp;<span class="ident" id="8360463">errf</span><span class="op" id="8360467">(</span><span class="string" id="8360468">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="8360513">,</span>&nbsp;<span class="builtinfunc" id="8360515">len</span><span class="op" id="8360518">(</span><span class="ident" id="8360519">parts</span><span class="op" id="8360524">)</span><span class="op" id="8360525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8360528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360531">stmt</span><span class="op" id="8360535">.</span><span class="ident" id="8360536">table</span>&nbsp;<span class="op" id="8360542">=</span>&nbsp;<span class="ident" id="8360544">parts</span><span class="op" id="8360549">[</span><span class="num" id="8360550">0</span><span class="op" id="8360551">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360554">stmt</span><span class="op" id="8360558">.</span><span class="ident" id="8360559">colName</span>&nbsp;<span class="op" id="8360567">=</span>&nbsp;<span class="ident" id="8360569">strings</span><span class="op" id="8360576">.</span><span class="ident" id="8360577">Split</span><span class="op" id="8360582">(</span><span class="ident" id="8360583">parts</span><span class="op" id="8360588">[</span><span class="num" id="8360589">1</span><span class="op" id="8360590">]</span><span class="op" id="8360591">,</span>&nbsp;<span class="string" id="8360593">&#34;,&#34;</span><span class="op" id="8360596">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360599">for</span>&nbsp;<span class="ident" id="8360603">n</span><span class="op" id="8360604">,</span>&nbsp;<span class="ident" id="8360606">colspec</span>&nbsp;<span class="op" id="8360614">:=</span>&nbsp;<span class="keyword" id="8360617">range</span>&nbsp;<span class="ident" id="8360623">strings</span><span class="op" id="8360630">.</span><span class="ident" id="8360631">Split</span><span class="op" id="8360636">(</span><span class="ident" id="8360637">parts</span><span class="op" id="8360642">[</span><span class="num" id="8360643">2</span><span class="op" id="8360644">]</span><span class="op" id="8360645">,</span>&nbsp;<span class="string" id="8360647">&#34;,&#34;</span><span class="op" id="8360650">)</span>&nbsp;<span class="op" id="8360652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360656">if</span>&nbsp;<span class="ident" id="8360659">colspec</span>&nbsp;<span class="op" id="8360667">==</span>&nbsp;<span class="string" id="8360670">&#34;&#34;</span>&nbsp;<span class="op" id="8360673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360678">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8360689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360693">nameVal</span>&nbsp;<span class="op" id="8360701">:=</span>&nbsp;<span class="ident" id="8360704">strings</span><span class="op" id="8360711">.</span><span class="ident" id="8360712">Split</span><span class="op" id="8360717">(</span><span class="ident" id="8360718">colspec</span><span class="op" id="8360725">,</span>&nbsp;<span class="string" id="8360727">&#34;=&#34;</span><span class="op" id="8360730">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360734">if</span>&nbsp;<span class="builtinfunc" id="8360737">len</span><span class="op" id="8360740">(</span><span class="ident" id="8360741">nameVal</span><span class="op" id="8360748">)</span>&nbsp;<span class="op" id="8360750">!=</span>&nbsp;<span class="num" id="8360753">2</span>&nbsp;<span class="op" id="8360755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360760">stmt</span><span class="op" id="8360764">.</span><span class="ident" id="8360765">Close</span><span class="op" id="8360770">(</span><span class="op" id="8360771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360776">return</span>&nbsp;<span class="builtintype" id="8360783">nil</span><span class="op" id="8360786">,</span>&nbsp;<span class="ident" id="8360788">errf</span><span class="op" id="8360792">(</span><span class="string" id="8360793">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="8360854">,</span>&nbsp;<span class="ident" id="8360856">stmt</span><span class="op" id="8360860">.</span><span class="ident" id="8360861">table</span><span class="op" id="8360866">,</span>&nbsp;<span class="ident" id="8360868">colspec</span><span class="op" id="8360875">,</span>&nbsp;<span class="ident" id="8360877">n</span><span class="op" id="8360878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8360882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360886">column</span><span class="op" id="8360892">,</span>&nbsp;<span class="ident" id="8360894">value</span>&nbsp;<span class="op" id="8360900">:=</span>&nbsp;<span class="ident" id="8360903">nameVal</span><span class="op" id="8360910">[</span><span class="num" id="8360911">0</span><span class="op" id="8360912">]</span><span class="op" id="8360913">,</span>&nbsp;<span class="ident" id="8360915">nameVal</span><span class="op" id="8360922">[</span><span class="num" id="8360923">1</span><span class="op" id="8360924">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360928">_</span><span class="op" id="8360929">,</span>&nbsp;<span class="ident" id="8360931">ok</span>&nbsp;<span class="op" id="8360934">:=</span>&nbsp;<span class="ident" id="8360937">c</span><span class="op" id="8360938">.</span><span class="ident" id="8360939">db</span><span class="op" id="8360941">.</span><span class="ident" id="8360942">columnType</span><span class="op" id="8360952">(</span><span class="ident" id="8360953">stmt</span><span class="op" id="8360957">.</span><span class="ident" id="8360958">table</span><span class="op" id="8360963">,</span>&nbsp;<span class="ident" id="8360965">column</span><span class="op" id="8360971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8360975">if</span>&nbsp;<span class="op" id="8360978">!</span><span class="ident" id="8360979">ok</span>&nbsp;<span class="op" id="8360982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8360987">stmt</span><span class="op" id="8360991">.</span><span class="ident" id="8360992">Close</span><span class="op" id="8360997">(</span><span class="op" id="8360998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361003">return</span>&nbsp;<span class="builtintype" id="8361010">nil</span><span class="op" id="8361013">,</span>&nbsp;<span class="ident" id="8361015">errf</span><span class="op" id="8361019">(</span><span class="string" id="8361020">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="8361074">,</span>&nbsp;<span class="ident" id="8361076">stmt</span><span class="op" id="8361080">.</span><span class="ident" id="8361081">table</span><span class="op" id="8361086">,</span>&nbsp;<span class="ident" id="8361088">column</span><span class="op" id="8361094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361098">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361102">if</span>&nbsp;<span class="ident" id="8361105">value</span>&nbsp;<span class="op" id="8361111">!=</span>&nbsp;<span class="string" id="8361114">&#34;?&#34;</span>&nbsp;<span class="op" id="8361118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361123">stmt</span><span class="op" id="8361127">.</span><span class="ident" id="8361128">Close</span><span class="op" id="8361133">(</span><span class="op" id="8361134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361139">return</span>&nbsp;<span class="builtintype" id="8361146">nil</span><span class="op" id="8361149">,</span>&nbsp;<span class="ident" id="8361151">errf</span><span class="op" id="8361155">(</span><span class="string" id="8361156">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="8361238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361244">stmt</span><span class="op" id="8361248">.</span><span class="ident" id="8361249">table</span><span class="op" id="8361254">,</span>&nbsp;<span class="ident" id="8361256">column</span><span class="op" id="8361262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361266">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361270">stmt</span><span class="op" id="8361274">.</span><span class="ident" id="8361275">whereCol</span>&nbsp;<span class="op" id="8361284">=</span>&nbsp;<span class="builtinfunc" id="8361286">append</span><span class="op" id="8361292">(</span><span class="ident" id="8361293">stmt</span><span class="op" id="8361297">.</span><span class="ident" id="8361298">whereCol</span><span class="op" id="8361306">,</span>&nbsp;<span class="ident" id="8361308">column</span><span class="op" id="8361314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361318">stmt</span><span class="op" id="8361322">.</span><span class="ident" id="8361323">placeholders</span><span class="op" id="8361335">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361342">return</span>&nbsp;<span class="ident" id="8361349">stmt</span><span class="op" id="8361353">,</span>&nbsp;<span class="builtintype" id="8361355">nil</span><br>
<span class="lineno"></span><span class="op" id="8361359">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="8361362">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="8361401">func</span>&nbsp;<span class="op" id="8361406">(</span><span class="ident" id="8361407">c</span>&nbsp;<span class="op" id="8361409">*</span><span class="ident" id="8361410">fakeConn</span><span class="op" id="8361418">)</span>&nbsp;<span class="ident" id="8361420">prepareCreate</span><span class="op" id="8361433">(</span><span class="ident" id="8361434">stmt</span>&nbsp;<span class="op" id="8361439">*</span><span class="ident" id="8361440">fakeStmt</span><span class="op" id="8361448">,</span>&nbsp;<span class="ident" id="8361450">parts</span>&nbsp;<span class="op" id="8361456">[</span><span class="op" id="8361457">]</span><span class="builtintype" id="8361458">string</span><span class="op" id="8361464">)</span>&nbsp;<span class="op" id="8361466">(</span><span class="ident" id="8361467">driver</span><span class="op" id="8361473">.</span><span class="ident" id="8361474">Stmt</span><span class="op" id="8361478">,</span>&nbsp;<span class="builtintype" id="8361480">error</span><span class="op" id="8361485">)</span>&nbsp;<span class="op" id="8361487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361490">if</span>&nbsp;<span class="builtinfunc" id="8361493">len</span><span class="op" id="8361496">(</span><span class="ident" id="8361497">parts</span><span class="op" id="8361502">)</span>&nbsp;<span class="op" id="8361504">!=</span>&nbsp;<span class="num" id="8361507">2</span>&nbsp;<span class="op" id="8361509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361513">stmt</span><span class="op" id="8361517">.</span><span class="ident" id="8361518">Close</span><span class="op" id="8361523">(</span><span class="op" id="8361524">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361528">return</span>&nbsp;<span class="builtintype" id="8361535">nil</span><span class="op" id="8361538">,</span>&nbsp;<span class="ident" id="8361540">errf</span><span class="op" id="8361544">(</span><span class="string" id="8361545">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="8361590">,</span>&nbsp;<span class="builtinfunc" id="8361592">len</span><span class="op" id="8361595">(</span><span class="ident" id="8361596">parts</span><span class="op" id="8361601">)</span><span class="op" id="8361602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361608">stmt</span><span class="op" id="8361612">.</span><span class="ident" id="8361613">table</span>&nbsp;<span class="op" id="8361619">=</span>&nbsp;<span class="ident" id="8361621">parts</span><span class="op" id="8361626">[</span><span class="num" id="8361627">0</span><span class="op" id="8361628">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361631">for</span>&nbsp;<span class="ident" id="8361635">n</span><span class="op" id="8361636">,</span>&nbsp;<span class="ident" id="8361638">colspec</span>&nbsp;<span class="op" id="8361646">:=</span>&nbsp;<span class="keyword" id="8361649">range</span>&nbsp;<span class="ident" id="8361655">strings</span><span class="op" id="8361662">.</span><span class="ident" id="8361663">Split</span><span class="op" id="8361668">(</span><span class="ident" id="8361669">parts</span><span class="op" id="8361674">[</span><span class="num" id="8361675">1</span><span class="op" id="8361676">]</span><span class="op" id="8361677">,</span>&nbsp;<span class="string" id="8361679">&#34;,&#34;</span><span class="op" id="8361682">)</span>&nbsp;<span class="op" id="8361684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361688">nameType</span>&nbsp;<span class="op" id="8361697">:=</span>&nbsp;<span class="ident" id="8361700">strings</span><span class="op" id="8361707">.</span><span class="ident" id="8361708">Split</span><span class="op" id="8361713">(</span><span class="ident" id="8361714">colspec</span><span class="op" id="8361721">,</span>&nbsp;<span class="string" id="8361723">&#34;=&#34;</span><span class="op" id="8361726">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361730">if</span>&nbsp;<span class="builtinfunc" id="8361733">len</span><span class="op" id="8361736">(</span><span class="ident" id="8361737">nameType</span><span class="op" id="8361745">)</span>&nbsp;<span class="op" id="8361747">!=</span>&nbsp;<span class="num" id="8361750">2</span>&nbsp;<span class="op" id="8361752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361757">stmt</span><span class="op" id="8361761">.</span><span class="ident" id="8361762">Close</span><span class="op" id="8361767">(</span><span class="op" id="8361768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361773">return</span>&nbsp;<span class="builtintype" id="8361780">nil</span><span class="op" id="8361783">,</span>&nbsp;<span class="ident" id="8361785">errf</span><span class="op" id="8361789">(</span><span class="string" id="8361790">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="8361848">,</span>&nbsp;<span class="ident" id="8361850">stmt</span><span class="op" id="8361854">.</span><span class="ident" id="8361855">table</span><span class="op" id="8361860">,</span>&nbsp;<span class="ident" id="8361862">colspec</span><span class="op" id="8361869">,</span>&nbsp;<span class="ident" id="8361871">n</span><span class="op" id="8361872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361880">stmt</span><span class="op" id="8361884">.</span><span class="ident" id="8361885">colName</span>&nbsp;<span class="op" id="8361893">=</span>&nbsp;<span class="builtinfunc" id="8361895">append</span><span class="op" id="8361901">(</span><span class="ident" id="8361902">stmt</span><span class="op" id="8361906">.</span><span class="ident" id="8361907">colName</span><span class="op" id="8361914">,</span>&nbsp;<span class="ident" id="8361916">nameType</span><span class="op" id="8361924">[</span><span class="num" id="8361925">0</span><span class="op" id="8361926">]</span><span class="op" id="8361927">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361931">stmt</span><span class="op" id="8361935">.</span><span class="ident" id="8361936">colType</span>&nbsp;<span class="op" id="8361944">=</span>&nbsp;<span class="builtinfunc" id="8361946">append</span><span class="op" id="8361952">(</span><span class="ident" id="8361953">stmt</span><span class="op" id="8361957">.</span><span class="ident" id="8361958">colType</span><span class="op" id="8361965">,</span>&nbsp;<span class="ident" id="8361967">nameType</span><span class="op" id="8361975">[</span><span class="num" id="8361976">1</span><span class="op" id="8361977">]</span><span class="op" id="8361978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361984">return</span>&nbsp;<span class="ident" id="8361991">stmt</span><span class="op" id="8361995">,</span>&nbsp;<span class="builtintype" id="8361997">nil</span><br>
<span class="lineno"></span><span class="op" id="8362001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="8362004">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="8362038">func</span>&nbsp;<span class="op" id="8362043">(</span><span class="ident" id="8362044">c</span>&nbsp;<span class="op" id="8362046">*</span><span class="ident" id="8362047">fakeConn</span><span class="op" id="8362055">)</span>&nbsp;<span class="ident" id="8362057">prepareInsert</span><span class="op" id="8362070">(</span><span class="ident" id="8362071">stmt</span>&nbsp;<span class="op" id="8362076">*</span><span class="ident" id="8362077">fakeStmt</span><span class="op" id="8362085">,</span>&nbsp;<span class="ident" id="8362087">parts</span>&nbsp;<span class="op" id="8362093">[</span><span class="op" id="8362094">]</span><span class="builtintype" id="8362095">string</span><span class="op" id="8362101">)</span>&nbsp;<span class="op" id="8362103">(</span><span class="ident" id="8362104">driver</span><span class="op" id="8362110">.</span><span class="ident" id="8362111">Stmt</span><span class="op" id="8362115">,</span>&nbsp;<span class="builtintype" id="8362117">error</span><span class="op" id="8362122">)</span>&nbsp;<span class="op" id="8362124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362127">if</span>&nbsp;<span class="builtinfunc" id="8362130">len</span><span class="op" id="8362133">(</span><span class="ident" id="8362134">parts</span><span class="op" id="8362139">)</span>&nbsp;<span class="op" id="8362141">!=</span>&nbsp;<span class="num" id="8362144">2</span>&nbsp;<span class="op" id="8362146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362150">stmt</span><span class="op" id="8362154">.</span><span class="ident" id="8362155">Close</span><span class="op" id="8362160">(</span><span class="op" id="8362161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362165">return</span>&nbsp;<span class="builtintype" id="8362172">nil</span><span class="op" id="8362175">,</span>&nbsp;<span class="ident" id="8362177">errf</span><span class="op" id="8362181">(</span><span class="string" id="8362182">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="8362227">,</span>&nbsp;<span class="builtinfunc" id="8362229">len</span><span class="op" id="8362232">(</span><span class="ident" id="8362233">parts</span><span class="op" id="8362238">)</span><span class="op" id="8362239">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8362242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362245">stmt</span><span class="op" id="8362249">.</span><span class="ident" id="8362250">table</span>&nbsp;<span class="op" id="8362256">=</span>&nbsp;<span class="ident" id="8362258">parts</span><span class="op" id="8362263">[</span><span class="num" id="8362264">0</span><span class="op" id="8362265">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362268">for</span>&nbsp;<span class="ident" id="8362272">n</span><span class="op" id="8362273">,</span>&nbsp;<span class="ident" id="8362275">colspec</span>&nbsp;<span class="op" id="8362283">:=</span>&nbsp;<span class="keyword" id="8362286">range</span>&nbsp;<span class="ident" id="8362292">strings</span><span class="op" id="8362299">.</span><span class="ident" id="8362300">Split</span><span class="op" id="8362305">(</span><span class="ident" id="8362306">parts</span><span class="op" id="8362311">[</span><span class="num" id="8362312">1</span><span class="op" id="8362313">]</span><span class="op" id="8362314">,</span>&nbsp;<span class="string" id="8362316">&#34;,&#34;</span><span class="op" id="8362319">)</span>&nbsp;<span class="op" id="8362321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362325">nameVal</span>&nbsp;<span class="op" id="8362333">:=</span>&nbsp;<span class="ident" id="8362336">strings</span><span class="op" id="8362343">.</span><span class="ident" id="8362344">Split</span><span class="op" id="8362349">(</span><span class="ident" id="8362350">colspec</span><span class="op" id="8362357">,</span>&nbsp;<span class="string" id="8362359">&#34;=&#34;</span><span class="op" id="8362362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362366">if</span>&nbsp;<span class="builtinfunc" id="8362369">len</span><span class="op" id="8362372">(</span><span class="ident" id="8362373">nameVal</span><span class="op" id="8362380">)</span>&nbsp;<span class="op" id="8362382">!=</span>&nbsp;<span class="num" id="8362385">2</span>&nbsp;<span class="op" id="8362387">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362392">stmt</span><span class="op" id="8362396">.</span><span class="ident" id="8362397">Close</span><span class="op" id="8362402">(</span><span class="op" id="8362403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362408">return</span>&nbsp;<span class="builtintype" id="8362415">nil</span><span class="op" id="8362418">,</span>&nbsp;<span class="ident" id="8362420">errf</span><span class="op" id="8362424">(</span><span class="string" id="8362425">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="8362483">,</span>&nbsp;<span class="ident" id="8362485">stmt</span><span class="op" id="8362489">.</span><span class="ident" id="8362490">table</span><span class="op" id="8362495">,</span>&nbsp;<span class="ident" id="8362497">colspec</span><span class="op" id="8362504">,</span>&nbsp;<span class="ident" id="8362506">n</span><span class="op" id="8362507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8362511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362515">column</span><span class="op" id="8362521">,</span>&nbsp;<span class="ident" id="8362523">value</span>&nbsp;<span class="op" id="8362529">:=</span>&nbsp;<span class="ident" id="8362532">nameVal</span><span class="op" id="8362539">[</span><span class="num" id="8362540">0</span><span class="op" id="8362541">]</span><span class="op" id="8362542">,</span>&nbsp;<span class="ident" id="8362544">nameVal</span><span class="op" id="8362551">[</span><span class="num" id="8362552">1</span><span class="op" id="8362553">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362557">ctype</span><span class="op" id="8362562">,</span>&nbsp;<span class="ident" id="8362564">ok</span>&nbsp;<span class="op" id="8362567">:=</span>&nbsp;<span class="ident" id="8362570">c</span><span class="op" id="8362571">.</span><span class="ident" id="8362572">db</span><span class="op" id="8362574">.</span><span class="ident" id="8362575">columnType</span><span class="op" id="8362585">(</span><span class="ident" id="8362586">stmt</span><span class="op" id="8362590">.</span><span class="ident" id="8362591">table</span><span class="op" id="8362596">,</span>&nbsp;<span class="ident" id="8362598">column</span><span class="op" id="8362604">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362608">if</span>&nbsp;<span class="op" id="8362611">!</span><span class="ident" id="8362612">ok</span>&nbsp;<span class="op" id="8362615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362620">stmt</span><span class="op" id="8362624">.</span><span class="ident" id="8362625">Close</span><span class="op" id="8362630">(</span><span class="op" id="8362631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362636">return</span>&nbsp;<span class="builtintype" id="8362643">nil</span><span class="op" id="8362646">,</span>&nbsp;<span class="ident" id="8362648">errf</span><span class="op" id="8362652">(</span><span class="string" id="8362653">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="8362704">,</span>&nbsp;<span class="ident" id="8362706">stmt</span><span class="op" id="8362710">.</span><span class="ident" id="8362711">table</span><span class="op" id="8362716">,</span>&nbsp;<span class="ident" id="8362718">column</span><span class="op" id="8362724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8362728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362732">stmt</span><span class="op" id="8362736">.</span><span class="ident" id="8362737">colName</span>&nbsp;<span class="op" id="8362745">=</span>&nbsp;<span class="builtinfunc" id="8362747">append</span><span class="op" id="8362753">(</span><span class="ident" id="8362754">stmt</span><span class="op" id="8362758">.</span><span class="ident" id="8362759">colName</span><span class="op" id="8362766">,</span>&nbsp;<span class="ident" id="8362768">column</span><span class="op" id="8362774">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362779">if</span>&nbsp;<span class="ident" id="8362782">value</span>&nbsp;<span class="op" id="8362788">!=</span>&nbsp;<span class="string" id="8362791">&#34;?&#34;</span>&nbsp;<span class="op" id="8362795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362800">var</span>&nbsp;<span class="ident" id="8362804">subsetVal</span>&nbsp;<span class="keyword" id="8362814">interface</span><span class="op" id="8362823">{</span><span class="op" id="8362824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8362829">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362865">switch</span>&nbsp;<span class="ident" id="8362872">ctype</span>&nbsp;<span class="op" id="8362878">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362883">case</span>&nbsp;<span class="string" id="8362888">&#34;string&#34;</span><span class="op" id="8362896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362902">subsetVal</span>&nbsp;<span class="op" id="8362912">=</span>&nbsp;<span class="op" id="8362914">[</span><span class="op" id="8362915">]</span><span class="builtintype" id="8362916">byte</span><span class="op" id="8362920">(</span><span class="ident" id="8362921">value</span><span class="op" id="8362926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362931">case</span>&nbsp;<span class="string" id="8362936">&#34;blob&#34;</span><span class="op" id="8362942">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362948">subsetVal</span>&nbsp;<span class="op" id="8362958">=</span>&nbsp;<span class="op" id="8362960">[</span><span class="op" id="8362961">]</span><span class="builtintype" id="8362962">byte</span><span class="op" id="8362966">(</span><span class="ident" id="8362967">value</span><span class="op" id="8362972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8362977">case</span>&nbsp;<span class="string" id="8362982">&#34;int32&#34;</span><span class="op" id="8362989">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362995">i</span><span class="op" id="8362996">,</span>&nbsp;<span class="ident" id="8362998">err</span>&nbsp;<span class="op" id="8363002">:=</span>&nbsp;<span class="ident" id="8363005">strconv</span><span class="op" id="8363012">.</span><span class="ident" id="8363013">Atoi</span><span class="op" id="8363017">(</span><span class="ident" id="8363018">value</span><span class="op" id="8363023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363029">if</span>&nbsp;<span class="ident" id="8363032">err</span>&nbsp;<span class="op" id="8363036">!=</span>&nbsp;<span class="builtintype" id="8363039">nil</span>&nbsp;<span class="op" id="8363043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363050">stmt</span><span class="op" id="8363054">.</span><span class="ident" id="8363055">Close</span><span class="op" id="8363060">(</span><span class="op" id="8363061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363068">return</span>&nbsp;<span class="builtintype" id="8363075">nil</span><span class="op" id="8363078">,</span>&nbsp;<span class="ident" id="8363080">errf</span><span class="op" id="8363084">(</span><span class="string" id="8363085">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="8363122">,</span>&nbsp;<span class="ident" id="8363124">value</span><span class="op" id="8363129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363135">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363141">subsetVal</span>&nbsp;<span class="op" id="8363151">=</span>&nbsp;<span class="builtintype" id="8363153">int64</span><span class="op" id="8363158">(</span><span class="ident" id="8363159">i</span><span class="op" id="8363160">)</span>&nbsp;<span class="comment" id="8363162">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363206">default</span><span class="op" id="8363213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363219">stmt</span><span class="op" id="8363223">.</span><span class="ident" id="8363224">Close</span><span class="op" id="8363229">(</span><span class="op" id="8363230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363236">return</span>&nbsp;<span class="builtintype" id="8363243">nil</span><span class="op" id="8363246">,</span>&nbsp;<span class="ident" id="8363248">errf</span><span class="op" id="8363252">(</span><span class="string" id="8363253">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="8363315">,</span>&nbsp;<span class="ident" id="8363317">value</span><span class="op" id="8363322">,</span>&nbsp;<span class="ident" id="8363324">ctype</span><span class="op" id="8363329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363334">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363339">stmt</span><span class="op" id="8363343">.</span><span class="ident" id="8363344">colValue</span>&nbsp;<span class="op" id="8363353">=</span>&nbsp;<span class="builtinfunc" id="8363355">append</span><span class="op" id="8363361">(</span><span class="ident" id="8363362">stmt</span><span class="op" id="8363366">.</span><span class="ident" id="8363367">colValue</span><span class="op" id="8363375">,</span>&nbsp;<span class="ident" id="8363377">subsetVal</span><span class="op" id="8363386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363390">}</span>&nbsp;<span class="keyword" id="8363392">else</span>&nbsp;<span class="op" id="8363397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363402">stmt</span><span class="op" id="8363406">.</span><span class="ident" id="8363407">placeholders</span><span class="op" id="8363419">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363425">stmt</span><span class="op" id="8363429">.</span><span class="ident" id="8363430">placeholderConverter</span>&nbsp;<span class="op" id="8363451">=</span>&nbsp;<span class="builtinfunc" id="8363453">append</span><span class="op" id="8363459">(</span><span class="ident" id="8363460">stmt</span><span class="op" id="8363464">.</span><span class="ident" id="8363465">placeholderConverter</span><span class="op" id="8363485">,</span>&nbsp;<span class="ident" id="8363487">converterForType</span><span class="op" id="8363503">(</span><span class="ident" id="8363504">ctype</span><span class="op" id="8363509">)</span><span class="op" id="8363510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363515">stmt</span><span class="op" id="8363519">.</span><span class="ident" id="8363520">colValue</span>&nbsp;<span class="op" id="8363529">=</span>&nbsp;<span class="builtinfunc" id="8363531">append</span><span class="op" id="8363537">(</span><span class="ident" id="8363538">stmt</span><span class="op" id="8363542">.</span><span class="ident" id="8363543">colValue</span><span class="op" id="8363551">,</span>&nbsp;<span class="string" id="8363553">&#34;?&#34;</span><span class="op" id="8363556">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363566">return</span>&nbsp;<span class="ident" id="8363573">stmt</span><span class="op" id="8363577">,</span>&nbsp;<span class="builtintype" id="8363579">nil</span><br>
<span class="lineno"></span><span class="op" id="8363583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="8363586">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="8363625">var</span>&nbsp;<span class="ident" id="8363629">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="8363648">func</span><span class="op" id="8363652">(</span><span class="op" id="8363653">)</span>&nbsp;<span class="builtintype" id="8363655">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8363661">func</span>&nbsp;<span class="op" id="8363666">(</span><span class="ident" id="8363667">c</span>&nbsp;<span class="op" id="8363669">*</span><span class="ident" id="8363670">fakeConn</span><span class="op" id="8363678">)</span>&nbsp;<span class="ident" id="8363680">Prepare</span><span class="op" id="8363687">(</span><span class="ident" id="8363688">query</span>&nbsp;<span class="builtintype" id="8363694">string</span><span class="op" id="8363700">)</span>&nbsp;<span class="op" id="8363702">(</span><span class="ident" id="8363703">driver</span><span class="op" id="8363709">.</span><span class="ident" id="8363710">Stmt</span><span class="op" id="8363714">,</span>&nbsp;<span class="builtintype" id="8363716">error</span><span class="op" id="8363721">)</span>&nbsp;<span class="op" id="8363723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363726">c</span><span class="op" id="8363727">.</span><span class="ident" id="8363728">numPrepare</span><span class="op" id="8363738">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363742">if</span>&nbsp;<span class="ident" id="8363745">c</span><span class="op" id="8363746">.</span><span class="ident" id="8363747">db</span>&nbsp;<span class="op" id="8363750">==</span>&nbsp;<span class="builtintype" id="8363753">nil</span>&nbsp;<span class="op" id="8363757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8363761">panic</span><span class="op" id="8363766">(</span><span class="string" id="8363767">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="8363787">+</span>&nbsp;<span class="ident" id="8363789">fmt</span><span class="op" id="8363792">.</span><span class="ident" id="8363793">Sprintf</span><span class="op" id="8363800">(</span><span class="string" id="8363801">&#34;%#v&#34;</span><span class="op" id="8363806">,</span>&nbsp;<span class="ident" id="8363808">c</span><span class="op" id="8363809">)</span><span class="op" id="8363810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363817">if</span>&nbsp;<span class="ident" id="8363820">hookPrepareBadConn</span>&nbsp;<span class="op" id="8363839">!=</span>&nbsp;<span class="builtintype" id="8363842">nil</span>&nbsp;<span class="op" id="8363846">&amp;&amp;</span>&nbsp;<span class="ident" id="8363849">hookPrepareBadConn</span><span class="op" id="8363867">(</span><span class="op" id="8363868">)</span>&nbsp;<span class="op" id="8363870">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363874">return</span>&nbsp;<span class="builtintype" id="8363881">nil</span><span class="op" id="8363884">,</span>&nbsp;<span class="ident" id="8363886">driver</span><span class="op" id="8363892">.</span><span class="ident" id="8363893">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8363905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8363909">parts</span>&nbsp;<span class="op" id="8363915">:=</span>&nbsp;<span class="ident" id="8363918">strings</span><span class="op" id="8363925">.</span><span class="ident" id="8363926">Split</span><span class="op" id="8363931">(</span><span class="ident" id="8363932">query</span><span class="op" id="8363937">,</span>&nbsp;<span class="string" id="8363939">&#34;|&#34;</span><span class="op" id="8363942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363945">if</span>&nbsp;<span class="builtinfunc" id="8363948">len</span><span class="op" id="8363951">(</span><span class="ident" id="8363952">parts</span><span class="op" id="8363957">)</span>&nbsp;<span class="op" id="8363959">&lt;</span>&nbsp;<span class="num" id="8363961">1</span>&nbsp;<span class="op" id="8363963">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8363967">return</span>&nbsp;<span class="builtintype" id="8363974">nil</span><span class="op" id="8363977">,</span>&nbsp;<span class="ident" id="8363979">errf</span><span class="op" id="8363983">(</span><span class="string" id="8363984">&#34;empty&nbsp;query&#34;</span><span class="op" id="8363997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8364000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364003">cmd</span>&nbsp;<span class="op" id="8364007">:=</span>&nbsp;<span class="ident" id="8364010">parts</span><span class="op" id="8364015">[</span><span class="num" id="8364016">0</span><span class="op" id="8364017">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364020">parts</span>&nbsp;<span class="op" id="8364026">=</span>&nbsp;<span class="ident" id="8364028">parts</span><span class="op" id="8364033">[</span><span class="num" id="8364034">1</span><span class="op" id="8364035">:</span><span class="op" id="8364036">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364039">stmt</span>&nbsp;<span class="op" id="8364044">:=</span>&nbsp;<span class="op" id="8364047">&amp;</span><span class="ident" id="8364048">fakeStmt</span><span class="op" id="8364056">{</span><span class="ident" id="8364057">q</span><span class="op" id="8364058">:</span>&nbsp;<span class="ident" id="8364060">query</span><span class="op" id="8364065">,</span>&nbsp;<span class="ident" id="8364067">c</span><span class="op" id="8364068">:</span>&nbsp;<span class="ident" id="8364070">c</span><span class="op" id="8364071">,</span>&nbsp;<span class="ident" id="8364073">cmd</span><span class="op" id="8364076">:</span>&nbsp;<span class="ident" id="8364078">cmd</span><span class="op" id="8364081">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364084">c</span><span class="op" id="8364085">.</span><span class="ident" id="8364086">incrStat</span><span class="op" id="8364094">(</span><span class="op" id="8364095">&amp;</span><span class="ident" id="8364096">c</span><span class="op" id="8364097">.</span><span class="ident" id="8364098">stmtsMade</span><span class="op" id="8364107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364110">switch</span>&nbsp;<span class="ident" id="8364117">cmd</span>&nbsp;<span class="op" id="8364121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364124">case</span>&nbsp;<span class="string" id="8364129">&#34;WIPE&#34;</span><span class="op" id="8364135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8364139">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364151">case</span>&nbsp;<span class="string" id="8364156">&#34;SELECT&#34;</span><span class="op" id="8364164">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364168">return</span>&nbsp;<span class="ident" id="8364175">c</span><span class="op" id="8364176">.</span><span class="ident" id="8364177">prepareSelect</span><span class="op" id="8364190">(</span><span class="ident" id="8364191">stmt</span><span class="op" id="8364195">,</span>&nbsp;<span class="ident" id="8364197">parts</span><span class="op" id="8364202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364205">case</span>&nbsp;<span class="string" id="8364210">&#34;CREATE&#34;</span><span class="op" id="8364218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364222">return</span>&nbsp;<span class="ident" id="8364229">c</span><span class="op" id="8364230">.</span><span class="ident" id="8364231">prepareCreate</span><span class="op" id="8364244">(</span><span class="ident" id="8364245">stmt</span><span class="op" id="8364249">,</span>&nbsp;<span class="ident" id="8364251">parts</span><span class="op" id="8364256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364259">case</span>&nbsp;<span class="string" id="8364264">&#34;INSERT&#34;</span><span class="op" id="8364272">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364276">return</span>&nbsp;<span class="ident" id="8364283">c</span><span class="op" id="8364284">.</span><span class="ident" id="8364285">prepareInsert</span><span class="op" id="8364298">(</span><span class="ident" id="8364299">stmt</span><span class="op" id="8364303">,</span>&nbsp;<span class="ident" id="8364305">parts</span><span class="op" id="8364310">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364313">case</span>&nbsp;<span class="string" id="8364318">&#34;NOSERT&#34;</span><span class="op" id="8364326">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8364330">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8364410">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364454">return</span>&nbsp;<span class="ident" id="8364461">c</span><span class="op" id="8364462">.</span><span class="ident" id="8364463">prepareInsert</span><span class="op" id="8364476">(</span><span class="ident" id="8364477">stmt</span><span class="op" id="8364481">,</span>&nbsp;<span class="ident" id="8364483">parts</span><span class="op" id="8364488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364491">default</span><span class="op" id="8364498">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364502">stmt</span><span class="op" id="8364506">.</span><span class="ident" id="8364507">Close</span><span class="op" id="8364512">(</span><span class="op" id="8364513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364517">return</span>&nbsp;<span class="builtintype" id="8364524">nil</span><span class="op" id="8364527">,</span>&nbsp;<span class="ident" id="8364529">errf</span><span class="op" id="8364533">(</span><span class="string" id="8364534">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="8364563">,</span>&nbsp;<span class="ident" id="8364565">cmd</span><span class="op" id="8364568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8364571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364574">return</span>&nbsp;<span class="ident" id="8364581">stmt</span><span class="op" id="8364585">,</span>&nbsp;<span class="builtintype" id="8364587">nil</span><br>
<span class="lineno"></span><span class="op" id="8364591">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="8364594">func</span>&nbsp;<span class="op" id="8364599">(</span><span class="ident" id="8364600">s</span>&nbsp;<span class="op" id="8364602">*</span><span class="ident" id="8364603">fakeStmt</span><span class="op" id="8364611">)</span>&nbsp;<span class="ident" id="8364613">ColumnConverter</span><span class="op" id="8364628">(</span><span class="ident" id="8364629">idx</span>&nbsp;<span class="builtintype" id="8364633">int</span><span class="op" id="8364636">)</span>&nbsp;<span class="ident" id="8364638">driver</span><span class="op" id="8364644">.</span><span class="ident" id="8364645">ValueConverter</span>&nbsp;<span class="op" id="8364660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364663">if</span>&nbsp;<span class="builtinfunc" id="8364666">len</span><span class="op" id="8364669">(</span><span class="ident" id="8364670">s</span><span class="op" id="8364671">.</span><span class="ident" id="8364672">placeholderConverter</span><span class="op" id="8364692">)</span>&nbsp;<span class="op" id="8364694">==</span>&nbsp;<span class="num" id="8364697">0</span>&nbsp;<span class="op" id="8364699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364703">return</span>&nbsp;<span class="ident" id="8364710">driver</span><span class="op" id="8364716">.</span><span class="ident" id="8364717">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8364744">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364747">return</span>&nbsp;<span class="ident" id="8364754">s</span><span class="op" id="8364755">.</span><span class="ident" id="8364756">placeholderConverter</span><span class="op" id="8364776">[</span><span class="ident" id="8364777">idx</span><span class="op" id="8364780">]</span><br>
<span class="lineno"></span><span class="op" id="8364782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364785">func</span>&nbsp;<span class="op" id="8364790">(</span><span class="ident" id="8364791">s</span>&nbsp;<span class="op" id="8364793">*</span><span class="ident" id="8364794">fakeStmt</span><span class="op" id="8364802">)</span>&nbsp;<span class="ident" id="8364804">Close</span><span class="op" id="8364809">(</span><span class="op" id="8364810">)</span>&nbsp;<span class="builtintype" id="8364812">error</span>&nbsp;<span class="op" id="8364818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364821">if</span>&nbsp;<span class="ident" id="8364824">s</span><span class="op" id="8364825">.</span><span class="ident" id="8364826">c</span>&nbsp;<span class="op" id="8364828">==</span>&nbsp;<span class="builtintype" id="8364831">nil</span>&nbsp;<span class="op" id="8364835">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8364839">panic</span><span class="op" id="8364844">(</span><span class="string" id="8364845">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="8364873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8364876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364879">if</span>&nbsp;<span class="ident" id="8364882">s</span><span class="op" id="8364883">.</span><span class="ident" id="8364884">c</span><span class="op" id="8364885">.</span><span class="ident" id="8364886">db</span>&nbsp;<span class="op" id="8364889">==</span>&nbsp;<span class="builtintype" id="8364892">nil</span>&nbsp;<span class="op" id="8364896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8364900">panic</span><span class="op" id="8364905">(</span><span class="string" id="8364906">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="8364960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8364963">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8364966">if</span>&nbsp;<span class="op" id="8364969">!</span><span class="ident" id="8364970">s</span><span class="op" id="8364971">.</span><span class="ident" id="8364972">closed</span>&nbsp;<span class="op" id="8364979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8364983">s</span><span class="op" id="8364984">.</span><span class="ident" id="8364985">c</span><span class="op" id="8364986">.</span><span class="ident" id="8364987">incrStat</span><span class="op" id="8364995">(</span><span class="op" id="8364996">&amp;</span><span class="ident" id="8364997">s</span><span class="op" id="8364998">.</span><span class="ident" id="8364999">c</span><span class="op" id="8365000">.</span><span class="ident" id="8365001">stmtsClosed</span><span class="op" id="8365012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8365016">s</span><span class="op" id="8365017">.</span><span class="ident" id="8365018">closed</span>&nbsp;<span class="op" id="8365025">=</span>&nbsp;<span class="builtintype" id="8365027">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8365033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365036">return</span>&nbsp;<span class="builtintype" id="8365043">nil</span><br>
<span class="lineno">520</span><span class="op" id="8365047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8365050">var</span>&nbsp;<span class="ident" id="8365054">errClosed</span>&nbsp;<span class="op" id="8365064">=</span>&nbsp;<span class="ident" id="8365066">errors</span><span class="op" id="8365072">.</span><span class="ident" id="8365073">New</span><span class="op" id="8365076">(</span><span class="string" id="8365077">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="8365112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8365115">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="8365154">var</span>&nbsp;<span class="ident" id="8365158">hookExecBadConn</span>&nbsp;<span class="keyword" id="8365174">func</span><span class="op" id="8365178">(</span><span class="op" id="8365179">)</span>&nbsp;<span class="builtintype" id="8365181">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8365187">func</span>&nbsp;<span class="op" id="8365192">(</span><span class="ident" id="8365193">s</span>&nbsp;<span class="op" id="8365195">*</span><span class="ident" id="8365196">fakeStmt</span><span class="op" id="8365204">)</span>&nbsp;<span class="ident" id="8365206">Exec</span><span class="op" id="8365210">(</span><span class="ident" id="8365211">args</span>&nbsp;<span class="op" id="8365216">[</span><span class="op" id="8365217">]</span><span class="ident" id="8365218">driver</span><span class="op" id="8365224">.</span><span class="ident" id="8365225">Value</span><span class="op" id="8365230">)</span>&nbsp;<span class="op" id="8365232">(</span><span class="ident" id="8365233">driver</span><span class="op" id="8365239">.</span><span class="ident" id="8365240">Result</span><span class="op" id="8365246">,</span>&nbsp;<span class="builtintype" id="8365248">error</span><span class="op" id="8365253">)</span>&nbsp;<span class="op" id="8365255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365258">if</span>&nbsp;<span class="ident" id="8365261">s</span><span class="op" id="8365262">.</span><span class="ident" id="8365263">closed</span>&nbsp;<span class="op" id="8365270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365274">return</span>&nbsp;<span class="builtintype" id="8365281">nil</span><span class="op" id="8365284">,</span>&nbsp;<span class="ident" id="8365286">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8365297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365301">if</span>&nbsp;<span class="ident" id="8365304">hookExecBadConn</span>&nbsp;<span class="op" id="8365320">!=</span>&nbsp;<span class="builtintype" id="8365323">nil</span>&nbsp;<span class="op" id="8365327">&amp;&amp;</span>&nbsp;<span class="ident" id="8365330">hookExecBadConn</span><span class="op" id="8365345">(</span><span class="op" id="8365346">)</span>&nbsp;<span class="op" id="8365348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365352">return</span>&nbsp;<span class="builtintype" id="8365359">nil</span><span class="op" id="8365362">,</span>&nbsp;<span class="ident" id="8365364">driver</span><span class="op" id="8365370">.</span><span class="ident" id="8365371">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8365383">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8365387">err</span>&nbsp;<span class="op" id="8365391">:=</span>&nbsp;<span class="ident" id="8365394">checkSubsetTypes</span><span class="op" id="8365410">(</span><span class="ident" id="8365411">args</span><span class="op" id="8365415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365418">if</span>&nbsp;<span class="ident" id="8365421">err</span>&nbsp;<span class="op" id="8365425">!=</span>&nbsp;<span class="builtintype" id="8365428">nil</span>&nbsp;<span class="op" id="8365432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365436">return</span>&nbsp;<span class="builtintype" id="8365443">nil</span><span class="op" id="8365446">,</span>&nbsp;<span class="ident" id="8365448">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8365453">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8365457">db</span>&nbsp;<span class="op" id="8365460">:=</span>&nbsp;<span class="ident" id="8365463">s</span><span class="op" id="8365464">.</span><span class="ident" id="8365465">c</span><span class="op" id="8365466">.</span><span class="ident" id="8365467">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365471">switch</span>&nbsp;<span class="ident" id="8365478">s</span><span class="op" id="8365479">.</span><span class="ident" id="8365480">cmd</span>&nbsp;<span class="op" id="8365484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365487">case</span>&nbsp;<span class="string" id="8365492">&#34;WIPE&#34;</span><span class="op" id="8365498">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8365502">db</span><span class="op" id="8365504">.</span><span class="ident" id="8365505">wipe</span><span class="op" id="8365509">(</span><span class="op" id="8365510">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365514">return</span>&nbsp;<span class="ident" id="8365521">driver</span><span class="op" id="8365527">.</span><span class="ident" id="8365528">ResultNoRows</span><span class="op" id="8365540">,</span>&nbsp;<span class="builtintype" id="8365542">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365547">case</span>&nbsp;<span class="string" id="8365552">&#34;CREATE&#34;</span><span class="op" id="8365560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365564">if</span>&nbsp;<span class="ident" id="8365567">err</span>&nbsp;<span class="op" id="8365571">:=</span>&nbsp;<span class="ident" id="8365574">db</span><span class="op" id="8365576">.</span><span class="ident" id="8365577">createTable</span><span class="op" id="8365588">(</span><span class="ident" id="8365589">s</span><span class="op" id="8365590">.</span><span class="ident" id="8365591">table</span><span class="op" id="8365596">,</span>&nbsp;<span class="ident" id="8365598">s</span><span class="op" id="8365599">.</span><span class="ident" id="8365600">colName</span><span class="op" id="8365607">,</span>&nbsp;<span class="ident" id="8365609">s</span><span class="op" id="8365610">.</span><span class="ident" id="8365611">colType</span><span class="op" id="8365618">)</span><span class="op" id="8365619">;</span>&nbsp;<span class="ident" id="8365621">err</span>&nbsp;<span class="op" id="8365625">!=</span>&nbsp;<span class="builtintype" id="8365628">nil</span>&nbsp;<span class="op" id="8365632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365637">return</span>&nbsp;<span class="builtintype" id="8365644">nil</span><span class="op" id="8365647">,</span>&nbsp;<span class="ident" id="8365649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8365655">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365659">return</span>&nbsp;<span class="ident" id="8365666">driver</span><span class="op" id="8365672">.</span><span class="ident" id="8365673">ResultNoRows</span><span class="op" id="8365685">,</span>&nbsp;<span class="builtintype" id="8365687">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365692">case</span>&nbsp;<span class="string" id="8365697">&#34;INSERT&#34;</span><span class="op" id="8365705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365709">return</span>&nbsp;<span class="ident" id="8365716">s</span><span class="op" id="8365717">.</span><span class="ident" id="8365718">execInsert</span><span class="op" id="8365728">(</span><span class="ident" id="8365729">args</span><span class="op" id="8365733">,</span>&nbsp;<span class="builtintype" id="8365735">true</span><span class="op" id="8365739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365742">case</span>&nbsp;<span class="string" id="8365747">&#34;NOSERT&#34;</span><span class="op" id="8365755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8365759">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8365839">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365883">return</span>&nbsp;<span class="ident" id="8365890">s</span><span class="op" id="8365891">.</span><span class="ident" id="8365892">execInsert</span><span class="op" id="8365902">(</span><span class="ident" id="8365903">args</span><span class="op" id="8365907">,</span>&nbsp;<span class="builtintype" id="8365909">false</span><span class="op" id="8365914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8365917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8365920">fmt</span><span class="op" id="8365923">.</span><span class="ident" id="8365924">Printf</span><span class="op" id="8365930">(</span><span class="string" id="8365931">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="8365962">,</span>&nbsp;<span class="ident" id="8365964">s</span><span class="op" id="8365965">.</span><span class="ident" id="8365966">cmd</span><span class="op" id="8365969">,</span>&nbsp;<span class="ident" id="8365971">s</span><span class="op" id="8365972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8365975">return</span>&nbsp;<span class="builtintype" id="8365982">nil</span><span class="op" id="8365985">,</span>&nbsp;<span class="ident" id="8365987">fmt</span><span class="op" id="8365990">.</span><span class="ident" id="8365991">Errorf</span><span class="op" id="8365997">(</span><span class="string" id="8365998">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="8366047">,</span>&nbsp;<span class="ident" id="8366049">s</span><span class="op" id="8366050">.</span><span class="ident" id="8366051">cmd</span><span class="op" id="8366054">)</span><br>
<span class="lineno">560</span><span class="op" id="8366056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8366059">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="8366111">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="8366180">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="8366218">func</span>&nbsp;<span class="op" id="8366223">(</span><span class="ident" id="8366224">s</span>&nbsp;<span class="op" id="8366226">*</span><span class="ident" id="8366227">fakeStmt</span><span class="op" id="8366235">)</span>&nbsp;<span class="ident" id="8366237">execInsert</span><span class="op" id="8366247">(</span><span class="ident" id="8366248">args</span>&nbsp;<span class="op" id="8366253">[</span><span class="op" id="8366254">]</span><span class="ident" id="8366255">driver</span><span class="op" id="8366261">.</span><span class="ident" id="8366262">Value</span><span class="op" id="8366267">,</span>&nbsp;<span class="ident" id="8366269">doInsert</span>&nbsp;<span class="builtintype" id="8366278">bool</span><span class="op" id="8366282">)</span>&nbsp;<span class="op" id="8366284">(</span><span class="ident" id="8366285">driver</span><span class="op" id="8366291">.</span><span class="ident" id="8366292">Result</span><span class="op" id="8366298">,</span>&nbsp;<span class="builtintype" id="8366300">error</span><span class="op" id="8366305">)</span>&nbsp;<span class="op" id="8366307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366310">db</span>&nbsp;<span class="op" id="8366313">:=</span>&nbsp;<span class="ident" id="8366316">s</span><span class="op" id="8366317">.</span><span class="ident" id="8366318">c</span><span class="op" id="8366319">.</span><span class="ident" id="8366320">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366324">if</span>&nbsp;<span class="builtinfunc" id="8366327">len</span><span class="op" id="8366330">(</span><span class="ident" id="8366331">args</span><span class="op" id="8366335">)</span>&nbsp;<span class="op" id="8366337">!=</span>&nbsp;<span class="ident" id="8366340">s</span><span class="op" id="8366341">.</span><span class="ident" id="8366342">placeholders</span>&nbsp;<span class="op" id="8366355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8366359">panic</span><span class="op" id="8366364">(</span><span class="string" id="8366365">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="8366423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8366426">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366429">db</span><span class="op" id="8366431">.</span><span class="ident" id="8366432">mu</span><span class="op" id="8366434">.</span><span class="ident" id="8366435">Lock</span><span class="op" id="8366439">(</span><span class="op" id="8366440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366443">t</span><span class="op" id="8366444">,</span>&nbsp;<span class="ident" id="8366446">ok</span>&nbsp;<span class="op" id="8366449">:=</span>&nbsp;<span class="ident" id="8366452">db</span><span class="op" id="8366454">.</span><span class="ident" id="8366455">table</span><span class="op" id="8366460">(</span><span class="ident" id="8366461">s</span><span class="op" id="8366462">.</span><span class="ident" id="8366463">table</span><span class="op" id="8366468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366471">db</span><span class="op" id="8366473">.</span><span class="ident" id="8366474">mu</span><span class="op" id="8366476">.</span><span class="ident" id="8366477">Unlock</span><span class="op" id="8366483">(</span><span class="op" id="8366484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366487">if</span>&nbsp;<span class="op" id="8366490">!</span><span class="ident" id="8366491">ok</span>&nbsp;<span class="op" id="8366494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366498">return</span>&nbsp;<span class="builtintype" id="8366505">nil</span><span class="op" id="8366508">,</span>&nbsp;<span class="ident" id="8366510">fmt</span><span class="op" id="8366513">.</span><span class="ident" id="8366514">Errorf</span><span class="op" id="8366520">(</span><span class="string" id="8366521">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="8366553">,</span>&nbsp;<span class="ident" id="8366555">s</span><span class="op" id="8366556">.</span><span class="ident" id="8366557">table</span><span class="op" id="8366562">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8366565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366569">t</span><span class="op" id="8366570">.</span><span class="ident" id="8366571">mu</span><span class="op" id="8366573">.</span><span class="ident" id="8366574">Lock</span><span class="op" id="8366578">(</span><span class="op" id="8366579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366582">defer</span>&nbsp;<span class="ident" id="8366588">t</span><span class="op" id="8366589">.</span><span class="ident" id="8366590">mu</span><span class="op" id="8366592">.</span><span class="ident" id="8366593">Unlock</span><span class="op" id="8366599">(</span><span class="op" id="8366600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366604">var</span>&nbsp;<span class="ident" id="8366608">cols</span>&nbsp;<span class="op" id="8366613">[</span><span class="op" id="8366614">]</span><span class="keyword" id="8366615">interface</span><span class="op" id="8366624">{</span><span class="op" id="8366625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366628">if</span>&nbsp;<span class="ident" id="8366631">doInsert</span>&nbsp;<span class="op" id="8366640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366644">cols</span>&nbsp;<span class="op" id="8366649">=</span>&nbsp;<span class="builtinfunc" id="8366651">make</span><span class="op" id="8366655">(</span><span class="op" id="8366656">[</span><span class="op" id="8366657">]</span><span class="keyword" id="8366658">interface</span><span class="op" id="8366667">{</span><span class="op" id="8366668">}</span><span class="op" id="8366669">,</span>&nbsp;<span class="builtinfunc" id="8366671">len</span><span class="op" id="8366674">(</span><span class="ident" id="8366675">t</span><span class="op" id="8366676">.</span><span class="ident" id="8366677">colname</span><span class="op" id="8366684">)</span><span class="op" id="8366685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8366688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366691">argPos</span>&nbsp;<span class="op" id="8366698">:=</span>&nbsp;<span class="num" id="8366701">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366704">for</span>&nbsp;<span class="ident" id="8366708">n</span><span class="op" id="8366709">,</span>&nbsp;<span class="ident" id="8366711">colname</span>&nbsp;<span class="op" id="8366719">:=</span>&nbsp;<span class="keyword" id="8366722">range</span>&nbsp;<span class="ident" id="8366728">s</span><span class="op" id="8366729">.</span><span class="ident" id="8366730">colName</span>&nbsp;<span class="op" id="8366738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8366742">colidx</span>&nbsp;<span class="op" id="8366749">:=</span>&nbsp;<span class="ident" id="8366752">t</span><span class="op" id="8366753">.</span><span class="ident" id="8366754">columnIndex</span><span class="op" id="8366765">(</span><span class="ident" id="8366766">colname</span><span class="op" id="8366773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366777">if</span>&nbsp;<span class="ident" id="8366780">colidx</span>&nbsp;<span class="op" id="8366787">==</span>&nbsp;<span class="op" id="8366790">-</span><span class="num" id="8366791">1</span>&nbsp;<span class="op" id="8366793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366798">return</span>&nbsp;<span class="builtintype" id="8366805">nil</span><span class="op" id="8366808">,</span>&nbsp;<span class="ident" id="8366810">fmt</span><span class="op" id="8366813">.</span><span class="ident" id="8366814">Errorf</span><span class="op" id="8366820">(</span><span class="string" id="8366821">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="8366902">,</span>&nbsp;<span class="ident" id="8366904">colname</span><span class="op" id="8366911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8366915">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366919">var</span>&nbsp;<span class="ident" id="8366923">val</span>&nbsp;<span class="keyword" id="8366927">interface</span><span class="op" id="8366936">{</span><span class="op" id="8366937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8366941">if</span>&nbsp;<span class="ident" id="8366944">strvalue</span><span class="op" id="8366952">,</span>&nbsp;<span class="ident" id="8366954">ok</span>&nbsp;<span class="op" id="8366957">:=</span>&nbsp;<span class="ident" id="8366960">s</span><span class="op" id="8366961">.</span><span class="ident" id="8366962">colValue</span><span class="op" id="8366970">[</span><span class="ident" id="8366971">n</span><span class="op" id="8366972">]</span><span class="op" id="8366973">.</span><span class="op" id="8366974">(</span><span class="builtintype" id="8366975">string</span><span class="op" id="8366981">)</span><span class="op" id="8366982">;</span>&nbsp;<span class="ident" id="8366984">ok</span>&nbsp;<span class="op" id="8366987">&amp;&amp;</span>&nbsp;<span class="ident" id="8366990">strvalue</span>&nbsp;<span class="op" id="8366999">==</span>&nbsp;<span class="string" id="8367002">&#34;?&#34;</span>&nbsp;<span class="op" id="8367006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367011">val</span>&nbsp;<span class="op" id="8367015">=</span>&nbsp;<span class="ident" id="8367017">args</span><span class="op" id="8367021">[</span><span class="ident" id="8367022">argPos</span><span class="op" id="8367028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367033">argPos</span><span class="op" id="8367039">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367044">}</span>&nbsp;<span class="keyword" id="8367046">else</span>&nbsp;<span class="op" id="8367051">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367056">val</span>&nbsp;<span class="op" id="8367060">=</span>&nbsp;<span class="ident" id="8367062">s</span><span class="op" id="8367063">.</span><span class="ident" id="8367064">colValue</span><span class="op" id="8367072">[</span><span class="ident" id="8367073">n</span><span class="op" id="8367074">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367082">if</span>&nbsp;<span class="ident" id="8367085">doInsert</span>&nbsp;<span class="op" id="8367094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367099">cols</span><span class="op" id="8367103">[</span><span class="ident" id="8367104">colidx</span><span class="op" id="8367110">]</span>&nbsp;<span class="op" id="8367112">=</span>&nbsp;<span class="ident" id="8367114">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367120">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367127">if</span>&nbsp;<span class="ident" id="8367130">doInsert</span>&nbsp;<span class="op" id="8367139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367143">t</span><span class="op" id="8367144">.</span><span class="ident" id="8367145">rows</span>&nbsp;<span class="op" id="8367150">=</span>&nbsp;<span class="builtinfunc" id="8367152">append</span><span class="op" id="8367158">(</span><span class="ident" id="8367159">t</span><span class="op" id="8367160">.</span><span class="ident" id="8367161">rows</span><span class="op" id="8367165">,</span>&nbsp;<span class="op" id="8367167">&amp;</span><span class="ident" id="8367168">row</span><span class="op" id="8367171">{</span><span class="ident" id="8367172">cols</span><span class="op" id="8367176">:</span>&nbsp;<span class="ident" id="8367178">cols</span><span class="op" id="8367182">}</span><span class="op" id="8367183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367186">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367189">return</span>&nbsp;<span class="ident" id="8367196">driver</span><span class="op" id="8367202">.</span><span class="ident" id="8367203">RowsAffected</span><span class="op" id="8367215">(</span><span class="num" id="8367216">1</span><span class="op" id="8367217">)</span><span class="op" id="8367218">,</span>&nbsp;<span class="builtintype" id="8367220">nil</span><br>
<span class="lineno"></span><span class="op" id="8367224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8367227">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="8367266">var</span>&nbsp;<span class="ident" id="8367270">hookQueryBadConn</span>&nbsp;<span class="keyword" id="8367287">func</span><span class="op" id="8367291">(</span><span class="op" id="8367292">)</span>&nbsp;<span class="builtintype" id="8367294">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="8367300">func</span>&nbsp;<span class="op" id="8367305">(</span><span class="ident" id="8367306">s</span>&nbsp;<span class="op" id="8367308">*</span><span class="ident" id="8367309">fakeStmt</span><span class="op" id="8367317">)</span>&nbsp;<span class="ident" id="8367319">Query</span><span class="op" id="8367324">(</span><span class="ident" id="8367325">args</span>&nbsp;<span class="op" id="8367330">[</span><span class="op" id="8367331">]</span><span class="ident" id="8367332">driver</span><span class="op" id="8367338">.</span><span class="ident" id="8367339">Value</span><span class="op" id="8367344">)</span>&nbsp;<span class="op" id="8367346">(</span><span class="ident" id="8367347">driver</span><span class="op" id="8367353">.</span><span class="ident" id="8367354">Rows</span><span class="op" id="8367358">,</span>&nbsp;<span class="builtintype" id="8367360">error</span><span class="op" id="8367365">)</span>&nbsp;<span class="op" id="8367367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367370">if</span>&nbsp;<span class="ident" id="8367373">s</span><span class="op" id="8367374">.</span><span class="ident" id="8367375">closed</span>&nbsp;<span class="op" id="8367382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367386">return</span>&nbsp;<span class="builtintype" id="8367393">nil</span><span class="op" id="8367396">,</span>&nbsp;<span class="ident" id="8367398">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367409">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367413">if</span>&nbsp;<span class="ident" id="8367416">hookQueryBadConn</span>&nbsp;<span class="op" id="8367433">!=</span>&nbsp;<span class="builtintype" id="8367436">nil</span>&nbsp;<span class="op" id="8367440">&amp;&amp;</span>&nbsp;<span class="ident" id="8367443">hookQueryBadConn</span><span class="op" id="8367459">(</span><span class="op" id="8367460">)</span>&nbsp;<span class="op" id="8367462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367466">return</span>&nbsp;<span class="builtintype" id="8367473">nil</span><span class="op" id="8367476">,</span>&nbsp;<span class="ident" id="8367478">driver</span><span class="op" id="8367484">.</span><span class="ident" id="8367485">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367501">err</span>&nbsp;<span class="op" id="8367505">:=</span>&nbsp;<span class="ident" id="8367508">checkSubsetTypes</span><span class="op" id="8367524">(</span><span class="ident" id="8367525">args</span><span class="op" id="8367529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367532">if</span>&nbsp;<span class="ident" id="8367535">err</span>&nbsp;<span class="op" id="8367539">!=</span>&nbsp;<span class="builtintype" id="8367542">nil</span>&nbsp;<span class="op" id="8367546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367550">return</span>&nbsp;<span class="builtintype" id="8367557">nil</span><span class="op" id="8367560">,</span>&nbsp;<span class="ident" id="8367562">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367571">db</span>&nbsp;<span class="op" id="8367574">:=</span>&nbsp;<span class="ident" id="8367577">s</span><span class="op" id="8367578">.</span><span class="ident" id="8367579">c</span><span class="op" id="8367580">.</span><span class="ident" id="8367581">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367585">if</span>&nbsp;<span class="builtinfunc" id="8367588">len</span><span class="op" id="8367591">(</span><span class="ident" id="8367592">args</span><span class="op" id="8367596">)</span>&nbsp;<span class="op" id="8367598">!=</span>&nbsp;<span class="ident" id="8367601">s</span><span class="op" id="8367602">.</span><span class="ident" id="8367603">placeholders</span>&nbsp;<span class="op" id="8367616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8367620">panic</span><span class="op" id="8367625">(</span><span class="string" id="8367626">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="8367684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367691">db</span><span class="op" id="8367693">.</span><span class="ident" id="8367694">mu</span><span class="op" id="8367696">.</span><span class="ident" id="8367697">Lock</span><span class="op" id="8367701">(</span><span class="op" id="8367702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367705">t</span><span class="op" id="8367706">,</span>&nbsp;<span class="ident" id="8367708">ok</span>&nbsp;<span class="op" id="8367711">:=</span>&nbsp;<span class="ident" id="8367714">db</span><span class="op" id="8367716">.</span><span class="ident" id="8367717">table</span><span class="op" id="8367722">(</span><span class="ident" id="8367723">s</span><span class="op" id="8367724">.</span><span class="ident" id="8367725">table</span><span class="op" id="8367730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367733">db</span><span class="op" id="8367735">.</span><span class="ident" id="8367736">mu</span><span class="op" id="8367738">.</span><span class="ident" id="8367739">Unlock</span><span class="op" id="8367745">(</span><span class="op" id="8367746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367749">if</span>&nbsp;<span class="op" id="8367752">!</span><span class="ident" id="8367753">ok</span>&nbsp;<span class="op" id="8367756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367760">return</span>&nbsp;<span class="builtintype" id="8367767">nil</span><span class="op" id="8367770">,</span>&nbsp;<span class="ident" id="8367772">fmt</span><span class="op" id="8367775">.</span><span class="ident" id="8367776">Errorf</span><span class="op" id="8367782">(</span><span class="string" id="8367783">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="8367815">,</span>&nbsp;<span class="ident" id="8367817">s</span><span class="op" id="8367818">.</span><span class="ident" id="8367819">table</span><span class="op" id="8367824">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8367827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367831">if</span>&nbsp;<span class="ident" id="8367834">s</span><span class="op" id="8367835">.</span><span class="ident" id="8367836">table</span>&nbsp;<span class="op" id="8367842">==</span>&nbsp;<span class="string" id="8367845">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="8367858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367862">if</span>&nbsp;<span class="builtinfunc" id="8367865">len</span><span class="op" id="8367868">(</span><span class="ident" id="8367869">s</span><span class="op" id="8367870">.</span><span class="ident" id="8367871">whereCol</span><span class="op" id="8367879">)</span>&nbsp;<span class="op" id="8367881">==</span>&nbsp;<span class="num" id="8367884">2</span>&nbsp;<span class="op" id="8367886">&amp;&amp;</span>&nbsp;<span class="ident" id="8367889">s</span><span class="op" id="8367890">.</span><span class="ident" id="8367891">whereCol</span><span class="op" id="8367899">[</span><span class="num" id="8367900">0</span><span class="op" id="8367901">]</span>&nbsp;<span class="op" id="8367903">==</span>&nbsp;<span class="string" id="8367906">&#34;op&#34;</span>&nbsp;<span class="op" id="8367911">&amp;&amp;</span>&nbsp;<span class="ident" id="8367914">s</span><span class="op" id="8367915">.</span><span class="ident" id="8367916">whereCol</span><span class="op" id="8367924">[</span><span class="num" id="8367925">1</span><span class="op" id="8367926">]</span>&nbsp;<span class="op" id="8367928">==</span>&nbsp;<span class="string" id="8367931">&#34;millis&#34;</span>&nbsp;<span class="op" id="8367940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8367945">if</span>&nbsp;<span class="ident" id="8367948">args</span><span class="op" id="8367952">[</span><span class="num" id="8367953">0</span><span class="op" id="8367954">]</span>&nbsp;<span class="op" id="8367956">==</span>&nbsp;<span class="string" id="8367959">&#34;sleep&#34;</span>&nbsp;<span class="op" id="8367967">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8367973">time</span><span class="op" id="8367977">.</span><span class="ident" id="8367978">Sleep</span><span class="op" id="8367983">(</span><span class="ident" id="8367984">time</span><span class="op" id="8367988">.</span><span class="ident" id="8367989">Duration</span><span class="op" id="8367997">(</span><span class="ident" id="8367998">args</span><span class="op" id="8368002">[</span><span class="num" id="8368003">1</span><span class="op" id="8368004">]</span><span class="op" id="8368005">.</span><span class="op" id="8368006">(</span><span class="builtintype" id="8368007">int64</span><span class="op" id="8368012">)</span><span class="op" id="8368013">)</span>&nbsp;<span class="op" id="8368015">*</span>&nbsp;<span class="ident" id="8368017">time</span><span class="op" id="8368021">.</span><span class="ident" id="8368022">Millisecond</span><span class="op" id="8368033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368049">t</span><span class="op" id="8368050">.</span><span class="ident" id="8368051">mu</span><span class="op" id="8368053">.</span><span class="ident" id="8368054">Lock</span><span class="op" id="8368058">(</span><span class="op" id="8368059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368062">defer</span>&nbsp;<span class="ident" id="8368068">t</span><span class="op" id="8368069">.</span><span class="ident" id="8368070">mu</span><span class="op" id="8368072">.</span><span class="ident" id="8368073">Unlock</span><span class="op" id="8368079">(</span><span class="op" id="8368080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368084">colIdx</span>&nbsp;<span class="op" id="8368091">:=</span>&nbsp;<span class="builtinfunc" id="8368094">make</span><span class="op" id="8368098">(</span><span class="keyword" id="8368099">map</span><span class="op" id="8368102">[</span><span class="builtintype" id="8368103">string</span><span class="op" id="8368109">]</span><span class="builtintype" id="8368110">int</span><span class="op" id="8368113">)</span>&nbsp;<span class="comment" id="8368115">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368163">for</span>&nbsp;<span class="ident" id="8368167">_</span><span class="op" id="8368168">,</span>&nbsp;<span class="ident" id="8368170">name</span>&nbsp;<span class="op" id="8368175">:=</span>&nbsp;<span class="keyword" id="8368178">range</span>&nbsp;<span class="ident" id="8368184">s</span><span class="op" id="8368185">.</span><span class="ident" id="8368186">colName</span>&nbsp;<span class="op" id="8368194">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368198">idx</span>&nbsp;<span class="op" id="8368202">:=</span>&nbsp;<span class="ident" id="8368205">t</span><span class="op" id="8368206">.</span><span class="ident" id="8368207">columnIndex</span><span class="op" id="8368218">(</span><span class="ident" id="8368219">name</span><span class="op" id="8368223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368227">if</span>&nbsp;<span class="ident" id="8368230">idx</span>&nbsp;<span class="op" id="8368234">==</span>&nbsp;<span class="op" id="8368237">-</span><span class="num" id="8368238">1</span>&nbsp;<span class="op" id="8368240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368245">return</span>&nbsp;<span class="builtintype" id="8368252">nil</span><span class="op" id="8368255">,</span>&nbsp;<span class="ident" id="8368257">fmt</span><span class="op" id="8368260">.</span><span class="ident" id="8368261">Errorf</span><span class="op" id="8368267">(</span><span class="string" id="8368268">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="8368300">,</span>&nbsp;<span class="ident" id="8368302">name</span><span class="op" id="8368306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368314">colIdx</span><span class="op" id="8368320">[</span><span class="ident" id="8368321">name</span><span class="op" id="8368325">]</span>&nbsp;<span class="op" id="8368327">=</span>&nbsp;<span class="ident" id="8368329">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368338">mrows</span>&nbsp;<span class="op" id="8368344">:=</span>&nbsp;<span class="op" id="8368347">[</span><span class="op" id="8368348">]</span><span class="op" id="8368349">*</span><span class="ident" id="8368350">row</span><span class="op" id="8368353">{</span><span class="op" id="8368354">}</span><br>
<span class="lineno"></span><span class="ident" id="8368356">rows</span><span class="op" id="8368360">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368363">for</span>&nbsp;<span class="ident" id="8368367">_</span><span class="op" id="8368368">,</span>&nbsp;<span class="ident" id="8368370">trow</span>&nbsp;<span class="op" id="8368375">:=</span>&nbsp;<span class="keyword" id="8368378">range</span>&nbsp;<span class="ident" id="8368384">t</span><span class="op" id="8368385">.</span><span class="ident" id="8368386">rows</span>&nbsp;<span class="op" id="8368391">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8368395">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8368464">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8368532">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368552">for</span>&nbsp;<span class="ident" id="8368556">widx</span><span class="op" id="8368560">,</span>&nbsp;<span class="ident" id="8368562">wcol</span>&nbsp;<span class="op" id="8368567">:=</span>&nbsp;<span class="keyword" id="8368570">range</span>&nbsp;<span class="ident" id="8368576">s</span><span class="op" id="8368577">.</span><span class="ident" id="8368578">whereCol</span>&nbsp;<span class="op" id="8368587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368592">idx</span>&nbsp;<span class="op" id="8368596">:=</span>&nbsp;<span class="ident" id="8368599">t</span><span class="op" id="8368600">.</span><span class="ident" id="8368601">columnIndex</span><span class="op" id="8368612">(</span><span class="ident" id="8368613">wcol</span><span class="op" id="8368617">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368622">if</span>&nbsp;<span class="ident" id="8368625">idx</span>&nbsp;<span class="op" id="8368629">==</span>&nbsp;<span class="op" id="8368632">-</span><span class="num" id="8368633">1</span>&nbsp;<span class="op" id="8368635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368641">return</span>&nbsp;<span class="builtintype" id="8368648">nil</span><span class="op" id="8368651">,</span>&nbsp;<span class="ident" id="8368653">fmt</span><span class="op" id="8368656">.</span><span class="ident" id="8368657">Errorf</span><span class="op" id="8368663">(</span><span class="string" id="8368664">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="8368700">,</span>&nbsp;<span class="ident" id="8368702">wcol</span><span class="op" id="8368706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368716">tcol</span>&nbsp;<span class="op" id="8368721">:=</span>&nbsp;<span class="ident" id="8368724">trow</span><span class="op" id="8368728">.</span><span class="ident" id="8368729">cols</span><span class="op" id="8368733">[</span><span class="ident" id="8368734">idx</span><span class="op" id="8368737">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368742">if</span>&nbsp;<span class="ident" id="8368745">bs</span><span class="op" id="8368747">,</span>&nbsp;<span class="ident" id="8368749">ok</span>&nbsp;<span class="op" id="8368752">:=</span>&nbsp;<span class="ident" id="8368755">tcol</span><span class="op" id="8368759">.</span><span class="op" id="8368760">(</span><span class="op" id="8368761">[</span><span class="op" id="8368762">]</span><span class="builtintype" id="8368763">byte</span><span class="op" id="8368767">)</span><span class="op" id="8368768">;</span>&nbsp;<span class="ident" id="8368770">ok</span>&nbsp;<span class="op" id="8368773">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8368779">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368828">tcol</span>&nbsp;<span class="op" id="8368833">=</span>&nbsp;<span class="builtintype" id="8368835">string</span><span class="op" id="8368841">(</span><span class="ident" id="8368842">bs</span><span class="op" id="8368844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368854">if</span>&nbsp;<span class="ident" id="8368857">fmt</span><span class="op" id="8368860">.</span><span class="ident" id="8368861">Sprintf</span><span class="op" id="8368868">(</span><span class="string" id="8368869">&#34;%v&#34;</span><span class="op" id="8368873">,</span>&nbsp;<span class="ident" id="8368875">tcol</span><span class="op" id="8368879">)</span>&nbsp;<span class="op" id="8368881">!=</span>&nbsp;<span class="ident" id="8368884">fmt</span><span class="op" id="8368887">.</span><span class="ident" id="8368888">Sprintf</span><span class="op" id="8368895">(</span><span class="string" id="8368896">&#34;%v&#34;</span><span class="op" id="8368900">,</span>&nbsp;<span class="ident" id="8368902">args</span><span class="op" id="8368906">[</span><span class="ident" id="8368907">widx</span><span class="op" id="8368911">]</span><span class="op" id="8368912">)</span>&nbsp;<span class="op" id="8368914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8368920">continue</span>&nbsp;<span class="ident" id="8368929">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8368941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8368945">mrow</span>&nbsp;<span class="op" id="8368950">:=</span>&nbsp;<span class="op" id="8368953">&amp;</span><span class="ident" id="8368954">row</span><span class="op" id="8368957">{</span><span class="ident" id="8368958">cols</span><span class="op" id="8368962">:</span>&nbsp;<span class="builtinfunc" id="8368964">make</span><span class="op" id="8368968">(</span><span class="op" id="8368969">[</span><span class="op" id="8368970">]</span><span class="keyword" id="8368971">interface</span><span class="op" id="8368980">{</span><span class="op" id="8368981">}</span><span class="op" id="8368982">,</span>&nbsp;<span class="builtinfunc" id="8368984">len</span><span class="op" id="8368987">(</span><span class="ident" id="8368988">s</span><span class="op" id="8368989">.</span><span class="ident" id="8368990">colName</span><span class="op" id="8368997">)</span><span class="op" id="8368998">)</span><span class="op" id="8368999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369003">for</span>&nbsp;<span class="ident" id="8369007">seli</span><span class="op" id="8369011">,</span>&nbsp;<span class="ident" id="8369013">name</span>&nbsp;<span class="op" id="8369018">:=</span>&nbsp;<span class="keyword" id="8369021">range</span>&nbsp;<span class="ident" id="8369027">s</span><span class="op" id="8369028">.</span><span class="ident" id="8369029">colName</span>&nbsp;<span class="op" id="8369037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369042">mrow</span><span class="op" id="8369046">.</span><span class="ident" id="8369047">cols</span><span class="op" id="8369051">[</span><span class="ident" id="8369052">seli</span><span class="op" id="8369056">]</span>&nbsp;<span class="op" id="8369058">=</span>&nbsp;<span class="ident" id="8369060">trow</span><span class="op" id="8369064">.</span><span class="ident" id="8369065">cols</span><span class="op" id="8369069">[</span><span class="ident" id="8369070">colIdx</span><span class="op" id="8369076">[</span><span class="ident" id="8369077">name</span><span class="op" id="8369081">]</span><span class="op" id="8369082">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8369086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369090">mrows</span>&nbsp;<span class="op" id="8369096">=</span>&nbsp;<span class="builtinfunc" id="8369098">append</span><span class="op" id="8369104">(</span><span class="ident" id="8369105">mrows</span><span class="op" id="8369110">,</span>&nbsp;<span class="ident" id="8369112">mrow</span><span class="op" id="8369116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8369119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369123">cursor</span>&nbsp;<span class="op" id="8369130">:=</span>&nbsp;<span class="op" id="8369133">&amp;</span><span class="ident" id="8369134">rowsCursor</span><span class="op" id="8369144">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369148">pos</span><span class="op" id="8369151">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8369156">-</span><span class="num" id="8369157">1</span><span class="op" id="8369158">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369162">rows</span><span class="op" id="8369166">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8369170">mrows</span><span class="op" id="8369175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369179">cols</span><span class="op" id="8369183">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8369187">s</span><span class="op" id="8369188">.</span><span class="ident" id="8369189">colName</span><span class="op" id="8369196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369200">errPos</span><span class="op" id="8369206">:</span>&nbsp;<span class="op" id="8369208">-</span><span class="num" id="8369209">1</span><span class="op" id="8369210">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8369213">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369216">return</span>&nbsp;<span class="ident" id="8369223">cursor</span><span class="op" id="8369229">,</span>&nbsp;<span class="builtintype" id="8369231">nil</span><br>
<span class="lineno"></span><span class="op" id="8369235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8369238">func</span>&nbsp;<span class="op" id="8369243">(</span><span class="ident" id="8369244">s</span>&nbsp;<span class="op" id="8369246">*</span><span class="ident" id="8369247">fakeStmt</span><span class="op" id="8369255">)</span>&nbsp;<span class="ident" id="8369257">NumInput</span><span class="op" id="8369265">(</span><span class="op" id="8369266">)</span>&nbsp;<span class="builtintype" id="8369268">int</span>&nbsp;<span class="op" id="8369272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369275">return</span>&nbsp;<span class="ident" id="8369282">s</span><span class="op" id="8369283">.</span><span class="ident" id="8369284">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="8369297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8369300">func</span>&nbsp;<span class="op" id="8369305">(</span><span class="ident" id="8369306">tx</span>&nbsp;<span class="op" id="8369309">*</span><span class="ident" id="8369310">fakeTx</span><span class="op" id="8369316">)</span>&nbsp;<span class="ident" id="8369318">Commit</span><span class="op" id="8369324">(</span><span class="op" id="8369325">)</span>&nbsp;<span class="builtintype" id="8369327">error</span>&nbsp;<span class="op" id="8369333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369336">tx</span><span class="op" id="8369338">.</span><span class="ident" id="8369339">c</span><span class="op" id="8369340">.</span><span class="ident" id="8369341">currTx</span>&nbsp;<span class="op" id="8369348">=</span>&nbsp;<span class="builtintype" id="8369350">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369355">return</span>&nbsp;<span class="builtintype" id="8369362">nil</span><br>
<span class="lineno">700</span><span class="op" id="8369366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8369369">func</span>&nbsp;<span class="op" id="8369374">(</span><span class="ident" id="8369375">tx</span>&nbsp;<span class="op" id="8369378">*</span><span class="ident" id="8369379">fakeTx</span><span class="op" id="8369385">)</span>&nbsp;<span class="ident" id="8369387">Rollback</span><span class="op" id="8369395">(</span><span class="op" id="8369396">)</span>&nbsp;<span class="builtintype" id="8369398">error</span>&nbsp;<span class="op" id="8369404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369407">tx</span><span class="op" id="8369409">.</span><span class="ident" id="8369410">c</span><span class="op" id="8369411">.</span><span class="ident" id="8369412">currTx</span>&nbsp;<span class="op" id="8369419">=</span>&nbsp;<span class="builtintype" id="8369421">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369426">return</span>&nbsp;<span class="builtintype" id="8369433">nil</span><br>
<span class="lineno">705</span><span class="op" id="8369437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8369440">type</span>&nbsp;<span class="ident" id="8369445">rowsCursor</span>&nbsp;<span class="keyword" id="8369456">struct</span>&nbsp;<span class="op" id="8369463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369466">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8369473">[</span><span class="op" id="8369474">]</span><span class="builtintype" id="8369475">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369483">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8369490">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369495">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8369502">[</span><span class="op" id="8369503">]</span><span class="op" id="8369504">*</span><span class="ident" id="8369505">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369510">closed</span>&nbsp;<span class="builtintype" id="8369517">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8369524">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369588">errPos</span>&nbsp;<span class="builtintype" id="8369595">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369600">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8369607">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8369615">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8369676">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8369736">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369785">bytesClone</span>&nbsp;<span class="keyword" id="8369796">map</span><span class="op" id="8369799">[</span><span class="op" id="8369800">*</span><span class="builtintype" id="8369801">byte</span><span class="op" id="8369805">]</span><span class="op" id="8369806">[</span><span class="op" id="8369807">]</span><span class="builtintype" id="8369808">byte</span><br>
<span class="lineno"></span><span class="op" id="8369813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8369816">func</span>&nbsp;<span class="op" id="8369821">(</span><span class="ident" id="8369822">rc</span>&nbsp;<span class="op" id="8369825">*</span><span class="ident" id="8369826">rowsCursor</span><span class="op" id="8369836">)</span>&nbsp;<span class="ident" id="8369838">Close</span><span class="op" id="8369843">(</span><span class="op" id="8369844">)</span>&nbsp;<span class="builtintype" id="8369846">error</span>&nbsp;<span class="op" id="8369852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369855">if</span>&nbsp;<span class="op" id="8369858">!</span><span class="ident" id="8369859">rc</span><span class="op" id="8369861">.</span><span class="ident" id="8369862">closed</span>&nbsp;<span class="op" id="8369869">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369873">for</span>&nbsp;<span class="ident" id="8369877">_</span><span class="op" id="8369878">,</span>&nbsp;<span class="ident" id="8369880">bs</span>&nbsp;<span class="op" id="8369883">:=</span>&nbsp;<span class="keyword" id="8369886">range</span>&nbsp;<span class="ident" id="8369892">rc</span><span class="op" id="8369894">.</span><span class="ident" id="8369895">bytesClone</span>&nbsp;<span class="op" id="8369906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369911">bs</span><span class="op" id="8369913">[</span><span class="num" id="8369914">0</span><span class="op" id="8369915">]</span>&nbsp;<span class="op" id="8369917">=</span>&nbsp;<span class="num" id="8369919">255</span>&nbsp;<span class="comment" id="8369923">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8369949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8369952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8369955">rc</span><span class="op" id="8369957">.</span><span class="ident" id="8369958">closed</span>&nbsp;<span class="op" id="8369965">=</span>&nbsp;<span class="builtintype" id="8369967">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8369973">return</span>&nbsp;<span class="builtintype" id="8369980">nil</span><br>
<span class="lineno"></span><span class="op" id="8369984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8369987">func</span>&nbsp;<span class="op" id="8369992">(</span><span class="ident" id="8369993">rc</span>&nbsp;<span class="op" id="8369996">*</span><span class="ident" id="8369997">rowsCursor</span><span class="op" id="8370007">)</span>&nbsp;<span class="ident" id="8370009">Columns</span><span class="op" id="8370016">(</span><span class="op" id="8370017">)</span>&nbsp;<span class="op" id="8370019">[</span><span class="op" id="8370020">]</span><span class="builtintype" id="8370021">string</span>&nbsp;<span class="op" id="8370028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370031">return</span>&nbsp;<span class="ident" id="8370038">rc</span><span class="op" id="8370040">.</span><span class="ident" id="8370041">cols</span><br>
<span class="lineno">735</span><span class="op" id="8370046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8370049">var</span>&nbsp;<span class="ident" id="8370053">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="8370072">func</span><span class="op" id="8370076">(</span><span class="ident" id="8370077">dest</span>&nbsp;<span class="op" id="8370082">[</span><span class="op" id="8370083">]</span><span class="ident" id="8370084">driver</span><span class="op" id="8370090">.</span><span class="ident" id="8370091">Value</span><span class="op" id="8370096">)</span>&nbsp;<span class="builtintype" id="8370098">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8370105">func</span>&nbsp;<span class="op" id="8370110">(</span><span class="ident" id="8370111">rc</span>&nbsp;<span class="op" id="8370114">*</span><span class="ident" id="8370115">rowsCursor</span><span class="op" id="8370125">)</span>&nbsp;<span class="ident" id="8370127">Next</span><span class="op" id="8370131">(</span><span class="ident" id="8370132">dest</span>&nbsp;<span class="op" id="8370137">[</span><span class="op" id="8370138">]</span><span class="ident" id="8370139">driver</span><span class="op" id="8370145">.</span><span class="ident" id="8370146">Value</span><span class="op" id="8370151">)</span>&nbsp;<span class="builtintype" id="8370153">error</span>&nbsp;<span class="op" id="8370159">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370162">if</span>&nbsp;<span class="ident" id="8370165">rowsCursorNextHook</span>&nbsp;<span class="op" id="8370184">!=</span>&nbsp;<span class="builtintype" id="8370187">nil</span>&nbsp;<span class="op" id="8370191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370195">return</span>&nbsp;<span class="ident" id="8370202">rowsCursorNextHook</span><span class="op" id="8370220">(</span><span class="ident" id="8370221">dest</span><span class="op" id="8370225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8370228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370232">if</span>&nbsp;<span class="ident" id="8370235">rc</span><span class="op" id="8370237">.</span><span class="ident" id="8370238">closed</span>&nbsp;<span class="op" id="8370245">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370249">return</span>&nbsp;<span class="ident" id="8370256">errors</span><span class="op" id="8370262">.</span><span class="ident" id="8370263">New</span><span class="op" id="8370266">(</span><span class="string" id="8370267">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="8370293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8370296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8370299">rc</span><span class="op" id="8370301">.</span><span class="ident" id="8370302">pos</span><span class="op" id="8370305">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370309">if</span>&nbsp;<span class="ident" id="8370312">rc</span><span class="op" id="8370314">.</span><span class="ident" id="8370315">pos</span>&nbsp;<span class="op" id="8370319">==</span>&nbsp;<span class="ident" id="8370322">rc</span><span class="op" id="8370324">.</span><span class="ident" id="8370325">errPos</span>&nbsp;<span class="op" id="8370332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370336">return</span>&nbsp;<span class="ident" id="8370343">rc</span><span class="op" id="8370345">.</span><span class="ident" id="8370346">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8370351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370354">if</span>&nbsp;<span class="ident" id="8370357">rc</span><span class="op" id="8370359">.</span><span class="ident" id="8370360">pos</span>&nbsp;<span class="op" id="8370364">&gt;=</span>&nbsp;<span class="builtinfunc" id="8370367">len</span><span class="op" id="8370370">(</span><span class="ident" id="8370371">rc</span><span class="op" id="8370373">.</span><span class="ident" id="8370374">rows</span><span class="op" id="8370378">)</span>&nbsp;<span class="op" id="8370380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370384">return</span>&nbsp;<span class="ident" id="8370391">io</span><span class="op" id="8370393">.</span><span class="ident" id="8370394">EOF</span>&nbsp;<span class="comment" id="8370398">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8370421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370424">for</span>&nbsp;<span class="ident" id="8370428">i</span><span class="op" id="8370429">,</span>&nbsp;<span class="ident" id="8370431">v</span>&nbsp;<span class="op" id="8370433">:=</span>&nbsp;<span class="keyword" id="8370436">range</span>&nbsp;<span class="ident" id="8370442">rc</span><span class="op" id="8370444">.</span><span class="ident" id="8370445">rows</span><span class="op" id="8370449">[</span><span class="ident" id="8370450">rc</span><span class="op" id="8370452">.</span><span class="ident" id="8370453">pos</span><span class="op" id="8370456">]</span><span class="op" id="8370457">.</span><span class="ident" id="8370458">cols</span>&nbsp;<span class="op" id="8370463">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8370467">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8370521">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8370573">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8370631">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8370686">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8370740">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8370795">dest</span><span class="op" id="8370799">[</span><span class="ident" id="8370800">i</span><span class="op" id="8370801">]</span>&nbsp;<span class="op" id="8370803">=</span>&nbsp;<span class="ident" id="8370805">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370810">if</span>&nbsp;<span class="ident" id="8370813">bs</span><span class="op" id="8370815">,</span>&nbsp;<span class="ident" id="8370817">ok</span>&nbsp;<span class="op" id="8370820">:=</span>&nbsp;<span class="ident" id="8370823">v</span><span class="op" id="8370824">.</span><span class="op" id="8370825">(</span><span class="op" id="8370826">[</span><span class="op" id="8370827">]</span><span class="builtintype" id="8370828">byte</span><span class="op" id="8370832">)</span><span class="op" id="8370833">;</span>&nbsp;<span class="ident" id="8370835">ok</span>&nbsp;<span class="op" id="8370838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370843">if</span>&nbsp;<span class="ident" id="8370846">rc</span><span class="op" id="8370848">.</span><span class="ident" id="8370849">bytesClone</span>&nbsp;<span class="op" id="8370860">==</span>&nbsp;<span class="builtintype" id="8370863">nil</span>&nbsp;<span class="op" id="8370867">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8370873">rc</span><span class="op" id="8370875">.</span><span class="ident" id="8370876">bytesClone</span>&nbsp;<span class="op" id="8370887">=</span>&nbsp;<span class="builtinfunc" id="8370889">make</span><span class="op" id="8370893">(</span><span class="keyword" id="8370894">map</span><span class="op" id="8370897">[</span><span class="op" id="8370898">*</span><span class="builtintype" id="8370899">byte</span><span class="op" id="8370903">]</span><span class="op" id="8370904">[</span><span class="op" id="8370905">]</span><span class="builtintype" id="8370906">byte</span><span class="op" id="8370910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8370915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8370920">clone</span><span class="op" id="8370925">,</span>&nbsp;<span class="ident" id="8370927">ok</span>&nbsp;<span class="op" id="8370930">:=</span>&nbsp;<span class="ident" id="8370933">rc</span><span class="op" id="8370935">.</span><span class="ident" id="8370936">bytesClone</span><span class="op" id="8370946">[</span><span class="op" id="8370947">&amp;</span><span class="ident" id="8370948">bs</span><span class="op" id="8370950">[</span><span class="num" id="8370951">0</span><span class="op" id="8370952">]</span><span class="op" id="8370953">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8370958">if</span>&nbsp;<span class="op" id="8370961">!</span><span class="ident" id="8370962">ok</span>&nbsp;<span class="op" id="8370965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8370971">clone</span>&nbsp;<span class="op" id="8370977">=</span>&nbsp;<span class="builtinfunc" id="8370979">make</span><span class="op" id="8370983">(</span><span class="op" id="8370984">[</span><span class="op" id="8370985">]</span><span class="builtintype" id="8370986">byte</span><span class="op" id="8370990">,</span>&nbsp;<span class="builtinfunc" id="8370992">len</span><span class="op" id="8370995">(</span><span class="ident" id="8370996">bs</span><span class="op" id="8370998">)</span><span class="op" id="8370999">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8371005">copy</span><span class="op" id="8371009">(</span><span class="ident" id="8371010">clone</span><span class="op" id="8371015">,</span>&nbsp;<span class="ident" id="8371017">bs</span><span class="op" id="8371019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8371025">rc</span><span class="op" id="8371027">.</span><span class="ident" id="8371028">bytesClone</span><span class="op" id="8371038">[</span><span class="op" id="8371039">&amp;</span><span class="ident" id="8371040">bs</span><span class="op" id="8371042">[</span><span class="num" id="8371043">0</span><span class="op" id="8371044">]</span><span class="op" id="8371045">]</span>&nbsp;<span class="op" id="8371047">=</span>&nbsp;<span class="ident" id="8371049">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8371058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8371063">dest</span><span class="op" id="8371067">[</span><span class="ident" id="8371068">i</span><span class="op" id="8371069">]</span>&nbsp;<span class="op" id="8371071">=</span>&nbsp;<span class="ident" id="8371073">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8371081">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8371084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371087">return</span>&nbsp;<span class="builtintype" id="8371094">nil</span><br>
<span class="lineno"></span><span class="op" id="8371098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8371101">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="8371172">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="8371198">//</span><br>
<span class="lineno"></span><span class="comment" id="8371201">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="8371264">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8371329">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="8371363">//</span><br>
<span class="lineno"></span><span class="keyword" id="8371366">type</span>&nbsp;<span class="ident" id="8371371">fakeDriverString</span>&nbsp;<span class="keyword" id="8371388">struct</span><span class="op" id="8371394">{</span><span class="op" id="8371395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8371398">func</span>&nbsp;<span class="op" id="8371403">(</span><span class="ident" id="8371404">fakeDriverString</span><span class="op" id="8371420">)</span>&nbsp;<span class="ident" id="8371422">ConvertValue</span><span class="op" id="8371434">(</span><span class="ident" id="8371435">v</span>&nbsp;<span class="keyword" id="8371437">interface</span><span class="op" id="8371446">{</span><span class="op" id="8371447">}</span><span class="op" id="8371448">)</span>&nbsp;<span class="op" id="8371450">(</span><span class="ident" id="8371451">driver</span><span class="op" id="8371457">.</span><span class="ident" id="8371458">Value</span><span class="op" id="8371463">,</span>&nbsp;<span class="builtintype" id="8371465">error</span><span class="op" id="8371470">)</span>&nbsp;<span class="op" id="8371472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371475">switch</span>&nbsp;<span class="ident" id="8371482">c</span>&nbsp;<span class="op" id="8371484">:=</span>&nbsp;<span class="ident" id="8371487">v</span><span class="op" id="8371488">.</span><span class="op" id="8371489">(</span><span class="keyword" id="8371490">type</span><span class="op" id="8371494">)</span>&nbsp;<span class="op" id="8371496">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371499">case</span>&nbsp;<span class="builtintype" id="8371504">string</span><span class="op" id="8371510">,</span>&nbsp;<span class="op" id="8371512">[</span><span class="op" id="8371513">]</span><span class="builtintype" id="8371514">byte</span><span class="op" id="8371518">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371522">return</span>&nbsp;<span class="ident" id="8371529">v</span><span class="op" id="8371530">,</span>&nbsp;<span class="builtintype" id="8371532">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371537">case</span>&nbsp;<span class="op" id="8371542">*</span><span class="builtintype" id="8371543">string</span><span class="op" id="8371549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371553">if</span>&nbsp;<span class="ident" id="8371556">c</span>&nbsp;<span class="op" id="8371558">==</span>&nbsp;<span class="builtintype" id="8371561">nil</span>&nbsp;<span class="op" id="8371565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371570">return</span>&nbsp;<span class="builtintype" id="8371577">nil</span><span class="op" id="8371580">,</span>&nbsp;<span class="builtintype" id="8371582">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8371588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371592">return</span>&nbsp;<span class="op" id="8371599">*</span><span class="ident" id="8371600">c</span><span class="op" id="8371601">,</span>&nbsp;<span class="builtintype" id="8371603">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8371608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371611">return</span>&nbsp;<span class="ident" id="8371618">fmt</span><span class="op" id="8371621">.</span><span class="ident" id="8371622">Sprintf</span><span class="op" id="8371629">(</span><span class="string" id="8371630">&#34;%v&#34;</span><span class="op" id="8371634">,</span>&nbsp;<span class="ident" id="8371636">v</span><span class="op" id="8371637">)</span><span class="op" id="8371638">,</span>&nbsp;<span class="builtintype" id="8371640">nil</span><br>
<span class="lineno"></span><span class="op" id="8371644">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="8371647">func</span>&nbsp;<span class="ident" id="8371652">converterForType</span><span class="op" id="8371668">(</span><span class="ident" id="8371669">typ</span>&nbsp;<span class="builtintype" id="8371673">string</span><span class="op" id="8371679">)</span>&nbsp;<span class="ident" id="8371681">driver</span><span class="op" id="8371687">.</span><span class="ident" id="8371688">ValueConverter</span>&nbsp;<span class="op" id="8371703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371706">switch</span>&nbsp;<span class="ident" id="8371713">typ</span>&nbsp;<span class="op" id="8371717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371720">case</span>&nbsp;<span class="string" id="8371725">&#34;bool&#34;</span><span class="op" id="8371731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371735">return</span>&nbsp;<span class="ident" id="8371742">driver</span><span class="op" id="8371748">.</span><span class="ident" id="8371749">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371755">case</span>&nbsp;<span class="string" id="8371760">&#34;nullbool&#34;</span><span class="op" id="8371770">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371774">return</span>&nbsp;<span class="ident" id="8371781">driver</span><span class="op" id="8371787">.</span><span class="ident" id="8371788">Null</span><span class="op" id="8371792">{</span><span class="ident" id="8371793">Converter</span><span class="op" id="8371802">:</span>&nbsp;<span class="ident" id="8371804">driver</span><span class="op" id="8371810">.</span><span class="ident" id="8371811">Bool</span><span class="op" id="8371815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371818">case</span>&nbsp;<span class="string" id="8371823">&#34;int32&#34;</span><span class="op" id="8371830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371834">return</span>&nbsp;<span class="ident" id="8371841">driver</span><span class="op" id="8371847">.</span><span class="ident" id="8371848">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371855">case</span>&nbsp;<span class="string" id="8371860">&#34;string&#34;</span><span class="op" id="8371868">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371872">return</span>&nbsp;<span class="ident" id="8371879">driver</span><span class="op" id="8371885">.</span><span class="ident" id="8371886">NotNull</span><span class="op" id="8371893">{</span><span class="ident" id="8371894">Converter</span><span class="op" id="8371903">:</span>&nbsp;<span class="ident" id="8371905">fakeDriverString</span><span class="op" id="8371921">{</span><span class="op" id="8371922">}</span><span class="op" id="8371923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371926">case</span>&nbsp;<span class="string" id="8371931">&#34;nullstring&#34;</span><span class="op" id="8371943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371947">return</span>&nbsp;<span class="ident" id="8371954">driver</span><span class="op" id="8371960">.</span><span class="ident" id="8371961">Null</span><span class="op" id="8371965">{</span><span class="ident" id="8371966">Converter</span><span class="op" id="8371975">:</span>&nbsp;<span class="ident" id="8371977">fakeDriverString</span><span class="op" id="8371993">{</span><span class="op" id="8371994">}</span><span class="op" id="8371995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8371998">case</span>&nbsp;<span class="string" id="8372003">&#34;int64&#34;</span><span class="op" id="8372010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8372014">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372066">return</span>&nbsp;<span class="ident" id="8372073">driver</span><span class="op" id="8372079">.</span><span class="ident" id="8372080">NotNull</span><span class="op" id="8372087">{</span><span class="ident" id="8372088">Converter</span><span class="op" id="8372097">:</span>&nbsp;<span class="ident" id="8372099">driver</span><span class="op" id="8372105">.</span><span class="ident" id="8372106">DefaultParameterConverter</span><span class="op" id="8372131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372134">case</span>&nbsp;<span class="string" id="8372139">&#34;nullint64&#34;</span><span class="op" id="8372150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8372154">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372206">return</span>&nbsp;<span class="ident" id="8372213">driver</span><span class="op" id="8372219">.</span><span class="ident" id="8372220">Null</span><span class="op" id="8372224">{</span><span class="ident" id="8372225">Converter</span><span class="op" id="8372234">:</span>&nbsp;<span class="ident" id="8372236">driver</span><span class="op" id="8372242">.</span><span class="ident" id="8372243">DefaultParameterConverter</span><span class="op" id="8372268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372271">case</span>&nbsp;<span class="string" id="8372276">&#34;float64&#34;</span><span class="op" id="8372285">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8372289">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372341">return</span>&nbsp;<span class="ident" id="8372348">driver</span><span class="op" id="8372354">.</span><span class="ident" id="8372355">NotNull</span><span class="op" id="8372362">{</span><span class="ident" id="8372363">Converter</span><span class="op" id="8372372">:</span>&nbsp;<span class="ident" id="8372374">driver</span><span class="op" id="8372380">.</span><span class="ident" id="8372381">DefaultParameterConverter</span><span class="op" id="8372406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372409">case</span>&nbsp;<span class="string" id="8372414">&#34;nullfloat64&#34;</span><span class="op" id="8372427">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8372431">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372483">return</span>&nbsp;<span class="ident" id="8372490">driver</span><span class="op" id="8372496">.</span><span class="ident" id="8372497">Null</span><span class="op" id="8372501">{</span><span class="ident" id="8372502">Converter</span><span class="op" id="8372511">:</span>&nbsp;<span class="ident" id="8372513">driver</span><span class="op" id="8372519">.</span><span class="ident" id="8372520">DefaultParameterConverter</span><span class="op" id="8372545">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372548">case</span>&nbsp;<span class="string" id="8372553">&#34;datetime&#34;</span><span class="op" id="8372563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8372567">return</span>&nbsp;<span class="ident" id="8372574">driver</span><span class="op" id="8372580">.</span><span class="ident" id="8372581">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8372608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8372611">panic</span><span class="op" id="8372616">(</span><span class="string" id="8372617">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="8372650">+</span>&nbsp;<span class="ident" id="8372652">typ</span><span class="op" id="8372655">)</span><br>
<span class="lineno"></span><span class="op" id="8372657">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
