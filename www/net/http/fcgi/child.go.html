<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5116989">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5117044">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5117098">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5117149">package</span>&nbsp;<span class="ident" id="5117157">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5117163">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5117237">import</span>&nbsp;<span class="op" id="5117244">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117247">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117257">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117264">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117270">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117283">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117290">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117302">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117318">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117324">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117335">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5117343">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5117350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5117353">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="5117434">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="5117472">type</span>&nbsp;<span class="ident" id="5117477">request</span>&nbsp;<span class="keyword" id="5117485">struct</span>&nbsp;<span class="op" id="5117492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117495">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5117505">*</span><span class="ident" id="5117506">io</span><span class="op" id="5117508">.</span><span class="ident" id="5117509">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117521">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5117531">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117539">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5117549">map</span><span class="op" id="5117552">[</span><span class="builtintype" id="5117553">string</span><span class="op" id="5117559">]</span><span class="builtintype" id="5117560">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117568">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5117578">[</span><span class="num" id="5117579">1024</span><span class="op" id="5117583">]</span><span class="builtintype" id="5117584">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117590">rawParams</span>&nbsp;<span class="op" id="5117600">[</span><span class="op" id="5117601">]</span><span class="builtintype" id="5117602">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117608">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="5117618">bool</span><br>
<span class="lineno"></span><span class="op" id="5117623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5117626">func</span>&nbsp;<span class="ident" id="5117631">newRequest</span><span class="op" id="5117641">(</span><span class="ident" id="5117642">reqId</span>&nbsp;<span class="builtintype" id="5117648">uint16</span><span class="op" id="5117654">,</span>&nbsp;<span class="ident" id="5117656">flags</span>&nbsp;<span class="builtintype" id="5117662">uint8</span><span class="op" id="5117667">)</span>&nbsp;<span class="op" id="5117669">*</span><span class="ident" id="5117670">request</span>&nbsp;<span class="op" id="5117678">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117681">r</span>&nbsp;<span class="op" id="5117683">:=</span>&nbsp;<span class="op" id="5117686">&amp;</span><span class="ident" id="5117687">request</span><span class="op" id="5117694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117698">reqId</span><span class="op" id="5117703">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5117708">reqId</span><span class="op" id="5117713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117717">params</span><span class="op" id="5117723">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5117727">map</span><span class="op" id="5117730">[</span><span class="builtintype" id="5117731">string</span><span class="op" id="5117737">]</span><span class="builtintype" id="5117738">string</span><span class="op" id="5117744">{</span><span class="op" id="5117745">}</span><span class="op" id="5117746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117750">keepConn</span><span class="op" id="5117758">:</span>&nbsp;<span class="ident" id="5117760">flags</span><span class="op" id="5117765">&amp;</span><span class="ident" id="5117766">flagKeepConn</span>&nbsp;<span class="op" id="5117779">!=</span>&nbsp;<span class="num" id="5117782">0</span><span class="op" id="5117783">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117786">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117789">r</span><span class="op" id="5117790">.</span><span class="ident" id="5117791">rawParams</span>&nbsp;<span class="op" id="5117801">=</span>&nbsp;<span class="ident" id="5117803">r</span><span class="op" id="5117804">.</span><span class="ident" id="5117805">buf</span><span class="op" id="5117808">[</span><span class="op" id="5117809">:</span><span class="num" id="5117810">0</span><span class="op" id="5117811">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117814">return</span>&nbsp;<span class="ident" id="5117821">r</span><br>
<span class="lineno"></span><span class="op" id="5117823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5117826">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="5117878">func</span>&nbsp;<span class="op" id="5117883">(</span><span class="ident" id="5117884">r</span>&nbsp;<span class="op" id="5117886">*</span><span class="ident" id="5117887">request</span><span class="op" id="5117894">)</span>&nbsp;<span class="ident" id="5117896">parseParams</span><span class="op" id="5117907">(</span><span class="op" id="5117908">)</span>&nbsp;<span class="op" id="5117910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117913">text</span>&nbsp;<span class="op" id="5117918">:=</span>&nbsp;<span class="ident" id="5117921">r</span><span class="op" id="5117922">.</span><span class="ident" id="5117923">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117934">r</span><span class="op" id="5117935">.</span><span class="ident" id="5117936">rawParams</span>&nbsp;<span class="op" id="5117946">=</span>&nbsp;<span class="ident" id="5117948">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117953">for</span>&nbsp;<span class="builtinfunc" id="5117957">len</span><span class="op" id="5117960">(</span><span class="ident" id="5117961">text</span><span class="op" id="5117965">)</span>&nbsp;<span class="op" id="5117967">&gt;</span>&nbsp;<span class="num" id="5117969">0</span>&nbsp;<span class="op" id="5117971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117975">keyLen</span><span class="op" id="5117981">,</span>&nbsp;<span class="ident" id="5117983">n</span>&nbsp;<span class="op" id="5117985">:=</span>&nbsp;<span class="ident" id="5117988">readSize</span><span class="op" id="5117996">(</span><span class="ident" id="5117997">text</span><span class="op" id="5118001">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118005">if</span>&nbsp;<span class="ident" id="5118008">n</span>&nbsp;<span class="op" id="5118010">==</span>&nbsp;<span class="num" id="5118013">0</span>&nbsp;<span class="op" id="5118015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118033">text</span>&nbsp;<span class="op" id="5118038">=</span>&nbsp;<span class="ident" id="5118040">text</span><span class="op" id="5118044">[</span><span class="ident" id="5118045">n</span><span class="op" id="5118046">:</span><span class="op" id="5118047">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118051">valLen</span><span class="op" id="5118057">,</span>&nbsp;<span class="ident" id="5118059">n</span>&nbsp;<span class="op" id="5118061">:=</span>&nbsp;<span class="ident" id="5118064">readSize</span><span class="op" id="5118072">(</span><span class="ident" id="5118073">text</span><span class="op" id="5118077">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118081">if</span>&nbsp;<span class="ident" id="5118084">n</span>&nbsp;<span class="op" id="5118086">==</span>&nbsp;<span class="num" id="5118089">0</span>&nbsp;<span class="op" id="5118091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118096">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118109">text</span>&nbsp;<span class="op" id="5118114">=</span>&nbsp;<span class="ident" id="5118116">text</span><span class="op" id="5118120">[</span><span class="ident" id="5118121">n</span><span class="op" id="5118122">:</span><span class="op" id="5118123">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118127">key</span>&nbsp;<span class="op" id="5118131">:=</span>&nbsp;<span class="ident" id="5118134">readString</span><span class="op" id="5118144">(</span><span class="ident" id="5118145">text</span><span class="op" id="5118149">,</span>&nbsp;<span class="ident" id="5118151">keyLen</span><span class="op" id="5118157">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118161">text</span>&nbsp;<span class="op" id="5118166">=</span>&nbsp;<span class="ident" id="5118168">text</span><span class="op" id="5118172">[</span><span class="ident" id="5118173">keyLen</span><span class="op" id="5118179">:</span><span class="op" id="5118180">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118184">val</span>&nbsp;<span class="op" id="5118188">:=</span>&nbsp;<span class="ident" id="5118191">readString</span><span class="op" id="5118201">(</span><span class="ident" id="5118202">text</span><span class="op" id="5118206">,</span>&nbsp;<span class="ident" id="5118208">valLen</span><span class="op" id="5118214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118218">text</span>&nbsp;<span class="op" id="5118223">=</span>&nbsp;<span class="ident" id="5118225">text</span><span class="op" id="5118229">[</span><span class="ident" id="5118230">valLen</span><span class="op" id="5118236">:</span><span class="op" id="5118237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118241">r</span><span class="op" id="5118242">.</span><span class="ident" id="5118243">params</span><span class="op" id="5118249">[</span><span class="ident" id="5118250">key</span><span class="op" id="5118253">]</span>&nbsp;<span class="op" id="5118255">=</span>&nbsp;<span class="ident" id="5118257">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118262">}</span><br>
<span class="lineno">65</span><span class="op" id="5118264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5118267">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="5118311">type</span>&nbsp;<span class="ident" id="5118316">response</span>&nbsp;<span class="keyword" id="5118325">struct</span>&nbsp;<span class="op" id="5118332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118335">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5118347">*</span><span class="ident" id="5118348">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118357">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5118369">http</span><span class="op" id="5118373">.</span><span class="ident" id="5118374">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118382">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5118394">*</span><span class="ident" id="5118395">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118406">wroteHeader</span>&nbsp;<span class="builtintype" id="5118418">bool</span><br>
<span class="lineno"></span><span class="op" id="5118423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="5118426">func</span>&nbsp;<span class="ident" id="5118431">newResponse</span><span class="op" id="5118442">(</span><span class="ident" id="5118443">c</span>&nbsp;<span class="op" id="5118445">*</span><span class="ident" id="5118446">child</span><span class="op" id="5118451">,</span>&nbsp;<span class="ident" id="5118453">req</span>&nbsp;<span class="op" id="5118457">*</span><span class="ident" id="5118458">request</span><span class="op" id="5118465">)</span>&nbsp;<span class="op" id="5118467">*</span><span class="ident" id="5118468">response</span>&nbsp;<span class="op" id="5118477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118480">return</span>&nbsp;<span class="op" id="5118487">&amp;</span><span class="ident" id="5118488">response</span><span class="op" id="5118496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118500">req</span><span class="op" id="5118503">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5118508">req</span><span class="op" id="5118511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118515">header</span><span class="op" id="5118521">:</span>&nbsp;<span class="ident" id="5118523">http</span><span class="op" id="5118527">.</span><span class="ident" id="5118528">Header</span><span class="op" id="5118534">{</span><span class="op" id="5118535">}</span><span class="op" id="5118536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118540">w</span><span class="op" id="5118541">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5118548">newWriter</span><span class="op" id="5118557">(</span><span class="ident" id="5118558">c</span><span class="op" id="5118559">.</span><span class="ident" id="5118560">conn</span><span class="op" id="5118564">,</span>&nbsp;<span class="ident" id="5118566">typeStdout</span><span class="op" id="5118576">,</span>&nbsp;<span class="ident" id="5118578">req</span><span class="op" id="5118581">.</span><span class="ident" id="5118582">reqId</span><span class="op" id="5118587">)</span><span class="op" id="5118588">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118591">}</span><br>
<span class="lineno"></span><span class="op" id="5118593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5118596">func</span>&nbsp;<span class="op" id="5118601">(</span><span class="ident" id="5118602">r</span>&nbsp;<span class="op" id="5118604">*</span><span class="ident" id="5118605">response</span><span class="op" id="5118613">)</span>&nbsp;<span class="ident" id="5118615">Header</span><span class="op" id="5118621">(</span><span class="op" id="5118622">)</span>&nbsp;<span class="ident" id="5118624">http</span><span class="op" id="5118628">.</span><span class="ident" id="5118629">Header</span>&nbsp;<span class="op" id="5118636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118639">return</span>&nbsp;<span class="ident" id="5118646">r</span><span class="op" id="5118647">.</span><span class="ident" id="5118648">header</span><br>
<span class="lineno">85</span><span class="op" id="5118655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5118658">func</span>&nbsp;<span class="op" id="5118663">(</span><span class="ident" id="5118664">r</span>&nbsp;<span class="op" id="5118666">*</span><span class="ident" id="5118667">response</span><span class="op" id="5118675">)</span>&nbsp;<span class="ident" id="5118677">Write</span><span class="op" id="5118682">(</span><span class="ident" id="5118683">data</span>&nbsp;<span class="op" id="5118688">[</span><span class="op" id="5118689">]</span><span class="builtintype" id="5118690">byte</span><span class="op" id="5118694">)</span>&nbsp;<span class="op" id="5118696">(</span><span class="builtintype" id="5118697">int</span><span class="op" id="5118700">,</span>&nbsp;<span class="builtintype" id="5118702">error</span><span class="op" id="5118707">)</span>&nbsp;<span class="op" id="5118709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118712">if</span>&nbsp;<span class="op" id="5118715">!</span><span class="ident" id="5118716">r</span><span class="op" id="5118717">.</span><span class="ident" id="5118718">wroteHeader</span>&nbsp;<span class="op" id="5118730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118734">r</span><span class="op" id="5118735">.</span><span class="ident" id="5118736">WriteHeader</span><span class="op" id="5118747">(</span><span class="ident" id="5118748">http</span><span class="op" id="5118752">.</span><span class="ident" id="5118753">StatusOK</span><span class="op" id="5118761">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118767">return</span>&nbsp;<span class="ident" id="5118774">r</span><span class="op" id="5118775">.</span><span class="ident" id="5118776">w</span><span class="op" id="5118777">.</span><span class="ident" id="5118778">Write</span><span class="op" id="5118783">(</span><span class="ident" id="5118784">data</span><span class="op" id="5118788">)</span><br>
<span class="lineno"></span><span class="op" id="5118790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5118793">func</span>&nbsp;<span class="op" id="5118798">(</span><span class="ident" id="5118799">r</span>&nbsp;<span class="op" id="5118801">*</span><span class="ident" id="5118802">response</span><span class="op" id="5118810">)</span>&nbsp;<span class="ident" id="5118812">WriteHeader</span><span class="op" id="5118823">(</span><span class="ident" id="5118824">code</span>&nbsp;<span class="builtintype" id="5118829">int</span><span class="op" id="5118832">)</span>&nbsp;<span class="op" id="5118834">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118837">if</span>&nbsp;<span class="ident" id="5118840">r</span><span class="op" id="5118841">.</span><span class="ident" id="5118842">wroteHeader</span>&nbsp;<span class="op" id="5118854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118858">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118869">r</span><span class="op" id="5118870">.</span><span class="ident" id="5118871">wroteHeader</span>&nbsp;<span class="op" id="5118883">=</span>&nbsp;<span class="ident" id="5118885">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118891">if</span>&nbsp;<span class="ident" id="5118894">code</span>&nbsp;<span class="op" id="5118899">==</span>&nbsp;<span class="ident" id="5118902">http</span><span class="op" id="5118906">.</span><span class="ident" id="5118907">StatusNotModified</span>&nbsp;<span class="op" id="5118925">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5118929">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118954">r</span><span class="op" id="5118955">.</span><span class="ident" id="5118956">header</span><span class="op" id="5118962">.</span><span class="ident" id="5118963">Del</span><span class="op" id="5118966">(</span><span class="string" id="5118967">&#34;Content-Type&#34;</span><span class="op" id="5118981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118985">r</span><span class="op" id="5118986">.</span><span class="ident" id="5118987">header</span><span class="op" id="5118993">.</span><span class="ident" id="5118994">Del</span><span class="op" id="5118997">(</span><span class="string" id="5118998">&#34;Content-Length&#34;</span><span class="op" id="5119014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119018">r</span><span class="op" id="5119019">.</span><span class="ident" id="5119020">header</span><span class="op" id="5119026">.</span><span class="ident" id="5119027">Del</span><span class="op" id="5119030">(</span><span class="string" id="5119031">&#34;Transfer-Encoding&#34;</span><span class="op" id="5119050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119053">}</span>&nbsp;<span class="keyword" id="5119055">else</span>&nbsp;<span class="keyword" id="5119060">if</span>&nbsp;<span class="ident" id="5119063">r</span><span class="op" id="5119064">.</span><span class="ident" id="5119065">header</span><span class="op" id="5119071">.</span><span class="ident" id="5119072">Get</span><span class="op" id="5119075">(</span><span class="string" id="5119076">&#34;Content-Type&#34;</span><span class="op" id="5119090">)</span>&nbsp;<span class="op" id="5119092">==</span>&nbsp;<span class="string" id="5119095">&#34;&#34;</span>&nbsp;<span class="op" id="5119098">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119102">r</span><span class="op" id="5119103">.</span><span class="ident" id="5119104">header</span><span class="op" id="5119110">.</span><span class="ident" id="5119111">Set</span><span class="op" id="5119114">(</span><span class="string" id="5119115">&#34;Content-Type&#34;</span><span class="op" id="5119129">,</span>&nbsp;<span class="string" id="5119131">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5119157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119164">if</span>&nbsp;<span class="ident" id="5119167">r</span><span class="op" id="5119168">.</span><span class="ident" id="5119169">header</span><span class="op" id="5119175">.</span><span class="ident" id="5119176">Get</span><span class="op" id="5119179">(</span><span class="string" id="5119180">&#34;Date&#34;</span><span class="op" id="5119186">)</span>&nbsp;<span class="op" id="5119188">==</span>&nbsp;<span class="string" id="5119191">&#34;&#34;</span>&nbsp;<span class="op" id="5119194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119198">r</span><span class="op" id="5119199">.</span><span class="ident" id="5119200">header</span><span class="op" id="5119206">.</span><span class="ident" id="5119207">Set</span><span class="op" id="5119210">(</span><span class="string" id="5119211">&#34;Date&#34;</span><span class="op" id="5119217">,</span>&nbsp;<span class="ident" id="5119219">time</span><span class="op" id="5119223">.</span><span class="ident" id="5119224">Now</span><span class="op" id="5119227">(</span><span class="op" id="5119228">)</span><span class="op" id="5119229">.</span><span class="ident" id="5119230">UTC</span><span class="op" id="5119233">(</span><span class="op" id="5119234">)</span><span class="op" id="5119235">.</span><span class="ident" id="5119236">Format</span><span class="op" id="5119242">(</span><span class="ident" id="5119243">http</span><span class="op" id="5119247">.</span><span class="ident" id="5119248">TimeFormat</span><span class="op" id="5119258">)</span><span class="op" id="5119259">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119266">fmt</span><span class="op" id="5119269">.</span><span class="ident" id="5119270">Fprintf</span><span class="op" id="5119277">(</span><span class="ident" id="5119278">r</span><span class="op" id="5119279">.</span><span class="ident" id="5119280">w</span><span class="op" id="5119281">,</span>&nbsp;<span class="string" id="5119283">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5119302">,</span>&nbsp;<span class="ident" id="5119304">code</span><span class="op" id="5119308">,</span>&nbsp;<span class="ident" id="5119310">http</span><span class="op" id="5119314">.</span><span class="ident" id="5119315">StatusText</span><span class="op" id="5119325">(</span><span class="ident" id="5119326">code</span><span class="op" id="5119330">)</span><span class="op" id="5119331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119334">r</span><span class="op" id="5119335">.</span><span class="ident" id="5119336">header</span><span class="op" id="5119342">.</span><span class="ident" id="5119343">Write</span><span class="op" id="5119348">(</span><span class="ident" id="5119349">r</span><span class="op" id="5119350">.</span><span class="ident" id="5119351">w</span><span class="op" id="5119352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119355">r</span><span class="op" id="5119356">.</span><span class="ident" id="5119357">w</span><span class="op" id="5119358">.</span><span class="ident" id="5119359">WriteString</span><span class="op" id="5119370">(</span><span class="string" id="5119371">&#34;\r\n&#34;</span><span class="op" id="5119377">)</span><br>
<span class="lineno">115</span><span class="op" id="5119379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5119382">func</span>&nbsp;<span class="op" id="5119387">(</span><span class="ident" id="5119388">r</span>&nbsp;<span class="op" id="5119390">*</span><span class="ident" id="5119391">response</span><span class="op" id="5119399">)</span>&nbsp;<span class="ident" id="5119401">Flush</span><span class="op" id="5119406">(</span><span class="op" id="5119407">)</span>&nbsp;<span class="op" id="5119409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119412">if</span>&nbsp;<span class="op" id="5119415">!</span><span class="ident" id="5119416">r</span><span class="op" id="5119417">.</span><span class="ident" id="5119418">wroteHeader</span>&nbsp;<span class="op" id="5119430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119434">r</span><span class="op" id="5119435">.</span><span class="ident" id="5119436">WriteHeader</span><span class="op" id="5119447">(</span><span class="ident" id="5119448">http</span><span class="op" id="5119452">.</span><span class="ident" id="5119453">StatusOK</span><span class="op" id="5119461">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119467">r</span><span class="op" id="5119468">.</span><span class="ident" id="5119469">w</span><span class="op" id="5119470">.</span><span class="ident" id="5119471">Flush</span><span class="op" id="5119476">(</span><span class="op" id="5119477">)</span><br>
<span class="lineno"></span><span class="op" id="5119479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5119482">func</span>&nbsp;<span class="op" id="5119487">(</span><span class="ident" id="5119488">r</span>&nbsp;<span class="op" id="5119490">*</span><span class="ident" id="5119491">response</span><span class="op" id="5119499">)</span>&nbsp;<span class="ident" id="5119501">Close</span><span class="op" id="5119506">(</span><span class="op" id="5119507">)</span>&nbsp;<span class="builtintype" id="5119509">error</span>&nbsp;<span class="op" id="5119515">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119518">r</span><span class="op" id="5119519">.</span><span class="ident" id="5119520">Flush</span><span class="op" id="5119525">(</span><span class="op" id="5119526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119529">return</span>&nbsp;<span class="ident" id="5119536">r</span><span class="op" id="5119537">.</span><span class="ident" id="5119538">w</span><span class="op" id="5119539">.</span><span class="ident" id="5119540">Close</span><span class="op" id="5119545">(</span><span class="op" id="5119546">)</span><br>
<span class="lineno"></span><span class="op" id="5119548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5119551">type</span>&nbsp;<span class="ident" id="5119556">child</span>&nbsp;<span class="keyword" id="5119562">struct</span>&nbsp;<span class="op" id="5119569">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119572">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5119580">*</span><span class="ident" id="5119581">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119587">handler</span>&nbsp;<span class="ident" id="5119595">http</span><span class="op" id="5119599">.</span><span class="ident" id="5119600">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119610">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5119619">sync</span><span class="op" id="5119623">.</span><span class="ident" id="5119624">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5119639">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119662">requests</span>&nbsp;<span class="keyword" id="5119671">map</span><span class="op" id="5119674">[</span><span class="builtintype" id="5119675">uint16</span><span class="op" id="5119681">]</span><span class="op" id="5119682">*</span><span class="ident" id="5119683">request</span>&nbsp;<span class="comment" id="5119691">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="5119714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5119717">func</span>&nbsp;<span class="ident" id="5119722">newChild</span><span class="op" id="5119730">(</span><span class="ident" id="5119731">rwc</span>&nbsp;<span class="ident" id="5119735">io</span><span class="op" id="5119737">.</span><span class="ident" id="5119738">ReadWriteCloser</span><span class="op" id="5119753">,</span>&nbsp;<span class="ident" id="5119755">handler</span>&nbsp;<span class="ident" id="5119763">http</span><span class="op" id="5119767">.</span><span class="ident" id="5119768">Handler</span><span class="op" id="5119775">)</span>&nbsp;<span class="op" id="5119777">*</span><span class="ident" id="5119778">child</span>&nbsp;<span class="op" id="5119784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119787">return</span>&nbsp;<span class="op" id="5119794">&amp;</span><span class="ident" id="5119795">child</span><span class="op" id="5119800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119804">conn</span><span class="op" id="5119808">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5119814">newConn</span><span class="op" id="5119821">(</span><span class="ident" id="5119822">rwc</span><span class="op" id="5119825">)</span><span class="op" id="5119826">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119830">handler</span><span class="op" id="5119837">:</span>&nbsp;&nbsp;<span class="ident" id="5119840">handler</span><span class="op" id="5119847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119851">requests</span><span class="op" id="5119859">:</span>&nbsp;<span class="builtinfunc" id="5119861">make</span><span class="op" id="5119865">(</span><span class="keyword" id="5119866">map</span><span class="op" id="5119869">[</span><span class="builtintype" id="5119870">uint16</span><span class="op" id="5119876">]</span><span class="op" id="5119877">*</span><span class="ident" id="5119878">request</span><span class="op" id="5119885">)</span><span class="op" id="5119886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119889">}</span><br>
<span class="lineno"></span><span class="op" id="5119891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5119894">func</span>&nbsp;<span class="op" id="5119899">(</span><span class="ident" id="5119900">c</span>&nbsp;<span class="op" id="5119902">*</span><span class="ident" id="5119903">child</span><span class="op" id="5119908">)</span>&nbsp;<span class="ident" id="5119910">serve</span><span class="op" id="5119915">(</span><span class="op" id="5119916">)</span>&nbsp;<span class="op" id="5119918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119921">defer</span>&nbsp;<span class="ident" id="5119927">c</span><span class="op" id="5119928">.</span><span class="ident" id="5119929">conn</span><span class="op" id="5119933">.</span><span class="ident" id="5119934">Close</span><span class="op" id="5119939">(</span><span class="op" id="5119940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119943">var</span>&nbsp;<span class="ident" id="5119947">rec</span>&nbsp;<span class="ident" id="5119951">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119959">for</span>&nbsp;<span class="op" id="5119963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119967">if</span>&nbsp;<span class="ident" id="5119970">err</span>&nbsp;<span class="op" id="5119974">:=</span>&nbsp;<span class="ident" id="5119977">rec</span><span class="op" id="5119980">.</span><span class="ident" id="5119981">read</span><span class="op" id="5119985">(</span><span class="ident" id="5119986">c</span><span class="op" id="5119987">.</span><span class="ident" id="5119988">conn</span><span class="op" id="5119992">.</span><span class="ident" id="5119993">rwc</span><span class="op" id="5119996">)</span><span class="op" id="5119997">;</span>&nbsp;<span class="ident" id="5119999">err</span>&nbsp;<span class="op" id="5120003">!=</span>&nbsp;<span class="ident" id="5120006">nil</span>&nbsp;<span class="op" id="5120010">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120015">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120028">if</span>&nbsp;<span class="ident" id="5120031">err</span>&nbsp;<span class="op" id="5120035">:=</span>&nbsp;<span class="ident" id="5120038">c</span><span class="op" id="5120039">.</span><span class="ident" id="5120040">handleRecord</span><span class="op" id="5120052">(</span><span class="op" id="5120053">&amp;</span><span class="ident" id="5120054">rec</span><span class="op" id="5120057">)</span><span class="op" id="5120058">;</span>&nbsp;<span class="ident" id="5120060">err</span>&nbsp;<span class="op" id="5120064">!=</span>&nbsp;<span class="ident" id="5120067">nil</span>&nbsp;<span class="op" id="5120071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120076">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120085">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120088">}</span><br>
<span class="lineno"></span><span class="op" id="5120090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5120093">var</span>&nbsp;<span class="ident" id="5120097">errCloseConn</span>&nbsp;<span class="op" id="5120110">=</span>&nbsp;<span class="ident" id="5120112">errors</span><span class="op" id="5120118">.</span><span class="ident" id="5120119">New</span><span class="op" id="5120122">(</span><span class="string" id="5120123">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="5120158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="5120161">var</span>&nbsp;<span class="ident" id="5120165">emptyBody</span>&nbsp;<span class="op" id="5120175">=</span>&nbsp;<span class="ident" id="5120177">ioutil</span><span class="op" id="5120183">.</span><span class="ident" id="5120184">NopCloser</span><span class="op" id="5120193">(</span><span class="ident" id="5120194">strings</span><span class="op" id="5120201">.</span><span class="ident" id="5120202">NewReader</span><span class="op" id="5120211">(</span><span class="string" id="5120212">&#34;&#34;</span><span class="op" id="5120214">)</span><span class="op" id="5120215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5120218">func</span>&nbsp;<span class="op" id="5120223">(</span><span class="ident" id="5120224">c</span>&nbsp;<span class="op" id="5120226">*</span><span class="ident" id="5120227">child</span><span class="op" id="5120232">)</span>&nbsp;<span class="ident" id="5120234">handleRecord</span><span class="op" id="5120246">(</span><span class="ident" id="5120247">rec</span>&nbsp;<span class="op" id="5120251">*</span><span class="ident" id="5120252">record</span><span class="op" id="5120258">)</span>&nbsp;<span class="builtintype" id="5120260">error</span>&nbsp;<span class="op" id="5120266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120269">c</span><span class="op" id="5120270">.</span><span class="ident" id="5120271">mu</span><span class="op" id="5120273">.</span><span class="ident" id="5120274">Lock</span><span class="op" id="5120278">(</span><span class="op" id="5120279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120282">req</span><span class="op" id="5120285">,</span>&nbsp;<span class="ident" id="5120287">ok</span>&nbsp;<span class="op" id="5120290">:=</span>&nbsp;<span class="ident" id="5120293">c</span><span class="op" id="5120294">.</span><span class="ident" id="5120295">requests</span><span class="op" id="5120303">[</span><span class="ident" id="5120304">rec</span><span class="op" id="5120307">.</span><span class="ident" id="5120308">h</span><span class="op" id="5120309">.</span><span class="ident" id="5120310">Id</span><span class="op" id="5120312">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120315">c</span><span class="op" id="5120316">.</span><span class="ident" id="5120317">mu</span><span class="op" id="5120319">.</span><span class="ident" id="5120320">Unlock</span><span class="op" id="5120326">(</span><span class="op" id="5120327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120330">if</span>&nbsp;<span class="op" id="5120333">!</span><span class="ident" id="5120334">ok</span>&nbsp;<span class="op" id="5120337">&amp;&amp;</span>&nbsp;<span class="ident" id="5120340">rec</span><span class="op" id="5120343">.</span><span class="ident" id="5120344">h</span><span class="op" id="5120345">.</span><span class="ident" id="5120346">Type</span>&nbsp;<span class="op" id="5120351">!=</span>&nbsp;<span class="ident" id="5120354">typeBeginRequest</span>&nbsp;<span class="op" id="5120371">&amp;&amp;</span>&nbsp;<span class="ident" id="5120374">rec</span><span class="op" id="5120377">.</span><span class="ident" id="5120378">h</span><span class="op" id="5120379">.</span><span class="ident" id="5120380">Type</span>&nbsp;<span class="op" id="5120385">!=</span>&nbsp;<span class="ident" id="5120388">typeGetValues</span>&nbsp;<span class="op" id="5120402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5120406">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120456">return</span>&nbsp;<span class="ident" id="5120463">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120468">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120472">switch</span>&nbsp;<span class="ident" id="5120479">rec</span><span class="op" id="5120482">.</span><span class="ident" id="5120483">h</span><span class="op" id="5120484">.</span><span class="ident" id="5120485">Type</span>&nbsp;<span class="op" id="5120490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120493">case</span>&nbsp;<span class="ident" id="5120498">typeBeginRequest</span><span class="op" id="5120514">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120518">if</span>&nbsp;<span class="ident" id="5120521">req</span>&nbsp;<span class="op" id="5120525">!=</span>&nbsp;<span class="ident" id="5120528">nil</span>&nbsp;<span class="op" id="5120532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5120537">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5120600">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120651">return</span>&nbsp;<span class="ident" id="5120658">errors</span><span class="op" id="5120664">.</span><span class="ident" id="5120665">New</span><span class="op" id="5120668">(</span><span class="string" id="5120669">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="5120714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120723">var</span>&nbsp;<span class="ident" id="5120727">br</span>&nbsp;<span class="ident" id="5120730">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120745">if</span>&nbsp;<span class="ident" id="5120748">err</span>&nbsp;<span class="op" id="5120752">:=</span>&nbsp;<span class="ident" id="5120755">br</span><span class="op" id="5120757">.</span><span class="ident" id="5120758">read</span><span class="op" id="5120762">(</span><span class="ident" id="5120763">rec</span><span class="op" id="5120766">.</span><span class="ident" id="5120767">content</span><span class="op" id="5120774">(</span><span class="op" id="5120775">)</span><span class="op" id="5120776">)</span><span class="op" id="5120777">;</span>&nbsp;<span class="ident" id="5120779">err</span>&nbsp;<span class="op" id="5120783">!=</span>&nbsp;<span class="ident" id="5120786">nil</span>&nbsp;<span class="op" id="5120790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120795">return</span>&nbsp;<span class="ident" id="5120802">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120812">if</span>&nbsp;<span class="ident" id="5120815">br</span><span class="op" id="5120817">.</span><span class="ident" id="5120818">role</span>&nbsp;<span class="op" id="5120823">!=</span>&nbsp;<span class="ident" id="5120826">roleResponder</span>&nbsp;<span class="op" id="5120840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120845">c</span><span class="op" id="5120846">.</span><span class="ident" id="5120847">conn</span><span class="op" id="5120851">.</span><span class="ident" id="5120852">writeEndRequest</span><span class="op" id="5120867">(</span><span class="ident" id="5120868">rec</span><span class="op" id="5120871">.</span><span class="ident" id="5120872">h</span><span class="op" id="5120873">.</span><span class="ident" id="5120874">Id</span><span class="op" id="5120876">,</span>&nbsp;<span class="num" id="5120878">0</span><span class="op" id="5120879">,</span>&nbsp;<span class="ident" id="5120881">statusUnknownRole</span><span class="op" id="5120898">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120903">return</span>&nbsp;<span class="ident" id="5120910">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120920">req</span>&nbsp;<span class="op" id="5120924">=</span>&nbsp;<span class="ident" id="5120926">newRequest</span><span class="op" id="5120936">(</span><span class="ident" id="5120937">rec</span><span class="op" id="5120940">.</span><span class="ident" id="5120941">h</span><span class="op" id="5120942">.</span><span class="ident" id="5120943">Id</span><span class="op" id="5120945">,</span>&nbsp;<span class="ident" id="5120947">br</span><span class="op" id="5120949">.</span><span class="ident" id="5120950">flags</span><span class="op" id="5120955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120959">c</span><span class="op" id="5120960">.</span><span class="ident" id="5120961">mu</span><span class="op" id="5120963">.</span><span class="ident" id="5120964">Lock</span><span class="op" id="5120968">(</span><span class="op" id="5120969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120973">c</span><span class="op" id="5120974">.</span><span class="ident" id="5120975">requests</span><span class="op" id="5120983">[</span><span class="ident" id="5120984">rec</span><span class="op" id="5120987">.</span><span class="ident" id="5120988">h</span><span class="op" id="5120989">.</span><span class="ident" id="5120990">Id</span><span class="op" id="5120992">]</span>&nbsp;<span class="op" id="5120994">=</span>&nbsp;<span class="ident" id="5120996">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121002">c</span><span class="op" id="5121003">.</span><span class="ident" id="5121004">mu</span><span class="op" id="5121006">.</span><span class="ident" id="5121007">Unlock</span><span class="op" id="5121013">(</span><span class="op" id="5121014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121018">return</span>&nbsp;<span class="ident" id="5121025">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121030">case</span>&nbsp;<span class="ident" id="5121035">typeParams</span><span class="op" id="5121045">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121049">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121120">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121193">if</span>&nbsp;<span class="builtinfunc" id="5121196">len</span><span class="op" id="5121199">(</span><span class="ident" id="5121200">rec</span><span class="op" id="5121203">.</span><span class="ident" id="5121204">content</span><span class="op" id="5121211">(</span><span class="op" id="5121212">)</span><span class="op" id="5121213">)</span>&nbsp;<span class="op" id="5121215">&gt;</span>&nbsp;<span class="num" id="5121217">0</span>&nbsp;<span class="op" id="5121219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121224">req</span><span class="op" id="5121227">.</span><span class="ident" id="5121228">rawParams</span>&nbsp;<span class="op" id="5121238">=</span>&nbsp;<span class="builtinfunc" id="5121240">append</span><span class="op" id="5121246">(</span><span class="ident" id="5121247">req</span><span class="op" id="5121250">.</span><span class="ident" id="5121251">rawParams</span><span class="op" id="5121260">,</span>&nbsp;<span class="ident" id="5121262">rec</span><span class="op" id="5121265">.</span><span class="ident" id="5121266">content</span><span class="op" id="5121273">(</span><span class="op" id="5121274">)</span><span class="op" id="5121275">...</span><span class="op" id="5121278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121283">return</span>&nbsp;<span class="ident" id="5121290">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121300">req</span><span class="op" id="5121303">.</span><span class="ident" id="5121304">parseParams</span><span class="op" id="5121315">(</span><span class="op" id="5121316">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121320">return</span>&nbsp;<span class="ident" id="5121327">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121332">case</span>&nbsp;<span class="ident" id="5121337">typeStdin</span><span class="op" id="5121346">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121350">content</span>&nbsp;<span class="op" id="5121358">:=</span>&nbsp;<span class="ident" id="5121361">rec</span><span class="op" id="5121364">.</span><span class="ident" id="5121365">content</span><span class="op" id="5121372">(</span><span class="op" id="5121373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121377">if</span>&nbsp;<span class="ident" id="5121380">req</span><span class="op" id="5121383">.</span><span class="ident" id="5121384">pw</span>&nbsp;<span class="op" id="5121387">==</span>&nbsp;<span class="ident" id="5121390">nil</span>&nbsp;<span class="op" id="5121394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121399">var</span>&nbsp;<span class="ident" id="5121403">body</span>&nbsp;<span class="ident" id="5121408">io</span><span class="op" id="5121410">.</span><span class="ident" id="5121411">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121425">if</span>&nbsp;<span class="builtinfunc" id="5121428">len</span><span class="op" id="5121431">(</span><span class="ident" id="5121432">content</span><span class="op" id="5121439">)</span>&nbsp;<span class="op" id="5121441">&gt;</span>&nbsp;<span class="num" id="5121443">0</span>&nbsp;<span class="op" id="5121445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121451">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121515">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121558">body</span><span class="op" id="5121562">,</span>&nbsp;<span class="ident" id="5121564">req</span><span class="op" id="5121567">.</span><span class="ident" id="5121568">pw</span>&nbsp;<span class="op" id="5121571">=</span>&nbsp;<span class="ident" id="5121573">io</span><span class="op" id="5121575">.</span><span class="ident" id="5121576">Pipe</span><span class="op" id="5121580">(</span><span class="op" id="5121581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121586">}</span>&nbsp;<span class="keyword" id="5121588">else</span>&nbsp;<span class="op" id="5121593">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121599">body</span>&nbsp;<span class="op" id="5121604">=</span>&nbsp;<span class="ident" id="5121606">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121624">go</span>&nbsp;<span class="ident" id="5121627">c</span><span class="op" id="5121628">.</span><span class="ident" id="5121629">serveRequest</span><span class="op" id="5121641">(</span><span class="ident" id="5121642">req</span><span class="op" id="5121645">,</span>&nbsp;<span class="ident" id="5121647">body</span><span class="op" id="5121651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121659">if</span>&nbsp;<span class="builtinfunc" id="5121662">len</span><span class="op" id="5121665">(</span><span class="ident" id="5121666">content</span><span class="op" id="5121673">)</span>&nbsp;<span class="op" id="5121675">&gt;</span>&nbsp;<span class="num" id="5121677">0</span>&nbsp;<span class="op" id="5121679">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121684">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121752">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121815">req</span><span class="op" id="5121818">.</span><span class="ident" id="5121819">pw</span><span class="op" id="5121821">.</span><span class="ident" id="5121822">Write</span><span class="op" id="5121827">(</span><span class="ident" id="5121828">content</span><span class="op" id="5121835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121839">}</span>&nbsp;<span class="keyword" id="5121841">else</span>&nbsp;<span class="keyword" id="5121846">if</span>&nbsp;<span class="ident" id="5121849">req</span><span class="op" id="5121852">.</span><span class="ident" id="5121853">pw</span>&nbsp;<span class="op" id="5121856">!=</span>&nbsp;<span class="ident" id="5121859">nil</span>&nbsp;<span class="op" id="5121863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121868">req</span><span class="op" id="5121871">.</span><span class="ident" id="5121872">pw</span><span class="op" id="5121874">.</span><span class="ident" id="5121875">Close</span><span class="op" id="5121880">(</span><span class="op" id="5121881">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121889">return</span>&nbsp;<span class="ident" id="5121896">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121901">case</span>&nbsp;<span class="ident" id="5121906">typeGetValues</span><span class="op" id="5121919">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121923">values</span>&nbsp;<span class="op" id="5121930">:=</span>&nbsp;<span class="keyword" id="5121933">map</span><span class="op" id="5121936">[</span><span class="builtintype" id="5121937">string</span><span class="op" id="5121943">]</span><span class="builtintype" id="5121944">string</span><span class="op" id="5121950">{</span><span class="string" id="5121951">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="5121968">:</span>&nbsp;<span class="string" id="5121970">&#34;1&#34;</span><span class="op" id="5121973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121977">c</span><span class="op" id="5121978">.</span><span class="ident" id="5121979">conn</span><span class="op" id="5121983">.</span><span class="ident" id="5121984">writePairs</span><span class="op" id="5121994">(</span><span class="ident" id="5121995">typeGetValuesResult</span><span class="op" id="5122014">,</span>&nbsp;<span class="num" id="5122016">0</span><span class="op" id="5122017">,</span>&nbsp;<span class="ident" id="5122019">values</span><span class="op" id="5122025">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122029">return</span>&nbsp;<span class="ident" id="5122036">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122041">case</span>&nbsp;<span class="ident" id="5122046">typeData</span><span class="op" id="5122054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5122058">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122125">return</span>&nbsp;<span class="ident" id="5122132">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122137">case</span>&nbsp;<span class="ident" id="5122142">typeAbortRequest</span><span class="op" id="5122158">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5122162">println</span><span class="op" id="5122169">(</span><span class="string" id="5122170">&#34;abort&#34;</span><span class="op" id="5122177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122181">c</span><span class="op" id="5122182">.</span><span class="ident" id="5122183">mu</span><span class="op" id="5122185">.</span><span class="ident" id="5122186">Lock</span><span class="op" id="5122190">(</span><span class="op" id="5122191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5122195">delete</span><span class="op" id="5122201">(</span><span class="ident" id="5122202">c</span><span class="op" id="5122203">.</span><span class="ident" id="5122204">requests</span><span class="op" id="5122212">,</span>&nbsp;<span class="ident" id="5122214">rec</span><span class="op" id="5122217">.</span><span class="ident" id="5122218">h</span><span class="op" id="5122219">.</span><span class="ident" id="5122220">Id</span><span class="op" id="5122222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122226">c</span><span class="op" id="5122227">.</span><span class="ident" id="5122228">mu</span><span class="op" id="5122230">.</span><span class="ident" id="5122231">Unlock</span><span class="op" id="5122237">(</span><span class="op" id="5122238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122242">c</span><span class="op" id="5122243">.</span><span class="ident" id="5122244">conn</span><span class="op" id="5122248">.</span><span class="ident" id="5122249">writeEndRequest</span><span class="op" id="5122264">(</span><span class="ident" id="5122265">rec</span><span class="op" id="5122268">.</span><span class="ident" id="5122269">h</span><span class="op" id="5122270">.</span><span class="ident" id="5122271">Id</span><span class="op" id="5122273">,</span>&nbsp;<span class="num" id="5122275">0</span><span class="op" id="5122276">,</span>&nbsp;<span class="ident" id="5122278">statusRequestComplete</span><span class="op" id="5122299">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122303">if</span>&nbsp;<span class="op" id="5122306">!</span><span class="ident" id="5122307">req</span><span class="op" id="5122310">.</span><span class="ident" id="5122311">keepConn</span>&nbsp;<span class="op" id="5122320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5122325">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122365">return</span>&nbsp;<span class="ident" id="5122372">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5122387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122391">return</span>&nbsp;<span class="ident" id="5122398">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122403">default</span><span class="op" id="5122410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122414">b</span>&nbsp;<span class="op" id="5122416">:=</span>&nbsp;<span class="builtinfunc" id="5122419">make</span><span class="op" id="5122423">(</span><span class="op" id="5122424">[</span><span class="op" id="5122425">]</span><span class="builtintype" id="5122426">byte</span><span class="op" id="5122430">,</span>&nbsp;<span class="num" id="5122432">8</span><span class="op" id="5122433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122437">b</span><span class="op" id="5122438">[</span><span class="num" id="5122439">0</span><span class="op" id="5122440">]</span>&nbsp;<span class="op" id="5122442">=</span>&nbsp;<span class="builtintype" id="5122444">byte</span><span class="op" id="5122448">(</span><span class="ident" id="5122449">rec</span><span class="op" id="5122452">.</span><span class="ident" id="5122453">h</span><span class="op" id="5122454">.</span><span class="ident" id="5122455">Type</span><span class="op" id="5122459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122463">c</span><span class="op" id="5122464">.</span><span class="ident" id="5122465">conn</span><span class="op" id="5122469">.</span><span class="ident" id="5122470">writeRecord</span><span class="op" id="5122481">(</span><span class="ident" id="5122482">typeUnknownType</span><span class="op" id="5122497">,</span>&nbsp;<span class="num" id="5122499">0</span><span class="op" id="5122500">,</span>&nbsp;<span class="ident" id="5122502">b</span><span class="op" id="5122503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122507">return</span>&nbsp;<span class="ident" id="5122514">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5122519">}</span><br>
<span class="lineno"></span><span class="op" id="5122521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5122524">func</span>&nbsp;<span class="op" id="5122529">(</span><span class="ident" id="5122530">c</span>&nbsp;<span class="op" id="5122532">*</span><span class="ident" id="5122533">child</span><span class="op" id="5122538">)</span>&nbsp;<span class="ident" id="5122540">serveRequest</span><span class="op" id="5122552">(</span><span class="ident" id="5122553">req</span>&nbsp;<span class="op" id="5122557">*</span><span class="ident" id="5122558">request</span><span class="op" id="5122565">,</span>&nbsp;<span class="ident" id="5122567">body</span>&nbsp;<span class="ident" id="5122572">io</span><span class="op" id="5122574">.</span><span class="ident" id="5122575">ReadCloser</span><span class="op" id="5122585">)</span>&nbsp;<span class="op" id="5122587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122590">r</span>&nbsp;<span class="op" id="5122592">:=</span>&nbsp;<span class="ident" id="5122595">newResponse</span><span class="op" id="5122606">(</span><span class="ident" id="5122607">c</span><span class="op" id="5122608">,</span>&nbsp;<span class="ident" id="5122610">req</span><span class="op" id="5122613">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122616">httpReq</span><span class="op" id="5122623">,</span>&nbsp;<span class="ident" id="5122625">err</span>&nbsp;<span class="op" id="5122629">:=</span>&nbsp;<span class="ident" id="5122632">cgi</span><span class="op" id="5122635">.</span><span class="ident" id="5122636">RequestFromMap</span><span class="op" id="5122650">(</span><span class="ident" id="5122651">req</span><span class="op" id="5122654">.</span><span class="ident" id="5122655">params</span><span class="op" id="5122661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5122664">if</span>&nbsp;<span class="ident" id="5122667">err</span>&nbsp;<span class="op" id="5122671">!=</span>&nbsp;<span class="ident" id="5122674">nil</span>&nbsp;<span class="op" id="5122678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5122682">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122726">r</span><span class="op" id="5122727">.</span><span class="ident" id="5122728">WriteHeader</span><span class="op" id="5122739">(</span><span class="ident" id="5122740">http</span><span class="op" id="5122744">.</span><span class="ident" id="5122745">StatusInternalServerError</span><span class="op" id="5122770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122774">c</span><span class="op" id="5122775">.</span><span class="ident" id="5122776">conn</span><span class="op" id="5122780">.</span><span class="ident" id="5122781">writeRecord</span><span class="op" id="5122792">(</span><span class="ident" id="5122793">typeStderr</span><span class="op" id="5122803">,</span>&nbsp;<span class="ident" id="5122805">req</span><span class="op" id="5122808">.</span><span class="ident" id="5122809">reqId</span><span class="op" id="5122814">,</span>&nbsp;<span class="op" id="5122816">[</span><span class="op" id="5122817">]</span><span class="builtintype" id="5122818">byte</span><span class="op" id="5122822">(</span><span class="ident" id="5122823">err</span><span class="op" id="5122826">.</span><span class="ident" id="5122827">Error</span><span class="op" id="5122832">(</span><span class="op" id="5122833">)</span><span class="op" id="5122834">)</span><span class="op" id="5122835">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5122838">}</span>&nbsp;<span class="keyword" id="5122840">else</span>&nbsp;<span class="op" id="5122845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122849">httpReq</span><span class="op" id="5122856">.</span><span class="ident" id="5122857">Body</span>&nbsp;<span class="op" id="5122862">=</span>&nbsp;<span class="ident" id="5122864">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122871">c</span><span class="op" id="5122872">.</span><span class="ident" id="5122873">handler</span><span class="op" id="5122880">.</span><span class="ident" id="5122881">ServeHTTP</span><span class="op" id="5122890">(</span><span class="ident" id="5122891">r</span><span class="op" id="5122892">,</span>&nbsp;<span class="ident" id="5122894">httpReq</span><span class="op" id="5122901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5122904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122907">r</span><span class="op" id="5122908">.</span><span class="ident" id="5122909">Close</span><span class="op" id="5122914">(</span><span class="op" id="5122915">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122918">c</span><span class="op" id="5122919">.</span><span class="ident" id="5122920">mu</span><span class="op" id="5122922">.</span><span class="ident" id="5122923">Lock</span><span class="op" id="5122927">(</span><span class="op" id="5122928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5122931">delete</span><span class="op" id="5122937">(</span><span class="ident" id="5122938">c</span><span class="op" id="5122939">.</span><span class="ident" id="5122940">requests</span><span class="op" id="5122948">,</span>&nbsp;<span class="ident" id="5122950">req</span><span class="op" id="5122953">.</span><span class="ident" id="5122954">reqId</span><span class="op" id="5122959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122962">c</span><span class="op" id="5122963">.</span><span class="ident" id="5122964">mu</span><span class="op" id="5122966">.</span><span class="ident" id="5122967">Unlock</span><span class="op" id="5122973">(</span><span class="op" id="5122974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5122977">c</span><span class="op" id="5122978">.</span><span class="ident" id="5122979">conn</span><span class="op" id="5122983">.</span><span class="ident" id="5122984">writeEndRequest</span><span class="op" id="5122999">(</span><span class="ident" id="5123000">req</span><span class="op" id="5123003">.</span><span class="ident" id="5123004">reqId</span><span class="op" id="5123009">,</span>&nbsp;<span class="num" id="5123011">0</span><span class="op" id="5123012">,</span>&nbsp;<span class="ident" id="5123014">statusRequestComplete</span><span class="op" id="5123035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123039">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123103">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123164">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123219">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123277">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123333">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5123391">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5123430">io</span><span class="op" id="5123432">.</span><span class="ident" id="5123433">CopyN</span><span class="op" id="5123438">(</span><span class="ident" id="5123439">ioutil</span><span class="op" id="5123445">.</span><span class="ident" id="5123446">Discard</span><span class="op" id="5123453">,</span>&nbsp;<span class="ident" id="5123455">body</span><span class="op" id="5123459">,</span>&nbsp;<span class="num" id="5123461">100</span><span class="op" id="5123464">&lt;&lt;</span><span class="num" id="5123466">20</span><span class="op" id="5123468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5123471">body</span><span class="op" id="5123475">.</span><span class="ident" id="5123476">Close</span><span class="op" id="5123481">(</span><span class="op" id="5123482">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123486">if</span>&nbsp;<span class="op" id="5123489">!</span><span class="ident" id="5123490">req</span><span class="op" id="5123493">.</span><span class="ident" id="5123494">keepConn</span>&nbsp;<span class="op" id="5123503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5123507">c</span><span class="op" id="5123508">.</span><span class="ident" id="5123509">conn</span><span class="op" id="5123513">.</span><span class="ident" id="5123514">Close</span><span class="op" id="5123519">(</span><span class="op" id="5123520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5123523">}</span><br>
<span class="lineno"></span><span class="op" id="5123525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="5123528">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="5123608">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5123683">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="5123704">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="5123761">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="5123813">func</span>&nbsp;<span class="ident" id="5123818">Serve</span><span class="op" id="5123823">(</span><span class="ident" id="5123824">l</span>&nbsp;<span class="ident" id="5123826">net</span><span class="op" id="5123829">.</span><span class="ident" id="5123830">Listener</span><span class="op" id="5123838">,</span>&nbsp;<span class="ident" id="5123840">handler</span>&nbsp;<span class="ident" id="5123848">http</span><span class="op" id="5123852">.</span><span class="ident" id="5123853">Handler</span><span class="op" id="5123860">)</span>&nbsp;<span class="builtintype" id="5123862">error</span>&nbsp;<span class="op" id="5123868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123871">if</span>&nbsp;<span class="ident" id="5123874">l</span>&nbsp;<span class="op" id="5123876">==</span>&nbsp;<span class="ident" id="5123879">nil</span>&nbsp;<span class="op" id="5123883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123887">var</span>&nbsp;<span class="ident" id="5123891">err</span>&nbsp;<span class="builtintype" id="5123895">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5123903">l</span><span class="op" id="5123904">,</span>&nbsp;<span class="ident" id="5123906">err</span>&nbsp;<span class="op" id="5123910">=</span>&nbsp;<span class="ident" id="5123912">net</span><span class="op" id="5123915">.</span><span class="ident" id="5123916">FileListener</span><span class="op" id="5123928">(</span><span class="ident" id="5123929">os</span><span class="op" id="5123931">.</span><span class="ident" id="5123932">Stdin</span><span class="op" id="5123937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123941">if</span>&nbsp;<span class="ident" id="5123944">err</span>&nbsp;<span class="op" id="5123948">!=</span>&nbsp;<span class="ident" id="5123951">nil</span>&nbsp;<span class="op" id="5123955">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123960">return</span>&nbsp;<span class="ident" id="5123967">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5123973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123977">defer</span>&nbsp;<span class="ident" id="5123983">l</span><span class="op" id="5123984">.</span><span class="ident" id="5123985">Close</span><span class="op" id="5123990">(</span><span class="op" id="5123991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5123994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123997">if</span>&nbsp;<span class="ident" id="5124000">handler</span>&nbsp;<span class="op" id="5124008">==</span>&nbsp;<span class="ident" id="5124011">nil</span>&nbsp;<span class="op" id="5124015">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124019">handler</span>&nbsp;<span class="op" id="5124027">=</span>&nbsp;<span class="ident" id="5124029">http</span><span class="op" id="5124033">.</span><span class="ident" id="5124034">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124054">for</span>&nbsp;<span class="op" id="5124058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124062">rw</span><span class="op" id="5124064">,</span>&nbsp;<span class="ident" id="5124066">err</span>&nbsp;<span class="op" id="5124070">:=</span>&nbsp;<span class="ident" id="5124073">l</span><span class="op" id="5124074">.</span><span class="ident" id="5124075">Accept</span><span class="op" id="5124081">(</span><span class="op" id="5124082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124086">if</span>&nbsp;<span class="ident" id="5124089">err</span>&nbsp;<span class="op" id="5124093">!=</span>&nbsp;<span class="ident" id="5124096">nil</span>&nbsp;<span class="op" id="5124100">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124105">return</span>&nbsp;<span class="ident" id="5124112">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124122">c</span>&nbsp;<span class="op" id="5124124">:=</span>&nbsp;<span class="ident" id="5124127">newChild</span><span class="op" id="5124135">(</span><span class="ident" id="5124136">rw</span><span class="op" id="5124138">,</span>&nbsp;<span class="ident" id="5124140">handler</span><span class="op" id="5124147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124151">go</span>&nbsp;<span class="ident" id="5124154">c</span><span class="op" id="5124155">.</span><span class="ident" id="5124156">serve</span><span class="op" id="5124161">(</span><span class="op" id="5124162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124165">}</span><br>
<span class="lineno">305</span><span class="op" id="5124167">}</span>
</div>
</body>
</html>
