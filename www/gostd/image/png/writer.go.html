<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5961745">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5961800">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5961854">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5961905">package</span>&nbsp;<span class="ident" id="5961913">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5961918">import</span>&nbsp;<span class="op" id="5961925">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961928">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961937">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961954">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961968">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961977">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961992">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5961998">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5962008">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5962011">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5962054">type</span>&nbsp;<span class="ident" id="5962059">Encoder</span>&nbsp;<span class="keyword" id="5962067">struct</span>&nbsp;<span class="op" id="5962074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962077">CompressionLevel</span>&nbsp;<span class="ident" id="5962094">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5962111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5962114">type</span>&nbsp;<span class="ident" id="5962119">encoder</span>&nbsp;<span class="keyword" id="5962127">struct</span>&nbsp;<span class="op" id="5962134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962137">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5962144">*</span><span class="ident" id="5962145">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962154">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962161">io</span><span class="op" id="5962163">.</span><span class="ident" id="5962164">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962172">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962179">image</span><span class="op" id="5962184">.</span><span class="ident" id="5962185">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962192">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5962199">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962204">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5962211">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962218">header</span>&nbsp;<span class="op" id="5962225">[</span><span class="num" id="5962226">8</span><span class="op" id="5962227">]</span><span class="builtintype" id="5962228">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962234">footer</span>&nbsp;<span class="op" id="5962241">[</span><span class="num" id="5962242">4</span><span class="op" id="5962243">]</span><span class="builtintype" id="5962244">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962250">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5962257">[</span><span class="num" id="5962258">4</span>&nbsp;<span class="op" id="5962260">*</span>&nbsp;<span class="num" id="5962262">256</span><span class="op" id="5962265">]</span><span class="builtintype" id="5962266">byte</span><br>
<span class="lineno"></span><span class="op" id="5962271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5962274">type</span>&nbsp;<span class="ident" id="5962279">CompressionLevel</span>&nbsp;<span class="builtintype" id="5962296">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5962301">const</span>&nbsp;<span class="op" id="5962307">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962310">DefaultCompression</span>&nbsp;<span class="ident" id="5962329">CompressionLevel</span>&nbsp;<span class="op" id="5962346">=</span>&nbsp;<span class="num" id="5962348">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962351">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962370">CompressionLevel</span>&nbsp;<span class="op" id="5962387">=</span>&nbsp;<span class="op" id="5962389">-</span><span class="num" id="5962390">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962393">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962412">CompressionLevel</span>&nbsp;<span class="op" id="5962429">=</span>&nbsp;<span class="op" id="5962431">-</span><span class="num" id="5962432">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962435">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962454">CompressionLevel</span>&nbsp;<span class="op" id="5962471">=</span>&nbsp;<span class="op" id="5962473">-</span><span class="num" id="5962474">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5962478">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5962551">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5962611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5962614">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5962629">func</span>&nbsp;<span class="ident" id="5962634">writeUint32</span><span class="op" id="5962645">(</span><span class="ident" id="5962646">b</span>&nbsp;<span class="op" id="5962648">[</span><span class="op" id="5962649">]</span><span class="builtintype" id="5962650">uint8</span><span class="op" id="5962655">,</span>&nbsp;<span class="ident" id="5962657">u</span>&nbsp;<span class="builtintype" id="5962659">uint32</span><span class="op" id="5962665">)</span>&nbsp;<span class="op" id="5962667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962670">b</span><span class="op" id="5962671">[</span><span class="num" id="5962672">0</span><span class="op" id="5962673">]</span>&nbsp;<span class="op" id="5962675">=</span>&nbsp;<span class="builtintype" id="5962677">uint8</span><span class="op" id="5962682">(</span><span class="ident" id="5962683">u</span>&nbsp;<span class="op" id="5962685">&gt;&gt;</span>&nbsp;<span class="num" id="5962688">24</span><span class="op" id="5962690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962693">b</span><span class="op" id="5962694">[</span><span class="num" id="5962695">1</span><span class="op" id="5962696">]</span>&nbsp;<span class="op" id="5962698">=</span>&nbsp;<span class="builtintype" id="5962700">uint8</span><span class="op" id="5962705">(</span><span class="ident" id="5962706">u</span>&nbsp;<span class="op" id="5962708">&gt;&gt;</span>&nbsp;<span class="num" id="5962711">16</span><span class="op" id="5962713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962716">b</span><span class="op" id="5962717">[</span><span class="num" id="5962718">2</span><span class="op" id="5962719">]</span>&nbsp;<span class="op" id="5962721">=</span>&nbsp;<span class="builtintype" id="5962723">uint8</span><span class="op" id="5962728">(</span><span class="ident" id="5962729">u</span>&nbsp;<span class="op" id="5962731">&gt;&gt;</span>&nbsp;<span class="num" id="5962734">8</span><span class="op" id="5962735">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962738">b</span><span class="op" id="5962739">[</span><span class="num" id="5962740">3</span><span class="op" id="5962741">]</span>&nbsp;<span class="op" id="5962743">=</span>&nbsp;<span class="builtintype" id="5962745">uint8</span><span class="op" id="5962750">(</span><span class="ident" id="5962751">u</span>&nbsp;<span class="op" id="5962753">&gt;&gt;</span>&nbsp;<span class="num" id="5962756">0</span><span class="op" id="5962757">)</span><br>
<span class="lineno"></span><span class="op" id="5962759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5962762">type</span>&nbsp;<span class="ident" id="5962767">opaquer</span>&nbsp;<span class="keyword" id="5962775">interface</span>&nbsp;<span class="op" id="5962785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962788">Opaque</span><span class="op" id="5962794">(</span><span class="op" id="5962795">)</span>&nbsp;<span class="builtintype" id="5962797">bool</span><br>
<span class="lineno">55</span><span class="op" id="5962802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5962805">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5962858">func</span>&nbsp;<span class="ident" id="5962863">opaque</span><span class="op" id="5962869">(</span><span class="ident" id="5962870">m</span>&nbsp;<span class="ident" id="5962872">image</span><span class="op" id="5962877">.</span><span class="ident" id="5962878">Image</span><span class="op" id="5962883">)</span>&nbsp;<span class="builtintype" id="5962885">bool</span>&nbsp;<span class="op" id="5962890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5962893">if</span>&nbsp;<span class="ident" id="5962896">o</span><span class="op" id="5962897">,</span>&nbsp;<span class="ident" id="5962899">ok</span>&nbsp;<span class="op" id="5962902">:=</span>&nbsp;<span class="ident" id="5962905">m</span><span class="op" id="5962906">.</span><span class="op" id="5962907">(</span><span class="ident" id="5962908">opaquer</span><span class="op" id="5962915">)</span><span class="op" id="5962916">;</span>&nbsp;<span class="ident" id="5962918">ok</span>&nbsp;<span class="op" id="5962921">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5962925">return</span>&nbsp;<span class="ident" id="5962932">o</span><span class="op" id="5962933">.</span><span class="ident" id="5962934">Opaque</span><span class="op" id="5962940">(</span><span class="op" id="5962941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5962944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5962947">b</span>&nbsp;<span class="op" id="5962949">:=</span>&nbsp;<span class="ident" id="5962952">m</span><span class="op" id="5962953">.</span><span class="ident" id="5962954">Bounds</span><span class="op" id="5962960">(</span><span class="op" id="5962961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5962964">for</span>&nbsp;<span class="ident" id="5962968">y</span>&nbsp;<span class="op" id="5962970">:=</span>&nbsp;<span class="ident" id="5962973">b</span><span class="op" id="5962974">.</span><span class="ident" id="5962975">Min</span><span class="op" id="5962978">.</span><span class="ident" id="5962979">Y</span><span class="op" id="5962980">;</span>&nbsp;<span class="ident" id="5962982">y</span>&nbsp;<span class="op" id="5962984">&lt;</span>&nbsp;<span class="ident" id="5962986">b</span><span class="op" id="5962987">.</span><span class="ident" id="5962988">Max</span><span class="op" id="5962991">.</span><span class="ident" id="5962992">Y</span><span class="op" id="5962993">;</span>&nbsp;<span class="ident" id="5962995">y</span><span class="op" id="5962996">++</span>&nbsp;<span class="op" id="5962999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963003">for</span>&nbsp;<span class="ident" id="5963007">x</span>&nbsp;<span class="op" id="5963009">:=</span>&nbsp;<span class="ident" id="5963012">b</span><span class="op" id="5963013">.</span><span class="ident" id="5963014">Min</span><span class="op" id="5963017">.</span><span class="ident" id="5963018">X</span><span class="op" id="5963019">;</span>&nbsp;<span class="ident" id="5963021">x</span>&nbsp;<span class="op" id="5963023">&lt;</span>&nbsp;<span class="ident" id="5963025">b</span><span class="op" id="5963026">.</span><span class="ident" id="5963027">Max</span><span class="op" id="5963030">.</span><span class="ident" id="5963031">X</span><span class="op" id="5963032">;</span>&nbsp;<span class="ident" id="5963034">x</span><span class="op" id="5963035">++</span>&nbsp;<span class="op" id="5963038">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963043">_</span><span class="op" id="5963044">,</span>&nbsp;<span class="ident" id="5963046">_</span><span class="op" id="5963047">,</span>&nbsp;<span class="ident" id="5963049">_</span><span class="op" id="5963050">,</span>&nbsp;<span class="ident" id="5963052">a</span>&nbsp;<span class="op" id="5963054">:=</span>&nbsp;<span class="ident" id="5963057">m</span><span class="op" id="5963058">.</span><span class="ident" id="5963059">At</span><span class="op" id="5963061">(</span><span class="ident" id="5963062">x</span><span class="op" id="5963063">,</span>&nbsp;<span class="ident" id="5963065">y</span><span class="op" id="5963066">)</span><span class="op" id="5963067">.</span><span class="ident" id="5963068">RGBA</span><span class="op" id="5963072">(</span><span class="op" id="5963073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963078">if</span>&nbsp;<span class="ident" id="5963081">a</span>&nbsp;<span class="op" id="5963083">!=</span>&nbsp;<span class="num" id="5963086">0xffff</span>&nbsp;<span class="op" id="5963093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963099">return</span>&nbsp;<span class="builtintype" id="5963106">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963119">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963125">return</span>&nbsp;<span class="builtintype" id="5963132">true</span><br>
<span class="lineno"></span><span class="op" id="5963137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5963140">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5963202">func</span>&nbsp;<span class="ident" id="5963207">abs8</span><span class="op" id="5963211">(</span><span class="ident" id="5963212">d</span>&nbsp;<span class="builtintype" id="5963214">uint8</span><span class="op" id="5963219">)</span>&nbsp;<span class="builtintype" id="5963221">int</span>&nbsp;<span class="op" id="5963225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963228">if</span>&nbsp;<span class="ident" id="5963231">d</span>&nbsp;<span class="op" id="5963233">&lt;</span>&nbsp;<span class="num" id="5963235">128</span>&nbsp;<span class="op" id="5963239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963243">return</span>&nbsp;<span class="builtintype" id="5963250">int</span><span class="op" id="5963253">(</span><span class="ident" id="5963254">d</span><span class="op" id="5963255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963261">return</span>&nbsp;<span class="num" id="5963268">256</span>&nbsp;<span class="op" id="5963272">-</span>&nbsp;<span class="builtintype" id="5963274">int</span><span class="op" id="5963277">(</span><span class="ident" id="5963278">d</span><span class="op" id="5963279">)</span><br>
<span class="lineno">80</span><span class="op" id="5963281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5963284">func</span>&nbsp;<span class="op" id="5963289">(</span><span class="ident" id="5963290">e</span>&nbsp;<span class="op" id="5963292">*</span><span class="ident" id="5963293">encoder</span><span class="op" id="5963300">)</span>&nbsp;<span class="ident" id="5963302">writeChunk</span><span class="op" id="5963312">(</span><span class="ident" id="5963313">b</span>&nbsp;<span class="op" id="5963315">[</span><span class="op" id="5963316">]</span><span class="builtintype" id="5963317">byte</span><span class="op" id="5963321">,</span>&nbsp;<span class="ident" id="5963323">name</span>&nbsp;<span class="builtintype" id="5963328">string</span><span class="op" id="5963334">)</span>&nbsp;<span class="op" id="5963336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963339">if</span>&nbsp;<span class="ident" id="5963342">e</span><span class="op" id="5963343">.</span><span class="ident" id="5963344">err</span>&nbsp;<span class="op" id="5963348">!=</span>&nbsp;<span class="builtintype" id="5963351">nil</span>&nbsp;<span class="op" id="5963355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963359">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963370">n</span>&nbsp;<span class="op" id="5963372">:=</span>&nbsp;<span class="builtintype" id="5963375">uint32</span><span class="op" id="5963381">(</span><span class="builtinfunc" id="5963382">len</span><span class="op" id="5963385">(</span><span class="ident" id="5963386">b</span><span class="op" id="5963387">)</span><span class="op" id="5963388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963391">if</span>&nbsp;<span class="builtintype" id="5963394">int</span><span class="op" id="5963397">(</span><span class="ident" id="5963398">n</span><span class="op" id="5963399">)</span>&nbsp;<span class="op" id="5963401">!=</span>&nbsp;<span class="builtinfunc" id="5963404">len</span><span class="op" id="5963407">(</span><span class="ident" id="5963408">b</span><span class="op" id="5963409">)</span>&nbsp;<span class="op" id="5963411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963415">e</span><span class="op" id="5963416">.</span><span class="ident" id="5963417">err</span>&nbsp;<span class="op" id="5963421">=</span>&nbsp;<span class="ident" id="5963423">UnsupportedError</span><span class="op" id="5963439">(</span><span class="ident" id="5963440">name</span>&nbsp;<span class="op" id="5963445">+</span>&nbsp;<span class="string" id="5963447">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5963471">+</span>&nbsp;<span class="ident" id="5963473">strconv</span><span class="op" id="5963480">.</span><span class="ident" id="5963481">Itoa</span><span class="op" id="5963485">(</span><span class="builtinfunc" id="5963486">len</span><span class="op" id="5963489">(</span><span class="ident" id="5963490">b</span><span class="op" id="5963491">)</span><span class="op" id="5963492">)</span><span class="op" id="5963493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963497">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963508">writeUint32</span><span class="op" id="5963519">(</span><span class="ident" id="5963520">e</span><span class="op" id="5963521">.</span><span class="ident" id="5963522">header</span><span class="op" id="5963528">[</span><span class="op" id="5963529">:</span><span class="num" id="5963530">4</span><span class="op" id="5963531">]</span><span class="op" id="5963532">,</span>&nbsp;<span class="ident" id="5963534">n</span><span class="op" id="5963535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963538">e</span><span class="op" id="5963539">.</span><span class="ident" id="5963540">header</span><span class="op" id="5963546">[</span><span class="num" id="5963547">4</span><span class="op" id="5963548">]</span>&nbsp;<span class="op" id="5963550">=</span>&nbsp;<span class="ident" id="5963552">name</span><span class="op" id="5963556">[</span><span class="num" id="5963557">0</span><span class="op" id="5963558">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963561">e</span><span class="op" id="5963562">.</span><span class="ident" id="5963563">header</span><span class="op" id="5963569">[</span><span class="num" id="5963570">5</span><span class="op" id="5963571">]</span>&nbsp;<span class="op" id="5963573">=</span>&nbsp;<span class="ident" id="5963575">name</span><span class="op" id="5963579">[</span><span class="num" id="5963580">1</span><span class="op" id="5963581">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963584">e</span><span class="op" id="5963585">.</span><span class="ident" id="5963586">header</span><span class="op" id="5963592">[</span><span class="num" id="5963593">6</span><span class="op" id="5963594">]</span>&nbsp;<span class="op" id="5963596">=</span>&nbsp;<span class="ident" id="5963598">name</span><span class="op" id="5963602">[</span><span class="num" id="5963603">2</span><span class="op" id="5963604">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963607">e</span><span class="op" id="5963608">.</span><span class="ident" id="5963609">header</span><span class="op" id="5963615">[</span><span class="num" id="5963616">7</span><span class="op" id="5963617">]</span>&nbsp;<span class="op" id="5963619">=</span>&nbsp;<span class="ident" id="5963621">name</span><span class="op" id="5963625">[</span><span class="num" id="5963626">3</span><span class="op" id="5963627">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963630">crc</span>&nbsp;<span class="op" id="5963634">:=</span>&nbsp;<span class="ident" id="5963637">crc32</span><span class="op" id="5963642">.</span><span class="ident" id="5963643">NewIEEE</span><span class="op" id="5963650">(</span><span class="op" id="5963651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963654">crc</span><span class="op" id="5963657">.</span><span class="ident" id="5963658">Write</span><span class="op" id="5963663">(</span><span class="ident" id="5963664">e</span><span class="op" id="5963665">.</span><span class="ident" id="5963666">header</span><span class="op" id="5963672">[</span><span class="num" id="5963673">4</span><span class="op" id="5963674">:</span><span class="num" id="5963675">8</span><span class="op" id="5963676">]</span><span class="op" id="5963677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963680">crc</span><span class="op" id="5963683">.</span><span class="ident" id="5963684">Write</span><span class="op" id="5963689">(</span><span class="ident" id="5963690">b</span><span class="op" id="5963691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963694">writeUint32</span><span class="op" id="5963705">(</span><span class="ident" id="5963706">e</span><span class="op" id="5963707">.</span><span class="ident" id="5963708">footer</span><span class="op" id="5963714">[</span><span class="op" id="5963715">:</span><span class="num" id="5963716">4</span><span class="op" id="5963717">]</span><span class="op" id="5963718">,</span>&nbsp;<span class="ident" id="5963720">crc</span><span class="op" id="5963723">.</span><span class="ident" id="5963724">Sum32</span><span class="op" id="5963729">(</span><span class="op" id="5963730">)</span><span class="op" id="5963731">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963735">_</span><span class="op" id="5963736">,</span>&nbsp;<span class="ident" id="5963738">e</span><span class="op" id="5963739">.</span><span class="ident" id="5963740">err</span>&nbsp;<span class="op" id="5963744">=</span>&nbsp;<span class="ident" id="5963746">e</span><span class="op" id="5963747">.</span><span class="ident" id="5963748">w</span><span class="op" id="5963749">.</span><span class="ident" id="5963750">Write</span><span class="op" id="5963755">(</span><span class="ident" id="5963756">e</span><span class="op" id="5963757">.</span><span class="ident" id="5963758">header</span><span class="op" id="5963764">[</span><span class="op" id="5963765">:</span><span class="num" id="5963766">8</span><span class="op" id="5963767">]</span><span class="op" id="5963768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963771">if</span>&nbsp;<span class="ident" id="5963774">e</span><span class="op" id="5963775">.</span><span class="ident" id="5963776">err</span>&nbsp;<span class="op" id="5963780">!=</span>&nbsp;<span class="builtintype" id="5963783">nil</span>&nbsp;<span class="op" id="5963787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963791">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963799">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963802">_</span><span class="op" id="5963803">,</span>&nbsp;<span class="ident" id="5963805">e</span><span class="op" id="5963806">.</span><span class="ident" id="5963807">err</span>&nbsp;<span class="op" id="5963811">=</span>&nbsp;<span class="ident" id="5963813">e</span><span class="op" id="5963814">.</span><span class="ident" id="5963815">w</span><span class="op" id="5963816">.</span><span class="ident" id="5963817">Write</span><span class="op" id="5963822">(</span><span class="ident" id="5963823">b</span><span class="op" id="5963824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963827">if</span>&nbsp;<span class="ident" id="5963830">e</span><span class="op" id="5963831">.</span><span class="ident" id="5963832">err</span>&nbsp;<span class="op" id="5963836">!=</span>&nbsp;<span class="builtintype" id="5963839">nil</span>&nbsp;<span class="op" id="5963843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5963847">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5963855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963858">_</span><span class="op" id="5963859">,</span>&nbsp;<span class="ident" id="5963861">e</span><span class="op" id="5963862">.</span><span class="ident" id="5963863">err</span>&nbsp;<span class="op" id="5963867">=</span>&nbsp;<span class="ident" id="5963869">e</span><span class="op" id="5963870">.</span><span class="ident" id="5963871">w</span><span class="op" id="5963872">.</span><span class="ident" id="5963873">Write</span><span class="op" id="5963878">(</span><span class="ident" id="5963879">e</span><span class="op" id="5963880">.</span><span class="ident" id="5963881">footer</span><span class="op" id="5963887">[</span><span class="op" id="5963888">:</span><span class="num" id="5963889">4</span><span class="op" id="5963890">]</span><span class="op" id="5963891">)</span><br>
<span class="lineno">110</span><span class="op" id="5963893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5963896">func</span>&nbsp;<span class="op" id="5963901">(</span><span class="ident" id="5963902">e</span>&nbsp;<span class="op" id="5963904">*</span><span class="ident" id="5963905">encoder</span><span class="op" id="5963912">)</span>&nbsp;<span class="ident" id="5963914">writeIHDR</span><span class="op" id="5963923">(</span><span class="op" id="5963924">)</span>&nbsp;<span class="op" id="5963926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963929">b</span>&nbsp;<span class="op" id="5963931">:=</span>&nbsp;<span class="ident" id="5963934">e</span><span class="op" id="5963935">.</span><span class="ident" id="5963936">m</span><span class="op" id="5963937">.</span><span class="ident" id="5963938">Bounds</span><span class="op" id="5963944">(</span><span class="op" id="5963945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963948">writeUint32</span><span class="op" id="5963959">(</span><span class="ident" id="5963960">e</span><span class="op" id="5963961">.</span><span class="ident" id="5963962">tmp</span><span class="op" id="5963965">[</span><span class="num" id="5963966">0</span><span class="op" id="5963967">:</span><span class="num" id="5963968">4</span><span class="op" id="5963969">]</span><span class="op" id="5963970">,</span>&nbsp;<span class="builtintype" id="5963972">uint32</span><span class="op" id="5963978">(</span><span class="ident" id="5963979">b</span><span class="op" id="5963980">.</span><span class="ident" id="5963981">Dx</span><span class="op" id="5963983">(</span><span class="op" id="5963984">)</span><span class="op" id="5963985">)</span><span class="op" id="5963986">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5963989">writeUint32</span><span class="op" id="5964000">(</span><span class="ident" id="5964001">e</span><span class="op" id="5964002">.</span><span class="ident" id="5964003">tmp</span><span class="op" id="5964006">[</span><span class="num" id="5964007">4</span><span class="op" id="5964008">:</span><span class="num" id="5964009">8</span><span class="op" id="5964010">]</span><span class="op" id="5964011">,</span>&nbsp;<span class="builtintype" id="5964013">uint32</span><span class="op" id="5964019">(</span><span class="ident" id="5964020">b</span><span class="op" id="5964021">.</span><span class="ident" id="5964022">Dy</span><span class="op" id="5964024">(</span><span class="op" id="5964025">)</span><span class="op" id="5964026">)</span><span class="op" id="5964027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5964030">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964064">switch</span>&nbsp;<span class="ident" id="5964071">e</span><span class="op" id="5964072">.</span><span class="ident" id="5964073">cb</span>&nbsp;<span class="op" id="5964076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964079">case</span>&nbsp;<span class="ident" id="5964084">cbG8</span><span class="op" id="5964088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964092">e</span><span class="op" id="5964093">.</span><span class="ident" id="5964094">tmp</span><span class="op" id="5964097">[</span><span class="num" id="5964098">8</span><span class="op" id="5964099">]</span>&nbsp;<span class="op" id="5964101">=</span>&nbsp;<span class="num" id="5964103">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964107">e</span><span class="op" id="5964108">.</span><span class="ident" id="5964109">tmp</span><span class="op" id="5964112">[</span><span class="num" id="5964113">9</span><span class="op" id="5964114">]</span>&nbsp;<span class="op" id="5964116">=</span>&nbsp;<span class="ident" id="5964118">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964131">case</span>&nbsp;<span class="ident" id="5964136">cbTC8</span><span class="op" id="5964141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964145">e</span><span class="op" id="5964146">.</span><span class="ident" id="5964147">tmp</span><span class="op" id="5964150">[</span><span class="num" id="5964151">8</span><span class="op" id="5964152">]</span>&nbsp;<span class="op" id="5964154">=</span>&nbsp;<span class="num" id="5964156">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964160">e</span><span class="op" id="5964161">.</span><span class="ident" id="5964162">tmp</span><span class="op" id="5964165">[</span><span class="num" id="5964166">9</span><span class="op" id="5964167">]</span>&nbsp;<span class="op" id="5964169">=</span>&nbsp;<span class="ident" id="5964171">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964184">case</span>&nbsp;<span class="ident" id="5964189">cbP8</span><span class="op" id="5964193">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964197">e</span><span class="op" id="5964198">.</span><span class="ident" id="5964199">tmp</span><span class="op" id="5964202">[</span><span class="num" id="5964203">8</span><span class="op" id="5964204">]</span>&nbsp;<span class="op" id="5964206">=</span>&nbsp;<span class="num" id="5964208">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964212">e</span><span class="op" id="5964213">.</span><span class="ident" id="5964214">tmp</span><span class="op" id="5964217">[</span><span class="num" id="5964218">9</span><span class="op" id="5964219">]</span>&nbsp;<span class="op" id="5964221">=</span>&nbsp;<span class="ident" id="5964223">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964235">case</span>&nbsp;<span class="ident" id="5964240">cbTCA8</span><span class="op" id="5964246">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964250">e</span><span class="op" id="5964251">.</span><span class="ident" id="5964252">tmp</span><span class="op" id="5964255">[</span><span class="num" id="5964256">8</span><span class="op" id="5964257">]</span>&nbsp;<span class="op" id="5964259">=</span>&nbsp;<span class="num" id="5964261">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964265">e</span><span class="op" id="5964266">.</span><span class="ident" id="5964267">tmp</span><span class="op" id="5964270">[</span><span class="num" id="5964271">9</span><span class="op" id="5964272">]</span>&nbsp;<span class="op" id="5964274">=</span>&nbsp;<span class="ident" id="5964276">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964294">case</span>&nbsp;<span class="ident" id="5964299">cbG16</span><span class="op" id="5964304">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964308">e</span><span class="op" id="5964309">.</span><span class="ident" id="5964310">tmp</span><span class="op" id="5964313">[</span><span class="num" id="5964314">8</span><span class="op" id="5964315">]</span>&nbsp;<span class="op" id="5964317">=</span>&nbsp;<span class="num" id="5964319">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964324">e</span><span class="op" id="5964325">.</span><span class="ident" id="5964326">tmp</span><span class="op" id="5964329">[</span><span class="num" id="5964330">9</span><span class="op" id="5964331">]</span>&nbsp;<span class="op" id="5964333">=</span>&nbsp;<span class="ident" id="5964335">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964348">case</span>&nbsp;<span class="ident" id="5964353">cbTC16</span><span class="op" id="5964359">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964363">e</span><span class="op" id="5964364">.</span><span class="ident" id="5964365">tmp</span><span class="op" id="5964368">[</span><span class="num" id="5964369">8</span><span class="op" id="5964370">]</span>&nbsp;<span class="op" id="5964372">=</span>&nbsp;<span class="num" id="5964374">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964379">e</span><span class="op" id="5964380">.</span><span class="ident" id="5964381">tmp</span><span class="op" id="5964384">[</span><span class="num" id="5964385">9</span><span class="op" id="5964386">]</span>&nbsp;<span class="op" id="5964388">=</span>&nbsp;<span class="ident" id="5964390">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964403">case</span>&nbsp;<span class="ident" id="5964408">cbTCA16</span><span class="op" id="5964415">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964419">e</span><span class="op" id="5964420">.</span><span class="ident" id="5964421">tmp</span><span class="op" id="5964424">[</span><span class="num" id="5964425">8</span><span class="op" id="5964426">]</span>&nbsp;<span class="op" id="5964428">=</span>&nbsp;<span class="num" id="5964430">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964435">e</span><span class="op" id="5964436">.</span><span class="ident" id="5964437">tmp</span><span class="op" id="5964440">[</span><span class="num" id="5964441">9</span><span class="op" id="5964442">]</span>&nbsp;<span class="op" id="5964444">=</span>&nbsp;<span class="ident" id="5964446">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5964464">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964467">e</span><span class="op" id="5964468">.</span><span class="ident" id="5964469">tmp</span><span class="op" id="5964472">[</span><span class="num" id="5964473">10</span><span class="op" id="5964475">]</span>&nbsp;<span class="op" id="5964477">=</span>&nbsp;<span class="num" id="5964479">0</span>&nbsp;<span class="comment" id="5964481">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964512">e</span><span class="op" id="5964513">.</span><span class="ident" id="5964514">tmp</span><span class="op" id="5964517">[</span><span class="num" id="5964518">11</span><span class="op" id="5964520">]</span>&nbsp;<span class="op" id="5964522">=</span>&nbsp;<span class="num" id="5964524">0</span>&nbsp;<span class="comment" id="5964526">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964552">e</span><span class="op" id="5964553">.</span><span class="ident" id="5964554">tmp</span><span class="op" id="5964557">[</span><span class="num" id="5964558">12</span><span class="op" id="5964560">]</span>&nbsp;<span class="op" id="5964562">=</span>&nbsp;<span class="num" id="5964564">0</span>&nbsp;<span class="comment" id="5964566">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964585">e</span><span class="op" id="5964586">.</span><span class="ident" id="5964587">writeChunk</span><span class="op" id="5964597">(</span><span class="ident" id="5964598">e</span><span class="op" id="5964599">.</span><span class="ident" id="5964600">tmp</span><span class="op" id="5964603">[</span><span class="op" id="5964604">:</span><span class="num" id="5964605">13</span><span class="op" id="5964607">]</span><span class="op" id="5964608">,</span>&nbsp;<span class="string" id="5964610">&#34;IHDR&#34;</span><span class="op" id="5964616">)</span><br>
<span class="lineno"></span><span class="op" id="5964618">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5964621">func</span>&nbsp;<span class="op" id="5964626">(</span><span class="ident" id="5964627">e</span>&nbsp;<span class="op" id="5964629">*</span><span class="ident" id="5964630">encoder</span><span class="op" id="5964637">)</span>&nbsp;<span class="ident" id="5964639">writePLTEAndTRNS</span><span class="op" id="5964655">(</span><span class="ident" id="5964656">p</span>&nbsp;<span class="ident" id="5964658">color</span><span class="op" id="5964663">.</span><span class="ident" id="5964664">Palette</span><span class="op" id="5964671">)</span>&nbsp;<span class="op" id="5964673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964676">if</span>&nbsp;<span class="builtinfunc" id="5964679">len</span><span class="op" id="5964682">(</span><span class="ident" id="5964683">p</span><span class="op" id="5964684">)</span>&nbsp;<span class="op" id="5964686">&lt;</span>&nbsp;<span class="num" id="5964688">1</span>&nbsp;<span class="op" id="5964690">||</span>&nbsp;<span class="builtinfunc" id="5964693">len</span><span class="op" id="5964696">(</span><span class="ident" id="5964697">p</span><span class="op" id="5964698">)</span>&nbsp;<span class="op" id="5964700">&gt;</span>&nbsp;<span class="num" id="5964702">256</span>&nbsp;<span class="op" id="5964706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964710">e</span><span class="op" id="5964711">.</span><span class="ident" id="5964712">err</span>&nbsp;<span class="op" id="5964716">=</span>&nbsp;<span class="ident" id="5964718">FormatError</span><span class="op" id="5964729">(</span><span class="string" id="5964730">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5964753">+</span>&nbsp;<span class="ident" id="5964755">strconv</span><span class="op" id="5964762">.</span><span class="ident" id="5964763">Itoa</span><span class="op" id="5964767">(</span><span class="builtinfunc" id="5964768">len</span><span class="op" id="5964771">(</span><span class="ident" id="5964772">p</span><span class="op" id="5964773">)</span><span class="op" id="5964774">)</span><span class="op" id="5964775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964779">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5964787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964790">last</span>&nbsp;<span class="op" id="5964795">:=</span>&nbsp;<span class="op" id="5964798">-</span><span class="num" id="5964799">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964802">for</span>&nbsp;<span class="ident" id="5964806">i</span><span class="op" id="5964807">,</span>&nbsp;<span class="ident" id="5964809">c</span>&nbsp;<span class="op" id="5964811">:=</span>&nbsp;<span class="keyword" id="5964814">range</span>&nbsp;<span class="ident" id="5964820">p</span>&nbsp;<span class="op" id="5964822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964826">c1</span>&nbsp;<span class="op" id="5964829">:=</span>&nbsp;<span class="ident" id="5964832">color</span><span class="op" id="5964837">.</span><span class="ident" id="5964838">NRGBAModel</span><span class="op" id="5964848">.</span><span class="ident" id="5964849">Convert</span><span class="op" id="5964856">(</span><span class="ident" id="5964857">c</span><span class="op" id="5964858">)</span><span class="op" id="5964859">.</span><span class="op" id="5964860">(</span><span class="ident" id="5964861">color</span><span class="op" id="5964866">.</span><span class="ident" id="5964867">NRGBA</span><span class="op" id="5964872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964876">e</span><span class="op" id="5964877">.</span><span class="ident" id="5964878">tmp</span><span class="op" id="5964881">[</span><span class="num" id="5964882">3</span><span class="op" id="5964883">*</span><span class="ident" id="5964884">i</span><span class="op" id="5964885">+</span><span class="num" id="5964886">0</span><span class="op" id="5964887">]</span>&nbsp;<span class="op" id="5964889">=</span>&nbsp;<span class="ident" id="5964891">c1</span><span class="op" id="5964893">.</span><span class="ident" id="5964894">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964898">e</span><span class="op" id="5964899">.</span><span class="ident" id="5964900">tmp</span><span class="op" id="5964903">[</span><span class="num" id="5964904">3</span><span class="op" id="5964905">*</span><span class="ident" id="5964906">i</span><span class="op" id="5964907">+</span><span class="num" id="5964908">1</span><span class="op" id="5964909">]</span>&nbsp;<span class="op" id="5964911">=</span>&nbsp;<span class="ident" id="5964913">c1</span><span class="op" id="5964915">.</span><span class="ident" id="5964916">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964920">e</span><span class="op" id="5964921">.</span><span class="ident" id="5964922">tmp</span><span class="op" id="5964925">[</span><span class="num" id="5964926">3</span><span class="op" id="5964927">*</span><span class="ident" id="5964928">i</span><span class="op" id="5964929">+</span><span class="num" id="5964930">2</span><span class="op" id="5964931">]</span>&nbsp;<span class="op" id="5964933">=</span>&nbsp;<span class="ident" id="5964935">c1</span><span class="op" id="5964937">.</span><span class="ident" id="5964938">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5964942">if</span>&nbsp;<span class="ident" id="5964945">c1</span><span class="op" id="5964947">.</span><span class="ident" id="5964948">A</span>&nbsp;<span class="op" id="5964950">!=</span>&nbsp;<span class="num" id="5964953">0xff</span>&nbsp;<span class="op" id="5964958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964963">last</span>&nbsp;<span class="op" id="5964968">=</span>&nbsp;<span class="ident" id="5964970">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5964974">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5964978">e</span><span class="op" id="5964979">.</span><span class="ident" id="5964980">tmp</span><span class="op" id="5964983">[</span><span class="num" id="5964984">3</span><span class="op" id="5964985">*</span><span class="num" id="5964986">256</span><span class="op" id="5964989">+</span><span class="ident" id="5964990">i</span><span class="op" id="5964991">]</span>&nbsp;<span class="op" id="5964993">=</span>&nbsp;<span class="ident" id="5964995">c1</span><span class="op" id="5964997">.</span><span class="ident" id="5964998">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5965001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5965004">e</span><span class="op" id="5965005">.</span><span class="ident" id="5965006">writeChunk</span><span class="op" id="5965016">(</span><span class="ident" id="5965017">e</span><span class="op" id="5965018">.</span><span class="ident" id="5965019">tmp</span><span class="op" id="5965022">[</span><span class="op" id="5965023">:</span><span class="num" id="5965024">3</span><span class="op" id="5965025">*</span><span class="builtinfunc" id="5965026">len</span><span class="op" id="5965029">(</span><span class="ident" id="5965030">p</span><span class="op" id="5965031">)</span><span class="op" id="5965032">]</span><span class="op" id="5965033">,</span>&nbsp;<span class="string" id="5965035">&#34;PLTE&#34;</span><span class="op" id="5965041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5965044">if</span>&nbsp;<span class="ident" id="5965047">last</span>&nbsp;<span class="op" id="5965052">!=</span>&nbsp;<span class="op" id="5965055">-</span><span class="num" id="5965056">1</span>&nbsp;<span class="op" id="5965058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5965062">e</span><span class="op" id="5965063">.</span><span class="ident" id="5965064">writeChunk</span><span class="op" id="5965074">(</span><span class="ident" id="5965075">e</span><span class="op" id="5965076">.</span><span class="ident" id="5965077">tmp</span><span class="op" id="5965080">[</span><span class="num" id="5965081">3</span><span class="op" id="5965082">*</span><span class="num" id="5965083">256</span><span class="op" id="5965086">:</span><span class="num" id="5965087">3</span><span class="op" id="5965088">*</span><span class="num" id="5965089">256</span><span class="op" id="5965092">+</span><span class="num" id="5965093">1</span><span class="op" id="5965094">+</span><span class="ident" id="5965095">last</span><span class="op" id="5965099">]</span><span class="op" id="5965100">,</span>&nbsp;<span class="string" id="5965102">&#34;tRNS&#34;</span><span class="op" id="5965108">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5965111">}</span><br>
<span class="lineno"></span><span class="op" id="5965113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5965116">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5965196">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5965277">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5965351">//</span><br>
<span class="lineno"></span><span class="comment" id="5965354">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5965425">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5965483">func</span>&nbsp;<span class="op" id="5965488">(</span><span class="ident" id="5965489">e</span>&nbsp;<span class="op" id="5965491">*</span><span class="ident" id="5965492">encoder</span><span class="op" id="5965499">)</span>&nbsp;<span class="ident" id="5965501">Write</span><span class="op" id="5965506">(</span><span class="ident" id="5965507">b</span>&nbsp;<span class="op" id="5965509">[</span><span class="op" id="5965510">]</span><span class="builtintype" id="5965511">byte</span><span class="op" id="5965515">)</span>&nbsp;<span class="op" id="5965517">(</span><span class="builtintype" id="5965518">int</span><span class="op" id="5965521">,</span>&nbsp;<span class="builtintype" id="5965523">error</span><span class="op" id="5965528">)</span>&nbsp;<span class="op" id="5965530">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5965533">e</span><span class="op" id="5965534">.</span><span class="ident" id="5965535">writeChunk</span><span class="op" id="5965545">(</span><span class="ident" id="5965546">b</span><span class="op" id="5965547">,</span>&nbsp;<span class="string" id="5965549">&#34;IDAT&#34;</span><span class="op" id="5965555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5965558">if</span>&nbsp;<span class="ident" id="5965561">e</span><span class="op" id="5965562">.</span><span class="ident" id="5965563">err</span>&nbsp;<span class="op" id="5965567">!=</span>&nbsp;<span class="builtintype" id="5965570">nil</span>&nbsp;<span class="op" id="5965574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5965578">return</span>&nbsp;<span class="num" id="5965585">0</span><span class="op" id="5965586">,</span>&nbsp;<span class="ident" id="5965588">e</span><span class="op" id="5965589">.</span><span class="ident" id="5965590">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5965595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5965598">return</span>&nbsp;<span class="builtinfunc" id="5965605">len</span><span class="op" id="5965608">(</span><span class="ident" id="5965609">b</span><span class="op" id="5965610">)</span><span class="op" id="5965611">,</span>&nbsp;<span class="builtintype" id="5965613">nil</span><br>
<span class="lineno">180</span><span class="op" id="5965617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5965620">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5965695">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5965793">func</span>&nbsp;<span class="ident" id="5965798">filter</span><span class="op" id="5965804">(</span><span class="ident" id="5965805">cr</span>&nbsp;<span class="op" id="5965808">*</span><span class="op" id="5965809">[</span><span class="ident" id="5965810">nFilter</span><span class="op" id="5965817">]</span><span class="op" id="5965818">[</span><span class="op" id="5965819">]</span><span class="builtintype" id="5965820">byte</span><span class="op" id="5965824">,</span>&nbsp;<span class="ident" id="5965826">pr</span>&nbsp;<span class="op" id="5965829">[</span><span class="op" id="5965830">]</span><span class="builtintype" id="5965831">byte</span><span class="op" id="5965835">,</span>&nbsp;<span class="ident" id="5965837">bpp</span>&nbsp;<span class="builtintype" id="5965841">int</span><span class="op" id="5965844">)</span>&nbsp;<span class="builtintype" id="5965846">int</span>&nbsp;<span class="op" id="5965850">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5965853">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5965952">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5966048">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5966143">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966217">cdat0</span>&nbsp;<span class="op" id="5966223">:=</span>&nbsp;<span class="ident" id="5966226">cr</span><span class="op" id="5966228">[</span><span class="num" id="5966229">0</span><span class="op" id="5966230">]</span><span class="op" id="5966231">[</span><span class="num" id="5966232">1</span><span class="op" id="5966233">:</span><span class="op" id="5966234">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966237">cdat1</span>&nbsp;<span class="op" id="5966243">:=</span>&nbsp;<span class="ident" id="5966246">cr</span><span class="op" id="5966248">[</span><span class="num" id="5966249">1</span><span class="op" id="5966250">]</span><span class="op" id="5966251">[</span><span class="num" id="5966252">1</span><span class="op" id="5966253">:</span><span class="op" id="5966254">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966257">cdat2</span>&nbsp;<span class="op" id="5966263">:=</span>&nbsp;<span class="ident" id="5966266">cr</span><span class="op" id="5966268">[</span><span class="num" id="5966269">2</span><span class="op" id="5966270">]</span><span class="op" id="5966271">[</span><span class="num" id="5966272">1</span><span class="op" id="5966273">:</span><span class="op" id="5966274">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966277">cdat3</span>&nbsp;<span class="op" id="5966283">:=</span>&nbsp;<span class="ident" id="5966286">cr</span><span class="op" id="5966288">[</span><span class="num" id="5966289">3</span><span class="op" id="5966290">]</span><span class="op" id="5966291">[</span><span class="num" id="5966292">1</span><span class="op" id="5966293">:</span><span class="op" id="5966294">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966297">cdat4</span>&nbsp;<span class="op" id="5966303">:=</span>&nbsp;<span class="ident" id="5966306">cr</span><span class="op" id="5966308">[</span><span class="num" id="5966309">4</span><span class="op" id="5966310">]</span><span class="op" id="5966311">[</span><span class="num" id="5966312">1</span><span class="op" id="5966313">:</span><span class="op" id="5966314">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966317">pdat</span>&nbsp;<span class="op" id="5966322">:=</span>&nbsp;<span class="ident" id="5966325">pr</span><span class="op" id="5966327">[</span><span class="num" id="5966328">1</span><span class="op" id="5966329">:</span><span class="op" id="5966330">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966333">n</span>&nbsp;<span class="op" id="5966335">:=</span>&nbsp;<span class="builtinfunc" id="5966338">len</span><span class="op" id="5966341">(</span><span class="ident" id="5966342">cdat0</span><span class="op" id="5966347">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5966351">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966370">sum</span>&nbsp;<span class="op" id="5966374">:=</span>&nbsp;<span class="num" id="5966377">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966380">for</span>&nbsp;<span class="ident" id="5966384">i</span>&nbsp;<span class="op" id="5966386">:=</span>&nbsp;<span class="num" id="5966389">0</span><span class="op" id="5966390">;</span>&nbsp;<span class="ident" id="5966392">i</span>&nbsp;<span class="op" id="5966394">&lt;</span>&nbsp;<span class="ident" id="5966396">n</span><span class="op" id="5966397">;</span>&nbsp;<span class="ident" id="5966399">i</span><span class="op" id="5966400">++</span>&nbsp;<span class="op" id="5966403">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966407">cdat2</span><span class="op" id="5966412">[</span><span class="ident" id="5966413">i</span><span class="op" id="5966414">]</span>&nbsp;<span class="op" id="5966416">=</span>&nbsp;<span class="ident" id="5966418">cdat0</span><span class="op" id="5966423">[</span><span class="ident" id="5966424">i</span><span class="op" id="5966425">]</span>&nbsp;<span class="op" id="5966427">-</span>&nbsp;<span class="ident" id="5966429">pdat</span><span class="op" id="5966433">[</span><span class="ident" id="5966434">i</span><span class="op" id="5966435">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966439">sum</span>&nbsp;<span class="op" id="5966443">+=</span>&nbsp;<span class="ident" id="5966446">abs8</span><span class="op" id="5966450">(</span><span class="ident" id="5966451">cdat2</span><span class="op" id="5966456">[</span><span class="ident" id="5966457">i</span><span class="op" id="5966458">]</span><span class="op" id="5966459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966465">best</span>&nbsp;<span class="op" id="5966470">:=</span>&nbsp;<span class="ident" id="5966473">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966478">filter</span>&nbsp;<span class="op" id="5966485">:=</span>&nbsp;<span class="ident" id="5966488">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5966495">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966517">sum</span>&nbsp;<span class="op" id="5966521">=</span>&nbsp;<span class="num" id="5966523">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966526">for</span>&nbsp;<span class="ident" id="5966530">i</span>&nbsp;<span class="op" id="5966532">:=</span>&nbsp;<span class="num" id="5966535">0</span><span class="op" id="5966536">;</span>&nbsp;<span class="ident" id="5966538">i</span>&nbsp;<span class="op" id="5966540">&lt;</span>&nbsp;<span class="ident" id="5966542">bpp</span><span class="op" id="5966545">;</span>&nbsp;<span class="ident" id="5966547">i</span><span class="op" id="5966548">++</span>&nbsp;<span class="op" id="5966551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966555">cdat4</span><span class="op" id="5966560">[</span><span class="ident" id="5966561">i</span><span class="op" id="5966562">]</span>&nbsp;<span class="op" id="5966564">=</span>&nbsp;<span class="ident" id="5966566">cdat0</span><span class="op" id="5966571">[</span><span class="ident" id="5966572">i</span><span class="op" id="5966573">]</span>&nbsp;<span class="op" id="5966575">-</span>&nbsp;<span class="ident" id="5966577">pdat</span><span class="op" id="5966581">[</span><span class="ident" id="5966582">i</span><span class="op" id="5966583">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966587">sum</span>&nbsp;<span class="op" id="5966591">+=</span>&nbsp;<span class="ident" id="5966594">abs8</span><span class="op" id="5966598">(</span><span class="ident" id="5966599">cdat4</span><span class="op" id="5966604">[</span><span class="ident" id="5966605">i</span><span class="op" id="5966606">]</span><span class="op" id="5966607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966613">for</span>&nbsp;<span class="ident" id="5966617">i</span>&nbsp;<span class="op" id="5966619">:=</span>&nbsp;<span class="ident" id="5966622">bpp</span><span class="op" id="5966625">;</span>&nbsp;<span class="ident" id="5966627">i</span>&nbsp;<span class="op" id="5966629">&lt;</span>&nbsp;<span class="ident" id="5966631">n</span><span class="op" id="5966632">;</span>&nbsp;<span class="ident" id="5966634">i</span><span class="op" id="5966635">++</span>&nbsp;<span class="op" id="5966638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966642">cdat4</span><span class="op" id="5966647">[</span><span class="ident" id="5966648">i</span><span class="op" id="5966649">]</span>&nbsp;<span class="op" id="5966651">=</span>&nbsp;<span class="ident" id="5966653">cdat0</span><span class="op" id="5966658">[</span><span class="ident" id="5966659">i</span><span class="op" id="5966660">]</span>&nbsp;<span class="op" id="5966662">-</span>&nbsp;<span class="ident" id="5966664">paeth</span><span class="op" id="5966669">(</span><span class="ident" id="5966670">cdat0</span><span class="op" id="5966675">[</span><span class="ident" id="5966676">i</span><span class="op" id="5966677">-</span><span class="ident" id="5966678">bpp</span><span class="op" id="5966681">]</span><span class="op" id="5966682">,</span>&nbsp;<span class="ident" id="5966684">pdat</span><span class="op" id="5966688">[</span><span class="ident" id="5966689">i</span><span class="op" id="5966690">]</span><span class="op" id="5966691">,</span>&nbsp;<span class="ident" id="5966693">pdat</span><span class="op" id="5966697">[</span><span class="ident" id="5966698">i</span><span class="op" id="5966699">-</span><span class="ident" id="5966700">bpp</span><span class="op" id="5966703">]</span><span class="op" id="5966704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966708">sum</span>&nbsp;<span class="op" id="5966712">+=</span>&nbsp;<span class="ident" id="5966715">abs8</span><span class="op" id="5966719">(</span><span class="ident" id="5966720">cdat4</span><span class="op" id="5966725">[</span><span class="ident" id="5966726">i</span><span class="op" id="5966727">]</span><span class="op" id="5966728">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966732">if</span>&nbsp;<span class="ident" id="5966735">sum</span>&nbsp;<span class="op" id="5966739">&gt;=</span>&nbsp;<span class="ident" id="5966742">best</span>&nbsp;<span class="op" id="5966747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966752">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966766">if</span>&nbsp;<span class="ident" id="5966769">sum</span>&nbsp;<span class="op" id="5966773">&lt;</span>&nbsp;<span class="ident" id="5966775">best</span>&nbsp;<span class="op" id="5966780">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966784">best</span>&nbsp;<span class="op" id="5966789">=</span>&nbsp;<span class="ident" id="5966791">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966797">filter</span>&nbsp;<span class="op" id="5966804">=</span>&nbsp;<span class="ident" id="5966806">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5966819">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966840">sum</span>&nbsp;<span class="op" id="5966844">=</span>&nbsp;<span class="num" id="5966846">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966849">for</span>&nbsp;<span class="ident" id="5966853">i</span>&nbsp;<span class="op" id="5966855">:=</span>&nbsp;<span class="num" id="5966858">0</span><span class="op" id="5966859">;</span>&nbsp;<span class="ident" id="5966861">i</span>&nbsp;<span class="op" id="5966863">&lt;</span>&nbsp;<span class="ident" id="5966865">n</span><span class="op" id="5966866">;</span>&nbsp;<span class="ident" id="5966868">i</span><span class="op" id="5966869">++</span>&nbsp;<span class="op" id="5966872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966876">sum</span>&nbsp;<span class="op" id="5966880">+=</span>&nbsp;<span class="ident" id="5966883">abs8</span><span class="op" id="5966887">(</span><span class="ident" id="5966888">cdat0</span><span class="op" id="5966893">[</span><span class="ident" id="5966894">i</span><span class="op" id="5966895">]</span><span class="op" id="5966896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966900">if</span>&nbsp;<span class="ident" id="5966903">sum</span>&nbsp;<span class="op" id="5966907">&gt;=</span>&nbsp;<span class="ident" id="5966910">best</span>&nbsp;<span class="op" id="5966915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966920">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5966934">if</span>&nbsp;<span class="ident" id="5966937">sum</span>&nbsp;<span class="op" id="5966941">&lt;</span>&nbsp;<span class="ident" id="5966943">best</span>&nbsp;<span class="op" id="5966948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966952">best</span>&nbsp;<span class="op" id="5966957">=</span>&nbsp;<span class="ident" id="5966959">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5966965">filter</span>&nbsp;<span class="op" id="5966972">=</span>&nbsp;<span class="ident" id="5966974">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5966982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5966986">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967006">sum</span>&nbsp;<span class="op" id="5967010">=</span>&nbsp;<span class="num" id="5967012">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967015">for</span>&nbsp;<span class="ident" id="5967019">i</span>&nbsp;<span class="op" id="5967021">:=</span>&nbsp;<span class="num" id="5967024">0</span><span class="op" id="5967025">;</span>&nbsp;<span class="ident" id="5967027">i</span>&nbsp;<span class="op" id="5967029">&lt;</span>&nbsp;<span class="ident" id="5967031">bpp</span><span class="op" id="5967034">;</span>&nbsp;<span class="ident" id="5967036">i</span><span class="op" id="5967037">++</span>&nbsp;<span class="op" id="5967040">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967044">cdat1</span><span class="op" id="5967049">[</span><span class="ident" id="5967050">i</span><span class="op" id="5967051">]</span>&nbsp;<span class="op" id="5967053">=</span>&nbsp;<span class="ident" id="5967055">cdat0</span><span class="op" id="5967060">[</span><span class="ident" id="5967061">i</span><span class="op" id="5967062">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967066">sum</span>&nbsp;<span class="op" id="5967070">+=</span>&nbsp;<span class="ident" id="5967073">abs8</span><span class="op" id="5967077">(</span><span class="ident" id="5967078">cdat1</span><span class="op" id="5967083">[</span><span class="ident" id="5967084">i</span><span class="op" id="5967085">]</span><span class="op" id="5967086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967092">for</span>&nbsp;<span class="ident" id="5967096">i</span>&nbsp;<span class="op" id="5967098">:=</span>&nbsp;<span class="ident" id="5967101">bpp</span><span class="op" id="5967104">;</span>&nbsp;<span class="ident" id="5967106">i</span>&nbsp;<span class="op" id="5967108">&lt;</span>&nbsp;<span class="ident" id="5967110">n</span><span class="op" id="5967111">;</span>&nbsp;<span class="ident" id="5967113">i</span><span class="op" id="5967114">++</span>&nbsp;<span class="op" id="5967117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967121">cdat1</span><span class="op" id="5967126">[</span><span class="ident" id="5967127">i</span><span class="op" id="5967128">]</span>&nbsp;<span class="op" id="5967130">=</span>&nbsp;<span class="ident" id="5967132">cdat0</span><span class="op" id="5967137">[</span><span class="ident" id="5967138">i</span><span class="op" id="5967139">]</span>&nbsp;<span class="op" id="5967141">-</span>&nbsp;<span class="ident" id="5967143">cdat0</span><span class="op" id="5967148">[</span><span class="ident" id="5967149">i</span><span class="op" id="5967150">-</span><span class="ident" id="5967151">bpp</span><span class="op" id="5967154">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967158">sum</span>&nbsp;<span class="op" id="5967162">+=</span>&nbsp;<span class="ident" id="5967165">abs8</span><span class="op" id="5967169">(</span><span class="ident" id="5967170">cdat1</span><span class="op" id="5967175">[</span><span class="ident" id="5967176">i</span><span class="op" id="5967177">]</span><span class="op" id="5967178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967182">if</span>&nbsp;<span class="ident" id="5967185">sum</span>&nbsp;<span class="op" id="5967189">&gt;=</span>&nbsp;<span class="ident" id="5967192">best</span>&nbsp;<span class="op" id="5967197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967202">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967213">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967216">if</span>&nbsp;<span class="ident" id="5967219">sum</span>&nbsp;<span class="op" id="5967223">&lt;</span>&nbsp;<span class="ident" id="5967225">best</span>&nbsp;<span class="op" id="5967230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967234">best</span>&nbsp;<span class="op" id="5967239">=</span>&nbsp;<span class="ident" id="5967241">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967247">filter</span>&nbsp;<span class="op" id="5967254">=</span>&nbsp;<span class="ident" id="5967256">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5967267">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967291">sum</span>&nbsp;<span class="op" id="5967295">=</span>&nbsp;<span class="num" id="5967297">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967300">for</span>&nbsp;<span class="ident" id="5967304">i</span>&nbsp;<span class="op" id="5967306">:=</span>&nbsp;<span class="num" id="5967309">0</span><span class="op" id="5967310">;</span>&nbsp;<span class="ident" id="5967312">i</span>&nbsp;<span class="op" id="5967314">&lt;</span>&nbsp;<span class="ident" id="5967316">bpp</span><span class="op" id="5967319">;</span>&nbsp;<span class="ident" id="5967321">i</span><span class="op" id="5967322">++</span>&nbsp;<span class="op" id="5967325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967329">cdat3</span><span class="op" id="5967334">[</span><span class="ident" id="5967335">i</span><span class="op" id="5967336">]</span>&nbsp;<span class="op" id="5967338">=</span>&nbsp;<span class="ident" id="5967340">cdat0</span><span class="op" id="5967345">[</span><span class="ident" id="5967346">i</span><span class="op" id="5967347">]</span>&nbsp;<span class="op" id="5967349">-</span>&nbsp;<span class="ident" id="5967351">pdat</span><span class="op" id="5967355">[</span><span class="ident" id="5967356">i</span><span class="op" id="5967357">]</span><span class="op" id="5967358">/</span><span class="num" id="5967359">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967363">sum</span>&nbsp;<span class="op" id="5967367">+=</span>&nbsp;<span class="ident" id="5967370">abs8</span><span class="op" id="5967374">(</span><span class="ident" id="5967375">cdat3</span><span class="op" id="5967380">[</span><span class="ident" id="5967381">i</span><span class="op" id="5967382">]</span><span class="op" id="5967383">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967389">for</span>&nbsp;<span class="ident" id="5967393">i</span>&nbsp;<span class="op" id="5967395">:=</span>&nbsp;<span class="ident" id="5967398">bpp</span><span class="op" id="5967401">;</span>&nbsp;<span class="ident" id="5967403">i</span>&nbsp;<span class="op" id="5967405">&lt;</span>&nbsp;<span class="ident" id="5967407">n</span><span class="op" id="5967408">;</span>&nbsp;<span class="ident" id="5967410">i</span><span class="op" id="5967411">++</span>&nbsp;<span class="op" id="5967414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967418">cdat3</span><span class="op" id="5967423">[</span><span class="ident" id="5967424">i</span><span class="op" id="5967425">]</span>&nbsp;<span class="op" id="5967427">=</span>&nbsp;<span class="ident" id="5967429">cdat0</span><span class="op" id="5967434">[</span><span class="ident" id="5967435">i</span><span class="op" id="5967436">]</span>&nbsp;<span class="op" id="5967438">-</span>&nbsp;<span class="builtintype" id="5967440">uint8</span><span class="op" id="5967445">(</span><span class="op" id="5967446">(</span><span class="builtintype" id="5967447">int</span><span class="op" id="5967450">(</span><span class="ident" id="5967451">cdat0</span><span class="op" id="5967456">[</span><span class="ident" id="5967457">i</span><span class="op" id="5967458">-</span><span class="ident" id="5967459">bpp</span><span class="op" id="5967462">]</span><span class="op" id="5967463">)</span><span class="op" id="5967464">+</span><span class="builtintype" id="5967465">int</span><span class="op" id="5967468">(</span><span class="ident" id="5967469">pdat</span><span class="op" id="5967473">[</span><span class="ident" id="5967474">i</span><span class="op" id="5967475">]</span><span class="op" id="5967476">)</span><span class="op" id="5967477">)</span><span class="op" id="5967478">/</span><span class="num" id="5967479">2</span><span class="op" id="5967480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967484">sum</span>&nbsp;<span class="op" id="5967488">+=</span>&nbsp;<span class="ident" id="5967491">abs8</span><span class="op" id="5967495">(</span><span class="ident" id="5967496">cdat3</span><span class="op" id="5967501">[</span><span class="ident" id="5967502">i</span><span class="op" id="5967503">]</span><span class="op" id="5967504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967508">if</span>&nbsp;<span class="ident" id="5967511">sum</span>&nbsp;<span class="op" id="5967515">&gt;=</span>&nbsp;<span class="ident" id="5967518">best</span>&nbsp;<span class="op" id="5967523">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967528">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967542">if</span>&nbsp;<span class="ident" id="5967545">sum</span>&nbsp;<span class="op" id="5967549">&lt;</span>&nbsp;<span class="ident" id="5967551">best</span>&nbsp;<span class="op" id="5967556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967560">best</span>&nbsp;<span class="op" id="5967565">=</span>&nbsp;<span class="ident" id="5967567">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967573">filter</span>&nbsp;<span class="op" id="5967580">=</span>&nbsp;<span class="ident" id="5967582">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967597">return</span>&nbsp;<span class="ident" id="5967604">filter</span><br>
<span class="lineno"></span><span class="op" id="5967611">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5967614">func</span>&nbsp;<span class="ident" id="5967619">writeImage</span><span class="op" id="5967629">(</span><span class="ident" id="5967630">w</span>&nbsp;<span class="ident" id="5967632">io</span><span class="op" id="5967634">.</span><span class="ident" id="5967635">Writer</span><span class="op" id="5967641">,</span>&nbsp;<span class="ident" id="5967643">m</span>&nbsp;<span class="ident" id="5967645">image</span><span class="op" id="5967650">.</span><span class="ident" id="5967651">Image</span><span class="op" id="5967656">,</span>&nbsp;<span class="ident" id="5967658">cb</span>&nbsp;<span class="builtintype" id="5967661">int</span><span class="op" id="5967664">,</span>&nbsp;<span class="ident" id="5967666">level</span>&nbsp;<span class="builtintype" id="5967672">int</span><span class="op" id="5967675">)</span>&nbsp;<span class="builtintype" id="5967677">error</span>&nbsp;<span class="op" id="5967683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967686">zw</span><span class="op" id="5967688">,</span>&nbsp;<span class="ident" id="5967690">err</span>&nbsp;<span class="op" id="5967694">:=</span>&nbsp;<span class="ident" id="5967697">zlib</span><span class="op" id="5967701">.</span><span class="ident" id="5967702">NewWriterLevel</span><span class="op" id="5967716">(</span><span class="ident" id="5967717">w</span><span class="op" id="5967718">,</span>&nbsp;<span class="ident" id="5967720">level</span><span class="op" id="5967725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967728">if</span>&nbsp;<span class="ident" id="5967731">err</span>&nbsp;<span class="op" id="5967735">!=</span>&nbsp;<span class="builtintype" id="5967738">nil</span>&nbsp;<span class="op" id="5967742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967746">return</span>&nbsp;<span class="ident" id="5967753">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967761">defer</span>&nbsp;<span class="ident" id="5967767">zw</span><span class="op" id="5967769">.</span><span class="ident" id="5967770">Close</span><span class="op" id="5967775">(</span><span class="op" id="5967776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967780">bpp</span>&nbsp;<span class="op" id="5967784">:=</span>&nbsp;<span class="num" id="5967787">0</span>&nbsp;<span class="comment" id="5967789">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967811">switch</span>&nbsp;<span class="ident" id="5967818">cb</span>&nbsp;<span class="op" id="5967821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967824">case</span>&nbsp;<span class="ident" id="5967829">cbG8</span><span class="op" id="5967833">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967837">bpp</span>&nbsp;<span class="op" id="5967841">=</span>&nbsp;<span class="num" id="5967843">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967846">case</span>&nbsp;<span class="ident" id="5967851">cbTC8</span><span class="op" id="5967856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967860">bpp</span>&nbsp;<span class="op" id="5967864">=</span>&nbsp;<span class="num" id="5967866">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967869">case</span>&nbsp;<span class="ident" id="5967874">cbP8</span><span class="op" id="5967878">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967882">bpp</span>&nbsp;<span class="op" id="5967886">=</span>&nbsp;<span class="num" id="5967888">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967891">case</span>&nbsp;<span class="ident" id="5967896">cbTCA8</span><span class="op" id="5967902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967906">bpp</span>&nbsp;<span class="op" id="5967910">=</span>&nbsp;<span class="num" id="5967912">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967915">case</span>&nbsp;<span class="ident" id="5967920">cbTC16</span><span class="op" id="5967926">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967930">bpp</span>&nbsp;<span class="op" id="5967934">=</span>&nbsp;<span class="num" id="5967936">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967939">case</span>&nbsp;<span class="ident" id="5967944">cbTCA16</span><span class="op" id="5967951">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967955">bpp</span>&nbsp;<span class="op" id="5967959">=</span>&nbsp;<span class="num" id="5967961">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967964">case</span>&nbsp;<span class="ident" id="5967969">cbG16</span><span class="op" id="5967974">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967978">bpp</span>&nbsp;<span class="op" id="5967982">=</span>&nbsp;<span class="num" id="5967984">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5967987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5967990">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968055">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968131">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968218">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968305">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968370">b</span>&nbsp;<span class="op" id="5968372">:=</span>&nbsp;<span class="ident" id="5968375">m</span><span class="op" id="5968376">.</span><span class="ident" id="5968377">Bounds</span><span class="op" id="5968383">(</span><span class="op" id="5968384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968387">var</span>&nbsp;<span class="ident" id="5968391">cr</span>&nbsp;<span class="op" id="5968394">[</span><span class="ident" id="5968395">nFilter</span><span class="op" id="5968402">]</span><span class="op" id="5968403">[</span><span class="op" id="5968404">]</span><span class="builtintype" id="5968405">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968412">for</span>&nbsp;<span class="ident" id="5968416">i</span>&nbsp;<span class="op" id="5968418">:=</span>&nbsp;<span class="keyword" id="5968421">range</span>&nbsp;<span class="ident" id="5968427">cr</span>&nbsp;<span class="op" id="5968430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968434">cr</span><span class="op" id="5968436">[</span><span class="ident" id="5968437">i</span><span class="op" id="5968438">]</span>&nbsp;<span class="op" id="5968440">=</span>&nbsp;<span class="builtinfunc" id="5968442">make</span><span class="op" id="5968446">(</span><span class="op" id="5968447">[</span><span class="op" id="5968448">]</span><span class="builtintype" id="5968449">uint8</span><span class="op" id="5968454">,</span>&nbsp;<span class="num" id="5968456">1</span><span class="op" id="5968457">+</span><span class="ident" id="5968458">bpp</span><span class="op" id="5968461">*</span><span class="ident" id="5968462">b</span><span class="op" id="5968463">.</span><span class="ident" id="5968464">Dx</span><span class="op" id="5968466">(</span><span class="op" id="5968467">)</span><span class="op" id="5968468">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968472">cr</span><span class="op" id="5968474">[</span><span class="ident" id="5968475">i</span><span class="op" id="5968476">]</span><span class="op" id="5968477">[</span><span class="num" id="5968478">0</span><span class="op" id="5968479">]</span>&nbsp;<span class="op" id="5968481">=</span>&nbsp;<span class="builtintype" id="5968483">uint8</span><span class="op" id="5968488">(</span><span class="ident" id="5968489">i</span><span class="op" id="5968490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5968493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968496">pr</span>&nbsp;<span class="op" id="5968499">:=</span>&nbsp;<span class="builtinfunc" id="5968502">make</span><span class="op" id="5968506">(</span><span class="op" id="5968507">[</span><span class="op" id="5968508">]</span><span class="builtintype" id="5968509">uint8</span><span class="op" id="5968514">,</span>&nbsp;<span class="num" id="5968516">1</span><span class="op" id="5968517">+</span><span class="ident" id="5968518">bpp</span><span class="op" id="5968521">*</span><span class="ident" id="5968522">b</span><span class="op" id="5968523">.</span><span class="ident" id="5968524">Dx</span><span class="op" id="5968526">(</span><span class="op" id="5968527">)</span><span class="op" id="5968528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968532">gray</span><span class="op" id="5968536">,</span>&nbsp;<span class="ident" id="5968538">_</span>&nbsp;<span class="op" id="5968540">:=</span>&nbsp;<span class="ident" id="5968543">m</span><span class="op" id="5968544">.</span><span class="op" id="5968545">(</span><span class="op" id="5968546">*</span><span class="ident" id="5968547">image</span><span class="op" id="5968552">.</span><span class="ident" id="5968553">Gray</span><span class="op" id="5968557">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968560">rgba</span><span class="op" id="5968564">,</span>&nbsp;<span class="ident" id="5968566">_</span>&nbsp;<span class="op" id="5968568">:=</span>&nbsp;<span class="ident" id="5968571">m</span><span class="op" id="5968572">.</span><span class="op" id="5968573">(</span><span class="op" id="5968574">*</span><span class="ident" id="5968575">image</span><span class="op" id="5968580">.</span><span class="ident" id="5968581">RGBA</span><span class="op" id="5968585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968588">paletted</span><span class="op" id="5968596">,</span>&nbsp;<span class="ident" id="5968598">_</span>&nbsp;<span class="op" id="5968600">:=</span>&nbsp;<span class="ident" id="5968603">m</span><span class="op" id="5968604">.</span><span class="op" id="5968605">(</span><span class="op" id="5968606">*</span><span class="ident" id="5968607">image</span><span class="op" id="5968612">.</span><span class="ident" id="5968613">Paletted</span><span class="op" id="5968621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968624">nrgba</span><span class="op" id="5968629">,</span>&nbsp;<span class="ident" id="5968631">_</span>&nbsp;<span class="op" id="5968633">:=</span>&nbsp;<span class="ident" id="5968636">m</span><span class="op" id="5968637">.</span><span class="op" id="5968638">(</span><span class="op" id="5968639">*</span><span class="ident" id="5968640">image</span><span class="op" id="5968645">.</span><span class="ident" id="5968646">NRGBA</span><span class="op" id="5968651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968655">for</span>&nbsp;<span class="ident" id="5968659">y</span>&nbsp;<span class="op" id="5968661">:=</span>&nbsp;<span class="ident" id="5968664">b</span><span class="op" id="5968665">.</span><span class="ident" id="5968666">Min</span><span class="op" id="5968669">.</span><span class="ident" id="5968670">Y</span><span class="op" id="5968671">;</span>&nbsp;<span class="ident" id="5968673">y</span>&nbsp;<span class="op" id="5968675">&lt;</span>&nbsp;<span class="ident" id="5968677">b</span><span class="op" id="5968678">.</span><span class="ident" id="5968679">Max</span><span class="op" id="5968682">.</span><span class="ident" id="5968683">Y</span><span class="op" id="5968684">;</span>&nbsp;<span class="ident" id="5968686">y</span><span class="op" id="5968687">++</span>&nbsp;<span class="op" id="5968690">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968694">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968729">i</span>&nbsp;<span class="op" id="5968731">:=</span>&nbsp;<span class="num" id="5968734">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968738">switch</span>&nbsp;<span class="ident" id="5968745">cb</span>&nbsp;<span class="op" id="5968748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968752">case</span>&nbsp;<span class="ident" id="5968757">cbG8</span><span class="op" id="5968761">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968766">if</span>&nbsp;<span class="ident" id="5968769">gray</span>&nbsp;<span class="op" id="5968774">!=</span>&nbsp;<span class="builtintype" id="5968777">nil</span>&nbsp;<span class="op" id="5968781">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968787">offset</span>&nbsp;<span class="op" id="5968794">:=</span>&nbsp;<span class="op" id="5968797">(</span><span class="ident" id="5968798">y</span>&nbsp;<span class="op" id="5968800">-</span>&nbsp;<span class="ident" id="5968802">b</span><span class="op" id="5968803">.</span><span class="ident" id="5968804">Min</span><span class="op" id="5968807">.</span><span class="ident" id="5968808">Y</span><span class="op" id="5968809">)</span>&nbsp;<span class="op" id="5968811">*</span>&nbsp;<span class="ident" id="5968813">gray</span><span class="op" id="5968817">.</span><span class="ident" id="5968818">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5968829">copy</span><span class="op" id="5968833">(</span><span class="ident" id="5968834">cr</span><span class="op" id="5968836">[</span><span class="num" id="5968837">0</span><span class="op" id="5968838">]</span><span class="op" id="5968839">[</span><span class="num" id="5968840">1</span><span class="op" id="5968841">:</span><span class="op" id="5968842">]</span><span class="op" id="5968843">,</span>&nbsp;<span class="ident" id="5968845">gray</span><span class="op" id="5968849">.</span><span class="ident" id="5968850">Pix</span><span class="op" id="5968853">[</span><span class="ident" id="5968854">offset</span><span class="op" id="5968860">:</span><span class="ident" id="5968861">offset</span><span class="op" id="5968867">+</span><span class="ident" id="5968868">b</span><span class="op" id="5968869">.</span><span class="ident" id="5968870">Dx</span><span class="op" id="5968872">(</span><span class="op" id="5968873">)</span><span class="op" id="5968874">]</span><span class="op" id="5968875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5968880">}</span>&nbsp;<span class="keyword" id="5968882">else</span>&nbsp;<span class="op" id="5968887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968893">for</span>&nbsp;<span class="ident" id="5968897">x</span>&nbsp;<span class="op" id="5968899">:=</span>&nbsp;<span class="ident" id="5968902">b</span><span class="op" id="5968903">.</span><span class="ident" id="5968904">Min</span><span class="op" id="5968907">.</span><span class="ident" id="5968908">X</span><span class="op" id="5968909">;</span>&nbsp;<span class="ident" id="5968911">x</span>&nbsp;<span class="op" id="5968913">&lt;</span>&nbsp;<span class="ident" id="5968915">b</span><span class="op" id="5968916">.</span><span class="ident" id="5968917">Max</span><span class="op" id="5968920">.</span><span class="ident" id="5968921">X</span><span class="op" id="5968922">;</span>&nbsp;<span class="ident" id="5968924">x</span><span class="op" id="5968925">++</span>&nbsp;<span class="op" id="5968928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968935">c</span>&nbsp;<span class="op" id="5968937">:=</span>&nbsp;<span class="ident" id="5968940">color</span><span class="op" id="5968945">.</span><span class="ident" id="5968946">GrayModel</span><span class="op" id="5968955">.</span><span class="ident" id="5968956">Convert</span><span class="op" id="5968963">(</span><span class="ident" id="5968964">m</span><span class="op" id="5968965">.</span><span class="ident" id="5968966">At</span><span class="op" id="5968968">(</span><span class="ident" id="5968969">x</span><span class="op" id="5968970">,</span>&nbsp;<span class="ident" id="5968972">y</span><span class="op" id="5968973">)</span><span class="op" id="5968974">)</span><span class="op" id="5968975">.</span><span class="op" id="5968976">(</span><span class="ident" id="5968977">color</span><span class="op" id="5968982">.</span><span class="ident" id="5968983">Gray</span><span class="op" id="5968987">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968994">cr</span><span class="op" id="5968996">[</span><span class="num" id="5968997">0</span><span class="op" id="5968998">]</span><span class="op" id="5968999">[</span><span class="ident" id="5969000">i</span><span class="op" id="5969001">]</span>&nbsp;<span class="op" id="5969003">=</span>&nbsp;<span class="ident" id="5969005">c</span><span class="op" id="5969006">.</span><span class="ident" id="5969007">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969014">i</span><span class="op" id="5969015">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969031">case</span>&nbsp;<span class="ident" id="5969036">cbTC8</span><span class="op" id="5969041">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5969046">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969118">cr0</span>&nbsp;<span class="op" id="5969122">:=</span>&nbsp;<span class="ident" id="5969125">cr</span><span class="op" id="5969127">[</span><span class="num" id="5969128">0</span><span class="op" id="5969129">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969134">stride</span><span class="op" id="5969140">,</span>&nbsp;<span class="ident" id="5969142">pix</span>&nbsp;<span class="op" id="5969146">:=</span>&nbsp;<span class="num" id="5969149">0</span><span class="op" id="5969150">,</span>&nbsp;<span class="op" id="5969152">[</span><span class="op" id="5969153">]</span><span class="builtintype" id="5969154">byte</span><span class="op" id="5969158">(</span><span class="builtintype" id="5969159">nil</span><span class="op" id="5969162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969167">if</span>&nbsp;<span class="ident" id="5969170">rgba</span>&nbsp;<span class="op" id="5969175">!=</span>&nbsp;<span class="builtintype" id="5969178">nil</span>&nbsp;<span class="op" id="5969182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969188">stride</span><span class="op" id="5969194">,</span>&nbsp;<span class="ident" id="5969196">pix</span>&nbsp;<span class="op" id="5969200">=</span>&nbsp;<span class="ident" id="5969202">rgba</span><span class="op" id="5969206">.</span><span class="ident" id="5969207">Stride</span><span class="op" id="5969213">,</span>&nbsp;<span class="ident" id="5969215">rgba</span><span class="op" id="5969219">.</span><span class="ident" id="5969220">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969227">}</span>&nbsp;<span class="keyword" id="5969229">else</span>&nbsp;<span class="keyword" id="5969234">if</span>&nbsp;<span class="ident" id="5969237">nrgba</span>&nbsp;<span class="op" id="5969243">!=</span>&nbsp;<span class="builtintype" id="5969246">nil</span>&nbsp;<span class="op" id="5969250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969256">stride</span><span class="op" id="5969262">,</span>&nbsp;<span class="ident" id="5969264">pix</span>&nbsp;<span class="op" id="5969268">=</span>&nbsp;<span class="ident" id="5969270">nrgba</span><span class="op" id="5969275">.</span><span class="ident" id="5969276">Stride</span><span class="op" id="5969282">,</span>&nbsp;<span class="ident" id="5969284">nrgba</span><span class="op" id="5969289">.</span><span class="ident" id="5969290">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969302">if</span>&nbsp;<span class="ident" id="5969305">stride</span>&nbsp;<span class="op" id="5969312">!=</span>&nbsp;<span class="num" id="5969315">0</span>&nbsp;<span class="op" id="5969317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969323">j0</span>&nbsp;<span class="op" id="5969326">:=</span>&nbsp;<span class="op" id="5969329">(</span><span class="ident" id="5969330">y</span>&nbsp;<span class="op" id="5969332">-</span>&nbsp;<span class="ident" id="5969334">b</span><span class="op" id="5969335">.</span><span class="ident" id="5969336">Min</span><span class="op" id="5969339">.</span><span class="ident" id="5969340">Y</span><span class="op" id="5969341">)</span>&nbsp;<span class="op" id="5969343">*</span>&nbsp;<span class="ident" id="5969345">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969356">j1</span>&nbsp;<span class="op" id="5969359">:=</span>&nbsp;<span class="ident" id="5969362">j0</span>&nbsp;<span class="op" id="5969365">+</span>&nbsp;<span class="ident" id="5969367">b</span><span class="op" id="5969368">.</span><span class="ident" id="5969369">Dx</span><span class="op" id="5969371">(</span><span class="op" id="5969372">)</span><span class="op" id="5969373">*</span><span class="num" id="5969374">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969380">for</span>&nbsp;<span class="ident" id="5969384">j</span>&nbsp;<span class="op" id="5969386">:=</span>&nbsp;<span class="ident" id="5969389">j0</span><span class="op" id="5969391">;</span>&nbsp;<span class="ident" id="5969393">j</span>&nbsp;<span class="op" id="5969395">&lt;</span>&nbsp;<span class="ident" id="5969397">j1</span><span class="op" id="5969399">;</span>&nbsp;<span class="ident" id="5969401">j</span>&nbsp;<span class="op" id="5969403">+=</span>&nbsp;<span class="num" id="5969406">4</span>&nbsp;<span class="op" id="5969408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969415">cr0</span><span class="op" id="5969418">[</span><span class="ident" id="5969419">i</span><span class="op" id="5969420">+</span><span class="num" id="5969421">0</span><span class="op" id="5969422">]</span>&nbsp;<span class="op" id="5969424">=</span>&nbsp;<span class="ident" id="5969426">pix</span><span class="op" id="5969429">[</span><span class="ident" id="5969430">j</span><span class="op" id="5969431">+</span><span class="num" id="5969432">0</span><span class="op" id="5969433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969440">cr0</span><span class="op" id="5969443">[</span><span class="ident" id="5969444">i</span><span class="op" id="5969445">+</span><span class="num" id="5969446">1</span><span class="op" id="5969447">]</span>&nbsp;<span class="op" id="5969449">=</span>&nbsp;<span class="ident" id="5969451">pix</span><span class="op" id="5969454">[</span><span class="ident" id="5969455">j</span><span class="op" id="5969456">+</span><span class="num" id="5969457">1</span><span class="op" id="5969458">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969465">cr0</span><span class="op" id="5969468">[</span><span class="ident" id="5969469">i</span><span class="op" id="5969470">+</span><span class="num" id="5969471">2</span><span class="op" id="5969472">]</span>&nbsp;<span class="op" id="5969474">=</span>&nbsp;<span class="ident" id="5969476">pix</span><span class="op" id="5969479">[</span><span class="ident" id="5969480">j</span><span class="op" id="5969481">+</span><span class="num" id="5969482">2</span><span class="op" id="5969483">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969490">i</span>&nbsp;<span class="op" id="5969492">+=</span>&nbsp;<span class="num" id="5969495">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969506">}</span>&nbsp;<span class="keyword" id="5969508">else</span>&nbsp;<span class="op" id="5969513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969519">for</span>&nbsp;<span class="ident" id="5969523">x</span>&nbsp;<span class="op" id="5969525">:=</span>&nbsp;<span class="ident" id="5969528">b</span><span class="op" id="5969529">.</span><span class="ident" id="5969530">Min</span><span class="op" id="5969533">.</span><span class="ident" id="5969534">X</span><span class="op" id="5969535">;</span>&nbsp;<span class="ident" id="5969537">x</span>&nbsp;<span class="op" id="5969539">&lt;</span>&nbsp;<span class="ident" id="5969541">b</span><span class="op" id="5969542">.</span><span class="ident" id="5969543">Max</span><span class="op" id="5969546">.</span><span class="ident" id="5969547">X</span><span class="op" id="5969548">;</span>&nbsp;<span class="ident" id="5969550">x</span><span class="op" id="5969551">++</span>&nbsp;<span class="op" id="5969554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969561">r</span><span class="op" id="5969562">,</span>&nbsp;<span class="ident" id="5969564">g</span><span class="op" id="5969565">,</span>&nbsp;<span class="ident" id="5969567">b</span><span class="op" id="5969568">,</span>&nbsp;<span class="ident" id="5969570">_</span>&nbsp;<span class="op" id="5969572">:=</span>&nbsp;<span class="ident" id="5969575">m</span><span class="op" id="5969576">.</span><span class="ident" id="5969577">At</span><span class="op" id="5969579">(</span><span class="ident" id="5969580">x</span><span class="op" id="5969581">,</span>&nbsp;<span class="ident" id="5969583">y</span><span class="op" id="5969584">)</span><span class="op" id="5969585">.</span><span class="ident" id="5969586">RGBA</span><span class="op" id="5969590">(</span><span class="op" id="5969591">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969598">cr0</span><span class="op" id="5969601">[</span><span class="ident" id="5969602">i</span><span class="op" id="5969603">+</span><span class="num" id="5969604">0</span><span class="op" id="5969605">]</span>&nbsp;<span class="op" id="5969607">=</span>&nbsp;<span class="builtintype" id="5969609">uint8</span><span class="op" id="5969614">(</span><span class="ident" id="5969615">r</span>&nbsp;<span class="op" id="5969617">&gt;&gt;</span>&nbsp;<span class="num" id="5969620">8</span><span class="op" id="5969621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969628">cr0</span><span class="op" id="5969631">[</span><span class="ident" id="5969632">i</span><span class="op" id="5969633">+</span><span class="num" id="5969634">1</span><span class="op" id="5969635">]</span>&nbsp;<span class="op" id="5969637">=</span>&nbsp;<span class="builtintype" id="5969639">uint8</span><span class="op" id="5969644">(</span><span class="ident" id="5969645">g</span>&nbsp;<span class="op" id="5969647">&gt;&gt;</span>&nbsp;<span class="num" id="5969650">8</span><span class="op" id="5969651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969658">cr0</span><span class="op" id="5969661">[</span><span class="ident" id="5969662">i</span><span class="op" id="5969663">+</span><span class="num" id="5969664">2</span><span class="op" id="5969665">]</span>&nbsp;<span class="op" id="5969667">=</span>&nbsp;<span class="builtintype" id="5969669">uint8</span><span class="op" id="5969674">(</span><span class="ident" id="5969675">b</span>&nbsp;<span class="op" id="5969677">&gt;&gt;</span>&nbsp;<span class="num" id="5969680">8</span><span class="op" id="5969681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969688">i</span>&nbsp;<span class="op" id="5969690">+=</span>&nbsp;<span class="num" id="5969693">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969699">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969708">case</span>&nbsp;<span class="ident" id="5969713">cbP8</span><span class="op" id="5969717">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969722">if</span>&nbsp;<span class="ident" id="5969725">paletted</span>&nbsp;<span class="op" id="5969734">!=</span>&nbsp;<span class="builtintype" id="5969737">nil</span>&nbsp;<span class="op" id="5969741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969747">offset</span>&nbsp;<span class="op" id="5969754">:=</span>&nbsp;<span class="op" id="5969757">(</span><span class="ident" id="5969758">y</span>&nbsp;<span class="op" id="5969760">-</span>&nbsp;<span class="ident" id="5969762">b</span><span class="op" id="5969763">.</span><span class="ident" id="5969764">Min</span><span class="op" id="5969767">.</span><span class="ident" id="5969768">Y</span><span class="op" id="5969769">)</span>&nbsp;<span class="op" id="5969771">*</span>&nbsp;<span class="ident" id="5969773">paletted</span><span class="op" id="5969781">.</span><span class="ident" id="5969782">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5969793">copy</span><span class="op" id="5969797">(</span><span class="ident" id="5969798">cr</span><span class="op" id="5969800">[</span><span class="num" id="5969801">0</span><span class="op" id="5969802">]</span><span class="op" id="5969803">[</span><span class="num" id="5969804">1</span><span class="op" id="5969805">:</span><span class="op" id="5969806">]</span><span class="op" id="5969807">,</span>&nbsp;<span class="ident" id="5969809">paletted</span><span class="op" id="5969817">.</span><span class="ident" id="5969818">Pix</span><span class="op" id="5969821">[</span><span class="ident" id="5969822">offset</span><span class="op" id="5969828">:</span><span class="ident" id="5969829">offset</span><span class="op" id="5969835">+</span><span class="ident" id="5969836">b</span><span class="op" id="5969837">.</span><span class="ident" id="5969838">Dx</span><span class="op" id="5969840">(</span><span class="op" id="5969841">)</span><span class="op" id="5969842">]</span><span class="op" id="5969843">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969848">}</span>&nbsp;<span class="keyword" id="5969850">else</span>&nbsp;<span class="op" id="5969855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969861">pi</span>&nbsp;<span class="op" id="5969864">:=</span>&nbsp;<span class="ident" id="5969867">m</span><span class="op" id="5969868">.</span><span class="op" id="5969869">(</span><span class="ident" id="5969870">image</span><span class="op" id="5969875">.</span><span class="ident" id="5969876">PalettedImage</span><span class="op" id="5969889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969895">for</span>&nbsp;<span class="ident" id="5969899">x</span>&nbsp;<span class="op" id="5969901">:=</span>&nbsp;<span class="ident" id="5969904">b</span><span class="op" id="5969905">.</span><span class="ident" id="5969906">Min</span><span class="op" id="5969909">.</span><span class="ident" id="5969910">X</span><span class="op" id="5969911">;</span>&nbsp;<span class="ident" id="5969913">x</span>&nbsp;<span class="op" id="5969915">&lt;</span>&nbsp;<span class="ident" id="5969917">b</span><span class="op" id="5969918">.</span><span class="ident" id="5969919">Max</span><span class="op" id="5969922">.</span><span class="ident" id="5969923">X</span><span class="op" id="5969924">;</span>&nbsp;<span class="ident" id="5969926">x</span><span class="op" id="5969927">++</span>&nbsp;<span class="op" id="5969930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969937">cr</span><span class="op" id="5969939">[</span><span class="num" id="5969940">0</span><span class="op" id="5969941">]</span><span class="op" id="5969942">[</span><span class="ident" id="5969943">i</span><span class="op" id="5969944">]</span>&nbsp;<span class="op" id="5969946">=</span>&nbsp;<span class="ident" id="5969948">pi</span><span class="op" id="5969950">.</span><span class="ident" id="5969951">ColorIndexAt</span><span class="op" id="5969963">(</span><span class="ident" id="5969964">x</span><span class="op" id="5969965">,</span>&nbsp;<span class="ident" id="5969967">y</span><span class="op" id="5969968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969975">i</span>&nbsp;<span class="op" id="5969977">+=</span>&nbsp;<span class="num" id="5969980">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969995">case</span>&nbsp;<span class="ident" id="5970000">cbTCA8</span><span class="op" id="5970006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970011">if</span>&nbsp;<span class="ident" id="5970014">nrgba</span>&nbsp;<span class="op" id="5970020">!=</span>&nbsp;<span class="builtintype" id="5970023">nil</span>&nbsp;<span class="op" id="5970027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970033">offset</span>&nbsp;<span class="op" id="5970040">:=</span>&nbsp;<span class="op" id="5970043">(</span><span class="ident" id="5970044">y</span>&nbsp;<span class="op" id="5970046">-</span>&nbsp;<span class="ident" id="5970048">b</span><span class="op" id="5970049">.</span><span class="ident" id="5970050">Min</span><span class="op" id="5970053">.</span><span class="ident" id="5970054">Y</span><span class="op" id="5970055">)</span>&nbsp;<span class="op" id="5970057">*</span>&nbsp;<span class="ident" id="5970059">nrgba</span><span class="op" id="5970064">.</span><span class="ident" id="5970065">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5970076">copy</span><span class="op" id="5970080">(</span><span class="ident" id="5970081">cr</span><span class="op" id="5970083">[</span><span class="num" id="5970084">0</span><span class="op" id="5970085">]</span><span class="op" id="5970086">[</span><span class="num" id="5970087">1</span><span class="op" id="5970088">:</span><span class="op" id="5970089">]</span><span class="op" id="5970090">,</span>&nbsp;<span class="ident" id="5970092">nrgba</span><span class="op" id="5970097">.</span><span class="ident" id="5970098">Pix</span><span class="op" id="5970101">[</span><span class="ident" id="5970102">offset</span><span class="op" id="5970108">:</span><span class="ident" id="5970109">offset</span><span class="op" id="5970115">+</span><span class="ident" id="5970116">b</span><span class="op" id="5970117">.</span><span class="ident" id="5970118">Dx</span><span class="op" id="5970120">(</span><span class="op" id="5970121">)</span><span class="op" id="5970122">*</span><span class="num" id="5970123">4</span><span class="op" id="5970124">]</span><span class="op" id="5970125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970130">}</span>&nbsp;<span class="keyword" id="5970132">else</span>&nbsp;<span class="op" id="5970137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970143">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970240">for</span>&nbsp;<span class="ident" id="5970244">x</span>&nbsp;<span class="op" id="5970246">:=</span>&nbsp;<span class="ident" id="5970249">b</span><span class="op" id="5970250">.</span><span class="ident" id="5970251">Min</span><span class="op" id="5970254">.</span><span class="ident" id="5970255">X</span><span class="op" id="5970256">;</span>&nbsp;<span class="ident" id="5970258">x</span>&nbsp;<span class="op" id="5970260">&lt;</span>&nbsp;<span class="ident" id="5970262">b</span><span class="op" id="5970263">.</span><span class="ident" id="5970264">Max</span><span class="op" id="5970267">.</span><span class="ident" id="5970268">X</span><span class="op" id="5970269">;</span>&nbsp;<span class="ident" id="5970271">x</span><span class="op" id="5970272">++</span>&nbsp;<span class="op" id="5970275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970282">c</span>&nbsp;<span class="op" id="5970284">:=</span>&nbsp;<span class="ident" id="5970287">color</span><span class="op" id="5970292">.</span><span class="ident" id="5970293">NRGBAModel</span><span class="op" id="5970303">.</span><span class="ident" id="5970304">Convert</span><span class="op" id="5970311">(</span><span class="ident" id="5970312">m</span><span class="op" id="5970313">.</span><span class="ident" id="5970314">At</span><span class="op" id="5970316">(</span><span class="ident" id="5970317">x</span><span class="op" id="5970318">,</span>&nbsp;<span class="ident" id="5970320">y</span><span class="op" id="5970321">)</span><span class="op" id="5970322">)</span><span class="op" id="5970323">.</span><span class="op" id="5970324">(</span><span class="ident" id="5970325">color</span><span class="op" id="5970330">.</span><span class="ident" id="5970331">NRGBA</span><span class="op" id="5970336">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970343">cr</span><span class="op" id="5970345">[</span><span class="num" id="5970346">0</span><span class="op" id="5970347">]</span><span class="op" id="5970348">[</span><span class="ident" id="5970349">i</span><span class="op" id="5970350">+</span><span class="num" id="5970351">0</span><span class="op" id="5970352">]</span>&nbsp;<span class="op" id="5970354">=</span>&nbsp;<span class="ident" id="5970356">c</span><span class="op" id="5970357">.</span><span class="ident" id="5970358">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970365">cr</span><span class="op" id="5970367">[</span><span class="num" id="5970368">0</span><span class="op" id="5970369">]</span><span class="op" id="5970370">[</span><span class="ident" id="5970371">i</span><span class="op" id="5970372">+</span><span class="num" id="5970373">1</span><span class="op" id="5970374">]</span>&nbsp;<span class="op" id="5970376">=</span>&nbsp;<span class="ident" id="5970378">c</span><span class="op" id="5970379">.</span><span class="ident" id="5970380">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970387">cr</span><span class="op" id="5970389">[</span><span class="num" id="5970390">0</span><span class="op" id="5970391">]</span><span class="op" id="5970392">[</span><span class="ident" id="5970393">i</span><span class="op" id="5970394">+</span><span class="num" id="5970395">2</span><span class="op" id="5970396">]</span>&nbsp;<span class="op" id="5970398">=</span>&nbsp;<span class="ident" id="5970400">c</span><span class="op" id="5970401">.</span><span class="ident" id="5970402">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970409">cr</span><span class="op" id="5970411">[</span><span class="num" id="5970412">0</span><span class="op" id="5970413">]</span><span class="op" id="5970414">[</span><span class="ident" id="5970415">i</span><span class="op" id="5970416">+</span><span class="num" id="5970417">3</span><span class="op" id="5970418">]</span>&nbsp;<span class="op" id="5970420">=</span>&nbsp;<span class="ident" id="5970422">c</span><span class="op" id="5970423">.</span><span class="ident" id="5970424">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970431">i</span>&nbsp;<span class="op" id="5970433">+=</span>&nbsp;<span class="num" id="5970436">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970451">case</span>&nbsp;<span class="ident" id="5970456">cbG16</span><span class="op" id="5970461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970466">for</span>&nbsp;<span class="ident" id="5970470">x</span>&nbsp;<span class="op" id="5970472">:=</span>&nbsp;<span class="ident" id="5970475">b</span><span class="op" id="5970476">.</span><span class="ident" id="5970477">Min</span><span class="op" id="5970480">.</span><span class="ident" id="5970481">X</span><span class="op" id="5970482">;</span>&nbsp;<span class="ident" id="5970484">x</span>&nbsp;<span class="op" id="5970486">&lt;</span>&nbsp;<span class="ident" id="5970488">b</span><span class="op" id="5970489">.</span><span class="ident" id="5970490">Max</span><span class="op" id="5970493">.</span><span class="ident" id="5970494">X</span><span class="op" id="5970495">;</span>&nbsp;<span class="ident" id="5970497">x</span><span class="op" id="5970498">++</span>&nbsp;<span class="op" id="5970501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970507">c</span>&nbsp;<span class="op" id="5970509">:=</span>&nbsp;<span class="ident" id="5970512">color</span><span class="op" id="5970517">.</span><span class="ident" id="5970518">Gray16Model</span><span class="op" id="5970529">.</span><span class="ident" id="5970530">Convert</span><span class="op" id="5970537">(</span><span class="ident" id="5970538">m</span><span class="op" id="5970539">.</span><span class="ident" id="5970540">At</span><span class="op" id="5970542">(</span><span class="ident" id="5970543">x</span><span class="op" id="5970544">,</span>&nbsp;<span class="ident" id="5970546">y</span><span class="op" id="5970547">)</span><span class="op" id="5970548">)</span><span class="op" id="5970549">.</span><span class="op" id="5970550">(</span><span class="ident" id="5970551">color</span><span class="op" id="5970556">.</span><span class="ident" id="5970557">Gray16</span><span class="op" id="5970563">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970569">cr</span><span class="op" id="5970571">[</span><span class="num" id="5970572">0</span><span class="op" id="5970573">]</span><span class="op" id="5970574">[</span><span class="ident" id="5970575">i</span><span class="op" id="5970576">+</span><span class="num" id="5970577">0</span><span class="op" id="5970578">]</span>&nbsp;<span class="op" id="5970580">=</span>&nbsp;<span class="builtintype" id="5970582">uint8</span><span class="op" id="5970587">(</span><span class="ident" id="5970588">c</span><span class="op" id="5970589">.</span><span class="ident" id="5970590">Y</span>&nbsp;<span class="op" id="5970592">&gt;&gt;</span>&nbsp;<span class="num" id="5970595">8</span><span class="op" id="5970596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970602">cr</span><span class="op" id="5970604">[</span><span class="num" id="5970605">0</span><span class="op" id="5970606">]</span><span class="op" id="5970607">[</span><span class="ident" id="5970608">i</span><span class="op" id="5970609">+</span><span class="num" id="5970610">1</span><span class="op" id="5970611">]</span>&nbsp;<span class="op" id="5970613">=</span>&nbsp;<span class="builtintype" id="5970615">uint8</span><span class="op" id="5970620">(</span><span class="ident" id="5970621">c</span><span class="op" id="5970622">.</span><span class="ident" id="5970623">Y</span><span class="op" id="5970624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970630">i</span>&nbsp;<span class="op" id="5970632">+=</span>&nbsp;<span class="num" id="5970635">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970644">case</span>&nbsp;<span class="ident" id="5970649">cbTC16</span><span class="op" id="5970655">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970660">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970732">for</span>&nbsp;<span class="ident" id="5970736">x</span>&nbsp;<span class="op" id="5970738">:=</span>&nbsp;<span class="ident" id="5970741">b</span><span class="op" id="5970742">.</span><span class="ident" id="5970743">Min</span><span class="op" id="5970746">.</span><span class="ident" id="5970747">X</span><span class="op" id="5970748">;</span>&nbsp;<span class="ident" id="5970750">x</span>&nbsp;<span class="op" id="5970752">&lt;</span>&nbsp;<span class="ident" id="5970754">b</span><span class="op" id="5970755">.</span><span class="ident" id="5970756">Max</span><span class="op" id="5970759">.</span><span class="ident" id="5970760">X</span><span class="op" id="5970761">;</span>&nbsp;<span class="ident" id="5970763">x</span><span class="op" id="5970764">++</span>&nbsp;<span class="op" id="5970767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970773">r</span><span class="op" id="5970774">,</span>&nbsp;<span class="ident" id="5970776">g</span><span class="op" id="5970777">,</span>&nbsp;<span class="ident" id="5970779">b</span><span class="op" id="5970780">,</span>&nbsp;<span class="ident" id="5970782">_</span>&nbsp;<span class="op" id="5970784">:=</span>&nbsp;<span class="ident" id="5970787">m</span><span class="op" id="5970788">.</span><span class="ident" id="5970789">At</span><span class="op" id="5970791">(</span><span class="ident" id="5970792">x</span><span class="op" id="5970793">,</span>&nbsp;<span class="ident" id="5970795">y</span><span class="op" id="5970796">)</span><span class="op" id="5970797">.</span><span class="ident" id="5970798">RGBA</span><span class="op" id="5970802">(</span><span class="op" id="5970803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970809">cr</span><span class="op" id="5970811">[</span><span class="num" id="5970812">0</span><span class="op" id="5970813">]</span><span class="op" id="5970814">[</span><span class="ident" id="5970815">i</span><span class="op" id="5970816">+</span><span class="num" id="5970817">0</span><span class="op" id="5970818">]</span>&nbsp;<span class="op" id="5970820">=</span>&nbsp;<span class="builtintype" id="5970822">uint8</span><span class="op" id="5970827">(</span><span class="ident" id="5970828">r</span>&nbsp;<span class="op" id="5970830">&gt;&gt;</span>&nbsp;<span class="num" id="5970833">8</span><span class="op" id="5970834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970840">cr</span><span class="op" id="5970842">[</span><span class="num" id="5970843">0</span><span class="op" id="5970844">]</span><span class="op" id="5970845">[</span><span class="ident" id="5970846">i</span><span class="op" id="5970847">+</span><span class="num" id="5970848">1</span><span class="op" id="5970849">]</span>&nbsp;<span class="op" id="5970851">=</span>&nbsp;<span class="builtintype" id="5970853">uint8</span><span class="op" id="5970858">(</span><span class="ident" id="5970859">r</span><span class="op" id="5970860">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970866">cr</span><span class="op" id="5970868">[</span><span class="num" id="5970869">0</span><span class="op" id="5970870">]</span><span class="op" id="5970871">[</span><span class="ident" id="5970872">i</span><span class="op" id="5970873">+</span><span class="num" id="5970874">2</span><span class="op" id="5970875">]</span>&nbsp;<span class="op" id="5970877">=</span>&nbsp;<span class="builtintype" id="5970879">uint8</span><span class="op" id="5970884">(</span><span class="ident" id="5970885">g</span>&nbsp;<span class="op" id="5970887">&gt;&gt;</span>&nbsp;<span class="num" id="5970890">8</span><span class="op" id="5970891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970897">cr</span><span class="op" id="5970899">[</span><span class="num" id="5970900">0</span><span class="op" id="5970901">]</span><span class="op" id="5970902">[</span><span class="ident" id="5970903">i</span><span class="op" id="5970904">+</span><span class="num" id="5970905">3</span><span class="op" id="5970906">]</span>&nbsp;<span class="op" id="5970908">=</span>&nbsp;<span class="builtintype" id="5970910">uint8</span><span class="op" id="5970915">(</span><span class="ident" id="5970916">g</span><span class="op" id="5970917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970923">cr</span><span class="op" id="5970925">[</span><span class="num" id="5970926">0</span><span class="op" id="5970927">]</span><span class="op" id="5970928">[</span><span class="ident" id="5970929">i</span><span class="op" id="5970930">+</span><span class="num" id="5970931">4</span><span class="op" id="5970932">]</span>&nbsp;<span class="op" id="5970934">=</span>&nbsp;<span class="builtintype" id="5970936">uint8</span><span class="op" id="5970941">(</span><span class="ident" id="5970942">b</span>&nbsp;<span class="op" id="5970944">&gt;&gt;</span>&nbsp;<span class="num" id="5970947">8</span><span class="op" id="5970948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970954">cr</span><span class="op" id="5970956">[</span><span class="num" id="5970957">0</span><span class="op" id="5970958">]</span><span class="op" id="5970959">[</span><span class="ident" id="5970960">i</span><span class="op" id="5970961">+</span><span class="num" id="5970962">5</span><span class="op" id="5970963">]</span>&nbsp;<span class="op" id="5970965">=</span>&nbsp;<span class="builtintype" id="5970967">uint8</span><span class="op" id="5970972">(</span><span class="ident" id="5970973">b</span><span class="op" id="5970974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970980">i</span>&nbsp;<span class="op" id="5970982">+=</span>&nbsp;<span class="num" id="5970985">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970994">case</span>&nbsp;<span class="ident" id="5970999">cbTCA16</span><span class="op" id="5971006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971011">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971107">for</span>&nbsp;<span class="ident" id="5971111">x</span>&nbsp;<span class="op" id="5971113">:=</span>&nbsp;<span class="ident" id="5971116">b</span><span class="op" id="5971117">.</span><span class="ident" id="5971118">Min</span><span class="op" id="5971121">.</span><span class="ident" id="5971122">X</span><span class="op" id="5971123">;</span>&nbsp;<span class="ident" id="5971125">x</span>&nbsp;<span class="op" id="5971127">&lt;</span>&nbsp;<span class="ident" id="5971129">b</span><span class="op" id="5971130">.</span><span class="ident" id="5971131">Max</span><span class="op" id="5971134">.</span><span class="ident" id="5971135">X</span><span class="op" id="5971136">;</span>&nbsp;<span class="ident" id="5971138">x</span><span class="op" id="5971139">++</span>&nbsp;<span class="op" id="5971142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971148">c</span>&nbsp;<span class="op" id="5971150">:=</span>&nbsp;<span class="ident" id="5971153">color</span><span class="op" id="5971158">.</span><span class="ident" id="5971159">NRGBA64Model</span><span class="op" id="5971171">.</span><span class="ident" id="5971172">Convert</span><span class="op" id="5971179">(</span><span class="ident" id="5971180">m</span><span class="op" id="5971181">.</span><span class="ident" id="5971182">At</span><span class="op" id="5971184">(</span><span class="ident" id="5971185">x</span><span class="op" id="5971186">,</span>&nbsp;<span class="ident" id="5971188">y</span><span class="op" id="5971189">)</span><span class="op" id="5971190">)</span><span class="op" id="5971191">.</span><span class="op" id="5971192">(</span><span class="ident" id="5971193">color</span><span class="op" id="5971198">.</span><span class="ident" id="5971199">NRGBA64</span><span class="op" id="5971206">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971212">cr</span><span class="op" id="5971214">[</span><span class="num" id="5971215">0</span><span class="op" id="5971216">]</span><span class="op" id="5971217">[</span><span class="ident" id="5971218">i</span><span class="op" id="5971219">+</span><span class="num" id="5971220">0</span><span class="op" id="5971221">]</span>&nbsp;<span class="op" id="5971223">=</span>&nbsp;<span class="builtintype" id="5971225">uint8</span><span class="op" id="5971230">(</span><span class="ident" id="5971231">c</span><span class="op" id="5971232">.</span><span class="ident" id="5971233">R</span>&nbsp;<span class="op" id="5971235">&gt;&gt;</span>&nbsp;<span class="num" id="5971238">8</span><span class="op" id="5971239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971245">cr</span><span class="op" id="5971247">[</span><span class="num" id="5971248">0</span><span class="op" id="5971249">]</span><span class="op" id="5971250">[</span><span class="ident" id="5971251">i</span><span class="op" id="5971252">+</span><span class="num" id="5971253">1</span><span class="op" id="5971254">]</span>&nbsp;<span class="op" id="5971256">=</span>&nbsp;<span class="builtintype" id="5971258">uint8</span><span class="op" id="5971263">(</span><span class="ident" id="5971264">c</span><span class="op" id="5971265">.</span><span class="ident" id="5971266">R</span><span class="op" id="5971267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971273">cr</span><span class="op" id="5971275">[</span><span class="num" id="5971276">0</span><span class="op" id="5971277">]</span><span class="op" id="5971278">[</span><span class="ident" id="5971279">i</span><span class="op" id="5971280">+</span><span class="num" id="5971281">2</span><span class="op" id="5971282">]</span>&nbsp;<span class="op" id="5971284">=</span>&nbsp;<span class="builtintype" id="5971286">uint8</span><span class="op" id="5971291">(</span><span class="ident" id="5971292">c</span><span class="op" id="5971293">.</span><span class="ident" id="5971294">G</span>&nbsp;<span class="op" id="5971296">&gt;&gt;</span>&nbsp;<span class="num" id="5971299">8</span><span class="op" id="5971300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971306">cr</span><span class="op" id="5971308">[</span><span class="num" id="5971309">0</span><span class="op" id="5971310">]</span><span class="op" id="5971311">[</span><span class="ident" id="5971312">i</span><span class="op" id="5971313">+</span><span class="num" id="5971314">3</span><span class="op" id="5971315">]</span>&nbsp;<span class="op" id="5971317">=</span>&nbsp;<span class="builtintype" id="5971319">uint8</span><span class="op" id="5971324">(</span><span class="ident" id="5971325">c</span><span class="op" id="5971326">.</span><span class="ident" id="5971327">G</span><span class="op" id="5971328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971334">cr</span><span class="op" id="5971336">[</span><span class="num" id="5971337">0</span><span class="op" id="5971338">]</span><span class="op" id="5971339">[</span><span class="ident" id="5971340">i</span><span class="op" id="5971341">+</span><span class="num" id="5971342">4</span><span class="op" id="5971343">]</span>&nbsp;<span class="op" id="5971345">=</span>&nbsp;<span class="builtintype" id="5971347">uint8</span><span class="op" id="5971352">(</span><span class="ident" id="5971353">c</span><span class="op" id="5971354">.</span><span class="ident" id="5971355">B</span>&nbsp;<span class="op" id="5971357">&gt;&gt;</span>&nbsp;<span class="num" id="5971360">8</span><span class="op" id="5971361">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971367">cr</span><span class="op" id="5971369">[</span><span class="num" id="5971370">0</span><span class="op" id="5971371">]</span><span class="op" id="5971372">[</span><span class="ident" id="5971373">i</span><span class="op" id="5971374">+</span><span class="num" id="5971375">5</span><span class="op" id="5971376">]</span>&nbsp;<span class="op" id="5971378">=</span>&nbsp;<span class="builtintype" id="5971380">uint8</span><span class="op" id="5971385">(</span><span class="ident" id="5971386">c</span><span class="op" id="5971387">.</span><span class="ident" id="5971388">B</span><span class="op" id="5971389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971395">cr</span><span class="op" id="5971397">[</span><span class="num" id="5971398">0</span><span class="op" id="5971399">]</span><span class="op" id="5971400">[</span><span class="ident" id="5971401">i</span><span class="op" id="5971402">+</span><span class="num" id="5971403">6</span><span class="op" id="5971404">]</span>&nbsp;<span class="op" id="5971406">=</span>&nbsp;<span class="builtintype" id="5971408">uint8</span><span class="op" id="5971413">(</span><span class="ident" id="5971414">c</span><span class="op" id="5971415">.</span><span class="ident" id="5971416">A</span>&nbsp;<span class="op" id="5971418">&gt;&gt;</span>&nbsp;<span class="num" id="5971421">8</span><span class="op" id="5971422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971428">cr</span><span class="op" id="5971430">[</span><span class="num" id="5971431">0</span><span class="op" id="5971432">]</span><span class="op" id="5971433">[</span><span class="ident" id="5971434">i</span><span class="op" id="5971435">+</span><span class="num" id="5971436">7</span><span class="op" id="5971437">]</span>&nbsp;<span class="op" id="5971439">=</span>&nbsp;<span class="builtintype" id="5971441">uint8</span><span class="op" id="5971446">(</span><span class="ident" id="5971447">c</span><span class="op" id="5971448">.</span><span class="ident" id="5971449">A</span><span class="op" id="5971450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971456">i</span>&nbsp;<span class="op" id="5971458">+=</span>&nbsp;<span class="num" id="5971461">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971466">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971475">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971498">f</span>&nbsp;<span class="op" id="5971500">:=</span>&nbsp;<span class="ident" id="5971503">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971512">if</span>&nbsp;<span class="ident" id="5971515">level</span>&nbsp;<span class="op" id="5971521">!=</span>&nbsp;<span class="ident" id="5971524">zlib</span><span class="op" id="5971528">.</span><span class="ident" id="5971529">NoCompression</span>&nbsp;<span class="op" id="5971543">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971548">f</span>&nbsp;<span class="op" id="5971550">=</span>&nbsp;<span class="ident" id="5971552">filter</span><span class="op" id="5971558">(</span><span class="op" id="5971559">&amp;</span><span class="ident" id="5971560">cr</span><span class="op" id="5971562">,</span>&nbsp;<span class="ident" id="5971564">pr</span><span class="op" id="5971566">,</span>&nbsp;<span class="ident" id="5971568">bpp</span><span class="op" id="5971571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971580">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971613">if</span>&nbsp;<span class="ident" id="5971616">_</span><span class="op" id="5971617">,</span>&nbsp;<span class="ident" id="5971619">err</span>&nbsp;<span class="op" id="5971623">:=</span>&nbsp;<span class="ident" id="5971626">zw</span><span class="op" id="5971628">.</span><span class="ident" id="5971629">Write</span><span class="op" id="5971634">(</span><span class="ident" id="5971635">cr</span><span class="op" id="5971637">[</span><span class="ident" id="5971638">f</span><span class="op" id="5971639">]</span><span class="op" id="5971640">)</span><span class="op" id="5971641">;</span>&nbsp;<span class="ident" id="5971643">err</span>&nbsp;<span class="op" id="5971647">!=</span>&nbsp;<span class="builtintype" id="5971650">nil</span>&nbsp;<span class="op" id="5971654">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971659">return</span>&nbsp;<span class="ident" id="5971666">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971677">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971733">pr</span><span class="op" id="5971735">,</span>&nbsp;<span class="ident" id="5971737">cr</span><span class="op" id="5971739">[</span><span class="num" id="5971740">0</span><span class="op" id="5971741">]</span>&nbsp;<span class="op" id="5971743">=</span>&nbsp;<span class="ident" id="5971745">cr</span><span class="op" id="5971747">[</span><span class="num" id="5971748">0</span><span class="op" id="5971749">]</span><span class="op" id="5971750">,</span>&nbsp;<span class="ident" id="5971752">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971759">return</span>&nbsp;<span class="builtintype" id="5971766">nil</span><br>
<span class="lineno"></span><span class="op" id="5971770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5971773">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5971832">func</span>&nbsp;<span class="op" id="5971837">(</span><span class="ident" id="5971838">e</span>&nbsp;<span class="op" id="5971840">*</span><span class="ident" id="5971841">encoder</span><span class="op" id="5971848">)</span>&nbsp;<span class="ident" id="5971850">writeIDATs</span><span class="op" id="5971860">(</span><span class="op" id="5971861">)</span>&nbsp;<span class="op" id="5971863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971866">if</span>&nbsp;<span class="ident" id="5971869">e</span><span class="op" id="5971870">.</span><span class="ident" id="5971871">err</span>&nbsp;<span class="op" id="5971875">!=</span>&nbsp;<span class="builtintype" id="5971878">nil</span>&nbsp;<span class="op" id="5971882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971886">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971897">var</span>&nbsp;<span class="ident" id="5971901">bw</span>&nbsp;<span class="op" id="5971904">*</span><span class="ident" id="5971905">bufio</span><span class="op" id="5971910">.</span><span class="ident" id="5971911">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971919">bw</span>&nbsp;<span class="op" id="5971922">=</span>&nbsp;<span class="ident" id="5971924">bufio</span><span class="op" id="5971929">.</span><span class="ident" id="5971930">NewWriterSize</span><span class="op" id="5971943">(</span><span class="ident" id="5971944">e</span><span class="op" id="5971945">,</span>&nbsp;<span class="num" id="5971947">1</span><span class="op" id="5971948">&lt;&lt;</span><span class="num" id="5971950">15</span><span class="op" id="5971952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971955">e</span><span class="op" id="5971956">.</span><span class="ident" id="5971957">err</span>&nbsp;<span class="op" id="5971961">=</span>&nbsp;<span class="ident" id="5971963">writeImage</span><span class="op" id="5971973">(</span><span class="ident" id="5971974">bw</span><span class="op" id="5971976">,</span>&nbsp;<span class="ident" id="5971978">e</span><span class="op" id="5971979">.</span><span class="ident" id="5971980">m</span><span class="op" id="5971981">,</span>&nbsp;<span class="ident" id="5971983">e</span><span class="op" id="5971984">.</span><span class="ident" id="5971985">cb</span><span class="op" id="5971987">,</span>&nbsp;<span class="ident" id="5971989">levelToZlib</span><span class="op" id="5972000">(</span><span class="ident" id="5972001">e</span><span class="op" id="5972002">.</span><span class="ident" id="5972003">enc</span><span class="op" id="5972006">.</span><span class="ident" id="5972007">CompressionLevel</span><span class="op" id="5972023">)</span><span class="op" id="5972024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972027">if</span>&nbsp;<span class="ident" id="5972030">e</span><span class="op" id="5972031">.</span><span class="ident" id="5972032">err</span>&nbsp;<span class="op" id="5972036">!=</span>&nbsp;<span class="builtintype" id="5972039">nil</span>&nbsp;<span class="op" id="5972043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972047">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972055">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972058">e</span><span class="op" id="5972059">.</span><span class="ident" id="5972060">err</span>&nbsp;<span class="op" id="5972064">=</span>&nbsp;<span class="ident" id="5972066">bw</span><span class="op" id="5972068">.</span><span class="ident" id="5972069">Flush</span><span class="op" id="5972074">(</span><span class="op" id="5972075">)</span><br>
<span class="lineno"></span><span class="op" id="5972077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5972080">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5972143">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5972206">func</span>&nbsp;<span class="ident" id="5972211">levelToZlib</span><span class="op" id="5972222">(</span><span class="ident" id="5972223">l</span>&nbsp;<span class="ident" id="5972225">CompressionLevel</span><span class="op" id="5972241">)</span>&nbsp;<span class="builtintype" id="5972243">int</span>&nbsp;<span class="op" id="5972247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972250">switch</span>&nbsp;<span class="ident" id="5972257">l</span>&nbsp;<span class="op" id="5972259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972262">case</span>&nbsp;<span class="ident" id="5972267">DefaultCompression</span><span class="op" id="5972285">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972289">return</span>&nbsp;<span class="ident" id="5972296">zlib</span><span class="op" id="5972300">.</span><span class="ident" id="5972301">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972321">case</span>&nbsp;<span class="ident" id="5972326">NoCompression</span><span class="op" id="5972339">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972343">return</span>&nbsp;<span class="ident" id="5972350">zlib</span><span class="op" id="5972354">.</span><span class="ident" id="5972355">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972370">case</span>&nbsp;<span class="ident" id="5972375">BestSpeed</span><span class="op" id="5972384">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972388">return</span>&nbsp;<span class="ident" id="5972395">zlib</span><span class="op" id="5972399">.</span><span class="ident" id="5972400">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972411">case</span>&nbsp;<span class="ident" id="5972416">BestCompression</span><span class="op" id="5972431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972435">return</span>&nbsp;<span class="ident" id="5972442">zlib</span><span class="op" id="5972446">.</span><span class="ident" id="5972447">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972464">default</span><span class="op" id="5972471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972475">return</span>&nbsp;<span class="ident" id="5972482">zlib</span><span class="op" id="5972486">.</span><span class="ident" id="5972487">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972507">}</span><br>
<span class="lineno"></span><span class="op" id="5972509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5972512">func</span>&nbsp;<span class="op" id="5972517">(</span><span class="ident" id="5972518">e</span>&nbsp;<span class="op" id="5972520">*</span><span class="ident" id="5972521">encoder</span><span class="op" id="5972528">)</span>&nbsp;<span class="ident" id="5972530">writeIEND</span><span class="op" id="5972539">(</span><span class="op" id="5972540">)</span>&nbsp;<span class="op" id="5972542">{</span>&nbsp;<span class="ident" id="5972544">e</span><span class="op" id="5972545">.</span><span class="ident" id="5972546">writeChunk</span><span class="op" id="5972556">(</span><span class="builtintype" id="5972557">nil</span><span class="op" id="5972560">,</span>&nbsp;<span class="string" id="5972562">&#34;IEND&#34;</span><span class="op" id="5972568">)</span>&nbsp;<span class="op" id="5972570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5972573">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5972639">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5972713">func</span>&nbsp;<span class="ident" id="5972718">Encode</span><span class="op" id="5972724">(</span><span class="ident" id="5972725">w</span>&nbsp;<span class="ident" id="5972727">io</span><span class="op" id="5972729">.</span><span class="ident" id="5972730">Writer</span><span class="op" id="5972736">,</span>&nbsp;<span class="ident" id="5972738">m</span>&nbsp;<span class="ident" id="5972740">image</span><span class="op" id="5972745">.</span><span class="ident" id="5972746">Image</span><span class="op" id="5972751">)</span>&nbsp;<span class="builtintype" id="5972753">error</span>&nbsp;<span class="op" id="5972759">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972762">var</span>&nbsp;<span class="ident" id="5972766">e</span>&nbsp;<span class="ident" id="5972768">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972777">return</span>&nbsp;<span class="ident" id="5972784">e</span><span class="op" id="5972785">.</span><span class="ident" id="5972786">Encode</span><span class="op" id="5972792">(</span><span class="ident" id="5972793">w</span><span class="op" id="5972794">,</span>&nbsp;<span class="ident" id="5972796">m</span><span class="op" id="5972797">)</span><br>
<span class="lineno"></span><span class="op" id="5972799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5972802">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5972851">func</span>&nbsp;<span class="op" id="5972856">(</span><span class="ident" id="5972857">enc</span>&nbsp;<span class="op" id="5972861">*</span><span class="ident" id="5972862">Encoder</span><span class="op" id="5972869">)</span>&nbsp;<span class="ident" id="5972871">Encode</span><span class="op" id="5972877">(</span><span class="ident" id="5972878">w</span>&nbsp;<span class="ident" id="5972880">io</span><span class="op" id="5972882">.</span><span class="ident" id="5972883">Writer</span><span class="op" id="5972889">,</span>&nbsp;<span class="ident" id="5972891">m</span>&nbsp;<span class="ident" id="5972893">image</span><span class="op" id="5972898">.</span><span class="ident" id="5972899">Image</span><span class="op" id="5972904">)</span>&nbsp;<span class="builtintype" id="5972906">error</span>&nbsp;<span class="op" id="5972912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5972915">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5972992">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5973072">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973091">mw</span><span class="op" id="5973093">,</span>&nbsp;<span class="ident" id="5973095">mh</span>&nbsp;<span class="op" id="5973098">:=</span>&nbsp;<span class="ident" id="5973101">int64</span><span class="op" id="5973106">(</span><span class="ident" id="5973107">m</span><span class="op" id="5973108">.</span><span class="ident" id="5973109">Bounds</span><span class="op" id="5973115">(</span><span class="op" id="5973116">)</span><span class="op" id="5973117">.</span><span class="ident" id="5973118">Dx</span><span class="op" id="5973120">(</span><span class="op" id="5973121">)</span><span class="op" id="5973122">)</span><span class="op" id="5973123">,</span>&nbsp;<span class="ident" id="5973125">int64</span><span class="op" id="5973130">(</span><span class="ident" id="5973131">m</span><span class="op" id="5973132">.</span><span class="ident" id="5973133">Bounds</span><span class="op" id="5973139">(</span><span class="op" id="5973140">)</span><span class="op" id="5973141">.</span><span class="ident" id="5973142">Dy</span><span class="op" id="5973144">(</span><span class="op" id="5973145">)</span><span class="op" id="5973146">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973149">if</span>&nbsp;<span class="ident" id="5973152">mw</span>&nbsp;<span class="op" id="5973155">&lt;=</span>&nbsp;<span class="num" id="5973158">0</span>&nbsp;<span class="op" id="5973160">||</span>&nbsp;<span class="ident" id="5973163">mh</span>&nbsp;<span class="op" id="5973166">&lt;=</span>&nbsp;<span class="num" id="5973169">0</span>&nbsp;<span class="op" id="5973171">||</span>&nbsp;<span class="ident" id="5973174">mw</span>&nbsp;<span class="op" id="5973177">&gt;=</span>&nbsp;<span class="num" id="5973180">1</span><span class="op" id="5973181">&lt;&lt;</span><span class="num" id="5973183">32</span>&nbsp;<span class="op" id="5973186">||</span>&nbsp;<span class="ident" id="5973189">mh</span>&nbsp;<span class="op" id="5973192">&gt;=</span>&nbsp;<span class="num" id="5973195">1</span><span class="op" id="5973196">&lt;&lt;</span><span class="num" id="5973198">32</span>&nbsp;<span class="op" id="5973201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973205">return</span>&nbsp;<span class="ident" id="5973212">FormatError</span><span class="op" id="5973223">(</span><span class="string" id="5973224">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5973247">+</span>&nbsp;<span class="ident" id="5973249">strconv</span><span class="op" id="5973256">.</span><span class="ident" id="5973257">FormatInt</span><span class="op" id="5973266">(</span><span class="ident" id="5973267">mw</span><span class="op" id="5973269">,</span>&nbsp;<span class="num" id="5973271">10</span><span class="op" id="5973273">)</span>&nbsp;<span class="op" id="5973275">+</span>&nbsp;<span class="string" id="5973277">&#34;x&#34;</span>&nbsp;<span class="op" id="5973281">+</span>&nbsp;<span class="ident" id="5973283">strconv</span><span class="op" id="5973290">.</span><span class="ident" id="5973291">FormatInt</span><span class="op" id="5973300">(</span><span class="ident" id="5973301">mh</span><span class="op" id="5973303">,</span>&nbsp;<span class="num" id="5973305">10</span><span class="op" id="5973307">)</span><span class="op" id="5973308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973315">var</span>&nbsp;<span class="ident" id="5973319">e</span>&nbsp;<span class="ident" id="5973321">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973330">e</span><span class="op" id="5973331">.</span><span class="ident" id="5973332">enc</span>&nbsp;<span class="op" id="5973336">=</span>&nbsp;<span class="ident" id="5973338">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973343">e</span><span class="op" id="5973344">.</span><span class="ident" id="5973345">w</span>&nbsp;<span class="op" id="5973347">=</span>&nbsp;<span class="ident" id="5973349">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973352">e</span><span class="op" id="5973353">.</span><span class="ident" id="5973354">m</span>&nbsp;<span class="op" id="5973356">=</span>&nbsp;<span class="ident" id="5973358">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973362">var</span>&nbsp;<span class="ident" id="5973366">pal</span>&nbsp;<span class="ident" id="5973370">color</span><span class="op" id="5973375">.</span><span class="ident" id="5973376">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5973385">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973446">if</span>&nbsp;<span class="ident" id="5973449">_</span><span class="op" id="5973450">,</span>&nbsp;<span class="ident" id="5973452">ok</span>&nbsp;<span class="op" id="5973455">:=</span>&nbsp;<span class="ident" id="5973458">m</span><span class="op" id="5973459">.</span><span class="op" id="5973460">(</span><span class="ident" id="5973461">image</span><span class="op" id="5973466">.</span><span class="ident" id="5973467">PalettedImage</span><span class="op" id="5973480">)</span><span class="op" id="5973481">;</span>&nbsp;<span class="ident" id="5973483">ok</span>&nbsp;<span class="op" id="5973486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973490">pal</span><span class="op" id="5973493">,</span>&nbsp;<span class="ident" id="5973495">_</span>&nbsp;<span class="op" id="5973497">=</span>&nbsp;<span class="ident" id="5973499">m</span><span class="op" id="5973500">.</span><span class="ident" id="5973501">ColorModel</span><span class="op" id="5973511">(</span><span class="op" id="5973512">)</span><span class="op" id="5973513">.</span><span class="op" id="5973514">(</span><span class="ident" id="5973515">color</span><span class="op" id="5973520">.</span><span class="ident" id="5973521">Palette</span><span class="op" id="5973528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973534">if</span>&nbsp;<span class="ident" id="5973537">pal</span>&nbsp;<span class="op" id="5973541">!=</span>&nbsp;<span class="builtintype" id="5973544">nil</span>&nbsp;<span class="op" id="5973548">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973552">e</span><span class="op" id="5973553">.</span><span class="ident" id="5973554">cb</span>&nbsp;<span class="op" id="5973557">=</span>&nbsp;<span class="ident" id="5973559">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973565">}</span>&nbsp;<span class="keyword" id="5973567">else</span>&nbsp;<span class="op" id="5973572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973576">switch</span>&nbsp;<span class="ident" id="5973583">m</span><span class="op" id="5973584">.</span><span class="ident" id="5973585">ColorModel</span><span class="op" id="5973595">(</span><span class="op" id="5973596">)</span>&nbsp;<span class="op" id="5973598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973602">case</span>&nbsp;<span class="ident" id="5973607">color</span><span class="op" id="5973612">.</span><span class="ident" id="5973613">GrayModel</span><span class="op" id="5973622">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973627">e</span><span class="op" id="5973628">.</span><span class="ident" id="5973629">cb</span>&nbsp;<span class="op" id="5973632">=</span>&nbsp;<span class="ident" id="5973634">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973641">case</span>&nbsp;<span class="ident" id="5973646">color</span><span class="op" id="5973651">.</span><span class="ident" id="5973652">Gray16Model</span><span class="op" id="5973663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973668">e</span><span class="op" id="5973669">.</span><span class="ident" id="5973670">cb</span>&nbsp;<span class="op" id="5973673">=</span>&nbsp;<span class="ident" id="5973675">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973683">case</span>&nbsp;<span class="ident" id="5973688">color</span><span class="op" id="5973693">.</span><span class="ident" id="5973694">RGBAModel</span><span class="op" id="5973703">,</span>&nbsp;<span class="ident" id="5973705">color</span><span class="op" id="5973710">.</span><span class="ident" id="5973711">NRGBAModel</span><span class="op" id="5973721">,</span>&nbsp;<span class="ident" id="5973723">color</span><span class="op" id="5973728">.</span><span class="ident" id="5973729">AlphaModel</span><span class="op" id="5973739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973744">if</span>&nbsp;<span class="ident" id="5973747">opaque</span><span class="op" id="5973753">(</span><span class="ident" id="5973754">m</span><span class="op" id="5973755">)</span>&nbsp;<span class="op" id="5973757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973763">e</span><span class="op" id="5973764">.</span><span class="ident" id="5973765">cb</span>&nbsp;<span class="op" id="5973768">=</span>&nbsp;<span class="ident" id="5973770">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973779">}</span>&nbsp;<span class="keyword" id="5973781">else</span>&nbsp;<span class="op" id="5973786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973792">e</span><span class="op" id="5973793">.</span><span class="ident" id="5973794">cb</span>&nbsp;<span class="op" id="5973797">=</span>&nbsp;<span class="ident" id="5973799">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973813">default</span><span class="op" id="5973820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973825">if</span>&nbsp;<span class="ident" id="5973828">opaque</span><span class="op" id="5973834">(</span><span class="ident" id="5973835">m</span><span class="op" id="5973836">)</span>&nbsp;<span class="op" id="5973838">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973844">e</span><span class="op" id="5973845">.</span><span class="ident" id="5973846">cb</span>&nbsp;<span class="op" id="5973849">=</span>&nbsp;<span class="ident" id="5973851">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973861">}</span>&nbsp;<span class="keyword" id="5973863">else</span>&nbsp;<span class="op" id="5973868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973874">e</span><span class="op" id="5973875">.</span><span class="ident" id="5973876">cb</span>&nbsp;<span class="op" id="5973879">=</span>&nbsp;<span class="ident" id="5973881">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973896">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973903">_</span><span class="op" id="5973904">,</span>&nbsp;<span class="ident" id="5973906">e</span><span class="op" id="5973907">.</span><span class="ident" id="5973908">err</span>&nbsp;<span class="op" id="5973912">=</span>&nbsp;<span class="ident" id="5973914">io</span><span class="op" id="5973916">.</span><span class="ident" id="5973917">WriteString</span><span class="op" id="5973928">(</span><span class="ident" id="5973929">w</span><span class="op" id="5973930">,</span>&nbsp;<span class="ident" id="5973932">pngHeader</span><span class="op" id="5973941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973944">e</span><span class="op" id="5973945">.</span><span class="ident" id="5973946">writeIHDR</span><span class="op" id="5973955">(</span><span class="op" id="5973956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973959">if</span>&nbsp;<span class="ident" id="5973962">pal</span>&nbsp;<span class="op" id="5973966">!=</span>&nbsp;<span class="builtintype" id="5973969">nil</span>&nbsp;<span class="op" id="5973973">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973977">e</span><span class="op" id="5973978">.</span><span class="ident" id="5973979">writePLTEAndTRNS</span><span class="op" id="5973995">(</span><span class="ident" id="5973996">pal</span><span class="op" id="5973999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974005">e</span><span class="op" id="5974006">.</span><span class="ident" id="5974007">writeIDATs</span><span class="op" id="5974017">(</span><span class="op" id="5974018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974021">e</span><span class="op" id="5974022">.</span><span class="ident" id="5974023">writeIEND</span><span class="op" id="5974032">(</span><span class="op" id="5974033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974036">return</span>&nbsp;<span class="ident" id="5974043">e</span><span class="op" id="5974044">.</span><span class="ident" id="5974045">err</span><br>
<span class="lineno">530</span><span class="op" id="5974049">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
