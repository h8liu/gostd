<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html" class="current">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6375353">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6375408">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6375462">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6375513">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="6375562">package</span>&nbsp;<span class="ident" id="6375570">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6375577">import</span>&nbsp;<span class="string" id="6375584">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6375590">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="6375669">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="6375720">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="6375776">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="6375824">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6375892">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="6375918">type</span>&nbsp;<span class="ident" id="6375923">StructuralError</span>&nbsp;<span class="builtintype" id="6375939">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6375947">func</span>&nbsp;<span class="op" id="6375952">(</span><span class="ident" id="6375953">s</span>&nbsp;<span class="ident" id="6375955">StructuralError</span><span class="op" id="6375970">)</span>&nbsp;<span class="ident" id="6375972">Error</span><span class="op" id="6375977">(</span><span class="op" id="6375978">)</span>&nbsp;<span class="builtintype" id="6375980">string</span>&nbsp;<span class="op" id="6375987">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375990">return</span>&nbsp;<span class="string" id="6375997">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="6376020">+</span>&nbsp;<span class="builtintype" id="6376022">string</span><span class="op" id="6376028">(</span><span class="ident" id="6376029">s</span><span class="op" id="6376030">)</span><br>
<span class="lineno"></span><span class="op" id="6376032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6376035">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6376083">type</span>&nbsp;<span class="ident" id="6376088">reader</span>&nbsp;<span class="keyword" id="6376095">struct</span>&nbsp;<span class="op" id="6376102">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376105">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6376118">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376129">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376142">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376150">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376163">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376171">wantBlockCRC</span>&nbsp;<span class="builtintype" id="6376184">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376192">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376205">bool</span>&nbsp;<span class="comment" id="6376210">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376255">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376268">int</span>&nbsp;&nbsp;<span class="comment" id="6376273">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376314">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376327">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376333">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376346">[</span><span class="op" id="6376347">]</span><span class="builtintype" id="6376348">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6376356">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376401">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376414">[</span><span class="num" id="6376415">256</span><span class="op" id="6376418">]</span><span class="builtintype" id="6376419">uint</span>&nbsp;<span class="comment" id="6376424">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376463">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376476">[</span><span class="op" id="6376477">]</span><span class="builtintype" id="6376478">uint32</span>&nbsp;&nbsp;<span class="comment" id="6376486">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376580">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376593">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6376603">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376645">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6376657">[</span><span class="op" id="6376658">]</span><span class="builtintype" id="6376659">uint32</span>&nbsp;<span class="comment" id="6376666">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376715">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="6376727">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6376736">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376774">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376786">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6376795">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376825">byteRepeats</span>&nbsp;<span class="builtintype" id="6376837">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6376846">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376890">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6376902">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6376911">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="6376958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6376961">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="6377033">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="6377080">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6377142">func</span>&nbsp;<span class="ident" id="6377147">NewReader</span><span class="op" id="6377156">(</span><span class="ident" id="6377157">r</span>&nbsp;<span class="ident" id="6377159">io</span><span class="op" id="6377161">.</span><span class="ident" id="6377162">Reader</span><span class="op" id="6377168">)</span>&nbsp;<span class="ident" id="6377170">io</span><span class="op" id="6377172">.</span><span class="ident" id="6377173">Reader</span>&nbsp;<span class="op" id="6377180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377183">bz2</span>&nbsp;<span class="op" id="6377187">:=</span>&nbsp;<span class="builtinfunc" id="6377190">new</span><span class="op" id="6377193">(</span><span class="ident" id="6377194">reader</span><span class="op" id="6377200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377203">bz2</span><span class="op" id="6377206">.</span><span class="ident" id="6377207">br</span>&nbsp;<span class="op" id="6377210">=</span>&nbsp;<span class="ident" id="6377212">newBitReader</span><span class="op" id="6377224">(</span><span class="ident" id="6377225">r</span><span class="op" id="6377226">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377229">return</span>&nbsp;<span class="ident" id="6377236">bz2</span><br>
<span class="lineno"></span><span class="op" id="6377240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6377243">const</span>&nbsp;<span class="ident" id="6377249">bzip2FileMagic</span>&nbsp;<span class="op" id="6377264">=</span>&nbsp;<span class="num" id="6377266">0x425a</span>&nbsp;<span class="comment" id="6377273">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6377281">const</span>&nbsp;<span class="ident" id="6377287">bzip2BlockMagic</span>&nbsp;<span class="op" id="6377303">=</span>&nbsp;<span class="num" id="6377305">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="6377320">const</span>&nbsp;<span class="ident" id="6377326">bzip2FinalMagic</span>&nbsp;<span class="op" id="6377342">=</span>&nbsp;<span class="num" id="6377344">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6377360">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6377394">func</span>&nbsp;<span class="op" id="6377399">(</span><span class="ident" id="6377400">bz2</span>&nbsp;<span class="op" id="6377404">*</span><span class="ident" id="6377405">reader</span><span class="op" id="6377411">)</span>&nbsp;<span class="ident" id="6377413">setup</span><span class="op" id="6377418">(</span><span class="ident" id="6377419">needMagic</span>&nbsp;<span class="builtintype" id="6377429">bool</span><span class="op" id="6377433">)</span>&nbsp;<span class="builtintype" id="6377435">error</span>&nbsp;<span class="op" id="6377441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377444">br</span>&nbsp;<span class="op" id="6377447">:=</span>&nbsp;<span class="op" id="6377450">&amp;</span><span class="ident" id="6377451">bz2</span><span class="op" id="6377454">.</span><span class="ident" id="6377455">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377460">if</span>&nbsp;<span class="ident" id="6377463">needMagic</span>&nbsp;<span class="op" id="6377473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377477">magic</span>&nbsp;<span class="op" id="6377483">:=</span>&nbsp;<span class="ident" id="6377486">br</span><span class="op" id="6377488">.</span><span class="ident" id="6377489">ReadBits</span><span class="op" id="6377497">(</span><span class="num" id="6377498">16</span><span class="op" id="6377500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377504">if</span>&nbsp;<span class="ident" id="6377507">magic</span>&nbsp;<span class="op" id="6377513">!=</span>&nbsp;<span class="ident" id="6377516">bzip2FileMagic</span>&nbsp;<span class="op" id="6377531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377536">return</span>&nbsp;<span class="ident" id="6377543">StructuralError</span><span class="op" id="6377558">(</span><span class="string" id="6377559">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="6377576">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377587">t</span>&nbsp;<span class="op" id="6377589">:=</span>&nbsp;<span class="ident" id="6377592">br</span><span class="op" id="6377594">.</span><span class="ident" id="6377595">ReadBits</span><span class="op" id="6377603">(</span><span class="num" id="6377604">8</span><span class="op" id="6377605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377608">if</span>&nbsp;<span class="ident" id="6377611">t</span>&nbsp;<span class="op" id="6377613">!=</span>&nbsp;<span class="string" id="6377616">&#39;h&#39;</span>&nbsp;<span class="op" id="6377620">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377624">return</span>&nbsp;<span class="ident" id="6377631">StructuralError</span><span class="op" id="6377646">(</span><span class="string" id="6377647">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="6377677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377684">level</span>&nbsp;<span class="op" id="6377690">:=</span>&nbsp;<span class="ident" id="6377693">br</span><span class="op" id="6377695">.</span><span class="ident" id="6377696">ReadBits</span><span class="op" id="6377704">(</span><span class="num" id="6377705">8</span><span class="op" id="6377706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377709">if</span>&nbsp;<span class="ident" id="6377712">level</span>&nbsp;<span class="op" id="6377718">&lt;</span>&nbsp;<span class="string" id="6377720">&#39;1&#39;</span>&nbsp;<span class="op" id="6377724">||</span>&nbsp;<span class="ident" id="6377727">level</span>&nbsp;<span class="op" id="6377733">&gt;</span>&nbsp;<span class="string" id="6377735">&#39;9&#39;</span>&nbsp;<span class="op" id="6377739">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377743">return</span>&nbsp;<span class="ident" id="6377750">StructuralError</span><span class="op" id="6377765">(</span><span class="string" id="6377766">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="6377793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377800">bz2</span><span class="op" id="6377803">.</span><span class="ident" id="6377804">fileCRC</span>&nbsp;<span class="op" id="6377812">=</span>&nbsp;<span class="num" id="6377814">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377817">bz2</span><span class="op" id="6377820">.</span><span class="ident" id="6377821">blockSize</span>&nbsp;<span class="op" id="6377831">=</span>&nbsp;<span class="num" id="6377833">100</span>&nbsp;<span class="op" id="6377837">*</span>&nbsp;<span class="num" id="6377839">1024</span>&nbsp;<span class="op" id="6377844">*</span>&nbsp;<span class="op" id="6377846">(</span><span class="builtintype" id="6377847">int</span><span class="op" id="6377850">(</span><span class="ident" id="6377851">level</span><span class="op" id="6377856">)</span>&nbsp;<span class="op" id="6377858">-</span>&nbsp;<span class="string" id="6377860">&#39;0&#39;</span><span class="op" id="6377863">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377866">if</span>&nbsp;<span class="ident" id="6377869">bz2</span><span class="op" id="6377872">.</span><span class="ident" id="6377873">blockSize</span>&nbsp;<span class="op" id="6377883">&gt;</span>&nbsp;<span class="builtinfunc" id="6377885">len</span><span class="op" id="6377888">(</span><span class="ident" id="6377889">bz2</span><span class="op" id="6377892">.</span><span class="ident" id="6377893">tt</span><span class="op" id="6377895">)</span>&nbsp;<span class="op" id="6377897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377901">bz2</span><span class="op" id="6377904">.</span><span class="ident" id="6377905">tt</span>&nbsp;<span class="op" id="6377908">=</span>&nbsp;<span class="builtinfunc" id="6377910">make</span><span class="op" id="6377914">(</span><span class="op" id="6377915">[</span><span class="op" id="6377916">]</span><span class="builtintype" id="6377917">uint32</span><span class="op" id="6377923">,</span>&nbsp;<span class="ident" id="6377925">bz2</span><span class="op" id="6377928">.</span><span class="ident" id="6377929">blockSize</span><span class="op" id="6377938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377944">return</span>&nbsp;<span class="ident" id="6377951">nil</span><br>
<span class="lineno"></span><span class="op" id="6377955">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="6377958">func</span>&nbsp;<span class="op" id="6377963">(</span><span class="ident" id="6377964">bz2</span>&nbsp;<span class="op" id="6377968">*</span><span class="ident" id="6377969">reader</span><span class="op" id="6377975">)</span>&nbsp;<span class="ident" id="6377977">Read</span><span class="op" id="6377981">(</span><span class="ident" id="6377982">buf</span>&nbsp;<span class="op" id="6377986">[</span><span class="op" id="6377987">]</span><span class="builtintype" id="6377988">byte</span><span class="op" id="6377992">)</span>&nbsp;<span class="op" id="6377994">(</span><span class="ident" id="6377995">n</span>&nbsp;<span class="builtintype" id="6377997">int</span><span class="op" id="6378000">,</span>&nbsp;<span class="ident" id="6378002">err</span>&nbsp;<span class="builtintype" id="6378006">error</span><span class="op" id="6378011">)</span>&nbsp;<span class="op" id="6378013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378016">if</span>&nbsp;<span class="ident" id="6378019">bz2</span><span class="op" id="6378022">.</span><span class="ident" id="6378023">eof</span>&nbsp;<span class="op" id="6378027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378031">return</span>&nbsp;<span class="num" id="6378038">0</span><span class="op" id="6378039">,</span>&nbsp;<span class="ident" id="6378041">io</span><span class="op" id="6378043">.</span><span class="ident" id="6378044">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378049">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378053">if</span>&nbsp;<span class="op" id="6378056">!</span><span class="ident" id="6378057">bz2</span><span class="op" id="6378060">.</span><span class="ident" id="6378061">setupDone</span>&nbsp;<span class="op" id="6378071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378075">err</span>&nbsp;<span class="op" id="6378079">=</span>&nbsp;<span class="ident" id="6378081">bz2</span><span class="op" id="6378084">.</span><span class="ident" id="6378085">setup</span><span class="op" id="6378090">(</span><span class="builtintype" id="6378091">true</span><span class="op" id="6378095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378099">brErr</span>&nbsp;<span class="op" id="6378105">:=</span>&nbsp;<span class="ident" id="6378108">bz2</span><span class="op" id="6378111">.</span><span class="ident" id="6378112">br</span><span class="op" id="6378114">.</span><span class="ident" id="6378115">Err</span><span class="op" id="6378118">(</span><span class="op" id="6378119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378123">if</span>&nbsp;<span class="ident" id="6378126">brErr</span>&nbsp;<span class="op" id="6378132">!=</span>&nbsp;<span class="ident" id="6378135">nil</span>&nbsp;<span class="op" id="6378139">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378144">err</span>&nbsp;<span class="op" id="6378148">=</span>&nbsp;<span class="ident" id="6378150">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378162">if</span>&nbsp;<span class="ident" id="6378165">err</span>&nbsp;<span class="op" id="6378169">!=</span>&nbsp;<span class="ident" id="6378172">nil</span>&nbsp;<span class="op" id="6378176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378181">return</span>&nbsp;<span class="num" id="6378188">0</span><span class="op" id="6378189">,</span>&nbsp;<span class="ident" id="6378191">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378197">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378201">bz2</span><span class="op" id="6378204">.</span><span class="ident" id="6378205">setupDone</span>&nbsp;<span class="op" id="6378215">=</span>&nbsp;<span class="builtintype" id="6378217">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378227">n</span><span class="op" id="6378228">,</span>&nbsp;<span class="ident" id="6378230">err</span>&nbsp;<span class="op" id="6378234">=</span>&nbsp;<span class="ident" id="6378236">bz2</span><span class="op" id="6378239">.</span><span class="ident" id="6378240">read</span><span class="op" id="6378244">(</span><span class="ident" id="6378245">buf</span><span class="op" id="6378248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378251">brErr</span>&nbsp;<span class="op" id="6378257">:=</span>&nbsp;<span class="ident" id="6378260">bz2</span><span class="op" id="6378263">.</span><span class="ident" id="6378264">br</span><span class="op" id="6378266">.</span><span class="ident" id="6378267">Err</span><span class="op" id="6378270">(</span><span class="op" id="6378271">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378274">if</span>&nbsp;<span class="ident" id="6378277">brErr</span>&nbsp;<span class="op" id="6378283">!=</span>&nbsp;<span class="ident" id="6378286">nil</span>&nbsp;<span class="op" id="6378290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378294">err</span>&nbsp;<span class="op" id="6378298">=</span>&nbsp;<span class="ident" id="6378300">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378310">return</span><br>
<span class="lineno"></span><span class="op" id="6378317">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="6378320">func</span>&nbsp;<span class="op" id="6378325">(</span><span class="ident" id="6378326">bz2</span>&nbsp;<span class="op" id="6378330">*</span><span class="ident" id="6378331">reader</span><span class="op" id="6378337">)</span>&nbsp;<span class="ident" id="6378339">readFromBlock</span><span class="op" id="6378352">(</span><span class="ident" id="6378353">buf</span>&nbsp;<span class="op" id="6378357">[</span><span class="op" id="6378358">]</span><span class="builtintype" id="6378359">byte</span><span class="op" id="6378363">)</span>&nbsp;<span class="builtintype" id="6378365">int</span>&nbsp;<span class="op" id="6378369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378372">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378443">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378508">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378576">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378645">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378715">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378760">n</span>&nbsp;<span class="op" id="6378762">:=</span>&nbsp;<span class="num" id="6378765">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378768">for</span>&nbsp;<span class="op" id="6378772">(</span><span class="ident" id="6378773">bz2</span><span class="op" id="6378776">.</span><span class="ident" id="6378777">repeats</span>&nbsp;<span class="op" id="6378785">&gt;</span>&nbsp;<span class="num" id="6378787">0</span>&nbsp;<span class="op" id="6378789">||</span>&nbsp;<span class="ident" id="6378792">bz2</span><span class="op" id="6378795">.</span><span class="ident" id="6378796">preRLEUsed</span>&nbsp;<span class="op" id="6378807">&lt;</span>&nbsp;<span class="builtinfunc" id="6378809">len</span><span class="op" id="6378812">(</span><span class="ident" id="6378813">bz2</span><span class="op" id="6378816">.</span><span class="ident" id="6378817">preRLE</span><span class="op" id="6378823">)</span><span class="op" id="6378824">)</span>&nbsp;<span class="op" id="6378826">&amp;&amp;</span>&nbsp;<span class="ident" id="6378829">n</span>&nbsp;<span class="op" id="6378831">&lt;</span>&nbsp;<span class="builtinfunc" id="6378833">len</span><span class="op" id="6378836">(</span><span class="ident" id="6378837">buf</span><span class="op" id="6378840">)</span>&nbsp;<span class="op" id="6378842">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378846">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378878">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378924">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378986">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379049">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379115">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379176">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379190">if</span>&nbsp;<span class="ident" id="6379193">bz2</span><span class="op" id="6379196">.</span><span class="ident" id="6379197">repeats</span>&nbsp;<span class="op" id="6379205">&gt;</span>&nbsp;<span class="num" id="6379207">0</span>&nbsp;<span class="op" id="6379209">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379214">buf</span><span class="op" id="6379217">[</span><span class="ident" id="6379218">n</span><span class="op" id="6379219">]</span>&nbsp;<span class="op" id="6379221">=</span>&nbsp;<span class="builtintype" id="6379223">byte</span><span class="op" id="6379227">(</span><span class="ident" id="6379228">bz2</span><span class="op" id="6379231">.</span><span class="ident" id="6379232">lastByte</span><span class="op" id="6379240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379245">n</span><span class="op" id="6379246">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379252">bz2</span><span class="op" id="6379255">.</span><span class="ident" id="6379256">repeats</span><span class="op" id="6379263">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379269">if</span>&nbsp;<span class="ident" id="6379272">bz2</span><span class="op" id="6379275">.</span><span class="ident" id="6379276">repeats</span>&nbsp;<span class="op" id="6379284">==</span>&nbsp;<span class="num" id="6379287">0</span>&nbsp;<span class="op" id="6379289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379295">bz2</span><span class="op" id="6379298">.</span><span class="ident" id="6379299">lastByte</span>&nbsp;<span class="op" id="6379308">=</span>&nbsp;<span class="op" id="6379310">-</span><span class="num" id="6379311">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379321">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379337">bz2</span><span class="op" id="6379340">.</span><span class="ident" id="6379341">tPos</span>&nbsp;<span class="op" id="6379346">=</span>&nbsp;<span class="ident" id="6379348">bz2</span><span class="op" id="6379351">.</span><span class="ident" id="6379352">preRLE</span><span class="op" id="6379358">[</span><span class="ident" id="6379359">bz2</span><span class="op" id="6379362">.</span><span class="ident" id="6379363">tPos</span><span class="op" id="6379367">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379371">b</span>&nbsp;<span class="op" id="6379373">:=</span>&nbsp;<span class="builtintype" id="6379376">byte</span><span class="op" id="6379380">(</span><span class="ident" id="6379381">bz2</span><span class="op" id="6379384">.</span><span class="ident" id="6379385">tPos</span><span class="op" id="6379389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379393">bz2</span><span class="op" id="6379396">.</span><span class="ident" id="6379397">tPos</span>&nbsp;<span class="op" id="6379402">&gt;&gt;=</span>&nbsp;<span class="num" id="6379406">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379410">bz2</span><span class="op" id="6379413">.</span><span class="ident" id="6379414">preRLEUsed</span><span class="op" id="6379424">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379430">if</span>&nbsp;<span class="ident" id="6379433">bz2</span><span class="op" id="6379436">.</span><span class="ident" id="6379437">byteRepeats</span>&nbsp;<span class="op" id="6379449">==</span>&nbsp;<span class="num" id="6379452">3</span>&nbsp;<span class="op" id="6379454">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379459">bz2</span><span class="op" id="6379462">.</span><span class="ident" id="6379463">repeats</span>&nbsp;<span class="op" id="6379471">=</span>&nbsp;<span class="builtintype" id="6379473">uint</span><span class="op" id="6379477">(</span><span class="ident" id="6379478">b</span><span class="op" id="6379479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379484">bz2</span><span class="op" id="6379487">.</span><span class="ident" id="6379488">byteRepeats</span>&nbsp;<span class="op" id="6379500">=</span>&nbsp;<span class="num" id="6379502">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379507">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379523">if</span>&nbsp;<span class="ident" id="6379526">bz2</span><span class="op" id="6379529">.</span><span class="ident" id="6379530">lastByte</span>&nbsp;<span class="op" id="6379539">==</span>&nbsp;<span class="builtintype" id="6379542">int</span><span class="op" id="6379545">(</span><span class="ident" id="6379546">b</span><span class="op" id="6379547">)</span>&nbsp;<span class="op" id="6379549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379554">bz2</span><span class="op" id="6379557">.</span><span class="ident" id="6379558">byteRepeats</span><span class="op" id="6379569">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379574">}</span>&nbsp;<span class="keyword" id="6379576">else</span>&nbsp;<span class="op" id="6379581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379586">bz2</span><span class="op" id="6379589">.</span><span class="ident" id="6379590">byteRepeats</span>&nbsp;<span class="op" id="6379602">=</span>&nbsp;<span class="num" id="6379604">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379608">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379612">bz2</span><span class="op" id="6379615">.</span><span class="ident" id="6379616">lastByte</span>&nbsp;<span class="op" id="6379625">=</span>&nbsp;<span class="builtintype" id="6379627">int</span><span class="op" id="6379630">(</span><span class="ident" id="6379631">b</span><span class="op" id="6379632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379637">buf</span><span class="op" id="6379640">[</span><span class="ident" id="6379641">n</span><span class="op" id="6379642">]</span>&nbsp;<span class="op" id="6379644">=</span>&nbsp;<span class="ident" id="6379646">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379650">n</span><span class="op" id="6379651">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379655">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379659">return</span>&nbsp;<span class="ident" id="6379666">n</span><br>
<span class="lineno"></span><span class="op" id="6379668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6379671">func</span>&nbsp;<span class="op" id="6379676">(</span><span class="ident" id="6379677">bz2</span>&nbsp;<span class="op" id="6379681">*</span><span class="ident" id="6379682">reader</span><span class="op" id="6379688">)</span>&nbsp;<span class="ident" id="6379690">read</span><span class="op" id="6379694">(</span><span class="ident" id="6379695">buf</span>&nbsp;<span class="op" id="6379699">[</span><span class="op" id="6379700">]</span><span class="builtintype" id="6379701">byte</span><span class="op" id="6379705">)</span>&nbsp;<span class="op" id="6379707">(</span><span class="builtintype" id="6379708">int</span><span class="op" id="6379711">,</span>&nbsp;<span class="builtintype" id="6379713">error</span><span class="op" id="6379718">)</span>&nbsp;<span class="op" id="6379720">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379723">for</span>&nbsp;<span class="op" id="6379727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379731">n</span>&nbsp;<span class="op" id="6379733">:=</span>&nbsp;<span class="ident" id="6379736">bz2</span><span class="op" id="6379739">.</span><span class="ident" id="6379740">readFromBlock</span><span class="op" id="6379753">(</span><span class="ident" id="6379754">buf</span><span class="op" id="6379757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379761">if</span>&nbsp;<span class="ident" id="6379764">n</span>&nbsp;<span class="op" id="6379766">&gt;</span>&nbsp;<span class="num" id="6379768">0</span>&nbsp;<span class="op" id="6379770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379775">bz2</span><span class="op" id="6379778">.</span><span class="ident" id="6379779">blockCRC</span>&nbsp;<span class="op" id="6379788">=</span>&nbsp;<span class="ident" id="6379790">updateCRC</span><span class="op" id="6379799">(</span><span class="ident" id="6379800">bz2</span><span class="op" id="6379803">.</span><span class="ident" id="6379804">blockCRC</span><span class="op" id="6379812">,</span>&nbsp;<span class="ident" id="6379814">buf</span><span class="op" id="6379817">[</span><span class="op" id="6379818">:</span><span class="ident" id="6379819">n</span><span class="op" id="6379820">]</span><span class="op" id="6379821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379826">return</span>&nbsp;<span class="ident" id="6379833">n</span><span class="op" id="6379834">,</span>&nbsp;<span class="ident" id="6379836">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379847">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379877">if</span>&nbsp;<span class="ident" id="6379880">bz2</span><span class="op" id="6379883">.</span><span class="ident" id="6379884">blockCRC</span>&nbsp;<span class="op" id="6379893">!=</span>&nbsp;<span class="ident" id="6379896">bz2</span><span class="op" id="6379899">.</span><span class="ident" id="6379900">wantBlockCRC</span>&nbsp;<span class="op" id="6379913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379918">bz2</span><span class="op" id="6379921">.</span><span class="ident" id="6379922">br</span><span class="op" id="6379924">.</span><span class="ident" id="6379925">err</span>&nbsp;<span class="op" id="6379929">=</span>&nbsp;<span class="ident" id="6379931">StructuralError</span><span class="op" id="6379946">(</span><span class="string" id="6379947">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6379972">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379977">return</span>&nbsp;<span class="num" id="6379984">0</span><span class="op" id="6379985">,</span>&nbsp;<span class="ident" id="6379987">bz2</span><span class="op" id="6379990">.</span><span class="ident" id="6379991">br</span><span class="op" id="6379993">.</span><span class="ident" id="6379994">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380005">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380027">br</span>&nbsp;<span class="op" id="6380030">:=</span>&nbsp;<span class="op" id="6380033">&amp;</span><span class="ident" id="6380034">bz2</span><span class="op" id="6380037">.</span><span class="ident" id="6380038">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380043">switch</span>&nbsp;<span class="ident" id="6380050">br</span><span class="op" id="6380052">.</span><span class="ident" id="6380053">ReadBits64</span><span class="op" id="6380063">(</span><span class="num" id="6380064">48</span><span class="op" id="6380066">)</span>&nbsp;<span class="op" id="6380068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380072">default</span><span class="op" id="6380079">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380084">return</span>&nbsp;<span class="num" id="6380091">0</span><span class="op" id="6380092">,</span>&nbsp;<span class="ident" id="6380094">StructuralError</span><span class="op" id="6380109">(</span><span class="string" id="6380110">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="6380133">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380138">case</span>&nbsp;<span class="ident" id="6380143">bzip2BlockMagic</span><span class="op" id="6380158">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380163">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380185">err</span>&nbsp;<span class="op" id="6380189">:=</span>&nbsp;<span class="ident" id="6380192">bz2</span><span class="op" id="6380195">.</span><span class="ident" id="6380196">readBlock</span><span class="op" id="6380205">(</span><span class="op" id="6380206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380211">if</span>&nbsp;<span class="ident" id="6380214">err</span>&nbsp;<span class="op" id="6380218">!=</span>&nbsp;<span class="ident" id="6380221">nil</span>&nbsp;<span class="op" id="6380225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380231">return</span>&nbsp;<span class="num" id="6380238">0</span><span class="op" id="6380239">,</span>&nbsp;<span class="ident" id="6380241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380248">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380253">case</span>&nbsp;<span class="ident" id="6380258">bzip2FinalMagic</span><span class="op" id="6380273">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380278">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380307">wantFileCRC</span>&nbsp;<span class="op" id="6380319">:=</span>&nbsp;<span class="builtintype" id="6380322">uint32</span><span class="op" id="6380328">(</span><span class="ident" id="6380329">br</span><span class="op" id="6380331">.</span><span class="ident" id="6380332">ReadBits64</span><span class="op" id="6380342">(</span><span class="num" id="6380343">32</span><span class="op" id="6380345">)</span><span class="op" id="6380346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380351">if</span>&nbsp;<span class="ident" id="6380354">br</span><span class="op" id="6380356">.</span><span class="ident" id="6380357">err</span>&nbsp;<span class="op" id="6380361">!=</span>&nbsp;<span class="ident" id="6380364">nil</span>&nbsp;<span class="op" id="6380368">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380374">return</span>&nbsp;<span class="num" id="6380381">0</span><span class="op" id="6380382">,</span>&nbsp;<span class="ident" id="6380384">br</span><span class="op" id="6380386">.</span><span class="ident" id="6380387">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380399">if</span>&nbsp;<span class="ident" id="6380402">bz2</span><span class="op" id="6380405">.</span><span class="ident" id="6380406">fileCRC</span>&nbsp;<span class="op" id="6380414">!=</span>&nbsp;<span class="ident" id="6380417">wantFileCRC</span>&nbsp;<span class="op" id="6380429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380435">br</span><span class="op" id="6380437">.</span><span class="ident" id="6380438">err</span>&nbsp;<span class="op" id="6380442">=</span>&nbsp;<span class="ident" id="6380444">StructuralError</span><span class="op" id="6380459">(</span><span class="string" id="6380460">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6380484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380490">return</span>&nbsp;<span class="num" id="6380497">0</span><span class="op" id="6380498">,</span>&nbsp;<span class="ident" id="6380500">br</span><span class="op" id="6380502">.</span><span class="ident" id="6380503">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380516">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380551">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380599">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380629">if</span>&nbsp;<span class="ident" id="6380632">br</span><span class="op" id="6380634">.</span><span class="ident" id="6380635">bits</span><span class="op" id="6380639">%</span><span class="num" id="6380640">8</span>&nbsp;<span class="op" id="6380642">!=</span>&nbsp;<span class="num" id="6380645">0</span>&nbsp;<span class="op" id="6380647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380653">br</span><span class="op" id="6380655">.</span><span class="ident" id="6380656">ReadBits</span><span class="op" id="6380664">(</span><span class="ident" id="6380665">br</span><span class="op" id="6380667">.</span><span class="ident" id="6380668">bits</span>&nbsp;<span class="op" id="6380673">%</span>&nbsp;<span class="num" id="6380675">8</span><span class="op" id="6380676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380686">b</span><span class="op" id="6380687">,</span>&nbsp;<span class="ident" id="6380689">err</span>&nbsp;<span class="op" id="6380693">:=</span>&nbsp;<span class="ident" id="6380696">br</span><span class="op" id="6380698">.</span><span class="ident" id="6380699">r</span><span class="op" id="6380700">.</span><span class="ident" id="6380701">ReadByte</span><span class="op" id="6380709">(</span><span class="op" id="6380710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380715">if</span>&nbsp;<span class="ident" id="6380718">err</span>&nbsp;<span class="op" id="6380722">==</span>&nbsp;<span class="ident" id="6380725">io</span><span class="op" id="6380727">.</span><span class="ident" id="6380728">EOF</span>&nbsp;<span class="op" id="6380732">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380738">br</span><span class="op" id="6380740">.</span><span class="ident" id="6380741">err</span>&nbsp;<span class="op" id="6380745">=</span>&nbsp;<span class="ident" id="6380747">io</span><span class="op" id="6380749">.</span><span class="ident" id="6380750">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380758">bz2</span><span class="op" id="6380761">.</span><span class="ident" id="6380762">eof</span>&nbsp;<span class="op" id="6380766">=</span>&nbsp;<span class="builtintype" id="6380768">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380777">return</span>&nbsp;<span class="num" id="6380784">0</span><span class="op" id="6380785">,</span>&nbsp;<span class="ident" id="6380787">io</span><span class="op" id="6380789">.</span><span class="ident" id="6380790">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380802">if</span>&nbsp;<span class="ident" id="6380805">err</span>&nbsp;<span class="op" id="6380809">!=</span>&nbsp;<span class="ident" id="6380812">nil</span>&nbsp;<span class="op" id="6380816">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380822">br</span><span class="op" id="6380824">.</span><span class="ident" id="6380825">err</span>&nbsp;<span class="op" id="6380829">=</span>&nbsp;<span class="ident" id="6380831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380839">return</span>&nbsp;<span class="num" id="6380846">0</span><span class="op" id="6380847">,</span>&nbsp;<span class="ident" id="6380849">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380861">z</span><span class="op" id="6380862">,</span>&nbsp;<span class="ident" id="6380864">err</span>&nbsp;<span class="op" id="6380868">:=</span>&nbsp;<span class="ident" id="6380871">br</span><span class="op" id="6380873">.</span><span class="ident" id="6380874">r</span><span class="op" id="6380875">.</span><span class="ident" id="6380876">ReadByte</span><span class="op" id="6380884">(</span><span class="op" id="6380885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380890">if</span>&nbsp;<span class="ident" id="6380893">err</span>&nbsp;<span class="op" id="6380897">!=</span>&nbsp;<span class="ident" id="6380900">nil</span>&nbsp;<span class="op" id="6380904">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380910">if</span>&nbsp;<span class="ident" id="6380913">err</span>&nbsp;<span class="op" id="6380917">==</span>&nbsp;<span class="ident" id="6380920">io</span><span class="op" id="6380922">.</span><span class="ident" id="6380923">EOF</span>&nbsp;<span class="op" id="6380927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380934">err</span>&nbsp;<span class="op" id="6380938">=</span>&nbsp;<span class="ident" id="6380940">io</span><span class="op" id="6380942">.</span><span class="ident" id="6380943">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380970">br</span><span class="op" id="6380972">.</span><span class="ident" id="6380973">err</span>&nbsp;<span class="op" id="6380977">=</span>&nbsp;<span class="ident" id="6380979">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380987">return</span>&nbsp;<span class="num" id="6380994">0</span><span class="op" id="6380995">,</span>&nbsp;<span class="ident" id="6380997">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381009">if</span>&nbsp;<span class="ident" id="6381012">b</span>&nbsp;<span class="op" id="6381014">!=</span>&nbsp;<span class="string" id="6381017">&#39;B&#39;</span>&nbsp;<span class="op" id="6381021">||</span>&nbsp;<span class="ident" id="6381024">z</span>&nbsp;<span class="op" id="6381026">!=</span>&nbsp;<span class="string" id="6381029">&#39;Z&#39;</span>&nbsp;<span class="op" id="6381033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381039">return</span>&nbsp;<span class="num" id="6381046">0</span><span class="op" id="6381047">,</span>&nbsp;<span class="ident" id="6381049">StructuralError</span><span class="op" id="6381064">(</span><span class="string" id="6381065">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="6381103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381113">if</span>&nbsp;<span class="ident" id="6381116">err</span>&nbsp;<span class="op" id="6381120">:=</span>&nbsp;<span class="ident" id="6381123">bz2</span><span class="op" id="6381126">.</span><span class="ident" id="6381127">setup</span><span class="op" id="6381132">(</span><span class="builtintype" id="6381133">false</span><span class="op" id="6381138">)</span><span class="op" id="6381139">;</span>&nbsp;<span class="ident" id="6381141">err</span>&nbsp;<span class="op" id="6381145">!=</span>&nbsp;<span class="ident" id="6381148">nil</span>&nbsp;<span class="op" id="6381152">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381158">return</span>&nbsp;<span class="num" id="6381165">0</span><span class="op" id="6381166">,</span>&nbsp;<span class="ident" id="6381168">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381182">}</span><br>
<span class="lineno"></span><span class="op" id="6381184">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="6381187">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="6381273">func</span>&nbsp;<span class="op" id="6381278">(</span><span class="ident" id="6381279">bz2</span>&nbsp;<span class="op" id="6381283">*</span><span class="ident" id="6381284">reader</span><span class="op" id="6381290">)</span>&nbsp;<span class="ident" id="6381292">readBlock</span><span class="op" id="6381301">(</span><span class="op" id="6381302">)</span>&nbsp;<span class="op" id="6381304">(</span><span class="ident" id="6381305">err</span>&nbsp;<span class="builtintype" id="6381309">error</span><span class="op" id="6381314">)</span>&nbsp;<span class="op" id="6381316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381319">br</span>&nbsp;<span class="op" id="6381322">:=</span>&nbsp;<span class="op" id="6381325">&amp;</span><span class="ident" id="6381326">bz2</span><span class="op" id="6381329">.</span><span class="ident" id="6381330">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381334">bz2</span><span class="op" id="6381337">.</span><span class="ident" id="6381338">wantBlockCRC</span>&nbsp;<span class="op" id="6381351">=</span>&nbsp;<span class="builtintype" id="6381353">uint32</span><span class="op" id="6381359">(</span><span class="ident" id="6381360">br</span><span class="op" id="6381362">.</span><span class="ident" id="6381363">ReadBits64</span><span class="op" id="6381373">(</span><span class="num" id="6381374">32</span><span class="op" id="6381376">)</span><span class="op" id="6381377">)</span>&nbsp;<span class="comment" id="6381379">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381446">bz2</span><span class="op" id="6381449">.</span><span class="ident" id="6381450">blockCRC</span>&nbsp;<span class="op" id="6381459">=</span>&nbsp;<span class="num" id="6381461">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381464">bz2</span><span class="op" id="6381467">.</span><span class="ident" id="6381468">fileCRC</span>&nbsp;<span class="op" id="6381476">=</span>&nbsp;<span class="op" id="6381478">(</span><span class="ident" id="6381479">bz2</span><span class="op" id="6381482">.</span><span class="ident" id="6381483">fileCRC</span><span class="op" id="6381490">&lt;&lt;</span><span class="num" id="6381492">1</span>&nbsp;<span class="op" id="6381494">|</span>&nbsp;<span class="ident" id="6381496">bz2</span><span class="op" id="6381499">.</span><span class="ident" id="6381500">fileCRC</span><span class="op" id="6381507">&gt;&gt;</span><span class="num" id="6381509">31</span><span class="op" id="6381511">)</span>&nbsp;<span class="op" id="6381513">^</span>&nbsp;<span class="ident" id="6381515">bz2</span><span class="op" id="6381518">.</span><span class="ident" id="6381519">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381533">randomized</span>&nbsp;<span class="op" id="6381544">:=</span>&nbsp;<span class="ident" id="6381547">br</span><span class="op" id="6381549">.</span><span class="ident" id="6381550">ReadBits</span><span class="op" id="6381558">(</span><span class="num" id="6381559">1</span><span class="op" id="6381560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381563">if</span>&nbsp;<span class="ident" id="6381566">randomized</span>&nbsp;<span class="op" id="6381577">!=</span>&nbsp;<span class="num" id="6381580">0</span>&nbsp;<span class="op" id="6381582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381586">return</span>&nbsp;<span class="ident" id="6381593">StructuralError</span><span class="op" id="6381608">(</span><span class="string" id="6381609">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="6381638">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381644">origPtr</span>&nbsp;<span class="op" id="6381652">:=</span>&nbsp;<span class="builtintype" id="6381655">uint</span><span class="op" id="6381659">(</span><span class="ident" id="6381660">br</span><span class="op" id="6381662">.</span><span class="ident" id="6381663">ReadBits</span><span class="op" id="6381671">(</span><span class="num" id="6381672">24</span><span class="op" id="6381674">)</span><span class="op" id="6381675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381679">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381751">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381815">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381844">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="6381866">:=</span>&nbsp;<span class="ident" id="6381869">br</span><span class="op" id="6381871">.</span><span class="ident" id="6381872">ReadBits</span><span class="op" id="6381880">(</span><span class="num" id="6381881">16</span><span class="op" id="6381883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381886">symbolPresent</span>&nbsp;<span class="op" id="6381900">:=</span>&nbsp;<span class="builtinfunc" id="6381903">make</span><span class="op" id="6381907">(</span><span class="op" id="6381908">[</span><span class="op" id="6381909">]</span><span class="builtintype" id="6381910">bool</span><span class="op" id="6381914">,</span>&nbsp;<span class="num" id="6381916">256</span><span class="op" id="6381919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381922">numSymbols</span>&nbsp;<span class="op" id="6381933">:=</span>&nbsp;<span class="num" id="6381936">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381939">for</span>&nbsp;<span class="ident" id="6381943">symRange</span>&nbsp;<span class="op" id="6381952">:=</span>&nbsp;<span class="builtintype" id="6381955">uint</span><span class="op" id="6381959">(</span><span class="num" id="6381960">0</span><span class="op" id="6381961">)</span><span class="op" id="6381962">;</span>&nbsp;<span class="ident" id="6381964">symRange</span>&nbsp;<span class="op" id="6381973">&lt;</span>&nbsp;<span class="num" id="6381975">16</span><span class="op" id="6381977">;</span>&nbsp;<span class="ident" id="6381979">symRange</span><span class="op" id="6381987">++</span>&nbsp;<span class="op" id="6381990">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381994">if</span>&nbsp;<span class="ident" id="6381997">symbolRangeUsedBitmap</span><span class="op" id="6382018">&amp;</span><span class="op" id="6382019">(</span><span class="num" id="6382020">1</span><span class="op" id="6382021">&lt;&lt;</span><span class="op" id="6382023">(</span><span class="num" id="6382024">15</span><span class="op" id="6382026">-</span><span class="ident" id="6382027">symRange</span><span class="op" id="6382035">)</span><span class="op" id="6382036">)</span>&nbsp;<span class="op" id="6382038">!=</span>&nbsp;<span class="num" id="6382041">0</span>&nbsp;<span class="op" id="6382043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382048">bits</span>&nbsp;<span class="op" id="6382053">:=</span>&nbsp;<span class="ident" id="6382056">br</span><span class="op" id="6382058">.</span><span class="ident" id="6382059">ReadBits</span><span class="op" id="6382067">(</span><span class="num" id="6382068">16</span><span class="op" id="6382070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382075">for</span>&nbsp;<span class="ident" id="6382079">symbol</span>&nbsp;<span class="op" id="6382086">:=</span>&nbsp;<span class="builtintype" id="6382089">uint</span><span class="op" id="6382093">(</span><span class="num" id="6382094">0</span><span class="op" id="6382095">)</span><span class="op" id="6382096">;</span>&nbsp;<span class="ident" id="6382098">symbol</span>&nbsp;<span class="op" id="6382105">&lt;</span>&nbsp;<span class="num" id="6382107">16</span><span class="op" id="6382109">;</span>&nbsp;<span class="ident" id="6382111">symbol</span><span class="op" id="6382117">++</span>&nbsp;<span class="op" id="6382120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382126">if</span>&nbsp;<span class="ident" id="6382129">bits</span><span class="op" id="6382133">&amp;</span><span class="op" id="6382134">(</span><span class="num" id="6382135">1</span><span class="op" id="6382136">&lt;&lt;</span><span class="op" id="6382138">(</span><span class="num" id="6382139">15</span><span class="op" id="6382141">-</span><span class="ident" id="6382142">symbol</span><span class="op" id="6382148">)</span><span class="op" id="6382149">)</span>&nbsp;<span class="op" id="6382151">!=</span>&nbsp;<span class="num" id="6382154">0</span>&nbsp;<span class="op" id="6382156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382163">symbolPresent</span><span class="op" id="6382176">[</span><span class="num" id="6382177">16</span><span class="op" id="6382179">*</span><span class="ident" id="6382180">symRange</span><span class="op" id="6382188">+</span><span class="ident" id="6382189">symbol</span><span class="op" id="6382195">]</span>&nbsp;<span class="op" id="6382197">=</span>&nbsp;<span class="builtintype" id="6382199">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382209">numSymbols</span><span class="op" id="6382219">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382238">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382242">if</span>&nbsp;<span class="ident" id="6382245">numSymbols</span>&nbsp;<span class="op" id="6382256">==</span>&nbsp;<span class="num" id="6382259">0</span>&nbsp;<span class="op" id="6382261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6382265">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382299">return</span>&nbsp;<span class="ident" id="6382306">StructuralError</span><span class="op" id="6382321">(</span><span class="string" id="6382322">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="6382343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382346">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6382350">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382412">numHuffmanTrees</span>&nbsp;<span class="op" id="6382428">:=</span>&nbsp;<span class="ident" id="6382431">br</span><span class="op" id="6382433">.</span><span class="ident" id="6382434">ReadBits</span><span class="op" id="6382442">(</span><span class="num" id="6382443">3</span><span class="op" id="6382444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382447">if</span>&nbsp;<span class="ident" id="6382450">numHuffmanTrees</span>&nbsp;<span class="op" id="6382466">&lt;</span>&nbsp;<span class="num" id="6382468">2</span>&nbsp;<span class="op" id="6382470">||</span>&nbsp;<span class="ident" id="6382473">numHuffmanTrees</span>&nbsp;<span class="op" id="6382489">&gt;</span>&nbsp;<span class="num" id="6382491">6</span>&nbsp;<span class="op" id="6382493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382497">return</span>&nbsp;<span class="ident" id="6382504">StructuralError</span><span class="op" id="6382519">(</span><span class="string" id="6382520">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="6382553">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6382560">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6382630">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382702">numSelectors</span>&nbsp;<span class="op" id="6382715">:=</span>&nbsp;<span class="ident" id="6382718">br</span><span class="op" id="6382720">.</span><span class="ident" id="6382721">ReadBits</span><span class="op" id="6382729">(</span><span class="num" id="6382730">15</span><span class="op" id="6382732">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382735">treeIndexes</span>&nbsp;<span class="op" id="6382747">:=</span>&nbsp;<span class="builtinfunc" id="6382750">make</span><span class="op" id="6382754">(</span><span class="op" id="6382755">[</span><span class="op" id="6382756">]</span><span class="builtintype" id="6382757">uint8</span><span class="op" id="6382762">,</span>&nbsp;<span class="ident" id="6382764">numSelectors</span><span class="op" id="6382776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6382780">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6382851">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382864">mtfTreeDecoder</span>&nbsp;<span class="op" id="6382879">:=</span>&nbsp;<span class="ident" id="6382882">newMTFDecoderWithRange</span><span class="op" id="6382904">(</span><span class="ident" id="6382905">numHuffmanTrees</span><span class="op" id="6382920">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382923">for</span>&nbsp;<span class="ident" id="6382927">i</span>&nbsp;<span class="op" id="6382929">:=</span>&nbsp;<span class="keyword" id="6382932">range</span>&nbsp;<span class="ident" id="6382938">treeIndexes</span>&nbsp;<span class="op" id="6382950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382954">c</span>&nbsp;<span class="op" id="6382956">:=</span>&nbsp;<span class="num" id="6382959">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382963">for</span>&nbsp;<span class="op" id="6382967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382972">inc</span>&nbsp;<span class="op" id="6382976">:=</span>&nbsp;<span class="ident" id="6382979">br</span><span class="op" id="6382981">.</span><span class="ident" id="6382982">ReadBits</span><span class="op" id="6382990">(</span><span class="num" id="6382991">1</span><span class="op" id="6382992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382997">if</span>&nbsp;<span class="ident" id="6383000">inc</span>&nbsp;<span class="op" id="6383004">==</span>&nbsp;<span class="num" id="6383007">0</span>&nbsp;<span class="op" id="6383009">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383015">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383029">c</span><span class="op" id="6383030">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383039">if</span>&nbsp;<span class="ident" id="6383042">c</span>&nbsp;<span class="op" id="6383044">&gt;=</span>&nbsp;<span class="ident" id="6383047">numHuffmanTrees</span>&nbsp;<span class="op" id="6383063">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383068">return</span>&nbsp;<span class="ident" id="6383075">StructuralError</span><span class="op" id="6383090">(</span><span class="string" id="6383091">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="6383113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383121">treeIndexes</span><span class="op" id="6383132">[</span><span class="ident" id="6383133">i</span><span class="op" id="6383134">]</span>&nbsp;<span class="op" id="6383136">=</span>&nbsp;<span class="builtintype" id="6383138">uint8</span><span class="op" id="6383143">(</span><span class="ident" id="6383144">mtfTreeDecoder</span><span class="op" id="6383158">.</span><span class="ident" id="6383159">Decode</span><span class="op" id="6383165">(</span><span class="ident" id="6383166">c</span><span class="op" id="6383167">)</span><span class="op" id="6383168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383175">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383245">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383287">symbols</span>&nbsp;<span class="op" id="6383295">:=</span>&nbsp;<span class="builtinfunc" id="6383298">make</span><span class="op" id="6383302">(</span><span class="op" id="6383303">[</span><span class="op" id="6383304">]</span><span class="builtintype" id="6383305">byte</span><span class="op" id="6383309">,</span>&nbsp;<span class="ident" id="6383311">numSymbols</span><span class="op" id="6383321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383324">nextSymbol</span>&nbsp;<span class="op" id="6383335">:=</span>&nbsp;<span class="num" id="6383338">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383341">for</span>&nbsp;<span class="ident" id="6383345">i</span>&nbsp;<span class="op" id="6383347">:=</span>&nbsp;<span class="num" id="6383350">0</span><span class="op" id="6383351">;</span>&nbsp;<span class="ident" id="6383353">i</span>&nbsp;<span class="op" id="6383355">&lt;</span>&nbsp;<span class="num" id="6383357">256</span><span class="op" id="6383360">;</span>&nbsp;<span class="ident" id="6383362">i</span><span class="op" id="6383363">++</span>&nbsp;<span class="op" id="6383366">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383370">if</span>&nbsp;<span class="ident" id="6383373">symbolPresent</span><span class="op" id="6383386">[</span><span class="ident" id="6383387">i</span><span class="op" id="6383388">]</span>&nbsp;<span class="op" id="6383390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383395">symbols</span><span class="op" id="6383402">[</span><span class="ident" id="6383403">nextSymbol</span><span class="op" id="6383413">]</span>&nbsp;<span class="op" id="6383415">=</span>&nbsp;<span class="builtintype" id="6383417">byte</span><span class="op" id="6383421">(</span><span class="ident" id="6383422">i</span><span class="op" id="6383423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383428">nextSymbol</span><span class="op" id="6383438">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383446">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383449">mtf</span>&nbsp;<span class="op" id="6383453">:=</span>&nbsp;<span class="ident" id="6383456">newMTFDecoder</span><span class="op" id="6383469">(</span><span class="ident" id="6383470">symbols</span><span class="op" id="6383477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383481">numSymbols</span>&nbsp;<span class="op" id="6383492">+=</span>&nbsp;<span class="num" id="6383495">2</span>&nbsp;<span class="comment" id="6383497">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383538">huffmanTrees</span>&nbsp;<span class="op" id="6383551">:=</span>&nbsp;<span class="builtinfunc" id="6383554">make</span><span class="op" id="6383558">(</span><span class="op" id="6383559">[</span><span class="op" id="6383560">]</span><span class="ident" id="6383561">huffmanTree</span><span class="op" id="6383572">,</span>&nbsp;<span class="ident" id="6383574">numHuffmanTrees</span><span class="op" id="6383589">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383593">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383653">lengths</span>&nbsp;<span class="op" id="6383661">:=</span>&nbsp;<span class="builtinfunc" id="6383664">make</span><span class="op" id="6383668">(</span><span class="op" id="6383669">[</span><span class="op" id="6383670">]</span><span class="builtintype" id="6383671">uint8</span><span class="op" id="6383676">,</span>&nbsp;<span class="ident" id="6383678">numSymbols</span><span class="op" id="6383688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383691">for</span>&nbsp;<span class="ident" id="6383695">i</span>&nbsp;<span class="op" id="6383697">:=</span>&nbsp;<span class="keyword" id="6383700">range</span>&nbsp;<span class="ident" id="6383706">huffmanTrees</span>&nbsp;<span class="op" id="6383719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383723">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383788">length</span>&nbsp;<span class="op" id="6383795">:=</span>&nbsp;<span class="ident" id="6383798">br</span><span class="op" id="6383800">.</span><span class="ident" id="6383801">ReadBits</span><span class="op" id="6383809">(</span><span class="num" id="6383810">5</span><span class="op" id="6383811">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383815">for</span>&nbsp;<span class="ident" id="6383819">j</span>&nbsp;<span class="op" id="6383821">:=</span>&nbsp;<span class="keyword" id="6383824">range</span>&nbsp;<span class="ident" id="6383830">lengths</span>&nbsp;<span class="op" id="6383838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383843">for</span>&nbsp;<span class="op" id="6383847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383853">if</span>&nbsp;<span class="op" id="6383856">!</span><span class="ident" id="6383857">br</span><span class="op" id="6383859">.</span><span class="ident" id="6383860">ReadBit</span><span class="op" id="6383867">(</span><span class="op" id="6383868">)</span>&nbsp;<span class="op" id="6383870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383877">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383887">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383893">if</span>&nbsp;<span class="ident" id="6383896">br</span><span class="op" id="6383898">.</span><span class="ident" id="6383899">ReadBit</span><span class="op" id="6383906">(</span><span class="op" id="6383907">)</span>&nbsp;<span class="op" id="6383909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383916">length</span><span class="op" id="6383922">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383929">}</span>&nbsp;<span class="keyword" id="6383931">else</span>&nbsp;<span class="op" id="6383936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383943">length</span><span class="op" id="6383949">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383956">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383966">if</span>&nbsp;<span class="ident" id="6383969">length</span>&nbsp;<span class="op" id="6383976">&lt;</span>&nbsp;<span class="num" id="6383978">0</span>&nbsp;<span class="op" id="6383980">||</span>&nbsp;<span class="ident" id="6383983">length</span>&nbsp;<span class="op" id="6383990">&gt;</span>&nbsp;<span class="num" id="6383992">20</span>&nbsp;<span class="op" id="6383995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384001">return</span>&nbsp;<span class="ident" id="6384008">StructuralError</span><span class="op" id="6384023">(</span><span class="string" id="6384024">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6384053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384063">lengths</span><span class="op" id="6384070">[</span><span class="ident" id="6384071">j</span><span class="op" id="6384072">]</span>&nbsp;<span class="op" id="6384074">=</span>&nbsp;<span class="builtintype" id="6384076">uint8</span><span class="op" id="6384081">(</span><span class="ident" id="6384082">length</span><span class="op" id="6384088">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384096">huffmanTrees</span><span class="op" id="6384108">[</span><span class="ident" id="6384109">i</span><span class="op" id="6384110">]</span><span class="op" id="6384111">,</span>&nbsp;<span class="ident" id="6384113">err</span>&nbsp;<span class="op" id="6384117">=</span>&nbsp;<span class="ident" id="6384119">newHuffmanTree</span><span class="op" id="6384133">(</span><span class="ident" id="6384134">lengths</span><span class="op" id="6384141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384145">if</span>&nbsp;<span class="ident" id="6384148">err</span>&nbsp;<span class="op" id="6384152">!=</span>&nbsp;<span class="ident" id="6384155">nil</span>&nbsp;<span class="op" id="6384159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384164">return</span>&nbsp;<span class="ident" id="6384171">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384177">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384184">selectorIndex</span>&nbsp;<span class="op" id="6384198">:=</span>&nbsp;<span class="num" id="6384201">1</span>&nbsp;<span class="comment" id="6384203">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384234">if</span>&nbsp;<span class="builtinfunc" id="6384237">len</span><span class="op" id="6384240">(</span><span class="ident" id="6384241">treeIndexes</span><span class="op" id="6384252">)</span>&nbsp;<span class="op" id="6384254">==</span>&nbsp;<span class="num" id="6384257">0</span>&nbsp;<span class="op" id="6384259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384263">return</span>&nbsp;<span class="ident" id="6384270">StructuralError</span><span class="op" id="6384285">(</span><span class="string" id="6384286">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="6384311">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384317">if</span>&nbsp;<span class="builtintype" id="6384320">int</span><span class="op" id="6384323">(</span><span class="ident" id="6384324">treeIndexes</span><span class="op" id="6384335">[</span><span class="num" id="6384336">0</span><span class="op" id="6384337">]</span><span class="op" id="6384338">)</span>&nbsp;<span class="op" id="6384340">&gt;=</span>&nbsp;<span class="builtinfunc" id="6384343">len</span><span class="op" id="6384346">(</span><span class="ident" id="6384347">huffmanTrees</span><span class="op" id="6384359">)</span>&nbsp;<span class="op" id="6384361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384365">return</span>&nbsp;<span class="ident" id="6384372">StructuralError</span><span class="op" id="6384387">(</span><span class="string" id="6384388">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6384416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384422">currentHuffmanTree</span>&nbsp;<span class="op" id="6384441">:=</span>&nbsp;<span class="ident" id="6384444">huffmanTrees</span><span class="op" id="6384456">[</span><span class="ident" id="6384457">treeIndexes</span><span class="op" id="6384468">[</span><span class="num" id="6384469">0</span><span class="op" id="6384470">]</span><span class="op" id="6384471">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384474">bufIndex</span>&nbsp;<span class="op" id="6384483">:=</span>&nbsp;<span class="num" id="6384486">0</span>&nbsp;<span class="comment" id="6384488">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6384528">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6384600">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6384667">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6384737">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384750">repeat</span>&nbsp;<span class="op" id="6384757">:=</span>&nbsp;<span class="num" id="6384760">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384763">repeat_power</span>&nbsp;<span class="op" id="6384776">:=</span>&nbsp;<span class="num" id="6384779">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6384783">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384857">for</span>&nbsp;<span class="ident" id="6384861">i</span>&nbsp;<span class="op" id="6384863">:=</span>&nbsp;<span class="keyword" id="6384866">range</span>&nbsp;<span class="ident" id="6384872">bz2</span><span class="op" id="6384875">.</span><span class="ident" id="6384876">c</span>&nbsp;<span class="op" id="6384878">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384882">bz2</span><span class="op" id="6384885">.</span><span class="ident" id="6384886">c</span><span class="op" id="6384887">[</span><span class="ident" id="6384888">i</span><span class="op" id="6384889">]</span>&nbsp;<span class="op" id="6384891">=</span>&nbsp;<span class="num" id="6384893">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384900">decoded</span>&nbsp;<span class="op" id="6384908">:=</span>&nbsp;<span class="num" id="6384911">0</span>&nbsp;<span class="comment" id="6384913">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384975">for</span>&nbsp;<span class="op" id="6384979">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384983">if</span>&nbsp;<span class="ident" id="6384986">decoded</span>&nbsp;<span class="op" id="6384994">==</span>&nbsp;<span class="num" id="6384997">50</span>&nbsp;<span class="op" id="6385000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385005">if</span>&nbsp;<span class="ident" id="6385008">selectorIndex</span>&nbsp;<span class="op" id="6385022">&gt;=</span>&nbsp;<span class="ident" id="6385025">numSelectors</span>&nbsp;<span class="op" id="6385038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385044">return</span>&nbsp;<span class="ident" id="6385051">StructuralError</span><span class="op" id="6385066">(</span><span class="string" id="6385067">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="6385120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385130">if</span>&nbsp;<span class="builtintype" id="6385133">int</span><span class="op" id="6385136">(</span><span class="ident" id="6385137">treeIndexes</span><span class="op" id="6385148">[</span><span class="ident" id="6385149">selectorIndex</span><span class="op" id="6385162">]</span><span class="op" id="6385163">)</span>&nbsp;<span class="op" id="6385165">&gt;=</span>&nbsp;<span class="builtinfunc" id="6385168">len</span><span class="op" id="6385171">(</span><span class="ident" id="6385172">huffmanTrees</span><span class="op" id="6385184">)</span>&nbsp;<span class="op" id="6385186">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385192">return</span>&nbsp;<span class="ident" id="6385199">StructuralError</span><span class="op" id="6385214">(</span><span class="string" id="6385215">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6385243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385253">currentHuffmanTree</span>&nbsp;<span class="op" id="6385272">=</span>&nbsp;<span class="ident" id="6385274">huffmanTrees</span><span class="op" id="6385286">[</span><span class="ident" id="6385287">treeIndexes</span><span class="op" id="6385298">[</span><span class="ident" id="6385299">selectorIndex</span><span class="op" id="6385312">]</span><span class="op" id="6385313">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385318">selectorIndex</span><span class="op" id="6385331">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385337">decoded</span>&nbsp;<span class="op" id="6385345">=</span>&nbsp;<span class="num" id="6385347">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385356">v</span>&nbsp;<span class="op" id="6385358">:=</span>&nbsp;<span class="ident" id="6385361">currentHuffmanTree</span><span class="op" id="6385379">.</span><span class="ident" id="6385380">Decode</span><span class="op" id="6385386">(</span><span class="ident" id="6385387">br</span><span class="op" id="6385389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385393">decoded</span><span class="op" id="6385400">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385406">if</span>&nbsp;<span class="ident" id="6385409">v</span>&nbsp;<span class="op" id="6385411">&lt;</span>&nbsp;<span class="num" id="6385413">2</span>&nbsp;<span class="op" id="6385415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6385420">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385466">if</span>&nbsp;<span class="ident" id="6385469">repeat</span>&nbsp;<span class="op" id="6385476">==</span>&nbsp;<span class="num" id="6385479">0</span>&nbsp;<span class="op" id="6385481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385487">repeat_power</span>&nbsp;<span class="op" id="6385500">=</span>&nbsp;<span class="num" id="6385502">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385507">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385512">repeat</span>&nbsp;<span class="op" id="6385519">+=</span>&nbsp;<span class="ident" id="6385522">repeat_power</span>&nbsp;<span class="op" id="6385535">&lt;&lt;</span>&nbsp;<span class="ident" id="6385538">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6385543">repeat_power</span>&nbsp;<span class="op" id="6385556">&lt;&lt;=</span>&nbsp;<span class="num" id="6385560">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6385566">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6385624">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385673">if</span>&nbsp;<span class="ident" id="6385676">repeat</span>&nbsp;<span class="op" id="6385683">&gt;</span>&nbsp;<span class="num" id="6385685">2</span><span class="op" id="6385686">*</span><span class="num" id="6385687">1024</span><span class="op" id="6385691">*</span><span class="num" id="6385692">1024</span>&nbsp;<span class="op" id="6385697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385703">return</span>&nbsp;<span class="ident" id="6385710">StructuralError</span><span class="op" id="6385725">(</span><span class="string" id="6385726">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="6385750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385760">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385771">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385776">if</span>&nbsp;<span class="ident" id="6385779">repeat</span>&nbsp;<span class="op" id="6385786">&gt;</span>&nbsp;<span class="num" id="6385788">0</span>&nbsp;<span class="op" id="6385790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6385795">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6385853">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385893">if</span>&nbsp;<span class="ident" id="6385896">repeat</span>&nbsp;<span class="op" id="6385903">&gt;</span>&nbsp;<span class="ident" id="6385905">bz2</span><span class="op" id="6385908">.</span><span class="ident" id="6385909">blockSize</span><span class="op" id="6385918">-</span><span class="ident" id="6385919">bufIndex</span>&nbsp;<span class="op" id="6385928">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385934">return</span>&nbsp;<span class="ident" id="6385941">StructuralError</span><span class="op" id="6385956">(</span><span class="string" id="6385957">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="6385984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6385989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6385994">for</span>&nbsp;<span class="ident" id="6385998">i</span>&nbsp;<span class="op" id="6386000">:=</span>&nbsp;<span class="num" id="6386003">0</span><span class="op" id="6386004">;</span>&nbsp;<span class="ident" id="6386006">i</span>&nbsp;<span class="op" id="6386008">&lt;</span>&nbsp;<span class="ident" id="6386010">repeat</span><span class="op" id="6386016">;</span>&nbsp;<span class="ident" id="6386018">i</span><span class="op" id="6386019">++</span>&nbsp;<span class="op" id="6386022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386028">b</span>&nbsp;<span class="op" id="6386030">:=</span>&nbsp;<span class="builtintype" id="6386033">byte</span><span class="op" id="6386037">(</span><span class="ident" id="6386038">mtf</span><span class="op" id="6386041">.</span><span class="ident" id="6386042">First</span><span class="op" id="6386047">(</span><span class="op" id="6386048">)</span><span class="op" id="6386049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386055">bz2</span><span class="op" id="6386058">.</span><span class="ident" id="6386059">tt</span><span class="op" id="6386061">[</span><span class="ident" id="6386062">bufIndex</span><span class="op" id="6386070">]</span>&nbsp;<span class="op" id="6386072">=</span>&nbsp;<span class="builtintype" id="6386074">uint32</span><span class="op" id="6386080">(</span><span class="ident" id="6386081">b</span><span class="op" id="6386082">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386088">bz2</span><span class="op" id="6386091">.</span><span class="ident" id="6386092">c</span><span class="op" id="6386093">[</span><span class="ident" id="6386094">b</span><span class="op" id="6386095">]</span><span class="op" id="6386096">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386103">bufIndex</span><span class="op" id="6386111">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6386117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386122">repeat</span>&nbsp;<span class="op" id="6386129">=</span>&nbsp;<span class="num" id="6386131">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6386135">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6386140">if</span>&nbsp;<span class="builtintype" id="6386143">int</span><span class="op" id="6386146">(</span><span class="ident" id="6386147">v</span><span class="op" id="6386148">)</span>&nbsp;<span class="op" id="6386150">==</span>&nbsp;<span class="ident" id="6386153">numSymbols</span><span class="op" id="6386163">-</span><span class="num" id="6386164">1</span>&nbsp;<span class="op" id="6386166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386171">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386228">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386286">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6386332">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6386340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386345">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386409">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386470">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386536">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386595">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386657">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386668">b</span>&nbsp;<span class="op" id="6386670">:=</span>&nbsp;<span class="builtintype" id="6386673">byte</span><span class="op" id="6386677">(</span><span class="ident" id="6386678">mtf</span><span class="op" id="6386681">.</span><span class="ident" id="6386682">Decode</span><span class="op" id="6386688">(</span><span class="builtintype" id="6386689">int</span><span class="op" id="6386692">(</span><span class="ident" id="6386693">v</span>&nbsp;<span class="op" id="6386695">-</span>&nbsp;<span class="num" id="6386697">1</span><span class="op" id="6386698">)</span><span class="op" id="6386699">)</span><span class="op" id="6386700">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6386704">if</span>&nbsp;<span class="ident" id="6386707">bufIndex</span>&nbsp;<span class="op" id="6386716">&gt;=</span>&nbsp;<span class="ident" id="6386719">bz2</span><span class="op" id="6386722">.</span><span class="ident" id="6386723">blockSize</span>&nbsp;<span class="op" id="6386733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6386738">return</span>&nbsp;<span class="ident" id="6386745">StructuralError</span><span class="op" id="6386760">(</span><span class="string" id="6386761">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="6386786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6386790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386794">bz2</span><span class="op" id="6386797">.</span><span class="ident" id="6386798">tt</span><span class="op" id="6386800">[</span><span class="ident" id="6386801">bufIndex</span><span class="op" id="6386809">]</span>&nbsp;<span class="op" id="6386811">=</span>&nbsp;<span class="builtintype" id="6386813">uint32</span><span class="op" id="6386819">(</span><span class="ident" id="6386820">b</span><span class="op" id="6386821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386825">bz2</span><span class="op" id="6386828">.</span><span class="ident" id="6386829">c</span><span class="op" id="6386830">[</span><span class="ident" id="6386831">b</span><span class="op" id="6386832">]</span><span class="op" id="6386833">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6386838">bufIndex</span><span class="op" id="6386846">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6386850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6386854">if</span>&nbsp;<span class="ident" id="6386857">origPtr</span>&nbsp;<span class="op" id="6386865">&gt;=</span>&nbsp;<span class="builtintype" id="6386868">uint</span><span class="op" id="6386872">(</span><span class="ident" id="6386873">bufIndex</span><span class="op" id="6386881">)</span>&nbsp;<span class="op" id="6386883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6386887">return</span>&nbsp;<span class="ident" id="6386894">StructuralError</span><span class="op" id="6386909">(</span><span class="string" id="6386910">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="6386933">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6386936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6386940">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6387007">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387049">bz2</span><span class="op" id="6387052">.</span><span class="ident" id="6387053">preRLE</span>&nbsp;<span class="op" id="6387060">=</span>&nbsp;<span class="ident" id="6387062">bz2</span><span class="op" id="6387065">.</span><span class="ident" id="6387066">tt</span><span class="op" id="6387068">[</span><span class="op" id="6387069">:</span><span class="ident" id="6387070">bufIndex</span><span class="op" id="6387078">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387081">bz2</span><span class="op" id="6387084">.</span><span class="ident" id="6387085">preRLEUsed</span>&nbsp;<span class="op" id="6387096">=</span>&nbsp;<span class="num" id="6387098">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387101">bz2</span><span class="op" id="6387104">.</span><span class="ident" id="6387105">tPos</span>&nbsp;<span class="op" id="6387110">=</span>&nbsp;<span class="ident" id="6387112">inverseBWT</span><span class="op" id="6387122">(</span><span class="ident" id="6387123">bz2</span><span class="op" id="6387126">.</span><span class="ident" id="6387127">preRLE</span><span class="op" id="6387133">,</span>&nbsp;<span class="ident" id="6387135">origPtr</span><span class="op" id="6387142">,</span>&nbsp;<span class="ident" id="6387144">bz2</span><span class="op" id="6387147">.</span><span class="ident" id="6387148">c</span><span class="op" id="6387149">[</span><span class="op" id="6387150">:</span><span class="op" id="6387151">]</span><span class="op" id="6387152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387155">bz2</span><span class="op" id="6387158">.</span><span class="ident" id="6387159">lastByte</span>&nbsp;<span class="op" id="6387168">=</span>&nbsp;<span class="op" id="6387170">-</span><span class="num" id="6387171">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387174">bz2</span><span class="op" id="6387177">.</span><span class="ident" id="6387178">byteRepeats</span>&nbsp;<span class="op" id="6387190">=</span>&nbsp;<span class="num" id="6387192">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387195">bz2</span><span class="op" id="6387198">.</span><span class="ident" id="6387199">repeats</span>&nbsp;<span class="op" id="6387207">=</span>&nbsp;<span class="num" id="6387209">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6387213">return</span>&nbsp;<span class="ident" id="6387220">nil</span><br>
<span class="lineno"></span><span class="op" id="6387224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6387227">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="6387306">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="6387383">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6387459">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="6387537">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="6387572">//</span><br>
<span class="lineno">455</span><span class="comment" id="6387575">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="6387652">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6387732">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6387809">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6387822">func</span>&nbsp;<span class="ident" id="6387827">inverseBWT</span><span class="op" id="6387837">(</span><span class="ident" id="6387838">tt</span>&nbsp;<span class="op" id="6387841">[</span><span class="op" id="6387842">]</span><span class="builtintype" id="6387843">uint32</span><span class="op" id="6387849">,</span>&nbsp;<span class="ident" id="6387851">origPtr</span>&nbsp;<span class="builtintype" id="6387859">uint</span><span class="op" id="6387863">,</span>&nbsp;<span class="ident" id="6387865">c</span>&nbsp;<span class="op" id="6387867">[</span><span class="op" id="6387868">]</span><span class="builtintype" id="6387869">uint</span><span class="op" id="6387873">)</span>&nbsp;<span class="builtintype" id="6387875">uint32</span>&nbsp;<span class="op" id="6387882">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387885">sum</span>&nbsp;<span class="op" id="6387889">:=</span>&nbsp;<span class="builtintype" id="6387892">uint</span><span class="op" id="6387896">(</span><span class="num" id="6387897">0</span><span class="op" id="6387898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6387901">for</span>&nbsp;<span class="ident" id="6387905">i</span>&nbsp;<span class="op" id="6387907">:=</span>&nbsp;<span class="num" id="6387910">0</span><span class="op" id="6387911">;</span>&nbsp;<span class="ident" id="6387913">i</span>&nbsp;<span class="op" id="6387915">&lt;</span>&nbsp;<span class="num" id="6387917">256</span><span class="op" id="6387920">;</span>&nbsp;<span class="ident" id="6387922">i</span><span class="op" id="6387923">++</span>&nbsp;<span class="op" id="6387926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387930">sum</span>&nbsp;<span class="op" id="6387934">+=</span>&nbsp;<span class="ident" id="6387937">c</span><span class="op" id="6387938">[</span><span class="ident" id="6387939">i</span><span class="op" id="6387940">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387944">c</span><span class="op" id="6387945">[</span><span class="ident" id="6387946">i</span><span class="op" id="6387947">]</span>&nbsp;<span class="op" id="6387949">=</span>&nbsp;<span class="ident" id="6387951">sum</span>&nbsp;<span class="op" id="6387955">-</span>&nbsp;<span class="ident" id="6387957">c</span><span class="op" id="6387958">[</span><span class="ident" id="6387959">i</span><span class="op" id="6387960">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6387963">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6387967">for</span>&nbsp;<span class="ident" id="6387971">i</span>&nbsp;<span class="op" id="6387973">:=</span>&nbsp;<span class="keyword" id="6387976">range</span>&nbsp;<span class="ident" id="6387982">tt</span>&nbsp;<span class="op" id="6387985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6387989">b</span>&nbsp;<span class="op" id="6387991">:=</span>&nbsp;<span class="ident" id="6387994">tt</span><span class="op" id="6387996">[</span><span class="ident" id="6387997">i</span><span class="op" id="6387998">]</span>&nbsp;<span class="op" id="6388000">&amp;</span>&nbsp;<span class="num" id="6388002">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388009">tt</span><span class="op" id="6388011">[</span><span class="ident" id="6388012">c</span><span class="op" id="6388013">[</span><span class="ident" id="6388014">b</span><span class="op" id="6388015">]</span><span class="op" id="6388016">]</span>&nbsp;<span class="op" id="6388018">|=</span>&nbsp;<span class="builtintype" id="6388021">uint32</span><span class="op" id="6388027">(</span><span class="ident" id="6388028">i</span><span class="op" id="6388029">)</span>&nbsp;<span class="op" id="6388031">&lt;&lt;</span>&nbsp;<span class="num" id="6388034">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388038">c</span><span class="op" id="6388039">[</span><span class="ident" id="6388040">b</span><span class="op" id="6388041">]</span><span class="op" id="6388042">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6388046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388050">return</span>&nbsp;<span class="ident" id="6388057">tt</span><span class="op" id="6388059">[</span><span class="ident" id="6388060">origPtr</span><span class="op" id="6388067">]</span>&nbsp;<span class="op" id="6388069">&gt;&gt;</span>&nbsp;<span class="num" id="6388072">8</span><br>
<span class="lineno"></span><span class="op" id="6388074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="6388077">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="6388165">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6388250">var</span>&nbsp;<span class="ident" id="6388254">crctab</span>&nbsp;<span class="op" id="6388261">[</span><span class="num" id="6388262">256</span><span class="op" id="6388265">]</span><span class="builtintype" id="6388266">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="6388274">func</span>&nbsp;<span class="ident" id="6388279">init</span><span class="op" id="6388283">(</span><span class="op" id="6388284">)</span>&nbsp;<span class="op" id="6388286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388289">const</span>&nbsp;<span class="ident" id="6388295">poly</span>&nbsp;<span class="op" id="6388300">=</span>&nbsp;<span class="num" id="6388302">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388314">for</span>&nbsp;<span class="ident" id="6388318">i</span>&nbsp;<span class="op" id="6388320">:=</span>&nbsp;<span class="keyword" id="6388323">range</span>&nbsp;<span class="ident" id="6388329">crctab</span>&nbsp;<span class="op" id="6388336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388340">crc</span>&nbsp;<span class="op" id="6388344">:=</span>&nbsp;<span class="builtintype" id="6388347">uint32</span><span class="op" id="6388353">(</span><span class="ident" id="6388354">i</span><span class="op" id="6388355">)</span>&nbsp;<span class="op" id="6388357">&lt;&lt;</span>&nbsp;<span class="num" id="6388360">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388365">for</span>&nbsp;<span class="ident" id="6388369">j</span>&nbsp;<span class="op" id="6388371">:=</span>&nbsp;<span class="num" id="6388374">0</span><span class="op" id="6388375">;</span>&nbsp;<span class="ident" id="6388377">j</span>&nbsp;<span class="op" id="6388379">&lt;</span>&nbsp;<span class="num" id="6388381">8</span><span class="op" id="6388382">;</span>&nbsp;<span class="ident" id="6388384">j</span><span class="op" id="6388385">++</span>&nbsp;<span class="op" id="6388388">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388393">if</span>&nbsp;<span class="ident" id="6388396">crc</span><span class="op" id="6388399">&amp;</span><span class="num" id="6388400">0x80000000</span>&nbsp;<span class="op" id="6388411">!=</span>&nbsp;<span class="num" id="6388414">0</span>&nbsp;<span class="op" id="6388416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388422">crc</span>&nbsp;<span class="op" id="6388426">=</span>&nbsp;<span class="op" id="6388428">(</span><span class="ident" id="6388429">crc</span>&nbsp;<span class="op" id="6388433">&lt;&lt;</span>&nbsp;<span class="num" id="6388436">1</span><span class="op" id="6388437">)</span>&nbsp;<span class="op" id="6388439">^</span>&nbsp;<span class="ident" id="6388441">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6388449">}</span>&nbsp;<span class="keyword" id="6388451">else</span>&nbsp;<span class="op" id="6388456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388462">crc</span>&nbsp;<span class="op" id="6388466">&lt;&lt;=</span>&nbsp;<span class="num" id="6388470">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6388475">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6388479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388483">crctab</span><span class="op" id="6388489">[</span><span class="ident" id="6388490">i</span><span class="op" id="6388491">]</span>&nbsp;<span class="op" id="6388493">=</span>&nbsp;<span class="ident" id="6388495">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6388500">}</span><br>
<span class="lineno"></span><span class="op" id="6388502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6388505">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="6388570">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="6388597">func</span>&nbsp;<span class="ident" id="6388602">updateCRC</span><span class="op" id="6388611">(</span><span class="ident" id="6388612">val</span>&nbsp;<span class="builtintype" id="6388616">uint32</span><span class="op" id="6388622">,</span>&nbsp;<span class="ident" id="6388624">b</span>&nbsp;<span class="op" id="6388626">[</span><span class="op" id="6388627">]</span><span class="builtintype" id="6388628">byte</span><span class="op" id="6388632">)</span>&nbsp;<span class="builtintype" id="6388634">uint32</span>&nbsp;<span class="op" id="6388641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388644">crc</span>&nbsp;<span class="op" id="6388648">:=</span>&nbsp;<span class="op" id="6388651">^</span><span class="ident" id="6388652">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388657">for</span>&nbsp;<span class="ident" id="6388661">_</span><span class="op" id="6388662">,</span>&nbsp;<span class="ident" id="6388664">v</span>&nbsp;<span class="op" id="6388666">:=</span>&nbsp;<span class="keyword" id="6388669">range</span>&nbsp;<span class="ident" id="6388675">b</span>&nbsp;<span class="op" id="6388677">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6388681">crc</span>&nbsp;<span class="op" id="6388685">=</span>&nbsp;<span class="ident" id="6388687">crctab</span><span class="op" id="6388693">[</span><span class="builtintype" id="6388694">byte</span><span class="op" id="6388698">(</span><span class="ident" id="6388699">crc</span><span class="op" id="6388702">&gt;&gt;</span><span class="num" id="6388704">24</span><span class="op" id="6388706">)</span><span class="op" id="6388707">^</span><span class="ident" id="6388708">v</span><span class="op" id="6388709">]</span>&nbsp;<span class="op" id="6388711">^</span>&nbsp;<span class="op" id="6388713">(</span><span class="ident" id="6388714">crc</span>&nbsp;<span class="op" id="6388718">&lt;&lt;</span>&nbsp;<span class="num" id="6388721">8</span><span class="op" id="6388722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6388725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6388728">return</span>&nbsp;<span class="op" id="6388735">^</span><span class="ident" id="6388736">crc</span><br>
<span class="lineno"></span><span class="op" id="6388740">}</span>
</div>
</body>
</html>
