<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3905915">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3905970">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3906024">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3906075">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3906113">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3906187">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3906260">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3906294">package</span>&nbsp;<span class="ident" id="3906302">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3906310">type</span>&nbsp;<span class="ident" id="3906315">cbc</span>&nbsp;<span class="keyword" id="3906319">struct</span>&nbsp;<span class="op" id="3906326">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906329">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3906339">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906346">blockSize</span>&nbsp;<span class="builtintype" id="3906356">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906361">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906371">[</span><span class="op" id="3906372">]</span><span class="builtintype" id="3906373">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906379">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906389">[</span><span class="op" id="3906390">]</span><span class="builtintype" id="3906391">byte</span><br>
<span class="lineno"></span><span class="op" id="3906396">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3906399">func</span>&nbsp;<span class="ident" id="3906404">newCBC</span><span class="op" id="3906410">(</span><span class="ident" id="3906411">b</span>&nbsp;<span class="ident" id="3906413">Block</span><span class="op" id="3906418">,</span>&nbsp;<span class="ident" id="3906420">iv</span>&nbsp;<span class="op" id="3906423">[</span><span class="op" id="3906424">]</span><span class="builtintype" id="3906425">byte</span><span class="op" id="3906429">)</span>&nbsp;<span class="op" id="3906431">*</span><span class="ident" id="3906432">cbc</span>&nbsp;<span class="op" id="3906436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906439">return</span>&nbsp;<span class="op" id="3906446">&amp;</span><span class="ident" id="3906447">cbc</span><span class="op" id="3906450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906454">b</span><span class="op" id="3906455">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3906465">b</span><span class="op" id="3906466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906470">blockSize</span><span class="op" id="3906479">:</span>&nbsp;<span class="ident" id="3906481">b</span><span class="op" id="3906482">.</span><span class="ident" id="3906483">BlockSize</span><span class="op" id="3906492">(</span><span class="op" id="3906493">)</span><span class="op" id="3906494">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906498">iv</span><span class="op" id="3906500">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3906509">dup</span><span class="op" id="3906512">(</span><span class="ident" id="3906513">iv</span><span class="op" id="3906515">)</span><span class="op" id="3906516">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906520">tmp</span><span class="op" id="3906523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3906531">make</span><span class="op" id="3906535">(</span><span class="op" id="3906536">[</span><span class="op" id="3906537">]</span><span class="builtintype" id="3906538">byte</span><span class="op" id="3906542">,</span>&nbsp;<span class="ident" id="3906544">b</span><span class="op" id="3906545">.</span><span class="ident" id="3906546">BlockSize</span><span class="op" id="3906555">(</span><span class="op" id="3906556">)</span><span class="op" id="3906557">)</span><span class="op" id="3906558">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906561">}</span><br>
<span class="lineno"></span><span class="op" id="3906563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3906566">type</span>&nbsp;<span class="ident" id="3906571">cbcEncrypter</span>&nbsp;<span class="ident" id="3906584">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3906589">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3906668">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3906741">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3906764">func</span>&nbsp;<span class="ident" id="3906769">NewCBCEncrypter</span><span class="op" id="3906784">(</span><span class="ident" id="3906785">b</span>&nbsp;<span class="ident" id="3906787">Block</span><span class="op" id="3906792">,</span>&nbsp;<span class="ident" id="3906794">iv</span>&nbsp;<span class="op" id="3906797">[</span><span class="op" id="3906798">]</span><span class="builtintype" id="3906799">byte</span><span class="op" id="3906803">)</span>&nbsp;<span class="ident" id="3906805">BlockMode</span>&nbsp;<span class="op" id="3906815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906818">if</span>&nbsp;<span class="builtinfunc" id="3906821">len</span><span class="op" id="3906824">(</span><span class="ident" id="3906825">iv</span><span class="op" id="3906827">)</span>&nbsp;<span class="op" id="3906829">!=</span>&nbsp;<span class="ident" id="3906832">b</span><span class="op" id="3906833">.</span><span class="ident" id="3906834">BlockSize</span><span class="op" id="3906843">(</span><span class="op" id="3906844">)</span>&nbsp;<span class="op" id="3906846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3906850">panic</span><span class="op" id="3906855">(</span><span class="string" id="3906856">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3906913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906919">return</span>&nbsp;<span class="op" id="3906926">(</span><span class="op" id="3906927">*</span><span class="ident" id="3906928">cbcEncrypter</span><span class="op" id="3906940">)</span><span class="op" id="3906941">(</span><span class="ident" id="3906942">newCBC</span><span class="op" id="3906948">(</span><span class="ident" id="3906949">b</span><span class="op" id="3906950">,</span>&nbsp;<span class="ident" id="3906952">iv</span><span class="op" id="3906954">)</span><span class="op" id="3906955">)</span><br>
<span class="lineno">40</span><span class="op" id="3906957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3906960">func</span>&nbsp;<span class="op" id="3906965">(</span><span class="ident" id="3906966">x</span>&nbsp;<span class="op" id="3906968">*</span><span class="ident" id="3906969">cbcEncrypter</span><span class="op" id="3906981">)</span>&nbsp;<span class="ident" id="3906983">BlockSize</span><span class="op" id="3906992">(</span><span class="op" id="3906993">)</span>&nbsp;<span class="builtintype" id="3906995">int</span>&nbsp;<span class="op" id="3906999">{</span>&nbsp;<span class="keyword" id="3907001">return</span>&nbsp;<span class="ident" id="3907008">x</span><span class="op" id="3907009">.</span><span class="ident" id="3907010">blockSize</span>&nbsp;<span class="op" id="3907020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3907023">func</span>&nbsp;<span class="op" id="3907028">(</span><span class="ident" id="3907029">x</span>&nbsp;<span class="op" id="3907031">*</span><span class="ident" id="3907032">cbcEncrypter</span><span class="op" id="3907044">)</span>&nbsp;<span class="ident" id="3907046">CryptBlocks</span><span class="op" id="3907057">(</span><span class="ident" id="3907058">dst</span><span class="op" id="3907061">,</span>&nbsp;<span class="ident" id="3907063">src</span>&nbsp;<span class="op" id="3907067">[</span><span class="op" id="3907068">]</span><span class="builtintype" id="3907069">byte</span><span class="op" id="3907073">)</span>&nbsp;<span class="op" id="3907075">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907078">if</span>&nbsp;<span class="builtinfunc" id="3907081">len</span><span class="op" id="3907084">(</span><span class="ident" id="3907085">src</span><span class="op" id="3907088">)</span><span class="op" id="3907089">%</span><span class="ident" id="3907090">x</span><span class="op" id="3907091">.</span><span class="ident" id="3907092">blockSize</span>&nbsp;<span class="op" id="3907102">!=</span>&nbsp;<span class="num" id="3907105">0</span>&nbsp;<span class="op" id="3907107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3907111">panic</span><span class="op" id="3907116">(</span><span class="string" id="3907117">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3907155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907161">if</span>&nbsp;<span class="builtinfunc" id="3907164">len</span><span class="op" id="3907167">(</span><span class="ident" id="3907168">dst</span><span class="op" id="3907171">)</span>&nbsp;<span class="op" id="3907173">&lt;</span>&nbsp;<span class="builtinfunc" id="3907175">len</span><span class="op" id="3907178">(</span><span class="ident" id="3907179">src</span><span class="op" id="3907182">)</span>&nbsp;<span class="op" id="3907184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3907188">panic</span><span class="op" id="3907193">(</span><span class="string" id="3907194">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3907236">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907243">iv</span>&nbsp;<span class="op" id="3907246">:=</span>&nbsp;<span class="ident" id="3907249">x</span><span class="op" id="3907250">.</span><span class="ident" id="3907251">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907256">for</span>&nbsp;<span class="builtinfunc" id="3907260">len</span><span class="op" id="3907263">(</span><span class="ident" id="3907264">src</span><span class="op" id="3907267">)</span>&nbsp;<span class="op" id="3907269">&gt;</span>&nbsp;<span class="num" id="3907271">0</span>&nbsp;<span class="op" id="3907273">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907277">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907327">xorBytes</span><span class="op" id="3907335">(</span><span class="ident" id="3907336">dst</span><span class="op" id="3907339">[</span><span class="op" id="3907340">:</span><span class="ident" id="3907341">x</span><span class="op" id="3907342">.</span><span class="ident" id="3907343">blockSize</span><span class="op" id="3907352">]</span><span class="op" id="3907353">,</span>&nbsp;<span class="ident" id="3907355">src</span><span class="op" id="3907358">[</span><span class="op" id="3907359">:</span><span class="ident" id="3907360">x</span><span class="op" id="3907361">.</span><span class="ident" id="3907362">blockSize</span><span class="op" id="3907371">]</span><span class="op" id="3907372">,</span>&nbsp;<span class="ident" id="3907374">iv</span><span class="op" id="3907376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907380">x</span><span class="op" id="3907381">.</span><span class="ident" id="3907382">b</span><span class="op" id="3907383">.</span><span class="ident" id="3907384">Encrypt</span><span class="op" id="3907391">(</span><span class="ident" id="3907392">dst</span><span class="op" id="3907395">[</span><span class="op" id="3907396">:</span><span class="ident" id="3907397">x</span><span class="op" id="3907398">.</span><span class="ident" id="3907399">blockSize</span><span class="op" id="3907408">]</span><span class="op" id="3907409">,</span>&nbsp;<span class="ident" id="3907411">dst</span><span class="op" id="3907414">[</span><span class="op" id="3907415">:</span><span class="ident" id="3907416">x</span><span class="op" id="3907417">.</span><span class="ident" id="3907418">blockSize</span><span class="op" id="3907427">]</span><span class="op" id="3907428">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907433">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907493">iv</span>&nbsp;<span class="op" id="3907496">=</span>&nbsp;<span class="ident" id="3907498">dst</span><span class="op" id="3907501">[</span><span class="op" id="3907502">:</span><span class="ident" id="3907503">x</span><span class="op" id="3907504">.</span><span class="ident" id="3907505">blockSize</span><span class="op" id="3907514">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907518">src</span>&nbsp;<span class="op" id="3907522">=</span>&nbsp;<span class="ident" id="3907524">src</span><span class="op" id="3907527">[</span><span class="ident" id="3907528">x</span><span class="op" id="3907529">.</span><span class="ident" id="3907530">blockSize</span><span class="op" id="3907539">:</span><span class="op" id="3907540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907544">dst</span>&nbsp;<span class="op" id="3907548">=</span>&nbsp;<span class="ident" id="3907550">dst</span><span class="op" id="3907553">[</span><span class="ident" id="3907554">x</span><span class="op" id="3907555">.</span><span class="ident" id="3907556">blockSize</span><span class="op" id="3907565">:</span><span class="op" id="3907566">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907573">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3907620">copy</span><span class="op" id="3907624">(</span><span class="ident" id="3907625">x</span><span class="op" id="3907626">.</span><span class="ident" id="3907627">iv</span><span class="op" id="3907629">,</span>&nbsp;<span class="ident" id="3907631">iv</span><span class="op" id="3907633">)</span><br>
<span class="lineno"></span><span class="op" id="3907635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3907638">func</span>&nbsp;<span class="op" id="3907643">(</span><span class="ident" id="3907644">x</span>&nbsp;<span class="op" id="3907646">*</span><span class="ident" id="3907647">cbcEncrypter</span><span class="op" id="3907659">)</span>&nbsp;<span class="ident" id="3907661">SetIV</span><span class="op" id="3907666">(</span><span class="ident" id="3907667">iv</span>&nbsp;<span class="op" id="3907670">[</span><span class="op" id="3907671">]</span><span class="builtintype" id="3907672">byte</span><span class="op" id="3907676">)</span>&nbsp;<span class="op" id="3907678">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907681">if</span>&nbsp;<span class="builtinfunc" id="3907684">len</span><span class="op" id="3907687">(</span><span class="ident" id="3907688">iv</span><span class="op" id="3907690">)</span>&nbsp;<span class="op" id="3907692">!=</span>&nbsp;<span class="builtinfunc" id="3907695">len</span><span class="op" id="3907698">(</span><span class="ident" id="3907699">x</span><span class="op" id="3907700">.</span><span class="ident" id="3907701">iv</span><span class="op" id="3907703">)</span>&nbsp;<span class="op" id="3907705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3907709">panic</span><span class="op" id="3907714">(</span><span class="string" id="3907715">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3907744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3907750">copy</span><span class="op" id="3907754">(</span><span class="ident" id="3907755">x</span><span class="op" id="3907756">.</span><span class="ident" id="3907757">iv</span><span class="op" id="3907759">,</span>&nbsp;<span class="ident" id="3907761">iv</span><span class="op" id="3907763">)</span><br>
<span class="lineno"></span><span class="op" id="3907765">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3907768">type</span>&nbsp;<span class="ident" id="3907773">cbcDecrypter</span>&nbsp;<span class="ident" id="3907786">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3907791">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3907870">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3907943">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3908013">func</span>&nbsp;<span class="ident" id="3908018">NewCBCDecrypter</span><span class="op" id="3908033">(</span><span class="ident" id="3908034">b</span>&nbsp;<span class="ident" id="3908036">Block</span><span class="op" id="3908041">,</span>&nbsp;<span class="ident" id="3908043">iv</span>&nbsp;<span class="op" id="3908046">[</span><span class="op" id="3908047">]</span><span class="builtintype" id="3908048">byte</span><span class="op" id="3908052">)</span>&nbsp;<span class="ident" id="3908054">BlockMode</span>&nbsp;<span class="op" id="3908064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908067">if</span>&nbsp;<span class="builtinfunc" id="3908070">len</span><span class="op" id="3908073">(</span><span class="ident" id="3908074">iv</span><span class="op" id="3908076">)</span>&nbsp;<span class="op" id="3908078">!=</span>&nbsp;<span class="ident" id="3908081">b</span><span class="op" id="3908082">.</span><span class="ident" id="3908083">BlockSize</span><span class="op" id="3908092">(</span><span class="op" id="3908093">)</span>&nbsp;<span class="op" id="3908095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3908099">panic</span><span class="op" id="3908104">(</span><span class="string" id="3908105">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3908162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908165">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908168">return</span>&nbsp;<span class="op" id="3908175">(</span><span class="op" id="3908176">*</span><span class="ident" id="3908177">cbcDecrypter</span><span class="op" id="3908189">)</span><span class="op" id="3908190">(</span><span class="ident" id="3908191">newCBC</span><span class="op" id="3908197">(</span><span class="ident" id="3908198">b</span><span class="op" id="3908199">,</span>&nbsp;<span class="ident" id="3908201">iv</span><span class="op" id="3908203">)</span><span class="op" id="3908204">)</span><br>
<span class="lineno"></span><span class="op" id="3908206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3908209">func</span>&nbsp;<span class="op" id="3908214">(</span><span class="ident" id="3908215">x</span>&nbsp;<span class="op" id="3908217">*</span><span class="ident" id="3908218">cbcDecrypter</span><span class="op" id="3908230">)</span>&nbsp;<span class="ident" id="3908232">BlockSize</span><span class="op" id="3908241">(</span><span class="op" id="3908242">)</span>&nbsp;<span class="builtintype" id="3908244">int</span>&nbsp;<span class="op" id="3908248">{</span>&nbsp;<span class="keyword" id="3908250">return</span>&nbsp;<span class="ident" id="3908257">x</span><span class="op" id="3908258">.</span><span class="ident" id="3908259">blockSize</span>&nbsp;<span class="op" id="3908269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3908272">func</span>&nbsp;<span class="op" id="3908277">(</span><span class="ident" id="3908278">x</span>&nbsp;<span class="op" id="3908280">*</span><span class="ident" id="3908281">cbcDecrypter</span><span class="op" id="3908293">)</span>&nbsp;<span class="ident" id="3908295">CryptBlocks</span><span class="op" id="3908306">(</span><span class="ident" id="3908307">dst</span><span class="op" id="3908310">,</span>&nbsp;<span class="ident" id="3908312">src</span>&nbsp;<span class="op" id="3908316">[</span><span class="op" id="3908317">]</span><span class="builtintype" id="3908318">byte</span><span class="op" id="3908322">)</span>&nbsp;<span class="op" id="3908324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908327">if</span>&nbsp;<span class="builtinfunc" id="3908330">len</span><span class="op" id="3908333">(</span><span class="ident" id="3908334">src</span><span class="op" id="3908337">)</span><span class="op" id="3908338">%</span><span class="ident" id="3908339">x</span><span class="op" id="3908340">.</span><span class="ident" id="3908341">blockSize</span>&nbsp;<span class="op" id="3908351">!=</span>&nbsp;<span class="num" id="3908354">0</span>&nbsp;<span class="op" id="3908356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3908360">panic</span><span class="op" id="3908365">(</span><span class="string" id="3908366">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3908404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908410">if</span>&nbsp;<span class="builtinfunc" id="3908413">len</span><span class="op" id="3908416">(</span><span class="ident" id="3908417">dst</span><span class="op" id="3908420">)</span>&nbsp;<span class="op" id="3908422">&lt;</span>&nbsp;<span class="builtinfunc" id="3908424">len</span><span class="op" id="3908427">(</span><span class="ident" id="3908428">src</span><span class="op" id="3908431">)</span>&nbsp;<span class="op" id="3908433">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3908437">panic</span><span class="op" id="3908442">(</span><span class="string" id="3908443">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3908485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908491">if</span>&nbsp;<span class="builtinfunc" id="3908494">len</span><span class="op" id="3908497">(</span><span class="ident" id="3908498">src</span><span class="op" id="3908501">)</span>&nbsp;<span class="op" id="3908503">==</span>&nbsp;<span class="num" id="3908506">0</span>&nbsp;<span class="op" id="3908508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908512">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908520">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3908524">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3908625">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908698">end</span>&nbsp;<span class="op" id="3908702">:=</span>&nbsp;<span class="builtinfunc" id="3908705">len</span><span class="op" id="3908708">(</span><span class="ident" id="3908709">src</span><span class="op" id="3908712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908715">start</span>&nbsp;<span class="op" id="3908721">:=</span>&nbsp;<span class="ident" id="3908724">end</span>&nbsp;<span class="op" id="3908728">-</span>&nbsp;<span class="ident" id="3908730">x</span><span class="op" id="3908731">.</span><span class="ident" id="3908732">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908743">prev</span>&nbsp;<span class="op" id="3908748">:=</span>&nbsp;<span class="ident" id="3908751">start</span>&nbsp;<span class="op" id="3908757">-</span>&nbsp;<span class="ident" id="3908759">x</span><span class="op" id="3908760">.</span><span class="ident" id="3908761">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3908773">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3908841">copy</span><span class="op" id="3908845">(</span><span class="ident" id="3908846">x</span><span class="op" id="3908847">.</span><span class="ident" id="3908848">tmp</span><span class="op" id="3908851">,</span>&nbsp;<span class="ident" id="3908853">src</span><span class="op" id="3908856">[</span><span class="ident" id="3908857">start</span><span class="op" id="3908862">:</span><span class="ident" id="3908863">end</span><span class="op" id="3908866">]</span><span class="op" id="3908867">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3908871">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908910">for</span>&nbsp;<span class="ident" id="3908914">start</span>&nbsp;<span class="op" id="3908920">&gt;</span>&nbsp;<span class="num" id="3908922">0</span>&nbsp;<span class="op" id="3908924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908928">x</span><span class="op" id="3908929">.</span><span class="ident" id="3908930">b</span><span class="op" id="3908931">.</span><span class="ident" id="3908932">Decrypt</span><span class="op" id="3908939">(</span><span class="ident" id="3908940">dst</span><span class="op" id="3908943">[</span><span class="ident" id="3908944">start</span><span class="op" id="3908949">:</span><span class="ident" id="3908950">end</span><span class="op" id="3908953">]</span><span class="op" id="3908954">,</span>&nbsp;<span class="ident" id="3908956">src</span><span class="op" id="3908959">[</span><span class="ident" id="3908960">start</span><span class="op" id="3908965">:</span><span class="ident" id="3908966">end</span><span class="op" id="3908969">]</span><span class="op" id="3908970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908974">xorBytes</span><span class="op" id="3908982">(</span><span class="ident" id="3908983">dst</span><span class="op" id="3908986">[</span><span class="ident" id="3908987">start</span><span class="op" id="3908992">:</span><span class="ident" id="3908993">end</span><span class="op" id="3908996">]</span><span class="op" id="3908997">,</span>&nbsp;<span class="ident" id="3908999">dst</span><span class="op" id="3909002">[</span><span class="ident" id="3909003">start</span><span class="op" id="3909008">:</span><span class="ident" id="3909009">end</span><span class="op" id="3909012">]</span><span class="op" id="3909013">,</span>&nbsp;<span class="ident" id="3909015">src</span><span class="op" id="3909018">[</span><span class="ident" id="3909019">prev</span><span class="op" id="3909023">:</span><span class="ident" id="3909024">start</span><span class="op" id="3909029">]</span><span class="op" id="3909030">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909035">end</span>&nbsp;<span class="op" id="3909039">=</span>&nbsp;<span class="ident" id="3909041">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909049">start</span>&nbsp;<span class="op" id="3909055">=</span>&nbsp;<span class="ident" id="3909057">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909064">prev</span>&nbsp;<span class="op" id="3909069">-=</span>&nbsp;<span class="ident" id="3909072">x</span><span class="op" id="3909073">.</span><span class="ident" id="3909074">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909089">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909150">x</span><span class="op" id="3909151">.</span><span class="ident" id="3909152">b</span><span class="op" id="3909153">.</span><span class="ident" id="3909154">Decrypt</span><span class="op" id="3909161">(</span><span class="ident" id="3909162">dst</span><span class="op" id="3909165">[</span><span class="ident" id="3909166">start</span><span class="op" id="3909171">:</span><span class="ident" id="3909172">end</span><span class="op" id="3909175">]</span><span class="op" id="3909176">,</span>&nbsp;<span class="ident" id="3909178">src</span><span class="op" id="3909181">[</span><span class="ident" id="3909182">start</span><span class="op" id="3909187">:</span><span class="ident" id="3909188">end</span><span class="op" id="3909191">]</span><span class="op" id="3909192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909195">xorBytes</span><span class="op" id="3909203">(</span><span class="ident" id="3909204">dst</span><span class="op" id="3909207">[</span><span class="ident" id="3909208">start</span><span class="op" id="3909213">:</span><span class="ident" id="3909214">end</span><span class="op" id="3909217">]</span><span class="op" id="3909218">,</span>&nbsp;<span class="ident" id="3909220">dst</span><span class="op" id="3909223">[</span><span class="ident" id="3909224">start</span><span class="op" id="3909229">:</span><span class="ident" id="3909230">end</span><span class="op" id="3909233">]</span><span class="op" id="3909234">,</span>&nbsp;<span class="ident" id="3909236">x</span><span class="op" id="3909237">.</span><span class="ident" id="3909238">iv</span><span class="op" id="3909240">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909244">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909301">x</span><span class="op" id="3909302">.</span><span class="ident" id="3909303">iv</span><span class="op" id="3909305">,</span>&nbsp;<span class="ident" id="3909307">x</span><span class="op" id="3909308">.</span><span class="ident" id="3909309">tmp</span>&nbsp;<span class="op" id="3909313">=</span>&nbsp;<span class="ident" id="3909315">x</span><span class="op" id="3909316">.</span><span class="ident" id="3909317">tmp</span><span class="op" id="3909320">,</span>&nbsp;<span class="ident" id="3909322">x</span><span class="op" id="3909323">.</span><span class="ident" id="3909324">iv</span><br>
<span class="lineno"></span><span class="op" id="3909327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3909330">func</span>&nbsp;<span class="op" id="3909335">(</span><span class="ident" id="3909336">x</span>&nbsp;<span class="op" id="3909338">*</span><span class="ident" id="3909339">cbcDecrypter</span><span class="op" id="3909351">)</span>&nbsp;<span class="ident" id="3909353">SetIV</span><span class="op" id="3909358">(</span><span class="ident" id="3909359">iv</span>&nbsp;<span class="op" id="3909362">[</span><span class="op" id="3909363">]</span><span class="builtintype" id="3909364">byte</span><span class="op" id="3909368">)</span>&nbsp;<span class="op" id="3909370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909373">if</span>&nbsp;<span class="builtinfunc" id="3909376">len</span><span class="op" id="3909379">(</span><span class="ident" id="3909380">iv</span><span class="op" id="3909382">)</span>&nbsp;<span class="op" id="3909384">!=</span>&nbsp;<span class="builtinfunc" id="3909387">len</span><span class="op" id="3909390">(</span><span class="ident" id="3909391">x</span><span class="op" id="3909392">.</span><span class="ident" id="3909393">iv</span><span class="op" id="3909395">)</span>&nbsp;<span class="op" id="3909397">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3909401">panic</span><span class="op" id="3909406">(</span><span class="string" id="3909407">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3909436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3909442">copy</span><span class="op" id="3909446">(</span><span class="ident" id="3909447">x</span><span class="op" id="3909448">.</span><span class="ident" id="3909449">iv</span><span class="op" id="3909451">,</span>&nbsp;<span class="ident" id="3909453">iv</span><span class="op" id="3909455">)</span><br>
<span class="lineno"></span><span class="op" id="3909457">}</span>
</div>
</body>
</html>
