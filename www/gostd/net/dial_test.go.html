<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html" class="current">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6633494">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6633549">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6633603">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6633654">package</span>&nbsp;<span class="ident" id="6633662">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6633667">import</span>&nbsp;<span class="op" id="6633674">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633677">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633686">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633694">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633701">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633707">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633713">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633724">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633735">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633745">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633756">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633767">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633775">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6633786">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6633793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6633796">func</span>&nbsp;<span class="ident" id="6633801">newLocalListener</span><span class="op" id="6633817">(</span><span class="ident" id="6633818">t</span>&nbsp;<span class="op" id="6633820">*</span><span class="ident" id="6633821">testing</span><span class="op" id="6633828">.</span><span class="ident" id="6633829">T</span><span class="op" id="6633830">)</span>&nbsp;<span class="ident" id="6633832">Listener</span>&nbsp;<span class="op" id="6633841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6633844">ln</span><span class="op" id="6633846">,</span>&nbsp;<span class="ident" id="6633848">err</span>&nbsp;<span class="op" id="6633852">:=</span>&nbsp;<span class="ident" id="6633855">Listen</span><span class="op" id="6633861">(</span><span class="string" id="6633862">&#34;tcp&#34;</span><span class="op" id="6633867">,</span>&nbsp;<span class="string" id="6633869">&#34;127.0.0.1:0&#34;</span><span class="op" id="6633882">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6633885">if</span>&nbsp;<span class="ident" id="6633888">err</span>&nbsp;<span class="op" id="6633892">!=</span>&nbsp;<span class="builtintype" id="6633895">nil</span>&nbsp;<span class="op" id="6633899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6633903">ln</span><span class="op" id="6633905">,</span>&nbsp;<span class="ident" id="6633907">err</span>&nbsp;<span class="op" id="6633911">=</span>&nbsp;<span class="ident" id="6633913">Listen</span><span class="op" id="6633919">(</span><span class="string" id="6633920">&#34;tcp6&#34;</span><span class="op" id="6633926">,</span>&nbsp;<span class="string" id="6633928">&#34;[::1]:0&#34;</span><span class="op" id="6633937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6633940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6633943">if</span>&nbsp;<span class="ident" id="6633946">err</span>&nbsp;<span class="op" id="6633950">!=</span>&nbsp;<span class="builtintype" id="6633953">nil</span>&nbsp;<span class="op" id="6633957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6633961">t</span><span class="op" id="6633962">.</span><span class="ident" id="6633963">Fatal</span><span class="op" id="6633968">(</span><span class="ident" id="6633969">err</span><span class="op" id="6633972">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6633975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6633978">return</span>&nbsp;<span class="ident" id="6633985">ln</span><br>
<span class="lineno"></span><span class="op" id="6633988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6633991">func</span>&nbsp;<span class="ident" id="6633996">TestDialTimeout</span><span class="op" id="6634011">(</span><span class="ident" id="6634012">t</span>&nbsp;<span class="op" id="6634014">*</span><span class="ident" id="6634015">testing</span><span class="op" id="6634022">.</span><span class="ident" id="6634023">T</span><span class="op" id="6634024">)</span>&nbsp;<span class="op" id="6634026">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634029">origBacklog</span>&nbsp;<span class="op" id="6634041">:=</span>&nbsp;<span class="ident" id="6634044">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634061">defer</span>&nbsp;<span class="keyword" id="6634067">func</span><span class="op" id="6634071">(</span><span class="op" id="6634072">)</span>&nbsp;<span class="op" id="6634074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634078">listenerBacklog</span>&nbsp;<span class="op" id="6634094">=</span>&nbsp;<span class="ident" id="6634096">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6634109">}</span><span class="op" id="6634110">(</span><span class="op" id="6634111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634114">listenerBacklog</span>&nbsp;<span class="op" id="6634130">=</span>&nbsp;<span class="num" id="6634132">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634136">ln</span>&nbsp;<span class="op" id="6634139">:=</span>&nbsp;<span class="ident" id="6634142">newLocalListener</span><span class="op" id="6634158">(</span><span class="ident" id="6634159">t</span><span class="op" id="6634160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634163">defer</span>&nbsp;<span class="ident" id="6634169">ln</span><span class="op" id="6634171">.</span><span class="ident" id="6634172">Close</span><span class="op" id="6634177">(</span><span class="op" id="6634178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634182">errc</span>&nbsp;<span class="op" id="6634187">:=</span>&nbsp;<span class="builtinfunc" id="6634190">make</span><span class="op" id="6634194">(</span><span class="keyword" id="6634195">chan</span>&nbsp;<span class="builtintype" id="6634200">error</span><span class="op" id="6634205">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634209">numConns</span>&nbsp;<span class="op" id="6634218">:=</span>&nbsp;<span class="ident" id="6634221">listenerBacklog</span>&nbsp;<span class="op" id="6634237">+</span>&nbsp;<span class="num" id="6634239">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634245">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634302">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634351">switch</span>&nbsp;<span class="ident" id="6634358">runtime</span><span class="op" id="6634365">.</span><span class="ident" id="6634366">GOOS</span>&nbsp;<span class="op" id="6634371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634374">case</span>&nbsp;<span class="string" id="6634379">&#34;linux&#34;</span><span class="op" id="6634386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634390">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634460">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634530">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634600">for</span>&nbsp;<span class="ident" id="6634604">i</span>&nbsp;<span class="op" id="6634606">:=</span>&nbsp;<span class="num" id="6634609">0</span><span class="op" id="6634610">;</span>&nbsp;<span class="ident" id="6634612">i</span>&nbsp;<span class="op" id="6634614">&lt;</span>&nbsp;<span class="ident" id="6634616">numConns</span><span class="op" id="6634624">;</span>&nbsp;<span class="ident" id="6634626">i</span><span class="op" id="6634627">++</span>&nbsp;<span class="op" id="6634630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634635">go</span>&nbsp;<span class="keyword" id="6634638">func</span><span class="op" id="6634642">(</span><span class="op" id="6634643">)</span>&nbsp;<span class="op" id="6634645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634651">_</span><span class="op" id="6634652">,</span>&nbsp;<span class="ident" id="6634654">err</span>&nbsp;<span class="op" id="6634658">:=</span>&nbsp;<span class="ident" id="6634661">DialTimeout</span><span class="op" id="6634672">(</span><span class="string" id="6634673">&#34;tcp&#34;</span><span class="op" id="6634678">,</span>&nbsp;<span class="ident" id="6634680">ln</span><span class="op" id="6634682">.</span><span class="ident" id="6634683">Addr</span><span class="op" id="6634687">(</span><span class="op" id="6634688">)</span><span class="op" id="6634689">.</span><span class="ident" id="6634690">String</span><span class="op" id="6634696">(</span><span class="op" id="6634697">)</span><span class="op" id="6634698">,</span>&nbsp;<span class="num" id="6634700">200</span><span class="op" id="6634703">*</span><span class="ident" id="6634704">time</span><span class="op" id="6634708">.</span><span class="ident" id="6634709">Millisecond</span><span class="op" id="6634720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6634726">errc</span>&nbsp;<span class="op" id="6634731">&lt;-</span>&nbsp;<span class="ident" id="6634734">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6634741">}</span><span class="op" id="6634742">(</span><span class="op" id="6634743">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6634747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6634750">case</span>&nbsp;<span class="string" id="6634755">&#34;darwin&#34;</span><span class="op" id="6634763">,</span>&nbsp;<span class="string" id="6634765">&#34;plan9&#34;</span><span class="op" id="6634772">,</span>&nbsp;<span class="string" id="6634774">&#34;windows&#34;</span><span class="op" id="6634783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634787">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634841">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634896">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634950">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634973">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6634978">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635040">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635096">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635150">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635210">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635215">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635282">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635379">go</span>&nbsp;<span class="keyword" id="6635382">func</span><span class="op" id="6635386">(</span><span class="op" id="6635387">)</span>&nbsp;<span class="op" id="6635389">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635394">c</span><span class="op" id="6635395">,</span>&nbsp;<span class="ident" id="6635397">err</span>&nbsp;<span class="op" id="6635401">:=</span>&nbsp;<span class="ident" id="6635404">DialTimeout</span><span class="op" id="6635415">(</span><span class="string" id="6635416">&#34;tcp&#34;</span><span class="op" id="6635421">,</span>&nbsp;<span class="string" id="6635423">&#34;127.0.71.111:49151&#34;</span><span class="op" id="6635443">,</span>&nbsp;<span class="num" id="6635445">200</span><span class="op" id="6635448">*</span><span class="ident" id="6635449">time</span><span class="op" id="6635453">.</span><span class="ident" id="6635454">Millisecond</span><span class="op" id="6635465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635470">if</span>&nbsp;<span class="ident" id="6635473">err</span>&nbsp;<span class="op" id="6635477">==</span>&nbsp;<span class="builtintype" id="6635480">nil</span>&nbsp;<span class="op" id="6635484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635490">err</span>&nbsp;<span class="op" id="6635494">=</span>&nbsp;<span class="ident" id="6635496">fmt</span><span class="op" id="6635499">.</span><span class="ident" id="6635500">Errorf</span><span class="op" id="6635506">(</span><span class="string" id="6635507">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="6635537">,</span>&nbsp;<span class="ident" id="6635539">c</span><span class="op" id="6635540">.</span><span class="ident" id="6635541">RemoteAddr</span><span class="op" id="6635551">(</span><span class="op" id="6635552">)</span><span class="op" id="6635553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635559">c</span><span class="op" id="6635560">.</span><span class="ident" id="6635561">Close</span><span class="op" id="6635566">(</span><span class="op" id="6635567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6635572">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635577">errc</span>&nbsp;<span class="op" id="6635582">&lt;-</span>&nbsp;<span class="ident" id="6635585">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6635591">}</span><span class="op" id="6635592">(</span><span class="op" id="6635593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635596">default</span><span class="op" id="6635603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635607">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635628">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635694">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635750">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6635766">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635828">t</span><span class="op" id="6635829">.</span><span class="ident" id="6635830">Skipf</span><span class="op" id="6635835">(</span><span class="string" id="6635836">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="6635868">,</span>&nbsp;<span class="ident" id="6635870">runtime</span><span class="op" id="6635877">.</span><span class="ident" id="6635878">GOOS</span><span class="op" id="6635882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6635885">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635889">connected</span>&nbsp;<span class="op" id="6635899">:=</span>&nbsp;<span class="num" id="6635902">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635905">for</span>&nbsp;<span class="op" id="6635909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635913">select</span>&nbsp;<span class="op" id="6635920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635924">case</span>&nbsp;<span class="op" id="6635929">&lt;-</span><span class="ident" id="6635931">time</span><span class="op" id="6635935">.</span><span class="ident" id="6635936">After</span><span class="op" id="6635941">(</span><span class="num" id="6635942">15</span>&nbsp;<span class="op" id="6635945">*</span>&nbsp;<span class="ident" id="6635947">time</span><span class="op" id="6635951">.</span><span class="ident" id="6635952">Second</span><span class="op" id="6635958">)</span><span class="op" id="6635959">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6635964">t</span><span class="op" id="6635965">.</span><span class="ident" id="6635966">Fatal</span><span class="op" id="6635971">(</span><span class="string" id="6635972">&#34;too&nbsp;slow&#34;</span><span class="op" id="6635982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6635986">case</span>&nbsp;<span class="ident" id="6635991">err</span>&nbsp;<span class="op" id="6635995">:=</span>&nbsp;<span class="op" id="6635998">&lt;-</span><span class="ident" id="6636000">errc</span><span class="op" id="6636004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636009">if</span>&nbsp;<span class="ident" id="6636012">err</span>&nbsp;<span class="op" id="6636016">==</span>&nbsp;<span class="builtintype" id="6636019">nil</span>&nbsp;<span class="op" id="6636023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636029">connected</span><span class="op" id="6636038">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636045">if</span>&nbsp;<span class="ident" id="6636048">connected</span>&nbsp;<span class="op" id="6636058">==</span>&nbsp;<span class="ident" id="6636061">numConns</span>&nbsp;<span class="op" id="6636070">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636077">t</span><span class="op" id="6636078">.</span><span class="ident" id="6636079">Fatal</span><span class="op" id="6636084">(</span><span class="string" id="6636085">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="6636139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636150">}</span>&nbsp;<span class="keyword" id="6636152">else</span>&nbsp;<span class="op" id="6636157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636163">terr</span><span class="op" id="6636167">,</span>&nbsp;<span class="ident" id="6636169">ok</span>&nbsp;<span class="op" id="6636172">:=</span>&nbsp;<span class="ident" id="6636175">err</span><span class="op" id="6636178">.</span><span class="op" id="6636179">(</span><span class="ident" id="6636180">timeout</span><span class="op" id="6636187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636193">if</span>&nbsp;<span class="op" id="6636196">!</span><span class="ident" id="6636197">ok</span>&nbsp;<span class="op" id="6636200">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636207">t</span><span class="op" id="6636208">.</span><span class="ident" id="6636209">Fatalf</span><span class="op" id="6636215">(</span><span class="string" id="6636216">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="6636265">,</span>&nbsp;<span class="ident" id="6636267">err</span><span class="op" id="6636270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636282">if</span>&nbsp;<span class="op" id="6636285">!</span><span class="ident" id="6636286">terr</span><span class="op" id="6636290">.</span><span class="ident" id="6636291">Timeout</span><span class="op" id="6636298">(</span><span class="op" id="6636299">)</span>&nbsp;<span class="op" id="6636301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636308">t</span><span class="op" id="6636309">.</span><span class="ident" id="6636310">Fatalf</span><span class="op" id="6636316">(</span><span class="string" id="6636317">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="6636346">,</span>&nbsp;<span class="ident" id="6636348">err</span><span class="op" id="6636351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636357">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6636363">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636400">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636417">}</span><br>
<span class="lineno">115</span><span class="op" id="6636419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6636422">func</span>&nbsp;<span class="ident" id="6636427">TestSelfConnect</span><span class="op" id="6636442">(</span><span class="ident" id="6636443">t</span>&nbsp;<span class="op" id="6636445">*</span><span class="ident" id="6636446">testing</span><span class="op" id="6636453">.</span><span class="ident" id="6636454">T</span><span class="op" id="6636455">)</span>&nbsp;<span class="op" id="6636457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636460">if</span>&nbsp;<span class="ident" id="6636463">runtime</span><span class="op" id="6636470">.</span><span class="ident" id="6636471">GOOS</span>&nbsp;<span class="op" id="6636476">==</span>&nbsp;<span class="string" id="6636479">&#34;windows&#34;</span>&nbsp;<span class="op" id="6636489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6636493">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636540">t</span><span class="op" id="6636541">.</span><span class="ident" id="6636542">Skip</span><span class="op" id="6636546">(</span><span class="string" id="6636547">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="6636586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6636593">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6636642">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6636675">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636730">l</span><span class="op" id="6636731">,</span>&nbsp;<span class="ident" id="6636733">err</span>&nbsp;<span class="op" id="6636737">:=</span>&nbsp;<span class="ident" id="6636740">Listen</span><span class="op" id="6636746">(</span><span class="string" id="6636747">&#34;tcp&#34;</span><span class="op" id="6636752">,</span>&nbsp;<span class="string" id="6636754">&#34;127.0.0.1:0&#34;</span><span class="op" id="6636767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636770">if</span>&nbsp;<span class="ident" id="6636773">err</span>&nbsp;<span class="op" id="6636777">!=</span>&nbsp;<span class="builtintype" id="6636780">nil</span>&nbsp;<span class="op" id="6636784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636788">t</span><span class="op" id="6636789">.</span><span class="ident" id="6636790">Fatal</span><span class="op" id="6636795">(</span><span class="ident" id="6636796">err</span><span class="op" id="6636799">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636805">c</span><span class="op" id="6636806">,</span>&nbsp;<span class="ident" id="6636808">err</span>&nbsp;<span class="op" id="6636812">:=</span>&nbsp;<span class="ident" id="6636815">Dial</span><span class="op" id="6636819">(</span><span class="string" id="6636820">&#34;tcp&#34;</span><span class="op" id="6636825">,</span>&nbsp;<span class="ident" id="6636827">l</span><span class="op" id="6636828">.</span><span class="ident" id="6636829">Addr</span><span class="op" id="6636833">(</span><span class="op" id="6636834">)</span><span class="op" id="6636835">.</span><span class="ident" id="6636836">String</span><span class="op" id="6636842">(</span><span class="op" id="6636843">)</span><span class="op" id="6636844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636847">if</span>&nbsp;<span class="ident" id="6636850">err</span>&nbsp;<span class="op" id="6636854">!=</span>&nbsp;<span class="builtintype" id="6636857">nil</span>&nbsp;<span class="op" id="6636861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636865">t</span><span class="op" id="6636866">.</span><span class="ident" id="6636867">Fatal</span><span class="op" id="6636872">(</span><span class="ident" id="6636873">err</span><span class="op" id="6636876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6636879">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636882">addr</span>&nbsp;<span class="op" id="6636887">:=</span>&nbsp;<span class="ident" id="6636890">c</span><span class="op" id="6636891">.</span><span class="ident" id="6636892">LocalAddr</span><span class="op" id="6636901">(</span><span class="op" id="6636902">)</span><span class="op" id="6636903">.</span><span class="ident" id="6636904">String</span><span class="op" id="6636910">(</span><span class="op" id="6636911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636914">c</span><span class="op" id="6636915">.</span><span class="ident" id="6636916">Close</span><span class="op" id="6636921">(</span><span class="op" id="6636922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636925">l</span><span class="op" id="6636926">.</span><span class="ident" id="6636927">Close</span><span class="op" id="6636932">(</span><span class="op" id="6636933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6636937">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6636984">n</span>&nbsp;<span class="op" id="6636986">:=</span>&nbsp;<span class="num" id="6636989">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6636997">if</span>&nbsp;<span class="ident" id="6637000">testing</span><span class="op" id="6637007">.</span><span class="ident" id="6637008">Short</span><span class="op" id="6637013">(</span><span class="op" id="6637014">)</span>&nbsp;<span class="op" id="6637016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637020">n</span>&nbsp;<span class="op" id="6637022">=</span>&nbsp;<span class="num" id="6637024">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6637033">switch</span>&nbsp;<span class="ident" id="6637040">runtime</span><span class="op" id="6637047">.</span><span class="ident" id="6637048">GOOS</span>&nbsp;<span class="op" id="6637053">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6637056">case</span>&nbsp;<span class="string" id="6637061">&#34;darwin&#34;</span><span class="op" id="6637069">,</span>&nbsp;<span class="string" id="6637071">&#34;dragonfly&#34;</span><span class="op" id="6637082">,</span>&nbsp;<span class="string" id="6637084">&#34;freebsd&#34;</span><span class="op" id="6637093">,</span>&nbsp;<span class="string" id="6637095">&#34;netbsd&#34;</span><span class="op" id="6637103">,</span>&nbsp;<span class="string" id="6637105">&#34;openbsd&#34;</span><span class="op" id="6637114">,</span>&nbsp;<span class="string" id="6637116">&#34;plan9&#34;</span><span class="op" id="6637123">,</span>&nbsp;<span class="string" id="6637125">&#34;solaris&#34;</span><span class="op" id="6637134">,</span>&nbsp;<span class="string" id="6637136">&#34;windows&#34;</span><span class="op" id="6637145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6637149">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6637199">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637254">n</span>&nbsp;<span class="op" id="6637256">=</span>&nbsp;<span class="num" id="6637258">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637263">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6637266">for</span>&nbsp;<span class="ident" id="6637270">i</span>&nbsp;<span class="op" id="6637272">:=</span>&nbsp;<span class="num" id="6637275">0</span><span class="op" id="6637276">;</span>&nbsp;<span class="ident" id="6637278">i</span>&nbsp;<span class="op" id="6637280">&lt;</span>&nbsp;<span class="ident" id="6637282">n</span><span class="op" id="6637283">;</span>&nbsp;<span class="ident" id="6637285">i</span><span class="op" id="6637286">++</span>&nbsp;<span class="op" id="6637289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637293">c</span><span class="op" id="6637294">,</span>&nbsp;<span class="ident" id="6637296">err</span>&nbsp;<span class="op" id="6637300">:=</span>&nbsp;<span class="ident" id="6637303">DialTimeout</span><span class="op" id="6637314">(</span><span class="string" id="6637315">&#34;tcp&#34;</span><span class="op" id="6637320">,</span>&nbsp;<span class="ident" id="6637322">addr</span><span class="op" id="6637326">,</span>&nbsp;<span class="ident" id="6637328">time</span><span class="op" id="6637332">.</span><span class="ident" id="6637333">Millisecond</span><span class="op" id="6637344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6637348">if</span>&nbsp;<span class="ident" id="6637351">err</span>&nbsp;<span class="op" id="6637355">==</span>&nbsp;<span class="builtintype" id="6637358">nil</span>&nbsp;<span class="op" id="6637362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6637367">if</span>&nbsp;<span class="ident" id="6637370">c</span><span class="op" id="6637371">.</span><span class="ident" id="6637372">LocalAddr</span><span class="op" id="6637381">(</span><span class="op" id="6637382">)</span><span class="op" id="6637383">.</span><span class="ident" id="6637384">String</span><span class="op" id="6637390">(</span><span class="op" id="6637391">)</span>&nbsp;<span class="op" id="6637393">==</span>&nbsp;<span class="ident" id="6637396">addr</span>&nbsp;<span class="op" id="6637401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637407">t</span><span class="op" id="6637408">.</span><span class="ident" id="6637409">Errorf</span><span class="op" id="6637415">(</span><span class="string" id="6637416">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="6637443">,</span>&nbsp;<span class="ident" id="6637445">i</span><span class="op" id="6637446">,</span>&nbsp;<span class="ident" id="6637448">addr</span><span class="op" id="6637452">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637457">}</span>&nbsp;<span class="keyword" id="6637459">else</span>&nbsp;<span class="op" id="6637464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637470">t</span><span class="op" id="6637471">.</span><span class="ident" id="6637472">Logf</span><span class="op" id="6637476">(</span><span class="string" id="6637477">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="6637539">,</span>&nbsp;<span class="ident" id="6637541">i</span><span class="op" id="6637542">,</span>&nbsp;<span class="ident" id="6637544">addr</span><span class="op" id="6637548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637558">c</span><span class="op" id="6637559">.</span><span class="ident" id="6637560">Close</span><span class="op" id="6637565">(</span><span class="op" id="6637566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637570">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637573">}</span><br>
<span class="lineno"></span><span class="op" id="6637575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6637578">var</span>&nbsp;<span class="ident" id="6637582">runErrorTest</span>&nbsp;<span class="op" id="6637595">=</span>&nbsp;<span class="ident" id="6637597">flag</span><span class="op" id="6637601">.</span><span class="ident" id="6637602">Bool</span><span class="op" id="6637606">(</span><span class="string" id="6637607">&#34;run_error_test&#34;</span><span class="op" id="6637623">,</span>&nbsp;<span class="builtintype" id="6637625">false</span><span class="op" id="6637630">,</span>&nbsp;<span class="string" id="6637632">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="6637672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6637675">type</span>&nbsp;<span class="ident" id="6637680">DialErrorTest</span>&nbsp;<span class="keyword" id="6637694">struct</span>&nbsp;<span class="op" id="6637701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637704">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6637712">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637720">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6637728">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6637736">Pattern</span>&nbsp;<span class="builtintype" id="6637744">string</span><br>
<span class="lineno"></span><span class="op" id="6637751">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6637754">var</span>&nbsp;<span class="ident" id="6637758">dialErrorTests</span>&nbsp;<span class="op" id="6637773">=</span>&nbsp;<span class="op" id="6637775">[</span><span class="op" id="6637776">]</span><span class="ident" id="6637777">DialErrorTest</span><span class="op" id="6637790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6637797">&#34;datakit&#34;</span><span class="op" id="6637806">,</span>&nbsp;<span class="string" id="6637808">&#34;mh/astro/r70&#34;</span><span class="op" id="6637822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6637826">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="6637878">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637881">}</span><span class="op" id="6637882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6637889">&#34;tcp&#34;</span><span class="op" id="6637894">,</span>&nbsp;<span class="string" id="6637896">&#34;127.0.0.1:&#34;</span><span class="op" id="6637911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6637915">&#34;dial&nbsp;tcp&nbsp;127.0.0.1::&nbsp;unknown&nbsp;port&nbsp;tcp/&#34;</span><span class="op" id="6637961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637964">}</span><span class="op" id="6637965">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6637968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6637972">&#34;tcp&#34;</span><span class="op" id="6637977">,</span>&nbsp;<span class="string" id="6637979">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="6638008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638012">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6638101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638104">}</span><span class="op" id="6638105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638108">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638112">&#34;tcp&#34;</span><span class="op" id="6638117">,</span>&nbsp;<span class="string" id="6638119">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="6638162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638166">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6638283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638286">}</span><span class="op" id="6638287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638294">&#34;tcp&#34;</span><span class="op" id="6638299">,</span>&nbsp;<span class="string" id="6638301">&#34;no-such-name:80&#34;</span><span class="op" id="6638318">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638322">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="6638396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638399">}</span><span class="op" id="6638400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638407">&#34;tcp&#34;</span><span class="op" id="6638412">,</span>&nbsp;<span class="string" id="6638414">&#34;mh/astro/r70:http&#34;</span><span class="op" id="6638433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638437">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="6638507">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638510">}</span><span class="op" id="6638511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638518">&#34;unix&#34;</span><span class="op" id="6638524">,</span>&nbsp;<span class="string" id="6638526">&#34;/etc/file-not-found&#34;</span><span class="op" id="6638547">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638551">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6638609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638612">}</span><span class="op" id="6638613">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638620">&#34;unix&#34;</span><span class="op" id="6638626">,</span>&nbsp;<span class="string" id="6638628">&#34;/etc/&#34;</span><span class="op" id="6638635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638639">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6638727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638730">}</span><span class="op" id="6638731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638734">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638738">&#34;unixpacket&#34;</span><span class="op" id="6638750">,</span>&nbsp;<span class="string" id="6638752">&#34;/etc/file-not-found&#34;</span><span class="op" id="6638773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638777">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6638841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638844">}</span><span class="op" id="6638845">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638852">&#34;unixpacket&#34;</span><span class="op" id="6638864">,</span>&nbsp;<span class="string" id="6638866">&#34;/etc/&#34;</span><span class="op" id="6638873">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6638877">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6638971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6638974">}</span><span class="op" id="6638975">,</span><br>
<span class="lineno"></span><span class="op" id="6638977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6638980">var</span>&nbsp;<span class="ident" id="6638984">duplicateErrorPattern</span>&nbsp;<span class="op" id="6639006">=</span>&nbsp;<span class="string" id="6639008">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6639031">func</span>&nbsp;<span class="ident" id="6639036">TestDialError</span><span class="op" id="6639049">(</span><span class="ident" id="6639050">t</span>&nbsp;<span class="op" id="6639052">*</span><span class="ident" id="6639053">testing</span><span class="op" id="6639060">.</span><span class="ident" id="6639061">T</span><span class="op" id="6639062">)</span>&nbsp;<span class="op" id="6639064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639067">if</span>&nbsp;<span class="op" id="6639070">!</span><span class="op" id="6639071">*</span><span class="ident" id="6639072">runErrorTest</span>&nbsp;<span class="op" id="6639085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639089">t</span><span class="op" id="6639090">.</span><span class="ident" id="6639091">Logf</span><span class="op" id="6639095">(</span><span class="string" id="6639096">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="6639142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639146">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639157">for</span>&nbsp;<span class="ident" id="6639161">i</span><span class="op" id="6639162">,</span>&nbsp;<span class="ident" id="6639164">tt</span>&nbsp;<span class="op" id="6639167">:=</span>&nbsp;<span class="keyword" id="6639170">range</span>&nbsp;<span class="ident" id="6639176">dialErrorTests</span>&nbsp;<span class="op" id="6639191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639195">c</span><span class="op" id="6639196">,</span>&nbsp;<span class="ident" id="6639198">err</span>&nbsp;<span class="op" id="6639202">:=</span>&nbsp;<span class="ident" id="6639205">Dial</span><span class="op" id="6639209">(</span><span class="ident" id="6639210">tt</span><span class="op" id="6639212">.</span><span class="ident" id="6639213">Net</span><span class="op" id="6639216">,</span>&nbsp;<span class="ident" id="6639218">tt</span><span class="op" id="6639220">.</span><span class="ident" id="6639221">Raddr</span><span class="op" id="6639226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639230">if</span>&nbsp;<span class="ident" id="6639233">c</span>&nbsp;<span class="op" id="6639235">!=</span>&nbsp;<span class="builtintype" id="6639238">nil</span>&nbsp;<span class="op" id="6639242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639247">c</span><span class="op" id="6639248">.</span><span class="ident" id="6639249">Close</span><span class="op" id="6639254">(</span><span class="op" id="6639255">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639263">if</span>&nbsp;<span class="ident" id="6639266">err</span>&nbsp;<span class="op" id="6639270">==</span>&nbsp;<span class="builtintype" id="6639273">nil</span>&nbsp;<span class="op" id="6639277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639282">t</span><span class="op" id="6639283">.</span><span class="ident" id="6639284">Errorf</span><span class="op" id="6639290">(</span><span class="string" id="6639291">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6639327">,</span>&nbsp;<span class="ident" id="6639329">i</span><span class="op" id="6639330">,</span>&nbsp;<span class="ident" id="6639332">tt</span><span class="op" id="6639334">.</span><span class="ident" id="6639335">Pattern</span><span class="op" id="6639342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639347">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639358">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639362">s</span>&nbsp;<span class="op" id="6639364">:=</span>&nbsp;<span class="ident" id="6639367">err</span><span class="op" id="6639370">.</span><span class="ident" id="6639371">Error</span><span class="op" id="6639376">(</span><span class="op" id="6639377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639381">match</span><span class="op" id="6639386">,</span>&nbsp;<span class="ident" id="6639388">_</span>&nbsp;<span class="op" id="6639390">:=</span>&nbsp;<span class="ident" id="6639393">regexp</span><span class="op" id="6639399">.</span><span class="ident" id="6639400">MatchString</span><span class="op" id="6639411">(</span><span class="ident" id="6639412">tt</span><span class="op" id="6639414">.</span><span class="ident" id="6639415">Pattern</span><span class="op" id="6639422">,</span>&nbsp;<span class="ident" id="6639424">s</span><span class="op" id="6639425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639429">if</span>&nbsp;<span class="op" id="6639432">!</span><span class="ident" id="6639433">match</span>&nbsp;<span class="op" id="6639439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639444">t</span><span class="op" id="6639445">.</span><span class="ident" id="6639446">Errorf</span><span class="op" id="6639452">(</span><span class="string" id="6639453">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6639482">,</span>&nbsp;<span class="ident" id="6639484">i</span><span class="op" id="6639485">,</span>&nbsp;<span class="ident" id="6639487">s</span><span class="op" id="6639488">,</span>&nbsp;<span class="ident" id="6639490">tt</span><span class="op" id="6639492">.</span><span class="ident" id="6639493">Pattern</span><span class="op" id="6639500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639504">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639508">match</span><span class="op" id="6639513">,</span>&nbsp;<span class="ident" id="6639515">_</span>&nbsp;<span class="op" id="6639517">=</span>&nbsp;<span class="ident" id="6639519">regexp</span><span class="op" id="6639525">.</span><span class="ident" id="6639526">MatchString</span><span class="op" id="6639537">(</span><span class="ident" id="6639538">duplicateErrorPattern</span><span class="op" id="6639559">,</span>&nbsp;<span class="ident" id="6639561">s</span><span class="op" id="6639562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6639566">if</span>&nbsp;<span class="ident" id="6639569">match</span>&nbsp;<span class="op" id="6639575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639580">t</span><span class="op" id="6639581">.</span><span class="ident" id="6639582">Errorf</span><span class="op" id="6639588">(</span><span class="string" id="6639589">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="6639632">,</span>&nbsp;<span class="ident" id="6639634">i</span><span class="op" id="6639635">,</span>&nbsp;<span class="ident" id="6639637">s</span><span class="op" id="6639638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639645">}</span><br>
<span class="lineno">240</span><span class="op" id="6639647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6639650">var</span>&nbsp;<span class="ident" id="6639654">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6639683">=</span>&nbsp;<span class="op" id="6639685">[</span><span class="op" id="6639686">]</span><span class="keyword" id="6639687">struct</span>&nbsp;<span class="op" id="6639694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639697">net</span>&nbsp;&nbsp;<span class="builtintype" id="6639702">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639710">addr</span>&nbsp;<span class="builtintype" id="6639715">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6639723">err</span>&nbsp;&nbsp;<span class="builtintype" id="6639728">error</span><br>
<span class="lineno"></span><span class="op" id="6639734">}</span><span class="op" id="6639735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639738">{</span><span class="string" id="6639739">&#34;foo&#34;</span><span class="op" id="6639744">,</span>&nbsp;<span class="string" id="6639746">&#34;bar&#34;</span><span class="op" id="6639751">,</span>&nbsp;<span class="op" id="6639753">&amp;</span><span class="ident" id="6639754">OpError</span><span class="op" id="6639761">{</span><span class="ident" id="6639762">Op</span><span class="op" id="6639764">:</span>&nbsp;<span class="string" id="6639766">&#34;dial&#34;</span><span class="op" id="6639772">,</span>&nbsp;<span class="ident" id="6639774">Net</span><span class="op" id="6639777">:</span>&nbsp;<span class="string" id="6639779">&#34;foo&#34;</span><span class="op" id="6639784">,</span>&nbsp;<span class="ident" id="6639786">Addr</span><span class="op" id="6639790">:</span>&nbsp;<span class="builtintype" id="6639792">nil</span><span class="op" id="6639795">,</span>&nbsp;<span class="ident" id="6639797">Err</span><span class="op" id="6639800">:</span>&nbsp;<span class="ident" id="6639802">UnknownNetworkError</span><span class="op" id="6639821">(</span><span class="string" id="6639822">&#34;foo&#34;</span><span class="op" id="6639827">)</span><span class="op" id="6639828">}</span><span class="op" id="6639829">}</span><span class="op" id="6639830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639833">{</span><span class="string" id="6639834">&#34;baz&#34;</span><span class="op" id="6639839">,</span>&nbsp;<span class="string" id="6639841">&#34;&#34;</span><span class="op" id="6639843">,</span>&nbsp;<span class="op" id="6639845">&amp;</span><span class="ident" id="6639846">OpError</span><span class="op" id="6639853">{</span><span class="ident" id="6639854">Op</span><span class="op" id="6639856">:</span>&nbsp;<span class="string" id="6639858">&#34;listen&#34;</span><span class="op" id="6639866">,</span>&nbsp;<span class="ident" id="6639868">Net</span><span class="op" id="6639871">:</span>&nbsp;<span class="string" id="6639873">&#34;baz&#34;</span><span class="op" id="6639878">,</span>&nbsp;<span class="ident" id="6639880">Addr</span><span class="op" id="6639884">:</span>&nbsp;<span class="builtintype" id="6639886">nil</span><span class="op" id="6639889">,</span>&nbsp;<span class="ident" id="6639891">Err</span><span class="op" id="6639894">:</span>&nbsp;<span class="ident" id="6639896">UnknownNetworkError</span><span class="op" id="6639915">(</span><span class="string" id="6639916">&#34;baz&#34;</span><span class="op" id="6639921">)</span><span class="op" id="6639922">}</span><span class="op" id="6639923">}</span><span class="op" id="6639924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6639927">{</span><span class="string" id="6639928">&#34;tcp&#34;</span><span class="op" id="6639933">,</span>&nbsp;<span class="string" id="6639935">&#34;&#34;</span><span class="op" id="6639937">,</span>&nbsp;<span class="op" id="6639939">&amp;</span><span class="ident" id="6639940">OpError</span><span class="op" id="6639947">{</span><span class="ident" id="6639948">Op</span><span class="op" id="6639950">:</span>&nbsp;<span class="string" id="6639952">&#34;dial&#34;</span><span class="op" id="6639958">,</span>&nbsp;<span class="ident" id="6639960">Net</span><span class="op" id="6639963">:</span>&nbsp;<span class="string" id="6639965">&#34;tcp&#34;</span><span class="op" id="6639970">,</span>&nbsp;<span class="ident" id="6639972">Addr</span><span class="op" id="6639976">:</span>&nbsp;<span class="builtintype" id="6639978">nil</span><span class="op" id="6639981">,</span>&nbsp;<span class="ident" id="6639983">Err</span><span class="op" id="6639986">:</span>&nbsp;<span class="ident" id="6639988">errMissingAddress</span><span class="op" id="6640005">}</span><span class="op" id="6640006">}</span><span class="op" id="6640007">,</span><br>
<span class="lineno">250</span><span class="op" id="6640009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6640012">func</span>&nbsp;<span class="ident" id="6640017">TestInvalidDialAndListenArgs</span><span class="op" id="6640045">(</span><span class="ident" id="6640046">t</span>&nbsp;<span class="op" id="6640048">*</span><span class="ident" id="6640049">testing</span><span class="op" id="6640056">.</span><span class="ident" id="6640057">T</span><span class="op" id="6640058">)</span>&nbsp;<span class="op" id="6640060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640063">for</span>&nbsp;<span class="ident" id="6640067">_</span><span class="op" id="6640068">,</span>&nbsp;<span class="ident" id="6640070">tt</span>&nbsp;<span class="op" id="6640073">:=</span>&nbsp;<span class="keyword" id="6640076">range</span>&nbsp;<span class="ident" id="6640082">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6640111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640115">var</span>&nbsp;<span class="ident" id="6640119">err</span>&nbsp;<span class="builtintype" id="6640123">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640131">switch</span>&nbsp;<span class="ident" id="6640138">tt</span><span class="op" id="6640140">.</span><span class="ident" id="6640141">err</span><span class="op" id="6640144">.</span><span class="op" id="6640145">(</span><span class="op" id="6640146">*</span><span class="ident" id="6640147">OpError</span><span class="op" id="6640154">)</span><span class="op" id="6640155">.</span><span class="ident" id="6640156">Op</span>&nbsp;<span class="op" id="6640159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640163">case</span>&nbsp;<span class="string" id="6640168">&#34;dial&#34;</span><span class="op" id="6640174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640179">_</span><span class="op" id="6640180">,</span>&nbsp;<span class="ident" id="6640182">err</span>&nbsp;<span class="op" id="6640186">=</span>&nbsp;<span class="ident" id="6640188">Dial</span><span class="op" id="6640192">(</span><span class="ident" id="6640193">tt</span><span class="op" id="6640195">.</span><span class="ident" id="6640196">net</span><span class="op" id="6640199">,</span>&nbsp;<span class="ident" id="6640201">tt</span><span class="op" id="6640203">.</span><span class="ident" id="6640204">addr</span><span class="op" id="6640208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640212">case</span>&nbsp;<span class="string" id="6640217">&#34;listen&#34;</span><span class="op" id="6640225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640230">_</span><span class="op" id="6640231">,</span>&nbsp;<span class="ident" id="6640233">err</span>&nbsp;<span class="op" id="6640237">=</span>&nbsp;<span class="ident" id="6640239">Listen</span><span class="op" id="6640245">(</span><span class="ident" id="6640246">tt</span><span class="op" id="6640248">.</span><span class="ident" id="6640249">net</span><span class="op" id="6640252">,</span>&nbsp;<span class="ident" id="6640254">tt</span><span class="op" id="6640256">.</span><span class="ident" id="6640257">addr</span><span class="op" id="6640261">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640269">if</span>&nbsp;<span class="op" id="6640272">!</span><span class="ident" id="6640273">reflect</span><span class="op" id="6640280">.</span><span class="ident" id="6640281">DeepEqual</span><span class="op" id="6640290">(</span><span class="ident" id="6640291">tt</span><span class="op" id="6640293">.</span><span class="ident" id="6640294">err</span><span class="op" id="6640297">,</span>&nbsp;<span class="ident" id="6640299">err</span><span class="op" id="6640302">)</span>&nbsp;<span class="op" id="6640304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640309">t</span><span class="op" id="6640310">.</span><span class="ident" id="6640311">Fatalf</span><span class="op" id="6640317">(</span><span class="string" id="6640318">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="6640341">,</span>&nbsp;<span class="ident" id="6640343">err</span><span class="op" id="6640346">,</span>&nbsp;<span class="ident" id="6640348">tt</span><span class="op" id="6640350">.</span><span class="ident" id="6640351">err</span><span class="op" id="6640354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640361">}</span><br>
<span class="lineno">265</span><span class="op" id="6640363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6640366">func</span>&nbsp;<span class="ident" id="6640371">TestDialTimeoutFDLeak</span><span class="op" id="6640392">(</span><span class="ident" id="6640393">t</span>&nbsp;<span class="op" id="6640395">*</span><span class="ident" id="6640396">testing</span><span class="op" id="6640403">.</span><span class="ident" id="6640404">T</span><span class="op" id="6640405">)</span>&nbsp;<span class="op" id="6640407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640410">if</span>&nbsp;<span class="ident" id="6640413">runtime</span><span class="op" id="6640420">.</span><span class="ident" id="6640421">GOOS</span>&nbsp;<span class="op" id="6640426">!=</span>&nbsp;<span class="string" id="6640429">&#34;linux&#34;</span>&nbsp;<span class="op" id="6640437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6640441">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640486">t</span><span class="op" id="6640487">.</span><span class="ident" id="6640488">Skipf</span><span class="op" id="6640493">(</span><span class="string" id="6640494">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6640515">,</span>&nbsp;<span class="ident" id="6640517">runtime</span><span class="op" id="6640524">.</span><span class="ident" id="6640525">GOOS</span><span class="op" id="6640529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640536">ln</span>&nbsp;<span class="op" id="6640539">:=</span>&nbsp;<span class="ident" id="6640542">newLocalListener</span><span class="op" id="6640558">(</span><span class="ident" id="6640559">t</span><span class="op" id="6640560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640563">defer</span>&nbsp;<span class="ident" id="6640569">ln</span><span class="op" id="6640571">.</span><span class="ident" id="6640572">Close</span><span class="op" id="6640577">(</span><span class="op" id="6640578">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640582">type</span>&nbsp;<span class="ident" id="6640587">connErr</span>&nbsp;<span class="keyword" id="6640595">struct</span>&nbsp;<span class="op" id="6640602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640606">conn</span>&nbsp;<span class="ident" id="6640611">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640618">err</span>&nbsp;&nbsp;<span class="builtintype" id="6640623">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640630">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640633">dials</span>&nbsp;<span class="op" id="6640639">:=</span>&nbsp;<span class="ident" id="6640642">listenerBacklog</span>&nbsp;<span class="op" id="6640658">+</span>&nbsp;<span class="num" id="6640660">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6640665">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640745">maxGoodConnect</span>&nbsp;<span class="op" id="6640760">:=</span>&nbsp;<span class="ident" id="6640763">listenerBacklog</span>&nbsp;<span class="op" id="6640779">+</span>&nbsp;<span class="ident" id="6640781">runtime</span><span class="op" id="6640788">.</span><span class="ident" id="6640789">NumCPU</span><span class="op" id="6640795">(</span><span class="op" id="6640796">)</span><span class="op" id="6640797">*</span><span class="num" id="6640798">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640802">resc</span>&nbsp;<span class="op" id="6640807">:=</span>&nbsp;<span class="builtinfunc" id="6640810">make</span><span class="op" id="6640814">(</span><span class="keyword" id="6640815">chan</span>&nbsp;<span class="ident" id="6640820">connErr</span><span class="op" id="6640827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640830">for</span>&nbsp;<span class="ident" id="6640834">i</span>&nbsp;<span class="op" id="6640836">:=</span>&nbsp;<span class="num" id="6640839">0</span><span class="op" id="6640840">;</span>&nbsp;<span class="ident" id="6640842">i</span>&nbsp;<span class="op" id="6640844">&lt;</span>&nbsp;<span class="ident" id="6640846">dials</span><span class="op" id="6640851">;</span>&nbsp;<span class="ident" id="6640853">i</span><span class="op" id="6640854">++</span>&nbsp;<span class="op" id="6640857">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640861">go</span>&nbsp;<span class="keyword" id="6640864">func</span><span class="op" id="6640868">(</span><span class="op" id="6640869">)</span>&nbsp;<span class="op" id="6640871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640876">conn</span><span class="op" id="6640880">,</span>&nbsp;<span class="ident" id="6640882">err</span>&nbsp;<span class="op" id="6640886">:=</span>&nbsp;<span class="ident" id="6640889">DialTimeout</span><span class="op" id="6640900">(</span><span class="string" id="6640901">&#34;tcp&#34;</span><span class="op" id="6640906">,</span>&nbsp;<span class="ident" id="6640908">ln</span><span class="op" id="6640910">.</span><span class="ident" id="6640911">Addr</span><span class="op" id="6640915">(</span><span class="op" id="6640916">)</span><span class="op" id="6640917">.</span><span class="ident" id="6640918">String</span><span class="op" id="6640924">(</span><span class="op" id="6640925">)</span><span class="op" id="6640926">,</span>&nbsp;<span class="num" id="6640928">500</span><span class="op" id="6640931">*</span><span class="ident" id="6640932">time</span><span class="op" id="6640936">.</span><span class="ident" id="6640937">Millisecond</span><span class="op" id="6640948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6640953">resc</span>&nbsp;<span class="op" id="6640958">&lt;-</span>&nbsp;<span class="ident" id="6640961">connErr</span><span class="op" id="6640968">{</span><span class="ident" id="6640969">conn</span><span class="op" id="6640973">,</span>&nbsp;<span class="ident" id="6640975">err</span><span class="op" id="6640978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640982">}</span><span class="op" id="6640983">(</span><span class="op" id="6640984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6640987">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6640991">var</span>&nbsp;<span class="ident" id="6640995">firstErr</span>&nbsp;<span class="builtintype" id="6641004">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641012">var</span>&nbsp;<span class="ident" id="6641016">ngood</span>&nbsp;<span class="builtintype" id="6641022">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641027">var</span>&nbsp;<span class="ident" id="6641031">toClose</span>&nbsp;<span class="op" id="6641039">[</span><span class="op" id="6641040">]</span><span class="ident" id="6641041">io</span><span class="op" id="6641043">.</span><span class="ident" id="6641044">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641052">for</span>&nbsp;<span class="ident" id="6641056">i</span>&nbsp;<span class="op" id="6641058">:=</span>&nbsp;<span class="num" id="6641061">0</span><span class="op" id="6641062">;</span>&nbsp;<span class="ident" id="6641064">i</span>&nbsp;<span class="op" id="6641066">&lt;</span>&nbsp;<span class="ident" id="6641068">dials</span><span class="op" id="6641073">;</span>&nbsp;<span class="ident" id="6641075">i</span><span class="op" id="6641076">++</span>&nbsp;<span class="op" id="6641079">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641083">ce</span>&nbsp;<span class="op" id="6641086">:=</span>&nbsp;<span class="op" id="6641089">&lt;-</span><span class="ident" id="6641091">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641098">if</span>&nbsp;<span class="ident" id="6641101">ce</span><span class="op" id="6641103">.</span><span class="ident" id="6641104">err</span>&nbsp;<span class="op" id="6641108">==</span>&nbsp;<span class="builtintype" id="6641111">nil</span>&nbsp;<span class="op" id="6641115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641120">ngood</span><span class="op" id="6641125">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641131">if</span>&nbsp;<span class="ident" id="6641134">ngood</span>&nbsp;<span class="op" id="6641140">&gt;</span>&nbsp;<span class="ident" id="6641142">maxGoodConnect</span>&nbsp;<span class="op" id="6641157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641163">t</span><span class="op" id="6641164">.</span><span class="ident" id="6641165">Errorf</span><span class="op" id="6641171">(</span><span class="string" id="6641172">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="6641211">,</span>&nbsp;<span class="ident" id="6641213">ngood</span><span class="op" id="6641218">,</span>&nbsp;<span class="ident" id="6641220">maxGoodConnect</span><span class="op" id="6641234">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641244">toClose</span>&nbsp;<span class="op" id="6641252">=</span>&nbsp;<span class="builtinfunc" id="6641254">append</span><span class="op" id="6641260">(</span><span class="ident" id="6641261">toClose</span><span class="op" id="6641268">,</span>&nbsp;<span class="ident" id="6641270">ce</span><span class="op" id="6641272">.</span><span class="ident" id="6641273">conn</span><span class="op" id="6641277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641282">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641297">err</span>&nbsp;<span class="op" id="6641301">:=</span>&nbsp;<span class="ident" id="6641304">ce</span><span class="op" id="6641306">.</span><span class="ident" id="6641307">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641313">if</span>&nbsp;<span class="ident" id="6641316">firstErr</span>&nbsp;<span class="op" id="6641325">==</span>&nbsp;<span class="string" id="6641328">&#34;&#34;</span>&nbsp;<span class="op" id="6641331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641336">firstErr</span>&nbsp;<span class="op" id="6641345">=</span>&nbsp;<span class="ident" id="6641347">err</span><span class="op" id="6641350">.</span><span class="ident" id="6641351">Error</span><span class="op" id="6641356">(</span><span class="op" id="6641357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641361">}</span>&nbsp;<span class="keyword" id="6641363">else</span>&nbsp;<span class="keyword" id="6641368">if</span>&nbsp;<span class="ident" id="6641371">err</span><span class="op" id="6641374">.</span><span class="ident" id="6641375">Error</span><span class="op" id="6641380">(</span><span class="op" id="6641381">)</span>&nbsp;<span class="op" id="6641383">!=</span>&nbsp;<span class="ident" id="6641386">firstErr</span>&nbsp;<span class="op" id="6641395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641400">t</span><span class="op" id="6641401">.</span><span class="ident" id="6641402">Fatalf</span><span class="op" id="6641408">(</span><span class="string" id="6641409">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="6641467">,</span>&nbsp;<span class="ident" id="6641469">firstErr</span><span class="op" id="6641477">,</span>&nbsp;<span class="ident" id="6641479">err</span><span class="op" id="6641482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641486">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641492">for</span>&nbsp;<span class="ident" id="6641496">_</span><span class="op" id="6641497">,</span>&nbsp;<span class="ident" id="6641499">c</span>&nbsp;<span class="op" id="6641501">:=</span>&nbsp;<span class="keyword" id="6641504">range</span>&nbsp;<span class="ident" id="6641510">toClose</span>&nbsp;<span class="op" id="6641518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641522">c</span><span class="op" id="6641523">.</span><span class="ident" id="6641524">Close</span><span class="op" id="6641529">(</span><span class="op" id="6641530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641536">for</span>&nbsp;<span class="ident" id="6641540">i</span>&nbsp;<span class="op" id="6641542">:=</span>&nbsp;<span class="num" id="6641545">0</span><span class="op" id="6641546">;</span>&nbsp;<span class="ident" id="6641548">i</span>&nbsp;<span class="op" id="6641550">&lt;</span>&nbsp;<span class="num" id="6641552">100</span><span class="op" id="6641555">;</span>&nbsp;<span class="ident" id="6641557">i</span><span class="op" id="6641558">++</span>&nbsp;<span class="op" id="6641561">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641565">if</span>&nbsp;<span class="ident" id="6641568">got</span>&nbsp;<span class="op" id="6641572">:=</span>&nbsp;<span class="ident" id="6641575">numFD</span><span class="op" id="6641580">(</span><span class="op" id="6641581">)</span><span class="op" id="6641582">;</span>&nbsp;<span class="ident" id="6641584">got</span>&nbsp;<span class="op" id="6641588">&lt;</span>&nbsp;<span class="ident" id="6641590">dials</span>&nbsp;<span class="op" id="6641596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6641601">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641620">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641633">time</span><span class="op" id="6641637">.</span><span class="ident" id="6641638">Sleep</span><span class="op" id="6641643">(</span><span class="num" id="6641644">10</span>&nbsp;<span class="op" id="6641647">*</span>&nbsp;<span class="ident" id="6641649">time</span><span class="op" id="6641653">.</span><span class="ident" id="6641654">Millisecond</span><span class="op" id="6641665">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641671">if</span>&nbsp;<span class="ident" id="6641674">got</span>&nbsp;<span class="op" id="6641678">:=</span>&nbsp;<span class="ident" id="6641681">numFD</span><span class="op" id="6641686">(</span><span class="op" id="6641687">)</span><span class="op" id="6641688">;</span>&nbsp;<span class="ident" id="6641690">got</span>&nbsp;<span class="op" id="6641694">&gt;=</span>&nbsp;<span class="ident" id="6641697">dials</span>&nbsp;<span class="op" id="6641703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641707">t</span><span class="op" id="6641708">.</span><span class="ident" id="6641709">Errorf</span><span class="op" id="6641715">(</span><span class="string" id="6641716">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="6641758">,</span>&nbsp;<span class="ident" id="6641760">dials</span><span class="op" id="6641765">,</span>&nbsp;<span class="ident" id="6641767">got</span><span class="op" id="6641770">,</span>&nbsp;<span class="ident" id="6641772">dials</span><span class="op" id="6641777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641780">}</span><br>
<span class="lineno"></span><span class="op" id="6641782">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6641785">func</span>&nbsp;<span class="ident" id="6641790">numTCP</span><span class="op" id="6641796">(</span><span class="op" id="6641797">)</span>&nbsp;<span class="op" id="6641799">(</span><span class="ident" id="6641800">ntcp</span><span class="op" id="6641804">,</span>&nbsp;<span class="ident" id="6641806">nopen</span><span class="op" id="6641811">,</span>&nbsp;<span class="ident" id="6641813">nclose</span>&nbsp;<span class="builtintype" id="6641820">int</span><span class="op" id="6641823">,</span>&nbsp;<span class="ident" id="6641825">err</span>&nbsp;<span class="builtintype" id="6641829">error</span><span class="op" id="6641834">)</span>&nbsp;<span class="op" id="6641836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641839">lsof</span><span class="op" id="6641843">,</span>&nbsp;<span class="ident" id="6641845">err</span>&nbsp;<span class="op" id="6641849">:=</span>&nbsp;<span class="ident" id="6641852">exec</span><span class="op" id="6641856">.</span><span class="ident" id="6641857">Command</span><span class="op" id="6641864">(</span><span class="string" id="6641865">&#34;lsof&#34;</span><span class="op" id="6641871">,</span>&nbsp;<span class="string" id="6641873">&#34;-n&#34;</span><span class="op" id="6641877">,</span>&nbsp;<span class="string" id="6641879">&#34;-p&#34;</span><span class="op" id="6641883">,</span>&nbsp;<span class="ident" id="6641885">strconv</span><span class="op" id="6641892">.</span><span class="ident" id="6641893">Itoa</span><span class="op" id="6641897">(</span><span class="ident" id="6641898">os</span><span class="op" id="6641900">.</span><span class="ident" id="6641901">Getpid</span><span class="op" id="6641907">(</span><span class="op" id="6641908">)</span><span class="op" id="6641909">)</span><span class="op" id="6641910">)</span><span class="op" id="6641911">.</span><span class="ident" id="6641912">Output</span><span class="op" id="6641918">(</span><span class="op" id="6641919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641922">if</span>&nbsp;<span class="ident" id="6641925">err</span>&nbsp;<span class="op" id="6641929">!=</span>&nbsp;<span class="builtintype" id="6641932">nil</span>&nbsp;<span class="op" id="6641936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6641940">return</span>&nbsp;<span class="num" id="6641947">0</span><span class="op" id="6641948">,</span>&nbsp;<span class="num" id="6641950">0</span><span class="op" id="6641951">,</span>&nbsp;<span class="num" id="6641953">0</span><span class="op" id="6641954">,</span>&nbsp;<span class="ident" id="6641956">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6641961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6641964">ntcp</span>&nbsp;<span class="op" id="6641969">+=</span>&nbsp;<span class="ident" id="6641972">bytes</span><span class="op" id="6641977">.</span><span class="ident" id="6641978">Count</span><span class="op" id="6641983">(</span><span class="ident" id="6641984">lsof</span><span class="op" id="6641988">,</span>&nbsp;<span class="op" id="6641990">[</span><span class="op" id="6641991">]</span><span class="builtintype" id="6641992">byte</span><span class="op" id="6641996">(</span><span class="string" id="6641997">&#34;TCP&#34;</span><span class="op" id="6642002">)</span><span class="op" id="6642003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642006">for</span>&nbsp;<span class="ident" id="6642010">_</span><span class="op" id="6642011">,</span>&nbsp;<span class="ident" id="6642013">state</span>&nbsp;<span class="op" id="6642019">:=</span>&nbsp;<span class="keyword" id="6642022">range</span>&nbsp;<span class="op" id="6642028">[</span><span class="op" id="6642029">]</span><span class="builtintype" id="6642030">string</span><span class="op" id="6642036">{</span><span class="string" id="6642037">&#34;LISTEN&#34;</span><span class="op" id="6642045">,</span>&nbsp;<span class="string" id="6642047">&#34;SYN_SENT&#34;</span><span class="op" id="6642057">,</span>&nbsp;<span class="string" id="6642059">&#34;SYN_RECEIVED&#34;</span><span class="op" id="6642073">,</span>&nbsp;<span class="string" id="6642075">&#34;ESTABLISHED&#34;</span><span class="op" id="6642088">}</span>&nbsp;<span class="op" id="6642090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642094">nopen</span>&nbsp;<span class="op" id="6642100">+=</span>&nbsp;<span class="ident" id="6642103">bytes</span><span class="op" id="6642108">.</span><span class="ident" id="6642109">Count</span><span class="op" id="6642114">(</span><span class="ident" id="6642115">lsof</span><span class="op" id="6642119">,</span>&nbsp;<span class="op" id="6642121">[</span><span class="op" id="6642122">]</span><span class="builtintype" id="6642123">byte</span><span class="op" id="6642127">(</span><span class="ident" id="6642128">state</span><span class="op" id="6642133">)</span><span class="op" id="6642134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642137">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642140">for</span>&nbsp;<span class="ident" id="6642144">_</span><span class="op" id="6642145">,</span>&nbsp;<span class="ident" id="6642147">state</span>&nbsp;<span class="op" id="6642153">:=</span>&nbsp;<span class="keyword" id="6642156">range</span>&nbsp;<span class="op" id="6642162">[</span><span class="op" id="6642163">]</span><span class="builtintype" id="6642164">string</span><span class="op" id="6642170">{</span><span class="string" id="6642171">&#34;CLOSED&#34;</span><span class="op" id="6642179">,</span>&nbsp;<span class="string" id="6642181">&#34;CLOSE_WAIT&#34;</span><span class="op" id="6642193">,</span>&nbsp;<span class="string" id="6642195">&#34;LAST_ACK&#34;</span><span class="op" id="6642205">,</span>&nbsp;<span class="string" id="6642207">&#34;FIN_WAIT_1&#34;</span><span class="op" id="6642219">,</span>&nbsp;<span class="string" id="6642221">&#34;FIN_WAIT_2&#34;</span><span class="op" id="6642233">,</span>&nbsp;<span class="string" id="6642235">&#34;CLOSING&#34;</span><span class="op" id="6642244">,</span>&nbsp;<span class="string" id="6642246">&#34;TIME_WAIT&#34;</span><span class="op" id="6642257">}</span>&nbsp;<span class="op" id="6642259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642263">nclose</span>&nbsp;<span class="op" id="6642270">+=</span>&nbsp;<span class="ident" id="6642273">bytes</span><span class="op" id="6642278">.</span><span class="ident" id="6642279">Count</span><span class="op" id="6642284">(</span><span class="ident" id="6642285">lsof</span><span class="op" id="6642289">,</span>&nbsp;<span class="op" id="6642291">[</span><span class="op" id="6642292">]</span><span class="builtintype" id="6642293">byte</span><span class="op" id="6642297">(</span><span class="ident" id="6642298">state</span><span class="op" id="6642303">)</span><span class="op" id="6642304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642310">return</span>&nbsp;<span class="ident" id="6642317">ntcp</span><span class="op" id="6642321">,</span>&nbsp;<span class="ident" id="6642323">nopen</span><span class="op" id="6642328">,</span>&nbsp;<span class="ident" id="6642330">nclose</span><span class="op" id="6642336">,</span>&nbsp;<span class="builtintype" id="6642338">nil</span><br>
<span class="lineno"></span><span class="op" id="6642342">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="6642345">func</span>&nbsp;<span class="ident" id="6642350">TestDialMultiFDLeak</span><span class="op" id="6642369">(</span><span class="ident" id="6642370">t</span>&nbsp;<span class="op" id="6642372">*</span><span class="ident" id="6642373">testing</span><span class="op" id="6642380">.</span><span class="ident" id="6642381">T</span><span class="op" id="6642382">)</span>&nbsp;<span class="op" id="6642384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642387">t</span><span class="op" id="6642388">.</span><span class="ident" id="6642389">Skip</span><span class="op" id="6642393">(</span><span class="string" id="6642394">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="6642430">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642434">if</span>&nbsp;<span class="op" id="6642437">!</span><span class="ident" id="6642438">supportsIPv4</span>&nbsp;<span class="op" id="6642451">||</span>&nbsp;<span class="op" id="6642454">!</span><span class="ident" id="6642455">supportsIPv6</span>&nbsp;<span class="op" id="6642468">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642472">t</span><span class="op" id="6642473">.</span><span class="ident" id="6642474">Skip</span><span class="op" id="6642478">(</span><span class="string" id="6642479">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="6642515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642522">halfDeadServer</span>&nbsp;<span class="op" id="6642537">:=</span>&nbsp;<span class="keyword" id="6642540">func</span><span class="op" id="6642544">(</span><span class="ident" id="6642545">dss</span>&nbsp;<span class="op" id="6642549">*</span><span class="ident" id="6642550">dualStackServer</span><span class="op" id="6642565">,</span>&nbsp;<span class="ident" id="6642567">ln</span>&nbsp;<span class="ident" id="6642570">Listener</span><span class="op" id="6642578">)</span>&nbsp;<span class="op" id="6642580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642584">for</span>&nbsp;<span class="op" id="6642588">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642593">if</span>&nbsp;<span class="ident" id="6642596">c</span><span class="op" id="6642597">,</span>&nbsp;<span class="ident" id="6642599">err</span>&nbsp;<span class="op" id="6642603">:=</span>&nbsp;<span class="ident" id="6642606">ln</span><span class="op" id="6642608">.</span><span class="ident" id="6642609">Accept</span><span class="op" id="6642615">(</span><span class="op" id="6642616">)</span><span class="op" id="6642617">;</span>&nbsp;<span class="ident" id="6642619">err</span>&nbsp;<span class="op" id="6642623">!=</span>&nbsp;<span class="builtintype" id="6642626">nil</span>&nbsp;<span class="op" id="6642630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642636">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642646">}</span>&nbsp;<span class="keyword" id="6642648">else</span>&nbsp;<span class="op" id="6642653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6642659">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6642692">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6642735">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642748">dss</span><span class="op" id="6642751">.</span><span class="ident" id="6642752">putConn</span><span class="op" id="6642759">(</span><span class="ident" id="6642760">c</span><span class="op" id="6642761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642773">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642776">dss</span><span class="op" id="6642779">,</span>&nbsp;<span class="ident" id="6642781">err</span>&nbsp;<span class="op" id="6642785">:=</span>&nbsp;<span class="ident" id="6642788">newDualStackServer</span><span class="op" id="6642806">(</span><span class="op" id="6642807">[</span><span class="op" id="6642808">]</span><span class="ident" id="6642809">streamListener</span><span class="op" id="6642823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642827">{</span><span class="ident" id="6642828">net</span><span class="op" id="6642831">:</span>&nbsp;<span class="string" id="6642833">&#34;tcp4&#34;</span><span class="op" id="6642839">,</span>&nbsp;<span class="ident" id="6642841">addr</span><span class="op" id="6642845">:</span>&nbsp;<span class="string" id="6642847">&#34;127.0.0.1&#34;</span><span class="op" id="6642858">}</span><span class="op" id="6642859">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642863">{</span><span class="ident" id="6642864">net</span><span class="op" id="6642867">:</span>&nbsp;<span class="string" id="6642869">&#34;tcp6&#34;</span><span class="op" id="6642875">,</span>&nbsp;<span class="ident" id="6642877">addr</span><span class="op" id="6642881">:</span>&nbsp;<span class="string" id="6642883">&#34;[::1]&#34;</span><span class="op" id="6642890">}</span><span class="op" id="6642891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642894">}</span><span class="op" id="6642895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642898">if</span>&nbsp;<span class="ident" id="6642901">err</span>&nbsp;<span class="op" id="6642905">!=</span>&nbsp;<span class="builtintype" id="6642908">nil</span>&nbsp;<span class="op" id="6642912">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6642916">t</span><span class="op" id="6642917">.</span><span class="ident" id="6642918">Fatalf</span><span class="op" id="6642924">(</span><span class="string" id="6642925">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6642956">,</span>&nbsp;<span class="ident" id="6642958">err</span><span class="op" id="6642961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6642964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642967">defer</span>&nbsp;<span class="ident" id="6642973">dss</span><span class="op" id="6642976">.</span><span class="ident" id="6642977">teardown</span><span class="op" id="6642985">(</span><span class="op" id="6642986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6642989">if</span>&nbsp;<span class="ident" id="6642992">err</span>&nbsp;<span class="op" id="6642996">:=</span>&nbsp;<span class="ident" id="6642999">dss</span><span class="op" id="6643002">.</span><span class="ident" id="6643003">buildup</span><span class="op" id="6643010">(</span><span class="ident" id="6643011">halfDeadServer</span><span class="op" id="6643025">)</span><span class="op" id="6643026">;</span>&nbsp;<span class="ident" id="6643028">err</span>&nbsp;<span class="op" id="6643032">!=</span>&nbsp;<span class="builtintype" id="6643035">nil</span>&nbsp;<span class="op" id="6643039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643043">t</span><span class="op" id="6643044">.</span><span class="ident" id="6643045">Fatalf</span><span class="op" id="6643051">(</span><span class="string" id="6643052">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6643088">,</span>&nbsp;<span class="ident" id="6643090">err</span><span class="op" id="6643093">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643100">_</span><span class="op" id="6643101">,</span>&nbsp;<span class="ident" id="6643103">before</span><span class="op" id="6643109">,</span>&nbsp;<span class="ident" id="6643111">_</span><span class="op" id="6643112">,</span>&nbsp;<span class="ident" id="6643114">err</span>&nbsp;<span class="op" id="6643118">:=</span>&nbsp;<span class="ident" id="6643121">numTCP</span><span class="op" id="6643127">(</span><span class="op" id="6643128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643131">if</span>&nbsp;<span class="ident" id="6643134">err</span>&nbsp;<span class="op" id="6643138">!=</span>&nbsp;<span class="builtintype" id="6643141">nil</span>&nbsp;<span class="op" id="6643145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643149">t</span><span class="op" id="6643150">.</span><span class="ident" id="6643151">Skipf</span><span class="op" id="6643156">(</span><span class="string" id="6643157">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6643207">,</span>&nbsp;<span class="ident" id="6643209">err</span><span class="op" id="6643212">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643219">var</span>&nbsp;<span class="ident" id="6643223">wg</span>&nbsp;<span class="ident" id="6643226">sync</span><span class="op" id="6643230">.</span><span class="ident" id="6643231">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643242">portnum</span><span class="op" id="6643249">,</span>&nbsp;<span class="ident" id="6643251">_</span><span class="op" id="6643252">,</span>&nbsp;<span class="ident" id="6643254">_</span>&nbsp;<span class="op" id="6643256">:=</span>&nbsp;<span class="ident" id="6643259">dtoi</span><span class="op" id="6643263">(</span><span class="ident" id="6643264">dss</span><span class="op" id="6643267">.</span><span class="ident" id="6643268">port</span><span class="op" id="6643272">,</span>&nbsp;<span class="num" id="6643274">0</span><span class="op" id="6643275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643278">ras</span>&nbsp;<span class="op" id="6643282">:=</span>&nbsp;<span class="ident" id="6643285">addrList</span><span class="op" id="6643293">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6643297">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643350">&amp;</span><span class="ident" id="6643351">TCPAddr</span><span class="op" id="6643358">{</span><span class="ident" id="6643359">IP</span><span class="op" id="6643361">:</span>&nbsp;<span class="ident" id="6643363">IPv4</span><span class="op" id="6643367">(</span><span class="num" id="6643368">198</span><span class="op" id="6643371">,</span>&nbsp;<span class="num" id="6643373">18</span><span class="op" id="6643375">,</span>&nbsp;<span class="num" id="6643377">0</span><span class="op" id="6643378">,</span>&nbsp;<span class="num" id="6643380">254</span><span class="op" id="6643383">)</span><span class="op" id="6643384">,</span>&nbsp;<span class="ident" id="6643386">Port</span><span class="op" id="6643390">:</span>&nbsp;<span class="ident" id="6643392">portnum</span><span class="op" id="6643399">}</span><span class="op" id="6643400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643404">&amp;</span><span class="ident" id="6643405">TCPAddr</span><span class="op" id="6643412">{</span><span class="ident" id="6643413">IP</span><span class="op" id="6643415">:</span>&nbsp;<span class="ident" id="6643417">ParseIP</span><span class="op" id="6643424">(</span><span class="string" id="6643425">&#34;2001:2::254&#34;</span><span class="op" id="6643438">)</span><span class="op" id="6643439">,</span>&nbsp;<span class="ident" id="6643441">Port</span><span class="op" id="6643445">:</span>&nbsp;<span class="ident" id="6643447">portnum</span><span class="op" id="6643454">}</span><span class="op" id="6643455">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6643460">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643497">&amp;</span><span class="ident" id="6643498">TCPAddr</span><span class="op" id="6643505">{</span><span class="ident" id="6643506">IP</span><span class="op" id="6643508">:</span>&nbsp;<span class="ident" id="6643510">IPv4</span><span class="op" id="6643514">(</span><span class="num" id="6643515">127</span><span class="op" id="6643518">,</span>&nbsp;<span class="num" id="6643520">0</span><span class="op" id="6643521">,</span>&nbsp;<span class="num" id="6643523">0</span><span class="op" id="6643524">,</span>&nbsp;<span class="num" id="6643526">1</span><span class="op" id="6643527">)</span><span class="op" id="6643528">,</span>&nbsp;<span class="ident" id="6643530">Port</span><span class="op" id="6643534">:</span>&nbsp;<span class="ident" id="6643536">portnum</span><span class="op" id="6643543">}</span><span class="op" id="6643544">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643548">&amp;</span><span class="ident" id="6643549">TCPAddr</span><span class="op" id="6643556">{</span><span class="ident" id="6643557">IP</span><span class="op" id="6643559">:</span>&nbsp;<span class="ident" id="6643561">IPv6loopback</span><span class="op" id="6643573">,</span>&nbsp;<span class="ident" id="6643575">Port</span><span class="op" id="6643579">:</span>&nbsp;<span class="ident" id="6643581">portnum</span><span class="op" id="6643588">}</span><span class="op" id="6643589">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6643594">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643646">&amp;</span><span class="ident" id="6643647">TCPAddr</span><span class="op" id="6643654">{</span><span class="ident" id="6643655">IP</span><span class="op" id="6643657">:</span>&nbsp;<span class="ident" id="6643659">IPv4</span><span class="op" id="6643663">(</span><span class="num" id="6643664">127</span><span class="op" id="6643667">,</span>&nbsp;<span class="num" id="6643669">0</span><span class="op" id="6643670">,</span>&nbsp;<span class="num" id="6643672">0</span><span class="op" id="6643673">,</span>&nbsp;<span class="num" id="6643675">1</span><span class="op" id="6643676">)</span><span class="op" id="6643677">,</span>&nbsp;<span class="ident" id="6643679">Port</span><span class="op" id="6643683">:</span>&nbsp;<span class="ident" id="6643685">portnum</span><span class="op" id="6643692">}</span><span class="op" id="6643693">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643697">&amp;</span><span class="ident" id="6643698">TCPAddr</span><span class="op" id="6643705">{</span><span class="ident" id="6643706">IP</span><span class="op" id="6643708">:</span>&nbsp;<span class="ident" id="6643710">IPv6loopback</span><span class="op" id="6643722">,</span>&nbsp;<span class="ident" id="6643724">Port</span><span class="op" id="6643728">:</span>&nbsp;<span class="ident" id="6643730">portnum</span><span class="op" id="6643737">}</span><span class="op" id="6643738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643744">const</span>&nbsp;<span class="ident" id="6643750">T1</span>&nbsp;<span class="op" id="6643753">=</span>&nbsp;<span class="num" id="6643755">10</span>&nbsp;<span class="op" id="6643758">*</span>&nbsp;<span class="ident" id="6643760">time</span><span class="op" id="6643764">.</span><span class="ident" id="6643765">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643778">const</span>&nbsp;<span class="ident" id="6643784">T2</span>&nbsp;<span class="op" id="6643787">=</span>&nbsp;<span class="num" id="6643789">2</span>&nbsp;<span class="op" id="6643791">*</span>&nbsp;<span class="ident" id="6643793">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643797">const</span>&nbsp;<span class="ident" id="6643803">N</span>&nbsp;<span class="op" id="6643805">=</span>&nbsp;<span class="num" id="6643807">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643811">for</span>&nbsp;<span class="ident" id="6643815">i</span>&nbsp;<span class="op" id="6643817">:=</span>&nbsp;<span class="num" id="6643820">0</span><span class="op" id="6643821">;</span>&nbsp;<span class="ident" id="6643823">i</span>&nbsp;<span class="op" id="6643825">&lt;</span>&nbsp;<span class="ident" id="6643827">N</span><span class="op" id="6643828">;</span>&nbsp;<span class="ident" id="6643830">i</span><span class="op" id="6643831">++</span>&nbsp;<span class="op" id="6643834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643838">wg</span><span class="op" id="6643840">.</span><span class="ident" id="6643841">Add</span><span class="op" id="6643844">(</span><span class="num" id="6643845">1</span><span class="op" id="6643846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643850">go</span>&nbsp;<span class="keyword" id="6643853">func</span><span class="op" id="6643857">(</span><span class="op" id="6643858">)</span>&nbsp;<span class="op" id="6643860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643865">defer</span>&nbsp;<span class="ident" id="6643871">wg</span><span class="op" id="6643873">.</span><span class="ident" id="6643874">Done</span><span class="op" id="6643878">(</span><span class="op" id="6643879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6643884">if</span>&nbsp;<span class="ident" id="6643887">c</span><span class="op" id="6643888">,</span>&nbsp;<span class="ident" id="6643890">err</span>&nbsp;<span class="op" id="6643894">:=</span>&nbsp;<span class="ident" id="6643897">dialMulti</span><span class="op" id="6643906">(</span><span class="string" id="6643907">&#34;tcp&#34;</span><span class="op" id="6643912">,</span>&nbsp;<span class="string" id="6643914">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="6643934">,</span>&nbsp;<span class="builtintype" id="6643936">nil</span><span class="op" id="6643939">,</span>&nbsp;<span class="ident" id="6643941">ras</span><span class="op" id="6643944">,</span>&nbsp;<span class="ident" id="6643946">time</span><span class="op" id="6643950">.</span><span class="ident" id="6643951">Now</span><span class="op" id="6643954">(</span><span class="op" id="6643955">)</span><span class="op" id="6643956">.</span><span class="ident" id="6643957">Add</span><span class="op" id="6643960">(</span><span class="ident" id="6643961">T1</span><span class="op" id="6643963">)</span><span class="op" id="6643964">)</span><span class="op" id="6643965">;</span>&nbsp;<span class="ident" id="6643967">err</span>&nbsp;<span class="op" id="6643971">==</span>&nbsp;<span class="builtintype" id="6643974">nil</span>&nbsp;<span class="op" id="6643978">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6643984">c</span><span class="op" id="6643985">.</span><span class="ident" id="6643986">Close</span><span class="op" id="6643991">(</span><span class="op" id="6643992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6643997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644001">}</span><span class="op" id="6644002">(</span><span class="op" id="6644003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644009">wg</span><span class="op" id="6644011">.</span><span class="ident" id="6644012">Wait</span><span class="op" id="6644016">(</span><span class="op" id="6644017">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644020">time</span><span class="op" id="6644024">.</span><span class="ident" id="6644025">Sleep</span><span class="op" id="6644030">(</span><span class="ident" id="6644031">T2</span><span class="op" id="6644033">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644037">ntcp</span><span class="op" id="6644041">,</span>&nbsp;<span class="ident" id="6644043">after</span><span class="op" id="6644048">,</span>&nbsp;<span class="ident" id="6644050">nclose</span><span class="op" id="6644056">,</span>&nbsp;<span class="ident" id="6644058">err</span>&nbsp;<span class="op" id="6644062">:=</span>&nbsp;<span class="ident" id="6644065">numTCP</span><span class="op" id="6644071">(</span><span class="op" id="6644072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644075">if</span>&nbsp;<span class="ident" id="6644078">err</span>&nbsp;<span class="op" id="6644082">!=</span>&nbsp;<span class="builtintype" id="6644085">nil</span>&nbsp;<span class="op" id="6644089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644093">t</span><span class="op" id="6644094">.</span><span class="ident" id="6644095">Skipf</span><span class="op" id="6644100">(</span><span class="string" id="6644101">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6644151">,</span>&nbsp;<span class="ident" id="6644153">err</span><span class="op" id="6644156">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644162">t</span><span class="op" id="6644163">.</span><span class="ident" id="6644164">Logf</span><span class="op" id="6644168">(</span><span class="string" id="6644169">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="6644228">,</span>&nbsp;<span class="ident" id="6644230">ntcp</span><span class="op" id="6644234">,</span>&nbsp;<span class="ident" id="6644236">after</span><span class="op" id="6644241">,</span>&nbsp;<span class="ident" id="6644243">nclose</span><span class="op" id="6644249">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644253">if</span>&nbsp;<span class="ident" id="6644256">after</span>&nbsp;<span class="op" id="6644262">!=</span>&nbsp;<span class="ident" id="6644265">before</span>&nbsp;<span class="op" id="6644272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644276">t</span><span class="op" id="6644277">.</span><span class="ident" id="6644278">Fatalf</span><span class="op" id="6644284">(</span><span class="string" id="6644285">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="6644320">,</span>&nbsp;<span class="ident" id="6644322">after</span><span class="op" id="6644327">,</span>&nbsp;<span class="ident" id="6644329">before</span><span class="op" id="6644335">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644338">}</span><br>
<span class="lineno"></span><span class="op" id="6644340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6644343">func</span>&nbsp;<span class="ident" id="6644348">numFD</span><span class="op" id="6644353">(</span><span class="op" id="6644354">)</span>&nbsp;<span class="builtintype" id="6644356">int</span>&nbsp;<span class="op" id="6644360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644363">if</span>&nbsp;<span class="ident" id="6644366">runtime</span><span class="op" id="6644373">.</span><span class="ident" id="6644374">GOOS</span>&nbsp;<span class="op" id="6644379">==</span>&nbsp;<span class="string" id="6644382">&#34;linux&#34;</span>&nbsp;<span class="op" id="6644390">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644394">f</span><span class="op" id="6644395">,</span>&nbsp;<span class="ident" id="6644397">err</span>&nbsp;<span class="op" id="6644401">:=</span>&nbsp;<span class="ident" id="6644404">os</span><span class="op" id="6644406">.</span><span class="ident" id="6644407">Open</span><span class="op" id="6644411">(</span><span class="string" id="6644412">&#34;/proc/self/fd&#34;</span><span class="op" id="6644427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644431">if</span>&nbsp;<span class="ident" id="6644434">err</span>&nbsp;<span class="op" id="6644438">!=</span>&nbsp;<span class="builtintype" id="6644441">nil</span>&nbsp;<span class="op" id="6644445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6644450">panic</span><span class="op" id="6644455">(</span><span class="ident" id="6644456">err</span><span class="op" id="6644459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644467">defer</span>&nbsp;<span class="ident" id="6644473">f</span><span class="op" id="6644474">.</span><span class="ident" id="6644475">Close</span><span class="op" id="6644480">(</span><span class="op" id="6644481">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644485">names</span><span class="op" id="6644490">,</span>&nbsp;<span class="ident" id="6644492">err</span>&nbsp;<span class="op" id="6644496">:=</span>&nbsp;<span class="ident" id="6644499">f</span><span class="op" id="6644500">.</span><span class="ident" id="6644501">Readdirnames</span><span class="op" id="6644513">(</span><span class="num" id="6644514">0</span><span class="op" id="6644515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644519">if</span>&nbsp;<span class="ident" id="6644522">err</span>&nbsp;<span class="op" id="6644526">!=</span>&nbsp;<span class="builtintype" id="6644529">nil</span>&nbsp;<span class="op" id="6644533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6644538">panic</span><span class="op" id="6644543">(</span><span class="ident" id="6644544">err</span><span class="op" id="6644547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644555">return</span>&nbsp;<span class="builtinfunc" id="6644562">len</span><span class="op" id="6644565">(</span><span class="ident" id="6644566">names</span><span class="op" id="6644571">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6644577">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6644633">panic</span><span class="op" id="6644638">(</span><span class="string" id="6644639">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="6644668">+</span>&nbsp;<span class="ident" id="6644670">runtime</span><span class="op" id="6644677">.</span><span class="ident" id="6644678">GOOS</span><span class="op" id="6644682">)</span><br>
<span class="lineno"></span><span class="op" id="6644684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6644687">func</span>&nbsp;<span class="ident" id="6644692">TestDialer</span><span class="op" id="6644702">(</span><span class="ident" id="6644703">t</span>&nbsp;<span class="op" id="6644705">*</span><span class="ident" id="6644706">testing</span><span class="op" id="6644713">.</span><span class="ident" id="6644714">T</span><span class="op" id="6644715">)</span>&nbsp;<span class="op" id="6644717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644720">ln</span><span class="op" id="6644722">,</span>&nbsp;<span class="ident" id="6644724">err</span>&nbsp;<span class="op" id="6644728">:=</span>&nbsp;<span class="ident" id="6644731">Listen</span><span class="op" id="6644737">(</span><span class="string" id="6644738">&#34;tcp4&#34;</span><span class="op" id="6644744">,</span>&nbsp;<span class="string" id="6644746">&#34;127.0.0.1:0&#34;</span><span class="op" id="6644759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644762">if</span>&nbsp;<span class="ident" id="6644765">err</span>&nbsp;<span class="op" id="6644769">!=</span>&nbsp;<span class="builtintype" id="6644772">nil</span>&nbsp;<span class="op" id="6644776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644780">t</span><span class="op" id="6644781">.</span><span class="ident" id="6644782">Fatalf</span><span class="op" id="6644788">(</span><span class="string" id="6644789">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6644808">,</span>&nbsp;<span class="ident" id="6644810">err</span><span class="op" id="6644813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644816">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644819">defer</span>&nbsp;<span class="ident" id="6644825">ln</span><span class="op" id="6644827">.</span><span class="ident" id="6644828">Close</span><span class="op" id="6644833">(</span><span class="op" id="6644834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644837">ch</span>&nbsp;<span class="op" id="6644840">:=</span>&nbsp;<span class="builtinfunc" id="6644843">make</span><span class="op" id="6644847">(</span><span class="keyword" id="6644848">chan</span>&nbsp;<span class="builtintype" id="6644853">error</span><span class="op" id="6644858">,</span>&nbsp;<span class="num" id="6644860">1</span><span class="op" id="6644861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644864">go</span>&nbsp;<span class="keyword" id="6644867">func</span><span class="op" id="6644871">(</span><span class="op" id="6644872">)</span>&nbsp;<span class="op" id="6644874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644878">c</span><span class="op" id="6644879">,</span>&nbsp;<span class="ident" id="6644881">err</span>&nbsp;<span class="op" id="6644885">:=</span>&nbsp;<span class="ident" id="6644888">ln</span><span class="op" id="6644890">.</span><span class="ident" id="6644891">Accept</span><span class="op" id="6644897">(</span><span class="op" id="6644898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644902">if</span>&nbsp;<span class="ident" id="6644905">err</span>&nbsp;<span class="op" id="6644909">!=</span>&nbsp;<span class="builtintype" id="6644912">nil</span>&nbsp;<span class="op" id="6644916">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644921">ch</span>&nbsp;<span class="op" id="6644924">&lt;-</span>&nbsp;<span class="ident" id="6644927">fmt</span><span class="op" id="6644930">.</span><span class="ident" id="6644931">Errorf</span><span class="op" id="6644937">(</span><span class="string" id="6644938">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6644957">,</span>&nbsp;<span class="ident" id="6644959">err</span><span class="op" id="6644962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644967">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6644976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6644980">defer</span>&nbsp;<span class="ident" id="6644986">c</span><span class="op" id="6644987">.</span><span class="ident" id="6644988">Close</span><span class="op" id="6644993">(</span><span class="op" id="6644994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6644998">ch</span>&nbsp;<span class="op" id="6645001">&lt;-</span>&nbsp;<span class="builtintype" id="6645004">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645009">}</span><span class="op" id="6645010">(</span><span class="op" id="6645011">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645015">laddr</span><span class="op" id="6645020">,</span>&nbsp;<span class="ident" id="6645022">err</span>&nbsp;<span class="op" id="6645026">:=</span>&nbsp;<span class="ident" id="6645029">ResolveTCPAddr</span><span class="op" id="6645043">(</span><span class="string" id="6645044">&#34;tcp4&#34;</span><span class="op" id="6645050">,</span>&nbsp;<span class="string" id="6645052">&#34;127.0.0.1:0&#34;</span><span class="op" id="6645065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645068">if</span>&nbsp;<span class="ident" id="6645071">err</span>&nbsp;<span class="op" id="6645075">!=</span>&nbsp;<span class="builtintype" id="6645078">nil</span>&nbsp;<span class="op" id="6645082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645086">t</span><span class="op" id="6645087">.</span><span class="ident" id="6645088">Fatalf</span><span class="op" id="6645094">(</span><span class="string" id="6645095">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6645122">,</span>&nbsp;<span class="ident" id="6645124">err</span><span class="op" id="6645127">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645133">d</span>&nbsp;<span class="op" id="6645135">:=</span>&nbsp;<span class="op" id="6645138">&amp;</span><span class="ident" id="6645139">Dialer</span><span class="op" id="6645145">{</span><span class="ident" id="6645146">LocalAddr</span><span class="op" id="6645155">:</span>&nbsp;<span class="ident" id="6645157">laddr</span><span class="op" id="6645162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645165">c</span><span class="op" id="6645166">,</span>&nbsp;<span class="ident" id="6645168">err</span>&nbsp;<span class="op" id="6645172">:=</span>&nbsp;<span class="ident" id="6645175">d</span><span class="op" id="6645176">.</span><span class="ident" id="6645177">Dial</span><span class="op" id="6645181">(</span><span class="string" id="6645182">&#34;tcp4&#34;</span><span class="op" id="6645188">,</span>&nbsp;<span class="ident" id="6645190">ln</span><span class="op" id="6645192">.</span><span class="ident" id="6645193">Addr</span><span class="op" id="6645197">(</span><span class="op" id="6645198">)</span><span class="op" id="6645199">.</span><span class="ident" id="6645200">String</span><span class="op" id="6645206">(</span><span class="op" id="6645207">)</span><span class="op" id="6645208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645211">if</span>&nbsp;<span class="ident" id="6645214">err</span>&nbsp;<span class="op" id="6645218">!=</span>&nbsp;<span class="builtintype" id="6645221">nil</span>&nbsp;<span class="op" id="6645225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645229">t</span><span class="op" id="6645230">.</span><span class="ident" id="6645231">Fatalf</span><span class="op" id="6645237">(</span><span class="string" id="6645238">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6645255">,</span>&nbsp;<span class="ident" id="6645257">err</span><span class="op" id="6645260">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645266">defer</span>&nbsp;<span class="ident" id="6645272">c</span><span class="op" id="6645273">.</span><span class="ident" id="6645274">Close</span><span class="op" id="6645279">(</span><span class="op" id="6645280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645283">c</span><span class="op" id="6645284">.</span><span class="ident" id="6645285">Read</span><span class="op" id="6645289">(</span><span class="builtinfunc" id="6645290">make</span><span class="op" id="6645294">(</span><span class="op" id="6645295">[</span><span class="op" id="6645296">]</span><span class="builtintype" id="6645297">byte</span><span class="op" id="6645301">,</span>&nbsp;<span class="num" id="6645303">1</span><span class="op" id="6645304">)</span><span class="op" id="6645305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645308">err</span>&nbsp;<span class="op" id="6645312">=</span>&nbsp;<span class="op" id="6645314">&lt;-</span><span class="ident" id="6645316">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645320">if</span>&nbsp;<span class="ident" id="6645323">err</span>&nbsp;<span class="op" id="6645327">!=</span>&nbsp;<span class="builtintype" id="6645330">nil</span>&nbsp;<span class="op" id="6645334">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645338">t</span><span class="op" id="6645339">.</span><span class="ident" id="6645340">Error</span><span class="op" id="6645345">(</span><span class="ident" id="6645346">err</span><span class="op" id="6645349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645352">}</span><br>
<span class="lineno"></span><span class="op" id="6645354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6645357">func</span>&nbsp;<span class="ident" id="6645362">TestDialDualStackLocalhost</span><span class="op" id="6645388">(</span><span class="ident" id="6645389">t</span>&nbsp;<span class="op" id="6645391">*</span><span class="ident" id="6645392">testing</span><span class="op" id="6645399">.</span><span class="ident" id="6645400">T</span><span class="op" id="6645401">)</span>&nbsp;<span class="op" id="6645403">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645406">switch</span>&nbsp;<span class="ident" id="6645413">runtime</span><span class="op" id="6645420">.</span><span class="ident" id="6645421">GOOS</span>&nbsp;<span class="op" id="6645426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645429">case</span>&nbsp;<span class="string" id="6645434">&#34;nacl&#34;</span><span class="op" id="6645440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645444">t</span><span class="op" id="6645445">.</span><span class="ident" id="6645446">Skipf</span><span class="op" id="6645451">(</span><span class="string" id="6645452">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6645473">,</span>&nbsp;<span class="ident" id="6645475">runtime</span><span class="op" id="6645482">.</span><span class="ident" id="6645483">GOOS</span><span class="op" id="6645487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645494">if</span>&nbsp;<span class="ident" id="6645497">ips</span><span class="op" id="6645500">,</span>&nbsp;<span class="ident" id="6645502">err</span>&nbsp;<span class="op" id="6645506">:=</span>&nbsp;<span class="ident" id="6645509">LookupIP</span><span class="op" id="6645517">(</span><span class="string" id="6645518">&#34;localhost&#34;</span><span class="op" id="6645529">)</span><span class="op" id="6645530">;</span>&nbsp;<span class="ident" id="6645532">err</span>&nbsp;<span class="op" id="6645536">!=</span>&nbsp;<span class="builtintype" id="6645539">nil</span>&nbsp;<span class="op" id="6645543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645547">t</span><span class="op" id="6645548">.</span><span class="ident" id="6645549">Fatalf</span><span class="op" id="6645555">(</span><span class="string" id="6645556">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6645577">,</span>&nbsp;<span class="ident" id="6645579">err</span><span class="op" id="6645582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645585">}</span>&nbsp;<span class="keyword" id="6645587">else</span>&nbsp;<span class="keyword" id="6645592">if</span>&nbsp;<span class="builtinfunc" id="6645595">len</span><span class="op" id="6645598">(</span><span class="ident" id="6645599">ips</span><span class="op" id="6645602">)</span>&nbsp;<span class="op" id="6645604">&lt;</span>&nbsp;<span class="num" id="6645606">2</span>&nbsp;<span class="op" id="6645608">||</span>&nbsp;<span class="op" id="6645611">!</span><span class="ident" id="6645612">supportsIPv4</span>&nbsp;<span class="op" id="6645625">||</span>&nbsp;<span class="op" id="6645628">!</span><span class="ident" id="6645629">supportsIPv6</span>&nbsp;<span class="op" id="6645642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645646">t</span><span class="op" id="6645647">.</span><span class="ident" id="6645648">Skip</span><span class="op" id="6645652">(</span><span class="string" id="6645653">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="6645725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645728">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645732">touchAndByeServer</span>&nbsp;<span class="op" id="6645750">:=</span>&nbsp;<span class="keyword" id="6645753">func</span><span class="op" id="6645757">(</span><span class="ident" id="6645758">dss</span>&nbsp;<span class="op" id="6645762">*</span><span class="ident" id="6645763">dualStackServer</span><span class="op" id="6645778">,</span>&nbsp;<span class="ident" id="6645780">ln</span>&nbsp;<span class="ident" id="6645783">Listener</span><span class="op" id="6645791">)</span>&nbsp;<span class="op" id="6645793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645797">for</span>&nbsp;<span class="op" id="6645801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645806">if</span>&nbsp;<span class="ident" id="6645809">c</span><span class="op" id="6645810">,</span>&nbsp;<span class="ident" id="6645812">err</span>&nbsp;<span class="op" id="6645816">:=</span>&nbsp;<span class="ident" id="6645819">ln</span><span class="op" id="6645821">.</span><span class="ident" id="6645822">Accept</span><span class="op" id="6645828">(</span><span class="op" id="6645829">)</span><span class="op" id="6645830">;</span>&nbsp;<span class="ident" id="6645832">err</span>&nbsp;<span class="op" id="6645836">!=</span>&nbsp;<span class="builtintype" id="6645839">nil</span>&nbsp;<span class="op" id="6645843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6645849">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645859">}</span>&nbsp;<span class="keyword" id="6645861">else</span>&nbsp;<span class="op" id="6645866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645872">c</span><span class="op" id="6645873">.</span><span class="ident" id="6645874">Close</span><span class="op" id="6645879">(</span><span class="op" id="6645880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645892">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6645895">dss</span><span class="op" id="6645898">,</span>&nbsp;<span class="ident" id="6645900">err</span>&nbsp;<span class="op" id="6645904">:=</span>&nbsp;<span class="ident" id="6645907">newDualStackServer</span><span class="op" id="6645925">(</span><span class="op" id="6645926">[</span><span class="op" id="6645927">]</span><span class="ident" id="6645928">streamListener</span><span class="op" id="6645942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645946">{</span><span class="ident" id="6645947">net</span><span class="op" id="6645950">:</span>&nbsp;<span class="string" id="6645952">&#34;tcp4&#34;</span><span class="op" id="6645958">,</span>&nbsp;<span class="ident" id="6645960">addr</span><span class="op" id="6645964">:</span>&nbsp;<span class="string" id="6645966">&#34;127.0.0.1&#34;</span><span class="op" id="6645977">}</span><span class="op" id="6645978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6645982">{</span><span class="ident" id="6645983">net</span><span class="op" id="6645986">:</span>&nbsp;<span class="string" id="6645988">&#34;tcp6&#34;</span><span class="op" id="6645994">,</span>&nbsp;<span class="ident" id="6645996">addr</span><span class="op" id="6646000">:</span>&nbsp;<span class="string" id="6646002">&#34;[::1]&#34;</span><span class="op" id="6646009">}</span><span class="op" id="6646010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646013">}</span><span class="op" id="6646014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646017">if</span>&nbsp;<span class="ident" id="6646020">err</span>&nbsp;<span class="op" id="6646024">!=</span>&nbsp;<span class="builtintype" id="6646027">nil</span>&nbsp;<span class="op" id="6646031">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646035">t</span><span class="op" id="6646036">.</span><span class="ident" id="6646037">Fatalf</span><span class="op" id="6646043">(</span><span class="string" id="6646044">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6646075">,</span>&nbsp;<span class="ident" id="6646077">err</span><span class="op" id="6646080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646086">defer</span>&nbsp;<span class="ident" id="6646092">dss</span><span class="op" id="6646095">.</span><span class="ident" id="6646096">teardown</span><span class="op" id="6646104">(</span><span class="op" id="6646105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646108">if</span>&nbsp;<span class="ident" id="6646111">err</span>&nbsp;<span class="op" id="6646115">:=</span>&nbsp;<span class="ident" id="6646118">dss</span><span class="op" id="6646121">.</span><span class="ident" id="6646122">buildup</span><span class="op" id="6646129">(</span><span class="ident" id="6646130">touchAndByeServer</span><span class="op" id="6646147">)</span><span class="op" id="6646148">;</span>&nbsp;<span class="ident" id="6646150">err</span>&nbsp;<span class="op" id="6646154">!=</span>&nbsp;<span class="builtintype" id="6646157">nil</span>&nbsp;<span class="op" id="6646161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646165">t</span><span class="op" id="6646166">.</span><span class="ident" id="6646167">Fatalf</span><span class="op" id="6646173">(</span><span class="string" id="6646174">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6646210">,</span>&nbsp;<span class="ident" id="6646212">err</span><span class="op" id="6646215">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646222">d</span>&nbsp;<span class="op" id="6646224">:=</span>&nbsp;<span class="op" id="6646227">&amp;</span><span class="ident" id="6646228">Dialer</span><span class="op" id="6646234">{</span><span class="ident" id="6646235">DualStack</span><span class="op" id="6646244">:</span>&nbsp;<span class="builtintype" id="6646246">true</span><span class="op" id="6646250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646253">for</span>&nbsp;<span class="keyword" id="6646257">range</span>&nbsp;<span class="ident" id="6646263">dss</span><span class="op" id="6646266">.</span><span class="ident" id="6646267">lns</span>&nbsp;<span class="op" id="6646271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646275">if</span>&nbsp;<span class="ident" id="6646278">c</span><span class="op" id="6646279">,</span>&nbsp;<span class="ident" id="6646281">err</span>&nbsp;<span class="op" id="6646285">:=</span>&nbsp;<span class="ident" id="6646288">d</span><span class="op" id="6646289">.</span><span class="ident" id="6646290">Dial</span><span class="op" id="6646294">(</span><span class="string" id="6646295">&#34;tcp&#34;</span><span class="op" id="6646300">,</span>&nbsp;<span class="string" id="6646302">&#34;localhost:&#34;</span><span class="op" id="6646314">+</span><span class="ident" id="6646315">dss</span><span class="op" id="6646318">.</span><span class="ident" id="6646319">port</span><span class="op" id="6646323">)</span><span class="op" id="6646324">;</span>&nbsp;<span class="ident" id="6646326">err</span>&nbsp;<span class="op" id="6646330">!=</span>&nbsp;<span class="builtintype" id="6646333">nil</span>&nbsp;<span class="op" id="6646337">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646342">t</span><span class="op" id="6646343">.</span><span class="ident" id="6646344">Errorf</span><span class="op" id="6646350">(</span><span class="string" id="6646351">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6646368">,</span>&nbsp;<span class="ident" id="6646370">err</span><span class="op" id="6646373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646377">}</span>&nbsp;<span class="keyword" id="6646379">else</span>&nbsp;<span class="op" id="6646384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646389">if</span>&nbsp;<span class="ident" id="6646392">addr</span>&nbsp;<span class="op" id="6646397">:=</span>&nbsp;<span class="ident" id="6646400">c</span><span class="op" id="6646401">.</span><span class="ident" id="6646402">LocalAddr</span><span class="op" id="6646411">(</span><span class="op" id="6646412">)</span><span class="op" id="6646413">.</span><span class="op" id="6646414">(</span><span class="op" id="6646415">*</span><span class="ident" id="6646416">TCPAddr</span><span class="op" id="6646423">)</span><span class="op" id="6646424">;</span>&nbsp;<span class="ident" id="6646426">addr</span><span class="op" id="6646430">.</span><span class="ident" id="6646431">IP</span><span class="op" id="6646433">.</span><span class="ident" id="6646434">To4</span><span class="op" id="6646437">(</span><span class="op" id="6646438">)</span>&nbsp;<span class="op" id="6646440">!=</span>&nbsp;<span class="builtintype" id="6646443">nil</span>&nbsp;<span class="op" id="6646447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646453">dss</span><span class="op" id="6646456">.</span><span class="ident" id="6646457">teardownNetwork</span><span class="op" id="6646472">(</span><span class="string" id="6646473">&#34;tcp4&#34;</span><span class="op" id="6646479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646484">}</span>&nbsp;<span class="keyword" id="6646486">else</span>&nbsp;<span class="keyword" id="6646491">if</span>&nbsp;<span class="ident" id="6646494">addr</span><span class="op" id="6646498">.</span><span class="ident" id="6646499">IP</span><span class="op" id="6646501">.</span><span class="ident" id="6646502">To16</span><span class="op" id="6646506">(</span><span class="op" id="6646507">)</span>&nbsp;<span class="op" id="6646509">!=</span>&nbsp;<span class="builtintype" id="6646512">nil</span>&nbsp;<span class="op" id="6646516">&amp;&amp;</span>&nbsp;<span class="ident" id="6646519">addr</span><span class="op" id="6646523">.</span><span class="ident" id="6646524">IP</span><span class="op" id="6646526">.</span><span class="ident" id="6646527">To4</span><span class="op" id="6646530">(</span><span class="op" id="6646531">)</span>&nbsp;<span class="op" id="6646533">==</span>&nbsp;<span class="builtintype" id="6646536">nil</span>&nbsp;<span class="op" id="6646540">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646546">dss</span><span class="op" id="6646549">.</span><span class="ident" id="6646550">teardownNetwork</span><span class="op" id="6646565">(</span><span class="string" id="6646566">&#34;tcp6&#34;</span><span class="op" id="6646572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646582">c</span><span class="op" id="6646583">.</span><span class="ident" id="6646584">Close</span><span class="op" id="6646589">(</span><span class="op" id="6646590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646597">}</span><br>
<span class="lineno">515</span><span class="op" id="6646599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6646602">func</span>&nbsp;<span class="ident" id="6646607">TestDialerKeepAlive</span><span class="op" id="6646626">(</span><span class="ident" id="6646627">t</span>&nbsp;<span class="op" id="6646629">*</span><span class="ident" id="6646630">testing</span><span class="op" id="6646637">.</span><span class="ident" id="6646638">T</span><span class="op" id="6646639">)</span>&nbsp;<span class="op" id="6646641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646644">ln</span>&nbsp;<span class="op" id="6646647">:=</span>&nbsp;<span class="ident" id="6646650">newLocalListener</span><span class="op" id="6646666">(</span><span class="ident" id="6646667">t</span><span class="op" id="6646668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646671">defer</span>&nbsp;<span class="ident" id="6646677">ln</span><span class="op" id="6646679">.</span><span class="ident" id="6646680">Close</span><span class="op" id="6646685">(</span><span class="op" id="6646686">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646689">defer</span>&nbsp;<span class="keyword" id="6646695">func</span><span class="op" id="6646699">(</span><span class="op" id="6646700">)</span>&nbsp;<span class="op" id="6646702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646706">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6646727">=</span>&nbsp;<span class="keyword" id="6646729">func</span><span class="op" id="6646733">(</span><span class="op" id="6646734">)</span>&nbsp;<span class="op" id="6646736">{</span><span class="op" id="6646737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646740">}</span><span class="op" id="6646741">(</span><span class="op" id="6646742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646745">go</span>&nbsp;<span class="keyword" id="6646748">func</span><span class="op" id="6646752">(</span><span class="op" id="6646753">)</span>&nbsp;<span class="op" id="6646755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646759">for</span>&nbsp;<span class="op" id="6646763">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646768">c</span><span class="op" id="6646769">,</span>&nbsp;<span class="ident" id="6646771">err</span>&nbsp;<span class="op" id="6646775">:=</span>&nbsp;<span class="ident" id="6646778">ln</span><span class="op" id="6646780">.</span><span class="ident" id="6646781">Accept</span><span class="op" id="6646787">(</span><span class="op" id="6646788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646793">if</span>&nbsp;<span class="ident" id="6646796">err</span>&nbsp;<span class="op" id="6646800">!=</span>&nbsp;<span class="builtintype" id="6646803">nil</span>&nbsp;<span class="op" id="6646807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646813">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646828">c</span><span class="op" id="6646829">.</span><span class="ident" id="6646830">Close</span><span class="op" id="6646835">(</span><span class="op" id="6646836">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6646843">}</span><span class="op" id="6646844">(</span><span class="op" id="6646845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646848">for</span>&nbsp;<span class="ident" id="6646852">_</span><span class="op" id="6646853">,</span>&nbsp;<span class="ident" id="6646855">keepAlive</span>&nbsp;<span class="op" id="6646865">:=</span>&nbsp;<span class="keyword" id="6646868">range</span>&nbsp;<span class="op" id="6646874">[</span><span class="op" id="6646875">]</span><span class="builtintype" id="6646876">bool</span><span class="op" id="6646880">{</span><span class="builtintype" id="6646881">false</span><span class="op" id="6646886">,</span>&nbsp;<span class="builtintype" id="6646888">true</span><span class="op" id="6646892">}</span>&nbsp;<span class="op" id="6646894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646898">got</span>&nbsp;<span class="op" id="6646902">:=</span>&nbsp;<span class="builtintype" id="6646905">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646913">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6646934">=</span>&nbsp;<span class="keyword" id="6646936">func</span><span class="op" id="6646940">(</span><span class="op" id="6646941">)</span>&nbsp;<span class="op" id="6646943">{</span>&nbsp;<span class="ident" id="6646945">got</span>&nbsp;<span class="op" id="6646949">=</span>&nbsp;<span class="builtintype" id="6646951">true</span>&nbsp;<span class="op" id="6646956">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646960">var</span>&nbsp;<span class="ident" id="6646964">d</span>&nbsp;<span class="ident" id="6646966">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6646975">if</span>&nbsp;<span class="ident" id="6646978">keepAlive</span>&nbsp;<span class="op" id="6646988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6646993">d</span><span class="op" id="6646994">.</span><span class="ident" id="6646995">KeepAlive</span>&nbsp;<span class="op" id="6647005">=</span>&nbsp;<span class="num" id="6647007">30</span>&nbsp;<span class="op" id="6647010">*</span>&nbsp;<span class="ident" id="6647012">time</span><span class="op" id="6647016">.</span><span class="ident" id="6647017">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6647026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6647030">c</span><span class="op" id="6647031">,</span>&nbsp;<span class="ident" id="6647033">err</span>&nbsp;<span class="op" id="6647037">:=</span>&nbsp;<span class="ident" id="6647040">d</span><span class="op" id="6647041">.</span><span class="ident" id="6647042">Dial</span><span class="op" id="6647046">(</span><span class="string" id="6647047">&#34;tcp&#34;</span><span class="op" id="6647052">,</span>&nbsp;<span class="ident" id="6647054">ln</span><span class="op" id="6647056">.</span><span class="ident" id="6647057">Addr</span><span class="op" id="6647061">(</span><span class="op" id="6647062">)</span><span class="op" id="6647063">.</span><span class="ident" id="6647064">String</span><span class="op" id="6647070">(</span><span class="op" id="6647071">)</span><span class="op" id="6647072">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6647076">if</span>&nbsp;<span class="ident" id="6647079">err</span>&nbsp;<span class="op" id="6647083">!=</span>&nbsp;<span class="builtintype" id="6647086">nil</span>&nbsp;<span class="op" id="6647090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6647095">t</span><span class="op" id="6647096">.</span><span class="ident" id="6647097">Fatal</span><span class="op" id="6647102">(</span><span class="ident" id="6647103">err</span><span class="op" id="6647106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6647110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6647114">c</span><span class="op" id="6647115">.</span><span class="ident" id="6647116">Close</span><span class="op" id="6647121">(</span><span class="op" id="6647122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6647126">if</span>&nbsp;<span class="ident" id="6647129">got</span>&nbsp;<span class="op" id="6647133">!=</span>&nbsp;<span class="ident" id="6647136">keepAlive</span>&nbsp;<span class="op" id="6647146">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6647151">t</span><span class="op" id="6647152">.</span><span class="ident" id="6647153">Errorf</span><span class="op" id="6647159">(</span><span class="string" id="6647160">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6647218">,</span>&nbsp;<span class="ident" id="6647220">d</span><span class="op" id="6647221">.</span><span class="ident" id="6647222">KeepAlive</span><span class="op" id="6647231">,</span>&nbsp;<span class="ident" id="6647233">got</span><span class="op" id="6647236">,</span>&nbsp;<span class="op" id="6647238">!</span><span class="ident" id="6647239">got</span><span class="op" id="6647242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6647246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6647249">}</span><br>
<span class="lineno"></span><span class="op" id="6647251">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
