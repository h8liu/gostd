<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3930894">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3930949">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3931003">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3931054">package</span>&nbsp;<span class="ident" id="3931062">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3931067">import</span>&nbsp;<span class="op" id="3931074">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931077">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931086">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931096">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931112">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931126">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931143">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931158">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931168">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931175">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931181">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3931188">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3931198">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3931201">type</span>&nbsp;<span class="ident" id="3931206">clientHandshakeState</span>&nbsp;<span class="keyword" id="3931227">struct</span>&nbsp;<span class="op" id="3931234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931237">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931250">*</span><span class="ident" id="3931251">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931257">serverHello</span>&nbsp;&nbsp;<span class="op" id="3931270">*</span><span class="ident" id="3931271">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931287">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931300">*</span><span class="ident" id="3931301">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931317">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931330">*</span><span class="ident" id="3931331">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931344">finishedHash</span>&nbsp;<span class="ident" id="3931357">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931371">masterSecret</span>&nbsp;<span class="op" id="3931384">[</span><span class="op" id="3931385">]</span><span class="builtintype" id="3931386">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931392">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3931405">*</span><span class="ident" id="3931406">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="3931425">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3931428">func</span>&nbsp;<span class="op" id="3931433">(</span><span class="ident" id="3931434">c</span>&nbsp;<span class="op" id="3931436">*</span><span class="ident" id="3931437">Conn</span><span class="op" id="3931441">)</span>&nbsp;<span class="ident" id="3931443">clientHandshake</span><span class="op" id="3931458">(</span><span class="op" id="3931459">)</span>&nbsp;<span class="builtintype" id="3931461">error</span>&nbsp;<span class="op" id="3931467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931470">if</span>&nbsp;<span class="ident" id="3931473">c</span><span class="op" id="3931474">.</span><span class="ident" id="3931475">config</span>&nbsp;<span class="op" id="3931482">==</span>&nbsp;<span class="ident" id="3931485">nil</span>&nbsp;<span class="op" id="3931489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931493">c</span><span class="op" id="3931494">.</span><span class="ident" id="3931495">config</span>&nbsp;<span class="op" id="3931502">=</span>&nbsp;<span class="ident" id="3931504">defaultConfig</span><span class="op" id="3931517">(</span><span class="op" id="3931518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931521">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931525">if</span>&nbsp;<span class="builtinfunc" id="3931528">len</span><span class="op" id="3931531">(</span><span class="ident" id="3931532">c</span><span class="op" id="3931533">.</span><span class="ident" id="3931534">config</span><span class="op" id="3931540">.</span><span class="ident" id="3931541">ServerName</span><span class="op" id="3931551">)</span>&nbsp;<span class="op" id="3931553">==</span>&nbsp;<span class="num" id="3931556">0</span>&nbsp;<span class="op" id="3931558">&amp;&amp;</span>&nbsp;<span class="op" id="3931561">!</span><span class="ident" id="3931562">c</span><span class="op" id="3931563">.</span><span class="ident" id="3931564">config</span><span class="op" id="3931570">.</span><span class="ident" id="3931571">InsecureSkipVerify</span>&nbsp;<span class="op" id="3931590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931594">return</span>&nbsp;<span class="ident" id="3931601">errors</span><span class="op" id="3931607">.</span><span class="ident" id="3931608">New</span><span class="op" id="3931611">(</span><span class="string" id="3931612">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="3931694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931701">nextProtosLength</span>&nbsp;<span class="op" id="3931718">:=</span>&nbsp;<span class="num" id="3931721">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931724">for</span>&nbsp;<span class="ident" id="3931728">_</span><span class="op" id="3931729">,</span>&nbsp;<span class="ident" id="3931731">proto</span>&nbsp;<span class="op" id="3931737">:=</span>&nbsp;<span class="keyword" id="3931740">range</span>&nbsp;<span class="ident" id="3931746">c</span><span class="op" id="3931747">.</span><span class="ident" id="3931748">config</span><span class="op" id="3931754">.</span><span class="ident" id="3931755">NextProtos</span>&nbsp;<span class="op" id="3931766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931770">if</span>&nbsp;<span class="ident" id="3931773">l</span>&nbsp;<span class="op" id="3931775">:=</span>&nbsp;<span class="builtinfunc" id="3931778">len</span><span class="op" id="3931781">(</span><span class="ident" id="3931782">proto</span><span class="op" id="3931787">)</span><span class="op" id="3931788">;</span>&nbsp;<span class="ident" id="3931790">l</span>&nbsp;<span class="op" id="3931792">==</span>&nbsp;<span class="num" id="3931795">0</span>&nbsp;<span class="op" id="3931797">||</span>&nbsp;<span class="ident" id="3931800">l</span>&nbsp;<span class="op" id="3931802">&gt;</span>&nbsp;<span class="num" id="3931804">255</span>&nbsp;<span class="op" id="3931808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931813">return</span>&nbsp;<span class="ident" id="3931820">errors</span><span class="op" id="3931826">.</span><span class="ident" id="3931827">New</span><span class="op" id="3931830">(</span><span class="string" id="3931831">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="3931862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931866">}</span>&nbsp;<span class="keyword" id="3931868">else</span>&nbsp;<span class="op" id="3931873">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931878">nextProtosLength</span>&nbsp;<span class="op" id="3931895">+=</span>&nbsp;<span class="num" id="3931898">1</span>&nbsp;<span class="op" id="3931900">+</span>&nbsp;<span class="ident" id="3931902">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3931909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931912">if</span>&nbsp;<span class="ident" id="3931915">nextProtosLength</span>&nbsp;<span class="op" id="3931932">&gt;</span>&nbsp;<span class="num" id="3931934">0xffff</span>&nbsp;<span class="op" id="3931941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931945">return</span>&nbsp;<span class="ident" id="3931952">errors</span><span class="op" id="3931958">.</span><span class="ident" id="3931959">New</span><span class="op" id="3931962">(</span><span class="string" id="3931963">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="3931997">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932004">hello</span>&nbsp;<span class="op" id="3932010">:=</span>&nbsp;<span class="op" id="3932013">&amp;</span><span class="ident" id="3932014">clientHelloMsg</span><span class="op" id="3932028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932032">vers</span><span class="op" id="3932036">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932053">c</span><span class="op" id="3932054">.</span><span class="ident" id="3932055">config</span><span class="op" id="3932061">.</span><span class="ident" id="3932062">maxVersion</span><span class="op" id="3932072">(</span><span class="op" id="3932073">)</span><span class="op" id="3932074">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932078">compressionMethods</span><span class="op" id="3932096">:</span>&nbsp;&nbsp;<span class="op" id="3932099">[</span><span class="op" id="3932100">]</span><span class="builtintype" id="3932101">uint8</span><span class="op" id="3932106">{</span><span class="ident" id="3932107">compressionNone</span><span class="op" id="3932122">}</span><span class="op" id="3932123">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932127">random</span><span class="op" id="3932133">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3932148">make</span><span class="op" id="3932152">(</span><span class="op" id="3932153">[</span><span class="op" id="3932154">]</span><span class="builtintype" id="3932155">byte</span><span class="op" id="3932159">,</span>&nbsp;<span class="num" id="3932161">32</span><span class="op" id="3932163">)</span><span class="op" id="3932164">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932168">ocspStapling</span><span class="op" id="3932180">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932189">true</span><span class="op" id="3932193">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932197">serverName</span><span class="op" id="3932207">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932218">c</span><span class="op" id="3932219">.</span><span class="ident" id="3932220">config</span><span class="op" id="3932226">.</span><span class="ident" id="3932227">ServerName</span><span class="op" id="3932237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932241">supportedCurves</span><span class="op" id="3932256">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932262">c</span><span class="op" id="3932263">.</span><span class="ident" id="3932264">config</span><span class="op" id="3932270">.</span><span class="ident" id="3932271">curvePreferences</span><span class="op" id="3932287">(</span><span class="op" id="3932288">)</span><span class="op" id="3932289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932293">supportedPoints</span><span class="op" id="3932308">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3932314">[</span><span class="op" id="3932315">]</span><span class="builtintype" id="3932316">uint8</span><span class="op" id="3932321">{</span><span class="ident" id="3932322">pointFormatUncompressed</span><span class="op" id="3932345">}</span><span class="op" id="3932346">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932350">nextProtoNeg</span><span class="op" id="3932362">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3932371">len</span><span class="op" id="3932374">(</span><span class="ident" id="3932375">c</span><span class="op" id="3932376">.</span><span class="ident" id="3932377">config</span><span class="op" id="3932383">.</span><span class="ident" id="3932384">NextProtos</span><span class="op" id="3932394">)</span>&nbsp;<span class="op" id="3932396">&gt;</span>&nbsp;<span class="num" id="3932398">0</span><span class="op" id="3932399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932403">secureRenegotiation</span><span class="op" id="3932422">:</span>&nbsp;<span class="ident" id="3932424">true</span><span class="op" id="3932428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932432">alpnProtocols</span><span class="op" id="3932445">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3932453">c</span><span class="op" id="3932454">.</span><span class="ident" id="3932455">config</span><span class="op" id="3932461">.</span><span class="ident" id="3932462">NextProtos</span><span class="op" id="3932472">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932479">possibleCipherSuites</span>&nbsp;<span class="op" id="3932500">:=</span>&nbsp;<span class="ident" id="3932503">c</span><span class="op" id="3932504">.</span><span class="ident" id="3932505">config</span><span class="op" id="3932511">.</span><span class="ident" id="3932512">cipherSuites</span><span class="op" id="3932524">(</span><span class="op" id="3932525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932528">hello</span><span class="op" id="3932533">.</span><span class="ident" id="3932534">cipherSuites</span>&nbsp;<span class="op" id="3932547">=</span>&nbsp;<span class="builtinfunc" id="3932549">make</span><span class="op" id="3932553">(</span><span class="op" id="3932554">[</span><span class="op" id="3932555">]</span><span class="builtintype" id="3932556">uint16</span><span class="op" id="3932562">,</span>&nbsp;<span class="num" id="3932564">0</span><span class="op" id="3932565">,</span>&nbsp;<span class="builtinfunc" id="3932567">len</span><span class="op" id="3932570">(</span><span class="ident" id="3932571">possibleCipherSuites</span><span class="op" id="3932591">)</span><span class="op" id="3932592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3932595">NextCipherSuite</span><span class="op" id="3932610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932613">for</span>&nbsp;<span class="ident" id="3932617">_</span><span class="op" id="3932618">,</span>&nbsp;<span class="ident" id="3932620">suiteId</span>&nbsp;<span class="op" id="3932628">:=</span>&nbsp;<span class="keyword" id="3932631">range</span>&nbsp;<span class="ident" id="3932637">possibleCipherSuites</span>&nbsp;<span class="op" id="3932658">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932662">for</span>&nbsp;<span class="ident" id="3932666">_</span><span class="op" id="3932667">,</span>&nbsp;<span class="ident" id="3932669">suite</span>&nbsp;<span class="op" id="3932675">:=</span>&nbsp;<span class="keyword" id="3932678">range</span>&nbsp;<span class="ident" id="3932684">cipherSuites</span>&nbsp;<span class="op" id="3932697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932702">if</span>&nbsp;<span class="ident" id="3932705">suite</span><span class="op" id="3932710">.</span><span class="ident" id="3932711">id</span>&nbsp;<span class="op" id="3932714">!=</span>&nbsp;<span class="ident" id="3932717">suiteId</span>&nbsp;<span class="op" id="3932725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932731">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3932748">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3932804">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932836">if</span>&nbsp;<span class="ident" id="3932839">hello</span><span class="op" id="3932844">.</span><span class="ident" id="3932845">vers</span>&nbsp;<span class="op" id="3932850">&lt;</span>&nbsp;<span class="ident" id="3932852">VersionTLS12</span>&nbsp;<span class="op" id="3932865">&amp;&amp;</span>&nbsp;<span class="ident" id="3932868">suite</span><span class="op" id="3932873">.</span><span class="ident" id="3932874">flags</span><span class="op" id="3932879">&amp;</span><span class="ident" id="3932880">suiteTLS12</span>&nbsp;<span class="op" id="3932891">!=</span>&nbsp;<span class="num" id="3932894">0</span>&nbsp;<span class="op" id="3932896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932902">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932919">hello</span><span class="op" id="3932924">.</span><span class="ident" id="3932925">cipherSuites</span>&nbsp;<span class="op" id="3932938">=</span>&nbsp;<span class="builtinfunc" id="3932940">append</span><span class="op" id="3932946">(</span><span class="ident" id="3932947">hello</span><span class="op" id="3932952">.</span><span class="ident" id="3932953">cipherSuites</span><span class="op" id="3932965">,</span>&nbsp;<span class="ident" id="3932967">suiteId</span><span class="op" id="3932974">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932979">continue</span>&nbsp;<span class="ident" id="3932988">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933013">_</span><span class="op" id="3933014">,</span>&nbsp;<span class="ident" id="3933016">err</span>&nbsp;<span class="op" id="3933020">:=</span>&nbsp;<span class="ident" id="3933023">io</span><span class="op" id="3933025">.</span><span class="ident" id="3933026">ReadFull</span><span class="op" id="3933034">(</span><span class="ident" id="3933035">c</span><span class="op" id="3933036">.</span><span class="ident" id="3933037">config</span><span class="op" id="3933043">.</span><span class="ident" id="3933044">rand</span><span class="op" id="3933048">(</span><span class="op" id="3933049">)</span><span class="op" id="3933050">,</span>&nbsp;<span class="ident" id="3933052">hello</span><span class="op" id="3933057">.</span><span class="ident" id="3933058">random</span><span class="op" id="3933064">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933067">if</span>&nbsp;<span class="ident" id="3933070">err</span>&nbsp;<span class="op" id="3933074">!=</span>&nbsp;<span class="ident" id="3933077">nil</span>&nbsp;<span class="op" id="3933081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933085">c</span><span class="op" id="3933086">.</span><span class="ident" id="3933087">sendAlert</span><span class="op" id="3933096">(</span><span class="ident" id="3933097">alertInternalError</span><span class="op" id="3933115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933119">return</span>&nbsp;<span class="ident" id="3933126">errors</span><span class="op" id="3933132">.</span><span class="ident" id="3933133">New</span><span class="op" id="3933136">(</span><span class="string" id="3933137">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3933167">+</span>&nbsp;<span class="ident" id="3933169">err</span><span class="op" id="3933172">.</span><span class="ident" id="3933173">Error</span><span class="op" id="3933178">(</span><span class="op" id="3933179">)</span><span class="op" id="3933180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933187">if</span>&nbsp;<span class="ident" id="3933190">hello</span><span class="op" id="3933195">.</span><span class="ident" id="3933196">vers</span>&nbsp;<span class="op" id="3933201">&gt;=</span>&nbsp;<span class="ident" id="3933204">VersionTLS12</span>&nbsp;<span class="op" id="3933217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933221">hello</span><span class="op" id="3933226">.</span><span class="ident" id="3933227">signatureAndHashes</span>&nbsp;<span class="op" id="3933246">=</span>&nbsp;<span class="ident" id="3933248">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933285">var</span>&nbsp;<span class="ident" id="3933289">session</span>&nbsp;<span class="op" id="3933297">*</span><span class="ident" id="3933298">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933318">var</span>&nbsp;<span class="ident" id="3933322">cacheKey</span>&nbsp;<span class="builtintype" id="3933331">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933339">sessionCache</span>&nbsp;<span class="op" id="3933352">:=</span>&nbsp;<span class="ident" id="3933355">c</span><span class="op" id="3933356">.</span><span class="ident" id="3933357">config</span><span class="op" id="3933363">.</span><span class="ident" id="3933364">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933384">if</span>&nbsp;<span class="ident" id="3933387">c</span><span class="op" id="3933388">.</span><span class="ident" id="3933389">config</span><span class="op" id="3933395">.</span><span class="ident" id="3933396">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3933419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933423">sessionCache</span>&nbsp;<span class="op" id="3933436">=</span>&nbsp;<span class="ident" id="3933438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933443">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933447">if</span>&nbsp;<span class="ident" id="3933450">sessionCache</span>&nbsp;<span class="op" id="3933463">!=</span>&nbsp;<span class="ident" id="3933466">nil</span>&nbsp;<span class="op" id="3933470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933474">hello</span><span class="op" id="3933479">.</span><span class="ident" id="3933480">ticketSupported</span>&nbsp;<span class="op" id="3933496">=</span>&nbsp;<span class="ident" id="3933498">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933506">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933565">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933581">cacheKey</span>&nbsp;<span class="op" id="3933590">=</span>&nbsp;<span class="ident" id="3933592">clientSessionCacheKey</span><span class="op" id="3933613">(</span><span class="ident" id="3933614">c</span><span class="op" id="3933615">.</span><span class="ident" id="3933616">conn</span><span class="op" id="3933620">.</span><span class="ident" id="3933621">RemoteAddr</span><span class="op" id="3933631">(</span><span class="op" id="3933632">)</span><span class="op" id="3933633">,</span>&nbsp;<span class="ident" id="3933635">c</span><span class="op" id="3933636">.</span><span class="ident" id="3933637">config</span><span class="op" id="3933643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933647">candidateSession</span><span class="op" id="3933663">,</span>&nbsp;<span class="ident" id="3933665">ok</span>&nbsp;<span class="op" id="3933668">:=</span>&nbsp;<span class="ident" id="3933671">sessionCache</span><span class="op" id="3933683">.</span><span class="ident" id="3933684">Get</span><span class="op" id="3933687">(</span><span class="ident" id="3933688">cacheKey</span><span class="op" id="3933696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933700">if</span>&nbsp;<span class="ident" id="3933703">ok</span>&nbsp;<span class="op" id="3933706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933711">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3933765">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933805">cipherSuiteOk</span>&nbsp;<span class="op" id="3933819">:=</span>&nbsp;<span class="ident" id="3933822">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933831">for</span>&nbsp;<span class="ident" id="3933835">_</span><span class="op" id="3933836">,</span>&nbsp;<span class="ident" id="3933838">id</span>&nbsp;<span class="op" id="3933841">:=</span>&nbsp;<span class="keyword" id="3933844">range</span>&nbsp;<span class="ident" id="3933850">hello</span><span class="op" id="3933855">.</span><span class="ident" id="3933856">cipherSuites</span>&nbsp;<span class="op" id="3933869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933875">if</span>&nbsp;<span class="ident" id="3933878">id</span>&nbsp;<span class="op" id="3933881">==</span>&nbsp;<span class="ident" id="3933884">candidateSession</span><span class="op" id="3933900">.</span><span class="ident" id="3933901">cipherSuite</span>&nbsp;<span class="op" id="3933913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933920">cipherSuiteOk</span>&nbsp;<span class="op" id="3933934">=</span>&nbsp;<span class="ident" id="3933936">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933946">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933967">versOk</span>&nbsp;<span class="op" id="3933974">:=</span>&nbsp;<span class="ident" id="3933977">candidateSession</span><span class="op" id="3933993">.</span><span class="ident" id="3933994">vers</span>&nbsp;<span class="op" id="3933999">&gt;=</span>&nbsp;<span class="ident" id="3934002">c</span><span class="op" id="3934003">.</span><span class="ident" id="3934004">config</span><span class="op" id="3934010">.</span><span class="ident" id="3934011">minVersion</span><span class="op" id="3934021">(</span><span class="op" id="3934022">)</span>&nbsp;<span class="op" id="3934024">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934031">candidateSession</span><span class="op" id="3934047">.</span><span class="ident" id="3934048">vers</span>&nbsp;<span class="op" id="3934053">&lt;=</span>&nbsp;<span class="ident" id="3934056">c</span><span class="op" id="3934057">.</span><span class="ident" id="3934058">config</span><span class="op" id="3934064">.</span><span class="ident" id="3934065">maxVersion</span><span class="op" id="3934075">(</span><span class="op" id="3934076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934081">if</span>&nbsp;<span class="ident" id="3934084">versOk</span>&nbsp;<span class="op" id="3934091">&amp;&amp;</span>&nbsp;<span class="ident" id="3934094">cipherSuiteOk</span>&nbsp;<span class="op" id="3934108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934114">session</span>&nbsp;<span class="op" id="3934122">=</span>&nbsp;<span class="ident" id="3934124">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934148">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934155">if</span>&nbsp;<span class="ident" id="3934158">session</span>&nbsp;<span class="op" id="3934166">!=</span>&nbsp;<span class="ident" id="3934169">nil</span>&nbsp;<span class="op" id="3934173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934177">hello</span><span class="op" id="3934182">.</span><span class="ident" id="3934183">sessionTicket</span>&nbsp;<span class="op" id="3934197">=</span>&nbsp;<span class="ident" id="3934199">session</span><span class="op" id="3934206">.</span><span class="ident" id="3934207">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934223">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934275">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934333">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934354">hello</span><span class="op" id="3934359">.</span><span class="ident" id="3934360">sessionId</span>&nbsp;<span class="op" id="3934370">=</span>&nbsp;<span class="builtinfunc" id="3934372">make</span><span class="op" id="3934376">(</span><span class="op" id="3934377">[</span><span class="op" id="3934378">]</span><span class="builtintype" id="3934379">byte</span><span class="op" id="3934383">,</span>&nbsp;<span class="num" id="3934385">16</span><span class="op" id="3934387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934391">if</span>&nbsp;<span class="ident" id="3934394">_</span><span class="op" id="3934395">,</span>&nbsp;<span class="ident" id="3934397">err</span>&nbsp;<span class="op" id="3934401">:=</span>&nbsp;<span class="ident" id="3934404">io</span><span class="op" id="3934406">.</span><span class="ident" id="3934407">ReadFull</span><span class="op" id="3934415">(</span><span class="ident" id="3934416">c</span><span class="op" id="3934417">.</span><span class="ident" id="3934418">config</span><span class="op" id="3934424">.</span><span class="ident" id="3934425">rand</span><span class="op" id="3934429">(</span><span class="op" id="3934430">)</span><span class="op" id="3934431">,</span>&nbsp;<span class="ident" id="3934433">hello</span><span class="op" id="3934438">.</span><span class="ident" id="3934439">sessionId</span><span class="op" id="3934448">)</span><span class="op" id="3934449">;</span>&nbsp;<span class="ident" id="3934451">err</span>&nbsp;<span class="op" id="3934455">!=</span>&nbsp;<span class="ident" id="3934458">nil</span>&nbsp;<span class="op" id="3934462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934467">c</span><span class="op" id="3934468">.</span><span class="ident" id="3934469">sendAlert</span><span class="op" id="3934478">(</span><span class="ident" id="3934479">alertInternalError</span><span class="op" id="3934497">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934502">return</span>&nbsp;<span class="ident" id="3934509">errors</span><span class="op" id="3934515">.</span><span class="ident" id="3934516">New</span><span class="op" id="3934519">(</span><span class="string" id="3934520">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3934550">+</span>&nbsp;<span class="ident" id="3934552">err</span><span class="op" id="3934555">.</span><span class="ident" id="3934556">Error</span><span class="op" id="3934561">(</span><span class="op" id="3934562">)</span><span class="op" id="3934563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934574">c</span><span class="op" id="3934575">.</span><span class="ident" id="3934576">writeRecord</span><span class="op" id="3934587">(</span><span class="ident" id="3934588">recordTypeHandshake</span><span class="op" id="3934607">,</span>&nbsp;<span class="ident" id="3934609">hello</span><span class="op" id="3934614">.</span><span class="ident" id="3934615">marshal</span><span class="op" id="3934622">(</span><span class="op" id="3934623">)</span><span class="op" id="3934624">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934628">msg</span><span class="op" id="3934631">,</span>&nbsp;<span class="ident" id="3934633">err</span>&nbsp;<span class="op" id="3934637">:=</span>&nbsp;<span class="ident" id="3934640">c</span><span class="op" id="3934641">.</span><span class="ident" id="3934642">readHandshake</span><span class="op" id="3934655">(</span><span class="op" id="3934656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934659">if</span>&nbsp;<span class="ident" id="3934662">err</span>&nbsp;<span class="op" id="3934666">!=</span>&nbsp;<span class="ident" id="3934669">nil</span>&nbsp;<span class="op" id="3934673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934677">return</span>&nbsp;<span class="ident" id="3934684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934689">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934692">serverHello</span><span class="op" id="3934703">,</span>&nbsp;<span class="ident" id="3934705">ok</span>&nbsp;<span class="op" id="3934708">:=</span>&nbsp;<span class="ident" id="3934711">msg</span><span class="op" id="3934714">.</span><span class="op" id="3934715">(</span><span class="op" id="3934716">*</span><span class="ident" id="3934717">serverHelloMsg</span><span class="op" id="3934731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934734">if</span>&nbsp;<span class="op" id="3934737">!</span><span class="ident" id="3934738">ok</span>&nbsp;<span class="op" id="3934741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934745">c</span><span class="op" id="3934746">.</span><span class="ident" id="3934747">sendAlert</span><span class="op" id="3934756">(</span><span class="ident" id="3934757">alertUnexpectedMessage</span><span class="op" id="3934779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934783">return</span>&nbsp;<span class="ident" id="3934790">unexpectedMessageError</span><span class="op" id="3934812">(</span><span class="ident" id="3934813">serverHello</span><span class="op" id="3934824">,</span>&nbsp;<span class="ident" id="3934826">msg</span><span class="op" id="3934829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934832">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934836">vers</span><span class="op" id="3934840">,</span>&nbsp;<span class="ident" id="3934842">ok</span>&nbsp;<span class="op" id="3934845">:=</span>&nbsp;<span class="ident" id="3934848">c</span><span class="op" id="3934849">.</span><span class="ident" id="3934850">config</span><span class="op" id="3934856">.</span><span class="ident" id="3934857">mutualVersion</span><span class="op" id="3934870">(</span><span class="ident" id="3934871">serverHello</span><span class="op" id="3934882">.</span><span class="ident" id="3934883">vers</span><span class="op" id="3934887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934890">if</span>&nbsp;<span class="op" id="3934893">!</span><span class="ident" id="3934894">ok</span>&nbsp;<span class="op" id="3934897">||</span>&nbsp;<span class="ident" id="3934900">vers</span>&nbsp;<span class="op" id="3934905">&lt;</span>&nbsp;<span class="ident" id="3934907">VersionTLS10</span>&nbsp;<span class="op" id="3934920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3934924">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934983">c</span><span class="op" id="3934984">.</span><span class="ident" id="3934985">sendAlert</span><span class="op" id="3934994">(</span><span class="ident" id="3934995">alertProtocolVersion</span><span class="op" id="3935015">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935019">return</span>&nbsp;<span class="ident" id="3935026">fmt</span><span class="op" id="3935029">.</span><span class="ident" id="3935030">Errorf</span><span class="op" id="3935036">(</span><span class="string" id="3935037">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3935091">,</span>&nbsp;<span class="ident" id="3935093">serverHello</span><span class="op" id="3935104">.</span><span class="ident" id="3935105">vers</span><span class="op" id="3935109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935115">c</span><span class="op" id="3935116">.</span><span class="ident" id="3935117">vers</span>&nbsp;<span class="op" id="3935122">=</span>&nbsp;<span class="ident" id="3935124">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935130">c</span><span class="op" id="3935131">.</span><span class="ident" id="3935132">haveVers</span>&nbsp;<span class="op" id="3935141">=</span>&nbsp;<span class="ident" id="3935143">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935150">suite</span>&nbsp;<span class="op" id="3935156">:=</span>&nbsp;<span class="ident" id="3935159">mutualCipherSuite</span><span class="op" id="3935176">(</span><span class="ident" id="3935177">c</span><span class="op" id="3935178">.</span><span class="ident" id="3935179">config</span><span class="op" id="3935185">.</span><span class="ident" id="3935186">cipherSuites</span><span class="op" id="3935198">(</span><span class="op" id="3935199">)</span><span class="op" id="3935200">,</span>&nbsp;<span class="ident" id="3935202">serverHello</span><span class="op" id="3935213">.</span><span class="ident" id="3935214">cipherSuite</span><span class="op" id="3935225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935228">if</span>&nbsp;<span class="ident" id="3935231">suite</span>&nbsp;<span class="op" id="3935237">==</span>&nbsp;<span class="ident" id="3935240">nil</span>&nbsp;<span class="op" id="3935244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935248">c</span><span class="op" id="3935249">.</span><span class="ident" id="3935250">sendAlert</span><span class="op" id="3935259">(</span><span class="ident" id="3935260">alertHandshakeFailure</span><span class="op" id="3935281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935285">return</span>&nbsp;<span class="ident" id="3935292">fmt</span><span class="op" id="3935295">.</span><span class="ident" id="3935296">Errorf</span><span class="op" id="3935302">(</span><span class="string" id="3935303">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="3935353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935356">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935360">hs</span>&nbsp;<span class="op" id="3935363">:=</span>&nbsp;<span class="op" id="3935366">&amp;</span><span class="ident" id="3935367">clientHandshakeState</span><span class="op" id="3935387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935391">c</span><span class="op" id="3935392">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935405">c</span><span class="op" id="3935406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935410">serverHello</span><span class="op" id="3935421">:</span>&nbsp;&nbsp;<span class="ident" id="3935424">serverHello</span><span class="op" id="3935435">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935439">hello</span><span class="op" id="3935444">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935453">hello</span><span class="op" id="3935458">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935462">suite</span><span class="op" id="3935467">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935476">suite</span><span class="op" id="3935481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935485">finishedHash</span><span class="op" id="3935497">:</span>&nbsp;<span class="ident" id="3935499">newFinishedHash</span><span class="op" id="3935514">(</span><span class="ident" id="3935515">c</span><span class="op" id="3935516">.</span><span class="ident" id="3935517">vers</span><span class="op" id="3935521">)</span><span class="op" id="3935522">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935526">session</span><span class="op" id="3935533">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3935540">session</span><span class="op" id="3935547">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935554">hs</span><span class="op" id="3935556">.</span><span class="ident" id="3935557">finishedHash</span><span class="op" id="3935569">.</span><span class="ident" id="3935570">Write</span><span class="op" id="3935575">(</span><span class="ident" id="3935576">hs</span><span class="op" id="3935578">.</span><span class="ident" id="3935579">hello</span><span class="op" id="3935584">.</span><span class="ident" id="3935585">marshal</span><span class="op" id="3935592">(</span><span class="op" id="3935593">)</span><span class="op" id="3935594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935597">hs</span><span class="op" id="3935599">.</span><span class="ident" id="3935600">finishedHash</span><span class="op" id="3935612">.</span><span class="ident" id="3935613">Write</span><span class="op" id="3935618">(</span><span class="ident" id="3935619">hs</span><span class="op" id="3935621">.</span><span class="ident" id="3935622">serverHello</span><span class="op" id="3935633">.</span><span class="ident" id="3935634">marshal</span><span class="op" id="3935641">(</span><span class="op" id="3935642">)</span><span class="op" id="3935643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935647">isResume</span><span class="op" id="3935655">,</span>&nbsp;<span class="ident" id="3935657">err</span>&nbsp;<span class="op" id="3935661">:=</span>&nbsp;<span class="ident" id="3935664">hs</span><span class="op" id="3935666">.</span><span class="ident" id="3935667">processServerHello</span><span class="op" id="3935685">(</span><span class="op" id="3935686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935689">if</span>&nbsp;<span class="ident" id="3935692">err</span>&nbsp;<span class="op" id="3935696">!=</span>&nbsp;<span class="ident" id="3935699">nil</span>&nbsp;<span class="op" id="3935703">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935707">return</span>&nbsp;<span class="ident" id="3935714">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935723">if</span>&nbsp;<span class="ident" id="3935726">isResume</span>&nbsp;<span class="op" id="3935735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935739">if</span>&nbsp;<span class="ident" id="3935742">err</span>&nbsp;<span class="op" id="3935746">:=</span>&nbsp;<span class="ident" id="3935749">hs</span><span class="op" id="3935751">.</span><span class="ident" id="3935752">establishKeys</span><span class="op" id="3935765">(</span><span class="op" id="3935766">)</span><span class="op" id="3935767">;</span>&nbsp;<span class="ident" id="3935769">err</span>&nbsp;<span class="op" id="3935773">!=</span>&nbsp;<span class="ident" id="3935776">nil</span>&nbsp;<span class="op" id="3935780">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935785">return</span>&nbsp;<span class="ident" id="3935792">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935802">if</span>&nbsp;<span class="ident" id="3935805">err</span>&nbsp;<span class="op" id="3935809">:=</span>&nbsp;<span class="ident" id="3935812">hs</span><span class="op" id="3935814">.</span><span class="ident" id="3935815">readSessionTicket</span><span class="op" id="3935832">(</span><span class="op" id="3935833">)</span><span class="op" id="3935834">;</span>&nbsp;<span class="ident" id="3935836">err</span>&nbsp;<span class="op" id="3935840">!=</span>&nbsp;<span class="ident" id="3935843">nil</span>&nbsp;<span class="op" id="3935847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935852">return</span>&nbsp;<span class="ident" id="3935859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935865">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935869">if</span>&nbsp;<span class="ident" id="3935872">err</span>&nbsp;<span class="op" id="3935876">:=</span>&nbsp;<span class="ident" id="3935879">hs</span><span class="op" id="3935881">.</span><span class="ident" id="3935882">readFinished</span><span class="op" id="3935894">(</span><span class="ident" id="3935895">c</span><span class="op" id="3935896">.</span><span class="ident" id="3935897">firstFinished</span><span class="op" id="3935910">[</span><span class="op" id="3935911">:</span><span class="op" id="3935912">]</span><span class="op" id="3935913">)</span><span class="op" id="3935914">;</span>&nbsp;<span class="ident" id="3935916">err</span>&nbsp;<span class="op" id="3935920">!=</span>&nbsp;<span class="ident" id="3935923">nil</span>&nbsp;<span class="op" id="3935927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935932">return</span>&nbsp;<span class="ident" id="3935939">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935949">if</span>&nbsp;<span class="ident" id="3935952">err</span>&nbsp;<span class="op" id="3935956">:=</span>&nbsp;<span class="ident" id="3935959">hs</span><span class="op" id="3935961">.</span><span class="ident" id="3935962">sendFinished</span><span class="op" id="3935974">(</span><span class="ident" id="3935975">nil</span><span class="op" id="3935978">)</span><span class="op" id="3935979">;</span>&nbsp;<span class="ident" id="3935981">err</span>&nbsp;<span class="op" id="3935985">!=</span>&nbsp;<span class="ident" id="3935988">nil</span>&nbsp;<span class="op" id="3935992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935997">return</span>&nbsp;<span class="ident" id="3936004">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936013">}</span>&nbsp;<span class="keyword" id="3936015">else</span>&nbsp;<span class="op" id="3936020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936024">if</span>&nbsp;<span class="ident" id="3936027">err</span>&nbsp;<span class="op" id="3936031">:=</span>&nbsp;<span class="ident" id="3936034">hs</span><span class="op" id="3936036">.</span><span class="ident" id="3936037">doFullHandshake</span><span class="op" id="3936052">(</span><span class="op" id="3936053">)</span><span class="op" id="3936054">;</span>&nbsp;<span class="ident" id="3936056">err</span>&nbsp;<span class="op" id="3936060">!=</span>&nbsp;<span class="ident" id="3936063">nil</span>&nbsp;<span class="op" id="3936067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936072">return</span>&nbsp;<span class="ident" id="3936079">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936085">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936089">if</span>&nbsp;<span class="ident" id="3936092">err</span>&nbsp;<span class="op" id="3936096">:=</span>&nbsp;<span class="ident" id="3936099">hs</span><span class="op" id="3936101">.</span><span class="ident" id="3936102">establishKeys</span><span class="op" id="3936115">(</span><span class="op" id="3936116">)</span><span class="op" id="3936117">;</span>&nbsp;<span class="ident" id="3936119">err</span>&nbsp;<span class="op" id="3936123">!=</span>&nbsp;<span class="ident" id="3936126">nil</span>&nbsp;<span class="op" id="3936130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936135">return</span>&nbsp;<span class="ident" id="3936142">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936152">if</span>&nbsp;<span class="ident" id="3936155">err</span>&nbsp;<span class="op" id="3936159">:=</span>&nbsp;<span class="ident" id="3936162">hs</span><span class="op" id="3936164">.</span><span class="ident" id="3936165">sendFinished</span><span class="op" id="3936177">(</span><span class="ident" id="3936178">c</span><span class="op" id="3936179">.</span><span class="ident" id="3936180">firstFinished</span><span class="op" id="3936193">[</span><span class="op" id="3936194">:</span><span class="op" id="3936195">]</span><span class="op" id="3936196">)</span><span class="op" id="3936197">;</span>&nbsp;<span class="ident" id="3936199">err</span>&nbsp;<span class="op" id="3936203">!=</span>&nbsp;<span class="ident" id="3936206">nil</span>&nbsp;<span class="op" id="3936210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936215">return</span>&nbsp;<span class="ident" id="3936222">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936232">if</span>&nbsp;<span class="ident" id="3936235">err</span>&nbsp;<span class="op" id="3936239">:=</span>&nbsp;<span class="ident" id="3936242">hs</span><span class="op" id="3936244">.</span><span class="ident" id="3936245">readSessionTicket</span><span class="op" id="3936262">(</span><span class="op" id="3936263">)</span><span class="op" id="3936264">;</span>&nbsp;<span class="ident" id="3936266">err</span>&nbsp;<span class="op" id="3936270">!=</span>&nbsp;<span class="ident" id="3936273">nil</span>&nbsp;<span class="op" id="3936277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936282">return</span>&nbsp;<span class="ident" id="3936289">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936299">if</span>&nbsp;<span class="ident" id="3936302">err</span>&nbsp;<span class="op" id="3936306">:=</span>&nbsp;<span class="ident" id="3936309">hs</span><span class="op" id="3936311">.</span><span class="ident" id="3936312">readFinished</span><span class="op" id="3936324">(</span><span class="ident" id="3936325">nil</span><span class="op" id="3936328">)</span><span class="op" id="3936329">;</span>&nbsp;<span class="ident" id="3936331">err</span>&nbsp;<span class="op" id="3936335">!=</span>&nbsp;<span class="ident" id="3936338">nil</span>&nbsp;<span class="op" id="3936342">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936347">return</span>&nbsp;<span class="ident" id="3936354">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936367">if</span>&nbsp;<span class="ident" id="3936370">sessionCache</span>&nbsp;<span class="op" id="3936383">!=</span>&nbsp;<span class="ident" id="3936386">nil</span>&nbsp;<span class="op" id="3936390">&amp;&amp;</span>&nbsp;<span class="ident" id="3936393">hs</span><span class="op" id="3936395">.</span><span class="ident" id="3936396">session</span>&nbsp;<span class="op" id="3936404">!=</span>&nbsp;<span class="ident" id="3936407">nil</span>&nbsp;<span class="op" id="3936411">&amp;&amp;</span>&nbsp;<span class="ident" id="3936414">session</span>&nbsp;<span class="op" id="3936422">!=</span>&nbsp;<span class="ident" id="3936425">hs</span><span class="op" id="3936427">.</span><span class="ident" id="3936428">session</span>&nbsp;<span class="op" id="3936436">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936440">sessionCache</span><span class="op" id="3936452">.</span><span class="ident" id="3936453">Put</span><span class="op" id="3936456">(</span><span class="ident" id="3936457">cacheKey</span><span class="op" id="3936465">,</span>&nbsp;<span class="ident" id="3936467">hs</span><span class="op" id="3936469">.</span><span class="ident" id="3936470">session</span><span class="op" id="3936477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936484">c</span><span class="op" id="3936485">.</span><span class="ident" id="3936486">didResume</span>&nbsp;<span class="op" id="3936496">=</span>&nbsp;<span class="ident" id="3936498">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936508">c</span><span class="op" id="3936509">.</span><span class="ident" id="3936510">handshakeComplete</span>&nbsp;<span class="op" id="3936528">=</span>&nbsp;<span class="ident" id="3936530">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936536">c</span><span class="op" id="3936537">.</span><span class="ident" id="3936538">cipherSuite</span>&nbsp;<span class="op" id="3936550">=</span>&nbsp;<span class="ident" id="3936552">suite</span><span class="op" id="3936557">.</span><span class="ident" id="3936558">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936562">return</span>&nbsp;<span class="ident" id="3936569">nil</span><br>
<span class="lineno"></span><span class="op" id="3936573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3936576">func</span>&nbsp;<span class="op" id="3936581">(</span><span class="ident" id="3936582">hs</span>&nbsp;<span class="op" id="3936585">*</span><span class="ident" id="3936586">clientHandshakeState</span><span class="op" id="3936606">)</span>&nbsp;<span class="ident" id="3936608">doFullHandshake</span><span class="op" id="3936623">(</span><span class="op" id="3936624">)</span>&nbsp;<span class="builtintype" id="3936626">error</span>&nbsp;<span class="op" id="3936632">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936635">c</span>&nbsp;<span class="op" id="3936637">:=</span>&nbsp;<span class="ident" id="3936640">hs</span><span class="op" id="3936642">.</span><span class="ident" id="3936643">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936647">msg</span><span class="op" id="3936650">,</span>&nbsp;<span class="ident" id="3936652">err</span>&nbsp;<span class="op" id="3936656">:=</span>&nbsp;<span class="ident" id="3936659">c</span><span class="op" id="3936660">.</span><span class="ident" id="3936661">readHandshake</span><span class="op" id="3936674">(</span><span class="op" id="3936675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936678">if</span>&nbsp;<span class="ident" id="3936681">err</span>&nbsp;<span class="op" id="3936685">!=</span>&nbsp;<span class="ident" id="3936688">nil</span>&nbsp;<span class="op" id="3936692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936696">return</span>&nbsp;<span class="ident" id="3936703">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936711">certMsg</span><span class="op" id="3936718">,</span>&nbsp;<span class="ident" id="3936720">ok</span>&nbsp;<span class="op" id="3936723">:=</span>&nbsp;<span class="ident" id="3936726">msg</span><span class="op" id="3936729">.</span><span class="op" id="3936730">(</span><span class="op" id="3936731">*</span><span class="ident" id="3936732">certificateMsg</span><span class="op" id="3936746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936749">if</span>&nbsp;<span class="op" id="3936752">!</span><span class="ident" id="3936753">ok</span>&nbsp;<span class="op" id="3936756">||</span>&nbsp;<span class="builtinfunc" id="3936759">len</span><span class="op" id="3936762">(</span><span class="ident" id="3936763">certMsg</span><span class="op" id="3936770">.</span><span class="ident" id="3936771">certificates</span><span class="op" id="3936783">)</span>&nbsp;<span class="op" id="3936785">==</span>&nbsp;<span class="num" id="3936788">0</span>&nbsp;<span class="op" id="3936790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936794">c</span><span class="op" id="3936795">.</span><span class="ident" id="3936796">sendAlert</span><span class="op" id="3936805">(</span><span class="ident" id="3936806">alertUnexpectedMessage</span><span class="op" id="3936828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936832">return</span>&nbsp;<span class="ident" id="3936839">unexpectedMessageError</span><span class="op" id="3936861">(</span><span class="ident" id="3936862">certMsg</span><span class="op" id="3936869">,</span>&nbsp;<span class="ident" id="3936871">msg</span><span class="op" id="3936874">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936880">hs</span><span class="op" id="3936882">.</span><span class="ident" id="3936883">finishedHash</span><span class="op" id="3936895">.</span><span class="ident" id="3936896">Write</span><span class="op" id="3936901">(</span><span class="ident" id="3936902">certMsg</span><span class="op" id="3936909">.</span><span class="ident" id="3936910">marshal</span><span class="op" id="3936917">(</span><span class="op" id="3936918">)</span><span class="op" id="3936919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936923">certs</span>&nbsp;<span class="op" id="3936929">:=</span>&nbsp;<span class="builtinfunc" id="3936932">make</span><span class="op" id="3936936">(</span><span class="op" id="3936937">[</span><span class="op" id="3936938">]</span><span class="op" id="3936939">*</span><span class="ident" id="3936940">x509</span><span class="op" id="3936944">.</span><span class="ident" id="3936945">Certificate</span><span class="op" id="3936956">,</span>&nbsp;<span class="builtinfunc" id="3936958">len</span><span class="op" id="3936961">(</span><span class="ident" id="3936962">certMsg</span><span class="op" id="3936969">.</span><span class="ident" id="3936970">certificates</span><span class="op" id="3936982">)</span><span class="op" id="3936983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936986">for</span>&nbsp;<span class="ident" id="3936990">i</span><span class="op" id="3936991">,</span>&nbsp;<span class="ident" id="3936993">asn1Data</span>&nbsp;<span class="op" id="3937002">:=</span>&nbsp;<span class="keyword" id="3937005">range</span>&nbsp;<span class="ident" id="3937011">certMsg</span><span class="op" id="3937018">.</span><span class="ident" id="3937019">certificates</span>&nbsp;<span class="op" id="3937032">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937036">cert</span><span class="op" id="3937040">,</span>&nbsp;<span class="ident" id="3937042">err</span>&nbsp;<span class="op" id="3937046">:=</span>&nbsp;<span class="ident" id="3937049">x509</span><span class="op" id="3937053">.</span><span class="ident" id="3937054">ParseCertificate</span><span class="op" id="3937070">(</span><span class="ident" id="3937071">asn1Data</span><span class="op" id="3937079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937083">if</span>&nbsp;<span class="ident" id="3937086">err</span>&nbsp;<span class="op" id="3937090">!=</span>&nbsp;<span class="ident" id="3937093">nil</span>&nbsp;<span class="op" id="3937097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937102">c</span><span class="op" id="3937103">.</span><span class="ident" id="3937104">sendAlert</span><span class="op" id="3937113">(</span><span class="ident" id="3937114">alertBadCertificate</span><span class="op" id="3937133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937138">return</span>&nbsp;<span class="ident" id="3937145">errors</span><span class="op" id="3937151">.</span><span class="ident" id="3937152">New</span><span class="op" id="3937155">(</span><span class="string" id="3937156">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="3937205">+</span>&nbsp;<span class="ident" id="3937207">err</span><span class="op" id="3937210">.</span><span class="ident" id="3937211">Error</span><span class="op" id="3937216">(</span><span class="op" id="3937217">)</span><span class="op" id="3937218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937222">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937226">certs</span><span class="op" id="3937231">[</span><span class="ident" id="3937232">i</span><span class="op" id="3937233">]</span>&nbsp;<span class="op" id="3937235">=</span>&nbsp;<span class="ident" id="3937237">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937247">if</span>&nbsp;<span class="op" id="3937250">!</span><span class="ident" id="3937251">c</span><span class="op" id="3937252">.</span><span class="ident" id="3937253">config</span><span class="op" id="3937259">.</span><span class="ident" id="3937260">InsecureSkipVerify</span>&nbsp;<span class="op" id="3937279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937283">opts</span>&nbsp;<span class="op" id="3937288">:=</span>&nbsp;<span class="ident" id="3937291">x509</span><span class="op" id="3937295">.</span><span class="ident" id="3937296">VerifyOptions</span><span class="op" id="3937309">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937314">Roots</span><span class="op" id="3937319">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3937329">c</span><span class="op" id="3937330">.</span><span class="ident" id="3937331">config</span><span class="op" id="3937337">.</span><span class="ident" id="3937338">RootCAs</span><span class="op" id="3937345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937350">CurrentTime</span><span class="op" id="3937361">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3937365">c</span><span class="op" id="3937366">.</span><span class="ident" id="3937367">config</span><span class="op" id="3937373">.</span><span class="ident" id="3937374">time</span><span class="op" id="3937378">(</span><span class="op" id="3937379">)</span><span class="op" id="3937380">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937385">DNSName</span><span class="op" id="3937392">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3937400">c</span><span class="op" id="3937401">.</span><span class="ident" id="3937402">config</span><span class="op" id="3937408">.</span><span class="ident" id="3937409">ServerName</span><span class="op" id="3937419">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937424">Intermediates</span><span class="op" id="3937437">:</span>&nbsp;<span class="ident" id="3937439">x509</span><span class="op" id="3937443">.</span><span class="ident" id="3937444">NewCertPool</span><span class="op" id="3937455">(</span><span class="op" id="3937456">)</span><span class="op" id="3937457">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937461">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937466">for</span>&nbsp;<span class="ident" id="3937470">i</span><span class="op" id="3937471">,</span>&nbsp;<span class="ident" id="3937473">cert</span>&nbsp;<span class="op" id="3937478">:=</span>&nbsp;<span class="keyword" id="3937481">range</span>&nbsp;<span class="ident" id="3937487">certs</span>&nbsp;<span class="op" id="3937493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937498">if</span>&nbsp;<span class="ident" id="3937501">i</span>&nbsp;<span class="op" id="3937503">==</span>&nbsp;<span class="num" id="3937506">0</span>&nbsp;<span class="op" id="3937508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937514">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937526">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937531">opts</span><span class="op" id="3937535">.</span><span class="ident" id="3937536">Intermediates</span><span class="op" id="3937549">.</span><span class="ident" id="3937550">AddCert</span><span class="op" id="3937557">(</span><span class="ident" id="3937558">cert</span><span class="op" id="3937562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937570">c</span><span class="op" id="3937571">.</span><span class="ident" id="3937572">verifiedChains</span><span class="op" id="3937586">,</span>&nbsp;<span class="ident" id="3937588">err</span>&nbsp;<span class="op" id="3937592">=</span>&nbsp;<span class="ident" id="3937594">certs</span><span class="op" id="3937599">[</span><span class="num" id="3937600">0</span><span class="op" id="3937601">]</span><span class="op" id="3937602">.</span><span class="ident" id="3937603">Verify</span><span class="op" id="3937609">(</span><span class="ident" id="3937610">opts</span><span class="op" id="3937614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937618">if</span>&nbsp;<span class="ident" id="3937621">err</span>&nbsp;<span class="op" id="3937625">!=</span>&nbsp;<span class="ident" id="3937628">nil</span>&nbsp;<span class="op" id="3937632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937637">c</span><span class="op" id="3937638">.</span><span class="ident" id="3937639">sendAlert</span><span class="op" id="3937648">(</span><span class="ident" id="3937649">alertBadCertificate</span><span class="op" id="3937668">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937673">return</span>&nbsp;<span class="ident" id="3937680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937693">switch</span>&nbsp;<span class="ident" id="3937700">certs</span><span class="op" id="3937705">[</span><span class="num" id="3937706">0</span><span class="op" id="3937707">]</span><span class="op" id="3937708">.</span><span class="ident" id="3937709">PublicKey</span><span class="op" id="3937718">.</span><span class="op" id="3937719">(</span><span class="keyword" id="3937720">type</span><span class="op" id="3937724">)</span>&nbsp;<span class="op" id="3937726">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937729">case</span>&nbsp;<span class="op" id="3937734">*</span><span class="ident" id="3937735">rsa</span><span class="op" id="3937738">.</span><span class="ident" id="3937739">PublicKey</span><span class="op" id="3937748">,</span>&nbsp;<span class="op" id="3937750">*</span><span class="ident" id="3937751">ecdsa</span><span class="op" id="3937756">.</span><span class="ident" id="3937757">PublicKey</span><span class="op" id="3937766">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937770">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937777">default</span><span class="op" id="3937784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937788">c</span><span class="op" id="3937789">.</span><span class="ident" id="3937790">sendAlert</span><span class="op" id="3937799">(</span><span class="ident" id="3937800">alertUnsupportedCertificate</span><span class="op" id="3937827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937831">return</span>&nbsp;<span class="ident" id="3937838">fmt</span><span class="op" id="3937841">.</span><span class="ident" id="3937842">Errorf</span><span class="op" id="3937848">(</span><span class="string" id="3937849">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="3937923">,</span>&nbsp;<span class="ident" id="3937925">certs</span><span class="op" id="3937930">[</span><span class="num" id="3937931">0</span><span class="op" id="3937932">]</span><span class="op" id="3937933">.</span><span class="ident" id="3937934">PublicKey</span><span class="op" id="3937943">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937950">c</span><span class="op" id="3937951">.</span><span class="ident" id="3937952">peerCertificates</span>&nbsp;<span class="op" id="3937969">=</span>&nbsp;<span class="ident" id="3937971">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937979">if</span>&nbsp;<span class="ident" id="3937982">hs</span><span class="op" id="3937984">.</span><span class="ident" id="3937985">serverHello</span><span class="op" id="3937996">.</span><span class="ident" id="3937997">ocspStapling</span>&nbsp;<span class="op" id="3938010">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938014">msg</span><span class="op" id="3938017">,</span>&nbsp;<span class="ident" id="3938019">err</span>&nbsp;<span class="op" id="3938023">=</span>&nbsp;<span class="ident" id="3938025">c</span><span class="op" id="3938026">.</span><span class="ident" id="3938027">readHandshake</span><span class="op" id="3938040">(</span><span class="op" id="3938041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938045">if</span>&nbsp;<span class="ident" id="3938048">err</span>&nbsp;<span class="op" id="3938052">!=</span>&nbsp;<span class="ident" id="3938055">nil</span>&nbsp;<span class="op" id="3938059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938064">return</span>&nbsp;<span class="ident" id="3938071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938081">cs</span><span class="op" id="3938083">,</span>&nbsp;<span class="ident" id="3938085">ok</span>&nbsp;<span class="op" id="3938088">:=</span>&nbsp;<span class="ident" id="3938091">msg</span><span class="op" id="3938094">.</span><span class="op" id="3938095">(</span><span class="op" id="3938096">*</span><span class="ident" id="3938097">certificateStatusMsg</span><span class="op" id="3938117">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938121">if</span>&nbsp;<span class="op" id="3938124">!</span><span class="ident" id="3938125">ok</span>&nbsp;<span class="op" id="3938128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938133">c</span><span class="op" id="3938134">.</span><span class="ident" id="3938135">sendAlert</span><span class="op" id="3938144">(</span><span class="ident" id="3938145">alertUnexpectedMessage</span><span class="op" id="3938167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938172">return</span>&nbsp;<span class="ident" id="3938179">unexpectedMessageError</span><span class="op" id="3938201">(</span><span class="ident" id="3938202">cs</span><span class="op" id="3938204">,</span>&nbsp;<span class="ident" id="3938206">msg</span><span class="op" id="3938209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938217">hs</span><span class="op" id="3938219">.</span><span class="ident" id="3938220">finishedHash</span><span class="op" id="3938232">.</span><span class="ident" id="3938233">Write</span><span class="op" id="3938238">(</span><span class="ident" id="3938239">cs</span><span class="op" id="3938241">.</span><span class="ident" id="3938242">marshal</span><span class="op" id="3938249">(</span><span class="op" id="3938250">)</span><span class="op" id="3938251">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938256">if</span>&nbsp;<span class="ident" id="3938259">cs</span><span class="op" id="3938261">.</span><span class="ident" id="3938262">statusType</span>&nbsp;<span class="op" id="3938273">==</span>&nbsp;<span class="ident" id="3938276">statusTypeOCSP</span>&nbsp;<span class="op" id="3938291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938296">c</span><span class="op" id="3938297">.</span><span class="ident" id="3938298">ocspResponse</span>&nbsp;<span class="op" id="3938311">=</span>&nbsp;<span class="ident" id="3938313">cs</span><span class="op" id="3938315">.</span><span class="ident" id="3938316">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938330">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938334">msg</span><span class="op" id="3938337">,</span>&nbsp;<span class="ident" id="3938339">err</span>&nbsp;<span class="op" id="3938343">=</span>&nbsp;<span class="ident" id="3938345">c</span><span class="op" id="3938346">.</span><span class="ident" id="3938347">readHandshake</span><span class="op" id="3938360">(</span><span class="op" id="3938361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938364">if</span>&nbsp;<span class="ident" id="3938367">err</span>&nbsp;<span class="op" id="3938371">!=</span>&nbsp;<span class="ident" id="3938374">nil</span>&nbsp;<span class="op" id="3938378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938382">return</span>&nbsp;<span class="ident" id="3938389">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938394">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938398">keyAgreement</span>&nbsp;<span class="op" id="3938411">:=</span>&nbsp;<span class="ident" id="3938414">hs</span><span class="op" id="3938416">.</span><span class="ident" id="3938417">suite</span><span class="op" id="3938422">.</span><span class="ident" id="3938423">ka</span><span class="op" id="3938425">(</span><span class="ident" id="3938426">c</span><span class="op" id="3938427">.</span><span class="ident" id="3938428">vers</span><span class="op" id="3938432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938436">skx</span><span class="op" id="3938439">,</span>&nbsp;<span class="ident" id="3938441">ok</span>&nbsp;<span class="op" id="3938444">:=</span>&nbsp;<span class="ident" id="3938447">msg</span><span class="op" id="3938450">.</span><span class="op" id="3938451">(</span><span class="op" id="3938452">*</span><span class="ident" id="3938453">serverKeyExchangeMsg</span><span class="op" id="3938473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938476">if</span>&nbsp;<span class="ident" id="3938479">ok</span>&nbsp;<span class="op" id="3938482">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938486">hs</span><span class="op" id="3938488">.</span><span class="ident" id="3938489">finishedHash</span><span class="op" id="3938501">.</span><span class="ident" id="3938502">Write</span><span class="op" id="3938507">(</span><span class="ident" id="3938508">skx</span><span class="op" id="3938511">.</span><span class="ident" id="3938512">marshal</span><span class="op" id="3938519">(</span><span class="op" id="3938520">)</span><span class="op" id="3938521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938525">err</span>&nbsp;<span class="op" id="3938529">=</span>&nbsp;<span class="ident" id="3938531">keyAgreement</span><span class="op" id="3938543">.</span><span class="ident" id="3938544">processServerKeyExchange</span><span class="op" id="3938568">(</span><span class="ident" id="3938569">c</span><span class="op" id="3938570">.</span><span class="ident" id="3938571">config</span><span class="op" id="3938577">,</span>&nbsp;<span class="ident" id="3938579">hs</span><span class="op" id="3938581">.</span><span class="ident" id="3938582">hello</span><span class="op" id="3938587">,</span>&nbsp;<span class="ident" id="3938589">hs</span><span class="op" id="3938591">.</span><span class="ident" id="3938592">serverHello</span><span class="op" id="3938603">,</span>&nbsp;<span class="ident" id="3938605">certs</span><span class="op" id="3938610">[</span><span class="num" id="3938611">0</span><span class="op" id="3938612">]</span><span class="op" id="3938613">,</span>&nbsp;<span class="ident" id="3938615">skx</span><span class="op" id="3938618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938622">if</span>&nbsp;<span class="ident" id="3938625">err</span>&nbsp;<span class="op" id="3938629">!=</span>&nbsp;<span class="ident" id="3938632">nil</span>&nbsp;<span class="op" id="3938636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938641">c</span><span class="op" id="3938642">.</span><span class="ident" id="3938643">sendAlert</span><span class="op" id="3938652">(</span><span class="ident" id="3938653">alertUnexpectedMessage</span><span class="op" id="3938675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938680">return</span>&nbsp;<span class="ident" id="3938687">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938698">msg</span><span class="op" id="3938701">,</span>&nbsp;<span class="ident" id="3938703">err</span>&nbsp;<span class="op" id="3938707">=</span>&nbsp;<span class="ident" id="3938709">c</span><span class="op" id="3938710">.</span><span class="ident" id="3938711">readHandshake</span><span class="op" id="3938724">(</span><span class="op" id="3938725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938729">if</span>&nbsp;<span class="ident" id="3938732">err</span>&nbsp;<span class="op" id="3938736">!=</span>&nbsp;<span class="ident" id="3938739">nil</span>&nbsp;<span class="op" id="3938743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938748">return</span>&nbsp;<span class="ident" id="3938755">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938768">var</span>&nbsp;<span class="ident" id="3938772">chainToSend</span>&nbsp;<span class="op" id="3938784">*</span><span class="ident" id="3938785">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938798">var</span>&nbsp;<span class="ident" id="3938802">certRequested</span>&nbsp;<span class="builtintype" id="3938816">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938822">certReq</span><span class="op" id="3938829">,</span>&nbsp;<span class="ident" id="3938831">ok</span>&nbsp;<span class="op" id="3938834">:=</span>&nbsp;<span class="ident" id="3938837">msg</span><span class="op" id="3938840">.</span><span class="op" id="3938841">(</span><span class="op" id="3938842">*</span><span class="ident" id="3938843">certificateRequestMsg</span><span class="op" id="3938864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938867">if</span>&nbsp;<span class="ident" id="3938870">ok</span>&nbsp;<span class="op" id="3938873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938877">certRequested</span>&nbsp;<span class="op" id="3938891">=</span>&nbsp;<span class="ident" id="3938893">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3938901">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3938952">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939017">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939083">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939146">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939211">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939258">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939321">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939366">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939424">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939459">hs</span><span class="op" id="3939461">.</span><span class="ident" id="3939462">finishedHash</span><span class="op" id="3939474">.</span><span class="ident" id="3939475">Write</span><span class="op" id="3939480">(</span><span class="ident" id="3939481">certReq</span><span class="op" id="3939488">.</span><span class="ident" id="3939489">marshal</span><span class="op" id="3939496">(</span><span class="op" id="3939497">)</span><span class="op" id="3939498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939503">var</span>&nbsp;<span class="ident" id="3939507">rsaAvail</span><span class="op" id="3939515">,</span>&nbsp;<span class="ident" id="3939517">ecdsaAvail</span>&nbsp;<span class="builtintype" id="3939528">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939535">for</span>&nbsp;<span class="ident" id="3939539">_</span><span class="op" id="3939540">,</span>&nbsp;<span class="ident" id="3939542">certType</span>&nbsp;<span class="op" id="3939551">:=</span>&nbsp;<span class="keyword" id="3939554">range</span>&nbsp;<span class="ident" id="3939560">certReq</span><span class="op" id="3939567">.</span><span class="ident" id="3939568">certificateTypes</span>&nbsp;<span class="op" id="3939585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939590">switch</span>&nbsp;<span class="ident" id="3939597">certType</span>&nbsp;<span class="op" id="3939606">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939611">case</span>&nbsp;<span class="ident" id="3939616">certTypeRSASign</span><span class="op" id="3939631">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939637">rsaAvail</span>&nbsp;<span class="op" id="3939646">=</span>&nbsp;<span class="ident" id="3939648">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939656">case</span>&nbsp;<span class="ident" id="3939661">certTypeECDSASign</span><span class="op" id="3939678">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939684">ecdsaAvail</span>&nbsp;<span class="op" id="3939695">=</span>&nbsp;<span class="ident" id="3939697">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939705">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939714">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939770">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3939836">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3939884">findCert</span><span class="op" id="3939892">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939896">for</span>&nbsp;<span class="ident" id="3939900">i</span><span class="op" id="3939901">,</span>&nbsp;<span class="ident" id="3939903">chain</span>&nbsp;<span class="op" id="3939909">:=</span>&nbsp;<span class="keyword" id="3939912">range</span>&nbsp;<span class="ident" id="3939918">c</span><span class="op" id="3939919">.</span><span class="ident" id="3939920">config</span><span class="op" id="3939926">.</span><span class="ident" id="3939927">Certificates</span>&nbsp;<span class="op" id="3939940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939945">if</span>&nbsp;<span class="op" id="3939948">!</span><span class="ident" id="3939949">rsaAvail</span>&nbsp;<span class="op" id="3939958">&amp;&amp;</span>&nbsp;<span class="op" id="3939961">!</span><span class="ident" id="3939962">ecdsaAvail</span>&nbsp;<span class="op" id="3939973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939979">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3939991">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3939997">for</span>&nbsp;<span class="ident" id="3940001">j</span><span class="op" id="3940002">,</span>&nbsp;<span class="ident" id="3940004">cert</span>&nbsp;<span class="op" id="3940009">:=</span>&nbsp;<span class="keyword" id="3940012">range</span>&nbsp;<span class="ident" id="3940018">chain</span><span class="op" id="3940023">.</span><span class="ident" id="3940024">Certificate</span>&nbsp;<span class="op" id="3940036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940042">x509Cert</span>&nbsp;<span class="op" id="3940051">:=</span>&nbsp;<span class="ident" id="3940054">chain</span><span class="op" id="3940059">.</span><span class="ident" id="3940060">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3940069">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3940121">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940159">if</span>&nbsp;<span class="ident" id="3940162">j</span>&nbsp;<span class="op" id="3940164">!=</span>&nbsp;<span class="num" id="3940167">0</span>&nbsp;<span class="op" id="3940169">||</span>&nbsp;<span class="ident" id="3940172">x509Cert</span>&nbsp;<span class="op" id="3940181">==</span>&nbsp;<span class="ident" id="3940184">nil</span>&nbsp;<span class="op" id="3940188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940195">if</span>&nbsp;<span class="ident" id="3940198">x509Cert</span><span class="op" id="3940206">,</span>&nbsp;<span class="ident" id="3940208">err</span>&nbsp;<span class="op" id="3940212">=</span>&nbsp;<span class="ident" id="3940214">x509</span><span class="op" id="3940218">.</span><span class="ident" id="3940219">ParseCertificate</span><span class="op" id="3940235">(</span><span class="ident" id="3940236">cert</span><span class="op" id="3940240">)</span><span class="op" id="3940241">;</span>&nbsp;<span class="ident" id="3940243">err</span>&nbsp;<span class="op" id="3940247">!=</span>&nbsp;<span class="ident" id="3940250">nil</span>&nbsp;<span class="op" id="3940254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940262">c</span><span class="op" id="3940263">.</span><span class="ident" id="3940264">sendAlert</span><span class="op" id="3940273">(</span><span class="ident" id="3940274">alertInternalError</span><span class="op" id="3940292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940300">return</span>&nbsp;<span class="ident" id="3940307">errors</span><span class="op" id="3940313">.</span><span class="ident" id="3940314">New</span><span class="op" id="3940317">(</span><span class="string" id="3940318">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="3940362">+</span>&nbsp;<span class="ident" id="3940364">strconv</span><span class="op" id="3940371">.</span><span class="ident" id="3940372">Itoa</span><span class="op" id="3940376">(</span><span class="ident" id="3940377">i</span><span class="op" id="3940378">)</span>&nbsp;<span class="op" id="3940380">+</span>&nbsp;<span class="string" id="3940382">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3940387">+</span>&nbsp;<span class="ident" id="3940389">err</span><span class="op" id="3940392">.</span><span class="ident" id="3940393">Error</span><span class="op" id="3940398">(</span><span class="op" id="3940399">)</span><span class="op" id="3940400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940407">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940420">switch</span>&nbsp;<span class="op" id="3940427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940433">case</span>&nbsp;<span class="ident" id="3940438">rsaAvail</span>&nbsp;<span class="op" id="3940447">&amp;&amp;</span>&nbsp;<span class="ident" id="3940450">x509Cert</span><span class="op" id="3940458">.</span><span class="ident" id="3940459">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3940478">==</span>&nbsp;<span class="ident" id="3940481">x509</span><span class="op" id="3940485">.</span><span class="ident" id="3940486">RSA</span><span class="op" id="3940489">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940495">case</span>&nbsp;<span class="ident" id="3940500">ecdsaAvail</span>&nbsp;<span class="op" id="3940511">&amp;&amp;</span>&nbsp;<span class="ident" id="3940514">x509Cert</span><span class="op" id="3940522">.</span><span class="ident" id="3940523">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3940542">==</span>&nbsp;<span class="ident" id="3940545">x509</span><span class="op" id="3940549">.</span><span class="ident" id="3940550">ECDSA</span><span class="op" id="3940555">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940561">default</span><span class="op" id="3940568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940575">continue</span>&nbsp;<span class="ident" id="3940584">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940604">if</span>&nbsp;<span class="builtinfunc" id="3940607">len</span><span class="op" id="3940610">(</span><span class="ident" id="3940611">certReq</span><span class="op" id="3940618">.</span><span class="ident" id="3940619">certificateAuthorities</span><span class="op" id="3940641">)</span>&nbsp;<span class="op" id="3940643">==</span>&nbsp;<span class="num" id="3940646">0</span>&nbsp;<span class="op" id="3940648">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3940655">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3940708">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940754">chainToSend</span>&nbsp;<span class="op" id="3940766">=</span>&nbsp;<span class="op" id="3940768">&amp;</span><span class="ident" id="3940769">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940780">break</span>&nbsp;<span class="ident" id="3940786">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940799">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940806">for</span>&nbsp;<span class="ident" id="3940810">_</span><span class="op" id="3940811">,</span>&nbsp;<span class="ident" id="3940813">ca</span>&nbsp;<span class="op" id="3940816">:=</span>&nbsp;<span class="keyword" id="3940819">range</span>&nbsp;<span class="ident" id="3940825">certReq</span><span class="op" id="3940832">.</span><span class="ident" id="3940833">certificateAuthorities</span>&nbsp;<span class="op" id="3940856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940863">if</span>&nbsp;<span class="ident" id="3940866">bytes</span><span class="op" id="3940871">.</span><span class="ident" id="3940872">Equal</span><span class="op" id="3940877">(</span><span class="ident" id="3940878">x509Cert</span><span class="op" id="3940886">.</span><span class="ident" id="3940887">RawIssuer</span><span class="op" id="3940896">,</span>&nbsp;<span class="ident" id="3940898">ca</span><span class="op" id="3940900">)</span>&nbsp;<span class="op" id="3940902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940910">chainToSend</span>&nbsp;<span class="op" id="3940922">=</span>&nbsp;<span class="op" id="3940924">&amp;</span><span class="ident" id="3940925">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3940937">break</span>&nbsp;<span class="ident" id="3940943">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3940972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3940977">msg</span><span class="op" id="3940980">,</span>&nbsp;<span class="ident" id="3940982">err</span>&nbsp;<span class="op" id="3940986">=</span>&nbsp;<span class="ident" id="3940988">c</span><span class="op" id="3940989">.</span><span class="ident" id="3940990">readHandshake</span><span class="op" id="3941003">(</span><span class="op" id="3941004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941008">if</span>&nbsp;<span class="ident" id="3941011">err</span>&nbsp;<span class="op" id="3941015">!=</span>&nbsp;<span class="ident" id="3941018">nil</span>&nbsp;<span class="op" id="3941022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941027">return</span>&nbsp;<span class="ident" id="3941034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941043">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941047">shd</span><span class="op" id="3941050">,</span>&nbsp;<span class="ident" id="3941052">ok</span>&nbsp;<span class="op" id="3941055">:=</span>&nbsp;<span class="ident" id="3941058">msg</span><span class="op" id="3941061">.</span><span class="op" id="3941062">(</span><span class="op" id="3941063">*</span><span class="ident" id="3941064">serverHelloDoneMsg</span><span class="op" id="3941082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941085">if</span>&nbsp;<span class="op" id="3941088">!</span><span class="ident" id="3941089">ok</span>&nbsp;<span class="op" id="3941092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941096">c</span><span class="op" id="3941097">.</span><span class="ident" id="3941098">sendAlert</span><span class="op" id="3941107">(</span><span class="ident" id="3941108">alertUnexpectedMessage</span><span class="op" id="3941130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941134">return</span>&nbsp;<span class="ident" id="3941141">unexpectedMessageError</span><span class="op" id="3941163">(</span><span class="ident" id="3941164">shd</span><span class="op" id="3941167">,</span>&nbsp;<span class="ident" id="3941169">msg</span><span class="op" id="3941172">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941178">hs</span><span class="op" id="3941180">.</span><span class="ident" id="3941181">finishedHash</span><span class="op" id="3941193">.</span><span class="ident" id="3941194">Write</span><span class="op" id="3941199">(</span><span class="ident" id="3941200">shd</span><span class="op" id="3941203">.</span><span class="ident" id="3941204">marshal</span><span class="op" id="3941211">(</span><span class="op" id="3941212">)</span><span class="op" id="3941213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3941217">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3941282">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3941350">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941375">if</span>&nbsp;<span class="ident" id="3941378">certRequested</span>&nbsp;<span class="op" id="3941392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941396">certMsg</span>&nbsp;<span class="op" id="3941404">=</span>&nbsp;<span class="builtinfunc" id="3941406">new</span><span class="op" id="3941409">(</span><span class="ident" id="3941410">certificateMsg</span><span class="op" id="3941424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941428">if</span>&nbsp;<span class="ident" id="3941431">chainToSend</span>&nbsp;<span class="op" id="3941443">!=</span>&nbsp;<span class="ident" id="3941446">nil</span>&nbsp;<span class="op" id="3941450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941455">certMsg</span><span class="op" id="3941462">.</span><span class="ident" id="3941463">certificates</span>&nbsp;<span class="op" id="3941476">=</span>&nbsp;<span class="ident" id="3941478">chainToSend</span><span class="op" id="3941489">.</span><span class="ident" id="3941490">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941508">hs</span><span class="op" id="3941510">.</span><span class="ident" id="3941511">finishedHash</span><span class="op" id="3941523">.</span><span class="ident" id="3941524">Write</span><span class="op" id="3941529">(</span><span class="ident" id="3941530">certMsg</span><span class="op" id="3941537">.</span><span class="ident" id="3941538">marshal</span><span class="op" id="3941545">(</span><span class="op" id="3941546">)</span><span class="op" id="3941547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941551">c</span><span class="op" id="3941552">.</span><span class="ident" id="3941553">writeRecord</span><span class="op" id="3941564">(</span><span class="ident" id="3941565">recordTypeHandshake</span><span class="op" id="3941584">,</span>&nbsp;<span class="ident" id="3941586">certMsg</span><span class="op" id="3941593">.</span><span class="ident" id="3941594">marshal</span><span class="op" id="3941601">(</span><span class="op" id="3941602">)</span><span class="op" id="3941603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941610">preMasterSecret</span><span class="op" id="3941625">,</span>&nbsp;<span class="ident" id="3941627">ckx</span><span class="op" id="3941630">,</span>&nbsp;<span class="ident" id="3941632">err</span>&nbsp;<span class="op" id="3941636">:=</span>&nbsp;<span class="ident" id="3941639">keyAgreement</span><span class="op" id="3941651">.</span><span class="ident" id="3941652">generateClientKeyExchange</span><span class="op" id="3941677">(</span><span class="ident" id="3941678">c</span><span class="op" id="3941679">.</span><span class="ident" id="3941680">config</span><span class="op" id="3941686">,</span>&nbsp;<span class="ident" id="3941688">hs</span><span class="op" id="3941690">.</span><span class="ident" id="3941691">hello</span><span class="op" id="3941696">,</span>&nbsp;<span class="ident" id="3941698">certs</span><span class="op" id="3941703">[</span><span class="num" id="3941704">0</span><span class="op" id="3941705">]</span><span class="op" id="3941706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941709">if</span>&nbsp;<span class="ident" id="3941712">err</span>&nbsp;<span class="op" id="3941716">!=</span>&nbsp;<span class="ident" id="3941719">nil</span>&nbsp;<span class="op" id="3941723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941727">c</span><span class="op" id="3941728">.</span><span class="ident" id="3941729">sendAlert</span><span class="op" id="3941738">(</span><span class="ident" id="3941739">alertInternalError</span><span class="op" id="3941757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941761">return</span>&nbsp;<span class="ident" id="3941768">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941773">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941776">if</span>&nbsp;<span class="ident" id="3941779">ckx</span>&nbsp;<span class="op" id="3941783">!=</span>&nbsp;<span class="ident" id="3941786">nil</span>&nbsp;<span class="op" id="3941790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941794">hs</span><span class="op" id="3941796">.</span><span class="ident" id="3941797">finishedHash</span><span class="op" id="3941809">.</span><span class="ident" id="3941810">Write</span><span class="op" id="3941815">(</span><span class="ident" id="3941816">ckx</span><span class="op" id="3941819">.</span><span class="ident" id="3941820">marshal</span><span class="op" id="3941827">(</span><span class="op" id="3941828">)</span><span class="op" id="3941829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941833">c</span><span class="op" id="3941834">.</span><span class="ident" id="3941835">writeRecord</span><span class="op" id="3941846">(</span><span class="ident" id="3941847">recordTypeHandshake</span><span class="op" id="3941866">,</span>&nbsp;<span class="ident" id="3941868">ckx</span><span class="op" id="3941871">.</span><span class="ident" id="3941872">marshal</span><span class="op" id="3941879">(</span><span class="op" id="3941880">)</span><span class="op" id="3941881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3941884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941888">if</span>&nbsp;<span class="ident" id="3941891">chainToSend</span>&nbsp;<span class="op" id="3941903">!=</span>&nbsp;<span class="ident" id="3941906">nil</span>&nbsp;<span class="op" id="3941910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3941914">var</span>&nbsp;<span class="ident" id="3941918">signed</span>&nbsp;<span class="op" id="3941925">[</span><span class="op" id="3941926">]</span><span class="builtintype" id="3941927">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941934">certVerify</span>&nbsp;<span class="op" id="3941945">:=</span>&nbsp;<span class="op" id="3941948">&amp;</span><span class="ident" id="3941949">certificateVerifyMsg</span><span class="op" id="3941969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3941974">hasSignatureAndHash</span><span class="op" id="3941993">:</span>&nbsp;<span class="ident" id="3941995">c</span><span class="op" id="3941996">.</span><span class="ident" id="3941997">vers</span>&nbsp;<span class="op" id="3942002">&gt;=</span>&nbsp;<span class="ident" id="3942005">VersionTLS12</span><span class="op" id="3942017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3942021">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942026">key</span><span class="op" id="3942029">,</span>&nbsp;<span class="ident" id="3942031">ok</span>&nbsp;<span class="op" id="3942034">:=</span>&nbsp;<span class="ident" id="3942037">chainToSend</span><span class="op" id="3942048">.</span><span class="ident" id="3942049">PrivateKey</span><span class="op" id="3942059">.</span><span class="op" id="3942060">(</span><span class="ident" id="3942061">crypto</span><span class="op" id="3942067">.</span><span class="ident" id="3942068">Signer</span><span class="op" id="3942074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942078">if</span>&nbsp;<span class="op" id="3942081">!</span><span class="ident" id="3942082">ok</span>&nbsp;<span class="op" id="3942085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942090">c</span><span class="op" id="3942091">.</span><span class="ident" id="3942092">sendAlert</span><span class="op" id="3942101">(</span><span class="ident" id="3942102">alertInternalError</span><span class="op" id="3942120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942125">return</span>&nbsp;<span class="ident" id="3942132">fmt</span><span class="op" id="3942135">.</span><span class="ident" id="3942136">Errorf</span><span class="op" id="3942142">(</span><span class="string" id="3942143">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="3942224">,</span>&nbsp;<span class="ident" id="3942226">chainToSend</span><span class="op" id="3942237">.</span><span class="ident" id="3942238">PrivateKey</span><span class="op" id="3942248">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3942252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942256">switch</span>&nbsp;<span class="ident" id="3942263">key</span><span class="op" id="3942266">.</span><span class="ident" id="3942267">Public</span><span class="op" id="3942273">(</span><span class="op" id="3942274">)</span><span class="op" id="3942275">.</span><span class="op" id="3942276">(</span><span class="keyword" id="3942277">type</span><span class="op" id="3942281">)</span>&nbsp;<span class="op" id="3942283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942287">case</span>&nbsp;<span class="op" id="3942292">*</span><span class="ident" id="3942293">ecdsa</span><span class="op" id="3942298">.</span><span class="ident" id="3942299">PublicKey</span><span class="op" id="3942308">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942313">digest</span><span class="op" id="3942319">,</span>&nbsp;<span class="ident" id="3942321">hashFunc</span><span class="op" id="3942329">,</span>&nbsp;<span class="ident" id="3942331">hashId</span>&nbsp;<span class="op" id="3942338">:=</span>&nbsp;<span class="ident" id="3942341">hs</span><span class="op" id="3942343">.</span><span class="ident" id="3942344">finishedHash</span><span class="op" id="3942356">.</span><span class="ident" id="3942357">hashForClientCertificate</span><span class="op" id="3942381">(</span><span class="ident" id="3942382">signatureECDSA</span><span class="op" id="3942396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942401">signed</span><span class="op" id="3942407">,</span>&nbsp;<span class="ident" id="3942409">err</span>&nbsp;<span class="op" id="3942413">=</span>&nbsp;<span class="ident" id="3942415">key</span><span class="op" id="3942418">.</span><span class="ident" id="3942419">Sign</span><span class="op" id="3942423">(</span><span class="ident" id="3942424">c</span><span class="op" id="3942425">.</span><span class="ident" id="3942426">config</span><span class="op" id="3942432">.</span><span class="ident" id="3942433">rand</span><span class="op" id="3942437">(</span><span class="op" id="3942438">)</span><span class="op" id="3942439">,</span>&nbsp;<span class="ident" id="3942441">digest</span><span class="op" id="3942447">,</span>&nbsp;<span class="ident" id="3942449">hashFunc</span><span class="op" id="3942457">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942462">certVerify</span><span class="op" id="3942472">.</span><span class="ident" id="3942473">signatureAndHash</span><span class="op" id="3942489">.</span><span class="ident" id="3942490">signature</span>&nbsp;<span class="op" id="3942500">=</span>&nbsp;<span class="ident" id="3942502">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942520">certVerify</span><span class="op" id="3942530">.</span><span class="ident" id="3942531">signatureAndHash</span><span class="op" id="3942547">.</span><span class="ident" id="3942548">hash</span>&nbsp;<span class="op" id="3942553">=</span>&nbsp;<span class="ident" id="3942555">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942564">case</span>&nbsp;<span class="op" id="3942569">*</span><span class="ident" id="3942570">rsa</span><span class="op" id="3942573">.</span><span class="ident" id="3942574">PublicKey</span><span class="op" id="3942583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942588">digest</span><span class="op" id="3942594">,</span>&nbsp;<span class="ident" id="3942596">hashFunc</span><span class="op" id="3942604">,</span>&nbsp;<span class="ident" id="3942606">hashId</span>&nbsp;<span class="op" id="3942613">:=</span>&nbsp;<span class="ident" id="3942616">hs</span><span class="op" id="3942618">.</span><span class="ident" id="3942619">finishedHash</span><span class="op" id="3942631">.</span><span class="ident" id="3942632">hashForClientCertificate</span><span class="op" id="3942656">(</span><span class="ident" id="3942657">signatureRSA</span><span class="op" id="3942669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942674">signed</span><span class="op" id="3942680">,</span>&nbsp;<span class="ident" id="3942682">err</span>&nbsp;<span class="op" id="3942686">=</span>&nbsp;<span class="ident" id="3942688">key</span><span class="op" id="3942691">.</span><span class="ident" id="3942692">Sign</span><span class="op" id="3942696">(</span><span class="ident" id="3942697">c</span><span class="op" id="3942698">.</span><span class="ident" id="3942699">config</span><span class="op" id="3942705">.</span><span class="ident" id="3942706">rand</span><span class="op" id="3942710">(</span><span class="op" id="3942711">)</span><span class="op" id="3942712">,</span>&nbsp;<span class="ident" id="3942714">digest</span><span class="op" id="3942720">,</span>&nbsp;<span class="ident" id="3942722">hashFunc</span><span class="op" id="3942730">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942735">certVerify</span><span class="op" id="3942745">.</span><span class="ident" id="3942746">signatureAndHash</span><span class="op" id="3942762">.</span><span class="ident" id="3942763">signature</span>&nbsp;<span class="op" id="3942773">=</span>&nbsp;<span class="ident" id="3942775">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942791">certVerify</span><span class="op" id="3942801">.</span><span class="ident" id="3942802">signatureAndHash</span><span class="op" id="3942818">.</span><span class="ident" id="3942819">hash</span>&nbsp;<span class="op" id="3942824">=</span>&nbsp;<span class="ident" id="3942826">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942835">default</span><span class="op" id="3942842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942847">err</span>&nbsp;<span class="op" id="3942851">=</span>&nbsp;<span class="ident" id="3942853">fmt</span><span class="op" id="3942856">.</span><span class="ident" id="3942857">Errorf</span><span class="op" id="3942863">(</span><span class="string" id="3942864">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="3942910">,</span>&nbsp;<span class="ident" id="3942912">key</span><span class="op" id="3942915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3942919">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942923">if</span>&nbsp;<span class="ident" id="3942926">err</span>&nbsp;<span class="op" id="3942930">!=</span>&nbsp;<span class="ident" id="3942933">nil</span>&nbsp;<span class="op" id="3942937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3942942">c</span><span class="op" id="3942943">.</span><span class="ident" id="3942944">sendAlert</span><span class="op" id="3942953">(</span><span class="ident" id="3942954">alertInternalError</span><span class="op" id="3942972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3942977">return</span>&nbsp;<span class="ident" id="3942984">errors</span><span class="op" id="3942990">.</span><span class="ident" id="3942991">New</span><span class="op" id="3942994">(</span><span class="string" id="3942995">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3943053">+</span>&nbsp;<span class="ident" id="3943055">err</span><span class="op" id="3943058">.</span><span class="ident" id="3943059">Error</span><span class="op" id="3943064">(</span><span class="op" id="3943065">)</span><span class="op" id="3943066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943074">certVerify</span><span class="op" id="3943084">.</span><span class="ident" id="3943085">signature</span>&nbsp;<span class="op" id="3943095">=</span>&nbsp;<span class="ident" id="3943097">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943107">hs</span><span class="op" id="3943109">.</span><span class="ident" id="3943110">finishedHash</span><span class="op" id="3943122">.</span><span class="ident" id="3943123">Write</span><span class="op" id="3943128">(</span><span class="ident" id="3943129">certVerify</span><span class="op" id="3943139">.</span><span class="ident" id="3943140">marshal</span><span class="op" id="3943147">(</span><span class="op" id="3943148">)</span><span class="op" id="3943149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943153">c</span><span class="op" id="3943154">.</span><span class="ident" id="3943155">writeRecord</span><span class="op" id="3943166">(</span><span class="ident" id="3943167">recordTypeHandshake</span><span class="op" id="3943186">,</span>&nbsp;<span class="ident" id="3943188">certVerify</span><span class="op" id="3943198">.</span><span class="ident" id="3943199">marshal</span><span class="op" id="3943206">(</span><span class="op" id="3943207">)</span><span class="op" id="3943208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943215">hs</span><span class="op" id="3943217">.</span><span class="ident" id="3943218">masterSecret</span>&nbsp;<span class="op" id="3943231">=</span>&nbsp;<span class="ident" id="3943233">masterFromPreMasterSecret</span><span class="op" id="3943258">(</span><span class="ident" id="3943259">c</span><span class="op" id="3943260">.</span><span class="ident" id="3943261">vers</span><span class="op" id="3943265">,</span>&nbsp;<span class="ident" id="3943267">preMasterSecret</span><span class="op" id="3943282">,</span>&nbsp;<span class="ident" id="3943284">hs</span><span class="op" id="3943286">.</span><span class="ident" id="3943287">hello</span><span class="op" id="3943292">.</span><span class="ident" id="3943293">random</span><span class="op" id="3943299">,</span>&nbsp;<span class="ident" id="3943301">hs</span><span class="op" id="3943303">.</span><span class="ident" id="3943304">serverHello</span><span class="op" id="3943315">.</span><span class="ident" id="3943316">random</span><span class="op" id="3943322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943325">return</span>&nbsp;<span class="ident" id="3943332">nil</span><br>
<span class="lineno"></span><span class="op" id="3943336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3943339">func</span>&nbsp;<span class="op" id="3943344">(</span><span class="ident" id="3943345">hs</span>&nbsp;<span class="op" id="3943348">*</span><span class="ident" id="3943349">clientHandshakeState</span><span class="op" id="3943369">)</span>&nbsp;<span class="ident" id="3943371">establishKeys</span><span class="op" id="3943384">(</span><span class="op" id="3943385">)</span>&nbsp;<span class="builtintype" id="3943387">error</span>&nbsp;<span class="op" id="3943393">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943396">c</span>&nbsp;<span class="op" id="3943398">:=</span>&nbsp;<span class="ident" id="3943401">hs</span><span class="op" id="3943403">.</span><span class="ident" id="3943404">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943408">clientMAC</span><span class="op" id="3943417">,</span>&nbsp;<span class="ident" id="3943419">serverMAC</span><span class="op" id="3943428">,</span>&nbsp;<span class="ident" id="3943430">clientKey</span><span class="op" id="3943439">,</span>&nbsp;<span class="ident" id="3943441">serverKey</span><span class="op" id="3943450">,</span>&nbsp;<span class="ident" id="3943452">clientIV</span><span class="op" id="3943460">,</span>&nbsp;<span class="ident" id="3943462">serverIV</span>&nbsp;<span class="op" id="3943471">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943476">keysFromMasterSecret</span><span class="op" id="3943496">(</span><span class="ident" id="3943497">c</span><span class="op" id="3943498">.</span><span class="ident" id="3943499">vers</span><span class="op" id="3943503">,</span>&nbsp;<span class="ident" id="3943505">hs</span><span class="op" id="3943507">.</span><span class="ident" id="3943508">masterSecret</span><span class="op" id="3943520">,</span>&nbsp;<span class="ident" id="3943522">hs</span><span class="op" id="3943524">.</span><span class="ident" id="3943525">hello</span><span class="op" id="3943530">.</span><span class="ident" id="3943531">random</span><span class="op" id="3943537">,</span>&nbsp;<span class="ident" id="3943539">hs</span><span class="op" id="3943541">.</span><span class="ident" id="3943542">serverHello</span><span class="op" id="3943553">.</span><span class="ident" id="3943554">random</span><span class="op" id="3943560">,</span>&nbsp;<span class="ident" id="3943562">hs</span><span class="op" id="3943564">.</span><span class="ident" id="3943565">suite</span><span class="op" id="3943570">.</span><span class="ident" id="3943571">macLen</span><span class="op" id="3943577">,</span>&nbsp;<span class="ident" id="3943579">hs</span><span class="op" id="3943581">.</span><span class="ident" id="3943582">suite</span><span class="op" id="3943587">.</span><span class="ident" id="3943588">keyLen</span><span class="op" id="3943594">,</span>&nbsp;<span class="ident" id="3943596">hs</span><span class="op" id="3943598">.</span><span class="ident" id="3943599">suite</span><span class="op" id="3943604">.</span><span class="ident" id="3943605">ivLen</span><span class="op" id="3943610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943613">var</span>&nbsp;<span class="ident" id="3943617">clientCipher</span><span class="op" id="3943629">,</span>&nbsp;<span class="ident" id="3943631">serverCipher</span>&nbsp;<span class="keyword" id="3943644">interface</span><span class="op" id="3943653">{</span><span class="op" id="3943654">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943657">var</span>&nbsp;<span class="ident" id="3943661">clientHash</span><span class="op" id="3943671">,</span>&nbsp;<span class="ident" id="3943673">serverHash</span>&nbsp;<span class="ident" id="3943684">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3943697">if</span>&nbsp;<span class="ident" id="3943700">hs</span><span class="op" id="3943702">.</span><span class="ident" id="3943703">suite</span><span class="op" id="3943708">.</span><span class="ident" id="3943709">cipher</span>&nbsp;<span class="op" id="3943716">!=</span>&nbsp;<span class="ident" id="3943719">nil</span>&nbsp;<span class="op" id="3943723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943727">clientCipher</span>&nbsp;<span class="op" id="3943740">=</span>&nbsp;<span class="ident" id="3943742">hs</span><span class="op" id="3943744">.</span><span class="ident" id="3943745">suite</span><span class="op" id="3943750">.</span><span class="ident" id="3943751">cipher</span><span class="op" id="3943757">(</span><span class="ident" id="3943758">clientKey</span><span class="op" id="3943767">,</span>&nbsp;<span class="ident" id="3943769">clientIV</span><span class="op" id="3943777">,</span>&nbsp;<span class="ident" id="3943779">false</span>&nbsp;<span class="comment" id="3943785">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3943806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943810">clientHash</span>&nbsp;<span class="op" id="3943821">=</span>&nbsp;<span class="ident" id="3943823">hs</span><span class="op" id="3943825">.</span><span class="ident" id="3943826">suite</span><span class="op" id="3943831">.</span><span class="ident" id="3943832">mac</span><span class="op" id="3943835">(</span><span class="ident" id="3943836">c</span><span class="op" id="3943837">.</span><span class="ident" id="3943838">vers</span><span class="op" id="3943842">,</span>&nbsp;<span class="ident" id="3943844">clientMAC</span><span class="op" id="3943853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943857">serverCipher</span>&nbsp;<span class="op" id="3943870">=</span>&nbsp;<span class="ident" id="3943872">hs</span><span class="op" id="3943874">.</span><span class="ident" id="3943875">suite</span><span class="op" id="3943880">.</span><span class="ident" id="3943881">cipher</span><span class="op" id="3943887">(</span><span class="ident" id="3943888">serverKey</span><span class="op" id="3943897">,</span>&nbsp;<span class="ident" id="3943899">serverIV</span><span class="op" id="3943907">,</span>&nbsp;<span class="ident" id="3943909">true</span>&nbsp;<span class="comment" id="3943914">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3943931">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943935">serverHash</span>&nbsp;<span class="op" id="3943946">=</span>&nbsp;<span class="ident" id="3943948">hs</span><span class="op" id="3943950">.</span><span class="ident" id="3943951">suite</span><span class="op" id="3943956">.</span><span class="ident" id="3943957">mac</span><span class="op" id="3943960">(</span><span class="ident" id="3943961">c</span><span class="op" id="3943962">.</span><span class="ident" id="3943963">vers</span><span class="op" id="3943967">,</span>&nbsp;<span class="ident" id="3943969">serverMAC</span><span class="op" id="3943978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3943981">}</span>&nbsp;<span class="keyword" id="3943983">else</span>&nbsp;<span class="op" id="3943988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3943992">clientCipher</span>&nbsp;<span class="op" id="3944005">=</span>&nbsp;<span class="ident" id="3944007">hs</span><span class="op" id="3944009">.</span><span class="ident" id="3944010">suite</span><span class="op" id="3944015">.</span><span class="ident" id="3944016">aead</span><span class="op" id="3944020">(</span><span class="ident" id="3944021">clientKey</span><span class="op" id="3944030">,</span>&nbsp;<span class="ident" id="3944032">clientIV</span><span class="op" id="3944040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944044">serverCipher</span>&nbsp;<span class="op" id="3944057">=</span>&nbsp;<span class="ident" id="3944059">hs</span><span class="op" id="3944061">.</span><span class="ident" id="3944062">suite</span><span class="op" id="3944067">.</span><span class="ident" id="3944068">aead</span><span class="op" id="3944072">(</span><span class="ident" id="3944073">serverKey</span><span class="op" id="3944082">,</span>&nbsp;<span class="ident" id="3944084">serverIV</span><span class="op" id="3944092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944095">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944099">c</span><span class="op" id="3944100">.</span><span class="ident" id="3944101">in</span><span class="op" id="3944103">.</span><span class="ident" id="3944104">prepareCipherSpec</span><span class="op" id="3944121">(</span><span class="ident" id="3944122">c</span><span class="op" id="3944123">.</span><span class="ident" id="3944124">vers</span><span class="op" id="3944128">,</span>&nbsp;<span class="ident" id="3944130">serverCipher</span><span class="op" id="3944142">,</span>&nbsp;<span class="ident" id="3944144">serverHash</span><span class="op" id="3944154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944157">c</span><span class="op" id="3944158">.</span><span class="ident" id="3944159">out</span><span class="op" id="3944162">.</span><span class="ident" id="3944163">prepareCipherSpec</span><span class="op" id="3944180">(</span><span class="ident" id="3944181">c</span><span class="op" id="3944182">.</span><span class="ident" id="3944183">vers</span><span class="op" id="3944187">,</span>&nbsp;<span class="ident" id="3944189">clientCipher</span><span class="op" id="3944201">,</span>&nbsp;<span class="ident" id="3944203">clientHash</span><span class="op" id="3944213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944216">return</span>&nbsp;<span class="ident" id="3944223">nil</span><br>
<span class="lineno"></span><span class="op" id="3944227">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="3944230">func</span>&nbsp;<span class="op" id="3944235">(</span><span class="ident" id="3944236">hs</span>&nbsp;<span class="op" id="3944239">*</span><span class="ident" id="3944240">clientHandshakeState</span><span class="op" id="3944260">)</span>&nbsp;<span class="ident" id="3944262">serverResumedSession</span><span class="op" id="3944282">(</span><span class="op" id="3944283">)</span>&nbsp;<span class="builtintype" id="3944285">bool</span>&nbsp;<span class="op" id="3944290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3944293">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3944363">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944420">return</span>&nbsp;<span class="ident" id="3944427">hs</span><span class="op" id="3944429">.</span><span class="ident" id="3944430">session</span>&nbsp;<span class="op" id="3944438">!=</span>&nbsp;<span class="ident" id="3944441">nil</span>&nbsp;<span class="op" id="3944445">&amp;&amp;</span>&nbsp;<span class="ident" id="3944448">hs</span><span class="op" id="3944450">.</span><span class="ident" id="3944451">hello</span><span class="op" id="3944456">.</span><span class="ident" id="3944457">sessionId</span>&nbsp;<span class="op" id="3944467">!=</span>&nbsp;<span class="ident" id="3944470">nil</span>&nbsp;<span class="op" id="3944474">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944479">bytes</span><span class="op" id="3944484">.</span><span class="ident" id="3944485">Equal</span><span class="op" id="3944490">(</span><span class="ident" id="3944491">hs</span><span class="op" id="3944493">.</span><span class="ident" id="3944494">serverHello</span><span class="op" id="3944505">.</span><span class="ident" id="3944506">sessionId</span><span class="op" id="3944515">,</span>&nbsp;<span class="ident" id="3944517">hs</span><span class="op" id="3944519">.</span><span class="ident" id="3944520">hello</span><span class="op" id="3944525">.</span><span class="ident" id="3944526">sessionId</span><span class="op" id="3944535">)</span><br>
<span class="lineno"></span><span class="op" id="3944537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3944540">func</span>&nbsp;<span class="op" id="3944545">(</span><span class="ident" id="3944546">hs</span>&nbsp;<span class="op" id="3944549">*</span><span class="ident" id="3944550">clientHandshakeState</span><span class="op" id="3944570">)</span>&nbsp;<span class="ident" id="3944572">processServerHello</span><span class="op" id="3944590">(</span><span class="op" id="3944591">)</span>&nbsp;<span class="op" id="3944593">(</span><span class="builtintype" id="3944594">bool</span><span class="op" id="3944598">,</span>&nbsp;<span class="builtintype" id="3944600">error</span><span class="op" id="3944605">)</span>&nbsp;<span class="op" id="3944607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944610">c</span>&nbsp;<span class="op" id="3944612">:=</span>&nbsp;<span class="ident" id="3944615">hs</span><span class="op" id="3944617">.</span><span class="ident" id="3944618">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944622">if</span>&nbsp;<span class="ident" id="3944625">hs</span><span class="op" id="3944627">.</span><span class="ident" id="3944628">serverHello</span><span class="op" id="3944639">.</span><span class="ident" id="3944640">compressionMethod</span>&nbsp;<span class="op" id="3944658">!=</span>&nbsp;<span class="ident" id="3944661">compressionNone</span>&nbsp;<span class="op" id="3944677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944681">c</span><span class="op" id="3944682">.</span><span class="ident" id="3944683">sendAlert</span><span class="op" id="3944692">(</span><span class="ident" id="3944693">alertUnexpectedMessage</span><span class="op" id="3944715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944719">return</span>&nbsp;<span class="ident" id="3944726">false</span><span class="op" id="3944731">,</span>&nbsp;<span class="ident" id="3944733">errors</span><span class="op" id="3944739">.</span><span class="ident" id="3944740">New</span><span class="op" id="3944743">(</span><span class="string" id="3944744">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="3944797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3944800">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944804">clientDidNPN</span>&nbsp;<span class="op" id="3944817">:=</span>&nbsp;<span class="ident" id="3944820">hs</span><span class="op" id="3944822">.</span><span class="ident" id="3944823">hello</span><span class="op" id="3944828">.</span><span class="ident" id="3944829">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944843">clientDidALPN</span>&nbsp;<span class="op" id="3944857">:=</span>&nbsp;<span class="builtinfunc" id="3944860">len</span><span class="op" id="3944863">(</span><span class="ident" id="3944864">hs</span><span class="op" id="3944866">.</span><span class="ident" id="3944867">hello</span><span class="op" id="3944872">.</span><span class="ident" id="3944873">alpnProtocols</span><span class="op" id="3944886">)</span>&nbsp;<span class="op" id="3944888">&gt;</span>&nbsp;<span class="num" id="3944890">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944893">serverHasNPN</span>&nbsp;<span class="op" id="3944906">:=</span>&nbsp;<span class="ident" id="3944909">hs</span><span class="op" id="3944911">.</span><span class="ident" id="3944912">serverHello</span><span class="op" id="3944923">.</span><span class="ident" id="3944924">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3944938">serverHasALPN</span>&nbsp;<span class="op" id="3944952">:=</span>&nbsp;<span class="builtinfunc" id="3944955">len</span><span class="op" id="3944958">(</span><span class="ident" id="3944959">hs</span><span class="op" id="3944961">.</span><span class="ident" id="3944962">serverHello</span><span class="op" id="3944973">.</span><span class="ident" id="3944974">alpnProtocol</span><span class="op" id="3944986">)</span>&nbsp;<span class="op" id="3944988">&gt;</span>&nbsp;<span class="num" id="3944990">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3944994">if</span>&nbsp;<span class="op" id="3944997">!</span><span class="ident" id="3944998">clientDidNPN</span>&nbsp;<span class="op" id="3945011">&amp;&amp;</span>&nbsp;<span class="ident" id="3945014">serverHasNPN</span>&nbsp;<span class="op" id="3945027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945031">c</span><span class="op" id="3945032">.</span><span class="ident" id="3945033">sendAlert</span><span class="op" id="3945042">(</span><span class="ident" id="3945043">alertHandshakeFailure</span><span class="op" id="3945064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945068">return</span>&nbsp;<span class="ident" id="3945075">false</span><span class="op" id="3945080">,</span>&nbsp;<span class="ident" id="3945082">errors</span><span class="op" id="3945088">.</span><span class="ident" id="3945089">New</span><span class="op" id="3945092">(</span><span class="string" id="3945093">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="3945138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945141">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945145">if</span>&nbsp;<span class="op" id="3945148">!</span><span class="ident" id="3945149">clientDidALPN</span>&nbsp;<span class="op" id="3945163">&amp;&amp;</span>&nbsp;<span class="ident" id="3945166">serverHasALPN</span>&nbsp;<span class="op" id="3945180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945184">c</span><span class="op" id="3945185">.</span><span class="ident" id="3945186">sendAlert</span><span class="op" id="3945195">(</span><span class="ident" id="3945196">alertHandshakeFailure</span><span class="op" id="3945217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945221">return</span>&nbsp;<span class="ident" id="3945228">false</span><span class="op" id="3945233">,</span>&nbsp;<span class="ident" id="3945235">errors</span><span class="op" id="3945241">.</span><span class="ident" id="3945242">New</span><span class="op" id="3945245">(</span><span class="string" id="3945246">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="3945292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945295">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945299">if</span>&nbsp;<span class="ident" id="3945302">serverHasNPN</span>&nbsp;<span class="op" id="3945315">&amp;&amp;</span>&nbsp;<span class="ident" id="3945318">serverHasALPN</span>&nbsp;<span class="op" id="3945332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945336">c</span><span class="op" id="3945337">.</span><span class="ident" id="3945338">sendAlert</span><span class="op" id="3945347">(</span><span class="ident" id="3945348">alertHandshakeFailure</span><span class="op" id="3945369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945373">return</span>&nbsp;<span class="ident" id="3945380">false</span><span class="op" id="3945385">,</span>&nbsp;<span class="ident" id="3945387">errors</span><span class="op" id="3945393">.</span><span class="ident" id="3945394">New</span><span class="op" id="3945397">(</span><span class="string" id="3945398">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="3945446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945449">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945453">if</span>&nbsp;<span class="ident" id="3945456">serverHasALPN</span>&nbsp;<span class="op" id="3945470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945474">c</span><span class="op" id="3945475">.</span><span class="ident" id="3945476">clientProtocol</span>&nbsp;<span class="op" id="3945491">=</span>&nbsp;<span class="ident" id="3945493">hs</span><span class="op" id="3945495">.</span><span class="ident" id="3945496">serverHello</span><span class="op" id="3945507">.</span><span class="ident" id="3945508">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945523">c</span><span class="op" id="3945524">.</span><span class="ident" id="3945525">clientProtocolFallback</span>&nbsp;<span class="op" id="3945548">=</span>&nbsp;<span class="ident" id="3945550">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945557">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945561">if</span>&nbsp;<span class="ident" id="3945564">hs</span><span class="op" id="3945566">.</span><span class="ident" id="3945567">serverResumedSession</span><span class="op" id="3945587">(</span><span class="op" id="3945588">)</span>&nbsp;<span class="op" id="3945590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3945594">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945654">hs</span><span class="op" id="3945656">.</span><span class="ident" id="3945657">masterSecret</span>&nbsp;<span class="op" id="3945670">=</span>&nbsp;<span class="ident" id="3945672">hs</span><span class="op" id="3945674">.</span><span class="ident" id="3945675">session</span><span class="op" id="3945682">.</span><span class="ident" id="3945683">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945698">c</span><span class="op" id="3945699">.</span><span class="ident" id="3945700">peerCertificates</span>&nbsp;<span class="op" id="3945717">=</span>&nbsp;<span class="ident" id="3945719">hs</span><span class="op" id="3945721">.</span><span class="ident" id="3945722">session</span><span class="op" id="3945729">.</span><span class="ident" id="3945730">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945751">return</span>&nbsp;<span class="ident" id="3945758">true</span><span class="op" id="3945762">,</span>&nbsp;<span class="ident" id="3945764">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945772">return</span>&nbsp;<span class="ident" id="3945779">false</span><span class="op" id="3945784">,</span>&nbsp;<span class="ident" id="3945786">nil</span><br>
<span class="lineno"></span><span class="op" id="3945790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="3945793">func</span>&nbsp;<span class="op" id="3945798">(</span><span class="ident" id="3945799">hs</span>&nbsp;<span class="op" id="3945802">*</span><span class="ident" id="3945803">clientHandshakeState</span><span class="op" id="3945823">)</span>&nbsp;<span class="ident" id="3945825">readFinished</span><span class="op" id="3945837">(</span><span class="ident" id="3945838">out</span>&nbsp;<span class="op" id="3945842">[</span><span class="op" id="3945843">]</span><span class="builtintype" id="3945844">byte</span><span class="op" id="3945848">)</span>&nbsp;<span class="builtintype" id="3945850">error</span>&nbsp;<span class="op" id="3945856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945859">c</span>&nbsp;<span class="op" id="3945861">:=</span>&nbsp;<span class="ident" id="3945864">hs</span><span class="op" id="3945866">.</span><span class="ident" id="3945867">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945871">c</span><span class="op" id="3945872">.</span><span class="ident" id="3945873">readRecord</span><span class="op" id="3945883">(</span><span class="ident" id="3945884">recordTypeChangeCipherSpec</span><span class="op" id="3945910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945913">if</span>&nbsp;<span class="ident" id="3945916">err</span>&nbsp;<span class="op" id="3945920">:=</span>&nbsp;<span class="ident" id="3945923">c</span><span class="op" id="3945924">.</span><span class="ident" id="3945925">in</span><span class="op" id="3945927">.</span><span class="builtintype" id="3945928">error</span><span class="op" id="3945933">(</span><span class="op" id="3945934">)</span><span class="op" id="3945935">;</span>&nbsp;<span class="ident" id="3945937">err</span>&nbsp;<span class="op" id="3945941">!=</span>&nbsp;<span class="ident" id="3945944">nil</span>&nbsp;<span class="op" id="3945948">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945952">return</span>&nbsp;<span class="ident" id="3945959">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3945964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3945968">msg</span><span class="op" id="3945971">,</span>&nbsp;<span class="ident" id="3945973">err</span>&nbsp;<span class="op" id="3945977">:=</span>&nbsp;<span class="ident" id="3945980">c</span><span class="op" id="3945981">.</span><span class="ident" id="3945982">readHandshake</span><span class="op" id="3945995">(</span><span class="op" id="3945996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3945999">if</span>&nbsp;<span class="ident" id="3946002">err</span>&nbsp;<span class="op" id="3946006">!=</span>&nbsp;<span class="ident" id="3946009">nil</span>&nbsp;<span class="op" id="3946013">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946017">return</span>&nbsp;<span class="ident" id="3946024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946032">serverFinished</span><span class="op" id="3946046">,</span>&nbsp;<span class="ident" id="3946048">ok</span>&nbsp;<span class="op" id="3946051">:=</span>&nbsp;<span class="ident" id="3946054">msg</span><span class="op" id="3946057">.</span><span class="op" id="3946058">(</span><span class="op" id="3946059">*</span><span class="ident" id="3946060">finishedMsg</span><span class="op" id="3946071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946074">if</span>&nbsp;<span class="op" id="3946077">!</span><span class="ident" id="3946078">ok</span>&nbsp;<span class="op" id="3946081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946085">c</span><span class="op" id="3946086">.</span><span class="ident" id="3946087">sendAlert</span><span class="op" id="3946096">(</span><span class="ident" id="3946097">alertUnexpectedMessage</span><span class="op" id="3946119">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946123">return</span>&nbsp;<span class="ident" id="3946130">unexpectedMessageError</span><span class="op" id="3946152">(</span><span class="ident" id="3946153">serverFinished</span><span class="op" id="3946167">,</span>&nbsp;<span class="ident" id="3946169">msg</span><span class="op" id="3946172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946179">verify</span>&nbsp;<span class="op" id="3946186">:=</span>&nbsp;<span class="ident" id="3946189">hs</span><span class="op" id="3946191">.</span><span class="ident" id="3946192">finishedHash</span><span class="op" id="3946204">.</span><span class="ident" id="3946205">serverSum</span><span class="op" id="3946214">(</span><span class="ident" id="3946215">hs</span><span class="op" id="3946217">.</span><span class="ident" id="3946218">masterSecret</span><span class="op" id="3946230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946233">if</span>&nbsp;<span class="builtinfunc" id="3946236">len</span><span class="op" id="3946239">(</span><span class="ident" id="3946240">verify</span><span class="op" id="3946246">)</span>&nbsp;<span class="op" id="3946248">!=</span>&nbsp;<span class="builtinfunc" id="3946251">len</span><span class="op" id="3946254">(</span><span class="ident" id="3946255">serverFinished</span><span class="op" id="3946269">.</span><span class="ident" id="3946270">verifyData</span><span class="op" id="3946280">)</span>&nbsp;<span class="op" id="3946282">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946287">subtle</span><span class="op" id="3946293">.</span><span class="ident" id="3946294">ConstantTimeCompare</span><span class="op" id="3946313">(</span><span class="ident" id="3946314">verify</span><span class="op" id="3946320">,</span>&nbsp;<span class="ident" id="3946322">serverFinished</span><span class="op" id="3946336">.</span><span class="ident" id="3946337">verifyData</span><span class="op" id="3946347">)</span>&nbsp;<span class="op" id="3946349">!=</span>&nbsp;<span class="num" id="3946352">1</span>&nbsp;<span class="op" id="3946354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946358">c</span><span class="op" id="3946359">.</span><span class="ident" id="3946360">sendAlert</span><span class="op" id="3946369">(</span><span class="ident" id="3946370">alertHandshakeFailure</span><span class="op" id="3946391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946395">return</span>&nbsp;<span class="ident" id="3946402">errors</span><span class="op" id="3946408">.</span><span class="ident" id="3946409">New</span><span class="op" id="3946412">(</span><span class="string" id="3946413">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="3946459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946465">hs</span><span class="op" id="3946467">.</span><span class="ident" id="3946468">finishedHash</span><span class="op" id="3946480">.</span><span class="ident" id="3946481">Write</span><span class="op" id="3946486">(</span><span class="ident" id="3946487">serverFinished</span><span class="op" id="3946501">.</span><span class="ident" id="3946502">marshal</span><span class="op" id="3946509">(</span><span class="op" id="3946510">)</span><span class="op" id="3946511">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3946514">copy</span><span class="op" id="3946518">(</span><span class="ident" id="3946519">out</span><span class="op" id="3946522">,</span>&nbsp;<span class="ident" id="3946524">verify</span><span class="op" id="3946530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946533">return</span>&nbsp;<span class="ident" id="3946540">nil</span><br>
<span class="lineno"></span><span class="op" id="3946544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3946547">func</span>&nbsp;<span class="op" id="3946552">(</span><span class="ident" id="3946553">hs</span>&nbsp;<span class="op" id="3946556">*</span><span class="ident" id="3946557">clientHandshakeState</span><span class="op" id="3946577">)</span>&nbsp;<span class="ident" id="3946579">readSessionTicket</span><span class="op" id="3946596">(</span><span class="op" id="3946597">)</span>&nbsp;<span class="builtintype" id="3946599">error</span>&nbsp;<span class="op" id="3946605">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946608">if</span>&nbsp;<span class="op" id="3946611">!</span><span class="ident" id="3946612">hs</span><span class="op" id="3946614">.</span><span class="ident" id="3946615">serverHello</span><span class="op" id="3946626">.</span><span class="ident" id="3946627">ticketSupported</span>&nbsp;<span class="op" id="3946643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946647">return</span>&nbsp;<span class="ident" id="3946654">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946663">c</span>&nbsp;<span class="op" id="3946665">:=</span>&nbsp;<span class="ident" id="3946668">hs</span><span class="op" id="3946670">.</span><span class="ident" id="3946671">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946674">msg</span><span class="op" id="3946677">,</span>&nbsp;<span class="ident" id="3946679">err</span>&nbsp;<span class="op" id="3946683">:=</span>&nbsp;<span class="ident" id="3946686">c</span><span class="op" id="3946687">.</span><span class="ident" id="3946688">readHandshake</span><span class="op" id="3946701">(</span><span class="op" id="3946702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946705">if</span>&nbsp;<span class="ident" id="3946708">err</span>&nbsp;<span class="op" id="3946712">!=</span>&nbsp;<span class="ident" id="3946715">nil</span>&nbsp;<span class="op" id="3946719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946723">return</span>&nbsp;<span class="ident" id="3946730">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946738">sessionTicketMsg</span><span class="op" id="3946754">,</span>&nbsp;<span class="ident" id="3946756">ok</span>&nbsp;<span class="op" id="3946759">:=</span>&nbsp;<span class="ident" id="3946762">msg</span><span class="op" id="3946765">.</span><span class="op" id="3946766">(</span><span class="op" id="3946767">*</span><span class="ident" id="3946768">newSessionTicketMsg</span><span class="op" id="3946787">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946790">if</span>&nbsp;<span class="op" id="3946793">!</span><span class="ident" id="3946794">ok</span>&nbsp;<span class="op" id="3946797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946801">c</span><span class="op" id="3946802">.</span><span class="ident" id="3946803">sendAlert</span><span class="op" id="3946812">(</span><span class="ident" id="3946813">alertUnexpectedMessage</span><span class="op" id="3946835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3946839">return</span>&nbsp;<span class="ident" id="3946846">unexpectedMessageError</span><span class="op" id="3946868">(</span><span class="ident" id="3946869">sessionTicketMsg</span><span class="op" id="3946885">,</span>&nbsp;<span class="ident" id="3946887">msg</span><span class="op" id="3946890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3946893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946896">hs</span><span class="op" id="3946898">.</span><span class="ident" id="3946899">finishedHash</span><span class="op" id="3946911">.</span><span class="ident" id="3946912">Write</span><span class="op" id="3946917">(</span><span class="ident" id="3946918">sessionTicketMsg</span><span class="op" id="3946934">.</span><span class="ident" id="3946935">marshal</span><span class="op" id="3946942">(</span><span class="op" id="3946943">)</span><span class="op" id="3946944">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946948">hs</span><span class="op" id="3946950">.</span><span class="ident" id="3946951">session</span>&nbsp;<span class="op" id="3946959">=</span>&nbsp;<span class="op" id="3946961">&amp;</span><span class="ident" id="3946962">ClientSessionState</span><span class="op" id="3946980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3946984">sessionTicket</span><span class="op" id="3946997">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3947004">sessionTicketMsg</span><span class="op" id="3947020">.</span><span class="ident" id="3947021">ticket</span><span class="op" id="3947027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947031">vers</span><span class="op" id="3947035">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3947051">c</span><span class="op" id="3947052">.</span><span class="ident" id="3947053">vers</span><span class="op" id="3947057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947061">cipherSuite</span><span class="op" id="3947072">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3947081">hs</span><span class="op" id="3947083">.</span><span class="ident" id="3947084">suite</span><span class="op" id="3947089">.</span><span class="ident" id="3947090">id</span><span class="op" id="3947092">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947096">masterSecret</span><span class="op" id="3947108">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3947116">hs</span><span class="op" id="3947118">.</span><span class="ident" id="3947119">masterSecret</span><span class="op" id="3947131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947135">serverCertificates</span><span class="op" id="3947153">:</span>&nbsp;<span class="ident" id="3947155">c</span><span class="op" id="3947156">.</span><span class="ident" id="3947157">peerCertificates</span><span class="op" id="3947173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3947176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947180">return</span>&nbsp;<span class="ident" id="3947187">nil</span><br>
<span class="lineno">590</span><span class="op" id="3947191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3947194">func</span>&nbsp;<span class="op" id="3947199">(</span><span class="ident" id="3947200">hs</span>&nbsp;<span class="op" id="3947203">*</span><span class="ident" id="3947204">clientHandshakeState</span><span class="op" id="3947224">)</span>&nbsp;<span class="ident" id="3947226">sendFinished</span><span class="op" id="3947238">(</span><span class="ident" id="3947239">out</span>&nbsp;<span class="op" id="3947243">[</span><span class="op" id="3947244">]</span><span class="builtintype" id="3947245">byte</span><span class="op" id="3947249">)</span>&nbsp;<span class="builtintype" id="3947251">error</span>&nbsp;<span class="op" id="3947257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947260">c</span>&nbsp;<span class="op" id="3947262">:=</span>&nbsp;<span class="ident" id="3947265">hs</span><span class="op" id="3947267">.</span><span class="ident" id="3947268">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947272">c</span><span class="op" id="3947273">.</span><span class="ident" id="3947274">writeRecord</span><span class="op" id="3947285">(</span><span class="ident" id="3947286">recordTypeChangeCipherSpec</span><span class="op" id="3947312">,</span>&nbsp;<span class="op" id="3947314">[</span><span class="op" id="3947315">]</span><span class="builtintype" id="3947316">byte</span><span class="op" id="3947320">{</span><span class="num" id="3947321">1</span><span class="op" id="3947322">}</span><span class="op" id="3947323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947326">if</span>&nbsp;<span class="ident" id="3947329">hs</span><span class="op" id="3947331">.</span><span class="ident" id="3947332">serverHello</span><span class="op" id="3947343">.</span><span class="ident" id="3947344">nextProtoNeg</span>&nbsp;<span class="op" id="3947357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947361">nextProto</span>&nbsp;<span class="op" id="3947371">:=</span>&nbsp;<span class="builtinfunc" id="3947374">new</span><span class="op" id="3947377">(</span><span class="ident" id="3947378">nextProtoMsg</span><span class="op" id="3947390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947394">proto</span><span class="op" id="3947399">,</span>&nbsp;<span class="ident" id="3947401">fallback</span>&nbsp;<span class="op" id="3947410">:=</span>&nbsp;<span class="ident" id="3947413">mutualProtocol</span><span class="op" id="3947427">(</span><span class="ident" id="3947428">c</span><span class="op" id="3947429">.</span><span class="ident" id="3947430">config</span><span class="op" id="3947436">.</span><span class="ident" id="3947437">NextProtos</span><span class="op" id="3947447">,</span>&nbsp;<span class="ident" id="3947449">hs</span><span class="op" id="3947451">.</span><span class="ident" id="3947452">serverHello</span><span class="op" id="3947463">.</span><span class="ident" id="3947464">nextProtos</span><span class="op" id="3947474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947478">nextProto</span><span class="op" id="3947487">.</span><span class="ident" id="3947488">proto</span>&nbsp;<span class="op" id="3947494">=</span>&nbsp;<span class="ident" id="3947496">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947504">c</span><span class="op" id="3947505">.</span><span class="ident" id="3947506">clientProtocol</span>&nbsp;<span class="op" id="3947521">=</span>&nbsp;<span class="ident" id="3947523">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947531">c</span><span class="op" id="3947532">.</span><span class="ident" id="3947533">clientProtocolFallback</span>&nbsp;<span class="op" id="3947556">=</span>&nbsp;<span class="ident" id="3947558">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947570">hs</span><span class="op" id="3947572">.</span><span class="ident" id="3947573">finishedHash</span><span class="op" id="3947585">.</span><span class="ident" id="3947586">Write</span><span class="op" id="3947591">(</span><span class="ident" id="3947592">nextProto</span><span class="op" id="3947601">.</span><span class="ident" id="3947602">marshal</span><span class="op" id="3947609">(</span><span class="op" id="3947610">)</span><span class="op" id="3947611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947615">c</span><span class="op" id="3947616">.</span><span class="ident" id="3947617">writeRecord</span><span class="op" id="3947628">(</span><span class="ident" id="3947629">recordTypeHandshake</span><span class="op" id="3947648">,</span>&nbsp;<span class="ident" id="3947650">nextProto</span><span class="op" id="3947659">.</span><span class="ident" id="3947660">marshal</span><span class="op" id="3947667">(</span><span class="op" id="3947668">)</span><span class="op" id="3947669">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3947672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947676">finished</span>&nbsp;<span class="op" id="3947685">:=</span>&nbsp;<span class="builtinfunc" id="3947688">new</span><span class="op" id="3947691">(</span><span class="ident" id="3947692">finishedMsg</span><span class="op" id="3947703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947706">finished</span><span class="op" id="3947714">.</span><span class="ident" id="3947715">verifyData</span>&nbsp;<span class="op" id="3947726">=</span>&nbsp;<span class="ident" id="3947728">hs</span><span class="op" id="3947730">.</span><span class="ident" id="3947731">finishedHash</span><span class="op" id="3947743">.</span><span class="ident" id="3947744">clientSum</span><span class="op" id="3947753">(</span><span class="ident" id="3947754">hs</span><span class="op" id="3947756">.</span><span class="ident" id="3947757">masterSecret</span><span class="op" id="3947769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947772">hs</span><span class="op" id="3947774">.</span><span class="ident" id="3947775">finishedHash</span><span class="op" id="3947787">.</span><span class="ident" id="3947788">Write</span><span class="op" id="3947793">(</span><span class="ident" id="3947794">finished</span><span class="op" id="3947802">.</span><span class="ident" id="3947803">marshal</span><span class="op" id="3947810">(</span><span class="op" id="3947811">)</span><span class="op" id="3947812">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3947815">c</span><span class="op" id="3947816">.</span><span class="ident" id="3947817">writeRecord</span><span class="op" id="3947828">(</span><span class="ident" id="3947829">recordTypeHandshake</span><span class="op" id="3947848">,</span>&nbsp;<span class="ident" id="3947850">finished</span><span class="op" id="3947858">.</span><span class="ident" id="3947859">marshal</span><span class="op" id="3947866">(</span><span class="op" id="3947867">)</span><span class="op" id="3947868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3947871">copy</span><span class="op" id="3947875">(</span><span class="ident" id="3947876">out</span><span class="op" id="3947879">,</span>&nbsp;<span class="ident" id="3947881">finished</span><span class="op" id="3947889">.</span><span class="ident" id="3947890">verifyData</span><span class="op" id="3947900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3947903">return</span>&nbsp;<span class="ident" id="3947910">nil</span><br>
<span class="lineno"></span><span class="op" id="3947914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="3947917">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="3947996">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3948067">func</span>&nbsp;<span class="ident" id="3948072">clientSessionCacheKey</span><span class="op" id="3948093">(</span><span class="ident" id="3948094">serverAddr</span>&nbsp;<span class="ident" id="3948105">net</span><span class="op" id="3948108">.</span><span class="ident" id="3948109">Addr</span><span class="op" id="3948113">,</span>&nbsp;<span class="ident" id="3948115">config</span>&nbsp;<span class="op" id="3948122">*</span><span class="ident" id="3948123">Config</span><span class="op" id="3948129">)</span>&nbsp;<span class="builtintype" id="3948131">string</span>&nbsp;<span class="op" id="3948138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948141">if</span>&nbsp;<span class="builtinfunc" id="3948144">len</span><span class="op" id="3948147">(</span><span class="ident" id="3948148">config</span><span class="op" id="3948154">.</span><span class="ident" id="3948155">ServerName</span><span class="op" id="3948165">)</span>&nbsp;<span class="op" id="3948167">&gt;</span>&nbsp;<span class="num" id="3948169">0</span>&nbsp;<span class="op" id="3948171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948175">return</span>&nbsp;<span class="ident" id="3948182">config</span><span class="op" id="3948188">.</span><span class="ident" id="3948189">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948204">return</span>&nbsp;<span class="ident" id="3948211">serverAddr</span><span class="op" id="3948221">.</span><span class="ident" id="3948222">String</span><span class="op" id="3948228">(</span><span class="op" id="3948229">)</span><br>
<span class="lineno"></span><span class="op" id="3948231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3948234">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="3948312">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3948388">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="3948464">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="3948512">func</span>&nbsp;<span class="ident" id="3948517">mutualProtocol</span><span class="op" id="3948531">(</span><span class="ident" id="3948532">protos</span><span class="op" id="3948538">,</span>&nbsp;<span class="ident" id="3948540">preferenceProtos</span>&nbsp;<span class="op" id="3948557">[</span><span class="op" id="3948558">]</span><span class="builtintype" id="3948559">string</span><span class="op" id="3948565">)</span>&nbsp;<span class="op" id="3948567">(</span><span class="builtintype" id="3948568">string</span><span class="op" id="3948574">,</span>&nbsp;<span class="builtintype" id="3948576">bool</span><span class="op" id="3948580">)</span>&nbsp;<span class="op" id="3948582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948585">for</span>&nbsp;<span class="ident" id="3948589">_</span><span class="op" id="3948590">,</span>&nbsp;<span class="ident" id="3948592">s</span>&nbsp;<span class="op" id="3948594">:=</span>&nbsp;<span class="keyword" id="3948597">range</span>&nbsp;<span class="ident" id="3948603">preferenceProtos</span>&nbsp;<span class="op" id="3948620">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948624">for</span>&nbsp;<span class="ident" id="3948628">_</span><span class="op" id="3948629">,</span>&nbsp;<span class="ident" id="3948631">c</span>&nbsp;<span class="op" id="3948633">:=</span>&nbsp;<span class="keyword" id="3948636">range</span>&nbsp;<span class="ident" id="3948642">protos</span>&nbsp;<span class="op" id="3948649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948654">if</span>&nbsp;<span class="ident" id="3948657">s</span>&nbsp;<span class="op" id="3948659">==</span>&nbsp;<span class="ident" id="3948662">c</span>&nbsp;<span class="op" id="3948664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948670">return</span>&nbsp;<span class="ident" id="3948677">s</span><span class="op" id="3948678">,</span>&nbsp;<span class="ident" id="3948680">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948693">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3948696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948700">return</span>&nbsp;<span class="ident" id="3948707">protos</span><span class="op" id="3948713">[</span><span class="num" id="3948714">0</span><span class="op" id="3948715">]</span><span class="op" id="3948716">,</span>&nbsp;<span class="ident" id="3948718">true</span><br>
<span class="lineno"></span><span class="op" id="3948723">}</span>
</div>
</body>
</html>
