<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1549267">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1549322">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1549376">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1549427">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549462">package</span>&nbsp;<span class="ident" id="1549470">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549479">import</span>&nbsp;<span class="string" id="1549486">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1549496">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1549561">//</span><br>
<span class="lineno"></span><span class="comment" id="1549564">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1549623">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Atomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1549639">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1549667">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Might&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1549717">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Don&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1549771">//</span><br>
<span class="lineno"></span><span class="comment" id="1549774">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1549824">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549885">const</span>&nbsp;<span class="op" id="1549891">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549894">mutex_unlocked</span>&nbsp;<span class="op" id="1549909">=</span>&nbsp;<span class="num" id="1549911">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549914">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1549929">=</span>&nbsp;<span class="num" id="1549931">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549934">mutex_sleeping</span>&nbsp;<span class="op" id="1549949">=</span>&nbsp;<span class="num" id="1549951">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549955">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1549971">=</span>&nbsp;<span class="num" id="1549973">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549976">active_spin_cnt</span>&nbsp;<span class="op" id="1549992">=</span>&nbsp;<span class="num" id="1549994">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1549998">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1550014">=</span>&nbsp;<span class="num" id="1550016">1</span><br>
<span class="lineno">30</span><span class="op" id="1550018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1550021">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1550098">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1550177">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1550252">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1550278">func</span>&nbsp;<span class="ident" id="1550283">futexsleep</span><span class="op" id="1550293">(</span><span class="ident" id="1550294">addr</span>&nbsp;<span class="op" id="1550299">*</span><span class="builtintype" id="1550300">uint32</span><span class="op" id="1550306">,</span>&nbsp;<span class="ident" id="1550308">val</span>&nbsp;<span class="builtintype" id="1550312">uint32</span><span class="op" id="1550318">,</span>&nbsp;<span class="ident" id="1550320">ns</span>&nbsp;<span class="ident" id="1550323">int64</span><span class="op" id="1550328">)</span><br>
<span class="lineno"></span><span class="keyword" id="1550330">func</span>&nbsp;<span class="ident" id="1550335">futexwakeup</span><span class="op" id="1550346">(</span><span class="ident" id="1550347">addr</span>&nbsp;<span class="op" id="1550352">*</span><span class="builtintype" id="1550353">uint32</span><span class="op" id="1550359">,</span>&nbsp;<span class="ident" id="1550361">cnt</span>&nbsp;<span class="builtintype" id="1550365">uint32</span><span class="op" id="1550371">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1550374">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1550432">func</span>&nbsp;<span class="ident" id="1550437">key32</span><span class="op" id="1550442">(</span><span class="ident" id="1550443">p</span>&nbsp;<span class="op" id="1550445">*</span><span class="builtintype" id="1550446">uintptr</span><span class="op" id="1550453">)</span>&nbsp;<span class="op" id="1550455">*</span><span class="builtintype" id="1550456">uint32</span>&nbsp;<span class="op" id="1550463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1550466">return</span>&nbsp;<span class="op" id="1550473">(</span><span class="op" id="1550474">*</span><span class="builtintype" id="1550475">uint32</span><span class="op" id="1550481">)</span><span class="op" id="1550482">(</span><span class="ident" id="1550483">unsafe</span><span class="op" id="1550489">.</span><span class="ident" id="1550490">Pointer</span><span class="op" id="1550497">(</span><span class="ident" id="1550498">p</span><span class="op" id="1550499">)</span><span class="op" id="1550500">)</span><br>
<span class="lineno"></span><span class="op" id="1550502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1550505">func</span>&nbsp;<span class="ident" id="1550510">lock</span><span class="op" id="1550514">(</span><span class="ident" id="1550515">l</span>&nbsp;<span class="op" id="1550517">*</span><span class="ident" id="1550518">mutex</span><span class="op" id="1550523">)</span>&nbsp;<span class="op" id="1550525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1550528">gp</span>&nbsp;<span class="op" id="1550531">:=</span>&nbsp;<span class="ident" id="1550534">getg</span><span class="op" id="1550538">(</span><span class="op" id="1550539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1550543">if</span>&nbsp;<span class="ident" id="1550546">gp</span><span class="op" id="1550548">.</span><span class="ident" id="1550549">m</span><span class="op" id="1550550">.</span><span class="ident" id="1550551">locks</span>&nbsp;<span class="op" id="1550557">&lt;</span>&nbsp;<span class="num" id="1550559">0</span>&nbsp;<span class="op" id="1550561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1550565">gothrow</span><span class="op" id="1550572">(</span><span class="string" id="1550573">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1550600">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1550603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1550606">gp</span><span class="op" id="1550608">.</span><span class="ident" id="1550609">m</span><span class="op" id="1550610">.</span><span class="ident" id="1550611">locks</span><span class="op" id="1550616">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550621">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1550652">v</span>&nbsp;<span class="op" id="1550654">:=</span>&nbsp;<span class="ident" id="1550657">xchg</span><span class="op" id="1550661">(</span><span class="ident" id="1550662">key32</span><span class="op" id="1550667">(</span><span class="op" id="1550668">&amp;</span><span class="ident" id="1550669">l</span><span class="op" id="1550670">.</span><span class="ident" id="1550671">key</span><span class="op" id="1550674">)</span><span class="op" id="1550675">,</span>&nbsp;<span class="ident" id="1550677">mutex_locked</span><span class="op" id="1550689">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1550692">if</span>&nbsp;<span class="ident" id="1550695">v</span>&nbsp;<span class="op" id="1550697">==</span>&nbsp;<span class="ident" id="1550700">mutex_unlocked</span>&nbsp;<span class="op" id="1550715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1550719">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1550727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550731">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550781">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550833">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550883">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550934">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1550989">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551044">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551065">wait</span>&nbsp;<span class="op" id="1551070">:=</span>&nbsp;<span class="ident" id="1551073">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551077">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551118">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551173">spin</span>&nbsp;<span class="op" id="1551178">:=</span>&nbsp;<span class="num" id="1551181">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551184">if</span>&nbsp;<span class="ident" id="1551187">ncpu</span>&nbsp;<span class="op" id="1551192">&gt;</span>&nbsp;<span class="num" id="1551194">1</span>&nbsp;<span class="op" id="1551196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551200">spin</span>&nbsp;<span class="op" id="1551205">=</span>&nbsp;<span class="ident" id="1551207">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551223">for</span>&nbsp;<span class="op" id="1551227">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551231">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551260">for</span>&nbsp;<span class="ident" id="1551264">i</span>&nbsp;<span class="op" id="1551266">:=</span>&nbsp;<span class="num" id="1551269">0</span><span class="op" id="1551270">;</span>&nbsp;<span class="ident" id="1551272">i</span>&nbsp;<span class="op" id="1551274">&lt;</span>&nbsp;<span class="ident" id="1551276">spin</span><span class="op" id="1551280">;</span>&nbsp;<span class="ident" id="1551282">i</span><span class="op" id="1551283">++</span>&nbsp;<span class="op" id="1551286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551291">for</span>&nbsp;<span class="ident" id="1551295">l</span><span class="op" id="1551296">.</span><span class="ident" id="1551297">key</span>&nbsp;<span class="op" id="1551301">==</span>&nbsp;<span class="ident" id="1551304">mutex_unlocked</span>&nbsp;<span class="op" id="1551319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551325">if</span>&nbsp;<span class="ident" id="1551328">cas</span><span class="op" id="1551331">(</span><span class="ident" id="1551332">key32</span><span class="op" id="1551337">(</span><span class="op" id="1551338">&amp;</span><span class="ident" id="1551339">l</span><span class="op" id="1551340">.</span><span class="ident" id="1551341">key</span><span class="op" id="1551344">)</span><span class="op" id="1551345">,</span>&nbsp;<span class="ident" id="1551347">mutex_unlocked</span><span class="op" id="1551361">,</span>&nbsp;<span class="ident" id="1551363">wait</span><span class="op" id="1551367">)</span>&nbsp;<span class="op" id="1551369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551376">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551397">procyield</span><span class="op" id="1551406">(</span><span class="ident" id="1551407">active_spin_cnt</span><span class="op" id="1551422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551431">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551464">for</span>&nbsp;<span class="ident" id="1551468">i</span>&nbsp;<span class="op" id="1551470">:=</span>&nbsp;<span class="num" id="1551473">0</span><span class="op" id="1551474">;</span>&nbsp;<span class="ident" id="1551476">i</span>&nbsp;<span class="op" id="1551478">&lt;</span>&nbsp;<span class="ident" id="1551480">passive_spin</span><span class="op" id="1551492">;</span>&nbsp;<span class="ident" id="1551494">i</span><span class="op" id="1551495">++</span>&nbsp;<span class="op" id="1551498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551503">for</span>&nbsp;<span class="ident" id="1551507">l</span><span class="op" id="1551508">.</span><span class="ident" id="1551509">key</span>&nbsp;<span class="op" id="1551513">==</span>&nbsp;<span class="ident" id="1551516">mutex_unlocked</span>&nbsp;<span class="op" id="1551531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551537">if</span>&nbsp;<span class="ident" id="1551540">cas</span><span class="op" id="1551543">(</span><span class="ident" id="1551544">key32</span><span class="op" id="1551549">(</span><span class="op" id="1551550">&amp;</span><span class="ident" id="1551551">l</span><span class="op" id="1551552">.</span><span class="ident" id="1551553">key</span><span class="op" id="1551556">)</span><span class="op" id="1551557">,</span>&nbsp;<span class="ident" id="1551559">mutex_unlocked</span><span class="op" id="1551573">,</span>&nbsp;<span class="ident" id="1551575">wait</span><span class="op" id="1551579">)</span>&nbsp;<span class="op" id="1551581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551588">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551609">osyield</span><span class="op" id="1551616">(</span><span class="op" id="1551617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551626">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551638">v</span>&nbsp;<span class="op" id="1551640">=</span>&nbsp;<span class="ident" id="1551642">xchg</span><span class="op" id="1551646">(</span><span class="ident" id="1551647">key32</span><span class="op" id="1551652">(</span><span class="op" id="1551653">&amp;</span><span class="ident" id="1551654">l</span><span class="op" id="1551655">.</span><span class="ident" id="1551656">key</span><span class="op" id="1551659">)</span><span class="op" id="1551660">,</span>&nbsp;<span class="ident" id="1551662">mutex_sleeping</span><span class="op" id="1551676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551680">if</span>&nbsp;<span class="ident" id="1551683">v</span>&nbsp;<span class="op" id="1551685">==</span>&nbsp;<span class="ident" id="1551688">mutex_unlocked</span>&nbsp;<span class="op" id="1551703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551708">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551717">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551721">wait</span>&nbsp;<span class="op" id="1551726">=</span>&nbsp;<span class="ident" id="1551728">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551745">futexsleep</span><span class="op" id="1551755">(</span><span class="ident" id="1551756">key32</span><span class="op" id="1551761">(</span><span class="op" id="1551762">&amp;</span><span class="ident" id="1551763">l</span><span class="op" id="1551764">.</span><span class="ident" id="1551765">key</span><span class="op" id="1551768">)</span><span class="op" id="1551769">,</span>&nbsp;<span class="ident" id="1551771">mutex_sleeping</span><span class="op" id="1551785">,</span>&nbsp;<span class="op" id="1551787">-</span><span class="num" id="1551788">1</span><span class="op" id="1551789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551792">}</span><br>
<span class="lineno"></span><span class="op" id="1551794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1551797">func</span>&nbsp;<span class="ident" id="1551802">unlock</span><span class="op" id="1551808">(</span><span class="ident" id="1551809">l</span>&nbsp;<span class="op" id="1551811">*</span><span class="ident" id="1551812">mutex</span><span class="op" id="1551817">)</span>&nbsp;<span class="op" id="1551819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551822">v</span>&nbsp;<span class="op" id="1551824">:=</span>&nbsp;<span class="ident" id="1551827">xchg</span><span class="op" id="1551831">(</span><span class="ident" id="1551832">key32</span><span class="op" id="1551837">(</span><span class="op" id="1551838">&amp;</span><span class="ident" id="1551839">l</span><span class="op" id="1551840">.</span><span class="ident" id="1551841">key</span><span class="op" id="1551844">)</span><span class="op" id="1551845">,</span>&nbsp;<span class="ident" id="1551847">mutex_unlocked</span><span class="op" id="1551861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551864">if</span>&nbsp;<span class="ident" id="1551867">v</span>&nbsp;<span class="op" id="1551869">==</span>&nbsp;<span class="ident" id="1551872">mutex_unlocked</span>&nbsp;<span class="op" id="1551887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551891">gothrow</span><span class="op" id="1551898">(</span><span class="string" id="1551899">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1551924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551927">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551930">if</span>&nbsp;<span class="ident" id="1551933">v</span>&nbsp;<span class="op" id="1551935">==</span>&nbsp;<span class="ident" id="1551938">mutex_sleeping</span>&nbsp;<span class="op" id="1551953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551957">futexwakeup</span><span class="op" id="1551968">(</span><span class="ident" id="1551969">key32</span><span class="op" id="1551974">(</span><span class="op" id="1551975">&amp;</span><span class="ident" id="1551976">l</span><span class="op" id="1551977">.</span><span class="ident" id="1551978">key</span><span class="op" id="1551981">)</span><span class="op" id="1551982">,</span>&nbsp;<span class="num" id="1551984">1</span><span class="op" id="1551985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551992">gp</span>&nbsp;<span class="op" id="1551995">:=</span>&nbsp;<span class="ident" id="1551998">getg</span><span class="op" id="1552002">(</span><span class="op" id="1552003">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552006">gp</span><span class="op" id="1552008">.</span><span class="ident" id="1552009">m</span><span class="op" id="1552010">.</span><span class="ident" id="1552011">locks</span><span class="op" id="1552016">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552020">if</span>&nbsp;<span class="ident" id="1552023">gp</span><span class="op" id="1552025">.</span><span class="ident" id="1552026">m</span><span class="op" id="1552027">.</span><span class="ident" id="1552028">locks</span>&nbsp;<span class="op" id="1552034">&lt;</span>&nbsp;<span class="num" id="1552036">0</span>&nbsp;<span class="op" id="1552038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552042">gothrow</span><span class="op" id="1552049">(</span><span class="string" id="1552050">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1552079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552085">if</span>&nbsp;<span class="ident" id="1552088">gp</span><span class="op" id="1552090">.</span><span class="ident" id="1552091">m</span><span class="op" id="1552092">.</span><span class="ident" id="1552093">locks</span>&nbsp;<span class="op" id="1552099">==</span>&nbsp;<span class="num" id="1552102">0</span>&nbsp;<span class="op" id="1552104">&amp;&amp;</span>&nbsp;<span class="ident" id="1552107">gp</span><span class="op" id="1552109">.</span><span class="ident" id="1552110">preempt</span>&nbsp;<span class="op" id="1552118">{</span>&nbsp;<span class="comment" id="1552120">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552193">gp</span><span class="op" id="1552195">.</span><span class="ident" id="1552196">stackguard0</span>&nbsp;<span class="op" id="1552208">=</span>&nbsp;<span class="ident" id="1552210">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552224">}</span><br>
<span class="lineno"></span><span class="op" id="1552226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1552229">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1552256">func</span>&nbsp;<span class="ident" id="1552261">noteclear</span><span class="op" id="1552270">(</span><span class="ident" id="1552271">n</span>&nbsp;<span class="op" id="1552273">*</span><span class="ident" id="1552274">note</span><span class="op" id="1552278">)</span>&nbsp;<span class="op" id="1552280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552283">n</span><span class="op" id="1552284">.</span><span class="ident" id="1552285">key</span>&nbsp;<span class="op" id="1552289">=</span>&nbsp;<span class="num" id="1552291">0</span><br>
<span class="lineno"></span><span class="op" id="1552293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552296">func</span>&nbsp;<span class="ident" id="1552301">notewakeup</span><span class="op" id="1552311">(</span><span class="ident" id="1552312">n</span>&nbsp;<span class="op" id="1552314">*</span><span class="ident" id="1552315">note</span><span class="op" id="1552319">)</span>&nbsp;<span class="op" id="1552321">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552324">old</span>&nbsp;<span class="op" id="1552328">:=</span>&nbsp;<span class="ident" id="1552331">xchg</span><span class="op" id="1552335">(</span><span class="ident" id="1552336">key32</span><span class="op" id="1552341">(</span><span class="op" id="1552342">&amp;</span><span class="ident" id="1552343">n</span><span class="op" id="1552344">.</span><span class="ident" id="1552345">key</span><span class="op" id="1552348">)</span><span class="op" id="1552349">,</span>&nbsp;<span class="num" id="1552351">1</span><span class="op" id="1552352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552355">if</span>&nbsp;<span class="ident" id="1552358">old</span>&nbsp;<span class="op" id="1552362">!=</span>&nbsp;<span class="num" id="1552365">0</span>&nbsp;<span class="op" id="1552367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1552371">print</span><span class="op" id="1552376">(</span><span class="string" id="1552377">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1552407">,</span>&nbsp;<span class="ident" id="1552409">old</span><span class="op" id="1552412">,</span>&nbsp;<span class="string" id="1552414">&#34;)\n&#34;</span><span class="op" id="1552419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552423">gothrow</span><span class="op" id="1552430">(</span><span class="string" id="1552431">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1552459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552462">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552465">futexwakeup</span><span class="op" id="1552476">(</span><span class="ident" id="1552477">key32</span><span class="op" id="1552482">(</span><span class="op" id="1552483">&amp;</span><span class="ident" id="1552484">n</span><span class="op" id="1552485">.</span><span class="ident" id="1552486">key</span><span class="op" id="1552489">)</span><span class="op" id="1552490">,</span>&nbsp;<span class="num" id="1552492">1</span><span class="op" id="1552493">)</span><br>
<span class="lineno"></span><span class="op" id="1552495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552498">func</span>&nbsp;<span class="ident" id="1552503">notesleep</span><span class="op" id="1552512">(</span><span class="ident" id="1552513">n</span>&nbsp;<span class="op" id="1552515">*</span><span class="ident" id="1552516">note</span><span class="op" id="1552520">)</span>&nbsp;<span class="op" id="1552522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552525">gp</span>&nbsp;<span class="op" id="1552528">:=</span>&nbsp;<span class="ident" id="1552531">getg</span><span class="op" id="1552535">(</span><span class="op" id="1552536">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552539">if</span>&nbsp;<span class="ident" id="1552542">gp</span>&nbsp;<span class="op" id="1552545">!=</span>&nbsp;<span class="ident" id="1552548">gp</span><span class="op" id="1552550">.</span><span class="ident" id="1552551">m</span><span class="op" id="1552552">.</span><span class="ident" id="1552553">g0</span>&nbsp;<span class="op" id="1552556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552560">gothrow</span><span class="op" id="1552567">(</span><span class="string" id="1552568">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1552589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552595">for</span>&nbsp;<span class="ident" id="1552599">atomicload</span><span class="op" id="1552609">(</span><span class="ident" id="1552610">key32</span><span class="op" id="1552615">(</span><span class="op" id="1552616">&amp;</span><span class="ident" id="1552617">n</span><span class="op" id="1552618">.</span><span class="ident" id="1552619">key</span><span class="op" id="1552622">)</span><span class="op" id="1552623">)</span>&nbsp;<span class="op" id="1552625">==</span>&nbsp;<span class="num" id="1552628">0</span>&nbsp;<span class="op" id="1552630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552634">gp</span><span class="op" id="1552636">.</span><span class="ident" id="1552637">m</span><span class="op" id="1552638">.</span><span class="ident" id="1552639">blocked</span>&nbsp;<span class="op" id="1552647">=</span>&nbsp;<span class="builtintype" id="1552649">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552656">futexsleep</span><span class="op" id="1552666">(</span><span class="ident" id="1552667">key32</span><span class="op" id="1552672">(</span><span class="op" id="1552673">&amp;</span><span class="ident" id="1552674">n</span><span class="op" id="1552675">.</span><span class="ident" id="1552676">key</span><span class="op" id="1552679">)</span><span class="op" id="1552680">,</span>&nbsp;<span class="num" id="1552682">0</span><span class="op" id="1552683">,</span>&nbsp;<span class="op" id="1552685">-</span><span class="num" id="1552686">1</span><span class="op" id="1552687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552691">gp</span><span class="op" id="1552693">.</span><span class="ident" id="1552694">m</span><span class="op" id="1552695">.</span><span class="ident" id="1552696">blocked</span>&nbsp;<span class="op" id="1552704">=</span>&nbsp;<span class="builtintype" id="1552706">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552713">}</span><br>
<span class="lineno"></span><span class="op" id="1552715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1552718">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1552731">func</span>&nbsp;<span class="ident" id="1552736">notetsleep_internal</span><span class="op" id="1552755">(</span><span class="ident" id="1552756">n</span>&nbsp;<span class="op" id="1552758">*</span><span class="ident" id="1552759">note</span><span class="op" id="1552763">,</span>&nbsp;<span class="ident" id="1552765">ns</span>&nbsp;<span class="ident" id="1552768">int64</span><span class="op" id="1552773">)</span>&nbsp;<span class="builtintype" id="1552775">bool</span>&nbsp;<span class="op" id="1552780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552783">gp</span>&nbsp;<span class="op" id="1552786">:=</span>&nbsp;<span class="ident" id="1552789">getg</span><span class="op" id="1552793">(</span><span class="op" id="1552794">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552798">if</span>&nbsp;<span class="ident" id="1552801">ns</span>&nbsp;<span class="op" id="1552804">&lt;</span>&nbsp;<span class="num" id="1552806">0</span>&nbsp;<span class="op" id="1552808">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552812">for</span>&nbsp;<span class="ident" id="1552816">atomicload</span><span class="op" id="1552826">(</span><span class="ident" id="1552827">key32</span><span class="op" id="1552832">(</span><span class="op" id="1552833">&amp;</span><span class="ident" id="1552834">n</span><span class="op" id="1552835">.</span><span class="ident" id="1552836">key</span><span class="op" id="1552839">)</span><span class="op" id="1552840">)</span>&nbsp;<span class="op" id="1552842">==</span>&nbsp;<span class="num" id="1552845">0</span>&nbsp;<span class="op" id="1552847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552852">gp</span><span class="op" id="1552854">.</span><span class="ident" id="1552855">m</span><span class="op" id="1552856">.</span><span class="ident" id="1552857">blocked</span>&nbsp;<span class="op" id="1552865">=</span>&nbsp;<span class="builtintype" id="1552867">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552875">futexsleep</span><span class="op" id="1552885">(</span><span class="ident" id="1552886">key32</span><span class="op" id="1552891">(</span><span class="op" id="1552892">&amp;</span><span class="ident" id="1552893">n</span><span class="op" id="1552894">.</span><span class="ident" id="1552895">key</span><span class="op" id="1552898">)</span><span class="op" id="1552899">,</span>&nbsp;<span class="num" id="1552901">0</span><span class="op" id="1552902">,</span>&nbsp;<span class="op" id="1552904">-</span><span class="num" id="1552905">1</span><span class="op" id="1552906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552911">gp</span><span class="op" id="1552913">.</span><span class="ident" id="1552914">m</span><span class="op" id="1552915">.</span><span class="ident" id="1552916">blocked</span>&nbsp;<span class="op" id="1552924">=</span>&nbsp;<span class="builtintype" id="1552926">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552934">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552938">return</span>&nbsp;<span class="builtintype" id="1552945">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552955">if</span>&nbsp;<span class="ident" id="1552958">atomicload</span><span class="op" id="1552968">(</span><span class="ident" id="1552969">key32</span><span class="op" id="1552974">(</span><span class="op" id="1552975">&amp;</span><span class="ident" id="1552976">n</span><span class="op" id="1552977">.</span><span class="ident" id="1552978">key</span><span class="op" id="1552981">)</span><span class="op" id="1552982">)</span>&nbsp;<span class="op" id="1552984">!=</span>&nbsp;<span class="num" id="1552987">0</span>&nbsp;<span class="op" id="1552989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552993">return</span>&nbsp;<span class="builtintype" id="1553000">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553010">deadline</span>&nbsp;<span class="op" id="1553019">:=</span>&nbsp;<span class="ident" id="1553022">nanotime</span><span class="op" id="1553030">(</span><span class="op" id="1553031">)</span>&nbsp;<span class="op" id="1553033">+</span>&nbsp;<span class="ident" id="1553035">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553039">for</span>&nbsp;<span class="op" id="1553043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553047">gp</span><span class="op" id="1553049">.</span><span class="ident" id="1553050">m</span><span class="op" id="1553051">.</span><span class="ident" id="1553052">blocked</span>&nbsp;<span class="op" id="1553060">=</span>&nbsp;<span class="builtintype" id="1553062">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553069">futexsleep</span><span class="op" id="1553079">(</span><span class="ident" id="1553080">key32</span><span class="op" id="1553085">(</span><span class="op" id="1553086">&amp;</span><span class="ident" id="1553087">n</span><span class="op" id="1553088">.</span><span class="ident" id="1553089">key</span><span class="op" id="1553092">)</span><span class="op" id="1553093">,</span>&nbsp;<span class="num" id="1553095">0</span><span class="op" id="1553096">,</span>&nbsp;<span class="ident" id="1553098">ns</span><span class="op" id="1553100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553104">gp</span><span class="op" id="1553106">.</span><span class="ident" id="1553107">m</span><span class="op" id="1553108">.</span><span class="ident" id="1553109">blocked</span>&nbsp;<span class="op" id="1553117">=</span>&nbsp;<span class="builtintype" id="1553119">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553127">if</span>&nbsp;<span class="ident" id="1553130">atomicload</span><span class="op" id="1553140">(</span><span class="ident" id="1553141">key32</span><span class="op" id="1553146">(</span><span class="op" id="1553147">&amp;</span><span class="ident" id="1553148">n</span><span class="op" id="1553149">.</span><span class="ident" id="1553150">key</span><span class="op" id="1553153">)</span><span class="op" id="1553154">)</span>&nbsp;<span class="op" id="1553156">!=</span>&nbsp;<span class="num" id="1553159">0</span>&nbsp;<span class="op" id="1553161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553166">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553174">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553178">now</span>&nbsp;<span class="op" id="1553182">:=</span>&nbsp;<span class="ident" id="1553185">nanotime</span><span class="op" id="1553193">(</span><span class="op" id="1553194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553198">if</span>&nbsp;<span class="ident" id="1553201">now</span>&nbsp;<span class="op" id="1553205">&gt;=</span>&nbsp;<span class="ident" id="1553208">deadline</span>&nbsp;<span class="op" id="1553217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553222">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553234">ns</span>&nbsp;<span class="op" id="1553237">=</span>&nbsp;<span class="ident" id="1553239">deadline</span>&nbsp;<span class="op" id="1553248">-</span>&nbsp;<span class="ident" id="1553250">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553258">return</span>&nbsp;<span class="ident" id="1553265">atomicload</span><span class="op" id="1553275">(</span><span class="ident" id="1553276">key32</span><span class="op" id="1553281">(</span><span class="op" id="1553282">&amp;</span><span class="ident" id="1553283">n</span><span class="op" id="1553284">.</span><span class="ident" id="1553285">key</span><span class="op" id="1553288">)</span><span class="op" id="1553289">)</span>&nbsp;<span class="op" id="1553291">!=</span>&nbsp;<span class="num" id="1553294">0</span><br>
<span class="lineno"></span><span class="op" id="1553296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1553299">func</span>&nbsp;<span class="ident" id="1553304">notetsleep</span><span class="op" id="1553314">(</span><span class="ident" id="1553315">n</span>&nbsp;<span class="op" id="1553317">*</span><span class="ident" id="1553318">note</span><span class="op" id="1553322">,</span>&nbsp;<span class="ident" id="1553324">ns</span>&nbsp;<span class="ident" id="1553327">int64</span><span class="op" id="1553332">)</span>&nbsp;<span class="builtintype" id="1553334">bool</span>&nbsp;<span class="op" id="1553339">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553342">gp</span>&nbsp;<span class="op" id="1553345">:=</span>&nbsp;<span class="ident" id="1553348">getg</span><span class="op" id="1553352">(</span><span class="op" id="1553353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553356">if</span>&nbsp;<span class="ident" id="1553359">gp</span>&nbsp;<span class="op" id="1553362">!=</span>&nbsp;<span class="ident" id="1553365">gp</span><span class="op" id="1553367">.</span><span class="ident" id="1553368">m</span><span class="op" id="1553369">.</span><span class="ident" id="1553370">g0</span>&nbsp;<span class="op" id="1553373">&amp;&amp;</span>&nbsp;<span class="ident" id="1553376">gp</span><span class="op" id="1553378">.</span><span class="ident" id="1553379">m</span><span class="op" id="1553380">.</span><span class="ident" id="1553381">gcing</span>&nbsp;<span class="op" id="1553387">==</span>&nbsp;<span class="num" id="1553390">0</span>&nbsp;<span class="op" id="1553392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553396">gothrow</span><span class="op" id="1553403">(</span><span class="string" id="1553404">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1553426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553433">return</span>&nbsp;<span class="ident" id="1553440">notetsleep_internal</span><span class="op" id="1553459">(</span><span class="ident" id="1553460">n</span><span class="op" id="1553461">,</span>&nbsp;<span class="ident" id="1553463">ns</span><span class="op" id="1553465">)</span><br>
<span class="lineno"></span><span class="op" id="1553467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1553470">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1553532">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1553602">func</span>&nbsp;<span class="ident" id="1553607">notetsleepg</span><span class="op" id="1553618">(</span><span class="ident" id="1553619">n</span>&nbsp;<span class="op" id="1553621">*</span><span class="ident" id="1553622">note</span><span class="op" id="1553626">,</span>&nbsp;<span class="ident" id="1553628">ns</span>&nbsp;<span class="ident" id="1553631">int64</span><span class="op" id="1553636">)</span>&nbsp;<span class="builtintype" id="1553638">bool</span>&nbsp;<span class="op" id="1553643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553646">gp</span>&nbsp;<span class="op" id="1553649">:=</span>&nbsp;<span class="ident" id="1553652">getg</span><span class="op" id="1553656">(</span><span class="op" id="1553657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553660">if</span>&nbsp;<span class="ident" id="1553663">gp</span>&nbsp;<span class="op" id="1553666">==</span>&nbsp;<span class="ident" id="1553669">gp</span><span class="op" id="1553671">.</span><span class="ident" id="1553672">m</span><span class="op" id="1553673">.</span><span class="ident" id="1553674">g0</span>&nbsp;<span class="op" id="1553677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553681">gothrow</span><span class="op" id="1553688">(</span><span class="string" id="1553689">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1553708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553711">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553715">entersyscallblock</span><span class="op" id="1553732">(</span><span class="op" id="1553733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553736">ok</span>&nbsp;<span class="op" id="1553739">:=</span>&nbsp;<span class="ident" id="1553742">notetsleep_internal</span><span class="op" id="1553761">(</span><span class="ident" id="1553762">n</span><span class="op" id="1553763">,</span>&nbsp;<span class="ident" id="1553765">ns</span><span class="op" id="1553767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553770">exitsyscall</span><span class="op" id="1553781">(</span><span class="op" id="1553782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553785">return</span>&nbsp;<span class="ident" id="1553792">ok</span><br>
<span class="lineno">205</span><span class="op" id="1553795">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
