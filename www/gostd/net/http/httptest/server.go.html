<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5462115">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5462170">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5462224">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5462275">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5462304">package</span>&nbsp;<span class="ident" id="5462312">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5462322">import</span>&nbsp;<span class="op" id="5462329">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462332">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462346">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462354">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462361">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462368">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462380">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5462386">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5462393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5462396">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="5462467">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="5462530">type</span>&nbsp;<span class="ident" id="5462535">Server</span>&nbsp;<span class="keyword" id="5462542">struct</span>&nbsp;<span class="op" id="5462549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462552">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5462561">string</span>&nbsp;<span class="comment" id="5462568">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462631">Listener</span>&nbsp;<span class="ident" id="5462640">net</span><span class="op" id="5462643">.</span><span class="ident" id="5462644">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462655">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462726">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462798">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462861">TLS</span>&nbsp;<span class="op" id="5462865">*</span><span class="ident" id="5462866">tls</span><span class="op" id="5462869">.</span><span class="ident" id="5462870">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462879">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462942">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462972">Config</span>&nbsp;<span class="op" id="5462979">*</span><span class="ident" id="5462980">http</span><span class="op" id="5462984">.</span><span class="ident" id="5462985">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462994">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463064">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463114">wg</span>&nbsp;<span class="ident" id="5463117">sync</span><span class="op" id="5463121">.</span><span class="ident" id="5463122">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="5463132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5463135">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="5463200">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="5463213">type</span>&nbsp;<span class="ident" id="5463218">historyListener</span>&nbsp;<span class="keyword" id="5463234">struct</span>&nbsp;<span class="op" id="5463241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463244">net</span><span class="op" id="5463247">.</span><span class="ident" id="5463248">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463258">sync</span><span class="op" id="5463262">.</span><span class="ident" id="5463263">Mutex</span>&nbsp;<span class="comment" id="5463269">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463290">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5463301">[</span><span class="op" id="5463302">]</span><span class="ident" id="5463303">net</span><span class="op" id="5463306">.</span><span class="ident" id="5463307">Conn</span><br>
<span class="lineno">45</span><span class="op" id="5463312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5463315">func</span>&nbsp;<span class="op" id="5463320">(</span><span class="ident" id="5463321">hs</span>&nbsp;<span class="op" id="5463324">*</span><span class="ident" id="5463325">historyListener</span><span class="op" id="5463340">)</span>&nbsp;<span class="ident" id="5463342">Accept</span><span class="op" id="5463348">(</span><span class="op" id="5463349">)</span>&nbsp;<span class="op" id="5463351">(</span><span class="ident" id="5463352">c</span>&nbsp;<span class="ident" id="5463354">net</span><span class="op" id="5463357">.</span><span class="ident" id="5463358">Conn</span><span class="op" id="5463362">,</span>&nbsp;<span class="ident" id="5463364">err</span>&nbsp;<span class="builtintype" id="5463368">error</span><span class="op" id="5463373">)</span>&nbsp;<span class="op" id="5463375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463378">c</span><span class="op" id="5463379">,</span>&nbsp;<span class="ident" id="5463381">err</span>&nbsp;<span class="op" id="5463385">=</span>&nbsp;<span class="ident" id="5463387">hs</span><span class="op" id="5463389">.</span><span class="ident" id="5463390">Listener</span><span class="op" id="5463398">.</span><span class="ident" id="5463399">Accept</span><span class="op" id="5463405">(</span><span class="op" id="5463406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463409">if</span>&nbsp;<span class="ident" id="5463412">err</span>&nbsp;<span class="op" id="5463416">==</span>&nbsp;<span class="ident" id="5463419">nil</span>&nbsp;<span class="op" id="5463423">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463427">hs</span><span class="op" id="5463429">.</span><span class="ident" id="5463430">Lock</span><span class="op" id="5463434">(</span><span class="op" id="5463435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463439">hs</span><span class="op" id="5463441">.</span><span class="ident" id="5463442">history</span>&nbsp;<span class="op" id="5463450">=</span>&nbsp;<span class="builtinfunc" id="5463452">append</span><span class="op" id="5463458">(</span><span class="ident" id="5463459">hs</span><span class="op" id="5463461">.</span><span class="ident" id="5463462">history</span><span class="op" id="5463469">,</span>&nbsp;<span class="ident" id="5463471">c</span><span class="op" id="5463472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463476">hs</span><span class="op" id="5463478">.</span><span class="ident" id="5463479">Unlock</span><span class="op" id="5463485">(</span><span class="op" id="5463486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463492">return</span><br>
<span class="lineno">55</span><span class="op" id="5463499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5463502">func</span>&nbsp;<span class="ident" id="5463507">newLocalListener</span><span class="op" id="5463523">(</span><span class="op" id="5463524">)</span>&nbsp;<span class="ident" id="5463526">net</span><span class="op" id="5463529">.</span><span class="ident" id="5463530">Listener</span>&nbsp;<span class="op" id="5463539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463542">if</span>&nbsp;<span class="op" id="5463545">*</span><span class="ident" id="5463546">serve</span>&nbsp;<span class="op" id="5463552">!=</span>&nbsp;<span class="string" id="5463555">&#34;&#34;</span>&nbsp;<span class="op" id="5463558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463562">l</span><span class="op" id="5463563">,</span>&nbsp;<span class="ident" id="5463565">err</span>&nbsp;<span class="op" id="5463569">:=</span>&nbsp;<span class="ident" id="5463572">net</span><span class="op" id="5463575">.</span><span class="ident" id="5463576">Listen</span><span class="op" id="5463582">(</span><span class="string" id="5463583">&#34;tcp&#34;</span><span class="op" id="5463588">,</span>&nbsp;<span class="op" id="5463590">*</span><span class="ident" id="5463591">serve</span><span class="op" id="5463596">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463600">if</span>&nbsp;<span class="ident" id="5463603">err</span>&nbsp;<span class="op" id="5463607">!=</span>&nbsp;<span class="ident" id="5463610">nil</span>&nbsp;<span class="op" id="5463614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5463619">panic</span><span class="op" id="5463624">(</span><span class="ident" id="5463625">fmt</span><span class="op" id="5463628">.</span><span class="ident" id="5463629">Sprintf</span><span class="op" id="5463636">(</span><span class="string" id="5463637">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="5463675">,</span>&nbsp;<span class="op" id="5463677">*</span><span class="ident" id="5463678">serve</span><span class="op" id="5463683">,</span>&nbsp;<span class="ident" id="5463685">err</span><span class="op" id="5463688">)</span><span class="op" id="5463689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463697">return</span>&nbsp;<span class="ident" id="5463704">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463707">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463710">l</span><span class="op" id="5463711">,</span>&nbsp;<span class="ident" id="5463713">err</span>&nbsp;<span class="op" id="5463717">:=</span>&nbsp;<span class="ident" id="5463720">net</span><span class="op" id="5463723">.</span><span class="ident" id="5463724">Listen</span><span class="op" id="5463730">(</span><span class="string" id="5463731">&#34;tcp&#34;</span><span class="op" id="5463736">,</span>&nbsp;<span class="string" id="5463738">&#34;127.0.0.1:0&#34;</span><span class="op" id="5463751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463754">if</span>&nbsp;<span class="ident" id="5463757">err</span>&nbsp;<span class="op" id="5463761">!=</span>&nbsp;<span class="ident" id="5463764">nil</span>&nbsp;<span class="op" id="5463768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463772">if</span>&nbsp;<span class="ident" id="5463775">l</span><span class="op" id="5463776">,</span>&nbsp;<span class="ident" id="5463778">err</span>&nbsp;<span class="op" id="5463782">=</span>&nbsp;<span class="ident" id="5463784">net</span><span class="op" id="5463787">.</span><span class="ident" id="5463788">Listen</span><span class="op" id="5463794">(</span><span class="string" id="5463795">&#34;tcp6&#34;</span><span class="op" id="5463801">,</span>&nbsp;<span class="string" id="5463803">&#34;[::1]:0&#34;</span><span class="op" id="5463812">)</span><span class="op" id="5463813">;</span>&nbsp;<span class="ident" id="5463815">err</span>&nbsp;<span class="op" id="5463819">!=</span>&nbsp;<span class="ident" id="5463822">nil</span>&nbsp;<span class="op" id="5463826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5463831">panic</span><span class="op" id="5463836">(</span><span class="ident" id="5463837">fmt</span><span class="op" id="5463840">.</span><span class="ident" id="5463841">Sprintf</span><span class="op" id="5463848">(</span><span class="string" id="5463849">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="5463891">,</span>&nbsp;<span class="ident" id="5463893">err</span><span class="op" id="5463896">)</span><span class="op" id="5463897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463901">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463907">return</span>&nbsp;<span class="ident" id="5463914">l</span><br>
<span class="lineno"></span><span class="op" id="5463916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5463919">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="5463974">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5464000">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="5464058">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="5464126">var</span>&nbsp;<span class="ident" id="5464130">serve</span>&nbsp;<span class="op" id="5464136">=</span>&nbsp;<span class="ident" id="5464138">flag</span><span class="op" id="5464142">.</span><span class="ident" id="5464143">String</span><span class="op" id="5464149">(</span><span class="string" id="5464150">&#34;httptest.serve&#34;</span><span class="op" id="5464166">,</span>&nbsp;<span class="string" id="5464168">&#34;&#34;</span><span class="op" id="5464170">,</span>&nbsp;<span class="string" id="5464172">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="5464240">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5464243">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="5464289">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5464353">func</span>&nbsp;<span class="ident" id="5464358">NewServer</span><span class="op" id="5464367">(</span><span class="ident" id="5464368">handler</span>&nbsp;<span class="ident" id="5464376">http</span><span class="op" id="5464380">.</span><span class="ident" id="5464381">Handler</span><span class="op" id="5464388">)</span>&nbsp;<span class="op" id="5464390">*</span><span class="ident" id="5464391">Server</span>&nbsp;<span class="op" id="5464398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464401">ts</span>&nbsp;<span class="op" id="5464404">:=</span>&nbsp;<span class="ident" id="5464407">NewUnstartedServer</span><span class="op" id="5464425">(</span><span class="ident" id="5464426">handler</span><span class="op" id="5464433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464436">ts</span><span class="op" id="5464438">.</span><span class="ident" id="5464439">Start</span><span class="op" id="5464444">(</span><span class="op" id="5464445">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464448">return</span>&nbsp;<span class="ident" id="5464455">ts</span><br>
<span class="lineno"></span><span class="op" id="5464458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464461">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5464526">//</span><br>
<span class="lineno">90</span><span class="comment" id="5464529">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5464598">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="5464611">//</span><br>
<span class="lineno"></span><span class="comment" id="5464614">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5464678">func</span>&nbsp;<span class="ident" id="5464683">NewUnstartedServer</span><span class="op" id="5464701">(</span><span class="ident" id="5464702">handler</span>&nbsp;<span class="ident" id="5464710">http</span><span class="op" id="5464714">.</span><span class="ident" id="5464715">Handler</span><span class="op" id="5464722">)</span>&nbsp;<span class="op" id="5464724">*</span><span class="ident" id="5464725">Server</span>&nbsp;<span class="op" id="5464732">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464735">return</span>&nbsp;<span class="op" id="5464742">&amp;</span><span class="ident" id="5464743">Server</span><span class="op" id="5464749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464753">Listener</span><span class="op" id="5464761">:</span>&nbsp;<span class="ident" id="5464763">newLocalListener</span><span class="op" id="5464779">(</span><span class="op" id="5464780">)</span><span class="op" id="5464781">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464785">Config</span><span class="op" id="5464791">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5464795">&amp;</span><span class="ident" id="5464796">http</span><span class="op" id="5464800">.</span><span class="ident" id="5464801">Server</span><span class="op" id="5464807">{</span><span class="ident" id="5464808">Handler</span><span class="op" id="5464815">:</span>&nbsp;<span class="ident" id="5464817">handler</span><span class="op" id="5464824">}</span><span class="op" id="5464825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464828">}</span><br>
<span class="lineno"></span><span class="op" id="5464830">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5464833">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5464883">func</span>&nbsp;<span class="op" id="5464888">(</span><span class="ident" id="5464889">s</span>&nbsp;<span class="op" id="5464891">*</span><span class="ident" id="5464892">Server</span><span class="op" id="5464898">)</span>&nbsp;<span class="ident" id="5464900">Start</span><span class="op" id="5464905">(</span><span class="op" id="5464906">)</span>&nbsp;<span class="op" id="5464908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464911">if</span>&nbsp;<span class="ident" id="5464914">s</span><span class="op" id="5464915">.</span><span class="ident" id="5464916">URL</span>&nbsp;<span class="op" id="5464920">!=</span>&nbsp;<span class="string" id="5464923">&#34;&#34;</span>&nbsp;<span class="op" id="5464926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5464930">panic</span><span class="op" id="5464935">(</span><span class="string" id="5464936">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5464960">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464966">s</span><span class="op" id="5464967">.</span><span class="ident" id="5464968">Listener</span>&nbsp;<span class="op" id="5464977">=</span>&nbsp;<span class="op" id="5464979">&amp;</span><span class="ident" id="5464980">historyListener</span><span class="op" id="5464995">{</span><span class="ident" id="5464996">Listener</span><span class="op" id="5465004">:</span>&nbsp;<span class="ident" id="5465006">s</span><span class="op" id="5465007">.</span><span class="ident" id="5465008">Listener</span><span class="op" id="5465016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465019">s</span><span class="op" id="5465020">.</span><span class="ident" id="5465021">URL</span>&nbsp;<span class="op" id="5465025">=</span>&nbsp;<span class="string" id="5465027">&#34;http://&#34;</span>&nbsp;<span class="op" id="5465037">+</span>&nbsp;<span class="ident" id="5465039">s</span><span class="op" id="5465040">.</span><span class="ident" id="5465041">Listener</span><span class="op" id="5465049">.</span><span class="ident" id="5465050">Addr</span><span class="op" id="5465054">(</span><span class="op" id="5465055">)</span><span class="op" id="5465056">.</span><span class="ident" id="5465057">String</span><span class="op" id="5465063">(</span><span class="op" id="5465064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465067">s</span><span class="op" id="5465068">.</span><span class="ident" id="5465069">wrapHandler</span><span class="op" id="5465080">(</span><span class="op" id="5465081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465084">go</span>&nbsp;<span class="ident" id="5465087">s</span><span class="op" id="5465088">.</span><span class="ident" id="5465089">Config</span><span class="op" id="5465095">.</span><span class="ident" id="5465096">Serve</span><span class="op" id="5465101">(</span><span class="ident" id="5465102">s</span><span class="op" id="5465103">.</span><span class="ident" id="5465104">Listener</span><span class="op" id="5465112">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465115">if</span>&nbsp;<span class="op" id="5465118">*</span><span class="ident" id="5465119">serve</span>&nbsp;<span class="op" id="5465125">!=</span>&nbsp;<span class="string" id="5465128">&#34;&#34;</span>&nbsp;<span class="op" id="5465131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465135">fmt</span><span class="op" id="5465138">.</span><span class="ident" id="5465139">Fprintln</span><span class="op" id="5465147">(</span><span class="ident" id="5465148">os</span><span class="op" id="5465150">.</span><span class="ident" id="5465151">Stderr</span><span class="op" id="5465157">,</span>&nbsp;<span class="string" id="5465159">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="5465181">,</span>&nbsp;<span class="ident" id="5465183">s</span><span class="op" id="5465184">.</span><span class="ident" id="5465185">URL</span><span class="op" id="5465188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465192">select</span>&nbsp;<span class="op" id="5465199">{</span><span class="op" id="5465200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465203">}</span><br>
<span class="lineno"></span><span class="op" id="5465205">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5465208">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5465268">func</span>&nbsp;<span class="op" id="5465273">(</span><span class="ident" id="5465274">s</span>&nbsp;<span class="op" id="5465276">*</span><span class="ident" id="5465277">Server</span><span class="op" id="5465283">)</span>&nbsp;<span class="ident" id="5465285">StartTLS</span><span class="op" id="5465293">(</span><span class="op" id="5465294">)</span>&nbsp;<span class="op" id="5465296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465299">if</span>&nbsp;<span class="ident" id="5465302">s</span><span class="op" id="5465303">.</span><span class="ident" id="5465304">URL</span>&nbsp;<span class="op" id="5465308">!=</span>&nbsp;<span class="string" id="5465311">&#34;&#34;</span>&nbsp;<span class="op" id="5465314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5465318">panic</span><span class="op" id="5465323">(</span><span class="string" id="5465324">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5465348">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465354">cert</span><span class="op" id="5465358">,</span>&nbsp;<span class="ident" id="5465360">err</span>&nbsp;<span class="op" id="5465364">:=</span>&nbsp;<span class="ident" id="5465367">tls</span><span class="op" id="5465370">.</span><span class="ident" id="5465371">X509KeyPair</span><span class="op" id="5465382">(</span><span class="ident" id="5465383">localhostCert</span><span class="op" id="5465396">,</span>&nbsp;<span class="ident" id="5465398">localhostKey</span><span class="op" id="5465410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465413">if</span>&nbsp;<span class="ident" id="5465416">err</span>&nbsp;<span class="op" id="5465420">!=</span>&nbsp;<span class="ident" id="5465423">nil</span>&nbsp;<span class="op" id="5465427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5465431">panic</span><span class="op" id="5465436">(</span><span class="ident" id="5465437">fmt</span><span class="op" id="5465440">.</span><span class="ident" id="5465441">Sprintf</span><span class="op" id="5465448">(</span><span class="string" id="5465449">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="5465477">,</span>&nbsp;<span class="ident" id="5465479">err</span><span class="op" id="5465482">)</span><span class="op" id="5465483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465486">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465490">existingConfig</span>&nbsp;<span class="op" id="5465505">:=</span>&nbsp;<span class="ident" id="5465508">s</span><span class="op" id="5465509">.</span><span class="ident" id="5465510">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465515">s</span><span class="op" id="5465516">.</span><span class="ident" id="5465517">TLS</span>&nbsp;<span class="op" id="5465521">=</span>&nbsp;<span class="builtinfunc" id="5465523">new</span><span class="op" id="5465526">(</span><span class="ident" id="5465527">tls</span><span class="op" id="5465530">.</span><span class="ident" id="5465531">Config</span><span class="op" id="5465537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465540">if</span>&nbsp;<span class="ident" id="5465543">existingConfig</span>&nbsp;<span class="op" id="5465558">!=</span>&nbsp;<span class="ident" id="5465561">nil</span>&nbsp;<span class="op" id="5465565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465569">*</span><span class="ident" id="5465570">s</span><span class="op" id="5465571">.</span><span class="ident" id="5465572">TLS</span>&nbsp;<span class="op" id="5465576">=</span>&nbsp;<span class="op" id="5465578">*</span><span class="ident" id="5465579">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465598">if</span>&nbsp;<span class="ident" id="5465601">s</span><span class="op" id="5465602">.</span><span class="ident" id="5465603">TLS</span><span class="op" id="5465606">.</span><span class="ident" id="5465607">NextProtos</span>&nbsp;<span class="op" id="5465618">==</span>&nbsp;<span class="ident" id="5465621">nil</span>&nbsp;<span class="op" id="5465625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465629">s</span><span class="op" id="5465630">.</span><span class="ident" id="5465631">TLS</span><span class="op" id="5465634">.</span><span class="ident" id="5465635">NextProtos</span>&nbsp;<span class="op" id="5465646">=</span>&nbsp;<span class="op" id="5465648">[</span><span class="op" id="5465649">]</span><span class="builtintype" id="5465650">string</span><span class="op" id="5465656">{</span><span class="string" id="5465657">&#34;http/1.1&#34;</span><span class="op" id="5465667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465673">if</span>&nbsp;<span class="builtinfunc" id="5465676">len</span><span class="op" id="5465679">(</span><span class="ident" id="5465680">s</span><span class="op" id="5465681">.</span><span class="ident" id="5465682">TLS</span><span class="op" id="5465685">.</span><span class="ident" id="5465686">Certificates</span><span class="op" id="5465698">)</span>&nbsp;<span class="op" id="5465700">==</span>&nbsp;<span class="num" id="5465703">0</span>&nbsp;<span class="op" id="5465705">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465709">s</span><span class="op" id="5465710">.</span><span class="ident" id="5465711">TLS</span><span class="op" id="5465714">.</span><span class="ident" id="5465715">Certificates</span>&nbsp;<span class="op" id="5465728">=</span>&nbsp;<span class="op" id="5465730">[</span><span class="op" id="5465731">]</span><span class="ident" id="5465732">tls</span><span class="op" id="5465735">.</span><span class="ident" id="5465736">Certificate</span><span class="op" id="5465747">{</span><span class="ident" id="5465748">cert</span><span class="op" id="5465752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465758">tlsListener</span>&nbsp;<span class="op" id="5465770">:=</span>&nbsp;<span class="ident" id="5465773">tls</span><span class="op" id="5465776">.</span><span class="ident" id="5465777">NewListener</span><span class="op" id="5465788">(</span><span class="ident" id="5465789">s</span><span class="op" id="5465790">.</span><span class="ident" id="5465791">Listener</span><span class="op" id="5465799">,</span>&nbsp;<span class="ident" id="5465801">s</span><span class="op" id="5465802">.</span><span class="ident" id="5465803">TLS</span><span class="op" id="5465806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465810">s</span><span class="op" id="5465811">.</span><span class="ident" id="5465812">Listener</span>&nbsp;<span class="op" id="5465821">=</span>&nbsp;<span class="op" id="5465823">&amp;</span><span class="ident" id="5465824">historyListener</span><span class="op" id="5465839">{</span><span class="ident" id="5465840">Listener</span><span class="op" id="5465848">:</span>&nbsp;<span class="ident" id="5465850">tlsListener</span><span class="op" id="5465861">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465864">s</span><span class="op" id="5465865">.</span><span class="ident" id="5465866">URL</span>&nbsp;<span class="op" id="5465870">=</span>&nbsp;<span class="string" id="5465872">&#34;https://&#34;</span>&nbsp;<span class="op" id="5465883">+</span>&nbsp;<span class="ident" id="5465885">s</span><span class="op" id="5465886">.</span><span class="ident" id="5465887">Listener</span><span class="op" id="5465895">.</span><span class="ident" id="5465896">Addr</span><span class="op" id="5465900">(</span><span class="op" id="5465901">)</span><span class="op" id="5465902">.</span><span class="ident" id="5465903">String</span><span class="op" id="5465909">(</span><span class="op" id="5465910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465913">s</span><span class="op" id="5465914">.</span><span class="ident" id="5465915">wrapHandler</span><span class="op" id="5465926">(</span><span class="op" id="5465927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465930">go</span>&nbsp;<span class="ident" id="5465933">s</span><span class="op" id="5465934">.</span><span class="ident" id="5465935">Config</span><span class="op" id="5465941">.</span><span class="ident" id="5465942">Serve</span><span class="op" id="5465947">(</span><span class="ident" id="5465948">s</span><span class="op" id="5465949">.</span><span class="ident" id="5465950">Listener</span><span class="op" id="5465958">)</span><br>
<span class="lineno"></span><span class="op" id="5465960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5465963">func</span>&nbsp;<span class="op" id="5465968">(</span><span class="ident" id="5465969">s</span>&nbsp;<span class="op" id="5465971">*</span><span class="ident" id="5465972">Server</span><span class="op" id="5465978">)</span>&nbsp;<span class="ident" id="5465980">wrapHandler</span><span class="op" id="5465991">(</span><span class="op" id="5465992">)</span>&nbsp;<span class="op" id="5465994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465997">h</span>&nbsp;<span class="op" id="5465999">:=</span>&nbsp;<span class="ident" id="5466002">s</span><span class="op" id="5466003">.</span><span class="ident" id="5466004">Config</span><span class="op" id="5466010">.</span><span class="ident" id="5466011">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466020">if</span>&nbsp;<span class="ident" id="5466023">h</span>&nbsp;<span class="op" id="5466025">==</span>&nbsp;<span class="ident" id="5466028">nil</span>&nbsp;<span class="op" id="5466032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466036">h</span>&nbsp;<span class="op" id="5466038">=</span>&nbsp;<span class="ident" id="5466040">http</span><span class="op" id="5466044">.</span><span class="ident" id="5466045">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466062">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466065">s</span><span class="op" id="5466066">.</span><span class="ident" id="5466067">Config</span><span class="op" id="5466073">.</span><span class="ident" id="5466074">Handler</span>&nbsp;<span class="op" id="5466082">=</span>&nbsp;<span class="op" id="5466084">&amp;</span><span class="ident" id="5466085">waitGroupHandler</span><span class="op" id="5466101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466105">s</span><span class="op" id="5466106">:</span>&nbsp;<span class="ident" id="5466108">s</span><span class="op" id="5466109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466113">h</span><span class="op" id="5466114">:</span>&nbsp;<span class="ident" id="5466116">h</span><span class="op" id="5466117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466120">}</span><br>
<span class="lineno"></span><span class="op" id="5466122">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5466125">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="5466184">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5466248">func</span>&nbsp;<span class="ident" id="5466253">NewTLSServer</span><span class="op" id="5466265">(</span><span class="ident" id="5466266">handler</span>&nbsp;<span class="ident" id="5466274">http</span><span class="op" id="5466278">.</span><span class="ident" id="5466279">Handler</span><span class="op" id="5466286">)</span>&nbsp;<span class="op" id="5466288">*</span><span class="ident" id="5466289">Server</span>&nbsp;<span class="op" id="5466296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466299">ts</span>&nbsp;<span class="op" id="5466302">:=</span>&nbsp;<span class="ident" id="5466305">NewUnstartedServer</span><span class="op" id="5466323">(</span><span class="ident" id="5466324">handler</span><span class="op" id="5466331">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466334">ts</span><span class="op" id="5466336">.</span><span class="ident" id="5466337">StartTLS</span><span class="op" id="5466345">(</span><span class="op" id="5466346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466349">return</span>&nbsp;<span class="ident" id="5466356">ts</span><br>
<span class="lineno"></span><span class="op" id="5466359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5466362">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="5466426">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5466469">func</span>&nbsp;<span class="op" id="5466474">(</span><span class="ident" id="5466475">s</span>&nbsp;<span class="op" id="5466477">*</span><span class="ident" id="5466478">Server</span><span class="op" id="5466484">)</span>&nbsp;<span class="ident" id="5466486">Close</span><span class="op" id="5466491">(</span><span class="op" id="5466492">)</span>&nbsp;<span class="op" id="5466494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466497">s</span><span class="op" id="5466498">.</span><span class="ident" id="5466499">Listener</span><span class="op" id="5466507">.</span><span class="ident" id="5466508">Close</span><span class="op" id="5466513">(</span><span class="op" id="5466514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466517">s</span><span class="op" id="5466518">.</span><span class="ident" id="5466519">wg</span><span class="op" id="5466521">.</span><span class="ident" id="5466522">Wait</span><span class="op" id="5466526">(</span><span class="op" id="5466527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466530">s</span><span class="op" id="5466531">.</span><span class="ident" id="5466532">CloseClientConnections</span><span class="op" id="5466554">(</span><span class="op" id="5466555">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466558">if</span>&nbsp;<span class="ident" id="5466561">t</span><span class="op" id="5466562">,</span>&nbsp;<span class="ident" id="5466564">ok</span>&nbsp;<span class="op" id="5466567">:=</span>&nbsp;<span class="ident" id="5466570">http</span><span class="op" id="5466574">.</span><span class="ident" id="5466575">DefaultTransport</span><span class="op" id="5466591">.</span><span class="op" id="5466592">(</span><span class="op" id="5466593">*</span><span class="ident" id="5466594">http</span><span class="op" id="5466598">.</span><span class="ident" id="5466599">Transport</span><span class="op" id="5466608">)</span><span class="op" id="5466609">;</span>&nbsp;<span class="ident" id="5466611">ok</span>&nbsp;<span class="op" id="5466614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466618">t</span><span class="op" id="5466619">.</span><span class="ident" id="5466620">CloseIdleConnections</span><span class="op" id="5466640">(</span><span class="op" id="5466641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466644">}</span><br>
<span class="lineno"></span><span class="op" id="5466646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5466649">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="5466718">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5466741">func</span>&nbsp;<span class="op" id="5466746">(</span><span class="ident" id="5466747">s</span>&nbsp;<span class="op" id="5466749">*</span><span class="ident" id="5466750">Server</span><span class="op" id="5466756">)</span>&nbsp;<span class="ident" id="5466758">CloseClientConnections</span><span class="op" id="5466780">(</span><span class="op" id="5466781">)</span>&nbsp;<span class="op" id="5466783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466786">hl</span><span class="op" id="5466788">,</span>&nbsp;<span class="ident" id="5466790">ok</span>&nbsp;<span class="op" id="5466793">:=</span>&nbsp;<span class="ident" id="5466796">s</span><span class="op" id="5466797">.</span><span class="ident" id="5466798">Listener</span><span class="op" id="5466806">.</span><span class="op" id="5466807">(</span><span class="op" id="5466808">*</span><span class="ident" id="5466809">historyListener</span><span class="op" id="5466824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466827">if</span>&nbsp;<span class="op" id="5466830">!</span><span class="ident" id="5466831">ok</span>&nbsp;<span class="op" id="5466834">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466838">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466849">hl</span><span class="op" id="5466851">.</span><span class="ident" id="5466852">Lock</span><span class="op" id="5466856">(</span><span class="op" id="5466857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466860">for</span>&nbsp;<span class="ident" id="5466864">_</span><span class="op" id="5466865">,</span>&nbsp;<span class="ident" id="5466867">conn</span>&nbsp;<span class="op" id="5466872">:=</span>&nbsp;<span class="keyword" id="5466875">range</span>&nbsp;<span class="ident" id="5466881">hl</span><span class="op" id="5466883">.</span><span class="ident" id="5466884">history</span>&nbsp;<span class="op" id="5466892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466896">conn</span><span class="op" id="5466900">.</span><span class="ident" id="5466901">Close</span><span class="op" id="5466906">(</span><span class="op" id="5466907">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466913">hl</span><span class="op" id="5466915">.</span><span class="ident" id="5466916">Unlock</span><span class="op" id="5466922">(</span><span class="op" id="5466923">)</span><br>
<span class="lineno"></span><span class="op" id="5466925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5466928">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="5466997">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="5467064">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="5467108">type</span>&nbsp;<span class="ident" id="5467113">waitGroupHandler</span>&nbsp;<span class="keyword" id="5467130">struct</span>&nbsp;<span class="op" id="5467137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467140">s</span>&nbsp;<span class="op" id="5467142">*</span><span class="ident" id="5467143">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467151">h</span>&nbsp;<span class="ident" id="5467153">http</span><span class="op" id="5467157">.</span><span class="ident" id="5467158">Handler</span>&nbsp;<span class="comment" id="5467166">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="5467177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5467180">func</span>&nbsp;<span class="op" id="5467185">(</span><span class="ident" id="5467186">h</span>&nbsp;<span class="op" id="5467188">*</span><span class="ident" id="5467189">waitGroupHandler</span><span class="op" id="5467205">)</span>&nbsp;<span class="ident" id="5467207">ServeHTTP</span><span class="op" id="5467216">(</span><span class="ident" id="5467217">w</span>&nbsp;<span class="ident" id="5467219">http</span><span class="op" id="5467223">.</span><span class="ident" id="5467224">ResponseWriter</span><span class="op" id="5467238">,</span>&nbsp;<span class="ident" id="5467240">r</span>&nbsp;<span class="op" id="5467242">*</span><span class="ident" id="5467243">http</span><span class="op" id="5467247">.</span><span class="ident" id="5467248">Request</span><span class="op" id="5467255">)</span>&nbsp;<span class="op" id="5467257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467260">h</span><span class="op" id="5467261">.</span><span class="ident" id="5467262">s</span><span class="op" id="5467263">.</span><span class="ident" id="5467264">wg</span><span class="op" id="5467266">.</span><span class="ident" id="5467267">Add</span><span class="op" id="5467270">(</span><span class="num" id="5467271">1</span><span class="op" id="5467272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467275">defer</span>&nbsp;<span class="ident" id="5467281">h</span><span class="op" id="5467282">.</span><span class="ident" id="5467283">s</span><span class="op" id="5467284">.</span><span class="ident" id="5467285">wg</span><span class="op" id="5467287">.</span><span class="ident" id="5467288">Done</span><span class="op" id="5467292">(</span><span class="op" id="5467293">)</span>&nbsp;<span class="comment" id="5467295">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467339">h</span><span class="op" id="5467340">.</span><span class="ident" id="5467341">h</span><span class="op" id="5467342">.</span><span class="ident" id="5467343">ServeHTTP</span><span class="op" id="5467352">(</span><span class="ident" id="5467353">w</span><span class="op" id="5467354">,</span>&nbsp;<span class="ident" id="5467356">r</span><span class="op" id="5467357">)</span><br>
<span class="lineno"></span><span class="op" id="5467359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5467362">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="5467418">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="5467491">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="5467510">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="5467544">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="5467680">var</span>&nbsp;<span class="ident" id="5467684">localhostCert</span>&nbsp;<span class="op" id="5467698">=</span>&nbsp;<span class="op" id="5467700">[</span><span class="op" id="5467701">]</span><span class="builtintype" id="5467702">byte</span><span class="op" id="5467706">(</span><span class="string" id="5467707">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="5468278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5468281">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="5468335">var</span>&nbsp;<span class="ident" id="5468339">localhostKey</span>&nbsp;<span class="op" id="5468352">=</span>&nbsp;<span class="op" id="5468354">[</span><span class="op" id="5468355">]</span><span class="builtintype" id="5468356">byte</span><span class="op" id="5468360">(</span><span class="string" id="5468361">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="5468859">)</span>
</div>
</body>
</html>
