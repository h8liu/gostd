<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html" class="current">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3108288">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3108344">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3108398">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3108449">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3108527">package</span>&nbsp;<span class="ident" id="3108535">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3108540">import</span>&nbsp;<span class="op" id="3108547">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3108550">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3108561">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3108568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3108571">//&nbsp;BUG(mikio):&nbsp;On&nbsp;every&nbsp;POSIX&nbsp;platform,&nbsp;reads&nbsp;from&nbsp;the&nbsp;&#34;ip4&#34;&nbsp;network</span><br>
<span class="lineno">15</span><span class="comment" id="3108640">//&nbsp;using&nbsp;the&nbsp;ReadFrom&nbsp;or&nbsp;ReadFromIP&nbsp;method&nbsp;might&nbsp;not&nbsp;return&nbsp;a&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment" id="3108711">//&nbsp;IPv4&nbsp;packet,&nbsp;including&nbsp;its&nbsp;header,&nbsp;even&nbsp;if&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span><span class="comment" id="3108772">//&nbsp;available.&nbsp;This&nbsp;can&nbsp;occur&nbsp;even&nbsp;in&nbsp;cases&nbsp;where&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="3108839">//&nbsp;could&nbsp;return&nbsp;a&nbsp;complete&nbsp;packet.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;it&nbsp;is&nbsp;recommended</span><br>
<span class="lineno"></span><span class="comment" id="3108909">//&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;uses&nbsp;these&nbsp;methods&nbsp;if&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;receive&nbsp;a</span><br>
<span class="lineno">20</span><span class="comment" id="3108979">//&nbsp;full&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="3108995">//</span><br>
<span class="lineno"></span><span class="comment" id="3108998">//&nbsp;The&nbsp;Go&nbsp;1&nbsp;compatibility&nbsp;guidelines&nbsp;make&nbsp;it&nbsp;impossible&nbsp;for&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3109064">//&nbsp;change&nbsp;the&nbsp;behavior&nbsp;of&nbsp;these&nbsp;methods;&nbsp;use&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="3109127">//&nbsp;instead.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3109140">func</span>&nbsp;<span class="ident" id="3109145">sockaddrToIP</span><span class="op" id="3109157">(</span><span class="ident" id="3109158">sa</span>&nbsp;<span class="ident" id="3109161">syscall</span><span class="op" id="3109168">.</span><span class="ident" id="3109169">Sockaddr</span><span class="op" id="3109177">)</span>&nbsp;<span class="ident" id="3109179">Addr</span>&nbsp;<span class="op" id="3109184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109187">switch</span>&nbsp;<span class="ident" id="3109194">sa</span>&nbsp;<span class="op" id="3109197">:=</span>&nbsp;<span class="ident" id="3109200">sa</span><span class="op" id="3109202">.</span><span class="op" id="3109203">(</span><span class="keyword" id="3109204">type</span><span class="op" id="3109208">)</span>&nbsp;<span class="op" id="3109210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109213">case</span>&nbsp;<span class="op" id="3109218">*</span><span class="ident" id="3109219">syscall</span><span class="op" id="3109226">.</span><span class="ident" id="3109227">SockaddrInet4</span><span class="op" id="3109240">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109244">return</span>&nbsp;<span class="op" id="3109251">&amp;</span><span class="ident" id="3109252">IPAddr</span><span class="op" id="3109258">{</span><span class="ident" id="3109259">IP</span><span class="op" id="3109261">:</span>&nbsp;<span class="ident" id="3109263">sa</span><span class="op" id="3109265">.</span><span class="ident" id="3109266">Addr</span><span class="op" id="3109270">[</span><span class="num" id="3109271">0</span><span class="op" id="3109272">:</span><span class="op" id="3109273">]</span><span class="op" id="3109274">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109277">case</span>&nbsp;<span class="op" id="3109282">*</span><span class="ident" id="3109283">syscall</span><span class="op" id="3109290">.</span><span class="ident" id="3109291">SockaddrInet6</span><span class="op" id="3109304">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109308">return</span>&nbsp;<span class="op" id="3109315">&amp;</span><span class="ident" id="3109316">IPAddr</span><span class="op" id="3109322">{</span><span class="ident" id="3109323">IP</span><span class="op" id="3109325">:</span>&nbsp;<span class="ident" id="3109327">sa</span><span class="op" id="3109329">.</span><span class="ident" id="3109330">Addr</span><span class="op" id="3109334">[</span><span class="num" id="3109335">0</span><span class="op" id="3109336">:</span><span class="op" id="3109337">]</span><span class="op" id="3109338">,</span>&nbsp;<span class="ident" id="3109340">Zone</span><span class="op" id="3109344">:</span>&nbsp;<span class="ident" id="3109346">zoneToString</span><span class="op" id="3109358">(</span><span class="builtintype" id="3109359">int</span><span class="op" id="3109362">(</span><span class="ident" id="3109363">sa</span><span class="op" id="3109365">.</span><span class="ident" id="3109366">ZoneId</span><span class="op" id="3109372">)</span><span class="op" id="3109373">)</span><span class="op" id="3109374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109380">return</span>&nbsp;<span class="ident" id="3109387">nil</span><br>
<span class="lineno"></span><span class="op" id="3109391">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3109394">func</span>&nbsp;<span class="op" id="3109399">(</span><span class="ident" id="3109400">a</span>&nbsp;<span class="op" id="3109402">*</span><span class="ident" id="3109403">IPAddr</span><span class="op" id="3109409">)</span>&nbsp;<span class="ident" id="3109411">family</span><span class="op" id="3109417">(</span><span class="op" id="3109418">)</span>&nbsp;<span class="builtintype" id="3109420">int</span>&nbsp;<span class="op" id="3109424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109427">if</span>&nbsp;<span class="ident" id="3109430">a</span>&nbsp;<span class="op" id="3109432">==</span>&nbsp;<span class="ident" id="3109435">nil</span>&nbsp;<span class="op" id="3109439">||</span>&nbsp;<span class="builtinfunc" id="3109442">len</span><span class="op" id="3109445">(</span><span class="ident" id="3109446">a</span><span class="op" id="3109447">.</span><span class="ident" id="3109448">IP</span><span class="op" id="3109450">)</span>&nbsp;<span class="op" id="3109452">&lt;=</span>&nbsp;<span class="ident" id="3109455">IPv4len</span>&nbsp;<span class="op" id="3109463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109467">return</span>&nbsp;<span class="ident" id="3109474">syscall</span><span class="op" id="3109481">.</span><span class="ident" id="3109482">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109491">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109494">if</span>&nbsp;<span class="ident" id="3109497">a</span><span class="op" id="3109498">.</span><span class="ident" id="3109499">IP</span><span class="op" id="3109501">.</span><span class="ident" id="3109502">To4</span><span class="op" id="3109505">(</span><span class="op" id="3109506">)</span>&nbsp;<span class="op" id="3109508">!=</span>&nbsp;<span class="ident" id="3109511">nil</span>&nbsp;<span class="op" id="3109515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109519">return</span>&nbsp;<span class="ident" id="3109526">syscall</span><span class="op" id="3109533">.</span><span class="ident" id="3109534">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109546">return</span>&nbsp;<span class="ident" id="3109553">syscall</span><span class="op" id="3109560">.</span><span class="ident" id="3109561">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3109570">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="3109573">func</span>&nbsp;<span class="op" id="3109578">(</span><span class="ident" id="3109579">a</span>&nbsp;<span class="op" id="3109581">*</span><span class="ident" id="3109582">IPAddr</span><span class="op" id="3109588">)</span>&nbsp;<span class="ident" id="3109590">isWildcard</span><span class="op" id="3109600">(</span><span class="op" id="3109601">)</span>&nbsp;<span class="builtintype" id="3109603">bool</span>&nbsp;<span class="op" id="3109608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109611">if</span>&nbsp;<span class="ident" id="3109614">a</span>&nbsp;<span class="op" id="3109616">==</span>&nbsp;<span class="ident" id="3109619">nil</span>&nbsp;<span class="op" id="3109623">||</span>&nbsp;<span class="ident" id="3109626">a</span><span class="op" id="3109627">.</span><span class="ident" id="3109628">IP</span>&nbsp;<span class="op" id="3109631">==</span>&nbsp;<span class="ident" id="3109634">nil</span>&nbsp;<span class="op" id="3109638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109642">return</span>&nbsp;<span class="builtintype" id="3109649">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109655">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109658">return</span>&nbsp;<span class="ident" id="3109665">a</span><span class="op" id="3109666">.</span><span class="ident" id="3109667">IP</span><span class="op" id="3109669">.</span><span class="ident" id="3109670">IsUnspecified</span><span class="op" id="3109683">(</span><span class="op" id="3109684">)</span><br>
<span class="lineno"></span><span class="op" id="3109686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3109689">func</span>&nbsp;<span class="op" id="3109694">(</span><span class="ident" id="3109695">a</span>&nbsp;<span class="op" id="3109697">*</span><span class="ident" id="3109698">IPAddr</span><span class="op" id="3109704">)</span>&nbsp;<span class="ident" id="3109706">sockaddr</span><span class="op" id="3109714">(</span><span class="ident" id="3109715">family</span>&nbsp;<span class="builtintype" id="3109722">int</span><span class="op" id="3109725">)</span>&nbsp;<span class="op" id="3109727">(</span><span class="ident" id="3109728">syscall</span><span class="op" id="3109735">.</span><span class="ident" id="3109736">Sockaddr</span><span class="op" id="3109744">,</span>&nbsp;<span class="builtintype" id="3109746">error</span><span class="op" id="3109751">)</span>&nbsp;<span class="op" id="3109753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109756">if</span>&nbsp;<span class="ident" id="3109759">a</span>&nbsp;<span class="op" id="3109761">==</span>&nbsp;<span class="ident" id="3109764">nil</span>&nbsp;<span class="op" id="3109768">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109772">return</span>&nbsp;<span class="ident" id="3109779">nil</span><span class="op" id="3109782">,</span>&nbsp;<span class="ident" id="3109784">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3109789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3109792">return</span>&nbsp;<span class="ident" id="3109799">ipToSockaddr</span><span class="op" id="3109811">(</span><span class="ident" id="3109812">family</span><span class="op" id="3109818">,</span>&nbsp;<span class="ident" id="3109820">a</span><span class="op" id="3109821">.</span><span class="ident" id="3109822">IP</span><span class="op" id="3109824">,</span>&nbsp;<span class="num" id="3109826">0</span><span class="op" id="3109827">,</span>&nbsp;<span class="ident" id="3109829">a</span><span class="op" id="3109830">.</span><span class="ident" id="3109831">Zone</span><span class="op" id="3109835">)</span><br>
<span class="lineno"></span><span class="op" id="3109837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3109840">//&nbsp;IPConn&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;and&nbsp;PacketConn&nbsp;interfaces</span><br>
<span class="lineno"></span><span class="comment" id="3109910">//&nbsp;for&nbsp;IP&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3109941">type</span>&nbsp;<span class="ident" id="3109946">IPConn</span>&nbsp;<span class="keyword" id="3109953">struct</span>&nbsp;<span class="op" id="3109960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3109963">conn</span><br>
<span class="lineno"></span><span class="op" id="3109968">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3109971">func</span>&nbsp;<span class="ident" id="3109976">newIPConn</span><span class="op" id="3109985">(</span><span class="ident" id="3109986">fd</span>&nbsp;<span class="op" id="3109989">*</span><span class="ident" id="3109990">netFD</span><span class="op" id="3109995">)</span>&nbsp;<span class="op" id="3109997">*</span><span class="ident" id="3109998">IPConn</span>&nbsp;<span class="op" id="3110005">{</span>&nbsp;<span class="keyword" id="3110007">return</span>&nbsp;<span class="op" id="3110014">&amp;</span><span class="ident" id="3110015">IPConn</span><span class="op" id="3110021">{</span><span class="ident" id="3110022">conn</span><span class="op" id="3110026">{</span><span class="ident" id="3110027">fd</span><span class="op" id="3110029">}</span><span class="op" id="3110030">}</span>&nbsp;<span class="op" id="3110032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3110035">//&nbsp;ReadFromIP&nbsp;reads&nbsp;an&nbsp;IP&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="3110104">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b&nbsp;and&nbsp;the&nbsp;return&nbsp;address</span><br>
<span class="lineno">70</span><span class="comment" id="3110175">//&nbsp;that&nbsp;was&nbsp;on&nbsp;the&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="3110202">//</span><br>
<span class="lineno"></span><span class="comment" id="3110205">//&nbsp;ReadFromIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3110268">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3110335">//&nbsp;SetReadDeadline.</span><br>
<span class="lineno">75</span><span class="keyword" id="3110355">func</span>&nbsp;<span class="op" id="3110360">(</span><span class="ident" id="3110361">c</span>&nbsp;<span class="op" id="3110363">*</span><span class="ident" id="3110364">IPConn</span><span class="op" id="3110370">)</span>&nbsp;<span class="ident" id="3110372">ReadFromIP</span><span class="op" id="3110382">(</span><span class="ident" id="3110383">b</span>&nbsp;<span class="op" id="3110385">[</span><span class="op" id="3110386">]</span><span class="builtintype" id="3110387">byte</span><span class="op" id="3110391">)</span>&nbsp;<span class="op" id="3110393">(</span><span class="builtintype" id="3110394">int</span><span class="op" id="3110397">,</span>&nbsp;<span class="op" id="3110399">*</span><span class="ident" id="3110400">IPAddr</span><span class="op" id="3110406">,</span>&nbsp;<span class="builtintype" id="3110408">error</span><span class="op" id="3110413">)</span>&nbsp;<span class="op" id="3110415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110418">if</span>&nbsp;<span class="op" id="3110421">!</span><span class="ident" id="3110422">c</span><span class="op" id="3110423">.</span><span class="ident" id="3110424">ok</span><span class="op" id="3110426">(</span><span class="op" id="3110427">)</span>&nbsp;<span class="op" id="3110429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110433">return</span>&nbsp;<span class="num" id="3110440">0</span><span class="op" id="3110441">,</span>&nbsp;<span class="ident" id="3110443">nil</span><span class="op" id="3110446">,</span>&nbsp;<span class="ident" id="3110448">syscall</span><span class="op" id="3110455">.</span><span class="ident" id="3110456">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3110467">//&nbsp;TODO(cw,rsc):&nbsp;consider&nbsp;using&nbsp;readv&nbsp;if&nbsp;we&nbsp;know&nbsp;the&nbsp;family</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3110528">//&nbsp;type&nbsp;to&nbsp;avoid&nbsp;the&nbsp;header&nbsp;trim/copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110567">var</span>&nbsp;<span class="ident" id="3110571">addr</span>&nbsp;<span class="op" id="3110576">*</span><span class="ident" id="3110577">IPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110585">n</span><span class="op" id="3110586">,</span>&nbsp;<span class="ident" id="3110588">sa</span><span class="op" id="3110590">,</span>&nbsp;<span class="ident" id="3110592">err</span>&nbsp;<span class="op" id="3110596">:=</span>&nbsp;<span class="ident" id="3110599">c</span><span class="op" id="3110600">.</span><span class="ident" id="3110601">fd</span><span class="op" id="3110603">.</span><span class="ident" id="3110604">readFrom</span><span class="op" id="3110612">(</span><span class="ident" id="3110613">b</span><span class="op" id="3110614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110617">switch</span>&nbsp;<span class="ident" id="3110624">sa</span>&nbsp;<span class="op" id="3110627">:=</span>&nbsp;<span class="ident" id="3110630">sa</span><span class="op" id="3110632">.</span><span class="op" id="3110633">(</span><span class="keyword" id="3110634">type</span><span class="op" id="3110638">)</span>&nbsp;<span class="op" id="3110640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110643">case</span>&nbsp;<span class="op" id="3110648">*</span><span class="ident" id="3110649">syscall</span><span class="op" id="3110656">.</span><span class="ident" id="3110657">SockaddrInet4</span><span class="op" id="3110670">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110674">addr</span>&nbsp;<span class="op" id="3110679">=</span>&nbsp;<span class="op" id="3110681">&amp;</span><span class="ident" id="3110682">IPAddr</span><span class="op" id="3110688">{</span><span class="ident" id="3110689">IP</span><span class="op" id="3110691">:</span>&nbsp;<span class="ident" id="3110693">sa</span><span class="op" id="3110695">.</span><span class="ident" id="3110696">Addr</span><span class="op" id="3110700">[</span><span class="num" id="3110701">0</span><span class="op" id="3110702">:</span><span class="op" id="3110703">]</span><span class="op" id="3110704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110708">if</span>&nbsp;<span class="builtinfunc" id="3110711">len</span><span class="op" id="3110714">(</span><span class="ident" id="3110715">b</span><span class="op" id="3110716">)</span>&nbsp;<span class="op" id="3110718">&gt;=</span>&nbsp;<span class="ident" id="3110721">IPv4len</span>&nbsp;<span class="op" id="3110729">{</span>&nbsp;<span class="comment" id="3110731">//&nbsp;discard&nbsp;ipv4&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110757">hsize</span>&nbsp;<span class="op" id="3110763">:=</span>&nbsp;<span class="op" id="3110766">(</span><span class="builtintype" id="3110767">int</span><span class="op" id="3110770">(</span><span class="ident" id="3110771">b</span><span class="op" id="3110772">[</span><span class="num" id="3110773">0</span><span class="op" id="3110774">]</span><span class="op" id="3110775">)</span>&nbsp;<span class="op" id="3110777">&amp;</span>&nbsp;<span class="num" id="3110779">0xf</span><span class="op" id="3110782">)</span>&nbsp;<span class="op" id="3110784">*</span>&nbsp;<span class="num" id="3110786">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3110791">copy</span><span class="op" id="3110795">(</span><span class="ident" id="3110796">b</span><span class="op" id="3110797">,</span>&nbsp;<span class="ident" id="3110799">b</span><span class="op" id="3110800">[</span><span class="ident" id="3110801">hsize</span><span class="op" id="3110806">:</span><span class="op" id="3110807">]</span><span class="op" id="3110808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110813">n</span>&nbsp;<span class="op" id="3110815">-=</span>&nbsp;<span class="ident" id="3110818">hsize</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110829">case</span>&nbsp;<span class="op" id="3110834">*</span><span class="ident" id="3110835">syscall</span><span class="op" id="3110842">.</span><span class="ident" id="3110843">SockaddrInet6</span><span class="op" id="3110856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3110860">addr</span>&nbsp;<span class="op" id="3110865">=</span>&nbsp;<span class="op" id="3110867">&amp;</span><span class="ident" id="3110868">IPAddr</span><span class="op" id="3110874">{</span><span class="ident" id="3110875">IP</span><span class="op" id="3110877">:</span>&nbsp;<span class="ident" id="3110879">sa</span><span class="op" id="3110881">.</span><span class="ident" id="3110882">Addr</span><span class="op" id="3110886">[</span><span class="num" id="3110887">0</span><span class="op" id="3110888">:</span><span class="op" id="3110889">]</span><span class="op" id="3110890">,</span>&nbsp;<span class="ident" id="3110892">Zone</span><span class="op" id="3110896">:</span>&nbsp;<span class="ident" id="3110898">zoneToString</span><span class="op" id="3110910">(</span><span class="builtintype" id="3110911">int</span><span class="op" id="3110914">(</span><span class="ident" id="3110915">sa</span><span class="op" id="3110917">.</span><span class="ident" id="3110918">ZoneId</span><span class="op" id="3110924">)</span><span class="op" id="3110925">)</span><span class="op" id="3110926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3110929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3110932">return</span>&nbsp;<span class="ident" id="3110939">n</span><span class="op" id="3110940">,</span>&nbsp;<span class="ident" id="3110942">addr</span><span class="op" id="3110946">,</span>&nbsp;<span class="ident" id="3110948">err</span><br>
<span class="lineno">95</span><span class="op" id="3110952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3110955">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3111010">func</span>&nbsp;<span class="op" id="3111015">(</span><span class="ident" id="3111016">c</span>&nbsp;<span class="op" id="3111018">*</span><span class="ident" id="3111019">IPConn</span><span class="op" id="3111025">)</span>&nbsp;<span class="ident" id="3111027">ReadFrom</span><span class="op" id="3111035">(</span><span class="ident" id="3111036">b</span>&nbsp;<span class="op" id="3111038">[</span><span class="op" id="3111039">]</span><span class="builtintype" id="3111040">byte</span><span class="op" id="3111044">)</span>&nbsp;<span class="op" id="3111046">(</span><span class="builtintype" id="3111047">int</span><span class="op" id="3111050">,</span>&nbsp;<span class="ident" id="3111052">Addr</span><span class="op" id="3111056">,</span>&nbsp;<span class="builtintype" id="3111058">error</span><span class="op" id="3111063">)</span>&nbsp;<span class="op" id="3111065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111068">if</span>&nbsp;<span class="op" id="3111071">!</span><span class="ident" id="3111072">c</span><span class="op" id="3111073">.</span><span class="ident" id="3111074">ok</span><span class="op" id="3111076">(</span><span class="op" id="3111077">)</span>&nbsp;<span class="op" id="3111079">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111083">return</span>&nbsp;<span class="num" id="3111090">0</span><span class="op" id="3111091">,</span>&nbsp;<span class="ident" id="3111093">nil</span><span class="op" id="3111096">,</span>&nbsp;<span class="ident" id="3111098">syscall</span><span class="op" id="3111105">.</span><span class="ident" id="3111106">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111117">n</span><span class="op" id="3111118">,</span>&nbsp;<span class="ident" id="3111120">addr</span><span class="op" id="3111124">,</span>&nbsp;<span class="ident" id="3111126">err</span>&nbsp;<span class="op" id="3111130">:=</span>&nbsp;<span class="ident" id="3111133">c</span><span class="op" id="3111134">.</span><span class="ident" id="3111135">ReadFromIP</span><span class="op" id="3111145">(</span><span class="ident" id="3111146">b</span><span class="op" id="3111147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111150">return</span>&nbsp;<span class="ident" id="3111157">n</span><span class="op" id="3111158">,</span>&nbsp;<span class="ident" id="3111160">addr</span><span class="op" id="3111164">.</span><span class="ident" id="3111165">toAddr</span><span class="op" id="3111171">(</span><span class="op" id="3111172">)</span><span class="op" id="3111173">,</span>&nbsp;<span class="ident" id="3111175">err</span><br>
<span class="lineno"></span><span class="op" id="3111179">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment" id="3111182">//&nbsp;ReadMsgIP&nbsp;reads&nbsp;a&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3111253">//&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;into&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3111320">//&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;oob,&nbsp;the&nbsp;flags</span><br>
<span class="lineno"></span><span class="comment" id="3111391">//&nbsp;that&nbsp;were&nbsp;set&nbsp;on&nbsp;the&nbsp;packet&nbsp;and&nbsp;the&nbsp;source&nbsp;address&nbsp;of&nbsp;the&nbsp;packet.</span><br>
<span class="lineno">110</span><span class="keyword" id="3111460">func</span>&nbsp;<span class="op" id="3111465">(</span><span class="ident" id="3111466">c</span>&nbsp;<span class="op" id="3111468">*</span><span class="ident" id="3111469">IPConn</span><span class="op" id="3111475">)</span>&nbsp;<span class="ident" id="3111477">ReadMsgIP</span><span class="op" id="3111486">(</span><span class="ident" id="3111487">b</span><span class="op" id="3111488">,</span>&nbsp;<span class="ident" id="3111490">oob</span>&nbsp;<span class="op" id="3111494">[</span><span class="op" id="3111495">]</span><span class="builtintype" id="3111496">byte</span><span class="op" id="3111500">)</span>&nbsp;<span class="op" id="3111502">(</span><span class="ident" id="3111503">n</span><span class="op" id="3111504">,</span>&nbsp;<span class="ident" id="3111506">oobn</span><span class="op" id="3111510">,</span>&nbsp;<span class="ident" id="3111512">flags</span>&nbsp;<span class="builtintype" id="3111518">int</span><span class="op" id="3111521">,</span>&nbsp;<span class="ident" id="3111523">addr</span>&nbsp;<span class="op" id="3111528">*</span><span class="ident" id="3111529">IPAddr</span><span class="op" id="3111535">,</span>&nbsp;<span class="ident" id="3111537">err</span>&nbsp;<span class="builtintype" id="3111541">error</span><span class="op" id="3111546">)</span>&nbsp;<span class="op" id="3111548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111551">if</span>&nbsp;<span class="op" id="3111554">!</span><span class="ident" id="3111555">c</span><span class="op" id="3111556">.</span><span class="ident" id="3111557">ok</span><span class="op" id="3111559">(</span><span class="op" id="3111560">)</span>&nbsp;<span class="op" id="3111562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111566">return</span>&nbsp;<span class="num" id="3111573">0</span><span class="op" id="3111574">,</span>&nbsp;<span class="num" id="3111576">0</span><span class="op" id="3111577">,</span>&nbsp;<span class="num" id="3111579">0</span><span class="op" id="3111580">,</span>&nbsp;<span class="ident" id="3111582">nil</span><span class="op" id="3111585">,</span>&nbsp;<span class="ident" id="3111587">syscall</span><span class="op" id="3111594">.</span><span class="ident" id="3111595">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111606">var</span>&nbsp;<span class="ident" id="3111610">sa</span>&nbsp;<span class="ident" id="3111613">syscall</span><span class="op" id="3111620">.</span><span class="ident" id="3111621">Sockaddr</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111631">n</span><span class="op" id="3111632">,</span>&nbsp;<span class="ident" id="3111634">oobn</span><span class="op" id="3111638">,</span>&nbsp;<span class="ident" id="3111640">flags</span><span class="op" id="3111645">,</span>&nbsp;<span class="ident" id="3111647">sa</span><span class="op" id="3111649">,</span>&nbsp;<span class="ident" id="3111651">err</span>&nbsp;<span class="op" id="3111655">=</span>&nbsp;<span class="ident" id="3111657">c</span><span class="op" id="3111658">.</span><span class="ident" id="3111659">fd</span><span class="op" id="3111661">.</span><span class="ident" id="3111662">readMsg</span><span class="op" id="3111669">(</span><span class="ident" id="3111670">b</span><span class="op" id="3111671">,</span>&nbsp;<span class="ident" id="3111673">oob</span><span class="op" id="3111676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111679">switch</span>&nbsp;<span class="ident" id="3111686">sa</span>&nbsp;<span class="op" id="3111689">:=</span>&nbsp;<span class="ident" id="3111692">sa</span><span class="op" id="3111694">.</span><span class="op" id="3111695">(</span><span class="keyword" id="3111696">type</span><span class="op" id="3111700">)</span>&nbsp;<span class="op" id="3111702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111705">case</span>&nbsp;<span class="op" id="3111710">*</span><span class="ident" id="3111711">syscall</span><span class="op" id="3111718">.</span><span class="ident" id="3111719">SockaddrInet4</span><span class="op" id="3111732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111736">addr</span>&nbsp;<span class="op" id="3111741">=</span>&nbsp;<span class="op" id="3111743">&amp;</span><span class="ident" id="3111744">IPAddr</span><span class="op" id="3111750">{</span><span class="ident" id="3111751">IP</span><span class="op" id="3111753">:</span>&nbsp;<span class="ident" id="3111755">sa</span><span class="op" id="3111757">.</span><span class="ident" id="3111758">Addr</span><span class="op" id="3111762">[</span><span class="num" id="3111763">0</span><span class="op" id="3111764">:</span><span class="op" id="3111765">]</span><span class="op" id="3111766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111769">case</span>&nbsp;<span class="op" id="3111774">*</span><span class="ident" id="3111775">syscall</span><span class="op" id="3111782">.</span><span class="ident" id="3111783">SockaddrInet6</span><span class="op" id="3111796">:</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3111800">addr</span>&nbsp;<span class="op" id="3111805">=</span>&nbsp;<span class="op" id="3111807">&amp;</span><span class="ident" id="3111808">IPAddr</span><span class="op" id="3111814">{</span><span class="ident" id="3111815">IP</span><span class="op" id="3111817">:</span>&nbsp;<span class="ident" id="3111819">sa</span><span class="op" id="3111821">.</span><span class="ident" id="3111822">Addr</span><span class="op" id="3111826">[</span><span class="num" id="3111827">0</span><span class="op" id="3111828">:</span><span class="op" id="3111829">]</span><span class="op" id="3111830">,</span>&nbsp;<span class="ident" id="3111832">Zone</span><span class="op" id="3111836">:</span>&nbsp;<span class="ident" id="3111838">zoneToString</span><span class="op" id="3111850">(</span><span class="builtintype" id="3111851">int</span><span class="op" id="3111854">(</span><span class="ident" id="3111855">sa</span><span class="op" id="3111857">.</span><span class="ident" id="3111858">ZoneId</span><span class="op" id="3111864">)</span><span class="op" id="3111865">)</span><span class="op" id="3111866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3111869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3111872">return</span><br>
<span class="lineno"></span><span class="op" id="3111879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3111882">//&nbsp;WriteToIP&nbsp;writes&nbsp;an&nbsp;IP&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3111950">//&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="3111961">//</span><br>
<span class="lineno"></span><span class="comment" id="3111964">//&nbsp;WriteToIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3112026">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno">130</span><span class="comment" id="3112093">//&nbsp;SetWriteDeadline.&nbsp;&nbsp;On&nbsp;packet-oriented&nbsp;connections,&nbsp;write&nbsp;timeouts</span><br>
<span class="lineno"></span><span class="comment" id="3112162">//&nbsp;are&nbsp;rare.</span><br>
<span class="lineno"></span><span class="keyword" id="3112175">func</span>&nbsp;<span class="op" id="3112180">(</span><span class="ident" id="3112181">c</span>&nbsp;<span class="op" id="3112183">*</span><span class="ident" id="3112184">IPConn</span><span class="op" id="3112190">)</span>&nbsp;<span class="ident" id="3112192">WriteToIP</span><span class="op" id="3112201">(</span><span class="ident" id="3112202">b</span>&nbsp;<span class="op" id="3112204">[</span><span class="op" id="3112205">]</span><span class="builtintype" id="3112206">byte</span><span class="op" id="3112210">,</span>&nbsp;<span class="ident" id="3112212">addr</span>&nbsp;<span class="op" id="3112217">*</span><span class="ident" id="3112218">IPAddr</span><span class="op" id="3112224">)</span>&nbsp;<span class="op" id="3112226">(</span><span class="builtintype" id="3112227">int</span><span class="op" id="3112230">,</span>&nbsp;<span class="builtintype" id="3112232">error</span><span class="op" id="3112237">)</span>&nbsp;<span class="op" id="3112239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112242">if</span>&nbsp;<span class="op" id="3112245">!</span><span class="ident" id="3112246">c</span><span class="op" id="3112247">.</span><span class="ident" id="3112248">ok</span><span class="op" id="3112250">(</span><span class="op" id="3112251">)</span>&nbsp;<span class="op" id="3112253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112257">return</span>&nbsp;<span class="num" id="3112264">0</span><span class="op" id="3112265">,</span>&nbsp;<span class="ident" id="3112267">syscall</span><span class="op" id="3112274">.</span><span class="ident" id="3112275">EINVAL</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112286">if</span>&nbsp;<span class="ident" id="3112289">c</span><span class="op" id="3112290">.</span><span class="ident" id="3112291">fd</span><span class="op" id="3112293">.</span><span class="ident" id="3112294">isConnected</span>&nbsp;<span class="op" id="3112306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112310">return</span>&nbsp;<span class="num" id="3112317">0</span><span class="op" id="3112318">,</span>&nbsp;<span class="op" id="3112320">&amp;</span><span class="ident" id="3112321">OpError</span><span class="op" id="3112328">{</span><span class="ident" id="3112329">Op</span><span class="op" id="3112331">:</span>&nbsp;<span class="string" id="3112333">&#34;write&#34;</span><span class="op" id="3112340">,</span>&nbsp;<span class="ident" id="3112342">Net</span><span class="op" id="3112345">:</span>&nbsp;<span class="ident" id="3112347">c</span><span class="op" id="3112348">.</span><span class="ident" id="3112349">fd</span><span class="op" id="3112351">.</span><span class="ident" id="3112352">net</span><span class="op" id="3112355">,</span>&nbsp;<span class="ident" id="3112357">Addr</span><span class="op" id="3112361">:</span>&nbsp;<span class="ident" id="3112363">addr</span><span class="op" id="3112367">,</span>&nbsp;<span class="ident" id="3112369">Err</span><span class="op" id="3112372">:</span>&nbsp;<span class="ident" id="3112374">ErrWriteToConnected</span><span class="op" id="3112393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112399">if</span>&nbsp;<span class="ident" id="3112402">addr</span>&nbsp;<span class="op" id="3112407">==</span>&nbsp;<span class="ident" id="3112410">nil</span>&nbsp;<span class="op" id="3112414">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112418">return</span>&nbsp;<span class="num" id="3112425">0</span><span class="op" id="3112426">,</span>&nbsp;<span class="op" id="3112428">&amp;</span><span class="ident" id="3112429">OpError</span><span class="op" id="3112436">{</span><span class="ident" id="3112437">Op</span><span class="op" id="3112439">:</span>&nbsp;<span class="string" id="3112441">&#34;write&#34;</span><span class="op" id="3112448">,</span>&nbsp;<span class="ident" id="3112450">Net</span><span class="op" id="3112453">:</span>&nbsp;<span class="ident" id="3112455">c</span><span class="op" id="3112456">.</span><span class="ident" id="3112457">fd</span><span class="op" id="3112459">.</span><span class="ident" id="3112460">net</span><span class="op" id="3112463">,</span>&nbsp;<span class="ident" id="3112465">Addr</span><span class="op" id="3112469">:</span>&nbsp;<span class="ident" id="3112471">nil</span><span class="op" id="3112474">,</span>&nbsp;<span class="ident" id="3112476">Err</span><span class="op" id="3112479">:</span>&nbsp;<span class="ident" id="3112481">errMissingAddress</span><span class="op" id="3112498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112504">sa</span><span class="op" id="3112506">,</span>&nbsp;<span class="ident" id="3112508">err</span>&nbsp;<span class="op" id="3112512">:=</span>&nbsp;<span class="ident" id="3112515">addr</span><span class="op" id="3112519">.</span><span class="ident" id="3112520">sockaddr</span><span class="op" id="3112528">(</span><span class="ident" id="3112529">c</span><span class="op" id="3112530">.</span><span class="ident" id="3112531">fd</span><span class="op" id="3112533">.</span><span class="ident" id="3112534">family</span><span class="op" id="3112540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112543">if</span>&nbsp;<span class="ident" id="3112546">err</span>&nbsp;<span class="op" id="3112550">!=</span>&nbsp;<span class="ident" id="3112553">nil</span>&nbsp;<span class="op" id="3112557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112561">return</span>&nbsp;<span class="num" id="3112568">0</span><span class="op" id="3112569">,</span>&nbsp;<span class="op" id="3112571">&amp;</span><span class="ident" id="3112572">OpError</span><span class="op" id="3112579">{</span><span class="string" id="3112580">&#34;write&#34;</span><span class="op" id="3112587">,</span>&nbsp;<span class="ident" id="3112589">c</span><span class="op" id="3112590">.</span><span class="ident" id="3112591">fd</span><span class="op" id="3112593">.</span><span class="ident" id="3112594">net</span><span class="op" id="3112597">,</span>&nbsp;<span class="ident" id="3112599">addr</span><span class="op" id="3112603">,</span>&nbsp;<span class="ident" id="3112605">err</span><span class="op" id="3112608">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112614">return</span>&nbsp;<span class="ident" id="3112621">c</span><span class="op" id="3112622">.</span><span class="ident" id="3112623">fd</span><span class="op" id="3112625">.</span><span class="ident" id="3112626">writeTo</span><span class="op" id="3112633">(</span><span class="ident" id="3112634">b</span><span class="op" id="3112635">,</span>&nbsp;<span class="ident" id="3112637">sa</span><span class="op" id="3112639">)</span><br>
<span class="lineno"></span><span class="op" id="3112641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3112644">//&nbsp;WriteTo&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;WriteTo&nbsp;method.</span><br>
<span class="lineno">150</span><span class="keyword" id="3112697">func</span>&nbsp;<span class="op" id="3112702">(</span><span class="ident" id="3112703">c</span>&nbsp;<span class="op" id="3112705">*</span><span class="ident" id="3112706">IPConn</span><span class="op" id="3112712">)</span>&nbsp;<span class="ident" id="3112714">WriteTo</span><span class="op" id="3112721">(</span><span class="ident" id="3112722">b</span>&nbsp;<span class="op" id="3112724">[</span><span class="op" id="3112725">]</span><span class="builtintype" id="3112726">byte</span><span class="op" id="3112730">,</span>&nbsp;<span class="ident" id="3112732">addr</span>&nbsp;<span class="ident" id="3112737">Addr</span><span class="op" id="3112741">)</span>&nbsp;<span class="op" id="3112743">(</span><span class="builtintype" id="3112744">int</span><span class="op" id="3112747">,</span>&nbsp;<span class="builtintype" id="3112749">error</span><span class="op" id="3112754">)</span>&nbsp;<span class="op" id="3112756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112759">if</span>&nbsp;<span class="op" id="3112762">!</span><span class="ident" id="3112763">c</span><span class="op" id="3112764">.</span><span class="ident" id="3112765">ok</span><span class="op" id="3112767">(</span><span class="op" id="3112768">)</span>&nbsp;<span class="op" id="3112770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112774">return</span>&nbsp;<span class="num" id="3112781">0</span><span class="op" id="3112782">,</span>&nbsp;<span class="ident" id="3112784">syscall</span><span class="op" id="3112791">.</span><span class="ident" id="3112792">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3112803">a</span><span class="op" id="3112804">,</span>&nbsp;<span class="ident" id="3112806">ok</span>&nbsp;<span class="op" id="3112809">:=</span>&nbsp;<span class="ident" id="3112812">addr</span><span class="op" id="3112816">.</span><span class="op" id="3112817">(</span><span class="op" id="3112818">*</span><span class="ident" id="3112819">IPAddr</span><span class="op" id="3112825">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112828">if</span>&nbsp;<span class="op" id="3112831">!</span><span class="ident" id="3112832">ok</span>&nbsp;<span class="op" id="3112835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112839">return</span>&nbsp;<span class="num" id="3112846">0</span><span class="op" id="3112847">,</span>&nbsp;<span class="op" id="3112849">&amp;</span><span class="ident" id="3112850">OpError</span><span class="op" id="3112857">{</span><span class="string" id="3112858">&#34;write&#34;</span><span class="op" id="3112865">,</span>&nbsp;<span class="ident" id="3112867">c</span><span class="op" id="3112868">.</span><span class="ident" id="3112869">fd</span><span class="op" id="3112871">.</span><span class="ident" id="3112872">net</span><span class="op" id="3112875">,</span>&nbsp;<span class="ident" id="3112877">addr</span><span class="op" id="3112881">,</span>&nbsp;<span class="ident" id="3112883">syscall</span><span class="op" id="3112890">.</span><span class="ident" id="3112891">EINVAL</span><span class="op" id="3112897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3112900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3112903">return</span>&nbsp;<span class="ident" id="3112910">c</span><span class="op" id="3112911">.</span><span class="ident" id="3112912">WriteToIP</span><span class="op" id="3112921">(</span><span class="ident" id="3112922">b</span><span class="op" id="3112923">,</span>&nbsp;<span class="ident" id="3112925">a</span><span class="op" id="3112926">)</span><br>
<span class="lineno"></span><span class="op" id="3112928">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3112931">//&nbsp;WriteMsgIP&nbsp;writes&nbsp;a&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3113001">//&nbsp;b&nbsp;and&nbsp;the&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;from&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3113068">//&nbsp;number&nbsp;of&nbsp;payload&nbsp;and&nbsp;out-of-band&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword" id="3113120">func</span>&nbsp;<span class="op" id="3113125">(</span><span class="ident" id="3113126">c</span>&nbsp;<span class="op" id="3113128">*</span><span class="ident" id="3113129">IPConn</span><span class="op" id="3113135">)</span>&nbsp;<span class="ident" id="3113137">WriteMsgIP</span><span class="op" id="3113147">(</span><span class="ident" id="3113148">b</span><span class="op" id="3113149">,</span>&nbsp;<span class="ident" id="3113151">oob</span>&nbsp;<span class="op" id="3113155">[</span><span class="op" id="3113156">]</span><span class="builtintype" id="3113157">byte</span><span class="op" id="3113161">,</span>&nbsp;<span class="ident" id="3113163">addr</span>&nbsp;<span class="op" id="3113168">*</span><span class="ident" id="3113169">IPAddr</span><span class="op" id="3113175">)</span>&nbsp;<span class="op" id="3113177">(</span><span class="ident" id="3113178">n</span><span class="op" id="3113179">,</span>&nbsp;<span class="ident" id="3113181">oobn</span>&nbsp;<span class="builtintype" id="3113186">int</span><span class="op" id="3113189">,</span>&nbsp;<span class="ident" id="3113191">err</span>&nbsp;<span class="builtintype" id="3113195">error</span><span class="op" id="3113200">)</span>&nbsp;<span class="op" id="3113202">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113205">if</span>&nbsp;<span class="op" id="3113208">!</span><span class="ident" id="3113209">c</span><span class="op" id="3113210">.</span><span class="ident" id="3113211">ok</span><span class="op" id="3113213">(</span><span class="op" id="3113214">)</span>&nbsp;<span class="op" id="3113216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113220">return</span>&nbsp;<span class="num" id="3113227">0</span><span class="op" id="3113228">,</span>&nbsp;<span class="num" id="3113230">0</span><span class="op" id="3113231">,</span>&nbsp;<span class="ident" id="3113233">syscall</span><span class="op" id="3113240">.</span><span class="ident" id="3113241">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113252">if</span>&nbsp;<span class="ident" id="3113255">c</span><span class="op" id="3113256">.</span><span class="ident" id="3113257">fd</span><span class="op" id="3113259">.</span><span class="ident" id="3113260">isConnected</span>&nbsp;<span class="op" id="3113272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113276">return</span>&nbsp;<span class="num" id="3113283">0</span><span class="op" id="3113284">,</span>&nbsp;<span class="num" id="3113286">0</span><span class="op" id="3113287">,</span>&nbsp;<span class="op" id="3113289">&amp;</span><span class="ident" id="3113290">OpError</span><span class="op" id="3113297">{</span><span class="ident" id="3113298">Op</span><span class="op" id="3113300">:</span>&nbsp;<span class="string" id="3113302">&#34;write&#34;</span><span class="op" id="3113309">,</span>&nbsp;<span class="ident" id="3113311">Net</span><span class="op" id="3113314">:</span>&nbsp;<span class="ident" id="3113316">c</span><span class="op" id="3113317">.</span><span class="ident" id="3113318">fd</span><span class="op" id="3113320">.</span><span class="ident" id="3113321">net</span><span class="op" id="3113324">,</span>&nbsp;<span class="ident" id="3113326">Addr</span><span class="op" id="3113330">:</span>&nbsp;<span class="ident" id="3113332">addr</span><span class="op" id="3113336">,</span>&nbsp;<span class="ident" id="3113338">Err</span><span class="op" id="3113341">:</span>&nbsp;<span class="ident" id="3113343">ErrWriteToConnected</span><span class="op" id="3113362">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113368">if</span>&nbsp;<span class="ident" id="3113371">addr</span>&nbsp;<span class="op" id="3113376">==</span>&nbsp;<span class="ident" id="3113379">nil</span>&nbsp;<span class="op" id="3113383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113387">return</span>&nbsp;<span class="num" id="3113394">0</span><span class="op" id="3113395">,</span>&nbsp;<span class="num" id="3113397">0</span><span class="op" id="3113398">,</span>&nbsp;<span class="op" id="3113400">&amp;</span><span class="ident" id="3113401">OpError</span><span class="op" id="3113408">{</span><span class="ident" id="3113409">Op</span><span class="op" id="3113411">:</span>&nbsp;<span class="string" id="3113413">&#34;write&#34;</span><span class="op" id="3113420">,</span>&nbsp;<span class="ident" id="3113422">Net</span><span class="op" id="3113425">:</span>&nbsp;<span class="ident" id="3113427">c</span><span class="op" id="3113428">.</span><span class="ident" id="3113429">fd</span><span class="op" id="3113431">.</span><span class="ident" id="3113432">net</span><span class="op" id="3113435">,</span>&nbsp;<span class="ident" id="3113437">Addr</span><span class="op" id="3113441">:</span>&nbsp;<span class="ident" id="3113443">nil</span><span class="op" id="3113446">,</span>&nbsp;<span class="ident" id="3113448">Err</span><span class="op" id="3113451">:</span>&nbsp;<span class="ident" id="3113453">errMissingAddress</span><span class="op" id="3113470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3113476">sa</span><span class="op" id="3113478">,</span>&nbsp;<span class="ident" id="3113480">err</span>&nbsp;<span class="op" id="3113484">:=</span>&nbsp;<span class="ident" id="3113487">addr</span><span class="op" id="3113491">.</span><span class="ident" id="3113492">sockaddr</span><span class="op" id="3113500">(</span><span class="ident" id="3113501">c</span><span class="op" id="3113502">.</span><span class="ident" id="3113503">fd</span><span class="op" id="3113505">.</span><span class="ident" id="3113506">family</span><span class="op" id="3113512">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113515">if</span>&nbsp;<span class="ident" id="3113518">err</span>&nbsp;<span class="op" id="3113522">!=</span>&nbsp;<span class="ident" id="3113525">nil</span>&nbsp;<span class="op" id="3113529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113533">return</span>&nbsp;<span class="num" id="3113540">0</span><span class="op" id="3113541">,</span>&nbsp;<span class="num" id="3113543">0</span><span class="op" id="3113544">,</span>&nbsp;<span class="op" id="3113546">&amp;</span><span class="ident" id="3113547">OpError</span><span class="op" id="3113554">{</span><span class="string" id="3113555">&#34;write&#34;</span><span class="op" id="3113562">,</span>&nbsp;<span class="ident" id="3113564">c</span><span class="op" id="3113565">.</span><span class="ident" id="3113566">fd</span><span class="op" id="3113568">.</span><span class="ident" id="3113569">net</span><span class="op" id="3113572">,</span>&nbsp;<span class="ident" id="3113574">addr</span><span class="op" id="3113578">,</span>&nbsp;<span class="ident" id="3113580">err</span><span class="op" id="3113583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3113586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113589">return</span>&nbsp;<span class="ident" id="3113596">c</span><span class="op" id="3113597">.</span><span class="ident" id="3113598">fd</span><span class="op" id="3113600">.</span><span class="ident" id="3113601">writeMsg</span><span class="op" id="3113609">(</span><span class="ident" id="3113610">b</span><span class="op" id="3113611">,</span>&nbsp;<span class="ident" id="3113613">oob</span><span class="op" id="3113616">,</span>&nbsp;<span class="ident" id="3113618">sa</span><span class="op" id="3113620">)</span><br>
<span class="lineno"></span><span class="op" id="3113622">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="3113625">//&nbsp;DialIP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;protocol</span><br>
<span class="lineno"></span><span class="comment" id="3113696">//&nbsp;netProto,&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed&nbsp;by&nbsp;a&nbsp;colon</span><br>
<span class="lineno"></span><span class="comment" id="3113765">//&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3113799">func</span>&nbsp;<span class="ident" id="3113804">DialIP</span><span class="op" id="3113810">(</span><span class="ident" id="3113811">netProto</span>&nbsp;<span class="builtintype" id="3113820">string</span><span class="op" id="3113826">,</span>&nbsp;<span class="ident" id="3113828">laddr</span><span class="op" id="3113833">,</span>&nbsp;<span class="ident" id="3113835">raddr</span>&nbsp;<span class="op" id="3113841">*</span><span class="ident" id="3113842">IPAddr</span><span class="op" id="3113848">)</span>&nbsp;<span class="op" id="3113850">(</span><span class="op" id="3113851">*</span><span class="ident" id="3113852">IPConn</span><span class="op" id="3113858">,</span>&nbsp;<span class="builtintype" id="3113860">error</span><span class="op" id="3113865">)</span>&nbsp;<span class="op" id="3113867">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3113870">return</span>&nbsp;<span class="ident" id="3113877">dialIP</span><span class="op" id="3113883">(</span><span class="ident" id="3113884">netProto</span><span class="op" id="3113892">,</span>&nbsp;<span class="ident" id="3113894">laddr</span><span class="op" id="3113899">,</span>&nbsp;<span class="ident" id="3113901">raddr</span><span class="op" id="3113906">,</span>&nbsp;<span class="ident" id="3113908">noDeadline</span><span class="op" id="3113918">)</span><br>
<span class="lineno"></span><span class="op" id="3113920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3113923">func</span>&nbsp;<span class="ident" id="3113928">dialIP</span><span class="op" id="3113934">(</span><span class="ident" id="3113935">netProto</span>&nbsp;<span class="builtintype" id="3113944">string</span><span class="op" id="3113950">,</span>&nbsp;<span class="ident" id="3113952">laddr</span><span class="op" id="3113957">,</span>&nbsp;<span class="ident" id="3113959">raddr</span>&nbsp;<span class="op" id="3113965">*</span><span class="ident" id="3113966">IPAddr</span><span class="op" id="3113972">,</span>&nbsp;<span class="ident" id="3113974">deadline</span>&nbsp;<span class="ident" id="3113983">time</span><span class="op" id="3113987">.</span><span class="ident" id="3113988">Time</span><span class="op" id="3113992">)</span>&nbsp;<span class="op" id="3113994">(</span><span class="op" id="3113995">*</span><span class="ident" id="3113996">IPConn</span><span class="op" id="3114002">,</span>&nbsp;<span class="builtintype" id="3114004">error</span><span class="op" id="3114009">)</span>&nbsp;<span class="op" id="3114011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114014">net</span><span class="op" id="3114017">,</span>&nbsp;<span class="ident" id="3114019">proto</span><span class="op" id="3114024">,</span>&nbsp;<span class="ident" id="3114026">err</span>&nbsp;<span class="op" id="3114030">:=</span>&nbsp;<span class="ident" id="3114033">parseNetwork</span><span class="op" id="3114045">(</span><span class="ident" id="3114046">netProto</span><span class="op" id="3114054">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114057">if</span>&nbsp;<span class="ident" id="3114060">err</span>&nbsp;<span class="op" id="3114064">!=</span>&nbsp;<span class="ident" id="3114067">nil</span>&nbsp;<span class="op" id="3114071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114075">return</span>&nbsp;<span class="ident" id="3114082">nil</span><span class="op" id="3114085">,</span>&nbsp;<span class="op" id="3114087">&amp;</span><span class="ident" id="3114088">OpError</span><span class="op" id="3114095">{</span><span class="ident" id="3114096">Op</span><span class="op" id="3114098">:</span>&nbsp;<span class="string" id="3114100">&#34;dial&#34;</span><span class="op" id="3114106">,</span>&nbsp;<span class="ident" id="3114108">Net</span><span class="op" id="3114111">:</span>&nbsp;<span class="ident" id="3114113">netProto</span><span class="op" id="3114121">,</span>&nbsp;<span class="ident" id="3114123">Addr</span><span class="op" id="3114127">:</span>&nbsp;<span class="ident" id="3114129">raddr</span><span class="op" id="3114134">,</span>&nbsp;<span class="ident" id="3114136">Err</span><span class="op" id="3114139">:</span>&nbsp;<span class="ident" id="3114141">err</span><span class="op" id="3114144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114150">switch</span>&nbsp;<span class="ident" id="3114157">net</span>&nbsp;<span class="op" id="3114161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114164">case</span>&nbsp;<span class="string" id="3114169">&#34;ip&#34;</span><span class="op" id="3114173">,</span>&nbsp;<span class="string" id="3114175">&#34;ip4&#34;</span><span class="op" id="3114180">,</span>&nbsp;<span class="string" id="3114182">&#34;ip6&#34;</span><span class="op" id="3114187">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114190">default</span><span class="op" id="3114197">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114201">return</span>&nbsp;<span class="ident" id="3114208">nil</span><span class="op" id="3114211">,</span>&nbsp;<span class="op" id="3114213">&amp;</span><span class="ident" id="3114214">OpError</span><span class="op" id="3114221">{</span><span class="ident" id="3114222">Op</span><span class="op" id="3114224">:</span>&nbsp;<span class="string" id="3114226">&#34;dial&#34;</span><span class="op" id="3114232">,</span>&nbsp;<span class="ident" id="3114234">Net</span><span class="op" id="3114237">:</span>&nbsp;<span class="ident" id="3114239">netProto</span><span class="op" id="3114247">,</span>&nbsp;<span class="ident" id="3114249">Addr</span><span class="op" id="3114253">:</span>&nbsp;<span class="ident" id="3114255">raddr</span><span class="op" id="3114260">,</span>&nbsp;<span class="ident" id="3114262">Err</span><span class="op" id="3114265">:</span>&nbsp;<span class="ident" id="3114267">UnknownNetworkError</span><span class="op" id="3114286">(</span><span class="ident" id="3114287">netProto</span><span class="op" id="3114295">)</span><span class="op" id="3114296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114302">if</span>&nbsp;<span class="ident" id="3114305">raddr</span>&nbsp;<span class="op" id="3114311">==</span>&nbsp;<span class="ident" id="3114314">nil</span>&nbsp;<span class="op" id="3114318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114322">return</span>&nbsp;<span class="ident" id="3114329">nil</span><span class="op" id="3114332">,</span>&nbsp;<span class="op" id="3114334">&amp;</span><span class="ident" id="3114335">OpError</span><span class="op" id="3114342">{</span><span class="ident" id="3114343">Op</span><span class="op" id="3114345">:</span>&nbsp;<span class="string" id="3114347">&#34;dial&#34;</span><span class="op" id="3114353">,</span>&nbsp;<span class="ident" id="3114355">Net</span><span class="op" id="3114358">:</span>&nbsp;<span class="ident" id="3114360">netProto</span><span class="op" id="3114368">,</span>&nbsp;<span class="ident" id="3114370">Addr</span><span class="op" id="3114374">:</span>&nbsp;<span class="ident" id="3114376">nil</span><span class="op" id="3114379">,</span>&nbsp;<span class="ident" id="3114381">Err</span><span class="op" id="3114384">:</span>&nbsp;<span class="ident" id="3114386">errMissingAddress</span><span class="op" id="3114403">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114409">fd</span><span class="op" id="3114411">,</span>&nbsp;<span class="ident" id="3114413">err</span>&nbsp;<span class="op" id="3114417">:=</span>&nbsp;<span class="ident" id="3114420">internetSocket</span><span class="op" id="3114434">(</span><span class="ident" id="3114435">net</span><span class="op" id="3114438">,</span>&nbsp;<span class="ident" id="3114440">laddr</span><span class="op" id="3114445">,</span>&nbsp;<span class="ident" id="3114447">raddr</span><span class="op" id="3114452">,</span>&nbsp;<span class="ident" id="3114454">deadline</span><span class="op" id="3114462">,</span>&nbsp;<span class="ident" id="3114464">syscall</span><span class="op" id="3114471">.</span><span class="ident" id="3114472">SOCK_RAW</span><span class="op" id="3114480">,</span>&nbsp;<span class="ident" id="3114482">proto</span><span class="op" id="3114487">,</span>&nbsp;<span class="string" id="3114489">&#34;dial&#34;</span><span class="op" id="3114495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114498">if</span>&nbsp;<span class="ident" id="3114501">err</span>&nbsp;<span class="op" id="3114505">!=</span>&nbsp;<span class="ident" id="3114508">nil</span>&nbsp;<span class="op" id="3114512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114516">return</span>&nbsp;<span class="ident" id="3114523">nil</span><span class="op" id="3114526">,</span>&nbsp;<span class="op" id="3114528">&amp;</span><span class="ident" id="3114529">OpError</span><span class="op" id="3114536">{</span><span class="ident" id="3114537">Op</span><span class="op" id="3114539">:</span>&nbsp;<span class="string" id="3114541">&#34;dial&#34;</span><span class="op" id="3114547">,</span>&nbsp;<span class="ident" id="3114549">Net</span><span class="op" id="3114552">:</span>&nbsp;<span class="ident" id="3114554">netProto</span><span class="op" id="3114562">,</span>&nbsp;<span class="ident" id="3114564">Addr</span><span class="op" id="3114568">:</span>&nbsp;<span class="ident" id="3114570">raddr</span><span class="op" id="3114575">,</span>&nbsp;<span class="ident" id="3114577">Err</span><span class="op" id="3114580">:</span>&nbsp;<span class="ident" id="3114582">err</span><span class="op" id="3114585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3114588">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114591">return</span>&nbsp;<span class="ident" id="3114598">newIPConn</span><span class="op" id="3114607">(</span><span class="ident" id="3114608">fd</span><span class="op" id="3114610">)</span><span class="op" id="3114611">,</span>&nbsp;<span class="ident" id="3114613">nil</span><br>
<span class="lineno"></span><span class="op" id="3114617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3114620">//&nbsp;ListenIP&nbsp;listens&nbsp;for&nbsp;incoming&nbsp;IP&nbsp;packets&nbsp;addressed&nbsp;to&nbsp;the&nbsp;local</span><br>
<span class="lineno"></span><span class="comment" id="3114687">//&nbsp;address&nbsp;laddr.&nbsp;&nbsp;The&nbsp;returned&nbsp;connection&#39;s&nbsp;ReadFrom&nbsp;and&nbsp;WriteTo</span><br>
<span class="lineno">210</span><span class="comment" id="3114753">//&nbsp;methods&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;receive&nbsp;and&nbsp;send&nbsp;IP&nbsp;packets&nbsp;with&nbsp;per-packet</span><br>
<span class="lineno"></span><span class="comment" id="3114823">//&nbsp;addressing.</span><br>
<span class="lineno"></span><span class="keyword" id="3114838">func</span>&nbsp;<span class="ident" id="3114843">ListenIP</span><span class="op" id="3114851">(</span><span class="ident" id="3114852">netProto</span>&nbsp;<span class="builtintype" id="3114861">string</span><span class="op" id="3114867">,</span>&nbsp;<span class="ident" id="3114869">laddr</span>&nbsp;<span class="op" id="3114875">*</span><span class="ident" id="3114876">IPAddr</span><span class="op" id="3114882">)</span>&nbsp;<span class="op" id="3114884">(</span><span class="op" id="3114885">*</span><span class="ident" id="3114886">IPConn</span><span class="op" id="3114892">,</span>&nbsp;<span class="builtintype" id="3114894">error</span><span class="op" id="3114899">)</span>&nbsp;<span class="op" id="3114901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3114904">net</span><span class="op" id="3114907">,</span>&nbsp;<span class="ident" id="3114909">proto</span><span class="op" id="3114914">,</span>&nbsp;<span class="ident" id="3114916">err</span>&nbsp;<span class="op" id="3114920">:=</span>&nbsp;<span class="ident" id="3114923">parseNetwork</span><span class="op" id="3114935">(</span><span class="ident" id="3114936">netProto</span><span class="op" id="3114944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114947">if</span>&nbsp;<span class="ident" id="3114950">err</span>&nbsp;<span class="op" id="3114954">!=</span>&nbsp;<span class="ident" id="3114957">nil</span>&nbsp;<span class="op" id="3114961">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3114965">return</span>&nbsp;<span class="ident" id="3114972">nil</span><span class="op" id="3114975">,</span>&nbsp;<span class="op" id="3114977">&amp;</span><span class="ident" id="3114978">OpError</span><span class="op" id="3114985">{</span><span class="ident" id="3114986">Op</span><span class="op" id="3114988">:</span>&nbsp;<span class="string" id="3114990">&#34;dial&#34;</span><span class="op" id="3114996">,</span>&nbsp;<span class="ident" id="3114998">Net</span><span class="op" id="3115001">:</span>&nbsp;<span class="ident" id="3115003">netProto</span><span class="op" id="3115011">,</span>&nbsp;<span class="ident" id="3115013">Addr</span><span class="op" id="3115017">:</span>&nbsp;<span class="ident" id="3115019">laddr</span><span class="op" id="3115024">,</span>&nbsp;<span class="ident" id="3115026">Err</span><span class="op" id="3115029">:</span>&nbsp;<span class="ident" id="3115031">err</span><span class="op" id="3115034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115040">switch</span>&nbsp;<span class="ident" id="3115047">net</span>&nbsp;<span class="op" id="3115051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115054">case</span>&nbsp;<span class="string" id="3115059">&#34;ip&#34;</span><span class="op" id="3115063">,</span>&nbsp;<span class="string" id="3115065">&#34;ip4&#34;</span><span class="op" id="3115070">,</span>&nbsp;<span class="string" id="3115072">&#34;ip6&#34;</span><span class="op" id="3115077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115080">default</span><span class="op" id="3115087">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115091">return</span>&nbsp;<span class="ident" id="3115098">nil</span><span class="op" id="3115101">,</span>&nbsp;<span class="op" id="3115103">&amp;</span><span class="ident" id="3115104">OpError</span><span class="op" id="3115111">{</span><span class="ident" id="3115112">Op</span><span class="op" id="3115114">:</span>&nbsp;<span class="string" id="3115116">&#34;listen&#34;</span><span class="op" id="3115124">,</span>&nbsp;<span class="ident" id="3115126">Net</span><span class="op" id="3115129">:</span>&nbsp;<span class="ident" id="3115131">netProto</span><span class="op" id="3115139">,</span>&nbsp;<span class="ident" id="3115141">Addr</span><span class="op" id="3115145">:</span>&nbsp;<span class="ident" id="3115147">laddr</span><span class="op" id="3115152">,</span>&nbsp;<span class="ident" id="3115154">Err</span><span class="op" id="3115157">:</span>&nbsp;<span class="ident" id="3115159">UnknownNetworkError</span><span class="op" id="3115178">(</span><span class="ident" id="3115179">netProto</span><span class="op" id="3115187">)</span><span class="op" id="3115188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3115194">fd</span><span class="op" id="3115196">,</span>&nbsp;<span class="ident" id="3115198">err</span>&nbsp;<span class="op" id="3115202">:=</span>&nbsp;<span class="ident" id="3115205">internetSocket</span><span class="op" id="3115219">(</span><span class="ident" id="3115220">net</span><span class="op" id="3115223">,</span>&nbsp;<span class="ident" id="3115225">laddr</span><span class="op" id="3115230">,</span>&nbsp;<span class="ident" id="3115232">nil</span><span class="op" id="3115235">,</span>&nbsp;<span class="ident" id="3115237">noDeadline</span><span class="op" id="3115247">,</span>&nbsp;<span class="ident" id="3115249">syscall</span><span class="op" id="3115256">.</span><span class="ident" id="3115257">SOCK_RAW</span><span class="op" id="3115265">,</span>&nbsp;<span class="ident" id="3115267">proto</span><span class="op" id="3115272">,</span>&nbsp;<span class="string" id="3115274">&#34;listen&#34;</span><span class="op" id="3115282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115285">if</span>&nbsp;<span class="ident" id="3115288">err</span>&nbsp;<span class="op" id="3115292">!=</span>&nbsp;<span class="ident" id="3115295">nil</span>&nbsp;<span class="op" id="3115299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115303">return</span>&nbsp;<span class="ident" id="3115310">nil</span><span class="op" id="3115313">,</span>&nbsp;<span class="op" id="3115315">&amp;</span><span class="ident" id="3115316">OpError</span><span class="op" id="3115323">{</span><span class="ident" id="3115324">Op</span><span class="op" id="3115326">:</span>&nbsp;<span class="string" id="3115328">&#34;listen&#34;</span><span class="op" id="3115336">,</span>&nbsp;<span class="ident" id="3115338">Net</span><span class="op" id="3115341">:</span>&nbsp;<span class="ident" id="3115343">netProto</span><span class="op" id="3115351">,</span>&nbsp;<span class="ident" id="3115353">Addr</span><span class="op" id="3115357">:</span>&nbsp;<span class="ident" id="3115359">laddr</span><span class="op" id="3115364">,</span>&nbsp;<span class="ident" id="3115366">Err</span><span class="op" id="3115369">:</span>&nbsp;<span class="ident" id="3115371">err</span><span class="op" id="3115374">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3115377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3115380">return</span>&nbsp;<span class="ident" id="3115387">newIPConn</span><span class="op" id="3115396">(</span><span class="ident" id="3115397">fd</span><span class="op" id="3115399">)</span><span class="op" id="3115400">,</span>&nbsp;<span class="ident" id="3115402">nil</span><br>
<span class="lineno"></span><span class="op" id="3115406">}</span>
</div>
</body>
</html>
