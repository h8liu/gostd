<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8396566">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8396621">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8396675">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8396726">package</span>&nbsp;<span class="ident" id="8396734">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8396740">import</span>&nbsp;<span class="op" id="8396747">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396750">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396759">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396768">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396782">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396797">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396803">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396810">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396827">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396838">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8396849">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8396856">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8396859">type</span>&nbsp;<span class="ident" id="8396864">authTest</span>&nbsp;<span class="keyword" id="8396873">struct</span>&nbsp;<span class="op" id="8396880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396883">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8396894">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396900">challenges</span>&nbsp;<span class="op" id="8396911">[</span><span class="op" id="8396912">]</span><span class="builtintype" id="8396913">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396921">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8396932">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8396940">responses</span>&nbsp;&nbsp;<span class="op" id="8396951">[</span><span class="op" id="8396952">]</span><span class="builtintype" id="8396953">string</span><br>
<span class="lineno">25</span><span class="op" id="8396960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8396963">var</span>&nbsp;<span class="ident" id="8396967">authTests</span>&nbsp;<span class="op" id="8396977">=</span>&nbsp;<span class="op" id="8396979">[</span><span class="op" id="8396980">]</span><span class="ident" id="8396981">authTest</span><span class="op" id="8396989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8396992">{</span><span class="ident" id="8396993">PlainAuth</span><span class="op" id="8397002">(</span><span class="string" id="8397003">&#34;&#34;</span><span class="op" id="8397005">,</span>&nbsp;<span class="string" id="8397007">&#34;user&#34;</span><span class="op" id="8397013">,</span>&nbsp;<span class="string" id="8397015">&#34;pass&#34;</span><span class="op" id="8397021">,</span>&nbsp;<span class="string" id="8397023">&#34;testserver&#34;</span><span class="op" id="8397035">)</span><span class="op" id="8397036">,</span>&nbsp;<span class="op" id="8397038">[</span><span class="op" id="8397039">]</span><span class="builtintype" id="8397040">string</span><span class="op" id="8397046">{</span><span class="op" id="8397047">}</span><span class="op" id="8397048">,</span>&nbsp;<span class="string" id="8397050">&#34;PLAIN&#34;</span><span class="op" id="8397057">,</span>&nbsp;<span class="op" id="8397059">[</span><span class="op" id="8397060">]</span><span class="builtintype" id="8397061">string</span><span class="op" id="8397067">{</span><span class="string" id="8397068">&#34;\x00user\x00pass&#34;</span><span class="op" id="8397086">}</span><span class="op" id="8397087">}</span><span class="op" id="8397088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397091">{</span><span class="ident" id="8397092">PlainAuth</span><span class="op" id="8397101">(</span><span class="string" id="8397102">&#34;foo&#34;</span><span class="op" id="8397107">,</span>&nbsp;<span class="string" id="8397109">&#34;bar&#34;</span><span class="op" id="8397114">,</span>&nbsp;<span class="string" id="8397116">&#34;baz&#34;</span><span class="op" id="8397121">,</span>&nbsp;<span class="string" id="8397123">&#34;testserver&#34;</span><span class="op" id="8397135">)</span><span class="op" id="8397136">,</span>&nbsp;<span class="op" id="8397138">[</span><span class="op" id="8397139">]</span><span class="builtintype" id="8397140">string</span><span class="op" id="8397146">{</span><span class="op" id="8397147">}</span><span class="op" id="8397148">,</span>&nbsp;<span class="string" id="8397150">&#34;PLAIN&#34;</span><span class="op" id="8397157">,</span>&nbsp;<span class="op" id="8397159">[</span><span class="op" id="8397160">]</span><span class="builtintype" id="8397161">string</span><span class="op" id="8397167">{</span><span class="string" id="8397168">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="8397187">}</span><span class="op" id="8397188">}</span><span class="op" id="8397189">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397192">{</span><span class="ident" id="8397193">CRAMMD5Auth</span><span class="op" id="8397204">(</span><span class="string" id="8397205">&#34;user&#34;</span><span class="op" id="8397211">,</span>&nbsp;<span class="string" id="8397213">&#34;pass&#34;</span><span class="op" id="8397219">)</span><span class="op" id="8397220">,</span>&nbsp;<span class="op" id="8397222">[</span><span class="op" id="8397223">]</span><span class="builtintype" id="8397224">string</span><span class="op" id="8397230">{</span><span class="string" id="8397231">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="8397263">}</span><span class="op" id="8397264">,</span>&nbsp;<span class="string" id="8397266">&#34;CRAM-MD5&#34;</span><span class="op" id="8397276">,</span>&nbsp;<span class="op" id="8397278">[</span><span class="op" id="8397279">]</span><span class="builtintype" id="8397280">string</span><span class="op" id="8397286">{</span><span class="string" id="8397287">&#34;&#34;</span><span class="op" id="8397289">,</span>&nbsp;<span class="string" id="8397291">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="8397330">}</span><span class="op" id="8397331">}</span><span class="op" id="8397332">,</span><br>
<span class="lineno"></span><span class="op" id="8397334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8397337">func</span>&nbsp;<span class="ident" id="8397342">TestAuth</span><span class="op" id="8397350">(</span><span class="ident" id="8397351">t</span>&nbsp;<span class="op" id="8397353">*</span><span class="ident" id="8397354">testing</span><span class="op" id="8397361">.</span><span class="ident" id="8397362">T</span><span class="op" id="8397363">)</span>&nbsp;<span class="op" id="8397365">{</span><br>
<span class="lineno"></span><span class="ident" id="8397367">testLoop</span><span class="op" id="8397375">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397378">for</span>&nbsp;<span class="ident" id="8397382">i</span><span class="op" id="8397383">,</span>&nbsp;<span class="ident" id="8397385">test</span>&nbsp;<span class="op" id="8397390">:=</span>&nbsp;<span class="keyword" id="8397393">range</span>&nbsp;<span class="ident" id="8397399">authTests</span>&nbsp;<span class="op" id="8397409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397413">name</span><span class="op" id="8397417">,</span>&nbsp;<span class="ident" id="8397419">resp</span><span class="op" id="8397423">,</span>&nbsp;<span class="ident" id="8397425">err</span>&nbsp;<span class="op" id="8397429">:=</span>&nbsp;<span class="ident" id="8397432">test</span><span class="op" id="8397436">.</span><span class="ident" id="8397437">auth</span><span class="op" id="8397441">.</span><span class="ident" id="8397442">Start</span><span class="op" id="8397447">(</span><span class="op" id="8397448">&amp;</span><span class="ident" id="8397449">ServerInfo</span><span class="op" id="8397459">{</span><span class="string" id="8397460">&#34;testserver&#34;</span><span class="op" id="8397472">,</span>&nbsp;<span class="builtintype" id="8397474">true</span><span class="op" id="8397478">,</span>&nbsp;<span class="ident" id="8397480">nil</span><span class="op" id="8397483">}</span><span class="op" id="8397484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397488">if</span>&nbsp;<span class="ident" id="8397491">name</span>&nbsp;<span class="op" id="8397496">!=</span>&nbsp;<span class="ident" id="8397499">test</span><span class="op" id="8397503">.</span><span class="ident" id="8397504">name</span>&nbsp;<span class="op" id="8397509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397514">t</span><span class="op" id="8397515">.</span><span class="ident" id="8397516">Errorf</span><span class="op" id="8397522">(</span><span class="string" id="8397523">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8397553">,</span>&nbsp;<span class="ident" id="8397555">i</span><span class="op" id="8397556">,</span>&nbsp;<span class="ident" id="8397558">name</span><span class="op" id="8397562">,</span>&nbsp;<span class="ident" id="8397564">test</span><span class="op" id="8397568">.</span><span class="ident" id="8397569">name</span><span class="op" id="8397573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397577">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397581">if</span>&nbsp;<span class="op" id="8397584">!</span><span class="ident" id="8397585">bytes</span><span class="op" id="8397590">.</span><span class="ident" id="8397591">Equal</span><span class="op" id="8397596">(</span><span class="ident" id="8397597">resp</span><span class="op" id="8397601">,</span>&nbsp;<span class="op" id="8397603">[</span><span class="op" id="8397604">]</span><span class="builtintype" id="8397605">byte</span><span class="op" id="8397609">(</span><span class="ident" id="8397610">test</span><span class="op" id="8397614">.</span><span class="ident" id="8397615">responses</span><span class="op" id="8397624">[</span><span class="num" id="8397625">0</span><span class="op" id="8397626">]</span><span class="op" id="8397627">)</span><span class="op" id="8397628">)</span>&nbsp;<span class="op" id="8397630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397635">t</span><span class="op" id="8397636">.</span><span class="ident" id="8397637">Errorf</span><span class="op" id="8397643">(</span><span class="string" id="8397644">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8397678">,</span>&nbsp;<span class="ident" id="8397680">i</span><span class="op" id="8397681">,</span>&nbsp;<span class="ident" id="8397683">resp</span><span class="op" id="8397687">,</span>&nbsp;<span class="ident" id="8397689">test</span><span class="op" id="8397693">.</span><span class="ident" id="8397694">responses</span><span class="op" id="8397703">[</span><span class="num" id="8397704">0</span><span class="op" id="8397705">]</span><span class="op" id="8397706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397714">if</span>&nbsp;<span class="ident" id="8397717">err</span>&nbsp;<span class="op" id="8397721">!=</span>&nbsp;<span class="ident" id="8397724">nil</span>&nbsp;<span class="op" id="8397728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397733">t</span><span class="op" id="8397734">.</span><span class="ident" id="8397735">Errorf</span><span class="op" id="8397741">(</span><span class="string" id="8397742">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8397757">,</span>&nbsp;<span class="ident" id="8397759">i</span><span class="op" id="8397760">,</span>&nbsp;<span class="ident" id="8397762">err</span><span class="op" id="8397765">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8397769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397773">for</span>&nbsp;<span class="ident" id="8397777">j</span>&nbsp;<span class="op" id="8397779">:=</span>&nbsp;<span class="keyword" id="8397782">range</span>&nbsp;<span class="ident" id="8397788">test</span><span class="op" id="8397792">.</span><span class="ident" id="8397793">challenges</span>&nbsp;<span class="op" id="8397804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397809">challenge</span>&nbsp;<span class="op" id="8397819">:=</span>&nbsp;<span class="op" id="8397822">[</span><span class="op" id="8397823">]</span><span class="builtintype" id="8397824">byte</span><span class="op" id="8397828">(</span><span class="ident" id="8397829">test</span><span class="op" id="8397833">.</span><span class="ident" id="8397834">challenges</span><span class="op" id="8397844">[</span><span class="ident" id="8397845">j</span><span class="op" id="8397846">]</span><span class="op" id="8397847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397852">expected</span>&nbsp;<span class="op" id="8397861">:=</span>&nbsp;<span class="op" id="8397864">[</span><span class="op" id="8397865">]</span><span class="builtintype" id="8397866">byte</span><span class="op" id="8397870">(</span><span class="ident" id="8397871">test</span><span class="op" id="8397875">.</span><span class="ident" id="8397876">responses</span><span class="op" id="8397885">[</span><span class="ident" id="8397886">j</span><span class="op" id="8397887">+</span><span class="num" id="8397888">1</span><span class="op" id="8397889">]</span><span class="op" id="8397890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397895">resp</span><span class="op" id="8397899">,</span>&nbsp;<span class="ident" id="8397901">err</span>&nbsp;<span class="op" id="8397905">:=</span>&nbsp;<span class="ident" id="8397908">test</span><span class="op" id="8397912">.</span><span class="ident" id="8397913">auth</span><span class="op" id="8397917">.</span><span class="ident" id="8397918">Next</span><span class="op" id="8397922">(</span><span class="ident" id="8397923">challenge</span><span class="op" id="8397932">,</span>&nbsp;<span class="builtintype" id="8397934">true</span><span class="op" id="8397938">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8397943">if</span>&nbsp;<span class="ident" id="8397946">err</span>&nbsp;<span class="op" id="8397950">!=</span>&nbsp;<span class="ident" id="8397953">nil</span>&nbsp;<span class="op" id="8397957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8397963">t</span><span class="op" id="8397964">.</span><span class="ident" id="8397965">Errorf</span><span class="op" id="8397971">(</span><span class="string" id="8397972">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8397987">,</span>&nbsp;<span class="ident" id="8397989">i</span><span class="op" id="8397990">,</span>&nbsp;<span class="ident" id="8397992">err</span><span class="op" id="8397995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398001">continue</span>&nbsp;<span class="ident" id="8398010">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398027">if</span>&nbsp;<span class="op" id="8398030">!</span><span class="ident" id="8398031">bytes</span><span class="op" id="8398036">.</span><span class="ident" id="8398037">Equal</span><span class="op" id="8398042">(</span><span class="ident" id="8398043">resp</span><span class="op" id="8398047">,</span>&nbsp;<span class="ident" id="8398049">expected</span><span class="op" id="8398057">)</span>&nbsp;<span class="op" id="8398059">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398065">t</span><span class="op" id="8398066">.</span><span class="ident" id="8398067">Errorf</span><span class="op" id="8398073">(</span><span class="string" id="8398074">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8398099">,</span>&nbsp;<span class="ident" id="8398101">i</span><span class="op" id="8398102">,</span>&nbsp;<span class="ident" id="8398104">resp</span><span class="op" id="8398108">,</span>&nbsp;<span class="ident" id="8398110">expected</span><span class="op" id="8398118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398124">continue</span>&nbsp;<span class="ident" id="8398133">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398152">}</span><br>
<span class="lineno">60</span><span class="op" id="8398154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8398157">func</span>&nbsp;<span class="ident" id="8398162">TestAuthPlain</span><span class="op" id="8398175">(</span><span class="ident" id="8398176">t</span>&nbsp;<span class="op" id="8398178">*</span><span class="ident" id="8398179">testing</span><span class="op" id="8398186">.</span><span class="ident" id="8398187">T</span><span class="op" id="8398188">)</span>&nbsp;<span class="op" id="8398190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398193">auth</span>&nbsp;<span class="op" id="8398198">:=</span>&nbsp;<span class="ident" id="8398201">PlainAuth</span><span class="op" id="8398210">(</span><span class="string" id="8398211">&#34;foo&#34;</span><span class="op" id="8398216">,</span>&nbsp;<span class="string" id="8398218">&#34;bar&#34;</span><span class="op" id="8398223">,</span>&nbsp;<span class="string" id="8398225">&#34;baz&#34;</span><span class="op" id="8398230">,</span>&nbsp;<span class="string" id="8398232">&#34;servername&#34;</span><span class="op" id="8398244">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398248">tests</span>&nbsp;<span class="op" id="8398254">:=</span>&nbsp;<span class="op" id="8398257">[</span><span class="op" id="8398258">]</span><span class="keyword" id="8398259">struct</span>&nbsp;<span class="op" id="8398266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398270">server</span>&nbsp;<span class="op" id="8398277">*</span><span class="ident" id="8398278">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398291">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8398298">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398306">}</span><span class="op" id="8398307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398311">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398316">server</span><span class="op" id="8398322">:</span>&nbsp;<span class="op" id="8398324">&amp;</span><span class="ident" id="8398325">ServerInfo</span><span class="op" id="8398335">{</span><span class="ident" id="8398336">Name</span><span class="op" id="8398340">:</span>&nbsp;<span class="string" id="8398342">&#34;servername&#34;</span><span class="op" id="8398354">,</span>&nbsp;<span class="ident" id="8398356">TLS</span><span class="op" id="8398359">:</span>&nbsp;<span class="builtintype" id="8398361">true</span><span class="op" id="8398365">}</span><span class="op" id="8398366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398370">}</span><span class="op" id="8398371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8398380">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398425">server</span><span class="op" id="8398431">:</span>&nbsp;<span class="op" id="8398433">&amp;</span><span class="ident" id="8398434">ServerInfo</span><span class="op" id="8398444">{</span><span class="ident" id="8398445">Name</span><span class="op" id="8398449">:</span>&nbsp;<span class="string" id="8398451">&#34;servername&#34;</span><span class="op" id="8398463">,</span>&nbsp;<span class="ident" id="8398465">Auth</span><span class="op" id="8398469">:</span>&nbsp;<span class="op" id="8398471">[</span><span class="op" id="8398472">]</span><span class="builtintype" id="8398473">string</span><span class="op" id="8398479">{</span><span class="string" id="8398480">&#34;PLAIN&#34;</span><span class="op" id="8398487">}</span><span class="op" id="8398488">}</span><span class="op" id="8398489">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398493">}</span><span class="op" id="8398494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398503">server</span><span class="op" id="8398509">:</span>&nbsp;<span class="op" id="8398511">&amp;</span><span class="ident" id="8398512">ServerInfo</span><span class="op" id="8398522">{</span><span class="ident" id="8398523">Name</span><span class="op" id="8398527">:</span>&nbsp;<span class="string" id="8398529">&#34;servername&#34;</span><span class="op" id="8398541">,</span>&nbsp;<span class="ident" id="8398543">Auth</span><span class="op" id="8398547">:</span>&nbsp;<span class="op" id="8398549">[</span><span class="op" id="8398550">]</span><span class="builtintype" id="8398551">string</span><span class="op" id="8398557">{</span><span class="string" id="8398558">&#34;CRAM-MD5&#34;</span><span class="op" id="8398568">}</span><span class="op" id="8398569">}</span><span class="op" id="8398570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398575">err</span><span class="op" id="8398578">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8398583">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="8398607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398611">}</span><span class="op" id="8398612">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398621">server</span><span class="op" id="8398627">:</span>&nbsp;<span class="op" id="8398629">&amp;</span><span class="ident" id="8398630">ServerInfo</span><span class="op" id="8398640">{</span><span class="ident" id="8398641">Name</span><span class="op" id="8398645">:</span>&nbsp;<span class="string" id="8398647">&#34;attacker&#34;</span><span class="op" id="8398657">,</span>&nbsp;<span class="ident" id="8398659">TLS</span><span class="op" id="8398662">:</span>&nbsp;<span class="builtintype" id="8398664">true</span><span class="op" id="8398668">}</span><span class="op" id="8398669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398674">err</span><span class="op" id="8398677">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8398682">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="8398699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398703">}</span><span class="op" id="8398704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398707">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398710">for</span>&nbsp;<span class="ident" id="8398714">i</span><span class="op" id="8398715">,</span>&nbsp;<span class="ident" id="8398717">tt</span>&nbsp;<span class="op" id="8398720">:=</span>&nbsp;<span class="keyword" id="8398723">range</span>&nbsp;<span class="ident" id="8398729">tests</span>&nbsp;<span class="op" id="8398735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398739">_</span><span class="op" id="8398740">,</span>&nbsp;<span class="ident" id="8398742">_</span><span class="op" id="8398743">,</span>&nbsp;<span class="ident" id="8398745">err</span>&nbsp;<span class="op" id="8398749">:=</span>&nbsp;<span class="ident" id="8398752">auth</span><span class="op" id="8398756">.</span><span class="ident" id="8398757">Start</span><span class="op" id="8398762">(</span><span class="ident" id="8398763">tt</span><span class="op" id="8398765">.</span><span class="ident" id="8398766">server</span><span class="op" id="8398772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398776">got</span>&nbsp;<span class="op" id="8398780">:=</span>&nbsp;<span class="string" id="8398783">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398788">if</span>&nbsp;<span class="ident" id="8398791">err</span>&nbsp;<span class="op" id="8398795">!=</span>&nbsp;<span class="ident" id="8398798">nil</span>&nbsp;<span class="op" id="8398802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398807">got</span>&nbsp;<span class="op" id="8398811">=</span>&nbsp;<span class="ident" id="8398813">err</span><span class="op" id="8398816">.</span><span class="ident" id="8398817">Error</span><span class="op" id="8398822">(</span><span class="op" id="8398823">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8398831">if</span>&nbsp;<span class="ident" id="8398834">got</span>&nbsp;<span class="op" id="8398838">!=</span>&nbsp;<span class="ident" id="8398841">tt</span><span class="op" id="8398843">.</span><span class="ident" id="8398844">err</span>&nbsp;<span class="op" id="8398848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398853">t</span><span class="op" id="8398854">.</span><span class="ident" id="8398855">Errorf</span><span class="op" id="8398861">(</span><span class="string" id="8398862">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8398891">,</span>&nbsp;<span class="ident" id="8398893">i</span><span class="op" id="8398894">,</span>&nbsp;<span class="ident" id="8398896">got</span><span class="op" id="8398899">,</span>&nbsp;<span class="ident" id="8398901">tt</span><span class="op" id="8398903">.</span><span class="ident" id="8398904">err</span><span class="op" id="8398907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8398914">}</span><br>
<span class="lineno">95</span><span class="op" id="8398916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8398919">type</span>&nbsp;<span class="ident" id="8398924">faker</span>&nbsp;<span class="keyword" id="8398930">struct</span>&nbsp;<span class="op" id="8398937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8398940">io</span><span class="op" id="8398942">.</span><span class="ident" id="8398943">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="8398954">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8398957">func</span>&nbsp;<span class="op" id="8398962">(</span><span class="ident" id="8398963">f</span>&nbsp;<span class="ident" id="8398965">faker</span><span class="op" id="8398970">)</span>&nbsp;<span class="ident" id="8398972">Close</span><span class="op" id="8398977">(</span><span class="op" id="8398978">)</span>&nbsp;<span class="builtintype" id="8398980">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399006">{</span>&nbsp;<span class="keyword" id="8399008">return</span>&nbsp;<span class="ident" id="8399015">nil</span>&nbsp;<span class="op" id="8399019">}</span><br>
<span class="lineno"></span><span class="keyword" id="8399021">func</span>&nbsp;<span class="op" id="8399026">(</span><span class="ident" id="8399027">f</span>&nbsp;<span class="ident" id="8399029">faker</span><span class="op" id="8399034">)</span>&nbsp;<span class="ident" id="8399036">LocalAddr</span><span class="op" id="8399045">(</span><span class="op" id="8399046">)</span>&nbsp;<span class="ident" id="8399048">net</span><span class="op" id="8399051">.</span><span class="ident" id="8399052">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399070">{</span>&nbsp;<span class="keyword" id="8399072">return</span>&nbsp;<span class="ident" id="8399079">nil</span>&nbsp;<span class="op" id="8399083">}</span><br>
<span class="lineno"></span><span class="keyword" id="8399085">func</span>&nbsp;<span class="op" id="8399090">(</span><span class="ident" id="8399091">f</span>&nbsp;<span class="ident" id="8399093">faker</span><span class="op" id="8399098">)</span>&nbsp;<span class="ident" id="8399100">RemoteAddr</span><span class="op" id="8399110">(</span><span class="op" id="8399111">)</span>&nbsp;<span class="ident" id="8399113">net</span><span class="op" id="8399116">.</span><span class="ident" id="8399117">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399134">{</span>&nbsp;<span class="keyword" id="8399136">return</span>&nbsp;<span class="ident" id="8399143">nil</span>&nbsp;<span class="op" id="8399147">}</span><br>
<span class="lineno"></span><span class="keyword" id="8399149">func</span>&nbsp;<span class="op" id="8399154">(</span><span class="ident" id="8399155">f</span>&nbsp;<span class="ident" id="8399157">faker</span><span class="op" id="8399162">)</span>&nbsp;<span class="ident" id="8399164">SetDeadline</span><span class="op" id="8399175">(</span><span class="ident" id="8399176">time</span><span class="op" id="8399180">.</span><span class="ident" id="8399181">Time</span><span class="op" id="8399185">)</span>&nbsp;<span class="builtintype" id="8399187">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8399198">{</span>&nbsp;<span class="keyword" id="8399200">return</span>&nbsp;<span class="ident" id="8399207">nil</span>&nbsp;<span class="op" id="8399211">}</span><br>
<span class="lineno">105</span><span class="keyword" id="8399213">func</span>&nbsp;<span class="op" id="8399218">(</span><span class="ident" id="8399219">f</span>&nbsp;<span class="ident" id="8399221">faker</span><span class="op" id="8399226">)</span>&nbsp;<span class="ident" id="8399228">SetReadDeadline</span><span class="op" id="8399243">(</span><span class="ident" id="8399244">time</span><span class="op" id="8399248">.</span><span class="ident" id="8399249">Time</span><span class="op" id="8399253">)</span>&nbsp;<span class="builtintype" id="8399255">error</span>&nbsp;&nbsp;<span class="op" id="8399262">{</span>&nbsp;<span class="keyword" id="8399264">return</span>&nbsp;<span class="ident" id="8399271">nil</span>&nbsp;<span class="op" id="8399275">}</span><br>
<span class="lineno"></span><span class="keyword" id="8399277">func</span>&nbsp;<span class="op" id="8399282">(</span><span class="ident" id="8399283">f</span>&nbsp;<span class="ident" id="8399285">faker</span><span class="op" id="8399290">)</span>&nbsp;<span class="ident" id="8399292">SetWriteDeadline</span><span class="op" id="8399308">(</span><span class="ident" id="8399309">time</span><span class="op" id="8399313">.</span><span class="ident" id="8399314">Time</span><span class="op" id="8399318">)</span>&nbsp;<span class="builtintype" id="8399320">error</span>&nbsp;<span class="op" id="8399326">{</span>&nbsp;<span class="keyword" id="8399328">return</span>&nbsp;<span class="ident" id="8399335">nil</span>&nbsp;<span class="op" id="8399339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8399342">func</span>&nbsp;<span class="ident" id="8399347">TestBasic</span><span class="op" id="8399356">(</span><span class="ident" id="8399357">t</span>&nbsp;<span class="op" id="8399359">*</span><span class="ident" id="8399360">testing</span><span class="op" id="8399367">.</span><span class="ident" id="8399368">T</span><span class="op" id="8399369">)</span>&nbsp;<span class="op" id="8399371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399374">server</span>&nbsp;<span class="op" id="8399381">:=</span>&nbsp;<span class="ident" id="8399384">strings</span><span class="op" id="8399391">.</span><span class="ident" id="8399392">Join</span><span class="op" id="8399396">(</span><span class="ident" id="8399397">strings</span><span class="op" id="8399404">.</span><span class="ident" id="8399405">Split</span><span class="op" id="8399410">(</span><span class="ident" id="8399411">basicServer</span><span class="op" id="8399422">,</span>&nbsp;<span class="string" id="8399424">&#34;\n&#34;</span><span class="op" id="8399428">)</span><span class="op" id="8399429">,</span>&nbsp;<span class="string" id="8399431">&#34;\r\n&#34;</span><span class="op" id="8399437">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399440">client</span>&nbsp;<span class="op" id="8399447">:=</span>&nbsp;<span class="ident" id="8399450">strings</span><span class="op" id="8399457">.</span><span class="ident" id="8399458">Join</span><span class="op" id="8399462">(</span><span class="ident" id="8399463">strings</span><span class="op" id="8399470">.</span><span class="ident" id="8399471">Split</span><span class="op" id="8399476">(</span><span class="ident" id="8399477">basicClient</span><span class="op" id="8399488">,</span>&nbsp;<span class="string" id="8399490">&#34;\n&#34;</span><span class="op" id="8399494">)</span><span class="op" id="8399495">,</span>&nbsp;<span class="string" id="8399497">&#34;\r\n&#34;</span><span class="op" id="8399503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8399507">var</span>&nbsp;<span class="ident" id="8399511">cmdbuf</span>&nbsp;<span class="ident" id="8399518">bytes</span><span class="op" id="8399523">.</span><span class="ident" id="8399524">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399532">bcmdbuf</span>&nbsp;<span class="op" id="8399540">:=</span>&nbsp;<span class="ident" id="8399543">bufio</span><span class="op" id="8399548">.</span><span class="ident" id="8399549">NewWriter</span><span class="op" id="8399558">(</span><span class="op" id="8399559">&amp;</span><span class="ident" id="8399560">cmdbuf</span><span class="op" id="8399566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8399569">var</span>&nbsp;<span class="ident" id="8399573">fake</span>&nbsp;<span class="ident" id="8399578">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399585">fake</span><span class="op" id="8399589">.</span><span class="ident" id="8399590">ReadWriter</span>&nbsp;<span class="op" id="8399601">=</span>&nbsp;<span class="ident" id="8399603">bufio</span><span class="op" id="8399608">.</span><span class="ident" id="8399609">NewReadWriter</span><span class="op" id="8399622">(</span><span class="ident" id="8399623">bufio</span><span class="op" id="8399628">.</span><span class="ident" id="8399629">NewReader</span><span class="op" id="8399638">(</span><span class="ident" id="8399639">strings</span><span class="op" id="8399646">.</span><span class="ident" id="8399647">NewReader</span><span class="op" id="8399656">(</span><span class="ident" id="8399657">server</span><span class="op" id="8399663">)</span><span class="op" id="8399664">)</span><span class="op" id="8399665">,</span>&nbsp;<span class="ident" id="8399667">bcmdbuf</span><span class="op" id="8399674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399677">c</span>&nbsp;<span class="op" id="8399679">:=</span>&nbsp;<span class="op" id="8399682">&amp;</span><span class="ident" id="8399683">Client</span><span class="op" id="8399689">{</span><span class="ident" id="8399690">Text</span><span class="op" id="8399694">:</span>&nbsp;<span class="ident" id="8399696">textproto</span><span class="op" id="8399705">.</span><span class="ident" id="8399706">NewConn</span><span class="op" id="8399713">(</span><span class="ident" id="8399714">fake</span><span class="op" id="8399718">)</span><span class="op" id="8399719">,</span>&nbsp;<span class="ident" id="8399721">localName</span><span class="op" id="8399730">:</span>&nbsp;<span class="string" id="8399732">&#34;localhost&#34;</span><span class="op" id="8399743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8399747">if</span>&nbsp;<span class="ident" id="8399750">err</span>&nbsp;<span class="op" id="8399754">:=</span>&nbsp;<span class="ident" id="8399757">c</span><span class="op" id="8399758">.</span><span class="ident" id="8399759">helo</span><span class="op" id="8399763">(</span><span class="op" id="8399764">)</span><span class="op" id="8399765">;</span>&nbsp;<span class="ident" id="8399767">err</span>&nbsp;<span class="op" id="8399771">!=</span>&nbsp;<span class="ident" id="8399774">nil</span>&nbsp;<span class="op" id="8399778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399782">t</span><span class="op" id="8399783">.</span><span class="ident" id="8399784">Fatalf</span><span class="op" id="8399790">(</span><span class="string" id="8399791">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8399808">,</span>&nbsp;<span class="ident" id="8399810">err</span><span class="op" id="8399813">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8399819">if</span>&nbsp;<span class="ident" id="8399822">err</span>&nbsp;<span class="op" id="8399826">:=</span>&nbsp;<span class="ident" id="8399829">c</span><span class="op" id="8399830">.</span><span class="ident" id="8399831">ehlo</span><span class="op" id="8399835">(</span><span class="op" id="8399836">)</span><span class="op" id="8399837">;</span>&nbsp;<span class="ident" id="8399839">err</span>&nbsp;<span class="op" id="8399843">==</span>&nbsp;<span class="ident" id="8399846">nil</span>&nbsp;<span class="op" id="8399850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399854">t</span><span class="op" id="8399855">.</span><span class="ident" id="8399856">Fatalf</span><span class="op" id="8399862">(</span><span class="string" id="8399863">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="8399892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8399898">if</span>&nbsp;<span class="ident" id="8399901">err</span>&nbsp;<span class="op" id="8399905">:=</span>&nbsp;<span class="ident" id="8399908">c</span><span class="op" id="8399909">.</span><span class="ident" id="8399910">ehlo</span><span class="op" id="8399914">(</span><span class="op" id="8399915">)</span><span class="op" id="8399916">;</span>&nbsp;<span class="ident" id="8399918">err</span>&nbsp;<span class="op" id="8399922">!=</span>&nbsp;<span class="ident" id="8399925">nil</span>&nbsp;<span class="op" id="8399929">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399933">t</span><span class="op" id="8399934">.</span><span class="ident" id="8399935">Fatalf</span><span class="op" id="8399941">(</span><span class="string" id="8399942">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8399966">,</span>&nbsp;<span class="ident" id="8399968">err</span><span class="op" id="8399971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8399974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8399978">c</span><span class="op" id="8399979">.</span><span class="ident" id="8399980">didHello</span>&nbsp;<span class="op" id="8399989">=</span>&nbsp;<span class="builtintype" id="8399991">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8399997">if</span>&nbsp;<span class="ident" id="8400000">ok</span><span class="op" id="8400002">,</span>&nbsp;<span class="ident" id="8400004">args</span>&nbsp;<span class="op" id="8400009">:=</span>&nbsp;<span class="ident" id="8400012">c</span><span class="op" id="8400013">.</span><span class="ident" id="8400014">Extension</span><span class="op" id="8400023">(</span><span class="string" id="8400024">&#34;aUtH&#34;</span><span class="op" id="8400030">)</span><span class="op" id="8400031">;</span>&nbsp;<span class="op" id="8400033">!</span><span class="ident" id="8400034">ok</span>&nbsp;<span class="op" id="8400037">||</span>&nbsp;<span class="ident" id="8400040">args</span>&nbsp;<span class="op" id="8400045">!=</span>&nbsp;<span class="string" id="8400048">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8400062">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400066">t</span><span class="op" id="8400067">.</span><span class="ident" id="8400068">Fatalf</span><span class="op" id="8400074">(</span><span class="string" id="8400075">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8400100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400106">if</span>&nbsp;<span class="ident" id="8400109">ok</span><span class="op" id="8400111">,</span>&nbsp;<span class="ident" id="8400113">_</span>&nbsp;<span class="op" id="8400115">:=</span>&nbsp;<span class="ident" id="8400118">c</span><span class="op" id="8400119">.</span><span class="ident" id="8400120">Extension</span><span class="op" id="8400129">(</span><span class="string" id="8400130">&#34;DSN&#34;</span><span class="op" id="8400135">)</span><span class="op" id="8400136">;</span>&nbsp;<span class="ident" id="8400138">ok</span>&nbsp;<span class="op" id="8400141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400145">t</span><span class="op" id="8400146">.</span><span class="ident" id="8400147">Fatalf</span><span class="op" id="8400153">(</span><span class="string" id="8400154">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8400177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400180">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400184">if</span>&nbsp;<span class="ident" id="8400187">err</span>&nbsp;<span class="op" id="8400191">:=</span>&nbsp;<span class="ident" id="8400194">c</span><span class="op" id="8400195">.</span><span class="ident" id="8400196">Mail</span><span class="op" id="8400200">(</span><span class="string" id="8400201">&#34;user@gmail.com&#34;</span><span class="op" id="8400217">)</span><span class="op" id="8400218">;</span>&nbsp;<span class="ident" id="8400220">err</span>&nbsp;<span class="op" id="8400224">==</span>&nbsp;<span class="ident" id="8400227">nil</span>&nbsp;<span class="op" id="8400231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400235">t</span><span class="op" id="8400236">.</span><span class="ident" id="8400237">Fatalf</span><span class="op" id="8400243">(</span><span class="string" id="8400244">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="8400280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400287">if</span>&nbsp;<span class="ident" id="8400290">err</span>&nbsp;<span class="op" id="8400294">:=</span>&nbsp;<span class="ident" id="8400297">c</span><span class="op" id="8400298">.</span><span class="ident" id="8400299">Verify</span><span class="op" id="8400305">(</span><span class="string" id="8400306">&#34;user1@gmail.com&#34;</span><span class="op" id="8400323">)</span><span class="op" id="8400324">;</span>&nbsp;<span class="ident" id="8400326">err</span>&nbsp;<span class="op" id="8400330">==</span>&nbsp;<span class="ident" id="8400333">nil</span>&nbsp;<span class="op" id="8400337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400341">t</span><span class="op" id="8400342">.</span><span class="ident" id="8400343">Fatalf</span><span class="op" id="8400349">(</span><span class="string" id="8400350">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="8400388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400394">if</span>&nbsp;<span class="ident" id="8400397">err</span>&nbsp;<span class="op" id="8400401">:=</span>&nbsp;<span class="ident" id="8400404">c</span><span class="op" id="8400405">.</span><span class="ident" id="8400406">Verify</span><span class="op" id="8400412">(</span><span class="string" id="8400413">&#34;user2@gmail.com&#34;</span><span class="op" id="8400430">)</span><span class="op" id="8400431">;</span>&nbsp;<span class="ident" id="8400433">err</span>&nbsp;<span class="op" id="8400437">!=</span>&nbsp;<span class="ident" id="8400440">nil</span>&nbsp;<span class="op" id="8400444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400448">t</span><span class="op" id="8400449">.</span><span class="ident" id="8400450">Fatalf</span><span class="op" id="8400456">(</span><span class="string" id="8400457">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="8400501">,</span>&nbsp;<span class="ident" id="8400503">err</span><span class="op" id="8400506">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8400513">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400559">c</span><span class="op" id="8400560">.</span><span class="ident" id="8400561">tls</span>&nbsp;<span class="op" id="8400565">=</span>&nbsp;<span class="builtintype" id="8400567">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400573">c</span><span class="op" id="8400574">.</span><span class="ident" id="8400575">serverName</span>&nbsp;<span class="op" id="8400586">=</span>&nbsp;<span class="string" id="8400588">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400607">if</span>&nbsp;<span class="ident" id="8400610">err</span>&nbsp;<span class="op" id="8400614">:=</span>&nbsp;<span class="ident" id="8400617">c</span><span class="op" id="8400618">.</span><span class="ident" id="8400619">Auth</span><span class="op" id="8400623">(</span><span class="ident" id="8400624">PlainAuth</span><span class="op" id="8400633">(</span><span class="string" id="8400634">&#34;&#34;</span><span class="op" id="8400636">,</span>&nbsp;<span class="string" id="8400638">&#34;user&#34;</span><span class="op" id="8400644">,</span>&nbsp;<span class="string" id="8400646">&#34;pass&#34;</span><span class="op" id="8400652">,</span>&nbsp;<span class="string" id="8400654">&#34;smtp.google.com&#34;</span><span class="op" id="8400671">)</span><span class="op" id="8400672">)</span><span class="op" id="8400673">;</span>&nbsp;<span class="ident" id="8400675">err</span>&nbsp;<span class="op" id="8400679">!=</span>&nbsp;<span class="ident" id="8400682">nil</span>&nbsp;<span class="op" id="8400686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400690">t</span><span class="op" id="8400691">.</span><span class="ident" id="8400692">Fatalf</span><span class="op" id="8400698">(</span><span class="string" id="8400699">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8400716">,</span>&nbsp;<span class="ident" id="8400718">err</span><span class="op" id="8400721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400728">if</span>&nbsp;<span class="ident" id="8400731">err</span>&nbsp;<span class="op" id="8400735">:=</span>&nbsp;<span class="ident" id="8400738">c</span><span class="op" id="8400739">.</span><span class="ident" id="8400740">Mail</span><span class="op" id="8400744">(</span><span class="string" id="8400745">&#34;user@gmail.com&#34;</span><span class="op" id="8400761">)</span><span class="op" id="8400762">;</span>&nbsp;<span class="ident" id="8400764">err</span>&nbsp;<span class="op" id="8400768">!=</span>&nbsp;<span class="ident" id="8400771">nil</span>&nbsp;<span class="op" id="8400775">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400779">t</span><span class="op" id="8400780">.</span><span class="ident" id="8400781">Fatalf</span><span class="op" id="8400787">(</span><span class="string" id="8400788">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8400805">,</span>&nbsp;<span class="ident" id="8400807">err</span><span class="op" id="8400810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8400816">if</span>&nbsp;<span class="ident" id="8400819">err</span>&nbsp;<span class="op" id="8400823">:=</span>&nbsp;<span class="ident" id="8400826">c</span><span class="op" id="8400827">.</span><span class="ident" id="8400828">Rcpt</span><span class="op" id="8400832">(</span><span class="string" id="8400833">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="8400863">)</span><span class="op" id="8400864">;</span>&nbsp;<span class="ident" id="8400866">err</span>&nbsp;<span class="op" id="8400870">!=</span>&nbsp;<span class="ident" id="8400873">nil</span>&nbsp;<span class="op" id="8400877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400881">t</span><span class="op" id="8400882">.</span><span class="ident" id="8400883">Fatalf</span><span class="op" id="8400889">(</span><span class="string" id="8400890">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8400907">,</span>&nbsp;<span class="ident" id="8400909">err</span><span class="op" id="8400912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8400915">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8400918">msg</span>&nbsp;<span class="op" id="8400922">:=</span>&nbsp;<span class="string" id="8400925">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401042">w</span><span class="op" id="8401043">,</span>&nbsp;<span class="ident" id="8401045">err</span>&nbsp;<span class="op" id="8401049">:=</span>&nbsp;<span class="ident" id="8401052">c</span><span class="op" id="8401053">.</span><span class="ident" id="8401054">Data</span><span class="op" id="8401058">(</span><span class="op" id="8401059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401062">if</span>&nbsp;<span class="ident" id="8401065">err</span>&nbsp;<span class="op" id="8401069">!=</span>&nbsp;<span class="ident" id="8401072">nil</span>&nbsp;<span class="op" id="8401076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401080">t</span><span class="op" id="8401081">.</span><span class="ident" id="8401082">Fatalf</span><span class="op" id="8401088">(</span><span class="string" id="8401089">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8401106">,</span>&nbsp;<span class="ident" id="8401108">err</span><span class="op" id="8401111">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401117">if</span>&nbsp;<span class="ident" id="8401120">_</span><span class="op" id="8401121">,</span>&nbsp;<span class="ident" id="8401123">err</span>&nbsp;<span class="op" id="8401127">:=</span>&nbsp;<span class="ident" id="8401130">w</span><span class="op" id="8401131">.</span><span class="ident" id="8401132">Write</span><span class="op" id="8401137">(</span><span class="op" id="8401138">[</span><span class="op" id="8401139">]</span><span class="builtintype" id="8401140">byte</span><span class="op" id="8401144">(</span><span class="ident" id="8401145">msg</span><span class="op" id="8401148">)</span><span class="op" id="8401149">)</span><span class="op" id="8401150">;</span>&nbsp;<span class="ident" id="8401152">err</span>&nbsp;<span class="op" id="8401156">!=</span>&nbsp;<span class="ident" id="8401159">nil</span>&nbsp;<span class="op" id="8401163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401167">t</span><span class="op" id="8401168">.</span><span class="ident" id="8401169">Fatalf</span><span class="op" id="8401175">(</span><span class="string" id="8401176">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8401199">,</span>&nbsp;<span class="ident" id="8401201">err</span><span class="op" id="8401204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401210">if</span>&nbsp;<span class="ident" id="8401213">err</span>&nbsp;<span class="op" id="8401217">:=</span>&nbsp;<span class="ident" id="8401220">w</span><span class="op" id="8401221">.</span><span class="ident" id="8401222">Close</span><span class="op" id="8401227">(</span><span class="op" id="8401228">)</span><span class="op" id="8401229">;</span>&nbsp;<span class="ident" id="8401231">err</span>&nbsp;<span class="op" id="8401235">!=</span>&nbsp;<span class="ident" id="8401238">nil</span>&nbsp;<span class="op" id="8401242">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401246">t</span><span class="op" id="8401247">.</span><span class="ident" id="8401248">Fatalf</span><span class="op" id="8401254">(</span><span class="string" id="8401255">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="8401278">,</span>&nbsp;<span class="ident" id="8401280">err</span><span class="op" id="8401283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401290">if</span>&nbsp;<span class="ident" id="8401293">err</span>&nbsp;<span class="op" id="8401297">:=</span>&nbsp;<span class="ident" id="8401300">c</span><span class="op" id="8401301">.</span><span class="ident" id="8401302">Quit</span><span class="op" id="8401306">(</span><span class="op" id="8401307">)</span><span class="op" id="8401308">;</span>&nbsp;<span class="ident" id="8401310">err</span>&nbsp;<span class="op" id="8401314">!=</span>&nbsp;<span class="ident" id="8401317">nil</span>&nbsp;<span class="op" id="8401321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401325">t</span><span class="op" id="8401326">.</span><span class="ident" id="8401327">Fatalf</span><span class="op" id="8401333">(</span><span class="string" id="8401334">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8401351">,</span>&nbsp;<span class="ident" id="8401353">err</span><span class="op" id="8401356">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401363">bcmdbuf</span><span class="op" id="8401370">.</span><span class="ident" id="8401371">Flush</span><span class="op" id="8401376">(</span><span class="op" id="8401377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401380">actualcmds</span>&nbsp;<span class="op" id="8401391">:=</span>&nbsp;<span class="ident" id="8401394">cmdbuf</span><span class="op" id="8401400">.</span><span class="ident" id="8401401">String</span><span class="op" id="8401407">(</span><span class="op" id="8401408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8401411">if</span>&nbsp;<span class="ident" id="8401414">client</span>&nbsp;<span class="op" id="8401421">!=</span>&nbsp;<span class="ident" id="8401424">actualcmds</span>&nbsp;<span class="op" id="8401435">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8401439">t</span><span class="op" id="8401440">.</span><span class="ident" id="8401441">Fatalf</span><span class="op" id="8401447">(</span><span class="string" id="8401448">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8401473">,</span>&nbsp;<span class="ident" id="8401475">actualcmds</span><span class="op" id="8401485">,</span>&nbsp;<span class="ident" id="8401487">client</span><span class="op" id="8401493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8401496">}</span><br>
<span class="lineno"></span><span class="op" id="8401498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8401501">var</span>&nbsp;<span class="ident" id="8401505">basicServer</span>&nbsp;<span class="op" id="8401517">=</span>&nbsp;<span class="string" id="8401519">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8401827">var</span>&nbsp;<span class="ident" id="8401831">basicClient</span>&nbsp;<span class="op" id="8401843">=</span>&nbsp;<span class="string" id="8401845">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8402212">func</span>&nbsp;<span class="ident" id="8402217">TestNewClient</span><span class="op" id="8402230">(</span><span class="ident" id="8402231">t</span>&nbsp;<span class="op" id="8402233">*</span><span class="ident" id="8402234">testing</span><span class="op" id="8402241">.</span><span class="ident" id="8402242">T</span><span class="op" id="8402243">)</span>&nbsp;<span class="op" id="8402245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402248">server</span>&nbsp;<span class="op" id="8402255">:=</span>&nbsp;<span class="ident" id="8402258">strings</span><span class="op" id="8402265">.</span><span class="ident" id="8402266">Join</span><span class="op" id="8402270">(</span><span class="ident" id="8402271">strings</span><span class="op" id="8402278">.</span><span class="ident" id="8402279">Split</span><span class="op" id="8402284">(</span><span class="ident" id="8402285">newClientServer</span><span class="op" id="8402300">,</span>&nbsp;<span class="string" id="8402302">&#34;\n&#34;</span><span class="op" id="8402306">)</span><span class="op" id="8402307">,</span>&nbsp;<span class="string" id="8402309">&#34;\r\n&#34;</span><span class="op" id="8402315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402318">client</span>&nbsp;<span class="op" id="8402325">:=</span>&nbsp;<span class="ident" id="8402328">strings</span><span class="op" id="8402335">.</span><span class="ident" id="8402336">Join</span><span class="op" id="8402340">(</span><span class="ident" id="8402341">strings</span><span class="op" id="8402348">.</span><span class="ident" id="8402349">Split</span><span class="op" id="8402354">(</span><span class="ident" id="8402355">newClientClient</span><span class="op" id="8402370">,</span>&nbsp;<span class="string" id="8402372">&#34;\n&#34;</span><span class="op" id="8402376">)</span><span class="op" id="8402377">,</span>&nbsp;<span class="string" id="8402379">&#34;\r\n&#34;</span><span class="op" id="8402385">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402389">var</span>&nbsp;<span class="ident" id="8402393">cmdbuf</span>&nbsp;<span class="ident" id="8402400">bytes</span><span class="op" id="8402405">.</span><span class="ident" id="8402406">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402414">bcmdbuf</span>&nbsp;<span class="op" id="8402422">:=</span>&nbsp;<span class="ident" id="8402425">bufio</span><span class="op" id="8402430">.</span><span class="ident" id="8402431">NewWriter</span><span class="op" id="8402440">(</span><span class="op" id="8402441">&amp;</span><span class="ident" id="8402442">cmdbuf</span><span class="op" id="8402448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402451">out</span>&nbsp;<span class="op" id="8402455">:=</span>&nbsp;<span class="keyword" id="8402458">func</span><span class="op" id="8402462">(</span><span class="op" id="8402463">)</span>&nbsp;<span class="builtintype" id="8402465">string</span>&nbsp;<span class="op" id="8402472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402476">bcmdbuf</span><span class="op" id="8402483">.</span><span class="ident" id="8402484">Flush</span><span class="op" id="8402489">(</span><span class="op" id="8402490">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402494">return</span>&nbsp;<span class="ident" id="8402501">cmdbuf</span><span class="op" id="8402507">.</span><span class="ident" id="8402508">String</span><span class="op" id="8402514">(</span><span class="op" id="8402515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402521">var</span>&nbsp;<span class="ident" id="8402525">fake</span>&nbsp;<span class="ident" id="8402530">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402537">fake</span><span class="op" id="8402541">.</span><span class="ident" id="8402542">ReadWriter</span>&nbsp;<span class="op" id="8402553">=</span>&nbsp;<span class="ident" id="8402555">bufio</span><span class="op" id="8402560">.</span><span class="ident" id="8402561">NewReadWriter</span><span class="op" id="8402574">(</span><span class="ident" id="8402575">bufio</span><span class="op" id="8402580">.</span><span class="ident" id="8402581">NewReader</span><span class="op" id="8402590">(</span><span class="ident" id="8402591">strings</span><span class="op" id="8402598">.</span><span class="ident" id="8402599">NewReader</span><span class="op" id="8402608">(</span><span class="ident" id="8402609">server</span><span class="op" id="8402615">)</span><span class="op" id="8402616">)</span><span class="op" id="8402617">,</span>&nbsp;<span class="ident" id="8402619">bcmdbuf</span><span class="op" id="8402626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402629">c</span><span class="op" id="8402630">,</span>&nbsp;<span class="ident" id="8402632">err</span>&nbsp;<span class="op" id="8402636">:=</span>&nbsp;<span class="ident" id="8402639">NewClient</span><span class="op" id="8402648">(</span><span class="ident" id="8402649">fake</span><span class="op" id="8402653">,</span>&nbsp;<span class="string" id="8402655">&#34;fake.host&#34;</span><span class="op" id="8402666">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402669">if</span>&nbsp;<span class="ident" id="8402672">err</span>&nbsp;<span class="op" id="8402676">!=</span>&nbsp;<span class="ident" id="8402679">nil</span>&nbsp;<span class="op" id="8402683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402687">t</span><span class="op" id="8402688">.</span><span class="ident" id="8402689">Fatalf</span><span class="op" id="8402695">(</span><span class="string" id="8402696">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="8402723">,</span>&nbsp;<span class="ident" id="8402725">err</span><span class="op" id="8402728">,</span>&nbsp;<span class="ident" id="8402730">out</span><span class="op" id="8402733">(</span><span class="op" id="8402734">)</span><span class="op" id="8402735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402741">defer</span>&nbsp;<span class="ident" id="8402747">c</span><span class="op" id="8402748">.</span><span class="ident" id="8402749">Close</span><span class="op" id="8402754">(</span><span class="op" id="8402755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402758">if</span>&nbsp;<span class="ident" id="8402761">ok</span><span class="op" id="8402763">,</span>&nbsp;<span class="ident" id="8402765">args</span>&nbsp;<span class="op" id="8402770">:=</span>&nbsp;<span class="ident" id="8402773">c</span><span class="op" id="8402774">.</span><span class="ident" id="8402775">Extension</span><span class="op" id="8402784">(</span><span class="string" id="8402785">&#34;aUtH&#34;</span><span class="op" id="8402791">)</span><span class="op" id="8402792">;</span>&nbsp;<span class="op" id="8402794">!</span><span class="ident" id="8402795">ok</span>&nbsp;<span class="op" id="8402798">||</span>&nbsp;<span class="ident" id="8402801">args</span>&nbsp;<span class="op" id="8402806">!=</span>&nbsp;<span class="string" id="8402809">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8402823">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402827">t</span><span class="op" id="8402828">.</span><span class="ident" id="8402829">Fatalf</span><span class="op" id="8402835">(</span><span class="string" id="8402836">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8402861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402867">if</span>&nbsp;<span class="ident" id="8402870">ok</span><span class="op" id="8402872">,</span>&nbsp;<span class="ident" id="8402874">_</span>&nbsp;<span class="op" id="8402876">:=</span>&nbsp;<span class="ident" id="8402879">c</span><span class="op" id="8402880">.</span><span class="ident" id="8402881">Extension</span><span class="op" id="8402890">(</span><span class="string" id="8402891">&#34;DSN&#34;</span><span class="op" id="8402896">)</span><span class="op" id="8402897">;</span>&nbsp;<span class="ident" id="8402899">ok</span>&nbsp;<span class="op" id="8402902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402906">t</span><span class="op" id="8402907">.</span><span class="ident" id="8402908">Fatalf</span><span class="op" id="8402914">(</span><span class="string" id="8402915">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8402938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8402941">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8402944">if</span>&nbsp;<span class="ident" id="8402947">err</span>&nbsp;<span class="op" id="8402951">:=</span>&nbsp;<span class="ident" id="8402954">c</span><span class="op" id="8402955">.</span><span class="ident" id="8402956">Quit</span><span class="op" id="8402960">(</span><span class="op" id="8402961">)</span><span class="op" id="8402962">;</span>&nbsp;<span class="ident" id="8402964">err</span>&nbsp;<span class="op" id="8402968">!=</span>&nbsp;<span class="ident" id="8402971">nil</span>&nbsp;<span class="op" id="8402975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8402979">t</span><span class="op" id="8402980">.</span><span class="ident" id="8402981">Fatalf</span><span class="op" id="8402987">(</span><span class="string" id="8402988">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8403005">,</span>&nbsp;<span class="ident" id="8403007">err</span><span class="op" id="8403010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403017">actualcmds</span>&nbsp;<span class="op" id="8403028">:=</span>&nbsp;<span class="ident" id="8403031">out</span><span class="op" id="8403034">(</span><span class="op" id="8403035">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403038">if</span>&nbsp;<span class="ident" id="8403041">client</span>&nbsp;<span class="op" id="8403048">!=</span>&nbsp;<span class="ident" id="8403051">actualcmds</span>&nbsp;<span class="op" id="8403062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403066">t</span><span class="op" id="8403067">.</span><span class="ident" id="8403068">Fatalf</span><span class="op" id="8403074">(</span><span class="string" id="8403075">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8403100">,</span>&nbsp;<span class="ident" id="8403102">actualcmds</span><span class="op" id="8403112">,</span>&nbsp;<span class="ident" id="8403114">client</span><span class="op" id="8403120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403123">}</span><br>
<span class="lineno"></span><span class="op" id="8403125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="8403128">var</span>&nbsp;<span class="ident" id="8403132">newClientServer</span>&nbsp;<span class="op" id="8403148">=</span>&nbsp;<span class="string" id="8403150">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8403263">var</span>&nbsp;<span class="ident" id="8403267">newClientClient</span>&nbsp;<span class="op" id="8403283">=</span>&nbsp;<span class="string" id="8403285">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8403309">func</span>&nbsp;<span class="ident" id="8403314">TestNewClient2</span><span class="op" id="8403328">(</span><span class="ident" id="8403329">t</span>&nbsp;<span class="op" id="8403331">*</span><span class="ident" id="8403332">testing</span><span class="op" id="8403339">.</span><span class="ident" id="8403340">T</span><span class="op" id="8403341">)</span>&nbsp;<span class="op" id="8403343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403346">server</span>&nbsp;<span class="op" id="8403353">:=</span>&nbsp;<span class="ident" id="8403356">strings</span><span class="op" id="8403363">.</span><span class="ident" id="8403364">Join</span><span class="op" id="8403368">(</span><span class="ident" id="8403369">strings</span><span class="op" id="8403376">.</span><span class="ident" id="8403377">Split</span><span class="op" id="8403382">(</span><span class="ident" id="8403383">newClient2Server</span><span class="op" id="8403399">,</span>&nbsp;<span class="string" id="8403401">&#34;\n&#34;</span><span class="op" id="8403405">)</span><span class="op" id="8403406">,</span>&nbsp;<span class="string" id="8403408">&#34;\r\n&#34;</span><span class="op" id="8403414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403417">client</span>&nbsp;<span class="op" id="8403424">:=</span>&nbsp;<span class="ident" id="8403427">strings</span><span class="op" id="8403434">.</span><span class="ident" id="8403435">Join</span><span class="op" id="8403439">(</span><span class="ident" id="8403440">strings</span><span class="op" id="8403447">.</span><span class="ident" id="8403448">Split</span><span class="op" id="8403453">(</span><span class="ident" id="8403454">newClient2Client</span><span class="op" id="8403470">,</span>&nbsp;<span class="string" id="8403472">&#34;\n&#34;</span><span class="op" id="8403476">)</span><span class="op" id="8403477">,</span>&nbsp;<span class="string" id="8403479">&#34;\r\n&#34;</span><span class="op" id="8403485">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403489">var</span>&nbsp;<span class="ident" id="8403493">cmdbuf</span>&nbsp;<span class="ident" id="8403500">bytes</span><span class="op" id="8403505">.</span><span class="ident" id="8403506">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403514">bcmdbuf</span>&nbsp;<span class="op" id="8403522">:=</span>&nbsp;<span class="ident" id="8403525">bufio</span><span class="op" id="8403530">.</span><span class="ident" id="8403531">NewWriter</span><span class="op" id="8403540">(</span><span class="op" id="8403541">&amp;</span><span class="ident" id="8403542">cmdbuf</span><span class="op" id="8403548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403551">var</span>&nbsp;<span class="ident" id="8403555">fake</span>&nbsp;<span class="ident" id="8403560">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403567">fake</span><span class="op" id="8403571">.</span><span class="ident" id="8403572">ReadWriter</span>&nbsp;<span class="op" id="8403583">=</span>&nbsp;<span class="ident" id="8403585">bufio</span><span class="op" id="8403590">.</span><span class="ident" id="8403591">NewReadWriter</span><span class="op" id="8403604">(</span><span class="ident" id="8403605">bufio</span><span class="op" id="8403610">.</span><span class="ident" id="8403611">NewReader</span><span class="op" id="8403620">(</span><span class="ident" id="8403621">strings</span><span class="op" id="8403628">.</span><span class="ident" id="8403629">NewReader</span><span class="op" id="8403638">(</span><span class="ident" id="8403639">server</span><span class="op" id="8403645">)</span><span class="op" id="8403646">)</span><span class="op" id="8403647">,</span>&nbsp;<span class="ident" id="8403649">bcmdbuf</span><span class="op" id="8403656">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403659">c</span><span class="op" id="8403660">,</span>&nbsp;<span class="ident" id="8403662">err</span>&nbsp;<span class="op" id="8403666">:=</span>&nbsp;<span class="ident" id="8403669">NewClient</span><span class="op" id="8403678">(</span><span class="ident" id="8403679">fake</span><span class="op" id="8403683">,</span>&nbsp;<span class="string" id="8403685">&#34;fake.host&#34;</span><span class="op" id="8403696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403699">if</span>&nbsp;<span class="ident" id="8403702">err</span>&nbsp;<span class="op" id="8403706">!=</span>&nbsp;<span class="ident" id="8403709">nil</span>&nbsp;<span class="op" id="8403713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403717">t</span><span class="op" id="8403718">.</span><span class="ident" id="8403719">Fatalf</span><span class="op" id="8403725">(</span><span class="string" id="8403726">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8403741">,</span>&nbsp;<span class="ident" id="8403743">err</span><span class="op" id="8403746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403752">defer</span>&nbsp;<span class="ident" id="8403758">c</span><span class="op" id="8403759">.</span><span class="ident" id="8403760">Close</span><span class="op" id="8403765">(</span><span class="op" id="8403766">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403769">if</span>&nbsp;<span class="ident" id="8403772">ok</span><span class="op" id="8403774">,</span>&nbsp;<span class="ident" id="8403776">_</span>&nbsp;<span class="op" id="8403778">:=</span>&nbsp;<span class="ident" id="8403781">c</span><span class="op" id="8403782">.</span><span class="ident" id="8403783">Extension</span><span class="op" id="8403792">(</span><span class="string" id="8403793">&#34;DSN&#34;</span><span class="op" id="8403798">)</span><span class="op" id="8403799">;</span>&nbsp;<span class="ident" id="8403801">ok</span>&nbsp;<span class="op" id="8403804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403808">t</span><span class="op" id="8403809">.</span><span class="ident" id="8403810">Fatalf</span><span class="op" id="8403816">(</span><span class="string" id="8403817">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8403840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403846">if</span>&nbsp;<span class="ident" id="8403849">err</span>&nbsp;<span class="op" id="8403853">:=</span>&nbsp;<span class="ident" id="8403856">c</span><span class="op" id="8403857">.</span><span class="ident" id="8403858">Quit</span><span class="op" id="8403862">(</span><span class="op" id="8403863">)</span><span class="op" id="8403864">;</span>&nbsp;<span class="ident" id="8403866">err</span>&nbsp;<span class="op" id="8403870">!=</span>&nbsp;<span class="ident" id="8403873">nil</span>&nbsp;<span class="op" id="8403877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403881">t</span><span class="op" id="8403882">.</span><span class="ident" id="8403883">Fatalf</span><span class="op" id="8403889">(</span><span class="string" id="8403890">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8403907">,</span>&nbsp;<span class="ident" id="8403909">err</span><span class="op" id="8403912">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8403915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403919">bcmdbuf</span><span class="op" id="8403926">.</span><span class="ident" id="8403927">Flush</span><span class="op" id="8403932">(</span><span class="op" id="8403933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403936">actualcmds</span>&nbsp;<span class="op" id="8403947">:=</span>&nbsp;<span class="ident" id="8403950">cmdbuf</span><span class="op" id="8403956">.</span><span class="ident" id="8403957">String</span><span class="op" id="8403963">(</span><span class="op" id="8403964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8403967">if</span>&nbsp;<span class="ident" id="8403970">client</span>&nbsp;<span class="op" id="8403977">!=</span>&nbsp;<span class="ident" id="8403980">actualcmds</span>&nbsp;<span class="op" id="8403991">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8403995">t</span><span class="op" id="8403996">.</span><span class="ident" id="8403997">Fatalf</span><span class="op" id="8404003">(</span><span class="string" id="8404004">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8404029">,</span>&nbsp;<span class="ident" id="8404031">actualcmds</span><span class="op" id="8404041">,</span>&nbsp;<span class="ident" id="8404043">client</span><span class="op" id="8404049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404052">}</span><br>
<span class="lineno"></span><span class="op" id="8404054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8404057">var</span>&nbsp;<span class="ident" id="8404061">newClient2Server</span>&nbsp;<span class="op" id="8404078">=</span>&nbsp;<span class="string" id="8404080">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8404201">var</span>&nbsp;<span class="ident" id="8404205">newClient2Client</span>&nbsp;<span class="op" id="8404222">=</span>&nbsp;<span class="string" id="8404224">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8404263">func</span>&nbsp;<span class="ident" id="8404268">TestHello</span><span class="op" id="8404277">(</span><span class="ident" id="8404278">t</span>&nbsp;<span class="op" id="8404280">*</span><span class="ident" id="8404281">testing</span><span class="op" id="8404288">.</span><span class="ident" id="8404289">T</span><span class="op" id="8404290">)</span>&nbsp;<span class="op" id="8404292">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404296">if</span>&nbsp;<span class="builtinfunc" id="8404299">len</span><span class="op" id="8404302">(</span><span class="ident" id="8404303">helloServer</span><span class="op" id="8404314">)</span>&nbsp;<span class="op" id="8404316">!=</span>&nbsp;<span class="builtinfunc" id="8404319">len</span><span class="op" id="8404322">(</span><span class="ident" id="8404323">helloClient</span><span class="op" id="8404334">)</span>&nbsp;<span class="op" id="8404336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404340">t</span><span class="op" id="8404341">.</span><span class="ident" id="8404342">Fatalf</span><span class="op" id="8404348">(</span><span class="string" id="8404349">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="8404388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404395">for</span>&nbsp;<span class="ident" id="8404399">i</span>&nbsp;<span class="op" id="8404401">:=</span>&nbsp;<span class="num" id="8404404">0</span><span class="op" id="8404405">;</span>&nbsp;<span class="ident" id="8404407">i</span>&nbsp;<span class="op" id="8404409">&lt;</span>&nbsp;<span class="builtinfunc" id="8404411">len</span><span class="op" id="8404414">(</span><span class="ident" id="8404415">helloServer</span><span class="op" id="8404426">)</span><span class="op" id="8404427">;</span>&nbsp;<span class="ident" id="8404429">i</span><span class="op" id="8404430">++</span>&nbsp;<span class="op" id="8404433">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404437">server</span>&nbsp;<span class="op" id="8404444">:=</span>&nbsp;<span class="ident" id="8404447">strings</span><span class="op" id="8404454">.</span><span class="ident" id="8404455">Join</span><span class="op" id="8404459">(</span><span class="ident" id="8404460">strings</span><span class="op" id="8404467">.</span><span class="ident" id="8404468">Split</span><span class="op" id="8404473">(</span><span class="ident" id="8404474">baseHelloServer</span><span class="op" id="8404489">+</span><span class="ident" id="8404490">helloServer</span><span class="op" id="8404501">[</span><span class="ident" id="8404502">i</span><span class="op" id="8404503">]</span><span class="op" id="8404504">,</span>&nbsp;<span class="string" id="8404506">&#34;\n&#34;</span><span class="op" id="8404510">)</span><span class="op" id="8404511">,</span>&nbsp;<span class="string" id="8404513">&#34;\r\n&#34;</span><span class="op" id="8404519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404523">client</span>&nbsp;<span class="op" id="8404530">:=</span>&nbsp;<span class="ident" id="8404533">strings</span><span class="op" id="8404540">.</span><span class="ident" id="8404541">Join</span><span class="op" id="8404545">(</span><span class="ident" id="8404546">strings</span><span class="op" id="8404553">.</span><span class="ident" id="8404554">Split</span><span class="op" id="8404559">(</span><span class="ident" id="8404560">baseHelloClient</span><span class="op" id="8404575">+</span><span class="ident" id="8404576">helloClient</span><span class="op" id="8404587">[</span><span class="ident" id="8404588">i</span><span class="op" id="8404589">]</span><span class="op" id="8404590">,</span>&nbsp;<span class="string" id="8404592">&#34;\n&#34;</span><span class="op" id="8404596">)</span><span class="op" id="8404597">,</span>&nbsp;<span class="string" id="8404599">&#34;\r\n&#34;</span><span class="op" id="8404605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404609">var</span>&nbsp;<span class="ident" id="8404613">cmdbuf</span>&nbsp;<span class="ident" id="8404620">bytes</span><span class="op" id="8404625">.</span><span class="ident" id="8404626">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404635">bcmdbuf</span>&nbsp;<span class="op" id="8404643">:=</span>&nbsp;<span class="ident" id="8404646">bufio</span><span class="op" id="8404651">.</span><span class="ident" id="8404652">NewWriter</span><span class="op" id="8404661">(</span><span class="op" id="8404662">&amp;</span><span class="ident" id="8404663">cmdbuf</span><span class="op" id="8404669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404673">var</span>&nbsp;<span class="ident" id="8404677">fake</span>&nbsp;<span class="ident" id="8404682">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404690">fake</span><span class="op" id="8404694">.</span><span class="ident" id="8404695">ReadWriter</span>&nbsp;<span class="op" id="8404706">=</span>&nbsp;<span class="ident" id="8404708">bufio</span><span class="op" id="8404713">.</span><span class="ident" id="8404714">NewReadWriter</span><span class="op" id="8404727">(</span><span class="ident" id="8404728">bufio</span><span class="op" id="8404733">.</span><span class="ident" id="8404734">NewReader</span><span class="op" id="8404743">(</span><span class="ident" id="8404744">strings</span><span class="op" id="8404751">.</span><span class="ident" id="8404752">NewReader</span><span class="op" id="8404761">(</span><span class="ident" id="8404762">server</span><span class="op" id="8404768">)</span><span class="op" id="8404769">)</span><span class="op" id="8404770">,</span>&nbsp;<span class="ident" id="8404772">bcmdbuf</span><span class="op" id="8404779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404783">c</span><span class="op" id="8404784">,</span>&nbsp;<span class="ident" id="8404786">err</span>&nbsp;<span class="op" id="8404790">:=</span>&nbsp;<span class="ident" id="8404793">NewClient</span><span class="op" id="8404802">(</span><span class="ident" id="8404803">fake</span><span class="op" id="8404807">,</span>&nbsp;<span class="string" id="8404809">&#34;fake.host&#34;</span><span class="op" id="8404820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404824">if</span>&nbsp;<span class="ident" id="8404827">err</span>&nbsp;<span class="op" id="8404831">!=</span>&nbsp;<span class="ident" id="8404834">nil</span>&nbsp;<span class="op" id="8404838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404843">t</span><span class="op" id="8404844">.</span><span class="ident" id="8404845">Fatalf</span><span class="op" id="8404851">(</span><span class="string" id="8404852">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8404867">,</span>&nbsp;<span class="ident" id="8404869">err</span><span class="op" id="8404872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8404876">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404880">defer</span>&nbsp;<span class="ident" id="8404886">c</span><span class="op" id="8404887">.</span><span class="ident" id="8404888">Close</span><span class="op" id="8404893">(</span><span class="op" id="8404894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404898">c</span><span class="op" id="8404899">.</span><span class="ident" id="8404900">localName</span>&nbsp;<span class="op" id="8404910">=</span>&nbsp;<span class="string" id="8404912">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404927">err</span>&nbsp;<span class="op" id="8404931">=</span>&nbsp;<span class="ident" id="8404933">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404940">switch</span>&nbsp;<span class="ident" id="8404947">i</span>&nbsp;<span class="op" id="8404949">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404953">case</span>&nbsp;<span class="num" id="8404958">0</span><span class="op" id="8404959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8404964">err</span>&nbsp;<span class="op" id="8404968">=</span>&nbsp;<span class="ident" id="8404970">c</span><span class="op" id="8404971">.</span><span class="ident" id="8404972">Hello</span><span class="op" id="8404977">(</span><span class="string" id="8404978">&#34;customhost&#34;</span><span class="op" id="8404990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8404994">case</span>&nbsp;<span class="num" id="8404999">1</span><span class="op" id="8405000">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405005">err</span>&nbsp;<span class="op" id="8405009">=</span>&nbsp;<span class="ident" id="8405011">c</span><span class="op" id="8405012">.</span><span class="ident" id="8405013">StartTLS</span><span class="op" id="8405021">(</span><span class="ident" id="8405022">nil</span><span class="op" id="8405025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405030">if</span>&nbsp;<span class="ident" id="8405033">err</span><span class="op" id="8405036">.</span><span class="ident" id="8405037">Error</span><span class="op" id="8405042">(</span><span class="op" id="8405043">)</span>&nbsp;<span class="op" id="8405045">==</span>&nbsp;<span class="string" id="8405048">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="8405070">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405076">err</span>&nbsp;<span class="op" id="8405080">=</span>&nbsp;<span class="ident" id="8405082">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405093">case</span>&nbsp;<span class="num" id="8405098">2</span><span class="op" id="8405099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405104">err</span>&nbsp;<span class="op" id="8405108">=</span>&nbsp;<span class="ident" id="8405110">c</span><span class="op" id="8405111">.</span><span class="ident" id="8405112">Verify</span><span class="op" id="8405118">(</span><span class="string" id="8405119">&#34;test@example.com&#34;</span><span class="op" id="8405137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405141">case</span>&nbsp;<span class="num" id="8405146">3</span><span class="op" id="8405147">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405152">c</span><span class="op" id="8405153">.</span><span class="ident" id="8405154">tls</span>&nbsp;<span class="op" id="8405158">=</span>&nbsp;<span class="builtintype" id="8405160">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405168">c</span><span class="op" id="8405169">.</span><span class="ident" id="8405170">serverName</span>&nbsp;<span class="op" id="8405181">=</span>&nbsp;<span class="string" id="8405183">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405204">err</span>&nbsp;<span class="op" id="8405208">=</span>&nbsp;<span class="ident" id="8405210">c</span><span class="op" id="8405211">.</span><span class="ident" id="8405212">Auth</span><span class="op" id="8405216">(</span><span class="ident" id="8405217">PlainAuth</span><span class="op" id="8405226">(</span><span class="string" id="8405227">&#34;&#34;</span><span class="op" id="8405229">,</span>&nbsp;<span class="string" id="8405231">&#34;user&#34;</span><span class="op" id="8405237">,</span>&nbsp;<span class="string" id="8405239">&#34;pass&#34;</span><span class="op" id="8405245">,</span>&nbsp;<span class="string" id="8405247">&#34;smtp.google.com&#34;</span><span class="op" id="8405264">)</span><span class="op" id="8405265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405269">case</span>&nbsp;<span class="num" id="8405274">4</span><span class="op" id="8405275">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405280">err</span>&nbsp;<span class="op" id="8405284">=</span>&nbsp;<span class="ident" id="8405286">c</span><span class="op" id="8405287">.</span><span class="ident" id="8405288">Mail</span><span class="op" id="8405292">(</span><span class="string" id="8405293">&#34;test@example.com&#34;</span><span class="op" id="8405311">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405315">case</span>&nbsp;<span class="num" id="8405320">5</span><span class="op" id="8405321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405326">ok</span><span class="op" id="8405328">,</span>&nbsp;<span class="ident" id="8405330">_</span>&nbsp;<span class="op" id="8405332">:=</span>&nbsp;<span class="ident" id="8405335">c</span><span class="op" id="8405336">.</span><span class="ident" id="8405337">Extension</span><span class="op" id="8405346">(</span><span class="string" id="8405347">&#34;feature&#34;</span><span class="op" id="8405356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405361">if</span>&nbsp;<span class="ident" id="8405364">ok</span>&nbsp;<span class="op" id="8405367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405373">t</span><span class="op" id="8405374">.</span><span class="ident" id="8405375">Errorf</span><span class="op" id="8405381">(</span><span class="string" id="8405382">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="8405420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405425">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405429">case</span>&nbsp;<span class="num" id="8405434">6</span><span class="op" id="8405435">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405440">err</span>&nbsp;<span class="op" id="8405444">=</span>&nbsp;<span class="ident" id="8405446">c</span><span class="op" id="8405447">.</span><span class="ident" id="8405448">Reset</span><span class="op" id="8405453">(</span><span class="op" id="8405454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405458">case</span>&nbsp;<span class="num" id="8405463">7</span><span class="op" id="8405464">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405469">err</span>&nbsp;<span class="op" id="8405473">=</span>&nbsp;<span class="ident" id="8405475">c</span><span class="op" id="8405476">.</span><span class="ident" id="8405477">Quit</span><span class="op" id="8405481">(</span><span class="op" id="8405482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405486">case</span>&nbsp;<span class="num" id="8405491">8</span><span class="op" id="8405492">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405497">err</span>&nbsp;<span class="op" id="8405501">=</span>&nbsp;<span class="ident" id="8405503">c</span><span class="op" id="8405504">.</span><span class="ident" id="8405505">Verify</span><span class="op" id="8405511">(</span><span class="string" id="8405512">&#34;test@example.com&#34;</span><span class="op" id="8405530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405535">if</span>&nbsp;<span class="ident" id="8405538">err</span>&nbsp;<span class="op" id="8405542">!=</span>&nbsp;<span class="ident" id="8405545">nil</span>&nbsp;<span class="op" id="8405549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405555">err</span>&nbsp;<span class="op" id="8405559">=</span>&nbsp;<span class="ident" id="8405561">c</span><span class="op" id="8405562">.</span><span class="ident" id="8405563">Hello</span><span class="op" id="8405568">(</span><span class="string" id="8405569">&#34;customhost&#34;</span><span class="op" id="8405581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405587">if</span>&nbsp;<span class="ident" id="8405590">err</span>&nbsp;<span class="op" id="8405594">!=</span>&nbsp;<span class="ident" id="8405597">nil</span>&nbsp;<span class="op" id="8405601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405608">t</span><span class="op" id="8405609">.</span><span class="ident" id="8405610">Errorf</span><span class="op" id="8405616">(</span><span class="string" id="8405617">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="8405639">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405654">default</span><span class="op" id="8405661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405666">t</span><span class="op" id="8405667">.</span><span class="ident" id="8405668">Fatalf</span><span class="op" id="8405674">(</span><span class="string" id="8405675">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="8405694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405698">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405703">if</span>&nbsp;<span class="ident" id="8405706">err</span>&nbsp;<span class="op" id="8405710">!=</span>&nbsp;<span class="ident" id="8405713">nil</span>&nbsp;<span class="op" id="8405717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405722">t</span><span class="op" id="8405723">.</span><span class="ident" id="8405724">Errorf</span><span class="op" id="8405730">(</span><span class="string" id="8405731">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8405754">,</span>&nbsp;<span class="ident" id="8405756">i</span><span class="op" id="8405757">,</span>&nbsp;<span class="ident" id="8405759">err</span><span class="op" id="8405762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405771">bcmdbuf</span><span class="op" id="8405778">.</span><span class="ident" id="8405779">Flush</span><span class="op" id="8405784">(</span><span class="op" id="8405785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405789">actualcmds</span>&nbsp;<span class="op" id="8405800">:=</span>&nbsp;<span class="ident" id="8405803">cmdbuf</span><span class="op" id="8405809">.</span><span class="ident" id="8405810">String</span><span class="op" id="8405816">(</span><span class="op" id="8405817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8405821">if</span>&nbsp;<span class="ident" id="8405824">client</span>&nbsp;<span class="op" id="8405831">!=</span>&nbsp;<span class="ident" id="8405834">actualcmds</span>&nbsp;<span class="op" id="8405845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8405850">t</span><span class="op" id="8405851">.</span><span class="ident" id="8405852">Errorf</span><span class="op" id="8405858">(</span><span class="string" id="8405859">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8405884">,</span>&nbsp;<span class="ident" id="8405886">actualcmds</span><span class="op" id="8405896">,</span>&nbsp;<span class="ident" id="8405898">client</span><span class="op" id="8405904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405908">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8405911">}</span><br>
<span class="lineno"></span><span class="op" id="8405913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8405916">var</span>&nbsp;<span class="ident" id="8405920">baseHelloServer</span>&nbsp;<span class="op" id="8405936">=</span>&nbsp;<span class="string" id="8405938">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8406012">var</span>&nbsp;<span class="ident" id="8406016">helloServer</span>&nbsp;<span class="op" id="8406028">=</span>&nbsp;<span class="op" id="8406030">[</span><span class="op" id="8406031">]</span><span class="builtintype" id="8406032">string</span><span class="op" id="8406038">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406041">&#34;&#34;</span><span class="op" id="8406043">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406046">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="8406069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406072">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="8406093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406096">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="8406112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406115">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8406132">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406135">&#34;&#34;</span><span class="op" id="8406137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406140">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="8406156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406159">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="8406174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406177">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8406194">,</span><br>
<span class="lineno"></span><span class="op" id="8406196">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="8406199">var</span>&nbsp;<span class="ident" id="8406203">baseHelloClient</span>&nbsp;<span class="op" id="8406219">=</span>&nbsp;<span class="string" id="8406221">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="8406257">var</span>&nbsp;<span class="ident" id="8406261">helloClient</span>&nbsp;<span class="op" id="8406273">=</span>&nbsp;<span class="op" id="8406275">[</span><span class="op" id="8406276">]</span><span class="builtintype" id="8406277">string</span><span class="op" id="8406283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406286">&#34;&#34;</span><span class="op" id="8406288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406291">&#34;STARTTLS\n&#34;</span><span class="op" id="8406303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406306">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8406331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406334">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="8406365">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406368">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="8406400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406403">&#34;&#34;</span><span class="op" id="8406405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406408">&#34;RSET\n&#34;</span><span class="op" id="8406416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406419">&#34;QUIT\n&#34;</span><span class="op" id="8406427">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8406430">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8406455">,</span><br>
<span class="lineno">415</span><span class="op" id="8406457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8406460">func</span>&nbsp;<span class="ident" id="8406465">TestSendMail</span><span class="op" id="8406477">(</span><span class="ident" id="8406478">t</span>&nbsp;<span class="op" id="8406480">*</span><span class="ident" id="8406481">testing</span><span class="op" id="8406488">.</span><span class="ident" id="8406489">T</span><span class="op" id="8406490">)</span>&nbsp;<span class="op" id="8406492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406495">server</span>&nbsp;<span class="op" id="8406502">:=</span>&nbsp;<span class="ident" id="8406505">strings</span><span class="op" id="8406512">.</span><span class="ident" id="8406513">Join</span><span class="op" id="8406517">(</span><span class="ident" id="8406518">strings</span><span class="op" id="8406525">.</span><span class="ident" id="8406526">Split</span><span class="op" id="8406531">(</span><span class="ident" id="8406532">sendMailServer</span><span class="op" id="8406546">,</span>&nbsp;<span class="string" id="8406548">&#34;\n&#34;</span><span class="op" id="8406552">)</span><span class="op" id="8406553">,</span>&nbsp;<span class="string" id="8406555">&#34;\r\n&#34;</span><span class="op" id="8406561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406564">client</span>&nbsp;<span class="op" id="8406571">:=</span>&nbsp;<span class="ident" id="8406574">strings</span><span class="op" id="8406581">.</span><span class="ident" id="8406582">Join</span><span class="op" id="8406586">(</span><span class="ident" id="8406587">strings</span><span class="op" id="8406594">.</span><span class="ident" id="8406595">Split</span><span class="op" id="8406600">(</span><span class="ident" id="8406601">sendMailClient</span><span class="op" id="8406615">,</span>&nbsp;<span class="string" id="8406617">&#34;\n&#34;</span><span class="op" id="8406621">)</span><span class="op" id="8406622">,</span>&nbsp;<span class="string" id="8406624">&#34;\r\n&#34;</span><span class="op" id="8406630">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406633">var</span>&nbsp;<span class="ident" id="8406637">cmdbuf</span>&nbsp;<span class="ident" id="8406644">bytes</span><span class="op" id="8406649">.</span><span class="ident" id="8406650">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406658">bcmdbuf</span>&nbsp;<span class="op" id="8406666">:=</span>&nbsp;<span class="ident" id="8406669">bufio</span><span class="op" id="8406674">.</span><span class="ident" id="8406675">NewWriter</span><span class="op" id="8406684">(</span><span class="op" id="8406685">&amp;</span><span class="ident" id="8406686">cmdbuf</span><span class="op" id="8406692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406695">l</span><span class="op" id="8406696">,</span>&nbsp;<span class="ident" id="8406698">err</span>&nbsp;<span class="op" id="8406702">:=</span>&nbsp;<span class="ident" id="8406705">net</span><span class="op" id="8406708">.</span><span class="ident" id="8406709">Listen</span><span class="op" id="8406715">(</span><span class="string" id="8406716">&#34;tcp&#34;</span><span class="op" id="8406721">,</span>&nbsp;<span class="string" id="8406723">&#34;127.0.0.1:0&#34;</span><span class="op" id="8406736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406739">if</span>&nbsp;<span class="ident" id="8406742">err</span>&nbsp;<span class="op" id="8406746">!=</span>&nbsp;<span class="ident" id="8406749">nil</span>&nbsp;<span class="op" id="8406753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406757">t</span><span class="op" id="8406758">.</span><span class="ident" id="8406759">Fatalf</span><span class="op" id="8406765">(</span><span class="string" id="8406766">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="8406800">,</span>&nbsp;<span class="ident" id="8406802">err</span><span class="op" id="8406805">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8406808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406811">defer</span>&nbsp;<span class="ident" id="8406817">l</span><span class="op" id="8406818">.</span><span class="ident" id="8406819">Close</span><span class="op" id="8406824">(</span><span class="op" id="8406825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8406829">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406862">var</span>&nbsp;<span class="ident" id="8406866">done</span>&nbsp;<span class="op" id="8406871">=</span>&nbsp;<span class="builtinfunc" id="8406873">make</span><span class="op" id="8406877">(</span><span class="keyword" id="8406878">chan</span>&nbsp;<span class="keyword" id="8406883">struct</span><span class="op" id="8406889">{</span><span class="op" id="8406890">}</span><span class="op" id="8406891">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406894">go</span>&nbsp;<span class="keyword" id="8406897">func</span><span class="op" id="8406901">(</span><span class="ident" id="8406902">data</span>&nbsp;<span class="op" id="8406907">[</span><span class="op" id="8406908">]</span><span class="builtintype" id="8406909">string</span><span class="op" id="8406915">)</span>&nbsp;<span class="op" id="8406917">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406922">defer</span>&nbsp;<span class="builtinfunc" id="8406928">close</span><span class="op" id="8406933">(</span><span class="ident" id="8406934">done</span><span class="op" id="8406938">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406943">conn</span><span class="op" id="8406947">,</span>&nbsp;<span class="ident" id="8406949">err</span>&nbsp;<span class="op" id="8406953">:=</span>&nbsp;<span class="ident" id="8406956">l</span><span class="op" id="8406957">.</span><span class="ident" id="8406958">Accept</span><span class="op" id="8406964">(</span><span class="op" id="8406965">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8406969">if</span>&nbsp;<span class="ident" id="8406972">err</span>&nbsp;<span class="op" id="8406976">!=</span>&nbsp;<span class="ident" id="8406979">nil</span>&nbsp;<span class="op" id="8406983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8406988">t</span><span class="op" id="8406989">.</span><span class="ident" id="8406990">Errorf</span><span class="op" id="8406996">(</span><span class="string" id="8406997">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8407015">,</span>&nbsp;<span class="ident" id="8407017">err</span><span class="op" id="8407020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407025">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407038">defer</span>&nbsp;<span class="ident" id="8407044">conn</span><span class="op" id="8407048">.</span><span class="ident" id="8407049">Close</span><span class="op" id="8407054">(</span><span class="op" id="8407055">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407060">tc</span>&nbsp;<span class="op" id="8407063">:=</span>&nbsp;<span class="ident" id="8407066">textproto</span><span class="op" id="8407075">.</span><span class="ident" id="8407076">NewConn</span><span class="op" id="8407083">(</span><span class="ident" id="8407084">conn</span><span class="op" id="8407088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407092">for</span>&nbsp;<span class="ident" id="8407096">i</span>&nbsp;<span class="op" id="8407098">:=</span>&nbsp;<span class="num" id="8407101">0</span><span class="op" id="8407102">;</span>&nbsp;<span class="ident" id="8407104">i</span>&nbsp;<span class="op" id="8407106">&lt;</span>&nbsp;<span class="builtinfunc" id="8407108">len</span><span class="op" id="8407111">(</span><span class="ident" id="8407112">data</span><span class="op" id="8407116">)</span>&nbsp;<span class="op" id="8407118">&amp;&amp;</span>&nbsp;<span class="ident" id="8407121">data</span><span class="op" id="8407125">[</span><span class="ident" id="8407126">i</span><span class="op" id="8407127">]</span>&nbsp;<span class="op" id="8407129">!=</span>&nbsp;<span class="string" id="8407132">&#34;&#34;</span><span class="op" id="8407134">;</span>&nbsp;<span class="ident" id="8407136">i</span><span class="op" id="8407137">++</span>&nbsp;<span class="op" id="8407140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407145">tc</span><span class="op" id="8407147">.</span><span class="ident" id="8407148">PrintfLine</span><span class="op" id="8407158">(</span><span class="ident" id="8407159">data</span><span class="op" id="8407163">[</span><span class="ident" id="8407164">i</span><span class="op" id="8407165">]</span><span class="op" id="8407166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407171">for</span>&nbsp;<span class="builtinfunc" id="8407175">len</span><span class="op" id="8407178">(</span><span class="ident" id="8407179">data</span><span class="op" id="8407183">[</span><span class="ident" id="8407184">i</span><span class="op" id="8407185">]</span><span class="op" id="8407186">)</span>&nbsp;<span class="op" id="8407188">&gt;=</span>&nbsp;<span class="num" id="8407191">4</span>&nbsp;<span class="op" id="8407193">&amp;&amp;</span>&nbsp;<span class="ident" id="8407196">data</span><span class="op" id="8407200">[</span><span class="ident" id="8407201">i</span><span class="op" id="8407202">]</span><span class="op" id="8407203">[</span><span class="num" id="8407204">3</span><span class="op" id="8407205">]</span>&nbsp;<span class="op" id="8407207">==</span>&nbsp;<span class="string" id="8407210">&#39;-&#39;</span>&nbsp;<span class="op" id="8407214">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407220">i</span><span class="op" id="8407221">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407228">tc</span><span class="op" id="8407230">.</span><span class="ident" id="8407231">PrintfLine</span><span class="op" id="8407241">(</span><span class="ident" id="8407242">data</span><span class="op" id="8407246">[</span><span class="ident" id="8407247">i</span><span class="op" id="8407248">]</span><span class="op" id="8407249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407259">if</span>&nbsp;<span class="ident" id="8407262">data</span><span class="op" id="8407266">[</span><span class="ident" id="8407267">i</span><span class="op" id="8407268">]</span>&nbsp;<span class="op" id="8407270">==</span>&nbsp;<span class="string" id="8407273">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="8407287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407293">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407308">read</span>&nbsp;<span class="op" id="8407313">:=</span>&nbsp;<span class="builtintype" id="8407316">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407325">for</span>&nbsp;<span class="op" id="8407329">!</span><span class="ident" id="8407330">read</span>&nbsp;<span class="op" id="8407335">||</span>&nbsp;<span class="ident" id="8407338">data</span><span class="op" id="8407342">[</span><span class="ident" id="8407343">i</span><span class="op" id="8407344">]</span>&nbsp;<span class="op" id="8407346">==</span>&nbsp;<span class="string" id="8407349">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8407364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407370">msg</span><span class="op" id="8407373">,</span>&nbsp;<span class="ident" id="8407375">err</span>&nbsp;<span class="op" id="8407379">:=</span>&nbsp;<span class="ident" id="8407382">tc</span><span class="op" id="8407384">.</span><span class="ident" id="8407385">ReadLine</span><span class="op" id="8407393">(</span><span class="op" id="8407394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407400">bcmdbuf</span><span class="op" id="8407407">.</span><span class="ident" id="8407408">Write</span><span class="op" id="8407413">(</span><span class="op" id="8407414">[</span><span class="op" id="8407415">]</span><span class="builtintype" id="8407416">byte</span><span class="op" id="8407420">(</span><span class="ident" id="8407421">msg</span>&nbsp;<span class="op" id="8407425">+</span>&nbsp;<span class="string" id="8407427">&#34;\r\n&#34;</span><span class="op" id="8407433">)</span><span class="op" id="8407434">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407440">read</span>&nbsp;<span class="op" id="8407445">=</span>&nbsp;<span class="builtintype" id="8407447">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407456">if</span>&nbsp;<span class="ident" id="8407459">err</span>&nbsp;<span class="op" id="8407463">!=</span>&nbsp;<span class="ident" id="8407466">nil</span>&nbsp;<span class="op" id="8407470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407477">t</span><span class="op" id="8407478">.</span><span class="ident" id="8407479">Errorf</span><span class="op" id="8407485">(</span><span class="string" id="8407486">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8407502">,</span>&nbsp;<span class="ident" id="8407504">err</span><span class="op" id="8407507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407514">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407525">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407531">if</span>&nbsp;<span class="ident" id="8407534">data</span><span class="op" id="8407538">[</span><span class="ident" id="8407539">i</span><span class="op" id="8407540">]</span>&nbsp;<span class="op" id="8407542">==</span>&nbsp;<span class="string" id="8407545">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8407560">&amp;&amp;</span>&nbsp;<span class="ident" id="8407563">msg</span>&nbsp;<span class="op" id="8407567">==</span>&nbsp;<span class="string" id="8407570">&#34;.&#34;</span>&nbsp;<span class="op" id="8407574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407581">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407600">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407603">}</span><span class="op" id="8407604">(</span><span class="ident" id="8407605">strings</span><span class="op" id="8407612">.</span><span class="ident" id="8407613">Split</span><span class="op" id="8407618">(</span><span class="ident" id="8407619">server</span><span class="op" id="8407625">,</span>&nbsp;<span class="string" id="8407627">&#34;\r\n&#34;</span><span class="op" id="8407633">)</span><span class="op" id="8407634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407638">err</span>&nbsp;<span class="op" id="8407642">=</span>&nbsp;<span class="ident" id="8407644">SendMail</span><span class="op" id="8407652">(</span><span class="ident" id="8407653">l</span><span class="op" id="8407654">.</span><span class="ident" id="8407655">Addr</span><span class="op" id="8407659">(</span><span class="op" id="8407660">)</span><span class="op" id="8407661">.</span><span class="ident" id="8407662">String</span><span class="op" id="8407668">(</span><span class="op" id="8407669">)</span><span class="op" id="8407670">,</span>&nbsp;<span class="ident" id="8407672">nil</span><span class="op" id="8407675">,</span>&nbsp;<span class="string" id="8407677">&#34;test@example.com&#34;</span><span class="op" id="8407695">,</span>&nbsp;<span class="op" id="8407697">[</span><span class="op" id="8407698">]</span><span class="builtintype" id="8407699">string</span><span class="op" id="8407705">{</span><span class="string" id="8407706">&#34;other@example.com&#34;</span><span class="op" id="8407725">}</span><span class="op" id="8407726">,</span>&nbsp;<span class="op" id="8407728">[</span><span class="op" id="8407729">]</span><span class="builtintype" id="8407730">byte</span><span class="op" id="8407734">(</span><span class="ident" id="8407735">strings</span><span class="op" id="8407742">.</span><span class="ident" id="8407743">Replace</span><span class="op" id="8407750">(</span><span class="string" id="8407751">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="8407850">,</span>&nbsp;<span class="string" id="8407852">&#34;\n&#34;</span><span class="op" id="8407856">,</span>&nbsp;<span class="string" id="8407858">&#34;\r\n&#34;</span><span class="op" id="8407864">,</span>&nbsp;<span class="op" id="8407866">-</span><span class="num" id="8407867">1</span><span class="op" id="8407868">)</span><span class="op" id="8407869">)</span><span class="op" id="8407870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407874">if</span>&nbsp;<span class="ident" id="8407877">err</span>&nbsp;<span class="op" id="8407881">!=</span>&nbsp;<span class="ident" id="8407884">nil</span>&nbsp;<span class="op" id="8407888">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407892">t</span><span class="op" id="8407893">.</span><span class="ident" id="8407894">Errorf</span><span class="op" id="8407900">(</span><span class="string" id="8407901">&#34;%v&#34;</span><span class="op" id="8407905">,</span>&nbsp;<span class="ident" id="8407907">err</span><span class="op" id="8407910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8407917">&lt;-</span><span class="ident" id="8407919">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407925">bcmdbuf</span><span class="op" id="8407932">.</span><span class="ident" id="8407933">Flush</span><span class="op" id="8407938">(</span><span class="op" id="8407939">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8407942">actualcmds</span>&nbsp;<span class="op" id="8407953">:=</span>&nbsp;<span class="ident" id="8407956">cmdbuf</span><span class="op" id="8407962">.</span><span class="ident" id="8407963">String</span><span class="op" id="8407969">(</span><span class="op" id="8407970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8407973">if</span>&nbsp;<span class="ident" id="8407976">client</span>&nbsp;<span class="op" id="8407983">!=</span>&nbsp;<span class="ident" id="8407986">actualcmds</span>&nbsp;<span class="op" id="8407997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408001">t</span><span class="op" id="8408002">.</span><span class="ident" id="8408003">Errorf</span><span class="op" id="8408009">(</span><span class="string" id="8408010">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8408035">,</span>&nbsp;<span class="ident" id="8408037">actualcmds</span><span class="op" id="8408047">,</span>&nbsp;<span class="ident" id="8408049">client</span><span class="op" id="8408055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408058">}</span><br>
<span class="lineno"></span><span class="op" id="8408060">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="8408063">var</span>&nbsp;<span class="ident" id="8408067">sendMailServer</span>&nbsp;<span class="op" id="8408082">=</span>&nbsp;<span class="string" id="8408084">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="8408213">var</span>&nbsp;<span class="ident" id="8408217">sendMailClient</span>&nbsp;<span class="op" id="8408232">=</span>&nbsp;<span class="string" id="8408234">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="8408434">func</span>&nbsp;<span class="ident" id="8408439">TestAuthFailed</span><span class="op" id="8408453">(</span><span class="ident" id="8408454">t</span>&nbsp;<span class="op" id="8408456">*</span><span class="ident" id="8408457">testing</span><span class="op" id="8408464">.</span><span class="ident" id="8408465">T</span><span class="op" id="8408466">)</span>&nbsp;<span class="op" id="8408468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408471">server</span>&nbsp;<span class="op" id="8408478">:=</span>&nbsp;<span class="ident" id="8408481">strings</span><span class="op" id="8408488">.</span><span class="ident" id="8408489">Join</span><span class="op" id="8408493">(</span><span class="ident" id="8408494">strings</span><span class="op" id="8408501">.</span><span class="ident" id="8408502">Split</span><span class="op" id="8408507">(</span><span class="ident" id="8408508">authFailedServer</span><span class="op" id="8408524">,</span>&nbsp;<span class="string" id="8408526">&#34;\n&#34;</span><span class="op" id="8408530">)</span><span class="op" id="8408531">,</span>&nbsp;<span class="string" id="8408533">&#34;\r\n&#34;</span><span class="op" id="8408539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408542">client</span>&nbsp;<span class="op" id="8408549">:=</span>&nbsp;<span class="ident" id="8408552">strings</span><span class="op" id="8408559">.</span><span class="ident" id="8408560">Join</span><span class="op" id="8408564">(</span><span class="ident" id="8408565">strings</span><span class="op" id="8408572">.</span><span class="ident" id="8408573">Split</span><span class="op" id="8408578">(</span><span class="ident" id="8408579">authFailedClient</span><span class="op" id="8408595">,</span>&nbsp;<span class="string" id="8408597">&#34;\n&#34;</span><span class="op" id="8408601">)</span><span class="op" id="8408602">,</span>&nbsp;<span class="string" id="8408604">&#34;\r\n&#34;</span><span class="op" id="8408610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408613">var</span>&nbsp;<span class="ident" id="8408617">cmdbuf</span>&nbsp;<span class="ident" id="8408624">bytes</span><span class="op" id="8408629">.</span><span class="ident" id="8408630">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408638">bcmdbuf</span>&nbsp;<span class="op" id="8408646">:=</span>&nbsp;<span class="ident" id="8408649">bufio</span><span class="op" id="8408654">.</span><span class="ident" id="8408655">NewWriter</span><span class="op" id="8408664">(</span><span class="op" id="8408665">&amp;</span><span class="ident" id="8408666">cmdbuf</span><span class="op" id="8408672">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408675">var</span>&nbsp;<span class="ident" id="8408679">fake</span>&nbsp;<span class="ident" id="8408684">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408691">fake</span><span class="op" id="8408695">.</span><span class="ident" id="8408696">ReadWriter</span>&nbsp;<span class="op" id="8408707">=</span>&nbsp;<span class="ident" id="8408709">bufio</span><span class="op" id="8408714">.</span><span class="ident" id="8408715">NewReadWriter</span><span class="op" id="8408728">(</span><span class="ident" id="8408729">bufio</span><span class="op" id="8408734">.</span><span class="ident" id="8408735">NewReader</span><span class="op" id="8408744">(</span><span class="ident" id="8408745">strings</span><span class="op" id="8408752">.</span><span class="ident" id="8408753">NewReader</span><span class="op" id="8408762">(</span><span class="ident" id="8408763">server</span><span class="op" id="8408769">)</span><span class="op" id="8408770">)</span><span class="op" id="8408771">,</span>&nbsp;<span class="ident" id="8408773">bcmdbuf</span><span class="op" id="8408780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408783">c</span><span class="op" id="8408784">,</span>&nbsp;<span class="ident" id="8408786">err</span>&nbsp;<span class="op" id="8408790">:=</span>&nbsp;<span class="ident" id="8408793">NewClient</span><span class="op" id="8408802">(</span><span class="ident" id="8408803">fake</span><span class="op" id="8408807">,</span>&nbsp;<span class="string" id="8408809">&#34;fake.host&#34;</span><span class="op" id="8408820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408823">if</span>&nbsp;<span class="ident" id="8408826">err</span>&nbsp;<span class="op" id="8408830">!=</span>&nbsp;<span class="ident" id="8408833">nil</span>&nbsp;<span class="op" id="8408837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408841">t</span><span class="op" id="8408842">.</span><span class="ident" id="8408843">Fatalf</span><span class="op" id="8408849">(</span><span class="string" id="8408850">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8408865">,</span>&nbsp;<span class="ident" id="8408867">err</span><span class="op" id="8408870">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8408873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8408876">defer</span>&nbsp;<span class="ident" id="8408882">c</span><span class="op" id="8408883">.</span><span class="ident" id="8408884">Close</span><span class="op" id="8408889">(</span><span class="op" id="8408890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408894">c</span><span class="op" id="8408895">.</span><span class="ident" id="8408896">tls</span>&nbsp;<span class="op" id="8408900">=</span>&nbsp;<span class="builtintype" id="8408902">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408908">c</span><span class="op" id="8408909">.</span><span class="ident" id="8408910">serverName</span>&nbsp;<span class="op" id="8408921">=</span>&nbsp;<span class="string" id="8408923">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8408942">err</span>&nbsp;<span class="op" id="8408946">=</span>&nbsp;<span class="ident" id="8408948">c</span><span class="op" id="8408949">.</span><span class="ident" id="8408950">Auth</span><span class="op" id="8408954">(</span><span class="ident" id="8408955">PlainAuth</span><span class="op" id="8408964">(</span><span class="string" id="8408965">&#34;&#34;</span><span class="op" id="8408967">,</span>&nbsp;<span class="string" id="8408969">&#34;user&#34;</span><span class="op" id="8408975">,</span>&nbsp;<span class="string" id="8408977">&#34;pass&#34;</span><span class="op" id="8408983">,</span>&nbsp;<span class="string" id="8408985">&#34;smtp.google.com&#34;</span><span class="op" id="8409002">)</span><span class="op" id="8409003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409007">if</span>&nbsp;<span class="ident" id="8409010">err</span>&nbsp;<span class="op" id="8409014">==</span>&nbsp;<span class="ident" id="8409017">nil</span>&nbsp;<span class="op" id="8409021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409025">t</span><span class="op" id="8409026">.</span><span class="ident" id="8409027">Error</span><span class="op" id="8409032">(</span><span class="string" id="8409033">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="8409065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409068">}</span>&nbsp;<span class="keyword" id="8409070">else</span>&nbsp;<span class="keyword" id="8409075">if</span>&nbsp;<span class="ident" id="8409078">err</span><span class="op" id="8409081">.</span><span class="ident" id="8409082">Error</span><span class="op" id="8409087">(</span><span class="op" id="8409088">)</span>&nbsp;<span class="op" id="8409090">!=</span>&nbsp;<span class="string" id="8409093">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="8409147">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409151">t</span><span class="op" id="8409152">.</span><span class="ident" id="8409153">Errorf</span><span class="op" id="8409159">(</span><span class="string" id="8409160">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="8409191">,</span>&nbsp;<span class="ident" id="8409193">err</span><span class="op" id="8409196">,</span>&nbsp;<span class="string" id="8409198">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="8409251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409258">bcmdbuf</span><span class="op" id="8409265">.</span><span class="ident" id="8409266">Flush</span><span class="op" id="8409271">(</span><span class="op" id="8409272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409275">actualcmds</span>&nbsp;<span class="op" id="8409286">:=</span>&nbsp;<span class="ident" id="8409289">cmdbuf</span><span class="op" id="8409295">.</span><span class="ident" id="8409296">String</span><span class="op" id="8409302">(</span><span class="op" id="8409303">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409306">if</span>&nbsp;<span class="ident" id="8409309">client</span>&nbsp;<span class="op" id="8409316">!=</span>&nbsp;<span class="ident" id="8409319">actualcmds</span>&nbsp;<span class="op" id="8409330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409334">t</span><span class="op" id="8409335">.</span><span class="ident" id="8409336">Errorf</span><span class="op" id="8409342">(</span><span class="string" id="8409343">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8409368">,</span>&nbsp;<span class="ident" id="8409370">actualcmds</span><span class="op" id="8409380">,</span>&nbsp;<span class="ident" id="8409382">client</span><span class="op" id="8409388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409391">}</span><br>
<span class="lineno"></span><span class="op" id="8409393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="8409396">var</span>&nbsp;<span class="ident" id="8409400">authFailedServer</span>&nbsp;<span class="op" id="8409417">=</span>&nbsp;<span class="string" id="8409419">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409561">var</span>&nbsp;<span class="ident" id="8409565">authFailedClient</span>&nbsp;<span class="op" id="8409582">=</span>&nbsp;<span class="string" id="8409584">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8409638">func</span>&nbsp;<span class="ident" id="8409643">TestTLSClient</span><span class="op" id="8409656">(</span><span class="ident" id="8409657">t</span>&nbsp;<span class="op" id="8409659">*</span><span class="ident" id="8409660">testing</span><span class="op" id="8409667">.</span><span class="ident" id="8409668">T</span><span class="op" id="8409669">)</span>&nbsp;<span class="op" id="8409671">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409674">ln</span>&nbsp;<span class="op" id="8409677">:=</span>&nbsp;<span class="ident" id="8409680">newLocalListener</span><span class="op" id="8409696">(</span><span class="ident" id="8409697">t</span><span class="op" id="8409698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409701">defer</span>&nbsp;<span class="ident" id="8409707">ln</span><span class="op" id="8409709">.</span><span class="ident" id="8409710">Close</span><span class="op" id="8409715">(</span><span class="op" id="8409716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409719">errc</span>&nbsp;<span class="op" id="8409724">:=</span>&nbsp;<span class="builtinfunc" id="8409727">make</span><span class="op" id="8409731">(</span><span class="keyword" id="8409732">chan</span>&nbsp;<span class="builtintype" id="8409737">error</span><span class="op" id="8409742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409745">go</span>&nbsp;<span class="keyword" id="8409748">func</span><span class="op" id="8409752">(</span><span class="op" id="8409753">)</span>&nbsp;<span class="op" id="8409755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409759">errc</span>&nbsp;<span class="op" id="8409764">&lt;-</span>&nbsp;<span class="ident" id="8409767">sendMail</span><span class="op" id="8409775">(</span><span class="ident" id="8409776">ln</span><span class="op" id="8409778">.</span><span class="ident" id="8409779">Addr</span><span class="op" id="8409783">(</span><span class="op" id="8409784">)</span><span class="op" id="8409785">.</span><span class="ident" id="8409786">String</span><span class="op" id="8409792">(</span><span class="op" id="8409793">)</span><span class="op" id="8409794">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409797">}</span><span class="op" id="8409798">(</span><span class="op" id="8409799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409802">conn</span><span class="op" id="8409806">,</span>&nbsp;<span class="ident" id="8409808">err</span>&nbsp;<span class="op" id="8409812">:=</span>&nbsp;<span class="ident" id="8409815">ln</span><span class="op" id="8409817">.</span><span class="ident" id="8409818">Accept</span><span class="op" id="8409824">(</span><span class="op" id="8409825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409828">if</span>&nbsp;<span class="ident" id="8409831">err</span>&nbsp;<span class="op" id="8409835">!=</span>&nbsp;<span class="ident" id="8409838">nil</span>&nbsp;<span class="op" id="8409842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409846">t</span><span class="op" id="8409847">.</span><span class="ident" id="8409848">Fatalf</span><span class="op" id="8409854">(</span><span class="string" id="8409855">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8409888">,</span>&nbsp;<span class="ident" id="8409890">err</span><span class="op" id="8409893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8409896">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409899">defer</span>&nbsp;<span class="ident" id="8409905">conn</span><span class="op" id="8409909">.</span><span class="ident" id="8409910">Close</span><span class="op" id="8409915">(</span><span class="op" id="8409916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8409919">if</span>&nbsp;<span class="ident" id="8409922">err</span>&nbsp;<span class="op" id="8409926">:=</span>&nbsp;<span class="ident" id="8409929">serverHandle</span><span class="op" id="8409941">(</span><span class="ident" id="8409942">conn</span><span class="op" id="8409946">,</span>&nbsp;<span class="ident" id="8409948">t</span><span class="op" id="8409949">)</span><span class="op" id="8409950">;</span>&nbsp;<span class="ident" id="8409952">err</span>&nbsp;<span class="op" id="8409956">!=</span>&nbsp;<span class="ident" id="8409959">nil</span>&nbsp;<span class="op" id="8409963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8409967">t</span><span class="op" id="8409968">.</span><span class="ident" id="8409969">Fatalf</span><span class="op" id="8409975">(</span><span class="string" id="8409976">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8410009">,</span>&nbsp;<span class="ident" id="8410011">err</span><span class="op" id="8410014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410020">if</span>&nbsp;<span class="ident" id="8410023">err</span>&nbsp;<span class="op" id="8410027">:=</span>&nbsp;<span class="op" id="8410030">&lt;-</span><span class="ident" id="8410032">errc</span><span class="op" id="8410036">;</span>&nbsp;<span class="ident" id="8410038">err</span>&nbsp;<span class="op" id="8410042">!=</span>&nbsp;<span class="ident" id="8410045">nil</span>&nbsp;<span class="op" id="8410049">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410053">t</span><span class="op" id="8410054">.</span><span class="ident" id="8410055">Fatalf</span><span class="op" id="8410061">(</span><span class="string" id="8410062">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8410080">,</span>&nbsp;<span class="ident" id="8410082">err</span><span class="op" id="8410085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410088">}</span><br>
<span class="lineno"></span><span class="op" id="8410090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8410093">func</span>&nbsp;<span class="ident" id="8410098">newLocalListener</span><span class="op" id="8410114">(</span><span class="ident" id="8410115">t</span>&nbsp;<span class="op" id="8410117">*</span><span class="ident" id="8410118">testing</span><span class="op" id="8410125">.</span><span class="ident" id="8410126">T</span><span class="op" id="8410127">)</span>&nbsp;<span class="ident" id="8410129">net</span><span class="op" id="8410132">.</span><span class="ident" id="8410133">Listener</span>&nbsp;<span class="op" id="8410142">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410145">ln</span><span class="op" id="8410147">,</span>&nbsp;<span class="ident" id="8410149">err</span>&nbsp;<span class="op" id="8410153">:=</span>&nbsp;<span class="ident" id="8410156">net</span><span class="op" id="8410159">.</span><span class="ident" id="8410160">Listen</span><span class="op" id="8410166">(</span><span class="string" id="8410167">&#34;tcp&#34;</span><span class="op" id="8410172">,</span>&nbsp;<span class="string" id="8410174">&#34;127.0.0.1:0&#34;</span><span class="op" id="8410187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410190">if</span>&nbsp;<span class="ident" id="8410193">err</span>&nbsp;<span class="op" id="8410197">!=</span>&nbsp;<span class="ident" id="8410200">nil</span>&nbsp;<span class="op" id="8410204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410208">ln</span><span class="op" id="8410210">,</span>&nbsp;<span class="ident" id="8410212">err</span>&nbsp;<span class="op" id="8410216">=</span>&nbsp;<span class="ident" id="8410218">net</span><span class="op" id="8410221">.</span><span class="ident" id="8410222">Listen</span><span class="op" id="8410228">(</span><span class="string" id="8410229">&#34;tcp6&#34;</span><span class="op" id="8410235">,</span>&nbsp;<span class="string" id="8410237">&#34;[::1]:0&#34;</span><span class="op" id="8410246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410252">if</span>&nbsp;<span class="ident" id="8410255">err</span>&nbsp;<span class="op" id="8410259">!=</span>&nbsp;<span class="ident" id="8410262">nil</span>&nbsp;<span class="op" id="8410266">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410270">t</span><span class="op" id="8410271">.</span><span class="ident" id="8410272">Fatal</span><span class="op" id="8410277">(</span><span class="ident" id="8410278">err</span><span class="op" id="8410281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410287">return</span>&nbsp;<span class="ident" id="8410294">ln</span><br>
<span class="lineno"></span><span class="op" id="8410297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="8410300">type</span>&nbsp;<span class="ident" id="8410305">smtpSender</span>&nbsp;<span class="keyword" id="8410316">struct</span>&nbsp;<span class="op" id="8410323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410326">w</span>&nbsp;<span class="ident" id="8410328">io</span><span class="op" id="8410330">.</span><span class="ident" id="8410331">Writer</span><br>
<span class="lineno"></span><span class="op" id="8410338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8410341">func</span>&nbsp;<span class="op" id="8410346">(</span><span class="ident" id="8410347">s</span>&nbsp;<span class="ident" id="8410349">smtpSender</span><span class="op" id="8410359">)</span>&nbsp;<span class="ident" id="8410361">send</span><span class="op" id="8410365">(</span><span class="ident" id="8410366">f</span>&nbsp;<span class="builtintype" id="8410368">string</span><span class="op" id="8410374">)</span>&nbsp;<span class="op" id="8410376">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410379">s</span><span class="op" id="8410380">.</span><span class="ident" id="8410381">w</span><span class="op" id="8410382">.</span><span class="ident" id="8410383">Write</span><span class="op" id="8410388">(</span><span class="op" id="8410389">[</span><span class="op" id="8410390">]</span><span class="builtintype" id="8410391">byte</span><span class="op" id="8410395">(</span><span class="ident" id="8410396">f</span>&nbsp;<span class="op" id="8410398">+</span>&nbsp;<span class="string" id="8410400">&#34;\r\n&#34;</span><span class="op" id="8410406">)</span><span class="op" id="8410407">)</span><br>
<span class="lineno"></span><span class="op" id="8410409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8410412">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="8410478">func</span>&nbsp;<span class="ident" id="8410483">serverHandle</span><span class="op" id="8410495">(</span><span class="ident" id="8410496">c</span>&nbsp;<span class="ident" id="8410498">net</span><span class="op" id="8410501">.</span><span class="ident" id="8410502">Conn</span><span class="op" id="8410506">,</span>&nbsp;<span class="ident" id="8410508">t</span>&nbsp;<span class="op" id="8410510">*</span><span class="ident" id="8410511">testing</span><span class="op" id="8410518">.</span><span class="ident" id="8410519">T</span><span class="op" id="8410520">)</span>&nbsp;<span class="builtintype" id="8410522">error</span>&nbsp;<span class="op" id="8410528">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410531">send</span>&nbsp;<span class="op" id="8410536">:=</span>&nbsp;<span class="ident" id="8410539">smtpSender</span><span class="op" id="8410549">{</span><span class="ident" id="8410550">c</span><span class="op" id="8410551">}</span><span class="op" id="8410552">.</span><span class="ident" id="8410553">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410559">send</span><span class="op" id="8410563">(</span><span class="string" id="8410564">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="8410599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410602">s</span>&nbsp;<span class="op" id="8410604">:=</span>&nbsp;<span class="ident" id="8410607">bufio</span><span class="op" id="8410612">.</span><span class="ident" id="8410613">NewScanner</span><span class="op" id="8410623">(</span><span class="ident" id="8410624">c</span><span class="op" id="8410625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410628">for</span>&nbsp;<span class="ident" id="8410632">s</span><span class="op" id="8410633">.</span><span class="ident" id="8410634">Scan</span><span class="op" id="8410638">(</span><span class="op" id="8410639">)</span>&nbsp;<span class="op" id="8410641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410645">switch</span>&nbsp;<span class="ident" id="8410652">s</span><span class="op" id="8410653">.</span><span class="ident" id="8410654">Text</span><span class="op" id="8410658">(</span><span class="op" id="8410659">)</span>&nbsp;<span class="op" id="8410661">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410665">case</span>&nbsp;<span class="string" id="8410670">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8410686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410691">send</span><span class="op" id="8410695">(</span><span class="string" id="8410696">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="8410746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410751">send</span><span class="op" id="8410755">(</span><span class="string" id="8410756">&#34;250-STARTTLS&#34;</span><span class="op" id="8410770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410775">send</span><span class="op" id="8410779">(</span><span class="string" id="8410780">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8410788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410792">case</span>&nbsp;<span class="string" id="8410797">&#34;STARTTLS&#34;</span><span class="op" id="8410807">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410812">send</span><span class="op" id="8410816">(</span><span class="string" id="8410817">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="8410831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410836">keypair</span><span class="op" id="8410843">,</span>&nbsp;<span class="ident" id="8410845">err</span>&nbsp;<span class="op" id="8410849">:=</span>&nbsp;<span class="ident" id="8410852">tls</span><span class="op" id="8410855">.</span><span class="ident" id="8410856">X509KeyPair</span><span class="op" id="8410867">(</span><span class="ident" id="8410868">localhostCert</span><span class="op" id="8410881">,</span>&nbsp;<span class="ident" id="8410883">localhostKey</span><span class="op" id="8410895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410900">if</span>&nbsp;<span class="ident" id="8410903">err</span>&nbsp;<span class="op" id="8410907">!=</span>&nbsp;<span class="ident" id="8410910">nil</span>&nbsp;<span class="op" id="8410914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8410920">return</span>&nbsp;<span class="ident" id="8410927">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8410934">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8410939">config</span>&nbsp;<span class="op" id="8410946">:=</span>&nbsp;<span class="op" id="8410949">&amp;</span><span class="ident" id="8410950">tls</span><span class="op" id="8410953">.</span><span class="ident" id="8410954">Config</span><span class="op" id="8410960">{</span><span class="ident" id="8410961">Certificates</span><span class="op" id="8410973">:</span>&nbsp;<span class="op" id="8410975">[</span><span class="op" id="8410976">]</span><span class="ident" id="8410977">tls</span><span class="op" id="8410980">.</span><span class="ident" id="8410981">Certificate</span><span class="op" id="8410992">{</span><span class="ident" id="8410993">keypair</span><span class="op" id="8411000">}</span><span class="op" id="8411001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411006">c</span>&nbsp;<span class="op" id="8411008">=</span>&nbsp;<span class="ident" id="8411010">tls</span><span class="op" id="8411013">.</span><span class="ident" id="8411014">Server</span><span class="op" id="8411020">(</span><span class="ident" id="8411021">c</span><span class="op" id="8411022">,</span>&nbsp;<span class="ident" id="8411024">config</span><span class="op" id="8411030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411035">defer</span>&nbsp;<span class="ident" id="8411041">c</span><span class="op" id="8411042">.</span><span class="ident" id="8411043">Close</span><span class="op" id="8411048">(</span><span class="op" id="8411049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411054">return</span>&nbsp;<span class="ident" id="8411061">serverHandleTLS</span><span class="op" id="8411076">(</span><span class="ident" id="8411077">c</span><span class="op" id="8411078">,</span>&nbsp;<span class="ident" id="8411080">t</span><span class="op" id="8411081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411085">default</span><span class="op" id="8411092">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411097">t</span><span class="op" id="8411098">.</span><span class="ident" id="8411099">Fatalf</span><span class="op" id="8411105">(</span><span class="string" id="8411106">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="8411132">,</span>&nbsp;<span class="ident" id="8411134">s</span><span class="op" id="8411135">.</span><span class="ident" id="8411136">Text</span><span class="op" id="8411140">(</span><span class="op" id="8411141">)</span><span class="op" id="8411142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411152">return</span>&nbsp;<span class="ident" id="8411159">s</span><span class="op" id="8411160">.</span><span class="ident" id="8411161">Err</span><span class="op" id="8411164">(</span><span class="op" id="8411165">)</span><br>
<span class="lineno"></span><span class="op" id="8411167">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="8411170">func</span>&nbsp;<span class="ident" id="8411175">serverHandleTLS</span><span class="op" id="8411190">(</span><span class="ident" id="8411191">c</span>&nbsp;<span class="ident" id="8411193">net</span><span class="op" id="8411196">.</span><span class="ident" id="8411197">Conn</span><span class="op" id="8411201">,</span>&nbsp;<span class="ident" id="8411203">t</span>&nbsp;<span class="op" id="8411205">*</span><span class="ident" id="8411206">testing</span><span class="op" id="8411213">.</span><span class="ident" id="8411214">T</span><span class="op" id="8411215">)</span>&nbsp;<span class="builtintype" id="8411217">error</span>&nbsp;<span class="op" id="8411223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411226">send</span>&nbsp;<span class="op" id="8411231">:=</span>&nbsp;<span class="ident" id="8411234">smtpSender</span><span class="op" id="8411244">{</span><span class="ident" id="8411245">c</span><span class="op" id="8411246">}</span><span class="op" id="8411247">.</span><span class="ident" id="8411248">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411254">s</span>&nbsp;<span class="op" id="8411256">:=</span>&nbsp;<span class="ident" id="8411259">bufio</span><span class="op" id="8411264">.</span><span class="ident" id="8411265">NewScanner</span><span class="op" id="8411275">(</span><span class="ident" id="8411276">c</span><span class="op" id="8411277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411280">for</span>&nbsp;<span class="ident" id="8411284">s</span><span class="op" id="8411285">.</span><span class="ident" id="8411286">Scan</span><span class="op" id="8411290">(</span><span class="op" id="8411291">)</span>&nbsp;<span class="op" id="8411293">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411297">switch</span>&nbsp;<span class="ident" id="8411304">s</span><span class="op" id="8411305">.</span><span class="ident" id="8411306">Text</span><span class="op" id="8411310">(</span><span class="op" id="8411311">)</span>&nbsp;<span class="op" id="8411313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411317">case</span>&nbsp;<span class="string" id="8411322">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8411338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411343">send</span><span class="op" id="8411347">(</span><span class="string" id="8411348">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8411356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411360">case</span>&nbsp;<span class="string" id="8411365">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="8411395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411400">send</span><span class="op" id="8411404">(</span><span class="string" id="8411405">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8411413">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411417">case</span>&nbsp;<span class="string" id="8411422">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="8411450">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411455">send</span><span class="op" id="8411459">(</span><span class="string" id="8411460">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8411468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411472">case</span>&nbsp;<span class="string" id="8411477">&#34;DATA&#34;</span><span class="op" id="8411483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411488">send</span><span class="op" id="8411492">(</span><span class="string" id="8411493">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="8411529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411534">send</span><span class="op" id="8411538">(</span><span class="string" id="8411539">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8411547">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411551">case</span>&nbsp;<span class="string" id="8411556">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="8411571">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411575">case</span>&nbsp;<span class="string" id="8411580">&#34;&#34;</span><span class="op" id="8411582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411586">case</span>&nbsp;<span class="string" id="8411591">&#34;howdy!&#34;</span><span class="op" id="8411599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411603">case</span>&nbsp;<span class="string" id="8411608">&#34;.&#34;</span><span class="op" id="8411611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411615">case</span>&nbsp;<span class="string" id="8411620">&#34;QUIT&#34;</span><span class="op" id="8411626">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411631">send</span><span class="op" id="8411635">(</span><span class="string" id="8411636">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="8411688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411693">return</span>&nbsp;<span class="ident" id="8411700">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411706">default</span><span class="op" id="8411713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411718">t</span><span class="op" id="8411719">.</span><span class="ident" id="8411720">Fatalf</span><span class="op" id="8411726">(</span><span class="string" id="8411727">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="8411764">,</span>&nbsp;<span class="ident" id="8411766">s</span><span class="op" id="8411767">.</span><span class="ident" id="8411768">Text</span><span class="op" id="8411772">(</span><span class="op" id="8411773">)</span><span class="op" id="8411774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411778">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8411784">return</span>&nbsp;<span class="ident" id="8411791">s</span><span class="op" id="8411792">.</span><span class="ident" id="8411793">Err</span><span class="op" id="8411796">(</span><span class="op" id="8411797">)</span><br>
<span class="lineno"></span><span class="op" id="8411799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8411802">func</span>&nbsp;<span class="ident" id="8411807">init</span><span class="op" id="8411811">(</span><span class="op" id="8411812">)</span>&nbsp;<span class="op" id="8411814">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411817">testRootCAs</span>&nbsp;<span class="op" id="8411829">:=</span>&nbsp;<span class="ident" id="8411832">x509</span><span class="op" id="8411836">.</span><span class="ident" id="8411837">NewCertPool</span><span class="op" id="8411848">(</span><span class="op" id="8411849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411852">testRootCAs</span><span class="op" id="8411863">.</span><span class="ident" id="8411864">AppendCertsFromPEM</span><span class="op" id="8411882">(</span><span class="ident" id="8411883">localhostCert</span><span class="op" id="8411896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411899">testHookStartTLS</span>&nbsp;<span class="op" id="8411916">=</span>&nbsp;<span class="keyword" id="8411918">func</span><span class="op" id="8411922">(</span><span class="ident" id="8411923">config</span>&nbsp;<span class="op" id="8411930">*</span><span class="ident" id="8411931">tls</span><span class="op" id="8411934">.</span><span class="ident" id="8411935">Config</span><span class="op" id="8411941">)</span>&nbsp;<span class="op" id="8411943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8411947">config</span><span class="op" id="8411953">.</span><span class="ident" id="8411954">RootCAs</span>&nbsp;<span class="op" id="8411962">=</span>&nbsp;<span class="ident" id="8411964">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8411977">}</span><br>
<span class="lineno">655</span><span class="op" id="8411979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8411982">func</span>&nbsp;<span class="ident" id="8411987">sendMail</span><span class="op" id="8411995">(</span><span class="ident" id="8411996">hostPort</span>&nbsp;<span class="builtintype" id="8412005">string</span><span class="op" id="8412011">)</span>&nbsp;<span class="builtintype" id="8412013">error</span>&nbsp;<span class="op" id="8412019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412022">host</span><span class="op" id="8412026">,</span>&nbsp;<span class="ident" id="8412028">_</span><span class="op" id="8412029">,</span>&nbsp;<span class="ident" id="8412031">err</span>&nbsp;<span class="op" id="8412035">:=</span>&nbsp;<span class="ident" id="8412038">net</span><span class="op" id="8412041">.</span><span class="ident" id="8412042">SplitHostPort</span><span class="op" id="8412055">(</span><span class="ident" id="8412056">hostPort</span><span class="op" id="8412064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412067">if</span>&nbsp;<span class="ident" id="8412070">err</span>&nbsp;<span class="op" id="8412074">!=</span>&nbsp;<span class="ident" id="8412077">nil</span>&nbsp;<span class="op" id="8412081">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412085">return</span>&nbsp;<span class="ident" id="8412092">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8412097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412100">auth</span>&nbsp;<span class="op" id="8412105">:=</span>&nbsp;<span class="ident" id="8412108">PlainAuth</span><span class="op" id="8412117">(</span><span class="string" id="8412118">&#34;&#34;</span><span class="op" id="8412120">,</span>&nbsp;<span class="string" id="8412122">&#34;&#34;</span><span class="op" id="8412124">,</span>&nbsp;<span class="string" id="8412126">&#34;&#34;</span><span class="op" id="8412128">,</span>&nbsp;<span class="ident" id="8412130">host</span><span class="op" id="8412134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412137">from</span>&nbsp;<span class="op" id="8412142">:=</span>&nbsp;<span class="string" id="8412145">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8412165">to</span>&nbsp;<span class="op" id="8412168">:=</span>&nbsp;<span class="op" id="8412171">[</span><span class="op" id="8412172">]</span><span class="builtintype" id="8412173">string</span><span class="op" id="8412179">{</span><span class="string" id="8412180">&#34;joe2@example.com&#34;</span><span class="op" id="8412198">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8412201">return</span>&nbsp;<span class="ident" id="8412208">SendMail</span><span class="op" id="8412216">(</span><span class="ident" id="8412217">hostPort</span><span class="op" id="8412225">,</span>&nbsp;<span class="ident" id="8412227">auth</span><span class="op" id="8412231">,</span>&nbsp;<span class="ident" id="8412233">from</span><span class="op" id="8412237">,</span>&nbsp;<span class="ident" id="8412239">to</span><span class="op" id="8412241">,</span>&nbsp;<span class="op" id="8412243">[</span><span class="op" id="8412244">]</span><span class="builtintype" id="8412245">byte</span><span class="op" id="8412249">(</span><span class="string" id="8412250">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="8412275">)</span><span class="op" id="8412276">)</span><br>
<span class="lineno"></span><span class="op" id="8412278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8412281">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="8412316">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="8412372">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="8412445">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="8412464">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="8412498">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="8412634">var</span>&nbsp;<span class="ident" id="8412638">localhostCert</span>&nbsp;<span class="op" id="8412652">=</span>&nbsp;<span class="op" id="8412654">[</span><span class="op" id="8412655">]</span><span class="builtintype" id="8412656">byte</span><span class="op" id="8412660">(</span><span class="string" id="8412661">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="8413232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="8413235">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="8413289">var</span>&nbsp;<span class="ident" id="8413293">localhostKey</span>&nbsp;<span class="op" id="8413306">=</span>&nbsp;<span class="op" id="8413308">[</span><span class="op" id="8413309">]</span><span class="builtintype" id="8413310">byte</span><span class="op" id="8413314">(</span><span class="string" id="8413315">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="8413813">)</span>
</div>
</body>
</html>
