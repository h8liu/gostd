<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html" class="current">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7533437">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7533492">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7533546">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7533597">package</span>&nbsp;<span class="ident" id="7533605">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7533611">import</span>&nbsp;<span class="op" id="7533618">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533621">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533630">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533639">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533653">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533668">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533674">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533681">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533698">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533709">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7533720">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7533727">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7533730">type</span>&nbsp;<span class="ident" id="7533735">authTest</span>&nbsp;<span class="keyword" id="7533744">struct</span>&nbsp;<span class="op" id="7533751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7533754">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7533765">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7533771">challenges</span>&nbsp;<span class="op" id="7533782">[</span><span class="op" id="7533783">]</span><span class="builtintype" id="7533784">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7533792">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7533803">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7533811">responses</span>&nbsp;&nbsp;<span class="op" id="7533822">[</span><span class="op" id="7533823">]</span><span class="builtintype" id="7533824">string</span><br>
<span class="lineno">25</span><span class="op" id="7533831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7533834">var</span>&nbsp;<span class="ident" id="7533838">authTests</span>&nbsp;<span class="op" id="7533848">=</span>&nbsp;<span class="op" id="7533850">[</span><span class="op" id="7533851">]</span><span class="ident" id="7533852">authTest</span><span class="op" id="7533860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7533863">{</span><span class="ident" id="7533864">PlainAuth</span><span class="op" id="7533873">(</span><span class="string" id="7533874">&#34;&#34;</span><span class="op" id="7533876">,</span>&nbsp;<span class="string" id="7533878">&#34;user&#34;</span><span class="op" id="7533884">,</span>&nbsp;<span class="string" id="7533886">&#34;pass&#34;</span><span class="op" id="7533892">,</span>&nbsp;<span class="string" id="7533894">&#34;testserver&#34;</span><span class="op" id="7533906">)</span><span class="op" id="7533907">,</span>&nbsp;<span class="op" id="7533909">[</span><span class="op" id="7533910">]</span><span class="builtintype" id="7533911">string</span><span class="op" id="7533917">{</span><span class="op" id="7533918">}</span><span class="op" id="7533919">,</span>&nbsp;<span class="string" id="7533921">&#34;PLAIN&#34;</span><span class="op" id="7533928">,</span>&nbsp;<span class="op" id="7533930">[</span><span class="op" id="7533931">]</span><span class="builtintype" id="7533932">string</span><span class="op" id="7533938">{</span><span class="string" id="7533939">&#34;\x00user\x00pass&#34;</span><span class="op" id="7533957">}</span><span class="op" id="7533958">}</span><span class="op" id="7533959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7533962">{</span><span class="ident" id="7533963">PlainAuth</span><span class="op" id="7533972">(</span><span class="string" id="7533973">&#34;foo&#34;</span><span class="op" id="7533978">,</span>&nbsp;<span class="string" id="7533980">&#34;bar&#34;</span><span class="op" id="7533985">,</span>&nbsp;<span class="string" id="7533987">&#34;baz&#34;</span><span class="op" id="7533992">,</span>&nbsp;<span class="string" id="7533994">&#34;testserver&#34;</span><span class="op" id="7534006">)</span><span class="op" id="7534007">,</span>&nbsp;<span class="op" id="7534009">[</span><span class="op" id="7534010">]</span><span class="builtintype" id="7534011">string</span><span class="op" id="7534017">{</span><span class="op" id="7534018">}</span><span class="op" id="7534019">,</span>&nbsp;<span class="string" id="7534021">&#34;PLAIN&#34;</span><span class="op" id="7534028">,</span>&nbsp;<span class="op" id="7534030">[</span><span class="op" id="7534031">]</span><span class="builtintype" id="7534032">string</span><span class="op" id="7534038">{</span><span class="string" id="7534039">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="7534058">}</span><span class="op" id="7534059">}</span><span class="op" id="7534060">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7534063">{</span><span class="ident" id="7534064">CRAMMD5Auth</span><span class="op" id="7534075">(</span><span class="string" id="7534076">&#34;user&#34;</span><span class="op" id="7534082">,</span>&nbsp;<span class="string" id="7534084">&#34;pass&#34;</span><span class="op" id="7534090">)</span><span class="op" id="7534091">,</span>&nbsp;<span class="op" id="7534093">[</span><span class="op" id="7534094">]</span><span class="builtintype" id="7534095">string</span><span class="op" id="7534101">{</span><span class="string" id="7534102">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="7534134">}</span><span class="op" id="7534135">,</span>&nbsp;<span class="string" id="7534137">&#34;CRAM-MD5&#34;</span><span class="op" id="7534147">,</span>&nbsp;<span class="op" id="7534149">[</span><span class="op" id="7534150">]</span><span class="builtintype" id="7534151">string</span><span class="op" id="7534157">{</span><span class="string" id="7534158">&#34;&#34;</span><span class="op" id="7534160">,</span>&nbsp;<span class="string" id="7534162">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="7534201">}</span><span class="op" id="7534202">}</span><span class="op" id="7534203">,</span><br>
<span class="lineno"></span><span class="op" id="7534205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7534208">func</span>&nbsp;<span class="ident" id="7534213">TestAuth</span><span class="op" id="7534221">(</span><span class="ident" id="7534222">t</span>&nbsp;<span class="op" id="7534224">*</span><span class="ident" id="7534225">testing</span><span class="op" id="7534232">.</span><span class="ident" id="7534233">T</span><span class="op" id="7534234">)</span>&nbsp;<span class="op" id="7534236">{</span><br>
<span class="lineno"></span><span class="ident" id="7534238">testLoop</span><span class="op" id="7534246">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534249">for</span>&nbsp;<span class="ident" id="7534253">i</span><span class="op" id="7534254">,</span>&nbsp;<span class="ident" id="7534256">test</span>&nbsp;<span class="op" id="7534261">:=</span>&nbsp;<span class="keyword" id="7534264">range</span>&nbsp;<span class="ident" id="7534270">authTests</span>&nbsp;<span class="op" id="7534280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534284">name</span><span class="op" id="7534288">,</span>&nbsp;<span class="ident" id="7534290">resp</span><span class="op" id="7534294">,</span>&nbsp;<span class="ident" id="7534296">err</span>&nbsp;<span class="op" id="7534300">:=</span>&nbsp;<span class="ident" id="7534303">test</span><span class="op" id="7534307">.</span><span class="ident" id="7534308">auth</span><span class="op" id="7534312">.</span><span class="ident" id="7534313">Start</span><span class="op" id="7534318">(</span><span class="op" id="7534319">&amp;</span><span class="ident" id="7534320">ServerInfo</span><span class="op" id="7534330">{</span><span class="string" id="7534331">&#34;testserver&#34;</span><span class="op" id="7534343">,</span>&nbsp;<span class="builtintype" id="7534345">true</span><span class="op" id="7534349">,</span>&nbsp;<span class="builtintype" id="7534351">nil</span><span class="op" id="7534354">}</span><span class="op" id="7534355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534359">if</span>&nbsp;<span class="ident" id="7534362">name</span>&nbsp;<span class="op" id="7534367">!=</span>&nbsp;<span class="ident" id="7534370">test</span><span class="op" id="7534374">.</span><span class="ident" id="7534375">name</span>&nbsp;<span class="op" id="7534380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534385">t</span><span class="op" id="7534386">.</span><span class="ident" id="7534387">Errorf</span><span class="op" id="7534393">(</span><span class="string" id="7534394">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7534424">,</span>&nbsp;<span class="ident" id="7534426">i</span><span class="op" id="7534427">,</span>&nbsp;<span class="ident" id="7534429">name</span><span class="op" id="7534433">,</span>&nbsp;<span class="ident" id="7534435">test</span><span class="op" id="7534439">.</span><span class="ident" id="7534440">name</span><span class="op" id="7534444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7534448">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534452">if</span>&nbsp;<span class="op" id="7534455">!</span><span class="ident" id="7534456">bytes</span><span class="op" id="7534461">.</span><span class="ident" id="7534462">Equal</span><span class="op" id="7534467">(</span><span class="ident" id="7534468">resp</span><span class="op" id="7534472">,</span>&nbsp;<span class="op" id="7534474">[</span><span class="op" id="7534475">]</span><span class="builtintype" id="7534476">byte</span><span class="op" id="7534480">(</span><span class="ident" id="7534481">test</span><span class="op" id="7534485">.</span><span class="ident" id="7534486">responses</span><span class="op" id="7534495">[</span><span class="num" id="7534496">0</span><span class="op" id="7534497">]</span><span class="op" id="7534498">)</span><span class="op" id="7534499">)</span>&nbsp;<span class="op" id="7534501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534506">t</span><span class="op" id="7534507">.</span><span class="ident" id="7534508">Errorf</span><span class="op" id="7534514">(</span><span class="string" id="7534515">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7534549">,</span>&nbsp;<span class="ident" id="7534551">i</span><span class="op" id="7534552">,</span>&nbsp;<span class="ident" id="7534554">resp</span><span class="op" id="7534558">,</span>&nbsp;<span class="ident" id="7534560">test</span><span class="op" id="7534564">.</span><span class="ident" id="7534565">responses</span><span class="op" id="7534574">[</span><span class="num" id="7534575">0</span><span class="op" id="7534576">]</span><span class="op" id="7534577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7534581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534585">if</span>&nbsp;<span class="ident" id="7534588">err</span>&nbsp;<span class="op" id="7534592">!=</span>&nbsp;<span class="builtintype" id="7534595">nil</span>&nbsp;<span class="op" id="7534599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534604">t</span><span class="op" id="7534605">.</span><span class="ident" id="7534606">Errorf</span><span class="op" id="7534612">(</span><span class="string" id="7534613">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7534628">,</span>&nbsp;<span class="ident" id="7534630">i</span><span class="op" id="7534631">,</span>&nbsp;<span class="ident" id="7534633">err</span><span class="op" id="7534636">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7534640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534644">for</span>&nbsp;<span class="ident" id="7534648">j</span>&nbsp;<span class="op" id="7534650">:=</span>&nbsp;<span class="keyword" id="7534653">range</span>&nbsp;<span class="ident" id="7534659">test</span><span class="op" id="7534663">.</span><span class="ident" id="7534664">challenges</span>&nbsp;<span class="op" id="7534675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534680">challenge</span>&nbsp;<span class="op" id="7534690">:=</span>&nbsp;<span class="op" id="7534693">[</span><span class="op" id="7534694">]</span><span class="builtintype" id="7534695">byte</span><span class="op" id="7534699">(</span><span class="ident" id="7534700">test</span><span class="op" id="7534704">.</span><span class="ident" id="7534705">challenges</span><span class="op" id="7534715">[</span><span class="ident" id="7534716">j</span><span class="op" id="7534717">]</span><span class="op" id="7534718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534723">expected</span>&nbsp;<span class="op" id="7534732">:=</span>&nbsp;<span class="op" id="7534735">[</span><span class="op" id="7534736">]</span><span class="builtintype" id="7534737">byte</span><span class="op" id="7534741">(</span><span class="ident" id="7534742">test</span><span class="op" id="7534746">.</span><span class="ident" id="7534747">responses</span><span class="op" id="7534756">[</span><span class="ident" id="7534757">j</span><span class="op" id="7534758">+</span><span class="num" id="7534759">1</span><span class="op" id="7534760">]</span><span class="op" id="7534761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534766">resp</span><span class="op" id="7534770">,</span>&nbsp;<span class="ident" id="7534772">err</span>&nbsp;<span class="op" id="7534776">:=</span>&nbsp;<span class="ident" id="7534779">test</span><span class="op" id="7534783">.</span><span class="ident" id="7534784">auth</span><span class="op" id="7534788">.</span><span class="ident" id="7534789">Next</span><span class="op" id="7534793">(</span><span class="ident" id="7534794">challenge</span><span class="op" id="7534803">,</span>&nbsp;<span class="builtintype" id="7534805">true</span><span class="op" id="7534809">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534814">if</span>&nbsp;<span class="ident" id="7534817">err</span>&nbsp;<span class="op" id="7534821">!=</span>&nbsp;<span class="builtintype" id="7534824">nil</span>&nbsp;<span class="op" id="7534828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534834">t</span><span class="op" id="7534835">.</span><span class="ident" id="7534836">Errorf</span><span class="op" id="7534842">(</span><span class="string" id="7534843">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="7534858">,</span>&nbsp;<span class="ident" id="7534860">i</span><span class="op" id="7534861">,</span>&nbsp;<span class="ident" id="7534863">err</span><span class="op" id="7534866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534872">continue</span>&nbsp;<span class="ident" id="7534881">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7534893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534898">if</span>&nbsp;<span class="op" id="7534901">!</span><span class="ident" id="7534902">bytes</span><span class="op" id="7534907">.</span><span class="ident" id="7534908">Equal</span><span class="op" id="7534913">(</span><span class="ident" id="7534914">resp</span><span class="op" id="7534918">,</span>&nbsp;<span class="ident" id="7534920">expected</span><span class="op" id="7534928">)</span>&nbsp;<span class="op" id="7534930">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7534936">t</span><span class="op" id="7534937">.</span><span class="ident" id="7534938">Errorf</span><span class="op" id="7534944">(</span><span class="string" id="7534945">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="7534970">,</span>&nbsp;<span class="ident" id="7534972">i</span><span class="op" id="7534973">,</span>&nbsp;<span class="ident" id="7534975">resp</span><span class="op" id="7534979">,</span>&nbsp;<span class="ident" id="7534981">expected</span><span class="op" id="7534989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7534995">continue</span>&nbsp;<span class="ident" id="7535004">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535023">}</span><br>
<span class="lineno">60</span><span class="op" id="7535025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535028">func</span>&nbsp;<span class="ident" id="7535033">TestAuthPlain</span><span class="op" id="7535046">(</span><span class="ident" id="7535047">t</span>&nbsp;<span class="op" id="7535049">*</span><span class="ident" id="7535050">testing</span><span class="op" id="7535057">.</span><span class="ident" id="7535058">T</span><span class="op" id="7535059">)</span>&nbsp;<span class="op" id="7535061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535064">auth</span>&nbsp;<span class="op" id="7535069">:=</span>&nbsp;<span class="ident" id="7535072">PlainAuth</span><span class="op" id="7535081">(</span><span class="string" id="7535082">&#34;foo&#34;</span><span class="op" id="7535087">,</span>&nbsp;<span class="string" id="7535089">&#34;bar&#34;</span><span class="op" id="7535094">,</span>&nbsp;<span class="string" id="7535096">&#34;baz&#34;</span><span class="op" id="7535101">,</span>&nbsp;<span class="string" id="7535103">&#34;servername&#34;</span><span class="op" id="7535115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535119">tests</span>&nbsp;<span class="op" id="7535125">:=</span>&nbsp;<span class="op" id="7535128">[</span><span class="op" id="7535129">]</span><span class="keyword" id="7535130">struct</span>&nbsp;<span class="op" id="7535137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535141">server</span>&nbsp;<span class="op" id="7535148">*</span><span class="ident" id="7535149">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535162">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7535169">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535177">}</span><span class="op" id="7535178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535182">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535187">server</span><span class="op" id="7535193">:</span>&nbsp;<span class="op" id="7535195">&amp;</span><span class="ident" id="7535196">ServerInfo</span><span class="op" id="7535206">{</span><span class="ident" id="7535207">Name</span><span class="op" id="7535211">:</span>&nbsp;<span class="string" id="7535213">&#34;servername&#34;</span><span class="op" id="7535225">,</span>&nbsp;<span class="ident" id="7535227">TLS</span><span class="op" id="7535230">:</span>&nbsp;<span class="builtintype" id="7535232">true</span><span class="op" id="7535236">}</span><span class="op" id="7535237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535241">}</span><span class="op" id="7535242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7535251">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535296">server</span><span class="op" id="7535302">:</span>&nbsp;<span class="op" id="7535304">&amp;</span><span class="ident" id="7535305">ServerInfo</span><span class="op" id="7535315">{</span><span class="ident" id="7535316">Name</span><span class="op" id="7535320">:</span>&nbsp;<span class="string" id="7535322">&#34;servername&#34;</span><span class="op" id="7535334">,</span>&nbsp;<span class="ident" id="7535336">Auth</span><span class="op" id="7535340">:</span>&nbsp;<span class="op" id="7535342">[</span><span class="op" id="7535343">]</span><span class="builtintype" id="7535344">string</span><span class="op" id="7535350">{</span><span class="string" id="7535351">&#34;PLAIN&#34;</span><span class="op" id="7535358">}</span><span class="op" id="7535359">}</span><span class="op" id="7535360">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535364">}</span><span class="op" id="7535365">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535374">server</span><span class="op" id="7535380">:</span>&nbsp;<span class="op" id="7535382">&amp;</span><span class="ident" id="7535383">ServerInfo</span><span class="op" id="7535393">{</span><span class="ident" id="7535394">Name</span><span class="op" id="7535398">:</span>&nbsp;<span class="string" id="7535400">&#34;servername&#34;</span><span class="op" id="7535412">,</span>&nbsp;<span class="ident" id="7535414">Auth</span><span class="op" id="7535418">:</span>&nbsp;<span class="op" id="7535420">[</span><span class="op" id="7535421">]</span><span class="builtintype" id="7535422">string</span><span class="op" id="7535428">{</span><span class="string" id="7535429">&#34;CRAM-MD5&#34;</span><span class="op" id="7535439">}</span><span class="op" id="7535440">}</span><span class="op" id="7535441">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535446">err</span><span class="op" id="7535449">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7535454">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="7535478">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535482">}</span><span class="op" id="7535483">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535492">server</span><span class="op" id="7535498">:</span>&nbsp;<span class="op" id="7535500">&amp;</span><span class="ident" id="7535501">ServerInfo</span><span class="op" id="7535511">{</span><span class="ident" id="7535512">Name</span><span class="op" id="7535516">:</span>&nbsp;<span class="string" id="7535518">&#34;attacker&#34;</span><span class="op" id="7535528">,</span>&nbsp;<span class="ident" id="7535530">TLS</span><span class="op" id="7535533">:</span>&nbsp;<span class="builtintype" id="7535535">true</span><span class="op" id="7535539">}</span><span class="op" id="7535540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535545">err</span><span class="op" id="7535548">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7535553">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="7535570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535574">}</span><span class="op" id="7535575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535578">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7535581">for</span>&nbsp;<span class="ident" id="7535585">i</span><span class="op" id="7535586">,</span>&nbsp;<span class="ident" id="7535588">tt</span>&nbsp;<span class="op" id="7535591">:=</span>&nbsp;<span class="keyword" id="7535594">range</span>&nbsp;<span class="ident" id="7535600">tests</span>&nbsp;<span class="op" id="7535606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535610">_</span><span class="op" id="7535611">,</span>&nbsp;<span class="ident" id="7535613">_</span><span class="op" id="7535614">,</span>&nbsp;<span class="ident" id="7535616">err</span>&nbsp;<span class="op" id="7535620">:=</span>&nbsp;<span class="ident" id="7535623">auth</span><span class="op" id="7535627">.</span><span class="ident" id="7535628">Start</span><span class="op" id="7535633">(</span><span class="ident" id="7535634">tt</span><span class="op" id="7535636">.</span><span class="ident" id="7535637">server</span><span class="op" id="7535643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535647">got</span>&nbsp;<span class="op" id="7535651">:=</span>&nbsp;<span class="string" id="7535654">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7535659">if</span>&nbsp;<span class="ident" id="7535662">err</span>&nbsp;<span class="op" id="7535666">!=</span>&nbsp;<span class="builtintype" id="7535669">nil</span>&nbsp;<span class="op" id="7535673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535678">got</span>&nbsp;<span class="op" id="7535682">=</span>&nbsp;<span class="ident" id="7535684">err</span><span class="op" id="7535687">.</span><span class="ident" id="7535688">Error</span><span class="op" id="7535693">(</span><span class="op" id="7535694">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7535702">if</span>&nbsp;<span class="ident" id="7535705">got</span>&nbsp;<span class="op" id="7535709">!=</span>&nbsp;<span class="ident" id="7535712">tt</span><span class="op" id="7535714">.</span><span class="ident" id="7535715">err</span>&nbsp;<span class="op" id="7535719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535724">t</span><span class="op" id="7535725">.</span><span class="ident" id="7535726">Errorf</span><span class="op" id="7535732">(</span><span class="string" id="7535733">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7535762">,</span>&nbsp;<span class="ident" id="7535764">i</span><span class="op" id="7535765">,</span>&nbsp;<span class="ident" id="7535767">got</span><span class="op" id="7535770">,</span>&nbsp;<span class="ident" id="7535772">tt</span><span class="op" id="7535774">.</span><span class="ident" id="7535775">err</span><span class="op" id="7535778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535785">}</span><br>
<span class="lineno">95</span><span class="op" id="7535787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535790">type</span>&nbsp;<span class="ident" id="7535795">faker</span>&nbsp;<span class="keyword" id="7535801">struct</span>&nbsp;<span class="op" id="7535808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7535811">io</span><span class="op" id="7535813">.</span><span class="ident" id="7535814">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="7535825">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7535828">func</span>&nbsp;<span class="op" id="7535833">(</span><span class="ident" id="7535834">f</span>&nbsp;<span class="ident" id="7535836">faker</span><span class="op" id="7535841">)</span>&nbsp;<span class="ident" id="7535843">Close</span><span class="op" id="7535848">(</span><span class="op" id="7535849">)</span>&nbsp;<span class="builtintype" id="7535851">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535877">{</span>&nbsp;<span class="keyword" id="7535879">return</span>&nbsp;<span class="builtintype" id="7535886">nil</span>&nbsp;<span class="op" id="7535890">}</span><br>
<span class="lineno"></span><span class="keyword" id="7535892">func</span>&nbsp;<span class="op" id="7535897">(</span><span class="ident" id="7535898">f</span>&nbsp;<span class="ident" id="7535900">faker</span><span class="op" id="7535905">)</span>&nbsp;<span class="ident" id="7535907">LocalAddr</span><span class="op" id="7535916">(</span><span class="op" id="7535917">)</span>&nbsp;<span class="ident" id="7535919">net</span><span class="op" id="7535922">.</span><span class="ident" id="7535923">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7535941">{</span>&nbsp;<span class="keyword" id="7535943">return</span>&nbsp;<span class="builtintype" id="7535950">nil</span>&nbsp;<span class="op" id="7535954">}</span><br>
<span class="lineno"></span><span class="keyword" id="7535956">func</span>&nbsp;<span class="op" id="7535961">(</span><span class="ident" id="7535962">f</span>&nbsp;<span class="ident" id="7535964">faker</span><span class="op" id="7535969">)</span>&nbsp;<span class="ident" id="7535971">RemoteAddr</span><span class="op" id="7535981">(</span><span class="op" id="7535982">)</span>&nbsp;<span class="ident" id="7535984">net</span><span class="op" id="7535987">.</span><span class="ident" id="7535988">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7536005">{</span>&nbsp;<span class="keyword" id="7536007">return</span>&nbsp;<span class="builtintype" id="7536014">nil</span>&nbsp;<span class="op" id="7536018">}</span><br>
<span class="lineno"></span><span class="keyword" id="7536020">func</span>&nbsp;<span class="op" id="7536025">(</span><span class="ident" id="7536026">f</span>&nbsp;<span class="ident" id="7536028">faker</span><span class="op" id="7536033">)</span>&nbsp;<span class="ident" id="7536035">SetDeadline</span><span class="op" id="7536046">(</span><span class="ident" id="7536047">time</span><span class="op" id="7536051">.</span><span class="ident" id="7536052">Time</span><span class="op" id="7536056">)</span>&nbsp;<span class="builtintype" id="7536058">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7536069">{</span>&nbsp;<span class="keyword" id="7536071">return</span>&nbsp;<span class="builtintype" id="7536078">nil</span>&nbsp;<span class="op" id="7536082">}</span><br>
<span class="lineno">105</span><span class="keyword" id="7536084">func</span>&nbsp;<span class="op" id="7536089">(</span><span class="ident" id="7536090">f</span>&nbsp;<span class="ident" id="7536092">faker</span><span class="op" id="7536097">)</span>&nbsp;<span class="ident" id="7536099">SetReadDeadline</span><span class="op" id="7536114">(</span><span class="ident" id="7536115">time</span><span class="op" id="7536119">.</span><span class="ident" id="7536120">Time</span><span class="op" id="7536124">)</span>&nbsp;<span class="builtintype" id="7536126">error</span>&nbsp;&nbsp;<span class="op" id="7536133">{</span>&nbsp;<span class="keyword" id="7536135">return</span>&nbsp;<span class="builtintype" id="7536142">nil</span>&nbsp;<span class="op" id="7536146">}</span><br>
<span class="lineno"></span><span class="keyword" id="7536148">func</span>&nbsp;<span class="op" id="7536153">(</span><span class="ident" id="7536154">f</span>&nbsp;<span class="ident" id="7536156">faker</span><span class="op" id="7536161">)</span>&nbsp;<span class="ident" id="7536163">SetWriteDeadline</span><span class="op" id="7536179">(</span><span class="ident" id="7536180">time</span><span class="op" id="7536184">.</span><span class="ident" id="7536185">Time</span><span class="op" id="7536189">)</span>&nbsp;<span class="builtintype" id="7536191">error</span>&nbsp;<span class="op" id="7536197">{</span>&nbsp;<span class="keyword" id="7536199">return</span>&nbsp;<span class="builtintype" id="7536206">nil</span>&nbsp;<span class="op" id="7536210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7536213">func</span>&nbsp;<span class="ident" id="7536218">TestBasic</span><span class="op" id="7536227">(</span><span class="ident" id="7536228">t</span>&nbsp;<span class="op" id="7536230">*</span><span class="ident" id="7536231">testing</span><span class="op" id="7536238">.</span><span class="ident" id="7536239">T</span><span class="op" id="7536240">)</span>&nbsp;<span class="op" id="7536242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536245">server</span>&nbsp;<span class="op" id="7536252">:=</span>&nbsp;<span class="ident" id="7536255">strings</span><span class="op" id="7536262">.</span><span class="ident" id="7536263">Join</span><span class="op" id="7536267">(</span><span class="ident" id="7536268">strings</span><span class="op" id="7536275">.</span><span class="ident" id="7536276">Split</span><span class="op" id="7536281">(</span><span class="ident" id="7536282">basicServer</span><span class="op" id="7536293">,</span>&nbsp;<span class="string" id="7536295">&#34;\n&#34;</span><span class="op" id="7536299">)</span><span class="op" id="7536300">,</span>&nbsp;<span class="string" id="7536302">&#34;\r\n&#34;</span><span class="op" id="7536308">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536311">client</span>&nbsp;<span class="op" id="7536318">:=</span>&nbsp;<span class="ident" id="7536321">strings</span><span class="op" id="7536328">.</span><span class="ident" id="7536329">Join</span><span class="op" id="7536333">(</span><span class="ident" id="7536334">strings</span><span class="op" id="7536341">.</span><span class="ident" id="7536342">Split</span><span class="op" id="7536347">(</span><span class="ident" id="7536348">basicClient</span><span class="op" id="7536359">,</span>&nbsp;<span class="string" id="7536361">&#34;\n&#34;</span><span class="op" id="7536365">)</span><span class="op" id="7536366">,</span>&nbsp;<span class="string" id="7536368">&#34;\r\n&#34;</span><span class="op" id="7536374">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536378">var</span>&nbsp;<span class="ident" id="7536382">cmdbuf</span>&nbsp;<span class="ident" id="7536389">bytes</span><span class="op" id="7536394">.</span><span class="ident" id="7536395">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536403">bcmdbuf</span>&nbsp;<span class="op" id="7536411">:=</span>&nbsp;<span class="ident" id="7536414">bufio</span><span class="op" id="7536419">.</span><span class="ident" id="7536420">NewWriter</span><span class="op" id="7536429">(</span><span class="op" id="7536430">&amp;</span><span class="ident" id="7536431">cmdbuf</span><span class="op" id="7536437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536440">var</span>&nbsp;<span class="ident" id="7536444">fake</span>&nbsp;<span class="ident" id="7536449">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536456">fake</span><span class="op" id="7536460">.</span><span class="ident" id="7536461">ReadWriter</span>&nbsp;<span class="op" id="7536472">=</span>&nbsp;<span class="ident" id="7536474">bufio</span><span class="op" id="7536479">.</span><span class="ident" id="7536480">NewReadWriter</span><span class="op" id="7536493">(</span><span class="ident" id="7536494">bufio</span><span class="op" id="7536499">.</span><span class="ident" id="7536500">NewReader</span><span class="op" id="7536509">(</span><span class="ident" id="7536510">strings</span><span class="op" id="7536517">.</span><span class="ident" id="7536518">NewReader</span><span class="op" id="7536527">(</span><span class="ident" id="7536528">server</span><span class="op" id="7536534">)</span><span class="op" id="7536535">)</span><span class="op" id="7536536">,</span>&nbsp;<span class="ident" id="7536538">bcmdbuf</span><span class="op" id="7536545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536548">c</span>&nbsp;<span class="op" id="7536550">:=</span>&nbsp;<span class="op" id="7536553">&amp;</span><span class="ident" id="7536554">Client</span><span class="op" id="7536560">{</span><span class="ident" id="7536561">Text</span><span class="op" id="7536565">:</span>&nbsp;<span class="ident" id="7536567">textproto</span><span class="op" id="7536576">.</span><span class="ident" id="7536577">NewConn</span><span class="op" id="7536584">(</span><span class="ident" id="7536585">fake</span><span class="op" id="7536589">)</span><span class="op" id="7536590">,</span>&nbsp;<span class="ident" id="7536592">localName</span><span class="op" id="7536601">:</span>&nbsp;<span class="string" id="7536603">&#34;localhost&#34;</span><span class="op" id="7536614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536618">if</span>&nbsp;<span class="ident" id="7536621">err</span>&nbsp;<span class="op" id="7536625">:=</span>&nbsp;<span class="ident" id="7536628">c</span><span class="op" id="7536629">.</span><span class="ident" id="7536630">helo</span><span class="op" id="7536634">(</span><span class="op" id="7536635">)</span><span class="op" id="7536636">;</span>&nbsp;<span class="ident" id="7536638">err</span>&nbsp;<span class="op" id="7536642">!=</span>&nbsp;<span class="builtintype" id="7536645">nil</span>&nbsp;<span class="op" id="7536649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536653">t</span><span class="op" id="7536654">.</span><span class="ident" id="7536655">Fatalf</span><span class="op" id="7536661">(</span><span class="string" id="7536662">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7536679">,</span>&nbsp;<span class="ident" id="7536681">err</span><span class="op" id="7536684">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7536687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536690">if</span>&nbsp;<span class="ident" id="7536693">err</span>&nbsp;<span class="op" id="7536697">:=</span>&nbsp;<span class="ident" id="7536700">c</span><span class="op" id="7536701">.</span><span class="ident" id="7536702">ehlo</span><span class="op" id="7536706">(</span><span class="op" id="7536707">)</span><span class="op" id="7536708">;</span>&nbsp;<span class="ident" id="7536710">err</span>&nbsp;<span class="op" id="7536714">==</span>&nbsp;<span class="builtintype" id="7536717">nil</span>&nbsp;<span class="op" id="7536721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536725">t</span><span class="op" id="7536726">.</span><span class="ident" id="7536727">Fatalf</span><span class="op" id="7536733">(</span><span class="string" id="7536734">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="7536763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7536766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536769">if</span>&nbsp;<span class="ident" id="7536772">err</span>&nbsp;<span class="op" id="7536776">:=</span>&nbsp;<span class="ident" id="7536779">c</span><span class="op" id="7536780">.</span><span class="ident" id="7536781">ehlo</span><span class="op" id="7536785">(</span><span class="op" id="7536786">)</span><span class="op" id="7536787">;</span>&nbsp;<span class="ident" id="7536789">err</span>&nbsp;<span class="op" id="7536793">!=</span>&nbsp;<span class="builtintype" id="7536796">nil</span>&nbsp;<span class="op" id="7536800">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536804">t</span><span class="op" id="7536805">.</span><span class="ident" id="7536806">Fatalf</span><span class="op" id="7536812">(</span><span class="string" id="7536813">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7536837">,</span>&nbsp;<span class="ident" id="7536839">err</span><span class="op" id="7536842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7536845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536849">c</span><span class="op" id="7536850">.</span><span class="ident" id="7536851">didHello</span>&nbsp;<span class="op" id="7536860">=</span>&nbsp;<span class="builtintype" id="7536862">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536868">if</span>&nbsp;<span class="ident" id="7536871">ok</span><span class="op" id="7536873">,</span>&nbsp;<span class="ident" id="7536875">args</span>&nbsp;<span class="op" id="7536880">:=</span>&nbsp;<span class="ident" id="7536883">c</span><span class="op" id="7536884">.</span><span class="ident" id="7536885">Extension</span><span class="op" id="7536894">(</span><span class="string" id="7536895">&#34;aUtH&#34;</span><span class="op" id="7536901">)</span><span class="op" id="7536902">;</span>&nbsp;<span class="op" id="7536904">!</span><span class="ident" id="7536905">ok</span>&nbsp;<span class="op" id="7536908">||</span>&nbsp;<span class="ident" id="7536911">args</span>&nbsp;<span class="op" id="7536916">!=</span>&nbsp;<span class="string" id="7536919">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7536933">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7536937">t</span><span class="op" id="7536938">.</span><span class="ident" id="7536939">Fatalf</span><span class="op" id="7536945">(</span><span class="string" id="7536946">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7536971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7536974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7536977">if</span>&nbsp;<span class="ident" id="7536980">ok</span><span class="op" id="7536982">,</span>&nbsp;<span class="ident" id="7536984">_</span>&nbsp;<span class="op" id="7536986">:=</span>&nbsp;<span class="ident" id="7536989">c</span><span class="op" id="7536990">.</span><span class="ident" id="7536991">Extension</span><span class="op" id="7537000">(</span><span class="string" id="7537001">&#34;DSN&#34;</span><span class="op" id="7537006">)</span><span class="op" id="7537007">;</span>&nbsp;<span class="ident" id="7537009">ok</span>&nbsp;<span class="op" id="7537012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537016">t</span><span class="op" id="7537017">.</span><span class="ident" id="7537018">Fatalf</span><span class="op" id="7537024">(</span><span class="string" id="7537025">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7537048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537051">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537055">if</span>&nbsp;<span class="ident" id="7537058">err</span>&nbsp;<span class="op" id="7537062">:=</span>&nbsp;<span class="ident" id="7537065">c</span><span class="op" id="7537066">.</span><span class="ident" id="7537067">Mail</span><span class="op" id="7537071">(</span><span class="string" id="7537072">&#34;user@gmail.com&#34;</span><span class="op" id="7537088">)</span><span class="op" id="7537089">;</span>&nbsp;<span class="ident" id="7537091">err</span>&nbsp;<span class="op" id="7537095">==</span>&nbsp;<span class="builtintype" id="7537098">nil</span>&nbsp;<span class="op" id="7537102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537106">t</span><span class="op" id="7537107">.</span><span class="ident" id="7537108">Fatalf</span><span class="op" id="7537114">(</span><span class="string" id="7537115">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="7537151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537158">if</span>&nbsp;<span class="ident" id="7537161">err</span>&nbsp;<span class="op" id="7537165">:=</span>&nbsp;<span class="ident" id="7537168">c</span><span class="op" id="7537169">.</span><span class="ident" id="7537170">Verify</span><span class="op" id="7537176">(</span><span class="string" id="7537177">&#34;user1@gmail.com&#34;</span><span class="op" id="7537194">)</span><span class="op" id="7537195">;</span>&nbsp;<span class="ident" id="7537197">err</span>&nbsp;<span class="op" id="7537201">==</span>&nbsp;<span class="builtintype" id="7537204">nil</span>&nbsp;<span class="op" id="7537208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537212">t</span><span class="op" id="7537213">.</span><span class="ident" id="7537214">Fatalf</span><span class="op" id="7537220">(</span><span class="string" id="7537221">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="7537259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537265">if</span>&nbsp;<span class="ident" id="7537268">err</span>&nbsp;<span class="op" id="7537272">:=</span>&nbsp;<span class="ident" id="7537275">c</span><span class="op" id="7537276">.</span><span class="ident" id="7537277">Verify</span><span class="op" id="7537283">(</span><span class="string" id="7537284">&#34;user2@gmail.com&#34;</span><span class="op" id="7537301">)</span><span class="op" id="7537302">;</span>&nbsp;<span class="ident" id="7537304">err</span>&nbsp;<span class="op" id="7537308">!=</span>&nbsp;<span class="builtintype" id="7537311">nil</span>&nbsp;<span class="op" id="7537315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537319">t</span><span class="op" id="7537320">.</span><span class="ident" id="7537321">Fatalf</span><span class="op" id="7537327">(</span><span class="string" id="7537328">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="7537372">,</span>&nbsp;<span class="ident" id="7537374">err</span><span class="op" id="7537377">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7537384">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537430">c</span><span class="op" id="7537431">.</span><span class="ident" id="7537432">tls</span>&nbsp;<span class="op" id="7537436">=</span>&nbsp;<span class="builtintype" id="7537438">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537444">c</span><span class="op" id="7537445">.</span><span class="ident" id="7537446">serverName</span>&nbsp;<span class="op" id="7537457">=</span>&nbsp;<span class="string" id="7537459">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537478">if</span>&nbsp;<span class="ident" id="7537481">err</span>&nbsp;<span class="op" id="7537485">:=</span>&nbsp;<span class="ident" id="7537488">c</span><span class="op" id="7537489">.</span><span class="ident" id="7537490">Auth</span><span class="op" id="7537494">(</span><span class="ident" id="7537495">PlainAuth</span><span class="op" id="7537504">(</span><span class="string" id="7537505">&#34;&#34;</span><span class="op" id="7537507">,</span>&nbsp;<span class="string" id="7537509">&#34;user&#34;</span><span class="op" id="7537515">,</span>&nbsp;<span class="string" id="7537517">&#34;pass&#34;</span><span class="op" id="7537523">,</span>&nbsp;<span class="string" id="7537525">&#34;smtp.google.com&#34;</span><span class="op" id="7537542">)</span><span class="op" id="7537543">)</span><span class="op" id="7537544">;</span>&nbsp;<span class="ident" id="7537546">err</span>&nbsp;<span class="op" id="7537550">!=</span>&nbsp;<span class="builtintype" id="7537553">nil</span>&nbsp;<span class="op" id="7537557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537561">t</span><span class="op" id="7537562">.</span><span class="ident" id="7537563">Fatalf</span><span class="op" id="7537569">(</span><span class="string" id="7537570">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7537587">,</span>&nbsp;<span class="ident" id="7537589">err</span><span class="op" id="7537592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537599">if</span>&nbsp;<span class="ident" id="7537602">err</span>&nbsp;<span class="op" id="7537606">:=</span>&nbsp;<span class="ident" id="7537609">c</span><span class="op" id="7537610">.</span><span class="ident" id="7537611">Mail</span><span class="op" id="7537615">(</span><span class="string" id="7537616">&#34;user@gmail.com&#34;</span><span class="op" id="7537632">)</span><span class="op" id="7537633">;</span>&nbsp;<span class="ident" id="7537635">err</span>&nbsp;<span class="op" id="7537639">!=</span>&nbsp;<span class="builtintype" id="7537642">nil</span>&nbsp;<span class="op" id="7537646">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537650">t</span><span class="op" id="7537651">.</span><span class="ident" id="7537652">Fatalf</span><span class="op" id="7537658">(</span><span class="string" id="7537659">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7537676">,</span>&nbsp;<span class="ident" id="7537678">err</span><span class="op" id="7537681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537687">if</span>&nbsp;<span class="ident" id="7537690">err</span>&nbsp;<span class="op" id="7537694">:=</span>&nbsp;<span class="ident" id="7537697">c</span><span class="op" id="7537698">.</span><span class="ident" id="7537699">Rcpt</span><span class="op" id="7537703">(</span><span class="string" id="7537704">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="7537734">)</span><span class="op" id="7537735">;</span>&nbsp;<span class="ident" id="7537737">err</span>&nbsp;<span class="op" id="7537741">!=</span>&nbsp;<span class="builtintype" id="7537744">nil</span>&nbsp;<span class="op" id="7537748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537752">t</span><span class="op" id="7537753">.</span><span class="ident" id="7537754">Fatalf</span><span class="op" id="7537760">(</span><span class="string" id="7537761">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7537778">,</span>&nbsp;<span class="ident" id="7537780">err</span><span class="op" id="7537783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537786">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537789">msg</span>&nbsp;<span class="op" id="7537793">:=</span>&nbsp;<span class="string" id="7537796">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537913">w</span><span class="op" id="7537914">,</span>&nbsp;<span class="ident" id="7537916">err</span>&nbsp;<span class="op" id="7537920">:=</span>&nbsp;<span class="ident" id="7537923">c</span><span class="op" id="7537924">.</span><span class="ident" id="7537925">Data</span><span class="op" id="7537929">(</span><span class="op" id="7537930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537933">if</span>&nbsp;<span class="ident" id="7537936">err</span>&nbsp;<span class="op" id="7537940">!=</span>&nbsp;<span class="builtintype" id="7537943">nil</span>&nbsp;<span class="op" id="7537947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7537951">t</span><span class="op" id="7537952">.</span><span class="ident" id="7537953">Fatalf</span><span class="op" id="7537959">(</span><span class="string" id="7537960">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7537977">,</span>&nbsp;<span class="ident" id="7537979">err</span><span class="op" id="7537982">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7537985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7537988">if</span>&nbsp;<span class="ident" id="7537991">_</span><span class="op" id="7537992">,</span>&nbsp;<span class="ident" id="7537994">err</span>&nbsp;<span class="op" id="7537998">:=</span>&nbsp;<span class="ident" id="7538001">w</span><span class="op" id="7538002">.</span><span class="ident" id="7538003">Write</span><span class="op" id="7538008">(</span><span class="op" id="7538009">[</span><span class="op" id="7538010">]</span><span class="builtintype" id="7538011">byte</span><span class="op" id="7538015">(</span><span class="ident" id="7538016">msg</span><span class="op" id="7538019">)</span><span class="op" id="7538020">)</span><span class="op" id="7538021">;</span>&nbsp;<span class="ident" id="7538023">err</span>&nbsp;<span class="op" id="7538027">!=</span>&nbsp;<span class="builtintype" id="7538030">nil</span>&nbsp;<span class="op" id="7538034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7538038">t</span><span class="op" id="7538039">.</span><span class="ident" id="7538040">Fatalf</span><span class="op" id="7538046">(</span><span class="string" id="7538047">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7538070">,</span>&nbsp;<span class="ident" id="7538072">err</span><span class="op" id="7538075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7538078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7538081">if</span>&nbsp;<span class="ident" id="7538084">err</span>&nbsp;<span class="op" id="7538088">:=</span>&nbsp;<span class="ident" id="7538091">w</span><span class="op" id="7538092">.</span><span class="ident" id="7538093">Close</span><span class="op" id="7538098">(</span><span class="op" id="7538099">)</span><span class="op" id="7538100">;</span>&nbsp;<span class="ident" id="7538102">err</span>&nbsp;<span class="op" id="7538106">!=</span>&nbsp;<span class="builtintype" id="7538109">nil</span>&nbsp;<span class="op" id="7538113">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7538117">t</span><span class="op" id="7538118">.</span><span class="ident" id="7538119">Fatalf</span><span class="op" id="7538125">(</span><span class="string" id="7538126">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="7538149">,</span>&nbsp;<span class="ident" id="7538151">err</span><span class="op" id="7538154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7538157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7538161">if</span>&nbsp;<span class="ident" id="7538164">err</span>&nbsp;<span class="op" id="7538168">:=</span>&nbsp;<span class="ident" id="7538171">c</span><span class="op" id="7538172">.</span><span class="ident" id="7538173">Quit</span><span class="op" id="7538177">(</span><span class="op" id="7538178">)</span><span class="op" id="7538179">;</span>&nbsp;<span class="ident" id="7538181">err</span>&nbsp;<span class="op" id="7538185">!=</span>&nbsp;<span class="builtintype" id="7538188">nil</span>&nbsp;<span class="op" id="7538192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7538196">t</span><span class="op" id="7538197">.</span><span class="ident" id="7538198">Fatalf</span><span class="op" id="7538204">(</span><span class="string" id="7538205">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7538222">,</span>&nbsp;<span class="ident" id="7538224">err</span><span class="op" id="7538227">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7538230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7538234">bcmdbuf</span><span class="op" id="7538241">.</span><span class="ident" id="7538242">Flush</span><span class="op" id="7538247">(</span><span class="op" id="7538248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7538251">actualcmds</span>&nbsp;<span class="op" id="7538262">:=</span>&nbsp;<span class="ident" id="7538265">cmdbuf</span><span class="op" id="7538271">.</span><span class="ident" id="7538272">String</span><span class="op" id="7538278">(</span><span class="op" id="7538279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7538282">if</span>&nbsp;<span class="ident" id="7538285">client</span>&nbsp;<span class="op" id="7538292">!=</span>&nbsp;<span class="ident" id="7538295">actualcmds</span>&nbsp;<span class="op" id="7538306">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7538310">t</span><span class="op" id="7538311">.</span><span class="ident" id="7538312">Fatalf</span><span class="op" id="7538318">(</span><span class="string" id="7538319">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7538344">,</span>&nbsp;<span class="ident" id="7538346">actualcmds</span><span class="op" id="7538356">,</span>&nbsp;<span class="ident" id="7538358">client</span><span class="op" id="7538364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7538367">}</span><br>
<span class="lineno"></span><span class="op" id="7538369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7538372">var</span>&nbsp;<span class="ident" id="7538376">basicServer</span>&nbsp;<span class="op" id="7538388">=</span>&nbsp;<span class="string" id="7538390">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7538698">var</span>&nbsp;<span class="ident" id="7538702">basicClient</span>&nbsp;<span class="op" id="7538714">=</span>&nbsp;<span class="string" id="7538716">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7539083">func</span>&nbsp;<span class="ident" id="7539088">TestNewClient</span><span class="op" id="7539101">(</span><span class="ident" id="7539102">t</span>&nbsp;<span class="op" id="7539104">*</span><span class="ident" id="7539105">testing</span><span class="op" id="7539112">.</span><span class="ident" id="7539113">T</span><span class="op" id="7539114">)</span>&nbsp;<span class="op" id="7539116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539119">server</span>&nbsp;<span class="op" id="7539126">:=</span>&nbsp;<span class="ident" id="7539129">strings</span><span class="op" id="7539136">.</span><span class="ident" id="7539137">Join</span><span class="op" id="7539141">(</span><span class="ident" id="7539142">strings</span><span class="op" id="7539149">.</span><span class="ident" id="7539150">Split</span><span class="op" id="7539155">(</span><span class="ident" id="7539156">newClientServer</span><span class="op" id="7539171">,</span>&nbsp;<span class="string" id="7539173">&#34;\n&#34;</span><span class="op" id="7539177">)</span><span class="op" id="7539178">,</span>&nbsp;<span class="string" id="7539180">&#34;\r\n&#34;</span><span class="op" id="7539186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539189">client</span>&nbsp;<span class="op" id="7539196">:=</span>&nbsp;<span class="ident" id="7539199">strings</span><span class="op" id="7539206">.</span><span class="ident" id="7539207">Join</span><span class="op" id="7539211">(</span><span class="ident" id="7539212">strings</span><span class="op" id="7539219">.</span><span class="ident" id="7539220">Split</span><span class="op" id="7539225">(</span><span class="ident" id="7539226">newClientClient</span><span class="op" id="7539241">,</span>&nbsp;<span class="string" id="7539243">&#34;\n&#34;</span><span class="op" id="7539247">)</span><span class="op" id="7539248">,</span>&nbsp;<span class="string" id="7539250">&#34;\r\n&#34;</span><span class="op" id="7539256">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539260">var</span>&nbsp;<span class="ident" id="7539264">cmdbuf</span>&nbsp;<span class="ident" id="7539271">bytes</span><span class="op" id="7539276">.</span><span class="ident" id="7539277">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539285">bcmdbuf</span>&nbsp;<span class="op" id="7539293">:=</span>&nbsp;<span class="ident" id="7539296">bufio</span><span class="op" id="7539301">.</span><span class="ident" id="7539302">NewWriter</span><span class="op" id="7539311">(</span><span class="op" id="7539312">&amp;</span><span class="ident" id="7539313">cmdbuf</span><span class="op" id="7539319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539322">out</span>&nbsp;<span class="op" id="7539326">:=</span>&nbsp;<span class="keyword" id="7539329">func</span><span class="op" id="7539333">(</span><span class="op" id="7539334">)</span>&nbsp;<span class="builtintype" id="7539336">string</span>&nbsp;<span class="op" id="7539343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539347">bcmdbuf</span><span class="op" id="7539354">.</span><span class="ident" id="7539355">Flush</span><span class="op" id="7539360">(</span><span class="op" id="7539361">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539365">return</span>&nbsp;<span class="ident" id="7539372">cmdbuf</span><span class="op" id="7539378">.</span><span class="ident" id="7539379">String</span><span class="op" id="7539385">(</span><span class="op" id="7539386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7539389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539392">var</span>&nbsp;<span class="ident" id="7539396">fake</span>&nbsp;<span class="ident" id="7539401">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539408">fake</span><span class="op" id="7539412">.</span><span class="ident" id="7539413">ReadWriter</span>&nbsp;<span class="op" id="7539424">=</span>&nbsp;<span class="ident" id="7539426">bufio</span><span class="op" id="7539431">.</span><span class="ident" id="7539432">NewReadWriter</span><span class="op" id="7539445">(</span><span class="ident" id="7539446">bufio</span><span class="op" id="7539451">.</span><span class="ident" id="7539452">NewReader</span><span class="op" id="7539461">(</span><span class="ident" id="7539462">strings</span><span class="op" id="7539469">.</span><span class="ident" id="7539470">NewReader</span><span class="op" id="7539479">(</span><span class="ident" id="7539480">server</span><span class="op" id="7539486">)</span><span class="op" id="7539487">)</span><span class="op" id="7539488">,</span>&nbsp;<span class="ident" id="7539490">bcmdbuf</span><span class="op" id="7539497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539500">c</span><span class="op" id="7539501">,</span>&nbsp;<span class="ident" id="7539503">err</span>&nbsp;<span class="op" id="7539507">:=</span>&nbsp;<span class="ident" id="7539510">NewClient</span><span class="op" id="7539519">(</span><span class="ident" id="7539520">fake</span><span class="op" id="7539524">,</span>&nbsp;<span class="string" id="7539526">&#34;fake.host&#34;</span><span class="op" id="7539537">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539540">if</span>&nbsp;<span class="ident" id="7539543">err</span>&nbsp;<span class="op" id="7539547">!=</span>&nbsp;<span class="builtintype" id="7539550">nil</span>&nbsp;<span class="op" id="7539554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539558">t</span><span class="op" id="7539559">.</span><span class="ident" id="7539560">Fatalf</span><span class="op" id="7539566">(</span><span class="string" id="7539567">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="7539594">,</span>&nbsp;<span class="ident" id="7539596">err</span><span class="op" id="7539599">,</span>&nbsp;<span class="ident" id="7539601">out</span><span class="op" id="7539604">(</span><span class="op" id="7539605">)</span><span class="op" id="7539606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7539609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539612">defer</span>&nbsp;<span class="ident" id="7539618">c</span><span class="op" id="7539619">.</span><span class="ident" id="7539620">Close</span><span class="op" id="7539625">(</span><span class="op" id="7539626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539629">if</span>&nbsp;<span class="ident" id="7539632">ok</span><span class="op" id="7539634">,</span>&nbsp;<span class="ident" id="7539636">args</span>&nbsp;<span class="op" id="7539641">:=</span>&nbsp;<span class="ident" id="7539644">c</span><span class="op" id="7539645">.</span><span class="ident" id="7539646">Extension</span><span class="op" id="7539655">(</span><span class="string" id="7539656">&#34;aUtH&#34;</span><span class="op" id="7539662">)</span><span class="op" id="7539663">;</span>&nbsp;<span class="op" id="7539665">!</span><span class="ident" id="7539666">ok</span>&nbsp;<span class="op" id="7539669">||</span>&nbsp;<span class="ident" id="7539672">args</span>&nbsp;<span class="op" id="7539677">!=</span>&nbsp;<span class="string" id="7539680">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="7539694">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539698">t</span><span class="op" id="7539699">.</span><span class="ident" id="7539700">Fatalf</span><span class="op" id="7539706">(</span><span class="string" id="7539707">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="7539732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7539735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539738">if</span>&nbsp;<span class="ident" id="7539741">ok</span><span class="op" id="7539743">,</span>&nbsp;<span class="ident" id="7539745">_</span>&nbsp;<span class="op" id="7539747">:=</span>&nbsp;<span class="ident" id="7539750">c</span><span class="op" id="7539751">.</span><span class="ident" id="7539752">Extension</span><span class="op" id="7539761">(</span><span class="string" id="7539762">&#34;DSN&#34;</span><span class="op" id="7539767">)</span><span class="op" id="7539768">;</span>&nbsp;<span class="ident" id="7539770">ok</span>&nbsp;<span class="op" id="7539773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539777">t</span><span class="op" id="7539778">.</span><span class="ident" id="7539779">Fatalf</span><span class="op" id="7539785">(</span><span class="string" id="7539786">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7539809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7539812">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539815">if</span>&nbsp;<span class="ident" id="7539818">err</span>&nbsp;<span class="op" id="7539822">:=</span>&nbsp;<span class="ident" id="7539825">c</span><span class="op" id="7539826">.</span><span class="ident" id="7539827">Quit</span><span class="op" id="7539831">(</span><span class="op" id="7539832">)</span><span class="op" id="7539833">;</span>&nbsp;<span class="ident" id="7539835">err</span>&nbsp;<span class="op" id="7539839">!=</span>&nbsp;<span class="builtintype" id="7539842">nil</span>&nbsp;<span class="op" id="7539846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539850">t</span><span class="op" id="7539851">.</span><span class="ident" id="7539852">Fatalf</span><span class="op" id="7539858">(</span><span class="string" id="7539859">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7539876">,</span>&nbsp;<span class="ident" id="7539878">err</span><span class="op" id="7539881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7539884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539888">actualcmds</span>&nbsp;<span class="op" id="7539899">:=</span>&nbsp;<span class="ident" id="7539902">out</span><span class="op" id="7539905">(</span><span class="op" id="7539906">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7539909">if</span>&nbsp;<span class="ident" id="7539912">client</span>&nbsp;<span class="op" id="7539919">!=</span>&nbsp;<span class="ident" id="7539922">actualcmds</span>&nbsp;<span class="op" id="7539933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7539937">t</span><span class="op" id="7539938">.</span><span class="ident" id="7539939">Fatalf</span><span class="op" id="7539945">(</span><span class="string" id="7539946">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7539971">,</span>&nbsp;<span class="ident" id="7539973">actualcmds</span><span class="op" id="7539983">,</span>&nbsp;<span class="ident" id="7539985">client</span><span class="op" id="7539991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7539994">}</span><br>
<span class="lineno"></span><span class="op" id="7539996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="7539999">var</span>&nbsp;<span class="ident" id="7540003">newClientServer</span>&nbsp;<span class="op" id="7540019">=</span>&nbsp;<span class="string" id="7540021">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7540134">var</span>&nbsp;<span class="ident" id="7540138">newClientClient</span>&nbsp;<span class="op" id="7540154">=</span>&nbsp;<span class="string" id="7540156">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7540180">func</span>&nbsp;<span class="ident" id="7540185">TestNewClient2</span><span class="op" id="7540199">(</span><span class="ident" id="7540200">t</span>&nbsp;<span class="op" id="7540202">*</span><span class="ident" id="7540203">testing</span><span class="op" id="7540210">.</span><span class="ident" id="7540211">T</span><span class="op" id="7540212">)</span>&nbsp;<span class="op" id="7540214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540217">server</span>&nbsp;<span class="op" id="7540224">:=</span>&nbsp;<span class="ident" id="7540227">strings</span><span class="op" id="7540234">.</span><span class="ident" id="7540235">Join</span><span class="op" id="7540239">(</span><span class="ident" id="7540240">strings</span><span class="op" id="7540247">.</span><span class="ident" id="7540248">Split</span><span class="op" id="7540253">(</span><span class="ident" id="7540254">newClient2Server</span><span class="op" id="7540270">,</span>&nbsp;<span class="string" id="7540272">&#34;\n&#34;</span><span class="op" id="7540276">)</span><span class="op" id="7540277">,</span>&nbsp;<span class="string" id="7540279">&#34;\r\n&#34;</span><span class="op" id="7540285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540288">client</span>&nbsp;<span class="op" id="7540295">:=</span>&nbsp;<span class="ident" id="7540298">strings</span><span class="op" id="7540305">.</span><span class="ident" id="7540306">Join</span><span class="op" id="7540310">(</span><span class="ident" id="7540311">strings</span><span class="op" id="7540318">.</span><span class="ident" id="7540319">Split</span><span class="op" id="7540324">(</span><span class="ident" id="7540325">newClient2Client</span><span class="op" id="7540341">,</span>&nbsp;<span class="string" id="7540343">&#34;\n&#34;</span><span class="op" id="7540347">)</span><span class="op" id="7540348">,</span>&nbsp;<span class="string" id="7540350">&#34;\r\n&#34;</span><span class="op" id="7540356">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540360">var</span>&nbsp;<span class="ident" id="7540364">cmdbuf</span>&nbsp;<span class="ident" id="7540371">bytes</span><span class="op" id="7540376">.</span><span class="ident" id="7540377">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540385">bcmdbuf</span>&nbsp;<span class="op" id="7540393">:=</span>&nbsp;<span class="ident" id="7540396">bufio</span><span class="op" id="7540401">.</span><span class="ident" id="7540402">NewWriter</span><span class="op" id="7540411">(</span><span class="op" id="7540412">&amp;</span><span class="ident" id="7540413">cmdbuf</span><span class="op" id="7540419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540422">var</span>&nbsp;<span class="ident" id="7540426">fake</span>&nbsp;<span class="ident" id="7540431">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540438">fake</span><span class="op" id="7540442">.</span><span class="ident" id="7540443">ReadWriter</span>&nbsp;<span class="op" id="7540454">=</span>&nbsp;<span class="ident" id="7540456">bufio</span><span class="op" id="7540461">.</span><span class="ident" id="7540462">NewReadWriter</span><span class="op" id="7540475">(</span><span class="ident" id="7540476">bufio</span><span class="op" id="7540481">.</span><span class="ident" id="7540482">NewReader</span><span class="op" id="7540491">(</span><span class="ident" id="7540492">strings</span><span class="op" id="7540499">.</span><span class="ident" id="7540500">NewReader</span><span class="op" id="7540509">(</span><span class="ident" id="7540510">server</span><span class="op" id="7540516">)</span><span class="op" id="7540517">)</span><span class="op" id="7540518">,</span>&nbsp;<span class="ident" id="7540520">bcmdbuf</span><span class="op" id="7540527">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540530">c</span><span class="op" id="7540531">,</span>&nbsp;<span class="ident" id="7540533">err</span>&nbsp;<span class="op" id="7540537">:=</span>&nbsp;<span class="ident" id="7540540">NewClient</span><span class="op" id="7540549">(</span><span class="ident" id="7540550">fake</span><span class="op" id="7540554">,</span>&nbsp;<span class="string" id="7540556">&#34;fake.host&#34;</span><span class="op" id="7540567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540570">if</span>&nbsp;<span class="ident" id="7540573">err</span>&nbsp;<span class="op" id="7540577">!=</span>&nbsp;<span class="builtintype" id="7540580">nil</span>&nbsp;<span class="op" id="7540584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540588">t</span><span class="op" id="7540589">.</span><span class="ident" id="7540590">Fatalf</span><span class="op" id="7540596">(</span><span class="string" id="7540597">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7540612">,</span>&nbsp;<span class="ident" id="7540614">err</span><span class="op" id="7540617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7540620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540623">defer</span>&nbsp;<span class="ident" id="7540629">c</span><span class="op" id="7540630">.</span><span class="ident" id="7540631">Close</span><span class="op" id="7540636">(</span><span class="op" id="7540637">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540640">if</span>&nbsp;<span class="ident" id="7540643">ok</span><span class="op" id="7540645">,</span>&nbsp;<span class="ident" id="7540647">_</span>&nbsp;<span class="op" id="7540649">:=</span>&nbsp;<span class="ident" id="7540652">c</span><span class="op" id="7540653">.</span><span class="ident" id="7540654">Extension</span><span class="op" id="7540663">(</span><span class="string" id="7540664">&#34;DSN&#34;</span><span class="op" id="7540669">)</span><span class="op" id="7540670">;</span>&nbsp;<span class="ident" id="7540672">ok</span>&nbsp;<span class="op" id="7540675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540679">t</span><span class="op" id="7540680">.</span><span class="ident" id="7540681">Fatalf</span><span class="op" id="7540687">(</span><span class="string" id="7540688">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="7540711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7540714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540717">if</span>&nbsp;<span class="ident" id="7540720">err</span>&nbsp;<span class="op" id="7540724">:=</span>&nbsp;<span class="ident" id="7540727">c</span><span class="op" id="7540728">.</span><span class="ident" id="7540729">Quit</span><span class="op" id="7540733">(</span><span class="op" id="7540734">)</span><span class="op" id="7540735">;</span>&nbsp;<span class="ident" id="7540737">err</span>&nbsp;<span class="op" id="7540741">!=</span>&nbsp;<span class="builtintype" id="7540744">nil</span>&nbsp;<span class="op" id="7540748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540752">t</span><span class="op" id="7540753">.</span><span class="ident" id="7540754">Fatalf</span><span class="op" id="7540760">(</span><span class="string" id="7540761">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7540778">,</span>&nbsp;<span class="ident" id="7540780">err</span><span class="op" id="7540783">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7540786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540790">bcmdbuf</span><span class="op" id="7540797">.</span><span class="ident" id="7540798">Flush</span><span class="op" id="7540803">(</span><span class="op" id="7540804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540807">actualcmds</span>&nbsp;<span class="op" id="7540818">:=</span>&nbsp;<span class="ident" id="7540821">cmdbuf</span><span class="op" id="7540827">.</span><span class="ident" id="7540828">String</span><span class="op" id="7540834">(</span><span class="op" id="7540835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7540838">if</span>&nbsp;<span class="ident" id="7540841">client</span>&nbsp;<span class="op" id="7540848">!=</span>&nbsp;<span class="ident" id="7540851">actualcmds</span>&nbsp;<span class="op" id="7540862">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7540866">t</span><span class="op" id="7540867">.</span><span class="ident" id="7540868">Fatalf</span><span class="op" id="7540874">(</span><span class="string" id="7540875">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7540900">,</span>&nbsp;<span class="ident" id="7540902">actualcmds</span><span class="op" id="7540912">,</span>&nbsp;<span class="ident" id="7540914">client</span><span class="op" id="7540920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7540923">}</span><br>
<span class="lineno"></span><span class="op" id="7540925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7540928">var</span>&nbsp;<span class="ident" id="7540932">newClient2Server</span>&nbsp;<span class="op" id="7540949">=</span>&nbsp;<span class="string" id="7540951">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7541072">var</span>&nbsp;<span class="ident" id="7541076">newClient2Client</span>&nbsp;<span class="op" id="7541093">=</span>&nbsp;<span class="string" id="7541095">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7541134">func</span>&nbsp;<span class="ident" id="7541139">TestHello</span><span class="op" id="7541148">(</span><span class="ident" id="7541149">t</span>&nbsp;<span class="op" id="7541151">*</span><span class="ident" id="7541152">testing</span><span class="op" id="7541159">.</span><span class="ident" id="7541160">T</span><span class="op" id="7541161">)</span>&nbsp;<span class="op" id="7541163">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541167">if</span>&nbsp;<span class="builtinfunc" id="7541170">len</span><span class="op" id="7541173">(</span><span class="ident" id="7541174">helloServer</span><span class="op" id="7541185">)</span>&nbsp;<span class="op" id="7541187">!=</span>&nbsp;<span class="builtinfunc" id="7541190">len</span><span class="op" id="7541193">(</span><span class="ident" id="7541194">helloClient</span><span class="op" id="7541205">)</span>&nbsp;<span class="op" id="7541207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541211">t</span><span class="op" id="7541212">.</span><span class="ident" id="7541213">Fatalf</span><span class="op" id="7541219">(</span><span class="string" id="7541220">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="7541259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7541262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541266">for</span>&nbsp;<span class="ident" id="7541270">i</span>&nbsp;<span class="op" id="7541272">:=</span>&nbsp;<span class="num" id="7541275">0</span><span class="op" id="7541276">;</span>&nbsp;<span class="ident" id="7541278">i</span>&nbsp;<span class="op" id="7541280">&lt;</span>&nbsp;<span class="builtinfunc" id="7541282">len</span><span class="op" id="7541285">(</span><span class="ident" id="7541286">helloServer</span><span class="op" id="7541297">)</span><span class="op" id="7541298">;</span>&nbsp;<span class="ident" id="7541300">i</span><span class="op" id="7541301">++</span>&nbsp;<span class="op" id="7541304">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541308">server</span>&nbsp;<span class="op" id="7541315">:=</span>&nbsp;<span class="ident" id="7541318">strings</span><span class="op" id="7541325">.</span><span class="ident" id="7541326">Join</span><span class="op" id="7541330">(</span><span class="ident" id="7541331">strings</span><span class="op" id="7541338">.</span><span class="ident" id="7541339">Split</span><span class="op" id="7541344">(</span><span class="ident" id="7541345">baseHelloServer</span><span class="op" id="7541360">+</span><span class="ident" id="7541361">helloServer</span><span class="op" id="7541372">[</span><span class="ident" id="7541373">i</span><span class="op" id="7541374">]</span><span class="op" id="7541375">,</span>&nbsp;<span class="string" id="7541377">&#34;\n&#34;</span><span class="op" id="7541381">)</span><span class="op" id="7541382">,</span>&nbsp;<span class="string" id="7541384">&#34;\r\n&#34;</span><span class="op" id="7541390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541394">client</span>&nbsp;<span class="op" id="7541401">:=</span>&nbsp;<span class="ident" id="7541404">strings</span><span class="op" id="7541411">.</span><span class="ident" id="7541412">Join</span><span class="op" id="7541416">(</span><span class="ident" id="7541417">strings</span><span class="op" id="7541424">.</span><span class="ident" id="7541425">Split</span><span class="op" id="7541430">(</span><span class="ident" id="7541431">baseHelloClient</span><span class="op" id="7541446">+</span><span class="ident" id="7541447">helloClient</span><span class="op" id="7541458">[</span><span class="ident" id="7541459">i</span><span class="op" id="7541460">]</span><span class="op" id="7541461">,</span>&nbsp;<span class="string" id="7541463">&#34;\n&#34;</span><span class="op" id="7541467">)</span><span class="op" id="7541468">,</span>&nbsp;<span class="string" id="7541470">&#34;\r\n&#34;</span><span class="op" id="7541476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541480">var</span>&nbsp;<span class="ident" id="7541484">cmdbuf</span>&nbsp;<span class="ident" id="7541491">bytes</span><span class="op" id="7541496">.</span><span class="ident" id="7541497">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541506">bcmdbuf</span>&nbsp;<span class="op" id="7541514">:=</span>&nbsp;<span class="ident" id="7541517">bufio</span><span class="op" id="7541522">.</span><span class="ident" id="7541523">NewWriter</span><span class="op" id="7541532">(</span><span class="op" id="7541533">&amp;</span><span class="ident" id="7541534">cmdbuf</span><span class="op" id="7541540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541544">var</span>&nbsp;<span class="ident" id="7541548">fake</span>&nbsp;<span class="ident" id="7541553">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541561">fake</span><span class="op" id="7541565">.</span><span class="ident" id="7541566">ReadWriter</span>&nbsp;<span class="op" id="7541577">=</span>&nbsp;<span class="ident" id="7541579">bufio</span><span class="op" id="7541584">.</span><span class="ident" id="7541585">NewReadWriter</span><span class="op" id="7541598">(</span><span class="ident" id="7541599">bufio</span><span class="op" id="7541604">.</span><span class="ident" id="7541605">NewReader</span><span class="op" id="7541614">(</span><span class="ident" id="7541615">strings</span><span class="op" id="7541622">.</span><span class="ident" id="7541623">NewReader</span><span class="op" id="7541632">(</span><span class="ident" id="7541633">server</span><span class="op" id="7541639">)</span><span class="op" id="7541640">)</span><span class="op" id="7541641">,</span>&nbsp;<span class="ident" id="7541643">bcmdbuf</span><span class="op" id="7541650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541654">c</span><span class="op" id="7541655">,</span>&nbsp;<span class="ident" id="7541657">err</span>&nbsp;<span class="op" id="7541661">:=</span>&nbsp;<span class="ident" id="7541664">NewClient</span><span class="op" id="7541673">(</span><span class="ident" id="7541674">fake</span><span class="op" id="7541678">,</span>&nbsp;<span class="string" id="7541680">&#34;fake.host&#34;</span><span class="op" id="7541691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541695">if</span>&nbsp;<span class="ident" id="7541698">err</span>&nbsp;<span class="op" id="7541702">!=</span>&nbsp;<span class="builtintype" id="7541705">nil</span>&nbsp;<span class="op" id="7541709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541714">t</span><span class="op" id="7541715">.</span><span class="ident" id="7541716">Fatalf</span><span class="op" id="7541722">(</span><span class="string" id="7541723">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7541738">,</span>&nbsp;<span class="ident" id="7541740">err</span><span class="op" id="7541743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7541747">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541751">defer</span>&nbsp;<span class="ident" id="7541757">c</span><span class="op" id="7541758">.</span><span class="ident" id="7541759">Close</span><span class="op" id="7541764">(</span><span class="op" id="7541765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541769">c</span><span class="op" id="7541770">.</span><span class="ident" id="7541771">localName</span>&nbsp;<span class="op" id="7541781">=</span>&nbsp;<span class="string" id="7541783">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541798">err</span>&nbsp;<span class="op" id="7541802">=</span>&nbsp;<span class="builtintype" id="7541804">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541811">switch</span>&nbsp;<span class="ident" id="7541818">i</span>&nbsp;<span class="op" id="7541820">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541824">case</span>&nbsp;<span class="num" id="7541829">0</span><span class="op" id="7541830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541835">err</span>&nbsp;<span class="op" id="7541839">=</span>&nbsp;<span class="ident" id="7541841">c</span><span class="op" id="7541842">.</span><span class="ident" id="7541843">Hello</span><span class="op" id="7541848">(</span><span class="string" id="7541849">&#34;customhost&#34;</span><span class="op" id="7541861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541865">case</span>&nbsp;<span class="num" id="7541870">1</span><span class="op" id="7541871">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541876">err</span>&nbsp;<span class="op" id="7541880">=</span>&nbsp;<span class="ident" id="7541882">c</span><span class="op" id="7541883">.</span><span class="ident" id="7541884">StartTLS</span><span class="op" id="7541892">(</span><span class="builtintype" id="7541893">nil</span><span class="op" id="7541896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541901">if</span>&nbsp;<span class="ident" id="7541904">err</span><span class="op" id="7541907">.</span><span class="ident" id="7541908">Error</span><span class="op" id="7541913">(</span><span class="op" id="7541914">)</span>&nbsp;<span class="op" id="7541916">==</span>&nbsp;<span class="string" id="7541919">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="7541941">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541947">err</span>&nbsp;<span class="op" id="7541951">=</span>&nbsp;<span class="builtintype" id="7541953">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7541960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7541964">case</span>&nbsp;<span class="num" id="7541969">2</span><span class="op" id="7541970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7541975">err</span>&nbsp;<span class="op" id="7541979">=</span>&nbsp;<span class="ident" id="7541981">c</span><span class="op" id="7541982">.</span><span class="ident" id="7541983">Verify</span><span class="op" id="7541989">(</span><span class="string" id="7541990">&#34;test@example.com&#34;</span><span class="op" id="7542008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542012">case</span>&nbsp;<span class="num" id="7542017">3</span><span class="op" id="7542018">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542023">c</span><span class="op" id="7542024">.</span><span class="ident" id="7542025">tls</span>&nbsp;<span class="op" id="7542029">=</span>&nbsp;<span class="builtintype" id="7542031">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542039">c</span><span class="op" id="7542040">.</span><span class="ident" id="7542041">serverName</span>&nbsp;<span class="op" id="7542052">=</span>&nbsp;<span class="string" id="7542054">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542075">err</span>&nbsp;<span class="op" id="7542079">=</span>&nbsp;<span class="ident" id="7542081">c</span><span class="op" id="7542082">.</span><span class="ident" id="7542083">Auth</span><span class="op" id="7542087">(</span><span class="ident" id="7542088">PlainAuth</span><span class="op" id="7542097">(</span><span class="string" id="7542098">&#34;&#34;</span><span class="op" id="7542100">,</span>&nbsp;<span class="string" id="7542102">&#34;user&#34;</span><span class="op" id="7542108">,</span>&nbsp;<span class="string" id="7542110">&#34;pass&#34;</span><span class="op" id="7542116">,</span>&nbsp;<span class="string" id="7542118">&#34;smtp.google.com&#34;</span><span class="op" id="7542135">)</span><span class="op" id="7542136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542140">case</span>&nbsp;<span class="num" id="7542145">4</span><span class="op" id="7542146">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542151">err</span>&nbsp;<span class="op" id="7542155">=</span>&nbsp;<span class="ident" id="7542157">c</span><span class="op" id="7542158">.</span><span class="ident" id="7542159">Mail</span><span class="op" id="7542163">(</span><span class="string" id="7542164">&#34;test@example.com&#34;</span><span class="op" id="7542182">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542186">case</span>&nbsp;<span class="num" id="7542191">5</span><span class="op" id="7542192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542197">ok</span><span class="op" id="7542199">,</span>&nbsp;<span class="ident" id="7542201">_</span>&nbsp;<span class="op" id="7542203">:=</span>&nbsp;<span class="ident" id="7542206">c</span><span class="op" id="7542207">.</span><span class="ident" id="7542208">Extension</span><span class="op" id="7542217">(</span><span class="string" id="7542218">&#34;feature&#34;</span><span class="op" id="7542227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542232">if</span>&nbsp;<span class="ident" id="7542235">ok</span>&nbsp;<span class="op" id="7542238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542244">t</span><span class="op" id="7542245">.</span><span class="ident" id="7542246">Errorf</span><span class="op" id="7542252">(</span><span class="string" id="7542253">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="7542291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542296">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542300">case</span>&nbsp;<span class="num" id="7542305">6</span><span class="op" id="7542306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542311">err</span>&nbsp;<span class="op" id="7542315">=</span>&nbsp;<span class="ident" id="7542317">c</span><span class="op" id="7542318">.</span><span class="ident" id="7542319">Reset</span><span class="op" id="7542324">(</span><span class="op" id="7542325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542329">case</span>&nbsp;<span class="num" id="7542334">7</span><span class="op" id="7542335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542340">err</span>&nbsp;<span class="op" id="7542344">=</span>&nbsp;<span class="ident" id="7542346">c</span><span class="op" id="7542347">.</span><span class="ident" id="7542348">Quit</span><span class="op" id="7542352">(</span><span class="op" id="7542353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542357">case</span>&nbsp;<span class="num" id="7542362">8</span><span class="op" id="7542363">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542368">err</span>&nbsp;<span class="op" id="7542372">=</span>&nbsp;<span class="ident" id="7542374">c</span><span class="op" id="7542375">.</span><span class="ident" id="7542376">Verify</span><span class="op" id="7542382">(</span><span class="string" id="7542383">&#34;test@example.com&#34;</span><span class="op" id="7542401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542406">if</span>&nbsp;<span class="ident" id="7542409">err</span>&nbsp;<span class="op" id="7542413">!=</span>&nbsp;<span class="builtintype" id="7542416">nil</span>&nbsp;<span class="op" id="7542420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542426">err</span>&nbsp;<span class="op" id="7542430">=</span>&nbsp;<span class="ident" id="7542432">c</span><span class="op" id="7542433">.</span><span class="ident" id="7542434">Hello</span><span class="op" id="7542439">(</span><span class="string" id="7542440">&#34;customhost&#34;</span><span class="op" id="7542452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542458">if</span>&nbsp;<span class="ident" id="7542461">err</span>&nbsp;<span class="op" id="7542465">!=</span>&nbsp;<span class="builtintype" id="7542468">nil</span>&nbsp;<span class="op" id="7542472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542479">t</span><span class="op" id="7542480">.</span><span class="ident" id="7542481">Errorf</span><span class="op" id="7542487">(</span><span class="string" id="7542488">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="7542510">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542525">default</span><span class="op" id="7542532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542537">t</span><span class="op" id="7542538">.</span><span class="ident" id="7542539">Fatalf</span><span class="op" id="7542545">(</span><span class="string" id="7542546">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="7542565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542569">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542574">if</span>&nbsp;<span class="ident" id="7542577">err</span>&nbsp;<span class="op" id="7542581">!=</span>&nbsp;<span class="builtintype" id="7542584">nil</span>&nbsp;<span class="op" id="7542588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542593">t</span><span class="op" id="7542594">.</span><span class="ident" id="7542595">Errorf</span><span class="op" id="7542601">(</span><span class="string" id="7542602">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7542625">,</span>&nbsp;<span class="ident" id="7542627">i</span><span class="op" id="7542628">,</span>&nbsp;<span class="ident" id="7542630">err</span><span class="op" id="7542633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542642">bcmdbuf</span><span class="op" id="7542649">.</span><span class="ident" id="7542650">Flush</span><span class="op" id="7542655">(</span><span class="op" id="7542656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542660">actualcmds</span>&nbsp;<span class="op" id="7542671">:=</span>&nbsp;<span class="ident" id="7542674">cmdbuf</span><span class="op" id="7542680">.</span><span class="ident" id="7542681">String</span><span class="op" id="7542687">(</span><span class="op" id="7542688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7542692">if</span>&nbsp;<span class="ident" id="7542695">client</span>&nbsp;<span class="op" id="7542702">!=</span>&nbsp;<span class="ident" id="7542705">actualcmds</span>&nbsp;<span class="op" id="7542716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7542721">t</span><span class="op" id="7542722">.</span><span class="ident" id="7542723">Errorf</span><span class="op" id="7542729">(</span><span class="string" id="7542730">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7542755">,</span>&nbsp;<span class="ident" id="7542757">actualcmds</span><span class="op" id="7542767">,</span>&nbsp;<span class="ident" id="7542769">client</span><span class="op" id="7542775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542779">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7542782">}</span><br>
<span class="lineno"></span><span class="op" id="7542784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7542787">var</span>&nbsp;<span class="ident" id="7542791">baseHelloServer</span>&nbsp;<span class="op" id="7542807">=</span>&nbsp;<span class="string" id="7542809">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7542883">var</span>&nbsp;<span class="ident" id="7542887">helloServer</span>&nbsp;<span class="op" id="7542899">=</span>&nbsp;<span class="op" id="7542901">[</span><span class="op" id="7542902">]</span><span class="builtintype" id="7542903">string</span><span class="op" id="7542909">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7542912">&#34;&#34;</span><span class="op" id="7542914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7542917">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="7542940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7542943">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="7542964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7542967">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="7542983">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7542986">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7543003">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543006">&#34;&#34;</span><span class="op" id="7543008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543011">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="7543027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543030">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="7543045">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543048">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="7543065">,</span><br>
<span class="lineno"></span><span class="op" id="7543067">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="7543070">var</span>&nbsp;<span class="ident" id="7543074">baseHelloClient</span>&nbsp;<span class="op" id="7543090">=</span>&nbsp;<span class="string" id="7543092">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="7543128">var</span>&nbsp;<span class="ident" id="7543132">helloClient</span>&nbsp;<span class="op" id="7543144">=</span>&nbsp;<span class="op" id="7543146">[</span><span class="op" id="7543147">]</span><span class="builtintype" id="7543148">string</span><span class="op" id="7543154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543157">&#34;&#34;</span><span class="op" id="7543159">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543162">&#34;STARTTLS\n&#34;</span><span class="op" id="7543174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543177">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7543202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543205">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="7543236">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543239">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="7543271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543274">&#34;&#34;</span><span class="op" id="7543276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543279">&#34;RSET\n&#34;</span><span class="op" id="7543287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543290">&#34;QUIT\n&#34;</span><span class="op" id="7543298">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7543301">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="7543326">,</span><br>
<span class="lineno">415</span><span class="op" id="7543328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7543331">func</span>&nbsp;<span class="ident" id="7543336">TestSendMail</span><span class="op" id="7543348">(</span><span class="ident" id="7543349">t</span>&nbsp;<span class="op" id="7543351">*</span><span class="ident" id="7543352">testing</span><span class="op" id="7543359">.</span><span class="ident" id="7543360">T</span><span class="op" id="7543361">)</span>&nbsp;<span class="op" id="7543363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543366">server</span>&nbsp;<span class="op" id="7543373">:=</span>&nbsp;<span class="ident" id="7543376">strings</span><span class="op" id="7543383">.</span><span class="ident" id="7543384">Join</span><span class="op" id="7543388">(</span><span class="ident" id="7543389">strings</span><span class="op" id="7543396">.</span><span class="ident" id="7543397">Split</span><span class="op" id="7543402">(</span><span class="ident" id="7543403">sendMailServer</span><span class="op" id="7543417">,</span>&nbsp;<span class="string" id="7543419">&#34;\n&#34;</span><span class="op" id="7543423">)</span><span class="op" id="7543424">,</span>&nbsp;<span class="string" id="7543426">&#34;\r\n&#34;</span><span class="op" id="7543432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543435">client</span>&nbsp;<span class="op" id="7543442">:=</span>&nbsp;<span class="ident" id="7543445">strings</span><span class="op" id="7543452">.</span><span class="ident" id="7543453">Join</span><span class="op" id="7543457">(</span><span class="ident" id="7543458">strings</span><span class="op" id="7543465">.</span><span class="ident" id="7543466">Split</span><span class="op" id="7543471">(</span><span class="ident" id="7543472">sendMailClient</span><span class="op" id="7543486">,</span>&nbsp;<span class="string" id="7543488">&#34;\n&#34;</span><span class="op" id="7543492">)</span><span class="op" id="7543493">,</span>&nbsp;<span class="string" id="7543495">&#34;\r\n&#34;</span><span class="op" id="7543501">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543504">var</span>&nbsp;<span class="ident" id="7543508">cmdbuf</span>&nbsp;<span class="ident" id="7543515">bytes</span><span class="op" id="7543520">.</span><span class="ident" id="7543521">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543529">bcmdbuf</span>&nbsp;<span class="op" id="7543537">:=</span>&nbsp;<span class="ident" id="7543540">bufio</span><span class="op" id="7543545">.</span><span class="ident" id="7543546">NewWriter</span><span class="op" id="7543555">(</span><span class="op" id="7543556">&amp;</span><span class="ident" id="7543557">cmdbuf</span><span class="op" id="7543563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543566">l</span><span class="op" id="7543567">,</span>&nbsp;<span class="ident" id="7543569">err</span>&nbsp;<span class="op" id="7543573">:=</span>&nbsp;<span class="ident" id="7543576">net</span><span class="op" id="7543579">.</span><span class="ident" id="7543580">Listen</span><span class="op" id="7543586">(</span><span class="string" id="7543587">&#34;tcp&#34;</span><span class="op" id="7543592">,</span>&nbsp;<span class="string" id="7543594">&#34;127.0.0.1:0&#34;</span><span class="op" id="7543607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543610">if</span>&nbsp;<span class="ident" id="7543613">err</span>&nbsp;<span class="op" id="7543617">!=</span>&nbsp;<span class="builtintype" id="7543620">nil</span>&nbsp;<span class="op" id="7543624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543628">t</span><span class="op" id="7543629">.</span><span class="ident" id="7543630">Fatalf</span><span class="op" id="7543636">(</span><span class="string" id="7543637">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="7543671">,</span>&nbsp;<span class="ident" id="7543673">err</span><span class="op" id="7543676">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7543679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543682">defer</span>&nbsp;<span class="ident" id="7543688">l</span><span class="op" id="7543689">.</span><span class="ident" id="7543690">Close</span><span class="op" id="7543695">(</span><span class="op" id="7543696">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7543700">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543733">var</span>&nbsp;<span class="ident" id="7543737">done</span>&nbsp;<span class="op" id="7543742">=</span>&nbsp;<span class="builtinfunc" id="7543744">make</span><span class="op" id="7543748">(</span><span class="keyword" id="7543749">chan</span>&nbsp;<span class="keyword" id="7543754">struct</span><span class="op" id="7543760">{</span><span class="op" id="7543761">}</span><span class="op" id="7543762">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543765">go</span>&nbsp;<span class="keyword" id="7543768">func</span><span class="op" id="7543772">(</span><span class="ident" id="7543773">data</span>&nbsp;<span class="op" id="7543778">[</span><span class="op" id="7543779">]</span><span class="builtintype" id="7543780">string</span><span class="op" id="7543786">)</span>&nbsp;<span class="op" id="7543788">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543793">defer</span>&nbsp;<span class="builtinfunc" id="7543799">close</span><span class="op" id="7543804">(</span><span class="ident" id="7543805">done</span><span class="op" id="7543809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543814">conn</span><span class="op" id="7543818">,</span>&nbsp;<span class="ident" id="7543820">err</span>&nbsp;<span class="op" id="7543824">:=</span>&nbsp;<span class="ident" id="7543827">l</span><span class="op" id="7543828">.</span><span class="ident" id="7543829">Accept</span><span class="op" id="7543835">(</span><span class="op" id="7543836">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543840">if</span>&nbsp;<span class="ident" id="7543843">err</span>&nbsp;<span class="op" id="7543847">!=</span>&nbsp;<span class="builtintype" id="7543850">nil</span>&nbsp;<span class="op" id="7543854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543859">t</span><span class="op" id="7543860">.</span><span class="ident" id="7543861">Errorf</span><span class="op" id="7543867">(</span><span class="string" id="7543868">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7543886">,</span>&nbsp;<span class="ident" id="7543888">err</span><span class="op" id="7543891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543896">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7543905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543909">defer</span>&nbsp;<span class="ident" id="7543915">conn</span><span class="op" id="7543919">.</span><span class="ident" id="7543920">Close</span><span class="op" id="7543925">(</span><span class="op" id="7543926">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7543931">tc</span>&nbsp;<span class="op" id="7543934">:=</span>&nbsp;<span class="ident" id="7543937">textproto</span><span class="op" id="7543946">.</span><span class="ident" id="7543947">NewConn</span><span class="op" id="7543954">(</span><span class="ident" id="7543955">conn</span><span class="op" id="7543959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7543963">for</span>&nbsp;<span class="ident" id="7543967">i</span>&nbsp;<span class="op" id="7543969">:=</span>&nbsp;<span class="num" id="7543972">0</span><span class="op" id="7543973">;</span>&nbsp;<span class="ident" id="7543975">i</span>&nbsp;<span class="op" id="7543977">&lt;</span>&nbsp;<span class="builtinfunc" id="7543979">len</span><span class="op" id="7543982">(</span><span class="ident" id="7543983">data</span><span class="op" id="7543987">)</span>&nbsp;<span class="op" id="7543989">&amp;&amp;</span>&nbsp;<span class="ident" id="7543992">data</span><span class="op" id="7543996">[</span><span class="ident" id="7543997">i</span><span class="op" id="7543998">]</span>&nbsp;<span class="op" id="7544000">!=</span>&nbsp;<span class="string" id="7544003">&#34;&#34;</span><span class="op" id="7544005">;</span>&nbsp;<span class="ident" id="7544007">i</span><span class="op" id="7544008">++</span>&nbsp;<span class="op" id="7544011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544016">tc</span><span class="op" id="7544018">.</span><span class="ident" id="7544019">PrintfLine</span><span class="op" id="7544029">(</span><span class="ident" id="7544030">data</span><span class="op" id="7544034">[</span><span class="ident" id="7544035">i</span><span class="op" id="7544036">]</span><span class="op" id="7544037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544042">for</span>&nbsp;<span class="builtinfunc" id="7544046">len</span><span class="op" id="7544049">(</span><span class="ident" id="7544050">data</span><span class="op" id="7544054">[</span><span class="ident" id="7544055">i</span><span class="op" id="7544056">]</span><span class="op" id="7544057">)</span>&nbsp;<span class="op" id="7544059">&gt;=</span>&nbsp;<span class="num" id="7544062">4</span>&nbsp;<span class="op" id="7544064">&amp;&amp;</span>&nbsp;<span class="ident" id="7544067">data</span><span class="op" id="7544071">[</span><span class="ident" id="7544072">i</span><span class="op" id="7544073">]</span><span class="op" id="7544074">[</span><span class="num" id="7544075">3</span><span class="op" id="7544076">]</span>&nbsp;<span class="op" id="7544078">==</span>&nbsp;<span class="string" id="7544081">&#39;-&#39;</span>&nbsp;<span class="op" id="7544085">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544091">i</span><span class="op" id="7544092">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544099">tc</span><span class="op" id="7544101">.</span><span class="ident" id="7544102">PrintfLine</span><span class="op" id="7544112">(</span><span class="ident" id="7544113">data</span><span class="op" id="7544117">[</span><span class="ident" id="7544118">i</span><span class="op" id="7544119">]</span><span class="op" id="7544120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544130">if</span>&nbsp;<span class="ident" id="7544133">data</span><span class="op" id="7544137">[</span><span class="ident" id="7544138">i</span><span class="op" id="7544139">]</span>&nbsp;<span class="op" id="7544141">==</span>&nbsp;<span class="string" id="7544144">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="7544158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544164">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544179">read</span>&nbsp;<span class="op" id="7544184">:=</span>&nbsp;<span class="builtintype" id="7544187">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544196">for</span>&nbsp;<span class="op" id="7544200">!</span><span class="ident" id="7544201">read</span>&nbsp;<span class="op" id="7544206">||</span>&nbsp;<span class="ident" id="7544209">data</span><span class="op" id="7544213">[</span><span class="ident" id="7544214">i</span><span class="op" id="7544215">]</span>&nbsp;<span class="op" id="7544217">==</span>&nbsp;<span class="string" id="7544220">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7544235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544241">msg</span><span class="op" id="7544244">,</span>&nbsp;<span class="ident" id="7544246">err</span>&nbsp;<span class="op" id="7544250">:=</span>&nbsp;<span class="ident" id="7544253">tc</span><span class="op" id="7544255">.</span><span class="ident" id="7544256">ReadLine</span><span class="op" id="7544264">(</span><span class="op" id="7544265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544271">bcmdbuf</span><span class="op" id="7544278">.</span><span class="ident" id="7544279">Write</span><span class="op" id="7544284">(</span><span class="op" id="7544285">[</span><span class="op" id="7544286">]</span><span class="builtintype" id="7544287">byte</span><span class="op" id="7544291">(</span><span class="ident" id="7544292">msg</span>&nbsp;<span class="op" id="7544296">+</span>&nbsp;<span class="string" id="7544298">&#34;\r\n&#34;</span><span class="op" id="7544304">)</span><span class="op" id="7544305">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544311">read</span>&nbsp;<span class="op" id="7544316">=</span>&nbsp;<span class="builtintype" id="7544318">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544327">if</span>&nbsp;<span class="ident" id="7544330">err</span>&nbsp;<span class="op" id="7544334">!=</span>&nbsp;<span class="builtintype" id="7544337">nil</span>&nbsp;<span class="op" id="7544341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544348">t</span><span class="op" id="7544349">.</span><span class="ident" id="7544350">Errorf</span><span class="op" id="7544356">(</span><span class="string" id="7544357">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7544373">,</span>&nbsp;<span class="ident" id="7544375">err</span><span class="op" id="7544378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544385">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544396">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544402">if</span>&nbsp;<span class="ident" id="7544405">data</span><span class="op" id="7544409">[</span><span class="ident" id="7544410">i</span><span class="op" id="7544411">]</span>&nbsp;<span class="op" id="7544413">==</span>&nbsp;<span class="string" id="7544416">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="7544431">&amp;&amp;</span>&nbsp;<span class="ident" id="7544434">msg</span>&nbsp;<span class="op" id="7544438">==</span>&nbsp;<span class="string" id="7544441">&#34;.&#34;</span>&nbsp;<span class="op" id="7544445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544452">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544471">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544474">}</span><span class="op" id="7544475">(</span><span class="ident" id="7544476">strings</span><span class="op" id="7544483">.</span><span class="ident" id="7544484">Split</span><span class="op" id="7544489">(</span><span class="ident" id="7544490">server</span><span class="op" id="7544496">,</span>&nbsp;<span class="string" id="7544498">&#34;\r\n&#34;</span><span class="op" id="7544504">)</span><span class="op" id="7544505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544509">err</span>&nbsp;<span class="op" id="7544513">=</span>&nbsp;<span class="ident" id="7544515">SendMail</span><span class="op" id="7544523">(</span><span class="ident" id="7544524">l</span><span class="op" id="7544525">.</span><span class="ident" id="7544526">Addr</span><span class="op" id="7544530">(</span><span class="op" id="7544531">)</span><span class="op" id="7544532">.</span><span class="ident" id="7544533">String</span><span class="op" id="7544539">(</span><span class="op" id="7544540">)</span><span class="op" id="7544541">,</span>&nbsp;<span class="builtintype" id="7544543">nil</span><span class="op" id="7544546">,</span>&nbsp;<span class="string" id="7544548">&#34;test@example.com&#34;</span><span class="op" id="7544566">,</span>&nbsp;<span class="op" id="7544568">[</span><span class="op" id="7544569">]</span><span class="builtintype" id="7544570">string</span><span class="op" id="7544576">{</span><span class="string" id="7544577">&#34;other@example.com&#34;</span><span class="op" id="7544596">}</span><span class="op" id="7544597">,</span>&nbsp;<span class="op" id="7544599">[</span><span class="op" id="7544600">]</span><span class="builtintype" id="7544601">byte</span><span class="op" id="7544605">(</span><span class="ident" id="7544606">strings</span><span class="op" id="7544613">.</span><span class="ident" id="7544614">Replace</span><span class="op" id="7544621">(</span><span class="string" id="7544622">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="7544721">,</span>&nbsp;<span class="string" id="7544723">&#34;\n&#34;</span><span class="op" id="7544727">,</span>&nbsp;<span class="string" id="7544729">&#34;\r\n&#34;</span><span class="op" id="7544735">,</span>&nbsp;<span class="op" id="7544737">-</span><span class="num" id="7544738">1</span><span class="op" id="7544739">)</span><span class="op" id="7544740">)</span><span class="op" id="7544741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544745">if</span>&nbsp;<span class="ident" id="7544748">err</span>&nbsp;<span class="op" id="7544752">!=</span>&nbsp;<span class="builtintype" id="7544755">nil</span>&nbsp;<span class="op" id="7544759">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544763">t</span><span class="op" id="7544764">.</span><span class="ident" id="7544765">Errorf</span><span class="op" id="7544771">(</span><span class="string" id="7544772">&#34;%v&#34;</span><span class="op" id="7544776">,</span>&nbsp;<span class="ident" id="7544778">err</span><span class="op" id="7544781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544788">&lt;-</span><span class="ident" id="7544790">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544796">bcmdbuf</span><span class="op" id="7544803">.</span><span class="ident" id="7544804">Flush</span><span class="op" id="7544809">(</span><span class="op" id="7544810">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544813">actualcmds</span>&nbsp;<span class="op" id="7544824">:=</span>&nbsp;<span class="ident" id="7544827">cmdbuf</span><span class="op" id="7544833">.</span><span class="ident" id="7544834">String</span><span class="op" id="7544840">(</span><span class="op" id="7544841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7544844">if</span>&nbsp;<span class="ident" id="7544847">client</span>&nbsp;<span class="op" id="7544854">!=</span>&nbsp;<span class="ident" id="7544857">actualcmds</span>&nbsp;<span class="op" id="7544868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7544872">t</span><span class="op" id="7544873">.</span><span class="ident" id="7544874">Errorf</span><span class="op" id="7544880">(</span><span class="string" id="7544881">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7544906">,</span>&nbsp;<span class="ident" id="7544908">actualcmds</span><span class="op" id="7544918">,</span>&nbsp;<span class="ident" id="7544920">client</span><span class="op" id="7544926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7544929">}</span><br>
<span class="lineno"></span><span class="op" id="7544931">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="7544934">var</span>&nbsp;<span class="ident" id="7544938">sendMailServer</span>&nbsp;<span class="op" id="7544953">=</span>&nbsp;<span class="string" id="7544955">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="7545084">var</span>&nbsp;<span class="ident" id="7545088">sendMailClient</span>&nbsp;<span class="op" id="7545103">=</span>&nbsp;<span class="string" id="7545105">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="7545305">func</span>&nbsp;<span class="ident" id="7545310">TestAuthFailed</span><span class="op" id="7545324">(</span><span class="ident" id="7545325">t</span>&nbsp;<span class="op" id="7545327">*</span><span class="ident" id="7545328">testing</span><span class="op" id="7545335">.</span><span class="ident" id="7545336">T</span><span class="op" id="7545337">)</span>&nbsp;<span class="op" id="7545339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545342">server</span>&nbsp;<span class="op" id="7545349">:=</span>&nbsp;<span class="ident" id="7545352">strings</span><span class="op" id="7545359">.</span><span class="ident" id="7545360">Join</span><span class="op" id="7545364">(</span><span class="ident" id="7545365">strings</span><span class="op" id="7545372">.</span><span class="ident" id="7545373">Split</span><span class="op" id="7545378">(</span><span class="ident" id="7545379">authFailedServer</span><span class="op" id="7545395">,</span>&nbsp;<span class="string" id="7545397">&#34;\n&#34;</span><span class="op" id="7545401">)</span><span class="op" id="7545402">,</span>&nbsp;<span class="string" id="7545404">&#34;\r\n&#34;</span><span class="op" id="7545410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545413">client</span>&nbsp;<span class="op" id="7545420">:=</span>&nbsp;<span class="ident" id="7545423">strings</span><span class="op" id="7545430">.</span><span class="ident" id="7545431">Join</span><span class="op" id="7545435">(</span><span class="ident" id="7545436">strings</span><span class="op" id="7545443">.</span><span class="ident" id="7545444">Split</span><span class="op" id="7545449">(</span><span class="ident" id="7545450">authFailedClient</span><span class="op" id="7545466">,</span>&nbsp;<span class="string" id="7545468">&#34;\n&#34;</span><span class="op" id="7545472">)</span><span class="op" id="7545473">,</span>&nbsp;<span class="string" id="7545475">&#34;\r\n&#34;</span><span class="op" id="7545481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7545484">var</span>&nbsp;<span class="ident" id="7545488">cmdbuf</span>&nbsp;<span class="ident" id="7545495">bytes</span><span class="op" id="7545500">.</span><span class="ident" id="7545501">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545509">bcmdbuf</span>&nbsp;<span class="op" id="7545517">:=</span>&nbsp;<span class="ident" id="7545520">bufio</span><span class="op" id="7545525">.</span><span class="ident" id="7545526">NewWriter</span><span class="op" id="7545535">(</span><span class="op" id="7545536">&amp;</span><span class="ident" id="7545537">cmdbuf</span><span class="op" id="7545543">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7545546">var</span>&nbsp;<span class="ident" id="7545550">fake</span>&nbsp;<span class="ident" id="7545555">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545562">fake</span><span class="op" id="7545566">.</span><span class="ident" id="7545567">ReadWriter</span>&nbsp;<span class="op" id="7545578">=</span>&nbsp;<span class="ident" id="7545580">bufio</span><span class="op" id="7545585">.</span><span class="ident" id="7545586">NewReadWriter</span><span class="op" id="7545599">(</span><span class="ident" id="7545600">bufio</span><span class="op" id="7545605">.</span><span class="ident" id="7545606">NewReader</span><span class="op" id="7545615">(</span><span class="ident" id="7545616">strings</span><span class="op" id="7545623">.</span><span class="ident" id="7545624">NewReader</span><span class="op" id="7545633">(</span><span class="ident" id="7545634">server</span><span class="op" id="7545640">)</span><span class="op" id="7545641">)</span><span class="op" id="7545642">,</span>&nbsp;<span class="ident" id="7545644">bcmdbuf</span><span class="op" id="7545651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545654">c</span><span class="op" id="7545655">,</span>&nbsp;<span class="ident" id="7545657">err</span>&nbsp;<span class="op" id="7545661">:=</span>&nbsp;<span class="ident" id="7545664">NewClient</span><span class="op" id="7545673">(</span><span class="ident" id="7545674">fake</span><span class="op" id="7545678">,</span>&nbsp;<span class="string" id="7545680">&#34;fake.host&#34;</span><span class="op" id="7545691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7545694">if</span>&nbsp;<span class="ident" id="7545697">err</span>&nbsp;<span class="op" id="7545701">!=</span>&nbsp;<span class="builtintype" id="7545704">nil</span>&nbsp;<span class="op" id="7545708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545712">t</span><span class="op" id="7545713">.</span><span class="ident" id="7545714">Fatalf</span><span class="op" id="7545720">(</span><span class="string" id="7545721">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="7545736">,</span>&nbsp;<span class="ident" id="7545738">err</span><span class="op" id="7545741">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7545744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7545747">defer</span>&nbsp;<span class="ident" id="7545753">c</span><span class="op" id="7545754">.</span><span class="ident" id="7545755">Close</span><span class="op" id="7545760">(</span><span class="op" id="7545761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545765">c</span><span class="op" id="7545766">.</span><span class="ident" id="7545767">tls</span>&nbsp;<span class="op" id="7545771">=</span>&nbsp;<span class="builtintype" id="7545773">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545779">c</span><span class="op" id="7545780">.</span><span class="ident" id="7545781">serverName</span>&nbsp;<span class="op" id="7545792">=</span>&nbsp;<span class="string" id="7545794">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545813">err</span>&nbsp;<span class="op" id="7545817">=</span>&nbsp;<span class="ident" id="7545819">c</span><span class="op" id="7545820">.</span><span class="ident" id="7545821">Auth</span><span class="op" id="7545825">(</span><span class="ident" id="7545826">PlainAuth</span><span class="op" id="7545835">(</span><span class="string" id="7545836">&#34;&#34;</span><span class="op" id="7545838">,</span>&nbsp;<span class="string" id="7545840">&#34;user&#34;</span><span class="op" id="7545846">,</span>&nbsp;<span class="string" id="7545848">&#34;pass&#34;</span><span class="op" id="7545854">,</span>&nbsp;<span class="string" id="7545856">&#34;smtp.google.com&#34;</span><span class="op" id="7545873">)</span><span class="op" id="7545874">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7545878">if</span>&nbsp;<span class="ident" id="7545881">err</span>&nbsp;<span class="op" id="7545885">==</span>&nbsp;<span class="builtintype" id="7545888">nil</span>&nbsp;<span class="op" id="7545892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7545896">t</span><span class="op" id="7545897">.</span><span class="ident" id="7545898">Error</span><span class="op" id="7545903">(</span><span class="string" id="7545904">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="7545936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7545939">}</span>&nbsp;<span class="keyword" id="7545941">else</span>&nbsp;<span class="keyword" id="7545946">if</span>&nbsp;<span class="ident" id="7545949">err</span><span class="op" id="7545952">.</span><span class="ident" id="7545953">Error</span><span class="op" id="7545958">(</span><span class="op" id="7545959">)</span>&nbsp;<span class="op" id="7545961">!=</span>&nbsp;<span class="string" id="7545964">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="7546018">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546022">t</span><span class="op" id="7546023">.</span><span class="ident" id="7546024">Errorf</span><span class="op" id="7546030">(</span><span class="string" id="7546031">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="7546062">,</span>&nbsp;<span class="ident" id="7546064">err</span><span class="op" id="7546067">,</span>&nbsp;<span class="string" id="7546069">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="7546122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7546125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546129">bcmdbuf</span><span class="op" id="7546136">.</span><span class="ident" id="7546137">Flush</span><span class="op" id="7546142">(</span><span class="op" id="7546143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546146">actualcmds</span>&nbsp;<span class="op" id="7546157">:=</span>&nbsp;<span class="ident" id="7546160">cmdbuf</span><span class="op" id="7546166">.</span><span class="ident" id="7546167">String</span><span class="op" id="7546173">(</span><span class="op" id="7546174">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546177">if</span>&nbsp;<span class="ident" id="7546180">client</span>&nbsp;<span class="op" id="7546187">!=</span>&nbsp;<span class="ident" id="7546190">actualcmds</span>&nbsp;<span class="op" id="7546201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546205">t</span><span class="op" id="7546206">.</span><span class="ident" id="7546207">Errorf</span><span class="op" id="7546213">(</span><span class="string" id="7546214">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="7546239">,</span>&nbsp;<span class="ident" id="7546241">actualcmds</span><span class="op" id="7546251">,</span>&nbsp;<span class="ident" id="7546253">client</span><span class="op" id="7546259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7546262">}</span><br>
<span class="lineno"></span><span class="op" id="7546264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="7546267">var</span>&nbsp;<span class="ident" id="7546271">authFailedServer</span>&nbsp;<span class="op" id="7546288">=</span>&nbsp;<span class="string" id="7546290">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7546432">var</span>&nbsp;<span class="ident" id="7546436">authFailedClient</span>&nbsp;<span class="op" id="7546453">=</span>&nbsp;<span class="string" id="7546455">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7546509">func</span>&nbsp;<span class="ident" id="7546514">TestTLSClient</span><span class="op" id="7546527">(</span><span class="ident" id="7546528">t</span>&nbsp;<span class="op" id="7546530">*</span><span class="ident" id="7546531">testing</span><span class="op" id="7546538">.</span><span class="ident" id="7546539">T</span><span class="op" id="7546540">)</span>&nbsp;<span class="op" id="7546542">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546545">ln</span>&nbsp;<span class="op" id="7546548">:=</span>&nbsp;<span class="ident" id="7546551">newLocalListener</span><span class="op" id="7546567">(</span><span class="ident" id="7546568">t</span><span class="op" id="7546569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546572">defer</span>&nbsp;<span class="ident" id="7546578">ln</span><span class="op" id="7546580">.</span><span class="ident" id="7546581">Close</span><span class="op" id="7546586">(</span><span class="op" id="7546587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546590">errc</span>&nbsp;<span class="op" id="7546595">:=</span>&nbsp;<span class="builtinfunc" id="7546598">make</span><span class="op" id="7546602">(</span><span class="keyword" id="7546603">chan</span>&nbsp;<span class="builtintype" id="7546608">error</span><span class="op" id="7546613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546616">go</span>&nbsp;<span class="keyword" id="7546619">func</span><span class="op" id="7546623">(</span><span class="op" id="7546624">)</span>&nbsp;<span class="op" id="7546626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546630">errc</span>&nbsp;<span class="op" id="7546635">&lt;-</span>&nbsp;<span class="ident" id="7546638">sendMail</span><span class="op" id="7546646">(</span><span class="ident" id="7546647">ln</span><span class="op" id="7546649">.</span><span class="ident" id="7546650">Addr</span><span class="op" id="7546654">(</span><span class="op" id="7546655">)</span><span class="op" id="7546656">.</span><span class="ident" id="7546657">String</span><span class="op" id="7546663">(</span><span class="op" id="7546664">)</span><span class="op" id="7546665">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7546668">}</span><span class="op" id="7546669">(</span><span class="op" id="7546670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546673">conn</span><span class="op" id="7546677">,</span>&nbsp;<span class="ident" id="7546679">err</span>&nbsp;<span class="op" id="7546683">:=</span>&nbsp;<span class="ident" id="7546686">ln</span><span class="op" id="7546688">.</span><span class="ident" id="7546689">Accept</span><span class="op" id="7546695">(</span><span class="op" id="7546696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546699">if</span>&nbsp;<span class="ident" id="7546702">err</span>&nbsp;<span class="op" id="7546706">!=</span>&nbsp;<span class="builtintype" id="7546709">nil</span>&nbsp;<span class="op" id="7546713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546717">t</span><span class="op" id="7546718">.</span><span class="ident" id="7546719">Fatalf</span><span class="op" id="7546725">(</span><span class="string" id="7546726">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7546759">,</span>&nbsp;<span class="ident" id="7546761">err</span><span class="op" id="7546764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7546767">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546770">defer</span>&nbsp;<span class="ident" id="7546776">conn</span><span class="op" id="7546780">.</span><span class="ident" id="7546781">Close</span><span class="op" id="7546786">(</span><span class="op" id="7546787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546790">if</span>&nbsp;<span class="ident" id="7546793">err</span>&nbsp;<span class="op" id="7546797">:=</span>&nbsp;<span class="ident" id="7546800">serverHandle</span><span class="op" id="7546812">(</span><span class="ident" id="7546813">conn</span><span class="op" id="7546817">,</span>&nbsp;<span class="ident" id="7546819">t</span><span class="op" id="7546820">)</span><span class="op" id="7546821">;</span>&nbsp;<span class="ident" id="7546823">err</span>&nbsp;<span class="op" id="7546827">!=</span>&nbsp;<span class="builtintype" id="7546830">nil</span>&nbsp;<span class="op" id="7546834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546838">t</span><span class="op" id="7546839">.</span><span class="ident" id="7546840">Fatalf</span><span class="op" id="7546846">(</span><span class="string" id="7546847">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="7546880">,</span>&nbsp;<span class="ident" id="7546882">err</span><span class="op" id="7546885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7546888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7546891">if</span>&nbsp;<span class="ident" id="7546894">err</span>&nbsp;<span class="op" id="7546898">:=</span>&nbsp;<span class="op" id="7546901">&lt;-</span><span class="ident" id="7546903">errc</span><span class="op" id="7546907">;</span>&nbsp;<span class="ident" id="7546909">err</span>&nbsp;<span class="op" id="7546913">!=</span>&nbsp;<span class="builtintype" id="7546916">nil</span>&nbsp;<span class="op" id="7546920">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7546924">t</span><span class="op" id="7546925">.</span><span class="ident" id="7546926">Fatalf</span><span class="op" id="7546932">(</span><span class="string" id="7546933">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7546951">,</span>&nbsp;<span class="ident" id="7546953">err</span><span class="op" id="7546956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7546959">}</span><br>
<span class="lineno"></span><span class="op" id="7546961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7546964">func</span>&nbsp;<span class="ident" id="7546969">newLocalListener</span><span class="op" id="7546985">(</span><span class="ident" id="7546986">t</span>&nbsp;<span class="op" id="7546988">*</span><span class="ident" id="7546989">testing</span><span class="op" id="7546996">.</span><span class="ident" id="7546997">T</span><span class="op" id="7546998">)</span>&nbsp;<span class="ident" id="7547000">net</span><span class="op" id="7547003">.</span><span class="ident" id="7547004">Listener</span>&nbsp;<span class="op" id="7547013">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547016">ln</span><span class="op" id="7547018">,</span>&nbsp;<span class="ident" id="7547020">err</span>&nbsp;<span class="op" id="7547024">:=</span>&nbsp;<span class="ident" id="7547027">net</span><span class="op" id="7547030">.</span><span class="ident" id="7547031">Listen</span><span class="op" id="7547037">(</span><span class="string" id="7547038">&#34;tcp&#34;</span><span class="op" id="7547043">,</span>&nbsp;<span class="string" id="7547045">&#34;127.0.0.1:0&#34;</span><span class="op" id="7547058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547061">if</span>&nbsp;<span class="ident" id="7547064">err</span>&nbsp;<span class="op" id="7547068">!=</span>&nbsp;<span class="builtintype" id="7547071">nil</span>&nbsp;<span class="op" id="7547075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547079">ln</span><span class="op" id="7547081">,</span>&nbsp;<span class="ident" id="7547083">err</span>&nbsp;<span class="op" id="7547087">=</span>&nbsp;<span class="ident" id="7547089">net</span><span class="op" id="7547092">.</span><span class="ident" id="7547093">Listen</span><span class="op" id="7547099">(</span><span class="string" id="7547100">&#34;tcp6&#34;</span><span class="op" id="7547106">,</span>&nbsp;<span class="string" id="7547108">&#34;[::1]:0&#34;</span><span class="op" id="7547117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7547120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547123">if</span>&nbsp;<span class="ident" id="7547126">err</span>&nbsp;<span class="op" id="7547130">!=</span>&nbsp;<span class="builtintype" id="7547133">nil</span>&nbsp;<span class="op" id="7547137">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547141">t</span><span class="op" id="7547142">.</span><span class="ident" id="7547143">Fatal</span><span class="op" id="7547148">(</span><span class="ident" id="7547149">err</span><span class="op" id="7547152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7547155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547158">return</span>&nbsp;<span class="ident" id="7547165">ln</span><br>
<span class="lineno"></span><span class="op" id="7547168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="7547171">type</span>&nbsp;<span class="ident" id="7547176">smtpSender</span>&nbsp;<span class="keyword" id="7547187">struct</span>&nbsp;<span class="op" id="7547194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547197">w</span>&nbsp;<span class="ident" id="7547199">io</span><span class="op" id="7547201">.</span><span class="ident" id="7547202">Writer</span><br>
<span class="lineno"></span><span class="op" id="7547209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7547212">func</span>&nbsp;<span class="op" id="7547217">(</span><span class="ident" id="7547218">s</span>&nbsp;<span class="ident" id="7547220">smtpSender</span><span class="op" id="7547230">)</span>&nbsp;<span class="ident" id="7547232">send</span><span class="op" id="7547236">(</span><span class="ident" id="7547237">f</span>&nbsp;<span class="builtintype" id="7547239">string</span><span class="op" id="7547245">)</span>&nbsp;<span class="op" id="7547247">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547250">s</span><span class="op" id="7547251">.</span><span class="ident" id="7547252">w</span><span class="op" id="7547253">.</span><span class="ident" id="7547254">Write</span><span class="op" id="7547259">(</span><span class="op" id="7547260">[</span><span class="op" id="7547261">]</span><span class="builtintype" id="7547262">byte</span><span class="op" id="7547266">(</span><span class="ident" id="7547267">f</span>&nbsp;<span class="op" id="7547269">+</span>&nbsp;<span class="string" id="7547271">&#34;\r\n&#34;</span><span class="op" id="7547277">)</span><span class="op" id="7547278">)</span><br>
<span class="lineno"></span><span class="op" id="7547280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7547283">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="7547349">func</span>&nbsp;<span class="ident" id="7547354">serverHandle</span><span class="op" id="7547366">(</span><span class="ident" id="7547367">c</span>&nbsp;<span class="ident" id="7547369">net</span><span class="op" id="7547372">.</span><span class="ident" id="7547373">Conn</span><span class="op" id="7547377">,</span>&nbsp;<span class="ident" id="7547379">t</span>&nbsp;<span class="op" id="7547381">*</span><span class="ident" id="7547382">testing</span><span class="op" id="7547389">.</span><span class="ident" id="7547390">T</span><span class="op" id="7547391">)</span>&nbsp;<span class="builtintype" id="7547393">error</span>&nbsp;<span class="op" id="7547399">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547402">send</span>&nbsp;<span class="op" id="7547407">:=</span>&nbsp;<span class="ident" id="7547410">smtpSender</span><span class="op" id="7547420">{</span><span class="ident" id="7547421">c</span><span class="op" id="7547422">}</span><span class="op" id="7547423">.</span><span class="ident" id="7547424">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547430">send</span><span class="op" id="7547434">(</span><span class="string" id="7547435">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="7547470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547473">s</span>&nbsp;<span class="op" id="7547475">:=</span>&nbsp;<span class="ident" id="7547478">bufio</span><span class="op" id="7547483">.</span><span class="ident" id="7547484">NewScanner</span><span class="op" id="7547494">(</span><span class="ident" id="7547495">c</span><span class="op" id="7547496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547499">for</span>&nbsp;<span class="ident" id="7547503">s</span><span class="op" id="7547504">.</span><span class="ident" id="7547505">Scan</span><span class="op" id="7547509">(</span><span class="op" id="7547510">)</span>&nbsp;<span class="op" id="7547512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547516">switch</span>&nbsp;<span class="ident" id="7547523">s</span><span class="op" id="7547524">.</span><span class="ident" id="7547525">Text</span><span class="op" id="7547529">(</span><span class="op" id="7547530">)</span>&nbsp;<span class="op" id="7547532">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547536">case</span>&nbsp;<span class="string" id="7547541">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7547557">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547562">send</span><span class="op" id="7547566">(</span><span class="string" id="7547567">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="7547617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547622">send</span><span class="op" id="7547626">(</span><span class="string" id="7547627">&#34;250-STARTTLS&#34;</span><span class="op" id="7547641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547646">send</span><span class="op" id="7547650">(</span><span class="string" id="7547651">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7547659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547663">case</span>&nbsp;<span class="string" id="7547668">&#34;STARTTLS&#34;</span><span class="op" id="7547678">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547683">send</span><span class="op" id="7547687">(</span><span class="string" id="7547688">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="7547702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547707">keypair</span><span class="op" id="7547714">,</span>&nbsp;<span class="ident" id="7547716">err</span>&nbsp;<span class="op" id="7547720">:=</span>&nbsp;<span class="ident" id="7547723">tls</span><span class="op" id="7547726">.</span><span class="ident" id="7547727">X509KeyPair</span><span class="op" id="7547738">(</span><span class="ident" id="7547739">localhostCert</span><span class="op" id="7547752">,</span>&nbsp;<span class="ident" id="7547754">localhostKey</span><span class="op" id="7547766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547771">if</span>&nbsp;<span class="ident" id="7547774">err</span>&nbsp;<span class="op" id="7547778">!=</span>&nbsp;<span class="builtintype" id="7547781">nil</span>&nbsp;<span class="op" id="7547785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547791">return</span>&nbsp;<span class="ident" id="7547798">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7547805">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547810">config</span>&nbsp;<span class="op" id="7547817">:=</span>&nbsp;<span class="op" id="7547820">&amp;</span><span class="ident" id="7547821">tls</span><span class="op" id="7547824">.</span><span class="ident" id="7547825">Config</span><span class="op" id="7547831">{</span><span class="ident" id="7547832">Certificates</span><span class="op" id="7547844">:</span>&nbsp;<span class="op" id="7547846">[</span><span class="op" id="7547847">]</span><span class="ident" id="7547848">tls</span><span class="op" id="7547851">.</span><span class="ident" id="7547852">Certificate</span><span class="op" id="7547863">{</span><span class="ident" id="7547864">keypair</span><span class="op" id="7547871">}</span><span class="op" id="7547872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547877">c</span>&nbsp;<span class="op" id="7547879">=</span>&nbsp;<span class="ident" id="7547881">tls</span><span class="op" id="7547884">.</span><span class="ident" id="7547885">Server</span><span class="op" id="7547891">(</span><span class="ident" id="7547892">c</span><span class="op" id="7547893">,</span>&nbsp;<span class="ident" id="7547895">config</span><span class="op" id="7547901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547906">defer</span>&nbsp;<span class="ident" id="7547912">c</span><span class="op" id="7547913">.</span><span class="ident" id="7547914">Close</span><span class="op" id="7547919">(</span><span class="op" id="7547920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547925">return</span>&nbsp;<span class="ident" id="7547932">serverHandleTLS</span><span class="op" id="7547947">(</span><span class="ident" id="7547948">c</span><span class="op" id="7547949">,</span>&nbsp;<span class="ident" id="7547951">t</span><span class="op" id="7547952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7547956">default</span><span class="op" id="7547963">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7547968">t</span><span class="op" id="7547969">.</span><span class="ident" id="7547970">Fatalf</span><span class="op" id="7547976">(</span><span class="string" id="7547977">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="7548003">,</span>&nbsp;<span class="ident" id="7548005">s</span><span class="op" id="7548006">.</span><span class="ident" id="7548007">Text</span><span class="op" id="7548011">(</span><span class="op" id="7548012">)</span><span class="op" id="7548013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7548017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7548020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548023">return</span>&nbsp;<span class="ident" id="7548030">s</span><span class="op" id="7548031">.</span><span class="ident" id="7548032">Err</span><span class="op" id="7548035">(</span><span class="op" id="7548036">)</span><br>
<span class="lineno"></span><span class="op" id="7548038">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="7548041">func</span>&nbsp;<span class="ident" id="7548046">serverHandleTLS</span><span class="op" id="7548061">(</span><span class="ident" id="7548062">c</span>&nbsp;<span class="ident" id="7548064">net</span><span class="op" id="7548067">.</span><span class="ident" id="7548068">Conn</span><span class="op" id="7548072">,</span>&nbsp;<span class="ident" id="7548074">t</span>&nbsp;<span class="op" id="7548076">*</span><span class="ident" id="7548077">testing</span><span class="op" id="7548084">.</span><span class="ident" id="7548085">T</span><span class="op" id="7548086">)</span>&nbsp;<span class="builtintype" id="7548088">error</span>&nbsp;<span class="op" id="7548094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548097">send</span>&nbsp;<span class="op" id="7548102">:=</span>&nbsp;<span class="ident" id="7548105">smtpSender</span><span class="op" id="7548115">{</span><span class="ident" id="7548116">c</span><span class="op" id="7548117">}</span><span class="op" id="7548118">.</span><span class="ident" id="7548119">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548125">s</span>&nbsp;<span class="op" id="7548127">:=</span>&nbsp;<span class="ident" id="7548130">bufio</span><span class="op" id="7548135">.</span><span class="ident" id="7548136">NewScanner</span><span class="op" id="7548146">(</span><span class="ident" id="7548147">c</span><span class="op" id="7548148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548151">for</span>&nbsp;<span class="ident" id="7548155">s</span><span class="op" id="7548156">.</span><span class="ident" id="7548157">Scan</span><span class="op" id="7548161">(</span><span class="op" id="7548162">)</span>&nbsp;<span class="op" id="7548164">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548168">switch</span>&nbsp;<span class="ident" id="7548175">s</span><span class="op" id="7548176">.</span><span class="ident" id="7548177">Text</span><span class="op" id="7548181">(</span><span class="op" id="7548182">)</span>&nbsp;<span class="op" id="7548184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548188">case</span>&nbsp;<span class="string" id="7548193">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="7548209">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548214">send</span><span class="op" id="7548218">(</span><span class="string" id="7548219">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7548227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548231">case</span>&nbsp;<span class="string" id="7548236">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="7548266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548271">send</span><span class="op" id="7548275">(</span><span class="string" id="7548276">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7548284">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548288">case</span>&nbsp;<span class="string" id="7548293">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="7548321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548326">send</span><span class="op" id="7548330">(</span><span class="string" id="7548331">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7548339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548343">case</span>&nbsp;<span class="string" id="7548348">&#34;DATA&#34;</span><span class="op" id="7548354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548359">send</span><span class="op" id="7548363">(</span><span class="string" id="7548364">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="7548400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548405">send</span><span class="op" id="7548409">(</span><span class="string" id="7548410">&#34;250&nbsp;Ok&#34;</span><span class="op" id="7548418">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548422">case</span>&nbsp;<span class="string" id="7548427">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="7548442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548446">case</span>&nbsp;<span class="string" id="7548451">&#34;&#34;</span><span class="op" id="7548453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548457">case</span>&nbsp;<span class="string" id="7548462">&#34;howdy!&#34;</span><span class="op" id="7548470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548474">case</span>&nbsp;<span class="string" id="7548479">&#34;.&#34;</span><span class="op" id="7548482">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548486">case</span>&nbsp;<span class="string" id="7548491">&#34;QUIT&#34;</span><span class="op" id="7548497">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548502">send</span><span class="op" id="7548506">(</span><span class="string" id="7548507">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="7548559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548564">return</span>&nbsp;<span class="builtintype" id="7548571">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548577">default</span><span class="op" id="7548584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548589">t</span><span class="op" id="7548590">.</span><span class="ident" id="7548591">Fatalf</span><span class="op" id="7548597">(</span><span class="string" id="7548598">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="7548635">,</span>&nbsp;<span class="ident" id="7548637">s</span><span class="op" id="7548638">.</span><span class="ident" id="7548639">Text</span><span class="op" id="7548643">(</span><span class="op" id="7548644">)</span><span class="op" id="7548645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7548649">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7548652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548655">return</span>&nbsp;<span class="ident" id="7548662">s</span><span class="op" id="7548663">.</span><span class="ident" id="7548664">Err</span><span class="op" id="7548667">(</span><span class="op" id="7548668">)</span><br>
<span class="lineno"></span><span class="op" id="7548670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7548673">func</span>&nbsp;<span class="ident" id="7548678">init</span><span class="op" id="7548682">(</span><span class="op" id="7548683">)</span>&nbsp;<span class="op" id="7548685">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548688">testRootCAs</span>&nbsp;<span class="op" id="7548700">:=</span>&nbsp;<span class="ident" id="7548703">x509</span><span class="op" id="7548707">.</span><span class="ident" id="7548708">NewCertPool</span><span class="op" id="7548719">(</span><span class="op" id="7548720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548723">testRootCAs</span><span class="op" id="7548734">.</span><span class="ident" id="7548735">AppendCertsFromPEM</span><span class="op" id="7548753">(</span><span class="ident" id="7548754">localhostCert</span><span class="op" id="7548767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548770">testHookStartTLS</span>&nbsp;<span class="op" id="7548787">=</span>&nbsp;<span class="keyword" id="7548789">func</span><span class="op" id="7548793">(</span><span class="ident" id="7548794">config</span>&nbsp;<span class="op" id="7548801">*</span><span class="ident" id="7548802">tls</span><span class="op" id="7548805">.</span><span class="ident" id="7548806">Config</span><span class="op" id="7548812">)</span>&nbsp;<span class="op" id="7548814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548818">config</span><span class="op" id="7548824">.</span><span class="ident" id="7548825">RootCAs</span>&nbsp;<span class="op" id="7548833">=</span>&nbsp;<span class="ident" id="7548835">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7548848">}</span><br>
<span class="lineno">655</span><span class="op" id="7548850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7548853">func</span>&nbsp;<span class="ident" id="7548858">sendMail</span><span class="op" id="7548866">(</span><span class="ident" id="7548867">hostPort</span>&nbsp;<span class="builtintype" id="7548876">string</span><span class="op" id="7548882">)</span>&nbsp;<span class="builtintype" id="7548884">error</span>&nbsp;<span class="op" id="7548890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548893">host</span><span class="op" id="7548897">,</span>&nbsp;<span class="ident" id="7548899">_</span><span class="op" id="7548900">,</span>&nbsp;<span class="ident" id="7548902">err</span>&nbsp;<span class="op" id="7548906">:=</span>&nbsp;<span class="ident" id="7548909">net</span><span class="op" id="7548912">.</span><span class="ident" id="7548913">SplitHostPort</span><span class="op" id="7548926">(</span><span class="ident" id="7548927">hostPort</span><span class="op" id="7548935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548938">if</span>&nbsp;<span class="ident" id="7548941">err</span>&nbsp;<span class="op" id="7548945">!=</span>&nbsp;<span class="builtintype" id="7548948">nil</span>&nbsp;<span class="op" id="7548952">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7548956">return</span>&nbsp;<span class="ident" id="7548963">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7548968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7548971">auth</span>&nbsp;<span class="op" id="7548976">:=</span>&nbsp;<span class="ident" id="7548979">PlainAuth</span><span class="op" id="7548988">(</span><span class="string" id="7548989">&#34;&#34;</span><span class="op" id="7548991">,</span>&nbsp;<span class="string" id="7548993">&#34;&#34;</span><span class="op" id="7548995">,</span>&nbsp;<span class="string" id="7548997">&#34;&#34;</span><span class="op" id="7548999">,</span>&nbsp;<span class="ident" id="7549001">host</span><span class="op" id="7549005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7549008">from</span>&nbsp;<span class="op" id="7549013">:=</span>&nbsp;<span class="string" id="7549016">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7549036">to</span>&nbsp;<span class="op" id="7549039">:=</span>&nbsp;<span class="op" id="7549042">[</span><span class="op" id="7549043">]</span><span class="builtintype" id="7549044">string</span><span class="op" id="7549050">{</span><span class="string" id="7549051">&#34;joe2@example.com&#34;</span><span class="op" id="7549069">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7549072">return</span>&nbsp;<span class="ident" id="7549079">SendMail</span><span class="op" id="7549087">(</span><span class="ident" id="7549088">hostPort</span><span class="op" id="7549096">,</span>&nbsp;<span class="ident" id="7549098">auth</span><span class="op" id="7549102">,</span>&nbsp;<span class="ident" id="7549104">from</span><span class="op" id="7549108">,</span>&nbsp;<span class="ident" id="7549110">to</span><span class="op" id="7549112">,</span>&nbsp;<span class="op" id="7549114">[</span><span class="op" id="7549115">]</span><span class="builtintype" id="7549116">byte</span><span class="op" id="7549120">(</span><span class="string" id="7549121">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="7549146">)</span><span class="op" id="7549147">)</span><br>
<span class="lineno"></span><span class="op" id="7549149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7549152">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="7549187">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="7549243">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="7549316">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="7549335">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="7549369">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="7549505">var</span>&nbsp;<span class="ident" id="7549509">localhostCert</span>&nbsp;<span class="op" id="7549523">=</span>&nbsp;<span class="op" id="7549525">[</span><span class="op" id="7549526">]</span><span class="builtintype" id="7549527">byte</span><span class="op" id="7549531">(</span><span class="string" id="7549532">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="7550103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="7550106">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="7550160">var</span>&nbsp;<span class="ident" id="7550164">localhostKey</span>&nbsp;<span class="op" id="7550177">=</span>&nbsp;<span class="op" id="7550179">[</span><span class="op" id="7550180">]</span><span class="builtintype" id="7550181">byte</span><span class="op" id="7550185">(</span><span class="string" id="7550186">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="7550684">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
