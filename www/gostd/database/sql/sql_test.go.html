<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html" class="current">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7175567">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7175622">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7175676">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7175727">package</span>&nbsp;<span class="ident" id="7175735">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7175740">import</span>&nbsp;<span class="op" id="7175747">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175750">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175773">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175783">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175790">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175803">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175814">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175825">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175836">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175844">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7175855">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7175862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7175865">func</span>&nbsp;<span class="ident" id="7175870">init</span><span class="op" id="7175874">(</span><span class="op" id="7175875">)</span>&nbsp;<span class="op" id="7175877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175880">type</span>&nbsp;<span class="ident" id="7175885">dbConn</span>&nbsp;<span class="keyword" id="7175892">struct</span>&nbsp;<span class="op" id="7175899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7175903">db</span>&nbsp;<span class="op" id="7175906">*</span><span class="ident" id="7175907">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7175912">c</span>&nbsp;&nbsp;<span class="op" id="7175915">*</span><span class="ident" id="7175916">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7175928">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7175931">freedFrom</span>&nbsp;<span class="op" id="7175941">:=</span>&nbsp;<span class="builtinfunc" id="7175944">make</span><span class="op" id="7175948">(</span><span class="keyword" id="7175949">map</span><span class="op" id="7175952">[</span><span class="ident" id="7175953">dbConn</span><span class="op" id="7175959">]</span><span class="builtintype" id="7175960">string</span><span class="op" id="7175966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7175969">putConnHook</span>&nbsp;<span class="op" id="7175981">=</span>&nbsp;<span class="keyword" id="7175983">func</span><span class="op" id="7175987">(</span><span class="ident" id="7175988">db</span>&nbsp;<span class="op" id="7175991">*</span><span class="ident" id="7175992">DB</span><span class="op" id="7175994">,</span>&nbsp;<span class="ident" id="7175996">c</span>&nbsp;<span class="op" id="7175998">*</span><span class="ident" id="7175999">driverConn</span><span class="op" id="7176009">)</span>&nbsp;<span class="op" id="7176011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176015">idx</span>&nbsp;<span class="op" id="7176019">:=</span>&nbsp;<span class="op" id="7176022">-</span><span class="num" id="7176023">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176027">for</span>&nbsp;<span class="ident" id="7176031">i</span><span class="op" id="7176032">,</span>&nbsp;<span class="ident" id="7176034">v</span>&nbsp;<span class="op" id="7176036">:=</span>&nbsp;<span class="keyword" id="7176039">range</span>&nbsp;<span class="ident" id="7176045">db</span><span class="op" id="7176047">.</span><span class="ident" id="7176048">freeConn</span>&nbsp;<span class="op" id="7176057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176062">if</span>&nbsp;<span class="ident" id="7176065">v</span>&nbsp;<span class="op" id="7176067">==</span>&nbsp;<span class="ident" id="7176070">c</span>&nbsp;<span class="op" id="7176072">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176078">idx</span>&nbsp;<span class="op" id="7176082">=</span>&nbsp;<span class="ident" id="7176084">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176090">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7176099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7176103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176107">if</span>&nbsp;<span class="ident" id="7176110">idx</span>&nbsp;<span class="op" id="7176114">&gt;=</span>&nbsp;<span class="num" id="7176117">0</span>&nbsp;<span class="op" id="7176119">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7176124">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7176197">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7176264">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7176298">println</span><span class="op" id="7176305">(</span><span class="string" id="7176306">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="7176349">+</span>&nbsp;<span class="ident" id="7176351">freedFrom</span><span class="op" id="7176360">[</span><span class="ident" id="7176361">dbConn</span><span class="op" id="7176367">{</span><span class="ident" id="7176368">db</span><span class="op" id="7176370">,</span>&nbsp;<span class="ident" id="7176372">c</span><span class="op" id="7176373">}</span><span class="op" id="7176374">]</span>&nbsp;<span class="op" id="7176376">+</span>&nbsp;<span class="string" id="7176378">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="7176393">+</span>&nbsp;<span class="ident" id="7176395">stack</span><span class="op" id="7176400">(</span><span class="op" id="7176401">)</span><span class="op" id="7176402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7176407">panic</span><span class="op" id="7176412">(</span><span class="string" id="7176413">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="7176435">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7176439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176443">freedFrom</span><span class="op" id="7176452">[</span><span class="ident" id="7176453">dbConn</span><span class="op" id="7176459">{</span><span class="ident" id="7176460">db</span><span class="op" id="7176462">,</span>&nbsp;<span class="ident" id="7176464">c</span><span class="op" id="7176465">}</span><span class="op" id="7176466">]</span>&nbsp;<span class="op" id="7176468">=</span>&nbsp;<span class="ident" id="7176470">stack</span><span class="op" id="7176475">(</span><span class="op" id="7176476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7176479">}</span><br>
<span class="lineno"></span><span class="op" id="7176481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="7176484">const</span>&nbsp;<span class="ident" id="7176490">fakeDBName</span>&nbsp;<span class="op" id="7176501">=</span>&nbsp;<span class="string" id="7176503">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7176510">var</span>&nbsp;<span class="ident" id="7176514">chrisBirthday</span>&nbsp;<span class="op" id="7176528">=</span>&nbsp;<span class="ident" id="7176530">time</span><span class="op" id="7176534">.</span><span class="ident" id="7176535">Unix</span><span class="op" id="7176539">(</span><span class="num" id="7176540">123456789</span><span class="op" id="7176549">,</span>&nbsp;<span class="num" id="7176551">0</span><span class="op" id="7176552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7176555">func</span>&nbsp;<span class="ident" id="7176560">newTestDB</span><span class="op" id="7176569">(</span><span class="ident" id="7176570">t</span>&nbsp;<span class="ident" id="7176572">testing</span><span class="op" id="7176579">.</span><span class="ident" id="7176580">TB</span><span class="op" id="7176582">,</span>&nbsp;<span class="ident" id="7176584">name</span>&nbsp;<span class="builtintype" id="7176589">string</span><span class="op" id="7176595">)</span>&nbsp;<span class="op" id="7176597">*</span><span class="ident" id="7176598">DB</span>&nbsp;<span class="op" id="7176601">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176604">db</span><span class="op" id="7176606">,</span>&nbsp;<span class="ident" id="7176608">err</span>&nbsp;<span class="op" id="7176612">:=</span>&nbsp;<span class="ident" id="7176615">Open</span><span class="op" id="7176619">(</span><span class="string" id="7176620">&#34;test&#34;</span><span class="op" id="7176626">,</span>&nbsp;<span class="ident" id="7176628">fakeDBName</span><span class="op" id="7176638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176641">if</span>&nbsp;<span class="ident" id="7176644">err</span>&nbsp;<span class="op" id="7176648">!=</span>&nbsp;<span class="builtintype" id="7176651">nil</span>&nbsp;<span class="op" id="7176655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176659">t</span><span class="op" id="7176660">.</span><span class="ident" id="7176661">Fatalf</span><span class="op" id="7176667">(</span><span class="string" id="7176668">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7176678">,</span>&nbsp;<span class="ident" id="7176680">err</span><span class="op" id="7176683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7176686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176689">if</span>&nbsp;<span class="ident" id="7176692">_</span><span class="op" id="7176693">,</span>&nbsp;<span class="ident" id="7176695">err</span>&nbsp;<span class="op" id="7176699">:=</span>&nbsp;<span class="ident" id="7176702">db</span><span class="op" id="7176704">.</span><span class="ident" id="7176705">Exec</span><span class="op" id="7176709">(</span><span class="string" id="7176710">&#34;WIPE&#34;</span><span class="op" id="7176716">)</span><span class="op" id="7176717">;</span>&nbsp;<span class="ident" id="7176719">err</span>&nbsp;<span class="op" id="7176723">!=</span>&nbsp;<span class="builtintype" id="7176726">nil</span>&nbsp;<span class="op" id="7176730">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176734">t</span><span class="op" id="7176735">.</span><span class="ident" id="7176736">Fatalf</span><span class="op" id="7176742">(</span><span class="string" id="7176743">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7176758">,</span>&nbsp;<span class="ident" id="7176760">err</span><span class="op" id="7176763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7176766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7176769">if</span>&nbsp;<span class="ident" id="7176772">name</span>&nbsp;<span class="op" id="7176777">==</span>&nbsp;<span class="string" id="7176780">&#34;people&#34;</span>&nbsp;<span class="op" id="7176789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176793">exec</span><span class="op" id="7176797">(</span><span class="ident" id="7176798">t</span><span class="op" id="7176799">,</span>&nbsp;<span class="ident" id="7176801">db</span><span class="op" id="7176803">,</span>&nbsp;<span class="string" id="7176805">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="7176878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176882">exec</span><span class="op" id="7176886">(</span><span class="ident" id="7176887">t</span><span class="op" id="7176888">,</span>&nbsp;<span class="ident" id="7176890">db</span><span class="op" id="7176892">,</span>&nbsp;<span class="string" id="7176894">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="7176939">,</span>&nbsp;<span class="num" id="7176941">1</span><span class="op" id="7176942">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7176946">exec</span><span class="op" id="7176950">(</span><span class="ident" id="7176951">t</span><span class="op" id="7176952">,</span>&nbsp;<span class="ident" id="7176954">db</span><span class="op" id="7176956">,</span>&nbsp;<span class="string" id="7176958">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="7177001">,</span>&nbsp;<span class="num" id="7177003">2</span><span class="op" id="7177004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177008">exec</span><span class="op" id="7177012">(</span><span class="ident" id="7177013">t</span><span class="op" id="7177014">,</span>&nbsp;<span class="ident" id="7177016">db</span><span class="op" id="7177018">,</span>&nbsp;<span class="string" id="7177020">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7177073">,</span>&nbsp;<span class="num" id="7177075">3</span><span class="op" id="7177076">,</span>&nbsp;<span class="ident" id="7177078">chrisBirthday</span><span class="op" id="7177091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7177094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177097">if</span>&nbsp;<span class="ident" id="7177100">name</span>&nbsp;<span class="op" id="7177105">==</span>&nbsp;<span class="string" id="7177108">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7177121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7177125">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177184">exec</span><span class="op" id="7177188">(</span><span class="ident" id="7177189">t</span><span class="op" id="7177190">,</span>&nbsp;<span class="ident" id="7177192">db</span><span class="op" id="7177194">,</span>&nbsp;<span class="string" id="7177196">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="7177238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177242">exec</span><span class="op" id="7177246">(</span><span class="ident" id="7177247">t</span><span class="op" id="7177248">,</span>&nbsp;<span class="ident" id="7177250">db</span><span class="op" id="7177252">,</span>&nbsp;<span class="string" id="7177254">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="7177292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7177295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177298">return</span>&nbsp;<span class="ident" id="7177305">db</span><br>
<span class="lineno"></span><span class="op" id="7177308">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="7177311">func</span>&nbsp;<span class="ident" id="7177316">exec</span><span class="op" id="7177320">(</span><span class="ident" id="7177321">t</span>&nbsp;<span class="ident" id="7177323">testing</span><span class="op" id="7177330">.</span><span class="ident" id="7177331">TB</span><span class="op" id="7177333">,</span>&nbsp;<span class="ident" id="7177335">db</span>&nbsp;<span class="op" id="7177338">*</span><span class="ident" id="7177339">DB</span><span class="op" id="7177341">,</span>&nbsp;<span class="ident" id="7177343">query</span>&nbsp;<span class="builtintype" id="7177349">string</span><span class="op" id="7177355">,</span>&nbsp;<span class="ident" id="7177357">args</span>&nbsp;<span class="op" id="7177362">...</span><span class="keyword" id="7177365">interface</span><span class="op" id="7177374">{</span><span class="op" id="7177375">}</span><span class="op" id="7177376">)</span>&nbsp;<span class="op" id="7177378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177381">_</span><span class="op" id="7177382">,</span>&nbsp;<span class="ident" id="7177384">err</span>&nbsp;<span class="op" id="7177388">:=</span>&nbsp;<span class="ident" id="7177391">db</span><span class="op" id="7177393">.</span><span class="ident" id="7177394">Exec</span><span class="op" id="7177398">(</span><span class="ident" id="7177399">query</span><span class="op" id="7177404">,</span>&nbsp;<span class="ident" id="7177406">args</span><span class="op" id="7177410">...</span><span class="op" id="7177413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177416">if</span>&nbsp;<span class="ident" id="7177419">err</span>&nbsp;<span class="op" id="7177423">!=</span>&nbsp;<span class="builtintype" id="7177426">nil</span>&nbsp;<span class="op" id="7177430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177434">t</span><span class="op" id="7177435">.</span><span class="ident" id="7177436">Fatalf</span><span class="op" id="7177442">(</span><span class="string" id="7177443">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="7177459">,</span>&nbsp;<span class="ident" id="7177461">query</span><span class="op" id="7177466">,</span>&nbsp;<span class="ident" id="7177468">err</span><span class="op" id="7177471">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7177474">}</span><br>
<span class="lineno"></span><span class="op" id="7177476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7177479">func</span>&nbsp;<span class="ident" id="7177484">closeDB</span><span class="op" id="7177491">(</span><span class="ident" id="7177492">t</span>&nbsp;<span class="ident" id="7177494">testing</span><span class="op" id="7177501">.</span><span class="ident" id="7177502">TB</span><span class="op" id="7177504">,</span>&nbsp;<span class="ident" id="7177506">db</span>&nbsp;<span class="op" id="7177509">*</span><span class="ident" id="7177510">DB</span><span class="op" id="7177512">)</span>&nbsp;<span class="op" id="7177514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177517">if</span>&nbsp;<span class="ident" id="7177520">e</span>&nbsp;<span class="op" id="7177522">:=</span>&nbsp;<span class="builtinfunc" id="7177525">recover</span><span class="op" id="7177532">(</span><span class="op" id="7177533">)</span><span class="op" id="7177534">;</span>&nbsp;<span class="ident" id="7177536">e</span>&nbsp;<span class="op" id="7177538">!=</span>&nbsp;<span class="builtintype" id="7177541">nil</span>&nbsp;<span class="op" id="7177545">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177549">fmt</span><span class="op" id="7177552">.</span><span class="ident" id="7177553">Printf</span><span class="op" id="7177559">(</span><span class="string" id="7177560">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="7177573">,</span>&nbsp;<span class="ident" id="7177575">e</span><span class="op" id="7177576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7177580">panic</span><span class="op" id="7177585">(</span><span class="ident" id="7177586">e</span><span class="op" id="7177587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7177590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177593">defer</span>&nbsp;<span class="ident" id="7177599">setHookpostCloseConn</span><span class="op" id="7177619">(</span><span class="builtintype" id="7177620">nil</span><span class="op" id="7177623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177626">setHookpostCloseConn</span><span class="op" id="7177646">(</span><span class="keyword" id="7177647">func</span><span class="op" id="7177651">(</span><span class="ident" id="7177652">_</span>&nbsp;<span class="op" id="7177654">*</span><span class="ident" id="7177655">fakeConn</span><span class="op" id="7177663">,</span>&nbsp;<span class="ident" id="7177665">err</span>&nbsp;<span class="builtintype" id="7177669">error</span><span class="op" id="7177674">)</span>&nbsp;<span class="op" id="7177676">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177680">if</span>&nbsp;<span class="ident" id="7177683">err</span>&nbsp;<span class="op" id="7177687">!=</span>&nbsp;<span class="builtintype" id="7177690">nil</span>&nbsp;<span class="op" id="7177694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7177699">t</span><span class="op" id="7177700">.</span><span class="ident" id="7177701">Errorf</span><span class="op" id="7177707">(</span><span class="string" id="7177708">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7177736">,</span>&nbsp;<span class="ident" id="7177738">err</span><span class="op" id="7177741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7177745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7177748">}</span><span class="op" id="7177749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177752">for</span>&nbsp;<span class="ident" id="7177756">i</span><span class="op" id="7177757">,</span>&nbsp;<span class="ident" id="7177759">dc</span>&nbsp;<span class="op" id="7177762">:=</span>&nbsp;<span class="keyword" id="7177765">range</span>&nbsp;<span class="ident" id="7177771">db</span><span class="op" id="7177773">.</span><span class="ident" id="7177774">freeConn</span>&nbsp;<span class="op" id="7177783">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7177787">if</span>&nbsp;<span class="ident" id="7177790">n</span>&nbsp;<span class="op" id="7177792">:=</span>&nbsp;<span class="builtinfunc" id="7177795">len</span><span class="op" id="7177798">(</span><span class="ident" id="7177799">dc</span><span class="op" id="7177801">.</span><span class="ident" id="7177802">openStmt</span><span class="op" id="7177810">)</span><span class="op" id="7177811">;</span>&nbsp;<span class="ident" id="7177813">n</span>&nbsp;<span class="op" id="7177815">&gt;</span>&nbsp;<span class="num" id="7177817">0</span>&nbsp;<span class="op" id="7177819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7177824">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7177868">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7177917">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7177966">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7178013">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178042">t</span><span class="op" id="7178043">.</span><span class="ident" id="7178044">Errorf</span><span class="op" id="7178050">(</span><span class="string" id="7178051">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7178111">,</span>&nbsp;<span class="ident" id="7178113">i</span><span class="op" id="7178114">,</span>&nbsp;<span class="builtinfunc" id="7178116">len</span><span class="op" id="7178119">(</span><span class="ident" id="7178120">db</span><span class="op" id="7178122">.</span><span class="ident" id="7178123">freeConn</span><span class="op" id="7178131">)</span><span class="op" id="7178132">,</span>&nbsp;<span class="ident" id="7178134">n</span><span class="op" id="7178135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7178139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7178142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178145">err</span>&nbsp;<span class="op" id="7178149">:=</span>&nbsp;<span class="ident" id="7178152">db</span><span class="op" id="7178154">.</span><span class="ident" id="7178155">Close</span><span class="op" id="7178160">(</span><span class="op" id="7178161">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178164">if</span>&nbsp;<span class="ident" id="7178167">err</span>&nbsp;<span class="op" id="7178171">!=</span>&nbsp;<span class="builtintype" id="7178174">nil</span>&nbsp;<span class="op" id="7178178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178182">t</span><span class="op" id="7178183">.</span><span class="ident" id="7178184">Fatalf</span><span class="op" id="7178190">(</span><span class="string" id="7178191">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="7178213">,</span>&nbsp;<span class="ident" id="7178215">err</span><span class="op" id="7178218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7178221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178224">db</span><span class="op" id="7178226">.</span><span class="ident" id="7178227">mu</span><span class="op" id="7178229">.</span><span class="ident" id="7178230">Lock</span><span class="op" id="7178234">(</span><span class="op" id="7178235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178238">count</span>&nbsp;<span class="op" id="7178244">:=</span>&nbsp;<span class="ident" id="7178247">db</span><span class="op" id="7178249">.</span><span class="ident" id="7178250">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178259">db</span><span class="op" id="7178261">.</span><span class="ident" id="7178262">mu</span><span class="op" id="7178264">.</span><span class="ident" id="7178265">Unlock</span><span class="op" id="7178271">(</span><span class="op" id="7178272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178275">if</span>&nbsp;<span class="ident" id="7178278">count</span>&nbsp;<span class="op" id="7178284">!=</span>&nbsp;<span class="num" id="7178287">0</span>&nbsp;<span class="op" id="7178289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178293">t</span><span class="op" id="7178294">.</span><span class="ident" id="7178295">Fatalf</span><span class="op" id="7178301">(</span><span class="string" id="7178302">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="7178346">,</span>&nbsp;<span class="ident" id="7178348">db</span><span class="op" id="7178350">.</span><span class="ident" id="7178351">numOpen</span><span class="op" id="7178358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7178361">}</span><br>
<span class="lineno"></span><span class="op" id="7178363">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="7178366">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="7178433">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="7178466">func</span>&nbsp;<span class="ident" id="7178471">numPrepares</span><span class="op" id="7178482">(</span><span class="ident" id="7178483">t</span>&nbsp;<span class="op" id="7178485">*</span><span class="ident" id="7178486">testing</span><span class="op" id="7178493">.</span><span class="ident" id="7178494">T</span><span class="op" id="7178495">,</span>&nbsp;<span class="ident" id="7178497">db</span>&nbsp;<span class="op" id="7178500">*</span><span class="ident" id="7178501">DB</span><span class="op" id="7178503">)</span>&nbsp;<span class="builtintype" id="7178505">int</span>&nbsp;<span class="op" id="7178509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178512">if</span>&nbsp;<span class="ident" id="7178515">n</span>&nbsp;<span class="op" id="7178517">:=</span>&nbsp;<span class="builtinfunc" id="7178520">len</span><span class="op" id="7178523">(</span><span class="ident" id="7178524">db</span><span class="op" id="7178526">.</span><span class="ident" id="7178527">freeConn</span><span class="op" id="7178535">)</span><span class="op" id="7178536">;</span>&nbsp;<span class="ident" id="7178538">n</span>&nbsp;<span class="op" id="7178540">!=</span>&nbsp;<span class="num" id="7178543">1</span>&nbsp;<span class="op" id="7178545">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178549">t</span><span class="op" id="7178550">.</span><span class="ident" id="7178551">Fatalf</span><span class="op" id="7178557">(</span><span class="string" id="7178558">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7178583">,</span>&nbsp;<span class="ident" id="7178585">n</span><span class="op" id="7178586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7178589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178592">return</span>&nbsp;<span class="ident" id="7178599">db</span><span class="op" id="7178601">.</span><span class="ident" id="7178602">freeConn</span><span class="op" id="7178610">[</span><span class="num" id="7178611">0</span><span class="op" id="7178612">]</span><span class="op" id="7178613">.</span><span class="ident" id="7178614">ci</span><span class="op" id="7178616">.</span><span class="op" id="7178617">(</span><span class="op" id="7178618">*</span><span class="ident" id="7178619">fakeConn</span><span class="op" id="7178627">)</span><span class="op" id="7178628">.</span><span class="ident" id="7178629">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="7178640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="7178643">func</span>&nbsp;<span class="op" id="7178648">(</span><span class="ident" id="7178649">db</span>&nbsp;<span class="op" id="7178652">*</span><span class="ident" id="7178653">DB</span><span class="op" id="7178655">)</span>&nbsp;<span class="ident" id="7178657">numDeps</span><span class="op" id="7178664">(</span><span class="op" id="7178665">)</span>&nbsp;<span class="builtintype" id="7178667">int</span>&nbsp;<span class="op" id="7178671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178674">db</span><span class="op" id="7178676">.</span><span class="ident" id="7178677">mu</span><span class="op" id="7178679">.</span><span class="ident" id="7178680">Lock</span><span class="op" id="7178684">(</span><span class="op" id="7178685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178688">defer</span>&nbsp;<span class="ident" id="7178694">db</span><span class="op" id="7178696">.</span><span class="ident" id="7178697">mu</span><span class="op" id="7178699">.</span><span class="ident" id="7178700">Unlock</span><span class="op" id="7178706">(</span><span class="op" id="7178707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178710">return</span>&nbsp;<span class="builtinfunc" id="7178717">len</span><span class="op" id="7178720">(</span><span class="ident" id="7178721">db</span><span class="op" id="7178723">.</span><span class="ident" id="7178724">dep</span><span class="op" id="7178727">)</span><br>
<span class="lineno"></span><span class="op" id="7178729">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="7178732">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7178802">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="7178847">func</span>&nbsp;<span class="op" id="7178852">(</span><span class="ident" id="7178853">db</span>&nbsp;<span class="op" id="7178856">*</span><span class="ident" id="7178857">DB</span><span class="op" id="7178859">)</span>&nbsp;<span class="ident" id="7178861">numDepsPollUntil</span><span class="op" id="7178877">(</span><span class="ident" id="7178878">want</span>&nbsp;<span class="builtintype" id="7178883">int</span><span class="op" id="7178886">,</span>&nbsp;<span class="ident" id="7178888">d</span>&nbsp;<span class="ident" id="7178890">time</span><span class="op" id="7178894">.</span><span class="ident" id="7178895">Duration</span><span class="op" id="7178903">)</span>&nbsp;<span class="builtintype" id="7178905">int</span>&nbsp;<span class="op" id="7178909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178912">deadline</span>&nbsp;<span class="op" id="7178921">:=</span>&nbsp;<span class="ident" id="7178924">time</span><span class="op" id="7178928">.</span><span class="ident" id="7178929">Now</span><span class="op" id="7178932">(</span><span class="op" id="7178933">)</span><span class="op" id="7178934">.</span><span class="ident" id="7178935">Add</span><span class="op" id="7178938">(</span><span class="ident" id="7178939">d</span><span class="op" id="7178940">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178943">for</span>&nbsp;<span class="op" id="7178947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7178951">n</span>&nbsp;<span class="op" id="7178953">:=</span>&nbsp;<span class="ident" id="7178956">db</span><span class="op" id="7178958">.</span><span class="ident" id="7178959">numDeps</span><span class="op" id="7178966">(</span><span class="op" id="7178967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7178971">if</span>&nbsp;<span class="ident" id="7178974">n</span>&nbsp;<span class="op" id="7178976">&lt;=</span>&nbsp;<span class="ident" id="7178979">want</span>&nbsp;<span class="op" id="7178984">||</span>&nbsp;<span class="ident" id="7178987">time</span><span class="op" id="7178991">.</span><span class="ident" id="7178992">Now</span><span class="op" id="7178995">(</span><span class="op" id="7178996">)</span><span class="op" id="7178997">.</span><span class="ident" id="7178998">After</span><span class="op" id="7179003">(</span><span class="ident" id="7179004">deadline</span><span class="op" id="7179012">)</span>&nbsp;<span class="op" id="7179014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179019">return</span>&nbsp;<span class="ident" id="7179026">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179030">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179034">time</span><span class="op" id="7179038">.</span><span class="ident" id="7179039">Sleep</span><span class="op" id="7179044">(</span><span class="num" id="7179045">50</span>&nbsp;<span class="op" id="7179048">*</span>&nbsp;<span class="ident" id="7179050">time</span><span class="op" id="7179054">.</span><span class="ident" id="7179055">Millisecond</span><span class="op" id="7179066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179069">}</span><br>
<span class="lineno"></span><span class="op" id="7179071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7179074">func</span>&nbsp;<span class="op" id="7179079">(</span><span class="ident" id="7179080">db</span>&nbsp;<span class="op" id="7179083">*</span><span class="ident" id="7179084">DB</span><span class="op" id="7179086">)</span>&nbsp;<span class="ident" id="7179088">numFreeConns</span><span class="op" id="7179100">(</span><span class="op" id="7179101">)</span>&nbsp;<span class="builtintype" id="7179103">int</span>&nbsp;<span class="op" id="7179107">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179110">db</span><span class="op" id="7179112">.</span><span class="ident" id="7179113">mu</span><span class="op" id="7179115">.</span><span class="ident" id="7179116">Lock</span><span class="op" id="7179120">(</span><span class="op" id="7179121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179124">defer</span>&nbsp;<span class="ident" id="7179130">db</span><span class="op" id="7179132">.</span><span class="ident" id="7179133">mu</span><span class="op" id="7179135">.</span><span class="ident" id="7179136">Unlock</span><span class="op" id="7179142">(</span><span class="op" id="7179143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179146">return</span>&nbsp;<span class="builtinfunc" id="7179153">len</span><span class="op" id="7179156">(</span><span class="ident" id="7179157">db</span><span class="op" id="7179159">.</span><span class="ident" id="7179160">freeConn</span><span class="op" id="7179168">)</span><br>
<span class="lineno"></span><span class="op" id="7179170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="7179173">func</span>&nbsp;<span class="op" id="7179178">(</span><span class="ident" id="7179179">db</span>&nbsp;<span class="op" id="7179182">*</span><span class="ident" id="7179183">DB</span><span class="op" id="7179185">)</span>&nbsp;<span class="ident" id="7179187">dumpDeps</span><span class="op" id="7179195">(</span><span class="ident" id="7179196">t</span>&nbsp;<span class="op" id="7179198">*</span><span class="ident" id="7179199">testing</span><span class="op" id="7179206">.</span><span class="ident" id="7179207">T</span><span class="op" id="7179208">)</span>&nbsp;<span class="op" id="7179210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179213">for</span>&nbsp;<span class="ident" id="7179217">fc</span>&nbsp;<span class="op" id="7179220">:=</span>&nbsp;<span class="keyword" id="7179223">range</span>&nbsp;<span class="ident" id="7179229">db</span><span class="op" id="7179231">.</span><span class="ident" id="7179232">dep</span>&nbsp;<span class="op" id="7179236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179240">db</span><span class="op" id="7179242">.</span><span class="ident" id="7179243">dumpDep</span><span class="op" id="7179250">(</span><span class="ident" id="7179251">t</span><span class="op" id="7179252">,</span>&nbsp;<span class="num" id="7179254">0</span><span class="op" id="7179255">,</span>&nbsp;<span class="ident" id="7179257">fc</span><span class="op" id="7179259">,</span>&nbsp;<span class="keyword" id="7179261">map</span><span class="op" id="7179264">[</span><span class="ident" id="7179265">finalCloser</span><span class="op" id="7179276">]</span><span class="builtintype" id="7179277">bool</span><span class="op" id="7179281">{</span><span class="op" id="7179282">}</span><span class="op" id="7179283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179286">}</span><br>
<span class="lineno"></span><span class="op" id="7179288">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="7179291">func</span>&nbsp;<span class="op" id="7179296">(</span><span class="ident" id="7179297">db</span>&nbsp;<span class="op" id="7179300">*</span><span class="ident" id="7179301">DB</span><span class="op" id="7179303">)</span>&nbsp;<span class="ident" id="7179305">dumpDep</span><span class="op" id="7179312">(</span><span class="ident" id="7179313">t</span>&nbsp;<span class="op" id="7179315">*</span><span class="ident" id="7179316">testing</span><span class="op" id="7179323">.</span><span class="ident" id="7179324">T</span><span class="op" id="7179325">,</span>&nbsp;<span class="ident" id="7179327">depth</span>&nbsp;<span class="builtintype" id="7179333">int</span><span class="op" id="7179336">,</span>&nbsp;<span class="ident" id="7179338">dep</span>&nbsp;<span class="ident" id="7179342">finalCloser</span><span class="op" id="7179353">,</span>&nbsp;<span class="ident" id="7179355">seen</span>&nbsp;<span class="keyword" id="7179360">map</span><span class="op" id="7179363">[</span><span class="ident" id="7179364">finalCloser</span><span class="op" id="7179375">]</span><span class="builtintype" id="7179376">bool</span><span class="op" id="7179380">)</span>&nbsp;<span class="op" id="7179382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179385">seen</span><span class="op" id="7179389">[</span><span class="ident" id="7179390">dep</span><span class="op" id="7179393">]</span>&nbsp;<span class="op" id="7179395">=</span>&nbsp;<span class="builtintype" id="7179397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179403">indent</span>&nbsp;<span class="op" id="7179410">:=</span>&nbsp;<span class="ident" id="7179413">strings</span><span class="op" id="7179420">.</span><span class="ident" id="7179421">Repeat</span><span class="op" id="7179427">(</span><span class="string" id="7179428">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="7179432">,</span>&nbsp;<span class="ident" id="7179434">depth</span><span class="op" id="7179439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179442">ds</span>&nbsp;<span class="op" id="7179445">:=</span>&nbsp;<span class="ident" id="7179448">db</span><span class="op" id="7179450">.</span><span class="ident" id="7179451">dep</span><span class="op" id="7179454">[</span><span class="ident" id="7179455">dep</span><span class="op" id="7179458">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179461">for</span>&nbsp;<span class="ident" id="7179465">k</span>&nbsp;<span class="op" id="7179467">:=</span>&nbsp;<span class="keyword" id="7179470">range</span>&nbsp;<span class="ident" id="7179476">ds</span>&nbsp;<span class="op" id="7179479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179483">t</span><span class="op" id="7179484">.</span><span class="ident" id="7179485">Logf</span><span class="op" id="7179489">(</span><span class="string" id="7179490">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="7179524">,</span>&nbsp;<span class="ident" id="7179526">indent</span><span class="op" id="7179532">,</span>&nbsp;<span class="ident" id="7179534">dep</span><span class="op" id="7179537">,</span>&nbsp;<span class="ident" id="7179539">dep</span><span class="op" id="7179542">,</span>&nbsp;<span class="ident" id="7179544">k</span><span class="op" id="7179545">,</span>&nbsp;<span class="ident" id="7179547">k</span><span class="op" id="7179548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179552">if</span>&nbsp;<span class="ident" id="7179555">fc</span><span class="op" id="7179557">,</span>&nbsp;<span class="ident" id="7179559">ok</span>&nbsp;<span class="op" id="7179562">:=</span>&nbsp;<span class="ident" id="7179565">k</span><span class="op" id="7179566">.</span><span class="op" id="7179567">(</span><span class="ident" id="7179568">finalCloser</span><span class="op" id="7179579">)</span><span class="op" id="7179580">;</span>&nbsp;<span class="ident" id="7179582">ok</span>&nbsp;<span class="op" id="7179585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179590">if</span>&nbsp;<span class="op" id="7179593">!</span><span class="ident" id="7179594">seen</span><span class="op" id="7179598">[</span><span class="ident" id="7179599">fc</span><span class="op" id="7179601">]</span>&nbsp;<span class="op" id="7179603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179609">db</span><span class="op" id="7179611">.</span><span class="ident" id="7179612">dumpDep</span><span class="op" id="7179619">(</span><span class="ident" id="7179620">t</span><span class="op" id="7179621">,</span>&nbsp;<span class="ident" id="7179623">depth</span><span class="op" id="7179628">+</span><span class="num" id="7179629">1</span><span class="op" id="7179630">,</span>&nbsp;<span class="ident" id="7179632">fc</span><span class="op" id="7179634">,</span>&nbsp;<span class="ident" id="7179636">seen</span><span class="op" id="7179640">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179652">}</span><br>
<span class="lineno"></span><span class="op" id="7179654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7179657">func</span>&nbsp;<span class="ident" id="7179662">TestQuery</span><span class="op" id="7179671">(</span><span class="ident" id="7179672">t</span>&nbsp;<span class="op" id="7179674">*</span><span class="ident" id="7179675">testing</span><span class="op" id="7179682">.</span><span class="ident" id="7179683">T</span><span class="op" id="7179684">)</span>&nbsp;<span class="op" id="7179686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179689">db</span>&nbsp;<span class="op" id="7179692">:=</span>&nbsp;<span class="ident" id="7179695">newTestDB</span><span class="op" id="7179704">(</span><span class="ident" id="7179705">t</span><span class="op" id="7179706">,</span>&nbsp;<span class="string" id="7179708">&#34;people&#34;</span><span class="op" id="7179716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179719">defer</span>&nbsp;<span class="ident" id="7179725">closeDB</span><span class="op" id="7179732">(</span><span class="ident" id="7179733">t</span><span class="op" id="7179734">,</span>&nbsp;<span class="ident" id="7179736">db</span><span class="op" id="7179738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179741">prepares0</span>&nbsp;<span class="op" id="7179751">:=</span>&nbsp;<span class="ident" id="7179754">numPrepares</span><span class="op" id="7179765">(</span><span class="ident" id="7179766">t</span><span class="op" id="7179767">,</span>&nbsp;<span class="ident" id="7179769">db</span><span class="op" id="7179771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179774">rows</span><span class="op" id="7179778">,</span>&nbsp;<span class="ident" id="7179780">err</span>&nbsp;<span class="op" id="7179784">:=</span>&nbsp;<span class="ident" id="7179787">db</span><span class="op" id="7179789">.</span><span class="ident" id="7179790">Query</span><span class="op" id="7179795">(</span><span class="string" id="7179796">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7179821">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179824">if</span>&nbsp;<span class="ident" id="7179827">err</span>&nbsp;<span class="op" id="7179831">!=</span>&nbsp;<span class="builtintype" id="7179834">nil</span>&nbsp;<span class="op" id="7179838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179842">t</span><span class="op" id="7179843">.</span><span class="ident" id="7179844">Fatalf</span><span class="op" id="7179850">(</span><span class="string" id="7179851">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7179862">,</span>&nbsp;<span class="ident" id="7179864">err</span><span class="op" id="7179867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179873">type</span>&nbsp;<span class="ident" id="7179878">row</span>&nbsp;<span class="keyword" id="7179882">struct</span>&nbsp;<span class="op" id="7179889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179893">age</span>&nbsp;&nbsp;<span class="builtintype" id="7179898">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179904">name</span>&nbsp;<span class="builtintype" id="7179909">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7179917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179920">got</span>&nbsp;<span class="op" id="7179924">:=</span>&nbsp;<span class="op" id="7179927">[</span><span class="op" id="7179928">]</span><span class="ident" id="7179929">row</span><span class="op" id="7179932">{</span><span class="op" id="7179933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179936">for</span>&nbsp;<span class="ident" id="7179940">rows</span><span class="op" id="7179944">.</span><span class="ident" id="7179945">Next</span><span class="op" id="7179949">(</span><span class="op" id="7179950">)</span>&nbsp;<span class="op" id="7179952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7179956">var</span>&nbsp;<span class="ident" id="7179960">r</span>&nbsp;<span class="ident" id="7179962">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7179968">err</span>&nbsp;<span class="op" id="7179972">=</span>&nbsp;<span class="ident" id="7179974">rows</span><span class="op" id="7179978">.</span><span class="ident" id="7179979">Scan</span><span class="op" id="7179983">(</span><span class="op" id="7179984">&amp;</span><span class="ident" id="7179985">r</span><span class="op" id="7179986">.</span><span class="ident" id="7179987">age</span><span class="op" id="7179990">,</span>&nbsp;<span class="op" id="7179992">&amp;</span><span class="ident" id="7179993">r</span><span class="op" id="7179994">.</span><span class="ident" id="7179995">name</span><span class="op" id="7179999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180003">if</span>&nbsp;<span class="ident" id="7180006">err</span>&nbsp;<span class="op" id="7180010">!=</span>&nbsp;<span class="builtintype" id="7180013">nil</span>&nbsp;<span class="op" id="7180017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180022">t</span><span class="op" id="7180023">.</span><span class="ident" id="7180024">Fatalf</span><span class="op" id="7180030">(</span><span class="string" id="7180031">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7180041">,</span>&nbsp;<span class="ident" id="7180043">err</span><span class="op" id="7180046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180054">got</span>&nbsp;<span class="op" id="7180058">=</span>&nbsp;<span class="builtinfunc" id="7180060">append</span><span class="op" id="7180066">(</span><span class="ident" id="7180067">got</span><span class="op" id="7180070">,</span>&nbsp;<span class="ident" id="7180072">r</span><span class="op" id="7180073">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180079">err</span>&nbsp;<span class="op" id="7180083">=</span>&nbsp;<span class="ident" id="7180085">rows</span><span class="op" id="7180089">.</span><span class="ident" id="7180090">Err</span><span class="op" id="7180093">(</span><span class="op" id="7180094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180097">if</span>&nbsp;<span class="ident" id="7180100">err</span>&nbsp;<span class="op" id="7180104">!=</span>&nbsp;<span class="builtintype" id="7180107">nil</span>&nbsp;<span class="op" id="7180111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180115">t</span><span class="op" id="7180116">.</span><span class="ident" id="7180117">Fatalf</span><span class="op" id="7180123">(</span><span class="string" id="7180124">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="7180133">,</span>&nbsp;<span class="ident" id="7180135">err</span><span class="op" id="7180138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180141">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180144">want</span>&nbsp;<span class="op" id="7180149">:=</span>&nbsp;<span class="op" id="7180152">[</span><span class="op" id="7180153">]</span><span class="ident" id="7180154">row</span><span class="op" id="7180157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180161">{</span><span class="ident" id="7180162">age</span><span class="op" id="7180165">:</span>&nbsp;<span class="num" id="7180167">1</span><span class="op" id="7180168">,</span>&nbsp;<span class="ident" id="7180170">name</span><span class="op" id="7180174">:</span>&nbsp;<span class="string" id="7180176">&#34;Alice&#34;</span><span class="op" id="7180183">}</span><span class="op" id="7180184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180188">{</span><span class="ident" id="7180189">age</span><span class="op" id="7180192">:</span>&nbsp;<span class="num" id="7180194">2</span><span class="op" id="7180195">,</span>&nbsp;<span class="ident" id="7180197">name</span><span class="op" id="7180201">:</span>&nbsp;<span class="string" id="7180203">&#34;Bob&#34;</span><span class="op" id="7180208">}</span><span class="op" id="7180209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180213">{</span><span class="ident" id="7180214">age</span><span class="op" id="7180217">:</span>&nbsp;<span class="num" id="7180219">3</span><span class="op" id="7180220">,</span>&nbsp;<span class="ident" id="7180222">name</span><span class="op" id="7180226">:</span>&nbsp;<span class="string" id="7180228">&#34;Chris&#34;</span><span class="op" id="7180235">}</span><span class="op" id="7180236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180239">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180242">if</span>&nbsp;<span class="op" id="7180245">!</span><span class="ident" id="7180246">reflect</span><span class="op" id="7180253">.</span><span class="ident" id="7180254">DeepEqual</span><span class="op" id="7180263">(</span><span class="ident" id="7180264">got</span><span class="op" id="7180267">,</span>&nbsp;<span class="ident" id="7180269">want</span><span class="op" id="7180273">)</span>&nbsp;<span class="op" id="7180275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180279">t</span><span class="op" id="7180280">.</span><span class="ident" id="7180281">Errorf</span><span class="op" id="7180287">(</span><span class="string" id="7180288">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7180321">,</span>&nbsp;<span class="ident" id="7180323">got</span><span class="op" id="7180326">,</span>&nbsp;<span class="ident" id="7180328">want</span><span class="op" id="7180332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7180339">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7180402">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180439">if</span>&nbsp;<span class="ident" id="7180442">n</span>&nbsp;<span class="op" id="7180444">:=</span>&nbsp;<span class="ident" id="7180447">db</span><span class="op" id="7180449">.</span><span class="ident" id="7180450">numFreeConns</span><span class="op" id="7180462">(</span><span class="op" id="7180463">)</span><span class="op" id="7180464">;</span>&nbsp;<span class="ident" id="7180466">n</span>&nbsp;<span class="op" id="7180468">!=</span>&nbsp;<span class="num" id="7180471">1</span>&nbsp;<span class="op" id="7180473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180477">t</span><span class="op" id="7180478">.</span><span class="ident" id="7180479">Fatalf</span><span class="op" id="7180485">(</span><span class="string" id="7180486">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7180535">,</span>&nbsp;<span class="ident" id="7180537">n</span><span class="op" id="7180538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180544">if</span>&nbsp;<span class="ident" id="7180547">prepares</span>&nbsp;<span class="op" id="7180556">:=</span>&nbsp;<span class="ident" id="7180559">numPrepares</span><span class="op" id="7180570">(</span><span class="ident" id="7180571">t</span><span class="op" id="7180572">,</span>&nbsp;<span class="ident" id="7180574">db</span><span class="op" id="7180576">)</span>&nbsp;<span class="op" id="7180578">-</span>&nbsp;<span class="ident" id="7180580">prepares0</span><span class="op" id="7180589">;</span>&nbsp;<span class="ident" id="7180591">prepares</span>&nbsp;<span class="op" id="7180600">!=</span>&nbsp;<span class="num" id="7180603">1</span>&nbsp;<span class="op" id="7180605">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180609">t</span><span class="op" id="7180610">.</span><span class="ident" id="7180611">Errorf</span><span class="op" id="7180617">(</span><span class="string" id="7180618">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7180658">,</span>&nbsp;<span class="ident" id="7180660">prepares</span><span class="op" id="7180668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180671">}</span><br>
<span class="lineno"></span><span class="op" id="7180673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7180676">func</span>&nbsp;<span class="ident" id="7180681">TestByteOwnership</span><span class="op" id="7180698">(</span><span class="ident" id="7180699">t</span>&nbsp;<span class="op" id="7180701">*</span><span class="ident" id="7180702">testing</span><span class="op" id="7180709">.</span><span class="ident" id="7180710">T</span><span class="op" id="7180711">)</span>&nbsp;<span class="op" id="7180713">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180716">db</span>&nbsp;<span class="op" id="7180719">:=</span>&nbsp;<span class="ident" id="7180722">newTestDB</span><span class="op" id="7180731">(</span><span class="ident" id="7180732">t</span><span class="op" id="7180733">,</span>&nbsp;<span class="string" id="7180735">&#34;people&#34;</span><span class="op" id="7180743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180746">defer</span>&nbsp;<span class="ident" id="7180752">closeDB</span><span class="op" id="7180759">(</span><span class="ident" id="7180760">t</span><span class="op" id="7180761">,</span>&nbsp;<span class="ident" id="7180763">db</span><span class="op" id="7180765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180768">rows</span><span class="op" id="7180772">,</span>&nbsp;<span class="ident" id="7180774">err</span>&nbsp;<span class="op" id="7180778">:=</span>&nbsp;<span class="ident" id="7180781">db</span><span class="op" id="7180783">.</span><span class="ident" id="7180784">Query</span><span class="op" id="7180789">(</span><span class="string" id="7180790">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="7180817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180820">if</span>&nbsp;<span class="ident" id="7180823">err</span>&nbsp;<span class="op" id="7180827">!=</span>&nbsp;<span class="builtintype" id="7180830">nil</span>&nbsp;<span class="op" id="7180834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180838">t</span><span class="op" id="7180839">.</span><span class="ident" id="7180840">Fatalf</span><span class="op" id="7180846">(</span><span class="string" id="7180847">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7180858">,</span>&nbsp;<span class="ident" id="7180860">err</span><span class="op" id="7180863">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180869">type</span>&nbsp;<span class="ident" id="7180874">row</span>&nbsp;<span class="keyword" id="7180878">struct</span>&nbsp;<span class="op" id="7180885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180889">name</span>&nbsp;&nbsp;<span class="op" id="7180895">[</span><span class="op" id="7180896">]</span><span class="builtintype" id="7180897">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180904">photo</span>&nbsp;<span class="ident" id="7180910">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7180920">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180923">got</span>&nbsp;<span class="op" id="7180927">:=</span>&nbsp;<span class="op" id="7180930">[</span><span class="op" id="7180931">]</span><span class="ident" id="7180932">row</span><span class="op" id="7180935">{</span><span class="op" id="7180936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180939">for</span>&nbsp;<span class="ident" id="7180943">rows</span><span class="op" id="7180947">.</span><span class="ident" id="7180948">Next</span><span class="op" id="7180952">(</span><span class="op" id="7180953">)</span>&nbsp;<span class="op" id="7180955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7180959">var</span>&nbsp;<span class="ident" id="7180963">r</span>&nbsp;<span class="ident" id="7180965">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7180971">err</span>&nbsp;<span class="op" id="7180975">=</span>&nbsp;<span class="ident" id="7180977">rows</span><span class="op" id="7180981">.</span><span class="ident" id="7180982">Scan</span><span class="op" id="7180986">(</span><span class="op" id="7180987">&amp;</span><span class="ident" id="7180988">r</span><span class="op" id="7180989">.</span><span class="ident" id="7180990">name</span><span class="op" id="7180994">,</span>&nbsp;<span class="op" id="7180996">&amp;</span><span class="ident" id="7180997">r</span><span class="op" id="7180998">.</span><span class="ident" id="7180999">photo</span><span class="op" id="7181004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181008">if</span>&nbsp;<span class="ident" id="7181011">err</span>&nbsp;<span class="op" id="7181015">!=</span>&nbsp;<span class="builtintype" id="7181018">nil</span>&nbsp;<span class="op" id="7181022">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181027">t</span><span class="op" id="7181028">.</span><span class="ident" id="7181029">Fatalf</span><span class="op" id="7181035">(</span><span class="string" id="7181036">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7181046">,</span>&nbsp;<span class="ident" id="7181048">err</span><span class="op" id="7181051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181059">got</span>&nbsp;<span class="op" id="7181063">=</span>&nbsp;<span class="builtinfunc" id="7181065">append</span><span class="op" id="7181071">(</span><span class="ident" id="7181072">got</span><span class="op" id="7181075">,</span>&nbsp;<span class="ident" id="7181077">r</span><span class="op" id="7181078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181084">corruptMemory</span>&nbsp;<span class="op" id="7181098">:=</span>&nbsp;<span class="op" id="7181101">[</span><span class="op" id="7181102">]</span><span class="builtintype" id="7181103">byte</span><span class="op" id="7181107">(</span><span class="string" id="7181108">&#34;\xffPHOTO&#34;</span><span class="op" id="7181119">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181122">want</span>&nbsp;<span class="op" id="7181127">:=</span>&nbsp;<span class="op" id="7181130">[</span><span class="op" id="7181131">]</span><span class="ident" id="7181132">row</span><span class="op" id="7181135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181139">{</span><span class="ident" id="7181140">name</span><span class="op" id="7181144">:</span>&nbsp;<span class="op" id="7181146">[</span><span class="op" id="7181147">]</span><span class="builtintype" id="7181148">byte</span><span class="op" id="7181152">(</span><span class="string" id="7181153">&#34;Alice&#34;</span><span class="op" id="7181160">)</span><span class="op" id="7181161">,</span>&nbsp;<span class="ident" id="7181163">photo</span><span class="op" id="7181168">:</span>&nbsp;<span class="ident" id="7181170">corruptMemory</span><span class="op" id="7181183">}</span><span class="op" id="7181184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181188">{</span><span class="ident" id="7181189">name</span><span class="op" id="7181193">:</span>&nbsp;<span class="op" id="7181195">[</span><span class="op" id="7181196">]</span><span class="builtintype" id="7181197">byte</span><span class="op" id="7181201">(</span><span class="string" id="7181202">&#34;Bob&#34;</span><span class="op" id="7181207">)</span><span class="op" id="7181208">,</span>&nbsp;<span class="ident" id="7181210">photo</span><span class="op" id="7181215">:</span>&nbsp;<span class="ident" id="7181217">corruptMemory</span><span class="op" id="7181230">}</span><span class="op" id="7181231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181235">{</span><span class="ident" id="7181236">name</span><span class="op" id="7181240">:</span>&nbsp;<span class="op" id="7181242">[</span><span class="op" id="7181243">]</span><span class="builtintype" id="7181244">byte</span><span class="op" id="7181248">(</span><span class="string" id="7181249">&#34;Chris&#34;</span><span class="op" id="7181256">)</span><span class="op" id="7181257">,</span>&nbsp;<span class="ident" id="7181259">photo</span><span class="op" id="7181264">:</span>&nbsp;<span class="ident" id="7181266">corruptMemory</span><span class="op" id="7181279">}</span><span class="op" id="7181280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181283">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181286">if</span>&nbsp;<span class="op" id="7181289">!</span><span class="ident" id="7181290">reflect</span><span class="op" id="7181297">.</span><span class="ident" id="7181298">DeepEqual</span><span class="op" id="7181307">(</span><span class="ident" id="7181308">got</span><span class="op" id="7181311">,</span>&nbsp;<span class="ident" id="7181313">want</span><span class="op" id="7181317">)</span>&nbsp;<span class="op" id="7181319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181323">t</span><span class="op" id="7181324">.</span><span class="ident" id="7181325">Errorf</span><span class="op" id="7181331">(</span><span class="string" id="7181332">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7181365">,</span>&nbsp;<span class="ident" id="7181367">got</span><span class="op" id="7181370">,</span>&nbsp;<span class="ident" id="7181372">want</span><span class="op" id="7181376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181383">var</span>&nbsp;<span class="ident" id="7181387">photo</span>&nbsp;<span class="ident" id="7181393">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181403">err</span>&nbsp;<span class="op" id="7181407">=</span>&nbsp;<span class="ident" id="7181409">db</span><span class="op" id="7181411">.</span><span class="ident" id="7181412">QueryRow</span><span class="op" id="7181420">(</span><span class="string" id="7181421">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7181449">,</span>&nbsp;<span class="string" id="7181451">&#34;Alice&#34;</span><span class="op" id="7181458">)</span><span class="op" id="7181459">.</span><span class="ident" id="7181460">Scan</span><span class="op" id="7181464">(</span><span class="op" id="7181465">&amp;</span><span class="ident" id="7181466">photo</span><span class="op" id="7181471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181474">if</span>&nbsp;<span class="ident" id="7181477">err</span>&nbsp;<span class="op" id="7181481">==</span>&nbsp;<span class="builtintype" id="7181484">nil</span>&nbsp;<span class="op" id="7181488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181492">t</span><span class="op" id="7181493">.</span><span class="ident" id="7181494">Error</span><span class="op" id="7181499">(</span><span class="string" id="7181500">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="7181549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181552">}</span><br>
<span class="lineno"></span><span class="op" id="7181554">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="7181557">func</span>&nbsp;<span class="ident" id="7181562">TestRowsColumns</span><span class="op" id="7181577">(</span><span class="ident" id="7181578">t</span>&nbsp;<span class="op" id="7181580">*</span><span class="ident" id="7181581">testing</span><span class="op" id="7181588">.</span><span class="ident" id="7181589">T</span><span class="op" id="7181590">)</span>&nbsp;<span class="op" id="7181592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181595">db</span>&nbsp;<span class="op" id="7181598">:=</span>&nbsp;<span class="ident" id="7181601">newTestDB</span><span class="op" id="7181610">(</span><span class="ident" id="7181611">t</span><span class="op" id="7181612">,</span>&nbsp;<span class="string" id="7181614">&#34;people&#34;</span><span class="op" id="7181622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181625">defer</span>&nbsp;<span class="ident" id="7181631">closeDB</span><span class="op" id="7181638">(</span><span class="ident" id="7181639">t</span><span class="op" id="7181640">,</span>&nbsp;<span class="ident" id="7181642">db</span><span class="op" id="7181644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181647">rows</span><span class="op" id="7181651">,</span>&nbsp;<span class="ident" id="7181653">err</span>&nbsp;<span class="op" id="7181657">:=</span>&nbsp;<span class="ident" id="7181660">db</span><span class="op" id="7181662">.</span><span class="ident" id="7181663">Query</span><span class="op" id="7181668">(</span><span class="string" id="7181669">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7181694">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181697">if</span>&nbsp;<span class="ident" id="7181700">err</span>&nbsp;<span class="op" id="7181704">!=</span>&nbsp;<span class="builtintype" id="7181707">nil</span>&nbsp;<span class="op" id="7181711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181715">t</span><span class="op" id="7181716">.</span><span class="ident" id="7181717">Fatalf</span><span class="op" id="7181723">(</span><span class="string" id="7181724">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7181735">,</span>&nbsp;<span class="ident" id="7181737">err</span><span class="op" id="7181740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181746">cols</span><span class="op" id="7181750">,</span>&nbsp;<span class="ident" id="7181752">err</span>&nbsp;<span class="op" id="7181756">:=</span>&nbsp;<span class="ident" id="7181759">rows</span><span class="op" id="7181763">.</span><span class="ident" id="7181764">Columns</span><span class="op" id="7181771">(</span><span class="op" id="7181772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181775">if</span>&nbsp;<span class="ident" id="7181778">err</span>&nbsp;<span class="op" id="7181782">!=</span>&nbsp;<span class="builtintype" id="7181785">nil</span>&nbsp;<span class="op" id="7181789">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181793">t</span><span class="op" id="7181794">.</span><span class="ident" id="7181795">Fatalf</span><span class="op" id="7181801">(</span><span class="string" id="7181802">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="7181815">,</span>&nbsp;<span class="ident" id="7181817">err</span><span class="op" id="7181820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181826">want</span>&nbsp;<span class="op" id="7181831">:=</span>&nbsp;<span class="op" id="7181834">[</span><span class="op" id="7181835">]</span><span class="builtintype" id="7181836">string</span><span class="op" id="7181842">{</span><span class="string" id="7181843">&#34;age&#34;</span><span class="op" id="7181848">,</span>&nbsp;<span class="string" id="7181850">&#34;name&#34;</span><span class="op" id="7181856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181859">if</span>&nbsp;<span class="op" id="7181862">!</span><span class="ident" id="7181863">reflect</span><span class="op" id="7181870">.</span><span class="ident" id="7181871">DeepEqual</span><span class="op" id="7181880">(</span><span class="ident" id="7181881">cols</span><span class="op" id="7181885">,</span>&nbsp;<span class="ident" id="7181887">want</span><span class="op" id="7181891">)</span>&nbsp;<span class="op" id="7181893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181897">t</span><span class="op" id="7181898">.</span><span class="ident" id="7181899">Errorf</span><span class="op" id="7181905">(</span><span class="string" id="7181906">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7181925">,</span>&nbsp;<span class="ident" id="7181927">cols</span><span class="op" id="7181931">,</span>&nbsp;<span class="ident" id="7181933">want</span><span class="op" id="7181937">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7181940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7181943">if</span>&nbsp;<span class="ident" id="7181946">err</span>&nbsp;<span class="op" id="7181950">:=</span>&nbsp;<span class="ident" id="7181953">rows</span><span class="op" id="7181957">.</span><span class="ident" id="7181958">Close</span><span class="op" id="7181963">(</span><span class="op" id="7181964">)</span><span class="op" id="7181965">;</span>&nbsp;<span class="ident" id="7181967">err</span>&nbsp;<span class="op" id="7181971">!=</span>&nbsp;<span class="builtintype" id="7181974">nil</span>&nbsp;<span class="op" id="7181978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7181982">t</span><span class="op" id="7181983">.</span><span class="ident" id="7181984">Errorf</span><span class="op" id="7181990">(</span><span class="string" id="7181991">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="7182015">,</span>&nbsp;<span class="ident" id="7182017">err</span><span class="op" id="7182020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7182023">}</span><br>
<span class="lineno"></span><span class="op" id="7182025">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7182028">func</span>&nbsp;<span class="ident" id="7182033">TestQueryRow</span><span class="op" id="7182045">(</span><span class="ident" id="7182046">t</span>&nbsp;<span class="op" id="7182048">*</span><span class="ident" id="7182049">testing</span><span class="op" id="7182056">.</span><span class="ident" id="7182057">T</span><span class="op" id="7182058">)</span>&nbsp;<span class="op" id="7182060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182063">db</span>&nbsp;<span class="op" id="7182066">:=</span>&nbsp;<span class="ident" id="7182069">newTestDB</span><span class="op" id="7182078">(</span><span class="ident" id="7182079">t</span><span class="op" id="7182080">,</span>&nbsp;<span class="string" id="7182082">&#34;people&#34;</span><span class="op" id="7182090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182093">defer</span>&nbsp;<span class="ident" id="7182099">closeDB</span><span class="op" id="7182106">(</span><span class="ident" id="7182107">t</span><span class="op" id="7182108">,</span>&nbsp;<span class="ident" id="7182110">db</span><span class="op" id="7182112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182115">var</span>&nbsp;<span class="ident" id="7182119">name</span>&nbsp;<span class="builtintype" id="7182124">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182132">var</span>&nbsp;<span class="ident" id="7182136">age</span>&nbsp;<span class="builtintype" id="7182140">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182145">var</span>&nbsp;<span class="ident" id="7182149">birthday</span>&nbsp;<span class="ident" id="7182158">time</span><span class="op" id="7182162">.</span><span class="ident" id="7182163">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182170">err</span>&nbsp;<span class="op" id="7182174">:=</span>&nbsp;<span class="ident" id="7182177">db</span><span class="op" id="7182179">.</span><span class="ident" id="7182180">QueryRow</span><span class="op" id="7182188">(</span><span class="string" id="7182189">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7182219">,</span>&nbsp;<span class="num" id="7182221">3</span><span class="op" id="7182222">)</span><span class="op" id="7182223">.</span><span class="ident" id="7182224">Scan</span><span class="op" id="7182228">(</span><span class="op" id="7182229">&amp;</span><span class="ident" id="7182230">age</span><span class="op" id="7182233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182236">if</span>&nbsp;<span class="ident" id="7182239">err</span>&nbsp;<span class="op" id="7182243">==</span>&nbsp;<span class="builtintype" id="7182246">nil</span>&nbsp;<span class="op" id="7182250">||</span>&nbsp;<span class="op" id="7182253">!</span><span class="ident" id="7182254">strings</span><span class="op" id="7182261">.</span><span class="ident" id="7182262">Contains</span><span class="op" id="7182270">(</span><span class="ident" id="7182271">err</span><span class="op" id="7182274">.</span><span class="ident" id="7182275">Error</span><span class="op" id="7182280">(</span><span class="op" id="7182281">)</span><span class="op" id="7182282">,</span>&nbsp;<span class="string" id="7182284">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="7182318">)</span>&nbsp;<span class="op" id="7182320">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182324">t</span><span class="op" id="7182325">.</span><span class="ident" id="7182326">Errorf</span><span class="op" id="7182332">(</span><span class="string" id="7182333">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="7182398">,</span>&nbsp;<span class="ident" id="7182400">err</span><span class="op" id="7182403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7182406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182410">err</span>&nbsp;<span class="op" id="7182414">=</span>&nbsp;<span class="ident" id="7182416">db</span><span class="op" id="7182418">.</span><span class="ident" id="7182419">QueryRow</span><span class="op" id="7182427">(</span><span class="string" id="7182428">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="7182455">,</span>&nbsp;<span class="num" id="7182457">3</span><span class="op" id="7182458">)</span><span class="op" id="7182459">.</span><span class="ident" id="7182460">Scan</span><span class="op" id="7182464">(</span><span class="op" id="7182465">&amp;</span><span class="ident" id="7182466">birthday</span><span class="op" id="7182474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182477">if</span>&nbsp;<span class="ident" id="7182480">err</span>&nbsp;<span class="op" id="7182484">!=</span>&nbsp;<span class="builtintype" id="7182487">nil</span>&nbsp;<span class="op" id="7182491">||</span>&nbsp;<span class="op" id="7182494">!</span><span class="ident" id="7182495">birthday</span><span class="op" id="7182503">.</span><span class="ident" id="7182504">Equal</span><span class="op" id="7182509">(</span><span class="ident" id="7182510">chrisBirthday</span><span class="op" id="7182523">)</span>&nbsp;<span class="op" id="7182525">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182529">t</span><span class="op" id="7182530">.</span><span class="ident" id="7182531">Errorf</span><span class="op" id="7182537">(</span><span class="string" id="7182538">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7182578">,</span>&nbsp;<span class="ident" id="7182580">birthday</span><span class="op" id="7182588">,</span>&nbsp;<span class="ident" id="7182590">err</span><span class="op" id="7182593">,</span>&nbsp;<span class="ident" id="7182595">chrisBirthday</span><span class="op" id="7182608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7182611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182615">err</span>&nbsp;<span class="op" id="7182619">=</span>&nbsp;<span class="ident" id="7182621">db</span><span class="op" id="7182623">.</span><span class="ident" id="7182624">QueryRow</span><span class="op" id="7182632">(</span><span class="string" id="7182633">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7182663">,</span>&nbsp;<span class="num" id="7182665">2</span><span class="op" id="7182666">)</span><span class="op" id="7182667">.</span><span class="ident" id="7182668">Scan</span><span class="op" id="7182672">(</span><span class="op" id="7182673">&amp;</span><span class="ident" id="7182674">age</span><span class="op" id="7182677">,</span>&nbsp;<span class="op" id="7182679">&amp;</span><span class="ident" id="7182680">name</span><span class="op" id="7182684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182687">if</span>&nbsp;<span class="ident" id="7182690">err</span>&nbsp;<span class="op" id="7182694">!=</span>&nbsp;<span class="builtintype" id="7182697">nil</span>&nbsp;<span class="op" id="7182701">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182705">t</span><span class="op" id="7182706">.</span><span class="ident" id="7182707">Fatalf</span><span class="op" id="7182713">(</span><span class="string" id="7182714">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7182737">,</span>&nbsp;<span class="ident" id="7182739">err</span><span class="op" id="7182742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7182745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182748">if</span>&nbsp;<span class="ident" id="7182751">name</span>&nbsp;<span class="op" id="7182756">!=</span>&nbsp;<span class="string" id="7182759">&#34;Bob&#34;</span>&nbsp;<span class="op" id="7182765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182769">t</span><span class="op" id="7182770">.</span><span class="ident" id="7182771">Errorf</span><span class="op" id="7182777">(</span><span class="string" id="7182778">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7182805">,</span>&nbsp;<span class="ident" id="7182807">name</span><span class="op" id="7182811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7182814">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182817">if</span>&nbsp;<span class="ident" id="7182820">age</span>&nbsp;<span class="op" id="7182824">!=</span>&nbsp;<span class="num" id="7182827">2</span>&nbsp;<span class="op" id="7182829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182833">t</span><span class="op" id="7182834">.</span><span class="ident" id="7182835">Errorf</span><span class="op" id="7182841">(</span><span class="string" id="7182842">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7182866">,</span>&nbsp;<span class="ident" id="7182868">age</span><span class="op" id="7182871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7182874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182878">err</span>&nbsp;<span class="op" id="7182882">=</span>&nbsp;<span class="ident" id="7182884">db</span><span class="op" id="7182886">.</span><span class="ident" id="7182887">QueryRow</span><span class="op" id="7182895">(</span><span class="string" id="7182896">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="7182927">,</span>&nbsp;<span class="string" id="7182929">&#34;Alice&#34;</span><span class="op" id="7182936">)</span><span class="op" id="7182937">.</span><span class="ident" id="7182938">Scan</span><span class="op" id="7182942">(</span><span class="op" id="7182943">&amp;</span><span class="ident" id="7182944">age</span><span class="op" id="7182947">,</span>&nbsp;<span class="op" id="7182949">&amp;</span><span class="ident" id="7182950">name</span><span class="op" id="7182954">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7182957">if</span>&nbsp;<span class="ident" id="7182960">err</span>&nbsp;<span class="op" id="7182964">!=</span>&nbsp;<span class="builtintype" id="7182967">nil</span>&nbsp;<span class="op" id="7182971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7182975">t</span><span class="op" id="7182976">.</span><span class="ident" id="7182977">Fatalf</span><span class="op" id="7182983">(</span><span class="string" id="7182984">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7183008">,</span>&nbsp;<span class="ident" id="7183010">err</span><span class="op" id="7183013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183019">if</span>&nbsp;<span class="ident" id="7183022">name</span>&nbsp;<span class="op" id="7183027">!=</span>&nbsp;<span class="string" id="7183030">&#34;Alice&#34;</span>&nbsp;<span class="op" id="7183038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183042">t</span><span class="op" id="7183043">.</span><span class="ident" id="7183044">Errorf</span><span class="op" id="7183050">(</span><span class="string" id="7183051">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7183080">,</span>&nbsp;<span class="ident" id="7183082">name</span><span class="op" id="7183086">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183092">if</span>&nbsp;<span class="ident" id="7183095">age</span>&nbsp;<span class="op" id="7183099">!=</span>&nbsp;<span class="num" id="7183102">1</span>&nbsp;<span class="op" id="7183104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183108">t</span><span class="op" id="7183109">.</span><span class="ident" id="7183110">Errorf</span><span class="op" id="7183116">(</span><span class="string" id="7183117">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7183141">,</span>&nbsp;<span class="ident" id="7183143">age</span><span class="op" id="7183146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183153">var</span>&nbsp;<span class="ident" id="7183157">photo</span>&nbsp;<span class="op" id="7183163">[</span><span class="op" id="7183164">]</span><span class="builtintype" id="7183165">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183171">err</span>&nbsp;<span class="op" id="7183175">=</span>&nbsp;<span class="ident" id="7183177">db</span><span class="op" id="7183179">.</span><span class="ident" id="7183180">QueryRow</span><span class="op" id="7183188">(</span><span class="string" id="7183189">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7183217">,</span>&nbsp;<span class="string" id="7183219">&#34;Alice&#34;</span><span class="op" id="7183226">)</span><span class="op" id="7183227">.</span><span class="ident" id="7183228">Scan</span><span class="op" id="7183232">(</span><span class="op" id="7183233">&amp;</span><span class="ident" id="7183234">photo</span><span class="op" id="7183239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183242">if</span>&nbsp;<span class="ident" id="7183245">err</span>&nbsp;<span class="op" id="7183249">!=</span>&nbsp;<span class="builtintype" id="7183252">nil</span>&nbsp;<span class="op" id="7183256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183260">t</span><span class="op" id="7183261">.</span><span class="ident" id="7183262">Fatalf</span><span class="op" id="7183268">(</span><span class="string" id="7183269">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7183294">,</span>&nbsp;<span class="ident" id="7183296">err</span><span class="op" id="7183299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183302">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183305">want</span>&nbsp;<span class="op" id="7183310">:=</span>&nbsp;<span class="op" id="7183313">[</span><span class="op" id="7183314">]</span><span class="builtintype" id="7183315">byte</span><span class="op" id="7183319">(</span><span class="string" id="7183320">&#34;APHOTO&#34;</span><span class="op" id="7183328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183331">if</span>&nbsp;<span class="op" id="7183334">!</span><span class="ident" id="7183335">reflect</span><span class="op" id="7183342">.</span><span class="ident" id="7183343">DeepEqual</span><span class="op" id="7183352">(</span><span class="ident" id="7183353">photo</span><span class="op" id="7183358">,</span>&nbsp;<span class="ident" id="7183360">want</span><span class="op" id="7183364">)</span>&nbsp;<span class="op" id="7183366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183370">t</span><span class="op" id="7183371">.</span><span class="ident" id="7183372">Errorf</span><span class="op" id="7183378">(</span><span class="string" id="7183379">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7183400">,</span>&nbsp;<span class="ident" id="7183402">photo</span><span class="op" id="7183407">,</span>&nbsp;<span class="ident" id="7183409">want</span><span class="op" id="7183413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183416">}</span><br>
<span class="lineno"></span><span class="op" id="7183418">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7183421">func</span>&nbsp;<span class="ident" id="7183426">TestStatementErrorAfterClose</span><span class="op" id="7183454">(</span><span class="ident" id="7183455">t</span>&nbsp;<span class="op" id="7183457">*</span><span class="ident" id="7183458">testing</span><span class="op" id="7183465">.</span><span class="ident" id="7183466">T</span><span class="op" id="7183467">)</span>&nbsp;<span class="op" id="7183469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183472">db</span>&nbsp;<span class="op" id="7183475">:=</span>&nbsp;<span class="ident" id="7183478">newTestDB</span><span class="op" id="7183487">(</span><span class="ident" id="7183488">t</span><span class="op" id="7183489">,</span>&nbsp;<span class="string" id="7183491">&#34;people&#34;</span><span class="op" id="7183499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183502">defer</span>&nbsp;<span class="ident" id="7183508">closeDB</span><span class="op" id="7183515">(</span><span class="ident" id="7183516">t</span><span class="op" id="7183517">,</span>&nbsp;<span class="ident" id="7183519">db</span><span class="op" id="7183521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183524">stmt</span><span class="op" id="7183528">,</span>&nbsp;<span class="ident" id="7183530">err</span>&nbsp;<span class="op" id="7183534">:=</span>&nbsp;<span class="ident" id="7183537">db</span><span class="op" id="7183539">.</span><span class="ident" id="7183540">Prepare</span><span class="op" id="7183547">(</span><span class="string" id="7183548">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7183574">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183577">if</span>&nbsp;<span class="ident" id="7183580">err</span>&nbsp;<span class="op" id="7183584">!=</span>&nbsp;<span class="builtintype" id="7183587">nil</span>&nbsp;<span class="op" id="7183591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183595">t</span><span class="op" id="7183596">.</span><span class="ident" id="7183597">Fatalf</span><span class="op" id="7183603">(</span><span class="string" id="7183604">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7183617">,</span>&nbsp;<span class="ident" id="7183619">err</span><span class="op" id="7183622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183628">err</span>&nbsp;<span class="op" id="7183632">=</span>&nbsp;<span class="ident" id="7183634">stmt</span><span class="op" id="7183638">.</span><span class="ident" id="7183639">Close</span><span class="op" id="7183644">(</span><span class="op" id="7183645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183648">if</span>&nbsp;<span class="ident" id="7183651">err</span>&nbsp;<span class="op" id="7183655">!=</span>&nbsp;<span class="builtintype" id="7183658">nil</span>&nbsp;<span class="op" id="7183662">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183666">t</span><span class="op" id="7183667">.</span><span class="ident" id="7183668">Fatalf</span><span class="op" id="7183674">(</span><span class="string" id="7183675">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7183686">,</span>&nbsp;<span class="ident" id="7183688">err</span><span class="op" id="7183691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183697">var</span>&nbsp;<span class="ident" id="7183701">name</span>&nbsp;<span class="builtintype" id="7183706">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183714">err</span>&nbsp;<span class="op" id="7183718">=</span>&nbsp;<span class="ident" id="7183720">stmt</span><span class="op" id="7183724">.</span><span class="ident" id="7183725">QueryRow</span><span class="op" id="7183733">(</span><span class="string" id="7183734">&#34;foo&#34;</span><span class="op" id="7183739">)</span><span class="op" id="7183740">.</span><span class="ident" id="7183741">Scan</span><span class="op" id="7183745">(</span><span class="op" id="7183746">&amp;</span><span class="ident" id="7183747">name</span><span class="op" id="7183751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183754">if</span>&nbsp;<span class="ident" id="7183757">err</span>&nbsp;<span class="op" id="7183761">==</span>&nbsp;<span class="builtintype" id="7183764">nil</span>&nbsp;<span class="op" id="7183768">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183772">t</span><span class="op" id="7183773">.</span><span class="ident" id="7183774">Errorf</span><span class="op" id="7183780">(</span><span class="string" id="7183781">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="7183833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7183836">}</span><br>
<span class="lineno"></span><span class="op" id="7183838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7183841">func</span>&nbsp;<span class="ident" id="7183846">TestStatementQueryRow</span><span class="op" id="7183867">(</span><span class="ident" id="7183868">t</span>&nbsp;<span class="op" id="7183870">*</span><span class="ident" id="7183871">testing</span><span class="op" id="7183878">.</span><span class="ident" id="7183879">T</span><span class="op" id="7183880">)</span>&nbsp;<span class="op" id="7183882">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183885">db</span>&nbsp;<span class="op" id="7183888">:=</span>&nbsp;<span class="ident" id="7183891">newTestDB</span><span class="op" id="7183900">(</span><span class="ident" id="7183901">t</span><span class="op" id="7183902">,</span>&nbsp;<span class="string" id="7183904">&#34;people&#34;</span><span class="op" id="7183912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183915">defer</span>&nbsp;<span class="ident" id="7183921">closeDB</span><span class="op" id="7183928">(</span><span class="ident" id="7183929">t</span><span class="op" id="7183930">,</span>&nbsp;<span class="ident" id="7183932">db</span><span class="op" id="7183934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7183937">stmt</span><span class="op" id="7183941">,</span>&nbsp;<span class="ident" id="7183943">err</span>&nbsp;<span class="op" id="7183947">:=</span>&nbsp;<span class="ident" id="7183950">db</span><span class="op" id="7183952">.</span><span class="ident" id="7183953">Prepare</span><span class="op" id="7183960">(</span><span class="string" id="7183961">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7183987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7183990">if</span>&nbsp;<span class="ident" id="7183993">err</span>&nbsp;<span class="op" id="7183997">!=</span>&nbsp;<span class="builtintype" id="7184000">nil</span>&nbsp;<span class="op" id="7184004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184008">t</span><span class="op" id="7184009">.</span><span class="ident" id="7184010">Fatalf</span><span class="op" id="7184016">(</span><span class="string" id="7184017">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7184030">,</span>&nbsp;<span class="ident" id="7184032">err</span><span class="op" id="7184035">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184041">defer</span>&nbsp;<span class="ident" id="7184047">stmt</span><span class="op" id="7184051">.</span><span class="ident" id="7184052">Close</span><span class="op" id="7184057">(</span><span class="op" id="7184058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184061">var</span>&nbsp;<span class="ident" id="7184065">age</span>&nbsp;<span class="builtintype" id="7184069">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184074">for</span>&nbsp;<span class="ident" id="7184078">n</span><span class="op" id="7184079">,</span>&nbsp;<span class="ident" id="7184081">tt</span>&nbsp;<span class="op" id="7184084">:=</span>&nbsp;<span class="keyword" id="7184087">range</span>&nbsp;<span class="op" id="7184093">[</span><span class="op" id="7184094">]</span><span class="keyword" id="7184095">struct</span>&nbsp;<span class="op" id="7184102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184106">name</span>&nbsp;<span class="builtintype" id="7184111">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184120">want</span>&nbsp;<span class="builtintype" id="7184125">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184130">}</span><span class="op" id="7184131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184135">{</span><span class="string" id="7184136">&#34;Alice&#34;</span><span class="op" id="7184143">,</span>&nbsp;<span class="num" id="7184145">1</span><span class="op" id="7184146">}</span><span class="op" id="7184147">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184151">{</span><span class="string" id="7184152">&#34;Bob&#34;</span><span class="op" id="7184157">,</span>&nbsp;<span class="num" id="7184159">2</span><span class="op" id="7184160">}</span><span class="op" id="7184161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184165">{</span><span class="string" id="7184166">&#34;Chris&#34;</span><span class="op" id="7184173">,</span>&nbsp;<span class="num" id="7184175">3</span><span class="op" id="7184176">}</span><span class="op" id="7184177">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184180">}</span>&nbsp;<span class="op" id="7184182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184186">if</span>&nbsp;<span class="ident" id="7184189">err</span>&nbsp;<span class="op" id="7184193">:=</span>&nbsp;<span class="ident" id="7184196">stmt</span><span class="op" id="7184200">.</span><span class="ident" id="7184201">QueryRow</span><span class="op" id="7184209">(</span><span class="ident" id="7184210">tt</span><span class="op" id="7184212">.</span><span class="ident" id="7184213">name</span><span class="op" id="7184217">)</span><span class="op" id="7184218">.</span><span class="ident" id="7184219">Scan</span><span class="op" id="7184223">(</span><span class="op" id="7184224">&amp;</span><span class="ident" id="7184225">age</span><span class="op" id="7184228">)</span><span class="op" id="7184229">;</span>&nbsp;<span class="ident" id="7184231">err</span>&nbsp;<span class="op" id="7184235">!=</span>&nbsp;<span class="builtintype" id="7184238">nil</span>&nbsp;<span class="op" id="7184242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184247">t</span><span class="op" id="7184248">.</span><span class="ident" id="7184249">Errorf</span><span class="op" id="7184255">(</span><span class="string" id="7184256">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="7184286">,</span>&nbsp;<span class="ident" id="7184288">n</span><span class="op" id="7184289">,</span>&nbsp;<span class="ident" id="7184291">tt</span><span class="op" id="7184293">.</span><span class="ident" id="7184294">name</span><span class="op" id="7184298">,</span>&nbsp;<span class="ident" id="7184300">err</span><span class="op" id="7184303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184307">}</span>&nbsp;<span class="keyword" id="7184309">else</span>&nbsp;<span class="keyword" id="7184314">if</span>&nbsp;<span class="ident" id="7184317">age</span>&nbsp;<span class="op" id="7184321">!=</span>&nbsp;<span class="ident" id="7184324">tt</span><span class="op" id="7184326">.</span><span class="ident" id="7184327">want</span>&nbsp;<span class="op" id="7184332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184337">t</span><span class="op" id="7184338">.</span><span class="ident" id="7184339">Errorf</span><span class="op" id="7184345">(</span><span class="string" id="7184346">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7184367">,</span>&nbsp;<span class="ident" id="7184369">n</span><span class="op" id="7184370">,</span>&nbsp;<span class="ident" id="7184372">age</span><span class="op" id="7184375">,</span>&nbsp;<span class="ident" id="7184377">tt</span><span class="op" id="7184379">.</span><span class="ident" id="7184380">want</span><span class="op" id="7184384">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184391">}</span><br>
<span class="lineno"></span><span class="op" id="7184393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7184396">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="7184421">func</span>&nbsp;<span class="ident" id="7184426">TestStatementQueryRowConcurrent</span><span class="op" id="7184457">(</span><span class="ident" id="7184458">t</span>&nbsp;<span class="op" id="7184460">*</span><span class="ident" id="7184461">testing</span><span class="op" id="7184468">.</span><span class="ident" id="7184469">T</span><span class="op" id="7184470">)</span>&nbsp;<span class="op" id="7184472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184475">db</span>&nbsp;<span class="op" id="7184478">:=</span>&nbsp;<span class="ident" id="7184481">newTestDB</span><span class="op" id="7184490">(</span><span class="ident" id="7184491">t</span><span class="op" id="7184492">,</span>&nbsp;<span class="string" id="7184494">&#34;people&#34;</span><span class="op" id="7184502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184505">defer</span>&nbsp;<span class="ident" id="7184511">closeDB</span><span class="op" id="7184518">(</span><span class="ident" id="7184519">t</span><span class="op" id="7184520">,</span>&nbsp;<span class="ident" id="7184522">db</span><span class="op" id="7184524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184527">stmt</span><span class="op" id="7184531">,</span>&nbsp;<span class="ident" id="7184533">err</span>&nbsp;<span class="op" id="7184537">:=</span>&nbsp;<span class="ident" id="7184540">db</span><span class="op" id="7184542">.</span><span class="ident" id="7184543">Prepare</span><span class="op" id="7184550">(</span><span class="string" id="7184551">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7184577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184580">if</span>&nbsp;<span class="ident" id="7184583">err</span>&nbsp;<span class="op" id="7184587">!=</span>&nbsp;<span class="builtintype" id="7184590">nil</span>&nbsp;<span class="op" id="7184594">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184598">t</span><span class="op" id="7184599">.</span><span class="ident" id="7184600">Fatalf</span><span class="op" id="7184606">(</span><span class="string" id="7184607">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7184620">,</span>&nbsp;<span class="ident" id="7184622">err</span><span class="op" id="7184625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184631">defer</span>&nbsp;<span class="ident" id="7184637">stmt</span><span class="op" id="7184641">.</span><span class="ident" id="7184642">Close</span><span class="op" id="7184647">(</span><span class="op" id="7184648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184652">const</span>&nbsp;<span class="ident" id="7184658">n</span>&nbsp;<span class="op" id="7184660">=</span>&nbsp;<span class="num" id="7184662">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184666">ch</span>&nbsp;<span class="op" id="7184669">:=</span>&nbsp;<span class="builtinfunc" id="7184672">make</span><span class="op" id="7184676">(</span><span class="keyword" id="7184677">chan</span>&nbsp;<span class="builtintype" id="7184682">error</span><span class="op" id="7184687">,</span>&nbsp;<span class="ident" id="7184689">n</span><span class="op" id="7184690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184693">for</span>&nbsp;<span class="ident" id="7184697">i</span>&nbsp;<span class="op" id="7184699">:=</span>&nbsp;<span class="num" id="7184702">0</span><span class="op" id="7184703">;</span>&nbsp;<span class="ident" id="7184705">i</span>&nbsp;<span class="op" id="7184707">&lt;</span>&nbsp;<span class="ident" id="7184709">n</span><span class="op" id="7184710">;</span>&nbsp;<span class="ident" id="7184712">i</span><span class="op" id="7184713">++</span>&nbsp;<span class="op" id="7184716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184720">go</span>&nbsp;<span class="keyword" id="7184723">func</span><span class="op" id="7184727">(</span><span class="op" id="7184728">)</span>&nbsp;<span class="op" id="7184730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184735">var</span>&nbsp;<span class="ident" id="7184739">age</span>&nbsp;<span class="builtintype" id="7184743">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184750">err</span>&nbsp;<span class="op" id="7184754">:=</span>&nbsp;<span class="ident" id="7184757">stmt</span><span class="op" id="7184761">.</span><span class="ident" id="7184762">QueryRow</span><span class="op" id="7184770">(</span><span class="string" id="7184771">&#34;Alice&#34;</span><span class="op" id="7184778">)</span><span class="op" id="7184779">.</span><span class="ident" id="7184780">Scan</span><span class="op" id="7184784">(</span><span class="op" id="7184785">&amp;</span><span class="ident" id="7184786">age</span><span class="op" id="7184789">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184794">if</span>&nbsp;<span class="ident" id="7184797">err</span>&nbsp;<span class="op" id="7184801">==</span>&nbsp;<span class="builtintype" id="7184804">nil</span>&nbsp;<span class="op" id="7184808">&amp;&amp;</span>&nbsp;<span class="ident" id="7184811">age</span>&nbsp;<span class="op" id="7184815">!=</span>&nbsp;<span class="num" id="7184818">1</span>&nbsp;<span class="op" id="7184820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184826">err</span>&nbsp;<span class="op" id="7184830">=</span>&nbsp;<span class="ident" id="7184832">fmt</span><span class="op" id="7184835">.</span><span class="ident" id="7184836">Errorf</span><span class="op" id="7184842">(</span><span class="string" id="7184843">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="7184862">,</span>&nbsp;<span class="ident" id="7184864">age</span><span class="op" id="7184867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184877">ch</span>&nbsp;<span class="op" id="7184880">&lt;-</span>&nbsp;<span class="ident" id="7184883">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184889">}</span><span class="op" id="7184890">(</span><span class="op" id="7184891">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184897">for</span>&nbsp;<span class="ident" id="7184901">i</span>&nbsp;<span class="op" id="7184903">:=</span>&nbsp;<span class="num" id="7184906">0</span><span class="op" id="7184907">;</span>&nbsp;<span class="ident" id="7184909">i</span>&nbsp;<span class="op" id="7184911">&lt;</span>&nbsp;<span class="ident" id="7184913">n</span><span class="op" id="7184914">;</span>&nbsp;<span class="ident" id="7184916">i</span><span class="op" id="7184917">++</span>&nbsp;<span class="op" id="7184920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7184924">if</span>&nbsp;<span class="ident" id="7184927">err</span>&nbsp;<span class="op" id="7184931">:=</span>&nbsp;<span class="op" id="7184934">&lt;-</span><span class="ident" id="7184936">ch</span><span class="op" id="7184938">;</span>&nbsp;<span class="ident" id="7184940">err</span>&nbsp;<span class="op" id="7184944">!=</span>&nbsp;<span class="builtintype" id="7184947">nil</span>&nbsp;<span class="op" id="7184951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7184956">t</span><span class="op" id="7184957">.</span><span class="ident" id="7184958">Error</span><span class="op" id="7184963">(</span><span class="ident" id="7184964">err</span><span class="op" id="7184967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184971">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7184974">}</span><br>
<span class="lineno"></span><span class="op" id="7184976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7184979">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="7185011">func</span>&nbsp;<span class="ident" id="7185016">TestBogusPreboundParameters</span><span class="op" id="7185043">(</span><span class="ident" id="7185044">t</span>&nbsp;<span class="op" id="7185046">*</span><span class="ident" id="7185047">testing</span><span class="op" id="7185054">.</span><span class="ident" id="7185055">T</span><span class="op" id="7185056">)</span>&nbsp;<span class="op" id="7185058">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185061">db</span>&nbsp;<span class="op" id="7185064">:=</span>&nbsp;<span class="ident" id="7185067">newTestDB</span><span class="op" id="7185076">(</span><span class="ident" id="7185077">t</span><span class="op" id="7185078">,</span>&nbsp;<span class="string" id="7185080">&#34;foo&#34;</span><span class="op" id="7185085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185088">defer</span>&nbsp;<span class="ident" id="7185094">closeDB</span><span class="op" id="7185101">(</span><span class="ident" id="7185102">t</span><span class="op" id="7185103">,</span>&nbsp;<span class="ident" id="7185105">db</span><span class="op" id="7185107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185110">exec</span><span class="op" id="7185114">(</span><span class="ident" id="7185115">t</span><span class="op" id="7185116">,</span>&nbsp;<span class="ident" id="7185118">db</span><span class="op" id="7185120">,</span>&nbsp;<span class="string" id="7185122">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7185165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185168">_</span><span class="op" id="7185169">,</span>&nbsp;<span class="ident" id="7185171">err</span>&nbsp;<span class="op" id="7185175">:=</span>&nbsp;<span class="ident" id="7185178">db</span><span class="op" id="7185180">.</span><span class="ident" id="7185181">Prepare</span><span class="op" id="7185188">(</span><span class="string" id="7185189">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="7185227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185230">if</span>&nbsp;<span class="ident" id="7185233">err</span>&nbsp;<span class="op" id="7185237">==</span>&nbsp;<span class="builtintype" id="7185240">nil</span>&nbsp;<span class="op" id="7185244">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185248">t</span><span class="op" id="7185249">.</span><span class="ident" id="7185250">Fatalf</span><span class="op" id="7185256">(</span><span class="string" id="7185257">&#34;expected&nbsp;error&#34;</span><span class="op" id="7185273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185279">if</span>&nbsp;<span class="ident" id="7185282">err</span><span class="op" id="7185285">.</span><span class="ident" id="7185286">Error</span><span class="op" id="7185291">(</span><span class="op" id="7185292">)</span>&nbsp;<span class="op" id="7185294">!=</span>&nbsp;<span class="string" id="7185297">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="7185358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185362">t</span><span class="op" id="7185363">.</span><span class="ident" id="7185364">Errorf</span><span class="op" id="7185370">(</span><span class="string" id="7185371">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7185393">,</span>&nbsp;<span class="ident" id="7185395">err</span><span class="op" id="7185398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185401">}</span><br>
<span class="lineno">400</span><span class="op" id="7185403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7185406">func</span>&nbsp;<span class="ident" id="7185411">TestExec</span><span class="op" id="7185419">(</span><span class="ident" id="7185420">t</span>&nbsp;<span class="op" id="7185422">*</span><span class="ident" id="7185423">testing</span><span class="op" id="7185430">.</span><span class="ident" id="7185431">T</span><span class="op" id="7185432">)</span>&nbsp;<span class="op" id="7185434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185437">db</span>&nbsp;<span class="op" id="7185440">:=</span>&nbsp;<span class="ident" id="7185443">newTestDB</span><span class="op" id="7185452">(</span><span class="ident" id="7185453">t</span><span class="op" id="7185454">,</span>&nbsp;<span class="string" id="7185456">&#34;foo&#34;</span><span class="op" id="7185461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185464">defer</span>&nbsp;<span class="ident" id="7185470">closeDB</span><span class="op" id="7185477">(</span><span class="ident" id="7185478">t</span><span class="op" id="7185479">,</span>&nbsp;<span class="ident" id="7185481">db</span><span class="op" id="7185483">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185486">exec</span><span class="op" id="7185490">(</span><span class="ident" id="7185491">t</span><span class="op" id="7185492">,</span>&nbsp;<span class="ident" id="7185494">db</span><span class="op" id="7185496">,</span>&nbsp;<span class="string" id="7185498">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7185541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185544">stmt</span><span class="op" id="7185548">,</span>&nbsp;<span class="ident" id="7185550">err</span>&nbsp;<span class="op" id="7185554">:=</span>&nbsp;<span class="ident" id="7185557">db</span><span class="op" id="7185559">.</span><span class="ident" id="7185560">Prepare</span><span class="op" id="7185567">(</span><span class="string" id="7185568">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7185592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185595">if</span>&nbsp;<span class="ident" id="7185598">err</span>&nbsp;<span class="op" id="7185602">!=</span>&nbsp;<span class="builtintype" id="7185605">nil</span>&nbsp;<span class="op" id="7185609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185613">t</span><span class="op" id="7185614">.</span><span class="ident" id="7185615">Errorf</span><span class="op" id="7185621">(</span><span class="string" id="7185622">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7185642">,</span>&nbsp;<span class="ident" id="7185644">stmt</span><span class="op" id="7185648">,</span>&nbsp;<span class="ident" id="7185650">err</span><span class="op" id="7185653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185656">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185659">defer</span>&nbsp;<span class="ident" id="7185665">stmt</span><span class="op" id="7185669">.</span><span class="ident" id="7185670">Close</span><span class="op" id="7185675">(</span><span class="op" id="7185676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7185680">type</span>&nbsp;<span class="ident" id="7185685">execTest</span>&nbsp;<span class="keyword" id="7185694">struct</span>&nbsp;<span class="op" id="7185701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185705">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185713">[</span><span class="op" id="7185714">]</span><span class="keyword" id="7185715">interface</span><span class="op" id="7185724">{</span><span class="op" id="7185725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185729">wantErr</span>&nbsp;<span class="builtintype" id="7185737">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7185748">execTests</span>&nbsp;<span class="op" id="7185758">:=</span>&nbsp;<span class="op" id="7185761">[</span><span class="op" id="7185762">]</span><span class="ident" id="7185763">execTest</span><span class="op" id="7185771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7185775">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185786">{</span><span class="op" id="7185787">[</span><span class="op" id="7185788">]</span><span class="keyword" id="7185789">interface</span><span class="op" id="7185798">{</span><span class="op" id="7185799">}</span><span class="op" id="7185800">{</span><span class="string" id="7185801">&#34;Brad&#34;</span><span class="op" id="7185807">,</span>&nbsp;<span class="num" id="7185809">31</span><span class="op" id="7185811">}</span><span class="op" id="7185812">,</span>&nbsp;<span class="string" id="7185814">&#34;&#34;</span><span class="op" id="7185816">}</span><span class="op" id="7185817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185821">{</span><span class="op" id="7185822">[</span><span class="op" id="7185823">]</span><span class="keyword" id="7185824">interface</span><span class="op" id="7185833">{</span><span class="op" id="7185834">}</span><span class="op" id="7185835">{</span><span class="string" id="7185836">&#34;Brad&#34;</span><span class="op" id="7185842">,</span>&nbsp;<span class="ident" id="7185844">int64</span><span class="op" id="7185849">(</span><span class="num" id="7185850">31</span><span class="op" id="7185852">)</span><span class="op" id="7185853">}</span><span class="op" id="7185854">,</span>&nbsp;<span class="string" id="7185856">&#34;&#34;</span><span class="op" id="7185858">}</span><span class="op" id="7185859">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185863">{</span><span class="op" id="7185864">[</span><span class="op" id="7185865">]</span><span class="keyword" id="7185866">interface</span><span class="op" id="7185875">{</span><span class="op" id="7185876">}</span><span class="op" id="7185877">{</span><span class="string" id="7185878">&#34;Bob&#34;</span><span class="op" id="7185883">,</span>&nbsp;<span class="string" id="7185885">&#34;32&#34;</span><span class="op" id="7185889">}</span><span class="op" id="7185890">,</span>&nbsp;<span class="string" id="7185892">&#34;&#34;</span><span class="op" id="7185894">}</span><span class="op" id="7185895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185899">{</span><span class="op" id="7185900">[</span><span class="op" id="7185901">]</span><span class="keyword" id="7185902">interface</span><span class="op" id="7185911">{</span><span class="op" id="7185912">}</span><span class="op" id="7185913">{</span><span class="num" id="7185914">7</span><span class="op" id="7185915">,</span>&nbsp;<span class="num" id="7185917">9</span><span class="op" id="7185918">}</span><span class="op" id="7185919">,</span>&nbsp;<span class="string" id="7185921">&#34;&#34;</span><span class="op" id="7185923">}</span><span class="op" id="7185924">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7185929">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7185955">{</span><span class="op" id="7185956">[</span><span class="op" id="7185957">]</span><span class="keyword" id="7185958">interface</span><span class="op" id="7185967">{</span><span class="op" id="7185968">}</span><span class="op" id="7185969">{</span><span class="string" id="7185970">&#34;Brad&#34;</span><span class="op" id="7185976">,</span>&nbsp;<span class="ident" id="7185978">int64</span><span class="op" id="7185983">(</span><span class="num" id="7185984">0xFFFFFFFF</span><span class="op" id="7185994">)</span><span class="op" id="7185995">}</span><span class="op" id="7185996">,</span>&nbsp;<span class="string" id="7185998">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="7186080">}</span><span class="op" id="7186081">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186085">{</span><span class="op" id="7186086">[</span><span class="op" id="7186087">]</span><span class="keyword" id="7186088">interface</span><span class="op" id="7186097">{</span><span class="op" id="7186098">}</span><span class="op" id="7186099">{</span><span class="string" id="7186100">&#34;Brad&#34;</span><span class="op" id="7186106">,</span>&nbsp;<span class="string" id="7186108">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="7186122">}</span><span class="op" id="7186123">,</span>&nbsp;<span class="string" id="7186125">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="7186225">}</span><span class="op" id="7186226">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7186231">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186258">{</span><span class="op" id="7186259">[</span><span class="op" id="7186260">]</span><span class="keyword" id="7186261">interface</span><span class="op" id="7186270">{</span><span class="op" id="7186271">}</span><span class="op" id="7186272">{</span><span class="op" id="7186273">}</span><span class="op" id="7186274">,</span>&nbsp;<span class="string" id="7186276">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="7186310">}</span><span class="op" id="7186311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186315">{</span><span class="op" id="7186316">[</span><span class="op" id="7186317">]</span><span class="keyword" id="7186318">interface</span><span class="op" id="7186327">{</span><span class="op" id="7186328">}</span><span class="op" id="7186329">{</span><span class="num" id="7186330">1</span><span class="op" id="7186331">,</span>&nbsp;<span class="num" id="7186333">2</span><span class="op" id="7186334">,</span>&nbsp;<span class="num" id="7186336">3</span><span class="op" id="7186337">}</span><span class="op" id="7186338">,</span>&nbsp;<span class="string" id="7186340">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="7186374">}</span><span class="op" id="7186375">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186381">for</span>&nbsp;<span class="ident" id="7186385">n</span><span class="op" id="7186386">,</span>&nbsp;<span class="ident" id="7186388">et</span>&nbsp;<span class="op" id="7186391">:=</span>&nbsp;<span class="keyword" id="7186394">range</span>&nbsp;<span class="ident" id="7186400">execTests</span>&nbsp;<span class="op" id="7186410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186414">_</span><span class="op" id="7186415">,</span>&nbsp;<span class="ident" id="7186417">err</span>&nbsp;<span class="op" id="7186421">:=</span>&nbsp;<span class="ident" id="7186424">stmt</span><span class="op" id="7186428">.</span><span class="ident" id="7186429">Exec</span><span class="op" id="7186433">(</span><span class="ident" id="7186434">et</span><span class="op" id="7186436">.</span><span class="ident" id="7186437">args</span><span class="op" id="7186441">...</span><span class="op" id="7186444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186448">errStr</span>&nbsp;<span class="op" id="7186455">:=</span>&nbsp;<span class="string" id="7186458">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186463">if</span>&nbsp;<span class="ident" id="7186466">err</span>&nbsp;<span class="op" id="7186470">!=</span>&nbsp;<span class="builtintype" id="7186473">nil</span>&nbsp;<span class="op" id="7186477">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186482">errStr</span>&nbsp;<span class="op" id="7186489">=</span>&nbsp;<span class="ident" id="7186491">err</span><span class="op" id="7186494">.</span><span class="ident" id="7186495">Error</span><span class="op" id="7186500">(</span><span class="op" id="7186501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186509">if</span>&nbsp;<span class="ident" id="7186512">errStr</span>&nbsp;<span class="op" id="7186519">!=</span>&nbsp;<span class="ident" id="7186522">et</span><span class="op" id="7186524">.</span><span class="ident" id="7186525">wantErr</span>&nbsp;<span class="op" id="7186533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186538">t</span><span class="op" id="7186539">.</span><span class="ident" id="7186540">Errorf</span><span class="op" id="7186546">(</span><span class="string" id="7186547">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="7186602">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186608">n</span><span class="op" id="7186609">,</span>&nbsp;<span class="ident" id="7186611">et</span><span class="op" id="7186613">.</span><span class="ident" id="7186614">args</span><span class="op" id="7186618">,</span>&nbsp;<span class="ident" id="7186620">errStr</span><span class="op" id="7186626">,</span>&nbsp;<span class="ident" id="7186628">et</span><span class="op" id="7186630">.</span><span class="ident" id="7186631">wantErr</span><span class="op" id="7186638">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186645">}</span><br>
<span class="lineno"></span><span class="op" id="7186647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7186650">func</span>&nbsp;<span class="ident" id="7186655">TestTxPrepare</span><span class="op" id="7186668">(</span><span class="ident" id="7186669">t</span>&nbsp;<span class="op" id="7186671">*</span><span class="ident" id="7186672">testing</span><span class="op" id="7186679">.</span><span class="ident" id="7186680">T</span><span class="op" id="7186681">)</span>&nbsp;<span class="op" id="7186683">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186686">db</span>&nbsp;<span class="op" id="7186689">:=</span>&nbsp;<span class="ident" id="7186692">newTestDB</span><span class="op" id="7186701">(</span><span class="ident" id="7186702">t</span><span class="op" id="7186703">,</span>&nbsp;<span class="string" id="7186705">&#34;&#34;</span><span class="op" id="7186707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186710">defer</span>&nbsp;<span class="ident" id="7186716">closeDB</span><span class="op" id="7186723">(</span><span class="ident" id="7186724">t</span><span class="op" id="7186725">,</span>&nbsp;<span class="ident" id="7186727">db</span><span class="op" id="7186729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186732">exec</span><span class="op" id="7186736">(</span><span class="ident" id="7186737">t</span><span class="op" id="7186738">,</span>&nbsp;<span class="ident" id="7186740">db</span><span class="op" id="7186742">,</span>&nbsp;<span class="string" id="7186744">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7186787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186790">tx</span><span class="op" id="7186792">,</span>&nbsp;<span class="ident" id="7186794">err</span>&nbsp;<span class="op" id="7186798">:=</span>&nbsp;<span class="ident" id="7186801">db</span><span class="op" id="7186803">.</span><span class="ident" id="7186804">Begin</span><span class="op" id="7186809">(</span><span class="op" id="7186810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186813">if</span>&nbsp;<span class="ident" id="7186816">err</span>&nbsp;<span class="op" id="7186820">!=</span>&nbsp;<span class="builtintype" id="7186823">nil</span>&nbsp;<span class="op" id="7186827">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186831">t</span><span class="op" id="7186832">.</span><span class="ident" id="7186833">Fatalf</span><span class="op" id="7186839">(</span><span class="string" id="7186840">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7186852">,</span>&nbsp;<span class="ident" id="7186854">err</span><span class="op" id="7186857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186863">stmt</span><span class="op" id="7186867">,</span>&nbsp;<span class="ident" id="7186869">err</span>&nbsp;<span class="op" id="7186873">:=</span>&nbsp;<span class="ident" id="7186876">tx</span><span class="op" id="7186878">.</span><span class="ident" id="7186879">Prepare</span><span class="op" id="7186886">(</span><span class="string" id="7186887">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7186911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186914">if</span>&nbsp;<span class="ident" id="7186917">err</span>&nbsp;<span class="op" id="7186921">!=</span>&nbsp;<span class="builtintype" id="7186924">nil</span>&nbsp;<span class="op" id="7186928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186932">t</span><span class="op" id="7186933">.</span><span class="ident" id="7186934">Fatalf</span><span class="op" id="7186940">(</span><span class="string" id="7186941">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7186961">,</span>&nbsp;<span class="ident" id="7186963">stmt</span><span class="op" id="7186967">,</span>&nbsp;<span class="ident" id="7186969">err</span><span class="op" id="7186972">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7186975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7186978">defer</span>&nbsp;<span class="ident" id="7186984">stmt</span><span class="op" id="7186988">.</span><span class="ident" id="7186989">Close</span><span class="op" id="7186994">(</span><span class="op" id="7186995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7186998">_</span><span class="op" id="7186999">,</span>&nbsp;<span class="ident" id="7187001">err</span>&nbsp;<span class="op" id="7187005">=</span>&nbsp;<span class="ident" id="7187007">stmt</span><span class="op" id="7187011">.</span><span class="ident" id="7187012">Exec</span><span class="op" id="7187016">(</span><span class="string" id="7187017">&#34;Bobby&#34;</span><span class="op" id="7187024">,</span>&nbsp;<span class="num" id="7187026">7</span><span class="op" id="7187027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187030">if</span>&nbsp;<span class="ident" id="7187033">err</span>&nbsp;<span class="op" id="7187037">!=</span>&nbsp;<span class="builtintype" id="7187040">nil</span>&nbsp;<span class="op" id="7187044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187048">t</span><span class="op" id="7187049">.</span><span class="ident" id="7187050">Fatalf</span><span class="op" id="7187056">(</span><span class="string" id="7187057">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7187068">,</span>&nbsp;<span class="ident" id="7187070">err</span><span class="op" id="7187073">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187079">err</span>&nbsp;<span class="op" id="7187083">=</span>&nbsp;<span class="ident" id="7187085">tx</span><span class="op" id="7187087">.</span><span class="ident" id="7187088">Commit</span><span class="op" id="7187094">(</span><span class="op" id="7187095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187098">if</span>&nbsp;<span class="ident" id="7187101">err</span>&nbsp;<span class="op" id="7187105">!=</span>&nbsp;<span class="builtintype" id="7187108">nil</span>&nbsp;<span class="op" id="7187112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187116">t</span><span class="op" id="7187117">.</span><span class="ident" id="7187118">Fatalf</span><span class="op" id="7187124">(</span><span class="string" id="7187125">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7187138">,</span>&nbsp;<span class="ident" id="7187140">err</span><span class="op" id="7187143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187146">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7187149">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187195">if</span>&nbsp;<span class="op" id="7187198">!</span><span class="ident" id="7187199">stmt</span><span class="op" id="7187203">.</span><span class="ident" id="7187204">closed</span>&nbsp;<span class="op" id="7187211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187215">t</span><span class="op" id="7187216">.</span><span class="ident" id="7187217">Fatal</span><span class="op" id="7187222">(</span><span class="string" id="7187223">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7187253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187256">}</span><br>
<span class="lineno"></span><span class="op" id="7187258">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7187261">func</span>&nbsp;<span class="ident" id="7187266">TestTxStmt</span><span class="op" id="7187276">(</span><span class="ident" id="7187277">t</span>&nbsp;<span class="op" id="7187279">*</span><span class="ident" id="7187280">testing</span><span class="op" id="7187287">.</span><span class="ident" id="7187288">T</span><span class="op" id="7187289">)</span>&nbsp;<span class="op" id="7187291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187294">db</span>&nbsp;<span class="op" id="7187297">:=</span>&nbsp;<span class="ident" id="7187300">newTestDB</span><span class="op" id="7187309">(</span><span class="ident" id="7187310">t</span><span class="op" id="7187311">,</span>&nbsp;<span class="string" id="7187313">&#34;&#34;</span><span class="op" id="7187315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187318">defer</span>&nbsp;<span class="ident" id="7187324">closeDB</span><span class="op" id="7187331">(</span><span class="ident" id="7187332">t</span><span class="op" id="7187333">,</span>&nbsp;<span class="ident" id="7187335">db</span><span class="op" id="7187337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187340">exec</span><span class="op" id="7187344">(</span><span class="ident" id="7187345">t</span><span class="op" id="7187346">,</span>&nbsp;<span class="ident" id="7187348">db</span><span class="op" id="7187350">,</span>&nbsp;<span class="string" id="7187352">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7187395">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187398">stmt</span><span class="op" id="7187402">,</span>&nbsp;<span class="ident" id="7187404">err</span>&nbsp;<span class="op" id="7187408">:=</span>&nbsp;<span class="ident" id="7187411">db</span><span class="op" id="7187413">.</span><span class="ident" id="7187414">Prepare</span><span class="op" id="7187421">(</span><span class="string" id="7187422">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7187446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187449">if</span>&nbsp;<span class="ident" id="7187452">err</span>&nbsp;<span class="op" id="7187456">!=</span>&nbsp;<span class="builtintype" id="7187459">nil</span>&nbsp;<span class="op" id="7187463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187467">t</span><span class="op" id="7187468">.</span><span class="ident" id="7187469">Fatalf</span><span class="op" id="7187475">(</span><span class="string" id="7187476">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7187496">,</span>&nbsp;<span class="ident" id="7187498">stmt</span><span class="op" id="7187502">,</span>&nbsp;<span class="ident" id="7187504">err</span><span class="op" id="7187507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187513">defer</span>&nbsp;<span class="ident" id="7187519">stmt</span><span class="op" id="7187523">.</span><span class="ident" id="7187524">Close</span><span class="op" id="7187529">(</span><span class="op" id="7187530">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187533">tx</span><span class="op" id="7187535">,</span>&nbsp;<span class="ident" id="7187537">err</span>&nbsp;<span class="op" id="7187541">:=</span>&nbsp;<span class="ident" id="7187544">db</span><span class="op" id="7187546">.</span><span class="ident" id="7187547">Begin</span><span class="op" id="7187552">(</span><span class="op" id="7187553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187556">if</span>&nbsp;<span class="ident" id="7187559">err</span>&nbsp;<span class="op" id="7187563">!=</span>&nbsp;<span class="builtintype" id="7187566">nil</span>&nbsp;<span class="op" id="7187570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187574">t</span><span class="op" id="7187575">.</span><span class="ident" id="7187576">Fatalf</span><span class="op" id="7187582">(</span><span class="string" id="7187583">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7187595">,</span>&nbsp;<span class="ident" id="7187597">err</span><span class="op" id="7187600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187606">txs</span>&nbsp;<span class="op" id="7187610">:=</span>&nbsp;<span class="ident" id="7187613">tx</span><span class="op" id="7187615">.</span><span class="ident" id="7187616">Stmt</span><span class="op" id="7187620">(</span><span class="ident" id="7187621">stmt</span><span class="op" id="7187625">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187628">defer</span>&nbsp;<span class="ident" id="7187634">txs</span><span class="op" id="7187637">.</span><span class="ident" id="7187638">Close</span><span class="op" id="7187643">(</span><span class="op" id="7187644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187647">_</span><span class="op" id="7187648">,</span>&nbsp;<span class="ident" id="7187650">err</span>&nbsp;<span class="op" id="7187654">=</span>&nbsp;<span class="ident" id="7187656">txs</span><span class="op" id="7187659">.</span><span class="ident" id="7187660">Exec</span><span class="op" id="7187664">(</span><span class="string" id="7187665">&#34;Bobby&#34;</span><span class="op" id="7187672">,</span>&nbsp;<span class="num" id="7187674">7</span><span class="op" id="7187675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187678">if</span>&nbsp;<span class="ident" id="7187681">err</span>&nbsp;<span class="op" id="7187685">!=</span>&nbsp;<span class="builtintype" id="7187688">nil</span>&nbsp;<span class="op" id="7187692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187696">t</span><span class="op" id="7187697">.</span><span class="ident" id="7187698">Fatalf</span><span class="op" id="7187704">(</span><span class="string" id="7187705">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7187716">,</span>&nbsp;<span class="ident" id="7187718">err</span><span class="op" id="7187721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187724">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187727">err</span>&nbsp;<span class="op" id="7187731">=</span>&nbsp;<span class="ident" id="7187733">tx</span><span class="op" id="7187735">.</span><span class="ident" id="7187736">Commit</span><span class="op" id="7187742">(</span><span class="op" id="7187743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187746">if</span>&nbsp;<span class="ident" id="7187749">err</span>&nbsp;<span class="op" id="7187753">!=</span>&nbsp;<span class="builtintype" id="7187756">nil</span>&nbsp;<span class="op" id="7187760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187764">t</span><span class="op" id="7187765">.</span><span class="ident" id="7187766">Fatalf</span><span class="op" id="7187772">(</span><span class="string" id="7187773">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7187786">,</span>&nbsp;<span class="ident" id="7187788">err</span><span class="op" id="7187791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7187797">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7187843">if</span>&nbsp;<span class="op" id="7187846">!</span><span class="ident" id="7187847">txs</span><span class="op" id="7187850">.</span><span class="ident" id="7187851">closed</span>&nbsp;<span class="op" id="7187858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7187862">t</span><span class="op" id="7187863">.</span><span class="ident" id="7187864">Fatal</span><span class="op" id="7187869">(</span><span class="string" id="7187870">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7187900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7187903">}</span><br>
<span class="lineno"></span><span class="op" id="7187905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="7187908">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="7187947">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="7188024">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="7188091">func</span>&nbsp;<span class="ident" id="7188096">TestTxQuery</span><span class="op" id="7188107">(</span><span class="ident" id="7188108">t</span>&nbsp;<span class="op" id="7188110">*</span><span class="ident" id="7188111">testing</span><span class="op" id="7188118">.</span><span class="ident" id="7188119">T</span><span class="op" id="7188120">)</span>&nbsp;<span class="op" id="7188122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188125">db</span>&nbsp;<span class="op" id="7188128">:=</span>&nbsp;<span class="ident" id="7188131">newTestDB</span><span class="op" id="7188140">(</span><span class="ident" id="7188141">t</span><span class="op" id="7188142">,</span>&nbsp;<span class="string" id="7188144">&#34;&#34;</span><span class="op" id="7188146">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188149">defer</span>&nbsp;<span class="ident" id="7188155">closeDB</span><span class="op" id="7188162">(</span><span class="ident" id="7188163">t</span><span class="op" id="7188164">,</span>&nbsp;<span class="ident" id="7188166">db</span><span class="op" id="7188168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188171">exec</span><span class="op" id="7188175">(</span><span class="ident" id="7188176">t</span><span class="op" id="7188177">,</span>&nbsp;<span class="ident" id="7188179">db</span><span class="op" id="7188181">,</span>&nbsp;<span class="string" id="7188183">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7188226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188229">exec</span><span class="op" id="7188233">(</span><span class="ident" id="7188234">t</span><span class="op" id="7188235">,</span>&nbsp;<span class="ident" id="7188237">db</span><span class="op" id="7188239">,</span>&nbsp;<span class="string" id="7188241">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="7188263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188267">tx</span><span class="op" id="7188269">,</span>&nbsp;<span class="ident" id="7188271">err</span>&nbsp;<span class="op" id="7188275">:=</span>&nbsp;<span class="ident" id="7188278">db</span><span class="op" id="7188280">.</span><span class="ident" id="7188281">Begin</span><span class="op" id="7188286">(</span><span class="op" id="7188287">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188290">if</span>&nbsp;<span class="ident" id="7188293">err</span>&nbsp;<span class="op" id="7188297">!=</span>&nbsp;<span class="builtintype" id="7188300">nil</span>&nbsp;<span class="op" id="7188304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188308">t</span><span class="op" id="7188309">.</span><span class="ident" id="7188310">Fatal</span><span class="op" id="7188315">(</span><span class="ident" id="7188316">err</span><span class="op" id="7188319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188325">defer</span>&nbsp;<span class="ident" id="7188331">tx</span><span class="op" id="7188333">.</span><span class="ident" id="7188334">Rollback</span><span class="op" id="7188342">(</span><span class="op" id="7188343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188347">r</span><span class="op" id="7188348">,</span>&nbsp;<span class="ident" id="7188350">err</span>&nbsp;<span class="op" id="7188354">:=</span>&nbsp;<span class="ident" id="7188357">tx</span><span class="op" id="7188359">.</span><span class="ident" id="7188360">Query</span><span class="op" id="7188365">(</span><span class="string" id="7188366">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7188383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188386">if</span>&nbsp;<span class="ident" id="7188389">err</span>&nbsp;<span class="op" id="7188393">!=</span>&nbsp;<span class="builtintype" id="7188396">nil</span>&nbsp;<span class="op" id="7188400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188404">t</span><span class="op" id="7188405">.</span><span class="ident" id="7188406">Fatal</span><span class="op" id="7188411">(</span><span class="ident" id="7188412">err</span><span class="op" id="7188415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188421">defer</span>&nbsp;<span class="ident" id="7188427">r</span><span class="op" id="7188428">.</span><span class="ident" id="7188429">Close</span><span class="op" id="7188434">(</span><span class="op" id="7188435">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188439">if</span>&nbsp;<span class="op" id="7188442">!</span><span class="ident" id="7188443">r</span><span class="op" id="7188444">.</span><span class="ident" id="7188445">Next</span><span class="op" id="7188449">(</span><span class="op" id="7188450">)</span>&nbsp;<span class="op" id="7188452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188456">if</span>&nbsp;<span class="ident" id="7188459">r</span><span class="op" id="7188460">.</span><span class="ident" id="7188461">Err</span><span class="op" id="7188464">(</span><span class="op" id="7188465">)</span>&nbsp;<span class="op" id="7188467">!=</span>&nbsp;<span class="builtintype" id="7188470">nil</span>&nbsp;<span class="op" id="7188474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188479">t</span><span class="op" id="7188480">.</span><span class="ident" id="7188481">Fatal</span><span class="op" id="7188486">(</span><span class="ident" id="7188487">r</span><span class="op" id="7188488">.</span><span class="ident" id="7188489">Err</span><span class="op" id="7188492">(</span><span class="op" id="7188493">)</span><span class="op" id="7188494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188498">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188502">t</span><span class="op" id="7188503">.</span><span class="ident" id="7188504">Fatal</span><span class="op" id="7188509">(</span><span class="string" id="7188510">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="7188528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188535">var</span>&nbsp;<span class="ident" id="7188539">x</span>&nbsp;<span class="builtintype" id="7188541">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188549">err</span>&nbsp;<span class="op" id="7188553">=</span>&nbsp;<span class="ident" id="7188555">r</span><span class="op" id="7188556">.</span><span class="ident" id="7188557">Scan</span><span class="op" id="7188561">(</span><span class="op" id="7188562">&amp;</span><span class="ident" id="7188563">x</span><span class="op" id="7188564">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188567">if</span>&nbsp;<span class="ident" id="7188570">err</span>&nbsp;<span class="op" id="7188574">!=</span>&nbsp;<span class="builtintype" id="7188577">nil</span>&nbsp;<span class="op" id="7188581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188585">t</span><span class="op" id="7188586">.</span><span class="ident" id="7188587">Fatal</span><span class="op" id="7188592">(</span><span class="ident" id="7188593">err</span><span class="op" id="7188596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188599">}</span><br>
<span class="lineno"></span><span class="op" id="7188601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7188604">func</span>&nbsp;<span class="ident" id="7188609">TestTxQueryInvalid</span><span class="op" id="7188627">(</span><span class="ident" id="7188628">t</span>&nbsp;<span class="op" id="7188630">*</span><span class="ident" id="7188631">testing</span><span class="op" id="7188638">.</span><span class="ident" id="7188639">T</span><span class="op" id="7188640">)</span>&nbsp;<span class="op" id="7188642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188645">db</span>&nbsp;<span class="op" id="7188648">:=</span>&nbsp;<span class="ident" id="7188651">newTestDB</span><span class="op" id="7188660">(</span><span class="ident" id="7188661">t</span><span class="op" id="7188662">,</span>&nbsp;<span class="string" id="7188664">&#34;&#34;</span><span class="op" id="7188666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188669">defer</span>&nbsp;<span class="ident" id="7188675">closeDB</span><span class="op" id="7188682">(</span><span class="ident" id="7188683">t</span><span class="op" id="7188684">,</span>&nbsp;<span class="ident" id="7188686">db</span><span class="op" id="7188688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188692">tx</span><span class="op" id="7188694">,</span>&nbsp;<span class="ident" id="7188696">err</span>&nbsp;<span class="op" id="7188700">:=</span>&nbsp;<span class="ident" id="7188703">db</span><span class="op" id="7188705">.</span><span class="ident" id="7188706">Begin</span><span class="op" id="7188711">(</span><span class="op" id="7188712">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188715">if</span>&nbsp;<span class="ident" id="7188718">err</span>&nbsp;<span class="op" id="7188722">!=</span>&nbsp;<span class="builtintype" id="7188725">nil</span>&nbsp;<span class="op" id="7188729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188733">t</span><span class="op" id="7188734">.</span><span class="ident" id="7188735">Fatal</span><span class="op" id="7188740">(</span><span class="ident" id="7188741">err</span><span class="op" id="7188744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188750">defer</span>&nbsp;<span class="ident" id="7188756">tx</span><span class="op" id="7188758">.</span><span class="ident" id="7188759">Rollback</span><span class="op" id="7188767">(</span><span class="op" id="7188768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188772">_</span><span class="op" id="7188773">,</span>&nbsp;<span class="ident" id="7188775">err</span>&nbsp;<span class="op" id="7188779">=</span>&nbsp;<span class="ident" id="7188781">tx</span><span class="op" id="7188783">.</span><span class="ident" id="7188784">Query</span><span class="op" id="7188789">(</span><span class="string" id="7188790">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7188807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7188810">if</span>&nbsp;<span class="ident" id="7188813">err</span>&nbsp;<span class="op" id="7188817">==</span>&nbsp;<span class="builtintype" id="7188820">nil</span>&nbsp;<span class="op" id="7188824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188828">t</span><span class="op" id="7188829">.</span><span class="ident" id="7188830">Fatal</span><span class="op" id="7188835">(</span><span class="string" id="7188836">&#34;Error&nbsp;expected&#34;</span><span class="op" id="7188852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7188855">}</span><br>
<span class="lineno"></span><span class="op" id="7188857">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="7188860">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="7188923">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="7188958">func</span>&nbsp;<span class="ident" id="7188963">TestTxErrBadConn</span><span class="op" id="7188979">(</span><span class="ident" id="7188980">t</span>&nbsp;<span class="op" id="7188982">*</span><span class="ident" id="7188983">testing</span><span class="op" id="7188990">.</span><span class="ident" id="7188991">T</span><span class="op" id="7188992">)</span>&nbsp;<span class="op" id="7188994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7188997">db</span><span class="op" id="7188999">,</span>&nbsp;<span class="ident" id="7189001">err</span>&nbsp;<span class="op" id="7189005">:=</span>&nbsp;<span class="ident" id="7189008">Open</span><span class="op" id="7189012">(</span><span class="string" id="7189013">&#34;test&#34;</span><span class="op" id="7189019">,</span>&nbsp;<span class="ident" id="7189021">fakeDBName</span><span class="op" id="7189031">+</span><span class="string" id="7189032">&#34;;badConn&#34;</span><span class="op" id="7189042">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189045">if</span>&nbsp;<span class="ident" id="7189048">err</span>&nbsp;<span class="op" id="7189052">!=</span>&nbsp;<span class="builtintype" id="7189055">nil</span>&nbsp;<span class="op" id="7189059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189063">t</span><span class="op" id="7189064">.</span><span class="ident" id="7189065">Fatalf</span><span class="op" id="7189071">(</span><span class="string" id="7189072">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7189082">,</span>&nbsp;<span class="ident" id="7189084">err</span><span class="op" id="7189087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189093">if</span>&nbsp;<span class="ident" id="7189096">_</span><span class="op" id="7189097">,</span>&nbsp;<span class="ident" id="7189099">err</span>&nbsp;<span class="op" id="7189103">:=</span>&nbsp;<span class="ident" id="7189106">db</span><span class="op" id="7189108">.</span><span class="ident" id="7189109">Exec</span><span class="op" id="7189113">(</span><span class="string" id="7189114">&#34;WIPE&#34;</span><span class="op" id="7189120">)</span><span class="op" id="7189121">;</span>&nbsp;<span class="ident" id="7189123">err</span>&nbsp;<span class="op" id="7189127">!=</span>&nbsp;<span class="builtintype" id="7189130">nil</span>&nbsp;<span class="op" id="7189134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189138">t</span><span class="op" id="7189139">.</span><span class="ident" id="7189140">Fatalf</span><span class="op" id="7189146">(</span><span class="string" id="7189147">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7189162">,</span>&nbsp;<span class="ident" id="7189164">err</span><span class="op" id="7189167">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189173">defer</span>&nbsp;<span class="ident" id="7189179">closeDB</span><span class="op" id="7189186">(</span><span class="ident" id="7189187">t</span><span class="op" id="7189188">,</span>&nbsp;<span class="ident" id="7189190">db</span><span class="op" id="7189192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189195">exec</span><span class="op" id="7189199">(</span><span class="ident" id="7189200">t</span><span class="op" id="7189201">,</span>&nbsp;<span class="ident" id="7189203">db</span><span class="op" id="7189205">,</span>&nbsp;<span class="string" id="7189207">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7189250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189253">stmt</span><span class="op" id="7189257">,</span>&nbsp;<span class="ident" id="7189259">err</span>&nbsp;<span class="op" id="7189263">:=</span>&nbsp;<span class="ident" id="7189266">db</span><span class="op" id="7189268">.</span><span class="ident" id="7189269">Prepare</span><span class="op" id="7189276">(</span><span class="string" id="7189277">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7189301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189304">if</span>&nbsp;<span class="ident" id="7189307">err</span>&nbsp;<span class="op" id="7189311">!=</span>&nbsp;<span class="builtintype" id="7189314">nil</span>&nbsp;<span class="op" id="7189318">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189322">t</span><span class="op" id="7189323">.</span><span class="ident" id="7189324">Fatalf</span><span class="op" id="7189330">(</span><span class="string" id="7189331">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7189351">,</span>&nbsp;<span class="ident" id="7189353">stmt</span><span class="op" id="7189357">,</span>&nbsp;<span class="ident" id="7189359">err</span><span class="op" id="7189362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189368">defer</span>&nbsp;<span class="ident" id="7189374">stmt</span><span class="op" id="7189378">.</span><span class="ident" id="7189379">Close</span><span class="op" id="7189384">(</span><span class="op" id="7189385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189388">tx</span><span class="op" id="7189390">,</span>&nbsp;<span class="ident" id="7189392">err</span>&nbsp;<span class="op" id="7189396">:=</span>&nbsp;<span class="ident" id="7189399">db</span><span class="op" id="7189401">.</span><span class="ident" id="7189402">Begin</span><span class="op" id="7189407">(</span><span class="op" id="7189408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189411">if</span>&nbsp;<span class="ident" id="7189414">err</span>&nbsp;<span class="op" id="7189418">!=</span>&nbsp;<span class="builtintype" id="7189421">nil</span>&nbsp;<span class="op" id="7189425">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189429">t</span><span class="op" id="7189430">.</span><span class="ident" id="7189431">Fatalf</span><span class="op" id="7189437">(</span><span class="string" id="7189438">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7189450">,</span>&nbsp;<span class="ident" id="7189452">err</span><span class="op" id="7189455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189461">txs</span>&nbsp;<span class="op" id="7189465">:=</span>&nbsp;<span class="ident" id="7189468">tx</span><span class="op" id="7189470">.</span><span class="ident" id="7189471">Stmt</span><span class="op" id="7189475">(</span><span class="ident" id="7189476">stmt</span><span class="op" id="7189480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189483">defer</span>&nbsp;<span class="ident" id="7189489">txs</span><span class="op" id="7189492">.</span><span class="ident" id="7189493">Close</span><span class="op" id="7189498">(</span><span class="op" id="7189499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189502">_</span><span class="op" id="7189503">,</span>&nbsp;<span class="ident" id="7189505">err</span>&nbsp;<span class="op" id="7189509">=</span>&nbsp;<span class="ident" id="7189511">txs</span><span class="op" id="7189514">.</span><span class="ident" id="7189515">Exec</span><span class="op" id="7189519">(</span><span class="string" id="7189520">&#34;Bobby&#34;</span><span class="op" id="7189527">,</span>&nbsp;<span class="num" id="7189529">7</span><span class="op" id="7189530">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189533">if</span>&nbsp;<span class="ident" id="7189536">err</span>&nbsp;<span class="op" id="7189540">!=</span>&nbsp;<span class="builtintype" id="7189543">nil</span>&nbsp;<span class="op" id="7189547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189551">t</span><span class="op" id="7189552">.</span><span class="ident" id="7189553">Fatalf</span><span class="op" id="7189559">(</span><span class="string" id="7189560">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7189571">,</span>&nbsp;<span class="ident" id="7189573">err</span><span class="op" id="7189576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189582">err</span>&nbsp;<span class="op" id="7189586">=</span>&nbsp;<span class="ident" id="7189588">tx</span><span class="op" id="7189590">.</span><span class="ident" id="7189591">Commit</span><span class="op" id="7189597">(</span><span class="op" id="7189598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189601">if</span>&nbsp;<span class="ident" id="7189604">err</span>&nbsp;<span class="op" id="7189608">!=</span>&nbsp;<span class="builtintype" id="7189611">nil</span>&nbsp;<span class="op" id="7189615">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189619">t</span><span class="op" id="7189620">.</span><span class="ident" id="7189621">Fatalf</span><span class="op" id="7189627">(</span><span class="string" id="7189628">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7189641">,</span>&nbsp;<span class="ident" id="7189643">err</span><span class="op" id="7189646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189649">}</span><br>
<span class="lineno"></span><span class="op" id="7189651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7189654">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="7189723">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="7189747">func</span>&nbsp;<span class="ident" id="7189752">TestIssue2542Deadlock</span><span class="op" id="7189773">(</span><span class="ident" id="7189774">t</span>&nbsp;<span class="op" id="7189776">*</span><span class="ident" id="7189777">testing</span><span class="op" id="7189784">.</span><span class="ident" id="7189785">T</span><span class="op" id="7189786">)</span>&nbsp;<span class="op" id="7189788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189791">db</span>&nbsp;<span class="op" id="7189794">:=</span>&nbsp;<span class="ident" id="7189797">newTestDB</span><span class="op" id="7189806">(</span><span class="ident" id="7189807">t</span><span class="op" id="7189808">,</span>&nbsp;<span class="string" id="7189810">&#34;people&#34;</span><span class="op" id="7189818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189821">closeDB</span><span class="op" id="7189828">(</span><span class="ident" id="7189829">t</span><span class="op" id="7189830">,</span>&nbsp;<span class="ident" id="7189832">db</span><span class="op" id="7189834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189837">for</span>&nbsp;<span class="ident" id="7189841">i</span>&nbsp;<span class="op" id="7189843">:=</span>&nbsp;<span class="num" id="7189846">0</span><span class="op" id="7189847">;</span>&nbsp;<span class="ident" id="7189849">i</span>&nbsp;<span class="op" id="7189851">&lt;</span>&nbsp;<span class="num" id="7189853">2</span><span class="op" id="7189854">;</span>&nbsp;<span class="ident" id="7189856">i</span><span class="op" id="7189857">++</span>&nbsp;<span class="op" id="7189860">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189864">_</span><span class="op" id="7189865">,</span>&nbsp;<span class="ident" id="7189867">err</span>&nbsp;<span class="op" id="7189871">:=</span>&nbsp;<span class="ident" id="7189874">db</span><span class="op" id="7189876">.</span><span class="ident" id="7189877">Query</span><span class="op" id="7189882">(</span><span class="string" id="7189883">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7189908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7189912">if</span>&nbsp;<span class="ident" id="7189915">err</span>&nbsp;<span class="op" id="7189919">==</span>&nbsp;<span class="builtintype" id="7189922">nil</span>&nbsp;<span class="op" id="7189926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7189931">t</span><span class="op" id="7189932">.</span><span class="ident" id="7189933">Fatalf</span><span class="op" id="7189939">(</span><span class="string" id="7189940">&#34;expected&nbsp;error&#34;</span><span class="op" id="7189956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7189963">}</span><br>
<span class="lineno">595</span><span class="op" id="7189965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7189968">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="7189998">func</span>&nbsp;<span class="ident" id="7190003">TestCloseStmtBeforeRows</span><span class="op" id="7190026">(</span><span class="ident" id="7190027">t</span>&nbsp;<span class="op" id="7190029">*</span><span class="ident" id="7190030">testing</span><span class="op" id="7190037">.</span><span class="ident" id="7190038">T</span><span class="op" id="7190039">)</span>&nbsp;<span class="op" id="7190041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190044">db</span>&nbsp;<span class="op" id="7190047">:=</span>&nbsp;<span class="ident" id="7190050">newTestDB</span><span class="op" id="7190059">(</span><span class="ident" id="7190060">t</span><span class="op" id="7190061">,</span>&nbsp;<span class="string" id="7190063">&#34;people&#34;</span><span class="op" id="7190071">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190074">defer</span>&nbsp;<span class="ident" id="7190080">closeDB</span><span class="op" id="7190087">(</span><span class="ident" id="7190088">t</span><span class="op" id="7190089">,</span>&nbsp;<span class="ident" id="7190091">db</span><span class="op" id="7190093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190097">s</span><span class="op" id="7190098">,</span>&nbsp;<span class="ident" id="7190100">err</span>&nbsp;<span class="op" id="7190104">:=</span>&nbsp;<span class="ident" id="7190107">db</span><span class="op" id="7190109">.</span><span class="ident" id="7190110">Prepare</span><span class="op" id="7190117">(</span><span class="string" id="7190118">&#34;SELECT|people|name|&#34;</span><span class="op" id="7190139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190142">if</span>&nbsp;<span class="ident" id="7190145">err</span>&nbsp;<span class="op" id="7190149">!=</span>&nbsp;<span class="builtintype" id="7190152">nil</span>&nbsp;<span class="op" id="7190156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190160">t</span><span class="op" id="7190161">.</span><span class="ident" id="7190162">Fatal</span><span class="op" id="7190167">(</span><span class="ident" id="7190168">err</span><span class="op" id="7190171">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7190174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190178">r</span><span class="op" id="7190179">,</span>&nbsp;<span class="ident" id="7190181">err</span>&nbsp;<span class="op" id="7190185">:=</span>&nbsp;<span class="ident" id="7190188">s</span><span class="op" id="7190189">.</span><span class="ident" id="7190190">Query</span><span class="op" id="7190195">(</span><span class="op" id="7190196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190199">if</span>&nbsp;<span class="ident" id="7190202">err</span>&nbsp;<span class="op" id="7190206">!=</span>&nbsp;<span class="builtintype" id="7190209">nil</span>&nbsp;<span class="op" id="7190213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190217">s</span><span class="op" id="7190218">.</span><span class="ident" id="7190219">Close</span><span class="op" id="7190224">(</span><span class="op" id="7190225">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190229">t</span><span class="op" id="7190230">.</span><span class="ident" id="7190231">Fatal</span><span class="op" id="7190236">(</span><span class="ident" id="7190237">err</span><span class="op" id="7190240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7190243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190247">err</span>&nbsp;<span class="op" id="7190251">=</span>&nbsp;<span class="ident" id="7190253">s</span><span class="op" id="7190254">.</span><span class="ident" id="7190255">Close</span><span class="op" id="7190260">(</span><span class="op" id="7190261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190264">if</span>&nbsp;<span class="ident" id="7190267">err</span>&nbsp;<span class="op" id="7190271">!=</span>&nbsp;<span class="builtintype" id="7190274">nil</span>&nbsp;<span class="op" id="7190278">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190282">t</span><span class="op" id="7190283">.</span><span class="ident" id="7190284">Fatal</span><span class="op" id="7190289">(</span><span class="ident" id="7190290">err</span><span class="op" id="7190293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7190296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190300">r</span><span class="op" id="7190301">.</span><span class="ident" id="7190302">Close</span><span class="op" id="7190307">(</span><span class="op" id="7190308">)</span><br>
<span class="lineno"></span><span class="op" id="7190310">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="7190313">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="7190378">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="7190413">func</span>&nbsp;<span class="ident" id="7190418">TestNullByteSlice</span><span class="op" id="7190435">(</span><span class="ident" id="7190436">t</span>&nbsp;<span class="op" id="7190438">*</span><span class="ident" id="7190439">testing</span><span class="op" id="7190446">.</span><span class="ident" id="7190447">T</span><span class="op" id="7190448">)</span>&nbsp;<span class="op" id="7190450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190453">db</span>&nbsp;<span class="op" id="7190456">:=</span>&nbsp;<span class="ident" id="7190459">newTestDB</span><span class="op" id="7190468">(</span><span class="ident" id="7190469">t</span><span class="op" id="7190470">,</span>&nbsp;<span class="string" id="7190472">&#34;&#34;</span><span class="op" id="7190474">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190477">defer</span>&nbsp;<span class="ident" id="7190483">closeDB</span><span class="op" id="7190490">(</span><span class="ident" id="7190491">t</span><span class="op" id="7190492">,</span>&nbsp;<span class="ident" id="7190494">db</span><span class="op" id="7190496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190499">exec</span><span class="op" id="7190503">(</span><span class="ident" id="7190504">t</span><span class="op" id="7190505">,</span>&nbsp;<span class="ident" id="7190507">db</span><span class="op" id="7190509">,</span>&nbsp;<span class="string" id="7190511">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7190546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190549">exec</span><span class="op" id="7190553">(</span><span class="ident" id="7190554">t</span><span class="op" id="7190555">,</span>&nbsp;<span class="ident" id="7190557">db</span><span class="op" id="7190559">,</span>&nbsp;<span class="string" id="7190561">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7190584">,</span>&nbsp;<span class="builtintype" id="7190586">nil</span><span class="op" id="7190589">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190593">var</span>&nbsp;<span class="ident" id="7190597">name</span>&nbsp;<span class="op" id="7190602">[</span><span class="op" id="7190603">]</span><span class="builtintype" id="7190604">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190611">err</span>&nbsp;<span class="op" id="7190615">:=</span>&nbsp;<span class="ident" id="7190618">db</span><span class="op" id="7190620">.</span><span class="ident" id="7190621">QueryRow</span><span class="op" id="7190629">(</span><span class="string" id="7190630">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7190650">,</span>&nbsp;<span class="num" id="7190652">10</span><span class="op" id="7190654">)</span><span class="op" id="7190655">.</span><span class="ident" id="7190656">Scan</span><span class="op" id="7190660">(</span><span class="op" id="7190661">&amp;</span><span class="ident" id="7190662">name</span><span class="op" id="7190666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190669">if</span>&nbsp;<span class="ident" id="7190672">err</span>&nbsp;<span class="op" id="7190676">!=</span>&nbsp;<span class="builtintype" id="7190679">nil</span>&nbsp;<span class="op" id="7190683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190687">t</span><span class="op" id="7190688">.</span><span class="ident" id="7190689">Fatal</span><span class="op" id="7190694">(</span><span class="ident" id="7190695">err</span><span class="op" id="7190698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7190701">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190704">if</span>&nbsp;<span class="ident" id="7190707">name</span>&nbsp;<span class="op" id="7190712">!=</span>&nbsp;<span class="builtintype" id="7190715">nil</span>&nbsp;<span class="op" id="7190719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190723">t</span><span class="op" id="7190724">.</span><span class="ident" id="7190725">Fatalf</span><span class="op" id="7190731">(</span><span class="string" id="7190732">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="7190791">,</span>&nbsp;<span class="ident" id="7190793">name</span><span class="op" id="7190797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7190800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190804">exec</span><span class="op" id="7190808">(</span><span class="ident" id="7190809">t</span><span class="op" id="7190810">,</span>&nbsp;<span class="ident" id="7190812">db</span><span class="op" id="7190814">,</span>&nbsp;<span class="string" id="7190816">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="7190839">,</span>&nbsp;<span class="string" id="7190841">&#34;bob&#34;</span><span class="op" id="7190846">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190849">err</span>&nbsp;<span class="op" id="7190853">=</span>&nbsp;<span class="ident" id="7190855">db</span><span class="op" id="7190857">.</span><span class="ident" id="7190858">QueryRow</span><span class="op" id="7190866">(</span><span class="string" id="7190867">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7190887">,</span>&nbsp;<span class="num" id="7190889">11</span><span class="op" id="7190891">)</span><span class="op" id="7190892">.</span><span class="ident" id="7190893">Scan</span><span class="op" id="7190897">(</span><span class="op" id="7190898">&amp;</span><span class="ident" id="7190899">name</span><span class="op" id="7190903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190906">if</span>&nbsp;<span class="ident" id="7190909">err</span>&nbsp;<span class="op" id="7190913">!=</span>&nbsp;<span class="builtintype" id="7190916">nil</span>&nbsp;<span class="op" id="7190920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190924">t</span><span class="op" id="7190925">.</span><span class="ident" id="7190926">Fatal</span><span class="op" id="7190931">(</span><span class="ident" id="7190932">err</span><span class="op" id="7190935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7190938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7190941">if</span>&nbsp;<span class="builtintype" id="7190944">string</span><span class="op" id="7190950">(</span><span class="ident" id="7190951">name</span><span class="op" id="7190955">)</span>&nbsp;<span class="op" id="7190957">!=</span>&nbsp;<span class="string" id="7190960">&#34;bob&#34;</span>&nbsp;<span class="op" id="7190966">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7190970">t</span><span class="op" id="7190971">.</span><span class="ident" id="7190972">Fatalf</span><span class="op" id="7190978">(</span><span class="string" id="7190979">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7191015">,</span>&nbsp;<span class="builtintype" id="7191017">string</span><span class="op" id="7191023">(</span><span class="ident" id="7191024">name</span><span class="op" id="7191028">)</span><span class="op" id="7191029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7191032">}</span><br>
<span class="lineno"></span><span class="op" id="7191034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7191037">func</span>&nbsp;<span class="ident" id="7191042">TestPointerParamsAndScans</span><span class="op" id="7191067">(</span><span class="ident" id="7191068">t</span>&nbsp;<span class="op" id="7191070">*</span><span class="ident" id="7191071">testing</span><span class="op" id="7191078">.</span><span class="ident" id="7191079">T</span><span class="op" id="7191080">)</span>&nbsp;<span class="op" id="7191082">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191085">db</span>&nbsp;<span class="op" id="7191088">:=</span>&nbsp;<span class="ident" id="7191091">newTestDB</span><span class="op" id="7191100">(</span><span class="ident" id="7191101">t</span><span class="op" id="7191102">,</span>&nbsp;<span class="string" id="7191104">&#34;&#34;</span><span class="op" id="7191106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191109">defer</span>&nbsp;<span class="ident" id="7191115">closeDB</span><span class="op" id="7191122">(</span><span class="ident" id="7191123">t</span><span class="op" id="7191124">,</span>&nbsp;<span class="ident" id="7191126">db</span><span class="op" id="7191128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191131">exec</span><span class="op" id="7191135">(</span><span class="ident" id="7191136">t</span><span class="op" id="7191137">,</span>&nbsp;<span class="ident" id="7191139">db</span><span class="op" id="7191141">,</span>&nbsp;<span class="string" id="7191143">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7191178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191182">bob</span>&nbsp;<span class="op" id="7191186">:=</span>&nbsp;<span class="string" id="7191189">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191196">var</span>&nbsp;<span class="ident" id="7191200">name</span>&nbsp;<span class="op" id="7191205">*</span><span class="builtintype" id="7191206">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191215">name</span>&nbsp;<span class="op" id="7191220">=</span>&nbsp;<span class="op" id="7191222">&amp;</span><span class="ident" id="7191223">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191228">exec</span><span class="op" id="7191232">(</span><span class="ident" id="7191233">t</span><span class="op" id="7191234">,</span>&nbsp;<span class="ident" id="7191236">db</span><span class="op" id="7191238">,</span>&nbsp;<span class="string" id="7191240">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7191263">,</span>&nbsp;<span class="ident" id="7191265">name</span><span class="op" id="7191269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191272">name</span>&nbsp;<span class="op" id="7191277">=</span>&nbsp;<span class="builtintype" id="7191279">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191284">exec</span><span class="op" id="7191288">(</span><span class="ident" id="7191289">t</span><span class="op" id="7191290">,</span>&nbsp;<span class="ident" id="7191292">db</span><span class="op" id="7191294">,</span>&nbsp;<span class="string" id="7191296">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="7191319">,</span>&nbsp;<span class="ident" id="7191321">name</span><span class="op" id="7191325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191329">err</span>&nbsp;<span class="op" id="7191333">:=</span>&nbsp;<span class="ident" id="7191336">db</span><span class="op" id="7191338">.</span><span class="ident" id="7191339">QueryRow</span><span class="op" id="7191347">(</span><span class="string" id="7191348">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7191368">,</span>&nbsp;<span class="num" id="7191370">10</span><span class="op" id="7191372">)</span><span class="op" id="7191373">.</span><span class="ident" id="7191374">Scan</span><span class="op" id="7191378">(</span><span class="op" id="7191379">&amp;</span><span class="ident" id="7191380">name</span><span class="op" id="7191384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191387">if</span>&nbsp;<span class="ident" id="7191390">err</span>&nbsp;<span class="op" id="7191394">!=</span>&nbsp;<span class="builtintype" id="7191397">nil</span>&nbsp;<span class="op" id="7191401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191405">t</span><span class="op" id="7191406">.</span><span class="ident" id="7191407">Fatalf</span><span class="op" id="7191413">(</span><span class="string" id="7191414">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="7191434">,</span>&nbsp;<span class="ident" id="7191436">err</span><span class="op" id="7191439">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7191442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191445">if</span>&nbsp;<span class="ident" id="7191448">name</span>&nbsp;<span class="op" id="7191453">==</span>&nbsp;<span class="builtintype" id="7191456">nil</span>&nbsp;<span class="op" id="7191460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191464">t</span><span class="op" id="7191465">.</span><span class="ident" id="7191466">Errorf</span><span class="op" id="7191472">(</span><span class="string" id="7191473">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7191503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7191506">}</span>&nbsp;<span class="keyword" id="7191508">else</span>&nbsp;<span class="keyword" id="7191513">if</span>&nbsp;<span class="op" id="7191516">*</span><span class="ident" id="7191517">name</span>&nbsp;<span class="op" id="7191522">!=</span>&nbsp;<span class="string" id="7191525">&#34;bob&#34;</span>&nbsp;<span class="op" id="7191531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191535">t</span><span class="op" id="7191536">.</span><span class="ident" id="7191537">Errorf</span><span class="op" id="7191543">(</span><span class="string" id="7191544">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7191573">,</span>&nbsp;<span class="op" id="7191575">*</span><span class="ident" id="7191576">name</span><span class="op" id="7191580">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7191583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191587">err</span>&nbsp;<span class="op" id="7191591">=</span>&nbsp;<span class="ident" id="7191593">db</span><span class="op" id="7191595">.</span><span class="ident" id="7191596">QueryRow</span><span class="op" id="7191604">(</span><span class="string" id="7191605">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7191625">,</span>&nbsp;<span class="num" id="7191627">20</span><span class="op" id="7191629">)</span><span class="op" id="7191630">.</span><span class="ident" id="7191631">Scan</span><span class="op" id="7191635">(</span><span class="op" id="7191636">&amp;</span><span class="ident" id="7191637">name</span><span class="op" id="7191641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191644">if</span>&nbsp;<span class="ident" id="7191647">err</span>&nbsp;<span class="op" id="7191651">!=</span>&nbsp;<span class="builtintype" id="7191654">nil</span>&nbsp;<span class="op" id="7191658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191662">t</span><span class="op" id="7191663">.</span><span class="ident" id="7191664">Fatalf</span><span class="op" id="7191670">(</span><span class="string" id="7191671">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="7191691">,</span>&nbsp;<span class="ident" id="7191693">err</span><span class="op" id="7191696">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7191699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191702">if</span>&nbsp;<span class="ident" id="7191705">name</span>&nbsp;<span class="op" id="7191710">!=</span>&nbsp;<span class="builtintype" id="7191713">nil</span>&nbsp;<span class="op" id="7191717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191721">t</span><span class="op" id="7191722">.</span><span class="ident" id="7191723">Errorf</span><span class="op" id="7191729">(</span><span class="string" id="7191730">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7191752">,</span>&nbsp;<span class="op" id="7191754">*</span><span class="ident" id="7191755">name</span><span class="op" id="7191759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7191762">}</span><br>
<span class="lineno"></span><span class="op" id="7191764">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="7191767">func</span>&nbsp;<span class="ident" id="7191772">TestQueryRowClosingStmt</span><span class="op" id="7191795">(</span><span class="ident" id="7191796">t</span>&nbsp;<span class="op" id="7191798">*</span><span class="ident" id="7191799">testing</span><span class="op" id="7191806">.</span><span class="ident" id="7191807">T</span><span class="op" id="7191808">)</span>&nbsp;<span class="op" id="7191810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191813">db</span>&nbsp;<span class="op" id="7191816">:=</span>&nbsp;<span class="ident" id="7191819">newTestDB</span><span class="op" id="7191828">(</span><span class="ident" id="7191829">t</span><span class="op" id="7191830">,</span>&nbsp;<span class="string" id="7191832">&#34;people&#34;</span><span class="op" id="7191840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191843">defer</span>&nbsp;<span class="ident" id="7191849">closeDB</span><span class="op" id="7191856">(</span><span class="ident" id="7191857">t</span><span class="op" id="7191858">,</span>&nbsp;<span class="ident" id="7191860">db</span><span class="op" id="7191862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191865">var</span>&nbsp;<span class="ident" id="7191869">name</span>&nbsp;<span class="builtintype" id="7191874">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191882">var</span>&nbsp;<span class="ident" id="7191886">age</span>&nbsp;<span class="builtintype" id="7191890">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191895">err</span>&nbsp;<span class="op" id="7191899">:=</span>&nbsp;<span class="ident" id="7191902">db</span><span class="op" id="7191904">.</span><span class="ident" id="7191905">QueryRow</span><span class="op" id="7191913">(</span><span class="string" id="7191914">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7191944">,</span>&nbsp;<span class="num" id="7191946">3</span><span class="op" id="7191947">)</span><span class="op" id="7191948">.</span><span class="ident" id="7191949">Scan</span><span class="op" id="7191953">(</span><span class="op" id="7191954">&amp;</span><span class="ident" id="7191955">age</span><span class="op" id="7191958">,</span>&nbsp;<span class="op" id="7191960">&amp;</span><span class="ident" id="7191961">name</span><span class="op" id="7191965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7191968">if</span>&nbsp;<span class="ident" id="7191971">err</span>&nbsp;<span class="op" id="7191975">!=</span>&nbsp;<span class="builtintype" id="7191978">nil</span>&nbsp;<span class="op" id="7191982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7191986">t</span><span class="op" id="7191987">.</span><span class="ident" id="7191988">Fatal</span><span class="op" id="7191993">(</span><span class="ident" id="7191994">err</span><span class="op" id="7191997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192000">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192003">if</span>&nbsp;<span class="builtinfunc" id="7192006">len</span><span class="op" id="7192009">(</span><span class="ident" id="7192010">db</span><span class="op" id="7192012">.</span><span class="ident" id="7192013">freeConn</span><span class="op" id="7192021">)</span>&nbsp;<span class="op" id="7192023">!=</span>&nbsp;<span class="num" id="7192026">1</span>&nbsp;<span class="op" id="7192028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192032">t</span><span class="op" id="7192033">.</span><span class="ident" id="7192034">Fatalf</span><span class="op" id="7192040">(</span><span class="string" id="7192041">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="7192063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192069">fakeConn</span>&nbsp;<span class="op" id="7192078">:=</span>&nbsp;<span class="ident" id="7192081">db</span><span class="op" id="7192083">.</span><span class="ident" id="7192084">freeConn</span><span class="op" id="7192092">[</span><span class="num" id="7192093">0</span><span class="op" id="7192094">]</span><span class="op" id="7192095">.</span><span class="ident" id="7192096">ci</span><span class="op" id="7192098">.</span><span class="op" id="7192099">(</span><span class="op" id="7192100">*</span><span class="ident" id="7192101">fakeConn</span><span class="op" id="7192109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192112">if</span>&nbsp;<span class="ident" id="7192115">made</span><span class="op" id="7192119">,</span>&nbsp;<span class="ident" id="7192121">closed</span>&nbsp;<span class="op" id="7192128">:=</span>&nbsp;<span class="ident" id="7192131">fakeConn</span><span class="op" id="7192139">.</span><span class="ident" id="7192140">stmtsMade</span><span class="op" id="7192149">,</span>&nbsp;<span class="ident" id="7192151">fakeConn</span><span class="op" id="7192159">.</span><span class="ident" id="7192160">stmtsClosed</span><span class="op" id="7192171">;</span>&nbsp;<span class="ident" id="7192173">made</span>&nbsp;<span class="op" id="7192178">!=</span>&nbsp;<span class="ident" id="7192181">closed</span>&nbsp;<span class="op" id="7192188">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192192">t</span><span class="op" id="7192193">.</span><span class="ident" id="7192194">Errorf</span><span class="op" id="7192200">(</span><span class="string" id="7192201">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="7192247">,</span>&nbsp;<span class="ident" id="7192249">made</span><span class="op" id="7192253">,</span>&nbsp;<span class="ident" id="7192255">closed</span><span class="op" id="7192261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192264">}</span><br>
<span class="lineno"></span><span class="op" id="7192266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7192269">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="7192288">func</span>&nbsp;<span class="ident" id="7192293">TestIssue6651</span><span class="op" id="7192306">(</span><span class="ident" id="7192307">t</span>&nbsp;<span class="op" id="7192309">*</span><span class="ident" id="7192310">testing</span><span class="op" id="7192317">.</span><span class="ident" id="7192318">T</span><span class="op" id="7192319">)</span>&nbsp;<span class="op" id="7192321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192324">db</span>&nbsp;<span class="op" id="7192327">:=</span>&nbsp;<span class="ident" id="7192330">newTestDB</span><span class="op" id="7192339">(</span><span class="ident" id="7192340">t</span><span class="op" id="7192341">,</span>&nbsp;<span class="string" id="7192343">&#34;people&#34;</span><span class="op" id="7192351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192354">defer</span>&nbsp;<span class="ident" id="7192360">closeDB</span><span class="op" id="7192367">(</span><span class="ident" id="7192368">t</span><span class="op" id="7192369">,</span>&nbsp;<span class="ident" id="7192371">db</span><span class="op" id="7192373">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192377">var</span>&nbsp;<span class="ident" id="7192381">v</span>&nbsp;<span class="builtintype" id="7192383">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192392">want</span>&nbsp;<span class="op" id="7192397">:=</span>&nbsp;<span class="string" id="7192400">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192422">rowsCursorNextHook</span>&nbsp;<span class="op" id="7192441">=</span>&nbsp;<span class="keyword" id="7192443">func</span><span class="op" id="7192447">(</span><span class="ident" id="7192448">dest</span>&nbsp;<span class="op" id="7192453">[</span><span class="op" id="7192454">]</span><span class="ident" id="7192455">driver</span><span class="op" id="7192461">.</span><span class="ident" id="7192462">Value</span><span class="op" id="7192467">)</span>&nbsp;<span class="builtintype" id="7192469">error</span>&nbsp;<span class="op" id="7192475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192479">return</span>&nbsp;<span class="ident" id="7192486">fmt</span><span class="op" id="7192489">.</span><span class="ident" id="7192490">Errorf</span><span class="op" id="7192496">(</span><span class="ident" id="7192497">want</span><span class="op" id="7192501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192504">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192507">defer</span>&nbsp;<span class="keyword" id="7192513">func</span><span class="op" id="7192517">(</span><span class="op" id="7192518">)</span>&nbsp;<span class="op" id="7192520">{</span>&nbsp;<span class="ident" id="7192522">rowsCursorNextHook</span>&nbsp;<span class="op" id="7192541">=</span>&nbsp;<span class="builtintype" id="7192543">nil</span>&nbsp;<span class="op" id="7192547">}</span><span class="op" id="7192548">(</span><span class="op" id="7192549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192552">err</span>&nbsp;<span class="op" id="7192556">:=</span>&nbsp;<span class="ident" id="7192559">db</span><span class="op" id="7192561">.</span><span class="ident" id="7192562">QueryRow</span><span class="op" id="7192570">(</span><span class="string" id="7192571">&#34;SELECT|people|name|&#34;</span><span class="op" id="7192592">)</span><span class="op" id="7192593">.</span><span class="ident" id="7192594">Scan</span><span class="op" id="7192598">(</span><span class="op" id="7192599">&amp;</span><span class="ident" id="7192600">v</span><span class="op" id="7192601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192604">if</span>&nbsp;<span class="ident" id="7192607">err</span>&nbsp;<span class="op" id="7192611">==</span>&nbsp;<span class="builtintype" id="7192614">nil</span>&nbsp;<span class="op" id="7192618">||</span>&nbsp;<span class="ident" id="7192621">err</span><span class="op" id="7192624">.</span><span class="ident" id="7192625">Error</span><span class="op" id="7192630">(</span><span class="op" id="7192631">)</span>&nbsp;<span class="op" id="7192633">!=</span>&nbsp;<span class="ident" id="7192636">want</span>&nbsp;<span class="op" id="7192641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192645">t</span><span class="op" id="7192646">.</span><span class="ident" id="7192647">Errorf</span><span class="op" id="7192653">(</span><span class="string" id="7192654">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7192675">,</span>&nbsp;<span class="ident" id="7192677">err</span><span class="op" id="7192680">,</span>&nbsp;<span class="ident" id="7192682">want</span><span class="op" id="7192686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192689">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192692">rowsCursorNextHook</span>&nbsp;<span class="op" id="7192711">=</span>&nbsp;<span class="builtintype" id="7192713">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192719">want</span>&nbsp;<span class="op" id="7192724">=</span>&nbsp;<span class="string" id="7192726">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192749">rowsCloseHook</span>&nbsp;<span class="op" id="7192763">=</span>&nbsp;<span class="keyword" id="7192765">func</span><span class="op" id="7192769">(</span><span class="ident" id="7192770">rows</span>&nbsp;<span class="op" id="7192775">*</span><span class="ident" id="7192776">Rows</span><span class="op" id="7192780">,</span>&nbsp;<span class="ident" id="7192782">err</span>&nbsp;<span class="op" id="7192786">*</span><span class="builtintype" id="7192787">error</span><span class="op" id="7192792">)</span>&nbsp;<span class="op" id="7192794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192798">*</span><span class="ident" id="7192799">err</span>&nbsp;<span class="op" id="7192803">=</span>&nbsp;<span class="ident" id="7192805">fmt</span><span class="op" id="7192808">.</span><span class="ident" id="7192809">Errorf</span><span class="op" id="7192815">(</span><span class="ident" id="7192816">want</span><span class="op" id="7192820">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7192823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192826">defer</span>&nbsp;<span class="keyword" id="7192832">func</span><span class="op" id="7192836">(</span><span class="op" id="7192837">)</span>&nbsp;<span class="op" id="7192839">{</span>&nbsp;<span class="ident" id="7192841">rowsCloseHook</span>&nbsp;<span class="op" id="7192855">=</span>&nbsp;<span class="builtintype" id="7192857">nil</span>&nbsp;<span class="op" id="7192861">}</span><span class="op" id="7192862">(</span><span class="op" id="7192863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192866">err</span>&nbsp;<span class="op" id="7192870">=</span>&nbsp;<span class="ident" id="7192872">db</span><span class="op" id="7192874">.</span><span class="ident" id="7192875">QueryRow</span><span class="op" id="7192883">(</span><span class="string" id="7192884">&#34;SELECT|people|name|&#34;</span><span class="op" id="7192905">)</span><span class="op" id="7192906">.</span><span class="ident" id="7192907">Scan</span><span class="op" id="7192911">(</span><span class="op" id="7192912">&amp;</span><span class="ident" id="7192913">v</span><span class="op" id="7192914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7192917">if</span>&nbsp;<span class="ident" id="7192920">err</span>&nbsp;<span class="op" id="7192924">==</span>&nbsp;<span class="builtintype" id="7192927">nil</span>&nbsp;<span class="op" id="7192931">||</span>&nbsp;<span class="ident" id="7192934">err</span><span class="op" id="7192937">.</span><span class="ident" id="7192938">Error</span><span class="op" id="7192943">(</span><span class="op" id="7192944">)</span>&nbsp;<span class="op" id="7192946">!=</span>&nbsp;<span class="ident" id="7192949">want</span>&nbsp;<span class="op" id="7192954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7192958">t</span><span class="op" id="7192959">.</span><span class="ident" id="7192960">Errorf</span><span class="op" id="7192966">(</span><span class="string" id="7192967">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7192988">,</span>&nbsp;<span class="ident" id="7192990">err</span><span class="op" id="7192993">,</span>&nbsp;<span class="ident" id="7192995">want</span><span class="op" id="7192999">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193002">}</span><br>
<span class="lineno"></span><span class="op" id="7193004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7193007">type</span>&nbsp;<span class="ident" id="7193012">nullTestRow</span>&nbsp;<span class="keyword" id="7193024">struct</span>&nbsp;<span class="op" id="7193031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193034">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7193047">interface</span><span class="op" id="7193056">{</span><span class="op" id="7193057">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193060">notNullParam</span>&nbsp;<span class="keyword" id="7193073">interface</span><span class="op" id="7193082">{</span><span class="op" id="7193083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193086">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="7193099">interface</span><span class="op" id="7193108">{</span><span class="op" id="7193109">}</span><br>
<span class="lineno"></span><span class="op" id="7193111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7193114">type</span>&nbsp;<span class="ident" id="7193119">nullTestSpec</span>&nbsp;<span class="keyword" id="7193132">struct</span>&nbsp;<span class="op" id="7193139">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193142">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7193154">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193162">notNullType</span>&nbsp;<span class="builtintype" id="7193174">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193182">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193194">[</span><span class="num" id="7193195">6</span><span class="op" id="7193196">]</span><span class="ident" id="7193197">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="7193209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="7193212">func</span>&nbsp;<span class="ident" id="7193217">TestNullStringParam</span><span class="op" id="7193236">(</span><span class="ident" id="7193237">t</span>&nbsp;<span class="op" id="7193239">*</span><span class="ident" id="7193240">testing</span><span class="op" id="7193247">.</span><span class="ident" id="7193248">T</span><span class="op" id="7193249">)</span>&nbsp;<span class="op" id="7193251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193254">spec</span>&nbsp;<span class="op" id="7193259">:=</span>&nbsp;<span class="ident" id="7193262">nullTestSpec</span><span class="op" id="7193274">{</span><span class="string" id="7193275">&#34;nullstring&#34;</span><span class="op" id="7193287">,</span>&nbsp;<span class="string" id="7193289">&#34;string&#34;</span><span class="op" id="7193297">,</span>&nbsp;<span class="op" id="7193299">[</span><span class="num" id="7193300">6</span><span class="op" id="7193301">]</span><span class="ident" id="7193302">nullTestRow</span><span class="op" id="7193313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193317">{</span><span class="ident" id="7193318">NullString</span><span class="op" id="7193328">{</span><span class="string" id="7193329">&#34;aqua&#34;</span><span class="op" id="7193335">,</span>&nbsp;<span class="builtintype" id="7193337">true</span><span class="op" id="7193341">}</span><span class="op" id="7193342">,</span>&nbsp;<span class="string" id="7193344">&#34;&#34;</span><span class="op" id="7193346">,</span>&nbsp;<span class="ident" id="7193348">NullString</span><span class="op" id="7193358">{</span><span class="string" id="7193359">&#34;aqua&#34;</span><span class="op" id="7193365">,</span>&nbsp;<span class="builtintype" id="7193367">true</span><span class="op" id="7193371">}</span><span class="op" id="7193372">}</span><span class="op" id="7193373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193377">{</span><span class="ident" id="7193378">NullString</span><span class="op" id="7193388">{</span><span class="string" id="7193389">&#34;brown&#34;</span><span class="op" id="7193396">,</span>&nbsp;<span class="builtintype" id="7193398">false</span><span class="op" id="7193403">}</span><span class="op" id="7193404">,</span>&nbsp;<span class="string" id="7193406">&#34;&#34;</span><span class="op" id="7193408">,</span>&nbsp;<span class="ident" id="7193410">NullString</span><span class="op" id="7193420">{</span><span class="string" id="7193421">&#34;&#34;</span><span class="op" id="7193423">,</span>&nbsp;<span class="builtintype" id="7193425">false</span><span class="op" id="7193430">}</span><span class="op" id="7193431">}</span><span class="op" id="7193432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193436">{</span><span class="string" id="7193437">&#34;chartreuse&#34;</span><span class="op" id="7193449">,</span>&nbsp;<span class="string" id="7193451">&#34;&#34;</span><span class="op" id="7193453">,</span>&nbsp;<span class="ident" id="7193455">NullString</span><span class="op" id="7193465">{</span><span class="string" id="7193466">&#34;chartreuse&#34;</span><span class="op" id="7193478">,</span>&nbsp;<span class="builtintype" id="7193480">true</span><span class="op" id="7193484">}</span><span class="op" id="7193485">}</span><span class="op" id="7193486">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193490">{</span><span class="ident" id="7193491">NullString</span><span class="op" id="7193501">{</span><span class="string" id="7193502">&#34;darkred&#34;</span><span class="op" id="7193511">,</span>&nbsp;<span class="builtintype" id="7193513">true</span><span class="op" id="7193517">}</span><span class="op" id="7193518">,</span>&nbsp;<span class="string" id="7193520">&#34;&#34;</span><span class="op" id="7193522">,</span>&nbsp;<span class="ident" id="7193524">NullString</span><span class="op" id="7193534">{</span><span class="string" id="7193535">&#34;darkred&#34;</span><span class="op" id="7193544">,</span>&nbsp;<span class="builtintype" id="7193546">true</span><span class="op" id="7193550">}</span><span class="op" id="7193551">}</span><span class="op" id="7193552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193556">{</span><span class="ident" id="7193557">NullString</span><span class="op" id="7193567">{</span><span class="string" id="7193568">&#34;eel&#34;</span><span class="op" id="7193573">,</span>&nbsp;<span class="builtintype" id="7193575">false</span><span class="op" id="7193580">}</span><span class="op" id="7193581">,</span>&nbsp;<span class="string" id="7193583">&#34;&#34;</span><span class="op" id="7193585">,</span>&nbsp;<span class="ident" id="7193587">NullString</span><span class="op" id="7193597">{</span><span class="string" id="7193598">&#34;&#34;</span><span class="op" id="7193600">,</span>&nbsp;<span class="builtintype" id="7193602">false</span><span class="op" id="7193607">}</span><span class="op" id="7193608">}</span><span class="op" id="7193609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193613">{</span><span class="string" id="7193614">&#34;foo&#34;</span><span class="op" id="7193619">,</span>&nbsp;<span class="ident" id="7193621">NullString</span><span class="op" id="7193631">{</span><span class="string" id="7193632">&#34;black&#34;</span><span class="op" id="7193639">,</span>&nbsp;<span class="builtintype" id="7193641">false</span><span class="op" id="7193646">}</span><span class="op" id="7193647">,</span>&nbsp;<span class="builtintype" id="7193649">nil</span><span class="op" id="7193652">}</span><span class="op" id="7193653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193656">}</span><span class="op" id="7193657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193660">nullTestRun</span><span class="op" id="7193671">(</span><span class="ident" id="7193672">t</span><span class="op" id="7193673">,</span>&nbsp;<span class="ident" id="7193675">spec</span><span class="op" id="7193679">)</span><br>
<span class="lineno">750</span><span class="op" id="7193681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7193684">func</span>&nbsp;<span class="ident" id="7193689">TestNullInt64Param</span><span class="op" id="7193707">(</span><span class="ident" id="7193708">t</span>&nbsp;<span class="op" id="7193710">*</span><span class="ident" id="7193711">testing</span><span class="op" id="7193718">.</span><span class="ident" id="7193719">T</span><span class="op" id="7193720">)</span>&nbsp;<span class="op" id="7193722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7193725">spec</span>&nbsp;<span class="op" id="7193730">:=</span>&nbsp;<span class="ident" id="7193733">nullTestSpec</span><span class="op" id="7193745">{</span><span class="string" id="7193746">&#34;nullint64&#34;</span><span class="op" id="7193757">,</span>&nbsp;<span class="string" id="7193759">&#34;int64&#34;</span><span class="op" id="7193766">,</span>&nbsp;<span class="op" id="7193768">[</span><span class="num" id="7193769">6</span><span class="op" id="7193770">]</span><span class="ident" id="7193771">nullTestRow</span><span class="op" id="7193782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193786">{</span><span class="ident" id="7193787">NullInt64</span><span class="op" id="7193796">{</span><span class="num" id="7193797">31</span><span class="op" id="7193799">,</span>&nbsp;<span class="builtintype" id="7193801">true</span><span class="op" id="7193805">}</span><span class="op" id="7193806">,</span>&nbsp;<span class="num" id="7193808">1</span><span class="op" id="7193809">,</span>&nbsp;<span class="ident" id="7193811">NullInt64</span><span class="op" id="7193820">{</span><span class="num" id="7193821">31</span><span class="op" id="7193823">,</span>&nbsp;<span class="builtintype" id="7193825">true</span><span class="op" id="7193829">}</span><span class="op" id="7193830">}</span><span class="op" id="7193831">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193835">{</span><span class="ident" id="7193836">NullInt64</span><span class="op" id="7193845">{</span><span class="op" id="7193846">-</span><span class="num" id="7193847">22</span><span class="op" id="7193849">,</span>&nbsp;<span class="builtintype" id="7193851">false</span><span class="op" id="7193856">}</span><span class="op" id="7193857">,</span>&nbsp;<span class="num" id="7193859">1</span><span class="op" id="7193860">,</span>&nbsp;<span class="ident" id="7193862">NullInt64</span><span class="op" id="7193871">{</span><span class="num" id="7193872">0</span><span class="op" id="7193873">,</span>&nbsp;<span class="builtintype" id="7193875">false</span><span class="op" id="7193880">}</span><span class="op" id="7193881">}</span><span class="op" id="7193882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193886">{</span><span class="num" id="7193887">22</span><span class="op" id="7193889">,</span>&nbsp;<span class="num" id="7193891">1</span><span class="op" id="7193892">,</span>&nbsp;<span class="ident" id="7193894">NullInt64</span><span class="op" id="7193903">{</span><span class="num" id="7193904">22</span><span class="op" id="7193906">,</span>&nbsp;<span class="builtintype" id="7193908">true</span><span class="op" id="7193912">}</span><span class="op" id="7193913">}</span><span class="op" id="7193914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193918">{</span><span class="ident" id="7193919">NullInt64</span><span class="op" id="7193928">{</span><span class="num" id="7193929">33</span><span class="op" id="7193931">,</span>&nbsp;<span class="builtintype" id="7193933">true</span><span class="op" id="7193937">}</span><span class="op" id="7193938">,</span>&nbsp;<span class="num" id="7193940">1</span><span class="op" id="7193941">,</span>&nbsp;<span class="ident" id="7193943">NullInt64</span><span class="op" id="7193952">{</span><span class="num" id="7193953">33</span><span class="op" id="7193955">,</span>&nbsp;<span class="builtintype" id="7193957">true</span><span class="op" id="7193961">}</span><span class="op" id="7193962">}</span><span class="op" id="7193963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7193967">{</span><span class="ident" id="7193968">NullInt64</span><span class="op" id="7193977">{</span><span class="num" id="7193978">222</span><span class="op" id="7193981">,</span>&nbsp;<span class="builtintype" id="7193983">false</span><span class="op" id="7193988">}</span><span class="op" id="7193989">,</span>&nbsp;<span class="num" id="7193991">1</span><span class="op" id="7193992">,</span>&nbsp;<span class="ident" id="7193994">NullInt64</span><span class="op" id="7194003">{</span><span class="num" id="7194004">0</span><span class="op" id="7194005">,</span>&nbsp;<span class="builtintype" id="7194007">false</span><span class="op" id="7194012">}</span><span class="op" id="7194013">}</span><span class="op" id="7194014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194018">{</span><span class="num" id="7194019">0</span><span class="op" id="7194020">,</span>&nbsp;<span class="ident" id="7194022">NullInt64</span><span class="op" id="7194031">{</span><span class="num" id="7194032">31</span><span class="op" id="7194034">,</span>&nbsp;<span class="builtintype" id="7194036">false</span><span class="op" id="7194041">}</span><span class="op" id="7194042">,</span>&nbsp;<span class="builtintype" id="7194044">nil</span><span class="op" id="7194047">}</span><span class="op" id="7194048">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194051">}</span><span class="op" id="7194052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7194055">nullTestRun</span><span class="op" id="7194066">(</span><span class="ident" id="7194067">t</span><span class="op" id="7194068">,</span>&nbsp;<span class="ident" id="7194070">spec</span><span class="op" id="7194074">)</span><br>
<span class="lineno"></span><span class="op" id="7194076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7194079">func</span>&nbsp;<span class="ident" id="7194084">TestNullFloat64Param</span><span class="op" id="7194104">(</span><span class="ident" id="7194105">t</span>&nbsp;<span class="op" id="7194107">*</span><span class="ident" id="7194108">testing</span><span class="op" id="7194115">.</span><span class="ident" id="7194116">T</span><span class="op" id="7194117">)</span>&nbsp;<span class="op" id="7194119">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7194122">spec</span>&nbsp;<span class="op" id="7194127">:=</span>&nbsp;<span class="ident" id="7194130">nullTestSpec</span><span class="op" id="7194142">{</span><span class="string" id="7194143">&#34;nullfloat64&#34;</span><span class="op" id="7194156">,</span>&nbsp;<span class="string" id="7194158">&#34;float64&#34;</span><span class="op" id="7194167">,</span>&nbsp;<span class="op" id="7194169">[</span><span class="num" id="7194170">6</span><span class="op" id="7194171">]</span><span class="ident" id="7194172">nullTestRow</span><span class="op" id="7194183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194187">{</span><span class="ident" id="7194188">NullFloat64</span><span class="op" id="7194199">{</span><span class="num" id="7194200">31.2</span><span class="op" id="7194204">,</span>&nbsp;<span class="builtintype" id="7194206">true</span><span class="op" id="7194210">}</span><span class="op" id="7194211">,</span>&nbsp;<span class="num" id="7194213">1</span><span class="op" id="7194214">,</span>&nbsp;<span class="ident" id="7194216">NullFloat64</span><span class="op" id="7194227">{</span><span class="num" id="7194228">31.2</span><span class="op" id="7194232">,</span>&nbsp;<span class="builtintype" id="7194234">true</span><span class="op" id="7194238">}</span><span class="op" id="7194239">}</span><span class="op" id="7194240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194244">{</span><span class="ident" id="7194245">NullFloat64</span><span class="op" id="7194256">{</span><span class="num" id="7194257">13.1</span><span class="op" id="7194261">,</span>&nbsp;<span class="builtintype" id="7194263">false</span><span class="op" id="7194268">}</span><span class="op" id="7194269">,</span>&nbsp;<span class="num" id="7194271">1</span><span class="op" id="7194272">,</span>&nbsp;<span class="ident" id="7194274">NullFloat64</span><span class="op" id="7194285">{</span><span class="num" id="7194286">0</span><span class="op" id="7194287">,</span>&nbsp;<span class="builtintype" id="7194289">false</span><span class="op" id="7194294">}</span><span class="op" id="7194295">}</span><span class="op" id="7194296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194300">{</span><span class="op" id="7194301">-</span><span class="num" id="7194302">22.9</span><span class="op" id="7194306">,</span>&nbsp;<span class="num" id="7194308">1</span><span class="op" id="7194309">,</span>&nbsp;<span class="ident" id="7194311">NullFloat64</span><span class="op" id="7194322">{</span><span class="op" id="7194323">-</span><span class="num" id="7194324">22.9</span><span class="op" id="7194328">,</span>&nbsp;<span class="builtintype" id="7194330">true</span><span class="op" id="7194334">}</span><span class="op" id="7194335">}</span><span class="op" id="7194336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194340">{</span><span class="ident" id="7194341">NullFloat64</span><span class="op" id="7194352">{</span><span class="num" id="7194353">33.81</span><span class="op" id="7194358">,</span>&nbsp;<span class="builtintype" id="7194360">true</span><span class="op" id="7194364">}</span><span class="op" id="7194365">,</span>&nbsp;<span class="num" id="7194367">1</span><span class="op" id="7194368">,</span>&nbsp;<span class="ident" id="7194370">NullFloat64</span><span class="op" id="7194381">{</span><span class="num" id="7194382">33.81</span><span class="op" id="7194387">,</span>&nbsp;<span class="builtintype" id="7194389">true</span><span class="op" id="7194393">}</span><span class="op" id="7194394">}</span><span class="op" id="7194395">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194399">{</span><span class="ident" id="7194400">NullFloat64</span><span class="op" id="7194411">{</span><span class="num" id="7194412">222</span><span class="op" id="7194415">,</span>&nbsp;<span class="builtintype" id="7194417">false</span><span class="op" id="7194422">}</span><span class="op" id="7194423">,</span>&nbsp;<span class="num" id="7194425">1</span><span class="op" id="7194426">,</span>&nbsp;<span class="ident" id="7194428">NullFloat64</span><span class="op" id="7194439">{</span><span class="num" id="7194440">0</span><span class="op" id="7194441">,</span>&nbsp;<span class="builtintype" id="7194443">false</span><span class="op" id="7194448">}</span><span class="op" id="7194449">}</span><span class="op" id="7194450">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194454">{</span><span class="num" id="7194455">10</span><span class="op" id="7194457">,</span>&nbsp;<span class="ident" id="7194459">NullFloat64</span><span class="op" id="7194470">{</span><span class="num" id="7194471">31.2</span><span class="op" id="7194475">,</span>&nbsp;<span class="builtintype" id="7194477">false</span><span class="op" id="7194482">}</span><span class="op" id="7194483">,</span>&nbsp;<span class="builtintype" id="7194485">nil</span><span class="op" id="7194488">}</span><span class="op" id="7194489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194492">}</span><span class="op" id="7194493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7194496">nullTestRun</span><span class="op" id="7194507">(</span><span class="ident" id="7194508">t</span><span class="op" id="7194509">,</span>&nbsp;<span class="ident" id="7194511">spec</span><span class="op" id="7194515">)</span><br>
<span class="lineno"></span><span class="op" id="7194517">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="7194520">func</span>&nbsp;<span class="ident" id="7194525">TestNullBoolParam</span><span class="op" id="7194542">(</span><span class="ident" id="7194543">t</span>&nbsp;<span class="op" id="7194545">*</span><span class="ident" id="7194546">testing</span><span class="op" id="7194553">.</span><span class="ident" id="7194554">T</span><span class="op" id="7194555">)</span>&nbsp;<span class="op" id="7194557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7194560">spec</span>&nbsp;<span class="op" id="7194565">:=</span>&nbsp;<span class="ident" id="7194568">nullTestSpec</span><span class="op" id="7194580">{</span><span class="string" id="7194581">&#34;nullbool&#34;</span><span class="op" id="7194591">,</span>&nbsp;<span class="string" id="7194593">&#34;bool&#34;</span><span class="op" id="7194599">,</span>&nbsp;<span class="op" id="7194601">[</span><span class="num" id="7194602">6</span><span class="op" id="7194603">]</span><span class="ident" id="7194604">nullTestRow</span><span class="op" id="7194615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194619">{</span><span class="ident" id="7194620">NullBool</span><span class="op" id="7194628">{</span><span class="builtintype" id="7194629">false</span><span class="op" id="7194634">,</span>&nbsp;<span class="builtintype" id="7194636">true</span><span class="op" id="7194640">}</span><span class="op" id="7194641">,</span>&nbsp;<span class="builtintype" id="7194643">true</span><span class="op" id="7194647">,</span>&nbsp;<span class="ident" id="7194649">NullBool</span><span class="op" id="7194657">{</span><span class="builtintype" id="7194658">false</span><span class="op" id="7194663">,</span>&nbsp;<span class="builtintype" id="7194665">true</span><span class="op" id="7194669">}</span><span class="op" id="7194670">}</span><span class="op" id="7194671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194675">{</span><span class="ident" id="7194676">NullBool</span><span class="op" id="7194684">{</span><span class="builtintype" id="7194685">true</span><span class="op" id="7194689">,</span>&nbsp;<span class="builtintype" id="7194691">false</span><span class="op" id="7194696">}</span><span class="op" id="7194697">,</span>&nbsp;<span class="builtintype" id="7194699">false</span><span class="op" id="7194704">,</span>&nbsp;<span class="ident" id="7194706">NullBool</span><span class="op" id="7194714">{</span><span class="builtintype" id="7194715">false</span><span class="op" id="7194720">,</span>&nbsp;<span class="builtintype" id="7194722">false</span><span class="op" id="7194727">}</span><span class="op" id="7194728">}</span><span class="op" id="7194729">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194733">{</span><span class="builtintype" id="7194734">true</span><span class="op" id="7194738">,</span>&nbsp;<span class="builtintype" id="7194740">true</span><span class="op" id="7194744">,</span>&nbsp;<span class="ident" id="7194746">NullBool</span><span class="op" id="7194754">{</span><span class="builtintype" id="7194755">true</span><span class="op" id="7194759">,</span>&nbsp;<span class="builtintype" id="7194761">true</span><span class="op" id="7194765">}</span><span class="op" id="7194766">}</span><span class="op" id="7194767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194771">{</span><span class="ident" id="7194772">NullBool</span><span class="op" id="7194780">{</span><span class="builtintype" id="7194781">true</span><span class="op" id="7194785">,</span>&nbsp;<span class="builtintype" id="7194787">true</span><span class="op" id="7194791">}</span><span class="op" id="7194792">,</span>&nbsp;<span class="builtintype" id="7194794">false</span><span class="op" id="7194799">,</span>&nbsp;<span class="ident" id="7194801">NullBool</span><span class="op" id="7194809">{</span><span class="builtintype" id="7194810">true</span><span class="op" id="7194814">,</span>&nbsp;<span class="builtintype" id="7194816">true</span><span class="op" id="7194820">}</span><span class="op" id="7194821">}</span><span class="op" id="7194822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194826">{</span><span class="ident" id="7194827">NullBool</span><span class="op" id="7194835">{</span><span class="builtintype" id="7194836">true</span><span class="op" id="7194840">,</span>&nbsp;<span class="builtintype" id="7194842">false</span><span class="op" id="7194847">}</span><span class="op" id="7194848">,</span>&nbsp;<span class="builtintype" id="7194850">true</span><span class="op" id="7194854">,</span>&nbsp;<span class="ident" id="7194856">NullBool</span><span class="op" id="7194864">{</span><span class="builtintype" id="7194865">false</span><span class="op" id="7194870">,</span>&nbsp;<span class="builtintype" id="7194872">false</span><span class="op" id="7194877">}</span><span class="op" id="7194878">}</span><span class="op" id="7194879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194883">{</span><span class="builtintype" id="7194884">true</span><span class="op" id="7194888">,</span>&nbsp;<span class="ident" id="7194890">NullBool</span><span class="op" id="7194898">{</span><span class="builtintype" id="7194899">true</span><span class="op" id="7194903">,</span>&nbsp;<span class="builtintype" id="7194905">false</span><span class="op" id="7194910">}</span><span class="op" id="7194911">,</span>&nbsp;<span class="builtintype" id="7194913">nil</span><span class="op" id="7194916">}</span><span class="op" id="7194917">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7194920">}</span><span class="op" id="7194921">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7194924">nullTestRun</span><span class="op" id="7194935">(</span><span class="ident" id="7194936">t</span><span class="op" id="7194937">,</span>&nbsp;<span class="ident" id="7194939">spec</span><span class="op" id="7194943">)</span><br>
<span class="lineno"></span><span class="op" id="7194945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7194948">func</span>&nbsp;<span class="ident" id="7194953">nullTestRun</span><span class="op" id="7194964">(</span><span class="ident" id="7194965">t</span>&nbsp;<span class="op" id="7194967">*</span><span class="ident" id="7194968">testing</span><span class="op" id="7194975">.</span><span class="ident" id="7194976">T</span><span class="op" id="7194977">,</span>&nbsp;<span class="ident" id="7194979">spec</span>&nbsp;<span class="ident" id="7194984">nullTestSpec</span><span class="op" id="7194996">)</span>&nbsp;<span class="op" id="7194998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195001">db</span>&nbsp;<span class="op" id="7195004">:=</span>&nbsp;<span class="ident" id="7195007">newTestDB</span><span class="op" id="7195016">(</span><span class="ident" id="7195017">t</span><span class="op" id="7195018">,</span>&nbsp;<span class="string" id="7195020">&#34;&#34;</span><span class="op" id="7195022">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7195025">defer</span>&nbsp;<span class="ident" id="7195031">closeDB</span><span class="op" id="7195038">(</span><span class="ident" id="7195039">t</span><span class="op" id="7195040">,</span>&nbsp;<span class="ident" id="7195042">db</span><span class="op" id="7195044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195047">exec</span><span class="op" id="7195051">(</span><span class="ident" id="7195052">t</span><span class="op" id="7195053">,</span>&nbsp;<span class="ident" id="7195055">db</span><span class="op" id="7195057">,</span>&nbsp;<span class="ident" id="7195059">fmt</span><span class="op" id="7195062">.</span><span class="ident" id="7195063">Sprintf</span><span class="op" id="7195070">(</span><span class="string" id="7195071">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="7195123">,</span>&nbsp;<span class="ident" id="7195125">spec</span><span class="op" id="7195129">.</span><span class="ident" id="7195130">nullType</span><span class="op" id="7195138">,</span>&nbsp;<span class="ident" id="7195140">spec</span><span class="op" id="7195144">.</span><span class="ident" id="7195145">notNullType</span><span class="op" id="7195156">)</span><span class="op" id="7195157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7195161">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195187">exec</span><span class="op" id="7195191">(</span><span class="ident" id="7195192">t</span><span class="op" id="7195193">,</span>&nbsp;<span class="ident" id="7195195">db</span><span class="op" id="7195197">,</span>&nbsp;<span class="string" id="7195199">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7195240">,</span>&nbsp;<span class="num" id="7195242">1</span><span class="op" id="7195243">,</span>&nbsp;<span class="string" id="7195245">&#34;alice&#34;</span><span class="op" id="7195252">,</span>&nbsp;<span class="ident" id="7195254">spec</span><span class="op" id="7195258">.</span><span class="ident" id="7195259">rows</span><span class="op" id="7195263">[</span><span class="num" id="7195264">0</span><span class="op" id="7195265">]</span><span class="op" id="7195266">.</span><span class="ident" id="7195267">nullParam</span><span class="op" id="7195276">,</span>&nbsp;<span class="ident" id="7195278">spec</span><span class="op" id="7195282">.</span><span class="ident" id="7195283">rows</span><span class="op" id="7195287">[</span><span class="num" id="7195288">0</span><span class="op" id="7195289">]</span><span class="op" id="7195290">.</span><span class="ident" id="7195291">notNullParam</span><span class="op" id="7195303">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195306">exec</span><span class="op" id="7195310">(</span><span class="ident" id="7195311">t</span><span class="op" id="7195312">,</span>&nbsp;<span class="ident" id="7195314">db</span><span class="op" id="7195316">,</span>&nbsp;<span class="string" id="7195318">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7195359">,</span>&nbsp;<span class="num" id="7195361">2</span><span class="op" id="7195362">,</span>&nbsp;<span class="string" id="7195364">&#34;bob&#34;</span><span class="op" id="7195369">,</span>&nbsp;<span class="ident" id="7195371">spec</span><span class="op" id="7195375">.</span><span class="ident" id="7195376">rows</span><span class="op" id="7195380">[</span><span class="num" id="7195381">1</span><span class="op" id="7195382">]</span><span class="op" id="7195383">.</span><span class="ident" id="7195384">nullParam</span><span class="op" id="7195393">,</span>&nbsp;<span class="ident" id="7195395">spec</span><span class="op" id="7195399">.</span><span class="ident" id="7195400">rows</span><span class="op" id="7195404">[</span><span class="num" id="7195405">1</span><span class="op" id="7195406">]</span><span class="op" id="7195407">.</span><span class="ident" id="7195408">notNullParam</span><span class="op" id="7195420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7195424">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195463">stmt</span><span class="op" id="7195467">,</span>&nbsp;<span class="ident" id="7195469">err</span>&nbsp;<span class="op" id="7195473">:=</span>&nbsp;<span class="ident" id="7195476">db</span><span class="op" id="7195478">.</span><span class="ident" id="7195479">Prepare</span><span class="op" id="7195486">(</span><span class="string" id="7195487">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7195528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7195531">if</span>&nbsp;<span class="ident" id="7195534">err</span>&nbsp;<span class="op" id="7195538">!=</span>&nbsp;<span class="builtintype" id="7195541">nil</span>&nbsp;<span class="op" id="7195545">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195549">t</span><span class="op" id="7195550">.</span><span class="ident" id="7195551">Fatalf</span><span class="op" id="7195557">(</span><span class="string" id="7195558">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7195571">,</span>&nbsp;<span class="ident" id="7195573">err</span><span class="op" id="7195576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7195579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7195582">defer</span>&nbsp;<span class="ident" id="7195588">stmt</span><span class="op" id="7195592">.</span><span class="ident" id="7195593">Close</span><span class="op" id="7195598">(</span><span class="op" id="7195599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7195602">if</span>&nbsp;<span class="ident" id="7195605">_</span><span class="op" id="7195606">,</span>&nbsp;<span class="ident" id="7195608">err</span>&nbsp;<span class="op" id="7195612">:=</span>&nbsp;<span class="ident" id="7195615">stmt</span><span class="op" id="7195619">.</span><span class="ident" id="7195620">Exec</span><span class="op" id="7195624">(</span><span class="num" id="7195625">3</span><span class="op" id="7195626">,</span>&nbsp;<span class="string" id="7195628">&#34;chris&#34;</span><span class="op" id="7195635">,</span>&nbsp;<span class="ident" id="7195637">spec</span><span class="op" id="7195641">.</span><span class="ident" id="7195642">rows</span><span class="op" id="7195646">[</span><span class="num" id="7195647">2</span><span class="op" id="7195648">]</span><span class="op" id="7195649">.</span><span class="ident" id="7195650">nullParam</span><span class="op" id="7195659">,</span>&nbsp;<span class="ident" id="7195661">spec</span><span class="op" id="7195665">.</span><span class="ident" id="7195666">rows</span><span class="op" id="7195670">[</span><span class="num" id="7195671">2</span><span class="op" id="7195672">]</span><span class="op" id="7195673">.</span><span class="ident" id="7195674">notNullParam</span><span class="op" id="7195686">)</span><span class="op" id="7195687">;</span>&nbsp;<span class="ident" id="7195689">err</span>&nbsp;<span class="op" id="7195693">!=</span>&nbsp;<span class="builtintype" id="7195696">nil</span>&nbsp;<span class="op" id="7195700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195704">t</span><span class="op" id="7195705">.</span><span class="ident" id="7195706">Errorf</span><span class="op" id="7195712">(</span><span class="string" id="7195713">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="7195736">,</span>&nbsp;<span class="ident" id="7195738">err</span><span class="op" id="7195741">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7195744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7195747">if</span>&nbsp;<span class="ident" id="7195750">_</span><span class="op" id="7195751">,</span>&nbsp;<span class="ident" id="7195753">err</span>&nbsp;<span class="op" id="7195757">:=</span>&nbsp;<span class="ident" id="7195760">stmt</span><span class="op" id="7195764">.</span><span class="ident" id="7195765">Exec</span><span class="op" id="7195769">(</span><span class="num" id="7195770">4</span><span class="op" id="7195771">,</span>&nbsp;<span class="string" id="7195773">&#34;dave&#34;</span><span class="op" id="7195779">,</span>&nbsp;<span class="ident" id="7195781">spec</span><span class="op" id="7195785">.</span><span class="ident" id="7195786">rows</span><span class="op" id="7195790">[</span><span class="num" id="7195791">3</span><span class="op" id="7195792">]</span><span class="op" id="7195793">.</span><span class="ident" id="7195794">nullParam</span><span class="op" id="7195803">,</span>&nbsp;<span class="ident" id="7195805">spec</span><span class="op" id="7195809">.</span><span class="ident" id="7195810">rows</span><span class="op" id="7195814">[</span><span class="num" id="7195815">3</span><span class="op" id="7195816">]</span><span class="op" id="7195817">.</span><span class="ident" id="7195818">notNullParam</span><span class="op" id="7195830">)</span><span class="op" id="7195831">;</span>&nbsp;<span class="ident" id="7195833">err</span>&nbsp;<span class="op" id="7195837">!=</span>&nbsp;<span class="builtintype" id="7195840">nil</span>&nbsp;<span class="op" id="7195844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195848">t</span><span class="op" id="7195849">.</span><span class="ident" id="7195850">Errorf</span><span class="op" id="7195856">(</span><span class="string" id="7195857">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="7195879">,</span>&nbsp;<span class="ident" id="7195881">err</span><span class="op" id="7195884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7195887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7195890">if</span>&nbsp;<span class="ident" id="7195893">_</span><span class="op" id="7195894">,</span>&nbsp;<span class="ident" id="7195896">err</span>&nbsp;<span class="op" id="7195900">:=</span>&nbsp;<span class="ident" id="7195903">stmt</span><span class="op" id="7195907">.</span><span class="ident" id="7195908">Exec</span><span class="op" id="7195912">(</span><span class="num" id="7195913">5</span><span class="op" id="7195914">,</span>&nbsp;<span class="string" id="7195916">&#34;eleanor&#34;</span><span class="op" id="7195925">,</span>&nbsp;<span class="ident" id="7195927">spec</span><span class="op" id="7195931">.</span><span class="ident" id="7195932">rows</span><span class="op" id="7195936">[</span><span class="num" id="7195937">4</span><span class="op" id="7195938">]</span><span class="op" id="7195939">.</span><span class="ident" id="7195940">nullParam</span><span class="op" id="7195949">,</span>&nbsp;<span class="ident" id="7195951">spec</span><span class="op" id="7195955">.</span><span class="ident" id="7195956">rows</span><span class="op" id="7195960">[</span><span class="num" id="7195961">4</span><span class="op" id="7195962">]</span><span class="op" id="7195963">.</span><span class="ident" id="7195964">notNullParam</span><span class="op" id="7195976">)</span><span class="op" id="7195977">;</span>&nbsp;<span class="ident" id="7195979">err</span>&nbsp;<span class="op" id="7195983">!=</span>&nbsp;<span class="builtintype" id="7195986">nil</span>&nbsp;<span class="op" id="7195990">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7195994">t</span><span class="op" id="7195995">.</span><span class="ident" id="7195996">Errorf</span><span class="op" id="7196002">(</span><span class="string" id="7196003">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="7196028">,</span>&nbsp;<span class="ident" id="7196030">err</span><span class="op" id="7196033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7196036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196040">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7196081">if</span>&nbsp;<span class="ident" id="7196084">_</span><span class="op" id="7196085">,</span>&nbsp;<span class="ident" id="7196087">err</span>&nbsp;<span class="op" id="7196091">:=</span>&nbsp;<span class="ident" id="7196094">stmt</span><span class="op" id="7196098">.</span><span class="ident" id="7196099">Exec</span><span class="op" id="7196103">(</span><span class="num" id="7196104">6</span><span class="op" id="7196105">,</span>&nbsp;<span class="string" id="7196107">&#34;bob&#34;</span><span class="op" id="7196112">,</span>&nbsp;<span class="ident" id="7196114">spec</span><span class="op" id="7196118">.</span><span class="ident" id="7196119">rows</span><span class="op" id="7196123">[</span><span class="num" id="7196124">5</span><span class="op" id="7196125">]</span><span class="op" id="7196126">.</span><span class="ident" id="7196127">nullParam</span><span class="op" id="7196136">,</span>&nbsp;<span class="ident" id="7196138">spec</span><span class="op" id="7196142">.</span><span class="ident" id="7196143">rows</span><span class="op" id="7196147">[</span><span class="num" id="7196148">5</span><span class="op" id="7196149">]</span><span class="op" id="7196150">.</span><span class="ident" id="7196151">notNullParam</span><span class="op" id="7196163">)</span><span class="op" id="7196164">;</span>&nbsp;<span class="ident" id="7196166">err</span>&nbsp;<span class="op" id="7196170">==</span>&nbsp;<span class="builtintype" id="7196173">nil</span>&nbsp;<span class="op" id="7196177">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196181">t</span><span class="op" id="7196182">.</span><span class="ident" id="7196183">Errorf</span><span class="op" id="7196189">(</span><span class="string" id="7196190">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="7196253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7196256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196260">_</span><span class="op" id="7196261">,</span>&nbsp;<span class="ident" id="7196263">err</span>&nbsp;<span class="op" id="7196267">=</span>&nbsp;<span class="ident" id="7196269">db</span><span class="op" id="7196271">.</span><span class="ident" id="7196272">Exec</span><span class="op" id="7196276">(</span><span class="string" id="7196277">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="7196307">,</span>&nbsp;<span class="num" id="7196309">999</span><span class="op" id="7196312">,</span>&nbsp;<span class="builtintype" id="7196314">nil</span><span class="op" id="7196317">,</span>&nbsp;<span class="builtintype" id="7196319">nil</span><span class="op" id="7196322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7196325">if</span>&nbsp;<span class="ident" id="7196328">err</span>&nbsp;<span class="op" id="7196332">==</span>&nbsp;<span class="builtintype" id="7196335">nil</span>&nbsp;<span class="op" id="7196339">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196343">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196393">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196449">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196501">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196549">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7196593">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7196653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196657">paramtype</span>&nbsp;<span class="op" id="7196667">:=</span>&nbsp;<span class="ident" id="7196670">reflect</span><span class="op" id="7196677">.</span><span class="ident" id="7196678">TypeOf</span><span class="op" id="7196684">(</span><span class="ident" id="7196685">spec</span><span class="op" id="7196689">.</span><span class="ident" id="7196690">rows</span><span class="op" id="7196694">[</span><span class="num" id="7196695">0</span><span class="op" id="7196696">]</span><span class="op" id="7196697">.</span><span class="ident" id="7196698">nullParam</span><span class="op" id="7196707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196710">bindVal</span>&nbsp;<span class="op" id="7196718">:=</span>&nbsp;<span class="ident" id="7196721">reflect</span><span class="op" id="7196728">.</span><span class="ident" id="7196729">New</span><span class="op" id="7196732">(</span><span class="ident" id="7196733">paramtype</span><span class="op" id="7196742">)</span><span class="op" id="7196743">.</span><span class="ident" id="7196744">Interface</span><span class="op" id="7196753">(</span><span class="op" id="7196754">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7196758">for</span>&nbsp;<span class="ident" id="7196762">i</span>&nbsp;<span class="op" id="7196764">:=</span>&nbsp;<span class="num" id="7196767">0</span><span class="op" id="7196768">;</span>&nbsp;<span class="ident" id="7196770">i</span>&nbsp;<span class="op" id="7196772">&lt;</span>&nbsp;<span class="num" id="7196774">5</span><span class="op" id="7196775">;</span>&nbsp;<span class="ident" id="7196777">i</span><span class="op" id="7196778">++</span>&nbsp;<span class="op" id="7196781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196785">id</span>&nbsp;<span class="op" id="7196788">:=</span>&nbsp;<span class="ident" id="7196791">i</span>&nbsp;<span class="op" id="7196793">+</span>&nbsp;<span class="num" id="7196795">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7196799">if</span>&nbsp;<span class="ident" id="7196802">err</span>&nbsp;<span class="op" id="7196806">:=</span>&nbsp;<span class="ident" id="7196809">db</span><span class="op" id="7196811">.</span><span class="ident" id="7196812">QueryRow</span><span class="op" id="7196820">(</span><span class="string" id="7196821">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="7196842">,</span>&nbsp;<span class="ident" id="7196844">id</span><span class="op" id="7196846">)</span><span class="op" id="7196847">.</span><span class="ident" id="7196848">Scan</span><span class="op" id="7196852">(</span><span class="ident" id="7196853">bindVal</span><span class="op" id="7196860">)</span><span class="op" id="7196861">;</span>&nbsp;<span class="ident" id="7196863">err</span>&nbsp;<span class="op" id="7196867">!=</span>&nbsp;<span class="builtintype" id="7196870">nil</span>&nbsp;<span class="op" id="7196874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196879">t</span><span class="op" id="7196880">.</span><span class="ident" id="7196881">Errorf</span><span class="op" id="7196887">(</span><span class="string" id="7196888">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="7196904">,</span>&nbsp;<span class="ident" id="7196906">id</span><span class="op" id="7196908">,</span>&nbsp;<span class="ident" id="7196910">err</span><span class="op" id="7196913">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7196917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7196921">bindValDeref</span>&nbsp;<span class="op" id="7196934">:=</span>&nbsp;<span class="ident" id="7196937">reflect</span><span class="op" id="7196944">.</span><span class="ident" id="7196945">ValueOf</span><span class="op" id="7196952">(</span><span class="ident" id="7196953">bindVal</span><span class="op" id="7196960">)</span><span class="op" id="7196961">.</span><span class="ident" id="7196962">Elem</span><span class="op" id="7196966">(</span><span class="op" id="7196967">)</span><span class="op" id="7196968">.</span><span class="ident" id="7196969">Interface</span><span class="op" id="7196978">(</span><span class="op" id="7196979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7196983">if</span>&nbsp;<span class="op" id="7196986">!</span><span class="ident" id="7196987">reflect</span><span class="op" id="7196994">.</span><span class="ident" id="7196995">DeepEqual</span><span class="op" id="7197004">(</span><span class="ident" id="7197005">bindValDeref</span><span class="op" id="7197017">,</span>&nbsp;<span class="ident" id="7197019">spec</span><span class="op" id="7197023">.</span><span class="ident" id="7197024">rows</span><span class="op" id="7197028">[</span><span class="ident" id="7197029">i</span><span class="op" id="7197030">]</span><span class="op" id="7197031">.</span><span class="ident" id="7197032">scanNullVal</span><span class="op" id="7197043">)</span>&nbsp;<span class="op" id="7197045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197050">t</span><span class="op" id="7197051">.</span><span class="ident" id="7197052">Errorf</span><span class="op" id="7197058">(</span><span class="string" id="7197059">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7197084">,</span>&nbsp;<span class="ident" id="7197086">id</span><span class="op" id="7197088">,</span>&nbsp;<span class="ident" id="7197090">bindValDeref</span><span class="op" id="7197102">,</span>&nbsp;<span class="ident" id="7197104">spec</span><span class="op" id="7197108">.</span><span class="ident" id="7197109">rows</span><span class="op" id="7197113">[</span><span class="ident" id="7197114">i</span><span class="op" id="7197115">]</span><span class="op" id="7197116">.</span><span class="ident" id="7197117">scanNullVal</span><span class="op" id="7197128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7197132">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7197135">}</span><br>
<span class="lineno"></span><span class="op" id="7197137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7197140">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="7197165">func</span>&nbsp;<span class="ident" id="7197170">TestQueryRowNilScanDest</span><span class="op" id="7197193">(</span><span class="ident" id="7197194">t</span>&nbsp;<span class="op" id="7197196">*</span><span class="ident" id="7197197">testing</span><span class="op" id="7197204">.</span><span class="ident" id="7197205">T</span><span class="op" id="7197206">)</span>&nbsp;<span class="op" id="7197208">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197211">db</span>&nbsp;<span class="op" id="7197214">:=</span>&nbsp;<span class="ident" id="7197217">newTestDB</span><span class="op" id="7197226">(</span><span class="ident" id="7197227">t</span><span class="op" id="7197228">,</span>&nbsp;<span class="string" id="7197230">&#34;people&#34;</span><span class="op" id="7197238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197241">defer</span>&nbsp;<span class="ident" id="7197247">closeDB</span><span class="op" id="7197254">(</span><span class="ident" id="7197255">t</span><span class="op" id="7197256">,</span>&nbsp;<span class="ident" id="7197258">db</span><span class="op" id="7197260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197263">var</span>&nbsp;<span class="ident" id="7197267">name</span>&nbsp;<span class="op" id="7197272">*</span><span class="builtintype" id="7197273">string</span>&nbsp;<span class="comment" id="7197280">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197296">err</span>&nbsp;<span class="op" id="7197300">:=</span>&nbsp;<span class="ident" id="7197303">db</span><span class="op" id="7197305">.</span><span class="ident" id="7197306">QueryRow</span><span class="op" id="7197314">(</span><span class="string" id="7197315">&#34;SELECT|people|name|&#34;</span><span class="op" id="7197336">)</span><span class="op" id="7197337">.</span><span class="ident" id="7197338">Scan</span><span class="op" id="7197342">(</span><span class="ident" id="7197343">name</span><span class="op" id="7197347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197350">want</span>&nbsp;<span class="op" id="7197355">:=</span>&nbsp;<span class="string" id="7197358">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197423">if</span>&nbsp;<span class="ident" id="7197426">err</span>&nbsp;<span class="op" id="7197430">==</span>&nbsp;<span class="builtintype" id="7197433">nil</span>&nbsp;<span class="op" id="7197437">||</span>&nbsp;<span class="ident" id="7197440">err</span><span class="op" id="7197443">.</span><span class="ident" id="7197444">Error</span><span class="op" id="7197449">(</span><span class="op" id="7197450">)</span>&nbsp;<span class="op" id="7197452">!=</span>&nbsp;<span class="ident" id="7197455">want</span>&nbsp;<span class="op" id="7197460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197464">t</span><span class="op" id="7197465">.</span><span class="ident" id="7197466">Errorf</span><span class="op" id="7197472">(</span><span class="string" id="7197473">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7197494">,</span>&nbsp;<span class="ident" id="7197496">err</span><span class="op" id="7197499">.</span><span class="ident" id="7197500">Error</span><span class="op" id="7197505">(</span><span class="op" id="7197506">)</span><span class="op" id="7197507">,</span>&nbsp;<span class="ident" id="7197509">want</span><span class="op" id="7197513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7197516">}</span><br>
<span class="lineno"></span><span class="op" id="7197518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="7197521">func</span>&nbsp;<span class="ident" id="7197526">TestIssue4902</span><span class="op" id="7197539">(</span><span class="ident" id="7197540">t</span>&nbsp;<span class="op" id="7197542">*</span><span class="ident" id="7197543">testing</span><span class="op" id="7197550">.</span><span class="ident" id="7197551">T</span><span class="op" id="7197552">)</span>&nbsp;<span class="op" id="7197554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197557">db</span>&nbsp;<span class="op" id="7197560">:=</span>&nbsp;<span class="ident" id="7197563">newTestDB</span><span class="op" id="7197572">(</span><span class="ident" id="7197573">t</span><span class="op" id="7197574">,</span>&nbsp;<span class="string" id="7197576">&#34;people&#34;</span><span class="op" id="7197584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197587">defer</span>&nbsp;<span class="ident" id="7197593">closeDB</span><span class="op" id="7197600">(</span><span class="ident" id="7197601">t</span><span class="op" id="7197602">,</span>&nbsp;<span class="ident" id="7197604">db</span><span class="op" id="7197606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197610">driver</span>&nbsp;<span class="op" id="7197617">:=</span>&nbsp;<span class="ident" id="7197620">db</span><span class="op" id="7197622">.</span><span class="ident" id="7197623">driver</span><span class="op" id="7197629">.</span><span class="op" id="7197630">(</span><span class="op" id="7197631">*</span><span class="ident" id="7197632">fakeDriver</span><span class="op" id="7197642">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197645">opens0</span>&nbsp;<span class="op" id="7197652">:=</span>&nbsp;<span class="ident" id="7197655">driver</span><span class="op" id="7197661">.</span><span class="ident" id="7197662">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197674">var</span>&nbsp;<span class="ident" id="7197678">stmt</span>&nbsp;<span class="op" id="7197683">*</span><span class="ident" id="7197684">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197690">var</span>&nbsp;<span class="ident" id="7197694">err</span>&nbsp;<span class="builtintype" id="7197698">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197705">for</span>&nbsp;<span class="ident" id="7197709">i</span>&nbsp;<span class="op" id="7197711">:=</span>&nbsp;<span class="num" id="7197714">0</span><span class="op" id="7197715">;</span>&nbsp;<span class="ident" id="7197717">i</span>&nbsp;<span class="op" id="7197719">&lt;</span>&nbsp;<span class="num" id="7197721">10</span><span class="op" id="7197723">;</span>&nbsp;<span class="ident" id="7197725">i</span><span class="op" id="7197726">++</span>&nbsp;<span class="op" id="7197729">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197733">stmt</span><span class="op" id="7197737">,</span>&nbsp;<span class="ident" id="7197739">err</span>&nbsp;<span class="op" id="7197743">=</span>&nbsp;<span class="ident" id="7197745">db</span><span class="op" id="7197747">.</span><span class="ident" id="7197748">Prepare</span><span class="op" id="7197755">(</span><span class="string" id="7197756">&#34;SELECT|people|name|&#34;</span><span class="op" id="7197777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197781">if</span>&nbsp;<span class="ident" id="7197784">err</span>&nbsp;<span class="op" id="7197788">!=</span>&nbsp;<span class="builtintype" id="7197791">nil</span>&nbsp;<span class="op" id="7197795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197800">t</span><span class="op" id="7197801">.</span><span class="ident" id="7197802">Fatal</span><span class="op" id="7197807">(</span><span class="ident" id="7197808">err</span><span class="op" id="7197811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7197815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197819">err</span>&nbsp;<span class="op" id="7197823">=</span>&nbsp;<span class="ident" id="7197825">stmt</span><span class="op" id="7197829">.</span><span class="ident" id="7197830">Close</span><span class="op" id="7197835">(</span><span class="op" id="7197836">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197840">if</span>&nbsp;<span class="ident" id="7197843">err</span>&nbsp;<span class="op" id="7197847">!=</span>&nbsp;<span class="builtintype" id="7197850">nil</span>&nbsp;<span class="op" id="7197854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197859">t</span><span class="op" id="7197860">.</span><span class="ident" id="7197861">Fatal</span><span class="op" id="7197866">(</span><span class="ident" id="7197867">err</span><span class="op" id="7197870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7197874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7197877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197881">opens</span>&nbsp;<span class="op" id="7197887">:=</span>&nbsp;<span class="ident" id="7197890">driver</span><span class="op" id="7197896">.</span><span class="ident" id="7197897">openCount</span>&nbsp;<span class="op" id="7197907">-</span>&nbsp;<span class="ident" id="7197909">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7197917">if</span>&nbsp;<span class="ident" id="7197920">opens</span>&nbsp;<span class="op" id="7197926">&gt;</span>&nbsp;<span class="num" id="7197928">1</span>&nbsp;<span class="op" id="7197930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197934">t</span><span class="op" id="7197935">.</span><span class="ident" id="7197936">Errorf</span><span class="op" id="7197942">(</span><span class="string" id="7197943">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7197966">,</span>&nbsp;<span class="ident" id="7197968">opens</span><span class="op" id="7197973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7197977">t</span><span class="op" id="7197978">.</span><span class="ident" id="7197979">Logf</span><span class="op" id="7197983">(</span><span class="string" id="7197984">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7197994">,</span>&nbsp;<span class="ident" id="7197996">db</span><span class="op" id="7197998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198002">t</span><span class="op" id="7198003">.</span><span class="ident" id="7198004">Logf</span><span class="op" id="7198008">(</span><span class="string" id="7198009">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7198023">,</span>&nbsp;<span class="ident" id="7198025">driver</span><span class="op" id="7198031">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198035">t</span><span class="op" id="7198036">.</span><span class="ident" id="7198037">Logf</span><span class="op" id="7198041">(</span><span class="string" id="7198042">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7198054">,</span>&nbsp;<span class="ident" id="7198056">stmt</span><span class="op" id="7198060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198063">}</span><br>
<span class="lineno"></span><span class="op" id="7198065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7198068">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="7198082">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="7198108">func</span>&nbsp;<span class="ident" id="7198113">TestSimultaneousQueries</span><span class="op" id="7198136">(</span><span class="ident" id="7198137">t</span>&nbsp;<span class="op" id="7198139">*</span><span class="ident" id="7198140">testing</span><span class="op" id="7198147">.</span><span class="ident" id="7198148">T</span><span class="op" id="7198149">)</span>&nbsp;<span class="op" id="7198151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198154">db</span>&nbsp;<span class="op" id="7198157">:=</span>&nbsp;<span class="ident" id="7198160">newTestDB</span><span class="op" id="7198169">(</span><span class="ident" id="7198170">t</span><span class="op" id="7198171">,</span>&nbsp;<span class="string" id="7198173">&#34;people&#34;</span><span class="op" id="7198181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198184">defer</span>&nbsp;<span class="ident" id="7198190">closeDB</span><span class="op" id="7198197">(</span><span class="ident" id="7198198">t</span><span class="op" id="7198199">,</span>&nbsp;<span class="ident" id="7198201">db</span><span class="op" id="7198203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198207">tx</span><span class="op" id="7198209">,</span>&nbsp;<span class="ident" id="7198211">err</span>&nbsp;<span class="op" id="7198215">:=</span>&nbsp;<span class="ident" id="7198218">db</span><span class="op" id="7198220">.</span><span class="ident" id="7198221">Begin</span><span class="op" id="7198226">(</span><span class="op" id="7198227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198230">if</span>&nbsp;<span class="ident" id="7198233">err</span>&nbsp;<span class="op" id="7198237">!=</span>&nbsp;<span class="builtintype" id="7198240">nil</span>&nbsp;<span class="op" id="7198244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198248">t</span><span class="op" id="7198249">.</span><span class="ident" id="7198250">Fatal</span><span class="op" id="7198255">(</span><span class="ident" id="7198256">err</span><span class="op" id="7198259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198265">defer</span>&nbsp;<span class="ident" id="7198271">tx</span><span class="op" id="7198273">.</span><span class="ident" id="7198274">Rollback</span><span class="op" id="7198282">(</span><span class="op" id="7198283">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198287">r1</span><span class="op" id="7198289">,</span>&nbsp;<span class="ident" id="7198291">err</span>&nbsp;<span class="op" id="7198295">:=</span>&nbsp;<span class="ident" id="7198298">tx</span><span class="op" id="7198300">.</span><span class="ident" id="7198301">Query</span><span class="op" id="7198306">(</span><span class="string" id="7198307">&#34;SELECT|people|name|&#34;</span><span class="op" id="7198328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198331">if</span>&nbsp;<span class="ident" id="7198334">err</span>&nbsp;<span class="op" id="7198338">!=</span>&nbsp;<span class="builtintype" id="7198341">nil</span>&nbsp;<span class="op" id="7198345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198349">t</span><span class="op" id="7198350">.</span><span class="ident" id="7198351">Fatal</span><span class="op" id="7198356">(</span><span class="ident" id="7198357">err</span><span class="op" id="7198360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198363">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198366">defer</span>&nbsp;<span class="ident" id="7198372">r1</span><span class="op" id="7198374">.</span><span class="ident" id="7198375">Close</span><span class="op" id="7198380">(</span><span class="op" id="7198381">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198385">r2</span><span class="op" id="7198387">,</span>&nbsp;<span class="ident" id="7198389">err</span>&nbsp;<span class="op" id="7198393">:=</span>&nbsp;<span class="ident" id="7198396">tx</span><span class="op" id="7198398">.</span><span class="ident" id="7198399">Query</span><span class="op" id="7198404">(</span><span class="string" id="7198405">&#34;SELECT|people|name|&#34;</span><span class="op" id="7198426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198429">if</span>&nbsp;<span class="ident" id="7198432">err</span>&nbsp;<span class="op" id="7198436">!=</span>&nbsp;<span class="builtintype" id="7198439">nil</span>&nbsp;<span class="op" id="7198443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198447">t</span><span class="op" id="7198448">.</span><span class="ident" id="7198449">Fatal</span><span class="op" id="7198454">(</span><span class="ident" id="7198455">err</span><span class="op" id="7198458">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198464">defer</span>&nbsp;<span class="ident" id="7198470">r2</span><span class="op" id="7198472">.</span><span class="ident" id="7198473">Close</span><span class="op" id="7198478">(</span><span class="op" id="7198479">)</span><br>
<span class="lineno"></span><span class="op" id="7198481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7198484">func</span>&nbsp;<span class="ident" id="7198489">TestMaxIdleConns</span><span class="op" id="7198505">(</span><span class="ident" id="7198506">t</span>&nbsp;<span class="op" id="7198508">*</span><span class="ident" id="7198509">testing</span><span class="op" id="7198516">.</span><span class="ident" id="7198517">T</span><span class="op" id="7198518">)</span>&nbsp;<span class="op" id="7198520">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198523">db</span>&nbsp;<span class="op" id="7198526">:=</span>&nbsp;<span class="ident" id="7198529">newTestDB</span><span class="op" id="7198538">(</span><span class="ident" id="7198539">t</span><span class="op" id="7198540">,</span>&nbsp;<span class="string" id="7198542">&#34;people&#34;</span><span class="op" id="7198550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198553">defer</span>&nbsp;<span class="ident" id="7198559">closeDB</span><span class="op" id="7198566">(</span><span class="ident" id="7198567">t</span><span class="op" id="7198568">,</span>&nbsp;<span class="ident" id="7198570">db</span><span class="op" id="7198572">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198576">tx</span><span class="op" id="7198578">,</span>&nbsp;<span class="ident" id="7198580">err</span>&nbsp;<span class="op" id="7198584">:=</span>&nbsp;<span class="ident" id="7198587">db</span><span class="op" id="7198589">.</span><span class="ident" id="7198590">Begin</span><span class="op" id="7198595">(</span><span class="op" id="7198596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198599">if</span>&nbsp;<span class="ident" id="7198602">err</span>&nbsp;<span class="op" id="7198606">!=</span>&nbsp;<span class="builtintype" id="7198609">nil</span>&nbsp;<span class="op" id="7198613">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198617">t</span><span class="op" id="7198618">.</span><span class="ident" id="7198619">Fatal</span><span class="op" id="7198624">(</span><span class="ident" id="7198625">err</span><span class="op" id="7198628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198634">tx</span><span class="op" id="7198636">.</span><span class="ident" id="7198637">Commit</span><span class="op" id="7198643">(</span><span class="op" id="7198644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198647">if</span>&nbsp;<span class="ident" id="7198650">got</span>&nbsp;<span class="op" id="7198654">:=</span>&nbsp;<span class="builtinfunc" id="7198657">len</span><span class="op" id="7198660">(</span><span class="ident" id="7198661">db</span><span class="op" id="7198663">.</span><span class="ident" id="7198664">freeConn</span><span class="op" id="7198672">)</span><span class="op" id="7198673">;</span>&nbsp;<span class="ident" id="7198675">got</span>&nbsp;<span class="op" id="7198679">!=</span>&nbsp;<span class="num" id="7198682">1</span>&nbsp;<span class="op" id="7198684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198688">t</span><span class="op" id="7198689">.</span><span class="ident" id="7198690">Errorf</span><span class="op" id="7198696">(</span><span class="string" id="7198697">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7198721">,</span>&nbsp;<span class="ident" id="7198723">got</span><span class="op" id="7198726">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198733">db</span><span class="op" id="7198735">.</span><span class="ident" id="7198736">SetMaxIdleConns</span><span class="op" id="7198751">(</span><span class="num" id="7198752">0</span><span class="op" id="7198753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198757">if</span>&nbsp;<span class="ident" id="7198760">got</span>&nbsp;<span class="op" id="7198764">:=</span>&nbsp;<span class="builtinfunc" id="7198767">len</span><span class="op" id="7198770">(</span><span class="ident" id="7198771">db</span><span class="op" id="7198773">.</span><span class="ident" id="7198774">freeConn</span><span class="op" id="7198782">)</span><span class="op" id="7198783">;</span>&nbsp;<span class="ident" id="7198785">got</span>&nbsp;<span class="op" id="7198789">!=</span>&nbsp;<span class="num" id="7198792">0</span>&nbsp;<span class="op" id="7198794">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198798">t</span><span class="op" id="7198799">.</span><span class="ident" id="7198800">Errorf</span><span class="op" id="7198806">(</span><span class="string" id="7198807">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7198849">,</span>&nbsp;<span class="ident" id="7198851">got</span><span class="op" id="7198854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198861">tx</span><span class="op" id="7198863">,</span>&nbsp;<span class="ident" id="7198865">err</span>&nbsp;<span class="op" id="7198869">=</span>&nbsp;<span class="ident" id="7198871">db</span><span class="op" id="7198873">.</span><span class="ident" id="7198874">Begin</span><span class="op" id="7198879">(</span><span class="op" id="7198880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198883">if</span>&nbsp;<span class="ident" id="7198886">err</span>&nbsp;<span class="op" id="7198890">!=</span>&nbsp;<span class="builtintype" id="7198893">nil</span>&nbsp;<span class="op" id="7198897">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198901">t</span><span class="op" id="7198902">.</span><span class="ident" id="7198903">Fatal</span><span class="op" id="7198908">(</span><span class="ident" id="7198909">err</span><span class="op" id="7198912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7198915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198918">tx</span><span class="op" id="7198920">.</span><span class="ident" id="7198921">Commit</span><span class="op" id="7198927">(</span><span class="op" id="7198928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7198931">if</span>&nbsp;<span class="ident" id="7198934">got</span>&nbsp;<span class="op" id="7198938">:=</span>&nbsp;<span class="builtinfunc" id="7198941">len</span><span class="op" id="7198944">(</span><span class="ident" id="7198945">db</span><span class="op" id="7198947">.</span><span class="ident" id="7198948">freeConn</span><span class="op" id="7198956">)</span><span class="op" id="7198957">;</span>&nbsp;<span class="ident" id="7198959">got</span>&nbsp;<span class="op" id="7198963">!=</span>&nbsp;<span class="num" id="7198966">0</span>&nbsp;<span class="op" id="7198968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7198972">t</span><span class="op" id="7198973">.</span><span class="ident" id="7198974">Errorf</span><span class="op" id="7198980">(</span><span class="string" id="7198981">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7199005">,</span>&nbsp;<span class="ident" id="7199007">got</span><span class="op" id="7199010">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199013">}</span><br>
<span class="lineno"></span><span class="op" id="7199015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7199018">func</span>&nbsp;<span class="ident" id="7199023">TestMaxOpenConns</span><span class="op" id="7199039">(</span><span class="ident" id="7199040">t</span>&nbsp;<span class="op" id="7199042">*</span><span class="ident" id="7199043">testing</span><span class="op" id="7199050">.</span><span class="ident" id="7199051">T</span><span class="op" id="7199052">)</span>&nbsp;<span class="op" id="7199054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199057">if</span>&nbsp;<span class="ident" id="7199060">testing</span><span class="op" id="7199067">.</span><span class="ident" id="7199068">Short</span><span class="op" id="7199073">(</span><span class="op" id="7199074">)</span>&nbsp;<span class="op" id="7199076">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199080">t</span><span class="op" id="7199081">.</span><span class="ident" id="7199082">Skip</span><span class="op" id="7199086">(</span><span class="string" id="7199087">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7199111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199117">defer</span>&nbsp;<span class="ident" id="7199123">setHookpostCloseConn</span><span class="op" id="7199143">(</span><span class="builtintype" id="7199144">nil</span><span class="op" id="7199147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199150">setHookpostCloseConn</span><span class="op" id="7199170">(</span><span class="keyword" id="7199171">func</span><span class="op" id="7199175">(</span><span class="ident" id="7199176">_</span>&nbsp;<span class="op" id="7199178">*</span><span class="ident" id="7199179">fakeConn</span><span class="op" id="7199187">,</span>&nbsp;<span class="ident" id="7199189">err</span>&nbsp;<span class="builtintype" id="7199193">error</span><span class="op" id="7199198">)</span>&nbsp;<span class="op" id="7199200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199204">if</span>&nbsp;<span class="ident" id="7199207">err</span>&nbsp;<span class="op" id="7199211">!=</span>&nbsp;<span class="builtintype" id="7199214">nil</span>&nbsp;<span class="op" id="7199218">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199223">t</span><span class="op" id="7199224">.</span><span class="ident" id="7199225">Errorf</span><span class="op" id="7199231">(</span><span class="string" id="7199232">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7199260">,</span>&nbsp;<span class="ident" id="7199262">err</span><span class="op" id="7199265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199272">}</span><span class="op" id="7199273">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199277">db</span>&nbsp;<span class="op" id="7199280">:=</span>&nbsp;<span class="ident" id="7199283">newTestDB</span><span class="op" id="7199292">(</span><span class="ident" id="7199293">t</span><span class="op" id="7199294">,</span>&nbsp;<span class="string" id="7199296">&#34;magicquery&#34;</span><span class="op" id="7199308">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199311">defer</span>&nbsp;<span class="ident" id="7199317">closeDB</span><span class="op" id="7199324">(</span><span class="ident" id="7199325">t</span><span class="op" id="7199326">,</span>&nbsp;<span class="ident" id="7199328">db</span><span class="op" id="7199330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199334">driver</span>&nbsp;<span class="op" id="7199341">:=</span>&nbsp;<span class="ident" id="7199344">db</span><span class="op" id="7199346">.</span><span class="ident" id="7199347">driver</span><span class="op" id="7199353">.</span><span class="op" id="7199354">(</span><span class="op" id="7199355">*</span><span class="ident" id="7199356">fakeDriver</span><span class="op" id="7199366">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7199370">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7199442">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199465">db</span><span class="op" id="7199467">.</span><span class="ident" id="7199468">SetMaxIdleConns</span><span class="op" id="7199483">(</span><span class="num" id="7199484">0</span><span class="op" id="7199485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199489">if</span>&nbsp;<span class="ident" id="7199492">g</span><span class="op" id="7199493">,</span>&nbsp;<span class="ident" id="7199495">w</span>&nbsp;<span class="op" id="7199497">:=</span>&nbsp;<span class="ident" id="7199500">db</span><span class="op" id="7199502">.</span><span class="ident" id="7199503">numFreeConns</span><span class="op" id="7199515">(</span><span class="op" id="7199516">)</span><span class="op" id="7199517">,</span>&nbsp;<span class="num" id="7199519">0</span><span class="op" id="7199520">;</span>&nbsp;<span class="ident" id="7199522">g</span>&nbsp;<span class="op" id="7199524">!=</span>&nbsp;<span class="ident" id="7199527">w</span>&nbsp;<span class="op" id="7199529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199533">t</span><span class="op" id="7199534">.</span><span class="ident" id="7199535">Errorf</span><span class="op" id="7199541">(</span><span class="string" id="7199542">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7199568">,</span>&nbsp;<span class="ident" id="7199570">g</span><span class="op" id="7199571">,</span>&nbsp;<span class="ident" id="7199573">w</span><span class="op" id="7199574">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199581">if</span>&nbsp;<span class="ident" id="7199584">n</span>&nbsp;<span class="op" id="7199586">:=</span>&nbsp;<span class="ident" id="7199589">db</span><span class="op" id="7199591">.</span><span class="ident" id="7199592">numDepsPollUntil</span><span class="op" id="7199608">(</span><span class="num" id="7199609">0</span><span class="op" id="7199610">,</span>&nbsp;<span class="ident" id="7199612">time</span><span class="op" id="7199616">.</span><span class="ident" id="7199617">Second</span><span class="op" id="7199623">)</span><span class="op" id="7199624">;</span>&nbsp;<span class="ident" id="7199626">n</span>&nbsp;<span class="op" id="7199628">&gt;</span>&nbsp;<span class="num" id="7199630">0</span>&nbsp;<span class="op" id="7199632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199636">t</span><span class="op" id="7199637">.</span><span class="ident" id="7199638">Errorf</span><span class="op" id="7199644">(</span><span class="string" id="7199645">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7199686">,</span>&nbsp;<span class="ident" id="7199688">n</span><span class="op" id="7199689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199693">db</span><span class="op" id="7199695">.</span><span class="ident" id="7199696">dumpDeps</span><span class="op" id="7199704">(</span><span class="ident" id="7199705">t</span><span class="op" id="7199706">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199713">driver</span><span class="op" id="7199719">.</span><span class="ident" id="7199720">mu</span><span class="op" id="7199722">.</span><span class="ident" id="7199723">Lock</span><span class="op" id="7199727">(</span><span class="op" id="7199728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199731">opens0</span>&nbsp;<span class="op" id="7199738">:=</span>&nbsp;<span class="ident" id="7199741">driver</span><span class="op" id="7199747">.</span><span class="ident" id="7199748">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199759">closes0</span>&nbsp;<span class="op" id="7199767">:=</span>&nbsp;<span class="ident" id="7199770">driver</span><span class="op" id="7199776">.</span><span class="ident" id="7199777">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199789">driver</span><span class="op" id="7199795">.</span><span class="ident" id="7199796">mu</span><span class="op" id="7199798">.</span><span class="ident" id="7199799">Unlock</span><span class="op" id="7199805">(</span><span class="op" id="7199806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199810">db</span><span class="op" id="7199812">.</span><span class="ident" id="7199813">SetMaxIdleConns</span><span class="op" id="7199828">(</span><span class="num" id="7199829">10</span><span class="op" id="7199831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199834">db</span><span class="op" id="7199836">.</span><span class="ident" id="7199837">SetMaxOpenConns</span><span class="op" id="7199852">(</span><span class="num" id="7199853">10</span><span class="op" id="7199855">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199859">stmt</span><span class="op" id="7199863">,</span>&nbsp;<span class="ident" id="7199865">err</span>&nbsp;<span class="op" id="7199869">:=</span>&nbsp;<span class="ident" id="7199872">db</span><span class="op" id="7199874">.</span><span class="ident" id="7199875">Prepare</span><span class="op" id="7199882">(</span><span class="string" id="7199883">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7199919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199922">if</span>&nbsp;<span class="ident" id="7199925">err</span>&nbsp;<span class="op" id="7199929">!=</span>&nbsp;<span class="builtintype" id="7199932">nil</span>&nbsp;<span class="op" id="7199936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7199940">t</span><span class="op" id="7199941">.</span><span class="ident" id="7199942">Fatal</span><span class="op" id="7199947">(</span><span class="ident" id="7199948">err</span><span class="op" id="7199951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7199954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7199958">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7199994">const</span>&nbsp;<span class="op" id="7200000">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200004">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200016">=</span>&nbsp;<span class="num" id="7200018">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200023">sleepMillis</span>&nbsp;<span class="op" id="7200035">=</span>&nbsp;<span class="num" id="7200037">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200042">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200054">=</span>&nbsp;<span class="num" id="7200056">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200062">var</span>&nbsp;<span class="ident" id="7200066">wg</span>&nbsp;<span class="ident" id="7200069">sync</span><span class="op" id="7200073">.</span><span class="ident" id="7200074">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200085">for</span>&nbsp;<span class="ident" id="7200089">batch</span>&nbsp;<span class="op" id="7200095">:=</span>&nbsp;<span class="num" id="7200098">0</span><span class="op" id="7200099">;</span>&nbsp;<span class="ident" id="7200101">batch</span>&nbsp;<span class="op" id="7200107">&lt;</span>&nbsp;<span class="ident" id="7200109">nbatch</span><span class="op" id="7200115">;</span>&nbsp;<span class="ident" id="7200117">batch</span><span class="op" id="7200122">++</span>&nbsp;<span class="op" id="7200125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200129">for</span>&nbsp;<span class="ident" id="7200133">i</span>&nbsp;<span class="op" id="7200135">:=</span>&nbsp;<span class="num" id="7200138">0</span><span class="op" id="7200139">;</span>&nbsp;<span class="ident" id="7200141">i</span>&nbsp;<span class="op" id="7200143">&lt;</span>&nbsp;<span class="ident" id="7200145">nquery</span><span class="op" id="7200151">;</span>&nbsp;<span class="ident" id="7200153">i</span><span class="op" id="7200154">++</span>&nbsp;<span class="op" id="7200157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200162">wg</span><span class="op" id="7200164">.</span><span class="ident" id="7200165">Add</span><span class="op" id="7200168">(</span><span class="num" id="7200169">1</span><span class="op" id="7200170">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200175">go</span>&nbsp;<span class="keyword" id="7200178">func</span><span class="op" id="7200182">(</span><span class="op" id="7200183">)</span>&nbsp;<span class="op" id="7200185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200191">defer</span>&nbsp;<span class="ident" id="7200197">wg</span><span class="op" id="7200199">.</span><span class="ident" id="7200200">Done</span><span class="op" id="7200204">(</span><span class="op" id="7200205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200211">var</span>&nbsp;<span class="ident" id="7200215">op</span>&nbsp;<span class="builtintype" id="7200218">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200229">if</span>&nbsp;<span class="ident" id="7200232">err</span>&nbsp;<span class="op" id="7200236">:=</span>&nbsp;<span class="ident" id="7200239">stmt</span><span class="op" id="7200243">.</span><span class="ident" id="7200244">QueryRow</span><span class="op" id="7200252">(</span><span class="string" id="7200253">&#34;sleep&#34;</span><span class="op" id="7200260">,</span>&nbsp;<span class="ident" id="7200262">sleepMillis</span><span class="op" id="7200273">)</span><span class="op" id="7200274">.</span><span class="ident" id="7200275">Scan</span><span class="op" id="7200279">(</span><span class="op" id="7200280">&amp;</span><span class="ident" id="7200281">op</span><span class="op" id="7200283">)</span><span class="op" id="7200284">;</span>&nbsp;<span class="ident" id="7200286">err</span>&nbsp;<span class="op" id="7200290">!=</span>&nbsp;<span class="builtintype" id="7200293">nil</span>&nbsp;<span class="op" id="7200297">&amp;&amp;</span>&nbsp;<span class="ident" id="7200300">err</span>&nbsp;<span class="op" id="7200304">!=</span>&nbsp;<span class="ident" id="7200307">ErrNoRows</span>&nbsp;<span class="op" id="7200317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200324">t</span><span class="op" id="7200325">.</span><span class="ident" id="7200326">Error</span><span class="op" id="7200331">(</span><span class="ident" id="7200332">err</span><span class="op" id="7200335">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200346">}</span><span class="op" id="7200347">(</span><span class="op" id="7200348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7200356">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7200413">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7200470">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200491">time</span><span class="op" id="7200495">.</span><span class="ident" id="7200496">Sleep</span><span class="op" id="7200501">(</span><span class="num" id="7200502">2</span>&nbsp;<span class="op" id="7200504">*</span>&nbsp;<span class="ident" id="7200506">sleepMillis</span>&nbsp;<span class="op" id="7200518">*</span>&nbsp;<span class="ident" id="7200520">time</span><span class="op" id="7200524">.</span><span class="ident" id="7200525">Millisecond</span><span class="op" id="7200536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200542">wg</span><span class="op" id="7200544">.</span><span class="ident" id="7200545">Wait</span><span class="op" id="7200549">(</span><span class="op" id="7200550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200554">if</span>&nbsp;<span class="ident" id="7200557">g</span><span class="op" id="7200558">,</span>&nbsp;<span class="ident" id="7200560">w</span>&nbsp;<span class="op" id="7200562">:=</span>&nbsp;<span class="ident" id="7200565">db</span><span class="op" id="7200567">.</span><span class="ident" id="7200568">numFreeConns</span><span class="op" id="7200580">(</span><span class="op" id="7200581">)</span><span class="op" id="7200582">,</span>&nbsp;<span class="num" id="7200584">10</span><span class="op" id="7200586">;</span>&nbsp;<span class="ident" id="7200588">g</span>&nbsp;<span class="op" id="7200590">!=</span>&nbsp;<span class="ident" id="7200593">w</span>&nbsp;<span class="op" id="7200595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200599">t</span><span class="op" id="7200600">.</span><span class="ident" id="7200601">Errorf</span><span class="op" id="7200607">(</span><span class="string" id="7200608">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7200634">,</span>&nbsp;<span class="ident" id="7200636">g</span><span class="op" id="7200637">,</span>&nbsp;<span class="ident" id="7200639">w</span><span class="op" id="7200640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200647">if</span>&nbsp;<span class="ident" id="7200650">n</span>&nbsp;<span class="op" id="7200652">:=</span>&nbsp;<span class="ident" id="7200655">db</span><span class="op" id="7200657">.</span><span class="ident" id="7200658">numDepsPollUntil</span><span class="op" id="7200674">(</span><span class="num" id="7200675">20</span><span class="op" id="7200677">,</span>&nbsp;<span class="ident" id="7200679">time</span><span class="op" id="7200683">.</span><span class="ident" id="7200684">Second</span><span class="op" id="7200690">)</span><span class="op" id="7200691">;</span>&nbsp;<span class="ident" id="7200693">n</span>&nbsp;<span class="op" id="7200695">&gt;</span>&nbsp;<span class="num" id="7200697">20</span>&nbsp;<span class="op" id="7200700">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200704">t</span><span class="op" id="7200705">.</span><span class="ident" id="7200706">Errorf</span><span class="op" id="7200712">(</span><span class="string" id="7200713">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="7200758">,</span>&nbsp;<span class="ident" id="7200760">n</span><span class="op" id="7200761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200765">db</span><span class="op" id="7200767">.</span><span class="ident" id="7200768">dumpDeps</span><span class="op" id="7200776">(</span><span class="ident" id="7200777">t</span><span class="op" id="7200778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7200781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200785">driver</span><span class="op" id="7200791">.</span><span class="ident" id="7200792">mu</span><span class="op" id="7200794">.</span><span class="ident" id="7200795">Lock</span><span class="op" id="7200799">(</span><span class="op" id="7200800">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200803">opens</span>&nbsp;<span class="op" id="7200809">:=</span>&nbsp;<span class="ident" id="7200812">driver</span><span class="op" id="7200818">.</span><span class="ident" id="7200819">openCount</span>&nbsp;<span class="op" id="7200829">-</span>&nbsp;<span class="ident" id="7200831">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200839">closes</span>&nbsp;<span class="op" id="7200846">:=</span>&nbsp;<span class="ident" id="7200849">driver</span><span class="op" id="7200855">.</span><span class="ident" id="7200856">closeCount</span>&nbsp;<span class="op" id="7200867">-</span>&nbsp;<span class="ident" id="7200869">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200878">driver</span><span class="op" id="7200884">.</span><span class="ident" id="7200885">mu</span><span class="op" id="7200887">.</span><span class="ident" id="7200888">Unlock</span><span class="op" id="7200894">(</span><span class="op" id="7200895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7200899">if</span>&nbsp;<span class="ident" id="7200902">opens</span>&nbsp;<span class="op" id="7200908">&gt;</span>&nbsp;<span class="num" id="7200910">10</span>&nbsp;<span class="op" id="7200913">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200917">t</span><span class="op" id="7200918">.</span><span class="ident" id="7200919">Logf</span><span class="op" id="7200923">(</span><span class="string" id="7200924">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7200941">,</span>&nbsp;<span class="ident" id="7200943">opens</span><span class="op" id="7200948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200952">t</span><span class="op" id="7200953">.</span><span class="ident" id="7200954">Logf</span><span class="op" id="7200958">(</span><span class="string" id="7200959">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7200977">,</span>&nbsp;<span class="ident" id="7200979">closes</span><span class="op" id="7200985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7200989">t</span><span class="op" id="7200990">.</span><span class="ident" id="7200991">Errorf</span><span class="op" id="7200997">(</span><span class="string" id="7200998">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7201038">,</span>&nbsp;<span class="ident" id="7201040">opens</span><span class="op" id="7201045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201049">db</span><span class="op" id="7201051">.</span><span class="ident" id="7201052">dumpDeps</span><span class="op" id="7201060">(</span><span class="ident" id="7201061">t</span><span class="op" id="7201062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201065">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201069">if</span>&nbsp;<span class="ident" id="7201072">err</span>&nbsp;<span class="op" id="7201076">:=</span>&nbsp;<span class="ident" id="7201079">stmt</span><span class="op" id="7201083">.</span><span class="ident" id="7201084">Close</span><span class="op" id="7201089">(</span><span class="op" id="7201090">)</span><span class="op" id="7201091">;</span>&nbsp;<span class="ident" id="7201093">err</span>&nbsp;<span class="op" id="7201097">!=</span>&nbsp;<span class="builtintype" id="7201100">nil</span>&nbsp;<span class="op" id="7201104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201108">t</span><span class="op" id="7201109">.</span><span class="ident" id="7201110">Fatal</span><span class="op" id="7201115">(</span><span class="ident" id="7201116">err</span><span class="op" id="7201119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201126">if</span>&nbsp;<span class="ident" id="7201129">g</span><span class="op" id="7201130">,</span>&nbsp;<span class="ident" id="7201132">w</span>&nbsp;<span class="op" id="7201134">:=</span>&nbsp;<span class="ident" id="7201137">db</span><span class="op" id="7201139">.</span><span class="ident" id="7201140">numFreeConns</span><span class="op" id="7201152">(</span><span class="op" id="7201153">)</span><span class="op" id="7201154">,</span>&nbsp;<span class="num" id="7201156">10</span><span class="op" id="7201158">;</span>&nbsp;<span class="ident" id="7201160">g</span>&nbsp;<span class="op" id="7201162">!=</span>&nbsp;<span class="ident" id="7201165">w</span>&nbsp;<span class="op" id="7201167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201171">t</span><span class="op" id="7201172">.</span><span class="ident" id="7201173">Errorf</span><span class="op" id="7201179">(</span><span class="string" id="7201180">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7201206">,</span>&nbsp;<span class="ident" id="7201208">g</span><span class="op" id="7201209">,</span>&nbsp;<span class="ident" id="7201211">w</span><span class="op" id="7201212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201219">if</span>&nbsp;<span class="ident" id="7201222">n</span>&nbsp;<span class="op" id="7201224">:=</span>&nbsp;<span class="ident" id="7201227">db</span><span class="op" id="7201229">.</span><span class="ident" id="7201230">numDepsPollUntil</span><span class="op" id="7201246">(</span><span class="num" id="7201247">10</span><span class="op" id="7201249">,</span>&nbsp;<span class="ident" id="7201251">time</span><span class="op" id="7201255">.</span><span class="ident" id="7201256">Second</span><span class="op" id="7201262">)</span><span class="op" id="7201263">;</span>&nbsp;<span class="ident" id="7201265">n</span>&nbsp;<span class="op" id="7201267">&gt;</span>&nbsp;<span class="num" id="7201269">10</span>&nbsp;<span class="op" id="7201272">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201276">t</span><span class="op" id="7201277">.</span><span class="ident" id="7201278">Errorf</span><span class="op" id="7201284">(</span><span class="string" id="7201285">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7201330">,</span>&nbsp;<span class="ident" id="7201332">n</span><span class="op" id="7201333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201337">db</span><span class="op" id="7201339">.</span><span class="ident" id="7201340">dumpDeps</span><span class="op" id="7201348">(</span><span class="ident" id="7201349">t</span><span class="op" id="7201350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201357">db</span><span class="op" id="7201359">.</span><span class="ident" id="7201360">SetMaxOpenConns</span><span class="op" id="7201375">(</span><span class="num" id="7201376">5</span><span class="op" id="7201377">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201381">if</span>&nbsp;<span class="ident" id="7201384">g</span><span class="op" id="7201385">,</span>&nbsp;<span class="ident" id="7201387">w</span>&nbsp;<span class="op" id="7201389">:=</span>&nbsp;<span class="ident" id="7201392">db</span><span class="op" id="7201394">.</span><span class="ident" id="7201395">numFreeConns</span><span class="op" id="7201407">(</span><span class="op" id="7201408">)</span><span class="op" id="7201409">,</span>&nbsp;<span class="num" id="7201411">5</span><span class="op" id="7201412">;</span>&nbsp;<span class="ident" id="7201414">g</span>&nbsp;<span class="op" id="7201416">!=</span>&nbsp;<span class="ident" id="7201419">w</span>&nbsp;<span class="op" id="7201421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201425">t</span><span class="op" id="7201426">.</span><span class="ident" id="7201427">Errorf</span><span class="op" id="7201433">(</span><span class="string" id="7201434">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7201460">,</span>&nbsp;<span class="ident" id="7201462">g</span><span class="op" id="7201463">,</span>&nbsp;<span class="ident" id="7201465">w</span><span class="op" id="7201466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201473">if</span>&nbsp;<span class="ident" id="7201476">n</span>&nbsp;<span class="op" id="7201478">:=</span>&nbsp;<span class="ident" id="7201481">db</span><span class="op" id="7201483">.</span><span class="ident" id="7201484">numDepsPollUntil</span><span class="op" id="7201500">(</span><span class="num" id="7201501">5</span><span class="op" id="7201502">,</span>&nbsp;<span class="ident" id="7201504">time</span><span class="op" id="7201508">.</span><span class="ident" id="7201509">Second</span><span class="op" id="7201515">)</span><span class="op" id="7201516">;</span>&nbsp;<span class="ident" id="7201518">n</span>&nbsp;<span class="op" id="7201520">&gt;</span>&nbsp;<span class="num" id="7201522">5</span>&nbsp;<span class="op" id="7201524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201528">t</span><span class="op" id="7201529">.</span><span class="ident" id="7201530">Errorf</span><span class="op" id="7201536">(</span><span class="string" id="7201537">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7201578">,</span>&nbsp;<span class="ident" id="7201580">n</span><span class="op" id="7201581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201585">db</span><span class="op" id="7201587">.</span><span class="ident" id="7201588">dumpDeps</span><span class="op" id="7201596">(</span><span class="ident" id="7201597">t</span><span class="op" id="7201598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201605">db</span><span class="op" id="7201607">.</span><span class="ident" id="7201608">SetMaxOpenConns</span><span class="op" id="7201623">(</span><span class="num" id="7201624">0</span><span class="op" id="7201625">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201629">if</span>&nbsp;<span class="ident" id="7201632">g</span><span class="op" id="7201633">,</span>&nbsp;<span class="ident" id="7201635">w</span>&nbsp;<span class="op" id="7201637">:=</span>&nbsp;<span class="ident" id="7201640">db</span><span class="op" id="7201642">.</span><span class="ident" id="7201643">numFreeConns</span><span class="op" id="7201655">(</span><span class="op" id="7201656">)</span><span class="op" id="7201657">,</span>&nbsp;<span class="num" id="7201659">5</span><span class="op" id="7201660">;</span>&nbsp;<span class="ident" id="7201662">g</span>&nbsp;<span class="op" id="7201664">!=</span>&nbsp;<span class="ident" id="7201667">w</span>&nbsp;<span class="op" id="7201669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201673">t</span><span class="op" id="7201674">.</span><span class="ident" id="7201675">Errorf</span><span class="op" id="7201681">(</span><span class="string" id="7201682">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7201708">,</span>&nbsp;<span class="ident" id="7201710">g</span><span class="op" id="7201711">,</span>&nbsp;<span class="ident" id="7201713">w</span><span class="op" id="7201714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201717">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201721">if</span>&nbsp;<span class="ident" id="7201724">n</span>&nbsp;<span class="op" id="7201726">:=</span>&nbsp;<span class="ident" id="7201729">db</span><span class="op" id="7201731">.</span><span class="ident" id="7201732">numDepsPollUntil</span><span class="op" id="7201748">(</span><span class="num" id="7201749">5</span><span class="op" id="7201750">,</span>&nbsp;<span class="ident" id="7201752">time</span><span class="op" id="7201756">.</span><span class="ident" id="7201757">Second</span><span class="op" id="7201763">)</span><span class="op" id="7201764">;</span>&nbsp;<span class="ident" id="7201766">n</span>&nbsp;<span class="op" id="7201768">&gt;</span>&nbsp;<span class="num" id="7201770">5</span>&nbsp;<span class="op" id="7201772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201776">t</span><span class="op" id="7201777">.</span><span class="ident" id="7201778">Errorf</span><span class="op" id="7201784">(</span><span class="string" id="7201785">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7201826">,</span>&nbsp;<span class="ident" id="7201828">n</span><span class="op" id="7201829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201833">db</span><span class="op" id="7201835">.</span><span class="ident" id="7201836">dumpDeps</span><span class="op" id="7201844">(</span><span class="ident" id="7201845">t</span><span class="op" id="7201846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201849">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201853">db</span><span class="op" id="7201855">.</span><span class="ident" id="7201856">SetMaxIdleConns</span><span class="op" id="7201871">(</span><span class="num" id="7201872">0</span><span class="op" id="7201873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201877">if</span>&nbsp;<span class="ident" id="7201880">g</span><span class="op" id="7201881">,</span>&nbsp;<span class="ident" id="7201883">w</span>&nbsp;<span class="op" id="7201885">:=</span>&nbsp;<span class="ident" id="7201888">db</span><span class="op" id="7201890">.</span><span class="ident" id="7201891">numFreeConns</span><span class="op" id="7201903">(</span><span class="op" id="7201904">)</span><span class="op" id="7201905">,</span>&nbsp;<span class="num" id="7201907">0</span><span class="op" id="7201908">;</span>&nbsp;<span class="ident" id="7201910">g</span>&nbsp;<span class="op" id="7201912">!=</span>&nbsp;<span class="ident" id="7201915">w</span>&nbsp;<span class="op" id="7201917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7201921">t</span><span class="op" id="7201922">.</span><span class="ident" id="7201923">Errorf</span><span class="op" id="7201929">(</span><span class="string" id="7201930">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7201956">,</span>&nbsp;<span class="ident" id="7201958">g</span><span class="op" id="7201959">,</span>&nbsp;<span class="ident" id="7201961">w</span><span class="op" id="7201962">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7201965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7201969">if</span>&nbsp;<span class="ident" id="7201972">n</span>&nbsp;<span class="op" id="7201974">:=</span>&nbsp;<span class="ident" id="7201977">db</span><span class="op" id="7201979">.</span><span class="ident" id="7201980">numDepsPollUntil</span><span class="op" id="7201996">(</span><span class="num" id="7201997">0</span><span class="op" id="7201998">,</span>&nbsp;<span class="ident" id="7202000">time</span><span class="op" id="7202004">.</span><span class="ident" id="7202005">Second</span><span class="op" id="7202011">)</span><span class="op" id="7202012">;</span>&nbsp;<span class="ident" id="7202014">n</span>&nbsp;<span class="op" id="7202016">&gt;</span>&nbsp;<span class="num" id="7202018">0</span>&nbsp;<span class="op" id="7202020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202024">t</span><span class="op" id="7202025">.</span><span class="ident" id="7202026">Errorf</span><span class="op" id="7202032">(</span><span class="string" id="7202033">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7202074">,</span>&nbsp;<span class="ident" id="7202076">n</span><span class="op" id="7202077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202081">db</span><span class="op" id="7202083">.</span><span class="ident" id="7202084">dumpDeps</span><span class="op" id="7202092">(</span><span class="ident" id="7202093">t</span><span class="op" id="7202094">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202097">}</span><br>
<span class="lineno"></span><span class="op" id="7202099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7202102">func</span>&nbsp;<span class="ident" id="7202107">TestSingleOpenConn</span><span class="op" id="7202125">(</span><span class="ident" id="7202126">t</span>&nbsp;<span class="op" id="7202128">*</span><span class="ident" id="7202129">testing</span><span class="op" id="7202136">.</span><span class="ident" id="7202137">T</span><span class="op" id="7202138">)</span>&nbsp;<span class="op" id="7202140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202143">db</span>&nbsp;<span class="op" id="7202146">:=</span>&nbsp;<span class="ident" id="7202149">newTestDB</span><span class="op" id="7202158">(</span><span class="ident" id="7202159">t</span><span class="op" id="7202160">,</span>&nbsp;<span class="string" id="7202162">&#34;people&#34;</span><span class="op" id="7202170">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202173">defer</span>&nbsp;<span class="ident" id="7202179">closeDB</span><span class="op" id="7202186">(</span><span class="ident" id="7202187">t</span><span class="op" id="7202188">,</span>&nbsp;<span class="ident" id="7202190">db</span><span class="op" id="7202192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202196">db</span><span class="op" id="7202198">.</span><span class="ident" id="7202199">SetMaxOpenConns</span><span class="op" id="7202214">(</span><span class="num" id="7202215">1</span><span class="op" id="7202216">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202220">rows</span><span class="op" id="7202224">,</span>&nbsp;<span class="ident" id="7202226">err</span>&nbsp;<span class="op" id="7202230">:=</span>&nbsp;<span class="ident" id="7202233">db</span><span class="op" id="7202235">.</span><span class="ident" id="7202236">Query</span><span class="op" id="7202241">(</span><span class="string" id="7202242">&#34;SELECT|people|name|&#34;</span><span class="op" id="7202263">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202266">if</span>&nbsp;<span class="ident" id="7202269">err</span>&nbsp;<span class="op" id="7202273">!=</span>&nbsp;<span class="builtintype" id="7202276">nil</span>&nbsp;<span class="op" id="7202280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202284">t</span><span class="op" id="7202285">.</span><span class="ident" id="7202286">Fatal</span><span class="op" id="7202291">(</span><span class="ident" id="7202292">err</span><span class="op" id="7202295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202301">if</span>&nbsp;<span class="ident" id="7202304">err</span>&nbsp;<span class="op" id="7202308">=</span>&nbsp;<span class="ident" id="7202310">rows</span><span class="op" id="7202314">.</span><span class="ident" id="7202315">Close</span><span class="op" id="7202320">(</span><span class="op" id="7202321">)</span><span class="op" id="7202322">;</span>&nbsp;<span class="ident" id="7202324">err</span>&nbsp;<span class="op" id="7202328">!=</span>&nbsp;<span class="builtintype" id="7202331">nil</span>&nbsp;<span class="op" id="7202335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202339">t</span><span class="op" id="7202340">.</span><span class="ident" id="7202341">Fatal</span><span class="op" id="7202346">(</span><span class="ident" id="7202347">err</span><span class="op" id="7202350">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7202356">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202379">rows</span><span class="op" id="7202383">,</span>&nbsp;<span class="ident" id="7202385">err</span>&nbsp;<span class="op" id="7202389">=</span>&nbsp;<span class="ident" id="7202391">db</span><span class="op" id="7202393">.</span><span class="ident" id="7202394">Query</span><span class="op" id="7202399">(</span><span class="string" id="7202400">&#34;SELECT|people|name|&#34;</span><span class="op" id="7202421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202424">if</span>&nbsp;<span class="ident" id="7202427">err</span>&nbsp;<span class="op" id="7202431">!=</span>&nbsp;<span class="builtintype" id="7202434">nil</span>&nbsp;<span class="op" id="7202438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202442">t</span><span class="op" id="7202443">.</span><span class="ident" id="7202444">Fatal</span><span class="op" id="7202449">(</span><span class="ident" id="7202450">err</span><span class="op" id="7202453">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202459">if</span>&nbsp;<span class="ident" id="7202462">err</span>&nbsp;<span class="op" id="7202466">=</span>&nbsp;<span class="ident" id="7202468">rows</span><span class="op" id="7202472">.</span><span class="ident" id="7202473">Close</span><span class="op" id="7202478">(</span><span class="op" id="7202479">)</span><span class="op" id="7202480">;</span>&nbsp;<span class="ident" id="7202482">err</span>&nbsp;<span class="op" id="7202486">!=</span>&nbsp;<span class="builtintype" id="7202489">nil</span>&nbsp;<span class="op" id="7202493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202497">t</span><span class="op" id="7202498">.</span><span class="ident" id="7202499">Fatal</span><span class="op" id="7202504">(</span><span class="ident" id="7202505">err</span><span class="op" id="7202508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202511">}</span><br>
<span class="lineno"></span><span class="op" id="7202513">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="7202516">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="7202541">func</span>&nbsp;<span class="ident" id="7202546">TestStmtCloseDeps</span><span class="op" id="7202563">(</span><span class="ident" id="7202564">t</span>&nbsp;<span class="op" id="7202566">*</span><span class="ident" id="7202567">testing</span><span class="op" id="7202574">.</span><span class="ident" id="7202575">T</span><span class="op" id="7202576">)</span>&nbsp;<span class="op" id="7202578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202581">if</span>&nbsp;<span class="ident" id="7202584">testing</span><span class="op" id="7202591">.</span><span class="ident" id="7202592">Short</span><span class="op" id="7202597">(</span><span class="op" id="7202598">)</span>&nbsp;<span class="op" id="7202600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202604">t</span><span class="op" id="7202605">.</span><span class="ident" id="7202606">Skip</span><span class="op" id="7202610">(</span><span class="string" id="7202611">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7202635">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202641">defer</span>&nbsp;<span class="ident" id="7202647">setHookpostCloseConn</span><span class="op" id="7202667">(</span><span class="builtintype" id="7202668">nil</span><span class="op" id="7202671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202674">setHookpostCloseConn</span><span class="op" id="7202694">(</span><span class="keyword" id="7202695">func</span><span class="op" id="7202699">(</span><span class="ident" id="7202700">_</span>&nbsp;<span class="op" id="7202702">*</span><span class="ident" id="7202703">fakeConn</span><span class="op" id="7202711">,</span>&nbsp;<span class="ident" id="7202713">err</span>&nbsp;<span class="builtintype" id="7202717">error</span><span class="op" id="7202722">)</span>&nbsp;<span class="op" id="7202724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202728">if</span>&nbsp;<span class="ident" id="7202731">err</span>&nbsp;<span class="op" id="7202735">!=</span>&nbsp;<span class="builtintype" id="7202738">nil</span>&nbsp;<span class="op" id="7202742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202747">t</span><span class="op" id="7202748">.</span><span class="ident" id="7202749">Errorf</span><span class="op" id="7202755">(</span><span class="string" id="7202756">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7202784">,</span>&nbsp;<span class="ident" id="7202786">err</span><span class="op" id="7202789">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7202796">}</span><span class="op" id="7202797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202801">db</span>&nbsp;<span class="op" id="7202804">:=</span>&nbsp;<span class="ident" id="7202807">newTestDB</span><span class="op" id="7202816">(</span><span class="ident" id="7202817">t</span><span class="op" id="7202818">,</span>&nbsp;<span class="string" id="7202820">&#34;magicquery&#34;</span><span class="op" id="7202832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7202835">defer</span>&nbsp;<span class="ident" id="7202841">closeDB</span><span class="op" id="7202848">(</span><span class="ident" id="7202849">t</span><span class="op" id="7202850">,</span>&nbsp;<span class="ident" id="7202852">db</span><span class="op" id="7202854">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202858">driver</span>&nbsp;<span class="op" id="7202865">:=</span>&nbsp;<span class="ident" id="7202868">db</span><span class="op" id="7202870">.</span><span class="ident" id="7202871">driver</span><span class="op" id="7202877">.</span><span class="op" id="7202878">(</span><span class="op" id="7202879">*</span><span class="ident" id="7202880">fakeDriver</span><span class="op" id="7202890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202894">driver</span><span class="op" id="7202900">.</span><span class="ident" id="7202901">mu</span><span class="op" id="7202903">.</span><span class="ident" id="7202904">Lock</span><span class="op" id="7202908">(</span><span class="op" id="7202909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202912">opens0</span>&nbsp;<span class="op" id="7202919">:=</span>&nbsp;<span class="ident" id="7202922">driver</span><span class="op" id="7202928">.</span><span class="ident" id="7202929">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202940">closes0</span>&nbsp;<span class="op" id="7202948">:=</span>&nbsp;<span class="ident" id="7202951">driver</span><span class="op" id="7202957">.</span><span class="ident" id="7202958">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202970">driver</span><span class="op" id="7202976">.</span><span class="ident" id="7202977">mu</span><span class="op" id="7202979">.</span><span class="ident" id="7202980">Unlock</span><span class="op" id="7202986">(</span><span class="op" id="7202987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7202990">openDelta0</span>&nbsp;<span class="op" id="7203001">:=</span>&nbsp;<span class="ident" id="7203004">opens0</span>&nbsp;<span class="op" id="7203011">-</span>&nbsp;<span class="ident" id="7203013">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203023">stmt</span><span class="op" id="7203027">,</span>&nbsp;<span class="ident" id="7203029">err</span>&nbsp;<span class="op" id="7203033">:=</span>&nbsp;<span class="ident" id="7203036">db</span><span class="op" id="7203038">.</span><span class="ident" id="7203039">Prepare</span><span class="op" id="7203046">(</span><span class="string" id="7203047">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7203083">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203086">if</span>&nbsp;<span class="ident" id="7203089">err</span>&nbsp;<span class="op" id="7203093">!=</span>&nbsp;<span class="builtintype" id="7203096">nil</span>&nbsp;<span class="op" id="7203100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203104">t</span><span class="op" id="7203105">.</span><span class="ident" id="7203106">Fatal</span><span class="op" id="7203111">(</span><span class="ident" id="7203112">err</span><span class="op" id="7203115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7203122">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203158">const</span>&nbsp;<span class="op" id="7203164">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203168">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203180">=</span>&nbsp;<span class="num" id="7203182">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203187">sleepMillis</span>&nbsp;<span class="op" id="7203199">=</span>&nbsp;<span class="num" id="7203201">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203206">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203218">=</span>&nbsp;<span class="num" id="7203220">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203223">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203226">var</span>&nbsp;<span class="ident" id="7203230">wg</span>&nbsp;<span class="ident" id="7203233">sync</span><span class="op" id="7203237">.</span><span class="ident" id="7203238">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203249">for</span>&nbsp;<span class="ident" id="7203253">batch</span>&nbsp;<span class="op" id="7203259">:=</span>&nbsp;<span class="num" id="7203262">0</span><span class="op" id="7203263">;</span>&nbsp;<span class="ident" id="7203265">batch</span>&nbsp;<span class="op" id="7203271">&lt;</span>&nbsp;<span class="ident" id="7203273">nbatch</span><span class="op" id="7203279">;</span>&nbsp;<span class="ident" id="7203281">batch</span><span class="op" id="7203286">++</span>&nbsp;<span class="op" id="7203289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203293">for</span>&nbsp;<span class="ident" id="7203297">i</span>&nbsp;<span class="op" id="7203299">:=</span>&nbsp;<span class="num" id="7203302">0</span><span class="op" id="7203303">;</span>&nbsp;<span class="ident" id="7203305">i</span>&nbsp;<span class="op" id="7203307">&lt;</span>&nbsp;<span class="ident" id="7203309">nquery</span><span class="op" id="7203315">;</span>&nbsp;<span class="ident" id="7203317">i</span><span class="op" id="7203318">++</span>&nbsp;<span class="op" id="7203321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203326">wg</span><span class="op" id="7203328">.</span><span class="ident" id="7203329">Add</span><span class="op" id="7203332">(</span><span class="num" id="7203333">1</span><span class="op" id="7203334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203339">go</span>&nbsp;<span class="keyword" id="7203342">func</span><span class="op" id="7203346">(</span><span class="op" id="7203347">)</span>&nbsp;<span class="op" id="7203349">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203355">defer</span>&nbsp;<span class="ident" id="7203361">wg</span><span class="op" id="7203363">.</span><span class="ident" id="7203364">Done</span><span class="op" id="7203368">(</span><span class="op" id="7203369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203375">var</span>&nbsp;<span class="ident" id="7203379">op</span>&nbsp;<span class="builtintype" id="7203382">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203393">if</span>&nbsp;<span class="ident" id="7203396">err</span>&nbsp;<span class="op" id="7203400">:=</span>&nbsp;<span class="ident" id="7203403">stmt</span><span class="op" id="7203407">.</span><span class="ident" id="7203408">QueryRow</span><span class="op" id="7203416">(</span><span class="string" id="7203417">&#34;sleep&#34;</span><span class="op" id="7203424">,</span>&nbsp;<span class="ident" id="7203426">sleepMillis</span><span class="op" id="7203437">)</span><span class="op" id="7203438">.</span><span class="ident" id="7203439">Scan</span><span class="op" id="7203443">(</span><span class="op" id="7203444">&amp;</span><span class="ident" id="7203445">op</span><span class="op" id="7203447">)</span><span class="op" id="7203448">;</span>&nbsp;<span class="ident" id="7203450">err</span>&nbsp;<span class="op" id="7203454">!=</span>&nbsp;<span class="builtintype" id="7203457">nil</span>&nbsp;<span class="op" id="7203461">&amp;&amp;</span>&nbsp;<span class="ident" id="7203464">err</span>&nbsp;<span class="op" id="7203468">!=</span>&nbsp;<span class="ident" id="7203471">ErrNoRows</span>&nbsp;<span class="op" id="7203481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203488">t</span><span class="op" id="7203489">.</span><span class="ident" id="7203490">Error</span><span class="op" id="7203495">(</span><span class="ident" id="7203496">err</span><span class="op" id="7203499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203505">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203510">}</span><span class="op" id="7203511">(</span><span class="op" id="7203512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7203520">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7203577">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7203634">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203655">time</span><span class="op" id="7203659">.</span><span class="ident" id="7203660">Sleep</span><span class="op" id="7203665">(</span><span class="num" id="7203666">2</span>&nbsp;<span class="op" id="7203668">*</span>&nbsp;<span class="ident" id="7203670">sleepMillis</span>&nbsp;<span class="op" id="7203682">*</span>&nbsp;<span class="ident" id="7203684">time</span><span class="op" id="7203688">.</span><span class="ident" id="7203689">Millisecond</span><span class="op" id="7203700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203706">wg</span><span class="op" id="7203708">.</span><span class="ident" id="7203709">Wait</span><span class="op" id="7203713">(</span><span class="op" id="7203714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203718">if</span>&nbsp;<span class="ident" id="7203721">g</span><span class="op" id="7203722">,</span>&nbsp;<span class="ident" id="7203724">w</span>&nbsp;<span class="op" id="7203726">:=</span>&nbsp;<span class="ident" id="7203729">db</span><span class="op" id="7203731">.</span><span class="ident" id="7203732">numFreeConns</span><span class="op" id="7203744">(</span><span class="op" id="7203745">)</span><span class="op" id="7203746">,</span>&nbsp;<span class="num" id="7203748">2</span><span class="op" id="7203749">;</span>&nbsp;<span class="ident" id="7203751">g</span>&nbsp;<span class="op" id="7203753">!=</span>&nbsp;<span class="ident" id="7203756">w</span>&nbsp;<span class="op" id="7203758">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203762">t</span><span class="op" id="7203763">.</span><span class="ident" id="7203764">Errorf</span><span class="op" id="7203770">(</span><span class="string" id="7203771">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7203797">,</span>&nbsp;<span class="ident" id="7203799">g</span><span class="op" id="7203800">,</span>&nbsp;<span class="ident" id="7203802">w</span><span class="op" id="7203803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7203810">if</span>&nbsp;<span class="ident" id="7203813">n</span>&nbsp;<span class="op" id="7203815">:=</span>&nbsp;<span class="ident" id="7203818">db</span><span class="op" id="7203820">.</span><span class="ident" id="7203821">numDepsPollUntil</span><span class="op" id="7203837">(</span><span class="num" id="7203838">4</span><span class="op" id="7203839">,</span>&nbsp;<span class="ident" id="7203841">time</span><span class="op" id="7203845">.</span><span class="ident" id="7203846">Second</span><span class="op" id="7203852">)</span><span class="op" id="7203853">;</span>&nbsp;<span class="ident" id="7203855">n</span>&nbsp;<span class="op" id="7203857">&gt;</span>&nbsp;<span class="num" id="7203859">4</span>&nbsp;<span class="op" id="7203861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203865">t</span><span class="op" id="7203866">.</span><span class="ident" id="7203867">Errorf</span><span class="op" id="7203873">(</span><span class="string" id="7203874">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="7203918">,</span>&nbsp;<span class="ident" id="7203920">n</span><span class="op" id="7203921">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203925">db</span><span class="op" id="7203927">.</span><span class="ident" id="7203928">dumpDeps</span><span class="op" id="7203936">(</span><span class="ident" id="7203937">t</span><span class="op" id="7203938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7203941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203945">driver</span><span class="op" id="7203951">.</span><span class="ident" id="7203952">mu</span><span class="op" id="7203954">.</span><span class="ident" id="7203955">Lock</span><span class="op" id="7203959">(</span><span class="op" id="7203960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203963">opens</span>&nbsp;<span class="op" id="7203969">:=</span>&nbsp;<span class="ident" id="7203972">driver</span><span class="op" id="7203978">.</span><span class="ident" id="7203979">openCount</span>&nbsp;<span class="op" id="7203989">-</span>&nbsp;<span class="ident" id="7203991">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7203999">closes</span>&nbsp;<span class="op" id="7204006">:=</span>&nbsp;<span class="ident" id="7204009">driver</span><span class="op" id="7204015">.</span><span class="ident" id="7204016">closeCount</span>&nbsp;<span class="op" id="7204027">-</span>&nbsp;<span class="ident" id="7204029">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204038">openDelta</span>&nbsp;<span class="op" id="7204048">:=</span>&nbsp;<span class="op" id="7204051">(</span><span class="ident" id="7204052">driver</span><span class="op" id="7204058">.</span><span class="ident" id="7204059">openCount</span>&nbsp;<span class="op" id="7204069">-</span>&nbsp;<span class="ident" id="7204071">driver</span><span class="op" id="7204077">.</span><span class="ident" id="7204078">closeCount</span><span class="op" id="7204088">)</span>&nbsp;<span class="op" id="7204090">-</span>&nbsp;<span class="ident" id="7204092">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204104">driver</span><span class="op" id="7204110">.</span><span class="ident" id="7204111">mu</span><span class="op" id="7204113">.</span><span class="ident" id="7204114">Unlock</span><span class="op" id="7204120">(</span><span class="op" id="7204121">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204125">if</span>&nbsp;<span class="ident" id="7204128">openDelta</span>&nbsp;<span class="op" id="7204138">&gt;</span>&nbsp;<span class="num" id="7204140">2</span>&nbsp;<span class="op" id="7204142">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204146">t</span><span class="op" id="7204147">.</span><span class="ident" id="7204148">Logf</span><span class="op" id="7204152">(</span><span class="string" id="7204153">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7204170">,</span>&nbsp;<span class="ident" id="7204172">opens</span><span class="op" id="7204177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204181">t</span><span class="op" id="7204182">.</span><span class="ident" id="7204183">Logf</span><span class="op" id="7204187">(</span><span class="string" id="7204188">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7204206">,</span>&nbsp;<span class="ident" id="7204208">closes</span><span class="op" id="7204214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204218">t</span><span class="op" id="7204219">.</span><span class="ident" id="7204220">Logf</span><span class="op" id="7204224">(</span><span class="string" id="7204225">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7204242">,</span>&nbsp;<span class="ident" id="7204244">openDelta</span><span class="op" id="7204253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204257">t</span><span class="op" id="7204258">.</span><span class="ident" id="7204259">Errorf</span><span class="op" id="7204265">(</span><span class="string" id="7204266">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7204305">,</span>&nbsp;<span class="ident" id="7204307">openDelta</span><span class="op" id="7204316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204320">db</span><span class="op" id="7204322">.</span><span class="ident" id="7204323">dumpDeps</span><span class="op" id="7204331">(</span><span class="ident" id="7204332">t</span><span class="op" id="7204333">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204340">if</span>&nbsp;<span class="builtinfunc" id="7204343">len</span><span class="op" id="7204346">(</span><span class="ident" id="7204347">stmt</span><span class="op" id="7204351">.</span><span class="ident" id="7204352">css</span><span class="op" id="7204355">)</span>&nbsp;<span class="op" id="7204357">&gt;</span>&nbsp;<span class="ident" id="7204359">nquery</span>&nbsp;<span class="op" id="7204366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204370">t</span><span class="op" id="7204371">.</span><span class="ident" id="7204372">Errorf</span><span class="op" id="7204378">(</span><span class="string" id="7204379">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="7204411">,</span>&nbsp;<span class="builtinfunc" id="7204413">len</span><span class="op" id="7204416">(</span><span class="ident" id="7204417">stmt</span><span class="op" id="7204421">.</span><span class="ident" id="7204422">css</span><span class="op" id="7204425">)</span><span class="op" id="7204426">,</span>&nbsp;<span class="ident" id="7204428">nquery</span><span class="op" id="7204434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204437">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204441">if</span>&nbsp;<span class="ident" id="7204444">err</span>&nbsp;<span class="op" id="7204448">:=</span>&nbsp;<span class="ident" id="7204451">stmt</span><span class="op" id="7204455">.</span><span class="ident" id="7204456">Close</span><span class="op" id="7204461">(</span><span class="op" id="7204462">)</span><span class="op" id="7204463">;</span>&nbsp;<span class="ident" id="7204465">err</span>&nbsp;<span class="op" id="7204469">!=</span>&nbsp;<span class="builtintype" id="7204472">nil</span>&nbsp;<span class="op" id="7204476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204480">t</span><span class="op" id="7204481">.</span><span class="ident" id="7204482">Fatal</span><span class="op" id="7204487">(</span><span class="ident" id="7204488">err</span><span class="op" id="7204491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204498">if</span>&nbsp;<span class="ident" id="7204501">g</span><span class="op" id="7204502">,</span>&nbsp;<span class="ident" id="7204504">w</span>&nbsp;<span class="op" id="7204506">:=</span>&nbsp;<span class="ident" id="7204509">db</span><span class="op" id="7204511">.</span><span class="ident" id="7204512">numFreeConns</span><span class="op" id="7204524">(</span><span class="op" id="7204525">)</span><span class="op" id="7204526">,</span>&nbsp;<span class="num" id="7204528">2</span><span class="op" id="7204529">;</span>&nbsp;<span class="ident" id="7204531">g</span>&nbsp;<span class="op" id="7204533">!=</span>&nbsp;<span class="ident" id="7204536">w</span>&nbsp;<span class="op" id="7204538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204542">t</span><span class="op" id="7204543">.</span><span class="ident" id="7204544">Errorf</span><span class="op" id="7204550">(</span><span class="string" id="7204551">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7204577">,</span>&nbsp;<span class="ident" id="7204579">g</span><span class="op" id="7204580">,</span>&nbsp;<span class="ident" id="7204582">w</span><span class="op" id="7204583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204590">if</span>&nbsp;<span class="ident" id="7204593">n</span>&nbsp;<span class="op" id="7204595">:=</span>&nbsp;<span class="ident" id="7204598">db</span><span class="op" id="7204600">.</span><span class="ident" id="7204601">numDepsPollUntil</span><span class="op" id="7204617">(</span><span class="num" id="7204618">2</span><span class="op" id="7204619">,</span>&nbsp;<span class="ident" id="7204621">time</span><span class="op" id="7204625">.</span><span class="ident" id="7204626">Second</span><span class="op" id="7204632">)</span><span class="op" id="7204633">;</span>&nbsp;<span class="ident" id="7204635">n</span>&nbsp;<span class="op" id="7204637">&gt;</span>&nbsp;<span class="num" id="7204639">2</span>&nbsp;<span class="op" id="7204641">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204645">t</span><span class="op" id="7204646">.</span><span class="ident" id="7204647">Errorf</span><span class="op" id="7204653">(</span><span class="string" id="7204654">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7204698">,</span>&nbsp;<span class="ident" id="7204700">n</span><span class="op" id="7204701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204705">db</span><span class="op" id="7204707">.</span><span class="ident" id="7204708">dumpDeps</span><span class="op" id="7204716">(</span><span class="ident" id="7204717">t</span><span class="op" id="7204718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204725">db</span><span class="op" id="7204727">.</span><span class="ident" id="7204728">SetMaxIdleConns</span><span class="op" id="7204743">(</span><span class="num" id="7204744">0</span><span class="op" id="7204745">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204749">if</span>&nbsp;<span class="ident" id="7204752">g</span><span class="op" id="7204753">,</span>&nbsp;<span class="ident" id="7204755">w</span>&nbsp;<span class="op" id="7204757">:=</span>&nbsp;<span class="ident" id="7204760">db</span><span class="op" id="7204762">.</span><span class="ident" id="7204763">numFreeConns</span><span class="op" id="7204775">(</span><span class="op" id="7204776">)</span><span class="op" id="7204777">,</span>&nbsp;<span class="num" id="7204779">0</span><span class="op" id="7204780">;</span>&nbsp;<span class="ident" id="7204782">g</span>&nbsp;<span class="op" id="7204784">!=</span>&nbsp;<span class="ident" id="7204787">w</span>&nbsp;<span class="op" id="7204789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204793">t</span><span class="op" id="7204794">.</span><span class="ident" id="7204795">Errorf</span><span class="op" id="7204801">(</span><span class="string" id="7204802">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7204828">,</span>&nbsp;<span class="ident" id="7204830">g</span><span class="op" id="7204831">,</span>&nbsp;<span class="ident" id="7204833">w</span><span class="op" id="7204834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7204841">if</span>&nbsp;<span class="ident" id="7204844">n</span>&nbsp;<span class="op" id="7204846">:=</span>&nbsp;<span class="ident" id="7204849">db</span><span class="op" id="7204851">.</span><span class="ident" id="7204852">numDepsPollUntil</span><span class="op" id="7204868">(</span><span class="num" id="7204869">0</span><span class="op" id="7204870">,</span>&nbsp;<span class="ident" id="7204872">time</span><span class="op" id="7204876">.</span><span class="ident" id="7204877">Second</span><span class="op" id="7204883">)</span><span class="op" id="7204884">;</span>&nbsp;<span class="ident" id="7204886">n</span>&nbsp;<span class="op" id="7204888">&gt;</span>&nbsp;<span class="num" id="7204890">0</span>&nbsp;<span class="op" id="7204892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204896">t</span><span class="op" id="7204897">.</span><span class="ident" id="7204898">Errorf</span><span class="op" id="7204904">(</span><span class="string" id="7204905">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7204946">,</span>&nbsp;<span class="ident" id="7204948">n</span><span class="op" id="7204949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7204953">db</span><span class="op" id="7204955">.</span><span class="ident" id="7204956">dumpDeps</span><span class="op" id="7204964">(</span><span class="ident" id="7204965">t</span><span class="op" id="7204966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7204969">}</span><br>
<span class="lineno"></span><span class="op" id="7204971">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="7204974">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="7204999">func</span>&nbsp;<span class="ident" id="7205004">TestCloseConnBeforeStmts</span><span class="op" id="7205028">(</span><span class="ident" id="7205029">t</span>&nbsp;<span class="op" id="7205031">*</span><span class="ident" id="7205032">testing</span><span class="op" id="7205039">.</span><span class="ident" id="7205040">T</span><span class="op" id="7205041">)</span>&nbsp;<span class="op" id="7205043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205046">db</span>&nbsp;<span class="op" id="7205049">:=</span>&nbsp;<span class="ident" id="7205052">newTestDB</span><span class="op" id="7205061">(</span><span class="ident" id="7205062">t</span><span class="op" id="7205063">,</span>&nbsp;<span class="string" id="7205065">&#34;people&#34;</span><span class="op" id="7205073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205076">defer</span>&nbsp;<span class="ident" id="7205082">closeDB</span><span class="op" id="7205089">(</span><span class="ident" id="7205090">t</span><span class="op" id="7205091">,</span>&nbsp;<span class="ident" id="7205093">db</span><span class="op" id="7205095">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205099">defer</span>&nbsp;<span class="ident" id="7205105">setHookpostCloseConn</span><span class="op" id="7205125">(</span><span class="builtintype" id="7205126">nil</span><span class="op" id="7205129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205132">setHookpostCloseConn</span><span class="op" id="7205152">(</span><span class="keyword" id="7205153">func</span><span class="op" id="7205157">(</span><span class="ident" id="7205158">_</span>&nbsp;<span class="op" id="7205160">*</span><span class="ident" id="7205161">fakeConn</span><span class="op" id="7205169">,</span>&nbsp;<span class="ident" id="7205171">err</span>&nbsp;<span class="builtintype" id="7205175">error</span><span class="op" id="7205180">)</span>&nbsp;<span class="op" id="7205182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205186">if</span>&nbsp;<span class="ident" id="7205189">err</span>&nbsp;<span class="op" id="7205193">!=</span>&nbsp;<span class="builtintype" id="7205196">nil</span>&nbsp;<span class="op" id="7205200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205205">t</span><span class="op" id="7205206">.</span><span class="ident" id="7205207">Errorf</span><span class="op" id="7205213">(</span><span class="string" id="7205214">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="7205251">,</span>&nbsp;<span class="ident" id="7205253">err</span><span class="op" id="7205256">,</span>&nbsp;<span class="ident" id="7205258">stack</span><span class="op" id="7205263">(</span><span class="op" id="7205264">)</span><span class="op" id="7205265">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205270">db</span><span class="op" id="7205272">.</span><span class="ident" id="7205273">dumpDeps</span><span class="op" id="7205281">(</span><span class="ident" id="7205282">t</span><span class="op" id="7205283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205288">t</span><span class="op" id="7205289">.</span><span class="ident" id="7205290">Errorf</span><span class="op" id="7205296">(</span><span class="string" id="7205297">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7205307">,</span>&nbsp;<span class="ident" id="7205309">db</span><span class="op" id="7205311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205318">}</span><span class="op" id="7205319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205323">stmt</span><span class="op" id="7205327">,</span>&nbsp;<span class="ident" id="7205329">err</span>&nbsp;<span class="op" id="7205333">:=</span>&nbsp;<span class="ident" id="7205336">db</span><span class="op" id="7205338">.</span><span class="ident" id="7205339">Prepare</span><span class="op" id="7205346">(</span><span class="string" id="7205347">&#34;SELECT|people|name|&#34;</span><span class="op" id="7205368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205371">if</span>&nbsp;<span class="ident" id="7205374">err</span>&nbsp;<span class="op" id="7205378">!=</span>&nbsp;<span class="builtintype" id="7205381">nil</span>&nbsp;<span class="op" id="7205385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205389">t</span><span class="op" id="7205390">.</span><span class="ident" id="7205391">Fatal</span><span class="op" id="7205396">(</span><span class="ident" id="7205397">err</span><span class="op" id="7205400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205407">if</span>&nbsp;<span class="builtinfunc" id="7205410">len</span><span class="op" id="7205413">(</span><span class="ident" id="7205414">db</span><span class="op" id="7205416">.</span><span class="ident" id="7205417">freeConn</span><span class="op" id="7205425">)</span>&nbsp;<span class="op" id="7205427">!=</span>&nbsp;<span class="num" id="7205430">1</span>&nbsp;<span class="op" id="7205432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205436">t</span><span class="op" id="7205437">.</span><span class="ident" id="7205438">Fatalf</span><span class="op" id="7205444">(</span><span class="string" id="7205445">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7205474">,</span>&nbsp;<span class="builtinfunc" id="7205476">len</span><span class="op" id="7205479">(</span><span class="ident" id="7205480">db</span><span class="op" id="7205482">.</span><span class="ident" id="7205483">freeConn</span><span class="op" id="7205491">)</span><span class="op" id="7205492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205498">dc</span>&nbsp;<span class="op" id="7205501">:=</span>&nbsp;<span class="ident" id="7205504">db</span><span class="op" id="7205506">.</span><span class="ident" id="7205507">freeConn</span><span class="op" id="7205515">[</span><span class="num" id="7205516">0</span><span class="op" id="7205517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205520">if</span>&nbsp;<span class="ident" id="7205523">dc</span><span class="op" id="7205525">.</span><span class="ident" id="7205526">closed</span>&nbsp;<span class="op" id="7205533">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205537">t</span><span class="op" id="7205538">.</span><span class="ident" id="7205539">Errorf</span><span class="op" id="7205545">(</span><span class="string" id="7205546">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7205572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205579">if</span>&nbsp;<span class="ident" id="7205582">n</span>&nbsp;<span class="op" id="7205584">:=</span>&nbsp;<span class="builtinfunc" id="7205587">len</span><span class="op" id="7205590">(</span><span class="ident" id="7205591">dc</span><span class="op" id="7205593">.</span><span class="ident" id="7205594">openStmt</span><span class="op" id="7205602">)</span><span class="op" id="7205603">;</span>&nbsp;<span class="ident" id="7205605">n</span>&nbsp;<span class="op" id="7205607">!=</span>&nbsp;<span class="num" id="7205610">1</span>&nbsp;<span class="op" id="7205612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205616">t</span><span class="op" id="7205617">.</span><span class="ident" id="7205618">Errorf</span><span class="op" id="7205624">(</span><span class="string" id="7205625">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7205663">,</span>&nbsp;<span class="ident" id="7205665">n</span><span class="op" id="7205666">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205672">err</span>&nbsp;<span class="op" id="7205676">=</span>&nbsp;<span class="ident" id="7205678">db</span><span class="op" id="7205680">.</span><span class="ident" id="7205681">Close</span><span class="op" id="7205686">(</span><span class="op" id="7205687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205690">if</span>&nbsp;<span class="ident" id="7205693">err</span>&nbsp;<span class="op" id="7205697">!=</span>&nbsp;<span class="builtintype" id="7205700">nil</span>&nbsp;<span class="op" id="7205704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205708">t</span><span class="op" id="7205709">.</span><span class="ident" id="7205710">Errorf</span><span class="op" id="7205716">(</span><span class="string" id="7205717">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7205732">,</span>&nbsp;<span class="ident" id="7205734">err</span><span class="op" id="7205737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205740">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205743">if</span>&nbsp;<span class="op" id="7205746">!</span><span class="ident" id="7205747">dc</span><span class="op" id="7205749">.</span><span class="ident" id="7205750">closed</span>&nbsp;<span class="op" id="7205757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205761">t</span><span class="op" id="7205762">.</span><span class="ident" id="7205763">Errorf</span><span class="op" id="7205769">(</span><span class="string" id="7205770">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7205815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205821">if</span>&nbsp;<span class="ident" id="7205824">n</span>&nbsp;<span class="op" id="7205826">:=</span>&nbsp;<span class="builtinfunc" id="7205829">len</span><span class="op" id="7205832">(</span><span class="ident" id="7205833">dc</span><span class="op" id="7205835">.</span><span class="ident" id="7205836">openStmt</span><span class="op" id="7205844">)</span><span class="op" id="7205845">;</span>&nbsp;<span class="ident" id="7205847">n</span>&nbsp;<span class="op" id="7205849">!=</span>&nbsp;<span class="num" id="7205852">0</span>&nbsp;<span class="op" id="7205854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205858">t</span><span class="op" id="7205859">.</span><span class="ident" id="7205860">Errorf</span><span class="op" id="7205866">(</span><span class="string" id="7205867">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7205905">,</span>&nbsp;<span class="ident" id="7205907">n</span><span class="op" id="7205908">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205915">err</span>&nbsp;<span class="op" id="7205919">=</span>&nbsp;<span class="ident" id="7205921">stmt</span><span class="op" id="7205925">.</span><span class="ident" id="7205926">Close</span><span class="op" id="7205931">(</span><span class="op" id="7205932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205935">if</span>&nbsp;<span class="ident" id="7205938">err</span>&nbsp;<span class="op" id="7205942">!=</span>&nbsp;<span class="builtintype" id="7205945">nil</span>&nbsp;<span class="op" id="7205949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7205953">t</span><span class="op" id="7205954">.</span><span class="ident" id="7205955">Errorf</span><span class="op" id="7205961">(</span><span class="string" id="7205962">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7205979">,</span>&nbsp;<span class="ident" id="7205981">err</span><span class="op" id="7205984">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7205987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7205991">if</span>&nbsp;<span class="op" id="7205994">!</span><span class="ident" id="7205995">dc</span><span class="op" id="7205997">.</span><span class="ident" id="7205998">closed</span>&nbsp;<span class="op" id="7206005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206009">t</span><span class="op" id="7206010">.</span><span class="ident" id="7206011">Errorf</span><span class="op" id="7206017">(</span><span class="string" id="7206018">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7206041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206044">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206047">if</span>&nbsp;<span class="ident" id="7206050">dc</span><span class="op" id="7206052">.</span><span class="ident" id="7206053">ci</span>&nbsp;<span class="op" id="7206056">!=</span>&nbsp;<span class="builtintype" id="7206059">nil</span>&nbsp;<span class="op" id="7206063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206067">t</span><span class="op" id="7206068">.</span><span class="ident" id="7206069">Errorf</span><span class="op" id="7206075">(</span><span class="string" id="7206076">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="7206137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206140">}</span><br>
<span class="lineno"></span><span class="op" id="7206142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="7206145">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="7206215">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="7206245">func</span>&nbsp;<span class="ident" id="7206250">TestRowsCloseOrder</span><span class="op" id="7206268">(</span><span class="ident" id="7206269">t</span>&nbsp;<span class="op" id="7206271">*</span><span class="ident" id="7206272">testing</span><span class="op" id="7206279">.</span><span class="ident" id="7206280">T</span><span class="op" id="7206281">)</span>&nbsp;<span class="op" id="7206283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206286">db</span>&nbsp;<span class="op" id="7206289">:=</span>&nbsp;<span class="ident" id="7206292">newTestDB</span><span class="op" id="7206301">(</span><span class="ident" id="7206302">t</span><span class="op" id="7206303">,</span>&nbsp;<span class="string" id="7206305">&#34;people&#34;</span><span class="op" id="7206313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206316">defer</span>&nbsp;<span class="ident" id="7206322">closeDB</span><span class="op" id="7206329">(</span><span class="ident" id="7206330">t</span><span class="op" id="7206331">,</span>&nbsp;<span class="ident" id="7206333">db</span><span class="op" id="7206335">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206339">db</span><span class="op" id="7206341">.</span><span class="ident" id="7206342">SetMaxIdleConns</span><span class="op" id="7206357">(</span><span class="num" id="7206358">0</span><span class="op" id="7206359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206362">setStrictFakeConnClose</span><span class="op" id="7206384">(</span><span class="ident" id="7206385">t</span><span class="op" id="7206386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206389">defer</span>&nbsp;<span class="ident" id="7206395">setStrictFakeConnClose</span><span class="op" id="7206417">(</span><span class="builtintype" id="7206418">nil</span><span class="op" id="7206421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206425">rows</span><span class="op" id="7206429">,</span>&nbsp;<span class="ident" id="7206431">err</span>&nbsp;<span class="op" id="7206435">:=</span>&nbsp;<span class="ident" id="7206438">db</span><span class="op" id="7206440">.</span><span class="ident" id="7206441">Query</span><span class="op" id="7206446">(</span><span class="string" id="7206447">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7206472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206475">if</span>&nbsp;<span class="ident" id="7206478">err</span>&nbsp;<span class="op" id="7206482">!=</span>&nbsp;<span class="builtintype" id="7206485">nil</span>&nbsp;<span class="op" id="7206489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206493">t</span><span class="op" id="7206494">.</span><span class="ident" id="7206495">Fatal</span><span class="op" id="7206500">(</span><span class="ident" id="7206501">err</span><span class="op" id="7206504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206510">err</span>&nbsp;<span class="op" id="7206514">=</span>&nbsp;<span class="ident" id="7206516">rows</span><span class="op" id="7206520">.</span><span class="ident" id="7206521">Close</span><span class="op" id="7206526">(</span><span class="op" id="7206527">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206530">if</span>&nbsp;<span class="ident" id="7206533">err</span>&nbsp;<span class="op" id="7206537">!=</span>&nbsp;<span class="builtintype" id="7206540">nil</span>&nbsp;<span class="op" id="7206544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206548">t</span><span class="op" id="7206549">.</span><span class="ident" id="7206550">Fatal</span><span class="op" id="7206555">(</span><span class="ident" id="7206556">err</span><span class="op" id="7206559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206562">}</span><br>
<span class="lineno"></span><span class="op" id="7206564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="7206567">func</span>&nbsp;<span class="ident" id="7206572">TestRowsImplicitClose</span><span class="op" id="7206593">(</span><span class="ident" id="7206594">t</span>&nbsp;<span class="op" id="7206596">*</span><span class="ident" id="7206597">testing</span><span class="op" id="7206604">.</span><span class="ident" id="7206605">T</span><span class="op" id="7206606">)</span>&nbsp;<span class="op" id="7206608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206611">db</span>&nbsp;<span class="op" id="7206614">:=</span>&nbsp;<span class="ident" id="7206617">newTestDB</span><span class="op" id="7206626">(</span><span class="ident" id="7206627">t</span><span class="op" id="7206628">,</span>&nbsp;<span class="string" id="7206630">&#34;people&#34;</span><span class="op" id="7206638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206641">defer</span>&nbsp;<span class="ident" id="7206647">closeDB</span><span class="op" id="7206654">(</span><span class="ident" id="7206655">t</span><span class="op" id="7206656">,</span>&nbsp;<span class="ident" id="7206658">db</span><span class="op" id="7206660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206664">rows</span><span class="op" id="7206668">,</span>&nbsp;<span class="ident" id="7206670">err</span>&nbsp;<span class="op" id="7206674">:=</span>&nbsp;<span class="ident" id="7206677">db</span><span class="op" id="7206679">.</span><span class="ident" id="7206680">Query</span><span class="op" id="7206685">(</span><span class="string" id="7206686">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7206711">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206714">if</span>&nbsp;<span class="ident" id="7206717">err</span>&nbsp;<span class="op" id="7206721">!=</span>&nbsp;<span class="builtintype" id="7206724">nil</span>&nbsp;<span class="op" id="7206728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206732">t</span><span class="op" id="7206733">.</span><span class="ident" id="7206734">Fatal</span><span class="op" id="7206739">(</span><span class="ident" id="7206740">err</span><span class="op" id="7206743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206750">want</span><span class="op" id="7206754">,</span>&nbsp;<span class="ident" id="7206756">fail</span>&nbsp;<span class="op" id="7206761">:=</span>&nbsp;<span class="num" id="7206764">2</span><span class="op" id="7206765">,</span>&nbsp;<span class="ident" id="7206767">errors</span><span class="op" id="7206773">.</span><span class="ident" id="7206774">New</span><span class="op" id="7206777">(</span><span class="string" id="7206778">&#34;fail&#34;</span><span class="op" id="7206784">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206787">r</span>&nbsp;<span class="op" id="7206789">:=</span>&nbsp;<span class="ident" id="7206792">rows</span><span class="op" id="7206796">.</span><span class="ident" id="7206797">rowsi</span><span class="op" id="7206802">.</span><span class="op" id="7206803">(</span><span class="op" id="7206804">*</span><span class="ident" id="7206805">rowsCursor</span><span class="op" id="7206815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206818">r</span><span class="op" id="7206819">.</span><span class="ident" id="7206820">errPos</span><span class="op" id="7206826">,</span>&nbsp;<span class="ident" id="7206828">r</span><span class="op" id="7206829">.</span><span class="ident" id="7206830">err</span>&nbsp;<span class="op" id="7206834">=</span>&nbsp;<span class="ident" id="7206836">want</span><span class="op" id="7206840">,</span>&nbsp;<span class="ident" id="7206842">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206849">got</span>&nbsp;<span class="op" id="7206853">:=</span>&nbsp;<span class="num" id="7206856">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206859">for</span>&nbsp;<span class="ident" id="7206863">rows</span><span class="op" id="7206867">.</span><span class="ident" id="7206868">Next</span><span class="op" id="7206872">(</span><span class="op" id="7206873">)</span>&nbsp;<span class="op" id="7206875">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206879">got</span><span class="op" id="7206882">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206889">if</span>&nbsp;<span class="ident" id="7206892">got</span>&nbsp;<span class="op" id="7206896">!=</span>&nbsp;<span class="ident" id="7206899">want</span>&nbsp;<span class="op" id="7206904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206908">t</span><span class="op" id="7206909">.</span><span class="ident" id="7206910">Errorf</span><span class="op" id="7206916">(</span><span class="string" id="7206917">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7206939">,</span>&nbsp;<span class="ident" id="7206941">got</span><span class="op" id="7206944">,</span>&nbsp;<span class="ident" id="7206946">want</span><span class="op" id="7206950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7206953">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7206956">if</span>&nbsp;<span class="ident" id="7206959">err</span>&nbsp;<span class="op" id="7206963">:=</span>&nbsp;<span class="ident" id="7206966">rows</span><span class="op" id="7206970">.</span><span class="ident" id="7206971">Err</span><span class="op" id="7206974">(</span><span class="op" id="7206975">)</span><span class="op" id="7206976">;</span>&nbsp;<span class="ident" id="7206978">err</span>&nbsp;<span class="op" id="7206982">!=</span>&nbsp;<span class="ident" id="7206985">fail</span>&nbsp;<span class="op" id="7206990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7206994">t</span><span class="op" id="7206995">.</span><span class="ident" id="7206996">Errorf</span><span class="op" id="7207002">(</span><span class="string" id="7207003">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7207026">,</span>&nbsp;<span class="ident" id="7207028">err</span><span class="op" id="7207031">,</span>&nbsp;<span class="ident" id="7207033">fail</span><span class="op" id="7207037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207043">if</span>&nbsp;<span class="op" id="7207046">!</span><span class="ident" id="7207047">r</span><span class="op" id="7207048">.</span><span class="ident" id="7207049">closed</span>&nbsp;<span class="op" id="7207056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207060">t</span><span class="op" id="7207061">.</span><span class="ident" id="7207062">Errorf</span><span class="op" id="7207068">(</span><span class="string" id="7207069">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="7207099">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207102">}</span><br>
<span class="lineno"></span><span class="op" id="7207104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7207107">func</span>&nbsp;<span class="ident" id="7207112">TestStmtCloseOrder</span><span class="op" id="7207130">(</span><span class="ident" id="7207131">t</span>&nbsp;<span class="op" id="7207133">*</span><span class="ident" id="7207134">testing</span><span class="op" id="7207141">.</span><span class="ident" id="7207142">T</span><span class="op" id="7207143">)</span>&nbsp;<span class="op" id="7207145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207148">db</span>&nbsp;<span class="op" id="7207151">:=</span>&nbsp;<span class="ident" id="7207154">newTestDB</span><span class="op" id="7207163">(</span><span class="ident" id="7207164">t</span><span class="op" id="7207165">,</span>&nbsp;<span class="string" id="7207167">&#34;people&#34;</span><span class="op" id="7207175">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207178">defer</span>&nbsp;<span class="ident" id="7207184">closeDB</span><span class="op" id="7207191">(</span><span class="ident" id="7207192">t</span><span class="op" id="7207193">,</span>&nbsp;<span class="ident" id="7207195">db</span><span class="op" id="7207197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207201">db</span><span class="op" id="7207203">.</span><span class="ident" id="7207204">SetMaxIdleConns</span><span class="op" id="7207219">(</span><span class="num" id="7207220">0</span><span class="op" id="7207221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207224">setStrictFakeConnClose</span><span class="op" id="7207246">(</span><span class="ident" id="7207247">t</span><span class="op" id="7207248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207251">defer</span>&nbsp;<span class="ident" id="7207257">setStrictFakeConnClose</span><span class="op" id="7207279">(</span><span class="builtintype" id="7207280">nil</span><span class="op" id="7207283">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207287">_</span><span class="op" id="7207288">,</span>&nbsp;<span class="ident" id="7207290">err</span>&nbsp;<span class="op" id="7207294">:=</span>&nbsp;<span class="ident" id="7207297">db</span><span class="op" id="7207299">.</span><span class="ident" id="7207300">Query</span><span class="op" id="7207305">(</span><span class="string" id="7207306">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="7207333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207336">if</span>&nbsp;<span class="ident" id="7207339">err</span>&nbsp;<span class="op" id="7207343">==</span>&nbsp;<span class="builtintype" id="7207346">nil</span>&nbsp;<span class="op" id="7207350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207354">t</span><span class="op" id="7207355">.</span><span class="ident" id="7207356">Fatal</span><span class="op" id="7207361">(</span><span class="string" id="7207362">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="7207402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207405">}</span><br>
<span class="lineno">1315</span><span class="op" id="7207407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7207410">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="7207435">func</span>&nbsp;<span class="ident" id="7207440">TestErrBadConnReconnect</span><span class="op" id="7207463">(</span><span class="ident" id="7207464">t</span>&nbsp;<span class="op" id="7207466">*</span><span class="ident" id="7207467">testing</span><span class="op" id="7207474">.</span><span class="ident" id="7207475">T</span><span class="op" id="7207476">)</span>&nbsp;<span class="op" id="7207478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207481">db</span>&nbsp;<span class="op" id="7207484">:=</span>&nbsp;<span class="ident" id="7207487">newTestDB</span><span class="op" id="7207496">(</span><span class="ident" id="7207497">t</span><span class="op" id="7207498">,</span>&nbsp;<span class="string" id="7207500">&#34;foo&#34;</span><span class="op" id="7207505">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207508">defer</span>&nbsp;<span class="ident" id="7207514">closeDB</span><span class="op" id="7207521">(</span><span class="ident" id="7207522">t</span><span class="op" id="7207523">,</span>&nbsp;<span class="ident" id="7207525">db</span><span class="op" id="7207527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207530">exec</span><span class="op" id="7207534">(</span><span class="ident" id="7207535">t</span><span class="op" id="7207536">,</span>&nbsp;<span class="ident" id="7207538">db</span><span class="op" id="7207540">,</span>&nbsp;<span class="string" id="7207542">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7207585">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207589">simulateBadConn</span>&nbsp;<span class="op" id="7207605">:=</span>&nbsp;<span class="keyword" id="7207608">func</span><span class="op" id="7207612">(</span><span class="ident" id="7207613">name</span>&nbsp;<span class="builtintype" id="7207618">string</span><span class="op" id="7207624">,</span>&nbsp;<span class="ident" id="7207626">hook</span>&nbsp;<span class="op" id="7207631">*</span><span class="keyword" id="7207632">func</span><span class="op" id="7207636">(</span><span class="op" id="7207637">)</span>&nbsp;<span class="builtintype" id="7207639">bool</span><span class="op" id="7207643">,</span>&nbsp;<span class="ident" id="7207645">op</span>&nbsp;<span class="keyword" id="7207648">func</span><span class="op" id="7207652">(</span><span class="op" id="7207653">)</span>&nbsp;<span class="builtintype" id="7207655">error</span><span class="op" id="7207660">)</span>&nbsp;<span class="op" id="7207662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207666">broken</span><span class="op" id="7207672">,</span>&nbsp;<span class="ident" id="7207674">retried</span>&nbsp;<span class="op" id="7207682">:=</span>&nbsp;<span class="builtintype" id="7207685">false</span><span class="op" id="7207690">,</span>&nbsp;<span class="builtintype" id="7207692">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207700">numOpen</span>&nbsp;<span class="op" id="7207708">:=</span>&nbsp;<span class="ident" id="7207711">db</span><span class="op" id="7207713">.</span><span class="ident" id="7207714">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7207725">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207776">*</span><span class="ident" id="7207777">hook</span>&nbsp;<span class="op" id="7207782">=</span>&nbsp;<span class="keyword" id="7207784">func</span><span class="op" id="7207788">(</span><span class="op" id="7207789">)</span>&nbsp;<span class="builtintype" id="7207791">bool</span>&nbsp;<span class="op" id="7207796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207801">if</span>&nbsp;<span class="op" id="7207804">!</span><span class="ident" id="7207805">broken</span>&nbsp;<span class="op" id="7207812">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207818">broken</span>&nbsp;<span class="op" id="7207825">=</span>&nbsp;<span class="builtintype" id="7207827">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207836">return</span>&nbsp;<span class="builtintype" id="7207843">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207856">retried</span>&nbsp;<span class="op" id="7207864">=</span>&nbsp;<span class="builtintype" id="7207866">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207874">return</span>&nbsp;<span class="builtintype" id="7207881">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207894">if</span>&nbsp;<span class="ident" id="7207897">err</span>&nbsp;<span class="op" id="7207901">:=</span>&nbsp;<span class="ident" id="7207904">op</span><span class="op" id="7207906">(</span><span class="op" id="7207907">)</span><span class="op" id="7207908">;</span>&nbsp;<span class="ident" id="7207910">err</span>&nbsp;<span class="op" id="7207914">!=</span>&nbsp;<span class="builtintype" id="7207917">nil</span>&nbsp;<span class="op" id="7207921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207926">t</span><span class="op" id="7207927">.</span><span class="ident" id="7207928">Errorf</span><span class="op" id="7207934">(</span><span class="ident" id="7207935">name</span><span class="op" id="7207939">+</span><span class="string" id="7207940">&#34;:&nbsp;%v&#34;</span><span class="op" id="7207946">,</span>&nbsp;<span class="ident" id="7207948">err</span><span class="op" id="7207951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207956">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7207965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7207970">if</span>&nbsp;<span class="op" id="7207973">!</span><span class="ident" id="7207974">broken</span>&nbsp;<span class="op" id="7207981">||</span>&nbsp;<span class="op" id="7207984">!</span><span class="ident" id="7207985">retried</span>&nbsp;<span class="op" id="7207993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7207998">t</span><span class="op" id="7207999">.</span><span class="ident" id="7208000">Error</span><span class="op" id="7208005">(</span><span class="ident" id="7208006">name</span>&nbsp;<span class="op" id="7208011">+</span>&nbsp;<span class="string" id="7208013">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="7208053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208057">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208061">*</span><span class="ident" id="7208062">hook</span>&nbsp;<span class="op" id="7208067">=</span>&nbsp;<span class="builtintype" id="7208069">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208076">if</span>&nbsp;<span class="ident" id="7208079">numOpen</span>&nbsp;<span class="op" id="7208087">!=</span>&nbsp;<span class="ident" id="7208090">db</span><span class="op" id="7208092">.</span><span class="ident" id="7208093">numOpen</span>&nbsp;<span class="op" id="7208101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208106">t</span><span class="op" id="7208107">.</span><span class="ident" id="7208108">Errorf</span><span class="op" id="7208114">(</span><span class="ident" id="7208115">name</span><span class="op" id="7208119">+</span><span class="string" id="7208120">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="7208148">,</span>&nbsp;<span class="ident" id="7208150">db</span><span class="op" id="7208152">.</span><span class="ident" id="7208153">numOpen</span><span class="op" id="7208160">-</span><span class="ident" id="7208161">numOpen</span><span class="op" id="7208168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208173">numOpen</span>&nbsp;<span class="op" id="7208181">=</span>&nbsp;<span class="ident" id="7208183">db</span><span class="op" id="7208185">.</span><span class="ident" id="7208186">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7208203">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208215">dbExec</span>&nbsp;<span class="op" id="7208222">:=</span>&nbsp;<span class="keyword" id="7208225">func</span><span class="op" id="7208229">(</span><span class="op" id="7208230">)</span>&nbsp;<span class="builtintype" id="7208232">error</span>&nbsp;<span class="op" id="7208238">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208242">_</span><span class="op" id="7208243">,</span>&nbsp;<span class="ident" id="7208245">err</span>&nbsp;<span class="op" id="7208249">:=</span>&nbsp;<span class="ident" id="7208252">db</span><span class="op" id="7208254">.</span><span class="ident" id="7208255">Exec</span><span class="op" id="7208259">(</span><span class="string" id="7208260">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7208291">,</span>&nbsp;<span class="string" id="7208293">&#34;Gordon&#34;</span><span class="op" id="7208301">,</span>&nbsp;<span class="num" id="7208303">3</span><span class="op" id="7208304">,</span>&nbsp;<span class="builtintype" id="7208306">true</span><span class="op" id="7208310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208314">return</span>&nbsp;<span class="ident" id="7208321">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208329">simulateBadConn</span><span class="op" id="7208344">(</span><span class="string" id="7208345">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="7208362">,</span>&nbsp;<span class="op" id="7208364">&amp;</span><span class="ident" id="7208365">hookPrepareBadConn</span><span class="op" id="7208383">,</span>&nbsp;<span class="ident" id="7208385">dbExec</span><span class="op" id="7208391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208394">simulateBadConn</span><span class="op" id="7208409">(</span><span class="string" id="7208410">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="7208424">,</span>&nbsp;<span class="op" id="7208426">&amp;</span><span class="ident" id="7208427">hookExecBadConn</span><span class="op" id="7208442">,</span>&nbsp;<span class="ident" id="7208444">dbExec</span><span class="op" id="7208450">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7208454">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208467">dbQuery</span>&nbsp;<span class="op" id="7208475">:=</span>&nbsp;<span class="keyword" id="7208478">func</span><span class="op" id="7208482">(</span><span class="op" id="7208483">)</span>&nbsp;<span class="builtintype" id="7208485">error</span>&nbsp;<span class="op" id="7208491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208495">rows</span><span class="op" id="7208499">,</span>&nbsp;<span class="ident" id="7208501">err</span>&nbsp;<span class="op" id="7208505">:=</span>&nbsp;<span class="ident" id="7208508">db</span><span class="op" id="7208510">.</span><span class="ident" id="7208511">Query</span><span class="op" id="7208516">(</span><span class="string" id="7208517">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7208538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208542">if</span>&nbsp;<span class="ident" id="7208545">err</span>&nbsp;<span class="op" id="7208549">==</span>&nbsp;<span class="builtintype" id="7208552">nil</span>&nbsp;<span class="op" id="7208556">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208561">err</span>&nbsp;<span class="op" id="7208565">=</span>&nbsp;<span class="ident" id="7208567">rows</span><span class="op" id="7208571">.</span><span class="ident" id="7208572">Close</span><span class="op" id="7208577">(</span><span class="op" id="7208578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208586">return</span>&nbsp;<span class="ident" id="7208593">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208601">simulateBadConn</span><span class="op" id="7208616">(</span><span class="string" id="7208617">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="7208635">,</span>&nbsp;<span class="op" id="7208637">&amp;</span><span class="ident" id="7208638">hookPrepareBadConn</span><span class="op" id="7208656">,</span>&nbsp;<span class="ident" id="7208658">dbQuery</span><span class="op" id="7208665">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208668">simulateBadConn</span><span class="op" id="7208683">(</span><span class="string" id="7208684">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="7208700">,</span>&nbsp;<span class="op" id="7208702">&amp;</span><span class="ident" id="7208703">hookQueryBadConn</span><span class="op" id="7208719">,</span>&nbsp;<span class="ident" id="7208721">dbQuery</span><span class="op" id="7208728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7208732">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208747">simulateBadConn</span><span class="op" id="7208762">(</span><span class="string" id="7208763">&#34;db.Prepare&#34;</span><span class="op" id="7208775">,</span>&nbsp;<span class="op" id="7208777">&amp;</span><span class="ident" id="7208778">hookPrepareBadConn</span><span class="op" id="7208796">,</span>&nbsp;<span class="keyword" id="7208798">func</span><span class="op" id="7208802">(</span><span class="op" id="7208803">)</span>&nbsp;<span class="builtintype" id="7208805">error</span>&nbsp;<span class="op" id="7208811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208815">stmt</span><span class="op" id="7208819">,</span>&nbsp;<span class="ident" id="7208821">err</span>&nbsp;<span class="op" id="7208825">:=</span>&nbsp;<span class="ident" id="7208828">db</span><span class="op" id="7208830">.</span><span class="ident" id="7208831">Prepare</span><span class="op" id="7208838">(</span><span class="string" id="7208839">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7208870">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208874">if</span>&nbsp;<span class="ident" id="7208877">err</span>&nbsp;<span class="op" id="7208881">!=</span>&nbsp;<span class="builtintype" id="7208884">nil</span>&nbsp;<span class="op" id="7208888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208893">return</span>&nbsp;<span class="ident" id="7208900">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7208910">stmt</span><span class="op" id="7208914">.</span><span class="ident" id="7208915">Close</span><span class="op" id="7208920">(</span><span class="op" id="7208921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7208925">return</span>&nbsp;<span class="builtintype" id="7208932">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7208937">}</span><span class="op" id="7208938">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7208942">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209015">forcePrepare</span>&nbsp;<span class="op" id="7209028">:=</span>&nbsp;<span class="keyword" id="7209031">func</span><span class="op" id="7209035">(</span><span class="ident" id="7209036">stmt</span>&nbsp;<span class="op" id="7209041">*</span><span class="ident" id="7209042">Stmt</span><span class="op" id="7209046">)</span>&nbsp;<span class="op" id="7209048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209052">stmt</span><span class="op" id="7209056">.</span><span class="ident" id="7209057">css</span>&nbsp;<span class="op" id="7209061">=</span>&nbsp;<span class="builtintype" id="7209063">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7209068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7209072">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209086">stmt1</span><span class="op" id="7209091">,</span>&nbsp;<span class="ident" id="7209093">err</span>&nbsp;<span class="op" id="7209097">:=</span>&nbsp;<span class="ident" id="7209100">db</span><span class="op" id="7209102">.</span><span class="ident" id="7209103">Prepare</span><span class="op" id="7209110">(</span><span class="string" id="7209111">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7209142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209145">if</span>&nbsp;<span class="ident" id="7209148">err</span>&nbsp;<span class="op" id="7209152">!=</span>&nbsp;<span class="builtintype" id="7209155">nil</span>&nbsp;<span class="op" id="7209159">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209163">t</span><span class="op" id="7209164">.</span><span class="ident" id="7209165">Fatalf</span><span class="op" id="7209171">(</span><span class="string" id="7209172">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7209185">,</span>&nbsp;<span class="ident" id="7209187">err</span><span class="op" id="7209190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7209193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209196">defer</span>&nbsp;<span class="ident" id="7209202">stmt1</span><span class="op" id="7209207">.</span><span class="ident" id="7209208">Close</span><span class="op" id="7209213">(</span><span class="op" id="7209214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7209217">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209262">forcePrepare</span><span class="op" id="7209274">(</span><span class="ident" id="7209275">stmt1</span><span class="op" id="7209280">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209284">stmtExec</span>&nbsp;<span class="op" id="7209293">:=</span>&nbsp;<span class="keyword" id="7209296">func</span><span class="op" id="7209300">(</span><span class="op" id="7209301">)</span>&nbsp;<span class="builtintype" id="7209303">error</span>&nbsp;<span class="op" id="7209309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209313">_</span><span class="op" id="7209314">,</span>&nbsp;<span class="ident" id="7209316">err</span>&nbsp;<span class="op" id="7209320">:=</span>&nbsp;<span class="ident" id="7209323">stmt1</span><span class="op" id="7209328">.</span><span class="ident" id="7209329">Exec</span><span class="op" id="7209333">(</span><span class="string" id="7209334">&#34;Gopher&#34;</span><span class="op" id="7209342">,</span>&nbsp;<span class="num" id="7209344">3</span><span class="op" id="7209345">,</span>&nbsp;<span class="builtintype" id="7209347">false</span><span class="op" id="7209352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209356">return</span>&nbsp;<span class="ident" id="7209363">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7209368">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209371">simulateBadConn</span><span class="op" id="7209386">(</span><span class="string" id="7209387">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="7209406">,</span>&nbsp;<span class="op" id="7209408">&amp;</span><span class="ident" id="7209409">hookPrepareBadConn</span><span class="op" id="7209427">,</span>&nbsp;<span class="ident" id="7209429">stmtExec</span><span class="op" id="7209437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209440">simulateBadConn</span><span class="op" id="7209455">(</span><span class="string" id="7209456">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="7209472">,</span>&nbsp;<span class="op" id="7209474">&amp;</span><span class="ident" id="7209475">hookExecBadConn</span><span class="op" id="7209490">,</span>&nbsp;<span class="ident" id="7209492">stmtExec</span><span class="op" id="7209500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7209504">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209519">stmt2</span><span class="op" id="7209524">,</span>&nbsp;<span class="ident" id="7209526">err</span>&nbsp;<span class="op" id="7209530">:=</span>&nbsp;<span class="ident" id="7209533">db</span><span class="op" id="7209535">.</span><span class="ident" id="7209536">Prepare</span><span class="op" id="7209543">(</span><span class="string" id="7209544">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7209565">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209568">if</span>&nbsp;<span class="ident" id="7209571">err</span>&nbsp;<span class="op" id="7209575">!=</span>&nbsp;<span class="builtintype" id="7209578">nil</span>&nbsp;<span class="op" id="7209582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209586">t</span><span class="op" id="7209587">.</span><span class="ident" id="7209588">Fatalf</span><span class="op" id="7209594">(</span><span class="string" id="7209595">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7209608">,</span>&nbsp;<span class="ident" id="7209610">err</span><span class="op" id="7209613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7209616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209619">defer</span>&nbsp;<span class="ident" id="7209625">stmt2</span><span class="op" id="7209630">.</span><span class="ident" id="7209631">Close</span><span class="op" id="7209636">(</span><span class="op" id="7209637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7209640">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209685">forcePrepare</span><span class="op" id="7209697">(</span><span class="ident" id="7209698">stmt2</span><span class="op" id="7209703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209707">stmtQuery</span>&nbsp;<span class="op" id="7209717">:=</span>&nbsp;<span class="keyword" id="7209720">func</span><span class="op" id="7209724">(</span><span class="op" id="7209725">)</span>&nbsp;<span class="builtintype" id="7209727">error</span>&nbsp;<span class="op" id="7209733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209737">rows</span><span class="op" id="7209741">,</span>&nbsp;<span class="ident" id="7209743">err</span>&nbsp;<span class="op" id="7209747">:=</span>&nbsp;<span class="ident" id="7209750">stmt2</span><span class="op" id="7209755">.</span><span class="ident" id="7209756">Query</span><span class="op" id="7209761">(</span><span class="op" id="7209762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209766">if</span>&nbsp;<span class="ident" id="7209769">err</span>&nbsp;<span class="op" id="7209773">==</span>&nbsp;<span class="builtintype" id="7209776">nil</span>&nbsp;<span class="op" id="7209780">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209785">err</span>&nbsp;<span class="op" id="7209789">=</span>&nbsp;<span class="ident" id="7209791">rows</span><span class="op" id="7209795">.</span><span class="ident" id="7209796">Close</span><span class="op" id="7209801">(</span><span class="op" id="7209802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7209806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7209810">return</span>&nbsp;<span class="ident" id="7209817">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7209822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209825">simulateBadConn</span><span class="op" id="7209840">(</span><span class="string" id="7209841">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="7209861">,</span>&nbsp;<span class="op" id="7209863">&amp;</span><span class="ident" id="7209864">hookPrepareBadConn</span><span class="op" id="7209882">,</span>&nbsp;<span class="ident" id="7209884">stmtQuery</span><span class="op" id="7209893">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209896">simulateBadConn</span><span class="op" id="7209911">(</span><span class="string" id="7209912">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="7209929">,</span>&nbsp;<span class="op" id="7209931">&amp;</span><span class="ident" id="7209932">hookQueryBadConn</span><span class="op" id="7209948">,</span>&nbsp;<span class="ident" id="7209950">stmtQuery</span><span class="op" id="7209959">)</span><br>
<span class="lineno"></span><span class="op" id="7209961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7209964">type</span>&nbsp;<span class="ident" id="7209969">concurrentTest</span>&nbsp;<span class="keyword" id="7209984">interface</span>&nbsp;<span class="op" id="7209994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7209997">init</span><span class="op" id="7210001">(</span><span class="ident" id="7210002">t</span>&nbsp;<span class="ident" id="7210004">testing</span><span class="op" id="7210011">.</span><span class="ident" id="7210012">TB</span><span class="op" id="7210014">,</span>&nbsp;<span class="ident" id="7210016">db</span>&nbsp;<span class="op" id="7210019">*</span><span class="ident" id="7210020">DB</span><span class="op" id="7210022">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210025">finish</span><span class="op" id="7210031">(</span><span class="ident" id="7210032">t</span>&nbsp;<span class="ident" id="7210034">testing</span><span class="op" id="7210041">.</span><span class="ident" id="7210042">TB</span><span class="op" id="7210044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210047">test</span><span class="op" id="7210051">(</span><span class="ident" id="7210052">t</span>&nbsp;<span class="ident" id="7210054">testing</span><span class="op" id="7210061">.</span><span class="ident" id="7210062">TB</span><span class="op" id="7210064">)</span>&nbsp;<span class="builtintype" id="7210066">error</span><br>
<span class="lineno"></span><span class="op" id="7210072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7210075">type</span>&nbsp;<span class="ident" id="7210080">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="7210102">struct</span>&nbsp;<span class="op" id="7210109">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210112">db</span>&nbsp;<span class="op" id="7210115">*</span><span class="ident" id="7210116">DB</span><br>
<span class="lineno"></span><span class="op" id="7210119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7210122">func</span>&nbsp;<span class="op" id="7210127">(</span><span class="ident" id="7210128">c</span>&nbsp;<span class="op" id="7210130">*</span><span class="ident" id="7210131">concurrentDBQueryTest</span><span class="op" id="7210152">)</span>&nbsp;<span class="ident" id="7210154">init</span><span class="op" id="7210158">(</span><span class="ident" id="7210159">t</span>&nbsp;<span class="ident" id="7210161">testing</span><span class="op" id="7210168">.</span><span class="ident" id="7210169">TB</span><span class="op" id="7210171">,</span>&nbsp;<span class="ident" id="7210173">db</span>&nbsp;<span class="op" id="7210176">*</span><span class="ident" id="7210177">DB</span><span class="op" id="7210179">)</span>&nbsp;<span class="op" id="7210181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210184">c</span><span class="op" id="7210185">.</span><span class="ident" id="7210186">db</span>&nbsp;<span class="op" id="7210189">=</span>&nbsp;<span class="ident" id="7210191">db</span><br>
<span class="lineno">1435</span><span class="op" id="7210194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7210197">func</span>&nbsp;<span class="op" id="7210202">(</span><span class="ident" id="7210203">c</span>&nbsp;<span class="op" id="7210205">*</span><span class="ident" id="7210206">concurrentDBQueryTest</span><span class="op" id="7210227">)</span>&nbsp;<span class="ident" id="7210229">finish</span><span class="op" id="7210235">(</span><span class="ident" id="7210236">t</span>&nbsp;<span class="ident" id="7210238">testing</span><span class="op" id="7210245">.</span><span class="ident" id="7210246">TB</span><span class="op" id="7210248">)</span>&nbsp;<span class="op" id="7210250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210253">c</span><span class="op" id="7210254">.</span><span class="ident" id="7210255">db</span>&nbsp;<span class="op" id="7210258">=</span>&nbsp;<span class="builtintype" id="7210260">nil</span><br>
<span class="lineno"></span><span class="op" id="7210264">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="7210267">func</span>&nbsp;<span class="op" id="7210272">(</span><span class="ident" id="7210273">c</span>&nbsp;<span class="op" id="7210275">*</span><span class="ident" id="7210276">concurrentDBQueryTest</span><span class="op" id="7210297">)</span>&nbsp;<span class="ident" id="7210299">test</span><span class="op" id="7210303">(</span><span class="ident" id="7210304">t</span>&nbsp;<span class="ident" id="7210306">testing</span><span class="op" id="7210313">.</span><span class="ident" id="7210314">TB</span><span class="op" id="7210316">)</span>&nbsp;<span class="builtintype" id="7210318">error</span>&nbsp;<span class="op" id="7210324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210327">rows</span><span class="op" id="7210331">,</span>&nbsp;<span class="ident" id="7210333">err</span>&nbsp;<span class="op" id="7210337">:=</span>&nbsp;<span class="ident" id="7210340">c</span><span class="op" id="7210341">.</span><span class="ident" id="7210342">db</span><span class="op" id="7210344">.</span><span class="ident" id="7210345">Query</span><span class="op" id="7210350">(</span><span class="string" id="7210351">&#34;SELECT|people|name|&#34;</span><span class="op" id="7210372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210375">if</span>&nbsp;<span class="ident" id="7210378">err</span>&nbsp;<span class="op" id="7210382">!=</span>&nbsp;<span class="builtintype" id="7210385">nil</span>&nbsp;<span class="op" id="7210389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210393">t</span><span class="op" id="7210394">.</span><span class="ident" id="7210395">Error</span><span class="op" id="7210400">(</span><span class="ident" id="7210401">err</span><span class="op" id="7210404">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210408">return</span>&nbsp;<span class="ident" id="7210415">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7210420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210423">var</span>&nbsp;<span class="ident" id="7210427">name</span>&nbsp;<span class="builtintype" id="7210432">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210440">for</span>&nbsp;<span class="ident" id="7210444">rows</span><span class="op" id="7210448">.</span><span class="ident" id="7210449">Next</span><span class="op" id="7210453">(</span><span class="op" id="7210454">)</span>&nbsp;<span class="op" id="7210456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210460">rows</span><span class="op" id="7210464">.</span><span class="ident" id="7210465">Scan</span><span class="op" id="7210469">(</span><span class="op" id="7210470">&amp;</span><span class="ident" id="7210471">name</span><span class="op" id="7210475">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7210478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210481">rows</span><span class="op" id="7210485">.</span><span class="ident" id="7210486">Close</span><span class="op" id="7210491">(</span><span class="op" id="7210492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210495">return</span>&nbsp;<span class="builtintype" id="7210502">nil</span><br>
<span class="lineno"></span><span class="op" id="7210506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="7210509">type</span>&nbsp;<span class="ident" id="7210514">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="7210535">struct</span>&nbsp;<span class="op" id="7210542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210545">db</span>&nbsp;<span class="op" id="7210548">*</span><span class="ident" id="7210549">DB</span><br>
<span class="lineno"></span><span class="op" id="7210552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7210555">func</span>&nbsp;<span class="op" id="7210560">(</span><span class="ident" id="7210561">c</span>&nbsp;<span class="op" id="7210563">*</span><span class="ident" id="7210564">concurrentDBExecTest</span><span class="op" id="7210584">)</span>&nbsp;<span class="ident" id="7210586">init</span><span class="op" id="7210590">(</span><span class="ident" id="7210591">t</span>&nbsp;<span class="ident" id="7210593">testing</span><span class="op" id="7210600">.</span><span class="ident" id="7210601">TB</span><span class="op" id="7210603">,</span>&nbsp;<span class="ident" id="7210605">db</span>&nbsp;<span class="op" id="7210608">*</span><span class="ident" id="7210609">DB</span><span class="op" id="7210611">)</span>&nbsp;<span class="op" id="7210613">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210616">c</span><span class="op" id="7210617">.</span><span class="ident" id="7210618">db</span>&nbsp;<span class="op" id="7210621">=</span>&nbsp;<span class="ident" id="7210623">db</span><br>
<span class="lineno"></span><span class="op" id="7210626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7210629">func</span>&nbsp;<span class="op" id="7210634">(</span><span class="ident" id="7210635">c</span>&nbsp;<span class="op" id="7210637">*</span><span class="ident" id="7210638">concurrentDBExecTest</span><span class="op" id="7210658">)</span>&nbsp;<span class="ident" id="7210660">finish</span><span class="op" id="7210666">(</span><span class="ident" id="7210667">t</span>&nbsp;<span class="ident" id="7210669">testing</span><span class="op" id="7210676">.</span><span class="ident" id="7210677">TB</span><span class="op" id="7210679">)</span>&nbsp;<span class="op" id="7210681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210684">c</span><span class="op" id="7210685">.</span><span class="ident" id="7210686">db</span>&nbsp;<span class="op" id="7210689">=</span>&nbsp;<span class="builtintype" id="7210691">nil</span><br>
<span class="lineno">1465</span><span class="op" id="7210695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7210698">func</span>&nbsp;<span class="op" id="7210703">(</span><span class="ident" id="7210704">c</span>&nbsp;<span class="op" id="7210706">*</span><span class="ident" id="7210707">concurrentDBExecTest</span><span class="op" id="7210727">)</span>&nbsp;<span class="ident" id="7210729">test</span><span class="op" id="7210733">(</span><span class="ident" id="7210734">t</span>&nbsp;<span class="ident" id="7210736">testing</span><span class="op" id="7210743">.</span><span class="ident" id="7210744">TB</span><span class="op" id="7210746">)</span>&nbsp;<span class="builtintype" id="7210748">error</span>&nbsp;<span class="op" id="7210754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210757">_</span><span class="op" id="7210758">,</span>&nbsp;<span class="ident" id="7210760">err</span>&nbsp;<span class="op" id="7210764">:=</span>&nbsp;<span class="ident" id="7210767">c</span><span class="op" id="7210768">.</span><span class="ident" id="7210769">db</span><span class="op" id="7210771">.</span><span class="ident" id="7210772">Exec</span><span class="op" id="7210776">(</span><span class="string" id="7210777">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7210830">,</span>&nbsp;<span class="num" id="7210832">3</span><span class="op" id="7210833">,</span>&nbsp;<span class="ident" id="7210835">chrisBirthday</span><span class="op" id="7210848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210851">if</span>&nbsp;<span class="ident" id="7210854">err</span>&nbsp;<span class="op" id="7210858">!=</span>&nbsp;<span class="builtintype" id="7210861">nil</span>&nbsp;<span class="op" id="7210865">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210869">t</span><span class="op" id="7210870">.</span><span class="ident" id="7210871">Error</span><span class="op" id="7210876">(</span><span class="ident" id="7210877">err</span><span class="op" id="7210880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210884">return</span>&nbsp;<span class="ident" id="7210891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7210896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7210899">return</span>&nbsp;<span class="builtintype" id="7210906">nil</span><br>
<span class="lineno"></span><span class="op" id="7210910">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="7210913">type</span>&nbsp;<span class="ident" id="7210918">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="7210942">struct</span>&nbsp;<span class="op" id="7210949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210952">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7210957">*</span><span class="ident" id="7210958">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7210962">stmt</span>&nbsp;<span class="op" id="7210967">*</span><span class="ident" id="7210968">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7210973">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="7210976">func</span>&nbsp;<span class="op" id="7210981">(</span><span class="ident" id="7210982">c</span>&nbsp;<span class="op" id="7210984">*</span><span class="ident" id="7210985">concurrentStmtQueryTest</span><span class="op" id="7211008">)</span>&nbsp;<span class="ident" id="7211010">init</span><span class="op" id="7211014">(</span><span class="ident" id="7211015">t</span>&nbsp;<span class="ident" id="7211017">testing</span><span class="op" id="7211024">.</span><span class="ident" id="7211025">TB</span><span class="op" id="7211027">,</span>&nbsp;<span class="ident" id="7211029">db</span>&nbsp;<span class="op" id="7211032">*</span><span class="ident" id="7211033">DB</span><span class="op" id="7211035">)</span>&nbsp;<span class="op" id="7211037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211040">c</span><span class="op" id="7211041">.</span><span class="ident" id="7211042">db</span>&nbsp;<span class="op" id="7211045">=</span>&nbsp;<span class="ident" id="7211047">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211051">var</span>&nbsp;<span class="ident" id="7211055">err</span>&nbsp;<span class="builtintype" id="7211059">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211066">c</span><span class="op" id="7211067">.</span><span class="ident" id="7211068">stmt</span><span class="op" id="7211072">,</span>&nbsp;<span class="ident" id="7211074">err</span>&nbsp;<span class="op" id="7211078">=</span>&nbsp;<span class="ident" id="7211080">db</span><span class="op" id="7211082">.</span><span class="ident" id="7211083">Prepare</span><span class="op" id="7211090">(</span><span class="string" id="7211091">&#34;SELECT|people|name|&#34;</span><span class="op" id="7211112">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211115">if</span>&nbsp;<span class="ident" id="7211118">err</span>&nbsp;<span class="op" id="7211122">!=</span>&nbsp;<span class="builtintype" id="7211125">nil</span>&nbsp;<span class="op" id="7211129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211133">t</span><span class="op" id="7211134">.</span><span class="ident" id="7211135">Fatal</span><span class="op" id="7211140">(</span><span class="ident" id="7211141">err</span><span class="op" id="7211144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7211147">}</span><br>
<span class="lineno"></span><span class="op" id="7211149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="7211152">func</span>&nbsp;<span class="op" id="7211157">(</span><span class="ident" id="7211158">c</span>&nbsp;<span class="op" id="7211160">*</span><span class="ident" id="7211161">concurrentStmtQueryTest</span><span class="op" id="7211184">)</span>&nbsp;<span class="ident" id="7211186">finish</span><span class="op" id="7211192">(</span><span class="ident" id="7211193">t</span>&nbsp;<span class="ident" id="7211195">testing</span><span class="op" id="7211202">.</span><span class="ident" id="7211203">TB</span><span class="op" id="7211205">)</span>&nbsp;<span class="op" id="7211207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211210">if</span>&nbsp;<span class="ident" id="7211213">c</span><span class="op" id="7211214">.</span><span class="ident" id="7211215">stmt</span>&nbsp;<span class="op" id="7211220">!=</span>&nbsp;<span class="builtintype" id="7211223">nil</span>&nbsp;<span class="op" id="7211227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211231">c</span><span class="op" id="7211232">.</span><span class="ident" id="7211233">stmt</span><span class="op" id="7211237">.</span><span class="ident" id="7211238">Close</span><span class="op" id="7211243">(</span><span class="op" id="7211244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211248">c</span><span class="op" id="7211249">.</span><span class="ident" id="7211250">stmt</span>&nbsp;<span class="op" id="7211255">=</span>&nbsp;<span class="builtintype" id="7211257">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7211262">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211265">c</span><span class="op" id="7211266">.</span><span class="ident" id="7211267">db</span>&nbsp;<span class="op" id="7211270">=</span>&nbsp;<span class="builtintype" id="7211272">nil</span><br>
<span class="lineno"></span><span class="op" id="7211276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7211279">func</span>&nbsp;<span class="op" id="7211284">(</span><span class="ident" id="7211285">c</span>&nbsp;<span class="op" id="7211287">*</span><span class="ident" id="7211288">concurrentStmtQueryTest</span><span class="op" id="7211311">)</span>&nbsp;<span class="ident" id="7211313">test</span><span class="op" id="7211317">(</span><span class="ident" id="7211318">t</span>&nbsp;<span class="ident" id="7211320">testing</span><span class="op" id="7211327">.</span><span class="ident" id="7211328">TB</span><span class="op" id="7211330">)</span>&nbsp;<span class="builtintype" id="7211332">error</span>&nbsp;<span class="op" id="7211338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211341">rows</span><span class="op" id="7211345">,</span>&nbsp;<span class="ident" id="7211347">err</span>&nbsp;<span class="op" id="7211351">:=</span>&nbsp;<span class="ident" id="7211354">c</span><span class="op" id="7211355">.</span><span class="ident" id="7211356">stmt</span><span class="op" id="7211360">.</span><span class="ident" id="7211361">Query</span><span class="op" id="7211366">(</span><span class="op" id="7211367">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211370">if</span>&nbsp;<span class="ident" id="7211373">err</span>&nbsp;<span class="op" id="7211377">!=</span>&nbsp;<span class="builtintype" id="7211380">nil</span>&nbsp;<span class="op" id="7211384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211388">t</span><span class="op" id="7211389">.</span><span class="ident" id="7211390">Errorf</span><span class="op" id="7211396">(</span><span class="string" id="7211397">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7211418">,</span>&nbsp;<span class="ident" id="7211420">err</span><span class="op" id="7211423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211427">return</span>&nbsp;<span class="ident" id="7211434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7211439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211443">var</span>&nbsp;<span class="ident" id="7211447">name</span>&nbsp;<span class="builtintype" id="7211452">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211460">for</span>&nbsp;<span class="ident" id="7211464">rows</span><span class="op" id="7211468">.</span><span class="ident" id="7211469">Next</span><span class="op" id="7211473">(</span><span class="op" id="7211474">)</span>&nbsp;<span class="op" id="7211476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211480">rows</span><span class="op" id="7211484">.</span><span class="ident" id="7211485">Scan</span><span class="op" id="7211489">(</span><span class="op" id="7211490">&amp;</span><span class="ident" id="7211491">name</span><span class="op" id="7211495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7211498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211501">rows</span><span class="op" id="7211505">.</span><span class="ident" id="7211506">Close</span><span class="op" id="7211511">(</span><span class="op" id="7211512">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211515">return</span>&nbsp;<span class="builtintype" id="7211522">nil</span><br>
<span class="lineno"></span><span class="op" id="7211526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7211529">type</span>&nbsp;<span class="ident" id="7211534">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="7211557">struct</span>&nbsp;<span class="op" id="7211564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211567">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7211572">*</span><span class="ident" id="7211573">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211577">stmt</span>&nbsp;<span class="op" id="7211582">*</span><span class="ident" id="7211583">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7211588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7211591">func</span>&nbsp;<span class="op" id="7211596">(</span><span class="ident" id="7211597">c</span>&nbsp;<span class="op" id="7211599">*</span><span class="ident" id="7211600">concurrentStmtExecTest</span><span class="op" id="7211622">)</span>&nbsp;<span class="ident" id="7211624">init</span><span class="op" id="7211628">(</span><span class="ident" id="7211629">t</span>&nbsp;<span class="ident" id="7211631">testing</span><span class="op" id="7211638">.</span><span class="ident" id="7211639">TB</span><span class="op" id="7211641">,</span>&nbsp;<span class="ident" id="7211643">db</span>&nbsp;<span class="op" id="7211646">*</span><span class="ident" id="7211647">DB</span><span class="op" id="7211649">)</span>&nbsp;<span class="op" id="7211651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211654">c</span><span class="op" id="7211655">.</span><span class="ident" id="7211656">db</span>&nbsp;<span class="op" id="7211659">=</span>&nbsp;<span class="ident" id="7211661">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211665">var</span>&nbsp;<span class="ident" id="7211669">err</span>&nbsp;<span class="builtintype" id="7211673">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211680">c</span><span class="op" id="7211681">.</span><span class="ident" id="7211682">stmt</span><span class="op" id="7211686">,</span>&nbsp;<span class="ident" id="7211688">err</span>&nbsp;<span class="op" id="7211692">=</span>&nbsp;<span class="ident" id="7211694">db</span><span class="op" id="7211696">.</span><span class="ident" id="7211697">Prepare</span><span class="op" id="7211704">(</span><span class="string" id="7211705">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7211758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211761">if</span>&nbsp;<span class="ident" id="7211764">err</span>&nbsp;<span class="op" id="7211768">!=</span>&nbsp;<span class="builtintype" id="7211771">nil</span>&nbsp;<span class="op" id="7211775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211779">t</span><span class="op" id="7211780">.</span><span class="ident" id="7211781">Fatal</span><span class="op" id="7211786">(</span><span class="ident" id="7211787">err</span><span class="op" id="7211790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7211793">}</span><br>
<span class="lineno">1525</span><span class="op" id="7211795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7211798">func</span>&nbsp;<span class="op" id="7211803">(</span><span class="ident" id="7211804">c</span>&nbsp;<span class="op" id="7211806">*</span><span class="ident" id="7211807">concurrentStmtExecTest</span><span class="op" id="7211829">)</span>&nbsp;<span class="ident" id="7211831">finish</span><span class="op" id="7211837">(</span><span class="ident" id="7211838">t</span>&nbsp;<span class="ident" id="7211840">testing</span><span class="op" id="7211847">.</span><span class="ident" id="7211848">TB</span><span class="op" id="7211850">)</span>&nbsp;<span class="op" id="7211852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7211855">if</span>&nbsp;<span class="ident" id="7211858">c</span><span class="op" id="7211859">.</span><span class="ident" id="7211860">stmt</span>&nbsp;<span class="op" id="7211865">!=</span>&nbsp;<span class="builtintype" id="7211868">nil</span>&nbsp;<span class="op" id="7211872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211876">c</span><span class="op" id="7211877">.</span><span class="ident" id="7211878">stmt</span><span class="op" id="7211882">.</span><span class="ident" id="7211883">Close</span><span class="op" id="7211888">(</span><span class="op" id="7211889">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211893">c</span><span class="op" id="7211894">.</span><span class="ident" id="7211895">stmt</span>&nbsp;<span class="op" id="7211900">=</span>&nbsp;<span class="builtintype" id="7211902">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7211907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211910">c</span><span class="op" id="7211911">.</span><span class="ident" id="7211912">db</span>&nbsp;<span class="op" id="7211915">=</span>&nbsp;<span class="builtintype" id="7211917">nil</span><br>
<span class="lineno"></span><span class="op" id="7211921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="7211924">func</span>&nbsp;<span class="op" id="7211929">(</span><span class="ident" id="7211930">c</span>&nbsp;<span class="op" id="7211932">*</span><span class="ident" id="7211933">concurrentStmtExecTest</span><span class="op" id="7211955">)</span>&nbsp;<span class="ident" id="7211957">test</span><span class="op" id="7211961">(</span><span class="ident" id="7211962">t</span>&nbsp;<span class="ident" id="7211964">testing</span><span class="op" id="7211971">.</span><span class="ident" id="7211972">TB</span><span class="op" id="7211974">)</span>&nbsp;<span class="builtintype" id="7211976">error</span>&nbsp;<span class="op" id="7211982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7211985">_</span><span class="op" id="7211986">,</span>&nbsp;<span class="ident" id="7211988">err</span>&nbsp;<span class="op" id="7211992">:=</span>&nbsp;<span class="ident" id="7211995">c</span><span class="op" id="7211996">.</span><span class="ident" id="7211997">stmt</span><span class="op" id="7212001">.</span><span class="ident" id="7212002">Exec</span><span class="op" id="7212006">(</span><span class="num" id="7212007">3</span><span class="op" id="7212008">,</span>&nbsp;<span class="ident" id="7212010">chrisBirthday</span><span class="op" id="7212023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212026">if</span>&nbsp;<span class="ident" id="7212029">err</span>&nbsp;<span class="op" id="7212033">!=</span>&nbsp;<span class="builtintype" id="7212036">nil</span>&nbsp;<span class="op" id="7212040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212044">t</span><span class="op" id="7212045">.</span><span class="ident" id="7212046">Errorf</span><span class="op" id="7212052">(</span><span class="string" id="7212053">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7212073">,</span>&nbsp;<span class="ident" id="7212075">err</span><span class="op" id="7212078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212082">return</span>&nbsp;<span class="ident" id="7212089">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212097">return</span>&nbsp;<span class="builtintype" id="7212104">nil</span><br>
<span class="lineno"></span><span class="op" id="7212108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212111">type</span>&nbsp;<span class="ident" id="7212116">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="7212138">struct</span>&nbsp;<span class="op" id="7212145">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212148">db</span>&nbsp;<span class="op" id="7212151">*</span><span class="ident" id="7212152">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212156">tx</span>&nbsp;<span class="op" id="7212159">*</span><span class="ident" id="7212160">Tx</span><br>
<span class="lineno"></span><span class="op" id="7212163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212166">func</span>&nbsp;<span class="op" id="7212171">(</span><span class="ident" id="7212172">c</span>&nbsp;<span class="op" id="7212174">*</span><span class="ident" id="7212175">concurrentTxQueryTest</span><span class="op" id="7212196">)</span>&nbsp;<span class="ident" id="7212198">init</span><span class="op" id="7212202">(</span><span class="ident" id="7212203">t</span>&nbsp;<span class="ident" id="7212205">testing</span><span class="op" id="7212212">.</span><span class="ident" id="7212213">TB</span><span class="op" id="7212215">,</span>&nbsp;<span class="ident" id="7212217">db</span>&nbsp;<span class="op" id="7212220">*</span><span class="ident" id="7212221">DB</span><span class="op" id="7212223">)</span>&nbsp;<span class="op" id="7212225">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212228">c</span><span class="op" id="7212229">.</span><span class="ident" id="7212230">db</span>&nbsp;<span class="op" id="7212233">=</span>&nbsp;<span class="ident" id="7212235">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212239">var</span>&nbsp;<span class="ident" id="7212243">err</span>&nbsp;<span class="builtintype" id="7212247">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212254">c</span><span class="op" id="7212255">.</span><span class="ident" id="7212256">tx</span><span class="op" id="7212258">,</span>&nbsp;<span class="ident" id="7212260">err</span>&nbsp;<span class="op" id="7212264">=</span>&nbsp;<span class="ident" id="7212266">c</span><span class="op" id="7212267">.</span><span class="ident" id="7212268">db</span><span class="op" id="7212270">.</span><span class="ident" id="7212271">Begin</span><span class="op" id="7212276">(</span><span class="op" id="7212277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212280">if</span>&nbsp;<span class="ident" id="7212283">err</span>&nbsp;<span class="op" id="7212287">!=</span>&nbsp;<span class="builtintype" id="7212290">nil</span>&nbsp;<span class="op" id="7212294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212298">t</span><span class="op" id="7212299">.</span><span class="ident" id="7212300">Fatal</span><span class="op" id="7212305">(</span><span class="ident" id="7212306">err</span><span class="op" id="7212309">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212312">}</span><br>
<span class="lineno"></span><span class="op" id="7212314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212317">func</span>&nbsp;<span class="op" id="7212322">(</span><span class="ident" id="7212323">c</span>&nbsp;<span class="op" id="7212325">*</span><span class="ident" id="7212326">concurrentTxQueryTest</span><span class="op" id="7212347">)</span>&nbsp;<span class="ident" id="7212349">finish</span><span class="op" id="7212355">(</span><span class="ident" id="7212356">t</span>&nbsp;<span class="ident" id="7212358">testing</span><span class="op" id="7212365">.</span><span class="ident" id="7212366">TB</span><span class="op" id="7212368">)</span>&nbsp;<span class="op" id="7212370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212373">if</span>&nbsp;<span class="ident" id="7212376">c</span><span class="op" id="7212377">.</span><span class="ident" id="7212378">tx</span>&nbsp;<span class="op" id="7212381">!=</span>&nbsp;<span class="builtintype" id="7212384">nil</span>&nbsp;<span class="op" id="7212388">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212392">c</span><span class="op" id="7212393">.</span><span class="ident" id="7212394">tx</span><span class="op" id="7212396">.</span><span class="ident" id="7212397">Rollback</span><span class="op" id="7212405">(</span><span class="op" id="7212406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212410">c</span><span class="op" id="7212411">.</span><span class="ident" id="7212412">tx</span>&nbsp;<span class="op" id="7212415">=</span>&nbsp;<span class="builtintype" id="7212417">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212425">c</span><span class="op" id="7212426">.</span><span class="ident" id="7212427">db</span>&nbsp;<span class="op" id="7212430">=</span>&nbsp;<span class="builtintype" id="7212432">nil</span><br>
<span class="lineno"></span><span class="op" id="7212436">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="7212439">func</span>&nbsp;<span class="op" id="7212444">(</span><span class="ident" id="7212445">c</span>&nbsp;<span class="op" id="7212447">*</span><span class="ident" id="7212448">concurrentTxQueryTest</span><span class="op" id="7212469">)</span>&nbsp;<span class="ident" id="7212471">test</span><span class="op" id="7212475">(</span><span class="ident" id="7212476">t</span>&nbsp;<span class="ident" id="7212478">testing</span><span class="op" id="7212485">.</span><span class="ident" id="7212486">TB</span><span class="op" id="7212488">)</span>&nbsp;<span class="builtintype" id="7212490">error</span>&nbsp;<span class="op" id="7212496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212499">rows</span><span class="op" id="7212503">,</span>&nbsp;<span class="ident" id="7212505">err</span>&nbsp;<span class="op" id="7212509">:=</span>&nbsp;<span class="ident" id="7212512">c</span><span class="op" id="7212513">.</span><span class="ident" id="7212514">db</span><span class="op" id="7212516">.</span><span class="ident" id="7212517">Query</span><span class="op" id="7212522">(</span><span class="string" id="7212523">&#34;SELECT|people|name|&#34;</span><span class="op" id="7212544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212547">if</span>&nbsp;<span class="ident" id="7212550">err</span>&nbsp;<span class="op" id="7212554">!=</span>&nbsp;<span class="builtintype" id="7212557">nil</span>&nbsp;<span class="op" id="7212561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212565">t</span><span class="op" id="7212566">.</span><span class="ident" id="7212567">Error</span><span class="op" id="7212572">(</span><span class="ident" id="7212573">err</span><span class="op" id="7212576">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212580">return</span>&nbsp;<span class="ident" id="7212587">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212595">var</span>&nbsp;<span class="ident" id="7212599">name</span>&nbsp;<span class="builtintype" id="7212604">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212612">for</span>&nbsp;<span class="ident" id="7212616">rows</span><span class="op" id="7212620">.</span><span class="ident" id="7212621">Next</span><span class="op" id="7212625">(</span><span class="op" id="7212626">)</span>&nbsp;<span class="op" id="7212628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212632">rows</span><span class="op" id="7212636">.</span><span class="ident" id="7212637">Scan</span><span class="op" id="7212641">(</span><span class="op" id="7212642">&amp;</span><span class="ident" id="7212643">name</span><span class="op" id="7212647">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212653">rows</span><span class="op" id="7212657">.</span><span class="ident" id="7212658">Close</span><span class="op" id="7212663">(</span><span class="op" id="7212664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212667">return</span>&nbsp;<span class="builtintype" id="7212674">nil</span><br>
<span class="lineno"></span><span class="op" id="7212678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="7212681">type</span>&nbsp;<span class="ident" id="7212686">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="7212707">struct</span>&nbsp;<span class="op" id="7212714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212717">db</span>&nbsp;<span class="op" id="7212720">*</span><span class="ident" id="7212721">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212725">tx</span>&nbsp;<span class="op" id="7212728">*</span><span class="ident" id="7212729">Tx</span><br>
<span class="lineno"></span><span class="op" id="7212732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="7212735">func</span>&nbsp;<span class="op" id="7212740">(</span><span class="ident" id="7212741">c</span>&nbsp;<span class="op" id="7212743">*</span><span class="ident" id="7212744">concurrentTxExecTest</span><span class="op" id="7212764">)</span>&nbsp;<span class="ident" id="7212766">init</span><span class="op" id="7212770">(</span><span class="ident" id="7212771">t</span>&nbsp;<span class="ident" id="7212773">testing</span><span class="op" id="7212780">.</span><span class="ident" id="7212781">TB</span><span class="op" id="7212783">,</span>&nbsp;<span class="ident" id="7212785">db</span>&nbsp;<span class="op" id="7212788">*</span><span class="ident" id="7212789">DB</span><span class="op" id="7212791">)</span>&nbsp;<span class="op" id="7212793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212796">c</span><span class="op" id="7212797">.</span><span class="ident" id="7212798">db</span>&nbsp;<span class="op" id="7212801">=</span>&nbsp;<span class="ident" id="7212803">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212807">var</span>&nbsp;<span class="ident" id="7212811">err</span>&nbsp;<span class="builtintype" id="7212815">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212822">c</span><span class="op" id="7212823">.</span><span class="ident" id="7212824">tx</span><span class="op" id="7212826">,</span>&nbsp;<span class="ident" id="7212828">err</span>&nbsp;<span class="op" id="7212832">=</span>&nbsp;<span class="ident" id="7212834">c</span><span class="op" id="7212835">.</span><span class="ident" id="7212836">db</span><span class="op" id="7212838">.</span><span class="ident" id="7212839">Begin</span><span class="op" id="7212844">(</span><span class="op" id="7212845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212848">if</span>&nbsp;<span class="ident" id="7212851">err</span>&nbsp;<span class="op" id="7212855">!=</span>&nbsp;<span class="builtintype" id="7212858">nil</span>&nbsp;<span class="op" id="7212862">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212866">t</span><span class="op" id="7212867">.</span><span class="ident" id="7212868">Fatal</span><span class="op" id="7212873">(</span><span class="ident" id="7212874">err</span><span class="op" id="7212877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212880">}</span><br>
<span class="lineno"></span><span class="op" id="7212882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7212885">func</span>&nbsp;<span class="op" id="7212890">(</span><span class="ident" id="7212891">c</span>&nbsp;<span class="op" id="7212893">*</span><span class="ident" id="7212894">concurrentTxExecTest</span><span class="op" id="7212914">)</span>&nbsp;<span class="ident" id="7212916">finish</span><span class="op" id="7212922">(</span><span class="ident" id="7212923">t</span>&nbsp;<span class="ident" id="7212925">testing</span><span class="op" id="7212932">.</span><span class="ident" id="7212933">TB</span><span class="op" id="7212935">)</span>&nbsp;<span class="op" id="7212937">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7212940">if</span>&nbsp;<span class="ident" id="7212943">c</span><span class="op" id="7212944">.</span><span class="ident" id="7212945">tx</span>&nbsp;<span class="op" id="7212948">!=</span>&nbsp;<span class="builtintype" id="7212951">nil</span>&nbsp;<span class="op" id="7212955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212959">c</span><span class="op" id="7212960">.</span><span class="ident" id="7212961">tx</span><span class="op" id="7212963">.</span><span class="ident" id="7212964">Rollback</span><span class="op" id="7212972">(</span><span class="op" id="7212973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212977">c</span><span class="op" id="7212978">.</span><span class="ident" id="7212979">tx</span>&nbsp;<span class="op" id="7212982">=</span>&nbsp;<span class="builtintype" id="7212984">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7212989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7212992">c</span><span class="op" id="7212993">.</span><span class="ident" id="7212994">db</span>&nbsp;<span class="op" id="7212997">=</span>&nbsp;<span class="builtintype" id="7212999">nil</span><br>
<span class="lineno">1600</span><span class="op" id="7213003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7213006">func</span>&nbsp;<span class="op" id="7213011">(</span><span class="ident" id="7213012">c</span>&nbsp;<span class="op" id="7213014">*</span><span class="ident" id="7213015">concurrentTxExecTest</span><span class="op" id="7213035">)</span>&nbsp;<span class="ident" id="7213037">test</span><span class="op" id="7213041">(</span><span class="ident" id="7213042">t</span>&nbsp;<span class="ident" id="7213044">testing</span><span class="op" id="7213051">.</span><span class="ident" id="7213052">TB</span><span class="op" id="7213054">)</span>&nbsp;<span class="builtintype" id="7213056">error</span>&nbsp;<span class="op" id="7213062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213065">_</span><span class="op" id="7213066">,</span>&nbsp;<span class="ident" id="7213068">err</span>&nbsp;<span class="op" id="7213072">:=</span>&nbsp;<span class="ident" id="7213075">c</span><span class="op" id="7213076">.</span><span class="ident" id="7213077">tx</span><span class="op" id="7213079">.</span><span class="ident" id="7213080">Exec</span><span class="op" id="7213084">(</span><span class="string" id="7213085">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7213138">,</span>&nbsp;<span class="num" id="7213140">3</span><span class="op" id="7213141">,</span>&nbsp;<span class="ident" id="7213143">chrisBirthday</span><span class="op" id="7213156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213159">if</span>&nbsp;<span class="ident" id="7213162">err</span>&nbsp;<span class="op" id="7213166">!=</span>&nbsp;<span class="builtintype" id="7213169">nil</span>&nbsp;<span class="op" id="7213173">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213177">t</span><span class="op" id="7213178">.</span><span class="ident" id="7213179">Error</span><span class="op" id="7213184">(</span><span class="ident" id="7213185">err</span><span class="op" id="7213188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213192">return</span>&nbsp;<span class="ident" id="7213199">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213207">return</span>&nbsp;<span class="builtintype" id="7213214">nil</span><br>
<span class="lineno"></span><span class="op" id="7213218">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="7213221">type</span>&nbsp;<span class="ident" id="7213226">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="7213252">struct</span>&nbsp;<span class="op" id="7213259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213262">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7213267">*</span><span class="ident" id="7213268">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213272">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7213277">*</span><span class="ident" id="7213278">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213282">stmt</span>&nbsp;<span class="op" id="7213287">*</span><span class="ident" id="7213288">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="7213293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7213296">func</span>&nbsp;<span class="op" id="7213301">(</span><span class="ident" id="7213302">c</span>&nbsp;<span class="op" id="7213304">*</span><span class="ident" id="7213305">concurrentTxStmtQueryTest</span><span class="op" id="7213330">)</span>&nbsp;<span class="ident" id="7213332">init</span><span class="op" id="7213336">(</span><span class="ident" id="7213337">t</span>&nbsp;<span class="ident" id="7213339">testing</span><span class="op" id="7213346">.</span><span class="ident" id="7213347">TB</span><span class="op" id="7213349">,</span>&nbsp;<span class="ident" id="7213351">db</span>&nbsp;<span class="op" id="7213354">*</span><span class="ident" id="7213355">DB</span><span class="op" id="7213357">)</span>&nbsp;<span class="op" id="7213359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213362">c</span><span class="op" id="7213363">.</span><span class="ident" id="7213364">db</span>&nbsp;<span class="op" id="7213367">=</span>&nbsp;<span class="ident" id="7213369">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213373">var</span>&nbsp;<span class="ident" id="7213377">err</span>&nbsp;<span class="builtintype" id="7213381">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213388">c</span><span class="op" id="7213389">.</span><span class="ident" id="7213390">tx</span><span class="op" id="7213392">,</span>&nbsp;<span class="ident" id="7213394">err</span>&nbsp;<span class="op" id="7213398">=</span>&nbsp;<span class="ident" id="7213400">c</span><span class="op" id="7213401">.</span><span class="ident" id="7213402">db</span><span class="op" id="7213404">.</span><span class="ident" id="7213405">Begin</span><span class="op" id="7213410">(</span><span class="op" id="7213411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213414">if</span>&nbsp;<span class="ident" id="7213417">err</span>&nbsp;<span class="op" id="7213421">!=</span>&nbsp;<span class="builtintype" id="7213424">nil</span>&nbsp;<span class="op" id="7213428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213432">t</span><span class="op" id="7213433">.</span><span class="ident" id="7213434">Fatal</span><span class="op" id="7213439">(</span><span class="ident" id="7213440">err</span><span class="op" id="7213443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213449">c</span><span class="op" id="7213450">.</span><span class="ident" id="7213451">stmt</span><span class="op" id="7213455">,</span>&nbsp;<span class="ident" id="7213457">err</span>&nbsp;<span class="op" id="7213461">=</span>&nbsp;<span class="ident" id="7213463">c</span><span class="op" id="7213464">.</span><span class="ident" id="7213465">tx</span><span class="op" id="7213467">.</span><span class="ident" id="7213468">Prepare</span><span class="op" id="7213475">(</span><span class="string" id="7213476">&#34;SELECT|people|name|&#34;</span><span class="op" id="7213497">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213500">if</span>&nbsp;<span class="ident" id="7213503">err</span>&nbsp;<span class="op" id="7213507">!=</span>&nbsp;<span class="builtintype" id="7213510">nil</span>&nbsp;<span class="op" id="7213514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213518">t</span><span class="op" id="7213519">.</span><span class="ident" id="7213520">Fatal</span><span class="op" id="7213525">(</span><span class="ident" id="7213526">err</span><span class="op" id="7213529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213532">}</span><br>
<span class="lineno"></span><span class="op" id="7213534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="7213537">func</span>&nbsp;<span class="op" id="7213542">(</span><span class="ident" id="7213543">c</span>&nbsp;<span class="op" id="7213545">*</span><span class="ident" id="7213546">concurrentTxStmtQueryTest</span><span class="op" id="7213571">)</span>&nbsp;<span class="ident" id="7213573">finish</span><span class="op" id="7213579">(</span><span class="ident" id="7213580">t</span>&nbsp;<span class="ident" id="7213582">testing</span><span class="op" id="7213589">.</span><span class="ident" id="7213590">TB</span><span class="op" id="7213592">)</span>&nbsp;<span class="op" id="7213594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213597">if</span>&nbsp;<span class="ident" id="7213600">c</span><span class="op" id="7213601">.</span><span class="ident" id="7213602">stmt</span>&nbsp;<span class="op" id="7213607">!=</span>&nbsp;<span class="builtintype" id="7213610">nil</span>&nbsp;<span class="op" id="7213614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213618">c</span><span class="op" id="7213619">.</span><span class="ident" id="7213620">stmt</span><span class="op" id="7213624">.</span><span class="ident" id="7213625">Close</span><span class="op" id="7213630">(</span><span class="op" id="7213631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213635">c</span><span class="op" id="7213636">.</span><span class="ident" id="7213637">stmt</span>&nbsp;<span class="op" id="7213642">=</span>&nbsp;<span class="builtintype" id="7213644">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213649">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213652">if</span>&nbsp;<span class="ident" id="7213655">c</span><span class="op" id="7213656">.</span><span class="ident" id="7213657">tx</span>&nbsp;<span class="op" id="7213660">!=</span>&nbsp;<span class="builtintype" id="7213663">nil</span>&nbsp;<span class="op" id="7213667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213671">c</span><span class="op" id="7213672">.</span><span class="ident" id="7213673">tx</span><span class="op" id="7213675">.</span><span class="ident" id="7213676">Rollback</span><span class="op" id="7213684">(</span><span class="op" id="7213685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213689">c</span><span class="op" id="7213690">.</span><span class="ident" id="7213691">tx</span>&nbsp;<span class="op" id="7213694">=</span>&nbsp;<span class="builtintype" id="7213696">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213704">c</span><span class="op" id="7213705">.</span><span class="ident" id="7213706">db</span>&nbsp;<span class="op" id="7213709">=</span>&nbsp;<span class="builtintype" id="7213711">nil</span><br>
<span class="lineno">1640</span><span class="op" id="7213715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7213718">func</span>&nbsp;<span class="op" id="7213723">(</span><span class="ident" id="7213724">c</span>&nbsp;<span class="op" id="7213726">*</span><span class="ident" id="7213727">concurrentTxStmtQueryTest</span><span class="op" id="7213752">)</span>&nbsp;<span class="ident" id="7213754">test</span><span class="op" id="7213758">(</span><span class="ident" id="7213759">t</span>&nbsp;<span class="ident" id="7213761">testing</span><span class="op" id="7213768">.</span><span class="ident" id="7213769">TB</span><span class="op" id="7213771">)</span>&nbsp;<span class="builtintype" id="7213773">error</span>&nbsp;<span class="op" id="7213779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213782">rows</span><span class="op" id="7213786">,</span>&nbsp;<span class="ident" id="7213788">err</span>&nbsp;<span class="op" id="7213792">:=</span>&nbsp;<span class="ident" id="7213795">c</span><span class="op" id="7213796">.</span><span class="ident" id="7213797">stmt</span><span class="op" id="7213801">.</span><span class="ident" id="7213802">Query</span><span class="op" id="7213807">(</span><span class="op" id="7213808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213811">if</span>&nbsp;<span class="ident" id="7213814">err</span>&nbsp;<span class="op" id="7213818">!=</span>&nbsp;<span class="builtintype" id="7213821">nil</span>&nbsp;<span class="op" id="7213825">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213829">t</span><span class="op" id="7213830">.</span><span class="ident" id="7213831">Errorf</span><span class="op" id="7213837">(</span><span class="string" id="7213838">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7213859">,</span>&nbsp;<span class="ident" id="7213861">err</span><span class="op" id="7213864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213868">return</span>&nbsp;<span class="ident" id="7213875">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213884">var</span>&nbsp;<span class="ident" id="7213888">name</span>&nbsp;<span class="builtintype" id="7213893">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213901">for</span>&nbsp;<span class="ident" id="7213905">rows</span><span class="op" id="7213909">.</span><span class="ident" id="7213910">Next</span><span class="op" id="7213914">(</span><span class="op" id="7213915">)</span>&nbsp;<span class="op" id="7213917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213921">rows</span><span class="op" id="7213925">.</span><span class="ident" id="7213926">Scan</span><span class="op" id="7213930">(</span><span class="op" id="7213931">&amp;</span><span class="ident" id="7213932">name</span><span class="op" id="7213936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7213939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7213942">rows</span><span class="op" id="7213946">.</span><span class="ident" id="7213947">Close</span><span class="op" id="7213952">(</span><span class="op" id="7213953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7213956">return</span>&nbsp;<span class="builtintype" id="7213963">nil</span><br>
<span class="lineno">1655</span><span class="op" id="7213967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7213970">type</span>&nbsp;<span class="ident" id="7213975">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="7214000">struct</span>&nbsp;<span class="op" id="7214007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214010">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7214015">*</span><span class="ident" id="7214016">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214020">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7214025">*</span><span class="ident" id="7214026">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214030">stmt</span>&nbsp;<span class="op" id="7214035">*</span><span class="ident" id="7214036">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7214041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7214044">func</span>&nbsp;<span class="op" id="7214049">(</span><span class="ident" id="7214050">c</span>&nbsp;<span class="op" id="7214052">*</span><span class="ident" id="7214053">concurrentTxStmtExecTest</span><span class="op" id="7214077">)</span>&nbsp;<span class="ident" id="7214079">init</span><span class="op" id="7214083">(</span><span class="ident" id="7214084">t</span>&nbsp;<span class="ident" id="7214086">testing</span><span class="op" id="7214093">.</span><span class="ident" id="7214094">TB</span><span class="op" id="7214096">,</span>&nbsp;<span class="ident" id="7214098">db</span>&nbsp;<span class="op" id="7214101">*</span><span class="ident" id="7214102">DB</span><span class="op" id="7214104">)</span>&nbsp;<span class="op" id="7214106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214109">c</span><span class="op" id="7214110">.</span><span class="ident" id="7214111">db</span>&nbsp;<span class="op" id="7214114">=</span>&nbsp;<span class="ident" id="7214116">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214120">var</span>&nbsp;<span class="ident" id="7214124">err</span>&nbsp;<span class="builtintype" id="7214128">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214135">c</span><span class="op" id="7214136">.</span><span class="ident" id="7214137">tx</span><span class="op" id="7214139">,</span>&nbsp;<span class="ident" id="7214141">err</span>&nbsp;<span class="op" id="7214145">=</span>&nbsp;<span class="ident" id="7214147">c</span><span class="op" id="7214148">.</span><span class="ident" id="7214149">db</span><span class="op" id="7214151">.</span><span class="ident" id="7214152">Begin</span><span class="op" id="7214157">(</span><span class="op" id="7214158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214161">if</span>&nbsp;<span class="ident" id="7214164">err</span>&nbsp;<span class="op" id="7214168">!=</span>&nbsp;<span class="builtintype" id="7214171">nil</span>&nbsp;<span class="op" id="7214175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214179">t</span><span class="op" id="7214180">.</span><span class="ident" id="7214181">Fatal</span><span class="op" id="7214186">(</span><span class="ident" id="7214187">err</span><span class="op" id="7214190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214193">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214196">c</span><span class="op" id="7214197">.</span><span class="ident" id="7214198">stmt</span><span class="op" id="7214202">,</span>&nbsp;<span class="ident" id="7214204">err</span>&nbsp;<span class="op" id="7214208">=</span>&nbsp;<span class="ident" id="7214210">c</span><span class="op" id="7214211">.</span><span class="ident" id="7214212">tx</span><span class="op" id="7214214">.</span><span class="ident" id="7214215">Prepare</span><span class="op" id="7214222">(</span><span class="string" id="7214223">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7214276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214279">if</span>&nbsp;<span class="ident" id="7214282">err</span>&nbsp;<span class="op" id="7214286">!=</span>&nbsp;<span class="builtintype" id="7214289">nil</span>&nbsp;<span class="op" id="7214293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214297">t</span><span class="op" id="7214298">.</span><span class="ident" id="7214299">Fatal</span><span class="op" id="7214304">(</span><span class="ident" id="7214305">err</span><span class="op" id="7214308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214311">}</span><br>
<span class="lineno"></span><span class="op" id="7214313">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="7214316">func</span>&nbsp;<span class="op" id="7214321">(</span><span class="ident" id="7214322">c</span>&nbsp;<span class="op" id="7214324">*</span><span class="ident" id="7214325">concurrentTxStmtExecTest</span><span class="op" id="7214349">)</span>&nbsp;<span class="ident" id="7214351">finish</span><span class="op" id="7214357">(</span><span class="ident" id="7214358">t</span>&nbsp;<span class="ident" id="7214360">testing</span><span class="op" id="7214367">.</span><span class="ident" id="7214368">TB</span><span class="op" id="7214370">)</span>&nbsp;<span class="op" id="7214372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214375">if</span>&nbsp;<span class="ident" id="7214378">c</span><span class="op" id="7214379">.</span><span class="ident" id="7214380">stmt</span>&nbsp;<span class="op" id="7214385">!=</span>&nbsp;<span class="builtintype" id="7214388">nil</span>&nbsp;<span class="op" id="7214392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214396">c</span><span class="op" id="7214397">.</span><span class="ident" id="7214398">stmt</span><span class="op" id="7214402">.</span><span class="ident" id="7214403">Close</span><span class="op" id="7214408">(</span><span class="op" id="7214409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214413">c</span><span class="op" id="7214414">.</span><span class="ident" id="7214415">stmt</span>&nbsp;<span class="op" id="7214420">=</span>&nbsp;<span class="builtintype" id="7214422">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214430">if</span>&nbsp;<span class="ident" id="7214433">c</span><span class="op" id="7214434">.</span><span class="ident" id="7214435">tx</span>&nbsp;<span class="op" id="7214438">!=</span>&nbsp;<span class="builtintype" id="7214441">nil</span>&nbsp;<span class="op" id="7214445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214449">c</span><span class="op" id="7214450">.</span><span class="ident" id="7214451">tx</span><span class="op" id="7214453">.</span><span class="ident" id="7214454">Rollback</span><span class="op" id="7214462">(</span><span class="op" id="7214463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214467">c</span><span class="op" id="7214468">.</span><span class="ident" id="7214469">tx</span>&nbsp;<span class="op" id="7214472">=</span>&nbsp;<span class="builtintype" id="7214474">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214479">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214482">c</span><span class="op" id="7214483">.</span><span class="ident" id="7214484">db</span>&nbsp;<span class="op" id="7214487">=</span>&nbsp;<span class="builtintype" id="7214489">nil</span><br>
<span class="lineno"></span><span class="op" id="7214493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7214496">func</span>&nbsp;<span class="op" id="7214501">(</span><span class="ident" id="7214502">c</span>&nbsp;<span class="op" id="7214504">*</span><span class="ident" id="7214505">concurrentTxStmtExecTest</span><span class="op" id="7214529">)</span>&nbsp;<span class="ident" id="7214531">test</span><span class="op" id="7214535">(</span><span class="ident" id="7214536">t</span>&nbsp;<span class="ident" id="7214538">testing</span><span class="op" id="7214545">.</span><span class="ident" id="7214546">TB</span><span class="op" id="7214548">)</span>&nbsp;<span class="builtintype" id="7214550">error</span>&nbsp;<span class="op" id="7214556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214559">_</span><span class="op" id="7214560">,</span>&nbsp;<span class="ident" id="7214562">err</span>&nbsp;<span class="op" id="7214566">:=</span>&nbsp;<span class="ident" id="7214569">c</span><span class="op" id="7214570">.</span><span class="ident" id="7214571">stmt</span><span class="op" id="7214575">.</span><span class="ident" id="7214576">Exec</span><span class="op" id="7214580">(</span><span class="num" id="7214581">3</span><span class="op" id="7214582">,</span>&nbsp;<span class="ident" id="7214584">chrisBirthday</span><span class="op" id="7214597">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214600">if</span>&nbsp;<span class="ident" id="7214603">err</span>&nbsp;<span class="op" id="7214607">!=</span>&nbsp;<span class="builtintype" id="7214610">nil</span>&nbsp;<span class="op" id="7214614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214618">t</span><span class="op" id="7214619">.</span><span class="ident" id="7214620">Errorf</span><span class="op" id="7214626">(</span><span class="string" id="7214627">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7214647">,</span>&nbsp;<span class="ident" id="7214649">err</span><span class="op" id="7214652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214656">return</span>&nbsp;<span class="ident" id="7214663">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7214668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7214671">return</span>&nbsp;<span class="builtintype" id="7214678">nil</span><br>
<span class="lineno">1695</span><span class="op" id="7214682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7214685">type</span>&nbsp;<span class="ident" id="7214690">concurrentRandomTest</span>&nbsp;<span class="keyword" id="7214711">struct</span>&nbsp;<span class="op" id="7214718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214721">tests</span>&nbsp;<span class="op" id="7214727">[</span><span class="op" id="7214728">]</span><span class="ident" id="7214729">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="7214744">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="7214747">func</span>&nbsp;<span class="op" id="7214752">(</span><span class="ident" id="7214753">c</span>&nbsp;<span class="op" id="7214755">*</span><span class="ident" id="7214756">concurrentRandomTest</span><span class="op" id="7214776">)</span>&nbsp;<span class="ident" id="7214778">init</span><span class="op" id="7214782">(</span><span class="ident" id="7214783">t</span>&nbsp;<span class="ident" id="7214785">testing</span><span class="op" id="7214792">.</span><span class="ident" id="7214793">TB</span><span class="op" id="7214795">,</span>&nbsp;<span class="ident" id="7214797">db</span>&nbsp;<span class="op" id="7214800">*</span><span class="ident" id="7214801">DB</span><span class="op" id="7214803">)</span>&nbsp;<span class="op" id="7214805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7214808">c</span><span class="op" id="7214809">.</span><span class="ident" id="7214810">tests</span>&nbsp;<span class="op" id="7214816">=</span>&nbsp;<span class="op" id="7214818">[</span><span class="op" id="7214819">]</span><span class="ident" id="7214820">concurrentTest</span><span class="op" id="7214834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7214838">new</span><span class="op" id="7214841">(</span><span class="ident" id="7214842">concurrentDBQueryTest</span><span class="op" id="7214863">)</span><span class="op" id="7214864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7214868">new</span><span class="op" id="7214871">(</span><span class="ident" id="7214872">concurrentDBExecTest</span><span class="op" id="7214892">)</span><span class="op" id="7214893">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7214897">new</span><span class="op" id="7214900">(</span><span class="ident" id="7214901">concurrentStmtQueryTest</span><span class="op" id="7214924">)</span><span class="op" id="7214925">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7214929">new</span><span class="op" id="7214932">(</span><span class="ident" id="7214933">concurrentStmtExecTest</span><span class="op" id="7214955">)</span><span class="op" id="7214956">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7214960">new</span><span class="op" id="7214963">(</span><span class="ident" id="7214964">concurrentTxQueryTest</span><span class="op" id="7214985">)</span><span class="op" id="7214986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7214990">new</span><span class="op" id="7214993">(</span><span class="ident" id="7214994">concurrentTxExecTest</span><span class="op" id="7215014">)</span><span class="op" id="7215015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7215019">new</span><span class="op" id="7215022">(</span><span class="ident" id="7215023">concurrentTxStmtQueryTest</span><span class="op" id="7215048">)</span><span class="op" id="7215049">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7215053">new</span><span class="op" id="7215056">(</span><span class="ident" id="7215057">concurrentTxStmtExecTest</span><span class="op" id="7215081">)</span><span class="op" id="7215082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215088">for</span>&nbsp;<span class="ident" id="7215092">_</span><span class="op" id="7215093">,</span>&nbsp;<span class="ident" id="7215095">ct</span>&nbsp;<span class="op" id="7215098">:=</span>&nbsp;<span class="keyword" id="7215101">range</span>&nbsp;<span class="ident" id="7215107">c</span><span class="op" id="7215108">.</span><span class="ident" id="7215109">tests</span>&nbsp;<span class="op" id="7215115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215119">ct</span><span class="op" id="7215121">.</span><span class="ident" id="7215122">init</span><span class="op" id="7215126">(</span><span class="ident" id="7215127">t</span><span class="op" id="7215128">,</span>&nbsp;<span class="ident" id="7215130">db</span><span class="op" id="7215132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215135">}</span><br>
<span class="lineno">1715</span><span class="op" id="7215137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7215140">func</span>&nbsp;<span class="op" id="7215145">(</span><span class="ident" id="7215146">c</span>&nbsp;<span class="op" id="7215148">*</span><span class="ident" id="7215149">concurrentRandomTest</span><span class="op" id="7215169">)</span>&nbsp;<span class="ident" id="7215171">finish</span><span class="op" id="7215177">(</span><span class="ident" id="7215178">t</span>&nbsp;<span class="ident" id="7215180">testing</span><span class="op" id="7215187">.</span><span class="ident" id="7215188">TB</span><span class="op" id="7215190">)</span>&nbsp;<span class="op" id="7215192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215195">for</span>&nbsp;<span class="ident" id="7215199">_</span><span class="op" id="7215200">,</span>&nbsp;<span class="ident" id="7215202">ct</span>&nbsp;<span class="op" id="7215205">:=</span>&nbsp;<span class="keyword" id="7215208">range</span>&nbsp;<span class="ident" id="7215214">c</span><span class="op" id="7215215">.</span><span class="ident" id="7215216">tests</span>&nbsp;<span class="op" id="7215222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215226">ct</span><span class="op" id="7215228">.</span><span class="ident" id="7215229">finish</span><span class="op" id="7215235">(</span><span class="ident" id="7215236">t</span><span class="op" id="7215237">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215240">}</span><br>
<span class="lineno"></span><span class="op" id="7215242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7215245">func</span>&nbsp;<span class="op" id="7215250">(</span><span class="ident" id="7215251">c</span>&nbsp;<span class="op" id="7215253">*</span><span class="ident" id="7215254">concurrentRandomTest</span><span class="op" id="7215274">)</span>&nbsp;<span class="ident" id="7215276">test</span><span class="op" id="7215280">(</span><span class="ident" id="7215281">t</span>&nbsp;<span class="ident" id="7215283">testing</span><span class="op" id="7215290">.</span><span class="ident" id="7215291">TB</span><span class="op" id="7215293">)</span>&nbsp;<span class="builtintype" id="7215295">error</span>&nbsp;<span class="op" id="7215301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215304">ct</span>&nbsp;<span class="op" id="7215307">:=</span>&nbsp;<span class="ident" id="7215310">c</span><span class="op" id="7215311">.</span><span class="ident" id="7215312">tests</span><span class="op" id="7215317">[</span><span class="ident" id="7215318">rand</span><span class="op" id="7215322">.</span><span class="ident" id="7215323">Intn</span><span class="op" id="7215327">(</span><span class="builtinfunc" id="7215328">len</span><span class="op" id="7215331">(</span><span class="ident" id="7215332">c</span><span class="op" id="7215333">.</span><span class="ident" id="7215334">tests</span><span class="op" id="7215339">)</span><span class="op" id="7215340">)</span><span class="op" id="7215341">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215344">return</span>&nbsp;<span class="ident" id="7215351">ct</span><span class="op" id="7215353">.</span><span class="ident" id="7215354">test</span><span class="op" id="7215358">(</span><span class="ident" id="7215359">t</span><span class="op" id="7215360">)</span><br>
<span class="lineno"></span><span class="op" id="7215362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7215365">func</span>&nbsp;<span class="ident" id="7215370">doConcurrentTest</span><span class="op" id="7215386">(</span><span class="ident" id="7215387">t</span>&nbsp;<span class="ident" id="7215389">testing</span><span class="op" id="7215396">.</span><span class="ident" id="7215397">TB</span><span class="op" id="7215399">,</span>&nbsp;<span class="ident" id="7215401">ct</span>&nbsp;<span class="ident" id="7215404">concurrentTest</span><span class="op" id="7215418">)</span>&nbsp;<span class="op" id="7215420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215423">maxProcs</span><span class="op" id="7215431">,</span>&nbsp;<span class="ident" id="7215433">numReqs</span>&nbsp;<span class="op" id="7215441">:=</span>&nbsp;<span class="num" id="7215444">1</span><span class="op" id="7215445">,</span>&nbsp;<span class="num" id="7215447">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215452">if</span>&nbsp;<span class="ident" id="7215455">testing</span><span class="op" id="7215462">.</span><span class="ident" id="7215463">Short</span><span class="op" id="7215468">(</span><span class="op" id="7215469">)</span>&nbsp;<span class="op" id="7215471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215475">maxProcs</span><span class="op" id="7215483">,</span>&nbsp;<span class="ident" id="7215485">numReqs</span>&nbsp;<span class="op" id="7215493">=</span>&nbsp;<span class="num" id="7215495">4</span><span class="op" id="7215496">,</span>&nbsp;<span class="num" id="7215498">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215505">defer</span>&nbsp;<span class="ident" id="7215511">runtime</span><span class="op" id="7215518">.</span><span class="ident" id="7215519">GOMAXPROCS</span><span class="op" id="7215529">(</span><span class="ident" id="7215530">runtime</span><span class="op" id="7215537">.</span><span class="ident" id="7215538">GOMAXPROCS</span><span class="op" id="7215548">(</span><span class="ident" id="7215549">maxProcs</span><span class="op" id="7215557">)</span><span class="op" id="7215558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215562">db</span>&nbsp;<span class="op" id="7215565">:=</span>&nbsp;<span class="ident" id="7215568">newTestDB</span><span class="op" id="7215577">(</span><span class="ident" id="7215578">t</span><span class="op" id="7215579">,</span>&nbsp;<span class="string" id="7215581">&#34;people&#34;</span><span class="op" id="7215589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215592">defer</span>&nbsp;<span class="ident" id="7215598">closeDB</span><span class="op" id="7215605">(</span><span class="ident" id="7215606">t</span><span class="op" id="7215607">,</span>&nbsp;<span class="ident" id="7215609">db</span><span class="op" id="7215611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215615">ct</span><span class="op" id="7215617">.</span><span class="ident" id="7215618">init</span><span class="op" id="7215622">(</span><span class="ident" id="7215623">t</span><span class="op" id="7215624">,</span>&nbsp;<span class="ident" id="7215626">db</span><span class="op" id="7215628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215631">defer</span>&nbsp;<span class="ident" id="7215637">ct</span><span class="op" id="7215639">.</span><span class="ident" id="7215640">finish</span><span class="op" id="7215646">(</span><span class="ident" id="7215647">t</span><span class="op" id="7215648">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215652">var</span>&nbsp;<span class="ident" id="7215656">wg</span>&nbsp;<span class="ident" id="7215659">sync</span><span class="op" id="7215663">.</span><span class="ident" id="7215664">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215675">wg</span><span class="op" id="7215677">.</span><span class="ident" id="7215678">Add</span><span class="op" id="7215681">(</span><span class="ident" id="7215682">numReqs</span><span class="op" id="7215689">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215693">reqs</span>&nbsp;<span class="op" id="7215698">:=</span>&nbsp;<span class="builtinfunc" id="7215701">make</span><span class="op" id="7215705">(</span><span class="keyword" id="7215706">chan</span>&nbsp;<span class="builtintype" id="7215711">bool</span><span class="op" id="7215715">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215718">defer</span>&nbsp;<span class="builtinfunc" id="7215724">close</span><span class="op" id="7215729">(</span><span class="ident" id="7215730">reqs</span><span class="op" id="7215734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215738">for</span>&nbsp;<span class="ident" id="7215742">i</span>&nbsp;<span class="op" id="7215744">:=</span>&nbsp;<span class="num" id="7215747">0</span><span class="op" id="7215748">;</span>&nbsp;<span class="ident" id="7215750">i</span>&nbsp;<span class="op" id="7215752">&lt;</span>&nbsp;<span class="ident" id="7215754">maxProcs</span><span class="op" id="7215762">*</span><span class="num" id="7215763">2</span><span class="op" id="7215764">;</span>&nbsp;<span class="ident" id="7215766">i</span><span class="op" id="7215767">++</span>&nbsp;<span class="op" id="7215770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215774">go</span>&nbsp;<span class="keyword" id="7215777">func</span><span class="op" id="7215781">(</span><span class="op" id="7215782">)</span>&nbsp;<span class="op" id="7215784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215789">for</span>&nbsp;<span class="keyword" id="7215793">range</span>&nbsp;<span class="ident" id="7215799">reqs</span>&nbsp;<span class="op" id="7215804">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215810">err</span>&nbsp;<span class="op" id="7215814">:=</span>&nbsp;<span class="ident" id="7215817">ct</span><span class="op" id="7215819">.</span><span class="ident" id="7215820">test</span><span class="op" id="7215824">(</span><span class="ident" id="7215825">t</span><span class="op" id="7215826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215832">if</span>&nbsp;<span class="ident" id="7215835">err</span>&nbsp;<span class="op" id="7215839">!=</span>&nbsp;<span class="builtintype" id="7215842">nil</span>&nbsp;<span class="op" id="7215846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215853">wg</span><span class="op" id="7215855">.</span><span class="ident" id="7215856">Done</span><span class="op" id="7215860">(</span><span class="op" id="7215861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215868">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215881">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215887">wg</span><span class="op" id="7215889">.</span><span class="ident" id="7215890">Done</span><span class="op" id="7215894">(</span><span class="op" id="7215895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215904">}</span><span class="op" id="7215905">(</span><span class="op" id="7215906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7215913">for</span>&nbsp;<span class="ident" id="7215917">i</span>&nbsp;<span class="op" id="7215919">:=</span>&nbsp;<span class="num" id="7215922">0</span><span class="op" id="7215923">;</span>&nbsp;<span class="ident" id="7215925">i</span>&nbsp;<span class="op" id="7215927">&lt;</span>&nbsp;<span class="ident" id="7215929">numReqs</span><span class="op" id="7215936">;</span>&nbsp;<span class="ident" id="7215938">i</span><span class="op" id="7215939">++</span>&nbsp;<span class="op" id="7215942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215946">reqs</span>&nbsp;<span class="op" id="7215951">&lt;-</span>&nbsp;<span class="builtintype" id="7215954">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7215960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7215964">wg</span><span class="op" id="7215966">.</span><span class="ident" id="7215967">Wait</span><span class="op" id="7215971">(</span><span class="op" id="7215972">)</span><br>
<span class="lineno">1765</span><span class="op" id="7215974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7215977">func</span>&nbsp;<span class="ident" id="7215982">manyConcurrentQueries</span><span class="op" id="7216003">(</span><span class="ident" id="7216004">t</span>&nbsp;<span class="ident" id="7216006">testing</span><span class="op" id="7216013">.</span><span class="ident" id="7216014">TB</span><span class="op" id="7216016">)</span>&nbsp;<span class="op" id="7216018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216021">maxProcs</span><span class="op" id="7216029">,</span>&nbsp;<span class="ident" id="7216031">numReqs</span>&nbsp;<span class="op" id="7216039">:=</span>&nbsp;<span class="num" id="7216042">16</span><span class="op" id="7216044">,</span>&nbsp;<span class="num" id="7216046">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216051">if</span>&nbsp;<span class="ident" id="7216054">testing</span><span class="op" id="7216061">.</span><span class="ident" id="7216062">Short</span><span class="op" id="7216067">(</span><span class="op" id="7216068">)</span>&nbsp;<span class="op" id="7216070">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216074">maxProcs</span><span class="op" id="7216082">,</span>&nbsp;<span class="ident" id="7216084">numReqs</span>&nbsp;<span class="op" id="7216092">=</span>&nbsp;<span class="num" id="7216094">4</span><span class="op" id="7216095">,</span>&nbsp;<span class="num" id="7216097">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216104">defer</span>&nbsp;<span class="ident" id="7216110">runtime</span><span class="op" id="7216117">.</span><span class="ident" id="7216118">GOMAXPROCS</span><span class="op" id="7216128">(</span><span class="ident" id="7216129">runtime</span><span class="op" id="7216136">.</span><span class="ident" id="7216137">GOMAXPROCS</span><span class="op" id="7216147">(</span><span class="ident" id="7216148">maxProcs</span><span class="op" id="7216156">)</span><span class="op" id="7216157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216161">db</span>&nbsp;<span class="op" id="7216164">:=</span>&nbsp;<span class="ident" id="7216167">newTestDB</span><span class="op" id="7216176">(</span><span class="ident" id="7216177">t</span><span class="op" id="7216178">,</span>&nbsp;<span class="string" id="7216180">&#34;people&#34;</span><span class="op" id="7216188">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216191">defer</span>&nbsp;<span class="ident" id="7216197">closeDB</span><span class="op" id="7216204">(</span><span class="ident" id="7216205">t</span><span class="op" id="7216206">,</span>&nbsp;<span class="ident" id="7216208">db</span><span class="op" id="7216210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216214">stmt</span><span class="op" id="7216218">,</span>&nbsp;<span class="ident" id="7216220">err</span>&nbsp;<span class="op" id="7216224">:=</span>&nbsp;<span class="ident" id="7216227">db</span><span class="op" id="7216229">.</span><span class="ident" id="7216230">Prepare</span><span class="op" id="7216237">(</span><span class="string" id="7216238">&#34;SELECT|people|name|&#34;</span><span class="op" id="7216259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216262">if</span>&nbsp;<span class="ident" id="7216265">err</span>&nbsp;<span class="op" id="7216269">!=</span>&nbsp;<span class="builtintype" id="7216272">nil</span>&nbsp;<span class="op" id="7216276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216280">t</span><span class="op" id="7216281">.</span><span class="ident" id="7216282">Fatal</span><span class="op" id="7216287">(</span><span class="ident" id="7216288">err</span><span class="op" id="7216291">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216297">defer</span>&nbsp;<span class="ident" id="7216303">stmt</span><span class="op" id="7216307">.</span><span class="ident" id="7216308">Close</span><span class="op" id="7216313">(</span><span class="op" id="7216314">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216318">var</span>&nbsp;<span class="ident" id="7216322">wg</span>&nbsp;<span class="ident" id="7216325">sync</span><span class="op" id="7216329">.</span><span class="ident" id="7216330">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216341">wg</span><span class="op" id="7216343">.</span><span class="ident" id="7216344">Add</span><span class="op" id="7216347">(</span><span class="ident" id="7216348">numReqs</span><span class="op" id="7216355">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216359">reqs</span>&nbsp;<span class="op" id="7216364">:=</span>&nbsp;<span class="builtinfunc" id="7216367">make</span><span class="op" id="7216371">(</span><span class="keyword" id="7216372">chan</span>&nbsp;<span class="builtintype" id="7216377">bool</span><span class="op" id="7216381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216384">defer</span>&nbsp;<span class="builtinfunc" id="7216390">close</span><span class="op" id="7216395">(</span><span class="ident" id="7216396">reqs</span><span class="op" id="7216400">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216404">for</span>&nbsp;<span class="ident" id="7216408">i</span>&nbsp;<span class="op" id="7216410">:=</span>&nbsp;<span class="num" id="7216413">0</span><span class="op" id="7216414">;</span>&nbsp;<span class="ident" id="7216416">i</span>&nbsp;<span class="op" id="7216418">&lt;</span>&nbsp;<span class="ident" id="7216420">maxProcs</span><span class="op" id="7216428">*</span><span class="num" id="7216429">2</span><span class="op" id="7216430">;</span>&nbsp;<span class="ident" id="7216432">i</span><span class="op" id="7216433">++</span>&nbsp;<span class="op" id="7216436">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216440">go</span>&nbsp;<span class="keyword" id="7216443">func</span><span class="op" id="7216447">(</span><span class="op" id="7216448">)</span>&nbsp;<span class="op" id="7216450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216455">for</span>&nbsp;<span class="keyword" id="7216459">range</span>&nbsp;<span class="ident" id="7216465">reqs</span>&nbsp;<span class="op" id="7216470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216476">rows</span><span class="op" id="7216480">,</span>&nbsp;<span class="ident" id="7216482">err</span>&nbsp;<span class="op" id="7216486">:=</span>&nbsp;<span class="ident" id="7216489">stmt</span><span class="op" id="7216493">.</span><span class="ident" id="7216494">Query</span><span class="op" id="7216499">(</span><span class="op" id="7216500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216506">if</span>&nbsp;<span class="ident" id="7216509">err</span>&nbsp;<span class="op" id="7216513">!=</span>&nbsp;<span class="builtintype" id="7216516">nil</span>&nbsp;<span class="op" id="7216520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216527">t</span><span class="op" id="7216528">.</span><span class="ident" id="7216529">Errorf</span><span class="op" id="7216535">(</span><span class="string" id="7216536">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7216557">,</span>&nbsp;<span class="ident" id="7216559">err</span><span class="op" id="7216562">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216569">wg</span><span class="op" id="7216571">.</span><span class="ident" id="7216572">Done</span><span class="op" id="7216576">(</span><span class="op" id="7216577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216584">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216604">var</span>&nbsp;<span class="ident" id="7216608">name</span>&nbsp;<span class="builtintype" id="7216613">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216624">for</span>&nbsp;<span class="ident" id="7216628">rows</span><span class="op" id="7216632">.</span><span class="ident" id="7216633">Next</span><span class="op" id="7216637">(</span><span class="op" id="7216638">)</span>&nbsp;<span class="op" id="7216640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216647">rows</span><span class="op" id="7216651">.</span><span class="ident" id="7216652">Scan</span><span class="op" id="7216656">(</span><span class="op" id="7216657">&amp;</span><span class="ident" id="7216658">name</span><span class="op" id="7216662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216674">rows</span><span class="op" id="7216678">.</span><span class="ident" id="7216679">Close</span><span class="op" id="7216684">(</span><span class="op" id="7216685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216692">wg</span><span class="op" id="7216694">.</span><span class="ident" id="7216695">Done</span><span class="op" id="7216699">(</span><span class="op" id="7216700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216709">}</span><span class="op" id="7216710">(</span><span class="op" id="7216711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216718">for</span>&nbsp;<span class="ident" id="7216722">i</span>&nbsp;<span class="op" id="7216724">:=</span>&nbsp;<span class="num" id="7216727">0</span><span class="op" id="7216728">;</span>&nbsp;<span class="ident" id="7216730">i</span>&nbsp;<span class="op" id="7216732">&lt;</span>&nbsp;<span class="ident" id="7216734">numReqs</span><span class="op" id="7216741">;</span>&nbsp;<span class="ident" id="7216743">i</span><span class="op" id="7216744">++</span>&nbsp;<span class="op" id="7216747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216751">reqs</span>&nbsp;<span class="op" id="7216756">&lt;-</span>&nbsp;<span class="builtintype" id="7216759">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7216765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216769">wg</span><span class="op" id="7216771">.</span><span class="ident" id="7216772">Wait</span><span class="op" id="7216776">(</span><span class="op" id="7216777">)</span><br>
<span class="lineno">1815</span><span class="op" id="7216779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7216782">func</span>&nbsp;<span class="ident" id="7216787">TestIssue6081</span><span class="op" id="7216800">(</span><span class="ident" id="7216801">t</span>&nbsp;<span class="op" id="7216803">*</span><span class="ident" id="7216804">testing</span><span class="op" id="7216811">.</span><span class="ident" id="7216812">T</span><span class="op" id="7216813">)</span>&nbsp;<span class="op" id="7216815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216818">db</span>&nbsp;<span class="op" id="7216821">:=</span>&nbsp;<span class="ident" id="7216824">newTestDB</span><span class="op" id="7216833">(</span><span class="ident" id="7216834">t</span><span class="op" id="7216835">,</span>&nbsp;<span class="string" id="7216837">&#34;people&#34;</span><span class="op" id="7216845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7216848">defer</span>&nbsp;<span class="ident" id="7216854">closeDB</span><span class="op" id="7216861">(</span><span class="ident" id="7216862">t</span><span class="op" id="7216863">,</span>&nbsp;<span class="ident" id="7216865">db</span><span class="op" id="7216867">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216871">drv</span>&nbsp;<span class="op" id="7216875">:=</span>&nbsp;<span class="ident" id="7216878">db</span><span class="op" id="7216880">.</span><span class="ident" id="7216881">driver</span><span class="op" id="7216887">.</span><span class="op" id="7216888">(</span><span class="op" id="7216889">*</span><span class="ident" id="7216890">fakeDriver</span><span class="op" id="7216900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216903">drv</span><span class="op" id="7216906">.</span><span class="ident" id="7216907">mu</span><span class="op" id="7216909">.</span><span class="ident" id="7216910">Lock</span><span class="op" id="7216914">(</span><span class="op" id="7216915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216918">opens0</span>&nbsp;<span class="op" id="7216925">:=</span>&nbsp;<span class="ident" id="7216928">drv</span><span class="op" id="7216931">.</span><span class="ident" id="7216932">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216943">closes0</span>&nbsp;<span class="op" id="7216951">:=</span>&nbsp;<span class="ident" id="7216954">drv</span><span class="op" id="7216957">.</span><span class="ident" id="7216958">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216970">drv</span><span class="op" id="7216973">.</span><span class="ident" id="7216974">mu</span><span class="op" id="7216976">.</span><span class="ident" id="7216977">Unlock</span><span class="op" id="7216983">(</span><span class="op" id="7216984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7216988">stmt</span><span class="op" id="7216992">,</span>&nbsp;<span class="ident" id="7216994">err</span>&nbsp;<span class="op" id="7216998">:=</span>&nbsp;<span class="ident" id="7217001">db</span><span class="op" id="7217003">.</span><span class="ident" id="7217004">Prepare</span><span class="op" id="7217011">(</span><span class="string" id="7217012">&#34;SELECT|people|name|&#34;</span><span class="op" id="7217033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217036">if</span>&nbsp;<span class="ident" id="7217039">err</span>&nbsp;<span class="op" id="7217043">!=</span>&nbsp;<span class="builtintype" id="7217046">nil</span>&nbsp;<span class="op" id="7217050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217054">t</span><span class="op" id="7217055">.</span><span class="ident" id="7217056">Fatal</span><span class="op" id="7217061">(</span><span class="ident" id="7217062">err</span><span class="op" id="7217065">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217071">rowsCloseHook</span>&nbsp;<span class="op" id="7217085">=</span>&nbsp;<span class="keyword" id="7217087">func</span><span class="op" id="7217091">(</span><span class="ident" id="7217092">rows</span>&nbsp;<span class="op" id="7217097">*</span><span class="ident" id="7217098">Rows</span><span class="op" id="7217102">,</span>&nbsp;<span class="ident" id="7217104">err</span>&nbsp;<span class="op" id="7217108">*</span><span class="builtintype" id="7217109">error</span><span class="op" id="7217114">)</span>&nbsp;<span class="op" id="7217116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217120">*</span><span class="ident" id="7217121">err</span>&nbsp;<span class="op" id="7217125">=</span>&nbsp;<span class="ident" id="7217127">driver</span><span class="op" id="7217133">.</span><span class="ident" id="7217134">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217149">defer</span>&nbsp;<span class="keyword" id="7217155">func</span><span class="op" id="7217159">(</span><span class="op" id="7217160">)</span>&nbsp;<span class="op" id="7217162">{</span>&nbsp;<span class="ident" id="7217164">rowsCloseHook</span>&nbsp;<span class="op" id="7217178">=</span>&nbsp;<span class="builtintype" id="7217180">nil</span>&nbsp;<span class="op" id="7217184">}</span><span class="op" id="7217185">(</span><span class="op" id="7217186">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217189">for</span>&nbsp;<span class="ident" id="7217193">i</span>&nbsp;<span class="op" id="7217195">:=</span>&nbsp;<span class="num" id="7217198">0</span><span class="op" id="7217199">;</span>&nbsp;<span class="ident" id="7217201">i</span>&nbsp;<span class="op" id="7217203">&lt;</span>&nbsp;<span class="num" id="7217205">10</span><span class="op" id="7217207">;</span>&nbsp;<span class="ident" id="7217209">i</span><span class="op" id="7217210">++</span>&nbsp;<span class="op" id="7217213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217217">rows</span><span class="op" id="7217221">,</span>&nbsp;<span class="ident" id="7217223">err</span>&nbsp;<span class="op" id="7217227">:=</span>&nbsp;<span class="ident" id="7217230">stmt</span><span class="op" id="7217234">.</span><span class="ident" id="7217235">Query</span><span class="op" id="7217240">(</span><span class="op" id="7217241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217245">if</span>&nbsp;<span class="ident" id="7217248">err</span>&nbsp;<span class="op" id="7217252">!=</span>&nbsp;<span class="builtintype" id="7217255">nil</span>&nbsp;<span class="op" id="7217259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217264">t</span><span class="op" id="7217265">.</span><span class="ident" id="7217266">Fatal</span><span class="op" id="7217271">(</span><span class="ident" id="7217272">err</span><span class="op" id="7217275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217279">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217283">rows</span><span class="op" id="7217287">.</span><span class="ident" id="7217288">Close</span><span class="op" id="7217293">(</span><span class="op" id="7217294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217300">if</span>&nbsp;<span class="ident" id="7217303">n</span>&nbsp;<span class="op" id="7217305">:=</span>&nbsp;<span class="builtinfunc" id="7217308">len</span><span class="op" id="7217311">(</span><span class="ident" id="7217312">stmt</span><span class="op" id="7217316">.</span><span class="ident" id="7217317">css</span><span class="op" id="7217320">)</span><span class="op" id="7217321">;</span>&nbsp;<span class="ident" id="7217323">n</span>&nbsp;<span class="op" id="7217325">&gt;</span>&nbsp;<span class="num" id="7217327">1</span>&nbsp;<span class="op" id="7217329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217333">t</span><span class="op" id="7217334">.</span><span class="ident" id="7217335">Errorf</span><span class="op" id="7217341">(</span><span class="string" id="7217342">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7217374">,</span>&nbsp;<span class="ident" id="7217376">n</span><span class="op" id="7217377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217380">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217383">stmt</span><span class="op" id="7217387">.</span><span class="ident" id="7217388">Close</span><span class="op" id="7217393">(</span><span class="op" id="7217394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217397">if</span>&nbsp;<span class="ident" id="7217400">n</span>&nbsp;<span class="op" id="7217402">:=</span>&nbsp;<span class="builtinfunc" id="7217405">len</span><span class="op" id="7217408">(</span><span class="ident" id="7217409">stmt</span><span class="op" id="7217413">.</span><span class="ident" id="7217414">css</span><span class="op" id="7217417">)</span><span class="op" id="7217418">;</span>&nbsp;<span class="ident" id="7217420">n</span>&nbsp;<span class="op" id="7217422">!=</span>&nbsp;<span class="num" id="7217425">0</span>&nbsp;<span class="op" id="7217427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217431">t</span><span class="op" id="7217432">.</span><span class="ident" id="7217433">Errorf</span><span class="op" id="7217439">(</span><span class="string" id="7217440">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7217481">,</span>&nbsp;<span class="ident" id="7217483">n</span><span class="op" id="7217484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217491">drv</span><span class="op" id="7217494">.</span><span class="ident" id="7217495">mu</span><span class="op" id="7217497">.</span><span class="ident" id="7217498">Lock</span><span class="op" id="7217502">(</span><span class="op" id="7217503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217506">opens</span>&nbsp;<span class="op" id="7217512">:=</span>&nbsp;<span class="ident" id="7217515">drv</span><span class="op" id="7217518">.</span><span class="ident" id="7217519">openCount</span>&nbsp;<span class="op" id="7217529">-</span>&nbsp;<span class="ident" id="7217531">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217539">closes</span>&nbsp;<span class="op" id="7217546">:=</span>&nbsp;<span class="ident" id="7217549">drv</span><span class="op" id="7217552">.</span><span class="ident" id="7217553">closeCount</span>&nbsp;<span class="op" id="7217564">-</span>&nbsp;<span class="ident" id="7217566">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217575">drv</span><span class="op" id="7217578">.</span><span class="ident" id="7217579">mu</span><span class="op" id="7217581">.</span><span class="ident" id="7217582">Unlock</span><span class="op" id="7217588">(</span><span class="op" id="7217589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217592">if</span>&nbsp;<span class="ident" id="7217595">opens</span>&nbsp;<span class="op" id="7217601">&lt;</span>&nbsp;<span class="num" id="7217603">9</span>&nbsp;<span class="op" id="7217605">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217609">t</span><span class="op" id="7217610">.</span><span class="ident" id="7217611">Errorf</span><span class="op" id="7217617">(</span><span class="string" id="7217618">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7217641">,</span>&nbsp;<span class="ident" id="7217643">opens</span><span class="op" id="7217648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7217654">if</span>&nbsp;<span class="ident" id="7217657">closes</span>&nbsp;<span class="op" id="7217664">&lt;</span>&nbsp;<span class="num" id="7217666">9</span>&nbsp;<span class="op" id="7217668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217672">t</span><span class="op" id="7217673">.</span><span class="ident" id="7217674">Errorf</span><span class="op" id="7217680">(</span><span class="string" id="7217681">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7217705">,</span>&nbsp;<span class="ident" id="7217707">closes</span><span class="op" id="7217713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7217716">}</span><br>
<span class="lineno">1860</span><span class="op" id="7217718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7217721">func</span>&nbsp;<span class="ident" id="7217726">TestConcurrency</span><span class="op" id="7217741">(</span><span class="ident" id="7217742">t</span>&nbsp;<span class="op" id="7217744">*</span><span class="ident" id="7217745">testing</span><span class="op" id="7217752">.</span><span class="ident" id="7217753">T</span><span class="op" id="7217754">)</span>&nbsp;<span class="op" id="7217756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217759">doConcurrentTest</span><span class="op" id="7217775">(</span><span class="ident" id="7217776">t</span><span class="op" id="7217777">,</span>&nbsp;<span class="builtinfunc" id="7217779">new</span><span class="op" id="7217782">(</span><span class="ident" id="7217783">concurrentDBQueryTest</span><span class="op" id="7217804">)</span><span class="op" id="7217805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217808">doConcurrentTest</span><span class="op" id="7217824">(</span><span class="ident" id="7217825">t</span><span class="op" id="7217826">,</span>&nbsp;<span class="builtinfunc" id="7217828">new</span><span class="op" id="7217831">(</span><span class="ident" id="7217832">concurrentDBExecTest</span><span class="op" id="7217852">)</span><span class="op" id="7217853">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217856">doConcurrentTest</span><span class="op" id="7217872">(</span><span class="ident" id="7217873">t</span><span class="op" id="7217874">,</span>&nbsp;<span class="builtinfunc" id="7217876">new</span><span class="op" id="7217879">(</span><span class="ident" id="7217880">concurrentStmtQueryTest</span><span class="op" id="7217903">)</span><span class="op" id="7217904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217907">doConcurrentTest</span><span class="op" id="7217923">(</span><span class="ident" id="7217924">t</span><span class="op" id="7217925">,</span>&nbsp;<span class="builtinfunc" id="7217927">new</span><span class="op" id="7217930">(</span><span class="ident" id="7217931">concurrentStmtExecTest</span><span class="op" id="7217953">)</span><span class="op" id="7217954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7217957">doConcurrentTest</span><span class="op" id="7217973">(</span><span class="ident" id="7217974">t</span><span class="op" id="7217975">,</span>&nbsp;<span class="builtinfunc" id="7217977">new</span><span class="op" id="7217980">(</span><span class="ident" id="7217981">concurrentTxQueryTest</span><span class="op" id="7218002">)</span><span class="op" id="7218003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218006">doConcurrentTest</span><span class="op" id="7218022">(</span><span class="ident" id="7218023">t</span><span class="op" id="7218024">,</span>&nbsp;<span class="builtinfunc" id="7218026">new</span><span class="op" id="7218029">(</span><span class="ident" id="7218030">concurrentTxExecTest</span><span class="op" id="7218050">)</span><span class="op" id="7218051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218054">doConcurrentTest</span><span class="op" id="7218070">(</span><span class="ident" id="7218071">t</span><span class="op" id="7218072">,</span>&nbsp;<span class="builtinfunc" id="7218074">new</span><span class="op" id="7218077">(</span><span class="ident" id="7218078">concurrentTxStmtQueryTest</span><span class="op" id="7218103">)</span><span class="op" id="7218104">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218107">doConcurrentTest</span><span class="op" id="7218123">(</span><span class="ident" id="7218124">t</span><span class="op" id="7218125">,</span>&nbsp;<span class="builtinfunc" id="7218127">new</span><span class="op" id="7218130">(</span><span class="ident" id="7218131">concurrentTxStmtExecTest</span><span class="op" id="7218155">)</span><span class="op" id="7218156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218159">doConcurrentTest</span><span class="op" id="7218175">(</span><span class="ident" id="7218176">t</span><span class="op" id="7218177">,</span>&nbsp;<span class="builtinfunc" id="7218179">new</span><span class="op" id="7218182">(</span><span class="ident" id="7218183">concurrentRandomTest</span><span class="op" id="7218203">)</span><span class="op" id="7218204">)</span><br>
<span class="lineno"></span><span class="op" id="7218206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7218209">func</span>&nbsp;<span class="ident" id="7218214">TestConnectionLeak</span><span class="op" id="7218232">(</span><span class="ident" id="7218233">t</span>&nbsp;<span class="op" id="7218235">*</span><span class="ident" id="7218236">testing</span><span class="op" id="7218243">.</span><span class="ident" id="7218244">T</span><span class="op" id="7218245">)</span>&nbsp;<span class="op" id="7218247">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218250">db</span>&nbsp;<span class="op" id="7218253">:=</span>&nbsp;<span class="ident" id="7218256">newTestDB</span><span class="op" id="7218265">(</span><span class="ident" id="7218266">t</span><span class="op" id="7218267">,</span>&nbsp;<span class="string" id="7218269">&#34;people&#34;</span><span class="op" id="7218277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218280">defer</span>&nbsp;<span class="ident" id="7218286">closeDB</span><span class="op" id="7218293">(</span><span class="ident" id="7218294">t</span><span class="op" id="7218295">,</span>&nbsp;<span class="ident" id="7218297">db</span><span class="op" id="7218299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218302">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218343">rows</span>&nbsp;<span class="op" id="7218348">:=</span>&nbsp;<span class="builtinfunc" id="7218351">make</span><span class="op" id="7218355">(</span><span class="op" id="7218356">[</span><span class="op" id="7218357">]</span><span class="op" id="7218358">*</span><span class="ident" id="7218359">Rows</span><span class="op" id="7218363">,</span>&nbsp;<span class="ident" id="7218365">defaultMaxIdleConns</span><span class="op" id="7218384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218387">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218453">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218523">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218540">db</span><span class="op" id="7218542">.</span><span class="ident" id="7218543">SetMaxOpenConns</span><span class="op" id="7218558">(</span><span class="builtinfunc" id="7218559">len</span><span class="op" id="7218562">(</span><span class="ident" id="7218563">rows</span><span class="op" id="7218567">)</span>&nbsp;<span class="op" id="7218569">+</span>&nbsp;<span class="num" id="7218571">1</span><span class="op" id="7218572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218575">for</span>&nbsp;<span class="ident" id="7218579">ii</span>&nbsp;<span class="op" id="7218582">:=</span>&nbsp;<span class="keyword" id="7218585">range</span>&nbsp;<span class="ident" id="7218591">rows</span>&nbsp;<span class="op" id="7218596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218600">r</span><span class="op" id="7218601">,</span>&nbsp;<span class="ident" id="7218603">err</span>&nbsp;<span class="op" id="7218607">:=</span>&nbsp;<span class="ident" id="7218610">db</span><span class="op" id="7218612">.</span><span class="ident" id="7218613">Query</span><span class="op" id="7218618">(</span><span class="string" id="7218619">&#34;SELECT|people|name|&#34;</span><span class="op" id="7218640">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218644">if</span>&nbsp;<span class="ident" id="7218647">err</span>&nbsp;<span class="op" id="7218651">!=</span>&nbsp;<span class="builtintype" id="7218654">nil</span>&nbsp;<span class="op" id="7218658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218663">t</span><span class="op" id="7218664">.</span><span class="ident" id="7218665">Fatal</span><span class="op" id="7218670">(</span><span class="ident" id="7218671">err</span><span class="op" id="7218674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218682">r</span><span class="op" id="7218683">.</span><span class="ident" id="7218684">Next</span><span class="op" id="7218688">(</span><span class="op" id="7218689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7218693">if</span>&nbsp;<span class="ident" id="7218696">err</span>&nbsp;<span class="op" id="7218700">:=</span>&nbsp;<span class="ident" id="7218703">r</span><span class="op" id="7218704">.</span><span class="ident" id="7218705">Err</span><span class="op" id="7218708">(</span><span class="op" id="7218709">)</span><span class="op" id="7218710">;</span>&nbsp;<span class="ident" id="7218712">err</span>&nbsp;<span class="op" id="7218716">!=</span>&nbsp;<span class="builtintype" id="7218719">nil</span>&nbsp;<span class="op" id="7218723">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218728">t</span><span class="op" id="7218729">.</span><span class="ident" id="7218730">Fatal</span><span class="op" id="7218735">(</span><span class="ident" id="7218736">err</span><span class="op" id="7218739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218747">rows</span><span class="op" id="7218751">[</span><span class="ident" id="7218752">ii</span><span class="op" id="7218754">]</span>&nbsp;<span class="op" id="7218756">=</span>&nbsp;<span class="ident" id="7218758">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7218761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218764">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218823">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7218887">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218923">drv</span>&nbsp;<span class="op" id="7218927">:=</span>&nbsp;<span class="ident" id="7218930">db</span><span class="op" id="7218932">.</span><span class="ident" id="7218933">driver</span><span class="op" id="7218939">.</span><span class="op" id="7218940">(</span><span class="op" id="7218941">*</span><span class="ident" id="7218942">fakeDriver</span><span class="op" id="7218952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218955">drv</span><span class="op" id="7218958">.</span><span class="ident" id="7218959">waitCh</span>&nbsp;<span class="op" id="7218966">=</span>&nbsp;<span class="builtinfunc" id="7218968">make</span><span class="op" id="7218972">(</span><span class="keyword" id="7218973">chan</span>&nbsp;<span class="keyword" id="7218978">struct</span><span class="op" id="7218984">{</span><span class="op" id="7218985">}</span><span class="op" id="7218986">,</span>&nbsp;<span class="num" id="7218988">1</span><span class="op" id="7218989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7218992">drv</span><span class="op" id="7218995">.</span><span class="ident" id="7218996">waitingCh</span>&nbsp;<span class="op" id="7219006">=</span>&nbsp;<span class="builtinfunc" id="7219008">make</span><span class="op" id="7219012">(</span><span class="keyword" id="7219013">chan</span>&nbsp;<span class="keyword" id="7219018">struct</span><span class="op" id="7219024">{</span><span class="op" id="7219025">}</span><span class="op" id="7219026">,</span>&nbsp;<span class="num" id="7219028">1</span><span class="op" id="7219029">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219032">var</span>&nbsp;<span class="ident" id="7219036">wg</span>&nbsp;<span class="ident" id="7219039">sync</span><span class="op" id="7219043">.</span><span class="ident" id="7219044">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219055">wg</span><span class="op" id="7219057">.</span><span class="ident" id="7219058">Add</span><span class="op" id="7219061">(</span><span class="num" id="7219062">1</span><span class="op" id="7219063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219066">go</span>&nbsp;<span class="keyword" id="7219069">func</span><span class="op" id="7219073">(</span><span class="op" id="7219074">)</span>&nbsp;<span class="op" id="7219076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219080">r</span><span class="op" id="7219081">,</span>&nbsp;<span class="ident" id="7219083">err</span>&nbsp;<span class="op" id="7219087">:=</span>&nbsp;<span class="ident" id="7219090">db</span><span class="op" id="7219092">.</span><span class="ident" id="7219093">Query</span><span class="op" id="7219098">(</span><span class="string" id="7219099">&#34;SELECT|people|name|&#34;</span><span class="op" id="7219120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219124">if</span>&nbsp;<span class="ident" id="7219127">err</span>&nbsp;<span class="op" id="7219131">!=</span>&nbsp;<span class="builtintype" id="7219134">nil</span>&nbsp;<span class="op" id="7219138">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219143">t</span><span class="op" id="7219144">.</span><span class="ident" id="7219145">Fatal</span><span class="op" id="7219150">(</span><span class="ident" id="7219151">err</span><span class="op" id="7219154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219162">r</span><span class="op" id="7219163">.</span><span class="ident" id="7219164">Close</span><span class="op" id="7219169">(</span><span class="op" id="7219170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219174">wg</span><span class="op" id="7219176">.</span><span class="ident" id="7219177">Done</span><span class="op" id="7219181">(</span><span class="op" id="7219182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219185">}</span><span class="op" id="7219186">(</span><span class="op" id="7219187">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219190">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219259">&lt;-</span><span class="ident" id="7219261">drv</span><span class="op" id="7219264">.</span><span class="ident" id="7219265">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219276">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219343">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219403">for</span>&nbsp;<span class="ident" id="7219407">_</span><span class="op" id="7219408">,</span>&nbsp;<span class="ident" id="7219410">v</span>&nbsp;<span class="op" id="7219412">:=</span>&nbsp;<span class="keyword" id="7219415">range</span>&nbsp;<span class="ident" id="7219421">rows</span>&nbsp;<span class="op" id="7219426">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219430">v</span><span class="op" id="7219431">.</span><span class="ident" id="7219432">Close</span><span class="op" id="7219437">(</span><span class="op" id="7219438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219444">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219515">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219586">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7219655">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219671">drv</span><span class="op" id="7219674">.</span><span class="ident" id="7219675">waitCh</span>&nbsp;<span class="op" id="7219682">&lt;-</span>&nbsp;<span class="keyword" id="7219685">struct</span><span class="op" id="7219691">{</span><span class="op" id="7219692">}</span><span class="op" id="7219693">{</span><span class="op" id="7219694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219697">wg</span><span class="op" id="7219699">.</span><span class="ident" id="7219700">Wait</span><span class="op" id="7219704">(</span><span class="op" id="7219705">)</span><br>
<span class="lineno"></span><span class="op" id="7219707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="7219710">func</span>&nbsp;<span class="ident" id="7219715">BenchmarkConcurrentDBExec</span><span class="op" id="7219740">(</span><span class="ident" id="7219741">b</span>&nbsp;<span class="op" id="7219743">*</span><span class="ident" id="7219744">testing</span><span class="op" id="7219751">.</span><span class="ident" id="7219752">B</span><span class="op" id="7219753">)</span>&nbsp;<span class="op" id="7219755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219758">b</span><span class="op" id="7219759">.</span><span class="ident" id="7219760">ReportAllocs</span><span class="op" id="7219772">(</span><span class="op" id="7219773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219776">ct</span>&nbsp;<span class="op" id="7219779">:=</span>&nbsp;<span class="builtinfunc" id="7219782">new</span><span class="op" id="7219785">(</span><span class="ident" id="7219786">concurrentDBExecTest</span><span class="op" id="7219806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219809">for</span>&nbsp;<span class="ident" id="7219813">i</span>&nbsp;<span class="op" id="7219815">:=</span>&nbsp;<span class="num" id="7219818">0</span><span class="op" id="7219819">;</span>&nbsp;<span class="ident" id="7219821">i</span>&nbsp;<span class="op" id="7219823">&lt;</span>&nbsp;<span class="ident" id="7219825">b</span><span class="op" id="7219826">.</span><span class="ident" id="7219827">N</span><span class="op" id="7219828">;</span>&nbsp;<span class="ident" id="7219830">i</span><span class="op" id="7219831">++</span>&nbsp;<span class="op" id="7219834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219838">doConcurrentTest</span><span class="op" id="7219854">(</span><span class="ident" id="7219855">b</span><span class="op" id="7219856">,</span>&nbsp;<span class="ident" id="7219858">ct</span><span class="op" id="7219860">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7219863">}</span><br>
<span class="lineno"></span><span class="op" id="7219865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7219868">func</span>&nbsp;<span class="ident" id="7219873">BenchmarkConcurrentStmtQuery</span><span class="op" id="7219901">(</span><span class="ident" id="7219902">b</span>&nbsp;<span class="op" id="7219904">*</span><span class="ident" id="7219905">testing</span><span class="op" id="7219912">.</span><span class="ident" id="7219913">B</span><span class="op" id="7219914">)</span>&nbsp;<span class="op" id="7219916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219919">b</span><span class="op" id="7219920">.</span><span class="ident" id="7219921">ReportAllocs</span><span class="op" id="7219933">(</span><span class="op" id="7219934">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7219937">ct</span>&nbsp;<span class="op" id="7219940">:=</span>&nbsp;<span class="builtinfunc" id="7219943">new</span><span class="op" id="7219946">(</span><span class="ident" id="7219947">concurrentStmtQueryTest</span><span class="op" id="7219970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7219973">for</span>&nbsp;<span class="ident" id="7219977">i</span>&nbsp;<span class="op" id="7219979">:=</span>&nbsp;<span class="num" id="7219982">0</span><span class="op" id="7219983">;</span>&nbsp;<span class="ident" id="7219985">i</span>&nbsp;<span class="op" id="7219987">&lt;</span>&nbsp;<span class="ident" id="7219989">b</span><span class="op" id="7219990">.</span><span class="ident" id="7219991">N</span><span class="op" id="7219992">;</span>&nbsp;<span class="ident" id="7219994">i</span><span class="op" id="7219995">++</span>&nbsp;<span class="op" id="7219998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220002">doConcurrentTest</span><span class="op" id="7220018">(</span><span class="ident" id="7220019">b</span><span class="op" id="7220020">,</span>&nbsp;<span class="ident" id="7220022">ct</span><span class="op" id="7220024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220027">}</span><br>
<span class="lineno"></span><span class="op" id="7220029">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="7220032">func</span>&nbsp;<span class="ident" id="7220037">BenchmarkConcurrentStmtExec</span><span class="op" id="7220064">(</span><span class="ident" id="7220065">b</span>&nbsp;<span class="op" id="7220067">*</span><span class="ident" id="7220068">testing</span><span class="op" id="7220075">.</span><span class="ident" id="7220076">B</span><span class="op" id="7220077">)</span>&nbsp;<span class="op" id="7220079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220082">b</span><span class="op" id="7220083">.</span><span class="ident" id="7220084">ReportAllocs</span><span class="op" id="7220096">(</span><span class="op" id="7220097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220100">ct</span>&nbsp;<span class="op" id="7220103">:=</span>&nbsp;<span class="builtinfunc" id="7220106">new</span><span class="op" id="7220109">(</span><span class="ident" id="7220110">concurrentStmtExecTest</span><span class="op" id="7220132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7220135">for</span>&nbsp;<span class="ident" id="7220139">i</span>&nbsp;<span class="op" id="7220141">:=</span>&nbsp;<span class="num" id="7220144">0</span><span class="op" id="7220145">;</span>&nbsp;<span class="ident" id="7220147">i</span>&nbsp;<span class="op" id="7220149">&lt;</span>&nbsp;<span class="ident" id="7220151">b</span><span class="op" id="7220152">.</span><span class="ident" id="7220153">N</span><span class="op" id="7220154">;</span>&nbsp;<span class="ident" id="7220156">i</span><span class="op" id="7220157">++</span>&nbsp;<span class="op" id="7220160">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220164">doConcurrentTest</span><span class="op" id="7220180">(</span><span class="ident" id="7220181">b</span><span class="op" id="7220182">,</span>&nbsp;<span class="ident" id="7220184">ct</span><span class="op" id="7220186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220189">}</span><br>
<span class="lineno"></span><span class="op" id="7220191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7220194">func</span>&nbsp;<span class="ident" id="7220199">BenchmarkConcurrentTxQuery</span><span class="op" id="7220225">(</span><span class="ident" id="7220226">b</span>&nbsp;<span class="op" id="7220228">*</span><span class="ident" id="7220229">testing</span><span class="op" id="7220236">.</span><span class="ident" id="7220237">B</span><span class="op" id="7220238">)</span>&nbsp;<span class="op" id="7220240">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220243">b</span><span class="op" id="7220244">.</span><span class="ident" id="7220245">ReportAllocs</span><span class="op" id="7220257">(</span><span class="op" id="7220258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220261">ct</span>&nbsp;<span class="op" id="7220264">:=</span>&nbsp;<span class="builtinfunc" id="7220267">new</span><span class="op" id="7220270">(</span><span class="ident" id="7220271">concurrentTxQueryTest</span><span class="op" id="7220292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7220295">for</span>&nbsp;<span class="ident" id="7220299">i</span>&nbsp;<span class="op" id="7220301">:=</span>&nbsp;<span class="num" id="7220304">0</span><span class="op" id="7220305">;</span>&nbsp;<span class="ident" id="7220307">i</span>&nbsp;<span class="op" id="7220309">&lt;</span>&nbsp;<span class="ident" id="7220311">b</span><span class="op" id="7220312">.</span><span class="ident" id="7220313">N</span><span class="op" id="7220314">;</span>&nbsp;<span class="ident" id="7220316">i</span><span class="op" id="7220317">++</span>&nbsp;<span class="op" id="7220320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220324">doConcurrentTest</span><span class="op" id="7220340">(</span><span class="ident" id="7220341">b</span><span class="op" id="7220342">,</span>&nbsp;<span class="ident" id="7220344">ct</span><span class="op" id="7220346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220349">}</span><br>
<span class="lineno">1955</span><span class="op" id="7220351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7220354">func</span>&nbsp;<span class="ident" id="7220359">BenchmarkConcurrentTxExec</span><span class="op" id="7220384">(</span><span class="ident" id="7220385">b</span>&nbsp;<span class="op" id="7220387">*</span><span class="ident" id="7220388">testing</span><span class="op" id="7220395">.</span><span class="ident" id="7220396">B</span><span class="op" id="7220397">)</span>&nbsp;<span class="op" id="7220399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220402">b</span><span class="op" id="7220403">.</span><span class="ident" id="7220404">ReportAllocs</span><span class="op" id="7220416">(</span><span class="op" id="7220417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220420">ct</span>&nbsp;<span class="op" id="7220423">:=</span>&nbsp;<span class="builtinfunc" id="7220426">new</span><span class="op" id="7220429">(</span><span class="ident" id="7220430">concurrentTxExecTest</span><span class="op" id="7220450">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7220453">for</span>&nbsp;<span class="ident" id="7220457">i</span>&nbsp;<span class="op" id="7220459">:=</span>&nbsp;<span class="num" id="7220462">0</span><span class="op" id="7220463">;</span>&nbsp;<span class="ident" id="7220465">i</span>&nbsp;<span class="op" id="7220467">&lt;</span>&nbsp;<span class="ident" id="7220469">b</span><span class="op" id="7220470">.</span><span class="ident" id="7220471">N</span><span class="op" id="7220472">;</span>&nbsp;<span class="ident" id="7220474">i</span><span class="op" id="7220475">++</span>&nbsp;<span class="op" id="7220478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220482">doConcurrentTest</span><span class="op" id="7220498">(</span><span class="ident" id="7220499">b</span><span class="op" id="7220500">,</span>&nbsp;<span class="ident" id="7220502">ct</span><span class="op" id="7220504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220507">}</span><br>
<span class="lineno"></span><span class="op" id="7220509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="7220512">func</span>&nbsp;<span class="ident" id="7220517">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="7220547">(</span><span class="ident" id="7220548">b</span>&nbsp;<span class="op" id="7220550">*</span><span class="ident" id="7220551">testing</span><span class="op" id="7220558">.</span><span class="ident" id="7220559">B</span><span class="op" id="7220560">)</span>&nbsp;<span class="op" id="7220562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220565">b</span><span class="op" id="7220566">.</span><span class="ident" id="7220567">ReportAllocs</span><span class="op" id="7220579">(</span><span class="op" id="7220580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220583">ct</span>&nbsp;<span class="op" id="7220586">:=</span>&nbsp;<span class="builtinfunc" id="7220589">new</span><span class="op" id="7220592">(</span><span class="ident" id="7220593">concurrentTxStmtQueryTest</span><span class="op" id="7220618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7220621">for</span>&nbsp;<span class="ident" id="7220625">i</span>&nbsp;<span class="op" id="7220627">:=</span>&nbsp;<span class="num" id="7220630">0</span><span class="op" id="7220631">;</span>&nbsp;<span class="ident" id="7220633">i</span>&nbsp;<span class="op" id="7220635">&lt;</span>&nbsp;<span class="ident" id="7220637">b</span><span class="op" id="7220638">.</span><span class="ident" id="7220639">N</span><span class="op" id="7220640">;</span>&nbsp;<span class="ident" id="7220642">i</span><span class="op" id="7220643">++</span>&nbsp;<span class="op" id="7220646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220650">doConcurrentTest</span><span class="op" id="7220666">(</span><span class="ident" id="7220667">b</span><span class="op" id="7220668">,</span>&nbsp;<span class="ident" id="7220670">ct</span><span class="op" id="7220672">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220675">}</span><br>
<span class="lineno"></span><span class="op" id="7220677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7220680">func</span>&nbsp;<span class="ident" id="7220685">BenchmarkConcurrentTxStmtExec</span><span class="op" id="7220714">(</span><span class="ident" id="7220715">b</span>&nbsp;<span class="op" id="7220717">*</span><span class="ident" id="7220718">testing</span><span class="op" id="7220725">.</span><span class="ident" id="7220726">B</span><span class="op" id="7220727">)</span>&nbsp;<span class="op" id="7220729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220732">b</span><span class="op" id="7220733">.</span><span class="ident" id="7220734">ReportAllocs</span><span class="op" id="7220746">(</span><span class="op" id="7220747">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220750">ct</span>&nbsp;<span class="op" id="7220753">:=</span>&nbsp;<span class="builtinfunc" id="7220756">new</span><span class="op" id="7220759">(</span><span class="ident" id="7220760">concurrentTxStmtExecTest</span><span class="op" id="7220784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7220787">for</span>&nbsp;<span class="ident" id="7220791">i</span>&nbsp;<span class="op" id="7220793">:=</span>&nbsp;<span class="num" id="7220796">0</span><span class="op" id="7220797">;</span>&nbsp;<span class="ident" id="7220799">i</span>&nbsp;<span class="op" id="7220801">&lt;</span>&nbsp;<span class="ident" id="7220803">b</span><span class="op" id="7220804">.</span><span class="ident" id="7220805">N</span><span class="op" id="7220806">;</span>&nbsp;<span class="ident" id="7220808">i</span><span class="op" id="7220809">++</span>&nbsp;<span class="op" id="7220812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220816">doConcurrentTest</span><span class="op" id="7220832">(</span><span class="ident" id="7220833">b</span><span class="op" id="7220834">,</span>&nbsp;<span class="ident" id="7220836">ct</span><span class="op" id="7220838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220841">}</span><br>
<span class="lineno"></span><span class="op" id="7220843">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="7220846">func</span>&nbsp;<span class="ident" id="7220851">BenchmarkConcurrentRandom</span><span class="op" id="7220876">(</span><span class="ident" id="7220877">b</span>&nbsp;<span class="op" id="7220879">*</span><span class="ident" id="7220880">testing</span><span class="op" id="7220887">.</span><span class="ident" id="7220888">B</span><span class="op" id="7220889">)</span>&nbsp;<span class="op" id="7220891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220894">b</span><span class="op" id="7220895">.</span><span class="ident" id="7220896">ReportAllocs</span><span class="op" id="7220908">(</span><span class="op" id="7220909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220912">ct</span>&nbsp;<span class="op" id="7220915">:=</span>&nbsp;<span class="builtinfunc" id="7220918">new</span><span class="op" id="7220921">(</span><span class="ident" id="7220922">concurrentRandomTest</span><span class="op" id="7220942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7220945">for</span>&nbsp;<span class="ident" id="7220949">i</span>&nbsp;<span class="op" id="7220951">:=</span>&nbsp;<span class="num" id="7220954">0</span><span class="op" id="7220955">;</span>&nbsp;<span class="ident" id="7220957">i</span>&nbsp;<span class="op" id="7220959">&lt;</span>&nbsp;<span class="ident" id="7220961">b</span><span class="op" id="7220962">.</span><span class="ident" id="7220963">N</span><span class="op" id="7220964">;</span>&nbsp;<span class="ident" id="7220966">i</span><span class="op" id="7220967">++</span>&nbsp;<span class="op" id="7220970">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7220974">doConcurrentTest</span><span class="op" id="7220990">(</span><span class="ident" id="7220991">b</span><span class="op" id="7220992">,</span>&nbsp;<span class="ident" id="7220994">ct</span><span class="op" id="7220996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7220999">}</span><br>
<span class="lineno"></span><span class="op" id="7221001">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
