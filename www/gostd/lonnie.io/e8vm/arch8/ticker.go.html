<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="4808064">package</span>&nbsp;<span class="ident" id="4808072">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4808079">import</span>&nbsp;<span class="op" id="4808086">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4808089">&#34;math/rand&#34;</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4808102">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4808109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4808112">//&nbsp;Ticker&nbsp;is&nbsp;a&nbsp;device&nbsp;that&nbsp;generates&nbsp;time&nbsp;interrupts.</span><br>
<span class="lineno"></span><span class="keyword" id="4808166">type</span>&nbsp;<span class="ident" id="4808171">ticker</span>&nbsp;<span class="keyword" id="4808178">struct</span>&nbsp;<span class="op" id="4808185">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808188">intBus</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4808197">intBus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808205">nextTick</span>&nbsp;<span class="builtintype" id="4808214">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808222">Interval</span>&nbsp;<span class="builtintype" id="4808231">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808238">Noise</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4808247">int32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808254">Rand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4808263">*</span><span class="ident" id="4808264">rand</span><span class="op" id="4808268">.</span><span class="ident" id="4808269">Rand</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808275">Code</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4808284">byte</span><br>
<span class="lineno"></span><span class="op" id="4808289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4808292">//&nbsp;NewTicker&nbsp;creates&nbsp;a&nbsp;new&nbsp;time&nbsp;interrupt&nbsp;generator.</span><br>
<span class="lineno">20</span><span class="keyword" id="4808345">func</span>&nbsp;<span class="ident" id="4808350">newTicker</span><span class="op" id="4808359">(</span><span class="ident" id="4808360">bus</span>&nbsp;<span class="ident" id="4808364">intBus</span><span class="op" id="4808370">)</span>&nbsp;<span class="op" id="4808372">*</span><span class="ident" id="4808373">ticker</span>&nbsp;<span class="op" id="4808380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808383">ret</span>&nbsp;<span class="op" id="4808387">:=</span>&nbsp;<span class="builtinfunc" id="4808390">new</span><span class="op" id="4808393">(</span><span class="ident" id="4808394">ticker</span><span class="op" id="4808400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808403">ret</span><span class="op" id="4808406">.</span><span class="ident" id="4808407">intBus</span>&nbsp;<span class="op" id="4808414">=</span>&nbsp;<span class="ident" id="4808416">bus</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808422">ret</span><span class="op" id="4808425">.</span><span class="ident" id="4808426">Interval</span>&nbsp;<span class="op" id="4808435">=</span>&nbsp;<span class="num" id="4808437">1000</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808443">ret</span><span class="op" id="4808446">.</span><span class="ident" id="4808447">Noise</span>&nbsp;<span class="op" id="4808453">=</span>&nbsp;<span class="num" id="4808455">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808459">ret</span><span class="op" id="4808462">.</span><span class="ident" id="4808463">Rand</span>&nbsp;<span class="op" id="4808468">=</span>&nbsp;<span class="ident" id="4808470">rand</span><span class="op" id="4808474">.</span><span class="ident" id="4808475">New</span><span class="op" id="4808478">(</span><span class="ident" id="4808479">rand</span><span class="op" id="4808483">.</span><span class="ident" id="4808484">NewSource</span><span class="op" id="4808493">(</span><span class="ident" id="4808494">time</span><span class="op" id="4808498">.</span><span class="ident" id="4808499">Now</span><span class="op" id="4808502">(</span><span class="op" id="4808503">)</span><span class="op" id="4808504">.</span><span class="ident" id="4808505">UnixNano</span><span class="op" id="4808513">(</span><span class="op" id="4808514">)</span><span class="op" id="4808515">)</span><span class="op" id="4808516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808519">ret</span><span class="op" id="4808522">.</span><span class="ident" id="4808523">Code</span>&nbsp;<span class="op" id="4808528">=</span>&nbsp;<span class="num" id="4808530">2</span>&nbsp;<span class="comment" id="4808532">//&nbsp;time&nbsp;interrupt&nbsp;code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808557">ret</span><span class="op" id="4808560">.</span><span class="ident" id="4808561">reset</span><span class="op" id="4808566">(</span><span class="op" id="4808567">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4808571">return</span>&nbsp;<span class="ident" id="4808578">ret</span><br>
<span class="lineno"></span><span class="op" id="4808582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4808585">func</span>&nbsp;<span class="op" id="4808590">(</span><span class="ident" id="4808591">t</span>&nbsp;<span class="op" id="4808593">*</span><span class="ident" id="4808594">ticker</span><span class="op" id="4808600">)</span>&nbsp;<span class="ident" id="4808602">reset</span><span class="op" id="4808607">(</span><span class="op" id="4808608">)</span>&nbsp;<span class="op" id="4808610">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4808613">if</span>&nbsp;<span class="ident" id="4808616">t</span><span class="op" id="4808617">.</span><span class="ident" id="4808618">Noise</span>&nbsp;<span class="op" id="4808624">&lt;</span>&nbsp;<span class="num" id="4808626">0</span>&nbsp;<span class="op" id="4808628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4808632">panic</span><span class="op" id="4808637">(</span><span class="string" id="4808638">&#34;negative&nbsp;ticker&nbsp;noise&#34;</span><span class="op" id="4808661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4808664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4808667">if</span>&nbsp;<span class="ident" id="4808670">t</span><span class="op" id="4808671">.</span><span class="ident" id="4808672">Interval</span>&nbsp;<span class="op" id="4808681">&lt;</span>&nbsp;<span class="num" id="4808683">0</span>&nbsp;<span class="op" id="4808685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4808689">panic</span><span class="op" id="4808694">(</span><span class="string" id="4808695">&#34;negative&nbsp;ticker&nbsp;interval&#34;</span><span class="op" id="4808721">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4808724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808728">noise</span>&nbsp;<span class="op" id="4808734">:=</span>&nbsp;<span class="builtintype" id="4808737">int32</span><span class="op" id="4808742">(</span><span class="num" id="4808743">0</span><span class="op" id="4808744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4808747">if</span>&nbsp;<span class="ident" id="4808750">t</span><span class="op" id="4808751">.</span><span class="ident" id="4808752">Noise</span>&nbsp;<span class="op" id="4808758">&gt;</span>&nbsp;<span class="num" id="4808760">0</span>&nbsp;<span class="op" id="4808762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808766">noise</span>&nbsp;<span class="op" id="4808772">=</span>&nbsp;<span class="ident" id="4808774">t</span><span class="op" id="4808775">.</span><span class="ident" id="4808776">Rand</span><span class="op" id="4808780">.</span><span class="ident" id="4808781">Int31n</span><span class="op" id="4808787">(</span><span class="ident" id="4808788">t</span><span class="op" id="4808789">.</span><span class="ident" id="4808790">Noise</span><span class="op" id="4808795">)</span>&nbsp;<span class="op" id="4808797">-</span>&nbsp;<span class="ident" id="4808799">t</span><span class="op" id="4808800">.</span><span class="ident" id="4808801">Noise</span><span class="op" id="4808806">/</span><span class="num" id="4808807">2</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4808810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808814">next</span>&nbsp;<span class="op" id="4808819">:=</span>&nbsp;<span class="ident" id="4808822">t</span><span class="op" id="4808823">.</span><span class="ident" id="4808824">Interval</span>&nbsp;<span class="op" id="4808833">+</span>&nbsp;<span class="ident" id="4808835">noise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4808842">if</span>&nbsp;<span class="ident" id="4808845">next</span>&nbsp;<span class="op" id="4808850">&lt;</span>&nbsp;<span class="num" id="4808852">0</span>&nbsp;<span class="op" id="4808854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808858">next</span>&nbsp;<span class="op" id="4808863">=</span>&nbsp;<span class="num" id="4808865">0</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4808868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4808872">t</span><span class="op" id="4808873">.</span><span class="ident" id="4808874">nextTick</span>&nbsp;<span class="op" id="4808883">=</span>&nbsp;<span class="ident" id="4808885">next</span><br>
<span class="lineno"></span><span class="op" id="4808890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4808893">//&nbsp;Tick&nbsp;decreases&nbsp;the&nbsp;ticking&nbsp;counter.&nbsp;If&nbsp;the&nbsp;counter&nbsp;reaches&nbsp;0,</span><br>
<span class="lineno"></span><span class="comment" id="4808958">//&nbsp;it&nbsp;will&nbsp;issue&nbsp;interrupts&nbsp;to&nbsp;all&nbsp;cores&nbsp;and&nbsp;reset&nbsp;the&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="4809022">func</span>&nbsp;<span class="op" id="4809027">(</span><span class="ident" id="4809028">t</span>&nbsp;<span class="op" id="4809030">*</span><span class="ident" id="4809031">ticker</span><span class="op" id="4809037">)</span>&nbsp;<span class="ident" id="4809039">Tick</span><span class="op" id="4809043">(</span><span class="op" id="4809044">)</span>&nbsp;<span class="op" id="4809046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4809049">if</span>&nbsp;<span class="ident" id="4809052">t</span><span class="op" id="4809053">.</span><span class="ident" id="4809054">nextTick</span>&nbsp;<span class="op" id="4809063">&lt;</span>&nbsp;<span class="num" id="4809065">0</span>&nbsp;<span class="op" id="4809067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4809071">panic</span><span class="op" id="4809076">(</span><span class="string" id="4809077">&#34;bug&#34;</span><span class="op" id="4809082">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4809085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4809089">if</span>&nbsp;<span class="ident" id="4809092">t</span><span class="op" id="4809093">.</span><span class="ident" id="4809094">nextTick</span>&nbsp;<span class="op" id="4809103">==</span>&nbsp;<span class="num" id="4809106">0</span>&nbsp;<span class="op" id="4809108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809112">intAllCores</span><span class="op" id="4809123">(</span><span class="ident" id="4809124">t</span><span class="op" id="4809125">.</span><span class="ident" id="4809126">intBus</span><span class="op" id="4809132">,</span>&nbsp;<span class="ident" id="4809134">t</span><span class="op" id="4809135">.</span><span class="ident" id="4809136">Code</span><span class="op" id="4809140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809144">t</span><span class="op" id="4809145">.</span><span class="ident" id="4809146">reset</span><span class="op" id="4809151">(</span><span class="op" id="4809152">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4809155">}</span>&nbsp;<span class="keyword" id="4809157">else</span>&nbsp;<span class="op" id="4809162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4809166">t</span><span class="op" id="4809167">.</span><span class="ident" id="4809168">nextTick</span><span class="op" id="4809176">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4809180">}</span><br>
<span class="lineno"></span><span class="op" id="4809182">}</span>
</div>
</body>
</html>
