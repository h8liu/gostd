<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1703753">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1703808">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1703862">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1703913">package</span>&nbsp;<span class="ident" id="1703921">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1703930">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1703989">//</span><br>
<span class="lineno"></span><span class="comment" id="1703992">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1704045">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1704102">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1704160">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1704216">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1704275">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1704302">//</span><br>
<span class="lineno"></span><span class="comment" id="1704305">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1704358">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1704376">//</span><br>
<span class="lineno"></span><span class="comment" id="1704379">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1704432">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1704487">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1704548">//</span><br>
<span class="lineno"></span><span class="comment" id="1704551">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1704606">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1704664">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1704723">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1704780">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1704835">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1704896">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1704952">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1705011">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1705033">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1705095">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1705155">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1705216">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1705252">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1705319">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1705386">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1705453">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1705520">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1705587">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1705654">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1705721">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1705788">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1705855">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1705922">//</span><br>
<span class="lineno"></span><span class="comment" id="1705925">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1705994">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1706050">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1706119">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1706188">//</span><br>
<span class="lineno"></span><span class="comment" id="1706191">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1706259">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1706333">import</span>&nbsp;<span class="op" id="1706340">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1706343">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1706352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1706355">const</span>&nbsp;<span class="op" id="1706361">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706364">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706421">bucketCntBits</span>&nbsp;<span class="op" id="1706435">=</span>&nbsp;<span class="num" id="1706437">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706440">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1706454">=</span>&nbsp;<span class="num" id="1706456">1</span>&nbsp;<span class="op" id="1706458">&lt;&lt;</span>&nbsp;<span class="ident" id="1706461">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706477">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706536">loadFactor</span>&nbsp;<span class="op" id="1706547">=</span>&nbsp;<span class="num" id="1706549">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706555">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706636">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706661">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706726">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706795">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1706808">=</span>&nbsp;<span class="num" id="1706810">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1706815">maxValueSize</span>&nbsp;<span class="op" id="1706828">=</span>&nbsp;<span class="num" id="1706830">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706836">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706907">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1706972">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707009">dataOffset</span>&nbsp;<span class="op" id="1707020">=</span>&nbsp;<span class="ident" id="1707022">unsafe</span><span class="op" id="1707028">.</span><span class="ident" id="1707029">Offsetof</span><span class="op" id="1707037">(</span><span class="keyword" id="1707038">struct</span>&nbsp;<span class="op" id="1707045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707049">b</span>&nbsp;<span class="ident" id="1707051">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707058">v</span>&nbsp;<span class="ident" id="1707060">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1707067">}</span><span class="op" id="1707068">{</span><span class="op" id="1707069">}</span><span class="op" id="1707070">.</span><span class="ident" id="1707071">v</span><span class="op" id="1707072">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707076">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707156">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707249">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707343">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707425">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707440">=</span>&nbsp;<span class="num" id="1707442">0</span>&nbsp;<span class="comment" id="1707444">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707462">evacuatedEmpty</span>&nbsp;<span class="op" id="1707477">=</span>&nbsp;<span class="num" id="1707479">1</span>&nbsp;<span class="comment" id="1707481">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707521">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707536">=</span>&nbsp;<span class="num" id="1707538">2</span>&nbsp;<span class="comment" id="1707540">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707621">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707636">=</span>&nbsp;<span class="num" id="1707638">3</span>&nbsp;<span class="comment" id="1707640">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707705">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707720">=</span>&nbsp;<span class="num" id="1707722">4</span>&nbsp;<span class="comment" id="1707724">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707771">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707781">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1707793">=</span>&nbsp;<span class="num" id="1707795">1</span>&nbsp;<span class="comment" id="1707797">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707840">oldIterator</span>&nbsp;<span class="op" id="1707852">=</span>&nbsp;<span class="num" id="1707854">2</span>&nbsp;<span class="comment" id="1707856">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707903">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1707946">noCheck</span>&nbsp;<span class="op" id="1707954">=</span>&nbsp;<span class="num" id="1707956">1</span><span class="op" id="1707957">&lt;&lt;</span><span class="op" id="1707959">(</span><span class="num" id="1707960">8</span><span class="op" id="1707961">*</span><span class="ident" id="1707962">ptrSize</span><span class="op" id="1707969">)</span>&nbsp;<span class="op" id="1707971">-</span>&nbsp;<span class="num" id="1707973">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1707977">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708047">checkgc</span>&nbsp;<span class="op" id="1708055">=</span>&nbsp;<span class="builtintype" id="1708057">false</span><br>
<span class="lineno"></span><span class="op" id="1708063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1708066">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1708092">type</span>&nbsp;<span class="ident" id="1708097">hmap</span>&nbsp;<span class="keyword" id="1708102">struct</span>&nbsp;<span class="op" id="1708109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708112">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708186">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708272">count</span>&nbsp;<span class="builtintype" id="1708278">int</span>&nbsp;<span class="comment" id="1708282">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708354">flags</span>&nbsp;<span class="builtintype" id="1708360">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708368">hash0</span>&nbsp;<span class="builtintype" id="1708374">uint32</span>&nbsp;<span class="comment" id="1708381">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708395">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1708401">uint8</span>&nbsp;&nbsp;<span class="comment" id="1708408">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708475">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1708486">unsafe</span><span class="op" id="1708492">.</span><span class="ident" id="1708493">Pointer</span>&nbsp;<span class="comment" id="1708501">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708551">oldbuckets</span>&nbsp;<span class="ident" id="1708562">unsafe</span><span class="op" id="1708568">.</span><span class="ident" id="1708569">Pointer</span>&nbsp;<span class="comment" id="1708577">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708647">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1708658">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1708673">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1708753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1708756">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1708782">type</span>&nbsp;<span class="ident" id="1708787">bmap</span>&nbsp;<span class="keyword" id="1708792">struct</span>&nbsp;<span class="op" id="1708799">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708802">tophash</span>&nbsp;&nbsp;<span class="op" id="1708811">[</span><span class="ident" id="1708812">bucketCnt</span><span class="op" id="1708821">]</span><span class="builtintype" id="1708822">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1708829">overflow</span>&nbsp;<span class="op" id="1708838">*</span><span class="ident" id="1708839">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708845">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708903">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1708986">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1709073">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1709149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1709152">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1709183">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1709248">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1709281">type</span>&nbsp;<span class="ident" id="1709286">hiter</span>&nbsp;<span class="keyword" id="1709292">struct</span>&nbsp;<span class="op" id="1709299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709302">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1709314">unsafe</span><span class="op" id="1709320">.</span><span class="ident" id="1709321">Pointer</span>&nbsp;<span class="comment" id="1709329">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709419">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1709431">unsafe</span><span class="op" id="1709437">.</span><span class="ident" id="1709438">Pointer</span>&nbsp;<span class="comment" id="1709446">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709499">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1709511">*</span><span class="ident" id="1709512">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709521">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1709533">*</span><span class="ident" id="1709534">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709540">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1709552">unsafe</span><span class="op" id="1709558">.</span><span class="ident" id="1709559">Pointer</span>&nbsp;<span class="comment" id="1709567">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709615">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1709627">*</span><span class="ident" id="1709628">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1709642">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709661">startBucket</span>&nbsp;<span class="builtintype" id="1709673">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1709688">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709720">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1709732">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1709747">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709845">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1709857">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1709872">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709937">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1709949">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709956">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1709968">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709975">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1709987">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1709996">checkBucket</span>&nbsp;<span class="builtintype" id="1710008">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1710016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1710019">func</span>&nbsp;<span class="ident" id="1710024">evacuated</span><span class="op" id="1710033">(</span><span class="ident" id="1710034">b</span>&nbsp;<span class="op" id="1710036">*</span><span class="ident" id="1710037">bmap</span><span class="op" id="1710041">)</span>&nbsp;<span class="builtintype" id="1710043">bool</span>&nbsp;<span class="op" id="1710048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710051">h</span>&nbsp;<span class="op" id="1710053">:=</span>&nbsp;<span class="ident" id="1710056">b</span><span class="op" id="1710057">.</span><span class="ident" id="1710058">tophash</span><span class="op" id="1710065">[</span><span class="num" id="1710066">0</span><span class="op" id="1710067">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1710070">return</span>&nbsp;<span class="ident" id="1710077">h</span>&nbsp;<span class="op" id="1710079">&gt;</span>&nbsp;<span class="ident" id="1710081">empty</span>&nbsp;<span class="op" id="1710087">&amp;&amp;</span>&nbsp;<span class="ident" id="1710090">h</span>&nbsp;<span class="op" id="1710092">&lt;</span>&nbsp;<span class="ident" id="1710094">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1710105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1710108">func</span>&nbsp;<span class="ident" id="1710113">makemap</span><span class="op" id="1710120">(</span><span class="ident" id="1710121">t</span>&nbsp;<span class="op" id="1710123">*</span><span class="ident" id="1710124">maptype</span><span class="op" id="1710131">,</span>&nbsp;<span class="ident" id="1710133">hint</span>&nbsp;<span class="ident" id="1710138">int64</span><span class="op" id="1710143">)</span>&nbsp;<span class="op" id="1710145">*</span><span class="ident" id="1710146">hmap</span>&nbsp;<span class="op" id="1710151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1710154">if</span>&nbsp;<span class="ident" id="1710157">sz</span>&nbsp;<span class="op" id="1710160">:=</span>&nbsp;<span class="ident" id="1710163">unsafe</span><span class="op" id="1710169">.</span><span class="ident" id="1710170">Sizeof</span><span class="op" id="1710176">(</span><span class="ident" id="1710177">hmap</span><span class="op" id="1710181">{</span><span class="op" id="1710182">}</span><span class="op" id="1710183">)</span><span class="op" id="1710184">;</span>&nbsp;<span class="ident" id="1710186">sz</span>&nbsp;<span class="op" id="1710189">&gt;</span>&nbsp;<span class="num" id="1710191">48</span>&nbsp;<span class="op" id="1710194">||</span>&nbsp;<span class="ident" id="1710197">sz</span>&nbsp;<span class="op" id="1710200">!=</span>&nbsp;<span class="builtintype" id="1710203">uintptr</span><span class="op" id="1710210">(</span><span class="ident" id="1710211">t</span><span class="op" id="1710212">.</span><span class="ident" id="1710213">hmap</span><span class="op" id="1710217">.</span><span class="ident" id="1710218">size</span><span class="op" id="1710222">)</span>&nbsp;<span class="op" id="1710224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710228">gothrow</span><span class="op" id="1710235">(</span><span class="string" id="1710236">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1710251">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1710254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1710258">if</span>&nbsp;<span class="ident" id="1710261">hint</span>&nbsp;<span class="op" id="1710266">&lt;</span>&nbsp;<span class="num" id="1710268">0</span>&nbsp;<span class="op" id="1710270">||</span>&nbsp;<span class="ident" id="1710273">int64</span><span class="op" id="1710278">(</span><span class="builtintype" id="1710279">int32</span><span class="op" id="1710284">(</span><span class="ident" id="1710285">hint</span><span class="op" id="1710289">)</span><span class="op" id="1710290">)</span>&nbsp;<span class="op" id="1710292">!=</span>&nbsp;<span class="ident" id="1710295">hint</span>&nbsp;<span class="op" id="1710300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1710304">panic</span><span class="op" id="1710309">(</span><span class="string" id="1710310">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1710338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1710342">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1710397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1710401">if</span>&nbsp;<span class="op" id="1710404">!</span><span class="ident" id="1710405">ismapkey</span><span class="op" id="1710413">(</span><span class="ident" id="1710414">t</span><span class="op" id="1710415">.</span><span class="ident" id="1710416">key</span><span class="op" id="1710419">)</span>&nbsp;<span class="op" id="1710421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710425">gothrow</span><span class="op" id="1710432">(</span><span class="string" id="1710433">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1710476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1710479">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1710483">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1710523">if</span>&nbsp;<span class="ident" id="1710526">t</span><span class="op" id="1710527">.</span><span class="ident" id="1710528">key</span><span class="op" id="1710531">.</span><span class="ident" id="1710532">size</span>&nbsp;<span class="op" id="1710537">&gt;</span>&nbsp;<span class="ident" id="1710539">maxKeySize</span>&nbsp;<span class="op" id="1710550">&amp;&amp;</span>&nbsp;<span class="op" id="1710553">(</span><span class="op" id="1710554">!</span><span class="ident" id="1710555">t</span><span class="op" id="1710556">.</span><span class="ident" id="1710557">indirectkey</span>&nbsp;<span class="op" id="1710569">||</span>&nbsp;<span class="ident" id="1710572">t</span><span class="op" id="1710573">.</span><span class="ident" id="1710574">keysize</span>&nbsp;<span class="op" id="1710582">!=</span>&nbsp;<span class="builtintype" id="1710585">uint8</span><span class="op" id="1710590">(</span><span class="ident" id="1710591">ptrSize</span><span class="op" id="1710598">)</span><span class="op" id="1710599">)</span>&nbsp;<span class="op" id="1710601">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710606">t</span><span class="op" id="1710607">.</span><span class="ident" id="1710608">key</span><span class="op" id="1710611">.</span><span class="ident" id="1710612">size</span>&nbsp;<span class="op" id="1710617">&lt;=</span>&nbsp;<span class="ident" id="1710620">maxKeySize</span>&nbsp;<span class="op" id="1710631">&amp;&amp;</span>&nbsp;<span class="op" id="1710634">(</span><span class="ident" id="1710635">t</span><span class="op" id="1710636">.</span><span class="ident" id="1710637">indirectkey</span>&nbsp;<span class="op" id="1710649">||</span>&nbsp;<span class="ident" id="1710652">t</span><span class="op" id="1710653">.</span><span class="ident" id="1710654">keysize</span>&nbsp;<span class="op" id="1710662">!=</span>&nbsp;<span class="builtintype" id="1710665">uint8</span><span class="op" id="1710670">(</span><span class="ident" id="1710671">t</span><span class="op" id="1710672">.</span><span class="ident" id="1710673">key</span><span class="op" id="1710676">.</span><span class="ident" id="1710677">size</span><span class="op" id="1710681">)</span><span class="op" id="1710682">)</span>&nbsp;<span class="op" id="1710684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710688">gothrow</span><span class="op" id="1710695">(</span><span class="string" id="1710696">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1710712">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1710715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1710718">if</span>&nbsp;<span class="ident" id="1710721">t</span><span class="op" id="1710722">.</span><span class="ident" id="1710723">elem</span><span class="op" id="1710727">.</span><span class="ident" id="1710728">size</span>&nbsp;<span class="op" id="1710733">&gt;</span>&nbsp;<span class="ident" id="1710735">maxValueSize</span>&nbsp;<span class="op" id="1710748">&amp;&amp;</span>&nbsp;<span class="op" id="1710751">(</span><span class="op" id="1710752">!</span><span class="ident" id="1710753">t</span><span class="op" id="1710754">.</span><span class="ident" id="1710755">indirectvalue</span>&nbsp;<span class="op" id="1710769">||</span>&nbsp;<span class="ident" id="1710772">t</span><span class="op" id="1710773">.</span><span class="ident" id="1710774">valuesize</span>&nbsp;<span class="op" id="1710784">!=</span>&nbsp;<span class="builtintype" id="1710787">uint8</span><span class="op" id="1710792">(</span><span class="ident" id="1710793">ptrSize</span><span class="op" id="1710800">)</span><span class="op" id="1710801">)</span>&nbsp;<span class="op" id="1710803">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710808">t</span><span class="op" id="1710809">.</span><span class="ident" id="1710810">elem</span><span class="op" id="1710814">.</span><span class="ident" id="1710815">size</span>&nbsp;<span class="op" id="1710820">&lt;=</span>&nbsp;<span class="ident" id="1710823">maxValueSize</span>&nbsp;<span class="op" id="1710836">&amp;&amp;</span>&nbsp;<span class="op" id="1710839">(</span><span class="ident" id="1710840">t</span><span class="op" id="1710841">.</span><span class="ident" id="1710842">indirectvalue</span>&nbsp;<span class="op" id="1710856">||</span>&nbsp;<span class="ident" id="1710859">t</span><span class="op" id="1710860">.</span><span class="ident" id="1710861">valuesize</span>&nbsp;<span class="op" id="1710871">!=</span>&nbsp;<span class="builtintype" id="1710874">uint8</span><span class="op" id="1710879">(</span><span class="ident" id="1710880">t</span><span class="op" id="1710881">.</span><span class="ident" id="1710882">elem</span><span class="op" id="1710886">.</span><span class="ident" id="1710887">size</span><span class="op" id="1710891">)</span><span class="op" id="1710892">)</span>&nbsp;<span class="op" id="1710894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1710898">gothrow</span><span class="op" id="1710905">(</span><span class="string" id="1710906">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1710924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1710927">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1710931">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1711008">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711053">if</span>&nbsp;<span class="ident" id="1711056">t</span><span class="op" id="1711057">.</span><span class="ident" id="1711058">key</span><span class="op" id="1711061">.</span><span class="ident" id="1711062">align</span>&nbsp;<span class="op" id="1711068">&gt;</span>&nbsp;<span class="ident" id="1711070">bucketCnt</span>&nbsp;<span class="op" id="1711080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711084">gothrow</span><span class="op" id="1711091">(</span><span class="string" id="1711092">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1711111">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711117">if</span>&nbsp;<span class="ident" id="1711120">t</span><span class="op" id="1711121">.</span><span class="ident" id="1711122">elem</span><span class="op" id="1711126">.</span><span class="ident" id="1711127">align</span>&nbsp;<span class="op" id="1711133">&gt;</span>&nbsp;<span class="ident" id="1711135">bucketCnt</span>&nbsp;<span class="op" id="1711145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711149">gothrow</span><span class="op" id="1711156">(</span><span class="string" id="1711157">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1711178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711184">if</span>&nbsp;<span class="builtintype" id="1711187">uintptr</span><span class="op" id="1711194">(</span><span class="ident" id="1711195">t</span><span class="op" id="1711196">.</span><span class="ident" id="1711197">key</span><span class="op" id="1711200">.</span><span class="ident" id="1711201">size</span><span class="op" id="1711205">)</span><span class="op" id="1711206">%</span><span class="builtintype" id="1711207">uintptr</span><span class="op" id="1711214">(</span><span class="ident" id="1711215">t</span><span class="op" id="1711216">.</span><span class="ident" id="1711217">key</span><span class="op" id="1711220">.</span><span class="ident" id="1711221">align</span><span class="op" id="1711226">)</span>&nbsp;<span class="op" id="1711228">!=</span>&nbsp;<span class="num" id="1711231">0</span>&nbsp;<span class="op" id="1711233">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711237">gothrow</span><span class="op" id="1711244">(</span><span class="string" id="1711245">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1711283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711289">if</span>&nbsp;<span class="builtintype" id="1711292">uintptr</span><span class="op" id="1711299">(</span><span class="ident" id="1711300">t</span><span class="op" id="1711301">.</span><span class="ident" id="1711302">elem</span><span class="op" id="1711306">.</span><span class="ident" id="1711307">size</span><span class="op" id="1711311">)</span><span class="op" id="1711312">%</span><span class="builtintype" id="1711313">uintptr</span><span class="op" id="1711320">(</span><span class="ident" id="1711321">t</span><span class="op" id="1711322">.</span><span class="ident" id="1711323">elem</span><span class="op" id="1711327">.</span><span class="ident" id="1711328">align</span><span class="op" id="1711333">)</span>&nbsp;<span class="op" id="1711335">!=</span>&nbsp;<span class="num" id="1711338">0</span>&nbsp;<span class="op" id="1711340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711344">gothrow</span><span class="op" id="1711351">(</span><span class="string" id="1711352">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1711394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711397">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711400">if</span>&nbsp;<span class="ident" id="1711403">bucketCnt</span>&nbsp;<span class="op" id="1711413">&lt;</span>&nbsp;<span class="num" id="1711415">8</span>&nbsp;<span class="op" id="1711417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711421">gothrow</span><span class="op" id="1711428">(</span><span class="string" id="1711429">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1711472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711478">if</span>&nbsp;<span class="ident" id="1711481">dataOffset</span><span class="op" id="1711491">%</span><span class="builtintype" id="1711492">uintptr</span><span class="op" id="1711499">(</span><span class="ident" id="1711500">t</span><span class="op" id="1711501">.</span><span class="ident" id="1711502">key</span><span class="op" id="1711505">.</span><span class="ident" id="1711506">align</span><span class="op" id="1711511">)</span>&nbsp;<span class="op" id="1711513">!=</span>&nbsp;<span class="num" id="1711516">0</span>&nbsp;<span class="op" id="1711518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711522">gothrow</span><span class="op" id="1711529">(</span><span class="string" id="1711530">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1711560">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711566">if</span>&nbsp;<span class="ident" id="1711569">dataOffset</span><span class="op" id="1711579">%</span><span class="builtintype" id="1711580">uintptr</span><span class="op" id="1711587">(</span><span class="ident" id="1711588">t</span><span class="op" id="1711589">.</span><span class="ident" id="1711590">elem</span><span class="op" id="1711594">.</span><span class="ident" id="1711595">align</span><span class="op" id="1711600">)</span>&nbsp;<span class="op" id="1711602">!=</span>&nbsp;<span class="num" id="1711605">0</span>&nbsp;<span class="op" id="1711607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711611">gothrow</span><span class="op" id="1711618">(</span><span class="string" id="1711619">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1711651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1711658">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1711726">B</span>&nbsp;<span class="op" id="1711728">:=</span>&nbsp;<span class="builtintype" id="1711731">uint8</span><span class="op" id="1711736">(</span><span class="num" id="1711737">0</span><span class="op" id="1711738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711741">for</span>&nbsp;<span class="op" id="1711745">;</span>&nbsp;<span class="ident" id="1711747">hint</span>&nbsp;<span class="op" id="1711752">&gt;</span>&nbsp;<span class="ident" id="1711754">bucketCnt</span>&nbsp;<span class="op" id="1711764">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1711767">float32</span><span class="op" id="1711774">(</span><span class="ident" id="1711775">hint</span><span class="op" id="1711779">)</span>&nbsp;<span class="op" id="1711781">&gt;</span>&nbsp;<span class="ident" id="1711783">loadFactor</span><span class="op" id="1711793">*</span><span class="builtintype" id="1711794">float32</span><span class="op" id="1711801">(</span><span class="builtintype" id="1711802">uintptr</span><span class="op" id="1711809">(</span><span class="num" id="1711810">1</span><span class="op" id="1711811">)</span><span class="op" id="1711812">&lt;&lt;</span><span class="ident" id="1711814">B</span><span class="op" id="1711815">)</span><span class="op" id="1711816">;</span>&nbsp;<span class="ident" id="1711818">B</span><span class="op" id="1711819">++</span>&nbsp;<span class="op" id="1711822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1711825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1711829">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1711861">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1711935">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1711996">var</span>&nbsp;<span class="ident" id="1712000">buckets</span>&nbsp;<span class="ident" id="1712008">unsafe</span><span class="op" id="1712014">.</span><span class="ident" id="1712015">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712024">if</span>&nbsp;<span class="ident" id="1712027">B</span>&nbsp;<span class="op" id="1712029">!=</span>&nbsp;<span class="num" id="1712032">0</span>&nbsp;<span class="op" id="1712034">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712038">if</span>&nbsp;<span class="ident" id="1712041">checkgc</span>&nbsp;<span class="op" id="1712049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712054">memstats</span><span class="op" id="1712062">.</span><span class="ident" id="1712063">next_gc</span>&nbsp;<span class="op" id="1712071">=</span>&nbsp;<span class="ident" id="1712073">memstats</span><span class="op" id="1712081">.</span><span class="ident" id="1712082">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1712095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712099">buckets</span>&nbsp;<span class="op" id="1712107">=</span>&nbsp;<span class="ident" id="1712109">newarray</span><span class="op" id="1712117">(</span><span class="ident" id="1712118">t</span><span class="op" id="1712119">.</span><span class="ident" id="1712120">bucket</span><span class="op" id="1712126">,</span>&nbsp;<span class="builtintype" id="1712128">uintptr</span><span class="op" id="1712135">(</span><span class="num" id="1712136">1</span><span class="op" id="1712137">)</span><span class="op" id="1712138">&lt;&lt;</span><span class="ident" id="1712140">B</span><span class="op" id="1712141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1712144">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1712148">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712168">if</span>&nbsp;<span class="ident" id="1712171">checkgc</span>&nbsp;<span class="op" id="1712179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712183">memstats</span><span class="op" id="1712191">.</span><span class="ident" id="1712192">next_gc</span>&nbsp;<span class="op" id="1712200">=</span>&nbsp;<span class="ident" id="1712202">memstats</span><span class="op" id="1712210">.</span><span class="ident" id="1712211">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1712223">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712226">h</span>&nbsp;<span class="op" id="1712228">:=</span>&nbsp;<span class="op" id="1712231">(</span><span class="op" id="1712232">*</span><span class="ident" id="1712233">hmap</span><span class="op" id="1712237">)</span><span class="op" id="1712238">(</span><span class="ident" id="1712239">newobject</span><span class="op" id="1712248">(</span><span class="ident" id="1712249">t</span><span class="op" id="1712250">.</span><span class="ident" id="1712251">hmap</span><span class="op" id="1712255">)</span><span class="op" id="1712256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712259">h</span><span class="op" id="1712260">.</span><span class="ident" id="1712261">count</span>&nbsp;<span class="op" id="1712267">=</span>&nbsp;<span class="num" id="1712269">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712272">h</span><span class="op" id="1712273">.</span><span class="ident" id="1712274">B</span>&nbsp;<span class="op" id="1712276">=</span>&nbsp;<span class="ident" id="1712278">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712281">h</span><span class="op" id="1712282">.</span><span class="ident" id="1712283">flags</span>&nbsp;<span class="op" id="1712289">=</span>&nbsp;<span class="num" id="1712291">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712294">h</span><span class="op" id="1712295">.</span><span class="ident" id="1712296">hash0</span>&nbsp;<span class="op" id="1712302">=</span>&nbsp;<span class="ident" id="1712304">fastrand1</span><span class="op" id="1712313">(</span><span class="op" id="1712314">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712317">h</span><span class="op" id="1712318">.</span><span class="ident" id="1712319">buckets</span>&nbsp;<span class="op" id="1712327">=</span>&nbsp;<span class="ident" id="1712329">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712338">h</span><span class="op" id="1712339">.</span><span class="ident" id="1712340">oldbuckets</span>&nbsp;<span class="op" id="1712351">=</span>&nbsp;<span class="ident" id="1712353">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712358">h</span><span class="op" id="1712359">.</span><span class="ident" id="1712360">nevacuate</span>&nbsp;<span class="op" id="1712370">=</span>&nbsp;<span class="num" id="1712372">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712376">return</span>&nbsp;<span class="ident" id="1712383">h</span><br>
<span class="lineno">230</span><span class="op" id="1712385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1712388">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1712459">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1712530">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1712560">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1712628">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1712659">func</span>&nbsp;<span class="ident" id="1712664">mapaccess1</span><span class="op" id="1712674">(</span><span class="ident" id="1712675">t</span>&nbsp;<span class="op" id="1712677">*</span><span class="ident" id="1712678">maptype</span><span class="op" id="1712685">,</span>&nbsp;<span class="ident" id="1712687">h</span>&nbsp;<span class="op" id="1712689">*</span><span class="ident" id="1712690">hmap</span><span class="op" id="1712694">,</span>&nbsp;<span class="ident" id="1712696">key</span>&nbsp;<span class="ident" id="1712700">unsafe</span><span class="op" id="1712706">.</span><span class="ident" id="1712707">Pointer</span><span class="op" id="1712714">)</span>&nbsp;<span class="ident" id="1712716">unsafe</span><span class="op" id="1712722">.</span><span class="ident" id="1712723">Pointer</span>&nbsp;<span class="op" id="1712731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712734">if</span>&nbsp;<span class="ident" id="1712737">raceenabled</span>&nbsp;<span class="op" id="1712749">&amp;&amp;</span>&nbsp;<span class="ident" id="1712752">h</span>&nbsp;<span class="op" id="1712754">!=</span>&nbsp;<span class="ident" id="1712757">nil</span>&nbsp;<span class="op" id="1712761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712765">callerpc</span>&nbsp;<span class="op" id="1712774">:=</span>&nbsp;<span class="ident" id="1712777">getcallerpc</span><span class="op" id="1712788">(</span><span class="ident" id="1712789">unsafe</span><span class="op" id="1712795">.</span><span class="ident" id="1712796">Pointer</span><span class="op" id="1712803">(</span><span class="op" id="1712804">&amp;</span><span class="ident" id="1712805">t</span><span class="op" id="1712806">)</span><span class="op" id="1712807">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712811">pc</span>&nbsp;<span class="op" id="1712814">:=</span>&nbsp;<span class="ident" id="1712817">funcPC</span><span class="op" id="1712823">(</span><span class="ident" id="1712824">mapaccess1</span><span class="op" id="1712834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712838">racereadpc</span><span class="op" id="1712848">(</span><span class="ident" id="1712849">unsafe</span><span class="op" id="1712855">.</span><span class="ident" id="1712856">Pointer</span><span class="op" id="1712863">(</span><span class="ident" id="1712864">h</span><span class="op" id="1712865">)</span><span class="op" id="1712866">,</span>&nbsp;<span class="ident" id="1712868">callerpc</span><span class="op" id="1712876">,</span>&nbsp;<span class="ident" id="1712878">pc</span><span class="op" id="1712880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1712884">raceReadObjectPC</span><span class="op" id="1712900">(</span><span class="ident" id="1712901">t</span><span class="op" id="1712902">.</span><span class="ident" id="1712903">key</span><span class="op" id="1712906">,</span>&nbsp;<span class="ident" id="1712908">key</span><span class="op" id="1712911">,</span>&nbsp;<span class="ident" id="1712913">callerpc</span><span class="op" id="1712921">,</span>&nbsp;<span class="ident" id="1712923">pc</span><span class="op" id="1712925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1712928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712931">if</span>&nbsp;<span class="ident" id="1712934">h</span>&nbsp;<span class="op" id="1712936">==</span>&nbsp;<span class="ident" id="1712939">nil</span>&nbsp;<span class="op" id="1712943">||</span>&nbsp;<span class="ident" id="1712946">h</span><span class="op" id="1712947">.</span><span class="ident" id="1712948">count</span>&nbsp;<span class="op" id="1712954">==</span>&nbsp;<span class="num" id="1712957">0</span>&nbsp;<span class="op" id="1712959">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1712963">return</span>&nbsp;<span class="ident" id="1712970">unsafe</span><span class="op" id="1712976">.</span><span class="ident" id="1712977">Pointer</span><span class="op" id="1712984">(</span><span class="ident" id="1712985">t</span><span class="op" id="1712986">.</span><span class="ident" id="1712987">elem</span><span class="op" id="1712991">.</span><span class="ident" id="1712992">zero</span><span class="op" id="1712996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1712999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713002">alg</span>&nbsp;<span class="op" id="1713006">:=</span>&nbsp;<span class="ident" id="1713009">goalg</span><span class="op" id="1713014">(</span><span class="ident" id="1713015">t</span><span class="op" id="1713016">.</span><span class="ident" id="1713017">key</span><span class="op" id="1713020">.</span><span class="ident" id="1713021">alg</span><span class="op" id="1713024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713027">hash</span>&nbsp;<span class="op" id="1713032">:=</span>&nbsp;<span class="ident" id="1713035">alg</span><span class="op" id="1713038">.</span><span class="ident" id="1713039">hash</span><span class="op" id="1713043">(</span><span class="ident" id="1713044">key</span><span class="op" id="1713047">,</span>&nbsp;<span class="builtintype" id="1713049">uintptr</span><span class="op" id="1713056">(</span><span class="ident" id="1713057">t</span><span class="op" id="1713058">.</span><span class="ident" id="1713059">key</span><span class="op" id="1713062">.</span><span class="ident" id="1713063">size</span><span class="op" id="1713067">)</span><span class="op" id="1713068">,</span>&nbsp;<span class="builtintype" id="1713070">uintptr</span><span class="op" id="1713077">(</span><span class="ident" id="1713078">h</span><span class="op" id="1713079">.</span><span class="ident" id="1713080">hash0</span><span class="op" id="1713085">)</span><span class="op" id="1713086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713089">m</span>&nbsp;<span class="op" id="1713091">:=</span>&nbsp;<span class="builtintype" id="1713094">uintptr</span><span class="op" id="1713101">(</span><span class="num" id="1713102">1</span><span class="op" id="1713103">)</span><span class="op" id="1713104">&lt;&lt;</span><span class="ident" id="1713106">h</span><span class="op" id="1713107">.</span><span class="ident" id="1713108">B</span>&nbsp;<span class="op" id="1713110">-</span>&nbsp;<span class="num" id="1713112">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713115">b</span>&nbsp;<span class="op" id="1713117">:=</span>&nbsp;<span class="op" id="1713120">(</span><span class="op" id="1713121">*</span><span class="ident" id="1713122">bmap</span><span class="op" id="1713126">)</span><span class="op" id="1713127">(</span><span class="ident" id="1713128">add</span><span class="op" id="1713131">(</span><span class="ident" id="1713132">h</span><span class="op" id="1713133">.</span><span class="ident" id="1713134">buckets</span><span class="op" id="1713141">,</span>&nbsp;<span class="op" id="1713143">(</span><span class="ident" id="1713144">hash</span><span class="op" id="1713148">&amp;</span><span class="ident" id="1713149">m</span><span class="op" id="1713150">)</span><span class="op" id="1713151">*</span><span class="builtintype" id="1713152">uintptr</span><span class="op" id="1713159">(</span><span class="ident" id="1713160">t</span><span class="op" id="1713161">.</span><span class="ident" id="1713162">bucketsize</span><span class="op" id="1713172">)</span><span class="op" id="1713173">)</span><span class="op" id="1713174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713177">if</span>&nbsp;<span class="ident" id="1713180">c</span>&nbsp;<span class="op" id="1713182">:=</span>&nbsp;<span class="ident" id="1713185">h</span><span class="op" id="1713186">.</span><span class="ident" id="1713187">oldbuckets</span><span class="op" id="1713197">;</span>&nbsp;<span class="ident" id="1713199">c</span>&nbsp;<span class="op" id="1713201">!=</span>&nbsp;<span class="ident" id="1713204">nil</span>&nbsp;<span class="op" id="1713208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713212">oldb</span>&nbsp;<span class="op" id="1713217">:=</span>&nbsp;<span class="op" id="1713220">(</span><span class="op" id="1713221">*</span><span class="ident" id="1713222">bmap</span><span class="op" id="1713226">)</span><span class="op" id="1713227">(</span><span class="ident" id="1713228">add</span><span class="op" id="1713231">(</span><span class="ident" id="1713232">c</span><span class="op" id="1713233">,</span>&nbsp;<span class="op" id="1713235">(</span><span class="ident" id="1713236">hash</span><span class="op" id="1713240">&amp;</span><span class="op" id="1713241">(</span><span class="ident" id="1713242">m</span><span class="op" id="1713243">&gt;&gt;</span><span class="num" id="1713245">1</span><span class="op" id="1713246">)</span><span class="op" id="1713247">)</span><span class="op" id="1713248">*</span><span class="builtintype" id="1713249">uintptr</span><span class="op" id="1713256">(</span><span class="ident" id="1713257">t</span><span class="op" id="1713258">.</span><span class="ident" id="1713259">bucketsize</span><span class="op" id="1713269">)</span><span class="op" id="1713270">)</span><span class="op" id="1713271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713275">if</span>&nbsp;<span class="op" id="1713278">!</span><span class="ident" id="1713279">evacuated</span><span class="op" id="1713288">(</span><span class="ident" id="1713289">oldb</span><span class="op" id="1713293">)</span>&nbsp;<span class="op" id="1713295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713300">b</span>&nbsp;<span class="op" id="1713302">=</span>&nbsp;<span class="ident" id="1713304">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713317">top</span>&nbsp;<span class="op" id="1713321">:=</span>&nbsp;<span class="builtintype" id="1713324">uint8</span><span class="op" id="1713329">(</span><span class="ident" id="1713330">hash</span>&nbsp;<span class="op" id="1713335">&gt;&gt;</span>&nbsp;<span class="op" id="1713338">(</span><span class="ident" id="1713339">ptrSize</span><span class="op" id="1713346">*</span><span class="num" id="1713347">8</span>&nbsp;<span class="op" id="1713349">-</span>&nbsp;<span class="num" id="1713351">8</span><span class="op" id="1713352">)</span><span class="op" id="1713353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713356">if</span>&nbsp;<span class="ident" id="1713359">top</span>&nbsp;<span class="op" id="1713363">&lt;</span>&nbsp;<span class="ident" id="1713365">minTopHash</span>&nbsp;<span class="op" id="1713376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713380">top</span>&nbsp;<span class="op" id="1713384">+=</span>&nbsp;<span class="ident" id="1713387">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713402">for</span>&nbsp;<span class="op" id="1713406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713410">for</span>&nbsp;<span class="ident" id="1713414">i</span>&nbsp;<span class="op" id="1713416">:=</span>&nbsp;<span class="builtintype" id="1713419">uintptr</span><span class="op" id="1713426">(</span><span class="num" id="1713427">0</span><span class="op" id="1713428">)</span><span class="op" id="1713429">;</span>&nbsp;<span class="ident" id="1713431">i</span>&nbsp;<span class="op" id="1713433">&lt;</span>&nbsp;<span class="ident" id="1713435">bucketCnt</span><span class="op" id="1713444">;</span>&nbsp;<span class="ident" id="1713446">i</span><span class="op" id="1713447">++</span>&nbsp;<span class="op" id="1713450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713455">if</span>&nbsp;<span class="ident" id="1713458">b</span><span class="op" id="1713459">.</span><span class="ident" id="1713460">tophash</span><span class="op" id="1713467">[</span><span class="ident" id="1713468">i</span><span class="op" id="1713469">]</span>&nbsp;<span class="op" id="1713471">!=</span>&nbsp;<span class="ident" id="1713474">top</span>&nbsp;<span class="op" id="1713478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713484">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713501">k</span>&nbsp;<span class="op" id="1713503">:=</span>&nbsp;<span class="ident" id="1713506">add</span><span class="op" id="1713509">(</span><span class="ident" id="1713510">unsafe</span><span class="op" id="1713516">.</span><span class="ident" id="1713517">Pointer</span><span class="op" id="1713524">(</span><span class="ident" id="1713525">b</span><span class="op" id="1713526">)</span><span class="op" id="1713527">,</span>&nbsp;<span class="ident" id="1713529">dataOffset</span><span class="op" id="1713539">+</span><span class="ident" id="1713540">i</span><span class="op" id="1713541">*</span><span class="builtintype" id="1713542">uintptr</span><span class="op" id="1713549">(</span><span class="ident" id="1713550">t</span><span class="op" id="1713551">.</span><span class="ident" id="1713552">keysize</span><span class="op" id="1713559">)</span><span class="op" id="1713560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713565">if</span>&nbsp;<span class="ident" id="1713568">t</span><span class="op" id="1713569">.</span><span class="ident" id="1713570">indirectkey</span>&nbsp;<span class="op" id="1713582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713588">k</span>&nbsp;<span class="op" id="1713590">=</span>&nbsp;<span class="op" id="1713592">*</span><span class="op" id="1713593">(</span><span class="op" id="1713594">(</span><span class="op" id="1713595">*</span><span class="ident" id="1713596">unsafe</span><span class="op" id="1713602">.</span><span class="ident" id="1713603">Pointer</span><span class="op" id="1713610">)</span><span class="op" id="1713611">(</span><span class="ident" id="1713612">k</span><span class="op" id="1713613">)</span><span class="op" id="1713614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713619">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713624">if</span>&nbsp;<span class="ident" id="1713627">alg</span><span class="op" id="1713630">.</span><span class="ident" id="1713631">equal</span><span class="op" id="1713636">(</span><span class="ident" id="1713637">key</span><span class="op" id="1713640">,</span>&nbsp;<span class="ident" id="1713642">k</span><span class="op" id="1713643">,</span>&nbsp;<span class="builtintype" id="1713645">uintptr</span><span class="op" id="1713652">(</span><span class="ident" id="1713653">t</span><span class="op" id="1713654">.</span><span class="ident" id="1713655">key</span><span class="op" id="1713658">.</span><span class="ident" id="1713659">size</span><span class="op" id="1713663">)</span><span class="op" id="1713664">)</span>&nbsp;<span class="op" id="1713666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713672">v</span>&nbsp;<span class="op" id="1713674">:=</span>&nbsp;<span class="ident" id="1713677">add</span><span class="op" id="1713680">(</span><span class="ident" id="1713681">unsafe</span><span class="op" id="1713687">.</span><span class="ident" id="1713688">Pointer</span><span class="op" id="1713695">(</span><span class="ident" id="1713696">b</span><span class="op" id="1713697">)</span><span class="op" id="1713698">,</span>&nbsp;<span class="ident" id="1713700">dataOffset</span><span class="op" id="1713710">+</span><span class="ident" id="1713711">bucketCnt</span><span class="op" id="1713720">*</span><span class="builtintype" id="1713721">uintptr</span><span class="op" id="1713728">(</span><span class="ident" id="1713729">t</span><span class="op" id="1713730">.</span><span class="ident" id="1713731">keysize</span><span class="op" id="1713738">)</span><span class="op" id="1713739">+</span><span class="ident" id="1713740">i</span><span class="op" id="1713741">*</span><span class="builtintype" id="1713742">uintptr</span><span class="op" id="1713749">(</span><span class="ident" id="1713750">t</span><span class="op" id="1713751">.</span><span class="ident" id="1713752">valuesize</span><span class="op" id="1713761">)</span><span class="op" id="1713762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713768">if</span>&nbsp;<span class="ident" id="1713771">t</span><span class="op" id="1713772">.</span><span class="ident" id="1713773">indirectvalue</span>&nbsp;<span class="op" id="1713787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713794">v</span>&nbsp;<span class="op" id="1713796">=</span>&nbsp;<span class="op" id="1713798">*</span><span class="op" id="1713799">(</span><span class="op" id="1713800">(</span><span class="op" id="1713801">*</span><span class="ident" id="1713802">unsafe</span><span class="op" id="1713808">.</span><span class="ident" id="1713809">Pointer</span><span class="op" id="1713816">)</span><span class="op" id="1713817">(</span><span class="ident" id="1713818">v</span><span class="op" id="1713819">)</span><span class="op" id="1713820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713826">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713832">return</span>&nbsp;<span class="ident" id="1713839">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1713852">b</span>&nbsp;<span class="op" id="1713854">=</span>&nbsp;<span class="ident" id="1713856">b</span><span class="op" id="1713857">.</span><span class="ident" id="1713858">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713869">if</span>&nbsp;<span class="ident" id="1713872">b</span>&nbsp;<span class="op" id="1713874">==</span>&nbsp;<span class="ident" id="1713877">nil</span>&nbsp;<span class="op" id="1713881">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1713886">return</span>&nbsp;<span class="ident" id="1713893">unsafe</span><span class="op" id="1713899">.</span><span class="ident" id="1713900">Pointer</span><span class="op" id="1713907">(</span><span class="ident" id="1713908">t</span><span class="op" id="1713909">.</span><span class="ident" id="1713910">elem</span><span class="op" id="1713914">.</span><span class="ident" id="1713915">zero</span><span class="op" id="1713919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1713926">}</span><br>
<span class="lineno"></span><span class="op" id="1713928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1713931">func</span>&nbsp;<span class="ident" id="1713936">mapaccess2</span><span class="op" id="1713946">(</span><span class="ident" id="1713947">t</span>&nbsp;<span class="op" id="1713949">*</span><span class="ident" id="1713950">maptype</span><span class="op" id="1713957">,</span>&nbsp;<span class="ident" id="1713959">h</span>&nbsp;<span class="op" id="1713961">*</span><span class="ident" id="1713962">hmap</span><span class="op" id="1713966">,</span>&nbsp;<span class="ident" id="1713968">key</span>&nbsp;<span class="ident" id="1713972">unsafe</span><span class="op" id="1713978">.</span><span class="ident" id="1713979">Pointer</span><span class="op" id="1713986">)</span>&nbsp;<span class="op" id="1713988">(</span><span class="ident" id="1713989">unsafe</span><span class="op" id="1713995">.</span><span class="ident" id="1713996">Pointer</span><span class="op" id="1714003">,</span>&nbsp;<span class="builtintype" id="1714005">bool</span><span class="op" id="1714009">)</span>&nbsp;<span class="op" id="1714011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714014">if</span>&nbsp;<span class="ident" id="1714017">raceenabled</span>&nbsp;<span class="op" id="1714029">&amp;&amp;</span>&nbsp;<span class="ident" id="1714032">h</span>&nbsp;<span class="op" id="1714034">!=</span>&nbsp;<span class="ident" id="1714037">nil</span>&nbsp;<span class="op" id="1714041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714045">callerpc</span>&nbsp;<span class="op" id="1714054">:=</span>&nbsp;<span class="ident" id="1714057">getcallerpc</span><span class="op" id="1714068">(</span><span class="ident" id="1714069">unsafe</span><span class="op" id="1714075">.</span><span class="ident" id="1714076">Pointer</span><span class="op" id="1714083">(</span><span class="op" id="1714084">&amp;</span><span class="ident" id="1714085">t</span><span class="op" id="1714086">)</span><span class="op" id="1714087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714091">pc</span>&nbsp;<span class="op" id="1714094">:=</span>&nbsp;<span class="ident" id="1714097">funcPC</span><span class="op" id="1714103">(</span><span class="ident" id="1714104">mapaccess2</span><span class="op" id="1714114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714118">racereadpc</span><span class="op" id="1714128">(</span><span class="ident" id="1714129">unsafe</span><span class="op" id="1714135">.</span><span class="ident" id="1714136">Pointer</span><span class="op" id="1714143">(</span><span class="ident" id="1714144">h</span><span class="op" id="1714145">)</span><span class="op" id="1714146">,</span>&nbsp;<span class="ident" id="1714148">callerpc</span><span class="op" id="1714156">,</span>&nbsp;<span class="ident" id="1714158">pc</span><span class="op" id="1714160">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714164">raceReadObjectPC</span><span class="op" id="1714180">(</span><span class="ident" id="1714181">t</span><span class="op" id="1714182">.</span><span class="ident" id="1714183">key</span><span class="op" id="1714186">,</span>&nbsp;<span class="ident" id="1714188">key</span><span class="op" id="1714191">,</span>&nbsp;<span class="ident" id="1714193">callerpc</span><span class="op" id="1714201">,</span>&nbsp;<span class="ident" id="1714203">pc</span><span class="op" id="1714205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714211">if</span>&nbsp;<span class="ident" id="1714214">h</span>&nbsp;<span class="op" id="1714216">==</span>&nbsp;<span class="ident" id="1714219">nil</span>&nbsp;<span class="op" id="1714223">||</span>&nbsp;<span class="ident" id="1714226">h</span><span class="op" id="1714227">.</span><span class="ident" id="1714228">count</span>&nbsp;<span class="op" id="1714234">==</span>&nbsp;<span class="num" id="1714237">0</span>&nbsp;<span class="op" id="1714239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714243">return</span>&nbsp;<span class="ident" id="1714250">unsafe</span><span class="op" id="1714256">.</span><span class="ident" id="1714257">Pointer</span><span class="op" id="1714264">(</span><span class="ident" id="1714265">t</span><span class="op" id="1714266">.</span><span class="ident" id="1714267">elem</span><span class="op" id="1714271">.</span><span class="ident" id="1714272">zero</span><span class="op" id="1714276">)</span><span class="op" id="1714277">,</span>&nbsp;<span class="builtintype" id="1714279">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714286">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714289">alg</span>&nbsp;<span class="op" id="1714293">:=</span>&nbsp;<span class="ident" id="1714296">goalg</span><span class="op" id="1714301">(</span><span class="ident" id="1714302">t</span><span class="op" id="1714303">.</span><span class="ident" id="1714304">key</span><span class="op" id="1714307">.</span><span class="ident" id="1714308">alg</span><span class="op" id="1714311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714314">hash</span>&nbsp;<span class="op" id="1714319">:=</span>&nbsp;<span class="ident" id="1714322">alg</span><span class="op" id="1714325">.</span><span class="ident" id="1714326">hash</span><span class="op" id="1714330">(</span><span class="ident" id="1714331">key</span><span class="op" id="1714334">,</span>&nbsp;<span class="builtintype" id="1714336">uintptr</span><span class="op" id="1714343">(</span><span class="ident" id="1714344">t</span><span class="op" id="1714345">.</span><span class="ident" id="1714346">key</span><span class="op" id="1714349">.</span><span class="ident" id="1714350">size</span><span class="op" id="1714354">)</span><span class="op" id="1714355">,</span>&nbsp;<span class="builtintype" id="1714357">uintptr</span><span class="op" id="1714364">(</span><span class="ident" id="1714365">h</span><span class="op" id="1714366">.</span><span class="ident" id="1714367">hash0</span><span class="op" id="1714372">)</span><span class="op" id="1714373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714376">m</span>&nbsp;<span class="op" id="1714378">:=</span>&nbsp;<span class="builtintype" id="1714381">uintptr</span><span class="op" id="1714388">(</span><span class="num" id="1714389">1</span><span class="op" id="1714390">)</span><span class="op" id="1714391">&lt;&lt;</span><span class="ident" id="1714393">h</span><span class="op" id="1714394">.</span><span class="ident" id="1714395">B</span>&nbsp;<span class="op" id="1714397">-</span>&nbsp;<span class="num" id="1714399">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714402">b</span>&nbsp;<span class="op" id="1714404">:=</span>&nbsp;<span class="op" id="1714407">(</span><span class="op" id="1714408">*</span><span class="ident" id="1714409">bmap</span><span class="op" id="1714413">)</span><span class="op" id="1714414">(</span><span class="ident" id="1714415">unsafe</span><span class="op" id="1714421">.</span><span class="ident" id="1714422">Pointer</span><span class="op" id="1714429">(</span><span class="builtintype" id="1714430">uintptr</span><span class="op" id="1714437">(</span><span class="ident" id="1714438">h</span><span class="op" id="1714439">.</span><span class="ident" id="1714440">buckets</span><span class="op" id="1714447">)</span>&nbsp;<span class="op" id="1714449">+</span>&nbsp;<span class="op" id="1714451">(</span><span class="ident" id="1714452">hash</span><span class="op" id="1714456">&amp;</span><span class="ident" id="1714457">m</span><span class="op" id="1714458">)</span><span class="op" id="1714459">*</span><span class="builtintype" id="1714460">uintptr</span><span class="op" id="1714467">(</span><span class="ident" id="1714468">t</span><span class="op" id="1714469">.</span><span class="ident" id="1714470">bucketsize</span><span class="op" id="1714480">)</span><span class="op" id="1714481">)</span><span class="op" id="1714482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714485">if</span>&nbsp;<span class="ident" id="1714488">c</span>&nbsp;<span class="op" id="1714490">:=</span>&nbsp;<span class="ident" id="1714493">h</span><span class="op" id="1714494">.</span><span class="ident" id="1714495">oldbuckets</span><span class="op" id="1714505">;</span>&nbsp;<span class="ident" id="1714507">c</span>&nbsp;<span class="op" id="1714509">!=</span>&nbsp;<span class="ident" id="1714512">nil</span>&nbsp;<span class="op" id="1714516">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714520">oldb</span>&nbsp;<span class="op" id="1714525">:=</span>&nbsp;<span class="op" id="1714528">(</span><span class="op" id="1714529">*</span><span class="ident" id="1714530">bmap</span><span class="op" id="1714534">)</span><span class="op" id="1714535">(</span><span class="ident" id="1714536">unsafe</span><span class="op" id="1714542">.</span><span class="ident" id="1714543">Pointer</span><span class="op" id="1714550">(</span><span class="builtintype" id="1714551">uintptr</span><span class="op" id="1714558">(</span><span class="ident" id="1714559">c</span><span class="op" id="1714560">)</span>&nbsp;<span class="op" id="1714562">+</span>&nbsp;<span class="op" id="1714564">(</span><span class="ident" id="1714565">hash</span><span class="op" id="1714569">&amp;</span><span class="op" id="1714570">(</span><span class="ident" id="1714571">m</span><span class="op" id="1714572">&gt;&gt;</span><span class="num" id="1714574">1</span><span class="op" id="1714575">)</span><span class="op" id="1714576">)</span><span class="op" id="1714577">*</span><span class="builtintype" id="1714578">uintptr</span><span class="op" id="1714585">(</span><span class="ident" id="1714586">t</span><span class="op" id="1714587">.</span><span class="ident" id="1714588">bucketsize</span><span class="op" id="1714598">)</span><span class="op" id="1714599">)</span><span class="op" id="1714600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714604">if</span>&nbsp;<span class="op" id="1714607">!</span><span class="ident" id="1714608">evacuated</span><span class="op" id="1714617">(</span><span class="ident" id="1714618">oldb</span><span class="op" id="1714622">)</span>&nbsp;<span class="op" id="1714624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714629">b</span>&nbsp;<span class="op" id="1714631">=</span>&nbsp;<span class="ident" id="1714633">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714643">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714646">top</span>&nbsp;<span class="op" id="1714650">:=</span>&nbsp;<span class="builtintype" id="1714653">uint8</span><span class="op" id="1714658">(</span><span class="ident" id="1714659">hash</span>&nbsp;<span class="op" id="1714664">&gt;&gt;</span>&nbsp;<span class="op" id="1714667">(</span><span class="ident" id="1714668">ptrSize</span><span class="op" id="1714675">*</span><span class="num" id="1714676">8</span>&nbsp;<span class="op" id="1714678">-</span>&nbsp;<span class="num" id="1714680">8</span><span class="op" id="1714681">)</span><span class="op" id="1714682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714685">if</span>&nbsp;<span class="ident" id="1714688">top</span>&nbsp;<span class="op" id="1714692">&lt;</span>&nbsp;<span class="ident" id="1714694">minTopHash</span>&nbsp;<span class="op" id="1714705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714709">top</span>&nbsp;<span class="op" id="1714713">+=</span>&nbsp;<span class="ident" id="1714716">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714731">for</span>&nbsp;<span class="op" id="1714735">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714739">for</span>&nbsp;<span class="ident" id="1714743">i</span>&nbsp;<span class="op" id="1714745">:=</span>&nbsp;<span class="builtintype" id="1714748">uintptr</span><span class="op" id="1714755">(</span><span class="num" id="1714756">0</span><span class="op" id="1714757">)</span><span class="op" id="1714758">;</span>&nbsp;<span class="ident" id="1714760">i</span>&nbsp;<span class="op" id="1714762">&lt;</span>&nbsp;<span class="ident" id="1714764">bucketCnt</span><span class="op" id="1714773">;</span>&nbsp;<span class="ident" id="1714775">i</span><span class="op" id="1714776">++</span>&nbsp;<span class="op" id="1714779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714784">if</span>&nbsp;<span class="ident" id="1714787">b</span><span class="op" id="1714788">.</span><span class="ident" id="1714789">tophash</span><span class="op" id="1714796">[</span><span class="ident" id="1714797">i</span><span class="op" id="1714798">]</span>&nbsp;<span class="op" id="1714800">!=</span>&nbsp;<span class="ident" id="1714803">top</span>&nbsp;<span class="op" id="1714807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714813">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714830">k</span>&nbsp;<span class="op" id="1714832">:=</span>&nbsp;<span class="ident" id="1714835">add</span><span class="op" id="1714838">(</span><span class="ident" id="1714839">unsafe</span><span class="op" id="1714845">.</span><span class="ident" id="1714846">Pointer</span><span class="op" id="1714853">(</span><span class="ident" id="1714854">b</span><span class="op" id="1714855">)</span><span class="op" id="1714856">,</span>&nbsp;<span class="ident" id="1714858">dataOffset</span><span class="op" id="1714868">+</span><span class="ident" id="1714869">i</span><span class="op" id="1714870">*</span><span class="builtintype" id="1714871">uintptr</span><span class="op" id="1714878">(</span><span class="ident" id="1714879">t</span><span class="op" id="1714880">.</span><span class="ident" id="1714881">keysize</span><span class="op" id="1714888">)</span><span class="op" id="1714889">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714894">if</span>&nbsp;<span class="ident" id="1714897">t</span><span class="op" id="1714898">.</span><span class="ident" id="1714899">indirectkey</span>&nbsp;<span class="op" id="1714911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1714917">k</span>&nbsp;<span class="op" id="1714919">=</span>&nbsp;<span class="op" id="1714921">*</span><span class="op" id="1714922">(</span><span class="op" id="1714923">(</span><span class="op" id="1714924">*</span><span class="ident" id="1714925">unsafe</span><span class="op" id="1714931">.</span><span class="ident" id="1714932">Pointer</span><span class="op" id="1714939">)</span><span class="op" id="1714940">(</span><span class="ident" id="1714941">k</span><span class="op" id="1714942">)</span><span class="op" id="1714943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1714948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1714953">if</span>&nbsp;<span class="ident" id="1714956">alg</span><span class="op" id="1714959">.</span><span class="ident" id="1714960">equal</span><span class="op" id="1714965">(</span><span class="ident" id="1714966">key</span><span class="op" id="1714969">,</span>&nbsp;<span class="ident" id="1714971">k</span><span class="op" id="1714972">,</span>&nbsp;<span class="builtintype" id="1714974">uintptr</span><span class="op" id="1714981">(</span><span class="ident" id="1714982">t</span><span class="op" id="1714983">.</span><span class="ident" id="1714984">key</span><span class="op" id="1714987">.</span><span class="ident" id="1714988">size</span><span class="op" id="1714992">)</span><span class="op" id="1714993">)</span>&nbsp;<span class="op" id="1714995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715001">v</span>&nbsp;<span class="op" id="1715003">:=</span>&nbsp;<span class="ident" id="1715006">add</span><span class="op" id="1715009">(</span><span class="ident" id="1715010">unsafe</span><span class="op" id="1715016">.</span><span class="ident" id="1715017">Pointer</span><span class="op" id="1715024">(</span><span class="ident" id="1715025">b</span><span class="op" id="1715026">)</span><span class="op" id="1715027">,</span>&nbsp;<span class="ident" id="1715029">dataOffset</span><span class="op" id="1715039">+</span><span class="ident" id="1715040">bucketCnt</span><span class="op" id="1715049">*</span><span class="builtintype" id="1715050">uintptr</span><span class="op" id="1715057">(</span><span class="ident" id="1715058">t</span><span class="op" id="1715059">.</span><span class="ident" id="1715060">keysize</span><span class="op" id="1715067">)</span><span class="op" id="1715068">+</span><span class="ident" id="1715069">i</span><span class="op" id="1715070">*</span><span class="builtintype" id="1715071">uintptr</span><span class="op" id="1715078">(</span><span class="ident" id="1715079">t</span><span class="op" id="1715080">.</span><span class="ident" id="1715081">valuesize</span><span class="op" id="1715090">)</span><span class="op" id="1715091">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715097">if</span>&nbsp;<span class="ident" id="1715100">t</span><span class="op" id="1715101">.</span><span class="ident" id="1715102">indirectvalue</span>&nbsp;<span class="op" id="1715116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715123">v</span>&nbsp;<span class="op" id="1715125">=</span>&nbsp;<span class="op" id="1715127">*</span><span class="op" id="1715128">(</span><span class="op" id="1715129">(</span><span class="op" id="1715130">*</span><span class="ident" id="1715131">unsafe</span><span class="op" id="1715137">.</span><span class="ident" id="1715138">Pointer</span><span class="op" id="1715145">)</span><span class="op" id="1715146">(</span><span class="ident" id="1715147">v</span><span class="op" id="1715148">)</span><span class="op" id="1715149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715161">return</span>&nbsp;<span class="ident" id="1715168">v</span><span class="op" id="1715169">,</span>&nbsp;<span class="builtintype" id="1715171">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715179">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715187">b</span>&nbsp;<span class="op" id="1715189">=</span>&nbsp;<span class="ident" id="1715191">b</span><span class="op" id="1715192">.</span><span class="ident" id="1715193">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715204">if</span>&nbsp;<span class="ident" id="1715207">b</span>&nbsp;<span class="op" id="1715209">==</span>&nbsp;<span class="ident" id="1715212">nil</span>&nbsp;<span class="op" id="1715216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715221">return</span>&nbsp;<span class="ident" id="1715228">unsafe</span><span class="op" id="1715234">.</span><span class="ident" id="1715235">Pointer</span><span class="op" id="1715242">(</span><span class="ident" id="1715243">t</span><span class="op" id="1715244">.</span><span class="ident" id="1715245">elem</span><span class="op" id="1715249">.</span><span class="ident" id="1715250">zero</span><span class="op" id="1715254">)</span><span class="op" id="1715255">,</span>&nbsp;<span class="builtintype" id="1715257">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715265">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715268">}</span><br>
<span class="lineno"></span><span class="op" id="1715270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1715273">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1715326">func</span>&nbsp;<span class="ident" id="1715331">mapaccessK</span><span class="op" id="1715341">(</span><span class="ident" id="1715342">t</span>&nbsp;<span class="op" id="1715344">*</span><span class="ident" id="1715345">maptype</span><span class="op" id="1715352">,</span>&nbsp;<span class="ident" id="1715354">h</span>&nbsp;<span class="op" id="1715356">*</span><span class="ident" id="1715357">hmap</span><span class="op" id="1715361">,</span>&nbsp;<span class="ident" id="1715363">key</span>&nbsp;<span class="ident" id="1715367">unsafe</span><span class="op" id="1715373">.</span><span class="ident" id="1715374">Pointer</span><span class="op" id="1715381">)</span>&nbsp;<span class="op" id="1715383">(</span><span class="ident" id="1715384">unsafe</span><span class="op" id="1715390">.</span><span class="ident" id="1715391">Pointer</span><span class="op" id="1715398">,</span>&nbsp;<span class="ident" id="1715400">unsafe</span><span class="op" id="1715406">.</span><span class="ident" id="1715407">Pointer</span><span class="op" id="1715414">)</span>&nbsp;<span class="op" id="1715416">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715419">if</span>&nbsp;<span class="ident" id="1715422">h</span>&nbsp;<span class="op" id="1715424">==</span>&nbsp;<span class="ident" id="1715427">nil</span>&nbsp;<span class="op" id="1715431">||</span>&nbsp;<span class="ident" id="1715434">h</span><span class="op" id="1715435">.</span><span class="ident" id="1715436">count</span>&nbsp;<span class="op" id="1715442">==</span>&nbsp;<span class="num" id="1715445">0</span>&nbsp;<span class="op" id="1715447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715451">return</span>&nbsp;<span class="ident" id="1715458">nil</span><span class="op" id="1715461">,</span>&nbsp;<span class="ident" id="1715463">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715471">alg</span>&nbsp;<span class="op" id="1715475">:=</span>&nbsp;<span class="ident" id="1715478">goalg</span><span class="op" id="1715483">(</span><span class="ident" id="1715484">t</span><span class="op" id="1715485">.</span><span class="ident" id="1715486">key</span><span class="op" id="1715489">.</span><span class="ident" id="1715490">alg</span><span class="op" id="1715493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715496">hash</span>&nbsp;<span class="op" id="1715501">:=</span>&nbsp;<span class="ident" id="1715504">alg</span><span class="op" id="1715507">.</span><span class="ident" id="1715508">hash</span><span class="op" id="1715512">(</span><span class="ident" id="1715513">key</span><span class="op" id="1715516">,</span>&nbsp;<span class="builtintype" id="1715518">uintptr</span><span class="op" id="1715525">(</span><span class="ident" id="1715526">t</span><span class="op" id="1715527">.</span><span class="ident" id="1715528">key</span><span class="op" id="1715531">.</span><span class="ident" id="1715532">size</span><span class="op" id="1715536">)</span><span class="op" id="1715537">,</span>&nbsp;<span class="builtintype" id="1715539">uintptr</span><span class="op" id="1715546">(</span><span class="ident" id="1715547">h</span><span class="op" id="1715548">.</span><span class="ident" id="1715549">hash0</span><span class="op" id="1715554">)</span><span class="op" id="1715555">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715558">m</span>&nbsp;<span class="op" id="1715560">:=</span>&nbsp;<span class="builtintype" id="1715563">uintptr</span><span class="op" id="1715570">(</span><span class="num" id="1715571">1</span><span class="op" id="1715572">)</span><span class="op" id="1715573">&lt;&lt;</span><span class="ident" id="1715575">h</span><span class="op" id="1715576">.</span><span class="ident" id="1715577">B</span>&nbsp;<span class="op" id="1715579">-</span>&nbsp;<span class="num" id="1715581">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715584">b</span>&nbsp;<span class="op" id="1715586">:=</span>&nbsp;<span class="op" id="1715589">(</span><span class="op" id="1715590">*</span><span class="ident" id="1715591">bmap</span><span class="op" id="1715595">)</span><span class="op" id="1715596">(</span><span class="ident" id="1715597">unsafe</span><span class="op" id="1715603">.</span><span class="ident" id="1715604">Pointer</span><span class="op" id="1715611">(</span><span class="builtintype" id="1715612">uintptr</span><span class="op" id="1715619">(</span><span class="ident" id="1715620">h</span><span class="op" id="1715621">.</span><span class="ident" id="1715622">buckets</span><span class="op" id="1715629">)</span>&nbsp;<span class="op" id="1715631">+</span>&nbsp;<span class="op" id="1715633">(</span><span class="ident" id="1715634">hash</span><span class="op" id="1715638">&amp;</span><span class="ident" id="1715639">m</span><span class="op" id="1715640">)</span><span class="op" id="1715641">*</span><span class="builtintype" id="1715642">uintptr</span><span class="op" id="1715649">(</span><span class="ident" id="1715650">t</span><span class="op" id="1715651">.</span><span class="ident" id="1715652">bucketsize</span><span class="op" id="1715662">)</span><span class="op" id="1715663">)</span><span class="op" id="1715664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715667">if</span>&nbsp;<span class="ident" id="1715670">c</span>&nbsp;<span class="op" id="1715672">:=</span>&nbsp;<span class="ident" id="1715675">h</span><span class="op" id="1715676">.</span><span class="ident" id="1715677">oldbuckets</span><span class="op" id="1715687">;</span>&nbsp;<span class="ident" id="1715689">c</span>&nbsp;<span class="op" id="1715691">!=</span>&nbsp;<span class="ident" id="1715694">nil</span>&nbsp;<span class="op" id="1715698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715702">oldb</span>&nbsp;<span class="op" id="1715707">:=</span>&nbsp;<span class="op" id="1715710">(</span><span class="op" id="1715711">*</span><span class="ident" id="1715712">bmap</span><span class="op" id="1715716">)</span><span class="op" id="1715717">(</span><span class="ident" id="1715718">unsafe</span><span class="op" id="1715724">.</span><span class="ident" id="1715725">Pointer</span><span class="op" id="1715732">(</span><span class="builtintype" id="1715733">uintptr</span><span class="op" id="1715740">(</span><span class="ident" id="1715741">c</span><span class="op" id="1715742">)</span>&nbsp;<span class="op" id="1715744">+</span>&nbsp;<span class="op" id="1715746">(</span><span class="ident" id="1715747">hash</span><span class="op" id="1715751">&amp;</span><span class="op" id="1715752">(</span><span class="ident" id="1715753">m</span><span class="op" id="1715754">&gt;&gt;</span><span class="num" id="1715756">1</span><span class="op" id="1715757">)</span><span class="op" id="1715758">)</span><span class="op" id="1715759">*</span><span class="builtintype" id="1715760">uintptr</span><span class="op" id="1715767">(</span><span class="ident" id="1715768">t</span><span class="op" id="1715769">.</span><span class="ident" id="1715770">bucketsize</span><span class="op" id="1715780">)</span><span class="op" id="1715781">)</span><span class="op" id="1715782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715786">if</span>&nbsp;<span class="op" id="1715789">!</span><span class="ident" id="1715790">evacuated</span><span class="op" id="1715799">(</span><span class="ident" id="1715800">oldb</span><span class="op" id="1715804">)</span>&nbsp;<span class="op" id="1715806">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715811">b</span>&nbsp;<span class="op" id="1715813">=</span>&nbsp;<span class="ident" id="1715815">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715828">top</span>&nbsp;<span class="op" id="1715832">:=</span>&nbsp;<span class="builtintype" id="1715835">uint8</span><span class="op" id="1715840">(</span><span class="ident" id="1715841">hash</span>&nbsp;<span class="op" id="1715846">&gt;&gt;</span>&nbsp;<span class="op" id="1715849">(</span><span class="ident" id="1715850">ptrSize</span><span class="op" id="1715857">*</span><span class="num" id="1715858">8</span>&nbsp;<span class="op" id="1715860">-</span>&nbsp;<span class="num" id="1715862">8</span><span class="op" id="1715863">)</span><span class="op" id="1715864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715867">if</span>&nbsp;<span class="ident" id="1715870">top</span>&nbsp;<span class="op" id="1715874">&lt;</span>&nbsp;<span class="ident" id="1715876">minTopHash</span>&nbsp;<span class="op" id="1715887">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1715891">top</span>&nbsp;<span class="op" id="1715895">+=</span>&nbsp;<span class="ident" id="1715898">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1715910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715913">for</span>&nbsp;<span class="op" id="1715917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715921">for</span>&nbsp;<span class="ident" id="1715925">i</span>&nbsp;<span class="op" id="1715927">:=</span>&nbsp;<span class="builtintype" id="1715930">uintptr</span><span class="op" id="1715937">(</span><span class="num" id="1715938">0</span><span class="op" id="1715939">)</span><span class="op" id="1715940">;</span>&nbsp;<span class="ident" id="1715942">i</span>&nbsp;<span class="op" id="1715944">&lt;</span>&nbsp;<span class="ident" id="1715946">bucketCnt</span><span class="op" id="1715955">;</span>&nbsp;<span class="ident" id="1715957">i</span><span class="op" id="1715958">++</span>&nbsp;<span class="op" id="1715961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715966">if</span>&nbsp;<span class="ident" id="1715969">b</span><span class="op" id="1715970">.</span><span class="ident" id="1715971">tophash</span><span class="op" id="1715978">[</span><span class="ident" id="1715979">i</span><span class="op" id="1715980">]</span>&nbsp;<span class="op" id="1715982">!=</span>&nbsp;<span class="ident" id="1715985">top</span>&nbsp;<span class="op" id="1715989">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1715995">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716012">k</span>&nbsp;<span class="op" id="1716014">:=</span>&nbsp;<span class="ident" id="1716017">add</span><span class="op" id="1716020">(</span><span class="ident" id="1716021">unsafe</span><span class="op" id="1716027">.</span><span class="ident" id="1716028">Pointer</span><span class="op" id="1716035">(</span><span class="ident" id="1716036">b</span><span class="op" id="1716037">)</span><span class="op" id="1716038">,</span>&nbsp;<span class="ident" id="1716040">dataOffset</span><span class="op" id="1716050">+</span><span class="ident" id="1716051">i</span><span class="op" id="1716052">*</span><span class="builtintype" id="1716053">uintptr</span><span class="op" id="1716060">(</span><span class="ident" id="1716061">t</span><span class="op" id="1716062">.</span><span class="ident" id="1716063">keysize</span><span class="op" id="1716070">)</span><span class="op" id="1716071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716076">if</span>&nbsp;<span class="ident" id="1716079">t</span><span class="op" id="1716080">.</span><span class="ident" id="1716081">indirectkey</span>&nbsp;<span class="op" id="1716093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716099">k</span>&nbsp;<span class="op" id="1716101">=</span>&nbsp;<span class="op" id="1716103">*</span><span class="op" id="1716104">(</span><span class="op" id="1716105">(</span><span class="op" id="1716106">*</span><span class="ident" id="1716107">unsafe</span><span class="op" id="1716113">.</span><span class="ident" id="1716114">Pointer</span><span class="op" id="1716121">)</span><span class="op" id="1716122">(</span><span class="ident" id="1716123">k</span><span class="op" id="1716124">)</span><span class="op" id="1716125">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716135">if</span>&nbsp;<span class="ident" id="1716138">alg</span><span class="op" id="1716141">.</span><span class="ident" id="1716142">equal</span><span class="op" id="1716147">(</span><span class="ident" id="1716148">key</span><span class="op" id="1716151">,</span>&nbsp;<span class="ident" id="1716153">k</span><span class="op" id="1716154">,</span>&nbsp;<span class="builtintype" id="1716156">uintptr</span><span class="op" id="1716163">(</span><span class="ident" id="1716164">t</span><span class="op" id="1716165">.</span><span class="ident" id="1716166">key</span><span class="op" id="1716169">.</span><span class="ident" id="1716170">size</span><span class="op" id="1716174">)</span><span class="op" id="1716175">)</span>&nbsp;<span class="op" id="1716177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716183">v</span>&nbsp;<span class="op" id="1716185">:=</span>&nbsp;<span class="ident" id="1716188">add</span><span class="op" id="1716191">(</span><span class="ident" id="1716192">unsafe</span><span class="op" id="1716198">.</span><span class="ident" id="1716199">Pointer</span><span class="op" id="1716206">(</span><span class="ident" id="1716207">b</span><span class="op" id="1716208">)</span><span class="op" id="1716209">,</span>&nbsp;<span class="ident" id="1716211">dataOffset</span><span class="op" id="1716221">+</span><span class="ident" id="1716222">bucketCnt</span><span class="op" id="1716231">*</span><span class="builtintype" id="1716232">uintptr</span><span class="op" id="1716239">(</span><span class="ident" id="1716240">t</span><span class="op" id="1716241">.</span><span class="ident" id="1716242">keysize</span><span class="op" id="1716249">)</span><span class="op" id="1716250">+</span><span class="ident" id="1716251">i</span><span class="op" id="1716252">*</span><span class="builtintype" id="1716253">uintptr</span><span class="op" id="1716260">(</span><span class="ident" id="1716261">t</span><span class="op" id="1716262">.</span><span class="ident" id="1716263">valuesize</span><span class="op" id="1716272">)</span><span class="op" id="1716273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716279">if</span>&nbsp;<span class="ident" id="1716282">t</span><span class="op" id="1716283">.</span><span class="ident" id="1716284">indirectvalue</span>&nbsp;<span class="op" id="1716298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716305">v</span>&nbsp;<span class="op" id="1716307">=</span>&nbsp;<span class="op" id="1716309">*</span><span class="op" id="1716310">(</span><span class="op" id="1716311">(</span><span class="op" id="1716312">*</span><span class="ident" id="1716313">unsafe</span><span class="op" id="1716319">.</span><span class="ident" id="1716320">Pointer</span><span class="op" id="1716327">)</span><span class="op" id="1716328">(</span><span class="ident" id="1716329">v</span><span class="op" id="1716330">)</span><span class="op" id="1716331">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716343">return</span>&nbsp;<span class="ident" id="1716350">k</span><span class="op" id="1716351">,</span>&nbsp;<span class="ident" id="1716353">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716366">b</span>&nbsp;<span class="op" id="1716368">=</span>&nbsp;<span class="ident" id="1716370">b</span><span class="op" id="1716371">.</span><span class="ident" id="1716372">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716383">if</span>&nbsp;<span class="ident" id="1716386">b</span>&nbsp;<span class="op" id="1716388">==</span>&nbsp;<span class="ident" id="1716391">nil</span>&nbsp;<span class="op" id="1716395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716400">return</span>&nbsp;<span class="ident" id="1716407">nil</span><span class="op" id="1716410">,</span>&nbsp;<span class="ident" id="1716412">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716421">}</span><br>
<span class="lineno"></span><span class="op" id="1716423">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1716426">func</span>&nbsp;<span class="ident" id="1716431">mapassign1</span><span class="op" id="1716441">(</span><span class="ident" id="1716442">t</span>&nbsp;<span class="op" id="1716444">*</span><span class="ident" id="1716445">maptype</span><span class="op" id="1716452">,</span>&nbsp;<span class="ident" id="1716454">h</span>&nbsp;<span class="op" id="1716456">*</span><span class="ident" id="1716457">hmap</span><span class="op" id="1716461">,</span>&nbsp;<span class="ident" id="1716463">key</span>&nbsp;<span class="ident" id="1716467">unsafe</span><span class="op" id="1716473">.</span><span class="ident" id="1716474">Pointer</span><span class="op" id="1716481">,</span>&nbsp;<span class="ident" id="1716483">val</span>&nbsp;<span class="ident" id="1716487">unsafe</span><span class="op" id="1716493">.</span><span class="ident" id="1716494">Pointer</span><span class="op" id="1716501">)</span>&nbsp;<span class="op" id="1716503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716506">if</span>&nbsp;<span class="ident" id="1716509">h</span>&nbsp;<span class="op" id="1716511">==</span>&nbsp;<span class="ident" id="1716514">nil</span>&nbsp;<span class="op" id="1716518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1716522">panic</span><span class="op" id="1716527">(</span><span class="string" id="1716528">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1716560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716563">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716566">if</span>&nbsp;<span class="ident" id="1716569">raceenabled</span>&nbsp;<span class="op" id="1716581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716585">callerpc</span>&nbsp;<span class="op" id="1716594">:=</span>&nbsp;<span class="ident" id="1716597">getcallerpc</span><span class="op" id="1716608">(</span><span class="ident" id="1716609">unsafe</span><span class="op" id="1716615">.</span><span class="ident" id="1716616">Pointer</span><span class="op" id="1716623">(</span><span class="op" id="1716624">&amp;</span><span class="ident" id="1716625">t</span><span class="op" id="1716626">)</span><span class="op" id="1716627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716631">pc</span>&nbsp;<span class="op" id="1716634">:=</span>&nbsp;<span class="ident" id="1716637">funcPC</span><span class="op" id="1716643">(</span><span class="ident" id="1716644">mapassign1</span><span class="op" id="1716654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716658">racewritepc</span><span class="op" id="1716669">(</span><span class="ident" id="1716670">unsafe</span><span class="op" id="1716676">.</span><span class="ident" id="1716677">Pointer</span><span class="op" id="1716684">(</span><span class="ident" id="1716685">h</span><span class="op" id="1716686">)</span><span class="op" id="1716687">,</span>&nbsp;<span class="ident" id="1716689">callerpc</span><span class="op" id="1716697">,</span>&nbsp;<span class="ident" id="1716699">pc</span><span class="op" id="1716701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716705">raceReadObjectPC</span><span class="op" id="1716721">(</span><span class="ident" id="1716722">t</span><span class="op" id="1716723">.</span><span class="ident" id="1716724">key</span><span class="op" id="1716727">,</span>&nbsp;<span class="ident" id="1716729">key</span><span class="op" id="1716732">,</span>&nbsp;<span class="ident" id="1716734">callerpc</span><span class="op" id="1716742">,</span>&nbsp;<span class="ident" id="1716744">pc</span><span class="op" id="1716746">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716750">raceReadObjectPC</span><span class="op" id="1716766">(</span><span class="ident" id="1716767">t</span><span class="op" id="1716768">.</span><span class="ident" id="1716769">elem</span><span class="op" id="1716773">,</span>&nbsp;<span class="ident" id="1716775">val</span><span class="op" id="1716778">,</span>&nbsp;<span class="ident" id="1716780">callerpc</span><span class="op" id="1716788">,</span>&nbsp;<span class="ident" id="1716790">pc</span><span class="op" id="1716792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716799">alg</span>&nbsp;<span class="op" id="1716803">:=</span>&nbsp;<span class="ident" id="1716806">goalg</span><span class="op" id="1716811">(</span><span class="ident" id="1716812">t</span><span class="op" id="1716813">.</span><span class="ident" id="1716814">key</span><span class="op" id="1716817">.</span><span class="ident" id="1716818">alg</span><span class="op" id="1716821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716824">hash</span>&nbsp;<span class="op" id="1716829">:=</span>&nbsp;<span class="ident" id="1716832">alg</span><span class="op" id="1716835">.</span><span class="ident" id="1716836">hash</span><span class="op" id="1716840">(</span><span class="ident" id="1716841">key</span><span class="op" id="1716844">,</span>&nbsp;<span class="builtintype" id="1716846">uintptr</span><span class="op" id="1716853">(</span><span class="ident" id="1716854">t</span><span class="op" id="1716855">.</span><span class="ident" id="1716856">key</span><span class="op" id="1716859">.</span><span class="ident" id="1716860">size</span><span class="op" id="1716864">)</span><span class="op" id="1716865">,</span>&nbsp;<span class="builtintype" id="1716867">uintptr</span><span class="op" id="1716874">(</span><span class="ident" id="1716875">h</span><span class="op" id="1716876">.</span><span class="ident" id="1716877">hash0</span><span class="op" id="1716882">)</span><span class="op" id="1716883">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716887">if</span>&nbsp;<span class="ident" id="1716890">h</span><span class="op" id="1716891">.</span><span class="ident" id="1716892">buckets</span>&nbsp;<span class="op" id="1716900">==</span>&nbsp;<span class="ident" id="1716903">nil</span>&nbsp;<span class="op" id="1716907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1716911">if</span>&nbsp;<span class="ident" id="1716914">checkgc</span>&nbsp;<span class="op" id="1716922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716927">memstats</span><span class="op" id="1716935">.</span><span class="ident" id="1716936">next_gc</span>&nbsp;<span class="op" id="1716944">=</span>&nbsp;<span class="ident" id="1716946">memstats</span><span class="op" id="1716954">.</span><span class="ident" id="1716955">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1716968">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1716972">h</span><span class="op" id="1716973">.</span><span class="ident" id="1716974">buckets</span>&nbsp;<span class="op" id="1716982">=</span>&nbsp;<span class="ident" id="1716984">newarray</span><span class="op" id="1716992">(</span><span class="ident" id="1716993">t</span><span class="op" id="1716994">.</span><span class="ident" id="1716995">bucket</span><span class="op" id="1717001">,</span>&nbsp;<span class="num" id="1717003">1</span><span class="op" id="1717004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1717010">again</span><span class="op" id="1717015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717018">bucket</span>&nbsp;<span class="op" id="1717025">:=</span>&nbsp;<span class="ident" id="1717028">hash</span>&nbsp;<span class="op" id="1717033">&amp;</span>&nbsp;<span class="op" id="1717035">(</span><span class="builtintype" id="1717036">uintptr</span><span class="op" id="1717043">(</span><span class="num" id="1717044">1</span><span class="op" id="1717045">)</span><span class="op" id="1717046">&lt;&lt;</span><span class="ident" id="1717048">h</span><span class="op" id="1717049">.</span><span class="ident" id="1717050">B</span>&nbsp;<span class="op" id="1717052">-</span>&nbsp;<span class="num" id="1717054">1</span><span class="op" id="1717055">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717058">if</span>&nbsp;<span class="ident" id="1717061">h</span><span class="op" id="1717062">.</span><span class="ident" id="1717063">oldbuckets</span>&nbsp;<span class="op" id="1717074">!=</span>&nbsp;<span class="ident" id="1717077">nil</span>&nbsp;<span class="op" id="1717081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717085">growWork</span><span class="op" id="1717093">(</span><span class="ident" id="1717094">t</span><span class="op" id="1717095">,</span>&nbsp;<span class="ident" id="1717097">h</span><span class="op" id="1717098">,</span>&nbsp;<span class="ident" id="1717100">bucket</span><span class="op" id="1717106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717112">b</span>&nbsp;<span class="op" id="1717114">:=</span>&nbsp;<span class="op" id="1717117">(</span><span class="op" id="1717118">*</span><span class="ident" id="1717119">bmap</span><span class="op" id="1717123">)</span><span class="op" id="1717124">(</span><span class="ident" id="1717125">unsafe</span><span class="op" id="1717131">.</span><span class="ident" id="1717132">Pointer</span><span class="op" id="1717139">(</span><span class="builtintype" id="1717140">uintptr</span><span class="op" id="1717147">(</span><span class="ident" id="1717148">h</span><span class="op" id="1717149">.</span><span class="ident" id="1717150">buckets</span><span class="op" id="1717157">)</span>&nbsp;<span class="op" id="1717159">+</span>&nbsp;<span class="ident" id="1717161">bucket</span><span class="op" id="1717167">*</span><span class="builtintype" id="1717168">uintptr</span><span class="op" id="1717175">(</span><span class="ident" id="1717176">t</span><span class="op" id="1717177">.</span><span class="ident" id="1717178">bucketsize</span><span class="op" id="1717188">)</span><span class="op" id="1717189">)</span><span class="op" id="1717190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717193">top</span>&nbsp;<span class="op" id="1717197">:=</span>&nbsp;<span class="builtintype" id="1717200">uint8</span><span class="op" id="1717205">(</span><span class="ident" id="1717206">hash</span>&nbsp;<span class="op" id="1717211">&gt;&gt;</span>&nbsp;<span class="op" id="1717214">(</span><span class="ident" id="1717215">ptrSize</span><span class="op" id="1717222">*</span><span class="num" id="1717223">8</span>&nbsp;<span class="op" id="1717225">-</span>&nbsp;<span class="num" id="1717227">8</span><span class="op" id="1717228">)</span><span class="op" id="1717229">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717232">if</span>&nbsp;<span class="ident" id="1717235">top</span>&nbsp;<span class="op" id="1717239">&lt;</span>&nbsp;<span class="ident" id="1717241">minTopHash</span>&nbsp;<span class="op" id="1717252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717256">top</span>&nbsp;<span class="op" id="1717260">+=</span>&nbsp;<span class="ident" id="1717263">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717279">var</span>&nbsp;<span class="ident" id="1717283">inserti</span>&nbsp;<span class="op" id="1717291">*</span><span class="builtintype" id="1717292">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717299">var</span>&nbsp;<span class="ident" id="1717303">insertk</span>&nbsp;<span class="ident" id="1717311">unsafe</span><span class="op" id="1717317">.</span><span class="ident" id="1717318">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717327">var</span>&nbsp;<span class="ident" id="1717331">insertv</span>&nbsp;<span class="ident" id="1717339">unsafe</span><span class="op" id="1717345">.</span><span class="ident" id="1717346">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717355">for</span>&nbsp;<span class="op" id="1717359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717363">for</span>&nbsp;<span class="ident" id="1717367">i</span>&nbsp;<span class="op" id="1717369">:=</span>&nbsp;<span class="builtintype" id="1717372">uintptr</span><span class="op" id="1717379">(</span><span class="num" id="1717380">0</span><span class="op" id="1717381">)</span><span class="op" id="1717382">;</span>&nbsp;<span class="ident" id="1717384">i</span>&nbsp;<span class="op" id="1717386">&lt;</span>&nbsp;<span class="ident" id="1717388">bucketCnt</span><span class="op" id="1717397">;</span>&nbsp;<span class="ident" id="1717399">i</span><span class="op" id="1717400">++</span>&nbsp;<span class="op" id="1717403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717408">if</span>&nbsp;<span class="ident" id="1717411">b</span><span class="op" id="1717412">.</span><span class="ident" id="1717413">tophash</span><span class="op" id="1717420">[</span><span class="ident" id="1717421">i</span><span class="op" id="1717422">]</span>&nbsp;<span class="op" id="1717424">!=</span>&nbsp;<span class="ident" id="1717427">top</span>&nbsp;<span class="op" id="1717431">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717437">if</span>&nbsp;<span class="ident" id="1717440">b</span><span class="op" id="1717441">.</span><span class="ident" id="1717442">tophash</span><span class="op" id="1717449">[</span><span class="ident" id="1717450">i</span><span class="op" id="1717451">]</span>&nbsp;<span class="op" id="1717453">==</span>&nbsp;<span class="ident" id="1717456">empty</span>&nbsp;<span class="op" id="1717462">&amp;&amp;</span>&nbsp;<span class="ident" id="1717465">inserti</span>&nbsp;<span class="op" id="1717473">==</span>&nbsp;<span class="ident" id="1717476">nil</span>&nbsp;<span class="op" id="1717480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717487">inserti</span>&nbsp;<span class="op" id="1717495">=</span>&nbsp;<span class="op" id="1717497">&amp;</span><span class="ident" id="1717498">b</span><span class="op" id="1717499">.</span><span class="ident" id="1717500">tophash</span><span class="op" id="1717507">[</span><span class="ident" id="1717508">i</span><span class="op" id="1717509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717516">insertk</span>&nbsp;<span class="op" id="1717524">=</span>&nbsp;<span class="ident" id="1717526">add</span><span class="op" id="1717529">(</span><span class="ident" id="1717530">unsafe</span><span class="op" id="1717536">.</span><span class="ident" id="1717537">Pointer</span><span class="op" id="1717544">(</span><span class="ident" id="1717545">b</span><span class="op" id="1717546">)</span><span class="op" id="1717547">,</span>&nbsp;<span class="ident" id="1717549">dataOffset</span><span class="op" id="1717559">+</span><span class="ident" id="1717560">i</span><span class="op" id="1717561">*</span><span class="builtintype" id="1717562">uintptr</span><span class="op" id="1717569">(</span><span class="ident" id="1717570">t</span><span class="op" id="1717571">.</span><span class="ident" id="1717572">keysize</span><span class="op" id="1717579">)</span><span class="op" id="1717580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717587">insertv</span>&nbsp;<span class="op" id="1717595">=</span>&nbsp;<span class="ident" id="1717597">add</span><span class="op" id="1717600">(</span><span class="ident" id="1717601">unsafe</span><span class="op" id="1717607">.</span><span class="ident" id="1717608">Pointer</span><span class="op" id="1717615">(</span><span class="ident" id="1717616">b</span><span class="op" id="1717617">)</span><span class="op" id="1717618">,</span>&nbsp;<span class="ident" id="1717620">dataOffset</span><span class="op" id="1717630">+</span><span class="ident" id="1717631">bucketCnt</span><span class="op" id="1717640">*</span><span class="builtintype" id="1717641">uintptr</span><span class="op" id="1717648">(</span><span class="ident" id="1717649">t</span><span class="op" id="1717650">.</span><span class="ident" id="1717651">keysize</span><span class="op" id="1717658">)</span><span class="op" id="1717659">+</span><span class="ident" id="1717660">i</span><span class="op" id="1717661">*</span><span class="builtintype" id="1717662">uintptr</span><span class="op" id="1717669">(</span><span class="ident" id="1717670">t</span><span class="op" id="1717671">.</span><span class="ident" id="1717672">valuesize</span><span class="op" id="1717681">)</span><span class="op" id="1717682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717688">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717694">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717711">k</span>&nbsp;<span class="op" id="1717713">:=</span>&nbsp;<span class="ident" id="1717716">add</span><span class="op" id="1717719">(</span><span class="ident" id="1717720">unsafe</span><span class="op" id="1717726">.</span><span class="ident" id="1717727">Pointer</span><span class="op" id="1717734">(</span><span class="ident" id="1717735">b</span><span class="op" id="1717736">)</span><span class="op" id="1717737">,</span>&nbsp;<span class="ident" id="1717739">dataOffset</span><span class="op" id="1717749">+</span><span class="ident" id="1717750">i</span><span class="op" id="1717751">*</span><span class="builtintype" id="1717752">uintptr</span><span class="op" id="1717759">(</span><span class="ident" id="1717760">t</span><span class="op" id="1717761">.</span><span class="ident" id="1717762">keysize</span><span class="op" id="1717769">)</span><span class="op" id="1717770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717775">k2</span>&nbsp;<span class="op" id="1717778">:=</span>&nbsp;<span class="ident" id="1717781">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717786">if</span>&nbsp;<span class="ident" id="1717789">t</span><span class="op" id="1717790">.</span><span class="ident" id="1717791">indirectkey</span>&nbsp;<span class="op" id="1717803">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717809">k2</span>&nbsp;<span class="op" id="1717812">=</span>&nbsp;<span class="op" id="1717814">*</span><span class="op" id="1717815">(</span><span class="op" id="1717816">(</span><span class="op" id="1717817">*</span><span class="ident" id="1717818">unsafe</span><span class="op" id="1717824">.</span><span class="ident" id="1717825">Pointer</span><span class="op" id="1717832">)</span><span class="op" id="1717833">(</span><span class="ident" id="1717834">k2</span><span class="op" id="1717836">)</span><span class="op" id="1717837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717847">if</span>&nbsp;<span class="op" id="1717850">!</span><span class="ident" id="1717851">alg</span><span class="op" id="1717854">.</span><span class="ident" id="1717855">equal</span><span class="op" id="1717860">(</span><span class="ident" id="1717861">key</span><span class="op" id="1717864">,</span>&nbsp;<span class="ident" id="1717866">k2</span><span class="op" id="1717868">,</span>&nbsp;<span class="builtintype" id="1717870">uintptr</span><span class="op" id="1717877">(</span><span class="ident" id="1717878">t</span><span class="op" id="1717879">.</span><span class="ident" id="1717880">key</span><span class="op" id="1717883">.</span><span class="ident" id="1717884">size</span><span class="op" id="1717888">)</span><span class="op" id="1717889">)</span>&nbsp;<span class="op" id="1717891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1717897">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1717909">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1717914">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1717964">memmove</span><span class="op" id="1717971">(</span><span class="ident" id="1717972">k2</span><span class="op" id="1717974">,</span>&nbsp;<span class="ident" id="1717976">key</span><span class="op" id="1717979">,</span>&nbsp;<span class="builtintype" id="1717981">uintptr</span><span class="op" id="1717988">(</span><span class="ident" id="1717989">t</span><span class="op" id="1717990">.</span><span class="ident" id="1717991">key</span><span class="op" id="1717994">.</span><span class="ident" id="1717995">size</span><span class="op" id="1717999">)</span><span class="op" id="1718000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718005">v</span>&nbsp;<span class="op" id="1718007">:=</span>&nbsp;<span class="ident" id="1718010">add</span><span class="op" id="1718013">(</span><span class="ident" id="1718014">unsafe</span><span class="op" id="1718020">.</span><span class="ident" id="1718021">Pointer</span><span class="op" id="1718028">(</span><span class="ident" id="1718029">b</span><span class="op" id="1718030">)</span><span class="op" id="1718031">,</span>&nbsp;<span class="ident" id="1718033">dataOffset</span><span class="op" id="1718043">+</span><span class="ident" id="1718044">bucketCnt</span><span class="op" id="1718053">*</span><span class="builtintype" id="1718054">uintptr</span><span class="op" id="1718061">(</span><span class="ident" id="1718062">t</span><span class="op" id="1718063">.</span><span class="ident" id="1718064">keysize</span><span class="op" id="1718071">)</span><span class="op" id="1718072">+</span><span class="ident" id="1718073">i</span><span class="op" id="1718074">*</span><span class="builtintype" id="1718075">uintptr</span><span class="op" id="1718082">(</span><span class="ident" id="1718083">t</span><span class="op" id="1718084">.</span><span class="ident" id="1718085">valuesize</span><span class="op" id="1718094">)</span><span class="op" id="1718095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718100">v2</span>&nbsp;<span class="op" id="1718103">:=</span>&nbsp;<span class="ident" id="1718106">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718111">if</span>&nbsp;<span class="ident" id="1718114">t</span><span class="op" id="1718115">.</span><span class="ident" id="1718116">indirectvalue</span>&nbsp;<span class="op" id="1718130">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718136">v2</span>&nbsp;<span class="op" id="1718139">=</span>&nbsp;<span class="op" id="1718141">*</span><span class="op" id="1718142">(</span><span class="op" id="1718143">(</span><span class="op" id="1718144">*</span><span class="ident" id="1718145">unsafe</span><span class="op" id="1718151">.</span><span class="ident" id="1718152">Pointer</span><span class="op" id="1718159">)</span><span class="op" id="1718160">(</span><span class="ident" id="1718161">v2</span><span class="op" id="1718163">)</span><span class="op" id="1718164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718174">memmove</span><span class="op" id="1718181">(</span><span class="ident" id="1718182">v2</span><span class="op" id="1718184">,</span>&nbsp;<span class="ident" id="1718186">val</span><span class="op" id="1718189">,</span>&nbsp;<span class="builtintype" id="1718191">uintptr</span><span class="op" id="1718198">(</span><span class="ident" id="1718199">t</span><span class="op" id="1718200">.</span><span class="ident" id="1718201">elem</span><span class="op" id="1718205">.</span><span class="ident" id="1718206">size</span><span class="op" id="1718210">)</span><span class="op" id="1718211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718216">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718225">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718229">if</span>&nbsp;<span class="ident" id="1718232">b</span><span class="op" id="1718233">.</span><span class="ident" id="1718234">overflow</span>&nbsp;<span class="op" id="1718243">==</span>&nbsp;<span class="ident" id="1718246">nil</span>&nbsp;<span class="op" id="1718250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718255">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718267">b</span>&nbsp;<span class="op" id="1718269">=</span>&nbsp;<span class="ident" id="1718271">b</span><span class="op" id="1718272">.</span><span class="ident" id="1718273">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718283">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1718287">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718353">if</span>&nbsp;<span class="builtintype" id="1718356">float32</span><span class="op" id="1718363">(</span><span class="ident" id="1718364">h</span><span class="op" id="1718365">.</span><span class="ident" id="1718366">count</span><span class="op" id="1718371">)</span>&nbsp;<span class="op" id="1718373">&gt;=</span>&nbsp;<span class="ident" id="1718376">loadFactor</span><span class="op" id="1718386">*</span><span class="builtintype" id="1718387">float32</span><span class="op" id="1718394">(</span><span class="op" id="1718395">(</span><span class="builtintype" id="1718396">uintptr</span><span class="op" id="1718403">(</span><span class="num" id="1718404">1</span><span class="op" id="1718405">)</span><span class="op" id="1718406">&lt;&lt;</span><span class="ident" id="1718408">h</span><span class="op" id="1718409">.</span><span class="ident" id="1718410">B</span><span class="op" id="1718411">)</span><span class="op" id="1718412">)</span>&nbsp;<span class="op" id="1718414">&amp;&amp;</span>&nbsp;<span class="ident" id="1718417">h</span><span class="op" id="1718418">.</span><span class="ident" id="1718419">count</span>&nbsp;<span class="op" id="1718425">&gt;=</span>&nbsp;<span class="ident" id="1718428">bucketCnt</span>&nbsp;<span class="op" id="1718438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718442">hashGrow</span><span class="op" id="1718450">(</span><span class="ident" id="1718451">t</span><span class="op" id="1718452">,</span>&nbsp;<span class="ident" id="1718454">h</span><span class="op" id="1718455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718459">goto</span>&nbsp;<span class="ident" id="1718464">again</span>&nbsp;<span class="comment" id="1718470">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718533">if</span>&nbsp;<span class="ident" id="1718536">inserti</span>&nbsp;<span class="op" id="1718544">==</span>&nbsp;<span class="ident" id="1718547">nil</span>&nbsp;<span class="op" id="1718551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1718555">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718610">if</span>&nbsp;<span class="ident" id="1718613">checkgc</span>&nbsp;<span class="op" id="1718621">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718626">memstats</span><span class="op" id="1718634">.</span><span class="ident" id="1718635">next_gc</span>&nbsp;<span class="op" id="1718643">=</span>&nbsp;<span class="ident" id="1718645">memstats</span><span class="op" id="1718653">.</span><span class="ident" id="1718654">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718671">newb</span>&nbsp;<span class="op" id="1718676">:=</span>&nbsp;<span class="op" id="1718679">(</span><span class="op" id="1718680">*</span><span class="ident" id="1718681">bmap</span><span class="op" id="1718685">)</span><span class="op" id="1718686">(</span><span class="ident" id="1718687">newobject</span><span class="op" id="1718696">(</span><span class="ident" id="1718697">t</span><span class="op" id="1718698">.</span><span class="ident" id="1718699">bucket</span><span class="op" id="1718705">)</span><span class="op" id="1718706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718710">b</span><span class="op" id="1718711">.</span><span class="ident" id="1718712">overflow</span>&nbsp;<span class="op" id="1718721">=</span>&nbsp;<span class="ident" id="1718723">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718730">inserti</span>&nbsp;<span class="op" id="1718738">=</span>&nbsp;<span class="op" id="1718740">&amp;</span><span class="ident" id="1718741">newb</span><span class="op" id="1718745">.</span><span class="ident" id="1718746">tophash</span><span class="op" id="1718753">[</span><span class="num" id="1718754">0</span><span class="op" id="1718755">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718759">insertk</span>&nbsp;<span class="op" id="1718767">=</span>&nbsp;<span class="ident" id="1718769">add</span><span class="op" id="1718772">(</span><span class="ident" id="1718773">unsafe</span><span class="op" id="1718779">.</span><span class="ident" id="1718780">Pointer</span><span class="op" id="1718787">(</span><span class="ident" id="1718788">newb</span><span class="op" id="1718792">)</span><span class="op" id="1718793">,</span>&nbsp;<span class="ident" id="1718795">dataOffset</span><span class="op" id="1718805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718809">insertv</span>&nbsp;<span class="op" id="1718817">=</span>&nbsp;<span class="ident" id="1718819">add</span><span class="op" id="1718822">(</span><span class="ident" id="1718823">insertk</span><span class="op" id="1718830">,</span>&nbsp;<span class="ident" id="1718832">bucketCnt</span><span class="op" id="1718841">*</span><span class="builtintype" id="1718842">uintptr</span><span class="op" id="1718849">(</span><span class="ident" id="1718850">t</span><span class="op" id="1718851">.</span><span class="ident" id="1718852">keysize</span><span class="op" id="1718859">)</span><span class="op" id="1718860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1718867">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718910">if</span>&nbsp;<span class="ident" id="1718913">t</span><span class="op" id="1718914">.</span><span class="ident" id="1718915">indirectkey</span>&nbsp;<span class="op" id="1718927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1718931">if</span>&nbsp;<span class="ident" id="1718934">checkgc</span>&nbsp;<span class="op" id="1718942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718947">memstats</span><span class="op" id="1718955">.</span><span class="ident" id="1718956">next_gc</span>&nbsp;<span class="op" id="1718964">=</span>&nbsp;<span class="ident" id="1718966">memstats</span><span class="op" id="1718974">.</span><span class="ident" id="1718975">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1718988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1718992">kmem</span>&nbsp;<span class="op" id="1718997">:=</span>&nbsp;<span class="ident" id="1719000">newobject</span><span class="op" id="1719009">(</span><span class="ident" id="1719010">t</span><span class="op" id="1719011">.</span><span class="ident" id="1719012">key</span><span class="op" id="1719015">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719019">*</span><span class="op" id="1719020">(</span><span class="op" id="1719021">*</span><span class="ident" id="1719022">unsafe</span><span class="op" id="1719028">.</span><span class="ident" id="1719029">Pointer</span><span class="op" id="1719036">)</span><span class="op" id="1719037">(</span><span class="ident" id="1719038">insertk</span><span class="op" id="1719045">)</span>&nbsp;<span class="op" id="1719047">=</span>&nbsp;<span class="ident" id="1719049">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719056">insertk</span>&nbsp;<span class="op" id="1719064">=</span>&nbsp;<span class="ident" id="1719066">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719075">if</span>&nbsp;<span class="ident" id="1719078">t</span><span class="op" id="1719079">.</span><span class="ident" id="1719080">indirectvalue</span>&nbsp;<span class="op" id="1719094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719098">if</span>&nbsp;<span class="ident" id="1719101">checkgc</span>&nbsp;<span class="op" id="1719109">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719114">memstats</span><span class="op" id="1719122">.</span><span class="ident" id="1719123">next_gc</span>&nbsp;<span class="op" id="1719131">=</span>&nbsp;<span class="ident" id="1719133">memstats</span><span class="op" id="1719141">.</span><span class="ident" id="1719142">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719159">vmem</span>&nbsp;<span class="op" id="1719164">:=</span>&nbsp;<span class="ident" id="1719167">newobject</span><span class="op" id="1719176">(</span><span class="ident" id="1719177">t</span><span class="op" id="1719178">.</span><span class="ident" id="1719179">elem</span><span class="op" id="1719183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719187">*</span><span class="op" id="1719188">(</span><span class="op" id="1719189">*</span><span class="ident" id="1719190">unsafe</span><span class="op" id="1719196">.</span><span class="ident" id="1719197">Pointer</span><span class="op" id="1719204">)</span><span class="op" id="1719205">(</span><span class="ident" id="1719206">insertv</span><span class="op" id="1719213">)</span>&nbsp;<span class="op" id="1719215">=</span>&nbsp;<span class="ident" id="1719217">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719224">insertv</span>&nbsp;<span class="op" id="1719232">=</span>&nbsp;<span class="ident" id="1719234">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719243">memmove</span><span class="op" id="1719250">(</span><span class="ident" id="1719251">insertk</span><span class="op" id="1719258">,</span>&nbsp;<span class="ident" id="1719260">key</span><span class="op" id="1719263">,</span>&nbsp;<span class="builtintype" id="1719265">uintptr</span><span class="op" id="1719272">(</span><span class="ident" id="1719273">t</span><span class="op" id="1719274">.</span><span class="ident" id="1719275">key</span><span class="op" id="1719278">.</span><span class="ident" id="1719279">size</span><span class="op" id="1719283">)</span><span class="op" id="1719284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719287">memmove</span><span class="op" id="1719294">(</span><span class="ident" id="1719295">insertv</span><span class="op" id="1719302">,</span>&nbsp;<span class="ident" id="1719304">val</span><span class="op" id="1719307">,</span>&nbsp;<span class="builtintype" id="1719309">uintptr</span><span class="op" id="1719316">(</span><span class="ident" id="1719317">t</span><span class="op" id="1719318">.</span><span class="ident" id="1719319">elem</span><span class="op" id="1719323">.</span><span class="ident" id="1719324">size</span><span class="op" id="1719328">)</span><span class="op" id="1719329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719332">*</span><span class="ident" id="1719333">inserti</span>&nbsp;<span class="op" id="1719341">=</span>&nbsp;<span class="ident" id="1719343">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719348">h</span><span class="op" id="1719349">.</span><span class="ident" id="1719350">count</span><span class="op" id="1719355">++</span><br>
<span class="lineno">485</span><span class="op" id="1719358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1719361">func</span>&nbsp;<span class="ident" id="1719366">mapdelete</span><span class="op" id="1719375">(</span><span class="ident" id="1719376">t</span>&nbsp;<span class="op" id="1719378">*</span><span class="ident" id="1719379">maptype</span><span class="op" id="1719386">,</span>&nbsp;<span class="ident" id="1719388">h</span>&nbsp;<span class="op" id="1719390">*</span><span class="ident" id="1719391">hmap</span><span class="op" id="1719395">,</span>&nbsp;<span class="ident" id="1719397">key</span>&nbsp;<span class="ident" id="1719401">unsafe</span><span class="op" id="1719407">.</span><span class="ident" id="1719408">Pointer</span><span class="op" id="1719415">)</span>&nbsp;<span class="op" id="1719417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719420">if</span>&nbsp;<span class="ident" id="1719423">raceenabled</span>&nbsp;<span class="op" id="1719435">&amp;&amp;</span>&nbsp;<span class="ident" id="1719438">h</span>&nbsp;<span class="op" id="1719440">!=</span>&nbsp;<span class="ident" id="1719443">nil</span>&nbsp;<span class="op" id="1719447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719451">callerpc</span>&nbsp;<span class="op" id="1719460">:=</span>&nbsp;<span class="ident" id="1719463">getcallerpc</span><span class="op" id="1719474">(</span><span class="ident" id="1719475">unsafe</span><span class="op" id="1719481">.</span><span class="ident" id="1719482">Pointer</span><span class="op" id="1719489">(</span><span class="op" id="1719490">&amp;</span><span class="ident" id="1719491">t</span><span class="op" id="1719492">)</span><span class="op" id="1719493">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719497">pc</span>&nbsp;<span class="op" id="1719500">:=</span>&nbsp;<span class="ident" id="1719503">funcPC</span><span class="op" id="1719509">(</span><span class="ident" id="1719510">mapdelete</span><span class="op" id="1719519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719523">racewritepc</span><span class="op" id="1719534">(</span><span class="ident" id="1719535">unsafe</span><span class="op" id="1719541">.</span><span class="ident" id="1719542">Pointer</span><span class="op" id="1719549">(</span><span class="ident" id="1719550">h</span><span class="op" id="1719551">)</span><span class="op" id="1719552">,</span>&nbsp;<span class="ident" id="1719554">callerpc</span><span class="op" id="1719562">,</span>&nbsp;<span class="ident" id="1719564">pc</span><span class="op" id="1719566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719570">raceReadObjectPC</span><span class="op" id="1719586">(</span><span class="ident" id="1719587">t</span><span class="op" id="1719588">.</span><span class="ident" id="1719589">key</span><span class="op" id="1719592">,</span>&nbsp;<span class="ident" id="1719594">key</span><span class="op" id="1719597">,</span>&nbsp;<span class="ident" id="1719599">callerpc</span><span class="op" id="1719607">,</span>&nbsp;<span class="ident" id="1719609">pc</span><span class="op" id="1719611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719617">if</span>&nbsp;<span class="ident" id="1719620">h</span>&nbsp;<span class="op" id="1719622">==</span>&nbsp;<span class="ident" id="1719625">nil</span>&nbsp;<span class="op" id="1719629">||</span>&nbsp;<span class="ident" id="1719632">h</span><span class="op" id="1719633">.</span><span class="ident" id="1719634">count</span>&nbsp;<span class="op" id="1719640">==</span>&nbsp;<span class="num" id="1719643">0</span>&nbsp;<span class="op" id="1719645">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719649">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719660">alg</span>&nbsp;<span class="op" id="1719664">:=</span>&nbsp;<span class="ident" id="1719667">goalg</span><span class="op" id="1719672">(</span><span class="ident" id="1719673">t</span><span class="op" id="1719674">.</span><span class="ident" id="1719675">key</span><span class="op" id="1719678">.</span><span class="ident" id="1719679">alg</span><span class="op" id="1719682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719685">hash</span>&nbsp;<span class="op" id="1719690">:=</span>&nbsp;<span class="ident" id="1719693">alg</span><span class="op" id="1719696">.</span><span class="ident" id="1719697">hash</span><span class="op" id="1719701">(</span><span class="ident" id="1719702">key</span><span class="op" id="1719705">,</span>&nbsp;<span class="builtintype" id="1719707">uintptr</span><span class="op" id="1719714">(</span><span class="ident" id="1719715">t</span><span class="op" id="1719716">.</span><span class="ident" id="1719717">key</span><span class="op" id="1719720">.</span><span class="ident" id="1719721">size</span><span class="op" id="1719725">)</span><span class="op" id="1719726">,</span>&nbsp;<span class="builtintype" id="1719728">uintptr</span><span class="op" id="1719735">(</span><span class="ident" id="1719736">h</span><span class="op" id="1719737">.</span><span class="ident" id="1719738">hash0</span><span class="op" id="1719743">)</span><span class="op" id="1719744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719747">bucket</span>&nbsp;<span class="op" id="1719754">:=</span>&nbsp;<span class="ident" id="1719757">hash</span>&nbsp;<span class="op" id="1719762">&amp;</span>&nbsp;<span class="op" id="1719764">(</span><span class="builtintype" id="1719765">uintptr</span><span class="op" id="1719772">(</span><span class="num" id="1719773">1</span><span class="op" id="1719774">)</span><span class="op" id="1719775">&lt;&lt;</span><span class="ident" id="1719777">h</span><span class="op" id="1719778">.</span><span class="ident" id="1719779">B</span>&nbsp;<span class="op" id="1719781">-</span>&nbsp;<span class="num" id="1719783">1</span><span class="op" id="1719784">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719787">if</span>&nbsp;<span class="ident" id="1719790">h</span><span class="op" id="1719791">.</span><span class="ident" id="1719792">oldbuckets</span>&nbsp;<span class="op" id="1719803">!=</span>&nbsp;<span class="ident" id="1719806">nil</span>&nbsp;<span class="op" id="1719810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719814">growWork</span><span class="op" id="1719822">(</span><span class="ident" id="1719823">t</span><span class="op" id="1719824">,</span>&nbsp;<span class="ident" id="1719826">h</span><span class="op" id="1719827">,</span>&nbsp;<span class="ident" id="1719829">bucket</span><span class="op" id="1719835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1719838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719841">b</span>&nbsp;<span class="op" id="1719843">:=</span>&nbsp;<span class="op" id="1719846">(</span><span class="op" id="1719847">*</span><span class="ident" id="1719848">bmap</span><span class="op" id="1719852">)</span><span class="op" id="1719853">(</span><span class="ident" id="1719854">unsafe</span><span class="op" id="1719860">.</span><span class="ident" id="1719861">Pointer</span><span class="op" id="1719868">(</span><span class="builtintype" id="1719869">uintptr</span><span class="op" id="1719876">(</span><span class="ident" id="1719877">h</span><span class="op" id="1719878">.</span><span class="ident" id="1719879">buckets</span><span class="op" id="1719886">)</span>&nbsp;<span class="op" id="1719888">+</span>&nbsp;<span class="ident" id="1719890">bucket</span><span class="op" id="1719896">*</span><span class="builtintype" id="1719897">uintptr</span><span class="op" id="1719904">(</span><span class="ident" id="1719905">t</span><span class="op" id="1719906">.</span><span class="ident" id="1719907">bucketsize</span><span class="op" id="1719917">)</span><span class="op" id="1719918">)</span><span class="op" id="1719919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719922">top</span>&nbsp;<span class="op" id="1719926">:=</span>&nbsp;<span class="builtintype" id="1719929">uint8</span><span class="op" id="1719934">(</span><span class="ident" id="1719935">hash</span>&nbsp;<span class="op" id="1719940">&gt;&gt;</span>&nbsp;<span class="op" id="1719943">(</span><span class="ident" id="1719944">ptrSize</span><span class="op" id="1719951">*</span><span class="num" id="1719952">8</span>&nbsp;<span class="op" id="1719954">-</span>&nbsp;<span class="num" id="1719956">8</span><span class="op" id="1719957">)</span><span class="op" id="1719958">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1719961">if</span>&nbsp;<span class="ident" id="1719964">top</span>&nbsp;<span class="op" id="1719968">&lt;</span>&nbsp;<span class="ident" id="1719970">minTopHash</span>&nbsp;<span class="op" id="1719981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1719985">top</span>&nbsp;<span class="op" id="1719989">+=</span>&nbsp;<span class="ident" id="1719992">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720007">for</span>&nbsp;<span class="op" id="1720011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720015">for</span>&nbsp;<span class="ident" id="1720019">i</span>&nbsp;<span class="op" id="1720021">:=</span>&nbsp;<span class="builtintype" id="1720024">uintptr</span><span class="op" id="1720031">(</span><span class="num" id="1720032">0</span><span class="op" id="1720033">)</span><span class="op" id="1720034">;</span>&nbsp;<span class="ident" id="1720036">i</span>&nbsp;<span class="op" id="1720038">&lt;</span>&nbsp;<span class="ident" id="1720040">bucketCnt</span><span class="op" id="1720049">;</span>&nbsp;<span class="ident" id="1720051">i</span><span class="op" id="1720052">++</span>&nbsp;<span class="op" id="1720055">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720060">if</span>&nbsp;<span class="ident" id="1720063">b</span><span class="op" id="1720064">.</span><span class="ident" id="1720065">tophash</span><span class="op" id="1720072">[</span><span class="ident" id="1720073">i</span><span class="op" id="1720074">]</span>&nbsp;<span class="op" id="1720076">!=</span>&nbsp;<span class="ident" id="1720079">top</span>&nbsp;<span class="op" id="1720083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720089">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720106">k</span>&nbsp;<span class="op" id="1720108">:=</span>&nbsp;<span class="ident" id="1720111">add</span><span class="op" id="1720114">(</span><span class="ident" id="1720115">unsafe</span><span class="op" id="1720121">.</span><span class="ident" id="1720122">Pointer</span><span class="op" id="1720129">(</span><span class="ident" id="1720130">b</span><span class="op" id="1720131">)</span><span class="op" id="1720132">,</span>&nbsp;<span class="ident" id="1720134">dataOffset</span><span class="op" id="1720144">+</span><span class="ident" id="1720145">i</span><span class="op" id="1720146">*</span><span class="builtintype" id="1720147">uintptr</span><span class="op" id="1720154">(</span><span class="ident" id="1720155">t</span><span class="op" id="1720156">.</span><span class="ident" id="1720157">keysize</span><span class="op" id="1720164">)</span><span class="op" id="1720165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720170">k2</span>&nbsp;<span class="op" id="1720173">:=</span>&nbsp;<span class="ident" id="1720176">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720181">if</span>&nbsp;<span class="ident" id="1720184">t</span><span class="op" id="1720185">.</span><span class="ident" id="1720186">indirectkey</span>&nbsp;<span class="op" id="1720198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720204">k2</span>&nbsp;<span class="op" id="1720207">=</span>&nbsp;<span class="op" id="1720209">*</span><span class="op" id="1720210">(</span><span class="op" id="1720211">(</span><span class="op" id="1720212">*</span><span class="ident" id="1720213">unsafe</span><span class="op" id="1720219">.</span><span class="ident" id="1720220">Pointer</span><span class="op" id="1720227">)</span><span class="op" id="1720228">(</span><span class="ident" id="1720229">k2</span><span class="op" id="1720231">)</span><span class="op" id="1720232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720242">if</span>&nbsp;<span class="op" id="1720245">!</span><span class="ident" id="1720246">alg</span><span class="op" id="1720249">.</span><span class="ident" id="1720250">equal</span><span class="op" id="1720255">(</span><span class="ident" id="1720256">key</span><span class="op" id="1720259">,</span>&nbsp;<span class="ident" id="1720261">k2</span><span class="op" id="1720263">,</span>&nbsp;<span class="builtintype" id="1720265">uintptr</span><span class="op" id="1720272">(</span><span class="ident" id="1720273">t</span><span class="op" id="1720274">.</span><span class="ident" id="1720275">key</span><span class="op" id="1720278">.</span><span class="ident" id="1720279">size</span><span class="op" id="1720283">)</span><span class="op" id="1720284">)</span>&nbsp;<span class="op" id="1720286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720292">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720309">memclr</span><span class="op" id="1720315">(</span><span class="ident" id="1720316">k</span><span class="op" id="1720317">,</span>&nbsp;<span class="builtintype" id="1720319">uintptr</span><span class="op" id="1720326">(</span><span class="ident" id="1720327">t</span><span class="op" id="1720328">.</span><span class="ident" id="1720329">keysize</span><span class="op" id="1720336">)</span><span class="op" id="1720337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720342">v</span>&nbsp;<span class="op" id="1720344">:=</span>&nbsp;<span class="ident" id="1720347">unsafe</span><span class="op" id="1720353">.</span><span class="ident" id="1720354">Pointer</span><span class="op" id="1720361">(</span><span class="builtintype" id="1720362">uintptr</span><span class="op" id="1720369">(</span><span class="ident" id="1720370">unsafe</span><span class="op" id="1720376">.</span><span class="ident" id="1720377">Pointer</span><span class="op" id="1720384">(</span><span class="ident" id="1720385">b</span><span class="op" id="1720386">)</span><span class="op" id="1720387">)</span>&nbsp;<span class="op" id="1720389">+</span>&nbsp;<span class="ident" id="1720391">dataOffset</span>&nbsp;<span class="op" id="1720402">+</span>&nbsp;<span class="ident" id="1720404">bucketCnt</span><span class="op" id="1720413">*</span><span class="builtintype" id="1720414">uintptr</span><span class="op" id="1720421">(</span><span class="ident" id="1720422">t</span><span class="op" id="1720423">.</span><span class="ident" id="1720424">keysize</span><span class="op" id="1720431">)</span>&nbsp;<span class="op" id="1720433">+</span>&nbsp;<span class="ident" id="1720435">i</span><span class="op" id="1720436">*</span><span class="builtintype" id="1720437">uintptr</span><span class="op" id="1720444">(</span><span class="ident" id="1720445">t</span><span class="op" id="1720446">.</span><span class="ident" id="1720447">valuesize</span><span class="op" id="1720456">)</span><span class="op" id="1720457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720462">memclr</span><span class="op" id="1720468">(</span><span class="ident" id="1720469">v</span><span class="op" id="1720470">,</span>&nbsp;<span class="builtintype" id="1720472">uintptr</span><span class="op" id="1720479">(</span><span class="ident" id="1720480">t</span><span class="op" id="1720481">.</span><span class="ident" id="1720482">valuesize</span><span class="op" id="1720491">)</span><span class="op" id="1720492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720497">b</span><span class="op" id="1720498">.</span><span class="ident" id="1720499">tophash</span><span class="op" id="1720506">[</span><span class="ident" id="1720507">i</span><span class="op" id="1720508">]</span>&nbsp;<span class="op" id="1720510">=</span>&nbsp;<span class="ident" id="1720512">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720521">h</span><span class="op" id="1720522">.</span><span class="ident" id="1720523">count</span><span class="op" id="1720528">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720534">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720547">b</span>&nbsp;<span class="op" id="1720549">=</span>&nbsp;<span class="ident" id="1720551">b</span><span class="op" id="1720552">.</span><span class="ident" id="1720553">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720564">if</span>&nbsp;<span class="ident" id="1720567">b</span>&nbsp;<span class="op" id="1720569">==</span>&nbsp;<span class="ident" id="1720572">nil</span>&nbsp;<span class="op" id="1720576">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720581">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720593">}</span><br>
<span class="lineno"></span><span class="op" id="1720595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1720598">func</span>&nbsp;<span class="ident" id="1720603">mapiterinit</span><span class="op" id="1720614">(</span><span class="ident" id="1720615">t</span>&nbsp;<span class="op" id="1720617">*</span><span class="ident" id="1720618">maptype</span><span class="op" id="1720625">,</span>&nbsp;<span class="ident" id="1720627">h</span>&nbsp;<span class="op" id="1720629">*</span><span class="ident" id="1720630">hmap</span><span class="op" id="1720634">,</span>&nbsp;<span class="ident" id="1720636">it</span>&nbsp;<span class="op" id="1720639">*</span><span class="ident" id="1720640">hiter</span><span class="op" id="1720645">)</span>&nbsp;<span class="op" id="1720647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1720650">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720715">it</span><span class="op" id="1720717">.</span><span class="ident" id="1720718">key</span>&nbsp;<span class="op" id="1720722">=</span>&nbsp;<span class="ident" id="1720724">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720729">it</span><span class="op" id="1720731">.</span><span class="ident" id="1720732">value</span>&nbsp;<span class="op" id="1720738">=</span>&nbsp;<span class="ident" id="1720740">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720745">it</span><span class="op" id="1720747">.</span><span class="ident" id="1720748">t</span>&nbsp;<span class="op" id="1720750">=</span>&nbsp;<span class="ident" id="1720752">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720757">it</span><span class="op" id="1720759">.</span><span class="ident" id="1720760">h</span>&nbsp;<span class="op" id="1720762">=</span>&nbsp;<span class="ident" id="1720764">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720769">it</span><span class="op" id="1720771">.</span><span class="ident" id="1720772">buckets</span>&nbsp;<span class="op" id="1720780">=</span>&nbsp;<span class="ident" id="1720782">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720787">it</span><span class="op" id="1720789">.</span><span class="ident" id="1720790">bptr</span>&nbsp;<span class="op" id="1720795">=</span>&nbsp;<span class="ident" id="1720797">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720803">if</span>&nbsp;<span class="ident" id="1720806">raceenabled</span>&nbsp;<span class="op" id="1720818">&amp;&amp;</span>&nbsp;<span class="ident" id="1720821">h</span>&nbsp;<span class="op" id="1720823">!=</span>&nbsp;<span class="ident" id="1720826">nil</span>&nbsp;<span class="op" id="1720830">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720834">callerpc</span>&nbsp;<span class="op" id="1720843">:=</span>&nbsp;<span class="ident" id="1720846">getcallerpc</span><span class="op" id="1720857">(</span><span class="ident" id="1720858">unsafe</span><span class="op" id="1720864">.</span><span class="ident" id="1720865">Pointer</span><span class="op" id="1720872">(</span><span class="op" id="1720873">&amp;</span><span class="ident" id="1720874">t</span><span class="op" id="1720875">)</span><span class="op" id="1720876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720880">racereadpc</span><span class="op" id="1720890">(</span><span class="ident" id="1720891">unsafe</span><span class="op" id="1720897">.</span><span class="ident" id="1720898">Pointer</span><span class="op" id="1720905">(</span><span class="ident" id="1720906">h</span><span class="op" id="1720907">)</span><span class="op" id="1720908">,</span>&nbsp;<span class="ident" id="1720910">callerpc</span><span class="op" id="1720918">,</span>&nbsp;<span class="ident" id="1720920">funcPC</span><span class="op" id="1720926">(</span><span class="ident" id="1720927">mapiterinit</span><span class="op" id="1720938">)</span><span class="op" id="1720939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1720942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1720946">if</span>&nbsp;<span class="ident" id="1720949">h</span>&nbsp;<span class="op" id="1720951">==</span>&nbsp;<span class="ident" id="1720954">nil</span>&nbsp;<span class="op" id="1720958">||</span>&nbsp;<span class="ident" id="1720961">h</span><span class="op" id="1720962">.</span><span class="ident" id="1720963">count</span>&nbsp;<span class="op" id="1720969">==</span>&nbsp;<span class="num" id="1720972">0</span>&nbsp;<span class="op" id="1720974">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720978">it</span><span class="op" id="1720980">.</span><span class="ident" id="1720981">key</span>&nbsp;<span class="op" id="1720985">=</span>&nbsp;<span class="ident" id="1720987">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1720993">it</span><span class="op" id="1720995">.</span><span class="ident" id="1720996">value</span>&nbsp;<span class="op" id="1721002">=</span>&nbsp;<span class="ident" id="1721004">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721010">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721022">if</span>&nbsp;<span class="ident" id="1721025">unsafe</span><span class="op" id="1721031">.</span><span class="ident" id="1721032">Sizeof</span><span class="op" id="1721038">(</span><span class="ident" id="1721039">hiter</span><span class="op" id="1721044">{</span><span class="op" id="1721045">}</span><span class="op" id="1721046">)</span><span class="op" id="1721047">/</span><span class="ident" id="1721048">ptrSize</span>&nbsp;<span class="op" id="1721056">!=</span>&nbsp;<span class="num" id="1721059">10</span>&nbsp;<span class="op" id="1721062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721066">gothrow</span><span class="op" id="1721073">(</span><span class="string" id="1721074">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1721100">)</span>&nbsp;<span class="comment" id="1721102">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721136">it</span><span class="op" id="1721138">.</span><span class="ident" id="1721139">t</span>&nbsp;<span class="op" id="1721141">=</span>&nbsp;<span class="ident" id="1721143">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721146">it</span><span class="op" id="1721148">.</span><span class="ident" id="1721149">h</span>&nbsp;<span class="op" id="1721151">=</span>&nbsp;<span class="ident" id="1721153">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1721157">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721191">it</span><span class="op" id="1721193">.</span><span class="ident" id="1721194">B</span>&nbsp;<span class="op" id="1721196">=</span>&nbsp;<span class="ident" id="1721198">h</span><span class="op" id="1721199">.</span><span class="ident" id="1721200">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721203">it</span><span class="op" id="1721205">.</span><span class="ident" id="1721206">buckets</span>&nbsp;<span class="op" id="1721214">=</span>&nbsp;<span class="ident" id="1721216">h</span><span class="op" id="1721217">.</span><span class="ident" id="1721218">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1721228">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721254">r</span>&nbsp;<span class="op" id="1721256">:=</span>&nbsp;<span class="builtintype" id="1721259">uintptr</span><span class="op" id="1721266">(</span><span class="ident" id="1721267">fastrand1</span><span class="op" id="1721276">(</span><span class="op" id="1721277">)</span><span class="op" id="1721278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721281">if</span>&nbsp;<span class="ident" id="1721284">h</span><span class="op" id="1721285">.</span><span class="ident" id="1721286">B</span>&nbsp;<span class="op" id="1721288">&gt;</span>&nbsp;<span class="num" id="1721290">31</span><span class="op" id="1721292">-</span><span class="ident" id="1721293">bucketCntBits</span>&nbsp;<span class="op" id="1721307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721311">r</span>&nbsp;<span class="op" id="1721313">+=</span>&nbsp;<span class="builtintype" id="1721316">uintptr</span><span class="op" id="1721323">(</span><span class="ident" id="1721324">fastrand1</span><span class="op" id="1721333">(</span><span class="op" id="1721334">)</span><span class="op" id="1721335">)</span>&nbsp;<span class="op" id="1721337">&lt;&lt;</span>&nbsp;<span class="num" id="1721340">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721344">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721347">it</span><span class="op" id="1721349">.</span><span class="ident" id="1721350">startBucket</span>&nbsp;<span class="op" id="1721362">=</span>&nbsp;<span class="ident" id="1721364">r</span>&nbsp;<span class="op" id="1721366">&amp;</span>&nbsp;<span class="op" id="1721368">(</span><span class="builtintype" id="1721369">uintptr</span><span class="op" id="1721376">(</span><span class="num" id="1721377">1</span><span class="op" id="1721378">)</span><span class="op" id="1721379">&lt;&lt;</span><span class="ident" id="1721381">h</span><span class="op" id="1721382">.</span><span class="ident" id="1721383">B</span>&nbsp;<span class="op" id="1721385">-</span>&nbsp;<span class="num" id="1721387">1</span><span class="op" id="1721388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721391">it</span><span class="op" id="1721393">.</span><span class="ident" id="1721394">offset</span>&nbsp;<span class="op" id="1721401">=</span>&nbsp;<span class="builtintype" id="1721403">uint8</span><span class="op" id="1721408">(</span><span class="ident" id="1721409">r</span>&nbsp;<span class="op" id="1721411">&gt;&gt;</span>&nbsp;<span class="ident" id="1721414">h</span><span class="op" id="1721415">.</span><span class="ident" id="1721416">B</span>&nbsp;<span class="op" id="1721418">&amp;</span>&nbsp;<span class="op" id="1721420">(</span><span class="ident" id="1721421">bucketCnt</span>&nbsp;<span class="op" id="1721431">-</span>&nbsp;<span class="num" id="1721433">1</span><span class="op" id="1721434">)</span><span class="op" id="1721435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1721439">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721458">it</span><span class="op" id="1721460">.</span><span class="ident" id="1721461">bucket</span>&nbsp;<span class="op" id="1721468">=</span>&nbsp;<span class="ident" id="1721470">it</span><span class="op" id="1721472">.</span><span class="ident" id="1721473">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721486">it</span><span class="op" id="1721488">.</span><span class="ident" id="1721489">wrapped</span>&nbsp;<span class="op" id="1721497">=</span>&nbsp;<span class="builtintype" id="1721499">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721506">it</span><span class="op" id="1721508">.</span><span class="ident" id="1721509">bptr</span>&nbsp;<span class="op" id="1721514">=</span>&nbsp;<span class="ident" id="1721516">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1721522">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1721556">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721612">for</span>&nbsp;<span class="op" id="1721616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721620">old</span>&nbsp;<span class="op" id="1721624">:=</span>&nbsp;<span class="ident" id="1721627">h</span><span class="op" id="1721628">.</span><span class="ident" id="1721629">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721637">if</span>&nbsp;<span class="ident" id="1721640">old</span>&nbsp;<span class="op" id="1721644">==</span>&nbsp;<span class="ident" id="1721647">old</span><span class="op" id="1721650">|</span><span class="ident" id="1721651">iterator</span><span class="op" id="1721659">|</span><span class="ident" id="1721660">oldIterator</span>&nbsp;<span class="op" id="1721672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721677">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721685">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721689">if</span>&nbsp;<span class="ident" id="1721692">cas</span><span class="op" id="1721695">(</span><span class="op" id="1721696">&amp;</span><span class="ident" id="1721697">h</span><span class="op" id="1721698">.</span><span class="ident" id="1721699">flags</span><span class="op" id="1721704">,</span>&nbsp;<span class="ident" id="1721706">old</span><span class="op" id="1721709">,</span>&nbsp;<span class="ident" id="1721711">old</span><span class="op" id="1721714">|</span><span class="ident" id="1721715">iterator</span><span class="op" id="1721723">|</span><span class="ident" id="1721724">oldIterator</span><span class="op" id="1721735">)</span>&nbsp;<span class="op" id="1721737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721742">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721757">mapiternext</span><span class="op" id="1721768">(</span><span class="ident" id="1721769">it</span><span class="op" id="1721771">)</span><br>
<span class="lineno"></span><span class="op" id="1721773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1721776">func</span>&nbsp;<span class="ident" id="1721781">mapiternext</span><span class="op" id="1721792">(</span><span class="ident" id="1721793">it</span>&nbsp;<span class="op" id="1721796">*</span><span class="ident" id="1721797">hiter</span><span class="op" id="1721802">)</span>&nbsp;<span class="op" id="1721804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721807">h</span>&nbsp;<span class="op" id="1721809">:=</span>&nbsp;<span class="ident" id="1721812">it</span><span class="op" id="1721814">.</span><span class="ident" id="1721815">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1721818">if</span>&nbsp;<span class="ident" id="1721821">raceenabled</span>&nbsp;<span class="op" id="1721833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721837">callerpc</span>&nbsp;<span class="op" id="1721846">:=</span>&nbsp;<span class="ident" id="1721849">getcallerpc</span><span class="op" id="1721860">(</span><span class="ident" id="1721861">unsafe</span><span class="op" id="1721867">.</span><span class="ident" id="1721868">Pointer</span><span class="op" id="1721875">(</span><span class="op" id="1721876">&amp;</span><span class="ident" id="1721877">it</span><span class="op" id="1721879">)</span><span class="op" id="1721880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721884">racereadpc</span><span class="op" id="1721894">(</span><span class="ident" id="1721895">unsafe</span><span class="op" id="1721901">.</span><span class="ident" id="1721902">Pointer</span><span class="op" id="1721909">(</span><span class="ident" id="1721910">h</span><span class="op" id="1721911">)</span><span class="op" id="1721912">,</span>&nbsp;<span class="ident" id="1721914">callerpc</span><span class="op" id="1721922">,</span>&nbsp;<span class="ident" id="1721924">funcPC</span><span class="op" id="1721930">(</span><span class="ident" id="1721931">mapiternext</span><span class="op" id="1721942">)</span><span class="op" id="1721943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1721946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721949">t</span>&nbsp;<span class="op" id="1721951">:=</span>&nbsp;<span class="ident" id="1721954">it</span><span class="op" id="1721956">.</span><span class="ident" id="1721957">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721960">bucket</span>&nbsp;<span class="op" id="1721967">:=</span>&nbsp;<span class="ident" id="1721970">it</span><span class="op" id="1721972">.</span><span class="ident" id="1721973">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721981">b</span>&nbsp;<span class="op" id="1721983">:=</span>&nbsp;<span class="ident" id="1721986">it</span><span class="op" id="1721988">.</span><span class="ident" id="1721989">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1721995">i</span>&nbsp;<span class="op" id="1721997">:=</span>&nbsp;<span class="ident" id="1722000">it</span><span class="op" id="1722002">.</span><span class="ident" id="1722003">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722006">checkBucket</span>&nbsp;<span class="op" id="1722018">:=</span>&nbsp;<span class="ident" id="1722021">it</span><span class="op" id="1722023">.</span><span class="ident" id="1722024">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722037">alg</span>&nbsp;<span class="op" id="1722041">:=</span>&nbsp;<span class="ident" id="1722044">goalg</span><span class="op" id="1722049">(</span><span class="ident" id="1722050">t</span><span class="op" id="1722051">.</span><span class="ident" id="1722052">key</span><span class="op" id="1722055">.</span><span class="ident" id="1722056">alg</span><span class="op" id="1722059">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1722062">next</span><span class="op" id="1722066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722069">if</span>&nbsp;<span class="ident" id="1722072">b</span>&nbsp;<span class="op" id="1722074">==</span>&nbsp;<span class="ident" id="1722077">nil</span>&nbsp;<span class="op" id="1722081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722085">if</span>&nbsp;<span class="ident" id="1722088">bucket</span>&nbsp;<span class="op" id="1722095">==</span>&nbsp;<span class="ident" id="1722098">it</span><span class="op" id="1722100">.</span><span class="ident" id="1722101">startBucket</span>&nbsp;<span class="op" id="1722113">&amp;&amp;</span>&nbsp;<span class="ident" id="1722116">it</span><span class="op" id="1722118">.</span><span class="ident" id="1722119">wrapped</span>&nbsp;<span class="op" id="1722127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722132">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722155">it</span><span class="op" id="1722157">.</span><span class="ident" id="1722158">key</span>&nbsp;<span class="op" id="1722162">=</span>&nbsp;<span class="ident" id="1722164">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722171">it</span><span class="op" id="1722173">.</span><span class="ident" id="1722174">value</span>&nbsp;<span class="op" id="1722180">=</span>&nbsp;<span class="ident" id="1722182">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722189">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1722198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722202">if</span>&nbsp;<span class="ident" id="1722205">h</span><span class="op" id="1722206">.</span><span class="ident" id="1722207">oldbuckets</span>&nbsp;<span class="op" id="1722218">!=</span>&nbsp;<span class="ident" id="1722221">nil</span>&nbsp;<span class="op" id="1722225">&amp;&amp;</span>&nbsp;<span class="ident" id="1722228">it</span><span class="op" id="1722230">.</span><span class="ident" id="1722231">B</span>&nbsp;<span class="op" id="1722233">==</span>&nbsp;<span class="ident" id="1722236">h</span><span class="op" id="1722237">.</span><span class="ident" id="1722238">B</span>&nbsp;<span class="op" id="1722240">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722245">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722326">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722403">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1722479">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722555">oldbucket</span>&nbsp;<span class="op" id="1722565">:=</span>&nbsp;<span class="ident" id="1722568">bucket</span>&nbsp;<span class="op" id="1722575">&amp;</span>&nbsp;<span class="op" id="1722577">(</span><span class="builtintype" id="1722578">uintptr</span><span class="op" id="1722585">(</span><span class="num" id="1722586">1</span><span class="op" id="1722587">)</span><span class="op" id="1722588">&lt;&lt;</span><span class="op" id="1722590">(</span><span class="ident" id="1722591">it</span><span class="op" id="1722593">.</span><span class="ident" id="1722594">B</span><span class="op" id="1722595">-</span><span class="num" id="1722596">1</span><span class="op" id="1722597">)</span>&nbsp;<span class="op" id="1722599">-</span>&nbsp;<span class="num" id="1722601">1</span><span class="op" id="1722602">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722607">b</span>&nbsp;<span class="op" id="1722609">=</span>&nbsp;<span class="op" id="1722611">(</span><span class="op" id="1722612">*</span><span class="ident" id="1722613">bmap</span><span class="op" id="1722617">)</span><span class="op" id="1722618">(</span><span class="ident" id="1722619">add</span><span class="op" id="1722622">(</span><span class="ident" id="1722623">h</span><span class="op" id="1722624">.</span><span class="ident" id="1722625">oldbuckets</span><span class="op" id="1722635">,</span>&nbsp;<span class="ident" id="1722637">oldbucket</span><span class="op" id="1722646">*</span><span class="builtintype" id="1722647">uintptr</span><span class="op" id="1722654">(</span><span class="ident" id="1722655">t</span><span class="op" id="1722656">.</span><span class="ident" id="1722657">bucketsize</span><span class="op" id="1722667">)</span><span class="op" id="1722668">)</span><span class="op" id="1722669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722674">if</span>&nbsp;<span class="op" id="1722677">!</span><span class="ident" id="1722678">evacuated</span><span class="op" id="1722687">(</span><span class="ident" id="1722688">b</span><span class="op" id="1722689">)</span>&nbsp;<span class="op" id="1722691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722697">checkBucket</span>&nbsp;<span class="op" id="1722709">=</span>&nbsp;<span class="ident" id="1722711">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1722721">}</span>&nbsp;<span class="keyword" id="1722723">else</span>&nbsp;<span class="op" id="1722728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722734">b</span>&nbsp;<span class="op" id="1722736">=</span>&nbsp;<span class="op" id="1722738">(</span><span class="op" id="1722739">*</span><span class="ident" id="1722740">bmap</span><span class="op" id="1722744">)</span><span class="op" id="1722745">(</span><span class="ident" id="1722746">add</span><span class="op" id="1722749">(</span><span class="ident" id="1722750">it</span><span class="op" id="1722752">.</span><span class="ident" id="1722753">buckets</span><span class="op" id="1722760">,</span>&nbsp;<span class="ident" id="1722762">bucket</span><span class="op" id="1722768">*</span><span class="builtintype" id="1722769">uintptr</span><span class="op" id="1722776">(</span><span class="ident" id="1722777">t</span><span class="op" id="1722778">.</span><span class="ident" id="1722779">bucketsize</span><span class="op" id="1722789">)</span><span class="op" id="1722790">)</span><span class="op" id="1722791">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722797">checkBucket</span>&nbsp;<span class="op" id="1722809">=</span>&nbsp;<span class="ident" id="1722811">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1722822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1722826">}</span>&nbsp;<span class="keyword" id="1722828">else</span>&nbsp;<span class="op" id="1722833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722838">b</span>&nbsp;<span class="op" id="1722840">=</span>&nbsp;<span class="op" id="1722842">(</span><span class="op" id="1722843">*</span><span class="ident" id="1722844">bmap</span><span class="op" id="1722848">)</span><span class="op" id="1722849">(</span><span class="ident" id="1722850">add</span><span class="op" id="1722853">(</span><span class="ident" id="1722854">it</span><span class="op" id="1722856">.</span><span class="ident" id="1722857">buckets</span><span class="op" id="1722864">,</span>&nbsp;<span class="ident" id="1722866">bucket</span><span class="op" id="1722872">*</span><span class="builtintype" id="1722873">uintptr</span><span class="op" id="1722880">(</span><span class="ident" id="1722881">t</span><span class="op" id="1722882">.</span><span class="ident" id="1722883">bucketsize</span><span class="op" id="1722893">)</span><span class="op" id="1722894">)</span><span class="op" id="1722895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722900">checkBucket</span>&nbsp;<span class="op" id="1722912">=</span>&nbsp;<span class="ident" id="1722914">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1722924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722928">bucket</span><span class="op" id="1722934">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1722939">if</span>&nbsp;<span class="ident" id="1722942">bucket</span>&nbsp;<span class="op" id="1722949">==</span>&nbsp;<span class="builtintype" id="1722952">uintptr</span><span class="op" id="1722959">(</span><span class="num" id="1722960">1</span><span class="op" id="1722961">)</span><span class="op" id="1722962">&lt;&lt;</span><span class="ident" id="1722964">it</span><span class="op" id="1722966">.</span><span class="ident" id="1722967">B</span>&nbsp;<span class="op" id="1722969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722974">bucket</span>&nbsp;<span class="op" id="1722981">=</span>&nbsp;<span class="num" id="1722983">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1722988">it</span><span class="op" id="1722990">.</span><span class="ident" id="1722991">wrapped</span>&nbsp;<span class="op" id="1722999">=</span>&nbsp;<span class="builtintype" id="1723001">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723012">i</span>&nbsp;<span class="op" id="1723014">=</span>&nbsp;<span class="num" id="1723016">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723022">for</span>&nbsp;<span class="op" id="1723026">;</span>&nbsp;<span class="ident" id="1723028">i</span>&nbsp;<span class="op" id="1723030">&lt;</span>&nbsp;<span class="ident" id="1723032">bucketCnt</span><span class="op" id="1723041">;</span>&nbsp;<span class="ident" id="1723043">i</span><span class="op" id="1723044">++</span>&nbsp;<span class="op" id="1723047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723051">offi</span>&nbsp;<span class="op" id="1723056">:=</span>&nbsp;<span class="op" id="1723059">(</span><span class="ident" id="1723060">i</span>&nbsp;<span class="op" id="1723062">+</span>&nbsp;<span class="ident" id="1723064">it</span><span class="op" id="1723066">.</span><span class="ident" id="1723067">offset</span><span class="op" id="1723073">)</span>&nbsp;<span class="op" id="1723075">&amp;</span>&nbsp;<span class="op" id="1723077">(</span><span class="ident" id="1723078">bucketCnt</span>&nbsp;<span class="op" id="1723088">-</span>&nbsp;<span class="num" id="1723090">1</span><span class="op" id="1723091">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723095">k</span>&nbsp;<span class="op" id="1723097">:=</span>&nbsp;<span class="ident" id="1723100">add</span><span class="op" id="1723103">(</span><span class="ident" id="1723104">unsafe</span><span class="op" id="1723110">.</span><span class="ident" id="1723111">Pointer</span><span class="op" id="1723118">(</span><span class="ident" id="1723119">b</span><span class="op" id="1723120">)</span><span class="op" id="1723121">,</span>&nbsp;<span class="ident" id="1723123">dataOffset</span><span class="op" id="1723133">+</span><span class="builtintype" id="1723134">uintptr</span><span class="op" id="1723141">(</span><span class="ident" id="1723142">offi</span><span class="op" id="1723146">)</span><span class="op" id="1723147">*</span><span class="builtintype" id="1723148">uintptr</span><span class="op" id="1723155">(</span><span class="ident" id="1723156">t</span><span class="op" id="1723157">.</span><span class="ident" id="1723158">keysize</span><span class="op" id="1723165">)</span><span class="op" id="1723166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723170">v</span>&nbsp;<span class="op" id="1723172">:=</span>&nbsp;<span class="ident" id="1723175">add</span><span class="op" id="1723178">(</span><span class="ident" id="1723179">unsafe</span><span class="op" id="1723185">.</span><span class="ident" id="1723186">Pointer</span><span class="op" id="1723193">(</span><span class="ident" id="1723194">b</span><span class="op" id="1723195">)</span><span class="op" id="1723196">,</span>&nbsp;<span class="ident" id="1723198">dataOffset</span><span class="op" id="1723208">+</span><span class="ident" id="1723209">bucketCnt</span><span class="op" id="1723218">*</span><span class="builtintype" id="1723219">uintptr</span><span class="op" id="1723226">(</span><span class="ident" id="1723227">t</span><span class="op" id="1723228">.</span><span class="ident" id="1723229">keysize</span><span class="op" id="1723236">)</span><span class="op" id="1723237">+</span><span class="builtintype" id="1723238">uintptr</span><span class="op" id="1723245">(</span><span class="ident" id="1723246">offi</span><span class="op" id="1723250">)</span><span class="op" id="1723251">*</span><span class="builtintype" id="1723252">uintptr</span><span class="op" id="1723259">(</span><span class="ident" id="1723260">t</span><span class="op" id="1723261">.</span><span class="ident" id="1723262">valuesize</span><span class="op" id="1723271">)</span><span class="op" id="1723272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723276">if</span>&nbsp;<span class="ident" id="1723279">b</span><span class="op" id="1723280">.</span><span class="ident" id="1723281">tophash</span><span class="op" id="1723288">[</span><span class="ident" id="1723289">offi</span><span class="op" id="1723293">]</span>&nbsp;<span class="op" id="1723295">!=</span>&nbsp;<span class="ident" id="1723298">empty</span>&nbsp;<span class="op" id="1723304">&amp;&amp;</span>&nbsp;<span class="ident" id="1723307">b</span><span class="op" id="1723308">.</span><span class="ident" id="1723309">tophash</span><span class="op" id="1723316">[</span><span class="ident" id="1723317">offi</span><span class="op" id="1723321">]</span>&nbsp;<span class="op" id="1723323">!=</span>&nbsp;<span class="ident" id="1723326">evacuatedEmpty</span>&nbsp;<span class="op" id="1723341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723346">if</span>&nbsp;<span class="ident" id="1723349">checkBucket</span>&nbsp;<span class="op" id="1723361">!=</span>&nbsp;<span class="ident" id="1723364">noCheck</span>&nbsp;<span class="op" id="1723372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723378">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723442">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723504">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723573">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723638">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723699">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723761">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723792">k2</span>&nbsp;<span class="op" id="1723795">:=</span>&nbsp;<span class="ident" id="1723798">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723804">if</span>&nbsp;<span class="ident" id="1723807">t</span><span class="op" id="1723808">.</span><span class="ident" id="1723809">indirectkey</span>&nbsp;<span class="op" id="1723821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1723828">k2</span>&nbsp;<span class="op" id="1723831">=</span>&nbsp;<span class="op" id="1723833">*</span><span class="op" id="1723834">(</span><span class="op" id="1723835">(</span><span class="op" id="1723836">*</span><span class="ident" id="1723837">unsafe</span><span class="op" id="1723843">.</span><span class="ident" id="1723844">Pointer</span><span class="op" id="1723851">)</span><span class="op" id="1723852">(</span><span class="ident" id="1723853">k2</span><span class="op" id="1723855">)</span><span class="op" id="1723856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1723862">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1723868">if</span>&nbsp;<span class="ident" id="1723871">alg</span><span class="op" id="1723874">.</span><span class="ident" id="1723875">equal</span><span class="op" id="1723880">(</span><span class="ident" id="1723881">k2</span><span class="op" id="1723883">,</span>&nbsp;<span class="ident" id="1723885">k2</span><span class="op" id="1723887">,</span>&nbsp;<span class="builtintype" id="1723889">uintptr</span><span class="op" id="1723896">(</span><span class="ident" id="1723897">t</span><span class="op" id="1723898">.</span><span class="ident" id="1723899">key</span><span class="op" id="1723902">.</span><span class="ident" id="1723903">size</span><span class="op" id="1723907">)</span><span class="op" id="1723908">)</span>&nbsp;<span class="op" id="1723910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723917">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1723974">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724032">hash</span>&nbsp;<span class="op" id="1724037">:=</span>&nbsp;<span class="ident" id="1724040">alg</span><span class="op" id="1724043">.</span><span class="ident" id="1724044">hash</span><span class="op" id="1724048">(</span><span class="ident" id="1724049">k2</span><span class="op" id="1724051">,</span>&nbsp;<span class="builtintype" id="1724053">uintptr</span><span class="op" id="1724060">(</span><span class="ident" id="1724061">t</span><span class="op" id="1724062">.</span><span class="ident" id="1724063">key</span><span class="op" id="1724066">.</span><span class="ident" id="1724067">size</span><span class="op" id="1724071">)</span><span class="op" id="1724072">,</span>&nbsp;<span class="builtintype" id="1724074">uintptr</span><span class="op" id="1724081">(</span><span class="ident" id="1724082">h</span><span class="op" id="1724083">.</span><span class="ident" id="1724084">hash0</span><span class="op" id="1724089">)</span><span class="op" id="1724090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724097">if</span>&nbsp;<span class="ident" id="1724100">hash</span><span class="op" id="1724104">&amp;</span><span class="op" id="1724105">(</span><span class="builtintype" id="1724106">uintptr</span><span class="op" id="1724113">(</span><span class="num" id="1724114">1</span><span class="op" id="1724115">)</span><span class="op" id="1724116">&lt;&lt;</span><span class="ident" id="1724118">it</span><span class="op" id="1724120">.</span><span class="ident" id="1724121">B</span><span class="op" id="1724122">-</span><span class="num" id="1724123">1</span><span class="op" id="1724124">)</span>&nbsp;<span class="op" id="1724126">!=</span>&nbsp;<span class="ident" id="1724129">checkBucket</span>&nbsp;<span class="op" id="1724141">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724149">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724169">}</span>&nbsp;<span class="keyword" id="1724171">else</span>&nbsp;<span class="op" id="1724176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724183">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724242">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724301">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724360">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724412">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724472">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724530">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724553">if</span>&nbsp;<span class="ident" id="1724556">checkBucket</span><span class="op" id="1724567">&gt;&gt;</span><span class="op" id="1724569">(</span><span class="ident" id="1724570">it</span><span class="op" id="1724572">.</span><span class="ident" id="1724573">B</span><span class="op" id="1724574">-</span><span class="num" id="1724575">1</span><span class="op" id="1724576">)</span>&nbsp;<span class="op" id="1724578">!=</span>&nbsp;<span class="builtintype" id="1724581">uintptr</span><span class="op" id="1724588">(</span><span class="ident" id="1724589">b</span><span class="op" id="1724590">.</span><span class="ident" id="1724591">tophash</span><span class="op" id="1724598">[</span><span class="ident" id="1724599">offi</span><span class="op" id="1724603">]</span><span class="op" id="1724604">&amp;</span><span class="num" id="1724605">1</span><span class="op" id="1724606">)</span>&nbsp;<span class="op" id="1724608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724616">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724641">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724646">if</span>&nbsp;<span class="ident" id="1724649">b</span><span class="op" id="1724650">.</span><span class="ident" id="1724651">tophash</span><span class="op" id="1724658">[</span><span class="ident" id="1724659">offi</span><span class="op" id="1724663">]</span>&nbsp;<span class="op" id="1724665">!=</span>&nbsp;<span class="ident" id="1724668">evacuatedX</span>&nbsp;<span class="op" id="1724679">&amp;&amp;</span>&nbsp;<span class="ident" id="1724682">b</span><span class="op" id="1724683">.</span><span class="ident" id="1724684">tophash</span><span class="op" id="1724691">[</span><span class="ident" id="1724692">offi</span><span class="op" id="1724696">]</span>&nbsp;<span class="op" id="1724698">!=</span>&nbsp;<span class="ident" id="1724701">evacuatedY</span>&nbsp;<span class="op" id="1724712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724718">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724768">if</span>&nbsp;<span class="ident" id="1724771">t</span><span class="op" id="1724772">.</span><span class="ident" id="1724773">indirectkey</span>&nbsp;<span class="op" id="1724785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724792">k</span>&nbsp;<span class="op" id="1724794">=</span>&nbsp;<span class="op" id="1724796">*</span><span class="op" id="1724797">(</span><span class="op" id="1724798">(</span><span class="op" id="1724799">*</span><span class="ident" id="1724800">unsafe</span><span class="op" id="1724806">.</span><span class="ident" id="1724807">Pointer</span><span class="op" id="1724814">)</span><span class="op" id="1724815">(</span><span class="ident" id="1724816">k</span><span class="op" id="1724817">)</span><span class="op" id="1724818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724824">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724830">it</span><span class="op" id="1724832">.</span><span class="ident" id="1724833">key</span>&nbsp;<span class="op" id="1724837">=</span>&nbsp;<span class="ident" id="1724839">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1724845">if</span>&nbsp;<span class="ident" id="1724848">t</span><span class="op" id="1724849">.</span><span class="ident" id="1724850">indirectvalue</span>&nbsp;<span class="op" id="1724864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724871">v</span>&nbsp;<span class="op" id="1724873">=</span>&nbsp;<span class="op" id="1724875">*</span><span class="op" id="1724876">(</span><span class="op" id="1724877">(</span><span class="op" id="1724878">*</span><span class="ident" id="1724879">unsafe</span><span class="op" id="1724885">.</span><span class="ident" id="1724886">Pointer</span><span class="op" id="1724893">)</span><span class="op" id="1724894">(</span><span class="ident" id="1724895">v</span><span class="op" id="1724896">)</span><span class="op" id="1724897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1724909">it</span><span class="op" id="1724911">.</span><span class="ident" id="1724912">value</span>&nbsp;<span class="op" id="1724918">=</span>&nbsp;<span class="ident" id="1724920">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1724925">}</span>&nbsp;<span class="keyword" id="1724927">else</span>&nbsp;<span class="op" id="1724932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1724938">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725002">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725061">k2</span>&nbsp;<span class="op" id="1725064">:=</span>&nbsp;<span class="ident" id="1725067">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725073">if</span>&nbsp;<span class="ident" id="1725076">t</span><span class="op" id="1725077">.</span><span class="ident" id="1725078">indirectkey</span>&nbsp;<span class="op" id="1725090">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725097">k2</span>&nbsp;<span class="op" id="1725100">=</span>&nbsp;<span class="op" id="1725102">*</span><span class="op" id="1725103">(</span><span class="op" id="1725104">(</span><span class="op" id="1725105">*</span><span class="ident" id="1725106">unsafe</span><span class="op" id="1725112">.</span><span class="ident" id="1725113">Pointer</span><span class="op" id="1725120">)</span><span class="op" id="1725121">(</span><span class="ident" id="1725122">k2</span><span class="op" id="1725124">)</span><span class="op" id="1725125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725137">if</span>&nbsp;<span class="ident" id="1725140">alg</span><span class="op" id="1725143">.</span><span class="ident" id="1725144">equal</span><span class="op" id="1725149">(</span><span class="ident" id="1725150">k2</span><span class="op" id="1725152">,</span>&nbsp;<span class="ident" id="1725154">k2</span><span class="op" id="1725156">,</span>&nbsp;<span class="builtintype" id="1725158">uintptr</span><span class="op" id="1725165">(</span><span class="ident" id="1725166">t</span><span class="op" id="1725167">.</span><span class="ident" id="1725168">key</span><span class="op" id="1725171">.</span><span class="ident" id="1725172">size</span><span class="op" id="1725176">)</span><span class="op" id="1725177">)</span>&nbsp;<span class="op" id="1725179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725186">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725237">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725286">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725348">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725415">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725488">rk</span><span class="op" id="1725490">,</span>&nbsp;<span class="ident" id="1725492">rv</span>&nbsp;<span class="op" id="1725495">:=</span>&nbsp;<span class="ident" id="1725498">mapaccessK</span><span class="op" id="1725508">(</span><span class="ident" id="1725509">t</span><span class="op" id="1725510">,</span>&nbsp;<span class="ident" id="1725512">h</span><span class="op" id="1725513">,</span>&nbsp;<span class="ident" id="1725515">k2</span><span class="op" id="1725517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725524">if</span>&nbsp;<span class="ident" id="1725527">rk</span>&nbsp;<span class="op" id="1725530">==</span>&nbsp;<span class="ident" id="1725533">nil</span>&nbsp;<span class="op" id="1725537">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725545">continue</span>&nbsp;<span class="comment" id="1725554">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725590">it</span><span class="op" id="1725592">.</span><span class="ident" id="1725593">key</span>&nbsp;<span class="op" id="1725597">=</span>&nbsp;<span class="ident" id="1725599">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725607">it</span><span class="op" id="1725609">.</span><span class="ident" id="1725610">value</span>&nbsp;<span class="op" id="1725616">=</span>&nbsp;<span class="ident" id="1725618">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725625">}</span>&nbsp;<span class="keyword" id="1725627">else</span>&nbsp;<span class="op" id="1725632">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725639">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725694">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725755">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1725808">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725851">it</span><span class="op" id="1725853">.</span><span class="ident" id="1725854">key</span>&nbsp;<span class="op" id="1725858">=</span>&nbsp;<span class="ident" id="1725860">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1725868">if</span>&nbsp;<span class="ident" id="1725871">t</span><span class="op" id="1725872">.</span><span class="ident" id="1725873">indirectvalue</span>&nbsp;<span class="op" id="1725887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725895">v</span>&nbsp;<span class="op" id="1725897">=</span>&nbsp;<span class="op" id="1725899">*</span><span class="op" id="1725900">(</span><span class="op" id="1725901">(</span><span class="op" id="1725902">*</span><span class="ident" id="1725903">unsafe</span><span class="op" id="1725909">.</span><span class="ident" id="1725910">Pointer</span><span class="op" id="1725917">)</span><span class="op" id="1725918">(</span><span class="ident" id="1725919">v</span><span class="op" id="1725920">)</span><span class="op" id="1725921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725935">it</span><span class="op" id="1725937">.</span><span class="ident" id="1725938">value</span>&nbsp;<span class="op" id="1725944">=</span>&nbsp;<span class="ident" id="1725946">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725952">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1725957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725962">it</span><span class="op" id="1725964">.</span><span class="ident" id="1725965">bucket</span>&nbsp;<span class="op" id="1725972">=</span>&nbsp;<span class="ident" id="1725974">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725984">it</span><span class="op" id="1725986">.</span><span class="ident" id="1725987">bptr</span>&nbsp;<span class="op" id="1725992">=</span>&nbsp;<span class="ident" id="1725994">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1725999">it</span><span class="op" id="1726001">.</span><span class="ident" id="1726002">i</span>&nbsp;<span class="op" id="1726004">=</span>&nbsp;<span class="ident" id="1726006">i</span>&nbsp;<span class="op" id="1726008">+</span>&nbsp;<span class="num" id="1726010">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726015">it</span><span class="op" id="1726017">.</span><span class="ident" id="1726018">checkBucket</span>&nbsp;<span class="op" id="1726030">=</span>&nbsp;<span class="ident" id="1726032">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726047">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726062">b</span>&nbsp;<span class="op" id="1726064">=</span>&nbsp;<span class="ident" id="1726066">b</span><span class="op" id="1726067">.</span><span class="ident" id="1726068">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726078">i</span>&nbsp;<span class="op" id="1726080">=</span>&nbsp;<span class="num" id="1726082">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726085">goto</span>&nbsp;<span class="ident" id="1726090">next</span><br>
<span class="lineno"></span><span class="op" id="1726095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1726098">func</span>&nbsp;<span class="ident" id="1726103">hashGrow</span><span class="op" id="1726111">(</span><span class="ident" id="1726112">t</span>&nbsp;<span class="op" id="1726114">*</span><span class="ident" id="1726115">maptype</span><span class="op" id="1726122">,</span>&nbsp;<span class="ident" id="1726124">h</span>&nbsp;<span class="op" id="1726126">*</span><span class="ident" id="1726127">hmap</span><span class="op" id="1726131">)</span>&nbsp;<span class="op" id="1726133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726136">if</span>&nbsp;<span class="ident" id="1726139">h</span><span class="op" id="1726140">.</span><span class="ident" id="1726141">oldbuckets</span>&nbsp;<span class="op" id="1726152">!=</span>&nbsp;<span class="ident" id="1726155">nil</span>&nbsp;<span class="op" id="1726159">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726163">gothrow</span><span class="op" id="1726170">(</span><span class="string" id="1726171">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1726200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726206">oldbuckets</span>&nbsp;<span class="op" id="1726217">:=</span>&nbsp;<span class="ident" id="1726220">h</span><span class="op" id="1726221">.</span><span class="ident" id="1726222">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726231">if</span>&nbsp;<span class="ident" id="1726234">checkgc</span>&nbsp;<span class="op" id="1726242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726246">memstats</span><span class="op" id="1726254">.</span><span class="ident" id="1726255">next_gc</span>&nbsp;<span class="op" id="1726263">=</span>&nbsp;<span class="ident" id="1726265">memstats</span><span class="op" id="1726273">.</span><span class="ident" id="1726274">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726289">newbuckets</span>&nbsp;<span class="op" id="1726300">:=</span>&nbsp;<span class="ident" id="1726303">newarray</span><span class="op" id="1726311">(</span><span class="ident" id="1726312">t</span><span class="op" id="1726313">.</span><span class="ident" id="1726314">bucket</span><span class="op" id="1726320">,</span>&nbsp;<span class="builtintype" id="1726322">uintptr</span><span class="op" id="1726329">(</span><span class="num" id="1726330">1</span><span class="op" id="1726331">)</span><span class="op" id="1726332">&lt;&lt;</span><span class="op" id="1726334">(</span><span class="ident" id="1726335">h</span><span class="op" id="1726336">.</span><span class="ident" id="1726337">B</span><span class="op" id="1726338">+</span><span class="num" id="1726339">1</span><span class="op" id="1726340">)</span><span class="op" id="1726341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726344">flags</span>&nbsp;<span class="op" id="1726350">:=</span>&nbsp;<span class="ident" id="1726353">h</span><span class="op" id="1726354">.</span><span class="ident" id="1726355">flags</span>&nbsp;<span class="op" id="1726361">&amp;^</span>&nbsp;<span class="op" id="1726364">(</span><span class="ident" id="1726365">iterator</span>&nbsp;<span class="op" id="1726374">|</span>&nbsp;<span class="ident" id="1726376">oldIterator</span><span class="op" id="1726387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726390">if</span>&nbsp;<span class="ident" id="1726393">h</span><span class="op" id="1726394">.</span><span class="ident" id="1726395">flags</span><span class="op" id="1726400">&amp;</span><span class="ident" id="1726401">iterator</span>&nbsp;<span class="op" id="1726410">!=</span>&nbsp;<span class="num" id="1726413">0</span>&nbsp;<span class="op" id="1726415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726419">flags</span>&nbsp;<span class="op" id="1726425">|=</span>&nbsp;<span class="ident" id="1726428">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1726441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726444">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726480">h</span><span class="op" id="1726481">.</span><span class="ident" id="1726482">B</span><span class="op" id="1726483">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726487">h</span><span class="op" id="1726488">.</span><span class="ident" id="1726489">flags</span>&nbsp;<span class="op" id="1726495">=</span>&nbsp;<span class="ident" id="1726497">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726504">h</span><span class="op" id="1726505">.</span><span class="ident" id="1726506">oldbuckets</span>&nbsp;<span class="op" id="1726517">=</span>&nbsp;<span class="ident" id="1726519">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726531">h</span><span class="op" id="1726532">.</span><span class="ident" id="1726533">buckets</span>&nbsp;<span class="op" id="1726541">=</span>&nbsp;<span class="ident" id="1726543">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726555">h</span><span class="op" id="1726556">.</span><span class="ident" id="1726557">nevacuate</span>&nbsp;<span class="op" id="1726567">=</span>&nbsp;<span class="num" id="1726569">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726573">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726641">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1726674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1726677">func</span>&nbsp;<span class="ident" id="1726682">growWork</span><span class="op" id="1726690">(</span><span class="ident" id="1726691">t</span>&nbsp;<span class="op" id="1726693">*</span><span class="ident" id="1726694">maptype</span><span class="op" id="1726701">,</span>&nbsp;<span class="ident" id="1726703">h</span>&nbsp;<span class="op" id="1726705">*</span><span class="ident" id="1726706">hmap</span><span class="op" id="1726710">,</span>&nbsp;<span class="ident" id="1726712">bucket</span>&nbsp;<span class="builtintype" id="1726719">uintptr</span><span class="op" id="1726726">)</span>&nbsp;<span class="op" id="1726728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726731">noldbuckets</span>&nbsp;<span class="op" id="1726743">:=</span>&nbsp;<span class="builtintype" id="1726746">uintptr</span><span class="op" id="1726753">(</span><span class="num" id="1726754">1</span><span class="op" id="1726755">)</span>&nbsp;<span class="op" id="1726757">&lt;&lt;</span>&nbsp;<span class="op" id="1726760">(</span><span class="ident" id="1726761">h</span><span class="op" id="1726762">.</span><span class="ident" id="1726763">B</span>&nbsp;<span class="op" id="1726765">-</span>&nbsp;<span class="num" id="1726767">1</span><span class="op" id="1726768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726772">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726826">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726863">evacuate</span><span class="op" id="1726871">(</span><span class="ident" id="1726872">t</span><span class="op" id="1726873">,</span>&nbsp;<span class="ident" id="1726875">h</span><span class="op" id="1726876">,</span>&nbsp;<span class="ident" id="1726878">bucket</span><span class="op" id="1726884">&amp;</span><span class="op" id="1726885">(</span><span class="ident" id="1726886">noldbuckets</span><span class="op" id="1726897">-</span><span class="num" id="1726898">1</span><span class="op" id="1726899">)</span><span class="op" id="1726900">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1726904">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1726964">if</span>&nbsp;<span class="ident" id="1726967">h</span><span class="op" id="1726968">.</span><span class="ident" id="1726969">oldbuckets</span>&nbsp;<span class="op" id="1726980">!=</span>&nbsp;<span class="ident" id="1726983">nil</span>&nbsp;<span class="op" id="1726987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1726991">evacuate</span><span class="op" id="1726999">(</span><span class="ident" id="1727000">t</span><span class="op" id="1727001">,</span>&nbsp;<span class="ident" id="1727003">h</span><span class="op" id="1727004">,</span>&nbsp;<span class="ident" id="1727006">h</span><span class="op" id="1727007">.</span><span class="ident" id="1727008">nevacuate</span><span class="op" id="1727017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1727020">}</span><br>
<span class="lineno"></span><span class="op" id="1727022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1727025">func</span>&nbsp;<span class="ident" id="1727030">evacuate</span><span class="op" id="1727038">(</span><span class="ident" id="1727039">t</span>&nbsp;<span class="op" id="1727041">*</span><span class="ident" id="1727042">maptype</span><span class="op" id="1727049">,</span>&nbsp;<span class="ident" id="1727051">h</span>&nbsp;<span class="op" id="1727053">*</span><span class="ident" id="1727054">hmap</span><span class="op" id="1727058">,</span>&nbsp;<span class="ident" id="1727060">oldbucket</span>&nbsp;<span class="builtintype" id="1727070">uintptr</span><span class="op" id="1727077">)</span>&nbsp;<span class="op" id="1727079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727082">b</span>&nbsp;<span class="op" id="1727084">:=</span>&nbsp;<span class="op" id="1727087">(</span><span class="op" id="1727088">*</span><span class="ident" id="1727089">bmap</span><span class="op" id="1727093">)</span><span class="op" id="1727094">(</span><span class="ident" id="1727095">add</span><span class="op" id="1727098">(</span><span class="ident" id="1727099">h</span><span class="op" id="1727100">.</span><span class="ident" id="1727101">oldbuckets</span><span class="op" id="1727111">,</span>&nbsp;<span class="ident" id="1727113">oldbucket</span><span class="op" id="1727122">*</span><span class="builtintype" id="1727123">uintptr</span><span class="op" id="1727130">(</span><span class="ident" id="1727131">t</span><span class="op" id="1727132">.</span><span class="ident" id="1727133">bucketsize</span><span class="op" id="1727143">)</span><span class="op" id="1727144">)</span><span class="op" id="1727145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727148">newbit</span>&nbsp;<span class="op" id="1727155">:=</span>&nbsp;<span class="builtintype" id="1727158">uintptr</span><span class="op" id="1727165">(</span><span class="num" id="1727166">1</span><span class="op" id="1727167">)</span>&nbsp;<span class="op" id="1727169">&lt;&lt;</span>&nbsp;<span class="op" id="1727172">(</span><span class="ident" id="1727173">h</span><span class="op" id="1727174">.</span><span class="ident" id="1727175">B</span>&nbsp;<span class="op" id="1727177">-</span>&nbsp;<span class="num" id="1727179">1</span><span class="op" id="1727180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727183">alg</span>&nbsp;<span class="op" id="1727187">:=</span>&nbsp;<span class="ident" id="1727190">goalg</span><span class="op" id="1727195">(</span><span class="ident" id="1727196">t</span><span class="op" id="1727197">.</span><span class="ident" id="1727198">key</span><span class="op" id="1727201">.</span><span class="ident" id="1727202">alg</span><span class="op" id="1727205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727208">if</span>&nbsp;<span class="op" id="1727211">!</span><span class="ident" id="1727212">evacuated</span><span class="op" id="1727221">(</span><span class="ident" id="1727222">b</span><span class="op" id="1727223">)</span>&nbsp;<span class="op" id="1727225">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727229">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1727299">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727363">x</span>&nbsp;<span class="op" id="1727365">:=</span>&nbsp;<span class="op" id="1727368">(</span><span class="op" id="1727369">*</span><span class="ident" id="1727370">bmap</span><span class="op" id="1727374">)</span><span class="op" id="1727375">(</span><span class="ident" id="1727376">add</span><span class="op" id="1727379">(</span><span class="ident" id="1727380">h</span><span class="op" id="1727381">.</span><span class="ident" id="1727382">buckets</span><span class="op" id="1727389">,</span>&nbsp;<span class="ident" id="1727391">oldbucket</span><span class="op" id="1727400">*</span><span class="builtintype" id="1727401">uintptr</span><span class="op" id="1727408">(</span><span class="ident" id="1727409">t</span><span class="op" id="1727410">.</span><span class="ident" id="1727411">bucketsize</span><span class="op" id="1727421">)</span><span class="op" id="1727422">)</span><span class="op" id="1727423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727427">y</span>&nbsp;<span class="op" id="1727429">:=</span>&nbsp;<span class="op" id="1727432">(</span><span class="op" id="1727433">*</span><span class="ident" id="1727434">bmap</span><span class="op" id="1727438">)</span><span class="op" id="1727439">(</span><span class="ident" id="1727440">add</span><span class="op" id="1727443">(</span><span class="ident" id="1727444">h</span><span class="op" id="1727445">.</span><span class="ident" id="1727446">buckets</span><span class="op" id="1727453">,</span>&nbsp;<span class="op" id="1727455">(</span><span class="ident" id="1727456">oldbucket</span><span class="op" id="1727465">+</span><span class="ident" id="1727466">newbit</span><span class="op" id="1727472">)</span><span class="op" id="1727473">*</span><span class="builtintype" id="1727474">uintptr</span><span class="op" id="1727481">(</span><span class="ident" id="1727482">t</span><span class="op" id="1727483">.</span><span class="ident" id="1727484">bucketsize</span><span class="op" id="1727494">)</span><span class="op" id="1727495">)</span><span class="op" id="1727496">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727500">xi</span>&nbsp;<span class="op" id="1727503">:=</span>&nbsp;<span class="num" id="1727506">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727510">yi</span>&nbsp;<span class="op" id="1727513">:=</span>&nbsp;<span class="num" id="1727516">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727520">xk</span>&nbsp;<span class="op" id="1727523">:=</span>&nbsp;<span class="ident" id="1727526">add</span><span class="op" id="1727529">(</span><span class="ident" id="1727530">unsafe</span><span class="op" id="1727536">.</span><span class="ident" id="1727537">Pointer</span><span class="op" id="1727544">(</span><span class="ident" id="1727545">x</span><span class="op" id="1727546">)</span><span class="op" id="1727547">,</span>&nbsp;<span class="ident" id="1727549">dataOffset</span><span class="op" id="1727559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727563">yk</span>&nbsp;<span class="op" id="1727566">:=</span>&nbsp;<span class="ident" id="1727569">add</span><span class="op" id="1727572">(</span><span class="ident" id="1727573">unsafe</span><span class="op" id="1727579">.</span><span class="ident" id="1727580">Pointer</span><span class="op" id="1727587">(</span><span class="ident" id="1727588">y</span><span class="op" id="1727589">)</span><span class="op" id="1727590">,</span>&nbsp;<span class="ident" id="1727592">dataOffset</span><span class="op" id="1727602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727606">xv</span>&nbsp;<span class="op" id="1727609">:=</span>&nbsp;<span class="ident" id="1727612">add</span><span class="op" id="1727615">(</span><span class="ident" id="1727616">xk</span><span class="op" id="1727618">,</span>&nbsp;<span class="ident" id="1727620">bucketCnt</span><span class="op" id="1727629">*</span><span class="builtintype" id="1727630">uintptr</span><span class="op" id="1727637">(</span><span class="ident" id="1727638">t</span><span class="op" id="1727639">.</span><span class="ident" id="1727640">keysize</span><span class="op" id="1727647">)</span><span class="op" id="1727648">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727652">yv</span>&nbsp;<span class="op" id="1727655">:=</span>&nbsp;<span class="ident" id="1727658">add</span><span class="op" id="1727661">(</span><span class="ident" id="1727662">yk</span><span class="op" id="1727664">,</span>&nbsp;<span class="ident" id="1727666">bucketCnt</span><span class="op" id="1727675">*</span><span class="builtintype" id="1727676">uintptr</span><span class="op" id="1727683">(</span><span class="ident" id="1727684">t</span><span class="op" id="1727685">.</span><span class="ident" id="1727686">keysize</span><span class="op" id="1727693">)</span><span class="op" id="1727694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727698">for</span>&nbsp;<span class="op" id="1727702">;</span>&nbsp;<span class="ident" id="1727704">b</span>&nbsp;<span class="op" id="1727706">!=</span>&nbsp;<span class="ident" id="1727709">nil</span><span class="op" id="1727712">;</span>&nbsp;<span class="ident" id="1727714">b</span>&nbsp;<span class="op" id="1727716">=</span>&nbsp;<span class="ident" id="1727718">b</span><span class="op" id="1727719">.</span><span class="ident" id="1727720">overflow</span>&nbsp;<span class="op" id="1727729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727734">k</span>&nbsp;<span class="op" id="1727736">:=</span>&nbsp;<span class="ident" id="1727739">add</span><span class="op" id="1727742">(</span><span class="ident" id="1727743">unsafe</span><span class="op" id="1727749">.</span><span class="ident" id="1727750">Pointer</span><span class="op" id="1727757">(</span><span class="ident" id="1727758">b</span><span class="op" id="1727759">)</span><span class="op" id="1727760">,</span>&nbsp;<span class="ident" id="1727762">dataOffset</span><span class="op" id="1727772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727777">v</span>&nbsp;<span class="op" id="1727779">:=</span>&nbsp;<span class="ident" id="1727782">add</span><span class="op" id="1727785">(</span><span class="ident" id="1727786">k</span><span class="op" id="1727787">,</span>&nbsp;<span class="ident" id="1727789">bucketCnt</span><span class="op" id="1727798">*</span><span class="builtintype" id="1727799">uintptr</span><span class="op" id="1727806">(</span><span class="ident" id="1727807">t</span><span class="op" id="1727808">.</span><span class="ident" id="1727809">keysize</span><span class="op" id="1727816">)</span><span class="op" id="1727817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727822">for</span>&nbsp;<span class="ident" id="1727826">i</span>&nbsp;<span class="op" id="1727828">:=</span>&nbsp;<span class="num" id="1727831">0</span><span class="op" id="1727832">;</span>&nbsp;<span class="ident" id="1727834">i</span>&nbsp;<span class="op" id="1727836">&lt;</span>&nbsp;<span class="ident" id="1727838">bucketCnt</span><span class="op" id="1727847">;</span>&nbsp;<span class="ident" id="1727849">i</span><span class="op" id="1727850">,</span>&nbsp;<span class="ident" id="1727852">k</span><span class="op" id="1727853">,</span>&nbsp;<span class="ident" id="1727855">v</span>&nbsp;<span class="op" id="1727857">=</span>&nbsp;<span class="ident" id="1727859">i</span><span class="op" id="1727860">+</span><span class="num" id="1727861">1</span><span class="op" id="1727862">,</span>&nbsp;<span class="ident" id="1727864">add</span><span class="op" id="1727867">(</span><span class="ident" id="1727868">k</span><span class="op" id="1727869">,</span>&nbsp;<span class="builtintype" id="1727871">uintptr</span><span class="op" id="1727878">(</span><span class="ident" id="1727879">t</span><span class="op" id="1727880">.</span><span class="ident" id="1727881">keysize</span><span class="op" id="1727888">)</span><span class="op" id="1727889">)</span><span class="op" id="1727890">,</span>&nbsp;<span class="ident" id="1727892">add</span><span class="op" id="1727895">(</span><span class="ident" id="1727896">v</span><span class="op" id="1727897">,</span>&nbsp;<span class="builtintype" id="1727899">uintptr</span><span class="op" id="1727906">(</span><span class="ident" id="1727907">t</span><span class="op" id="1727908">.</span><span class="ident" id="1727909">valuesize</span><span class="op" id="1727918">)</span><span class="op" id="1727919">)</span>&nbsp;<span class="op" id="1727921">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727927">top</span>&nbsp;<span class="op" id="1727931">:=</span>&nbsp;<span class="ident" id="1727934">b</span><span class="op" id="1727935">.</span><span class="ident" id="1727936">tophash</span><span class="op" id="1727943">[</span><span class="ident" id="1727944">i</span><span class="op" id="1727945">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1727951">if</span>&nbsp;<span class="ident" id="1727954">top</span>&nbsp;<span class="op" id="1727958">==</span>&nbsp;<span class="ident" id="1727961">empty</span>&nbsp;<span class="op" id="1727967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1727974">b</span><span class="op" id="1727975">.</span><span class="ident" id="1727976">tophash</span><span class="op" id="1727983">[</span><span class="ident" id="1727984">i</span><span class="op" id="1727985">]</span>&nbsp;<span class="op" id="1727987">=</span>&nbsp;<span class="ident" id="1727989">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728009">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728022">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728028">if</span>&nbsp;<span class="ident" id="1728031">top</span>&nbsp;<span class="op" id="1728035">&lt;</span>&nbsp;<span class="ident" id="1728037">minTopHash</span>&nbsp;<span class="op" id="1728048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728055">gothrow</span><span class="op" id="1728062">(</span><span class="string" id="1728063">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1728078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728090">k2</span>&nbsp;<span class="op" id="1728093">:=</span>&nbsp;<span class="ident" id="1728096">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728102">if</span>&nbsp;<span class="ident" id="1728105">t</span><span class="op" id="1728106">.</span><span class="ident" id="1728107">indirectkey</span>&nbsp;<span class="op" id="1728119">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728126">k2</span>&nbsp;<span class="op" id="1728129">=</span>&nbsp;<span class="op" id="1728131">*</span><span class="op" id="1728132">(</span><span class="op" id="1728133">(</span><span class="op" id="1728134">*</span><span class="ident" id="1728135">unsafe</span><span class="op" id="1728141">.</span><span class="ident" id="1728142">Pointer</span><span class="op" id="1728149">)</span><span class="op" id="1728150">(</span><span class="ident" id="1728151">k2</span><span class="op" id="1728153">)</span><span class="op" id="1728154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1728160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728166">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728235">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1728291">hash</span>&nbsp;<span class="op" id="1728296">:=</span>&nbsp;<span class="ident" id="1728299">alg</span><span class="op" id="1728302">.</span><span class="ident" id="1728303">hash</span><span class="op" id="1728307">(</span><span class="ident" id="1728308">k2</span><span class="op" id="1728310">,</span>&nbsp;<span class="builtintype" id="1728312">uintptr</span><span class="op" id="1728319">(</span><span class="ident" id="1728320">t</span><span class="op" id="1728321">.</span><span class="ident" id="1728322">key</span><span class="op" id="1728325">.</span><span class="ident" id="1728326">size</span><span class="op" id="1728330">)</span><span class="op" id="1728331">,</span>&nbsp;<span class="builtintype" id="1728333">uintptr</span><span class="op" id="1728340">(</span><span class="ident" id="1728341">h</span><span class="op" id="1728342">.</span><span class="ident" id="1728343">hash0</span><span class="op" id="1728348">)</span><span class="op" id="1728349">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728355">if</span>&nbsp;<span class="ident" id="1728358">h</span><span class="op" id="1728359">.</span><span class="ident" id="1728360">flags</span><span class="op" id="1728365">&amp;</span><span class="ident" id="1728366">iterator</span>&nbsp;<span class="op" id="1728375">!=</span>&nbsp;<span class="num" id="1728378">0</span>&nbsp;<span class="op" id="1728380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1728387">if</span>&nbsp;<span class="op" id="1728390">!</span><span class="ident" id="1728391">alg</span><span class="op" id="1728394">.</span><span class="ident" id="1728395">equal</span><span class="op" id="1728400">(</span><span class="ident" id="1728401">k2</span><span class="op" id="1728403">,</span>&nbsp;<span class="ident" id="1728405">k2</span><span class="op" id="1728407">,</span>&nbsp;<span class="builtintype" id="1728409">uintptr</span><span class="op" id="1728416">(</span><span class="ident" id="1728417">t</span><span class="op" id="1728418">.</span><span class="ident" id="1728419">key</span><span class="op" id="1728422">.</span><span class="ident" id="1728423">size</span><span class="op" id="1728427">)</span><span class="op" id="1728428">)</span>&nbsp;<span class="op" id="1728430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728438">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728506">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728573">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728641">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728705">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728757">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728825">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728894">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1728964">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1729029">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1729096">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729127">if</span>&nbsp;<span class="op" id="1729130">(</span><span class="ident" id="1729131">top</span>&nbsp;<span class="op" id="1729135">&amp;</span>&nbsp;<span class="num" id="1729137">1</span><span class="op" id="1729138">)</span>&nbsp;<span class="op" id="1729140">!=</span>&nbsp;<span class="num" id="1729143">0</span>&nbsp;<span class="op" id="1729145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729154">hash</span>&nbsp;<span class="op" id="1729159">|=</span>&nbsp;<span class="ident" id="1729162">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729175">}</span>&nbsp;<span class="keyword" id="1729177">else</span>&nbsp;<span class="op" id="1729182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729191">hash</span>&nbsp;<span class="op" id="1729196">&amp;^=</span>&nbsp;<span class="ident" id="1729200">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729221">top</span>&nbsp;<span class="op" id="1729225">=</span>&nbsp;<span class="builtintype" id="1729227">uint8</span><span class="op" id="1729232">(</span><span class="ident" id="1729233">hash</span>&nbsp;<span class="op" id="1729238">&gt;&gt;</span>&nbsp;<span class="op" id="1729241">(</span><span class="ident" id="1729242">ptrSize</span><span class="op" id="1729249">*</span><span class="num" id="1729250">8</span>&nbsp;<span class="op" id="1729252">-</span>&nbsp;<span class="num" id="1729254">8</span><span class="op" id="1729255">)</span><span class="op" id="1729256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729264">if</span>&nbsp;<span class="ident" id="1729267">top</span>&nbsp;<span class="op" id="1729271">&lt;</span>&nbsp;<span class="ident" id="1729273">minTopHash</span>&nbsp;<span class="op" id="1729284">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729293">top</span>&nbsp;<span class="op" id="1729297">+=</span>&nbsp;<span class="ident" id="1729300">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729336">if</span>&nbsp;<span class="op" id="1729339">(</span><span class="ident" id="1729340">hash</span>&nbsp;<span class="op" id="1729345">&amp;</span>&nbsp;<span class="ident" id="1729347">newbit</span><span class="op" id="1729353">)</span>&nbsp;<span class="op" id="1729355">==</span>&nbsp;<span class="num" id="1729358">0</span>&nbsp;<span class="op" id="1729360">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729367">b</span><span class="op" id="1729368">.</span><span class="ident" id="1729369">tophash</span><span class="op" id="1729376">[</span><span class="ident" id="1729377">i</span><span class="op" id="1729378">]</span>&nbsp;<span class="op" id="1729380">=</span>&nbsp;<span class="ident" id="1729382">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729398">if</span>&nbsp;<span class="ident" id="1729401">xi</span>&nbsp;<span class="op" id="1729404">==</span>&nbsp;<span class="ident" id="1729407">bucketCnt</span>&nbsp;<span class="op" id="1729417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729425">if</span>&nbsp;<span class="ident" id="1729428">checkgc</span>&nbsp;<span class="op" id="1729436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729445">memstats</span><span class="op" id="1729453">.</span><span class="ident" id="1729454">next_gc</span>&nbsp;<span class="op" id="1729462">=</span>&nbsp;<span class="ident" id="1729464">memstats</span><span class="op" id="1729472">.</span><span class="ident" id="1729473">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729490">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729498">newx</span>&nbsp;<span class="op" id="1729503">:=</span>&nbsp;<span class="op" id="1729506">(</span><span class="op" id="1729507">*</span><span class="ident" id="1729508">bmap</span><span class="op" id="1729512">)</span><span class="op" id="1729513">(</span><span class="ident" id="1729514">newobject</span><span class="op" id="1729523">(</span><span class="ident" id="1729524">t</span><span class="op" id="1729525">.</span><span class="ident" id="1729526">bucket</span><span class="op" id="1729532">)</span><span class="op" id="1729533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729541">x</span><span class="op" id="1729542">.</span><span class="ident" id="1729543">overflow</span>&nbsp;<span class="op" id="1729552">=</span>&nbsp;<span class="ident" id="1729554">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729565">x</span>&nbsp;<span class="op" id="1729567">=</span>&nbsp;<span class="ident" id="1729569">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729580">xi</span>&nbsp;<span class="op" id="1729583">=</span>&nbsp;<span class="num" id="1729585">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729593">xk</span>&nbsp;<span class="op" id="1729596">=</span>&nbsp;<span class="ident" id="1729598">add</span><span class="op" id="1729601">(</span><span class="ident" id="1729602">unsafe</span><span class="op" id="1729608">.</span><span class="ident" id="1729609">Pointer</span><span class="op" id="1729616">(</span><span class="ident" id="1729617">x</span><span class="op" id="1729618">)</span><span class="op" id="1729619">,</span>&nbsp;<span class="ident" id="1729621">dataOffset</span><span class="op" id="1729631">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729639">xv</span>&nbsp;<span class="op" id="1729642">=</span>&nbsp;<span class="ident" id="1729644">add</span><span class="op" id="1729647">(</span><span class="ident" id="1729648">xk</span><span class="op" id="1729650">,</span>&nbsp;<span class="ident" id="1729652">bucketCnt</span><span class="op" id="1729661">*</span><span class="builtintype" id="1729662">uintptr</span><span class="op" id="1729669">(</span><span class="ident" id="1729670">t</span><span class="op" id="1729671">.</span><span class="ident" id="1729672">keysize</span><span class="op" id="1729679">)</span><span class="op" id="1729680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729694">x</span><span class="op" id="1729695">.</span><span class="ident" id="1729696">tophash</span><span class="op" id="1729703">[</span><span class="ident" id="1729704">xi</span><span class="op" id="1729706">]</span>&nbsp;<span class="op" id="1729708">=</span>&nbsp;<span class="ident" id="1729710">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729719">if</span>&nbsp;<span class="ident" id="1729722">t</span><span class="op" id="1729723">.</span><span class="ident" id="1729724">indirectkey</span>&nbsp;<span class="op" id="1729736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729744">*</span><span class="op" id="1729745">(</span><span class="op" id="1729746">*</span><span class="ident" id="1729747">unsafe</span><span class="op" id="1729753">.</span><span class="ident" id="1729754">Pointer</span><span class="op" id="1729761">)</span><span class="op" id="1729762">(</span><span class="ident" id="1729763">xk</span><span class="op" id="1729765">)</span>&nbsp;<span class="op" id="1729767">=</span>&nbsp;<span class="ident" id="1729769">k2</span>&nbsp;<span class="comment" id="1729772">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729793">}</span>&nbsp;<span class="keyword" id="1729795">else</span>&nbsp;<span class="op" id="1729800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729808">memmove</span><span class="op" id="1729815">(</span><span class="ident" id="1729816">xk</span><span class="op" id="1729818">,</span>&nbsp;<span class="ident" id="1729820">k</span><span class="op" id="1729821">,</span>&nbsp;<span class="builtintype" id="1729823">uintptr</span><span class="op" id="1729830">(</span><span class="ident" id="1729831">t</span><span class="op" id="1729832">.</span><span class="ident" id="1729833">key</span><span class="op" id="1729836">.</span><span class="ident" id="1729837">size</span><span class="op" id="1729841">)</span><span class="op" id="1729842">)</span>&nbsp;<span class="comment" id="1729844">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1729870">if</span>&nbsp;<span class="ident" id="1729873">t</span><span class="op" id="1729874">.</span><span class="ident" id="1729875">indirectvalue</span>&nbsp;<span class="op" id="1729889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729897">*</span><span class="op" id="1729898">(</span><span class="op" id="1729899">*</span><span class="ident" id="1729900">unsafe</span><span class="op" id="1729906">.</span><span class="ident" id="1729907">Pointer</span><span class="op" id="1729914">)</span><span class="op" id="1729915">(</span><span class="ident" id="1729916">xv</span><span class="op" id="1729918">)</span>&nbsp;<span class="op" id="1729920">=</span>&nbsp;<span class="op" id="1729922">*</span><span class="op" id="1729923">(</span><span class="op" id="1729924">*</span><span class="ident" id="1729925">unsafe</span><span class="op" id="1729931">.</span><span class="ident" id="1729932">Pointer</span><span class="op" id="1729939">)</span><span class="op" id="1729940">(</span><span class="ident" id="1729941">v</span><span class="op" id="1729942">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1729949">}</span>&nbsp;<span class="keyword" id="1729951">else</span>&nbsp;<span class="op" id="1729956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1729964">memmove</span><span class="op" id="1729971">(</span><span class="ident" id="1729972">xv</span><span class="op" id="1729974">,</span>&nbsp;<span class="ident" id="1729976">v</span><span class="op" id="1729977">,</span>&nbsp;<span class="builtintype" id="1729979">uintptr</span><span class="op" id="1729986">(</span><span class="ident" id="1729987">t</span><span class="op" id="1729988">.</span><span class="ident" id="1729989">elem</span><span class="op" id="1729993">.</span><span class="ident" id="1729994">size</span><span class="op" id="1729998">)</span><span class="op" id="1729999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730013">xi</span><span class="op" id="1730015">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730023">xk</span>&nbsp;<span class="op" id="1730026">=</span>&nbsp;<span class="ident" id="1730028">add</span><span class="op" id="1730031">(</span><span class="ident" id="1730032">xk</span><span class="op" id="1730034">,</span>&nbsp;<span class="builtintype" id="1730036">uintptr</span><span class="op" id="1730043">(</span><span class="ident" id="1730044">t</span><span class="op" id="1730045">.</span><span class="ident" id="1730046">keysize</span><span class="op" id="1730053">)</span><span class="op" id="1730054">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730061">xv</span>&nbsp;<span class="op" id="1730064">=</span>&nbsp;<span class="ident" id="1730066">add</span><span class="op" id="1730069">(</span><span class="ident" id="1730070">xv</span><span class="op" id="1730072">,</span>&nbsp;<span class="builtintype" id="1730074">uintptr</span><span class="op" id="1730081">(</span><span class="ident" id="1730082">t</span><span class="op" id="1730083">.</span><span class="ident" id="1730084">valuesize</span><span class="op" id="1730093">)</span><span class="op" id="1730094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730100">}</span>&nbsp;<span class="keyword" id="1730102">else</span>&nbsp;<span class="op" id="1730107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730114">b</span><span class="op" id="1730115">.</span><span class="ident" id="1730116">tophash</span><span class="op" id="1730123">[</span><span class="ident" id="1730124">i</span><span class="op" id="1730125">]</span>&nbsp;<span class="op" id="1730127">=</span>&nbsp;<span class="ident" id="1730129">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730145">if</span>&nbsp;<span class="ident" id="1730148">yi</span>&nbsp;<span class="op" id="1730151">==</span>&nbsp;<span class="ident" id="1730154">bucketCnt</span>&nbsp;<span class="op" id="1730164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730172">if</span>&nbsp;<span class="ident" id="1730175">checkgc</span>&nbsp;<span class="op" id="1730183">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730192">memstats</span><span class="op" id="1730200">.</span><span class="ident" id="1730201">next_gc</span>&nbsp;<span class="op" id="1730209">=</span>&nbsp;<span class="ident" id="1730211">memstats</span><span class="op" id="1730219">.</span><span class="ident" id="1730220">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730245">newy</span>&nbsp;<span class="op" id="1730250">:=</span>&nbsp;<span class="op" id="1730253">(</span><span class="op" id="1730254">*</span><span class="ident" id="1730255">bmap</span><span class="op" id="1730259">)</span><span class="op" id="1730260">(</span><span class="ident" id="1730261">newobject</span><span class="op" id="1730270">(</span><span class="ident" id="1730271">t</span><span class="op" id="1730272">.</span><span class="ident" id="1730273">bucket</span><span class="op" id="1730279">)</span><span class="op" id="1730280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730288">y</span><span class="op" id="1730289">.</span><span class="ident" id="1730290">overflow</span>&nbsp;<span class="op" id="1730299">=</span>&nbsp;<span class="ident" id="1730301">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730312">y</span>&nbsp;<span class="op" id="1730314">=</span>&nbsp;<span class="ident" id="1730316">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730327">yi</span>&nbsp;<span class="op" id="1730330">=</span>&nbsp;<span class="num" id="1730332">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730340">yk</span>&nbsp;<span class="op" id="1730343">=</span>&nbsp;<span class="ident" id="1730345">add</span><span class="op" id="1730348">(</span><span class="ident" id="1730349">unsafe</span><span class="op" id="1730355">.</span><span class="ident" id="1730356">Pointer</span><span class="op" id="1730363">(</span><span class="ident" id="1730364">y</span><span class="op" id="1730365">)</span><span class="op" id="1730366">,</span>&nbsp;<span class="ident" id="1730368">dataOffset</span><span class="op" id="1730378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730386">yv</span>&nbsp;<span class="op" id="1730389">=</span>&nbsp;<span class="ident" id="1730391">add</span><span class="op" id="1730394">(</span><span class="ident" id="1730395">yk</span><span class="op" id="1730397">,</span>&nbsp;<span class="ident" id="1730399">bucketCnt</span><span class="op" id="1730408">*</span><span class="builtintype" id="1730409">uintptr</span><span class="op" id="1730416">(</span><span class="ident" id="1730417">t</span><span class="op" id="1730418">.</span><span class="ident" id="1730419">keysize</span><span class="op" id="1730426">)</span><span class="op" id="1730427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730441">y</span><span class="op" id="1730442">.</span><span class="ident" id="1730443">tophash</span><span class="op" id="1730450">[</span><span class="ident" id="1730451">yi</span><span class="op" id="1730453">]</span>&nbsp;<span class="op" id="1730455">=</span>&nbsp;<span class="ident" id="1730457">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730466">if</span>&nbsp;<span class="ident" id="1730469">t</span><span class="op" id="1730470">.</span><span class="ident" id="1730471">indirectkey</span>&nbsp;<span class="op" id="1730483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730491">*</span><span class="op" id="1730492">(</span><span class="op" id="1730493">*</span><span class="ident" id="1730494">unsafe</span><span class="op" id="1730500">.</span><span class="ident" id="1730501">Pointer</span><span class="op" id="1730508">)</span><span class="op" id="1730509">(</span><span class="ident" id="1730510">yk</span><span class="op" id="1730512">)</span>&nbsp;<span class="op" id="1730514">=</span>&nbsp;<span class="ident" id="1730516">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730524">}</span>&nbsp;<span class="keyword" id="1730526">else</span>&nbsp;<span class="op" id="1730531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730539">memmove</span><span class="op" id="1730546">(</span><span class="ident" id="1730547">yk</span><span class="op" id="1730549">,</span>&nbsp;<span class="ident" id="1730551">k</span><span class="op" id="1730552">,</span>&nbsp;<span class="builtintype" id="1730554">uintptr</span><span class="op" id="1730561">(</span><span class="ident" id="1730562">t</span><span class="op" id="1730563">.</span><span class="ident" id="1730564">key</span><span class="op" id="1730567">.</span><span class="ident" id="1730568">size</span><span class="op" id="1730572">)</span><span class="op" id="1730573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730580">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730587">if</span>&nbsp;<span class="ident" id="1730590">t</span><span class="op" id="1730591">.</span><span class="ident" id="1730592">indirectvalue</span>&nbsp;<span class="op" id="1730606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730614">*</span><span class="op" id="1730615">(</span><span class="op" id="1730616">*</span><span class="ident" id="1730617">unsafe</span><span class="op" id="1730623">.</span><span class="ident" id="1730624">Pointer</span><span class="op" id="1730631">)</span><span class="op" id="1730632">(</span><span class="ident" id="1730633">yv</span><span class="op" id="1730635">)</span>&nbsp;<span class="op" id="1730637">=</span>&nbsp;<span class="op" id="1730639">*</span><span class="op" id="1730640">(</span><span class="op" id="1730641">*</span><span class="ident" id="1730642">unsafe</span><span class="op" id="1730648">.</span><span class="ident" id="1730649">Pointer</span><span class="op" id="1730656">)</span><span class="op" id="1730657">(</span><span class="ident" id="1730658">v</span><span class="op" id="1730659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730666">}</span>&nbsp;<span class="keyword" id="1730668">else</span>&nbsp;<span class="op" id="1730673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730681">memmove</span><span class="op" id="1730688">(</span><span class="ident" id="1730689">yv</span><span class="op" id="1730691">,</span>&nbsp;<span class="ident" id="1730693">v</span><span class="op" id="1730694">,</span>&nbsp;<span class="builtintype" id="1730696">uintptr</span><span class="op" id="1730703">(</span><span class="ident" id="1730704">t</span><span class="op" id="1730705">.</span><span class="ident" id="1730706">elem</span><span class="op" id="1730710">.</span><span class="ident" id="1730711">size</span><span class="op" id="1730715">)</span><span class="op" id="1730716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730723">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730730">yi</span><span class="op" id="1730732">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730740">yk</span>&nbsp;<span class="op" id="1730743">=</span>&nbsp;<span class="ident" id="1730745">add</span><span class="op" id="1730748">(</span><span class="ident" id="1730749">yk</span><span class="op" id="1730751">,</span>&nbsp;<span class="builtintype" id="1730753">uintptr</span><span class="op" id="1730760">(</span><span class="ident" id="1730761">t</span><span class="op" id="1730762">.</span><span class="ident" id="1730763">keysize</span><span class="op" id="1730770">)</span><span class="op" id="1730771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730778">yv</span>&nbsp;<span class="op" id="1730781">=</span>&nbsp;<span class="ident" id="1730783">add</span><span class="op" id="1730786">(</span><span class="ident" id="1730787">yv</span><span class="op" id="1730789">,</span>&nbsp;<span class="builtintype" id="1730791">uintptr</span><span class="op" id="1730798">(</span><span class="ident" id="1730799">t</span><span class="op" id="1730800">.</span><span class="ident" id="1730801">valuesize</span><span class="op" id="1730810">)</span><span class="op" id="1730811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730822">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1730826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1730830">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1730893">if</span>&nbsp;<span class="ident" id="1730896">h</span><span class="op" id="1730897">.</span><span class="ident" id="1730898">flags</span><span class="op" id="1730903">&amp;</span><span class="ident" id="1730904">oldIterator</span>&nbsp;<span class="op" id="1730916">==</span>&nbsp;<span class="num" id="1730919">0</span>&nbsp;<span class="op" id="1730921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730926">b</span>&nbsp;<span class="op" id="1730928">=</span>&nbsp;<span class="op" id="1730930">(</span><span class="op" id="1730931">*</span><span class="ident" id="1730932">bmap</span><span class="op" id="1730936">)</span><span class="op" id="1730937">(</span><span class="ident" id="1730938">add</span><span class="op" id="1730941">(</span><span class="ident" id="1730942">h</span><span class="op" id="1730943">.</span><span class="ident" id="1730944">oldbuckets</span><span class="op" id="1730954">,</span>&nbsp;<span class="ident" id="1730956">oldbucket</span><span class="op" id="1730965">*</span><span class="builtintype" id="1730966">uintptr</span><span class="op" id="1730973">(</span><span class="ident" id="1730974">t</span><span class="op" id="1730975">.</span><span class="ident" id="1730976">bucketsize</span><span class="op" id="1730986">)</span><span class="op" id="1730987">)</span><span class="op" id="1730988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1730993">b</span><span class="op" id="1730994">.</span><span class="ident" id="1730995">overflow</span>&nbsp;<span class="op" id="1731004">=</span>&nbsp;<span class="ident" id="1731006">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731013">memclr</span><span class="op" id="1731019">(</span><span class="ident" id="1731020">add</span><span class="op" id="1731023">(</span><span class="ident" id="1731024">unsafe</span><span class="op" id="1731030">.</span><span class="ident" id="1731031">Pointer</span><span class="op" id="1731038">(</span><span class="ident" id="1731039">b</span><span class="op" id="1731040">)</span><span class="op" id="1731041">,</span>&nbsp;<span class="ident" id="1731043">dataOffset</span><span class="op" id="1731053">)</span><span class="op" id="1731054">,</span>&nbsp;<span class="builtintype" id="1731056">uintptr</span><span class="op" id="1731063">(</span><span class="ident" id="1731064">t</span><span class="op" id="1731065">.</span><span class="ident" id="1731066">bucketsize</span><span class="op" id="1731076">)</span><span class="op" id="1731077">-</span><span class="ident" id="1731078">dataOffset</span><span class="op" id="1731088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1731092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1731095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731099">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1731127">if</span>&nbsp;<span class="ident" id="1731130">oldbucket</span>&nbsp;<span class="op" id="1731140">==</span>&nbsp;<span class="ident" id="1731143">h</span><span class="op" id="1731144">.</span><span class="ident" id="1731145">nevacuate</span>&nbsp;<span class="op" id="1731155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731159">h</span><span class="op" id="1731160">.</span><span class="ident" id="1731161">nevacuate</span>&nbsp;<span class="op" id="1731171">=</span>&nbsp;<span class="ident" id="1731173">oldbucket</span>&nbsp;<span class="op" id="1731183">+</span>&nbsp;<span class="num" id="1731185">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1731189">if</span>&nbsp;<span class="ident" id="1731192">oldbucket</span><span class="op" id="1731201">+</span><span class="num" id="1731202">1</span>&nbsp;<span class="op" id="1731204">==</span>&nbsp;<span class="ident" id="1731207">newbit</span>&nbsp;<span class="op" id="1731214">{</span>&nbsp;<span class="comment" id="1731216">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731248">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731304">h</span><span class="op" id="1731305">.</span><span class="ident" id="1731306">oldbuckets</span>&nbsp;<span class="op" id="1731317">=</span>&nbsp;<span class="ident" id="1731319">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1731325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1731328">}</span><br>
<span class="lineno"></span><span class="op" id="1731330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1731333">func</span>&nbsp;<span class="ident" id="1731338">ismapkey</span><span class="op" id="1731346">(</span><span class="ident" id="1731347">t</span>&nbsp;<span class="op" id="1731349">*</span><span class="ident" id="1731350">_type</span><span class="op" id="1731355">)</span>&nbsp;<span class="builtintype" id="1731357">bool</span>&nbsp;<span class="op" id="1731362">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1731365">return</span>&nbsp;<span class="ident" id="1731372">goalg</span><span class="op" id="1731377">(</span><span class="ident" id="1731378">t</span><span class="op" id="1731379">.</span><span class="ident" id="1731380">alg</span><span class="op" id="1731383">)</span><span class="op" id="1731384">.</span><span class="ident" id="1731385">hash</span>&nbsp;<span class="op" id="1731390">!=</span>&nbsp;<span class="ident" id="1731393">nil</span><br>
<span class="lineno"></span><span class="op" id="1731397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1731400">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1731451">func</span>&nbsp;<span class="ident" id="1731456">reflect_makemap</span><span class="op" id="1731471">(</span><span class="ident" id="1731472">t</span>&nbsp;<span class="op" id="1731474">*</span><span class="ident" id="1731475">maptype</span><span class="op" id="1731482">)</span>&nbsp;<span class="op" id="1731484">*</span><span class="ident" id="1731485">hmap</span>&nbsp;<span class="op" id="1731490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1731493">return</span>&nbsp;<span class="ident" id="1731500">makemap</span><span class="op" id="1731507">(</span><span class="ident" id="1731508">t</span><span class="op" id="1731509">,</span>&nbsp;<span class="num" id="1731511">0</span><span class="op" id="1731512">)</span><br>
<span class="lineno"></span><span class="op" id="1731514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1731517">func</span>&nbsp;<span class="ident" id="1731522">reflect_mapaccess</span><span class="op" id="1731539">(</span><span class="ident" id="1731540">t</span>&nbsp;<span class="op" id="1731542">*</span><span class="ident" id="1731543">maptype</span><span class="op" id="1731550">,</span>&nbsp;<span class="ident" id="1731552">h</span>&nbsp;<span class="op" id="1731554">*</span><span class="ident" id="1731555">hmap</span><span class="op" id="1731559">,</span>&nbsp;<span class="ident" id="1731561">key</span>&nbsp;<span class="ident" id="1731565">unsafe</span><span class="op" id="1731571">.</span><span class="ident" id="1731572">Pointer</span><span class="op" id="1731579">)</span>&nbsp;<span class="ident" id="1731581">unsafe</span><span class="op" id="1731587">.</span><span class="ident" id="1731588">Pointer</span>&nbsp;<span class="op" id="1731596">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731599">val</span><span class="op" id="1731602">,</span>&nbsp;<span class="ident" id="1731604">ok</span>&nbsp;<span class="op" id="1731607">:=</span>&nbsp;<span class="ident" id="1731610">mapaccess2</span><span class="op" id="1731620">(</span><span class="ident" id="1731621">t</span><span class="op" id="1731622">,</span>&nbsp;<span class="ident" id="1731624">h</span><span class="op" id="1731625">,</span>&nbsp;<span class="ident" id="1731627">key</span><span class="op" id="1731630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1731633">if</span>&nbsp;<span class="op" id="1731636">!</span><span class="ident" id="1731637">ok</span>&nbsp;<span class="op" id="1731640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1731644">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731689">val</span>&nbsp;<span class="op" id="1731693">=</span>&nbsp;<span class="ident" id="1731695">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1731700">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1731703">return</span>&nbsp;<span class="ident" id="1731710">val</span><br>
<span class="lineno"></span><span class="op" id="1731714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1731717">func</span>&nbsp;<span class="ident" id="1731722">reflect_mapassign</span><span class="op" id="1731739">(</span><span class="ident" id="1731740">t</span>&nbsp;<span class="op" id="1731742">*</span><span class="ident" id="1731743">maptype</span><span class="op" id="1731750">,</span>&nbsp;<span class="ident" id="1731752">h</span>&nbsp;<span class="op" id="1731754">*</span><span class="ident" id="1731755">hmap</span><span class="op" id="1731759">,</span>&nbsp;<span class="ident" id="1731761">key</span>&nbsp;<span class="ident" id="1731765">unsafe</span><span class="op" id="1731771">.</span><span class="ident" id="1731772">Pointer</span><span class="op" id="1731779">,</span>&nbsp;<span class="ident" id="1731781">val</span>&nbsp;<span class="ident" id="1731785">unsafe</span><span class="op" id="1731791">.</span><span class="ident" id="1731792">Pointer</span><span class="op" id="1731799">)</span>&nbsp;<span class="op" id="1731801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731804">mapassign1</span><span class="op" id="1731814">(</span><span class="ident" id="1731815">t</span><span class="op" id="1731816">,</span>&nbsp;<span class="ident" id="1731818">h</span><span class="op" id="1731819">,</span>&nbsp;<span class="ident" id="1731821">key</span><span class="op" id="1731824">,</span>&nbsp;<span class="ident" id="1731826">val</span><span class="op" id="1731829">)</span><br>
<span class="lineno">920</span><span class="op" id="1731831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1731834">func</span>&nbsp;<span class="ident" id="1731839">reflect_mapdelete</span><span class="op" id="1731856">(</span><span class="ident" id="1731857">t</span>&nbsp;<span class="op" id="1731859">*</span><span class="ident" id="1731860">maptype</span><span class="op" id="1731867">,</span>&nbsp;<span class="ident" id="1731869">h</span>&nbsp;<span class="op" id="1731871">*</span><span class="ident" id="1731872">hmap</span><span class="op" id="1731876">,</span>&nbsp;<span class="ident" id="1731878">key</span>&nbsp;<span class="ident" id="1731882">unsafe</span><span class="op" id="1731888">.</span><span class="ident" id="1731889">Pointer</span><span class="op" id="1731896">)</span>&nbsp;<span class="op" id="1731898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731901">mapdelete</span><span class="op" id="1731910">(</span><span class="ident" id="1731911">t</span><span class="op" id="1731912">,</span>&nbsp;<span class="ident" id="1731914">h</span><span class="op" id="1731915">,</span>&nbsp;<span class="ident" id="1731917">key</span><span class="op" id="1731920">)</span><br>
<span class="lineno"></span><span class="op" id="1731922">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1731925">func</span>&nbsp;<span class="ident" id="1731930">reflect_mapiterinit</span><span class="op" id="1731949">(</span><span class="ident" id="1731950">t</span>&nbsp;<span class="op" id="1731952">*</span><span class="ident" id="1731953">maptype</span><span class="op" id="1731960">,</span>&nbsp;<span class="ident" id="1731962">h</span>&nbsp;<span class="op" id="1731964">*</span><span class="ident" id="1731965">hmap</span><span class="op" id="1731969">)</span>&nbsp;<span class="op" id="1731971">*</span><span class="ident" id="1731972">hiter</span>&nbsp;<span class="op" id="1731978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731981">it</span>&nbsp;<span class="op" id="1731984">:=</span>&nbsp;<span class="builtinfunc" id="1731987">new</span><span class="op" id="1731990">(</span><span class="ident" id="1731991">hiter</span><span class="op" id="1731996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1731999">mapiterinit</span><span class="op" id="1732010">(</span><span class="ident" id="1732011">t</span><span class="op" id="1732012">,</span>&nbsp;<span class="ident" id="1732014">h</span><span class="op" id="1732015">,</span>&nbsp;<span class="ident" id="1732017">it</span><span class="op" id="1732019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732022">return</span>&nbsp;<span class="ident" id="1732029">it</span><br>
<span class="lineno">930</span><span class="op" id="1732032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1732035">func</span>&nbsp;<span class="ident" id="1732040">reflect_mapiternext</span><span class="op" id="1732059">(</span><span class="ident" id="1732060">it</span>&nbsp;<span class="op" id="1732063">*</span><span class="ident" id="1732064">hiter</span><span class="op" id="1732069">)</span>&nbsp;<span class="op" id="1732071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1732074">mapiternext</span><span class="op" id="1732085">(</span><span class="ident" id="1732086">it</span><span class="op" id="1732088">)</span><br>
<span class="lineno"></span><span class="op" id="1732090">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1732093">func</span>&nbsp;<span class="ident" id="1732098">reflect_mapiterkey</span><span class="op" id="1732116">(</span><span class="ident" id="1732117">it</span>&nbsp;<span class="op" id="1732120">*</span><span class="ident" id="1732121">hiter</span><span class="op" id="1732126">)</span>&nbsp;<span class="ident" id="1732128">unsafe</span><span class="op" id="1732134">.</span><span class="ident" id="1732135">Pointer</span>&nbsp;<span class="op" id="1732143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732146">return</span>&nbsp;<span class="ident" id="1732153">it</span><span class="op" id="1732155">.</span><span class="ident" id="1732156">key</span><br>
<span class="lineno"></span><span class="op" id="1732160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1732163">func</span>&nbsp;<span class="ident" id="1732168">reflect_maplen</span><span class="op" id="1732182">(</span><span class="ident" id="1732183">h</span>&nbsp;<span class="op" id="1732185">*</span><span class="ident" id="1732186">hmap</span><span class="op" id="1732190">)</span>&nbsp;<span class="builtintype" id="1732192">int</span>&nbsp;<span class="op" id="1732196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732199">if</span>&nbsp;<span class="ident" id="1732202">h</span>&nbsp;<span class="op" id="1732204">==</span>&nbsp;<span class="ident" id="1732207">nil</span>&nbsp;<span class="op" id="1732211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732215">return</span>&nbsp;<span class="num" id="1732222">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1732225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732228">if</span>&nbsp;<span class="ident" id="1732231">raceenabled</span>&nbsp;<span class="op" id="1732243">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1732247">callerpc</span>&nbsp;<span class="op" id="1732256">:=</span>&nbsp;<span class="ident" id="1732259">getcallerpc</span><span class="op" id="1732270">(</span><span class="ident" id="1732271">unsafe</span><span class="op" id="1732277">.</span><span class="ident" id="1732278">Pointer</span><span class="op" id="1732285">(</span><span class="op" id="1732286">&amp;</span><span class="ident" id="1732287">h</span><span class="op" id="1732288">)</span><span class="op" id="1732289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1732293">racereadpc</span><span class="op" id="1732303">(</span><span class="ident" id="1732304">unsafe</span><span class="op" id="1732310">.</span><span class="ident" id="1732311">Pointer</span><span class="op" id="1732318">(</span><span class="ident" id="1732319">h</span><span class="op" id="1732320">)</span><span class="op" id="1732321">,</span>&nbsp;<span class="ident" id="1732323">callerpc</span><span class="op" id="1732331">,</span>&nbsp;<span class="ident" id="1732333">funcPC</span><span class="op" id="1732339">(</span><span class="ident" id="1732340">reflect_maplen</span><span class="op" id="1732354">)</span><span class="op" id="1732355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1732358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732361">return</span>&nbsp;<span class="ident" id="1732368">h</span><span class="op" id="1732369">.</span><span class="ident" id="1732370">count</span><br>
<span class="lineno"></span><span class="op" id="1732376">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1732379">func</span>&nbsp;<span class="ident" id="1732384">reflect_ismapkey</span><span class="op" id="1732400">(</span><span class="ident" id="1732401">t</span>&nbsp;<span class="op" id="1732403">*</span><span class="ident" id="1732404">_type</span><span class="op" id="1732409">)</span>&nbsp;<span class="builtintype" id="1732411">bool</span>&nbsp;<span class="op" id="1732416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1732419">return</span>&nbsp;<span class="ident" id="1732426">ismapkey</span><span class="op" id="1732434">(</span><span class="ident" id="1732435">t</span><span class="op" id="1732436">)</span><br>
<span class="lineno"></span><span class="op" id="1732438">}</span>
</div>
</body>
</html>
