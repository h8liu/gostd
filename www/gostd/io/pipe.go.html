<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>io</h2>
<ul>
<li><a href="/gostd/io/io.go.html">io.go</a></li>
<li><a href="/gostd/io/io_test.go.html">io_test.go</a></li>
<li><a href="/gostd/io/multi.go.html">multi.go</a></li>
<li><a href="/gostd/io/multi_test.go.html">multi_test.go</a></li>
<li><a href="/gostd/io/pipe.go.html" class="current">pipe.go</a></li>
<li><a href="/gostd/io/pipe_test.go.html">pipe_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1432670">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1432725">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1432779">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1432830">//&nbsp;Pipe&nbsp;adapter&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1432885">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432923">package</span>&nbsp;<span class="ident" id="1432931">io</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1432935">import</span>&nbsp;<span class="op" id="1432942">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1432945">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1432955">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="1432962">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1432965">//&nbsp;ErrClosedPipe&nbsp;is&nbsp;the&nbsp;error&nbsp;used&nbsp;for&nbsp;read&nbsp;or&nbsp;write&nbsp;operations&nbsp;on&nbsp;a&nbsp;closed&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1433047">var</span>&nbsp;<span class="ident" id="1433051">ErrClosedPipe</span>&nbsp;<span class="op" id="1433065">=</span>&nbsp;<span class="ident" id="1433067">errors</span><span class="op" id="1433073">.</span><span class="ident" id="1433074">New</span><span class="op" id="1433077">(</span><span class="string" id="1433078">&#34;io:&nbsp;read/write&nbsp;on&nbsp;closed&nbsp;pipe&#34;</span><span class="op" id="1433109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1433112">type</span>&nbsp;<span class="ident" id="1433117">pipeResult</span>&nbsp;<span class="keyword" id="1433128">struct</span>&nbsp;<span class="op" id="1433135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433138">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1433142">int</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433147">err</span>&nbsp;<span class="builtintype" id="1433151">error</span><br>
<span class="lineno"></span><span class="op" id="1433157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1433160">//&nbsp;A&nbsp;pipe&nbsp;is&nbsp;the&nbsp;shared&nbsp;pipe&nbsp;structure&nbsp;underlying&nbsp;PipeReader&nbsp;and&nbsp;PipeWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1433237">type</span>&nbsp;<span class="ident" id="1433242">pipe</span>&nbsp;<span class="keyword" id="1433247">struct</span>&nbsp;<span class="op" id="1433254">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433257">rl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1433263">sync</span><span class="op" id="1433267">.</span><span class="ident" id="1433268">Mutex</span>&nbsp;<span class="comment" id="1433274">//&nbsp;gates&nbsp;readers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433306">wl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1433312">sync</span><span class="op" id="1433316">.</span><span class="ident" id="1433317">Mutex</span>&nbsp;<span class="comment" id="1433323">//&nbsp;gates&nbsp;writers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433355">l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1433361">sync</span><span class="op" id="1433365">.</span><span class="ident" id="1433366">Mutex</span>&nbsp;<span class="comment" id="1433372">//&nbsp;protects&nbsp;remaining&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433402">data</span>&nbsp;&nbsp;<span class="op" id="1433408">[</span><span class="op" id="1433409">]</span><span class="builtintype" id="1433410">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1433419">//&nbsp;data&nbsp;remaining&nbsp;in&nbsp;pending&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433455">rwait</span>&nbsp;<span class="ident" id="1433461">sync</span><span class="op" id="1433465">.</span><span class="ident" id="1433466">Cond</span>&nbsp;&nbsp;<span class="comment" id="1433472">//&nbsp;waiting&nbsp;reader</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433491">wwait</span>&nbsp;<span class="ident" id="1433497">sync</span><span class="op" id="1433501">.</span><span class="ident" id="1433502">Cond</span>&nbsp;&nbsp;<span class="comment" id="1433508">//&nbsp;waiting&nbsp;writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433527">rerr</span>&nbsp;&nbsp;<span class="builtintype" id="1433533">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1433544">//&nbsp;if&nbsp;reader&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433587">werr</span>&nbsp;&nbsp;<span class="builtintype" id="1433593">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1433604">//&nbsp;if&nbsp;writer&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;reads</span><br>
<span class="lineno"></span><span class="op" id="1433645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1433648">func</span>&nbsp;<span class="op" id="1433653">(</span><span class="ident" id="1433654">p</span>&nbsp;<span class="op" id="1433656">*</span><span class="ident" id="1433657">pipe</span><span class="op" id="1433661">)</span>&nbsp;<span class="ident" id="1433663">read</span><span class="op" id="1433667">(</span><span class="ident" id="1433668">b</span>&nbsp;<span class="op" id="1433670">[</span><span class="op" id="1433671">]</span><span class="builtintype" id="1433672">byte</span><span class="op" id="1433676">)</span>&nbsp;<span class="op" id="1433678">(</span><span class="ident" id="1433679">n</span>&nbsp;<span class="builtintype" id="1433681">int</span><span class="op" id="1433684">,</span>&nbsp;<span class="ident" id="1433686">err</span>&nbsp;<span class="builtintype" id="1433690">error</span><span class="op" id="1433695">)</span>&nbsp;<span class="op" id="1433697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1433700">//&nbsp;One&nbsp;reader&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433726">p</span><span class="op" id="1433727">.</span><span class="ident" id="1433728">rl</span><span class="op" id="1433730">.</span><span class="ident" id="1433731">Lock</span><span class="op" id="1433735">(</span><span class="op" id="1433736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433739">defer</span>&nbsp;<span class="ident" id="1433745">p</span><span class="op" id="1433746">.</span><span class="ident" id="1433747">rl</span><span class="op" id="1433749">.</span><span class="ident" id="1433750">Unlock</span><span class="op" id="1433756">(</span><span class="op" id="1433757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433761">p</span><span class="op" id="1433762">.</span><span class="ident" id="1433763">l</span><span class="op" id="1433764">.</span><span class="ident" id="1433765">Lock</span><span class="op" id="1433769">(</span><span class="op" id="1433770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433773">defer</span>&nbsp;<span class="ident" id="1433779">p</span><span class="op" id="1433780">.</span><span class="ident" id="1433781">l</span><span class="op" id="1433782">.</span><span class="ident" id="1433783">Unlock</span><span class="op" id="1433789">(</span><span class="op" id="1433790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433793">for</span>&nbsp;<span class="op" id="1433797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433801">if</span>&nbsp;<span class="ident" id="1433804">p</span><span class="op" id="1433805">.</span><span class="ident" id="1433806">rerr</span>&nbsp;<span class="op" id="1433811">!=</span>&nbsp;<span class="ident" id="1433814">nil</span>&nbsp;<span class="op" id="1433818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433823">return</span>&nbsp;<span class="num" id="1433830">0</span><span class="op" id="1433831">,</span>&nbsp;<span class="ident" id="1433833">ErrClosedPipe</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433853">if</span>&nbsp;<span class="ident" id="1433856">p</span><span class="op" id="1433857">.</span><span class="ident" id="1433858">data</span>&nbsp;<span class="op" id="1433863">!=</span>&nbsp;<span class="ident" id="1433866">nil</span>&nbsp;<span class="op" id="1433870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433875">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433887">if</span>&nbsp;<span class="ident" id="1433890">p</span><span class="op" id="1433891">.</span><span class="ident" id="1433892">werr</span>&nbsp;<span class="op" id="1433897">!=</span>&nbsp;<span class="ident" id="1433900">nil</span>&nbsp;<span class="op" id="1433904">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433909">return</span>&nbsp;<span class="num" id="1433916">0</span><span class="op" id="1433917">,</span>&nbsp;<span class="ident" id="1433919">p</span><span class="op" id="1433920">.</span><span class="ident" id="1433921">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433932">p</span><span class="op" id="1433933">.</span><span class="ident" id="1433934">rwait</span><span class="op" id="1433939">.</span><span class="ident" id="1433940">Wait</span><span class="op" id="1433944">(</span><span class="op" id="1433945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1433948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433951">n</span>&nbsp;<span class="op" id="1433953">=</span>&nbsp;<span class="builtinfunc" id="1433955">copy</span><span class="op" id="1433959">(</span><span class="ident" id="1433960">b</span><span class="op" id="1433961">,</span>&nbsp;<span class="ident" id="1433963">p</span><span class="op" id="1433964">.</span><span class="ident" id="1433965">data</span><span class="op" id="1433969">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1433972">p</span><span class="op" id="1433973">.</span><span class="ident" id="1433974">data</span>&nbsp;<span class="op" id="1433979">=</span>&nbsp;<span class="ident" id="1433981">p</span><span class="op" id="1433982">.</span><span class="ident" id="1433983">data</span><span class="op" id="1433987">[</span><span class="ident" id="1433988">n</span><span class="op" id="1433989">:</span><span class="op" id="1433990">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1433993">if</span>&nbsp;<span class="builtinfunc" id="1433996">len</span><span class="op" id="1433999">(</span><span class="ident" id="1434000">p</span><span class="op" id="1434001">.</span><span class="ident" id="1434002">data</span><span class="op" id="1434006">)</span>&nbsp;<span class="op" id="1434008">==</span>&nbsp;<span class="num" id="1434011">0</span>&nbsp;<span class="op" id="1434013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434017">p</span><span class="op" id="1434018">.</span><span class="ident" id="1434019">data</span>&nbsp;<span class="op" id="1434024">=</span>&nbsp;<span class="ident" id="1434026">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434032">p</span><span class="op" id="1434033">.</span><span class="ident" id="1434034">wwait</span><span class="op" id="1434039">.</span><span class="ident" id="1434040">Signal</span><span class="op" id="1434046">(</span><span class="op" id="1434047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434050">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434053">return</span><br>
<span class="lineno"></span><span class="op" id="1434060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1434063">var</span>&nbsp;<span class="ident" id="1434067">zero</span>&nbsp;<span class="op" id="1434072">[</span><span class="num" id="1434073">0</span><span class="op" id="1434074">]</span><span class="builtintype" id="1434075">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="1434081">func</span>&nbsp;<span class="op" id="1434086">(</span><span class="ident" id="1434087">p</span>&nbsp;<span class="op" id="1434089">*</span><span class="ident" id="1434090">pipe</span><span class="op" id="1434094">)</span>&nbsp;<span class="ident" id="1434096">write</span><span class="op" id="1434101">(</span><span class="ident" id="1434102">b</span>&nbsp;<span class="op" id="1434104">[</span><span class="op" id="1434105">]</span><span class="builtintype" id="1434106">byte</span><span class="op" id="1434110">)</span>&nbsp;<span class="op" id="1434112">(</span><span class="ident" id="1434113">n</span>&nbsp;<span class="builtintype" id="1434115">int</span><span class="op" id="1434118">,</span>&nbsp;<span class="ident" id="1434120">err</span>&nbsp;<span class="builtintype" id="1434124">error</span><span class="op" id="1434129">)</span>&nbsp;<span class="op" id="1434131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1434134">//&nbsp;pipe&nbsp;uses&nbsp;nil&nbsp;to&nbsp;mean&nbsp;not&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434174">if</span>&nbsp;<span class="ident" id="1434177">b</span>&nbsp;<span class="op" id="1434179">==</span>&nbsp;<span class="ident" id="1434182">nil</span>&nbsp;<span class="op" id="1434186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434190">b</span>&nbsp;<span class="op" id="1434192">=</span>&nbsp;<span class="ident" id="1434194">zero</span><span class="op" id="1434198">[</span><span class="op" id="1434199">:</span><span class="op" id="1434200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434203">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1434207">//&nbsp;One&nbsp;writer&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434233">p</span><span class="op" id="1434234">.</span><span class="ident" id="1434235">wl</span><span class="op" id="1434237">.</span><span class="ident" id="1434238">Lock</span><span class="op" id="1434242">(</span><span class="op" id="1434243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434246">defer</span>&nbsp;<span class="ident" id="1434252">p</span><span class="op" id="1434253">.</span><span class="ident" id="1434254">wl</span><span class="op" id="1434256">.</span><span class="ident" id="1434257">Unlock</span><span class="op" id="1434263">(</span><span class="op" id="1434264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434268">p</span><span class="op" id="1434269">.</span><span class="ident" id="1434270">l</span><span class="op" id="1434271">.</span><span class="ident" id="1434272">Lock</span><span class="op" id="1434276">(</span><span class="op" id="1434277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434280">defer</span>&nbsp;<span class="ident" id="1434286">p</span><span class="op" id="1434287">.</span><span class="ident" id="1434288">l</span><span class="op" id="1434289">.</span><span class="ident" id="1434290">Unlock</span><span class="op" id="1434296">(</span><span class="op" id="1434297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434300">if</span>&nbsp;<span class="ident" id="1434303">p</span><span class="op" id="1434304">.</span><span class="ident" id="1434305">werr</span>&nbsp;<span class="op" id="1434310">!=</span>&nbsp;<span class="ident" id="1434313">nil</span>&nbsp;<span class="op" id="1434317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434321">err</span>&nbsp;<span class="op" id="1434325">=</span>&nbsp;<span class="ident" id="1434327">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434343">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434354">p</span><span class="op" id="1434355">.</span><span class="ident" id="1434356">data</span>&nbsp;<span class="op" id="1434361">=</span>&nbsp;<span class="ident" id="1434363">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434366">p</span><span class="op" id="1434367">.</span><span class="ident" id="1434368">rwait</span><span class="op" id="1434373">.</span><span class="ident" id="1434374">Signal</span><span class="op" id="1434380">(</span><span class="op" id="1434381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434384">for</span>&nbsp;<span class="op" id="1434388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434392">if</span>&nbsp;<span class="ident" id="1434395">p</span><span class="op" id="1434396">.</span><span class="ident" id="1434397">data</span>&nbsp;<span class="op" id="1434402">==</span>&nbsp;<span class="ident" id="1434405">nil</span>&nbsp;<span class="op" id="1434409">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434414">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434426">if</span>&nbsp;<span class="ident" id="1434429">p</span><span class="op" id="1434430">.</span><span class="ident" id="1434431">rerr</span>&nbsp;<span class="op" id="1434436">!=</span>&nbsp;<span class="ident" id="1434439">nil</span>&nbsp;<span class="op" id="1434443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434448">err</span>&nbsp;<span class="op" id="1434452">=</span>&nbsp;<span class="ident" id="1434454">p</span><span class="op" id="1434455">.</span><span class="ident" id="1434456">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434464">break</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434476">if</span>&nbsp;<span class="ident" id="1434479">p</span><span class="op" id="1434480">.</span><span class="ident" id="1434481">werr</span>&nbsp;<span class="op" id="1434486">!=</span>&nbsp;<span class="ident" id="1434489">nil</span>&nbsp;<span class="op" id="1434493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434498">err</span>&nbsp;<span class="op" id="1434502">=</span>&nbsp;<span class="ident" id="1434504">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434524">p</span><span class="op" id="1434525">.</span><span class="ident" id="1434526">wwait</span><span class="op" id="1434531">.</span><span class="ident" id="1434532">Wait</span><span class="op" id="1434536">(</span><span class="op" id="1434537">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434543">n</span>&nbsp;<span class="op" id="1434545">=</span>&nbsp;<span class="builtinfunc" id="1434547">len</span><span class="op" id="1434550">(</span><span class="ident" id="1434551">b</span><span class="op" id="1434552">)</span>&nbsp;<span class="op" id="1434554">-</span>&nbsp;<span class="builtinfunc" id="1434556">len</span><span class="op" id="1434559">(</span><span class="ident" id="1434560">p</span><span class="op" id="1434561">.</span><span class="ident" id="1434562">data</span><span class="op" id="1434566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434569">p</span><span class="op" id="1434570">.</span><span class="ident" id="1434571">data</span>&nbsp;<span class="op" id="1434576">=</span>&nbsp;<span class="ident" id="1434578">nil</span>&nbsp;<span class="comment" id="1434582">//&nbsp;in&nbsp;case&nbsp;of&nbsp;rerr&nbsp;or&nbsp;werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434610">return</span><br>
<span class="lineno"></span><span class="op" id="1434617">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1434620">func</span>&nbsp;<span class="op" id="1434625">(</span><span class="ident" id="1434626">p</span>&nbsp;<span class="op" id="1434628">*</span><span class="ident" id="1434629">pipe</span><span class="op" id="1434633">)</span>&nbsp;<span class="ident" id="1434635">rclose</span><span class="op" id="1434641">(</span><span class="ident" id="1434642">err</span>&nbsp;<span class="builtintype" id="1434646">error</span><span class="op" id="1434651">)</span>&nbsp;<span class="op" id="1434653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434656">if</span>&nbsp;<span class="ident" id="1434659">err</span>&nbsp;<span class="op" id="1434663">==</span>&nbsp;<span class="ident" id="1434666">nil</span>&nbsp;<span class="op" id="1434670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434674">err</span>&nbsp;<span class="op" id="1434678">=</span>&nbsp;<span class="ident" id="1434680">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434695">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434698">p</span><span class="op" id="1434699">.</span><span class="ident" id="1434700">l</span><span class="op" id="1434701">.</span><span class="ident" id="1434702">Lock</span><span class="op" id="1434706">(</span><span class="op" id="1434707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434710">defer</span>&nbsp;<span class="ident" id="1434716">p</span><span class="op" id="1434717">.</span><span class="ident" id="1434718">l</span><span class="op" id="1434719">.</span><span class="ident" id="1434720">Unlock</span><span class="op" id="1434726">(</span><span class="op" id="1434727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434730">p</span><span class="op" id="1434731">.</span><span class="ident" id="1434732">rerr</span>&nbsp;<span class="op" id="1434737">=</span>&nbsp;<span class="ident" id="1434739">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434744">p</span><span class="op" id="1434745">.</span><span class="ident" id="1434746">rwait</span><span class="op" id="1434751">.</span><span class="ident" id="1434752">Signal</span><span class="op" id="1434758">(</span><span class="op" id="1434759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434762">p</span><span class="op" id="1434763">.</span><span class="ident" id="1434764">wwait</span><span class="op" id="1434769">.</span><span class="ident" id="1434770">Signal</span><span class="op" id="1434776">(</span><span class="op" id="1434777">)</span><br>
<span class="lineno">110</span><span class="op" id="1434779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1434782">func</span>&nbsp;<span class="op" id="1434787">(</span><span class="ident" id="1434788">p</span>&nbsp;<span class="op" id="1434790">*</span><span class="ident" id="1434791">pipe</span><span class="op" id="1434795">)</span>&nbsp;<span class="ident" id="1434797">wclose</span><span class="op" id="1434803">(</span><span class="ident" id="1434804">err</span>&nbsp;<span class="builtintype" id="1434808">error</span><span class="op" id="1434813">)</span>&nbsp;<span class="op" id="1434815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434818">if</span>&nbsp;<span class="ident" id="1434821">err</span>&nbsp;<span class="op" id="1434825">==</span>&nbsp;<span class="ident" id="1434828">nil</span>&nbsp;<span class="op" id="1434832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434836">err</span>&nbsp;<span class="op" id="1434840">=</span>&nbsp;<span class="ident" id="1434842">EOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1434847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434850">p</span><span class="op" id="1434851">.</span><span class="ident" id="1434852">l</span><span class="op" id="1434853">.</span><span class="ident" id="1434854">Lock</span><span class="op" id="1434858">(</span><span class="op" id="1434859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1434862">defer</span>&nbsp;<span class="ident" id="1434868">p</span><span class="op" id="1434869">.</span><span class="ident" id="1434870">l</span><span class="op" id="1434871">.</span><span class="ident" id="1434872">Unlock</span><span class="op" id="1434878">(</span><span class="op" id="1434879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434882">p</span><span class="op" id="1434883">.</span><span class="ident" id="1434884">werr</span>&nbsp;<span class="op" id="1434889">=</span>&nbsp;<span class="ident" id="1434891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434896">p</span><span class="op" id="1434897">.</span><span class="ident" id="1434898">rwait</span><span class="op" id="1434903">.</span><span class="ident" id="1434904">Signal</span><span class="op" id="1434910">(</span><span class="op" id="1434911">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1434914">p</span><span class="op" id="1434915">.</span><span class="ident" id="1434916">wwait</span><span class="op" id="1434921">.</span><span class="ident" id="1434922">Signal</span><span class="op" id="1434928">(</span><span class="op" id="1434929">)</span><br>
<span class="lineno"></span><span class="op" id="1434931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1434934">//&nbsp;A&nbsp;PipeReader&nbsp;is&nbsp;the&nbsp;read&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1434978">type</span>&nbsp;<span class="ident" id="1434983">PipeReader</span>&nbsp;<span class="keyword" id="1434994">struct</span>&nbsp;<span class="op" id="1435001">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435004">p</span>&nbsp;<span class="op" id="1435006">*</span><span class="ident" id="1435007">pipe</span><br>
<span class="lineno"></span><span class="op" id="1435012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1435015">//&nbsp;Read&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Read&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1435063">//&nbsp;it&nbsp;reads&nbsp;data&nbsp;from&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;a&nbsp;writer</span><br>
<span class="lineno">130</span><span class="comment" id="1435119">//&nbsp;arrives&nbsp;or&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1435158">//&nbsp;If&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1435217">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1435259">func</span>&nbsp;<span class="op" id="1435264">(</span><span class="ident" id="1435265">r</span>&nbsp;<span class="op" id="1435267">*</span><span class="ident" id="1435268">PipeReader</span><span class="op" id="1435278">)</span>&nbsp;<span class="ident" id="1435280">Read</span><span class="op" id="1435284">(</span><span class="ident" id="1435285">data</span>&nbsp;<span class="op" id="1435290">[</span><span class="op" id="1435291">]</span><span class="builtintype" id="1435292">byte</span><span class="op" id="1435296">)</span>&nbsp;<span class="op" id="1435298">(</span><span class="ident" id="1435299">n</span>&nbsp;<span class="builtintype" id="1435301">int</span><span class="op" id="1435304">,</span>&nbsp;<span class="ident" id="1435306">err</span>&nbsp;<span class="builtintype" id="1435310">error</span><span class="op" id="1435315">)</span>&nbsp;<span class="op" id="1435317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435320">return</span>&nbsp;<span class="ident" id="1435327">r</span><span class="op" id="1435328">.</span><span class="ident" id="1435329">p</span><span class="op" id="1435330">.</span><span class="ident" id="1435331">read</span><span class="op" id="1435335">(</span><span class="ident" id="1435336">data</span><span class="op" id="1435340">)</span><br>
<span class="lineno">135</span><span class="op" id="1435342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1435345">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1435398">//&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;ErrClosedPipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1435461">func</span>&nbsp;<span class="op" id="1435466">(</span><span class="ident" id="1435467">r</span>&nbsp;<span class="op" id="1435469">*</span><span class="ident" id="1435470">PipeReader</span><span class="op" id="1435480">)</span>&nbsp;<span class="ident" id="1435482">Close</span><span class="op" id="1435487">(</span><span class="op" id="1435488">)</span>&nbsp;<span class="builtintype" id="1435490">error</span>&nbsp;<span class="op" id="1435496">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435499">return</span>&nbsp;<span class="ident" id="1435506">r</span><span class="op" id="1435507">.</span><span class="ident" id="1435508">CloseWithError</span><span class="op" id="1435522">(</span><span class="ident" id="1435523">nil</span><span class="op" id="1435526">)</span><br>
<span class="lineno"></span><span class="op" id="1435528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1435531">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes</span><br>
<span class="lineno"></span><span class="comment" id="1435586">//&nbsp;to&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno">145</span><span class="keyword" id="1435646">func</span>&nbsp;<span class="op" id="1435651">(</span><span class="ident" id="1435652">r</span>&nbsp;<span class="op" id="1435654">*</span><span class="ident" id="1435655">PipeReader</span><span class="op" id="1435665">)</span>&nbsp;<span class="ident" id="1435667">CloseWithError</span><span class="op" id="1435681">(</span><span class="ident" id="1435682">err</span>&nbsp;<span class="builtintype" id="1435686">error</span><span class="op" id="1435691">)</span>&nbsp;<span class="builtintype" id="1435693">error</span>&nbsp;<span class="op" id="1435699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435702">r</span><span class="op" id="1435703">.</span><span class="ident" id="1435704">p</span><span class="op" id="1435705">.</span><span class="ident" id="1435706">rclose</span><span class="op" id="1435712">(</span><span class="ident" id="1435713">err</span><span class="op" id="1435716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1435719">return</span>&nbsp;<span class="ident" id="1435726">nil</span><br>
<span class="lineno"></span><span class="op" id="1435730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1435733">//&nbsp;A&nbsp;PipeWriter&nbsp;is&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1435778">type</span>&nbsp;<span class="ident" id="1435783">PipeWriter</span>&nbsp;<span class="keyword" id="1435794">struct</span>&nbsp;<span class="op" id="1435801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1435804">p</span>&nbsp;<span class="op" id="1435806">*</span><span class="ident" id="1435807">pipe</span><br>
<span class="lineno"></span><span class="op" id="1435812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="1435815">//&nbsp;Write&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Write&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1435865">//&nbsp;it&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1435919">//&nbsp;have&nbsp;consumed&nbsp;all&nbsp;the&nbsp;data&nbsp;or&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1435976">//&nbsp;If&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;err&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1436032">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;ErrClosedPipe.</span><br>
<span class="lineno">160</span><span class="keyword" id="1436084">func</span>&nbsp;<span class="op" id="1436089">(</span><span class="ident" id="1436090">w</span>&nbsp;<span class="op" id="1436092">*</span><span class="ident" id="1436093">PipeWriter</span><span class="op" id="1436103">)</span>&nbsp;<span class="ident" id="1436105">Write</span><span class="op" id="1436110">(</span><span class="ident" id="1436111">data</span>&nbsp;<span class="op" id="1436116">[</span><span class="op" id="1436117">]</span><span class="builtintype" id="1436118">byte</span><span class="op" id="1436122">)</span>&nbsp;<span class="op" id="1436124">(</span><span class="ident" id="1436125">n</span>&nbsp;<span class="builtintype" id="1436127">int</span><span class="op" id="1436130">,</span>&nbsp;<span class="ident" id="1436132">err</span>&nbsp;<span class="builtintype" id="1436136">error</span><span class="op" id="1436141">)</span>&nbsp;<span class="op" id="1436143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436146">return</span>&nbsp;<span class="ident" id="1436153">w</span><span class="op" id="1436154">.</span><span class="ident" id="1436155">p</span><span class="op" id="1436156">.</span><span class="ident" id="1436157">write</span><span class="op" id="1436162">(</span><span class="ident" id="1436163">data</span><span class="op" id="1436167">)</span><br>
<span class="lineno"></span><span class="op" id="1436169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1436172">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno">165</span><span class="comment" id="1436226">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1436281">func</span>&nbsp;<span class="op" id="1436286">(</span><span class="ident" id="1436287">w</span>&nbsp;<span class="op" id="1436289">*</span><span class="ident" id="1436290">PipeWriter</span><span class="op" id="1436300">)</span>&nbsp;<span class="ident" id="1436302">Close</span><span class="op" id="1436307">(</span><span class="op" id="1436308">)</span>&nbsp;<span class="builtintype" id="1436310">error</span>&nbsp;<span class="op" id="1436316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436319">return</span>&nbsp;<span class="ident" id="1436326">w</span><span class="op" id="1436327">.</span><span class="ident" id="1436328">CloseWithError</span><span class="op" id="1436342">(</span><span class="ident" id="1436343">nil</span><span class="op" id="1436346">)</span><br>
<span class="lineno"></span><span class="op" id="1436348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="1436351">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1436414">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno"></span><span class="keyword" id="1436479">func</span>&nbsp;<span class="op" id="1436484">(</span><span class="ident" id="1436485">w</span>&nbsp;<span class="op" id="1436487">*</span><span class="ident" id="1436488">PipeWriter</span><span class="op" id="1436498">)</span>&nbsp;<span class="ident" id="1436500">CloseWithError</span><span class="op" id="1436514">(</span><span class="ident" id="1436515">err</span>&nbsp;<span class="builtintype" id="1436519">error</span><span class="op" id="1436524">)</span>&nbsp;<span class="builtintype" id="1436526">error</span>&nbsp;<span class="op" id="1436532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1436535">w</span><span class="op" id="1436536">.</span><span class="ident" id="1436537">p</span><span class="op" id="1436538">.</span><span class="ident" id="1436539">wclose</span><span class="op" id="1436545">(</span><span class="ident" id="1436546">err</span><span class="op" id="1436549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1436552">return</span>&nbsp;<span class="ident" id="1436559">nil</span><br>
<span class="lineno">175</span><span class="op" id="1436563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1436566">//&nbsp;Pipe&nbsp;creates&nbsp;a&nbsp;synchronous&nbsp;in-memory&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="1436612">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1436669">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno">180</span><span class="comment" id="1436706">//&nbsp;Reads&nbsp;on&nbsp;one&nbsp;end&nbsp;are&nbsp;matched&nbsp;with&nbsp;writes&nbsp;on&nbsp;the&nbsp;other,</span><br>
<span class="lineno"></span><span class="comment" id="1436764">//&nbsp;copying&nbsp;data&nbsp;directly&nbsp;between&nbsp;the&nbsp;two;&nbsp;there&nbsp;is&nbsp;no&nbsp;internal&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="comment" id="1436838">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;Read&nbsp;and&nbsp;Write&nbsp;in&nbsp;parallel&nbsp;with&nbsp;each&nbsp;other&nbsp;or&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1436911">//&nbsp;Close.&nbsp;Close&nbsp;will&nbsp;complete&nbsp;once&nbsp;pending&nbsp;I/O&nbsp;is&nbsp;done.&nbsp;Parallel&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1436985">//&nbsp;Read,&nbsp;and&nbsp;parallel&nbsp;calls&nbsp;to&nbsp;Write,&nbsp;are&nbsp;also&nbsp;safe:</span><br>
<span class="lineno">185</span><span class="comment" id="1437038">//&nbsp;the&nbsp;individual&nbsp;calls&nbsp;will&nbsp;be&nbsp;gated&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="keyword" id="1437090">func</span>&nbsp;<span class="ident" id="1437095">Pipe</span><span class="op" id="1437099">(</span><span class="op" id="1437100">)</span>&nbsp;<span class="op" id="1437102">(</span><span class="op" id="1437103">*</span><span class="ident" id="1437104">PipeReader</span><span class="op" id="1437114">,</span>&nbsp;<span class="op" id="1437116">*</span><span class="ident" id="1437117">PipeWriter</span><span class="op" id="1437127">)</span>&nbsp;<span class="op" id="1437129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437132">p</span>&nbsp;<span class="op" id="1437134">:=</span>&nbsp;<span class="builtinfunc" id="1437137">new</span><span class="op" id="1437140">(</span><span class="ident" id="1437141">pipe</span><span class="op" id="1437145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437148">p</span><span class="op" id="1437149">.</span><span class="ident" id="1437150">rwait</span><span class="op" id="1437155">.</span><span class="ident" id="1437156">L</span>&nbsp;<span class="op" id="1437158">=</span>&nbsp;<span class="op" id="1437160">&amp;</span><span class="ident" id="1437161">p</span><span class="op" id="1437162">.</span><span class="ident" id="1437163">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437166">p</span><span class="op" id="1437167">.</span><span class="ident" id="1437168">wwait</span><span class="op" id="1437173">.</span><span class="ident" id="1437174">L</span>&nbsp;<span class="op" id="1437176">=</span>&nbsp;<span class="op" id="1437178">&amp;</span><span class="ident" id="1437179">p</span><span class="op" id="1437180">.</span><span class="ident" id="1437181">l</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437184">r</span>&nbsp;<span class="op" id="1437186">:=</span>&nbsp;<span class="op" id="1437189">&amp;</span><span class="ident" id="1437190">PipeReader</span><span class="op" id="1437200">{</span><span class="ident" id="1437201">p</span><span class="op" id="1437202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437205">w</span>&nbsp;<span class="op" id="1437207">:=</span>&nbsp;<span class="op" id="1437210">&amp;</span><span class="ident" id="1437211">PipeWriter</span><span class="op" id="1437221">{</span><span class="ident" id="1437222">p</span><span class="op" id="1437223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1437226">return</span>&nbsp;<span class="ident" id="1437233">r</span><span class="op" id="1437234">,</span>&nbsp;<span class="ident" id="1437236">w</span><br>
<span class="lineno"></span><span class="op" id="1437238">}</span>
</div>
</body>
</html>
