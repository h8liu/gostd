<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2095559">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2095614">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2095668">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2095719">package</span>&nbsp;<span class="ident" id="2095727">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2095736">import</span>&nbsp;<span class="string" id="2095743">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2095753">//&nbsp;The&nbsp;code&nbsp;in&nbsp;this&nbsp;file&nbsp;implements&nbsp;stack&nbsp;trace&nbsp;walking&nbsp;for&nbsp;all&nbsp;architectures.</span><br>
<span class="lineno">10</span><span class="comment" id="2095832">//&nbsp;The&nbsp;most&nbsp;important&nbsp;fact&nbsp;about&nbsp;a&nbsp;given&nbsp;architecture&nbsp;is&nbsp;whether&nbsp;it&nbsp;uses&nbsp;a&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span><span class="comment" id="2095922">//&nbsp;On&nbsp;systems&nbsp;with&nbsp;link&nbsp;registers,&nbsp;the&nbsp;prologue&nbsp;for&nbsp;a&nbsp;non-leaf&nbsp;function&nbsp;stores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2096005">//&nbsp;incoming&nbsp;value&nbsp;of&nbsp;LR&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;newly&nbsp;allocated&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno"></span><span class="comment" id="2096079">//&nbsp;On&nbsp;systems&nbsp;without&nbsp;link&nbsp;registers,&nbsp;the&nbsp;architecture&nbsp;pushes&nbsp;a&nbsp;return&nbsp;PC&nbsp;during</span><br>
<span class="lineno"></span><span class="comment" id="2096160">//&nbsp;the&nbsp;call&nbsp;instruction,&nbsp;so&nbsp;the&nbsp;return&nbsp;PC&nbsp;ends&nbsp;up&nbsp;above&nbsp;the&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno">15</span><span class="comment" id="2096233">//&nbsp;In&nbsp;this&nbsp;file,&nbsp;the&nbsp;return&nbsp;PC&nbsp;is&nbsp;always&nbsp;called&nbsp;LR,&nbsp;no&nbsp;matter&nbsp;how&nbsp;it&nbsp;was&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="2096313">//</span><br>
<span class="lineno"></span><span class="comment" id="2096316">//&nbsp;To&nbsp;date,&nbsp;the&nbsp;opposite&nbsp;of&nbsp;a&nbsp;link&nbsp;register&nbsp;architecture&nbsp;is&nbsp;an&nbsp;x86&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="comment" id="2096397">//&nbsp;This&nbsp;code&nbsp;may&nbsp;need&nbsp;to&nbsp;change&nbsp;if&nbsp;some&nbsp;other&nbsp;kind&nbsp;of&nbsp;non-link-register</span><br>
<span class="lineno"></span><span class="comment" id="2096469">//&nbsp;architecture&nbsp;comes&nbsp;along.</span><br>
<span class="lineno">20</span><span class="comment" id="2096498">//</span><br>
<span class="lineno"></span><span class="comment" id="2096501">//&nbsp;The&nbsp;other&nbsp;important&nbsp;fact&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;pointer:&nbsp;on&nbsp;32-bit&nbsp;systems&nbsp;the&nbsp;LR</span><br>
<span class="lineno"></span><span class="comment" id="2096580">//&nbsp;takes&nbsp;up&nbsp;only&nbsp;4&nbsp;bytes&nbsp;on&nbsp;the&nbsp;stack,&nbsp;while&nbsp;on&nbsp;64-bit&nbsp;systems&nbsp;it&nbsp;takes&nbsp;up&nbsp;8&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2096664">//&nbsp;Typically&nbsp;this&nbsp;is&nbsp;ptrSize.</span><br>
<span class="lineno"></span><span class="comment" id="2096694">//</span><br>
<span class="lineno">25</span><span class="comment" id="2096697">//&nbsp;As&nbsp;an&nbsp;exception,&nbsp;amd64p32&nbsp;has&nbsp;ptrSize&nbsp;==&nbsp;4&nbsp;but&nbsp;the&nbsp;CALL&nbsp;instruction&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="2096774">//&nbsp;stores&nbsp;an&nbsp;8-byte&nbsp;return&nbsp;PC&nbsp;onto&nbsp;the&nbsp;stack.&nbsp;To&nbsp;accommodate&nbsp;this,&nbsp;we&nbsp;use&nbsp;regSize</span><br>
<span class="lineno"></span><span class="comment" id="2096856">//&nbsp;as&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;architecture-pushed&nbsp;return&nbsp;PC.</span><br>
<span class="lineno"></span><span class="comment" id="2096909">//</span><br>
<span class="lineno"></span><span class="comment" id="2096912">//&nbsp;usesLR&nbsp;is&nbsp;defined&nbsp;below.&nbsp;ptrSize&nbsp;and&nbsp;regSize&nbsp;are&nbsp;defined&nbsp;in&nbsp;stubs.go.</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="2096986">const</span>&nbsp;<span class="ident" id="2096992">usesLR</span>&nbsp;<span class="op" id="2096999">=</span>&nbsp;<span class="ident" id="2097001">GOARCH</span>&nbsp;<span class="op" id="2097008">!=</span>&nbsp;<span class="string" id="2097011">&#34;amd64&#34;</span>&nbsp;<span class="op" id="2097019">&amp;&amp;</span>&nbsp;<span class="ident" id="2097022">GOARCH</span>&nbsp;<span class="op" id="2097029">!=</span>&nbsp;<span class="string" id="2097032">&#34;amd64p32&#34;</span>&nbsp;<span class="op" id="2097043">&amp;&amp;</span>&nbsp;<span class="ident" id="2097046">GOARCH</span>&nbsp;<span class="op" id="2097053">!=</span>&nbsp;<span class="string" id="2097056">&#34;386&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2097063">var</span>&nbsp;<span class="op" id="2097067">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097070">//&nbsp;initialized&nbsp;in&nbsp;tracebackinit</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097103">deferprocPC</span>&nbsp;<span class="builtintype" id="2097115">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097124">goexitPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2097136">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097145">jmpdeferPC</span>&nbsp;&nbsp;<span class="builtintype" id="2097157">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097166">mcallPC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2097178">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097187">morestackPC</span>&nbsp;<span class="builtintype" id="2097199">uintptr</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097208">mstartPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2097220">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097229">newprocPC</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2097241">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097250">rt0_goPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2097262">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097271">sigpanicPC</span>&nbsp;&nbsp;<span class="builtintype" id="2097283">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097293">externalthreadhandlerp</span>&nbsp;<span class="builtintype" id="2097316">uintptr</span>&nbsp;<span class="comment" id="2097324">//&nbsp;initialized&nbsp;elsewhere</span><br>
<span class="lineno"></span><span class="op" id="2097349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2097352">func</span>&nbsp;<span class="ident" id="2097357">tracebackinit</span><span class="op" id="2097370">(</span><span class="op" id="2097371">)</span>&nbsp;<span class="op" id="2097373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097376">//&nbsp;Go&nbsp;variable&nbsp;initialization&nbsp;happens&nbsp;late&nbsp;during&nbsp;runtime&nbsp;startup.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097444">//&nbsp;Instead&nbsp;of&nbsp;initializing&nbsp;the&nbsp;variables&nbsp;above&nbsp;in&nbsp;the&nbsp;declarations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097513">//&nbsp;schedinit&nbsp;calls&nbsp;this&nbsp;function&nbsp;so&nbsp;that&nbsp;the&nbsp;variables&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097573">//&nbsp;initialized&nbsp;and&nbsp;available&nbsp;earlier&nbsp;in&nbsp;the&nbsp;startup&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097636">deferprocPC</span>&nbsp;<span class="op" id="2097648">=</span>&nbsp;<span class="ident" id="2097650">funcPC</span><span class="op" id="2097656">(</span><span class="ident" id="2097657">deferproc</span><span class="op" id="2097666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097669">goexitPC</span>&nbsp;<span class="op" id="2097678">=</span>&nbsp;<span class="ident" id="2097680">funcPC</span><span class="op" id="2097686">(</span><span class="ident" id="2097687">goexit</span><span class="op" id="2097693">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097696">jmpdeferPC</span>&nbsp;<span class="op" id="2097707">=</span>&nbsp;<span class="ident" id="2097709">funcPC</span><span class="op" id="2097715">(</span><span class="ident" id="2097716">jmpdefer</span><span class="op" id="2097724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097727">mcallPC</span>&nbsp;<span class="op" id="2097735">=</span>&nbsp;<span class="ident" id="2097737">funcPC</span><span class="op" id="2097743">(</span><span class="ident" id="2097744">mcall</span><span class="op" id="2097749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097752">morestackPC</span>&nbsp;<span class="op" id="2097764">=</span>&nbsp;<span class="ident" id="2097766">funcPC</span><span class="op" id="2097772">(</span><span class="ident" id="2097773">morestack</span><span class="op" id="2097782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097785">mstartPC</span>&nbsp;<span class="op" id="2097794">=</span>&nbsp;<span class="ident" id="2097796">funcPC</span><span class="op" id="2097802">(</span><span class="ident" id="2097803">mstart</span><span class="op" id="2097809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097812">newprocPC</span>&nbsp;<span class="op" id="2097822">=</span>&nbsp;<span class="ident" id="2097824">funcPC</span><span class="op" id="2097830">(</span><span class="ident" id="2097831">newproc</span><span class="op" id="2097838">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097841">rt0_goPC</span>&nbsp;<span class="op" id="2097850">=</span>&nbsp;<span class="ident" id="2097852">funcPC</span><span class="op" id="2097858">(</span><span class="ident" id="2097859">rt0_go</span><span class="op" id="2097865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097868">sigpanicPC</span>&nbsp;<span class="op" id="2097879">=</span>&nbsp;<span class="ident" id="2097881">funcPC</span><span class="op" id="2097887">(</span><span class="ident" id="2097888">sigpanic</span><span class="op" id="2097896">)</span><br>
<span class="lineno"></span><span class="op" id="2097898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2097901">//&nbsp;Traceback&nbsp;over&nbsp;the&nbsp;deferred&nbsp;function&nbsp;calls.</span><br>
<span class="lineno">65</span><span class="comment" id="2097948">//&nbsp;Report&nbsp;them&nbsp;like&nbsp;calls&nbsp;that&nbsp;have&nbsp;been&nbsp;invoked&nbsp;but&nbsp;not&nbsp;started&nbsp;executing&nbsp;yet.</span><br>
<span class="lineno"></span><span class="keyword" id="2098028">func</span>&nbsp;<span class="ident" id="2098033">tracebackdefers</span><span class="op" id="2098048">(</span><span class="ident" id="2098049">gp</span>&nbsp;<span class="op" id="2098052">*</span><span class="ident" id="2098053">g</span><span class="op" id="2098054">,</span>&nbsp;<span class="ident" id="2098056">callback</span>&nbsp;<span class="keyword" id="2098065">func</span><span class="op" id="2098069">(</span><span class="op" id="2098070">*</span><span class="ident" id="2098071">stkframe</span><span class="op" id="2098079">,</span>&nbsp;<span class="ident" id="2098081">unsafe</span><span class="op" id="2098087">.</span><span class="ident" id="2098088">Pointer</span><span class="op" id="2098095">)</span>&nbsp;<span class="builtintype" id="2098097">bool</span><span class="op" id="2098101">,</span>&nbsp;<span class="ident" id="2098103">v</span>&nbsp;<span class="ident" id="2098105">unsafe</span><span class="op" id="2098111">.</span><span class="ident" id="2098112">Pointer</span><span class="op" id="2098119">)</span>&nbsp;<span class="op" id="2098121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098124">var</span>&nbsp;<span class="ident" id="2098128">frame</span>&nbsp;<span class="ident" id="2098134">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098144">for</span>&nbsp;<span class="ident" id="2098148">d</span>&nbsp;<span class="op" id="2098150">:=</span>&nbsp;<span class="ident" id="2098153">gp</span><span class="op" id="2098155">.</span><span class="ident" id="2098156">_defer</span><span class="op" id="2098162">;</span>&nbsp;<span class="ident" id="2098164">d</span>&nbsp;<span class="op" id="2098166">!=</span>&nbsp;<span class="ident" id="2098169">nil</span><span class="op" id="2098172">;</span>&nbsp;<span class="ident" id="2098174">d</span>&nbsp;<span class="op" id="2098176">=</span>&nbsp;<span class="ident" id="2098178">d</span><span class="op" id="2098179">.</span><span class="ident" id="2098180">link</span>&nbsp;<span class="op" id="2098185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098189">fn</span>&nbsp;<span class="op" id="2098192">:=</span>&nbsp;<span class="ident" id="2098195">d</span><span class="op" id="2098196">.</span><span class="ident" id="2098197">fn</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098202">if</span>&nbsp;<span class="ident" id="2098205">fn</span>&nbsp;<span class="op" id="2098208">==</span>&nbsp;<span class="ident" id="2098211">nil</span>&nbsp;<span class="op" id="2098215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2098220">//&nbsp;Defer&nbsp;of&nbsp;nil&nbsp;function.&nbsp;Args&nbsp;don&#39;t&nbsp;matter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098268">frame</span><span class="op" id="2098273">.</span><span class="ident" id="2098274">pc</span>&nbsp;<span class="op" id="2098277">=</span>&nbsp;<span class="num" id="2098279">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098284">frame</span><span class="op" id="2098289">.</span><span class="ident" id="2098290">fn</span>&nbsp;<span class="op" id="2098293">=</span>&nbsp;<span class="ident" id="2098295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098302">frame</span><span class="op" id="2098307">.</span><span class="ident" id="2098308">argp</span>&nbsp;<span class="op" id="2098313">=</span>&nbsp;<span class="num" id="2098315">0</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098320">frame</span><span class="op" id="2098325">.</span><span class="ident" id="2098326">arglen</span>&nbsp;<span class="op" id="2098333">=</span>&nbsp;<span class="num" id="2098335">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098340">frame</span><span class="op" id="2098345">.</span><span class="ident" id="2098346">argmap</span>&nbsp;<span class="op" id="2098353">=</span>&nbsp;<span class="ident" id="2098355">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098361">}</span>&nbsp;<span class="keyword" id="2098363">else</span>&nbsp;<span class="op" id="2098368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098373">frame</span><span class="op" id="2098378">.</span><span class="ident" id="2098379">pc</span>&nbsp;<span class="op" id="2098382">=</span>&nbsp;<span class="builtintype" id="2098384">uintptr</span><span class="op" id="2098391">(</span><span class="ident" id="2098392">fn</span><span class="op" id="2098394">.</span><span class="ident" id="2098395">fn</span><span class="op" id="2098397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098402">f</span>&nbsp;<span class="op" id="2098404">:=</span>&nbsp;<span class="ident" id="2098407">findfunc</span><span class="op" id="2098415">(</span><span class="ident" id="2098416">frame</span><span class="op" id="2098421">.</span><span class="ident" id="2098422">pc</span><span class="op" id="2098424">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098429">if</span>&nbsp;<span class="ident" id="2098432">f</span>&nbsp;<span class="op" id="2098434">==</span>&nbsp;<span class="ident" id="2098437">nil</span>&nbsp;<span class="op" id="2098441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2098447">print</span><span class="op" id="2098452">(</span><span class="string" id="2098453">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;in&nbsp;defer&nbsp;&#34;</span><span class="op" id="2098484">,</span>&nbsp;<span class="ident" id="2098486">hex</span><span class="op" id="2098489">(</span><span class="ident" id="2098490">frame</span><span class="op" id="2098495">.</span><span class="ident" id="2098496">pc</span><span class="op" id="2098498">)</span><span class="op" id="2098499">,</span>&nbsp;<span class="string" id="2098501">&#34;\n&#34;</span><span class="op" id="2098505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098511">gothrow</span><span class="op" id="2098518">(</span><span class="string" id="2098519">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="2098531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098541">frame</span><span class="op" id="2098546">.</span><span class="ident" id="2098547">fn</span>&nbsp;<span class="op" id="2098550">=</span>&nbsp;<span class="ident" id="2098552">f</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098557">frame</span><span class="op" id="2098562">.</span><span class="ident" id="2098563">argp</span>&nbsp;<span class="op" id="2098568">=</span>&nbsp;<span class="builtintype" id="2098570">uintptr</span><span class="op" id="2098577">(</span><span class="ident" id="2098578">deferArgs</span><span class="op" id="2098587">(</span><span class="ident" id="2098588">d</span><span class="op" id="2098589">)</span><span class="op" id="2098590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098595">setArgInfo</span><span class="op" id="2098605">(</span><span class="op" id="2098606">&amp;</span><span class="ident" id="2098607">frame</span><span class="op" id="2098612">,</span>&nbsp;<span class="ident" id="2098614">f</span><span class="op" id="2098615">,</span>&nbsp;<span class="builtintype" id="2098617">true</span><span class="op" id="2098621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098629">frame</span><span class="op" id="2098634">.</span><span class="ident" id="2098635">continpc</span>&nbsp;<span class="op" id="2098644">=</span>&nbsp;<span class="ident" id="2098646">frame</span><span class="op" id="2098651">.</span><span class="ident" id="2098652">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098657">if</span>&nbsp;<span class="op" id="2098660">!</span><span class="ident" id="2098661">callback</span><span class="op" id="2098669">(</span><span class="op" id="2098670">(</span><span class="op" id="2098671">*</span><span class="ident" id="2098672">stkframe</span><span class="op" id="2098680">)</span><span class="op" id="2098681">(</span><span class="ident" id="2098682">noescape</span><span class="op" id="2098690">(</span><span class="ident" id="2098691">unsafe</span><span class="op" id="2098697">.</span><span class="ident" id="2098698">Pointer</span><span class="op" id="2098705">(</span><span class="op" id="2098706">&amp;</span><span class="ident" id="2098707">frame</span><span class="op" id="2098712">)</span><span class="op" id="2098713">)</span><span class="op" id="2098714">)</span><span class="op" id="2098715">,</span>&nbsp;<span class="ident" id="2098717">v</span><span class="op" id="2098718">)</span>&nbsp;<span class="op" id="2098720">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098725">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098737">}</span><br>
<span class="lineno"></span><span class="op" id="2098739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="2098742">//&nbsp;Generic&nbsp;traceback.&nbsp;&nbsp;Handles&nbsp;runtime&nbsp;stack&nbsp;prints&nbsp;(pcbuf&nbsp;==&nbsp;nil),</span><br>
<span class="lineno"></span><span class="comment" id="2098810">//&nbsp;the&nbsp;runtime.Callers&nbsp;function&nbsp;(pcbuf&nbsp;!=&nbsp;nil),&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="2098881">//&nbsp;collector&nbsp;(callback&nbsp;!=&nbsp;nil).&nbsp;&nbsp;A&nbsp;little&nbsp;clunky&nbsp;to&nbsp;merge&nbsp;these,&nbsp;but&nbsp;avoids</span><br>
<span class="lineno"></span><span class="comment" id="2098957">//&nbsp;duplicating&nbsp;the&nbsp;code&nbsp;and&nbsp;all&nbsp;its&nbsp;subtlety.</span><br>
<span class="lineno"></span><span class="keyword" id="2099003">func</span>&nbsp;<span class="ident" id="2099008">gentraceback</span><span class="op" id="2099020">(</span><span class="ident" id="2099021">pc0</span>&nbsp;<span class="builtintype" id="2099025">uintptr</span><span class="op" id="2099032">,</span>&nbsp;<span class="ident" id="2099034">sp0</span>&nbsp;<span class="builtintype" id="2099038">uintptr</span><span class="op" id="2099045">,</span>&nbsp;<span class="ident" id="2099047">lr0</span>&nbsp;<span class="builtintype" id="2099051">uintptr</span><span class="op" id="2099058">,</span>&nbsp;<span class="ident" id="2099060">gp</span>&nbsp;<span class="op" id="2099063">*</span><span class="ident" id="2099064">g</span><span class="op" id="2099065">,</span>&nbsp;<span class="ident" id="2099067">skip</span>&nbsp;<span class="builtintype" id="2099072">int</span><span class="op" id="2099075">,</span>&nbsp;<span class="ident" id="2099077">pcbuf</span>&nbsp;<span class="op" id="2099083">*</span><span class="builtintype" id="2099084">uintptr</span><span class="op" id="2099091">,</span>&nbsp;<span class="ident" id="2099093">max</span>&nbsp;<span class="builtintype" id="2099097">int</span><span class="op" id="2099100">,</span>&nbsp;<span class="ident" id="2099102">callback</span>&nbsp;<span class="keyword" id="2099111">func</span><span class="op" id="2099115">(</span><span class="op" id="2099116">*</span><span class="ident" id="2099117">stkframe</span><span class="op" id="2099125">,</span>&nbsp;<span class="ident" id="2099127">unsafe</span><span class="op" id="2099133">.</span><span class="ident" id="2099134">Pointer</span><span class="op" id="2099141">)</span>&nbsp;<span class="builtintype" id="2099143">bool</span><span class="op" id="2099147">,</span>&nbsp;<span class="ident" id="2099149">v</span>&nbsp;<span class="ident" id="2099151">unsafe</span><span class="op" id="2099157">.</span><span class="ident" id="2099158">Pointer</span><span class="op" id="2099165">,</span>&nbsp;<span class="ident" id="2099167">flags</span>&nbsp;<span class="builtintype" id="2099173">uint</span><span class="op" id="2099177">)</span>&nbsp;<span class="builtintype" id="2099179">int</span>&nbsp;<span class="op" id="2099183">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099186">if</span>&nbsp;<span class="ident" id="2099189">goexitPC</span>&nbsp;<span class="op" id="2099198">==</span>&nbsp;<span class="num" id="2099201">0</span>&nbsp;<span class="op" id="2099203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099207">gothrow</span><span class="op" id="2099214">(</span><span class="string" id="2099215">&#34;gentraceback&nbsp;before&nbsp;goexitPC&nbsp;initialization&#34;</span><span class="op" id="2099260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099266">g</span>&nbsp;<span class="op" id="2099268">:=</span>&nbsp;<span class="ident" id="2099271">getg</span><span class="op" id="2099275">(</span><span class="op" id="2099276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099279">if</span>&nbsp;<span class="ident" id="2099282">g</span>&nbsp;<span class="op" id="2099284">==</span>&nbsp;<span class="ident" id="2099287">gp</span>&nbsp;<span class="op" id="2099290">&amp;&amp;</span>&nbsp;<span class="ident" id="2099293">g</span>&nbsp;<span class="op" id="2099295">==</span>&nbsp;<span class="ident" id="2099298">g</span><span class="op" id="2099299">.</span><span class="ident" id="2099300">m</span><span class="op" id="2099301">.</span><span class="ident" id="2099302">curg</span>&nbsp;<span class="op" id="2099307">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099311">//&nbsp;The&nbsp;starting&nbsp;sp&nbsp;has&nbsp;been&nbsp;passed&nbsp;in&nbsp;as&nbsp;a&nbsp;uintptr,&nbsp;and&nbsp;the&nbsp;caller&nbsp;may</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099384">//&nbsp;have&nbsp;other&nbsp;uintptr-typed&nbsp;stack&nbsp;references&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099440">//&nbsp;If&nbsp;during&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;that&nbsp;got&nbsp;us&nbsp;here&nbsp;or&nbsp;during&nbsp;one&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099510">//&nbsp;callbacks&nbsp;below&nbsp;the&nbsp;stack&nbsp;must&nbsp;be&nbsp;grown,&nbsp;all&nbsp;these&nbsp;uintptr&nbsp;references</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099585">//&nbsp;to&nbsp;the&nbsp;stack&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;and&nbsp;gentraceback&nbsp;will&nbsp;continue</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099655">//&nbsp;to&nbsp;inspect&nbsp;the&nbsp;old&nbsp;stack&nbsp;memory,&nbsp;which&nbsp;may&nbsp;no&nbsp;longer&nbsp;be&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099723">//&nbsp;Even&nbsp;if&nbsp;all&nbsp;the&nbsp;variables&nbsp;were&nbsp;updated&nbsp;correctly,&nbsp;it&nbsp;is&nbsp;not&nbsp;clear&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099799">//&nbsp;we&nbsp;want&nbsp;to&nbsp;expose&nbsp;a&nbsp;traceback&nbsp;that&nbsp;begins&nbsp;on&nbsp;one&nbsp;stack&nbsp;and&nbsp;ends</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099868">//&nbsp;on&nbsp;another&nbsp;stack.&nbsp;That&nbsp;could&nbsp;confuse&nbsp;callers&nbsp;quite&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099931">//&nbsp;Instead,&nbsp;we&nbsp;require&nbsp;that&nbsp;gentraceback&nbsp;and&nbsp;any&nbsp;other&nbsp;function&nbsp;that</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2100002">//&nbsp;accepts&nbsp;an&nbsp;sp&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;(typically&nbsp;obtained&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2100070">//&nbsp;calling&nbsp;getcallersp)&nbsp;must&nbsp;not&nbsp;run&nbsp;on&nbsp;that&nbsp;goroutine&#39;s&nbsp;stack&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2100139">//&nbsp;instead&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100169">gothrow</span><span class="op" id="2100176">(</span><span class="string" id="2100177">&#34;gentraceback&nbsp;cannot&nbsp;trace&nbsp;user&nbsp;goroutine&nbsp;on&nbsp;its&nbsp;own&nbsp;stack&#34;</span><span class="op" id="2100236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100239">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100242">gotraceback</span>&nbsp;<span class="op" id="2100254">:=</span>&nbsp;<span class="ident" id="2100257">gotraceback</span><span class="op" id="2100268">(</span><span class="ident" id="2100269">nil</span><span class="op" id="2100272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100275">if</span>&nbsp;<span class="ident" id="2100278">pc0</span>&nbsp;<span class="op" id="2100282">==</span>&nbsp;<span class="op" id="2100285">^</span><span class="builtintype" id="2100286">uintptr</span><span class="op" id="2100293">(</span><span class="num" id="2100294">0</span><span class="op" id="2100295">)</span>&nbsp;<span class="op" id="2100297">&amp;&amp;</span>&nbsp;<span class="ident" id="2100300">sp0</span>&nbsp;<span class="op" id="2100304">==</span>&nbsp;<span class="op" id="2100307">^</span><span class="builtintype" id="2100308">uintptr</span><span class="op" id="2100315">(</span><span class="num" id="2100316">0</span><span class="op" id="2100317">)</span>&nbsp;<span class="op" id="2100319">{</span>&nbsp;<span class="comment" id="2100321">//&nbsp;Signal&nbsp;to&nbsp;fetch&nbsp;saved&nbsp;values&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100364">if</span>&nbsp;<span class="ident" id="2100367">gp</span><span class="op" id="2100369">.</span><span class="ident" id="2100370">syscallsp</span>&nbsp;<span class="op" id="2100380">!=</span>&nbsp;<span class="num" id="2100383">0</span>&nbsp;<span class="op" id="2100385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100390">pc0</span>&nbsp;<span class="op" id="2100394">=</span>&nbsp;<span class="ident" id="2100396">gp</span><span class="op" id="2100398">.</span><span class="ident" id="2100399">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100412">sp0</span>&nbsp;<span class="op" id="2100416">=</span>&nbsp;<span class="ident" id="2100418">gp</span><span class="op" id="2100420">.</span><span class="ident" id="2100421">syscallsp</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100434">if</span>&nbsp;<span class="ident" id="2100437">usesLR</span>&nbsp;<span class="op" id="2100444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100450">lr0</span>&nbsp;<span class="op" id="2100454">=</span>&nbsp;<span class="num" id="2100456">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100465">}</span>&nbsp;<span class="keyword" id="2100467">else</span>&nbsp;<span class="op" id="2100472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100477">pc0</span>&nbsp;<span class="op" id="2100481">=</span>&nbsp;<span class="ident" id="2100483">gp</span><span class="op" id="2100485">.</span><span class="ident" id="2100486">sched</span><span class="op" id="2100491">.</span><span class="ident" id="2100492">pc</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100498">sp0</span>&nbsp;<span class="op" id="2100502">=</span>&nbsp;<span class="ident" id="2100504">gp</span><span class="op" id="2100506">.</span><span class="ident" id="2100507">sched</span><span class="op" id="2100512">.</span><span class="ident" id="2100513">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100519">if</span>&nbsp;<span class="ident" id="2100522">usesLR</span>&nbsp;<span class="op" id="2100529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100535">lr0</span>&nbsp;<span class="op" id="2100539">=</span>&nbsp;<span class="ident" id="2100541">gp</span><span class="op" id="2100543">.</span><span class="ident" id="2100544">sched</span><span class="op" id="2100549">.</span><span class="ident" id="2100550">lr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100560">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100567">nprint</span>&nbsp;<span class="op" id="2100574">:=</span>&nbsp;<span class="num" id="2100577">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100580">var</span>&nbsp;<span class="ident" id="2100584">frame</span>&nbsp;<span class="ident" id="2100590">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100600">frame</span><span class="op" id="2100605">.</span><span class="ident" id="2100606">pc</span>&nbsp;<span class="op" id="2100609">=</span>&nbsp;<span class="ident" id="2100611">pc0</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100616">frame</span><span class="op" id="2100621">.</span><span class="ident" id="2100622">sp</span>&nbsp;<span class="op" id="2100625">=</span>&nbsp;<span class="ident" id="2100627">sp0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100632">if</span>&nbsp;<span class="ident" id="2100635">usesLR</span>&nbsp;<span class="op" id="2100642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100646">frame</span><span class="op" id="2100651">.</span><span class="ident" id="2100652">lr</span>&nbsp;<span class="op" id="2100655">=</span>&nbsp;<span class="ident" id="2100657">lr0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100665">waspanic</span>&nbsp;<span class="op" id="2100674">:=</span>&nbsp;<span class="builtintype" id="2100677">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100684">wasnewproc</span>&nbsp;<span class="op" id="2100695">:=</span>&nbsp;<span class="builtintype" id="2100698">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100705">printing</span>&nbsp;<span class="op" id="2100714">:=</span>&nbsp;<span class="ident" id="2100717">pcbuf</span>&nbsp;<span class="op" id="2100723">==</span>&nbsp;<span class="ident" id="2100726">nil</span>&nbsp;<span class="op" id="2100730">&amp;&amp;</span>&nbsp;<span class="ident" id="2100733">callback</span>&nbsp;<span class="op" id="2100742">==</span>&nbsp;<span class="ident" id="2100745">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100750">_defer</span>&nbsp;<span class="op" id="2100757">:=</span>&nbsp;<span class="ident" id="2100760">gp</span><span class="op" id="2100762">.</span><span class="ident" id="2100763">_defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100772">for</span>&nbsp;<span class="ident" id="2100776">_defer</span>&nbsp;<span class="op" id="2100783">!=</span>&nbsp;<span class="ident" id="2100786">nil</span>&nbsp;<span class="op" id="2100790">&amp;&amp;</span>&nbsp;<span class="builtintype" id="2100793">uintptr</span><span class="op" id="2100800">(</span><span class="ident" id="2100801">_defer</span><span class="op" id="2100807">.</span><span class="ident" id="2100808">argp</span><span class="op" id="2100812">)</span>&nbsp;<span class="op" id="2100814">==</span>&nbsp;<span class="ident" id="2100817">_NoArgs</span>&nbsp;<span class="op" id="2100825">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100829">_defer</span>&nbsp;<span class="op" id="2100836">=</span>&nbsp;<span class="ident" id="2100838">_defer</span><span class="op" id="2100844">.</span><span class="ident" id="2100845">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2100855">//&nbsp;If&nbsp;the&nbsp;PC&nbsp;is&nbsp;zero,&nbsp;it&#39;s&nbsp;likely&nbsp;a&nbsp;nil&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2100911">//&nbsp;Start&nbsp;in&nbsp;the&nbsp;caller&#39;s&nbsp;frame.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100944">if</span>&nbsp;<span class="ident" id="2100947">frame</span><span class="op" id="2100952">.</span><span class="ident" id="2100953">pc</span>&nbsp;<span class="op" id="2100956">==</span>&nbsp;<span class="num" id="2100959">0</span>&nbsp;<span class="op" id="2100961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100965">if</span>&nbsp;<span class="ident" id="2100968">usesLR</span>&nbsp;<span class="op" id="2100975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100980">frame</span><span class="op" id="2100985">.</span><span class="ident" id="2100986">pc</span>&nbsp;<span class="op" id="2100989">=</span>&nbsp;<span class="op" id="2100991">*</span><span class="op" id="2100992">(</span><span class="op" id="2100993">*</span><span class="builtintype" id="2100994">uintptr</span><span class="op" id="2101001">)</span><span class="op" id="2101002">(</span><span class="ident" id="2101003">unsafe</span><span class="op" id="2101009">.</span><span class="ident" id="2101010">Pointer</span><span class="op" id="2101017">(</span><span class="ident" id="2101018">frame</span><span class="op" id="2101023">.</span><span class="ident" id="2101024">sp</span><span class="op" id="2101026">)</span><span class="op" id="2101027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101032">frame</span><span class="op" id="2101037">.</span><span class="ident" id="2101038">lr</span>&nbsp;<span class="op" id="2101041">=</span>&nbsp;<span class="num" id="2101043">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101047">}</span>&nbsp;<span class="keyword" id="2101049">else</span>&nbsp;<span class="op" id="2101054">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101059">frame</span><span class="op" id="2101064">.</span><span class="ident" id="2101065">pc</span>&nbsp;<span class="op" id="2101068">=</span>&nbsp;<span class="builtintype" id="2101070">uintptr</span><span class="op" id="2101077">(</span><span class="op" id="2101078">*</span><span class="op" id="2101079">(</span><span class="op" id="2101080">*</span><span class="ident" id="2101081">uintreg</span><span class="op" id="2101088">)</span><span class="op" id="2101089">(</span><span class="ident" id="2101090">unsafe</span><span class="op" id="2101096">.</span><span class="ident" id="2101097">Pointer</span><span class="op" id="2101104">(</span><span class="ident" id="2101105">frame</span><span class="op" id="2101110">.</span><span class="ident" id="2101111">sp</span><span class="op" id="2101113">)</span><span class="op" id="2101114">)</span><span class="op" id="2101115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101120">frame</span><span class="op" id="2101125">.</span><span class="ident" id="2101126">sp</span>&nbsp;<span class="op" id="2101129">+=</span>&nbsp;<span class="ident" id="2101132">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101149">f</span>&nbsp;<span class="op" id="2101151">:=</span>&nbsp;<span class="ident" id="2101154">findfunc</span><span class="op" id="2101162">(</span><span class="ident" id="2101163">frame</span><span class="op" id="2101168">.</span><span class="ident" id="2101169">pc</span><span class="op" id="2101171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101174">if</span>&nbsp;<span class="ident" id="2101177">f</span>&nbsp;<span class="op" id="2101179">==</span>&nbsp;<span class="ident" id="2101182">nil</span>&nbsp;<span class="op" id="2101186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101190">if</span>&nbsp;<span class="ident" id="2101193">callback</span>&nbsp;<span class="op" id="2101202">!=</span>&nbsp;<span class="ident" id="2101205">nil</span>&nbsp;<span class="op" id="2101209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2101214">print</span><span class="op" id="2101219">(</span><span class="string" id="2101220">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;&#34;</span><span class="op" id="2101242">,</span>&nbsp;<span class="ident" id="2101244">hex</span><span class="op" id="2101247">(</span><span class="ident" id="2101248">frame</span><span class="op" id="2101253">.</span><span class="ident" id="2101254">pc</span><span class="op" id="2101256">)</span><span class="op" id="2101257">,</span>&nbsp;<span class="string" id="2101259">&#34;\n&#34;</span><span class="op" id="2101263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101268">gothrow</span><span class="op" id="2101275">(</span><span class="string" id="2101276">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="2101288">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101296">return</span>&nbsp;<span class="num" id="2101303">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101309">frame</span><span class="op" id="2101314">.</span><span class="ident" id="2101315">fn</span>&nbsp;<span class="op" id="2101318">=</span>&nbsp;<span class="ident" id="2101320">f</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101324">n</span>&nbsp;<span class="op" id="2101326">:=</span>&nbsp;<span class="num" id="2101329">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101332">for</span>&nbsp;<span class="ident" id="2101336">n</span>&nbsp;<span class="op" id="2101338">&lt;</span>&nbsp;<span class="ident" id="2101340">max</span>&nbsp;<span class="op" id="2101344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101348">//&nbsp;Typically:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101364">//&nbsp;&nbsp;&nbsp;&nbsppc&nbsp;is&nbsp;the&nbsp;PC&nbsp;of&nbsp;the&nbsp;running&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101407">//&nbsp;&nbsp;&nbsp;&nbspsp&nbsp;is&nbsp;the&nbsp;stack&nbsp;pointer&nbsp;at&nbsp;that&nbsp;program&nbsp;counter.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101461">//&nbsp;&nbsp;&nbsp;&nbspfp&nbsp;is&nbsp;the&nbsp;frame&nbsp;pointer&nbsp;(caller&#39;s&nbsp;stack&nbsp;pointer)&nbsp;at&nbsp;that&nbsp;program&nbsp;counter,&nbsp;or&nbsp;nil&nbsp;if&nbsp;unknown.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101559">//&nbsp;&nbsp;&nbsp;&nbspstk&nbsp;is&nbsp;the&nbsp;stack&nbsp;containing&nbsp;sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101596">//&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;caller&#39;s&nbsp;program&nbsp;counter&nbsp;is&nbsp;lr,&nbsp;unless&nbsp;lr&nbsp;is&nbsp;zero,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;is&nbsp;*(uintptr*)sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101691">f</span>&nbsp;<span class="op" id="2101693">=</span>&nbsp;<span class="ident" id="2101695">frame</span><span class="op" id="2101700">.</span><span class="ident" id="2101701">fn</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101707">//&nbsp;Found&nbsp;an&nbsp;actual&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101738">//&nbsp;Derive&nbsp;frame&nbsp;pointer&nbsp;and&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101783">if</span>&nbsp;<span class="ident" id="2101786">frame</span><span class="op" id="2101791">.</span><span class="ident" id="2101792">fp</span>&nbsp;<span class="op" id="2101795">==</span>&nbsp;<span class="num" id="2101798">0</span>&nbsp;<span class="op" id="2101800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101805">frame</span><span class="op" id="2101810">.</span><span class="ident" id="2101811">fp</span>&nbsp;<span class="op" id="2101814">=</span>&nbsp;<span class="ident" id="2101816">frame</span><span class="op" id="2101821">.</span><span class="ident" id="2101822">sp</span>&nbsp;<span class="op" id="2101825">+</span>&nbsp;<span class="builtintype" id="2101827">uintptr</span><span class="op" id="2101834">(</span><span class="ident" id="2101835">funcspdelta</span><span class="op" id="2101846">(</span><span class="ident" id="2101847">f</span><span class="op" id="2101848">,</span>&nbsp;<span class="ident" id="2101850">frame</span><span class="op" id="2101855">.</span><span class="ident" id="2101856">pc</span><span class="op" id="2101858">)</span><span class="op" id="2101859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101864">if</span>&nbsp;<span class="op" id="2101867">!</span><span class="ident" id="2101868">usesLR</span>&nbsp;<span class="op" id="2101875">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2101881">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2101960">frame</span><span class="op" id="2101965">.</span><span class="ident" id="2101966">fp</span>&nbsp;<span class="op" id="2101969">+=</span>&nbsp;<span class="ident" id="2101972">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2101987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2101991">var</span>&nbsp;<span class="ident" id="2101995">flr</span>&nbsp;<span class="op" id="2101999">*</span><span class="ident" id="2102000">_func</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2102008">if</span>&nbsp;<span class="ident" id="2102011">topofstack</span><span class="op" id="2102021">(</span><span class="ident" id="2102022">f</span><span class="op" id="2102023">)</span>&nbsp;<span class="op" id="2102025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102030">frame</span><span class="op" id="2102035">.</span><span class="ident" id="2102036">lr</span>&nbsp;<span class="op" id="2102039">=</span>&nbsp;<span class="num" id="2102041">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102046">flr</span>&nbsp;<span class="op" id="2102050">=</span>&nbsp;<span class="ident" id="2102052">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102058">}</span>&nbsp;<span class="keyword" id="2102060">else</span>&nbsp;<span class="keyword" id="2102065">if</span>&nbsp;<span class="ident" id="2102068">usesLR</span>&nbsp;<span class="op" id="2102075">&amp;&amp;</span>&nbsp;<span class="ident" id="2102078">f</span><span class="op" id="2102079">.</span><span class="ident" id="2102080">entry</span>&nbsp;<span class="op" id="2102086">==</span>&nbsp;<span class="ident" id="2102089">jmpdeferPC</span>&nbsp;<span class="op" id="2102100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102105">//&nbsp;jmpdefer&nbsp;modifies&nbsp;SP/LR/PC&nbsp;non-atomically.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102154">//&nbsp;If&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;arrives&nbsp;during&nbsp;jmpdefer,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102210">//&nbsp;the&nbsp;stack&nbsp;unwind&nbsp;may&nbsp;see&nbsp;a&nbsp;mismatched&nbsp;register&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102267">//&nbsp;and&nbsp;get&nbsp;confused.&nbsp;Stop&nbsp;if&nbsp;we&nbsp;see&nbsp;PC&nbsp;within&nbsp;jmpdefer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102325">//&nbsp;to&nbsp;avoid&nbsp;that&nbsp;confusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102356">//&nbsp;See&nbsp;golang.org/issue/8153.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2102389">if</span>&nbsp;<span class="ident" id="2102392">callback</span>&nbsp;<span class="op" id="2102401">!=</span>&nbsp;<span class="ident" id="2102404">nil</span>&nbsp;<span class="op" id="2102408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102414">gothrow</span><span class="op" id="2102421">(</span><span class="string" id="2102422">&#34;traceback_arm:&nbsp;found&nbsp;jmpdefer&nbsp;when&nbsp;tracing&nbsp;with&nbsp;callback&#34;</span><span class="op" id="2102480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102490">frame</span><span class="op" id="2102495">.</span><span class="ident" id="2102496">lr</span>&nbsp;<span class="op" id="2102499">=</span>&nbsp;<span class="num" id="2102501">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102505">}</span>&nbsp;<span class="keyword" id="2102507">else</span>&nbsp;<span class="op" id="2102512">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2102517">if</span>&nbsp;<span class="ident" id="2102520">usesLR</span>&nbsp;<span class="op" id="2102527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2102533">if</span>&nbsp;<span class="ident" id="2102536">n</span>&nbsp;<span class="op" id="2102538">==</span>&nbsp;<span class="num" id="2102541">0</span>&nbsp;<span class="op" id="2102543">&amp;&amp;</span>&nbsp;<span class="ident" id="2102546">frame</span><span class="op" id="2102551">.</span><span class="ident" id="2102552">sp</span>&nbsp;<span class="op" id="2102555">&lt;</span>&nbsp;<span class="ident" id="2102557">frame</span><span class="op" id="2102562">.</span><span class="ident" id="2102563">fp</span>&nbsp;<span class="op" id="2102566">||</span>&nbsp;<span class="ident" id="2102569">frame</span><span class="op" id="2102574">.</span><span class="ident" id="2102575">lr</span>&nbsp;<span class="op" id="2102578">==</span>&nbsp;<span class="num" id="2102581">0</span>&nbsp;<span class="op" id="2102583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102590">frame</span><span class="op" id="2102595">.</span><span class="ident" id="2102596">lr</span>&nbsp;<span class="op" id="2102599">=</span>&nbsp;<span class="op" id="2102601">*</span><span class="op" id="2102602">(</span><span class="op" id="2102603">*</span><span class="builtintype" id="2102604">uintptr</span><span class="op" id="2102611">)</span><span class="op" id="2102612">(</span><span class="ident" id="2102613">unsafe</span><span class="op" id="2102619">.</span><span class="ident" id="2102620">Pointer</span><span class="op" id="2102627">(</span><span class="ident" id="2102628">frame</span><span class="op" id="2102633">.</span><span class="ident" id="2102634">sp</span><span class="op" id="2102636">)</span><span class="op" id="2102637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102648">}</span>&nbsp;<span class="keyword" id="2102650">else</span>&nbsp;<span class="op" id="2102655">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2102661">if</span>&nbsp;<span class="ident" id="2102664">frame</span><span class="op" id="2102669">.</span><span class="ident" id="2102670">lr</span>&nbsp;<span class="op" id="2102673">==</span>&nbsp;<span class="num" id="2102676">0</span>&nbsp;<span class="op" id="2102678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102685">frame</span><span class="op" id="2102690">.</span><span class="ident" id="2102691">lr</span>&nbsp;<span class="op" id="2102694">=</span>&nbsp;<span class="builtintype" id="2102696">uintptr</span><span class="op" id="2102703">(</span><span class="op" id="2102704">*</span><span class="op" id="2102705">(</span><span class="op" id="2102706">*</span><span class="ident" id="2102707">uintreg</span><span class="op" id="2102714">)</span><span class="op" id="2102715">(</span><span class="ident" id="2102716">unsafe</span><span class="op" id="2102722">.</span><span class="ident" id="2102723">Pointer</span><span class="op" id="2102730">(</span><span class="ident" id="2102731">frame</span><span class="op" id="2102736">.</span><span class="ident" id="2102737">fp</span>&nbsp;<span class="op" id="2102740">-</span>&nbsp;<span class="ident" id="2102742">regSize</span><span class="op" id="2102749">)</span><span class="op" id="2102750">)</span><span class="op" id="2102751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2102762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2102767">flr</span>&nbsp;<span class="op" id="2102771">=</span>&nbsp;<span class="ident" id="2102773">findfunc</span><span class="op" id="2102781">(</span><span class="ident" id="2102782">frame</span><span class="op" id="2102787">.</span><span class="ident" id="2102788">lr</span><span class="op" id="2102790">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2102795">if</span>&nbsp;<span class="ident" id="2102798">flr</span>&nbsp;<span class="op" id="2102802">==</span>&nbsp;<span class="ident" id="2102805">nil</span>&nbsp;<span class="op" id="2102809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102815">//&nbsp;This&nbsp;happens&nbsp;if&nbsp;you&nbsp;get&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;at&nbsp;just&nbsp;the&nbsp;wrong&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102892">//&nbsp;In&nbsp;that&nbsp;context&nbsp;it&nbsp;is&nbsp;okay&nbsp;to&nbsp;stop&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2102941">//&nbsp;But&nbsp;if&nbsp;callback&nbsp;is&nbsp;set,&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;and&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103014">//&nbsp;get&nbsp;everything,&nbsp;so&nbsp;crash&nbsp;loudly.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2103054">if</span>&nbsp;<span class="ident" id="2103057">callback</span>&nbsp;<span class="op" id="2103066">!=</span>&nbsp;<span class="ident" id="2103069">nil</span>&nbsp;<span class="op" id="2103073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2103080">print</span><span class="op" id="2103085">(</span><span class="string" id="2103086">&#34;runtime:&nbsp;unexpected&nbsp;return&nbsp;pc&nbsp;for&nbsp;&#34;</span><span class="op" id="2103122">,</span>&nbsp;<span class="ident" id="2103124">gofuncname</span><span class="op" id="2103134">(</span><span class="ident" id="2103135">f</span><span class="op" id="2103136">)</span><span class="op" id="2103137">,</span>&nbsp;<span class="string" id="2103139">&#34;&nbsp;called&nbsp;from&nbsp;&#34;</span><span class="op" id="2103154">,</span>&nbsp;<span class="ident" id="2103156">hex</span><span class="op" id="2103159">(</span><span class="ident" id="2103160">frame</span><span class="op" id="2103165">.</span><span class="ident" id="2103166">lr</span><span class="op" id="2103168">)</span><span class="op" id="2103169">,</span>&nbsp;<span class="string" id="2103171">&#34;\n&#34;</span><span class="op" id="2103175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2103182">gothrow</span><span class="op" id="2103189">(</span><span class="string" id="2103190">&#34;unknown&nbsp;caller&nbsp;pc&#34;</span><span class="op" id="2103209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2103215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2103220">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2103224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2103229">frame</span><span class="op" id="2103234">.</span><span class="ident" id="2103235">varp</span>&nbsp;<span class="op" id="2103240">=</span>&nbsp;<span class="ident" id="2103242">frame</span><span class="op" id="2103247">.</span><span class="ident" id="2103248">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2103253">if</span>&nbsp;<span class="op" id="2103256">!</span><span class="ident" id="2103257">usesLR</span>&nbsp;<span class="op" id="2103264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103269">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2103347">frame</span><span class="op" id="2103352">.</span><span class="ident" id="2103353">varp</span>&nbsp;<span class="op" id="2103358">-=</span>&nbsp;<span class="ident" id="2103361">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2103371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103376">//&nbsp;Derive&nbsp;size&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103407">//&nbsp;Most&nbsp;functions&nbsp;have&nbsp;a&nbsp;fixed-size&nbsp;argument&nbsp;block,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103461">//&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;metadata&nbsp;about&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103511">//&nbsp;Not&nbsp;all,&nbsp;though:&nbsp;there&nbsp;are&nbsp;some&nbsp;variadic&nbsp;functions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103567">//&nbsp;in&nbsp;package&nbsp;runtime&nbsp;and&nbsp;reflect,&nbsp;and&nbsp;for&nbsp;those&nbsp;we&nbsp;use&nbsp;call-specific</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103639">//&nbsp;metadata&nbsp;recorded&nbsp;by&nbsp;f&#39;s&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2103677">if</span>&nbsp;<span class="ident" id="2103680">callback</span>&nbsp;<span class="op" id="2103689">!=</span>&nbsp;<span class="ident" id="2103692">nil</span>&nbsp;<span class="op" id="2103696">||</span>&nbsp;<span class="ident" id="2103699">printing</span>&nbsp;<span class="op" id="2103708">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2103713">frame</span><span class="op" id="2103718">.</span><span class="ident" id="2103719">argp</span>&nbsp;<span class="op" id="2103724">=</span>&nbsp;<span class="ident" id="2103726">frame</span><span class="op" id="2103731">.</span><span class="ident" id="2103732">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2103738">if</span>&nbsp;<span class="ident" id="2103741">usesLR</span>&nbsp;<span class="op" id="2103748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2103754">frame</span><span class="op" id="2103759">.</span><span class="ident" id="2103760">argp</span>&nbsp;<span class="op" id="2103765">+=</span>&nbsp;<span class="ident" id="2103768">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2103779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2103784">setArgInfo</span><span class="op" id="2103794">(</span><span class="op" id="2103795">&amp;</span><span class="ident" id="2103796">frame</span><span class="op" id="2103801">,</span>&nbsp;<span class="ident" id="2103803">f</span><span class="op" id="2103804">,</span>&nbsp;<span class="ident" id="2103806">callback</span>&nbsp;<span class="op" id="2103815">!=</span>&nbsp;<span class="ident" id="2103818">nil</span><span class="op" id="2103821">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2103825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103830">//&nbsp;Determine&nbsp;function&nbsp;SP&nbsp;where&nbsp;deferproc&nbsp;would&nbsp;find&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2103899">var</span>&nbsp;<span class="ident" id="2103903">sparg</span>&nbsp;<span class="builtintype" id="2103909">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2103919">if</span>&nbsp;<span class="ident" id="2103922">usesLR</span>&nbsp;<span class="op" id="2103929">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2103934">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack&nbsp;plus&nbsp;1&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104020">//&nbsp;for&nbsp;the&nbsp;saved&nbsp;LR.&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104106">//&nbsp;however,&nbsp;the&nbsp;SP&nbsp;is&nbsp;three&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104162">//&nbsp;If&nbsp;the&nbsp;function&nbsp;has&nbsp;no&nbsp;frame&nbsp;at&nbsp;all&nbsp;-&nbsp;perhaps&nbsp;it&nbsp;just&nbsp;started,&nbsp;or&nbsp;perhaps</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104242">//&nbsp;it&nbsp;is&nbsp;a&nbsp;leaf&nbsp;with&nbsp;no&nbsp;local&nbsp;variables&nbsp;-&nbsp;then&nbsp;we&nbsp;cannot&nbsp;possibly&nbsp;find&nbsp;its</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104320">//&nbsp;SP&nbsp;in&nbsp;a&nbsp;defer,&nbsp;and&nbsp;we&nbsp;might&nbsp;confuse&nbsp;its&nbsp;SP&nbsp;for&nbsp;its&nbsp;caller&#39;s&nbsp;SP,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104393">//&nbsp;leave&nbsp;sparg=0&nbsp;in&nbsp;that&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2104427">if</span>&nbsp;<span class="ident" id="2104430">frame</span><span class="op" id="2104435">.</span><span class="ident" id="2104436">fp</span>&nbsp;<span class="op" id="2104439">!=</span>&nbsp;<span class="ident" id="2104442">frame</span><span class="op" id="2104447">.</span><span class="ident" id="2104448">sp</span>&nbsp;<span class="op" id="2104451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2104457">sparg</span>&nbsp;<span class="op" id="2104463">=</span>&nbsp;<span class="ident" id="2104465">frame</span><span class="op" id="2104470">.</span><span class="ident" id="2104471">sp</span>&nbsp;<span class="op" id="2104474">+</span>&nbsp;<span class="ident" id="2104476">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2104488">if</span>&nbsp;<span class="ident" id="2104491">wasnewproc</span>&nbsp;<span class="op" id="2104502">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2104509">sparg</span>&nbsp;<span class="op" id="2104515">+=</span>&nbsp;<span class="num" id="2104518">3</span>&nbsp;<span class="op" id="2104520">*</span>&nbsp;<span class="ident" id="2104522">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2104534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2104539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2104543">}</span>&nbsp;<span class="keyword" id="2104545">else</span>&nbsp;<span class="op" id="2104550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104555">//&nbsp;On&nbsp;x86&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack,&nbsp;so&nbsp;SP&nbsp;exactly.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104620">//&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,&nbsp;however,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104697">//&nbsp;the&nbsp;SP&nbsp;is&nbsp;two&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2104742">sparg</span>&nbsp;<span class="op" id="2104748">=</span>&nbsp;<span class="ident" id="2104750">frame</span><span class="op" id="2104755">.</span><span class="ident" id="2104756">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2104762">if</span>&nbsp;<span class="ident" id="2104765">wasnewproc</span>&nbsp;<span class="op" id="2104776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2104782">sparg</span>&nbsp;<span class="op" id="2104788">+=</span>&nbsp;<span class="num" id="2104791">2</span>&nbsp;<span class="op" id="2104793">*</span>&nbsp;<span class="ident" id="2104795">ptrSize</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2104806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2104810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104815">//&nbsp;Determine&nbsp;frame&#39;s&nbsp;&#39;continuation&nbsp;PC&#39;,&nbsp;where&nbsp;it&nbsp;can&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104880">//&nbsp;Normally&nbsp;this&nbsp;is&nbsp;the&nbsp;return&nbsp;address&nbsp;on&nbsp;the&nbsp;stack,&nbsp;but&nbsp;if&nbsp;sigpanic</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2104951">//&nbsp;is&nbsp;immediately&nbsp;below&nbsp;this&nbsp;function&nbsp;on&nbsp;the&nbsp;stack,&nbsp;then&nbsp;the&nbsp;frame</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105020">//&nbsp;stopped&nbsp;executing&nbsp;due&nbsp;to&nbsp;a&nbsp;trap,&nbsp;and&nbsp;frame.pc&nbsp;is&nbsp;probably&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105087">//&nbsp;a&nbsp;safe&nbsp;point&nbsp;for&nbsp;looking&nbsp;up&nbsp;liveness&nbsp;information.&nbsp;In&nbsp;this&nbsp;panicking&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105166">//&nbsp;the&nbsp;function&nbsp;either&nbsp;doesn&#39;t&nbsp;return&nbsp;at&nbsp;all&nbsp;(if&nbsp;it&nbsp;has&nbsp;no&nbsp;defers&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105244">//&nbsp;defers&nbsp;do&nbsp;not&nbsp;recover)&nbsp;or&nbsp;it&nbsp;returns&nbsp;from&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;to</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105311">//&nbsp;deferproc&nbsp;a&nbsp;second&nbsp;time&nbsp;(if&nbsp;the&nbsp;corresponding&nbsp;deferred&nbsp;func&nbsp;recovers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105387">//&nbsp;It&nbsp;suffices&nbsp;to&nbsp;assume&nbsp;that&nbsp;the&nbsp;most&nbsp;recent&nbsp;deferproc&nbsp;is&nbsp;the&nbsp;one&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105461">//&nbsp;returns;&nbsp;everything&nbsp;live&nbsp;at&nbsp;earlier&nbsp;deferprocs&nbsp;is&nbsp;still&nbsp;live&nbsp;at&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2105540">frame</span><span class="op" id="2105545">.</span><span class="ident" id="2105546">continpc</span>&nbsp;<span class="op" id="2105555">=</span>&nbsp;<span class="ident" id="2105557">frame</span><span class="op" id="2105562">.</span><span class="ident" id="2105563">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105568">if</span>&nbsp;<span class="ident" id="2105571">waspanic</span>&nbsp;<span class="op" id="2105580">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105585">if</span>&nbsp;<span class="ident" id="2105588">_defer</span>&nbsp;<span class="op" id="2105595">!=</span>&nbsp;<span class="ident" id="2105598">nil</span>&nbsp;<span class="op" id="2105602">&amp;&amp;</span>&nbsp;<span class="ident" id="2105605">_defer</span><span class="op" id="2105611">.</span><span class="ident" id="2105612">argp</span>&nbsp;<span class="op" id="2105617">==</span>&nbsp;<span class="ident" id="2105620">sparg</span>&nbsp;<span class="op" id="2105626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2105632">frame</span><span class="op" id="2105637">.</span><span class="ident" id="2105638">continpc</span>&nbsp;<span class="op" id="2105647">=</span>&nbsp;<span class="ident" id="2105649">_defer</span><span class="op" id="2105655">.</span><span class="ident" id="2105656">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105662">}</span>&nbsp;<span class="keyword" id="2105664">else</span>&nbsp;<span class="op" id="2105669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2105675">frame</span><span class="op" id="2105680">.</span><span class="ident" id="2105681">continpc</span>&nbsp;<span class="op" id="2105690">=</span>&nbsp;<span class="num" id="2105692">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105697">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2105706">//&nbsp;Unwind&nbsp;our&nbsp;local&nbsp;defer&nbsp;stack&nbsp;past&nbsp;this&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105757">for</span>&nbsp;<span class="ident" id="2105761">_defer</span>&nbsp;<span class="op" id="2105768">!=</span>&nbsp;<span class="ident" id="2105771">nil</span>&nbsp;<span class="op" id="2105775">&amp;&amp;</span>&nbsp;<span class="op" id="2105778">(</span><span class="ident" id="2105779">_defer</span><span class="op" id="2105785">.</span><span class="ident" id="2105786">argp</span>&nbsp;<span class="op" id="2105791">==</span>&nbsp;<span class="ident" id="2105794">sparg</span>&nbsp;<span class="op" id="2105800">||</span>&nbsp;<span class="ident" id="2105803">_defer</span><span class="op" id="2105809">.</span><span class="ident" id="2105810">argp</span>&nbsp;<span class="op" id="2105815">==</span>&nbsp;<span class="ident" id="2105818">_NoArgs</span><span class="op" id="2105825">)</span>&nbsp;<span class="op" id="2105827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2105832">_defer</span>&nbsp;<span class="op" id="2105839">=</span>&nbsp;<span class="ident" id="2105841">_defer</span><span class="op" id="2105847">.</span><span class="ident" id="2105848">link</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105860">if</span>&nbsp;<span class="ident" id="2105863">skip</span>&nbsp;<span class="op" id="2105868">&gt;</span>&nbsp;<span class="num" id="2105870">0</span>&nbsp;<span class="op" id="2105872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2105877">skip</span><span class="op" id="2105881">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105887">goto</span>&nbsp;<span class="ident" id="2105892">skipped</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105907">if</span>&nbsp;<span class="ident" id="2105910">pcbuf</span>&nbsp;<span class="op" id="2105916">!=</span>&nbsp;<span class="ident" id="2105919">nil</span>&nbsp;<span class="op" id="2105923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105928">(</span><span class="op" id="2105929">*</span><span class="op" id="2105930">[</span><span class="num" id="2105931">1</span>&nbsp;<span class="op" id="2105933">&lt;&lt;</span>&nbsp;<span class="num" id="2105936">20</span><span class="op" id="2105938">]</span><span class="builtintype" id="2105939">uintptr</span><span class="op" id="2105946">)</span><span class="op" id="2105947">(</span><span class="ident" id="2105948">unsafe</span><span class="op" id="2105954">.</span><span class="ident" id="2105955">Pointer</span><span class="op" id="2105962">(</span><span class="ident" id="2105963">pcbuf</span><span class="op" id="2105968">)</span><span class="op" id="2105969">)</span><span class="op" id="2105970">[</span><span class="ident" id="2105971">n</span><span class="op" id="2105972">]</span>&nbsp;<span class="op" id="2105974">=</span>&nbsp;<span class="ident" id="2105976">frame</span><span class="op" id="2105981">.</span><span class="ident" id="2105982">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2105987">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2105991">if</span>&nbsp;<span class="ident" id="2105994">callback</span>&nbsp;<span class="op" id="2106003">!=</span>&nbsp;<span class="ident" id="2106006">nil</span>&nbsp;<span class="op" id="2106010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106015">if</span>&nbsp;<span class="op" id="2106018">!</span><span class="ident" id="2106019">callback</span><span class="op" id="2106027">(</span><span class="op" id="2106028">(</span><span class="op" id="2106029">*</span><span class="ident" id="2106030">stkframe</span><span class="op" id="2106038">)</span><span class="op" id="2106039">(</span><span class="ident" id="2106040">noescape</span><span class="op" id="2106048">(</span><span class="ident" id="2106049">unsafe</span><span class="op" id="2106055">.</span><span class="ident" id="2106056">Pointer</span><span class="op" id="2106063">(</span><span class="op" id="2106064">&amp;</span><span class="ident" id="2106065">frame</span><span class="op" id="2106070">)</span><span class="op" id="2106071">)</span><span class="op" id="2106072">)</span><span class="op" id="2106073">,</span>&nbsp;<span class="ident" id="2106075">v</span><span class="op" id="2106076">)</span>&nbsp;<span class="op" id="2106078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106084">return</span>&nbsp;<span class="ident" id="2106091">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106100">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106104">if</span>&nbsp;<span class="ident" id="2106107">printing</span>&nbsp;<span class="op" id="2106116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106121">if</span>&nbsp;<span class="op" id="2106124">(</span><span class="ident" id="2106125">flags</span><span class="op" id="2106130">&amp;</span><span class="ident" id="2106131">_TraceRuntimeFrames</span><span class="op" id="2106150">)</span>&nbsp;<span class="op" id="2106152">!=</span>&nbsp;<span class="num" id="2106155">0</span>&nbsp;<span class="op" id="2106157">||</span>&nbsp;<span class="ident" id="2106160">showframe</span><span class="op" id="2106169">(</span><span class="ident" id="2106170">f</span><span class="op" id="2106171">,</span>&nbsp;<span class="ident" id="2106173">gp</span><span class="op" id="2106175">)</span>&nbsp;<span class="op" id="2106177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2106183">//&nbsp;Print&nbsp;during&nbsp;crash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2106210">//&nbsp;&nbsp;&nbsp;&nbspmain(0x1,&nbsp;0x2,&nbsp;0x3)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2106237">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp/home/rsc/go/src/runtime/x.go:23&nbsp;+0xf</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2106283">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2106290">tracepc</span>&nbsp;<span class="op" id="2106298">:=</span>&nbsp;<span class="ident" id="2106301">frame</span><span class="op" id="2106306">.</span><span class="ident" id="2106307">pc</span>&nbsp;<span class="comment" id="2106310">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106359">if</span>&nbsp;<span class="op" id="2106362">(</span><span class="ident" id="2106363">n</span>&nbsp;<span class="op" id="2106365">&gt;</span>&nbsp;<span class="num" id="2106367">0</span>&nbsp;<span class="op" id="2106369">||</span>&nbsp;<span class="ident" id="2106372">flags</span><span class="op" id="2106377">&amp;</span><span class="ident" id="2106378">_TraceTrap</span>&nbsp;<span class="op" id="2106389">==</span>&nbsp;<span class="num" id="2106392">0</span><span class="op" id="2106393">)</span>&nbsp;<span class="op" id="2106395">&amp;&amp;</span>&nbsp;<span class="ident" id="2106398">frame</span><span class="op" id="2106403">.</span><span class="ident" id="2106404">pc</span>&nbsp;<span class="op" id="2106407">&gt;</span>&nbsp;<span class="ident" id="2106409">f</span><span class="op" id="2106410">.</span><span class="ident" id="2106411">entry</span>&nbsp;<span class="op" id="2106417">&amp;&amp;</span>&nbsp;<span class="op" id="2106420">!</span><span class="ident" id="2106421">waspanic</span>&nbsp;<span class="op" id="2106430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2106437">tracepc</span><span class="op" id="2106444">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106451">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106457">print</span><span class="op" id="2106462">(</span><span class="ident" id="2106463">gofuncname</span><span class="op" id="2106473">(</span><span class="ident" id="2106474">f</span><span class="op" id="2106475">)</span><span class="op" id="2106476">,</span>&nbsp;<span class="string" id="2106478">&#34;(&#34;</span><span class="op" id="2106481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2106487">argp</span>&nbsp;<span class="op" id="2106492">:=</span>&nbsp;<span class="op" id="2106495">(</span><span class="op" id="2106496">*</span><span class="op" id="2106497">[</span><span class="num" id="2106498">100</span><span class="op" id="2106501">]</span><span class="builtintype" id="2106502">uintptr</span><span class="op" id="2106509">)</span><span class="op" id="2106510">(</span><span class="ident" id="2106511">unsafe</span><span class="op" id="2106517">.</span><span class="ident" id="2106518">Pointer</span><span class="op" id="2106525">(</span><span class="ident" id="2106526">frame</span><span class="op" id="2106531">.</span><span class="ident" id="2106532">argp</span><span class="op" id="2106536">)</span><span class="op" id="2106537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106543">for</span>&nbsp;<span class="ident" id="2106547">i</span>&nbsp;<span class="op" id="2106549">:=</span>&nbsp;<span class="builtintype" id="2106552">uintptr</span><span class="op" id="2106559">(</span><span class="num" id="2106560">0</span><span class="op" id="2106561">)</span><span class="op" id="2106562">;</span>&nbsp;<span class="ident" id="2106564">i</span>&nbsp;<span class="op" id="2106566">&lt;</span>&nbsp;<span class="ident" id="2106568">frame</span><span class="op" id="2106573">.</span><span class="ident" id="2106574">arglen</span><span class="op" id="2106580">/</span><span class="ident" id="2106581">ptrSize</span><span class="op" id="2106588">;</span>&nbsp;<span class="ident" id="2106590">i</span><span class="op" id="2106591">++</span>&nbsp;<span class="op" id="2106594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106601">if</span>&nbsp;<span class="ident" id="2106604">i</span>&nbsp;<span class="op" id="2106606">&gt;=</span>&nbsp;<span class="num" id="2106609">10</span>&nbsp;<span class="op" id="2106612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106620">print</span><span class="op" id="2106625">(</span><span class="string" id="2106626">&#34;,&nbsp;...&#34;</span><span class="op" id="2106633">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106641">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106659">if</span>&nbsp;<span class="ident" id="2106662">i</span>&nbsp;<span class="op" id="2106664">!=</span>&nbsp;<span class="num" id="2106667">0</span>&nbsp;<span class="op" id="2106669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106677">print</span><span class="op" id="2106682">(</span><span class="string" id="2106683">&#34;,&nbsp;&#34;</span><span class="op" id="2106687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106694">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106701">print</span><span class="op" id="2106706">(</span><span class="ident" id="2106707">hex</span><span class="op" id="2106710">(</span><span class="ident" id="2106711">argp</span><span class="op" id="2106715">[</span><span class="ident" id="2106716">i</span><span class="op" id="2106717">]</span><span class="op" id="2106718">)</span><span class="op" id="2106719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106731">print</span><span class="op" id="2106736">(</span><span class="string" id="2106737">&#34;)\n&#34;</span><span class="op" id="2106742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106748">var</span>&nbsp;<span class="ident" id="2106752">file</span>&nbsp;<span class="builtintype" id="2106757">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2106768">line</span>&nbsp;<span class="op" id="2106773">:=</span>&nbsp;<span class="ident" id="2106776">funcline</span><span class="op" id="2106784">(</span><span class="ident" id="2106785">f</span><span class="op" id="2106786">,</span>&nbsp;<span class="ident" id="2106788">tracepc</span><span class="op" id="2106795">,</span>&nbsp;<span class="op" id="2106797">&amp;</span><span class="ident" id="2106798">file</span><span class="op" id="2106802">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106808">print</span><span class="op" id="2106813">(</span><span class="string" id="2106814">&#34;\t&#34;</span><span class="op" id="2106818">,</span>&nbsp;<span class="ident" id="2106820">file</span><span class="op" id="2106824">,</span>&nbsp;<span class="string" id="2106826">&#34;:&#34;</span><span class="op" id="2106829">,</span>&nbsp;<span class="ident" id="2106831">line</span><span class="op" id="2106835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106841">if</span>&nbsp;<span class="ident" id="2106844">frame</span><span class="op" id="2106849">.</span><span class="ident" id="2106850">pc</span>&nbsp;<span class="op" id="2106853">&gt;</span>&nbsp;<span class="ident" id="2106855">f</span><span class="op" id="2106856">.</span><span class="ident" id="2106857">entry</span>&nbsp;<span class="op" id="2106863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106870">print</span><span class="op" id="2106875">(</span><span class="string" id="2106876">&#34;&nbsp;+&#34;</span><span class="op" id="2106880">,</span>&nbsp;<span class="ident" id="2106882">hex</span><span class="op" id="2106885">(</span><span class="ident" id="2106886">frame</span><span class="op" id="2106891">.</span><span class="ident" id="2106892">pc</span><span class="op" id="2106894">-</span><span class="ident" id="2106895">f</span><span class="op" id="2106896">.</span><span class="ident" id="2106897">entry</span><span class="op" id="2106902">)</span><span class="op" id="2106903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2106909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2106915">if</span>&nbsp;<span class="ident" id="2106918">g</span><span class="op" id="2106919">.</span><span class="ident" id="2106920">m</span><span class="op" id="2106921">.</span><span class="ident" id="2106922">throwing</span>&nbsp;<span class="op" id="2106931">&gt;</span>&nbsp;<span class="num" id="2106933">0</span>&nbsp;<span class="op" id="2106935">&amp;&amp;</span>&nbsp;<span class="ident" id="2106938">gp</span>&nbsp;<span class="op" id="2106941">==</span>&nbsp;<span class="ident" id="2106944">g</span><span class="op" id="2106945">.</span><span class="ident" id="2106946">m</span><span class="op" id="2106947">.</span><span class="ident" id="2106948">curg</span>&nbsp;<span class="op" id="2106953">||</span>&nbsp;<span class="ident" id="2106956">gotraceback</span>&nbsp;<span class="op" id="2106968">&gt;=</span>&nbsp;<span class="num" id="2106971">2</span>&nbsp;<span class="op" id="2106973">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2106980">print</span><span class="op" id="2106985">(</span><span class="string" id="2106986">&#34;&nbsp;fp=&#34;</span><span class="op" id="2106992">,</span>&nbsp;<span class="ident" id="2106994">hex</span><span class="op" id="2106997">(</span><span class="ident" id="2106998">frame</span><span class="op" id="2107003">.</span><span class="ident" id="2107004">fp</span><span class="op" id="2107006">)</span><span class="op" id="2107007">,</span>&nbsp;<span class="string" id="2107009">&#34;&nbsp;sp=&#34;</span><span class="op" id="2107015">,</span>&nbsp;<span class="ident" id="2107017">hex</span><span class="op" id="2107020">(</span><span class="ident" id="2107021">frame</span><span class="op" id="2107026">.</span><span class="ident" id="2107027">sp</span><span class="op" id="2107029">)</span><span class="op" id="2107030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2107042">print</span><span class="op" id="2107047">(</span><span class="string" id="2107048">&#34;\n&#34;</span><span class="op" id="2107052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107058">nprint</span><span class="op" id="2107064">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107070">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107078">n</span><span class="op" id="2107079">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107084">skipped</span><span class="op" id="2107091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107095">waspanic</span>&nbsp;<span class="op" id="2107104">=</span>&nbsp;<span class="ident" id="2107106">f</span><span class="op" id="2107107">.</span><span class="ident" id="2107108">entry</span>&nbsp;<span class="op" id="2107114">==</span>&nbsp;<span class="ident" id="2107117">sigpanicPC</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107130">wasnewproc</span>&nbsp;<span class="op" id="2107141">=</span>&nbsp;<span class="ident" id="2107143">f</span><span class="op" id="2107144">.</span><span class="ident" id="2107145">entry</span>&nbsp;<span class="op" id="2107151">==</span>&nbsp;<span class="ident" id="2107154">newprocPC</span>&nbsp;<span class="op" id="2107164">||</span>&nbsp;<span class="ident" id="2107167">f</span><span class="op" id="2107168">.</span><span class="ident" id="2107169">entry</span>&nbsp;<span class="op" id="2107175">==</span>&nbsp;<span class="ident" id="2107178">deferprocPC</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107193">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;past&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2107242">if</span>&nbsp;<span class="ident" id="2107245">flr</span>&nbsp;<span class="op" id="2107249">==</span>&nbsp;<span class="ident" id="2107252">nil</span>&nbsp;<span class="op" id="2107256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2107261">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107274">//&nbsp;Unwind&nbsp;to&nbsp;next&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107301">frame</span><span class="op" id="2107306">.</span><span class="ident" id="2107307">fn</span>&nbsp;<span class="op" id="2107310">=</span>&nbsp;<span class="ident" id="2107312">flr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107318">frame</span><span class="op" id="2107323">.</span><span class="ident" id="2107324">pc</span>&nbsp;<span class="op" id="2107327">=</span>&nbsp;<span class="ident" id="2107329">frame</span><span class="op" id="2107334">.</span><span class="ident" id="2107335">lr</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107340">frame</span><span class="op" id="2107345">.</span><span class="ident" id="2107346">lr</span>&nbsp;<span class="op" id="2107349">=</span>&nbsp;<span class="num" id="2107351">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107355">frame</span><span class="op" id="2107360">.</span><span class="ident" id="2107361">sp</span>&nbsp;<span class="op" id="2107364">=</span>&nbsp;<span class="ident" id="2107366">frame</span><span class="op" id="2107371">.</span><span class="ident" id="2107372">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107377">frame</span><span class="op" id="2107382">.</span><span class="ident" id="2107383">fp</span>&nbsp;<span class="op" id="2107386">=</span>&nbsp;<span class="num" id="2107388">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107392">frame</span><span class="op" id="2107397">.</span><span class="ident" id="2107398">argmap</span>&nbsp;<span class="op" id="2107405">=</span>&nbsp;<span class="ident" id="2107407">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107414">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;sighandler&nbsp;saves&nbsp;the&nbsp;LR&nbsp;on&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107484">//&nbsp;before&nbsp;faking&nbsp;a&nbsp;call&nbsp;to&nbsp;sigpanic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2107523">if</span>&nbsp;<span class="ident" id="2107526">usesLR</span>&nbsp;<span class="op" id="2107533">&amp;&amp;</span>&nbsp;<span class="ident" id="2107536">waspanic</span>&nbsp;<span class="op" id="2107545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107550">x</span>&nbsp;<span class="op" id="2107552">:=</span>&nbsp;<span class="op" id="2107555">*</span><span class="op" id="2107556">(</span><span class="op" id="2107557">*</span><span class="builtintype" id="2107558">uintptr</span><span class="op" id="2107565">)</span><span class="op" id="2107566">(</span><span class="ident" id="2107567">unsafe</span><span class="op" id="2107573">.</span><span class="ident" id="2107574">Pointer</span><span class="op" id="2107581">(</span><span class="ident" id="2107582">frame</span><span class="op" id="2107587">.</span><span class="ident" id="2107588">sp</span><span class="op" id="2107590">)</span><span class="op" id="2107591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107596">frame</span><span class="op" id="2107601">.</span><span class="ident" id="2107602">sp</span>&nbsp;<span class="op" id="2107605">+=</span>&nbsp;<span class="ident" id="2107608">ptrSize</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107619">f</span>&nbsp;<span class="op" id="2107621">=</span>&nbsp;<span class="ident" id="2107623">findfunc</span><span class="op" id="2107631">(</span><span class="ident" id="2107632">frame</span><span class="op" id="2107637">.</span><span class="ident" id="2107638">pc</span><span class="op" id="2107640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107645">frame</span><span class="op" id="2107650">.</span><span class="ident" id="2107651">fn</span>&nbsp;<span class="op" id="2107654">=</span>&nbsp;<span class="ident" id="2107656">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2107661">if</span>&nbsp;<span class="ident" id="2107664">f</span>&nbsp;<span class="op" id="2107666">==</span>&nbsp;<span class="ident" id="2107669">nil</span>&nbsp;<span class="op" id="2107673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107679">frame</span><span class="op" id="2107684">.</span><span class="ident" id="2107685">pc</span>&nbsp;<span class="op" id="2107688">=</span>&nbsp;<span class="ident" id="2107690">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107695">}</span>&nbsp;<span class="keyword" id="2107697">else</span>&nbsp;<span class="keyword" id="2107702">if</span>&nbsp;<span class="ident" id="2107705">f</span><span class="op" id="2107706">.</span><span class="ident" id="2107707">frame</span>&nbsp;<span class="op" id="2107713">==</span>&nbsp;<span class="num" id="2107716">0</span>&nbsp;<span class="op" id="2107718">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107724">frame</span><span class="op" id="2107729">.</span><span class="ident" id="2107730">lr</span>&nbsp;<span class="op" id="2107733">=</span>&nbsp;<span class="ident" id="2107735">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2107751">if</span>&nbsp;<span class="ident" id="2107754">pcbuf</span>&nbsp;<span class="op" id="2107760">==</span>&nbsp;<span class="ident" id="2107763">nil</span>&nbsp;<span class="op" id="2107767">&amp;&amp;</span>&nbsp;<span class="ident" id="2107770">callback</span>&nbsp;<span class="op" id="2107779">==</span>&nbsp;<span class="ident" id="2107782">nil</span>&nbsp;<span class="op" id="2107786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2107790">n</span>&nbsp;<span class="op" id="2107792">=</span>&nbsp;<span class="ident" id="2107794">nprint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2107802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107806">//&nbsp;If&nbsp;callback&nbsp;!=&nbsp;nil,&nbsp;we&#39;re&nbsp;being&nbsp;called&nbsp;to&nbsp;gather&nbsp;stack&nbsp;information&nbsp;during</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107884">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth.&nbsp;In&nbsp;that&nbsp;context,&nbsp;require&nbsp;that&nbsp;we&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2107962">//&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;not,&nbsp;then&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;somewhere&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108039">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth&nbsp;may&nbsp;not&nbsp;have&nbsp;seen&nbsp;the&nbsp;correct&nbsp;picture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108116">//&nbsp;of&nbsp;the&nbsp;stack.&nbsp;Crash&nbsp;now&nbsp;instead&nbsp;of&nbsp;silently&nbsp;executing&nbsp;the&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108197">//&nbsp;or&nbsp;stack&nbsp;copy&nbsp;incorrectly&nbsp;and&nbsp;setting&nbsp;up&nbsp;for&nbsp;a&nbsp;mysterious&nbsp;crash&nbsp;later.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108272">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108276">//&nbsp;Note&nbsp;that&nbsp;panic&nbsp;!=&nbsp;nil&nbsp;is&nbsp;okay&nbsp;here:&nbsp;there&nbsp;can&nbsp;be&nbsp;leftover&nbsp;panics,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108347">//&nbsp;because&nbsp;the&nbsp;defers&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;do&nbsp;not&nbsp;nest&nbsp;in&nbsp;frame&nbsp;order&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108419">//&nbsp;they&nbsp;do&nbsp;on&nbsp;the&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;you&nbsp;have:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108464">//</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108468">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;1&nbsp;defers&nbsp;d1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108490">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;2&nbsp;defers&nbsp;d2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108512">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;3&nbsp;defers&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108534">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;4&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108553">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;4&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108595">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;5,&nbsp;running&nbsp;d3,&nbsp;defers&nbsp;d4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108630">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;5&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108649">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;5&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108691">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;6,&nbsp;running&nbsp;d4,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108733">//&nbsp;&nbsp;&nbsp;&nbspframe&nbsp;6,&nbsp;running&nbsp;d2,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108775">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108779">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d4,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d4&nbsp;-&gt;&nbsp;d3,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108846">//&nbsp;is&nbsp;nested&nbsp;properly,&nbsp;and&nbsp;we&#39;ll&nbsp;treat&nbsp;frame&nbsp;3&nbsp;as&nbsp;resumable,&nbsp;because&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108919">//&nbsp;can&nbsp;find&nbsp;d3.&nbsp;(And&nbsp;in&nbsp;fact&nbsp;frame&nbsp;3&nbsp;is&nbsp;resumable.&nbsp;If&nbsp;d4&nbsp;recovers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2108986">//&nbsp;and&nbsp;frame&nbsp;5&nbsp;continues&nbsp;running,&nbsp;d3,&nbsp;d3&nbsp;can&nbsp;recover&nbsp;and&nbsp;we&#39;ll</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109050">//&nbsp;resume&nbsp;execution&nbsp;in&nbsp;(returning&nbsp;from)&nbsp;frame&nbsp;3.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109101">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109105">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d2,&nbsp;however,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d2&nbsp;-&gt;&nbsp;d3,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109175">//&nbsp;which&nbsp;is&nbsp;inverted.&nbsp;The&nbsp;scan&nbsp;will&nbsp;match&nbsp;d2&nbsp;to&nbsp;frame&nbsp;2&nbsp;but&nbsp;having</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109243">//&nbsp;d2&nbsp;on&nbsp;the&nbsp;stack&nbsp;until&nbsp;then&nbsp;means&nbsp;it&nbsp;will&nbsp;not&nbsp;match&nbsp;d3&nbsp;to&nbsp;frame&nbsp;3.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109313">//&nbsp;This&nbsp;is&nbsp;okay:&nbsp;if&nbsp;we&#39;re&nbsp;running&nbsp;d2,&nbsp;then&nbsp;all&nbsp;the&nbsp;defers&nbsp;after&nbsp;d2&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109386">//&nbsp;completed&nbsp;and&nbsp;their&nbsp;corresponding&nbsp;frames&nbsp;are&nbsp;dead.&nbsp;Not&nbsp;finding&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109456">//&nbsp;for&nbsp;frame&nbsp;3&nbsp;means&nbsp;we&#39;ll&nbsp;set&nbsp;frame&nbsp;3&#39;s&nbsp;continpc&nbsp;==&nbsp;0,&nbsp;which&nbsp;is&nbsp;correct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109530">//&nbsp;(frame&nbsp;3&nbsp;is&nbsp;dead).&nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;walk&nbsp;the&nbsp;panic&nbsp;stack&nbsp;can&nbsp;thus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109601">//&nbsp;contain&nbsp;defers&nbsp;(d3&nbsp;in&nbsp;this&nbsp;case)&nbsp;for&nbsp;dead&nbsp;frames.&nbsp;The&nbsp;inversion&nbsp;here</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109674">//&nbsp;always&nbsp;indicates&nbsp;a&nbsp;dead&nbsp;frame,&nbsp;and&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;inversion&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109748">//&nbsp;scan&nbsp;is&nbsp;to&nbsp;hide&nbsp;those&nbsp;dead&nbsp;frames,&nbsp;so&nbsp;the&nbsp;scan&nbsp;is&nbsp;still&nbsp;okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109814">//&nbsp;what&#39;s&nbsp;left&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;are&nbsp;exactly&nbsp;(and&nbsp;only)&nbsp;the&nbsp;dead&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109889">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109893">//&nbsp;We&nbsp;require&nbsp;callback&nbsp;!=&nbsp;nil&nbsp;here&nbsp;because&nbsp;only&nbsp;when&nbsp;callback&nbsp;!=&nbsp;nil</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2109963">//&nbsp;do&nbsp;we&nbsp;know&nbsp;that&nbsp;gentraceback&nbsp;is&nbsp;being&nbsp;called&nbsp;in&nbsp;a&nbsp;&#34;must&nbsp;be&nbsp;correct&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110035">//&nbsp;context&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;&#34;best&nbsp;effort&#34;&nbsp;context.&nbsp;The&nbsp;tracebacks&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110106">//&nbsp;callbacks&nbsp;only&nbsp;happen&nbsp;when&nbsp;everything&nbsp;is&nbsp;stopped&nbsp;nicely.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110167">//&nbsp;At&nbsp;other&nbsp;times,&nbsp;such&nbsp;as&nbsp;when&nbsp;gathering&nbsp;a&nbsp;stack&nbsp;for&nbsp;a&nbsp;profiling&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110241">//&nbsp;or&nbsp;when&nbsp;printing&nbsp;a&nbsp;traceback&nbsp;during&nbsp;a&nbsp;crash,&nbsp;everything&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110312">//&nbsp;stopped&nbsp;nicely,&nbsp;and&nbsp;the&nbsp;stack&nbsp;walk&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;complete.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110380">//&nbsp;It&#39;s&nbsp;okay&nbsp;in&nbsp;those&nbsp;situations&nbsp;not&nbsp;to&nbsp;use&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2110452">//&nbsp;incomplete&nbsp;information&nbsp;then&nbsp;is&nbsp;still&nbsp;better&nbsp;than&nbsp;nothing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2110514">if</span>&nbsp;<span class="ident" id="2110517">callback</span>&nbsp;<span class="op" id="2110526">!=</span>&nbsp;<span class="ident" id="2110529">nil</span>&nbsp;<span class="op" id="2110533">&amp;&amp;</span>&nbsp;<span class="ident" id="2110536">n</span>&nbsp;<span class="op" id="2110538">&lt;</span>&nbsp;<span class="ident" id="2110540">max</span>&nbsp;<span class="op" id="2110544">&amp;&amp;</span>&nbsp;<span class="ident" id="2110547">_defer</span>&nbsp;<span class="op" id="2110554">!=</span>&nbsp;<span class="ident" id="2110557">nil</span>&nbsp;<span class="op" id="2110561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2110565">if</span>&nbsp;<span class="ident" id="2110568">_defer</span>&nbsp;<span class="op" id="2110575">!=</span>&nbsp;<span class="ident" id="2110578">nil</span>&nbsp;<span class="op" id="2110582">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2110587">print</span><span class="op" id="2110592">(</span><span class="string" id="2110593">&#34;runtime:&nbsp;g&#34;</span><span class="op" id="2110605">,</span>&nbsp;<span class="ident" id="2110607">gp</span><span class="op" id="2110609">.</span><span class="ident" id="2110610">goid</span><span class="op" id="2110614">,</span>&nbsp;<span class="string" id="2110616">&#34;:&nbsp;leftover&nbsp;defer&nbsp;argp=&#34;</span><span class="op" id="2110640">,</span>&nbsp;<span class="ident" id="2110642">hex</span><span class="op" id="2110645">(</span><span class="ident" id="2110646">_defer</span><span class="op" id="2110652">.</span><span class="ident" id="2110653">argp</span><span class="op" id="2110657">)</span><span class="op" id="2110658">,</span>&nbsp;<span class="string" id="2110660">&#34;&nbsp;pc=&#34;</span><span class="op" id="2110666">,</span>&nbsp;<span class="ident" id="2110668">hex</span><span class="op" id="2110671">(</span><span class="ident" id="2110672">_defer</span><span class="op" id="2110678">.</span><span class="ident" id="2110679">pc</span><span class="op" id="2110681">)</span><span class="op" id="2110682">,</span>&nbsp;<span class="string" id="2110684">&#34;\n&#34;</span><span class="op" id="2110688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2110692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2110696">for</span>&nbsp;<span class="ident" id="2110700">_defer</span>&nbsp;<span class="op" id="2110707">=</span>&nbsp;<span class="ident" id="2110709">gp</span><span class="op" id="2110711">.</span><span class="ident" id="2110712">_defer</span><span class="op" id="2110718">;</span>&nbsp;<span class="ident" id="2110720">_defer</span>&nbsp;<span class="op" id="2110727">!=</span>&nbsp;<span class="ident" id="2110730">nil</span><span class="op" id="2110733">;</span>&nbsp;<span class="ident" id="2110735">_defer</span>&nbsp;<span class="op" id="2110742">=</span>&nbsp;<span class="ident" id="2110744">_defer</span><span class="op" id="2110750">.</span><span class="ident" id="2110751">link</span>&nbsp;<span class="op" id="2110756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2110761">print</span><span class="op" id="2110766">(</span><span class="string" id="2110767">&#34;\tdefer&nbsp;&#34;</span><span class="op" id="2110777">,</span>&nbsp;<span class="ident" id="2110779">_defer</span><span class="op" id="2110785">,</span>&nbsp;<span class="string" id="2110787">&#34;&nbsp;argp=&#34;</span><span class="op" id="2110795">,</span>&nbsp;<span class="ident" id="2110797">hex</span><span class="op" id="2110800">(</span><span class="ident" id="2110801">_defer</span><span class="op" id="2110807">.</span><span class="ident" id="2110808">argp</span><span class="op" id="2110812">)</span><span class="op" id="2110813">,</span>&nbsp;<span class="string" id="2110815">&#34;&nbsp;pc=&#34;</span><span class="op" id="2110821">,</span>&nbsp;<span class="ident" id="2110823">hex</span><span class="op" id="2110826">(</span><span class="ident" id="2110827">_defer</span><span class="op" id="2110833">.</span><span class="ident" id="2110834">pc</span><span class="op" id="2110836">)</span><span class="op" id="2110837">,</span>&nbsp;<span class="string" id="2110839">&#34;\n&#34;</span><span class="op" id="2110843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2110847">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2110851">gothrow</span><span class="op" id="2110858">(</span><span class="string" id="2110859">&#34;traceback&nbsp;has&nbsp;leftover&nbsp;defers&#34;</span><span class="op" id="2110890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2110893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2110897">return</span>&nbsp;<span class="ident" id="2110904">n</span><br>
<span class="lineno"></span><span class="op" id="2110906">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="2110909">func</span>&nbsp;<span class="ident" id="2110914">setArgInfo</span><span class="op" id="2110924">(</span><span class="ident" id="2110925">frame</span>&nbsp;<span class="op" id="2110931">*</span><span class="ident" id="2110932">stkframe</span><span class="op" id="2110940">,</span>&nbsp;<span class="ident" id="2110942">f</span>&nbsp;<span class="op" id="2110944">*</span><span class="ident" id="2110945">_func</span><span class="op" id="2110950">,</span>&nbsp;<span class="ident" id="2110952">needArgMap</span>&nbsp;<span class="builtintype" id="2110963">bool</span><span class="op" id="2110967">)</span>&nbsp;<span class="op" id="2110969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2110972">frame</span><span class="op" id="2110977">.</span><span class="ident" id="2110978">arglen</span>&nbsp;<span class="op" id="2110985">=</span>&nbsp;<span class="builtintype" id="2110987">uintptr</span><span class="op" id="2110994">(</span><span class="ident" id="2110995">f</span><span class="op" id="2110996">.</span><span class="ident" id="2110997">args</span><span class="op" id="2111001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111004">if</span>&nbsp;<span class="ident" id="2111007">needArgMap</span>&nbsp;<span class="op" id="2111018">&amp;&amp;</span>&nbsp;<span class="ident" id="2111021">f</span><span class="op" id="2111022">.</span><span class="ident" id="2111023">args</span>&nbsp;<span class="op" id="2111028">==</span>&nbsp;<span class="ident" id="2111031">_ArgsSizeUnknown</span>&nbsp;<span class="op" id="2111048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2111052">//&nbsp;Extract&nbsp;argument&nbsp;bitmaps&nbsp;for&nbsp;reflect&nbsp;stubs&nbsp;from&nbsp;the&nbsp;calls&nbsp;they&nbsp;made&nbsp;to&nbsp;reflect.</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111137">switch</span>&nbsp;<span class="ident" id="2111144">gofuncname</span><span class="op" id="2111154">(</span><span class="ident" id="2111155">f</span><span class="op" id="2111156">)</span>&nbsp;<span class="op" id="2111158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111162">case</span>&nbsp;<span class="string" id="2111167">&#34;reflect.makeFuncStub&#34;</span><span class="op" id="2111189">,</span>&nbsp;<span class="string" id="2111191">&#34;reflect.methodValueCall&#34;</span><span class="op" id="2111216">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111221">arg0</span>&nbsp;<span class="op" id="2111226">:=</span>&nbsp;<span class="ident" id="2111229">frame</span><span class="op" id="2111234">.</span><span class="ident" id="2111235">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111241">if</span>&nbsp;<span class="ident" id="2111244">usesLR</span>&nbsp;<span class="op" id="2111251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111257">arg0</span>&nbsp;<span class="op" id="2111262">+=</span>&nbsp;<span class="ident" id="2111265">ptrSize</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2111276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111281">fn</span>&nbsp;<span class="op" id="2111284">:=</span>&nbsp;<span class="op" id="2111287">*</span><span class="op" id="2111288">(</span><span class="op" id="2111289">*</span><span class="op" id="2111290">*</span><span class="op" id="2111291">[</span><span class="num" id="2111292">2</span><span class="op" id="2111293">]</span><span class="builtintype" id="2111294">uintptr</span><span class="op" id="2111301">)</span><span class="op" id="2111302">(</span><span class="ident" id="2111303">unsafe</span><span class="op" id="2111309">.</span><span class="ident" id="2111310">Pointer</span><span class="op" id="2111317">(</span><span class="ident" id="2111318">arg0</span><span class="op" id="2111322">)</span><span class="op" id="2111323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111328">if</span>&nbsp;<span class="ident" id="2111331">fn</span><span class="op" id="2111333">[</span><span class="num" id="2111334">0</span><span class="op" id="2111335">]</span>&nbsp;<span class="op" id="2111337">!=</span>&nbsp;<span class="ident" id="2111340">f</span><span class="op" id="2111341">.</span><span class="ident" id="2111342">entry</span>&nbsp;<span class="op" id="2111348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2111354">print</span><span class="op" id="2111359">(</span><span class="string" id="2111360">&#34;runtime:&nbsp;confused&nbsp;by&nbsp;&#34;</span><span class="op" id="2111383">,</span>&nbsp;<span class="ident" id="2111385">gofuncname</span><span class="op" id="2111395">(</span><span class="ident" id="2111396">f</span><span class="op" id="2111397">)</span><span class="op" id="2111398">,</span>&nbsp;<span class="string" id="2111400">&#34;\n&#34;</span><span class="op" id="2111404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111410">gothrow</span><span class="op" id="2111417">(</span><span class="string" id="2111418">&#34;reflect&nbsp;mismatch&#34;</span><span class="op" id="2111436">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2111441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111446">bv</span>&nbsp;<span class="op" id="2111449">:=</span>&nbsp;<span class="op" id="2111452">(</span><span class="op" id="2111453">*</span><span class="ident" id="2111454">bitvector</span><span class="op" id="2111463">)</span><span class="op" id="2111464">(</span><span class="ident" id="2111465">unsafe</span><span class="op" id="2111471">.</span><span class="ident" id="2111472">Pointer</span><span class="op" id="2111479">(</span><span class="ident" id="2111480">fn</span><span class="op" id="2111482">[</span><span class="num" id="2111483">1</span><span class="op" id="2111484">]</span><span class="op" id="2111485">)</span><span class="op" id="2111486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111491">frame</span><span class="op" id="2111496">.</span><span class="ident" id="2111497">arglen</span>&nbsp;<span class="op" id="2111504">=</span>&nbsp;<span class="builtintype" id="2111506">uintptr</span><span class="op" id="2111513">(</span><span class="ident" id="2111514">bv</span><span class="op" id="2111516">.</span><span class="ident" id="2111517">n</span>&nbsp;<span class="op" id="2111519">/</span>&nbsp;<span class="num" id="2111521">2</span>&nbsp;<span class="op" id="2111523">*</span>&nbsp;<span class="ident" id="2111525">ptrSize</span><span class="op" id="2111532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111537">frame</span><span class="op" id="2111542">.</span><span class="ident" id="2111543">argmap</span>&nbsp;<span class="op" id="2111550">=</span>&nbsp;<span class="ident" id="2111552">bv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2111557">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2111560">}</span><br>
<span class="lineno"></span><span class="op" id="2111562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2111565">func</span>&nbsp;<span class="ident" id="2111570">printcreatedby</span><span class="op" id="2111584">(</span><span class="ident" id="2111585">gp</span>&nbsp;<span class="op" id="2111588">*</span><span class="ident" id="2111589">g</span><span class="op" id="2111590">)</span>&nbsp;<span class="op" id="2111592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2111595">//&nbsp;Show&nbsp;what&nbsp;created&nbsp;goroutine,&nbsp;except&nbsp;main&nbsp;goroutine&nbsp;(goid&nbsp;1).</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111660">pc</span>&nbsp;<span class="op" id="2111663">:=</span>&nbsp;<span class="ident" id="2111666">gp</span><span class="op" id="2111668">.</span><span class="ident" id="2111669">gopc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111675">f</span>&nbsp;<span class="op" id="2111677">:=</span>&nbsp;<span class="ident" id="2111680">findfunc</span><span class="op" id="2111688">(</span><span class="ident" id="2111689">pc</span><span class="op" id="2111691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111694">if</span>&nbsp;<span class="ident" id="2111697">f</span>&nbsp;<span class="op" id="2111699">!=</span>&nbsp;<span class="ident" id="2111702">nil</span>&nbsp;<span class="op" id="2111706">&amp;&amp;</span>&nbsp;<span class="ident" id="2111709">showframe</span><span class="op" id="2111718">(</span><span class="ident" id="2111719">f</span><span class="op" id="2111720">,</span>&nbsp;<span class="ident" id="2111722">gp</span><span class="op" id="2111724">)</span>&nbsp;<span class="op" id="2111726">&amp;&amp;</span>&nbsp;<span class="ident" id="2111729">gp</span><span class="op" id="2111731">.</span><span class="ident" id="2111732">goid</span>&nbsp;<span class="op" id="2111737">!=</span>&nbsp;<span class="num" id="2111740">1</span>&nbsp;<span class="op" id="2111742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2111746">print</span><span class="op" id="2111751">(</span><span class="string" id="2111752">&#34;created&nbsp;by&nbsp;&#34;</span><span class="op" id="2111765">,</span>&nbsp;<span class="ident" id="2111767">gofuncname</span><span class="op" id="2111777">(</span><span class="ident" id="2111778">f</span><span class="op" id="2111779">)</span><span class="op" id="2111780">,</span>&nbsp;<span class="string" id="2111782">&#34;\n&#34;</span><span class="op" id="2111786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111790">tracepc</span>&nbsp;<span class="op" id="2111798">:=</span>&nbsp;<span class="ident" id="2111801">pc</span>&nbsp;<span class="comment" id="2111804">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111851">if</span>&nbsp;<span class="ident" id="2111854">pc</span>&nbsp;<span class="op" id="2111857">&gt;</span>&nbsp;<span class="ident" id="2111859">f</span><span class="op" id="2111860">.</span><span class="ident" id="2111861">entry</span>&nbsp;<span class="op" id="2111867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111872">tracepc</span>&nbsp;<span class="op" id="2111880">-=</span>&nbsp;<span class="ident" id="2111883">_PCQuantum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2111896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111900">var</span>&nbsp;<span class="ident" id="2111904">file</span>&nbsp;<span class="builtintype" id="2111909">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2111918">line</span>&nbsp;<span class="op" id="2111923">:=</span>&nbsp;<span class="ident" id="2111926">funcline</span><span class="op" id="2111934">(</span><span class="ident" id="2111935">f</span><span class="op" id="2111936">,</span>&nbsp;<span class="ident" id="2111938">tracepc</span><span class="op" id="2111945">,</span>&nbsp;<span class="op" id="2111947">&amp;</span><span class="ident" id="2111948">file</span><span class="op" id="2111952">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2111956">print</span><span class="op" id="2111961">(</span><span class="string" id="2111962">&#34;\t&#34;</span><span class="op" id="2111966">,</span>&nbsp;<span class="ident" id="2111968">file</span><span class="op" id="2111972">,</span>&nbsp;<span class="string" id="2111974">&#34;:&#34;</span><span class="op" id="2111977">,</span>&nbsp;<span class="ident" id="2111979">line</span><span class="op" id="2111983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2111987">if</span>&nbsp;<span class="ident" id="2111990">pc</span>&nbsp;<span class="op" id="2111993">&gt;</span>&nbsp;<span class="ident" id="2111995">f</span><span class="op" id="2111996">.</span><span class="ident" id="2111997">entry</span>&nbsp;<span class="op" id="2112003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2112008">print</span><span class="op" id="2112013">(</span><span class="string" id="2112014">&#34;&nbsp;+&#34;</span><span class="op" id="2112018">,</span>&nbsp;<span class="ident" id="2112020">hex</span><span class="op" id="2112023">(</span><span class="ident" id="2112024">pc</span><span class="op" id="2112026">-</span><span class="ident" id="2112027">f</span><span class="op" id="2112028">.</span><span class="ident" id="2112029">entry</span><span class="op" id="2112034">)</span><span class="op" id="2112035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2112039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2112043">print</span><span class="op" id="2112048">(</span><span class="string" id="2112049">&#34;\n&#34;</span><span class="op" id="2112053">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2112056">}</span><br>
<span class="lineno"></span><span class="op" id="2112058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2112061">func</span>&nbsp;<span class="ident" id="2112066">traceback</span><span class="op" id="2112075">(</span><span class="ident" id="2112076">pc</span>&nbsp;<span class="builtintype" id="2112079">uintptr</span><span class="op" id="2112086">,</span>&nbsp;<span class="ident" id="2112088">sp</span>&nbsp;<span class="builtintype" id="2112091">uintptr</span><span class="op" id="2112098">,</span>&nbsp;<span class="ident" id="2112100">lr</span>&nbsp;<span class="builtintype" id="2112103">uintptr</span><span class="op" id="2112110">,</span>&nbsp;<span class="ident" id="2112112">gp</span>&nbsp;<span class="op" id="2112115">*</span><span class="ident" id="2112116">g</span><span class="op" id="2112117">)</span>&nbsp;<span class="op" id="2112119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2112122">traceback1</span><span class="op" id="2112132">(</span><span class="ident" id="2112133">pc</span><span class="op" id="2112135">,</span>&nbsp;<span class="ident" id="2112137">sp</span><span class="op" id="2112139">,</span>&nbsp;<span class="ident" id="2112141">lr</span><span class="op" id="2112143">,</span>&nbsp;<span class="ident" id="2112145">gp</span><span class="op" id="2112147">,</span>&nbsp;<span class="num" id="2112149">0</span><span class="op" id="2112150">)</span><br>
<span class="lineno">495</span><span class="op" id="2112152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2112155">//&nbsp;tracebacktrap&nbsp;is&nbsp;like&nbsp;traceback&nbsp;but&nbsp;expects&nbsp;that&nbsp;the&nbsp;PC&nbsp;and&nbsp;SP&nbsp;were&nbsp;obtained</span><br>
<span class="lineno"></span><span class="comment" id="2112235">//&nbsp;from&nbsp;a&nbsp;trap,&nbsp;not&nbsp;from&nbsp;gp-&gt;sched&nbsp;or&nbsp;gp-&gt;syscallpc/gp-&gt;syscallsp&nbsp;or&nbsp;getcallerpc/getcallersp.</span><br>
<span class="lineno"></span><span class="comment" id="2112329">//&nbsp;Because&nbsp;they&nbsp;are&nbsp;from&nbsp;a&nbsp;trap&nbsp;instead&nbsp;of&nbsp;from&nbsp;a&nbsp;saved&nbsp;pair,</span><br>
<span class="lineno">500</span><span class="comment" id="2112391">//&nbsp;the&nbsp;initial&nbsp;PC&nbsp;must&nbsp;not&nbsp;be&nbsp;rewound&nbsp;to&nbsp;the&nbsp;previous&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="2112458">//&nbsp;(All&nbsp;the&nbsp;saved&nbsp;pairs&nbsp;record&nbsp;a&nbsp;PC&nbsp;that&nbsp;is&nbsp;a&nbsp;return&nbsp;address,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="2112526">//&nbsp;rewind&nbsp;it&nbsp;into&nbsp;the&nbsp;CALL&nbsp;instruction.)</span><br>
<span class="lineno"></span><span class="keyword" id="2112567">func</span>&nbsp;<span class="ident" id="2112572">tracebacktrap</span><span class="op" id="2112585">(</span><span class="ident" id="2112586">pc</span>&nbsp;<span class="builtintype" id="2112589">uintptr</span><span class="op" id="2112596">,</span>&nbsp;<span class="ident" id="2112598">sp</span>&nbsp;<span class="builtintype" id="2112601">uintptr</span><span class="op" id="2112608">,</span>&nbsp;<span class="ident" id="2112610">lr</span>&nbsp;<span class="builtintype" id="2112613">uintptr</span><span class="op" id="2112620">,</span>&nbsp;<span class="ident" id="2112622">gp</span>&nbsp;<span class="op" id="2112625">*</span><span class="ident" id="2112626">g</span><span class="op" id="2112627">)</span>&nbsp;<span class="op" id="2112629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2112632">traceback1</span><span class="op" id="2112642">(</span><span class="ident" id="2112643">pc</span><span class="op" id="2112645">,</span>&nbsp;<span class="ident" id="2112647">sp</span><span class="op" id="2112649">,</span>&nbsp;<span class="ident" id="2112651">lr</span><span class="op" id="2112653">,</span>&nbsp;<span class="ident" id="2112655">gp</span><span class="op" id="2112657">,</span>&nbsp;<span class="ident" id="2112659">_TraceTrap</span><span class="op" id="2112669">)</span><br>
<span class="lineno">505</span><span class="op" id="2112671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2112674">func</span>&nbsp;<span class="ident" id="2112679">traceback1</span><span class="op" id="2112689">(</span><span class="ident" id="2112690">pc</span>&nbsp;<span class="builtintype" id="2112693">uintptr</span><span class="op" id="2112700">,</span>&nbsp;<span class="ident" id="2112702">sp</span>&nbsp;<span class="builtintype" id="2112705">uintptr</span><span class="op" id="2112712">,</span>&nbsp;<span class="ident" id="2112714">lr</span>&nbsp;<span class="builtintype" id="2112717">uintptr</span><span class="op" id="2112724">,</span>&nbsp;<span class="ident" id="2112726">gp</span>&nbsp;<span class="op" id="2112729">*</span><span class="ident" id="2112730">g</span><span class="op" id="2112731">,</span>&nbsp;<span class="ident" id="2112733">flags</span>&nbsp;<span class="builtintype" id="2112739">uint</span><span class="op" id="2112743">)</span>&nbsp;<span class="op" id="2112745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2112748">var</span>&nbsp;<span class="ident" id="2112752">n</span>&nbsp;<span class="builtintype" id="2112754">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2112759">if</span>&nbsp;<span class="ident" id="2112762">readgstatus</span><span class="op" id="2112773">(</span><span class="ident" id="2112774">gp</span><span class="op" id="2112776">)</span><span class="op" id="2112777">&amp;^</span><span class="ident" id="2112779">_Gscan</span>&nbsp;<span class="op" id="2112786">==</span>&nbsp;<span class="ident" id="2112789">_Gsyscall</span>&nbsp;<span class="op" id="2112799">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2112803">//&nbsp;Override&nbsp;registers&nbsp;if&nbsp;blocked&nbsp;in&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2112854">pc</span>&nbsp;<span class="op" id="2112857">=</span>&nbsp;<span class="ident" id="2112859">gp</span><span class="op" id="2112861">.</span><span class="ident" id="2112862">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2112874">sp</span>&nbsp;<span class="op" id="2112877">=</span>&nbsp;<span class="ident" id="2112879">gp</span><span class="op" id="2112881">.</span><span class="ident" id="2112882">syscallsp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2112894">flags</span>&nbsp;<span class="op" id="2112900">&amp;^=</span>&nbsp;<span class="ident" id="2112904">_TraceTrap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2112916">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2112919">//&nbsp;Print&nbsp;traceback.&nbsp;By&nbsp;default,&nbsp;omits&nbsp;runtime&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2112974">//&nbsp;If&nbsp;that&nbsp;means&nbsp;we&nbsp;print&nbsp;nothing&nbsp;at&nbsp;all,&nbsp;repeat&nbsp;forcing&nbsp;all&nbsp;frames&nbsp;printed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113052">n</span>&nbsp;<span class="op" id="2113054">=</span>&nbsp;<span class="ident" id="2113056">gentraceback</span><span class="op" id="2113068">(</span><span class="ident" id="2113069">pc</span><span class="op" id="2113071">,</span>&nbsp;<span class="ident" id="2113073">sp</span><span class="op" id="2113075">,</span>&nbsp;<span class="ident" id="2113077">lr</span><span class="op" id="2113079">,</span>&nbsp;<span class="ident" id="2113081">gp</span><span class="op" id="2113083">,</span>&nbsp;<span class="num" id="2113085">0</span><span class="op" id="2113086">,</span>&nbsp;<span class="ident" id="2113088">nil</span><span class="op" id="2113091">,</span>&nbsp;<span class="ident" id="2113093">_TracebackMaxFrames</span><span class="op" id="2113112">,</span>&nbsp;<span class="ident" id="2113114">nil</span><span class="op" id="2113117">,</span>&nbsp;<span class="ident" id="2113119">nil</span><span class="op" id="2113122">,</span>&nbsp;<span class="ident" id="2113124">flags</span><span class="op" id="2113129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113132">if</span>&nbsp;<span class="ident" id="2113135">n</span>&nbsp;<span class="op" id="2113137">==</span>&nbsp;<span class="num" id="2113140">0</span>&nbsp;<span class="op" id="2113142">&amp;&amp;</span>&nbsp;<span class="op" id="2113145">(</span><span class="ident" id="2113146">flags</span><span class="op" id="2113151">&amp;</span><span class="ident" id="2113152">_TraceRuntimeFrames</span><span class="op" id="2113171">)</span>&nbsp;<span class="op" id="2113173">==</span>&nbsp;<span class="num" id="2113176">0</span>&nbsp;<span class="op" id="2113178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113182">n</span>&nbsp;<span class="op" id="2113184">=</span>&nbsp;<span class="ident" id="2113186">gentraceback</span><span class="op" id="2113198">(</span><span class="ident" id="2113199">pc</span><span class="op" id="2113201">,</span>&nbsp;<span class="ident" id="2113203">sp</span><span class="op" id="2113205">,</span>&nbsp;<span class="ident" id="2113207">lr</span><span class="op" id="2113209">,</span>&nbsp;<span class="ident" id="2113211">gp</span><span class="op" id="2113213">,</span>&nbsp;<span class="num" id="2113215">0</span><span class="op" id="2113216">,</span>&nbsp;<span class="ident" id="2113218">nil</span><span class="op" id="2113221">,</span>&nbsp;<span class="ident" id="2113223">_TracebackMaxFrames</span><span class="op" id="2113242">,</span>&nbsp;<span class="ident" id="2113244">nil</span><span class="op" id="2113247">,</span>&nbsp;<span class="ident" id="2113249">nil</span><span class="op" id="2113252">,</span>&nbsp;<span class="ident" id="2113254">flags</span><span class="op" id="2113259">|</span><span class="ident" id="2113260">_TraceRuntimeFrames</span><span class="op" id="2113279">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2113282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113285">if</span>&nbsp;<span class="ident" id="2113288">n</span>&nbsp;<span class="op" id="2113290">==</span>&nbsp;<span class="ident" id="2113293">_TracebackMaxFrames</span>&nbsp;<span class="op" id="2113313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2113317">print</span><span class="op" id="2113322">(</span><span class="string" id="2113323">&#34;...additional&nbsp;frames&nbsp;elided...\n&#34;</span><span class="op" id="2113357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2113360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113363">printcreatedby</span><span class="op" id="2113377">(</span><span class="ident" id="2113378">gp</span><span class="op" id="2113380">)</span><br>
<span class="lineno">525</span><span class="op" id="2113382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2113385">func</span>&nbsp;<span class="ident" id="2113390">callers</span><span class="op" id="2113397">(</span><span class="ident" id="2113398">skip</span>&nbsp;<span class="builtintype" id="2113403">int</span><span class="op" id="2113406">,</span>&nbsp;<span class="ident" id="2113408">pcbuf</span>&nbsp;<span class="op" id="2113414">*</span><span class="builtintype" id="2113415">uintptr</span><span class="op" id="2113422">,</span>&nbsp;<span class="ident" id="2113424">m</span>&nbsp;<span class="builtintype" id="2113426">int</span><span class="op" id="2113429">)</span>&nbsp;<span class="builtintype" id="2113431">int</span>&nbsp;<span class="op" id="2113435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113438">sp</span>&nbsp;<span class="op" id="2113441">:=</span>&nbsp;<span class="ident" id="2113444">getcallersp</span><span class="op" id="2113455">(</span><span class="ident" id="2113456">unsafe</span><span class="op" id="2113462">.</span><span class="ident" id="2113463">Pointer</span><span class="op" id="2113470">(</span><span class="op" id="2113471">&amp;</span><span class="ident" id="2113472">skip</span><span class="op" id="2113476">)</span><span class="op" id="2113477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113480">pc</span>&nbsp;<span class="op" id="2113483">:=</span>&nbsp;<span class="builtintype" id="2113486">uintptr</span><span class="op" id="2113493">(</span><span class="ident" id="2113494">getcallerpc</span><span class="op" id="2113505">(</span><span class="ident" id="2113506">unsafe</span><span class="op" id="2113512">.</span><span class="ident" id="2113513">Pointer</span><span class="op" id="2113520">(</span><span class="op" id="2113521">&amp;</span><span class="ident" id="2113522">skip</span><span class="op" id="2113526">)</span><span class="op" id="2113527">)</span><span class="op" id="2113528">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113531">var</span>&nbsp;<span class="ident" id="2113535">n</span>&nbsp;<span class="builtintype" id="2113537">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113542">onM</span><span class="op" id="2113545">(</span><span class="keyword" id="2113546">func</span><span class="op" id="2113550">(</span><span class="op" id="2113551">)</span>&nbsp;<span class="op" id="2113553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113557">n</span>&nbsp;<span class="op" id="2113559">=</span>&nbsp;<span class="ident" id="2113561">gentraceback</span><span class="op" id="2113573">(</span><span class="ident" id="2113574">pc</span><span class="op" id="2113576">,</span>&nbsp;<span class="ident" id="2113578">sp</span><span class="op" id="2113580">,</span>&nbsp;<span class="num" id="2113582">0</span><span class="op" id="2113583">,</span>&nbsp;<span class="ident" id="2113585">getg</span><span class="op" id="2113589">(</span><span class="op" id="2113590">)</span><span class="op" id="2113591">,</span>&nbsp;<span class="ident" id="2113593">skip</span><span class="op" id="2113597">,</span>&nbsp;<span class="ident" id="2113599">pcbuf</span><span class="op" id="2113604">,</span>&nbsp;<span class="ident" id="2113606">m</span><span class="op" id="2113607">,</span>&nbsp;<span class="ident" id="2113609">nil</span><span class="op" id="2113612">,</span>&nbsp;<span class="ident" id="2113614">nil</span><span class="op" id="2113617">,</span>&nbsp;<span class="num" id="2113619">0</span><span class="op" id="2113620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2113623">}</span><span class="op" id="2113624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113627">return</span>&nbsp;<span class="ident" id="2113634">n</span><br>
<span class="lineno">535</span><span class="op" id="2113636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2113639">func</span>&nbsp;<span class="ident" id="2113644">gcallers</span><span class="op" id="2113652">(</span><span class="ident" id="2113653">gp</span>&nbsp;<span class="op" id="2113656">*</span><span class="ident" id="2113657">g</span><span class="op" id="2113658">,</span>&nbsp;<span class="ident" id="2113660">skip</span>&nbsp;<span class="builtintype" id="2113665">int</span><span class="op" id="2113668">,</span>&nbsp;<span class="ident" id="2113670">pcbuf</span>&nbsp;<span class="op" id="2113676">*</span><span class="builtintype" id="2113677">uintptr</span><span class="op" id="2113684">,</span>&nbsp;<span class="ident" id="2113686">m</span>&nbsp;<span class="builtintype" id="2113688">int</span><span class="op" id="2113691">)</span>&nbsp;<span class="builtintype" id="2113693">int</span>&nbsp;<span class="op" id="2113697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113700">return</span>&nbsp;<span class="ident" id="2113707">gentraceback</span><span class="op" id="2113719">(</span><span class="op" id="2113720">^</span><span class="builtintype" id="2113721">uintptr</span><span class="op" id="2113728">(</span><span class="num" id="2113729">0</span><span class="op" id="2113730">)</span><span class="op" id="2113731">,</span>&nbsp;<span class="op" id="2113733">^</span><span class="builtintype" id="2113734">uintptr</span><span class="op" id="2113741">(</span><span class="num" id="2113742">0</span><span class="op" id="2113743">)</span><span class="op" id="2113744">,</span>&nbsp;<span class="num" id="2113746">0</span><span class="op" id="2113747">,</span>&nbsp;<span class="ident" id="2113749">gp</span><span class="op" id="2113751">,</span>&nbsp;<span class="ident" id="2113753">skip</span><span class="op" id="2113757">,</span>&nbsp;<span class="ident" id="2113759">pcbuf</span><span class="op" id="2113764">,</span>&nbsp;<span class="ident" id="2113766">m</span><span class="op" id="2113767">,</span>&nbsp;<span class="ident" id="2113769">nil</span><span class="op" id="2113772">,</span>&nbsp;<span class="ident" id="2113774">nil</span><span class="op" id="2113777">,</span>&nbsp;<span class="num" id="2113779">0</span><span class="op" id="2113780">)</span><br>
<span class="lineno"></span><span class="op" id="2113782">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="2113785">func</span>&nbsp;<span class="ident" id="2113790">showframe</span><span class="op" id="2113799">(</span><span class="ident" id="2113800">f</span>&nbsp;<span class="op" id="2113802">*</span><span class="ident" id="2113803">_func</span><span class="op" id="2113808">,</span>&nbsp;<span class="ident" id="2113810">gp</span>&nbsp;<span class="op" id="2113813">*</span><span class="ident" id="2113814">g</span><span class="op" id="2113815">)</span>&nbsp;<span class="builtintype" id="2113817">bool</span>&nbsp;<span class="op" id="2113822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113825">g</span>&nbsp;<span class="op" id="2113827">:=</span>&nbsp;<span class="ident" id="2113830">getg</span><span class="op" id="2113834">(</span><span class="op" id="2113835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113838">if</span>&nbsp;<span class="ident" id="2113841">g</span><span class="op" id="2113842">.</span><span class="ident" id="2113843">m</span><span class="op" id="2113844">.</span><span class="ident" id="2113845">throwing</span>&nbsp;<span class="op" id="2113854">&gt;</span>&nbsp;<span class="num" id="2113856">0</span>&nbsp;<span class="op" id="2113858">&amp;&amp;</span>&nbsp;<span class="ident" id="2113861">gp</span>&nbsp;<span class="op" id="2113864">!=</span>&nbsp;<span class="ident" id="2113867">nil</span>&nbsp;<span class="op" id="2113871">&amp;&amp;</span>&nbsp;<span class="op" id="2113874">(</span><span class="ident" id="2113875">gp</span>&nbsp;<span class="op" id="2113878">==</span>&nbsp;<span class="ident" id="2113881">g</span><span class="op" id="2113882">.</span><span class="ident" id="2113883">m</span><span class="op" id="2113884">.</span><span class="ident" id="2113885">curg</span>&nbsp;<span class="op" id="2113890">||</span>&nbsp;<span class="ident" id="2113893">gp</span>&nbsp;<span class="op" id="2113896">==</span>&nbsp;<span class="ident" id="2113899">g</span><span class="op" id="2113900">.</span><span class="ident" id="2113901">m</span><span class="op" id="2113902">.</span><span class="ident" id="2113903">caughtsig</span><span class="op" id="2113912">)</span>&nbsp;<span class="op" id="2113914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2113918">return</span>&nbsp;<span class="builtintype" id="2113925">true</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2113931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113934">traceback</span>&nbsp;<span class="op" id="2113944">:=</span>&nbsp;<span class="ident" id="2113947">gotraceback</span><span class="op" id="2113958">(</span><span class="ident" id="2113959">nil</span><span class="op" id="2113962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2113965">name</span>&nbsp;<span class="op" id="2113970">:=</span>&nbsp;<span class="ident" id="2113973">gostringnocopy</span><span class="op" id="2113987">(</span><span class="ident" id="2113988">funcname</span><span class="op" id="2113996">(</span><span class="ident" id="2113997">f</span><span class="op" id="2113998">)</span><span class="op" id="2113999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2114003">//&nbsp;Special&nbsp;case:&nbsp;always&nbsp;show&nbsp;runtime.panic&nbsp;frame,&nbsp;so&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2114069">//&nbsp;see&nbsp;where&nbsp;a&nbsp;panic&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2114131">//&nbsp;See&nbsp;golang.org/issue/5832.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2114162">if</span>&nbsp;<span class="ident" id="2114165">name</span>&nbsp;<span class="op" id="2114170">==</span>&nbsp;<span class="string" id="2114173">&#34;runtime.panic&#34;</span>&nbsp;<span class="op" id="2114189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2114193">return</span>&nbsp;<span class="builtintype" id="2114200">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2114206">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2114210">return</span>&nbsp;<span class="ident" id="2114217">traceback</span>&nbsp;<span class="op" id="2114227">&gt;</span>&nbsp;<span class="num" id="2114229">1</span>&nbsp;<span class="op" id="2114231">||</span>&nbsp;<span class="ident" id="2114234">f</span>&nbsp;<span class="op" id="2114236">!=</span>&nbsp;<span class="ident" id="2114239">nil</span>&nbsp;<span class="op" id="2114243">&amp;&amp;</span>&nbsp;<span class="ident" id="2114246">contains</span><span class="op" id="2114254">(</span><span class="ident" id="2114255">name</span><span class="op" id="2114259">,</span>&nbsp;<span class="string" id="2114261">&#34;.&#34;</span><span class="op" id="2114264">)</span>&nbsp;<span class="op" id="2114266">&amp;&amp;</span>&nbsp;<span class="op" id="2114269">(</span><span class="op" id="2114270">!</span><span class="ident" id="2114271">hasprefix</span><span class="op" id="2114280">(</span><span class="ident" id="2114281">name</span><span class="op" id="2114285">,</span>&nbsp;<span class="string" id="2114287">&#34;runtime.&#34;</span><span class="op" id="2114297">)</span>&nbsp;<span class="op" id="2114299">||</span>&nbsp;<span class="ident" id="2114302">isExportedRuntime</span><span class="op" id="2114319">(</span><span class="ident" id="2114320">name</span><span class="op" id="2114324">)</span><span class="op" id="2114325">)</span><br>
<span class="lineno"></span><span class="op" id="2114327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2114330">//&nbsp;isExportedRuntime&nbsp;reports&nbsp;whether&nbsp;name&nbsp;is&nbsp;an&nbsp;exported&nbsp;runtime&nbsp;function.</span><br>
<span class="lineno">560</span><span class="comment" id="2114405">//&nbsp;It&nbsp;is&nbsp;only&nbsp;for&nbsp;runtime&nbsp;functions,&nbsp;so&nbsp;ASCII&nbsp;A-Z&nbsp;is&nbsp;fine.</span><br>
<span class="lineno"></span><span class="keyword" id="2114464">func</span>&nbsp;<span class="ident" id="2114469">isExportedRuntime</span><span class="op" id="2114486">(</span><span class="ident" id="2114487">name</span>&nbsp;<span class="builtintype" id="2114492">string</span><span class="op" id="2114498">)</span>&nbsp;<span class="builtintype" id="2114500">bool</span>&nbsp;<span class="op" id="2114505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2114508">const</span>&nbsp;<span class="ident" id="2114514">n</span>&nbsp;<span class="op" id="2114516">=</span>&nbsp;<span class="builtinfunc" id="2114518">len</span><span class="op" id="2114521">(</span><span class="string" id="2114522">&#34;runtime.&#34;</span><span class="op" id="2114532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2114535">return</span>&nbsp;<span class="builtinfunc" id="2114542">len</span><span class="op" id="2114545">(</span><span class="ident" id="2114546">name</span><span class="op" id="2114550">)</span>&nbsp;<span class="op" id="2114552">&gt;</span>&nbsp;<span class="ident" id="2114554">n</span>&nbsp;<span class="op" id="2114556">&amp;&amp;</span>&nbsp;<span class="ident" id="2114559">name</span><span class="op" id="2114563">[</span><span class="op" id="2114564">:</span><span class="ident" id="2114565">n</span><span class="op" id="2114566">]</span>&nbsp;<span class="op" id="2114568">==</span>&nbsp;<span class="string" id="2114571">&#34;runtime.&#34;</span>&nbsp;<span class="op" id="2114582">&amp;&amp;</span>&nbsp;<span class="string" id="2114585">&#39;A&#39;</span>&nbsp;<span class="op" id="2114589">&lt;=</span>&nbsp;<span class="ident" id="2114592">name</span><span class="op" id="2114596">[</span><span class="ident" id="2114597">n</span><span class="op" id="2114598">]</span>&nbsp;<span class="op" id="2114600">&amp;&amp;</span>&nbsp;<span class="ident" id="2114603">name</span><span class="op" id="2114607">[</span><span class="ident" id="2114608">n</span><span class="op" id="2114609">]</span>&nbsp;<span class="op" id="2114611">&lt;=</span>&nbsp;<span class="string" id="2114614">&#39;Z&#39;</span><br>
<span class="lineno"></span><span class="op" id="2114618">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="2114621">var</span>&nbsp;<span class="ident" id="2114625">gStatusStrings</span>&nbsp;<span class="op" id="2114640">=</span>&nbsp;<span class="op" id="2114642">[</span><span class="op" id="2114643">...</span><span class="op" id="2114646">]</span><span class="builtintype" id="2114647">string</span><span class="op" id="2114653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114656">_Gidle</span><span class="op" id="2114662">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2114669">&#34;idle&#34;</span><span class="op" id="2114675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114678">_Grunnable</span><span class="op" id="2114688">:</span>&nbsp;&nbsp;<span class="string" id="2114691">&#34;runnable&#34;</span><span class="op" id="2114701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114704">_Grunning</span><span class="op" id="2114713">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="2114717">&#34;running&#34;</span><span class="op" id="2114726">,</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114729">_Gsyscall</span><span class="op" id="2114738">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="2114742">&#34;syscall&#34;</span><span class="op" id="2114751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114754">_Gwaiting</span><span class="op" id="2114763">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="2114767">&#34;waiting&#34;</span><span class="op" id="2114776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114779">_Gdead</span><span class="op" id="2114785">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2114792">&#34;dead&#34;</span><span class="op" id="2114798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114801">_Genqueue</span><span class="op" id="2114810">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="2114814">&#34;enqueue&#34;</span><span class="op" id="2114823">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114826">_Gcopystack</span><span class="op" id="2114837">:</span>&nbsp;<span class="string" id="2114839">&#34;copystack&#34;</span><span class="op" id="2114850">,</span><br>
<span class="lineno">575</span><span class="op" id="2114852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2114855">var</span>&nbsp;<span class="ident" id="2114859">gScanStatusStrings</span>&nbsp;<span class="op" id="2114878">=</span>&nbsp;<span class="op" id="2114880">[</span><span class="op" id="2114881">...</span><span class="op" id="2114884">]</span><span class="builtintype" id="2114885">string</span><span class="op" id="2114891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="2114894">0</span><span class="op" id="2114895">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2114906">&#34;scan&#34;</span><span class="op" id="2114912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114915">_Grunnable</span><span class="op" id="2114925">:</span>&nbsp;<span class="string" id="2114927">&#34;scanrunnable&#34;</span><span class="op" id="2114941">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114944">_Grunning</span><span class="op" id="2114953">:</span>&nbsp;&nbsp;<span class="string" id="2114956">&#34;scanrunning&#34;</span><span class="op" id="2114969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2114972">_Gsyscall</span><span class="op" id="2114981">:</span>&nbsp;&nbsp;<span class="string" id="2114984">&#34;scansyscall&#34;</span><span class="op" id="2114997">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115000">_Gwaiting</span><span class="op" id="2115009">:</span>&nbsp;&nbsp;<span class="string" id="2115012">&#34;scanwaiting&#34;</span><span class="op" id="2115025">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115028">_Gdead</span><span class="op" id="2115034">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2115040">&#34;scandead&#34;</span><span class="op" id="2115050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115053">_Genqueue</span><span class="op" id="2115062">:</span>&nbsp;&nbsp;<span class="string" id="2115065">&#34;scanenqueue&#34;</span><span class="op" id="2115078">,</span><br>
<span class="lineno">585</span><span class="op" id="2115080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2115083">func</span>&nbsp;<span class="ident" id="2115088">goroutineheader</span><span class="op" id="2115103">(</span><span class="ident" id="2115104">gp</span>&nbsp;<span class="op" id="2115107">*</span><span class="ident" id="2115108">g</span><span class="op" id="2115109">)</span>&nbsp;<span class="op" id="2115111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115114">gpstatus</span>&nbsp;<span class="op" id="2115123">:=</span>&nbsp;<span class="ident" id="2115126">readgstatus</span><span class="op" id="2115137">(</span><span class="ident" id="2115138">gp</span><span class="op" id="2115140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2115144">//&nbsp;Basic&nbsp;string&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115168">var</span>&nbsp;<span class="ident" id="2115172">status</span>&nbsp;<span class="builtintype" id="2115179">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115187">if</span>&nbsp;<span class="num" id="2115190">0</span>&nbsp;<span class="op" id="2115192">&lt;=</span>&nbsp;<span class="ident" id="2115195">gpstatus</span>&nbsp;<span class="op" id="2115204">&amp;&amp;</span>&nbsp;<span class="ident" id="2115207">gpstatus</span>&nbsp;<span class="op" id="2115216">&lt;</span>&nbsp;<span class="builtintype" id="2115218">uint32</span><span class="op" id="2115224">(</span><span class="builtinfunc" id="2115225">len</span><span class="op" id="2115228">(</span><span class="ident" id="2115229">gStatusStrings</span><span class="op" id="2115243">)</span><span class="op" id="2115244">)</span>&nbsp;<span class="op" id="2115246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115250">status</span>&nbsp;<span class="op" id="2115257">=</span>&nbsp;<span class="ident" id="2115259">gStatusStrings</span><span class="op" id="2115273">[</span><span class="ident" id="2115274">gpstatus</span><span class="op" id="2115282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115285">}</span>&nbsp;<span class="keyword" id="2115287">else</span>&nbsp;<span class="keyword" id="2115292">if</span>&nbsp;<span class="ident" id="2115295">gpstatus</span><span class="op" id="2115303">&amp;</span><span class="ident" id="2115304">_Gscan</span>&nbsp;<span class="op" id="2115311">!=</span>&nbsp;<span class="num" id="2115314">0</span>&nbsp;<span class="op" id="2115316">&amp;&amp;</span>&nbsp;<span class="num" id="2115319">0</span>&nbsp;<span class="op" id="2115321">&lt;=</span>&nbsp;<span class="ident" id="2115324">gpstatus</span><span class="op" id="2115332">&amp;^</span><span class="ident" id="2115334">_Gscan</span>&nbsp;<span class="op" id="2115341">&amp;&amp;</span>&nbsp;<span class="ident" id="2115344">gpstatus</span><span class="op" id="2115352">&amp;^</span><span class="ident" id="2115354">_Gscan</span>&nbsp;<span class="op" id="2115361">&lt;</span>&nbsp;<span class="builtintype" id="2115363">uint32</span><span class="op" id="2115369">(</span><span class="builtinfunc" id="2115370">len</span><span class="op" id="2115373">(</span><span class="ident" id="2115374">gStatusStrings</span><span class="op" id="2115388">)</span><span class="op" id="2115389">)</span>&nbsp;<span class="op" id="2115391">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115395">status</span>&nbsp;<span class="op" id="2115402">=</span>&nbsp;<span class="ident" id="2115404">gStatusStrings</span><span class="op" id="2115418">[</span><span class="ident" id="2115419">gpstatus</span><span class="op" id="2115427">&amp;^</span><span class="ident" id="2115429">_Gscan</span><span class="op" id="2115435">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115438">}</span>&nbsp;<span class="keyword" id="2115440">else</span>&nbsp;<span class="op" id="2115445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115449">status</span>&nbsp;<span class="op" id="2115456">=</span>&nbsp;<span class="string" id="2115458">&#34;???&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2115469">//&nbsp;Override.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115483">if</span>&nbsp;<span class="op" id="2115486">(</span><span class="ident" id="2115487">gpstatus</span>&nbsp;<span class="op" id="2115496">==</span>&nbsp;<span class="ident" id="2115499">_Gwaiting</span>&nbsp;<span class="op" id="2115509">||</span>&nbsp;<span class="ident" id="2115512">gpstatus</span>&nbsp;<span class="op" id="2115521">==</span>&nbsp;<span class="ident" id="2115524">_Gscanwaiting</span><span class="op" id="2115537">)</span>&nbsp;<span class="op" id="2115539">&amp;&amp;</span>&nbsp;<span class="ident" id="2115542">gp</span><span class="op" id="2115544">.</span><span class="ident" id="2115545">waitreason</span>&nbsp;<span class="op" id="2115556">!=</span>&nbsp;<span class="string" id="2115559">&#34;&#34;</span>&nbsp;<span class="op" id="2115562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115566">status</span>&nbsp;<span class="op" id="2115573">=</span>&nbsp;<span class="ident" id="2115575">gp</span><span class="op" id="2115577">.</span><span class="ident" id="2115578">waitreason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2115594">//&nbsp;approx&nbsp;time&nbsp;the&nbsp;G&nbsp;is&nbsp;blocked,&nbsp;in&nbsp;minutes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115639">var</span>&nbsp;<span class="ident" id="2115643">waitfor</span>&nbsp;<span class="ident" id="2115651">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115658">gpstatus</span>&nbsp;<span class="op" id="2115667">&amp;^=</span>&nbsp;<span class="ident" id="2115671">_Gscan</span>&nbsp;<span class="comment" id="2115678">//&nbsp;drop&nbsp;the&nbsp;scan&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115700">if</span>&nbsp;<span class="op" id="2115703">(</span><span class="ident" id="2115704">gpstatus</span>&nbsp;<span class="op" id="2115713">==</span>&nbsp;<span class="ident" id="2115716">_Gwaiting</span>&nbsp;<span class="op" id="2115726">||</span>&nbsp;<span class="ident" id="2115729">gpstatus</span>&nbsp;<span class="op" id="2115738">==</span>&nbsp;<span class="ident" id="2115741">_Gsyscall</span><span class="op" id="2115750">)</span>&nbsp;<span class="op" id="2115752">&amp;&amp;</span>&nbsp;<span class="ident" id="2115755">gp</span><span class="op" id="2115757">.</span><span class="ident" id="2115758">waitsince</span>&nbsp;<span class="op" id="2115768">!=</span>&nbsp;<span class="num" id="2115771">0</span>&nbsp;<span class="op" id="2115773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2115777">waitfor</span>&nbsp;<span class="op" id="2115785">=</span>&nbsp;<span class="op" id="2115787">(</span><span class="ident" id="2115788">nanotime</span><span class="op" id="2115796">(</span><span class="op" id="2115797">)</span>&nbsp;<span class="op" id="2115799">-</span>&nbsp;<span class="ident" id="2115801">gp</span><span class="op" id="2115803">.</span><span class="ident" id="2115804">waitsince</span><span class="op" id="2115813">)</span>&nbsp;<span class="op" id="2115815">/</span>&nbsp;<span class="num" id="2115817">60e9</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2115826">print</span><span class="op" id="2115831">(</span><span class="string" id="2115832">&#34;goroutine&nbsp;&#34;</span><span class="op" id="2115844">,</span>&nbsp;<span class="ident" id="2115846">gp</span><span class="op" id="2115848">.</span><span class="ident" id="2115849">goid</span><span class="op" id="2115853">,</span>&nbsp;<span class="string" id="2115855">&#34;&nbsp;[&#34;</span><span class="op" id="2115859">,</span>&nbsp;<span class="ident" id="2115861">status</span><span class="op" id="2115867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115870">if</span>&nbsp;<span class="ident" id="2115873">waitfor</span>&nbsp;<span class="op" id="2115881">&gt;=</span>&nbsp;<span class="num" id="2115884">1</span>&nbsp;<span class="op" id="2115886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2115890">print</span><span class="op" id="2115895">(</span><span class="string" id="2115896">&#34;,&nbsp;&#34;</span><span class="op" id="2115900">,</span>&nbsp;<span class="ident" id="2115902">waitfor</span><span class="op" id="2115909">,</span>&nbsp;<span class="string" id="2115911">&#34;&nbsp;minutes&#34;</span><span class="op" id="2115921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115924">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2115927">if</span>&nbsp;<span class="ident" id="2115930">gp</span><span class="op" id="2115932">.</span><span class="ident" id="2115933">lockedm</span>&nbsp;<span class="op" id="2115941">!=</span>&nbsp;<span class="ident" id="2115944">nil</span>&nbsp;<span class="op" id="2115948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2115952">print</span><span class="op" id="2115957">(</span><span class="string" id="2115958">&#34;,&nbsp;locked&nbsp;to&nbsp;thread&#34;</span><span class="op" id="2115978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2115981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2115984">print</span><span class="op" id="2115989">(</span><span class="string" id="2115990">&#34;]:\n&#34;</span><span class="op" id="2115996">)</span><br>
<span class="lineno"></span><span class="op" id="2115998">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="2116001">func</span>&nbsp;<span class="ident" id="2116006">tracebackothers</span><span class="op" id="2116021">(</span><span class="ident" id="2116022">me</span>&nbsp;<span class="op" id="2116025">*</span><span class="ident" id="2116026">g</span><span class="op" id="2116027">)</span>&nbsp;<span class="op" id="2116029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116032">level</span>&nbsp;<span class="op" id="2116038">:=</span>&nbsp;<span class="ident" id="2116041">gotraceback</span><span class="op" id="2116052">(</span><span class="ident" id="2116053">nil</span><span class="op" id="2116056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2116060">//&nbsp;Show&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;first,&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116121">g</span>&nbsp;<span class="op" id="2116123">:=</span>&nbsp;<span class="ident" id="2116126">getg</span><span class="op" id="2116130">(</span><span class="op" id="2116131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116134">gp</span>&nbsp;<span class="op" id="2116137">:=</span>&nbsp;<span class="ident" id="2116140">g</span><span class="op" id="2116141">.</span><span class="ident" id="2116142">m</span><span class="op" id="2116143">.</span><span class="ident" id="2116144">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2116150">if</span>&nbsp;<span class="ident" id="2116153">gp</span>&nbsp;<span class="op" id="2116156">!=</span>&nbsp;<span class="ident" id="2116159">nil</span>&nbsp;<span class="op" id="2116163">&amp;&amp;</span>&nbsp;<span class="ident" id="2116166">gp</span>&nbsp;<span class="op" id="2116169">!=</span>&nbsp;<span class="ident" id="2116172">me</span>&nbsp;<span class="op" id="2116175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2116179">print</span><span class="op" id="2116184">(</span><span class="string" id="2116185">&#34;\n&#34;</span><span class="op" id="2116189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116193">goroutineheader</span><span class="op" id="2116208">(</span><span class="ident" id="2116209">gp</span><span class="op" id="2116211">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116215">traceback</span><span class="op" id="2116224">(</span><span class="op" id="2116225">^</span><span class="builtintype" id="2116226">uintptr</span><span class="op" id="2116233">(</span><span class="num" id="2116234">0</span><span class="op" id="2116235">)</span><span class="op" id="2116236">,</span>&nbsp;<span class="op" id="2116238">^</span><span class="builtintype" id="2116239">uintptr</span><span class="op" id="2116246">(</span><span class="num" id="2116247">0</span><span class="op" id="2116248">)</span><span class="op" id="2116249">,</span>&nbsp;<span class="num" id="2116251">0</span><span class="op" id="2116252">,</span>&nbsp;<span class="ident" id="2116254">gp</span><span class="op" id="2116256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2116259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116263">lock</span><span class="op" id="2116267">(</span><span class="op" id="2116268">&amp;</span><span class="ident" id="2116269">allglock</span><span class="op" id="2116277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2116280">for</span>&nbsp;<span class="ident" id="2116284">_</span><span class="op" id="2116285">,</span>&nbsp;<span class="ident" id="2116287">gp</span>&nbsp;<span class="op" id="2116290">:=</span>&nbsp;<span class="keyword" id="2116293">range</span>&nbsp;<span class="ident" id="2116299">allgs</span>&nbsp;<span class="op" id="2116305">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2116309">if</span>&nbsp;<span class="ident" id="2116312">gp</span>&nbsp;<span class="op" id="2116315">==</span>&nbsp;<span class="ident" id="2116318">me</span>&nbsp;<span class="op" id="2116321">||</span>&nbsp;<span class="ident" id="2116324">gp</span>&nbsp;<span class="op" id="2116327">==</span>&nbsp;<span class="ident" id="2116330">g</span><span class="op" id="2116331">.</span><span class="ident" id="2116332">m</span><span class="op" id="2116333">.</span><span class="ident" id="2116334">curg</span>&nbsp;<span class="op" id="2116339">||</span>&nbsp;<span class="ident" id="2116342">readgstatus</span><span class="op" id="2116353">(</span><span class="ident" id="2116354">gp</span><span class="op" id="2116356">)</span>&nbsp;<span class="op" id="2116358">==</span>&nbsp;<span class="ident" id="2116361">_Gdead</span>&nbsp;<span class="op" id="2116368">||</span>&nbsp;<span class="ident" id="2116371">gp</span><span class="op" id="2116373">.</span><span class="ident" id="2116374">issystem</span>&nbsp;<span class="op" id="2116383">&amp;&amp;</span>&nbsp;<span class="ident" id="2116386">level</span>&nbsp;<span class="op" id="2116392">&lt;</span>&nbsp;<span class="num" id="2116394">2</span>&nbsp;<span class="op" id="2116396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2116401">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2116412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2116416">print</span><span class="op" id="2116421">(</span><span class="string" id="2116422">&#34;\n&#34;</span><span class="op" id="2116426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116430">goroutineheader</span><span class="op" id="2116445">(</span><span class="ident" id="2116446">gp</span><span class="op" id="2116448">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2116452">if</span>&nbsp;<span class="ident" id="2116455">readgstatus</span><span class="op" id="2116466">(</span><span class="ident" id="2116467">gp</span><span class="op" id="2116469">)</span><span class="op" id="2116470">&amp;^</span><span class="ident" id="2116472">_Gscan</span>&nbsp;<span class="op" id="2116479">==</span>&nbsp;<span class="ident" id="2116482">_Grunning</span>&nbsp;<span class="op" id="2116492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2116497">print</span><span class="op" id="2116502">(</span><span class="string" id="2116503">&#34;\tgoroutine&nbsp;running&nbsp;on&nbsp;other&nbsp;thread;&nbsp;stack&nbsp;unavailable\n&#34;</span><span class="op" id="2116561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116566">printcreatedby</span><span class="op" id="2116580">(</span><span class="ident" id="2116581">gp</span><span class="op" id="2116583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2116587">}</span>&nbsp;<span class="keyword" id="2116589">else</span>&nbsp;<span class="op" id="2116594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116599">traceback</span><span class="op" id="2116608">(</span><span class="op" id="2116609">^</span><span class="builtintype" id="2116610">uintptr</span><span class="op" id="2116617">(</span><span class="num" id="2116618">0</span><span class="op" id="2116619">)</span><span class="op" id="2116620">,</span>&nbsp;<span class="op" id="2116622">^</span><span class="builtintype" id="2116623">uintptr</span><span class="op" id="2116630">(</span><span class="num" id="2116631">0</span><span class="op" id="2116632">)</span><span class="op" id="2116633">,</span>&nbsp;<span class="num" id="2116635">0</span><span class="op" id="2116636">,</span>&nbsp;<span class="ident" id="2116638">gp</span><span class="op" id="2116640">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2116644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2116647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116650">unlock</span><span class="op" id="2116656">(</span><span class="op" id="2116657">&amp;</span><span class="ident" id="2116658">allglock</span><span class="op" id="2116666">)</span><br>
<span class="lineno"></span><span class="op" id="2116668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="2116671">//&nbsp;Does&nbsp;f&nbsp;mark&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;goroutine&nbsp;stack?</span><br>
<span class="lineno"></span><span class="keyword" id="2116716">func</span>&nbsp;<span class="ident" id="2116721">topofstack</span><span class="op" id="2116731">(</span><span class="ident" id="2116732">f</span>&nbsp;<span class="op" id="2116734">*</span><span class="ident" id="2116735">_func</span><span class="op" id="2116740">)</span>&nbsp;<span class="builtintype" id="2116742">bool</span>&nbsp;<span class="op" id="2116747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116750">pc</span>&nbsp;<span class="op" id="2116753">:=</span>&nbsp;<span class="ident" id="2116756">f</span><span class="op" id="2116757">.</span><span class="ident" id="2116758">entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2116765">return</span>&nbsp;<span class="ident" id="2116772">pc</span>&nbsp;<span class="op" id="2116775">==</span>&nbsp;<span class="ident" id="2116778">goexitPC</span>&nbsp;<span class="op" id="2116787">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116792">pc</span>&nbsp;<span class="op" id="2116795">==</span>&nbsp;<span class="ident" id="2116798">mstartPC</span>&nbsp;<span class="op" id="2116807">||</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116812">pc</span>&nbsp;<span class="op" id="2116815">==</span>&nbsp;<span class="ident" id="2116818">mcallPC</span>&nbsp;<span class="op" id="2116826">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116831">pc</span>&nbsp;<span class="op" id="2116834">==</span>&nbsp;<span class="ident" id="2116837">morestackPC</span>&nbsp;<span class="op" id="2116849">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116854">pc</span>&nbsp;<span class="op" id="2116857">==</span>&nbsp;<span class="ident" id="2116860">rt0_goPC</span>&nbsp;<span class="op" id="2116869">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2116874">externalthreadhandlerp</span>&nbsp;<span class="op" id="2116897">!=</span>&nbsp;<span class="num" id="2116900">0</span>&nbsp;<span class="op" id="2116902">&amp;&amp;</span>&nbsp;<span class="ident" id="2116905">pc</span>&nbsp;<span class="op" id="2116908">==</span>&nbsp;<span class="ident" id="2116911">externalthreadhandlerp</span><br>
<span class="lineno"></span><span class="op" id="2116934">}</span>
</div>
</body>
</html>
