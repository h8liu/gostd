<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3376120">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3376176">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3376230">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3376281">package</span>&nbsp;<span class="ident" id="3376289">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3376297">import</span>&nbsp;<span class="op" id="3376304">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3376307">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3376316">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3376333">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3376341">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="3376351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3376354">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="3376386">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="3376452">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3376524">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3376578">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="3376626">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3376694">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="3376762">type</span>&nbsp;<span class="ident" id="3376767">onePassProg</span>&nbsp;<span class="keyword" id="3376779">struct</span>&nbsp;<span class="op" id="3376786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376789">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3376796">[</span><span class="op" id="3376797">]</span><span class="ident" id="3376798">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376811">Start</span>&nbsp;&nbsp;<span class="builtintype" id="3376818">int</span>&nbsp;<span class="comment" id="3376822">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3376853">NumCap</span>&nbsp;<span class="builtintype" id="3376860">int</span>&nbsp;<span class="comment" id="3376864">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="3376901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3376904">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3376987">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="3377053">type</span>&nbsp;<span class="ident" id="3377058">onePassInst</span>&nbsp;<span class="keyword" id="3377070">struct</span>&nbsp;<span class="op" id="3377077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377080">syntax</span><span class="op" id="3377086">.</span><span class="ident" id="3377087">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377093">Next</span>&nbsp;<span class="op" id="3377098">[</span><span class="op" id="3377099">]</span><span class="builtintype" id="3377100">uint32</span><br>
<span class="lineno"></span><span class="op" id="3377107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3377110">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3377177">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3377236">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3377305">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="3377366">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="3377384">func</span>&nbsp;<span class="ident" id="3377389">onePassPrefix</span><span class="op" id="3377402">(</span><span class="ident" id="3377403">p</span>&nbsp;<span class="op" id="3377405">*</span><span class="ident" id="3377406">syntax</span><span class="op" id="3377412">.</span><span class="ident" id="3377413">Prog</span><span class="op" id="3377417">)</span>&nbsp;<span class="op" id="3377419">(</span><span class="ident" id="3377420">prefix</span>&nbsp;<span class="builtintype" id="3377427">string</span><span class="op" id="3377433">,</span>&nbsp;<span class="ident" id="3377435">complete</span>&nbsp;<span class="builtintype" id="3377444">bool</span><span class="op" id="3377448">,</span>&nbsp;<span class="ident" id="3377450">pc</span>&nbsp;<span class="builtintype" id="3377453">uint32</span><span class="op" id="3377459">)</span>&nbsp;<span class="op" id="3377461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377464">i</span>&nbsp;<span class="op" id="3377466">:=</span>&nbsp;<span class="op" id="3377469">&amp;</span><span class="ident" id="3377470">p</span><span class="op" id="3377471">.</span><span class="ident" id="3377472">Inst</span><span class="op" id="3377476">[</span><span class="ident" id="3377477">p</span><span class="op" id="3377478">.</span><span class="ident" id="3377479">Start</span><span class="op" id="3377484">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377487">if</span>&nbsp;<span class="ident" id="3377490">i</span><span class="op" id="3377491">.</span><span class="ident" id="3377492">Op</span>&nbsp;<span class="op" id="3377495">!=</span>&nbsp;<span class="ident" id="3377498">syntax</span><span class="op" id="3377504">.</span><span class="ident" id="3377505">InstEmptyWidth</span>&nbsp;<span class="op" id="3377520">||</span>&nbsp;<span class="op" id="3377523">(</span><span class="ident" id="3377524">syntax</span><span class="op" id="3377530">.</span><span class="ident" id="3377531">EmptyOp</span><span class="op" id="3377538">(</span><span class="ident" id="3377539">i</span><span class="op" id="3377540">.</span><span class="ident" id="3377541">Arg</span><span class="op" id="3377544">)</span><span class="op" id="3377545">)</span><span class="op" id="3377546">&amp;</span><span class="ident" id="3377547">syntax</span><span class="op" id="3377553">.</span><span class="ident" id="3377554">EmptyBeginText</span>&nbsp;<span class="op" id="3377569">==</span>&nbsp;<span class="num" id="3377572">0</span>&nbsp;<span class="op" id="3377574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377578">return</span>&nbsp;<span class="string" id="3377585">&#34;&#34;</span><span class="op" id="3377587">,</span>&nbsp;<span class="ident" id="3377589">i</span><span class="op" id="3377590">.</span><span class="ident" id="3377591">Op</span>&nbsp;<span class="op" id="3377594">==</span>&nbsp;<span class="ident" id="3377597">syntax</span><span class="op" id="3377603">.</span><span class="ident" id="3377604">InstMatch</span><span class="op" id="3377613">,</span>&nbsp;<span class="builtintype" id="3377615">uint32</span><span class="op" id="3377621">(</span><span class="ident" id="3377622">p</span><span class="op" id="3377623">.</span><span class="ident" id="3377624">Start</span><span class="op" id="3377629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377632">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377635">pc</span>&nbsp;<span class="op" id="3377638">=</span>&nbsp;<span class="ident" id="3377640">i</span><span class="op" id="3377641">.</span><span class="ident" id="3377642">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377647">i</span>&nbsp;<span class="op" id="3377649">=</span>&nbsp;<span class="op" id="3377651">&amp;</span><span class="ident" id="3377652">p</span><span class="op" id="3377653">.</span><span class="ident" id="3377654">Inst</span><span class="op" id="3377658">[</span><span class="ident" id="3377659">pc</span><span class="op" id="3377661">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377664">for</span>&nbsp;<span class="ident" id="3377668">i</span><span class="op" id="3377669">.</span><span class="ident" id="3377670">Op</span>&nbsp;<span class="op" id="3377673">==</span>&nbsp;<span class="ident" id="3377676">syntax</span><span class="op" id="3377682">.</span><span class="ident" id="3377683">InstNop</span>&nbsp;<span class="op" id="3377691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377695">pc</span>&nbsp;<span class="op" id="3377698">=</span>&nbsp;<span class="ident" id="3377700">i</span><span class="op" id="3377701">.</span><span class="ident" id="3377702">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3377708">i</span>&nbsp;<span class="op" id="3377710">=</span>&nbsp;<span class="op" id="3377712">&amp;</span><span class="ident" id="3377713">p</span><span class="op" id="3377714">.</span><span class="ident" id="3377715">Inst</span><span class="op" id="3377719">[</span><span class="ident" id="3377720">pc</span><span class="op" id="3377722">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377728">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377779">if</span>&nbsp;<span class="ident" id="3377782">iop</span><span class="op" id="3377785">(</span><span class="ident" id="3377786">i</span><span class="op" id="3377787">)</span>&nbsp;<span class="op" id="3377789">!=</span>&nbsp;<span class="ident" id="3377792">syntax</span><span class="op" id="3377798">.</span><span class="ident" id="3377799">InstRune</span>&nbsp;<span class="op" id="3377808">||</span>&nbsp;<span class="builtinfunc" id="3377811">len</span><span class="op" id="3377814">(</span><span class="ident" id="3377815">i</span><span class="op" id="3377816">.</span><span class="ident" id="3377817">Rune</span><span class="op" id="3377821">)</span>&nbsp;<span class="op" id="3377823">!=</span>&nbsp;<span class="num" id="3377826">1</span>&nbsp;<span class="op" id="3377828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377832">return</span>&nbsp;<span class="string" id="3377839">&#34;&#34;</span><span class="op" id="3377841">,</span>&nbsp;<span class="ident" id="3377843">i</span><span class="op" id="3377844">.</span><span class="ident" id="3377845">Op</span>&nbsp;<span class="op" id="3377848">==</span>&nbsp;<span class="ident" id="3377851">syntax</span><span class="op" id="3377857">.</span><span class="ident" id="3377858">InstMatch</span><span class="op" id="3377867">,</span>&nbsp;<span class="builtintype" id="3377869">uint32</span><span class="op" id="3377875">(</span><span class="ident" id="3377876">p</span><span class="op" id="3377877">.</span><span class="ident" id="3377878">Start</span><span class="op" id="3377883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3377886">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3377890">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377926">var</span>&nbsp;<span class="ident" id="3377930">buf</span>&nbsp;<span class="ident" id="3377934">bytes</span><span class="op" id="3377939">.</span><span class="ident" id="3377940">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3377948">for</span>&nbsp;<span class="ident" id="3377952">iop</span><span class="op" id="3377955">(</span><span class="ident" id="3377956">i</span><span class="op" id="3377957">)</span>&nbsp;<span class="op" id="3377959">==</span>&nbsp;<span class="ident" id="3377962">syntax</span><span class="op" id="3377968">.</span><span class="ident" id="3377969">InstRune</span>&nbsp;<span class="op" id="3377978">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3377981">len</span><span class="op" id="3377984">(</span><span class="ident" id="3377985">i</span><span class="op" id="3377986">.</span><span class="ident" id="3377987">Rune</span><span class="op" id="3377991">)</span>&nbsp;<span class="op" id="3377993">==</span>&nbsp;<span class="num" id="3377996">1</span>&nbsp;<span class="op" id="3377998">&amp;&amp;</span>&nbsp;<span class="ident" id="3378001">syntax</span><span class="op" id="3378007">.</span><span class="ident" id="3378008">Flags</span><span class="op" id="3378013">(</span><span class="ident" id="3378014">i</span><span class="op" id="3378015">.</span><span class="ident" id="3378016">Arg</span><span class="op" id="3378019">)</span><span class="op" id="3378020">&amp;</span><span class="ident" id="3378021">syntax</span><span class="op" id="3378027">.</span><span class="ident" id="3378028">FoldCase</span>&nbsp;<span class="op" id="3378037">==</span>&nbsp;<span class="num" id="3378040">0</span>&nbsp;<span class="op" id="3378042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378046">buf</span><span class="op" id="3378049">.</span><span class="ident" id="3378050">WriteRune</span><span class="op" id="3378059">(</span><span class="ident" id="3378060">i</span><span class="op" id="3378061">.</span><span class="ident" id="3378062">Rune</span><span class="op" id="3378066">[</span><span class="num" id="3378067">0</span><span class="op" id="3378068">]</span><span class="op" id="3378069">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378073">pc</span><span class="op" id="3378075">,</span>&nbsp;<span class="ident" id="3378077">i</span>&nbsp;<span class="op" id="3378079">=</span>&nbsp;<span class="ident" id="3378081">i</span><span class="op" id="3378082">.</span><span class="ident" id="3378083">Out</span><span class="op" id="3378086">,</span>&nbsp;<span class="op" id="3378088">&amp;</span><span class="ident" id="3378089">p</span><span class="op" id="3378090">.</span><span class="ident" id="3378091">Inst</span><span class="op" id="3378095">[</span><span class="ident" id="3378096">i</span><span class="op" id="3378097">.</span><span class="ident" id="3378098">Out</span><span class="op" id="3378101">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378107">return</span>&nbsp;<span class="ident" id="3378114">buf</span><span class="op" id="3378117">.</span><span class="ident" id="3378118">String</span><span class="op" id="3378124">(</span><span class="op" id="3378125">)</span><span class="op" id="3378126">,</span>&nbsp;<span class="ident" id="3378128">i</span><span class="op" id="3378129">.</span><span class="ident" id="3378130">Op</span>&nbsp;<span class="op" id="3378133">==</span>&nbsp;<span class="ident" id="3378136">syntax</span><span class="op" id="3378142">.</span><span class="ident" id="3378143">InstEmptyWidth</span>&nbsp;<span class="op" id="3378158">&amp;&amp;</span>&nbsp;<span class="op" id="3378161">(</span><span class="ident" id="3378162">syntax</span><span class="op" id="3378168">.</span><span class="ident" id="3378169">EmptyOp</span><span class="op" id="3378176">(</span><span class="ident" id="3378177">i</span><span class="op" id="3378178">.</span><span class="ident" id="3378179">Arg</span><span class="op" id="3378182">)</span><span class="op" id="3378183">)</span><span class="op" id="3378184">&amp;</span><span class="ident" id="3378185">syntax</span><span class="op" id="3378191">.</span><span class="ident" id="3378192">EmptyBeginText</span>&nbsp;<span class="op" id="3378207">!=</span>&nbsp;<span class="num" id="3378210">0</span><span class="op" id="3378211">,</span>&nbsp;<span class="ident" id="3378213">pc</span><br>
<span class="lineno"></span><span class="op" id="3378216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3378219">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3378311">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="3378408">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3378502">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="3378587">func</span>&nbsp;<span class="ident" id="3378592">onePassNext</span><span class="op" id="3378603">(</span><span class="ident" id="3378604">i</span>&nbsp;<span class="op" id="3378606">*</span><span class="ident" id="3378607">onePassInst</span><span class="op" id="3378618">,</span>&nbsp;<span class="ident" id="3378620">r</span>&nbsp;<span class="builtintype" id="3378622">rune</span><span class="op" id="3378626">)</span>&nbsp;<span class="builtintype" id="3378628">uint32</span>&nbsp;<span class="op" id="3378635">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378638">next</span>&nbsp;<span class="op" id="3378643">:=</span>&nbsp;<span class="ident" id="3378646">i</span><span class="op" id="3378647">.</span><span class="ident" id="3378648">MatchRunePos</span><span class="op" id="3378660">(</span><span class="ident" id="3378661">r</span><span class="op" id="3378662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378665">if</span>&nbsp;<span class="ident" id="3378668">next</span>&nbsp;<span class="op" id="3378673">&gt;=</span>&nbsp;<span class="num" id="3378676">0</span>&nbsp;<span class="op" id="3378678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378682">return</span>&nbsp;<span class="ident" id="3378689">i</span><span class="op" id="3378690">.</span><span class="ident" id="3378691">Next</span><span class="op" id="3378695">[</span><span class="ident" id="3378696">next</span><span class="op" id="3378700">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378706">if</span>&nbsp;<span class="ident" id="3378709">i</span><span class="op" id="3378710">.</span><span class="ident" id="3378711">Op</span>&nbsp;<span class="op" id="3378714">==</span>&nbsp;<span class="ident" id="3378717">syntax</span><span class="op" id="3378723">.</span><span class="ident" id="3378724">InstAltMatch</span>&nbsp;<span class="op" id="3378737">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378741">return</span>&nbsp;<span class="ident" id="3378748">i</span><span class="op" id="3378749">.</span><span class="ident" id="3378750">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378758">return</span>&nbsp;<span class="num" id="3378765">0</span><br>
<span class="lineno"></span><span class="op" id="3378767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3378770">func</span>&nbsp;<span class="ident" id="3378775">iop</span><span class="op" id="3378778">(</span><span class="ident" id="3378779">i</span>&nbsp;<span class="op" id="3378781">*</span><span class="ident" id="3378782">syntax</span><span class="op" id="3378788">.</span><span class="ident" id="3378789">Inst</span><span class="op" id="3378793">)</span>&nbsp;<span class="ident" id="3378795">syntax</span><span class="op" id="3378801">.</span><span class="ident" id="3378802">InstOp</span>&nbsp;<span class="op" id="3378809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378812">op</span>&nbsp;<span class="op" id="3378815">:=</span>&nbsp;<span class="ident" id="3378818">i</span><span class="op" id="3378819">.</span><span class="ident" id="3378820">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378824">switch</span>&nbsp;<span class="ident" id="3378831">op</span>&nbsp;<span class="op" id="3378834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378837">case</span>&nbsp;<span class="ident" id="3378842">syntax</span><span class="op" id="3378848">.</span><span class="ident" id="3378849">InstRune1</span><span class="op" id="3378858">,</span>&nbsp;<span class="ident" id="3378860">syntax</span><span class="op" id="3378866">.</span><span class="ident" id="3378867">InstRuneAny</span><span class="op" id="3378878">,</span>&nbsp;<span class="ident" id="3378880">syntax</span><span class="op" id="3378886">.</span><span class="ident" id="3378887">InstRuneAnyNotNL</span><span class="op" id="3378903">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378907">op</span>&nbsp;<span class="op" id="3378910">=</span>&nbsp;<span class="ident" id="3378912">syntax</span><span class="op" id="3378918">.</span><span class="ident" id="3378919">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378932">return</span>&nbsp;<span class="ident" id="3378939">op</span><br>
<span class="lineno"></span><span class="op" id="3378942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3378945">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="3379003">type</span>&nbsp;<span class="ident" id="3379008">queueOnePass</span>&nbsp;<span class="keyword" id="3379021">struct</span>&nbsp;<span class="op" id="3379028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379031">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3379047">[</span><span class="op" id="3379048">]</span><span class="builtintype" id="3379049">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379057">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3379073">[</span><span class="op" id="3379074">]</span><span class="builtintype" id="3379075">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379083">size</span><span class="op" id="3379087">,</span>&nbsp;<span class="ident" id="3379089">nextIndex</span>&nbsp;<span class="builtintype" id="3379099">uint32</span><br>
<span class="lineno"></span><span class="op" id="3379106">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="3379109">func</span>&nbsp;<span class="op" id="3379114">(</span><span class="ident" id="3379115">q</span>&nbsp;<span class="op" id="3379117">*</span><span class="ident" id="3379118">queueOnePass</span><span class="op" id="3379130">)</span>&nbsp;<span class="ident" id="3379132">empty</span><span class="op" id="3379137">(</span><span class="op" id="3379138">)</span>&nbsp;<span class="builtintype" id="3379140">bool</span>&nbsp;<span class="op" id="3379145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379148">return</span>&nbsp;<span class="ident" id="3379155">q</span><span class="op" id="3379156">.</span><span class="ident" id="3379157">nextIndex</span>&nbsp;<span class="op" id="3379167">&gt;=</span>&nbsp;<span class="ident" id="3379170">q</span><span class="op" id="3379171">.</span><span class="ident" id="3379172">size</span><br>
<span class="lineno"></span><span class="op" id="3379177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3379180">func</span>&nbsp;<span class="op" id="3379185">(</span><span class="ident" id="3379186">q</span>&nbsp;<span class="op" id="3379188">*</span><span class="ident" id="3379189">queueOnePass</span><span class="op" id="3379201">)</span>&nbsp;<span class="ident" id="3379203">next</span><span class="op" id="3379207">(</span><span class="op" id="3379208">)</span>&nbsp;<span class="op" id="3379210">(</span><span class="ident" id="3379211">n</span>&nbsp;<span class="builtintype" id="3379213">uint32</span><span class="op" id="3379219">)</span>&nbsp;<span class="op" id="3379221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379224">n</span>&nbsp;<span class="op" id="3379226">=</span>&nbsp;<span class="ident" id="3379228">q</span><span class="op" id="3379229">.</span><span class="ident" id="3379230">dense</span><span class="op" id="3379235">[</span><span class="ident" id="3379236">q</span><span class="op" id="3379237">.</span><span class="ident" id="3379238">nextIndex</span><span class="op" id="3379247">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379250">q</span><span class="op" id="3379251">.</span><span class="ident" id="3379252">nextIndex</span><span class="op" id="3379261">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379265">return</span><br>
<span class="lineno"></span><span class="op" id="3379272">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3379275">func</span>&nbsp;<span class="op" id="3379280">(</span><span class="ident" id="3379281">q</span>&nbsp;<span class="op" id="3379283">*</span><span class="ident" id="3379284">queueOnePass</span><span class="op" id="3379296">)</span>&nbsp;<span class="ident" id="3379298">clear</span><span class="op" id="3379303">(</span><span class="op" id="3379304">)</span>&nbsp;<span class="op" id="3379306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379309">q</span><span class="op" id="3379310">.</span><span class="ident" id="3379311">size</span>&nbsp;<span class="op" id="3379316">=</span>&nbsp;<span class="num" id="3379318">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379321">q</span><span class="op" id="3379322">.</span><span class="ident" id="3379323">nextIndex</span>&nbsp;<span class="op" id="3379333">=</span>&nbsp;<span class="num" id="3379335">0</span><br>
<span class="lineno"></span><span class="op" id="3379337">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="3379340">func</span>&nbsp;<span class="op" id="3379345">(</span><span class="ident" id="3379346">q</span>&nbsp;<span class="op" id="3379348">*</span><span class="ident" id="3379349">queueOnePass</span><span class="op" id="3379361">)</span>&nbsp;<span class="ident" id="3379363">reset</span><span class="op" id="3379368">(</span><span class="op" id="3379369">)</span>&nbsp;<span class="op" id="3379371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379374">q</span><span class="op" id="3379375">.</span><span class="ident" id="3379376">nextIndex</span>&nbsp;<span class="op" id="3379386">=</span>&nbsp;<span class="num" id="3379388">0</span><br>
<span class="lineno"></span><span class="op" id="3379390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="3379393">func</span>&nbsp;<span class="op" id="3379398">(</span><span class="ident" id="3379399">q</span>&nbsp;<span class="op" id="3379401">*</span><span class="ident" id="3379402">queueOnePass</span><span class="op" id="3379414">)</span>&nbsp;<span class="ident" id="3379416">contains</span><span class="op" id="3379424">(</span><span class="ident" id="3379425">u</span>&nbsp;<span class="builtintype" id="3379427">uint32</span><span class="op" id="3379433">)</span>&nbsp;<span class="builtintype" id="3379435">bool</span>&nbsp;<span class="op" id="3379440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379443">if</span>&nbsp;<span class="ident" id="3379446">u</span>&nbsp;<span class="op" id="3379448">&gt;=</span>&nbsp;<span class="builtintype" id="3379451">uint32</span><span class="op" id="3379457">(</span><span class="builtinfunc" id="3379458">len</span><span class="op" id="3379461">(</span><span class="ident" id="3379462">q</span><span class="op" id="3379463">.</span><span class="ident" id="3379464">sparse</span><span class="op" id="3379470">)</span><span class="op" id="3379471">)</span>&nbsp;<span class="op" id="3379473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379477">return</span>&nbsp;<span class="builtintype" id="3379484">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379494">return</span>&nbsp;<span class="ident" id="3379501">q</span><span class="op" id="3379502">.</span><span class="ident" id="3379503">sparse</span><span class="op" id="3379509">[</span><span class="ident" id="3379510">u</span><span class="op" id="3379511">]</span>&nbsp;<span class="op" id="3379513">&lt;</span>&nbsp;<span class="ident" id="3379515">q</span><span class="op" id="3379516">.</span><span class="ident" id="3379517">size</span>&nbsp;<span class="op" id="3379522">&amp;&amp;</span>&nbsp;<span class="ident" id="3379525">q</span><span class="op" id="3379526">.</span><span class="ident" id="3379527">dense</span><span class="op" id="3379532">[</span><span class="ident" id="3379533">q</span><span class="op" id="3379534">.</span><span class="ident" id="3379535">sparse</span><span class="op" id="3379541">[</span><span class="ident" id="3379542">u</span><span class="op" id="3379543">]</span><span class="op" id="3379544">]</span>&nbsp;<span class="op" id="3379546">==</span>&nbsp;<span class="ident" id="3379549">u</span><br>
<span class="lineno">120</span><span class="op" id="3379551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3379554">func</span>&nbsp;<span class="op" id="3379559">(</span><span class="ident" id="3379560">q</span>&nbsp;<span class="op" id="3379562">*</span><span class="ident" id="3379563">queueOnePass</span><span class="op" id="3379575">)</span>&nbsp;<span class="ident" id="3379577">insert</span><span class="op" id="3379583">(</span><span class="ident" id="3379584">u</span>&nbsp;<span class="builtintype" id="3379586">uint32</span><span class="op" id="3379592">)</span>&nbsp;<span class="op" id="3379594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379597">if</span>&nbsp;<span class="op" id="3379600">!</span><span class="ident" id="3379601">q</span><span class="op" id="3379602">.</span><span class="ident" id="3379603">contains</span><span class="op" id="3379611">(</span><span class="ident" id="3379612">u</span><span class="op" id="3379613">)</span>&nbsp;<span class="op" id="3379615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379619">q</span><span class="op" id="3379620">.</span><span class="ident" id="3379621">insertNew</span><span class="op" id="3379630">(</span><span class="ident" id="3379631">u</span><span class="op" id="3379632">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379635">}</span><br>
<span class="lineno"></span><span class="op" id="3379637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3379640">func</span>&nbsp;<span class="op" id="3379645">(</span><span class="ident" id="3379646">q</span>&nbsp;<span class="op" id="3379648">*</span><span class="ident" id="3379649">queueOnePass</span><span class="op" id="3379661">)</span>&nbsp;<span class="ident" id="3379663">insertNew</span><span class="op" id="3379672">(</span><span class="ident" id="3379673">u</span>&nbsp;<span class="builtintype" id="3379675">uint32</span><span class="op" id="3379681">)</span>&nbsp;<span class="op" id="3379683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379686">if</span>&nbsp;<span class="ident" id="3379689">u</span>&nbsp;<span class="op" id="3379691">&gt;=</span>&nbsp;<span class="builtintype" id="3379694">uint32</span><span class="op" id="3379700">(</span><span class="builtinfunc" id="3379701">len</span><span class="op" id="3379704">(</span><span class="ident" id="3379705">q</span><span class="op" id="3379706">.</span><span class="ident" id="3379707">sparse</span><span class="op" id="3379713">)</span><span class="op" id="3379714">)</span>&nbsp;<span class="op" id="3379716">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379720">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379731">q</span><span class="op" id="3379732">.</span><span class="ident" id="3379733">sparse</span><span class="op" id="3379739">[</span><span class="ident" id="3379740">u</span><span class="op" id="3379741">]</span>&nbsp;<span class="op" id="3379743">=</span>&nbsp;<span class="ident" id="3379745">q</span><span class="op" id="3379746">.</span><span class="ident" id="3379747">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379753">q</span><span class="op" id="3379754">.</span><span class="ident" id="3379755">dense</span><span class="op" id="3379760">[</span><span class="ident" id="3379761">q</span><span class="op" id="3379762">.</span><span class="ident" id="3379763">size</span><span class="op" id="3379767">]</span>&nbsp;<span class="op" id="3379769">=</span>&nbsp;<span class="ident" id="3379771">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379774">q</span><span class="op" id="3379775">.</span><span class="ident" id="3379776">size</span><span class="op" id="3379780">++</span><br>
<span class="lineno">135</span><span class="op" id="3379783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3379786">func</span>&nbsp;<span class="ident" id="3379791">newQueue</span><span class="op" id="3379799">(</span><span class="ident" id="3379800">size</span>&nbsp;<span class="builtintype" id="3379805">int</span><span class="op" id="3379808">)</span>&nbsp;<span class="op" id="3379810">(</span><span class="ident" id="3379811">q</span>&nbsp;<span class="op" id="3379813">*</span><span class="ident" id="3379814">queueOnePass</span><span class="op" id="3379826">)</span>&nbsp;<span class="op" id="3379828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379831">return</span>&nbsp;<span class="op" id="3379838">&amp;</span><span class="ident" id="3379839">queueOnePass</span><span class="op" id="3379851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379855">sparse</span><span class="op" id="3379861">:</span>&nbsp;<span class="builtinfunc" id="3379863">make</span><span class="op" id="3379867">(</span><span class="op" id="3379868">[</span><span class="op" id="3379869">]</span><span class="builtintype" id="3379870">uint32</span><span class="op" id="3379876">,</span>&nbsp;<span class="ident" id="3379878">size</span><span class="op" id="3379882">)</span><span class="op" id="3379883">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379887">dense</span><span class="op" id="3379892">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3379895">make</span><span class="op" id="3379899">(</span><span class="op" id="3379900">[</span><span class="op" id="3379901">]</span><span class="builtintype" id="3379902">uint32</span><span class="op" id="3379908">,</span>&nbsp;<span class="ident" id="3379910">size</span><span class="op" id="3379914">)</span><span class="op" id="3379915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379918">}</span><br>
<span class="lineno"></span><span class="op" id="3379920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3379923">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="3380009">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="3380093">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3380178">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="3380243">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="3380329">const</span>&nbsp;<span class="ident" id="3380335">mergeFailed</span>&nbsp;<span class="op" id="3380347">=</span>&nbsp;<span class="builtintype" id="3380349">uint32</span><span class="op" id="3380355">(</span><span class="num" id="3380356">0xffffffff</span><span class="op" id="3380366">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="3380369">var</span>&nbsp;<span class="op" id="3380373">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380376">noRune</span>&nbsp;<span class="op" id="3380383">=</span>&nbsp;<span class="op" id="3380385">[</span><span class="op" id="3380386">]</span><span class="builtintype" id="3380387">rune</span><span class="op" id="3380391">{</span><span class="op" id="3380392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380395">noNext</span>&nbsp;<span class="op" id="3380402">=</span>&nbsp;<span class="op" id="3380404">[</span><span class="op" id="3380405">]</span><span class="builtintype" id="3380406">uint32</span><span class="op" id="3380412">{</span><span class="ident" id="3380413">mergeFailed</span><span class="op" id="3380424">}</span><br>
<span class="lineno"></span><span class="op" id="3380426">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="3380429">func</span>&nbsp;<span class="ident" id="3380434">mergeRuneSets</span><span class="op" id="3380447">(</span><span class="ident" id="3380448">leftRunes</span><span class="op" id="3380457">,</span>&nbsp;<span class="ident" id="3380459">rightRunes</span>&nbsp;<span class="op" id="3380470">*</span><span class="op" id="3380471">[</span><span class="op" id="3380472">]</span><span class="builtintype" id="3380473">rune</span><span class="op" id="3380477">,</span>&nbsp;<span class="ident" id="3380479">leftPC</span><span class="op" id="3380485">,</span>&nbsp;<span class="ident" id="3380487">rightPC</span>&nbsp;<span class="builtintype" id="3380495">uint32</span><span class="op" id="3380501">)</span>&nbsp;<span class="op" id="3380503">(</span><span class="op" id="3380504">[</span><span class="op" id="3380505">]</span><span class="builtintype" id="3380506">rune</span><span class="op" id="3380510">,</span>&nbsp;<span class="op" id="3380512">[</span><span class="op" id="3380513">]</span><span class="builtintype" id="3380514">uint32</span><span class="op" id="3380520">)</span>&nbsp;<span class="op" id="3380522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380525">leftLen</span>&nbsp;<span class="op" id="3380533">:=</span>&nbsp;<span class="builtinfunc" id="3380536">len</span><span class="op" id="3380539">(</span><span class="op" id="3380540">*</span><span class="ident" id="3380541">leftRunes</span><span class="op" id="3380550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380553">rightLen</span>&nbsp;<span class="op" id="3380562">:=</span>&nbsp;<span class="builtinfunc" id="3380565">len</span><span class="op" id="3380568">(</span><span class="op" id="3380569">*</span><span class="ident" id="3380570">rightRunes</span><span class="op" id="3380580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380583">if</span>&nbsp;<span class="ident" id="3380586">leftLen</span><span class="op" id="3380593">&amp;</span><span class="num" id="3380594">0x1</span>&nbsp;<span class="op" id="3380598">!=</span>&nbsp;<span class="num" id="3380601">0</span>&nbsp;<span class="op" id="3380603">||</span>&nbsp;<span class="ident" id="3380606">rightLen</span><span class="op" id="3380614">&amp;</span><span class="num" id="3380615">0x1</span>&nbsp;<span class="op" id="3380619">!=</span>&nbsp;<span class="num" id="3380622">0</span>&nbsp;<span class="op" id="3380624">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3380628">panic</span><span class="op" id="3380633">(</span><span class="string" id="3380634">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="3380667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380673">var</span>&nbsp;<span class="op" id="3380677">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380681">lx</span><span class="op" id="3380683">,</span>&nbsp;<span class="ident" id="3380685">rx</span>&nbsp;<span class="builtintype" id="3380688">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380693">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380696">merged</span>&nbsp;<span class="op" id="3380703">:=</span>&nbsp;<span class="builtinfunc" id="3380706">make</span><span class="op" id="3380710">(</span><span class="op" id="3380711">[</span><span class="op" id="3380712">]</span><span class="builtintype" id="3380713">rune</span><span class="op" id="3380717">,</span>&nbsp;<span class="num" id="3380719">0</span><span class="op" id="3380720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380723">next</span>&nbsp;<span class="op" id="3380728">:=</span>&nbsp;<span class="builtinfunc" id="3380731">make</span><span class="op" id="3380735">(</span><span class="op" id="3380736">[</span><span class="op" id="3380737">]</span><span class="builtintype" id="3380738">uint32</span><span class="op" id="3380744">,</span>&nbsp;<span class="num" id="3380746">0</span><span class="op" id="3380747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380750">ok</span>&nbsp;<span class="op" id="3380753">:=</span>&nbsp;<span class="builtintype" id="3380756">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380762">defer</span>&nbsp;<span class="keyword" id="3380768">func</span><span class="op" id="3380772">(</span><span class="op" id="3380773">)</span>&nbsp;<span class="op" id="3380775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380779">if</span>&nbsp;<span class="op" id="3380782">!</span><span class="ident" id="3380783">ok</span>&nbsp;<span class="op" id="3380786">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380791">merged</span>&nbsp;<span class="op" id="3380798">=</span>&nbsp;<span class="ident" id="3380800">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380807">next</span>&nbsp;<span class="op" id="3380812">=</span>&nbsp;<span class="ident" id="3380814">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380823">}</span><span class="op" id="3380824">(</span><span class="op" id="3380825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380829">ix</span>&nbsp;<span class="op" id="3380832">:=</span>&nbsp;<span class="op" id="3380835">-</span><span class="num" id="3380836">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380839">extend</span>&nbsp;<span class="op" id="3380846">:=</span>&nbsp;<span class="keyword" id="3380849">func</span><span class="op" id="3380853">(</span><span class="ident" id="3380854">newLow</span>&nbsp;<span class="op" id="3380861">*</span><span class="builtintype" id="3380862">int</span><span class="op" id="3380865">,</span>&nbsp;<span class="ident" id="3380867">newArray</span>&nbsp;<span class="op" id="3380876">*</span><span class="op" id="3380877">[</span><span class="op" id="3380878">]</span><span class="builtintype" id="3380879">rune</span><span class="op" id="3380883">,</span>&nbsp;<span class="ident" id="3380885">pc</span>&nbsp;<span class="builtintype" id="3380888">uint32</span><span class="op" id="3380894">)</span>&nbsp;<span class="builtintype" id="3380896">bool</span>&nbsp;<span class="op" id="3380901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380905">if</span>&nbsp;<span class="ident" id="3380908">ix</span>&nbsp;<span class="op" id="3380911">&gt;</span>&nbsp;<span class="num" id="3380913">0</span>&nbsp;<span class="op" id="3380915">&amp;&amp;</span>&nbsp;<span class="op" id="3380918">(</span><span class="op" id="3380919">*</span><span class="ident" id="3380920">newArray</span><span class="op" id="3380928">)</span><span class="op" id="3380929">[</span><span class="op" id="3380930">*</span><span class="ident" id="3380931">newLow</span><span class="op" id="3380937">]</span>&nbsp;<span class="op" id="3380939">&lt;=</span>&nbsp;<span class="ident" id="3380942">merged</span><span class="op" id="3380948">[</span><span class="ident" id="3380949">ix</span><span class="op" id="3380951">]</span>&nbsp;<span class="op" id="3380953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3380958">return</span>&nbsp;<span class="builtintype" id="3380965">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3380973">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3380977">merged</span>&nbsp;<span class="op" id="3380984">=</span>&nbsp;<span class="builtinfunc" id="3380986">append</span><span class="op" id="3380992">(</span><span class="ident" id="3380993">merged</span><span class="op" id="3380999">,</span>&nbsp;<span class="op" id="3381001">(</span><span class="op" id="3381002">*</span><span class="ident" id="3381003">newArray</span><span class="op" id="3381011">)</span><span class="op" id="3381012">[</span><span class="op" id="3381013">*</span><span class="ident" id="3381014">newLow</span><span class="op" id="3381020">]</span><span class="op" id="3381021">,</span>&nbsp;<span class="op" id="3381023">(</span><span class="op" id="3381024">*</span><span class="ident" id="3381025">newArray</span><span class="op" id="3381033">)</span><span class="op" id="3381034">[</span><span class="op" id="3381035">*</span><span class="ident" id="3381036">newLow</span><span class="op" id="3381042">+</span><span class="num" id="3381043">1</span><span class="op" id="3381044">]</span><span class="op" id="3381045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381049">*</span><span class="ident" id="3381050">newLow</span>&nbsp;<span class="op" id="3381057">+=</span>&nbsp;<span class="num" id="3381060">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381064">ix</span>&nbsp;<span class="op" id="3381067">+=</span>&nbsp;<span class="num" id="3381070">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381074">next</span>&nbsp;<span class="op" id="3381079">=</span>&nbsp;<span class="builtinfunc" id="3381081">append</span><span class="op" id="3381087">(</span><span class="ident" id="3381088">next</span><span class="op" id="3381092">,</span>&nbsp;<span class="ident" id="3381094">pc</span><span class="op" id="3381096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381100">return</span>&nbsp;<span class="builtintype" id="3381107">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381117">for</span>&nbsp;<span class="ident" id="3381121">lx</span>&nbsp;<span class="op" id="3381124">&lt;</span>&nbsp;<span class="ident" id="3381126">leftLen</span>&nbsp;<span class="op" id="3381134">||</span>&nbsp;<span class="ident" id="3381137">rx</span>&nbsp;<span class="op" id="3381140">&lt;</span>&nbsp;<span class="ident" id="3381142">rightLen</span>&nbsp;<span class="op" id="3381151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381155">switch</span>&nbsp;<span class="op" id="3381162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381166">case</span>&nbsp;<span class="ident" id="3381171">rx</span>&nbsp;<span class="op" id="3381174">&gt;=</span>&nbsp;<span class="ident" id="3381177">rightLen</span><span class="op" id="3381185">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381190">ok</span>&nbsp;<span class="op" id="3381193">=</span>&nbsp;<span class="ident" id="3381195">extend</span><span class="op" id="3381201">(</span><span class="op" id="3381202">&amp;</span><span class="ident" id="3381203">lx</span><span class="op" id="3381205">,</span>&nbsp;<span class="ident" id="3381207">leftRunes</span><span class="op" id="3381216">,</span>&nbsp;<span class="ident" id="3381218">leftPC</span><span class="op" id="3381224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381228">case</span>&nbsp;<span class="ident" id="3381233">lx</span>&nbsp;<span class="op" id="3381236">&gt;=</span>&nbsp;<span class="ident" id="3381239">leftLen</span><span class="op" id="3381246">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381251">ok</span>&nbsp;<span class="op" id="3381254">=</span>&nbsp;<span class="ident" id="3381256">extend</span><span class="op" id="3381262">(</span><span class="op" id="3381263">&amp;</span><span class="ident" id="3381264">rx</span><span class="op" id="3381266">,</span>&nbsp;<span class="ident" id="3381268">rightRunes</span><span class="op" id="3381278">,</span>&nbsp;<span class="ident" id="3381280">rightPC</span><span class="op" id="3381287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381291">case</span>&nbsp;<span class="op" id="3381296">(</span><span class="op" id="3381297">*</span><span class="ident" id="3381298">rightRunes</span><span class="op" id="3381308">)</span><span class="op" id="3381309">[</span><span class="ident" id="3381310">rx</span><span class="op" id="3381312">]</span>&nbsp;<span class="op" id="3381314">&lt;</span>&nbsp;<span class="op" id="3381316">(</span><span class="op" id="3381317">*</span><span class="ident" id="3381318">leftRunes</span><span class="op" id="3381327">)</span><span class="op" id="3381328">[</span><span class="ident" id="3381329">lx</span><span class="op" id="3381331">]</span><span class="op" id="3381332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381337">ok</span>&nbsp;<span class="op" id="3381340">=</span>&nbsp;<span class="ident" id="3381342">extend</span><span class="op" id="3381348">(</span><span class="op" id="3381349">&amp;</span><span class="ident" id="3381350">rx</span><span class="op" id="3381352">,</span>&nbsp;<span class="ident" id="3381354">rightRunes</span><span class="op" id="3381364">,</span>&nbsp;<span class="ident" id="3381366">rightPC</span><span class="op" id="3381373">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381377">default</span><span class="op" id="3381384">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381389">ok</span>&nbsp;<span class="op" id="3381392">=</span>&nbsp;<span class="ident" id="3381394">extend</span><span class="op" id="3381400">(</span><span class="op" id="3381401">&amp;</span><span class="ident" id="3381402">lx</span><span class="op" id="3381404">,</span>&nbsp;<span class="ident" id="3381406">leftRunes</span><span class="op" id="3381415">,</span>&nbsp;<span class="ident" id="3381417">leftPC</span><span class="op" id="3381423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381431">if</span>&nbsp;<span class="op" id="3381434">!</span><span class="ident" id="3381435">ok</span>&nbsp;<span class="op" id="3381438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381443">return</span>&nbsp;<span class="ident" id="3381450">noRune</span><span class="op" id="3381456">,</span>&nbsp;<span class="ident" id="3381458">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3381470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381473">return</span>&nbsp;<span class="ident" id="3381480">merged</span><span class="op" id="3381486">,</span>&nbsp;<span class="ident" id="3381488">next</span><br>
<span class="lineno"></span><span class="op" id="3381493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="3381496">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="3381580">func</span>&nbsp;<span class="ident" id="3381585">cleanupOnePass</span><span class="op" id="3381599">(</span><span class="ident" id="3381600">prog</span>&nbsp;<span class="op" id="3381605">*</span><span class="ident" id="3381606">onePassProg</span><span class="op" id="3381617">,</span>&nbsp;<span class="ident" id="3381619">original</span>&nbsp;<span class="op" id="3381628">*</span><span class="ident" id="3381629">syntax</span><span class="op" id="3381635">.</span><span class="ident" id="3381636">Prog</span><span class="op" id="3381640">)</span>&nbsp;<span class="op" id="3381642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381645">for</span>&nbsp;<span class="ident" id="3381649">ix</span><span class="op" id="3381651">,</span>&nbsp;<span class="ident" id="3381653">instOriginal</span>&nbsp;<span class="op" id="3381666">:=</span>&nbsp;<span class="keyword" id="3381669">range</span>&nbsp;<span class="ident" id="3381675">original</span><span class="op" id="3381683">.</span><span class="ident" id="3381684">Inst</span>&nbsp;<span class="op" id="3381689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381693">switch</span>&nbsp;<span class="ident" id="3381700">instOriginal</span><span class="op" id="3381712">.</span><span class="ident" id="3381713">Op</span>&nbsp;<span class="op" id="3381716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381720">case</span>&nbsp;<span class="ident" id="3381725">syntax</span><span class="op" id="3381731">.</span><span class="ident" id="3381732">InstAlt</span><span class="op" id="3381739">,</span>&nbsp;<span class="ident" id="3381741">syntax</span><span class="op" id="3381747">.</span><span class="ident" id="3381748">InstAltMatch</span><span class="op" id="3381760">,</span>&nbsp;<span class="ident" id="3381762">syntax</span><span class="op" id="3381768">.</span><span class="ident" id="3381769">InstRune</span><span class="op" id="3381777">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381781">case</span>&nbsp;<span class="ident" id="3381786">syntax</span><span class="op" id="3381792">.</span><span class="ident" id="3381793">InstCapture</span><span class="op" id="3381804">,</span>&nbsp;<span class="ident" id="3381806">syntax</span><span class="op" id="3381812">.</span><span class="ident" id="3381813">InstEmptyWidth</span><span class="op" id="3381827">,</span>&nbsp;<span class="ident" id="3381829">syntax</span><span class="op" id="3381835">.</span><span class="ident" id="3381836">InstNop</span><span class="op" id="3381843">,</span>&nbsp;<span class="ident" id="3381845">syntax</span><span class="op" id="3381851">.</span><span class="ident" id="3381852">InstMatch</span><span class="op" id="3381861">,</span>&nbsp;<span class="ident" id="3381863">syntax</span><span class="op" id="3381869">.</span><span class="ident" id="3381870">InstFail</span><span class="op" id="3381878">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381883">prog</span><span class="op" id="3381887">.</span><span class="ident" id="3381888">Inst</span><span class="op" id="3381892">[</span><span class="ident" id="3381893">ix</span><span class="op" id="3381895">]</span><span class="op" id="3381896">.</span><span class="ident" id="3381897">Next</span>&nbsp;<span class="op" id="3381902">=</span>&nbsp;<span class="ident" id="3381904">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3381910">case</span>&nbsp;<span class="ident" id="3381915">syntax</span><span class="op" id="3381921">.</span><span class="ident" id="3381922">InstRune1</span><span class="op" id="3381931">,</span>&nbsp;<span class="ident" id="3381933">syntax</span><span class="op" id="3381939">.</span><span class="ident" id="3381940">InstRuneAny</span><span class="op" id="3381951">,</span>&nbsp;<span class="ident" id="3381953">syntax</span><span class="op" id="3381959">.</span><span class="ident" id="3381960">InstRuneAnyNotNL</span><span class="op" id="3381976">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3381981">prog</span><span class="op" id="3381985">.</span><span class="ident" id="3381986">Inst</span><span class="op" id="3381990">[</span><span class="ident" id="3381991">ix</span><span class="op" id="3381993">]</span><span class="op" id="3381994">.</span><span class="ident" id="3381995">Next</span>&nbsp;<span class="op" id="3382000">=</span>&nbsp;<span class="ident" id="3382002">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382009">prog</span><span class="op" id="3382013">.</span><span class="ident" id="3382014">Inst</span><span class="op" id="3382018">[</span><span class="ident" id="3382019">ix</span><span class="op" id="3382021">]</span>&nbsp;<span class="op" id="3382023">=</span>&nbsp;<span class="ident" id="3382025">onePassInst</span><span class="op" id="3382036">{</span><span class="ident" id="3382037">Inst</span><span class="op" id="3382041">:</span>&nbsp;<span class="ident" id="3382043">instOriginal</span><span class="op" id="3382055">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382062">}</span><br>
<span class="lineno"></span><span class="op" id="3382064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3382067">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="3382144">func</span>&nbsp;<span class="ident" id="3382149">onePassCopy</span><span class="op" id="3382160">(</span><span class="ident" id="3382161">prog</span>&nbsp;<span class="op" id="3382166">*</span><span class="ident" id="3382167">syntax</span><span class="op" id="3382173">.</span><span class="ident" id="3382174">Prog</span><span class="op" id="3382178">)</span>&nbsp;<span class="op" id="3382180">*</span><span class="ident" id="3382181">onePassProg</span>&nbsp;<span class="op" id="3382193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382196">p</span>&nbsp;<span class="op" id="3382198">:=</span>&nbsp;<span class="op" id="3382201">&amp;</span><span class="ident" id="3382202">onePassProg</span><span class="op" id="3382213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382217">Start</span><span class="op" id="3382222">:</span>&nbsp;&nbsp;<span class="ident" id="3382225">prog</span><span class="op" id="3382229">.</span><span class="ident" id="3382230">Start</span><span class="op" id="3382235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382239">NumCap</span><span class="op" id="3382245">:</span>&nbsp;<span class="ident" id="3382247">prog</span><span class="op" id="3382251">.</span><span class="ident" id="3382252">NumCap</span><span class="op" id="3382258">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382261">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382264">for</span>&nbsp;<span class="ident" id="3382268">_</span><span class="op" id="3382269">,</span>&nbsp;<span class="ident" id="3382271">inst</span>&nbsp;<span class="op" id="3382276">:=</span>&nbsp;<span class="keyword" id="3382279">range</span>&nbsp;<span class="ident" id="3382285">prog</span><span class="op" id="3382289">.</span><span class="ident" id="3382290">Inst</span>&nbsp;<span class="op" id="3382295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382299">p</span><span class="op" id="3382300">.</span><span class="ident" id="3382301">Inst</span>&nbsp;<span class="op" id="3382306">=</span>&nbsp;<span class="builtinfunc" id="3382308">append</span><span class="op" id="3382314">(</span><span class="ident" id="3382315">p</span><span class="op" id="3382316">.</span><span class="ident" id="3382317">Inst</span><span class="op" id="3382321">,</span>&nbsp;<span class="ident" id="3382323">onePassInst</span><span class="op" id="3382334">{</span><span class="ident" id="3382335">Inst</span><span class="op" id="3382339">:</span>&nbsp;<span class="ident" id="3382341">inst</span><span class="op" id="3382345">}</span><span class="op" id="3382346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382353">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382428">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382504">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382540">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382571">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382602">for</span>&nbsp;<span class="ident" id="3382606">pc</span>&nbsp;<span class="op" id="3382609">:=</span>&nbsp;<span class="keyword" id="3382612">range</span>&nbsp;<span class="ident" id="3382618">p</span><span class="op" id="3382619">.</span><span class="ident" id="3382620">Inst</span>&nbsp;<span class="op" id="3382625">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382629">switch</span>&nbsp;<span class="ident" id="3382636">p</span><span class="op" id="3382637">.</span><span class="ident" id="3382638">Inst</span><span class="op" id="3382642">[</span><span class="ident" id="3382643">pc</span><span class="op" id="3382645">]</span><span class="op" id="3382646">.</span><span class="ident" id="3382647">Op</span>&nbsp;<span class="op" id="3382650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382654">default</span><span class="op" id="3382661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382666">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382677">case</span>&nbsp;<span class="ident" id="3382682">syntax</span><span class="op" id="3382688">.</span><span class="ident" id="3382689">InstAlt</span><span class="op" id="3382696">,</span>&nbsp;<span class="ident" id="3382698">syntax</span><span class="op" id="3382704">.</span><span class="ident" id="3382705">InstAltMatch</span><span class="op" id="3382717">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382722">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382740">p_A_Other</span>&nbsp;<span class="op" id="3382750">:=</span>&nbsp;<span class="op" id="3382753">&amp;</span><span class="ident" id="3382754">p</span><span class="op" id="3382755">.</span><span class="ident" id="3382756">Inst</span><span class="op" id="3382760">[</span><span class="ident" id="3382761">pc</span><span class="op" id="3382763">]</span><span class="op" id="3382764">.</span><span class="ident" id="3382765">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382772">p_A_Alt</span>&nbsp;<span class="op" id="3382780">:=</span>&nbsp;<span class="op" id="3382783">&amp;</span><span class="ident" id="3382784">p</span><span class="op" id="3382785">.</span><span class="ident" id="3382786">Inst</span><span class="op" id="3382790">[</span><span class="ident" id="3382791">pc</span><span class="op" id="3382793">]</span><span class="op" id="3382794">.</span><span class="ident" id="3382795">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3382802">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382842">instAlt</span>&nbsp;<span class="op" id="3382850">:=</span>&nbsp;<span class="ident" id="3382853">p</span><span class="op" id="3382854">.</span><span class="ident" id="3382855">Inst</span><span class="op" id="3382859">[</span><span class="op" id="3382860">*</span><span class="ident" id="3382861">p_A_Alt</span><span class="op" id="3382868">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382873">if</span>&nbsp;<span class="op" id="3382876">!</span><span class="op" id="3382877">(</span><span class="ident" id="3382878">instAlt</span><span class="op" id="3382885">.</span><span class="ident" id="3382886">Op</span>&nbsp;<span class="op" id="3382889">==</span>&nbsp;<span class="ident" id="3382892">syntax</span><span class="op" id="3382898">.</span><span class="ident" id="3382899">InstAlt</span>&nbsp;<span class="op" id="3382907">||</span>&nbsp;<span class="ident" id="3382910">instAlt</span><span class="op" id="3382917">.</span><span class="ident" id="3382918">Op</span>&nbsp;<span class="op" id="3382921">==</span>&nbsp;<span class="ident" id="3382924">syntax</span><span class="op" id="3382930">.</span><span class="ident" id="3382931">InstAltMatch</span><span class="op" id="3382943">)</span>&nbsp;<span class="op" id="3382945">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382951">p_A_Alt</span><span class="op" id="3382958">,</span>&nbsp;<span class="ident" id="3382960">p_A_Other</span>&nbsp;<span class="op" id="3382970">=</span>&nbsp;<span class="ident" id="3382972">p_A_Other</span><span class="op" id="3382981">,</span>&nbsp;<span class="ident" id="3382983">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382995">instAlt</span>&nbsp;<span class="op" id="3383003">=</span>&nbsp;<span class="ident" id="3383005">p</span><span class="op" id="3383006">.</span><span class="ident" id="3383007">Inst</span><span class="op" id="3383011">[</span><span class="op" id="3383012">*</span><span class="ident" id="3383013">p_A_Alt</span><span class="op" id="3383020">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383026">if</span>&nbsp;<span class="op" id="3383029">!</span><span class="op" id="3383030">(</span><span class="ident" id="3383031">instAlt</span><span class="op" id="3383038">.</span><span class="ident" id="3383039">Op</span>&nbsp;<span class="op" id="3383042">==</span>&nbsp;<span class="ident" id="3383045">syntax</span><span class="op" id="3383051">.</span><span class="ident" id="3383052">InstAlt</span>&nbsp;<span class="op" id="3383060">||</span>&nbsp;<span class="ident" id="3383063">instAlt</span><span class="op" id="3383070">.</span><span class="ident" id="3383071">Op</span>&nbsp;<span class="op" id="3383074">==</span>&nbsp;<span class="ident" id="3383077">syntax</span><span class="op" id="3383083">.</span><span class="ident" id="3383084">InstAltMatch</span><span class="op" id="3383096">)</span>&nbsp;<span class="op" id="3383098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383105">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383118">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383128">instOther</span>&nbsp;<span class="op" id="3383138">:=</span>&nbsp;<span class="ident" id="3383141">p</span><span class="op" id="3383142">.</span><span class="ident" id="3383143">Inst</span><span class="op" id="3383147">[</span><span class="op" id="3383148">*</span><span class="ident" id="3383149">p_A_Other</span><span class="op" id="3383158">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383163">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383225">if</span>&nbsp;<span class="ident" id="3383228">instOther</span><span class="op" id="3383237">.</span><span class="ident" id="3383238">Op</span>&nbsp;<span class="op" id="3383241">==</span>&nbsp;<span class="ident" id="3383244">syntax</span><span class="op" id="3383250">.</span><span class="ident" id="3383251">InstAlt</span>&nbsp;<span class="op" id="3383259">||</span>&nbsp;<span class="ident" id="3383262">instOther</span><span class="op" id="3383271">.</span><span class="ident" id="3383272">Op</span>&nbsp;<span class="op" id="3383275">==</span>&nbsp;<span class="ident" id="3383278">syntax</span><span class="op" id="3383284">.</span><span class="ident" id="3383285">InstAltMatch</span>&nbsp;<span class="op" id="3383298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383304">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383327">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383344">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383379">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383412">p_B_Alt</span>&nbsp;<span class="op" id="3383420">:=</span>&nbsp;<span class="op" id="3383423">&amp;</span><span class="ident" id="3383424">p</span><span class="op" id="3383425">.</span><span class="ident" id="3383426">Inst</span><span class="op" id="3383430">[</span><span class="op" id="3383431">*</span><span class="ident" id="3383432">p_A_Alt</span><span class="op" id="3383439">]</span><span class="op" id="3383440">.</span><span class="ident" id="3383441">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383448">p_B_Other</span>&nbsp;<span class="op" id="3383458">:=</span>&nbsp;<span class="op" id="3383461">&amp;</span><span class="ident" id="3383462">p</span><span class="op" id="3383463">.</span><span class="ident" id="3383464">Inst</span><span class="op" id="3383468">[</span><span class="op" id="3383469">*</span><span class="ident" id="3383470">p_A_Alt</span><span class="op" id="3383477">]</span><span class="op" id="3383478">.</span><span class="ident" id="3383479">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383486">patch</span>&nbsp;<span class="op" id="3383492">:=</span>&nbsp;<span class="builtintype" id="3383495">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383504">if</span>&nbsp;<span class="ident" id="3383507">instAlt</span><span class="op" id="3383514">.</span><span class="ident" id="3383515">Out</span>&nbsp;<span class="op" id="3383519">==</span>&nbsp;<span class="builtintype" id="3383522">uint32</span><span class="op" id="3383528">(</span><span class="ident" id="3383529">pc</span><span class="op" id="3383531">)</span>&nbsp;<span class="op" id="3383533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383539">patch</span>&nbsp;<span class="op" id="3383545">=</span>&nbsp;<span class="builtintype" id="3383547">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383555">}</span>&nbsp;<span class="keyword" id="3383557">else</span>&nbsp;<span class="keyword" id="3383562">if</span>&nbsp;<span class="ident" id="3383565">instAlt</span><span class="op" id="3383572">.</span><span class="ident" id="3383573">Arg</span>&nbsp;<span class="op" id="3383577">==</span>&nbsp;<span class="builtintype" id="3383580">uint32</span><span class="op" id="3383586">(</span><span class="ident" id="3383587">pc</span><span class="op" id="3383589">)</span>&nbsp;<span class="op" id="3383591">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383597">patch</span>&nbsp;<span class="op" id="3383603">=</span>&nbsp;<span class="builtintype" id="3383605">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383614">p_B_Alt</span><span class="op" id="3383621">,</span>&nbsp;<span class="ident" id="3383623">p_B_Other</span>&nbsp;<span class="op" id="3383633">=</span>&nbsp;<span class="ident" id="3383635">p_B_Other</span><span class="op" id="3383644">,</span>&nbsp;<span class="ident" id="3383646">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383662">if</span>&nbsp;<span class="ident" id="3383665">patch</span>&nbsp;<span class="op" id="3383671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383677">*</span><span class="ident" id="3383678">p_B_Alt</span>&nbsp;<span class="op" id="3383686">=</span>&nbsp;<span class="op" id="3383688">*</span><span class="ident" id="3383689">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383708">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383748">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383781">if</span>&nbsp;<span class="op" id="3383784">*</span><span class="ident" id="3383785">p_A_Other</span>&nbsp;<span class="op" id="3383795">==</span>&nbsp;<span class="op" id="3383798">*</span><span class="ident" id="3383799">p_B_Alt</span>&nbsp;<span class="op" id="3383807">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383813">*</span><span class="ident" id="3383814">p_A_Alt</span>&nbsp;<span class="op" id="3383822">=</span>&nbsp;<span class="op" id="3383824">*</span><span class="ident" id="3383825">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383848">return</span>&nbsp;<span class="ident" id="3383855">p</span><br>
<span class="lineno">280</span><span class="op" id="3383857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3383860">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="3383925">type</span>&nbsp;<span class="ident" id="3383930">runeSlice</span>&nbsp;<span class="op" id="3383940">[</span><span class="op" id="3383941">]</span><span class="builtintype" id="3383942">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="3383948">func</span>&nbsp;<span class="op" id="3383953">(</span><span class="ident" id="3383954">p</span>&nbsp;<span class="ident" id="3383956">runeSlice</span><span class="op" id="3383965">)</span>&nbsp;<span class="ident" id="3383967">Len</span><span class="op" id="3383970">(</span><span class="op" id="3383971">)</span>&nbsp;<span class="builtintype" id="3383973">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3383987">{</span>&nbsp;<span class="keyword" id="3383989">return</span>&nbsp;<span class="builtinfunc" id="3383996">len</span><span class="op" id="3383999">(</span><span class="ident" id="3384000">p</span><span class="op" id="3384001">)</span>&nbsp;<span class="op" id="3384003">}</span><br>
<span class="lineno"></span><span class="keyword" id="3384005">func</span>&nbsp;<span class="op" id="3384010">(</span><span class="ident" id="3384011">p</span>&nbsp;<span class="ident" id="3384013">runeSlice</span><span class="op" id="3384022">)</span>&nbsp;<span class="ident" id="3384024">Less</span><span class="op" id="3384028">(</span><span class="ident" id="3384029">i</span><span class="op" id="3384030">,</span>&nbsp;<span class="ident" id="3384032">j</span>&nbsp;<span class="builtintype" id="3384034">int</span><span class="op" id="3384037">)</span>&nbsp;<span class="builtintype" id="3384039">bool</span>&nbsp;<span class="op" id="3384044">{</span>&nbsp;<span class="keyword" id="3384046">return</span>&nbsp;<span class="ident" id="3384053">p</span><span class="op" id="3384054">[</span><span class="ident" id="3384055">i</span><span class="op" id="3384056">]</span>&nbsp;<span class="op" id="3384058">&lt;</span>&nbsp;<span class="ident" id="3384060">p</span><span class="op" id="3384061">[</span><span class="ident" id="3384062">j</span><span class="op" id="3384063">]</span>&nbsp;<span class="op" id="3384065">}</span><br>
<span class="lineno"></span><span class="keyword" id="3384067">func</span>&nbsp;<span class="op" id="3384072">(</span><span class="ident" id="3384073">p</span>&nbsp;<span class="ident" id="3384075">runeSlice</span><span class="op" id="3384084">)</span>&nbsp;<span class="ident" id="3384086">Swap</span><span class="op" id="3384090">(</span><span class="ident" id="3384091">i</span><span class="op" id="3384092">,</span>&nbsp;<span class="ident" id="3384094">j</span>&nbsp;<span class="builtintype" id="3384096">int</span><span class="op" id="3384099">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3384106">{</span>&nbsp;<span class="ident" id="3384108">p</span><span class="op" id="3384109">[</span><span class="ident" id="3384110">i</span><span class="op" id="3384111">]</span><span class="op" id="3384112">,</span>&nbsp;<span class="ident" id="3384114">p</span><span class="op" id="3384115">[</span><span class="ident" id="3384116">j</span><span class="op" id="3384117">]</span>&nbsp;<span class="op" id="3384119">=</span>&nbsp;<span class="ident" id="3384121">p</span><span class="op" id="3384122">[</span><span class="ident" id="3384123">j</span><span class="op" id="3384124">]</span><span class="op" id="3384125">,</span>&nbsp;<span class="ident" id="3384127">p</span><span class="op" id="3384128">[</span><span class="ident" id="3384129">i</span><span class="op" id="3384130">]</span>&nbsp;<span class="op" id="3384132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3384135">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="3384168">func</span>&nbsp;<span class="op" id="3384173">(</span><span class="ident" id="3384174">p</span>&nbsp;<span class="ident" id="3384176">runeSlice</span><span class="op" id="3384185">)</span>&nbsp;<span class="ident" id="3384187">Sort</span><span class="op" id="3384191">(</span><span class="op" id="3384192">)</span>&nbsp;<span class="op" id="3384194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384197">sort</span><span class="op" id="3384201">.</span><span class="ident" id="3384202">Sort</span><span class="op" id="3384206">(</span><span class="ident" id="3384207">p</span><span class="op" id="3384208">)</span><br>
<span class="lineno"></span><span class="op" id="3384210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3384213">var</span>&nbsp;<span class="ident" id="3384217">anyRuneNotNL</span>&nbsp;<span class="op" id="3384230">=</span>&nbsp;<span class="op" id="3384232">[</span><span class="op" id="3384233">]</span><span class="builtintype" id="3384234">rune</span><span class="op" id="3384238">{</span><span class="num" id="3384239">0</span><span class="op" id="3384240">,</span>&nbsp;<span class="string" id="3384242">&#39;\n&#39;</span>&nbsp;<span class="op" id="3384247">-</span>&nbsp;<span class="num" id="3384249">1</span><span class="op" id="3384250">,</span>&nbsp;<span class="string" id="3384252">&#39;\n&#39;</span>&nbsp;<span class="op" id="3384257">+</span>&nbsp;<span class="num" id="3384259">1</span><span class="op" id="3384260">,</span>&nbsp;<span class="ident" id="3384262">unicode</span><span class="op" id="3384269">.</span><span class="ident" id="3384270">MaxRune</span><span class="op" id="3384277">}</span><br>
<span class="lineno">295</span><span class="keyword" id="3384279">var</span>&nbsp;<span class="ident" id="3384283">anyRune</span>&nbsp;<span class="op" id="3384291">=</span>&nbsp;<span class="op" id="3384293">[</span><span class="op" id="3384294">]</span><span class="builtintype" id="3384295">rune</span><span class="op" id="3384299">{</span><span class="num" id="3384300">0</span><span class="op" id="3384301">,</span>&nbsp;<span class="ident" id="3384303">unicode</span><span class="op" id="3384310">.</span><span class="ident" id="3384311">MaxRune</span><span class="op" id="3384318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3384321">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="3384403">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="3384484">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="3384564">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="3384639">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="3384667">func</span>&nbsp;<span class="ident" id="3384672">makeOnePass</span><span class="op" id="3384683">(</span><span class="ident" id="3384684">p</span>&nbsp;<span class="op" id="3384686">*</span><span class="ident" id="3384687">onePassProg</span><span class="op" id="3384698">)</span>&nbsp;<span class="op" id="3384700">*</span><span class="ident" id="3384701">onePassProg</span>&nbsp;<span class="op" id="3384713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384716">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384806">if</span>&nbsp;<span class="builtinfunc" id="3384809">len</span><span class="op" id="3384812">(</span><span class="ident" id="3384813">p</span><span class="op" id="3384814">.</span><span class="ident" id="3384815">Inst</span><span class="op" id="3384819">)</span>&nbsp;<span class="op" id="3384821">&gt;=</span>&nbsp;<span class="num" id="3384824">1000</span>&nbsp;<span class="op" id="3384829">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384833">return</span>&nbsp;<span class="ident" id="3384840">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384856">var</span>&nbsp;<span class="op" id="3384860">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384864">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3384877">=</span>&nbsp;<span class="ident" id="3384879">newQueue</span><span class="op" id="3384887">(</span><span class="builtinfunc" id="3384888">len</span><span class="op" id="3384891">(</span><span class="ident" id="3384892">p</span><span class="op" id="3384893">.</span><span class="ident" id="3384894">Inst</span><span class="op" id="3384898">)</span><span class="op" id="3384899">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384903">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3384916">=</span>&nbsp;<span class="ident" id="3384918">newQueue</span><span class="op" id="3384926">(</span><span class="builtinfunc" id="3384927">len</span><span class="op" id="3384930">(</span><span class="ident" id="3384931">p</span><span class="op" id="3384932">.</span><span class="ident" id="3384933">Inst</span><span class="op" id="3384937">)</span><span class="op" id="3384938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384942">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3384955">func</span><span class="op" id="3384959">(</span><span class="builtintype" id="3384960">uint32</span><span class="op" id="3384966">,</span>&nbsp;<span class="op" id="3384968">*</span><span class="ident" id="3384969">queueOnePass</span><span class="op" id="3384981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384985">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3384998">func</span><span class="op" id="3385002">(</span><span class="builtintype" id="3385003">uint32</span><span class="op" id="3385009">,</span>&nbsp;<span class="keyword" id="3385011">map</span><span class="op" id="3385014">[</span><span class="builtintype" id="3385015">uint32</span><span class="op" id="3385021">]</span><span class="builtintype" id="3385022">bool</span><span class="op" id="3385026">)</span>&nbsp;<span class="builtintype" id="3385028">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385035">onePassRunes</span>&nbsp;<span class="op" id="3385048">=</span>&nbsp;<span class="builtinfunc" id="3385050">make</span><span class="op" id="3385054">(</span><span class="op" id="3385055">[</span><span class="op" id="3385056">]</span><span class="op" id="3385057">[</span><span class="op" id="3385058">]</span><span class="builtintype" id="3385059">rune</span><span class="op" id="3385063">,</span>&nbsp;<span class="builtinfunc" id="3385065">len</span><span class="op" id="3385068">(</span><span class="ident" id="3385069">p</span><span class="op" id="3385070">.</span><span class="ident" id="3385071">Inst</span><span class="op" id="3385075">)</span><span class="op" id="3385076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385079">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385082">build</span>&nbsp;<span class="op" id="3385088">=</span>&nbsp;<span class="keyword" id="3385090">func</span><span class="op" id="3385094">(</span><span class="ident" id="3385095">pc</span>&nbsp;<span class="builtintype" id="3385098">uint32</span><span class="op" id="3385104">,</span>&nbsp;<span class="ident" id="3385106">q</span>&nbsp;<span class="op" id="3385108">*</span><span class="ident" id="3385109">queueOnePass</span><span class="op" id="3385121">)</span>&nbsp;<span class="op" id="3385123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385127">if</span>&nbsp;<span class="ident" id="3385130">q</span><span class="op" id="3385131">.</span><span class="ident" id="3385132">contains</span><span class="op" id="3385140">(</span><span class="ident" id="3385141">pc</span><span class="op" id="3385143">)</span>&nbsp;<span class="op" id="3385145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385150">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385163">inst</span>&nbsp;<span class="op" id="3385168">:=</span>&nbsp;<span class="ident" id="3385171">p</span><span class="op" id="3385172">.</span><span class="ident" id="3385173">Inst</span><span class="op" id="3385177">[</span><span class="ident" id="3385178">pc</span><span class="op" id="3385180">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385184">switch</span>&nbsp;<span class="ident" id="3385191">inst</span><span class="op" id="3385195">.</span><span class="ident" id="3385196">Op</span>&nbsp;<span class="op" id="3385199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385203">case</span>&nbsp;<span class="ident" id="3385208">syntax</span><span class="op" id="3385214">.</span><span class="ident" id="3385215">InstAlt</span><span class="op" id="3385222">,</span>&nbsp;<span class="ident" id="3385224">syntax</span><span class="op" id="3385230">.</span><span class="ident" id="3385231">InstAltMatch</span><span class="op" id="3385243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385248">q</span><span class="op" id="3385249">.</span><span class="ident" id="3385250">insert</span><span class="op" id="3385256">(</span><span class="ident" id="3385257">inst</span><span class="op" id="3385261">.</span><span class="ident" id="3385262">Out</span><span class="op" id="3385265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385270">build</span><span class="op" id="3385275">(</span><span class="ident" id="3385276">inst</span><span class="op" id="3385280">.</span><span class="ident" id="3385281">Out</span><span class="op" id="3385284">,</span>&nbsp;<span class="ident" id="3385286">q</span><span class="op" id="3385287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385292">q</span><span class="op" id="3385293">.</span><span class="ident" id="3385294">insert</span><span class="op" id="3385300">(</span><span class="ident" id="3385301">inst</span><span class="op" id="3385305">.</span><span class="ident" id="3385306">Arg</span><span class="op" id="3385309">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385313">case</span>&nbsp;<span class="ident" id="3385318">syntax</span><span class="op" id="3385324">.</span><span class="ident" id="3385325">InstMatch</span><span class="op" id="3385334">,</span>&nbsp;<span class="ident" id="3385336">syntax</span><span class="op" id="3385342">.</span><span class="ident" id="3385343">InstFail</span><span class="op" id="3385351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385355">default</span><span class="op" id="3385362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385367">q</span><span class="op" id="3385368">.</span><span class="ident" id="3385369">insert</span><span class="op" id="3385375">(</span><span class="ident" id="3385376">inst</span><span class="op" id="3385380">.</span><span class="ident" id="3385381">Out</span><span class="op" id="3385384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385391">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385395">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385475">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385508">check</span>&nbsp;<span class="op" id="3385514">=</span>&nbsp;<span class="keyword" id="3385516">func</span><span class="op" id="3385520">(</span><span class="ident" id="3385521">pc</span>&nbsp;<span class="builtintype" id="3385524">uint32</span><span class="op" id="3385530">,</span>&nbsp;<span class="ident" id="3385532">m</span>&nbsp;<span class="keyword" id="3385534">map</span><span class="op" id="3385537">[</span><span class="builtintype" id="3385538">uint32</span><span class="op" id="3385544">]</span><span class="builtintype" id="3385545">bool</span><span class="op" id="3385549">)</span>&nbsp;<span class="op" id="3385551">(</span><span class="ident" id="3385552">ok</span>&nbsp;<span class="builtintype" id="3385555">bool</span><span class="op" id="3385559">)</span>&nbsp;<span class="op" id="3385561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385565">ok</span>&nbsp;<span class="op" id="3385568">=</span>&nbsp;<span class="builtintype" id="3385570">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385577">inst</span>&nbsp;<span class="op" id="3385582">:=</span>&nbsp;<span class="op" id="3385585">&amp;</span><span class="ident" id="3385586">p</span><span class="op" id="3385587">.</span><span class="ident" id="3385588">Inst</span><span class="op" id="3385592">[</span><span class="ident" id="3385593">pc</span><span class="op" id="3385595">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385599">if</span>&nbsp;<span class="ident" id="3385602">visitQueue</span><span class="op" id="3385612">.</span><span class="ident" id="3385613">contains</span><span class="op" id="3385621">(</span><span class="ident" id="3385622">pc</span><span class="op" id="3385624">)</span>&nbsp;<span class="op" id="3385626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385631">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385644">visitQueue</span><span class="op" id="3385654">.</span><span class="ident" id="3385655">insert</span><span class="op" id="3385661">(</span><span class="ident" id="3385662">pc</span><span class="op" id="3385664">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385668">switch</span>&nbsp;<span class="ident" id="3385675">inst</span><span class="op" id="3385679">.</span><span class="ident" id="3385680">Op</span>&nbsp;<span class="op" id="3385683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385687">case</span>&nbsp;<span class="ident" id="3385692">syntax</span><span class="op" id="3385698">.</span><span class="ident" id="3385699">InstAlt</span><span class="op" id="3385706">,</span>&nbsp;<span class="ident" id="3385708">syntax</span><span class="op" id="3385714">.</span><span class="ident" id="3385715">InstAltMatch</span><span class="op" id="3385727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385732">ok</span>&nbsp;<span class="op" id="3385735">=</span>&nbsp;<span class="ident" id="3385737">check</span><span class="op" id="3385742">(</span><span class="ident" id="3385743">inst</span><span class="op" id="3385747">.</span><span class="ident" id="3385748">Out</span><span class="op" id="3385751">,</span>&nbsp;<span class="ident" id="3385753">m</span><span class="op" id="3385754">)</span>&nbsp;<span class="op" id="3385756">&amp;&amp;</span>&nbsp;<span class="ident" id="3385759">check</span><span class="op" id="3385764">(</span><span class="ident" id="3385765">inst</span><span class="op" id="3385769">.</span><span class="ident" id="3385770">Arg</span><span class="op" id="3385773">,</span>&nbsp;<span class="ident" id="3385775">m</span><span class="op" id="3385776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385781">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385821">matchOut</span>&nbsp;<span class="op" id="3385830">:=</span>&nbsp;<span class="ident" id="3385833">m</span><span class="op" id="3385834">[</span><span class="ident" id="3385835">inst</span><span class="op" id="3385839">.</span><span class="ident" id="3385840">Out</span><span class="op" id="3385843">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385848">matchArg</span>&nbsp;<span class="op" id="3385857">:=</span>&nbsp;<span class="ident" id="3385860">m</span><span class="op" id="3385861">[</span><span class="ident" id="3385862">inst</span><span class="op" id="3385866">.</span><span class="ident" id="3385867">Arg</span><span class="op" id="3385870">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385875">if</span>&nbsp;<span class="ident" id="3385878">matchOut</span>&nbsp;<span class="op" id="3385887">&amp;&amp;</span>&nbsp;<span class="ident" id="3385890">matchArg</span>&nbsp;<span class="op" id="3385899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385905">ok</span>&nbsp;<span class="op" id="3385908">=</span>&nbsp;<span class="builtintype" id="3385910">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385920">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385929">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385934">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385972">if</span>&nbsp;<span class="ident" id="3385975">matchArg</span>&nbsp;<span class="op" id="3385984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385990">inst</span><span class="op" id="3385994">.</span><span class="ident" id="3385995">Out</span><span class="op" id="3385998">,</span>&nbsp;<span class="ident" id="3386000">inst</span><span class="op" id="3386004">.</span><span class="ident" id="3386005">Arg</span>&nbsp;<span class="op" id="3386009">=</span>&nbsp;<span class="ident" id="3386011">inst</span><span class="op" id="3386015">.</span><span class="ident" id="3386016">Arg</span><span class="op" id="3386019">,</span>&nbsp;<span class="ident" id="3386021">inst</span><span class="op" id="3386025">.</span><span class="ident" id="3386026">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386034">matchOut</span><span class="op" id="3386042">,</span>&nbsp;<span class="ident" id="3386044">matchArg</span>&nbsp;<span class="op" id="3386053">=</span>&nbsp;<span class="ident" id="3386055">matchArg</span><span class="op" id="3386063">,</span>&nbsp;<span class="ident" id="3386065">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386077">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386082">if</span>&nbsp;<span class="ident" id="3386085">matchOut</span>&nbsp;<span class="op" id="3386094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386100">m</span><span class="op" id="3386101">[</span><span class="ident" id="3386102">pc</span><span class="op" id="3386104">]</span>&nbsp;<span class="op" id="3386106">=</span>&nbsp;<span class="builtintype" id="3386108">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386117">inst</span><span class="op" id="3386121">.</span><span class="ident" id="3386122">Op</span>&nbsp;<span class="op" id="3386125">=</span>&nbsp;<span class="ident" id="3386127">syntax</span><span class="op" id="3386133">.</span><span class="ident" id="3386134">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386156">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386218">onePassRunes</span><span class="op" id="3386230">[</span><span class="ident" id="3386231">pc</span><span class="op" id="3386233">]</span><span class="op" id="3386234">,</span>&nbsp;<span class="ident" id="3386236">inst</span><span class="op" id="3386240">.</span><span class="ident" id="3386241">Next</span>&nbsp;<span class="op" id="3386246">=</span>&nbsp;<span class="ident" id="3386248">mergeRuneSets</span><span class="op" id="3386261">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386267">&amp;</span><span class="ident" id="3386268">onePassRunes</span><span class="op" id="3386280">[</span><span class="ident" id="3386281">inst</span><span class="op" id="3386285">.</span><span class="ident" id="3386286">Out</span><span class="op" id="3386289">]</span><span class="op" id="3386290">,</span>&nbsp;<span class="op" id="3386292">&amp;</span><span class="ident" id="3386293">onePassRunes</span><span class="op" id="3386305">[</span><span class="ident" id="3386306">inst</span><span class="op" id="3386310">.</span><span class="ident" id="3386311">Arg</span><span class="op" id="3386314">]</span><span class="op" id="3386315">,</span>&nbsp;<span class="ident" id="3386317">inst</span><span class="op" id="3386321">.</span><span class="ident" id="3386322">Out</span><span class="op" id="3386325">,</span>&nbsp;<span class="ident" id="3386327">inst</span><span class="op" id="3386331">.</span><span class="ident" id="3386332">Arg</span><span class="op" id="3386335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386340">if</span>&nbsp;<span class="builtinfunc" id="3386343">len</span><span class="op" id="3386346">(</span><span class="ident" id="3386347">inst</span><span class="op" id="3386351">.</span><span class="ident" id="3386352">Next</span><span class="op" id="3386356">)</span>&nbsp;<span class="op" id="3386358">&gt;</span>&nbsp;<span class="num" id="3386360">0</span>&nbsp;<span class="op" id="3386362">&amp;&amp;</span>&nbsp;<span class="ident" id="3386365">inst</span><span class="op" id="3386369">.</span><span class="ident" id="3386370">Next</span><span class="op" id="3386374">[</span><span class="num" id="3386375">0</span><span class="op" id="3386376">]</span>&nbsp;<span class="op" id="3386378">==</span>&nbsp;<span class="ident" id="3386381">mergeFailed</span>&nbsp;<span class="op" id="3386393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386399">ok</span>&nbsp;<span class="op" id="3386402">=</span>&nbsp;<span class="builtintype" id="3386404">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386414">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386427">case</span>&nbsp;<span class="ident" id="3386432">syntax</span><span class="op" id="3386438">.</span><span class="ident" id="3386439">InstCapture</span><span class="op" id="3386450">,</span>&nbsp;<span class="ident" id="3386452">syntax</span><span class="op" id="3386458">.</span><span class="ident" id="3386459">InstNop</span><span class="op" id="3386466">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386471">ok</span>&nbsp;<span class="op" id="3386474">=</span>&nbsp;<span class="ident" id="3386476">check</span><span class="op" id="3386481">(</span><span class="ident" id="3386482">inst</span><span class="op" id="3386486">.</span><span class="ident" id="3386487">Out</span><span class="op" id="3386490">,</span>&nbsp;<span class="ident" id="3386492">m</span><span class="op" id="3386493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386498">m</span><span class="op" id="3386499">[</span><span class="ident" id="3386500">pc</span><span class="op" id="3386502">]</span>&nbsp;<span class="op" id="3386504">=</span>&nbsp;<span class="ident" id="3386506">m</span><span class="op" id="3386507">[</span><span class="ident" id="3386508">inst</span><span class="op" id="3386512">.</span><span class="ident" id="3386513">Out</span><span class="op" id="3386516">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3386521">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386574">onePassRunes</span><span class="op" id="3386586">[</span><span class="ident" id="3386587">pc</span><span class="op" id="3386589">]</span>&nbsp;<span class="op" id="3386591">=</span>&nbsp;<span class="builtinfunc" id="3386593">append</span><span class="op" id="3386599">(</span><span class="op" id="3386600">[</span><span class="op" id="3386601">]</span><span class="builtintype" id="3386602">rune</span><span class="op" id="3386606">{</span><span class="op" id="3386607">}</span><span class="op" id="3386608">,</span>&nbsp;<span class="ident" id="3386610">onePassRunes</span><span class="op" id="3386622">[</span><span class="ident" id="3386623">inst</span><span class="op" id="3386627">.</span><span class="ident" id="3386628">Out</span><span class="op" id="3386631">]</span><span class="op" id="3386632">...</span><span class="op" id="3386635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386640">inst</span><span class="op" id="3386644">.</span><span class="ident" id="3386645">Next</span>&nbsp;<span class="op" id="3386650">=</span>&nbsp;<span class="op" id="3386652">[</span><span class="op" id="3386653">]</span><span class="builtintype" id="3386654">uint32</span><span class="op" id="3386660">{</span><span class="op" id="3386661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386666">for</span>&nbsp;<span class="ident" id="3386670">i</span>&nbsp;<span class="op" id="3386672">:=</span>&nbsp;<span class="builtinfunc" id="3386675">len</span><span class="op" id="3386678">(</span><span class="ident" id="3386679">onePassRunes</span><span class="op" id="3386691">[</span><span class="ident" id="3386692">pc</span><span class="op" id="3386694">]</span><span class="op" id="3386695">)</span>&nbsp;<span class="op" id="3386697">/</span>&nbsp;<span class="num" id="3386699">2</span><span class="op" id="3386700">;</span>&nbsp;<span class="ident" id="3386702">i</span>&nbsp;<span class="op" id="3386704">&gt;=</span>&nbsp;<span class="num" id="3386707">0</span><span class="op" id="3386708">;</span>&nbsp;<span class="ident" id="3386710">i</span><span class="op" id="3386711">--</span>&nbsp;<span class="op" id="3386714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386720">inst</span><span class="op" id="3386724">.</span><span class="ident" id="3386725">Next</span>&nbsp;<span class="op" id="3386730">=</span>&nbsp;<span class="builtinfunc" id="3386732">append</span><span class="op" id="3386738">(</span><span class="ident" id="3386739">inst</span><span class="op" id="3386743">.</span><span class="ident" id="3386744">Next</span><span class="op" id="3386748">,</span>&nbsp;<span class="ident" id="3386750">inst</span><span class="op" id="3386754">.</span><span class="ident" id="3386755">Out</span><span class="op" id="3386758">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386767">case</span>&nbsp;<span class="ident" id="3386772">syntax</span><span class="op" id="3386778">.</span><span class="ident" id="3386779">InstEmptyWidth</span><span class="op" id="3386793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386798">ok</span>&nbsp;<span class="op" id="3386801">=</span>&nbsp;<span class="ident" id="3386803">check</span><span class="op" id="3386808">(</span><span class="ident" id="3386809">inst</span><span class="op" id="3386813">.</span><span class="ident" id="3386814">Out</span><span class="op" id="3386817">,</span>&nbsp;<span class="ident" id="3386819">m</span><span class="op" id="3386820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386825">m</span><span class="op" id="3386826">[</span><span class="ident" id="3386827">pc</span><span class="op" id="3386829">]</span>&nbsp;<span class="op" id="3386831">=</span>&nbsp;<span class="ident" id="3386833">m</span><span class="op" id="3386834">[</span><span class="ident" id="3386835">inst</span><span class="op" id="3386839">.</span><span class="ident" id="3386840">Out</span><span class="op" id="3386843">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386848">onePassRunes</span><span class="op" id="3386860">[</span><span class="ident" id="3386861">pc</span><span class="op" id="3386863">]</span>&nbsp;<span class="op" id="3386865">=</span>&nbsp;<span class="builtinfunc" id="3386867">append</span><span class="op" id="3386873">(</span><span class="op" id="3386874">[</span><span class="op" id="3386875">]</span><span class="builtintype" id="3386876">rune</span><span class="op" id="3386880">{</span><span class="op" id="3386881">}</span><span class="op" id="3386882">,</span>&nbsp;<span class="ident" id="3386884">onePassRunes</span><span class="op" id="3386896">[</span><span class="ident" id="3386897">inst</span><span class="op" id="3386901">.</span><span class="ident" id="3386902">Out</span><span class="op" id="3386905">]</span><span class="op" id="3386906">...</span><span class="op" id="3386909">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386914">inst</span><span class="op" id="3386918">.</span><span class="ident" id="3386919">Next</span>&nbsp;<span class="op" id="3386924">=</span>&nbsp;<span class="op" id="3386926">[</span><span class="op" id="3386927">]</span><span class="builtintype" id="3386928">uint32</span><span class="op" id="3386934">{</span><span class="op" id="3386935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386940">for</span>&nbsp;<span class="ident" id="3386944">i</span>&nbsp;<span class="op" id="3386946">:=</span>&nbsp;<span class="builtinfunc" id="3386949">len</span><span class="op" id="3386952">(</span><span class="ident" id="3386953">onePassRunes</span><span class="op" id="3386965">[</span><span class="ident" id="3386966">pc</span><span class="op" id="3386968">]</span><span class="op" id="3386969">)</span>&nbsp;<span class="op" id="3386971">/</span>&nbsp;<span class="num" id="3386973">2</span><span class="op" id="3386974">;</span>&nbsp;<span class="ident" id="3386976">i</span>&nbsp;<span class="op" id="3386978">&gt;=</span>&nbsp;<span class="num" id="3386981">0</span><span class="op" id="3386982">;</span>&nbsp;<span class="ident" id="3386984">i</span><span class="op" id="3386985">--</span>&nbsp;<span class="op" id="3386988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386994">inst</span><span class="op" id="3386998">.</span><span class="ident" id="3386999">Next</span>&nbsp;<span class="op" id="3387004">=</span>&nbsp;<span class="builtinfunc" id="3387006">append</span><span class="op" id="3387012">(</span><span class="ident" id="3387013">inst</span><span class="op" id="3387017">.</span><span class="ident" id="3387018">Next</span><span class="op" id="3387022">,</span>&nbsp;<span class="ident" id="3387024">inst</span><span class="op" id="3387028">.</span><span class="ident" id="3387029">Out</span><span class="op" id="3387032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387041">case</span>&nbsp;<span class="ident" id="3387046">syntax</span><span class="op" id="3387052">.</span><span class="ident" id="3387053">InstMatch</span><span class="op" id="3387062">,</span>&nbsp;<span class="ident" id="3387064">syntax</span><span class="op" id="3387070">.</span><span class="ident" id="3387071">InstFail</span><span class="op" id="3387079">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387084">m</span><span class="op" id="3387085">[</span><span class="ident" id="3387086">pc</span><span class="op" id="3387088">]</span>&nbsp;<span class="op" id="3387090">=</span>&nbsp;<span class="ident" id="3387092">inst</span><span class="op" id="3387096">.</span><span class="ident" id="3387097">Op</span>&nbsp;<span class="op" id="3387100">==</span>&nbsp;<span class="ident" id="3387103">syntax</span><span class="op" id="3387109">.</span><span class="ident" id="3387110">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387123">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387131">case</span>&nbsp;<span class="ident" id="3387136">syntax</span><span class="op" id="3387142">.</span><span class="ident" id="3387143">InstRune</span><span class="op" id="3387151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387156">ok</span>&nbsp;<span class="op" id="3387159">=</span>&nbsp;<span class="ident" id="3387161">check</span><span class="op" id="3387166">(</span><span class="ident" id="3387167">inst</span><span class="op" id="3387171">.</span><span class="ident" id="3387172">Out</span><span class="op" id="3387175">,</span>&nbsp;<span class="ident" id="3387177">m</span><span class="op" id="3387178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387183">m</span><span class="op" id="3387184">[</span><span class="ident" id="3387185">pc</span><span class="op" id="3387187">]</span>&nbsp;<span class="op" id="3387189">=</span>&nbsp;<span class="builtintype" id="3387191">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387200">if</span>&nbsp;<span class="builtinfunc" id="3387203">len</span><span class="op" id="3387206">(</span><span class="ident" id="3387207">inst</span><span class="op" id="3387211">.</span><span class="ident" id="3387212">Next</span><span class="op" id="3387216">)</span>&nbsp;<span class="op" id="3387218">&gt;</span>&nbsp;<span class="num" id="3387220">0</span>&nbsp;<span class="op" id="3387222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387228">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387242">if</span>&nbsp;<span class="builtinfunc" id="3387245">len</span><span class="op" id="3387248">(</span><span class="ident" id="3387249">inst</span><span class="op" id="3387253">.</span><span class="ident" id="3387254">Rune</span><span class="op" id="3387258">)</span>&nbsp;<span class="op" id="3387260">==</span>&nbsp;<span class="num" id="3387263">0</span>&nbsp;<span class="op" id="3387265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387271">onePassRunes</span><span class="op" id="3387283">[</span><span class="ident" id="3387284">pc</span><span class="op" id="3387286">]</span>&nbsp;<span class="op" id="3387288">=</span>&nbsp;<span class="op" id="3387290">[</span><span class="op" id="3387291">]</span><span class="builtintype" id="3387292">rune</span><span class="op" id="3387296">{</span><span class="op" id="3387297">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387303">inst</span><span class="op" id="3387307">.</span><span class="ident" id="3387308">Next</span>&nbsp;<span class="op" id="3387313">=</span>&nbsp;<span class="op" id="3387315">[</span><span class="op" id="3387316">]</span><span class="builtintype" id="3387317">uint32</span><span class="op" id="3387323">{</span><span class="ident" id="3387324">inst</span><span class="op" id="3387328">.</span><span class="ident" id="3387329">Out</span><span class="op" id="3387332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387338">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387352">runes</span>&nbsp;<span class="op" id="3387358">:=</span>&nbsp;<span class="builtinfunc" id="3387361">make</span><span class="op" id="3387365">(</span><span class="op" id="3387366">[</span><span class="op" id="3387367">]</span><span class="builtintype" id="3387368">rune</span><span class="op" id="3387372">,</span>&nbsp;<span class="num" id="3387374">0</span><span class="op" id="3387375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387380">if</span>&nbsp;<span class="builtinfunc" id="3387383">len</span><span class="op" id="3387386">(</span><span class="ident" id="3387387">inst</span><span class="op" id="3387391">.</span><span class="ident" id="3387392">Rune</span><span class="op" id="3387396">)</span>&nbsp;<span class="op" id="3387398">==</span>&nbsp;<span class="num" id="3387401">1</span>&nbsp;<span class="op" id="3387403">&amp;&amp;</span>&nbsp;<span class="ident" id="3387406">syntax</span><span class="op" id="3387412">.</span><span class="ident" id="3387413">Flags</span><span class="op" id="3387418">(</span><span class="ident" id="3387419">inst</span><span class="op" id="3387423">.</span><span class="ident" id="3387424">Arg</span><span class="op" id="3387427">)</span><span class="op" id="3387428">&amp;</span><span class="ident" id="3387429">syntax</span><span class="op" id="3387435">.</span><span class="ident" id="3387436">FoldCase</span>&nbsp;<span class="op" id="3387445">!=</span>&nbsp;<span class="num" id="3387448">0</span>&nbsp;<span class="op" id="3387450">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387456">r0</span>&nbsp;<span class="op" id="3387459">:=</span>&nbsp;<span class="ident" id="3387462">inst</span><span class="op" id="3387466">.</span><span class="ident" id="3387467">Rune</span><span class="op" id="3387471">[</span><span class="num" id="3387472">0</span><span class="op" id="3387473">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387479">runes</span>&nbsp;<span class="op" id="3387485">=</span>&nbsp;<span class="builtinfunc" id="3387487">append</span><span class="op" id="3387493">(</span><span class="ident" id="3387494">runes</span><span class="op" id="3387499">,</span>&nbsp;<span class="ident" id="3387501">r0</span><span class="op" id="3387503">,</span>&nbsp;<span class="ident" id="3387505">r0</span><span class="op" id="3387507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387513">for</span>&nbsp;<span class="ident" id="3387517">r1</span>&nbsp;<span class="op" id="3387520">:=</span>&nbsp;<span class="ident" id="3387523">unicode</span><span class="op" id="3387530">.</span><span class="ident" id="3387531">SimpleFold</span><span class="op" id="3387541">(</span><span class="ident" id="3387542">r0</span><span class="op" id="3387544">)</span><span class="op" id="3387545">;</span>&nbsp;<span class="ident" id="3387547">r1</span>&nbsp;<span class="op" id="3387550">!=</span>&nbsp;<span class="ident" id="3387553">r0</span><span class="op" id="3387555">;</span>&nbsp;<span class="ident" id="3387557">r1</span>&nbsp;<span class="op" id="3387560">=</span>&nbsp;<span class="ident" id="3387562">unicode</span><span class="op" id="3387569">.</span><span class="ident" id="3387570">SimpleFold</span><span class="op" id="3387580">(</span><span class="ident" id="3387581">r1</span><span class="op" id="3387583">)</span>&nbsp;<span class="op" id="3387585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387592">runes</span>&nbsp;<span class="op" id="3387598">=</span>&nbsp;<span class="builtinfunc" id="3387600">append</span><span class="op" id="3387606">(</span><span class="ident" id="3387607">runes</span><span class="op" id="3387612">,</span>&nbsp;<span class="ident" id="3387614">r1</span><span class="op" id="3387616">,</span>&nbsp;<span class="ident" id="3387618">r1</span><span class="op" id="3387620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387626">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387632">sort</span><span class="op" id="3387636">.</span><span class="ident" id="3387637">Sort</span><span class="op" id="3387641">(</span><span class="ident" id="3387642">runeSlice</span><span class="op" id="3387651">(</span><span class="ident" id="3387652">runes</span><span class="op" id="3387657">)</span><span class="op" id="3387658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387663">}</span>&nbsp;<span class="keyword" id="3387665">else</span>&nbsp;<span class="op" id="3387670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387676">runes</span>&nbsp;<span class="op" id="3387682">=</span>&nbsp;<span class="builtinfunc" id="3387684">append</span><span class="op" id="3387690">(</span><span class="ident" id="3387691">runes</span><span class="op" id="3387696">,</span>&nbsp;<span class="ident" id="3387698">inst</span><span class="op" id="3387702">.</span><span class="ident" id="3387703">Rune</span><span class="op" id="3387707">...</span><span class="op" id="3387710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387720">onePassRunes</span><span class="op" id="3387732">[</span><span class="ident" id="3387733">pc</span><span class="op" id="3387735">]</span>&nbsp;<span class="op" id="3387737">=</span>&nbsp;<span class="ident" id="3387739">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387748">inst</span><span class="op" id="3387752">.</span><span class="ident" id="3387753">Next</span>&nbsp;<span class="op" id="3387758">=</span>&nbsp;<span class="op" id="3387760">[</span><span class="op" id="3387761">]</span><span class="builtintype" id="3387762">uint32</span><span class="op" id="3387768">{</span><span class="op" id="3387769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387774">for</span>&nbsp;<span class="ident" id="3387778">i</span>&nbsp;<span class="op" id="3387780">:=</span>&nbsp;<span class="builtinfunc" id="3387783">len</span><span class="op" id="3387786">(</span><span class="ident" id="3387787">onePassRunes</span><span class="op" id="3387799">[</span><span class="ident" id="3387800">pc</span><span class="op" id="3387802">]</span><span class="op" id="3387803">)</span>&nbsp;<span class="op" id="3387805">/</span>&nbsp;<span class="num" id="3387807">2</span><span class="op" id="3387808">;</span>&nbsp;<span class="ident" id="3387810">i</span>&nbsp;<span class="op" id="3387812">&gt;=</span>&nbsp;<span class="num" id="3387815">0</span><span class="op" id="3387816">;</span>&nbsp;<span class="ident" id="3387818">i</span><span class="op" id="3387819">--</span>&nbsp;<span class="op" id="3387822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387828">inst</span><span class="op" id="3387832">.</span><span class="ident" id="3387833">Next</span>&nbsp;<span class="op" id="3387838">=</span>&nbsp;<span class="builtinfunc" id="3387840">append</span><span class="op" id="3387846">(</span><span class="ident" id="3387847">inst</span><span class="op" id="3387851">.</span><span class="ident" id="3387852">Next</span><span class="op" id="3387856">,</span>&nbsp;<span class="ident" id="3387858">inst</span><span class="op" id="3387862">.</span><span class="ident" id="3387863">Out</span><span class="op" id="3387866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387876">inst</span><span class="op" id="3387880">.</span><span class="ident" id="3387881">Op</span>&nbsp;<span class="op" id="3387884">=</span>&nbsp;<span class="ident" id="3387886">syntax</span><span class="op" id="3387892">.</span><span class="ident" id="3387893">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387904">case</span>&nbsp;<span class="ident" id="3387909">syntax</span><span class="op" id="3387915">.</span><span class="ident" id="3387916">InstRune1</span><span class="op" id="3387925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387930">ok</span>&nbsp;<span class="op" id="3387933">=</span>&nbsp;<span class="ident" id="3387935">check</span><span class="op" id="3387940">(</span><span class="ident" id="3387941">inst</span><span class="op" id="3387945">.</span><span class="ident" id="3387946">Out</span><span class="op" id="3387949">,</span>&nbsp;<span class="ident" id="3387951">m</span><span class="op" id="3387952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387957">m</span><span class="op" id="3387958">[</span><span class="ident" id="3387959">pc</span><span class="op" id="3387961">]</span>&nbsp;<span class="op" id="3387963">=</span>&nbsp;<span class="builtintype" id="3387965">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387974">if</span>&nbsp;<span class="builtinfunc" id="3387977">len</span><span class="op" id="3387980">(</span><span class="ident" id="3387981">inst</span><span class="op" id="3387985">.</span><span class="ident" id="3387986">Next</span><span class="op" id="3387990">)</span>&nbsp;<span class="op" id="3387992">&gt;</span>&nbsp;<span class="num" id="3387994">0</span>&nbsp;<span class="op" id="3387996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388002">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388016">runes</span>&nbsp;<span class="op" id="3388022">:=</span>&nbsp;<span class="op" id="3388025">[</span><span class="op" id="3388026">]</span><span class="builtintype" id="3388027">rune</span><span class="op" id="3388031">{</span><span class="op" id="3388032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3388037">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388068">if</span>&nbsp;<span class="ident" id="3388071">syntax</span><span class="op" id="3388077">.</span><span class="ident" id="3388078">Flags</span><span class="op" id="3388083">(</span><span class="ident" id="3388084">inst</span><span class="op" id="3388088">.</span><span class="ident" id="3388089">Arg</span><span class="op" id="3388092">)</span><span class="op" id="3388093">&amp;</span><span class="ident" id="3388094">syntax</span><span class="op" id="3388100">.</span><span class="ident" id="3388101">FoldCase</span>&nbsp;<span class="op" id="3388110">!=</span>&nbsp;<span class="num" id="3388113">0</span>&nbsp;<span class="op" id="3388115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388121">r0</span>&nbsp;<span class="op" id="3388124">:=</span>&nbsp;<span class="ident" id="3388127">inst</span><span class="op" id="3388131">.</span><span class="ident" id="3388132">Rune</span><span class="op" id="3388136">[</span><span class="num" id="3388137">0</span><span class="op" id="3388138">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388144">runes</span>&nbsp;<span class="op" id="3388150">=</span>&nbsp;<span class="builtinfunc" id="3388152">append</span><span class="op" id="3388158">(</span><span class="ident" id="3388159">runes</span><span class="op" id="3388164">,</span>&nbsp;<span class="ident" id="3388166">r0</span><span class="op" id="3388168">,</span>&nbsp;<span class="ident" id="3388170">r0</span><span class="op" id="3388172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388178">for</span>&nbsp;<span class="ident" id="3388182">r1</span>&nbsp;<span class="op" id="3388185">:=</span>&nbsp;<span class="ident" id="3388188">unicode</span><span class="op" id="3388195">.</span><span class="ident" id="3388196">SimpleFold</span><span class="op" id="3388206">(</span><span class="ident" id="3388207">r0</span><span class="op" id="3388209">)</span><span class="op" id="3388210">;</span>&nbsp;<span class="ident" id="3388212">r1</span>&nbsp;<span class="op" id="3388215">!=</span>&nbsp;<span class="ident" id="3388218">r0</span><span class="op" id="3388220">;</span>&nbsp;<span class="ident" id="3388222">r1</span>&nbsp;<span class="op" id="3388225">=</span>&nbsp;<span class="ident" id="3388227">unicode</span><span class="op" id="3388234">.</span><span class="ident" id="3388235">SimpleFold</span><span class="op" id="3388245">(</span><span class="ident" id="3388246">r1</span><span class="op" id="3388248">)</span>&nbsp;<span class="op" id="3388250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388257">runes</span>&nbsp;<span class="op" id="3388263">=</span>&nbsp;<span class="builtinfunc" id="3388265">append</span><span class="op" id="3388271">(</span><span class="ident" id="3388272">runes</span><span class="op" id="3388277">,</span>&nbsp;<span class="ident" id="3388279">r1</span><span class="op" id="3388281">,</span>&nbsp;<span class="ident" id="3388283">r1</span><span class="op" id="3388285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388297">sort</span><span class="op" id="3388301">.</span><span class="ident" id="3388302">Sort</span><span class="op" id="3388306">(</span><span class="ident" id="3388307">runeSlice</span><span class="op" id="3388316">(</span><span class="ident" id="3388317">runes</span><span class="op" id="3388322">)</span><span class="op" id="3388323">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388328">}</span>&nbsp;<span class="keyword" id="3388330">else</span>&nbsp;<span class="op" id="3388335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388341">runes</span>&nbsp;<span class="op" id="3388347">=</span>&nbsp;<span class="builtinfunc" id="3388349">append</span><span class="op" id="3388355">(</span><span class="ident" id="3388356">runes</span><span class="op" id="3388361">,</span>&nbsp;<span class="ident" id="3388363">inst</span><span class="op" id="3388367">.</span><span class="ident" id="3388368">Rune</span><span class="op" id="3388372">[</span><span class="num" id="3388373">0</span><span class="op" id="3388374">]</span><span class="op" id="3388375">,</span>&nbsp;<span class="ident" id="3388377">inst</span><span class="op" id="3388381">.</span><span class="ident" id="3388382">Rune</span><span class="op" id="3388386">[</span><span class="num" id="3388387">0</span><span class="op" id="3388388">]</span><span class="op" id="3388389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388399">onePassRunes</span><span class="op" id="3388411">[</span><span class="ident" id="3388412">pc</span><span class="op" id="3388414">]</span>&nbsp;<span class="op" id="3388416">=</span>&nbsp;<span class="ident" id="3388418">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388427">inst</span><span class="op" id="3388431">.</span><span class="ident" id="3388432">Next</span>&nbsp;<span class="op" id="3388437">=</span>&nbsp;<span class="op" id="3388439">[</span><span class="op" id="3388440">]</span><span class="builtintype" id="3388441">uint32</span><span class="op" id="3388447">{</span><span class="op" id="3388448">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388453">for</span>&nbsp;<span class="ident" id="3388457">i</span>&nbsp;<span class="op" id="3388459">:=</span>&nbsp;<span class="builtinfunc" id="3388462">len</span><span class="op" id="3388465">(</span><span class="ident" id="3388466">onePassRunes</span><span class="op" id="3388478">[</span><span class="ident" id="3388479">pc</span><span class="op" id="3388481">]</span><span class="op" id="3388482">)</span>&nbsp;<span class="op" id="3388484">/</span>&nbsp;<span class="num" id="3388486">2</span><span class="op" id="3388487">;</span>&nbsp;<span class="ident" id="3388489">i</span>&nbsp;<span class="op" id="3388491">&gt;=</span>&nbsp;<span class="num" id="3388494">0</span><span class="op" id="3388495">;</span>&nbsp;<span class="ident" id="3388497">i</span><span class="op" id="3388498">--</span>&nbsp;<span class="op" id="3388501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388507">inst</span><span class="op" id="3388511">.</span><span class="ident" id="3388512">Next</span>&nbsp;<span class="op" id="3388517">=</span>&nbsp;<span class="builtinfunc" id="3388519">append</span><span class="op" id="3388525">(</span><span class="ident" id="3388526">inst</span><span class="op" id="3388530">.</span><span class="ident" id="3388531">Next</span><span class="op" id="3388535">,</span>&nbsp;<span class="ident" id="3388537">inst</span><span class="op" id="3388541">.</span><span class="ident" id="3388542">Out</span><span class="op" id="3388545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388555">inst</span><span class="op" id="3388559">.</span><span class="ident" id="3388560">Op</span>&nbsp;<span class="op" id="3388563">=</span>&nbsp;<span class="ident" id="3388565">syntax</span><span class="op" id="3388571">.</span><span class="ident" id="3388572">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388583">case</span>&nbsp;<span class="ident" id="3388588">syntax</span><span class="op" id="3388594">.</span><span class="ident" id="3388595">InstRuneAny</span><span class="op" id="3388606">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388611">ok</span>&nbsp;<span class="op" id="3388614">=</span>&nbsp;<span class="ident" id="3388616">check</span><span class="op" id="3388621">(</span><span class="ident" id="3388622">inst</span><span class="op" id="3388626">.</span><span class="ident" id="3388627">Out</span><span class="op" id="3388630">,</span>&nbsp;<span class="ident" id="3388632">m</span><span class="op" id="3388633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388638">m</span><span class="op" id="3388639">[</span><span class="ident" id="3388640">pc</span><span class="op" id="3388642">]</span>&nbsp;<span class="op" id="3388644">=</span>&nbsp;<span class="builtintype" id="3388646">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388655">if</span>&nbsp;<span class="builtinfunc" id="3388658">len</span><span class="op" id="3388661">(</span><span class="ident" id="3388662">inst</span><span class="op" id="3388666">.</span><span class="ident" id="3388667">Next</span><span class="op" id="3388671">)</span>&nbsp;<span class="op" id="3388673">&gt;</span>&nbsp;<span class="num" id="3388675">0</span>&nbsp;<span class="op" id="3388677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388683">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388692">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388697">onePassRunes</span><span class="op" id="3388709">[</span><span class="ident" id="3388710">pc</span><span class="op" id="3388712">]</span>&nbsp;<span class="op" id="3388714">=</span>&nbsp;<span class="builtinfunc" id="3388716">append</span><span class="op" id="3388722">(</span><span class="op" id="3388723">[</span><span class="op" id="3388724">]</span><span class="builtintype" id="3388725">rune</span><span class="op" id="3388729">{</span><span class="op" id="3388730">}</span><span class="op" id="3388731">,</span>&nbsp;<span class="ident" id="3388733">anyRune</span><span class="op" id="3388740">...</span><span class="op" id="3388743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388748">inst</span><span class="op" id="3388752">.</span><span class="ident" id="3388753">Next</span>&nbsp;<span class="op" id="3388758">=</span>&nbsp;<span class="op" id="3388760">[</span><span class="op" id="3388761">]</span><span class="builtintype" id="3388762">uint32</span><span class="op" id="3388768">{</span><span class="ident" id="3388769">inst</span><span class="op" id="3388773">.</span><span class="ident" id="3388774">Out</span><span class="op" id="3388777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388781">case</span>&nbsp;<span class="ident" id="3388786">syntax</span><span class="op" id="3388792">.</span><span class="ident" id="3388793">InstRuneAnyNotNL</span><span class="op" id="3388809">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388814">ok</span>&nbsp;<span class="op" id="3388817">=</span>&nbsp;<span class="ident" id="3388819">check</span><span class="op" id="3388824">(</span><span class="ident" id="3388825">inst</span><span class="op" id="3388829">.</span><span class="ident" id="3388830">Out</span><span class="op" id="3388833">,</span>&nbsp;<span class="ident" id="3388835">m</span><span class="op" id="3388836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388841">m</span><span class="op" id="3388842">[</span><span class="ident" id="3388843">pc</span><span class="op" id="3388845">]</span>&nbsp;<span class="op" id="3388847">=</span>&nbsp;<span class="builtintype" id="3388849">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388858">if</span>&nbsp;<span class="builtinfunc" id="3388861">len</span><span class="op" id="3388864">(</span><span class="ident" id="3388865">inst</span><span class="op" id="3388869">.</span><span class="ident" id="3388870">Next</span><span class="op" id="3388874">)</span>&nbsp;<span class="op" id="3388876">&gt;</span>&nbsp;<span class="num" id="3388878">0</span>&nbsp;<span class="op" id="3388880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388900">onePassRunes</span><span class="op" id="3388912">[</span><span class="ident" id="3388913">pc</span><span class="op" id="3388915">]</span>&nbsp;<span class="op" id="3388917">=</span>&nbsp;<span class="builtinfunc" id="3388919">append</span><span class="op" id="3388925">(</span><span class="op" id="3388926">[</span><span class="op" id="3388927">]</span><span class="builtintype" id="3388928">rune</span><span class="op" id="3388932">{</span><span class="op" id="3388933">}</span><span class="op" id="3388934">,</span>&nbsp;<span class="ident" id="3388936">anyRuneNotNL</span><span class="op" id="3388948">...</span><span class="op" id="3388951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388956">inst</span><span class="op" id="3388960">.</span><span class="ident" id="3388961">Next</span>&nbsp;<span class="op" id="3388966">=</span>&nbsp;<span class="op" id="3388968">[</span><span class="op" id="3388969">]</span><span class="builtintype" id="3388970">uint32</span><span class="op" id="3388976">{</span><span class="op" id="3388977">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388982">for</span>&nbsp;<span class="ident" id="3388986">i</span>&nbsp;<span class="op" id="3388988">:=</span>&nbsp;<span class="builtinfunc" id="3388991">len</span><span class="op" id="3388994">(</span><span class="ident" id="3388995">onePassRunes</span><span class="op" id="3389007">[</span><span class="ident" id="3389008">pc</span><span class="op" id="3389010">]</span><span class="op" id="3389011">)</span>&nbsp;<span class="op" id="3389013">/</span>&nbsp;<span class="num" id="3389015">2</span><span class="op" id="3389016">;</span>&nbsp;<span class="ident" id="3389018">i</span>&nbsp;<span class="op" id="3389020">&gt;=</span>&nbsp;<span class="num" id="3389023">0</span><span class="op" id="3389024">;</span>&nbsp;<span class="ident" id="3389026">i</span><span class="op" id="3389027">--</span>&nbsp;<span class="op" id="3389030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389036">inst</span><span class="op" id="3389040">.</span><span class="ident" id="3389041">Next</span>&nbsp;<span class="op" id="3389046">=</span>&nbsp;<span class="builtinfunc" id="3389048">append</span><span class="op" id="3389054">(</span><span class="ident" id="3389055">inst</span><span class="op" id="3389059">.</span><span class="ident" id="3389060">Next</span><span class="op" id="3389064">,</span>&nbsp;<span class="ident" id="3389066">inst</span><span class="op" id="3389070">.</span><span class="ident" id="3389071">Out</span><span class="op" id="3389074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389087">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389099">instQueue</span><span class="op" id="3389108">.</span><span class="ident" id="3389109">clear</span><span class="op" id="3389114">(</span><span class="op" id="3389115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389118">instQueue</span><span class="op" id="3389127">.</span><span class="ident" id="3389128">insert</span><span class="op" id="3389134">(</span><span class="builtintype" id="3389135">uint32</span><span class="op" id="3389141">(</span><span class="ident" id="3389142">p</span><span class="op" id="3389143">.</span><span class="ident" id="3389144">Start</span><span class="op" id="3389149">)</span><span class="op" id="3389150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389153">m</span>&nbsp;<span class="op" id="3389155">:=</span>&nbsp;<span class="builtinfunc" id="3389158">make</span><span class="op" id="3389162">(</span><span class="keyword" id="3389163">map</span><span class="op" id="3389166">[</span><span class="builtintype" id="3389167">uint32</span><span class="op" id="3389173">]</span><span class="builtintype" id="3389174">bool</span><span class="op" id="3389178">,</span>&nbsp;<span class="builtinfunc" id="3389180">len</span><span class="op" id="3389183">(</span><span class="ident" id="3389184">p</span><span class="op" id="3389185">.</span><span class="ident" id="3389186">Inst</span><span class="op" id="3389190">)</span><span class="op" id="3389191">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389194">for</span>&nbsp;<span class="op" id="3389198">!</span><span class="ident" id="3389199">instQueue</span><span class="op" id="3389208">.</span><span class="ident" id="3389209">empty</span><span class="op" id="3389214">(</span><span class="op" id="3389215">)</span>&nbsp;<span class="op" id="3389217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389221">pc</span>&nbsp;<span class="op" id="3389224">:=</span>&nbsp;<span class="ident" id="3389227">instQueue</span><span class="op" id="3389236">.</span><span class="ident" id="3389237">next</span><span class="op" id="3389241">(</span><span class="op" id="3389242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389246">inst</span>&nbsp;<span class="op" id="3389251">:=</span>&nbsp;<span class="ident" id="3389254">p</span><span class="op" id="3389255">.</span><span class="ident" id="3389256">Inst</span><span class="op" id="3389260">[</span><span class="ident" id="3389261">pc</span><span class="op" id="3389263">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389267">visitQueue</span><span class="op" id="3389277">.</span><span class="ident" id="3389278">clear</span><span class="op" id="3389283">(</span><span class="op" id="3389284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389288">if</span>&nbsp;<span class="op" id="3389291">!</span><span class="ident" id="3389292">check</span><span class="op" id="3389297">(</span><span class="builtintype" id="3389298">uint32</span><span class="op" id="3389304">(</span><span class="ident" id="3389305">pc</span><span class="op" id="3389307">)</span><span class="op" id="3389308">,</span>&nbsp;<span class="ident" id="3389310">m</span><span class="op" id="3389311">)</span>&nbsp;<span class="op" id="3389313">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389318">p</span>&nbsp;<span class="op" id="3389320">=</span>&nbsp;<span class="ident" id="3389322">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389336">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389348">switch</span>&nbsp;<span class="ident" id="3389355">inst</span><span class="op" id="3389359">.</span><span class="ident" id="3389360">Op</span>&nbsp;<span class="op" id="3389363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389367">case</span>&nbsp;<span class="ident" id="3389372">syntax</span><span class="op" id="3389378">.</span><span class="ident" id="3389379">InstAlt</span><span class="op" id="3389386">,</span>&nbsp;<span class="ident" id="3389388">syntax</span><span class="op" id="3389394">.</span><span class="ident" id="3389395">InstAltMatch</span><span class="op" id="3389407">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389412">instQueue</span><span class="op" id="3389421">.</span><span class="ident" id="3389422">insert</span><span class="op" id="3389428">(</span><span class="ident" id="3389429">inst</span><span class="op" id="3389433">.</span><span class="ident" id="3389434">Out</span><span class="op" id="3389437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389442">instQueue</span><span class="op" id="3389451">.</span><span class="ident" id="3389452">insert</span><span class="op" id="3389458">(</span><span class="ident" id="3389459">inst</span><span class="op" id="3389463">.</span><span class="ident" id="3389464">Arg</span><span class="op" id="3389467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389471">case</span>&nbsp;<span class="ident" id="3389476">syntax</span><span class="op" id="3389482">.</span><span class="ident" id="3389483">InstCapture</span><span class="op" id="3389494">,</span>&nbsp;<span class="ident" id="3389496">syntax</span><span class="op" id="3389502">.</span><span class="ident" id="3389503">InstEmptyWidth</span><span class="op" id="3389517">,</span>&nbsp;<span class="ident" id="3389519">syntax</span><span class="op" id="3389525">.</span><span class="ident" id="3389526">InstNop</span><span class="op" id="3389533">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389538">instQueue</span><span class="op" id="3389547">.</span><span class="ident" id="3389548">insert</span><span class="op" id="3389554">(</span><span class="ident" id="3389555">inst</span><span class="op" id="3389559">.</span><span class="ident" id="3389560">Out</span><span class="op" id="3389563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389567">case</span>&nbsp;<span class="ident" id="3389572">syntax</span><span class="op" id="3389578">.</span><span class="ident" id="3389579">InstMatch</span><span class="op" id="3389588">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389592">case</span>&nbsp;<span class="ident" id="3389597">syntax</span><span class="op" id="3389603">.</span><span class="ident" id="3389604">InstFail</span><span class="op" id="3389612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389616">case</span>&nbsp;<span class="ident" id="3389621">syntax</span><span class="op" id="3389627">.</span><span class="ident" id="3389628">InstRune</span><span class="op" id="3389636">,</span>&nbsp;<span class="ident" id="3389638">syntax</span><span class="op" id="3389644">.</span><span class="ident" id="3389645">InstRune1</span><span class="op" id="3389654">,</span>&nbsp;<span class="ident" id="3389656">syntax</span><span class="op" id="3389662">.</span><span class="ident" id="3389663">InstRuneAny</span><span class="op" id="3389674">,</span>&nbsp;<span class="ident" id="3389676">syntax</span><span class="op" id="3389682">.</span><span class="ident" id="3389683">InstRuneAnyNotNL</span><span class="op" id="3389699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389703">default</span><span class="op" id="3389710">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389717">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389720">if</span>&nbsp;<span class="ident" id="3389723">p</span>&nbsp;<span class="op" id="3389725">!=</span>&nbsp;<span class="ident" id="3389728">notOnePass</span>&nbsp;<span class="op" id="3389739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389743">for</span>&nbsp;<span class="ident" id="3389747">i</span>&nbsp;<span class="op" id="3389749">:=</span>&nbsp;<span class="keyword" id="3389752">range</span>&nbsp;<span class="ident" id="3389758">p</span><span class="op" id="3389759">.</span><span class="ident" id="3389760">Inst</span>&nbsp;<span class="op" id="3389765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389770">p</span><span class="op" id="3389771">.</span><span class="ident" id="3389772">Inst</span><span class="op" id="3389776">[</span><span class="ident" id="3389777">i</span><span class="op" id="3389778">]</span><span class="op" id="3389779">.</span><span class="ident" id="3389780">Rune</span>&nbsp;<span class="op" id="3389785">=</span>&nbsp;<span class="ident" id="3389787">onePassRunes</span><span class="op" id="3389799">[</span><span class="ident" id="3389800">i</span><span class="op" id="3389801">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389808">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389811">return</span>&nbsp;<span class="ident" id="3389818">p</span><br>
<span class="lineno"></span><span class="op" id="3389820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3389823">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="3389891">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="3389928">func</span>&nbsp;<span class="ident" id="3389933">walk</span><span class="op" id="3389937">(</span><span class="ident" id="3389938">prog</span>&nbsp;<span class="op" id="3389943">*</span><span class="ident" id="3389944">syntax</span><span class="op" id="3389950">.</span><span class="ident" id="3389951">Prog</span><span class="op" id="3389955">,</span>&nbsp;<span class="ident" id="3389957">funcs</span>&nbsp;<span class="op" id="3389963">...</span><span class="keyword" id="3389966">func</span><span class="op" id="3389970">(</span><span class="ident" id="3389971">ip</span><span class="op" id="3389973">,</span>&nbsp;<span class="ident" id="3389975">next</span>&nbsp;<span class="builtintype" id="3389980">uint32</span><span class="op" id="3389986">)</span><span class="op" id="3389987">)</span>&nbsp;<span class="op" id="3389989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389992">var</span>&nbsp;<span class="ident" id="3389996">walk1</span>&nbsp;<span class="keyword" id="3390002">func</span><span class="op" id="3390006">(</span><span class="builtintype" id="3390007">uint32</span><span class="op" id="3390013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390016">progQueue</span>&nbsp;<span class="op" id="3390026">:=</span>&nbsp;<span class="ident" id="3390029">newQueue</span><span class="op" id="3390037">(</span><span class="builtinfunc" id="3390038">len</span><span class="op" id="3390041">(</span><span class="ident" id="3390042">prog</span><span class="op" id="3390046">.</span><span class="ident" id="3390047">Inst</span><span class="op" id="3390051">)</span><span class="op" id="3390052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390055">walk1</span>&nbsp;<span class="op" id="3390061">=</span>&nbsp;<span class="keyword" id="3390063">func</span><span class="op" id="3390067">(</span><span class="ident" id="3390068">ip</span>&nbsp;<span class="builtintype" id="3390071">uint32</span><span class="op" id="3390077">)</span>&nbsp;<span class="op" id="3390079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390083">if</span>&nbsp;<span class="ident" id="3390086">progQueue</span><span class="op" id="3390095">.</span><span class="ident" id="3390096">contains</span><span class="op" id="3390104">(</span><span class="ident" id="3390105">ip</span><span class="op" id="3390107">)</span>&nbsp;<span class="op" id="3390109">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390127">progQueue</span><span class="op" id="3390136">.</span><span class="ident" id="3390137">insert</span><span class="op" id="3390143">(</span><span class="ident" id="3390144">ip</span><span class="op" id="3390146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390150">inst</span>&nbsp;<span class="op" id="3390155">:=</span>&nbsp;<span class="ident" id="3390158">prog</span><span class="op" id="3390162">.</span><span class="ident" id="3390163">Inst</span><span class="op" id="3390167">[</span><span class="ident" id="3390168">ip</span><span class="op" id="3390170">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390174">switch</span>&nbsp;<span class="ident" id="3390181">inst</span><span class="op" id="3390185">.</span><span class="ident" id="3390186">Op</span>&nbsp;<span class="op" id="3390189">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390193">case</span>&nbsp;<span class="ident" id="3390198">syntax</span><span class="op" id="3390204">.</span><span class="ident" id="3390205">InstAlt</span><span class="op" id="3390212">,</span>&nbsp;<span class="ident" id="3390214">syntax</span><span class="op" id="3390220">.</span><span class="ident" id="3390221">InstAltMatch</span><span class="op" id="3390233">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390238">for</span>&nbsp;<span class="ident" id="3390242">_</span><span class="op" id="3390243">,</span>&nbsp;<span class="ident" id="3390245">f</span>&nbsp;<span class="op" id="3390247">:=</span>&nbsp;<span class="keyword" id="3390250">range</span>&nbsp;<span class="ident" id="3390256">funcs</span>&nbsp;<span class="op" id="3390262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390268">f</span><span class="op" id="3390269">(</span><span class="ident" id="3390270">ip</span><span class="op" id="3390272">,</span>&nbsp;<span class="ident" id="3390274">inst</span><span class="op" id="3390278">.</span><span class="ident" id="3390279">Out</span><span class="op" id="3390282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390288">f</span><span class="op" id="3390289">(</span><span class="ident" id="3390290">ip</span><span class="op" id="3390292">,</span>&nbsp;<span class="ident" id="3390294">inst</span><span class="op" id="3390298">.</span><span class="ident" id="3390299">Arg</span><span class="op" id="3390302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390307">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390312">walk1</span><span class="op" id="3390317">(</span><span class="ident" id="3390318">inst</span><span class="op" id="3390322">.</span><span class="ident" id="3390323">Out</span><span class="op" id="3390326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390331">walk1</span><span class="op" id="3390336">(</span><span class="ident" id="3390337">inst</span><span class="op" id="3390341">.</span><span class="ident" id="3390342">Arg</span><span class="op" id="3390345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390349">default</span><span class="op" id="3390356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390361">for</span>&nbsp;<span class="ident" id="3390365">_</span><span class="op" id="3390366">,</span>&nbsp;<span class="ident" id="3390368">f</span>&nbsp;<span class="op" id="3390370">:=</span>&nbsp;<span class="keyword" id="3390373">range</span>&nbsp;<span class="ident" id="3390379">funcs</span>&nbsp;<span class="op" id="3390385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390391">f</span><span class="op" id="3390392">(</span><span class="ident" id="3390393">ip</span><span class="op" id="3390395">,</span>&nbsp;<span class="ident" id="3390397">inst</span><span class="op" id="3390401">.</span><span class="ident" id="3390402">Out</span><span class="op" id="3390405">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390415">walk1</span><span class="op" id="3390420">(</span><span class="ident" id="3390421">inst</span><span class="op" id="3390425">.</span><span class="ident" id="3390426">Out</span><span class="op" id="3390429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390439">walk1</span><span class="op" id="3390444">(</span><span class="builtintype" id="3390445">uint32</span><span class="op" id="3390451">(</span><span class="ident" id="3390452">prog</span><span class="op" id="3390456">.</span><span class="ident" id="3390457">Start</span><span class="op" id="3390462">)</span><span class="op" id="3390463">)</span><br>
<span class="lineno">520</span><span class="op" id="3390465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3390468">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="3390537">func</span>&nbsp;<span class="ident" id="3390542">find</span><span class="op" id="3390546">(</span><span class="ident" id="3390547">prog</span>&nbsp;<span class="op" id="3390552">*</span><span class="ident" id="3390553">syntax</span><span class="op" id="3390559">.</span><span class="ident" id="3390560">Prog</span><span class="op" id="3390564">,</span>&nbsp;<span class="ident" id="3390566">f</span>&nbsp;<span class="keyword" id="3390568">func</span><span class="op" id="3390572">(</span><span class="op" id="3390573">*</span><span class="ident" id="3390574">syntax</span><span class="op" id="3390580">.</span><span class="ident" id="3390581">Prog</span><span class="op" id="3390585">,</span>&nbsp;<span class="builtintype" id="3390587">int</span><span class="op" id="3390590">)</span>&nbsp;<span class="builtintype" id="3390592">bool</span><span class="op" id="3390596">)</span>&nbsp;<span class="op" id="3390598">(</span><span class="ident" id="3390599">matches</span>&nbsp;<span class="op" id="3390607">[</span><span class="op" id="3390608">]</span><span class="builtintype" id="3390609">uint32</span><span class="op" id="3390615">)</span>&nbsp;<span class="op" id="3390617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390620">matches</span>&nbsp;<span class="op" id="3390628">=</span>&nbsp;<span class="op" id="3390630">[</span><span class="op" id="3390631">]</span><span class="builtintype" id="3390632">uint32</span><span class="op" id="3390638">{</span><span class="op" id="3390639">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390643">for</span>&nbsp;<span class="ident" id="3390647">ip</span>&nbsp;<span class="op" id="3390650">:=</span>&nbsp;<span class="keyword" id="3390653">range</span>&nbsp;<span class="ident" id="3390659">prog</span><span class="op" id="3390663">.</span><span class="ident" id="3390664">Inst</span>&nbsp;<span class="op" id="3390669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390673">if</span>&nbsp;<span class="ident" id="3390676">f</span><span class="op" id="3390677">(</span><span class="ident" id="3390678">prog</span><span class="op" id="3390682">,</span>&nbsp;<span class="ident" id="3390684">ip</span><span class="op" id="3390686">)</span>&nbsp;<span class="op" id="3390688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390693">matches</span>&nbsp;<span class="op" id="3390701">=</span>&nbsp;<span class="builtinfunc" id="3390703">append</span><span class="op" id="3390709">(</span><span class="ident" id="3390710">matches</span><span class="op" id="3390717">,</span>&nbsp;<span class="builtintype" id="3390719">uint32</span><span class="op" id="3390725">(</span><span class="ident" id="3390726">ip</span><span class="op" id="3390728">)</span><span class="op" id="3390729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390733">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390739">return</span><br>
<span class="lineno"></span><span class="op" id="3390746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3390749">var</span>&nbsp;<span class="ident" id="3390753">notOnePass</span>&nbsp;<span class="op" id="3390764">*</span><span class="ident" id="3390765">onePassProg</span>&nbsp;<span class="op" id="3390777">=</span>&nbsp;<span class="ident" id="3390779">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="3390784">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="3390881">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3390965">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3391051">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="3391137">func</span>&nbsp;<span class="ident" id="3391142">compileOnePass</span><span class="op" id="3391156">(</span><span class="ident" id="3391157">prog</span>&nbsp;<span class="op" id="3391162">*</span><span class="ident" id="3391163">syntax</span><span class="op" id="3391169">.</span><span class="ident" id="3391170">Prog</span><span class="op" id="3391174">)</span>&nbsp;<span class="op" id="3391176">(</span><span class="ident" id="3391177">p</span>&nbsp;<span class="op" id="3391179">*</span><span class="ident" id="3391180">onePassProg</span><span class="op" id="3391191">)</span>&nbsp;<span class="op" id="3391193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391196">if</span>&nbsp;<span class="ident" id="3391199">prog</span><span class="op" id="3391203">.</span><span class="ident" id="3391204">Start</span>&nbsp;<span class="op" id="3391210">==</span>&nbsp;<span class="num" id="3391213">0</span>&nbsp;<span class="op" id="3391215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391219">return</span>&nbsp;<span class="ident" id="3391226">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3391241">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391272">if</span>&nbsp;<span class="ident" id="3391275">prog</span><span class="op" id="3391279">.</span><span class="ident" id="3391280">Inst</span><span class="op" id="3391284">[</span><span class="ident" id="3391285">prog</span><span class="op" id="3391289">.</span><span class="ident" id="3391290">Start</span><span class="op" id="3391295">]</span><span class="op" id="3391296">.</span><span class="ident" id="3391297">Op</span>&nbsp;<span class="op" id="3391300">!=</span>&nbsp;<span class="ident" id="3391303">syntax</span><span class="op" id="3391309">.</span><span class="ident" id="3391310">InstEmptyWidth</span>&nbsp;<span class="op" id="3391325">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391330">syntax</span><span class="op" id="3391336">.</span><span class="ident" id="3391337">EmptyOp</span><span class="op" id="3391344">(</span><span class="ident" id="3391345">prog</span><span class="op" id="3391349">.</span><span class="ident" id="3391350">Inst</span><span class="op" id="3391354">[</span><span class="ident" id="3391355">prog</span><span class="op" id="3391359">.</span><span class="ident" id="3391360">Start</span><span class="op" id="3391365">]</span><span class="op" id="3391366">.</span><span class="ident" id="3391367">Arg</span><span class="op" id="3391370">)</span><span class="op" id="3391371">&amp;</span><span class="ident" id="3391372">syntax</span><span class="op" id="3391378">.</span><span class="ident" id="3391379">EmptyBeginText</span>&nbsp;<span class="op" id="3391394">!=</span>&nbsp;<span class="ident" id="3391397">syntax</span><span class="op" id="3391403">.</span><span class="ident" id="3391404">EmptyBeginText</span>&nbsp;<span class="op" id="3391419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391423">return</span>&nbsp;<span class="ident" id="3391430">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3391445">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391509">for</span>&nbsp;<span class="ident" id="3391513">_</span><span class="op" id="3391514">,</span>&nbsp;<span class="ident" id="3391516">inst</span>&nbsp;<span class="op" id="3391521">:=</span>&nbsp;<span class="keyword" id="3391524">range</span>&nbsp;<span class="ident" id="3391530">prog</span><span class="op" id="3391534">.</span><span class="ident" id="3391535">Inst</span>&nbsp;<span class="op" id="3391540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391544">opOut</span>&nbsp;<span class="op" id="3391550">:=</span>&nbsp;<span class="ident" id="3391553">prog</span><span class="op" id="3391557">.</span><span class="ident" id="3391558">Inst</span><span class="op" id="3391562">[</span><span class="ident" id="3391563">inst</span><span class="op" id="3391567">.</span><span class="ident" id="3391568">Out</span><span class="op" id="3391571">]</span><span class="op" id="3391572">.</span><span class="ident" id="3391573">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391578">switch</span>&nbsp;<span class="ident" id="3391585">inst</span><span class="op" id="3391589">.</span><span class="ident" id="3391590">Op</span>&nbsp;<span class="op" id="3391593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391597">default</span><span class="op" id="3391604">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391609">if</span>&nbsp;<span class="ident" id="3391612">opOut</span>&nbsp;<span class="op" id="3391618">==</span>&nbsp;<span class="ident" id="3391621">syntax</span><span class="op" id="3391627">.</span><span class="ident" id="3391628">InstMatch</span>&nbsp;<span class="op" id="3391638">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391644">return</span>&nbsp;<span class="ident" id="3391651">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391669">case</span>&nbsp;<span class="ident" id="3391674">syntax</span><span class="op" id="3391680">.</span><span class="ident" id="3391681">InstAlt</span><span class="op" id="3391688">,</span>&nbsp;<span class="ident" id="3391690">syntax</span><span class="op" id="3391696">.</span><span class="ident" id="3391697">InstAltMatch</span><span class="op" id="3391709">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391714">if</span>&nbsp;<span class="ident" id="3391717">opOut</span>&nbsp;<span class="op" id="3391723">==</span>&nbsp;<span class="ident" id="3391726">syntax</span><span class="op" id="3391732">.</span><span class="ident" id="3391733">InstMatch</span>&nbsp;<span class="op" id="3391743">||</span>&nbsp;<span class="ident" id="3391746">prog</span><span class="op" id="3391750">.</span><span class="ident" id="3391751">Inst</span><span class="op" id="3391755">[</span><span class="ident" id="3391756">inst</span><span class="op" id="3391760">.</span><span class="ident" id="3391761">Arg</span><span class="op" id="3391764">]</span><span class="op" id="3391765">.</span><span class="ident" id="3391766">Op</span>&nbsp;<span class="op" id="3391769">==</span>&nbsp;<span class="ident" id="3391772">syntax</span><span class="op" id="3391778">.</span><span class="ident" id="3391779">InstMatch</span>&nbsp;<span class="op" id="3391789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391795">return</span>&nbsp;<span class="ident" id="3391802">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391820">case</span>&nbsp;<span class="ident" id="3391825">syntax</span><span class="op" id="3391831">.</span><span class="ident" id="3391832">InstEmptyWidth</span><span class="op" id="3391846">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391851">if</span>&nbsp;<span class="ident" id="3391854">opOut</span>&nbsp;<span class="op" id="3391860">==</span>&nbsp;<span class="ident" id="3391863">syntax</span><span class="op" id="3391869">.</span><span class="ident" id="3391870">InstMatch</span>&nbsp;<span class="op" id="3391880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391886">if</span>&nbsp;<span class="ident" id="3391889">syntax</span><span class="op" id="3391895">.</span><span class="ident" id="3391896">EmptyOp</span><span class="op" id="3391903">(</span><span class="ident" id="3391904">inst</span><span class="op" id="3391908">.</span><span class="ident" id="3391909">Arg</span><span class="op" id="3391912">)</span><span class="op" id="3391913">&amp;</span><span class="ident" id="3391914">syntax</span><span class="op" id="3391920">.</span><span class="ident" id="3391921">EmptyEndText</span>&nbsp;<span class="op" id="3391934">==</span>&nbsp;<span class="ident" id="3391937">syntax</span><span class="op" id="3391943">.</span><span class="ident" id="3391944">EmptyEndText</span>&nbsp;<span class="op" id="3391957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391964">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391983">return</span>&nbsp;<span class="ident" id="3391990">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392011">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3392014">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3392073">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392143">p</span>&nbsp;<span class="op" id="3392145">=</span>&nbsp;<span class="ident" id="3392147">onePassCopy</span><span class="op" id="3392158">(</span><span class="ident" id="3392159">prog</span><span class="op" id="3392163">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3392167">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392230">p</span>&nbsp;<span class="op" id="3392232">=</span>&nbsp;<span class="ident" id="3392234">makeOnePass</span><span class="op" id="3392245">(</span><span class="ident" id="3392246">p</span><span class="op" id="3392247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392251">if</span>&nbsp;<span class="ident" id="3392254">p</span>&nbsp;<span class="op" id="3392256">!=</span>&nbsp;<span class="ident" id="3392259">notOnePass</span>&nbsp;<span class="op" id="3392270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392274">cleanupOnePass</span><span class="op" id="3392288">(</span><span class="ident" id="3392289">p</span><span class="op" id="3392290">,</span>&nbsp;<span class="ident" id="3392292">prog</span><span class="op" id="3392296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392299">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392302">return</span>&nbsp;<span class="ident" id="3392309">p</span><br>
<span class="lineno"></span><span class="op" id="3392311">}</span>
</div>
</body>
</html>
