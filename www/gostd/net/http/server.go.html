<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5094888">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5094943">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5094997">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5095048">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5095080">package</span>&nbsp;<span class="ident" id="5095088">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5095094">import</span>&nbsp;<span class="op" id="5095101">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095104">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095113">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095127">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095137">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095144">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095150">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095163">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095170">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095177">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095188">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095194">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095202">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095213">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095224">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095235">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095243">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5095258">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5095265">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5095268">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="5095309">var</span>&nbsp;<span class="op" id="5095313">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095316">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="5095335">=</span>&nbsp;<span class="ident" id="5095337">errors</span><span class="op" id="5095343">.</span><span class="ident" id="5095344">New</span><span class="op" id="5095347">(</span><span class="string" id="5095348">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="5095379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095382">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="5095401">=</span>&nbsp;<span class="ident" id="5095403">errors</span><span class="op" id="5095409">.</span><span class="ident" id="5095410">New</span><span class="op" id="5095413">(</span><span class="string" id="5095414">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="5095480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095483">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5095502">=</span>&nbsp;<span class="ident" id="5095504">errors</span><span class="op" id="5095510">.</span><span class="ident" id="5095511">New</span><span class="op" id="5095514">(</span><span class="string" id="5095515">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="5095539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095542">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5095561">=</span>&nbsp;<span class="ident" id="5095563">errors</span><span class="op" id="5095569">.</span><span class="ident" id="5095570">New</span><span class="op" id="5095573">(</span><span class="string" id="5095574">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="5095630">)</span><br>
<span class="lineno">35</span><span class="op" id="5095632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5095635">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5095688">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="5095740">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="5095763">//</span><br>
<span class="lineno"></span><span class="comment" id="5095766">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="5095837">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="5095905">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="5095968">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="5095987">//</span><br>
<span class="lineno"></span><span class="comment" id="5095990">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="5096059">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5096127">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="5096197">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="5096229">//</span><br>
<span class="lineno"></span><span class="keyword" id="5096232">type</span>&nbsp;<span class="ident" id="5096237">Handler</span>&nbsp;<span class="keyword" id="5096245">interface</span>&nbsp;<span class="op" id="5096255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096258">ServeHTTP</span><span class="op" id="5096267">(</span><span class="ident" id="5096268">ResponseWriter</span><span class="op" id="5096282">,</span>&nbsp;<span class="op" id="5096284">*</span><span class="ident" id="5096285">Request</span><span class="op" id="5096292">)</span><br>
<span class="lineno"></span><span class="op" id="5096294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5096297">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5096357">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5096388">type</span>&nbsp;<span class="ident" id="5096393">ResponseWriter</span>&nbsp;<span class="keyword" id="5096408">interface</span>&nbsp;<span class="op" id="5096418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096421">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096489">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096556">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096571">Header</span><span class="op" id="5096577">(</span><span class="op" id="5096578">)</span>&nbsp;<span class="ident" id="5096580">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096589">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096659">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096742">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096805">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096883">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096947">Write</span><span class="op" id="5096952">(</span><span class="op" id="5096953">[</span><span class="op" id="5096954">]</span><span class="builtintype" id="5096955">byte</span><span class="op" id="5096959">)</span>&nbsp;<span class="op" id="5096961">(</span><span class="builtintype" id="5096962">int</span><span class="op" id="5096965">,</span>&nbsp;<span class="builtintype" id="5096967">error</span><span class="op" id="5096972">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096976">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097040">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097109">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097166">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097224">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097246">WriteHeader</span><span class="op" id="5097257">(</span><span class="builtintype" id="5097258">int</span><span class="op" id="5097261">)</span><br>
<span class="lineno"></span><span class="op" id="5097263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5097266">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="5097336">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="5097393">//</span><br>
<span class="lineno"></span><span class="comment" id="5097396">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="5097454">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="5097507">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="5097572">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="5097586">type</span>&nbsp;<span class="ident" id="5097591">Flusher</span>&nbsp;<span class="keyword" id="5097599">interface</span>&nbsp;<span class="op" id="5097609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097612">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097661">Flush</span><span class="op" id="5097666">(</span><span class="op" id="5097667">)</span><br>
<span class="lineno"></span><span class="op" id="5097669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5097672">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="5097743">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5097791">type</span>&nbsp;<span class="ident" id="5097796">Hijacker</span>&nbsp;<span class="keyword" id="5097805">interface</span>&nbsp;<span class="op" id="5097815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097818">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097871">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097925">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097976">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5098029">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098059">Hijack</span><span class="op" id="5098065">(</span><span class="op" id="5098066">)</span>&nbsp;<span class="op" id="5098068">(</span><span class="ident" id="5098069">net</span><span class="op" id="5098072">.</span><span class="ident" id="5098073">Conn</span><span class="op" id="5098077">,</span>&nbsp;<span class="op" id="5098079">*</span><span class="ident" id="5098080">bufio</span><span class="op" id="5098085">.</span><span class="ident" id="5098086">ReadWriter</span><span class="op" id="5098096">,</span>&nbsp;<span class="builtintype" id="5098098">error</span><span class="op" id="5098103">)</span><br>
<span class="lineno"></span><span class="op" id="5098105">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5098108">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5098179">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="5098244">//</span><br>
<span class="lineno"></span><span class="comment" id="5098247">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="5098317">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="5098381">type</span>&nbsp;<span class="ident" id="5098386">CloseNotifier</span>&nbsp;<span class="keyword" id="5098400">interface</span>&nbsp;<span class="op" id="5098410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5098413">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5098476">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098522">CloseNotify</span><span class="op" id="5098533">(</span><span class="op" id="5098534">)</span>&nbsp;<span class="op" id="5098536">&lt;-</span><span class="keyword" id="5098538">chan</span>&nbsp;<span class="builtintype" id="5098543">bool</span><br>
<span class="lineno">110</span><span class="op" id="5098548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5098551">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5098611">type</span>&nbsp;<span class="ident" id="5098616">conn</span>&nbsp;<span class="keyword" id="5098621">struct</span>&nbsp;<span class="op" id="5098628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098631">remoteAddr</span>&nbsp;<span class="builtintype" id="5098642">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5098663">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098698">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5098709">*</span><span class="ident" id="5098710">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5098730">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098777">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5098788">net</span><span class="op" id="5098791">.</span><span class="ident" id="5098792">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5098809">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098828">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5098839">io</span><span class="op" id="5098841">.</span><span class="ident" id="5098842">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5098860">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098921">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5098932">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5098953">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098981">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5098992">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5099013">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099067">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5099078">*</span><span class="ident" id="5099079">io</span><span class="op" id="5099081">.</span><span class="ident" id="5099082">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5099099">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099122">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5099133">*</span><span class="ident" id="5099134">bufio</span><span class="op" id="5099139">.</span><span class="ident" id="5099140">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5099154">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099217">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5099228">*</span><span class="ident" id="5099229">tls</span><span class="op" id="5099232">.</span><span class="ident" id="5099233">ConnectionState</span>&nbsp;<span class="comment" id="5099249">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099280">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5099293">sync</span><span class="op" id="5099297">.</span><span class="ident" id="5099298">Mutex</span>&nbsp;<span class="comment" id="5099304">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099329">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5099342">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5099353">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099396">closeNotifyc</span>&nbsp;<span class="keyword" id="5099409">chan</span>&nbsp;<span class="builtintype" id="5099414">bool</span>&nbsp;&nbsp;<span class="comment" id="5099420">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099436">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5099449">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5099460">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="5099503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="5099506">func</span>&nbsp;<span class="op" id="5099511">(</span><span class="ident" id="5099512">c</span>&nbsp;<span class="op" id="5099514">*</span><span class="ident" id="5099515">conn</span><span class="op" id="5099519">)</span>&nbsp;<span class="ident" id="5099521">hijacked</span><span class="op" id="5099529">(</span><span class="op" id="5099530">)</span>&nbsp;<span class="builtintype" id="5099532">bool</span>&nbsp;<span class="op" id="5099537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099540">c</span><span class="op" id="5099541">.</span><span class="ident" id="5099542">mu</span><span class="op" id="5099544">.</span><span class="ident" id="5099545">Lock</span><span class="op" id="5099549">(</span><span class="op" id="5099550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099553">defer</span>&nbsp;<span class="ident" id="5099559">c</span><span class="op" id="5099560">.</span><span class="ident" id="5099561">mu</span><span class="op" id="5099563">.</span><span class="ident" id="5099564">Unlock</span><span class="op" id="5099570">(</span><span class="op" id="5099571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099574">return</span>&nbsp;<span class="ident" id="5099581">c</span><span class="op" id="5099582">.</span><span class="ident" id="5099583">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="5099593">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="5099596">func</span>&nbsp;<span class="op" id="5099601">(</span><span class="ident" id="5099602">c</span>&nbsp;<span class="op" id="5099604">*</span><span class="ident" id="5099605">conn</span><span class="op" id="5099609">)</span>&nbsp;<span class="ident" id="5099611">hijack</span><span class="op" id="5099617">(</span><span class="op" id="5099618">)</span>&nbsp;<span class="op" id="5099620">(</span><span class="ident" id="5099621">rwc</span>&nbsp;<span class="ident" id="5099625">net</span><span class="op" id="5099628">.</span><span class="ident" id="5099629">Conn</span><span class="op" id="5099633">,</span>&nbsp;<span class="ident" id="5099635">buf</span>&nbsp;<span class="op" id="5099639">*</span><span class="ident" id="5099640">bufio</span><span class="op" id="5099645">.</span><span class="ident" id="5099646">ReadWriter</span><span class="op" id="5099656">,</span>&nbsp;<span class="ident" id="5099658">err</span>&nbsp;<span class="builtintype" id="5099662">error</span><span class="op" id="5099667">)</span>&nbsp;<span class="op" id="5099669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099672">c</span><span class="op" id="5099673">.</span><span class="ident" id="5099674">mu</span><span class="op" id="5099676">.</span><span class="ident" id="5099677">Lock</span><span class="op" id="5099681">(</span><span class="op" id="5099682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099685">defer</span>&nbsp;<span class="ident" id="5099691">c</span><span class="op" id="5099692">.</span><span class="ident" id="5099693">mu</span><span class="op" id="5099695">.</span><span class="ident" id="5099696">Unlock</span><span class="op" id="5099702">(</span><span class="op" id="5099703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099706">if</span>&nbsp;<span class="ident" id="5099709">c</span><span class="op" id="5099710">.</span><span class="ident" id="5099711">hijackedv</span>&nbsp;<span class="op" id="5099721">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099725">return</span>&nbsp;<span class="ident" id="5099732">nil</span><span class="op" id="5099735">,</span>&nbsp;<span class="ident" id="5099737">nil</span><span class="op" id="5099740">,</span>&nbsp;<span class="ident" id="5099742">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5099755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099758">if</span>&nbsp;<span class="ident" id="5099761">c</span><span class="op" id="5099762">.</span><span class="ident" id="5099763">closeNotifyc</span>&nbsp;<span class="op" id="5099776">!=</span>&nbsp;<span class="ident" id="5099779">nil</span>&nbsp;<span class="op" id="5099783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099787">return</span>&nbsp;<span class="ident" id="5099794">nil</span><span class="op" id="5099797">,</span>&nbsp;<span class="ident" id="5099799">nil</span><span class="op" id="5099802">,</span>&nbsp;<span class="ident" id="5099804">errors</span><span class="op" id="5099810">.</span><span class="ident" id="5099811">New</span><span class="op" id="5099814">(</span><span class="string" id="5099815">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="5099871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5099874">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099877">c</span><span class="op" id="5099878">.</span><span class="ident" id="5099879">hijackedv</span>&nbsp;<span class="op" id="5099889">=</span>&nbsp;<span class="builtintype" id="5099891">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099897">rwc</span>&nbsp;<span class="op" id="5099901">=</span>&nbsp;<span class="ident" id="5099903">c</span><span class="op" id="5099904">.</span><span class="ident" id="5099905">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099910">buf</span>&nbsp;<span class="op" id="5099914">=</span>&nbsp;<span class="ident" id="5099916">c</span><span class="op" id="5099917">.</span><span class="ident" id="5099918">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099923">c</span><span class="op" id="5099924">.</span><span class="ident" id="5099925">rwc</span>&nbsp;<span class="op" id="5099929">=</span>&nbsp;<span class="ident" id="5099931">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099936">c</span><span class="op" id="5099937">.</span><span class="ident" id="5099938">buf</span>&nbsp;<span class="op" id="5099942">=</span>&nbsp;<span class="ident" id="5099944">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099949">c</span><span class="op" id="5099950">.</span><span class="ident" id="5099951">setState</span><span class="op" id="5099959">(</span><span class="ident" id="5099960">rwc</span><span class="op" id="5099963">,</span>&nbsp;<span class="ident" id="5099965">StateHijacked</span><span class="op" id="5099978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099981">return</span><br>
<span class="lineno"></span><span class="op" id="5099988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5099991">func</span>&nbsp;<span class="op" id="5099996">(</span><span class="ident" id="5099997">c</span>&nbsp;<span class="op" id="5099999">*</span><span class="ident" id="5100000">conn</span><span class="op" id="5100004">)</span>&nbsp;<span class="ident" id="5100006">closeNotify</span><span class="op" id="5100017">(</span><span class="op" id="5100018">)</span>&nbsp;<span class="op" id="5100020">&lt;-</span><span class="keyword" id="5100022">chan</span>&nbsp;<span class="builtintype" id="5100027">bool</span>&nbsp;<span class="op" id="5100032">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100035">c</span><span class="op" id="5100036">.</span><span class="ident" id="5100037">mu</span><span class="op" id="5100039">.</span><span class="ident" id="5100040">Lock</span><span class="op" id="5100044">(</span><span class="op" id="5100045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100048">defer</span>&nbsp;<span class="ident" id="5100054">c</span><span class="op" id="5100055">.</span><span class="ident" id="5100056">mu</span><span class="op" id="5100058">.</span><span class="ident" id="5100059">Unlock</span><span class="op" id="5100065">(</span><span class="op" id="5100066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100069">if</span>&nbsp;<span class="ident" id="5100072">c</span><span class="op" id="5100073">.</span><span class="ident" id="5100074">closeNotifyc</span>&nbsp;<span class="op" id="5100087">==</span>&nbsp;<span class="ident" id="5100090">nil</span>&nbsp;<span class="op" id="5100094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100098">c</span><span class="op" id="5100099">.</span><span class="ident" id="5100100">closeNotifyc</span>&nbsp;<span class="op" id="5100113">=</span>&nbsp;<span class="builtinfunc" id="5100115">make</span><span class="op" id="5100119">(</span><span class="keyword" id="5100120">chan</span>&nbsp;<span class="builtintype" id="5100125">bool</span><span class="op" id="5100129">,</span>&nbsp;<span class="num" id="5100131">1</span><span class="op" id="5100132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100136">if</span>&nbsp;<span class="ident" id="5100139">c</span><span class="op" id="5100140">.</span><span class="ident" id="5100141">hijackedv</span>&nbsp;<span class="op" id="5100151">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5100156">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5100206">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100241">return</span>&nbsp;<span class="ident" id="5100248">c</span><span class="op" id="5100249">.</span><span class="ident" id="5100250">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100269">pr</span><span class="op" id="5100271">,</span>&nbsp;<span class="ident" id="5100273">pw</span>&nbsp;<span class="op" id="5100276">:=</span>&nbsp;<span class="ident" id="5100279">io</span><span class="op" id="5100281">.</span><span class="ident" id="5100282">Pipe</span><span class="op" id="5100286">(</span><span class="op" id="5100287">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100292">readSource</span>&nbsp;<span class="op" id="5100303">:=</span>&nbsp;<span class="ident" id="5100306">c</span><span class="op" id="5100307">.</span><span class="ident" id="5100308">sr</span><span class="op" id="5100310">.</span><span class="ident" id="5100311">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100315">c</span><span class="op" id="5100316">.</span><span class="ident" id="5100317">sr</span><span class="op" id="5100319">.</span><span class="ident" id="5100320">Lock</span><span class="op" id="5100324">(</span><span class="op" id="5100325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100329">c</span><span class="op" id="5100330">.</span><span class="ident" id="5100331">sr</span><span class="op" id="5100333">.</span><span class="ident" id="5100334">r</span>&nbsp;<span class="op" id="5100336">=</span>&nbsp;<span class="ident" id="5100338">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100343">c</span><span class="op" id="5100344">.</span><span class="ident" id="5100345">sr</span><span class="op" id="5100347">.</span><span class="ident" id="5100348">Unlock</span><span class="op" id="5100354">(</span><span class="op" id="5100355">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100359">go</span>&nbsp;<span class="keyword" id="5100362">func</span><span class="op" id="5100366">(</span><span class="op" id="5100367">)</span>&nbsp;<span class="op" id="5100369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100374">_</span><span class="op" id="5100375">,</span>&nbsp;<span class="ident" id="5100377">err</span>&nbsp;<span class="op" id="5100381">:=</span>&nbsp;<span class="ident" id="5100384">io</span><span class="op" id="5100386">.</span><span class="ident" id="5100387">Copy</span><span class="op" id="5100391">(</span><span class="ident" id="5100392">pw</span><span class="op" id="5100394">,</span>&nbsp;<span class="ident" id="5100396">readSource</span><span class="op" id="5100406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100411">if</span>&nbsp;<span class="ident" id="5100414">err</span>&nbsp;<span class="op" id="5100418">==</span>&nbsp;<span class="ident" id="5100421">nil</span>&nbsp;<span class="op" id="5100425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100431">err</span>&nbsp;<span class="op" id="5100435">=</span>&nbsp;<span class="ident" id="5100437">io</span><span class="op" id="5100439">.</span><span class="ident" id="5100440">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100447">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100452">pw</span><span class="op" id="5100454">.</span><span class="ident" id="5100455">CloseWithError</span><span class="op" id="5100469">(</span><span class="ident" id="5100470">err</span><span class="op" id="5100473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100478">c</span><span class="op" id="5100479">.</span><span class="ident" id="5100480">noteClientGone</span><span class="op" id="5100494">(</span><span class="op" id="5100495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100499">}</span><span class="op" id="5100500">(</span><span class="op" id="5100501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100507">return</span>&nbsp;<span class="ident" id="5100514">c</span><span class="op" id="5100515">.</span><span class="ident" id="5100516">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="5100529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5100532">func</span>&nbsp;<span class="op" id="5100537">(</span><span class="ident" id="5100538">c</span>&nbsp;<span class="op" id="5100540">*</span><span class="ident" id="5100541">conn</span><span class="op" id="5100545">)</span>&nbsp;<span class="ident" id="5100547">noteClientGone</span><span class="op" id="5100561">(</span><span class="op" id="5100562">)</span>&nbsp;<span class="op" id="5100564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100567">c</span><span class="op" id="5100568">.</span><span class="ident" id="5100569">mu</span><span class="op" id="5100571">.</span><span class="ident" id="5100572">Lock</span><span class="op" id="5100576">(</span><span class="op" id="5100577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100580">defer</span>&nbsp;<span class="ident" id="5100586">c</span><span class="op" id="5100587">.</span><span class="ident" id="5100588">mu</span><span class="op" id="5100590">.</span><span class="ident" id="5100591">Unlock</span><span class="op" id="5100597">(</span><span class="op" id="5100598">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100601">if</span>&nbsp;<span class="ident" id="5100604">c</span><span class="op" id="5100605">.</span><span class="ident" id="5100606">closeNotifyc</span>&nbsp;<span class="op" id="5100619">!=</span>&nbsp;<span class="ident" id="5100622">nil</span>&nbsp;<span class="op" id="5100626">&amp;&amp;</span>&nbsp;<span class="op" id="5100629">!</span><span class="ident" id="5100630">c</span><span class="op" id="5100631">.</span><span class="ident" id="5100632">clientGone</span>&nbsp;<span class="op" id="5100643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100647">c</span><span class="op" id="5100648">.</span><span class="ident" id="5100649">closeNotifyc</span>&nbsp;<span class="op" id="5100662">&lt;-</span>&nbsp;<span class="builtintype" id="5100665">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100674">c</span><span class="op" id="5100675">.</span><span class="ident" id="5100676">clientGone</span>&nbsp;<span class="op" id="5100687">=</span>&nbsp;<span class="builtintype" id="5100689">true</span><br>
<span class="lineno"></span><span class="op" id="5100694">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5100697">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="5100755">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="5100807">type</span>&nbsp;<span class="ident" id="5100812">switchReader</span>&nbsp;<span class="keyword" id="5100825">struct</span>&nbsp;<span class="op" id="5100832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100835">io</span><span class="op" id="5100837">.</span><span class="ident" id="5100838">Reader</span><br>
<span class="lineno">195</span><span class="op" id="5100845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5100848">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="5100906">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="5100959">type</span>&nbsp;<span class="ident" id="5100964">switchWriter</span>&nbsp;<span class="keyword" id="5100977">struct</span>&nbsp;<span class="op" id="5100984">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100987">io</span><span class="op" id="5100989">.</span><span class="ident" id="5100990">Writer</span><br>
<span class="lineno"></span><span class="op" id="5100997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5101000">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="5101067">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="5101112">type</span>&nbsp;<span class="ident" id="5101117">liveSwitchReader</span>&nbsp;<span class="keyword" id="5101134">struct</span>&nbsp;<span class="op" id="5101141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101144">sync</span><span class="op" id="5101148">.</span><span class="ident" id="5101149">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101156">r</span>&nbsp;<span class="ident" id="5101158">io</span><span class="op" id="5101160">.</span><span class="ident" id="5101161">Reader</span><br>
<span class="lineno"></span><span class="op" id="5101168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="5101171">func</span>&nbsp;<span class="op" id="5101176">(</span><span class="ident" id="5101177">sr</span>&nbsp;<span class="op" id="5101180">*</span><span class="ident" id="5101181">liveSwitchReader</span><span class="op" id="5101197">)</span>&nbsp;<span class="ident" id="5101199">Read</span><span class="op" id="5101203">(</span><span class="ident" id="5101204">p</span>&nbsp;<span class="op" id="5101206">[</span><span class="op" id="5101207">]</span><span class="builtintype" id="5101208">byte</span><span class="op" id="5101212">)</span>&nbsp;<span class="op" id="5101214">(</span><span class="ident" id="5101215">n</span>&nbsp;<span class="builtintype" id="5101217">int</span><span class="op" id="5101220">,</span>&nbsp;<span class="ident" id="5101222">err</span>&nbsp;<span class="builtintype" id="5101226">error</span><span class="op" id="5101231">)</span>&nbsp;<span class="op" id="5101233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101236">sr</span><span class="op" id="5101238">.</span><span class="ident" id="5101239">Lock</span><span class="op" id="5101243">(</span><span class="op" id="5101244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101247">r</span>&nbsp;<span class="op" id="5101249">:=</span>&nbsp;<span class="ident" id="5101252">sr</span><span class="op" id="5101254">.</span><span class="ident" id="5101255">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101258">sr</span><span class="op" id="5101260">.</span><span class="ident" id="5101261">Unlock</span><span class="op" id="5101267">(</span><span class="op" id="5101268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5101271">return</span>&nbsp;<span class="ident" id="5101278">r</span><span class="op" id="5101279">.</span><span class="ident" id="5101280">Read</span><span class="op" id="5101284">(</span><span class="ident" id="5101285">p</span><span class="op" id="5101286">)</span><br>
<span class="lineno">215</span><span class="op" id="5101288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5101291">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="5101345">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="5101387">const</span>&nbsp;<span class="ident" id="5101393">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="5101418">=</span>&nbsp;<span class="num" id="5101420">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="5101426">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="5101495">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="5101544">//</span><br>
<span class="lineno"></span><span class="comment" id="5101547">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="5101619">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="5101690">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="5101762">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="5101836">//</span><br>
<span class="lineno"></span><span class="comment" id="5101839">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="5101909">type</span>&nbsp;<span class="ident" id="5101914">chunkWriter</span>&nbsp;<span class="keyword" id="5101926">struct</span>&nbsp;<span class="op" id="5101933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101936">res</span>&nbsp;<span class="op" id="5101940">*</span><span class="ident" id="5101941">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5101952">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102014">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102072">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102130">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102170">header</span>&nbsp;<span class="ident" id="5102177">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102186">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102250">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102300">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102361">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102384">wroteHeader</span>&nbsp;<span class="builtintype" id="5102396">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102403">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102438">chunking</span>&nbsp;<span class="builtintype" id="5102447">bool</span>&nbsp;<span class="comment" id="5102452">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="5102502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5102505">var</span>&nbsp;<span class="op" id="5102509">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102512">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5102523">=</span>&nbsp;<span class="op" id="5102525">[</span><span class="op" id="5102526">]</span><span class="builtintype" id="5102527">byte</span><span class="op" id="5102531">(</span><span class="string" id="5102532">&#34;\r\n&#34;</span><span class="op" id="5102538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102541">colonSpace</span>&nbsp;<span class="op" id="5102552">=</span>&nbsp;<span class="op" id="5102554">[</span><span class="op" id="5102555">]</span><span class="builtintype" id="5102556">byte</span><span class="op" id="5102560">(</span><span class="string" id="5102561">&#34;:&nbsp;&#34;</span><span class="op" id="5102565">)</span><br>
<span class="lineno"></span><span class="op" id="5102567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5102570">func</span>&nbsp;<span class="op" id="5102575">(</span><span class="ident" id="5102576">cw</span>&nbsp;<span class="op" id="5102579">*</span><span class="ident" id="5102580">chunkWriter</span><span class="op" id="5102591">)</span>&nbsp;<span class="ident" id="5102593">Write</span><span class="op" id="5102598">(</span><span class="ident" id="5102599">p</span>&nbsp;<span class="op" id="5102601">[</span><span class="op" id="5102602">]</span><span class="builtintype" id="5102603">byte</span><span class="op" id="5102607">)</span>&nbsp;<span class="op" id="5102609">(</span><span class="ident" id="5102610">n</span>&nbsp;<span class="builtintype" id="5102612">int</span><span class="op" id="5102615">,</span>&nbsp;<span class="ident" id="5102617">err</span>&nbsp;<span class="builtintype" id="5102621">error</span><span class="op" id="5102626">)</span>&nbsp;<span class="op" id="5102628">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102631">if</span>&nbsp;<span class="op" id="5102634">!</span><span class="ident" id="5102635">cw</span><span class="op" id="5102637">.</span><span class="ident" id="5102638">wroteHeader</span>&nbsp;<span class="op" id="5102650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102654">cw</span><span class="op" id="5102656">.</span><span class="ident" id="5102657">writeHeader</span><span class="op" id="5102668">(</span><span class="ident" id="5102669">p</span><span class="op" id="5102670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5102673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102676">if</span>&nbsp;<span class="ident" id="5102679">cw</span><span class="op" id="5102681">.</span><span class="ident" id="5102682">res</span><span class="op" id="5102685">.</span><span class="ident" id="5102686">req</span><span class="op" id="5102689">.</span><span class="ident" id="5102690">Method</span>&nbsp;<span class="op" id="5102697">==</span>&nbsp;<span class="string" id="5102700">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5102707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5102711">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102728">return</span>&nbsp;<span class="builtinfunc" id="5102735">len</span><span class="op" id="5102738">(</span><span class="ident" id="5102739">p</span><span class="op" id="5102740">)</span><span class="op" id="5102741">,</span>&nbsp;<span class="ident" id="5102743">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5102748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102751">if</span>&nbsp;<span class="ident" id="5102754">cw</span><span class="op" id="5102756">.</span><span class="ident" id="5102757">chunking</span>&nbsp;<span class="op" id="5102766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102770">_</span><span class="op" id="5102771">,</span>&nbsp;<span class="ident" id="5102773">err</span>&nbsp;<span class="op" id="5102777">=</span>&nbsp;<span class="ident" id="5102779">fmt</span><span class="op" id="5102782">.</span><span class="ident" id="5102783">Fprintf</span><span class="op" id="5102790">(</span><span class="ident" id="5102791">cw</span><span class="op" id="5102793">.</span><span class="ident" id="5102794">res</span><span class="op" id="5102797">.</span><span class="ident" id="5102798">conn</span><span class="op" id="5102802">.</span><span class="ident" id="5102803">buf</span><span class="op" id="5102806">,</span>&nbsp;<span class="string" id="5102808">&#34;%x\r\n&#34;</span><span class="op" id="5102816">,</span>&nbsp;<span class="builtinfunc" id="5102818">len</span><span class="op" id="5102821">(</span><span class="ident" id="5102822">p</span><span class="op" id="5102823">)</span><span class="op" id="5102824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102828">if</span>&nbsp;<span class="ident" id="5102831">err</span>&nbsp;<span class="op" id="5102835">!=</span>&nbsp;<span class="ident" id="5102838">nil</span>&nbsp;<span class="op" id="5102842">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102847">cw</span><span class="op" id="5102849">.</span><span class="ident" id="5102850">res</span><span class="op" id="5102853">.</span><span class="ident" id="5102854">conn</span><span class="op" id="5102858">.</span><span class="ident" id="5102859">rwc</span><span class="op" id="5102862">.</span><span class="ident" id="5102863">Close</span><span class="op" id="5102868">(</span><span class="op" id="5102869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102874">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5102883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5102886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102889">n</span><span class="op" id="5102890">,</span>&nbsp;<span class="ident" id="5102892">err</span>&nbsp;<span class="op" id="5102896">=</span>&nbsp;<span class="ident" id="5102898">cw</span><span class="op" id="5102900">.</span><span class="ident" id="5102901">res</span><span class="op" id="5102904">.</span><span class="ident" id="5102905">conn</span><span class="op" id="5102909">.</span><span class="ident" id="5102910">buf</span><span class="op" id="5102913">.</span><span class="ident" id="5102914">Write</span><span class="op" id="5102919">(</span><span class="ident" id="5102920">p</span><span class="op" id="5102921">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102924">if</span>&nbsp;<span class="ident" id="5102927">cw</span><span class="op" id="5102929">.</span><span class="ident" id="5102930">chunking</span>&nbsp;<span class="op" id="5102939">&amp;&amp;</span>&nbsp;<span class="ident" id="5102942">err</span>&nbsp;<span class="op" id="5102946">==</span>&nbsp;<span class="ident" id="5102949">nil</span>&nbsp;<span class="op" id="5102953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5102957">_</span><span class="op" id="5102958">,</span>&nbsp;<span class="ident" id="5102960">err</span>&nbsp;<span class="op" id="5102964">=</span>&nbsp;<span class="ident" id="5102966">cw</span><span class="op" id="5102968">.</span><span class="ident" id="5102969">res</span><span class="op" id="5102972">.</span><span class="ident" id="5102973">conn</span><span class="op" id="5102977">.</span><span class="ident" id="5102978">buf</span><span class="op" id="5102981">.</span><span class="ident" id="5102982">Write</span><span class="op" id="5102987">(</span><span class="ident" id="5102988">crlf</span><span class="op" id="5102992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5102995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5102998">if</span>&nbsp;<span class="ident" id="5103001">err</span>&nbsp;<span class="op" id="5103005">!=</span>&nbsp;<span class="ident" id="5103008">nil</span>&nbsp;<span class="op" id="5103012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103016">cw</span><span class="op" id="5103018">.</span><span class="ident" id="5103019">res</span><span class="op" id="5103022">.</span><span class="ident" id="5103023">conn</span><span class="op" id="5103027">.</span><span class="ident" id="5103028">rwc</span><span class="op" id="5103031">.</span><span class="ident" id="5103032">Close</span><span class="op" id="5103037">(</span><span class="op" id="5103038">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5103041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5103044">return</span><br>
<span class="lineno"></span><span class="op" id="5103051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5103054">func</span>&nbsp;<span class="op" id="5103059">(</span><span class="ident" id="5103060">cw</span>&nbsp;<span class="op" id="5103063">*</span><span class="ident" id="5103064">chunkWriter</span><span class="op" id="5103075">)</span>&nbsp;<span class="ident" id="5103077">flush</span><span class="op" id="5103082">(</span><span class="op" id="5103083">)</span>&nbsp;<span class="op" id="5103085">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5103088">if</span>&nbsp;<span class="op" id="5103091">!</span><span class="ident" id="5103092">cw</span><span class="op" id="5103094">.</span><span class="ident" id="5103095">wroteHeader</span>&nbsp;<span class="op" id="5103107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103111">cw</span><span class="op" id="5103113">.</span><span class="ident" id="5103114">writeHeader</span><span class="op" id="5103125">(</span><span class="ident" id="5103126">nil</span><span class="op" id="5103129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5103132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103135">cw</span><span class="op" id="5103137">.</span><span class="ident" id="5103138">res</span><span class="op" id="5103141">.</span><span class="ident" id="5103142">conn</span><span class="op" id="5103146">.</span><span class="ident" id="5103147">buf</span><span class="op" id="5103150">.</span><span class="ident" id="5103151">Flush</span><span class="op" id="5103156">(</span><span class="op" id="5103157">)</span><br>
<span class="lineno"></span><span class="op" id="5103159">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="5103162">func</span>&nbsp;<span class="op" id="5103167">(</span><span class="ident" id="5103168">cw</span>&nbsp;<span class="op" id="5103171">*</span><span class="ident" id="5103172">chunkWriter</span><span class="op" id="5103183">)</span>&nbsp;<span class="builtinfunc" id="5103185">close</span><span class="op" id="5103190">(</span><span class="op" id="5103191">)</span>&nbsp;<span class="op" id="5103193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5103196">if</span>&nbsp;<span class="op" id="5103199">!</span><span class="ident" id="5103200">cw</span><span class="op" id="5103202">.</span><span class="ident" id="5103203">wroteHeader</span>&nbsp;<span class="op" id="5103215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103219">cw</span><span class="op" id="5103221">.</span><span class="ident" id="5103222">writeHeader</span><span class="op" id="5103233">(</span><span class="ident" id="5103234">nil</span><span class="op" id="5103237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5103240">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5103243">if</span>&nbsp;<span class="ident" id="5103246">cw</span><span class="op" id="5103248">.</span><span class="ident" id="5103249">chunking</span>&nbsp;<span class="op" id="5103258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5103262">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5103318">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5103372">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103383">cw</span><span class="op" id="5103385">.</span><span class="ident" id="5103386">res</span><span class="op" id="5103389">.</span><span class="ident" id="5103390">conn</span><span class="op" id="5103394">.</span><span class="ident" id="5103395">buf</span><span class="op" id="5103398">.</span><span class="ident" id="5103399">WriteString</span><span class="op" id="5103410">(</span><span class="string" id="5103411">&#34;0\r\n\r\n&#34;</span><span class="op" id="5103422">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5103425">}</span><br>
<span class="lineno"></span><span class="op" id="5103427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5103430">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="5103492">type</span>&nbsp;<span class="ident" id="5103497">response</span>&nbsp;<span class="keyword" id="5103506">struct</span>&nbsp;<span class="op" id="5103513">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103516">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5103530">*</span><span class="ident" id="5103531">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103537">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5103551">*</span><span class="ident" id="5103552">Request</span>&nbsp;<span class="comment" id="5103560">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103590">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5103604">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5103613">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103659">wroteContinue</span>&nbsp;<span class="builtintype" id="5103673">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5103682">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103721">w</span>&nbsp;&nbsp;<span class="op" id="5103724">*</span><span class="ident" id="5103725">bufio</span><span class="op" id="5103730">.</span><span class="ident" id="5103731">Writer</span>&nbsp;<span class="comment" id="5103738">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103782">cw</span>&nbsp;<span class="ident" id="5103785">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5103798">sw</span>&nbsp;<span class="op" id="5103801">*</span><span class="ident" id="5103802">switchWriter</span>&nbsp;<span class="comment" id="5103815">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5103870">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5103931">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5103993">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104051">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104095">handlerHeader</span>&nbsp;<span class="ident" id="5104109">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104117">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="5104131">bool</span>&nbsp;<span class="comment" id="5104136">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104183">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5104197">int64</span>&nbsp;<span class="comment" id="5104203">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104239">contentLength</span>&nbsp;<span class="ident" id="5104253">int64</span>&nbsp;<span class="comment" id="5104259">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104305">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5104319">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5104325">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104364">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104423">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104476">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104527">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104547">closeAfterReply</span>&nbsp;<span class="builtintype" id="5104563">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104570">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104625">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104680">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104731">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104793">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104849">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5104909">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104928">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="5104948">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5104955">handlerDone</span>&nbsp;<span class="builtintype" id="5104967">bool</span>&nbsp;<span class="comment" id="5104972">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5105009">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105049">dateBuf</span>&nbsp;<span class="op" id="5105057">[</span><span class="builtinfunc" id="5105058">len</span><span class="op" id="5105061">(</span><span class="ident" id="5105062">TimeFormat</span><span class="op" id="5105072">)</span><span class="op" id="5105073">]</span><span class="builtintype" id="5105074">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105080">clenBuf</span>&nbsp;<span class="op" id="5105088">[</span><span class="num" id="5105089">10</span><span class="op" id="5105091">]</span><span class="builtintype" id="5105092">byte</span><br>
<span class="lineno">340</span><span class="op" id="5105097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5105100">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5105171">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="5105201">func</span>&nbsp;<span class="op" id="5105206">(</span><span class="ident" id="5105207">w</span>&nbsp;<span class="op" id="5105209">*</span><span class="ident" id="5105210">response</span><span class="op" id="5105218">)</span>&nbsp;<span class="ident" id="5105220">requestTooLarge</span><span class="op" id="5105235">(</span><span class="op" id="5105236">)</span>&nbsp;<span class="op" id="5105238">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105241">w</span><span class="op" id="5105242">.</span><span class="ident" id="5105243">closeAfterReply</span>&nbsp;<span class="op" id="5105259">=</span>&nbsp;<span class="builtintype" id="5105261">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105267">w</span><span class="op" id="5105268">.</span><span class="ident" id="5105269">requestBodyLimitHit</span>&nbsp;<span class="op" id="5105289">=</span>&nbsp;<span class="builtintype" id="5105291">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105297">if</span>&nbsp;<span class="op" id="5105300">!</span><span class="ident" id="5105301">w</span><span class="op" id="5105302">.</span><span class="ident" id="5105303">wroteHeader</span>&nbsp;<span class="op" id="5105315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105319">w</span><span class="op" id="5105320">.</span><span class="ident" id="5105321">Header</span><span class="op" id="5105327">(</span><span class="op" id="5105328">)</span><span class="op" id="5105329">.</span><span class="ident" id="5105330">Set</span><span class="op" id="5105333">(</span><span class="string" id="5105334">&#34;Connection&#34;</span><span class="op" id="5105346">,</span>&nbsp;<span class="string" id="5105348">&#34;close&#34;</span><span class="op" id="5105355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5105358">}</span><br>
<span class="lineno">350</span><span class="op" id="5105360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5105363">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="5105435">func</span>&nbsp;<span class="op" id="5105440">(</span><span class="ident" id="5105441">w</span>&nbsp;<span class="op" id="5105443">*</span><span class="ident" id="5105444">response</span><span class="op" id="5105452">)</span>&nbsp;<span class="ident" id="5105454">needsSniff</span><span class="op" id="5105464">(</span><span class="op" id="5105465">)</span>&nbsp;<span class="builtintype" id="5105467">bool</span>&nbsp;<span class="op" id="5105472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105475">_</span><span class="op" id="5105476">,</span>&nbsp;<span class="ident" id="5105478">haveType</span>&nbsp;<span class="op" id="5105487">:=</span>&nbsp;<span class="ident" id="5105490">w</span><span class="op" id="5105491">.</span><span class="ident" id="5105492">handlerHeader</span><span class="op" id="5105505">[</span><span class="string" id="5105506">&#34;Content-Type&#34;</span><span class="op" id="5105520">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105523">return</span>&nbsp;<span class="op" id="5105530">!</span><span class="ident" id="5105531">w</span><span class="op" id="5105532">.</span><span class="ident" id="5105533">cw</span><span class="op" id="5105535">.</span><span class="ident" id="5105536">wroteHeader</span>&nbsp;<span class="op" id="5105548">&amp;&amp;</span>&nbsp;<span class="op" id="5105551">!</span><span class="ident" id="5105552">haveType</span>&nbsp;<span class="op" id="5105561">&amp;&amp;</span>&nbsp;<span class="ident" id="5105564">w</span><span class="op" id="5105565">.</span><span class="ident" id="5105566">written</span>&nbsp;<span class="op" id="5105574">&lt;</span>&nbsp;<span class="ident" id="5105576">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="5105585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5105588">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="5105654">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="5105671">type</span>&nbsp;<span class="ident" id="5105676">writerOnly</span>&nbsp;<span class="keyword" id="5105687">struct</span>&nbsp;<span class="op" id="5105694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105697">io</span><span class="op" id="5105699">.</span><span class="ident" id="5105700">Writer</span><br>
<span class="lineno"></span><span class="op" id="5105707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5105710">func</span>&nbsp;<span class="ident" id="5105715">srcIsRegularFile</span><span class="op" id="5105731">(</span><span class="ident" id="5105732">src</span>&nbsp;<span class="ident" id="5105736">io</span><span class="op" id="5105738">.</span><span class="ident" id="5105739">Reader</span><span class="op" id="5105745">)</span>&nbsp;<span class="op" id="5105747">(</span><span class="ident" id="5105748">isRegular</span>&nbsp;<span class="builtintype" id="5105758">bool</span><span class="op" id="5105762">,</span>&nbsp;<span class="ident" id="5105764">err</span>&nbsp;<span class="builtintype" id="5105768">error</span><span class="op" id="5105773">)</span>&nbsp;<span class="op" id="5105775">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105778">switch</span>&nbsp;<span class="ident" id="5105785">v</span>&nbsp;<span class="op" id="5105787">:=</span>&nbsp;<span class="ident" id="5105790">src</span><span class="op" id="5105793">.</span><span class="op" id="5105794">(</span><span class="keyword" id="5105795">type</span><span class="op" id="5105799">)</span>&nbsp;<span class="op" id="5105801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105804">case</span>&nbsp;<span class="op" id="5105809">*</span><span class="ident" id="5105810">os</span><span class="op" id="5105812">.</span><span class="ident" id="5105813">File</span><span class="op" id="5105817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5105821">fi</span><span class="op" id="5105823">,</span>&nbsp;<span class="ident" id="5105825">err</span>&nbsp;<span class="op" id="5105829">:=</span>&nbsp;<span class="ident" id="5105832">v</span><span class="op" id="5105833">.</span><span class="ident" id="5105834">Stat</span><span class="op" id="5105838">(</span><span class="op" id="5105839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105843">if</span>&nbsp;<span class="ident" id="5105846">err</span>&nbsp;<span class="op" id="5105850">!=</span>&nbsp;<span class="ident" id="5105853">nil</span>&nbsp;<span class="op" id="5105857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105862">return</span>&nbsp;<span class="builtintype" id="5105869">false</span><span class="op" id="5105874">,</span>&nbsp;<span class="ident" id="5105876">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5105882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105886">return</span>&nbsp;<span class="ident" id="5105893">fi</span><span class="op" id="5105895">.</span><span class="ident" id="5105896">Mode</span><span class="op" id="5105900">(</span><span class="op" id="5105901">)</span><span class="op" id="5105902">.</span><span class="ident" id="5105903">IsRegular</span><span class="op" id="5105912">(</span><span class="op" id="5105913">)</span><span class="op" id="5105914">,</span>&nbsp;<span class="ident" id="5105916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105921">case</span>&nbsp;<span class="op" id="5105926">*</span><span class="ident" id="5105927">io</span><span class="op" id="5105929">.</span><span class="ident" id="5105930">LimitedReader</span><span class="op" id="5105943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105947">return</span>&nbsp;<span class="ident" id="5105954">srcIsRegularFile</span><span class="op" id="5105970">(</span><span class="ident" id="5105971">v</span><span class="op" id="5105972">.</span><span class="ident" id="5105973">R</span><span class="op" id="5105974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105977">default</span><span class="op" id="5105984">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5105988">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5105996">}</span><br>
<span class="lineno"></span><span class="op" id="5105998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5106001">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="5106071">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="5106107">func</span>&nbsp;<span class="op" id="5106112">(</span><span class="ident" id="5106113">w</span>&nbsp;<span class="op" id="5106115">*</span><span class="ident" id="5106116">response</span><span class="op" id="5106124">)</span>&nbsp;<span class="ident" id="5106126">ReadFrom</span><span class="op" id="5106134">(</span><span class="ident" id="5106135">src</span>&nbsp;<span class="ident" id="5106139">io</span><span class="op" id="5106141">.</span><span class="ident" id="5106142">Reader</span><span class="op" id="5106148">)</span>&nbsp;<span class="op" id="5106150">(</span><span class="ident" id="5106151">n</span>&nbsp;<span class="ident" id="5106153">int64</span><span class="op" id="5106158">,</span>&nbsp;<span class="ident" id="5106160">err</span>&nbsp;<span class="builtintype" id="5106164">error</span><span class="op" id="5106169">)</span>&nbsp;<span class="op" id="5106171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5106174">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5106236">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5106300">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106352">rf</span><span class="op" id="5106354">,</span>&nbsp;<span class="ident" id="5106356">ok</span>&nbsp;<span class="op" id="5106359">:=</span>&nbsp;<span class="ident" id="5106362">w</span><span class="op" id="5106363">.</span><span class="ident" id="5106364">conn</span><span class="op" id="5106368">.</span><span class="ident" id="5106369">rwc</span><span class="op" id="5106372">.</span><span class="op" id="5106373">(</span><span class="ident" id="5106374">io</span><span class="op" id="5106376">.</span><span class="ident" id="5106377">ReaderFrom</span><span class="op" id="5106387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106390">regFile</span><span class="op" id="5106397">,</span>&nbsp;<span class="ident" id="5106399">err</span>&nbsp;<span class="op" id="5106403">:=</span>&nbsp;<span class="ident" id="5106406">srcIsRegularFile</span><span class="op" id="5106422">(</span><span class="ident" id="5106423">src</span><span class="op" id="5106426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106429">if</span>&nbsp;<span class="ident" id="5106432">err</span>&nbsp;<span class="op" id="5106436">!=</span>&nbsp;<span class="ident" id="5106439">nil</span>&nbsp;<span class="op" id="5106443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106447">return</span>&nbsp;<span class="num" id="5106454">0</span><span class="op" id="5106455">,</span>&nbsp;<span class="ident" id="5106457">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5106462">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106465">if</span>&nbsp;<span class="op" id="5106468">!</span><span class="ident" id="5106469">ok</span>&nbsp;<span class="op" id="5106472">||</span>&nbsp;<span class="op" id="5106475">!</span><span class="ident" id="5106476">regFile</span>&nbsp;<span class="op" id="5106484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106488">return</span>&nbsp;<span class="ident" id="5106495">io</span><span class="op" id="5106497">.</span><span class="ident" id="5106498">Copy</span><span class="op" id="5106502">(</span><span class="ident" id="5106503">writerOnly</span><span class="op" id="5106513">{</span><span class="ident" id="5106514">w</span><span class="op" id="5106515">}</span><span class="op" id="5106516">,</span>&nbsp;<span class="ident" id="5106518">src</span><span class="op" id="5106521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5106524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5106528">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106548">if</span>&nbsp;<span class="op" id="5106551">!</span><span class="ident" id="5106552">w</span><span class="op" id="5106553">.</span><span class="ident" id="5106554">wroteHeader</span>&nbsp;<span class="op" id="5106566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106570">w</span><span class="op" id="5106571">.</span><span class="ident" id="5106572">WriteHeader</span><span class="op" id="5106583">(</span><span class="ident" id="5106584">StatusOK</span><span class="op" id="5106592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5106595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106599">if</span>&nbsp;<span class="ident" id="5106602">w</span><span class="op" id="5106603">.</span><span class="ident" id="5106604">needsSniff</span><span class="op" id="5106614">(</span><span class="op" id="5106615">)</span>&nbsp;<span class="op" id="5106617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106621">n0</span><span class="op" id="5106623">,</span>&nbsp;<span class="ident" id="5106625">err</span>&nbsp;<span class="op" id="5106629">:=</span>&nbsp;<span class="ident" id="5106632">io</span><span class="op" id="5106634">.</span><span class="ident" id="5106635">Copy</span><span class="op" id="5106639">(</span><span class="ident" id="5106640">writerOnly</span><span class="op" id="5106650">{</span><span class="ident" id="5106651">w</span><span class="op" id="5106652">}</span><span class="op" id="5106653">,</span>&nbsp;<span class="ident" id="5106655">io</span><span class="op" id="5106657">.</span><span class="ident" id="5106658">LimitReader</span><span class="op" id="5106669">(</span><span class="ident" id="5106670">src</span><span class="op" id="5106673">,</span>&nbsp;<span class="ident" id="5106675">sniffLen</span><span class="op" id="5106683">)</span><span class="op" id="5106684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106688">n</span>&nbsp;<span class="op" id="5106690">+=</span>&nbsp;<span class="ident" id="5106693">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106698">if</span>&nbsp;<span class="ident" id="5106701">err</span>&nbsp;<span class="op" id="5106705">!=</span>&nbsp;<span class="ident" id="5106708">nil</span>&nbsp;<span class="op" id="5106712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106717">return</span>&nbsp;<span class="ident" id="5106724">n</span><span class="op" id="5106725">,</span>&nbsp;<span class="ident" id="5106727">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5106733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5106736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106740">w</span><span class="op" id="5106741">.</span><span class="ident" id="5106742">w</span><span class="op" id="5106743">.</span><span class="ident" id="5106744">Flush</span><span class="op" id="5106749">(</span><span class="op" id="5106750">)</span>&nbsp;&nbsp;<span class="comment" id="5106753">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106788">w</span><span class="op" id="5106789">.</span><span class="ident" id="5106790">cw</span><span class="op" id="5106792">.</span><span class="ident" id="5106793">flush</span><span class="op" id="5106798">(</span><span class="op" id="5106799">)</span>&nbsp;<span class="comment" id="5106801">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5106853">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5106933">if</span>&nbsp;<span class="op" id="5106936">!</span><span class="ident" id="5106937">w</span><span class="op" id="5106938">.</span><span class="ident" id="5106939">cw</span><span class="op" id="5106941">.</span><span class="ident" id="5106942">chunking</span>&nbsp;<span class="op" id="5106951">&amp;&amp;</span>&nbsp;<span class="ident" id="5106954">w</span><span class="op" id="5106955">.</span><span class="ident" id="5106956">bodyAllowed</span><span class="op" id="5106967">(</span><span class="op" id="5106968">)</span>&nbsp;<span class="op" id="5106970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5106974">n0</span><span class="op" id="5106976">,</span>&nbsp;<span class="ident" id="5106978">err</span>&nbsp;<span class="op" id="5106982">:=</span>&nbsp;<span class="ident" id="5106985">rf</span><span class="op" id="5106987">.</span><span class="ident" id="5106988">ReadFrom</span><span class="op" id="5106996">(</span><span class="ident" id="5106997">src</span><span class="op" id="5107000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107004">n</span>&nbsp;<span class="op" id="5107006">+=</span>&nbsp;<span class="ident" id="5107009">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107014">w</span><span class="op" id="5107015">.</span><span class="ident" id="5107016">written</span>&nbsp;<span class="op" id="5107024">+=</span>&nbsp;<span class="ident" id="5107027">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5107032">return</span>&nbsp;<span class="ident" id="5107039">n</span><span class="op" id="5107040">,</span>&nbsp;<span class="ident" id="5107042">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5107047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107051">n0</span><span class="op" id="5107053">,</span>&nbsp;<span class="ident" id="5107055">err</span>&nbsp;<span class="op" id="5107059">:=</span>&nbsp;<span class="ident" id="5107062">io</span><span class="op" id="5107064">.</span><span class="ident" id="5107065">Copy</span><span class="op" id="5107069">(</span><span class="ident" id="5107070">writerOnly</span><span class="op" id="5107080">{</span><span class="ident" id="5107081">w</span><span class="op" id="5107082">}</span><span class="op" id="5107083">,</span>&nbsp;<span class="ident" id="5107085">src</span><span class="op" id="5107088">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107091">n</span>&nbsp;<span class="op" id="5107093">+=</span>&nbsp;<span class="ident" id="5107096">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5107100">return</span>&nbsp;<span class="ident" id="5107107">n</span><span class="op" id="5107108">,</span>&nbsp;<span class="ident" id="5107110">err</span><br>
<span class="lineno"></span><span class="op" id="5107114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5107117">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="5107186">const</span>&nbsp;<span class="ident" id="5107192">noLimit</span>&nbsp;<span class="ident" id="5107200">int64</span>&nbsp;<span class="op" id="5107206">=</span>&nbsp;<span class="op" id="5107208">(</span><span class="num" id="5107209">1</span>&nbsp;<span class="op" id="5107211">&lt;&lt;</span>&nbsp;<span class="num" id="5107214">63</span><span class="op" id="5107216">)</span>&nbsp;<span class="op" id="5107218">-</span>&nbsp;<span class="num" id="5107220">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5107223">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="5107301">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="5107336">const</span>&nbsp;<span class="ident" id="5107342">debugServerConnections</span>&nbsp;<span class="op" id="5107365">=</span>&nbsp;<span class="builtintype" id="5107367">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="5107374">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="5107409">func</span>&nbsp;<span class="op" id="5107414">(</span><span class="ident" id="5107415">srv</span>&nbsp;<span class="op" id="5107419">*</span><span class="ident" id="5107420">Server</span><span class="op" id="5107426">)</span>&nbsp;<span class="ident" id="5107428">newConn</span><span class="op" id="5107435">(</span><span class="ident" id="5107436">rwc</span>&nbsp;<span class="ident" id="5107440">net</span><span class="op" id="5107443">.</span><span class="ident" id="5107444">Conn</span><span class="op" id="5107448">)</span>&nbsp;<span class="op" id="5107450">(</span><span class="ident" id="5107451">c</span>&nbsp;<span class="op" id="5107453">*</span><span class="ident" id="5107454">conn</span><span class="op" id="5107458">,</span>&nbsp;<span class="ident" id="5107460">err</span>&nbsp;<span class="builtintype" id="5107464">error</span><span class="op" id="5107469">)</span>&nbsp;<span class="op" id="5107471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107474">c</span>&nbsp;<span class="op" id="5107476">=</span>&nbsp;<span class="builtinfunc" id="5107478">new</span><span class="op" id="5107481">(</span><span class="ident" id="5107482">conn</span><span class="op" id="5107486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107489">c</span><span class="op" id="5107490">.</span><span class="ident" id="5107491">remoteAddr</span>&nbsp;<span class="op" id="5107502">=</span>&nbsp;<span class="ident" id="5107504">rwc</span><span class="op" id="5107507">.</span><span class="ident" id="5107508">RemoteAddr</span><span class="op" id="5107518">(</span><span class="op" id="5107519">)</span><span class="op" id="5107520">.</span><span class="ident" id="5107521">String</span><span class="op" id="5107527">(</span><span class="op" id="5107528">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107531">c</span><span class="op" id="5107532">.</span><span class="ident" id="5107533">server</span>&nbsp;<span class="op" id="5107540">=</span>&nbsp;<span class="ident" id="5107542">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107547">c</span><span class="op" id="5107548">.</span><span class="ident" id="5107549">rwc</span>&nbsp;<span class="op" id="5107553">=</span>&nbsp;<span class="ident" id="5107555">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107560">c</span><span class="op" id="5107561">.</span><span class="ident" id="5107562">w</span>&nbsp;<span class="op" id="5107564">=</span>&nbsp;<span class="ident" id="5107566">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5107571">if</span>&nbsp;<span class="ident" id="5107574">debugServerConnections</span>&nbsp;<span class="op" id="5107597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107601">c</span><span class="op" id="5107602">.</span><span class="ident" id="5107603">rwc</span>&nbsp;<span class="op" id="5107607">=</span>&nbsp;<span class="ident" id="5107609">newLoggingConn</span><span class="op" id="5107623">(</span><span class="string" id="5107624">&#34;server&#34;</span><span class="op" id="5107632">,</span>&nbsp;<span class="ident" id="5107634">c</span><span class="op" id="5107635">.</span><span class="ident" id="5107636">rwc</span><span class="op" id="5107639">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5107642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107645">c</span><span class="op" id="5107646">.</span><span class="ident" id="5107647">sr</span>&nbsp;<span class="op" id="5107650">=</span>&nbsp;<span class="ident" id="5107652">liveSwitchReader</span><span class="op" id="5107668">{</span><span class="ident" id="5107669">r</span><span class="op" id="5107670">:</span>&nbsp;<span class="ident" id="5107672">c</span><span class="op" id="5107673">.</span><span class="ident" id="5107674">rwc</span><span class="op" id="5107677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107680">c</span><span class="op" id="5107681">.</span><span class="ident" id="5107682">lr</span>&nbsp;<span class="op" id="5107685">=</span>&nbsp;<span class="ident" id="5107687">io</span><span class="op" id="5107689">.</span><span class="ident" id="5107690">LimitReader</span><span class="op" id="5107701">(</span><span class="op" id="5107702">&amp;</span><span class="ident" id="5107703">c</span><span class="op" id="5107704">.</span><span class="ident" id="5107705">sr</span><span class="op" id="5107707">,</span>&nbsp;<span class="ident" id="5107709">noLimit</span><span class="op" id="5107716">)</span><span class="op" id="5107717">.</span><span class="op" id="5107718">(</span><span class="op" id="5107719">*</span><span class="ident" id="5107720">io</span><span class="op" id="5107722">.</span><span class="ident" id="5107723">LimitedReader</span><span class="op" id="5107736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107739">br</span>&nbsp;<span class="op" id="5107742">:=</span>&nbsp;<span class="ident" id="5107745">newBufioReader</span><span class="op" id="5107759">(</span><span class="ident" id="5107760">c</span><span class="op" id="5107761">.</span><span class="ident" id="5107762">lr</span><span class="op" id="5107764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107767">bw</span>&nbsp;<span class="op" id="5107770">:=</span>&nbsp;<span class="ident" id="5107773">newBufioWriterSize</span><span class="op" id="5107791">(</span><span class="ident" id="5107792">checkConnErrorWriter</span><span class="op" id="5107812">{</span><span class="ident" id="5107813">c</span><span class="op" id="5107814">}</span><span class="op" id="5107815">,</span>&nbsp;<span class="num" id="5107817">4</span><span class="op" id="5107818">&lt;&lt;</span><span class="num" id="5107820">10</span><span class="op" id="5107822">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107825">c</span><span class="op" id="5107826">.</span><span class="ident" id="5107827">buf</span>&nbsp;<span class="op" id="5107831">=</span>&nbsp;<span class="ident" id="5107833">bufio</span><span class="op" id="5107838">.</span><span class="ident" id="5107839">NewReadWriter</span><span class="op" id="5107852">(</span><span class="ident" id="5107853">br</span><span class="op" id="5107855">,</span>&nbsp;<span class="ident" id="5107857">bw</span><span class="op" id="5107859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5107862">return</span>&nbsp;<span class="ident" id="5107869">c</span><span class="op" id="5107870">,</span>&nbsp;<span class="ident" id="5107872">nil</span><br>
<span class="lineno"></span><span class="op" id="5107876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5107879">var</span>&nbsp;<span class="op" id="5107883">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107886">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5107904">sync</span><span class="op" id="5107908">.</span><span class="ident" id="5107909">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107915">bufioWriter2kPool</span>&nbsp;<span class="ident" id="5107933">sync</span><span class="op" id="5107937">.</span><span class="ident" id="5107938">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5107944">bufioWriter4kPool</span>&nbsp;<span class="ident" id="5107962">sync</span><span class="op" id="5107966">.</span><span class="ident" id="5107967">Pool</span><br>
<span class="lineno"></span><span class="op" id="5107972">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="5107975">func</span>&nbsp;<span class="ident" id="5107980">bufioWriterPool</span><span class="op" id="5107995">(</span><span class="ident" id="5107996">size</span>&nbsp;<span class="builtintype" id="5108001">int</span><span class="op" id="5108004">)</span>&nbsp;<span class="op" id="5108006">*</span><span class="ident" id="5108007">sync</span><span class="op" id="5108011">.</span><span class="ident" id="5108012">Pool</span>&nbsp;<span class="op" id="5108017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108020">switch</span>&nbsp;<span class="ident" id="5108027">size</span>&nbsp;<span class="op" id="5108032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108035">case</span>&nbsp;<span class="num" id="5108040">2</span>&nbsp;<span class="op" id="5108042">&lt;&lt;</span>&nbsp;<span class="num" id="5108045">10</span><span class="op" id="5108047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108051">return</span>&nbsp;<span class="op" id="5108058">&amp;</span><span class="ident" id="5108059">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108078">case</span>&nbsp;<span class="num" id="5108083">4</span>&nbsp;<span class="op" id="5108085">&lt;&lt;</span>&nbsp;<span class="num" id="5108088">10</span><span class="op" id="5108090">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108094">return</span>&nbsp;<span class="op" id="5108101">&amp;</span><span class="ident" id="5108102">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5108121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108124">return</span>&nbsp;<span class="ident" id="5108131">nil</span><br>
<span class="lineno"></span><span class="op" id="5108135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="5108138">func</span>&nbsp;<span class="ident" id="5108143">newBufioReader</span><span class="op" id="5108157">(</span><span class="ident" id="5108158">r</span>&nbsp;<span class="ident" id="5108160">io</span><span class="op" id="5108162">.</span><span class="ident" id="5108163">Reader</span><span class="op" id="5108169">)</span>&nbsp;<span class="op" id="5108171">*</span><span class="ident" id="5108172">bufio</span><span class="op" id="5108177">.</span><span class="ident" id="5108178">Reader</span>&nbsp;<span class="op" id="5108185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108188">if</span>&nbsp;<span class="ident" id="5108191">v</span>&nbsp;<span class="op" id="5108193">:=</span>&nbsp;<span class="ident" id="5108196">bufioReaderPool</span><span class="op" id="5108211">.</span><span class="ident" id="5108212">Get</span><span class="op" id="5108215">(</span><span class="op" id="5108216">)</span><span class="op" id="5108217">;</span>&nbsp;<span class="ident" id="5108219">v</span>&nbsp;<span class="op" id="5108221">!=</span>&nbsp;<span class="ident" id="5108224">nil</span>&nbsp;<span class="op" id="5108228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108232">br</span>&nbsp;<span class="op" id="5108235">:=</span>&nbsp;<span class="ident" id="5108238">v</span><span class="op" id="5108239">.</span><span class="op" id="5108240">(</span><span class="op" id="5108241">*</span><span class="ident" id="5108242">bufio</span><span class="op" id="5108247">.</span><span class="ident" id="5108248">Reader</span><span class="op" id="5108254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108258">br</span><span class="op" id="5108260">.</span><span class="ident" id="5108261">Reset</span><span class="op" id="5108266">(</span><span class="ident" id="5108267">r</span><span class="op" id="5108268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108272">return</span>&nbsp;<span class="ident" id="5108279">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5108283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108286">return</span>&nbsp;<span class="ident" id="5108293">bufio</span><span class="op" id="5108298">.</span><span class="ident" id="5108299">NewReader</span><span class="op" id="5108308">(</span><span class="ident" id="5108309">r</span><span class="op" id="5108310">)</span><br>
<span class="lineno"></span><span class="op" id="5108312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5108315">func</span>&nbsp;<span class="ident" id="5108320">putBufioReader</span><span class="op" id="5108334">(</span><span class="ident" id="5108335">br</span>&nbsp;<span class="op" id="5108338">*</span><span class="ident" id="5108339">bufio</span><span class="op" id="5108344">.</span><span class="ident" id="5108345">Reader</span><span class="op" id="5108351">)</span>&nbsp;<span class="op" id="5108353">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108356">br</span><span class="op" id="5108358">.</span><span class="ident" id="5108359">Reset</span><span class="op" id="5108364">(</span><span class="ident" id="5108365">nil</span><span class="op" id="5108368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108371">bufioReaderPool</span><span class="op" id="5108386">.</span><span class="ident" id="5108387">Put</span><span class="op" id="5108390">(</span><span class="ident" id="5108391">br</span><span class="op" id="5108393">)</span><br>
<span class="lineno"></span><span class="op" id="5108395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5108398">func</span>&nbsp;<span class="ident" id="5108403">newBufioWriterSize</span><span class="op" id="5108421">(</span><span class="ident" id="5108422">w</span>&nbsp;<span class="ident" id="5108424">io</span><span class="op" id="5108426">.</span><span class="ident" id="5108427">Writer</span><span class="op" id="5108433">,</span>&nbsp;<span class="ident" id="5108435">size</span>&nbsp;<span class="builtintype" id="5108440">int</span><span class="op" id="5108443">)</span>&nbsp;<span class="op" id="5108445">*</span><span class="ident" id="5108446">bufio</span><span class="op" id="5108451">.</span><span class="ident" id="5108452">Writer</span>&nbsp;<span class="op" id="5108459">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108462">pool</span>&nbsp;<span class="op" id="5108467">:=</span>&nbsp;<span class="ident" id="5108470">bufioWriterPool</span><span class="op" id="5108485">(</span><span class="ident" id="5108486">size</span><span class="op" id="5108490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108493">if</span>&nbsp;<span class="ident" id="5108496">pool</span>&nbsp;<span class="op" id="5108501">!=</span>&nbsp;<span class="ident" id="5108504">nil</span>&nbsp;<span class="op" id="5108508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108512">if</span>&nbsp;<span class="ident" id="5108515">v</span>&nbsp;<span class="op" id="5108517">:=</span>&nbsp;<span class="ident" id="5108520">pool</span><span class="op" id="5108524">.</span><span class="ident" id="5108525">Get</span><span class="op" id="5108528">(</span><span class="op" id="5108529">)</span><span class="op" id="5108530">;</span>&nbsp;<span class="ident" id="5108532">v</span>&nbsp;<span class="op" id="5108534">!=</span>&nbsp;<span class="ident" id="5108537">nil</span>&nbsp;<span class="op" id="5108541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108546">bw</span>&nbsp;<span class="op" id="5108549">:=</span>&nbsp;<span class="ident" id="5108552">v</span><span class="op" id="5108553">.</span><span class="op" id="5108554">(</span><span class="op" id="5108555">*</span><span class="ident" id="5108556">bufio</span><span class="op" id="5108561">.</span><span class="ident" id="5108562">Writer</span><span class="op" id="5108568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108573">bw</span><span class="op" id="5108575">.</span><span class="ident" id="5108576">Reset</span><span class="op" id="5108581">(</span><span class="ident" id="5108582">w</span><span class="op" id="5108583">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108588">return</span>&nbsp;<span class="ident" id="5108595">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5108600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5108603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108606">return</span>&nbsp;<span class="ident" id="5108613">bufio</span><span class="op" id="5108618">.</span><span class="ident" id="5108619">NewWriterSize</span><span class="op" id="5108632">(</span><span class="ident" id="5108633">w</span><span class="op" id="5108634">,</span>&nbsp;<span class="ident" id="5108636">size</span><span class="op" id="5108640">)</span><br>
<span class="lineno"></span><span class="op" id="5108642">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="5108645">func</span>&nbsp;<span class="ident" id="5108650">putBufioWriter</span><span class="op" id="5108664">(</span><span class="ident" id="5108665">bw</span>&nbsp;<span class="op" id="5108668">*</span><span class="ident" id="5108669">bufio</span><span class="op" id="5108674">.</span><span class="ident" id="5108675">Writer</span><span class="op" id="5108681">)</span>&nbsp;<span class="op" id="5108683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108686">bw</span><span class="op" id="5108688">.</span><span class="ident" id="5108689">Reset</span><span class="op" id="5108694">(</span><span class="ident" id="5108695">nil</span><span class="op" id="5108698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5108701">if</span>&nbsp;<span class="ident" id="5108704">pool</span>&nbsp;<span class="op" id="5108709">:=</span>&nbsp;<span class="ident" id="5108712">bufioWriterPool</span><span class="op" id="5108727">(</span><span class="ident" id="5108728">bw</span><span class="op" id="5108730">.</span><span class="ident" id="5108731">Available</span><span class="op" id="5108740">(</span><span class="op" id="5108741">)</span><span class="op" id="5108742">)</span><span class="op" id="5108743">;</span>&nbsp;<span class="ident" id="5108745">pool</span>&nbsp;<span class="op" id="5108750">!=</span>&nbsp;<span class="ident" id="5108753">nil</span>&nbsp;<span class="op" id="5108757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5108761">pool</span><span class="op" id="5108765">.</span><span class="ident" id="5108766">Put</span><span class="op" id="5108769">(</span><span class="ident" id="5108770">bw</span><span class="op" id="5108772">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5108775">}</span><br>
<span class="lineno"></span><span class="op" id="5108777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5108780">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="5108850">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="5108873">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5108933">const</span>&nbsp;<span class="ident" id="5108939">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="5108961">=</span>&nbsp;<span class="num" id="5108963">1</span>&nbsp;<span class="op" id="5108965">&lt;&lt;</span>&nbsp;<span class="num" id="5108968">20</span>&nbsp;<span class="comment" id="5108971">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5108980">func</span>&nbsp;<span class="op" id="5108985">(</span><span class="ident" id="5108986">srv</span>&nbsp;<span class="op" id="5108990">*</span><span class="ident" id="5108991">Server</span><span class="op" id="5108997">)</span>&nbsp;<span class="ident" id="5108999">maxHeaderBytes</span><span class="op" id="5109013">(</span><span class="op" id="5109014">)</span>&nbsp;<span class="builtintype" id="5109016">int</span>&nbsp;<span class="op" id="5109020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109023">if</span>&nbsp;<span class="ident" id="5109026">srv</span><span class="op" id="5109029">.</span><span class="ident" id="5109030">MaxHeaderBytes</span>&nbsp;<span class="op" id="5109045">&gt;</span>&nbsp;<span class="num" id="5109047">0</span>&nbsp;<span class="op" id="5109049">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109053">return</span>&nbsp;<span class="ident" id="5109060">srv</span><span class="op" id="5109063">.</span><span class="ident" id="5109064">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109083">return</span>&nbsp;<span class="ident" id="5109090">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="5109112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="5109115">func</span>&nbsp;<span class="op" id="5109120">(</span><span class="ident" id="5109121">srv</span>&nbsp;<span class="op" id="5109125">*</span><span class="ident" id="5109126">Server</span><span class="op" id="5109132">)</span>&nbsp;<span class="ident" id="5109134">initialLimitedReaderSize</span><span class="op" id="5109158">(</span><span class="op" id="5109159">)</span>&nbsp;<span class="ident" id="5109161">int64</span>&nbsp;<span class="op" id="5109167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109170">return</span>&nbsp;<span class="ident" id="5109177">int64</span><span class="op" id="5109182">(</span><span class="ident" id="5109183">srv</span><span class="op" id="5109186">.</span><span class="ident" id="5109187">maxHeaderBytes</span><span class="op" id="5109201">(</span><span class="op" id="5109202">)</span><span class="op" id="5109203">)</span>&nbsp;<span class="op" id="5109205">+</span>&nbsp;<span class="num" id="5109207">4096</span>&nbsp;<span class="comment" id="5109212">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="5109226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5109229">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="5109293">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="5109325">type</span>&nbsp;<span class="ident" id="5109330">expectContinueReader</span>&nbsp;<span class="keyword" id="5109351">struct</span>&nbsp;<span class="op" id="5109358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109361">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5109372">*</span><span class="ident" id="5109373">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109383">readCloser</span>&nbsp;<span class="ident" id="5109394">io</span><span class="op" id="5109396">.</span><span class="ident" id="5109397">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109409">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5109420">bool</span><br>
<span class="lineno">520</span><span class="op" id="5109425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5109428">func</span>&nbsp;<span class="op" id="5109433">(</span><span class="ident" id="5109434">ecr</span>&nbsp;<span class="op" id="5109438">*</span><span class="ident" id="5109439">expectContinueReader</span><span class="op" id="5109459">)</span>&nbsp;<span class="ident" id="5109461">Read</span><span class="op" id="5109465">(</span><span class="ident" id="5109466">p</span>&nbsp;<span class="op" id="5109468">[</span><span class="op" id="5109469">]</span><span class="builtintype" id="5109470">byte</span><span class="op" id="5109474">)</span>&nbsp;<span class="op" id="5109476">(</span><span class="ident" id="5109477">n</span>&nbsp;<span class="builtintype" id="5109479">int</span><span class="op" id="5109482">,</span>&nbsp;<span class="ident" id="5109484">err</span>&nbsp;<span class="builtintype" id="5109488">error</span><span class="op" id="5109493">)</span>&nbsp;<span class="op" id="5109495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109498">if</span>&nbsp;<span class="ident" id="5109501">ecr</span><span class="op" id="5109504">.</span><span class="ident" id="5109505">closed</span>&nbsp;<span class="op" id="5109512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109516">return</span>&nbsp;<span class="num" id="5109523">0</span><span class="op" id="5109524">,</span>&nbsp;<span class="ident" id="5109526">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109552">if</span>&nbsp;<span class="op" id="5109555">!</span><span class="ident" id="5109556">ecr</span><span class="op" id="5109559">.</span><span class="ident" id="5109560">resp</span><span class="op" id="5109564">.</span><span class="ident" id="5109565">wroteContinue</span>&nbsp;<span class="op" id="5109579">&amp;&amp;</span>&nbsp;<span class="op" id="5109582">!</span><span class="ident" id="5109583">ecr</span><span class="op" id="5109586">.</span><span class="ident" id="5109587">resp</span><span class="op" id="5109591">.</span><span class="ident" id="5109592">conn</span><span class="op" id="5109596">.</span><span class="ident" id="5109597">hijacked</span><span class="op" id="5109605">(</span><span class="op" id="5109606">)</span>&nbsp;<span class="op" id="5109608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109612">ecr</span><span class="op" id="5109615">.</span><span class="ident" id="5109616">resp</span><span class="op" id="5109620">.</span><span class="ident" id="5109621">wroteContinue</span>&nbsp;<span class="op" id="5109635">=</span>&nbsp;<span class="builtintype" id="5109637">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109644">ecr</span><span class="op" id="5109647">.</span><span class="ident" id="5109648">resp</span><span class="op" id="5109652">.</span><span class="ident" id="5109653">conn</span><span class="op" id="5109657">.</span><span class="ident" id="5109658">buf</span><span class="op" id="5109661">.</span><span class="ident" id="5109662">WriteString</span><span class="op" id="5109673">(</span><span class="string" id="5109674">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="5109705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109709">ecr</span><span class="op" id="5109712">.</span><span class="ident" id="5109713">resp</span><span class="op" id="5109717">.</span><span class="ident" id="5109718">conn</span><span class="op" id="5109722">.</span><span class="ident" id="5109723">buf</span><span class="op" id="5109726">.</span><span class="ident" id="5109727">Flush</span><span class="op" id="5109732">(</span><span class="op" id="5109733">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5109736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109739">return</span>&nbsp;<span class="ident" id="5109746">ecr</span><span class="op" id="5109749">.</span><span class="ident" id="5109750">readCloser</span><span class="op" id="5109760">.</span><span class="ident" id="5109761">Read</span><span class="op" id="5109765">(</span><span class="ident" id="5109766">p</span><span class="op" id="5109767">)</span><br>
<span class="lineno"></span><span class="op" id="5109769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5109772">func</span>&nbsp;<span class="op" id="5109777">(</span><span class="ident" id="5109778">ecr</span>&nbsp;<span class="op" id="5109782">*</span><span class="ident" id="5109783">expectContinueReader</span><span class="op" id="5109803">)</span>&nbsp;<span class="ident" id="5109805">Close</span><span class="op" id="5109810">(</span><span class="op" id="5109811">)</span>&nbsp;<span class="builtintype" id="5109813">error</span>&nbsp;<span class="op" id="5109819">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5109822">ecr</span><span class="op" id="5109825">.</span><span class="ident" id="5109826">closed</span>&nbsp;<span class="op" id="5109833">=</span>&nbsp;<span class="builtintype" id="5109835">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5109841">return</span>&nbsp;<span class="ident" id="5109848">ecr</span><span class="op" id="5109851">.</span><span class="ident" id="5109852">readCloser</span><span class="op" id="5109862">.</span><span class="ident" id="5109863">Close</span><span class="op" id="5109868">(</span><span class="op" id="5109869">)</span><br>
<span class="lineno"></span><span class="op" id="5109871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5109874">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="5109919">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="5109967">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="5110007">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="5110071">const</span>&nbsp;<span class="ident" id="5110077">TimeFormat</span>&nbsp;<span class="op" id="5110088">=</span>&nbsp;<span class="string" id="5110090">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="5110123">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="5110203">func</span>&nbsp;<span class="ident" id="5110208">appendTime</span><span class="op" id="5110218">(</span><span class="ident" id="5110219">b</span>&nbsp;<span class="op" id="5110221">[</span><span class="op" id="5110222">]</span><span class="builtintype" id="5110223">byte</span><span class="op" id="5110227">,</span>&nbsp;<span class="ident" id="5110229">t</span>&nbsp;<span class="ident" id="5110231">time</span><span class="op" id="5110235">.</span><span class="ident" id="5110236">Time</span><span class="op" id="5110240">)</span>&nbsp;<span class="op" id="5110242">[</span><span class="op" id="5110243">]</span><span class="builtintype" id="5110244">byte</span>&nbsp;<span class="op" id="5110249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110252">const</span>&nbsp;<span class="ident" id="5110258">days</span>&nbsp;<span class="op" id="5110263">=</span>&nbsp;<span class="string" id="5110265">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110290">const</span>&nbsp;<span class="ident" id="5110296">months</span>&nbsp;<span class="op" id="5110303">=</span>&nbsp;<span class="string" id="5110305">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110346">t</span>&nbsp;<span class="op" id="5110348">=</span>&nbsp;<span class="ident" id="5110350">t</span><span class="op" id="5110351">.</span><span class="ident" id="5110352">UTC</span><span class="op" id="5110355">(</span><span class="op" id="5110356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110359">yy</span><span class="op" id="5110361">,</span>&nbsp;<span class="ident" id="5110363">mm</span><span class="op" id="5110365">,</span>&nbsp;<span class="ident" id="5110367">dd</span>&nbsp;<span class="op" id="5110370">:=</span>&nbsp;<span class="ident" id="5110373">t</span><span class="op" id="5110374">.</span><span class="ident" id="5110375">Date</span><span class="op" id="5110379">(</span><span class="op" id="5110380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110383">hh</span><span class="op" id="5110385">,</span>&nbsp;<span class="ident" id="5110387">mn</span><span class="op" id="5110389">,</span>&nbsp;<span class="ident" id="5110391">ss</span>&nbsp;<span class="op" id="5110394">:=</span>&nbsp;<span class="ident" id="5110397">t</span><span class="op" id="5110398">.</span><span class="ident" id="5110399">Clock</span><span class="op" id="5110404">(</span><span class="op" id="5110405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110408">day</span>&nbsp;<span class="op" id="5110412">:=</span>&nbsp;<span class="ident" id="5110415">days</span><span class="op" id="5110419">[</span><span class="num" id="5110420">3</span><span class="op" id="5110421">*</span><span class="ident" id="5110422">t</span><span class="op" id="5110423">.</span><span class="ident" id="5110424">Weekday</span><span class="op" id="5110431">(</span><span class="op" id="5110432">)</span><span class="op" id="5110433">:</span><span class="op" id="5110434">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110437">mon</span>&nbsp;<span class="op" id="5110441">:=</span>&nbsp;<span class="ident" id="5110444">months</span><span class="op" id="5110450">[</span><span class="num" id="5110451">3</span><span class="op" id="5110452">*</span><span class="op" id="5110453">(</span><span class="ident" id="5110454">mm</span><span class="op" id="5110456">-</span><span class="num" id="5110457">1</span><span class="op" id="5110458">)</span><span class="op" id="5110459">:</span><span class="op" id="5110460">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110464">return</span>&nbsp;<span class="builtinfunc" id="5110471">append</span><span class="op" id="5110477">(</span><span class="ident" id="5110478">b</span><span class="op" id="5110479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110483">day</span><span class="op" id="5110486">[</span><span class="num" id="5110487">0</span><span class="op" id="5110488">]</span><span class="op" id="5110489">,</span>&nbsp;<span class="ident" id="5110491">day</span><span class="op" id="5110494">[</span><span class="num" id="5110495">1</span><span class="op" id="5110496">]</span><span class="op" id="5110497">,</span>&nbsp;<span class="ident" id="5110499">day</span><span class="op" id="5110502">[</span><span class="num" id="5110503">2</span><span class="op" id="5110504">]</span><span class="op" id="5110505">,</span>&nbsp;<span class="string" id="5110507">&#39;,&#39;</span><span class="op" id="5110510">,</span>&nbsp;<span class="string" id="5110512">&#39;&nbsp;&#39;</span><span class="op" id="5110515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5110519">byte</span><span class="op" id="5110523">(</span><span class="string" id="5110524">&#39;0&#39;</span><span class="op" id="5110527">+</span><span class="ident" id="5110528">dd</span><span class="op" id="5110530">/</span><span class="num" id="5110531">10</span><span class="op" id="5110533">)</span><span class="op" id="5110534">,</span>&nbsp;<span class="builtintype" id="5110536">byte</span><span class="op" id="5110540">(</span><span class="string" id="5110541">&#39;0&#39;</span><span class="op" id="5110544">+</span><span class="ident" id="5110545">dd</span><span class="op" id="5110547">%</span><span class="num" id="5110548">10</span><span class="op" id="5110550">)</span><span class="op" id="5110551">,</span>&nbsp;<span class="string" id="5110553">&#39;&nbsp;&#39;</span><span class="op" id="5110556">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5110560">mon</span><span class="op" id="5110563">[</span><span class="num" id="5110564">0</span><span class="op" id="5110565">]</span><span class="op" id="5110566">,</span>&nbsp;<span class="ident" id="5110568">mon</span><span class="op" id="5110571">[</span><span class="num" id="5110572">1</span><span class="op" id="5110573">]</span><span class="op" id="5110574">,</span>&nbsp;<span class="ident" id="5110576">mon</span><span class="op" id="5110579">[</span><span class="num" id="5110580">2</span><span class="op" id="5110581">]</span><span class="op" id="5110582">,</span>&nbsp;<span class="string" id="5110584">&#39;&nbsp;&#39;</span><span class="op" id="5110587">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5110591">byte</span><span class="op" id="5110595">(</span><span class="string" id="5110596">&#39;0&#39;</span><span class="op" id="5110599">+</span><span class="ident" id="5110600">yy</span><span class="op" id="5110602">/</span><span class="num" id="5110603">1000</span><span class="op" id="5110607">)</span><span class="op" id="5110608">,</span>&nbsp;<span class="builtintype" id="5110610">byte</span><span class="op" id="5110614">(</span><span class="string" id="5110615">&#39;0&#39;</span><span class="op" id="5110618">+</span><span class="op" id="5110619">(</span><span class="ident" id="5110620">yy</span><span class="op" id="5110622">/</span><span class="num" id="5110623">100</span><span class="op" id="5110626">)</span><span class="op" id="5110627">%</span><span class="num" id="5110628">10</span><span class="op" id="5110630">)</span><span class="op" id="5110631">,</span>&nbsp;<span class="builtintype" id="5110633">byte</span><span class="op" id="5110637">(</span><span class="string" id="5110638">&#39;0&#39;</span><span class="op" id="5110641">+</span><span class="op" id="5110642">(</span><span class="ident" id="5110643">yy</span><span class="op" id="5110645">/</span><span class="num" id="5110646">10</span><span class="op" id="5110648">)</span><span class="op" id="5110649">%</span><span class="num" id="5110650">10</span><span class="op" id="5110652">)</span><span class="op" id="5110653">,</span>&nbsp;<span class="builtintype" id="5110655">byte</span><span class="op" id="5110659">(</span><span class="string" id="5110660">&#39;0&#39;</span><span class="op" id="5110663">+</span><span class="ident" id="5110664">yy</span><span class="op" id="5110666">%</span><span class="num" id="5110667">10</span><span class="op" id="5110669">)</span><span class="op" id="5110670">,</span>&nbsp;<span class="string" id="5110672">&#39;&nbsp;&#39;</span><span class="op" id="5110675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5110679">byte</span><span class="op" id="5110683">(</span><span class="string" id="5110684">&#39;0&#39;</span><span class="op" id="5110687">+</span><span class="ident" id="5110688">hh</span><span class="op" id="5110690">/</span><span class="num" id="5110691">10</span><span class="op" id="5110693">)</span><span class="op" id="5110694">,</span>&nbsp;<span class="builtintype" id="5110696">byte</span><span class="op" id="5110700">(</span><span class="string" id="5110701">&#39;0&#39;</span><span class="op" id="5110704">+</span><span class="ident" id="5110705">hh</span><span class="op" id="5110707">%</span><span class="num" id="5110708">10</span><span class="op" id="5110710">)</span><span class="op" id="5110711">,</span>&nbsp;<span class="string" id="5110713">&#39;:&#39;</span><span class="op" id="5110716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5110720">byte</span><span class="op" id="5110724">(</span><span class="string" id="5110725">&#39;0&#39;</span><span class="op" id="5110728">+</span><span class="ident" id="5110729">mn</span><span class="op" id="5110731">/</span><span class="num" id="5110732">10</span><span class="op" id="5110734">)</span><span class="op" id="5110735">,</span>&nbsp;<span class="builtintype" id="5110737">byte</span><span class="op" id="5110741">(</span><span class="string" id="5110742">&#39;0&#39;</span><span class="op" id="5110745">+</span><span class="ident" id="5110746">mn</span><span class="op" id="5110748">%</span><span class="num" id="5110749">10</span><span class="op" id="5110751">)</span><span class="op" id="5110752">,</span>&nbsp;<span class="string" id="5110754">&#39;:&#39;</span><span class="op" id="5110757">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5110761">byte</span><span class="op" id="5110765">(</span><span class="string" id="5110766">&#39;0&#39;</span><span class="op" id="5110769">+</span><span class="ident" id="5110770">ss</span><span class="op" id="5110772">/</span><span class="num" id="5110773">10</span><span class="op" id="5110775">)</span><span class="op" id="5110776">,</span>&nbsp;<span class="builtintype" id="5110778">byte</span><span class="op" id="5110782">(</span><span class="string" id="5110783">&#39;0&#39;</span><span class="op" id="5110786">+</span><span class="ident" id="5110787">ss</span><span class="op" id="5110789">%</span><span class="num" id="5110790">10</span><span class="op" id="5110792">)</span><span class="op" id="5110793">,</span>&nbsp;<span class="string" id="5110795">&#39;&nbsp;&#39;</span><span class="op" id="5110798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5110802">&#39;G&#39;</span><span class="op" id="5110805">,</span>&nbsp;<span class="string" id="5110807">&#39;M&#39;</span><span class="op" id="5110810">,</span>&nbsp;<span class="string" id="5110812">&#39;T&#39;</span><span class="op" id="5110815">)</span><br>
<span class="lineno">565</span><span class="op" id="5110817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5110820">var</span>&nbsp;<span class="ident" id="5110824">errTooLarge</span>&nbsp;<span class="op" id="5110836">=</span>&nbsp;<span class="ident" id="5110838">errors</span><span class="op" id="5110844">.</span><span class="ident" id="5110845">New</span><span class="op" id="5110848">(</span><span class="string" id="5110849">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="5110874">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5110877">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="5110915">func</span>&nbsp;<span class="op" id="5110920">(</span><span class="ident" id="5110921">c</span>&nbsp;<span class="op" id="5110923">*</span><span class="ident" id="5110924">conn</span><span class="op" id="5110928">)</span>&nbsp;<span class="ident" id="5110930">readRequest</span><span class="op" id="5110941">(</span><span class="op" id="5110942">)</span>&nbsp;<span class="op" id="5110944">(</span><span class="ident" id="5110945">w</span>&nbsp;<span class="op" id="5110947">*</span><span class="ident" id="5110948">response</span><span class="op" id="5110956">,</span>&nbsp;<span class="ident" id="5110958">err</span>&nbsp;<span class="builtintype" id="5110962">error</span><span class="op" id="5110967">)</span>&nbsp;<span class="op" id="5110969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110972">if</span>&nbsp;<span class="ident" id="5110975">c</span><span class="op" id="5110976">.</span><span class="ident" id="5110977">hijacked</span><span class="op" id="5110985">(</span><span class="op" id="5110986">)</span>&nbsp;<span class="op" id="5110988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5110992">return</span>&nbsp;<span class="ident" id="5110999">nil</span><span class="op" id="5111002">,</span>&nbsp;<span class="ident" id="5111004">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111021">if</span>&nbsp;<span class="ident" id="5111024">d</span>&nbsp;<span class="op" id="5111026">:=</span>&nbsp;<span class="ident" id="5111029">c</span><span class="op" id="5111030">.</span><span class="ident" id="5111031">server</span><span class="op" id="5111037">.</span><span class="ident" id="5111038">ReadTimeout</span><span class="op" id="5111049">;</span>&nbsp;<span class="ident" id="5111051">d</span>&nbsp;<span class="op" id="5111053">!=</span>&nbsp;<span class="num" id="5111056">0</span>&nbsp;<span class="op" id="5111058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111062">c</span><span class="op" id="5111063">.</span><span class="ident" id="5111064">rwc</span><span class="op" id="5111067">.</span><span class="ident" id="5111068">SetReadDeadline</span><span class="op" id="5111083">(</span><span class="ident" id="5111084">time</span><span class="op" id="5111088">.</span><span class="ident" id="5111089">Now</span><span class="op" id="5111092">(</span><span class="op" id="5111093">)</span><span class="op" id="5111094">.</span><span class="ident" id="5111095">Add</span><span class="op" id="5111098">(</span><span class="ident" id="5111099">d</span><span class="op" id="5111100">)</span><span class="op" id="5111101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111107">if</span>&nbsp;<span class="ident" id="5111110">d</span>&nbsp;<span class="op" id="5111112">:=</span>&nbsp;<span class="ident" id="5111115">c</span><span class="op" id="5111116">.</span><span class="ident" id="5111117">server</span><span class="op" id="5111123">.</span><span class="ident" id="5111124">WriteTimeout</span><span class="op" id="5111136">;</span>&nbsp;<span class="ident" id="5111138">d</span>&nbsp;<span class="op" id="5111140">!=</span>&nbsp;<span class="num" id="5111143">0</span>&nbsp;<span class="op" id="5111145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111149">defer</span>&nbsp;<span class="keyword" id="5111155">func</span><span class="op" id="5111159">(</span><span class="op" id="5111160">)</span>&nbsp;<span class="op" id="5111162">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111167">c</span><span class="op" id="5111168">.</span><span class="ident" id="5111169">rwc</span><span class="op" id="5111172">.</span><span class="ident" id="5111173">SetWriteDeadline</span><span class="op" id="5111189">(</span><span class="ident" id="5111190">time</span><span class="op" id="5111194">.</span><span class="ident" id="5111195">Now</span><span class="op" id="5111198">(</span><span class="op" id="5111199">)</span><span class="op" id="5111200">.</span><span class="ident" id="5111201">Add</span><span class="op" id="5111204">(</span><span class="ident" id="5111205">d</span><span class="op" id="5111206">)</span><span class="op" id="5111207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111211">}</span><span class="op" id="5111212">(</span><span class="op" id="5111213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111220">c</span><span class="op" id="5111221">.</span><span class="ident" id="5111222">lr</span><span class="op" id="5111224">.</span><span class="ident" id="5111225">N</span>&nbsp;<span class="op" id="5111227">=</span>&nbsp;<span class="ident" id="5111229">c</span><span class="op" id="5111230">.</span><span class="ident" id="5111231">server</span><span class="op" id="5111237">.</span><span class="ident" id="5111238">initialLimitedReaderSize</span><span class="op" id="5111262">(</span><span class="op" id="5111263">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111266">var</span>&nbsp;<span class="ident" id="5111270">req</span>&nbsp;<span class="op" id="5111274">*</span><span class="ident" id="5111275">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111284">if</span>&nbsp;<span class="ident" id="5111287">req</span><span class="op" id="5111290">,</span>&nbsp;<span class="ident" id="5111292">err</span>&nbsp;<span class="op" id="5111296">=</span>&nbsp;<span class="ident" id="5111298">ReadRequest</span><span class="op" id="5111309">(</span><span class="ident" id="5111310">c</span><span class="op" id="5111311">.</span><span class="ident" id="5111312">buf</span><span class="op" id="5111315">.</span><span class="ident" id="5111316">Reader</span><span class="op" id="5111322">)</span><span class="op" id="5111323">;</span>&nbsp;<span class="ident" id="5111325">err</span>&nbsp;<span class="op" id="5111329">!=</span>&nbsp;<span class="ident" id="5111332">nil</span>&nbsp;<span class="op" id="5111336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111340">if</span>&nbsp;<span class="ident" id="5111343">c</span><span class="op" id="5111344">.</span><span class="ident" id="5111345">lr</span><span class="op" id="5111347">.</span><span class="ident" id="5111348">N</span>&nbsp;<span class="op" id="5111350">==</span>&nbsp;<span class="num" id="5111353">0</span>&nbsp;<span class="op" id="5111355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111360">return</span>&nbsp;<span class="ident" id="5111367">nil</span><span class="op" id="5111370">,</span>&nbsp;<span class="ident" id="5111372">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111386">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111390">return</span>&nbsp;<span class="ident" id="5111397">nil</span><span class="op" id="5111400">,</span>&nbsp;<span class="ident" id="5111402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111410">c</span><span class="op" id="5111411">.</span><span class="ident" id="5111412">lr</span><span class="op" id="5111414">.</span><span class="ident" id="5111415">N</span>&nbsp;<span class="op" id="5111417">=</span>&nbsp;<span class="ident" id="5111419">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111429">req</span><span class="op" id="5111432">.</span><span class="ident" id="5111433">RemoteAddr</span>&nbsp;<span class="op" id="5111444">=</span>&nbsp;<span class="ident" id="5111446">c</span><span class="op" id="5111447">.</span><span class="ident" id="5111448">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111460">req</span><span class="op" id="5111463">.</span><span class="ident" id="5111464">TLS</span>&nbsp;<span class="op" id="5111468">=</span>&nbsp;<span class="ident" id="5111470">c</span><span class="op" id="5111471">.</span><span class="ident" id="5111472">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111483">w</span>&nbsp;<span class="op" id="5111485">=</span>&nbsp;<span class="op" id="5111487">&amp;</span><span class="ident" id="5111488">response</span><span class="op" id="5111496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111500">conn</span><span class="op" id="5111504">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5111515">c</span><span class="op" id="5111516">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111520">req</span><span class="op" id="5111523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5111535">req</span><span class="op" id="5111538">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111542">handlerHeader</span><span class="op" id="5111555">:</span>&nbsp;<span class="builtinfunc" id="5111557">make</span><span class="op" id="5111561">(</span><span class="ident" id="5111562">Header</span><span class="op" id="5111568">)</span><span class="op" id="5111569">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111573">contentLength</span><span class="op" id="5111586">:</span>&nbsp;<span class="op" id="5111588">-</span><span class="num" id="5111589">1</span><span class="op" id="5111590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111596">w</span><span class="op" id="5111597">.</span><span class="ident" id="5111598">cw</span><span class="op" id="5111600">.</span><span class="ident" id="5111601">res</span>&nbsp;<span class="op" id="5111605">=</span>&nbsp;<span class="ident" id="5111607">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111610">w</span><span class="op" id="5111611">.</span><span class="ident" id="5111612">w</span>&nbsp;<span class="op" id="5111614">=</span>&nbsp;<span class="ident" id="5111616">newBufioWriterSize</span><span class="op" id="5111634">(</span><span class="op" id="5111635">&amp;</span><span class="ident" id="5111636">w</span><span class="op" id="5111637">.</span><span class="ident" id="5111638">cw</span><span class="op" id="5111640">,</span>&nbsp;<span class="ident" id="5111642">bufferBeforeChunkingSize</span><span class="op" id="5111666">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111669">return</span>&nbsp;<span class="ident" id="5111676">w</span><span class="op" id="5111677">,</span>&nbsp;<span class="ident" id="5111679">nil</span><br>
<span class="lineno"></span><span class="op" id="5111683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5111686">func</span>&nbsp;<span class="op" id="5111691">(</span><span class="ident" id="5111692">w</span>&nbsp;<span class="op" id="5111694">*</span><span class="ident" id="5111695">response</span><span class="op" id="5111703">)</span>&nbsp;<span class="ident" id="5111705">Header</span><span class="op" id="5111711">(</span><span class="op" id="5111712">)</span>&nbsp;<span class="ident" id="5111714">Header</span>&nbsp;<span class="op" id="5111721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5111724">if</span>&nbsp;<span class="ident" id="5111727">w</span><span class="op" id="5111728">.</span><span class="ident" id="5111729">cw</span><span class="op" id="5111731">.</span><span class="ident" id="5111732">header</span>&nbsp;<span class="op" id="5111739">==</span>&nbsp;<span class="ident" id="5111742">nil</span>&nbsp;<span class="op" id="5111746">&amp;&amp;</span>&nbsp;<span class="ident" id="5111749">w</span><span class="op" id="5111750">.</span><span class="ident" id="5111751">wroteHeader</span>&nbsp;<span class="op" id="5111763">&amp;&amp;</span>&nbsp;<span class="op" id="5111766">!</span><span class="ident" id="5111767">w</span><span class="op" id="5111768">.</span><span class="ident" id="5111769">cw</span><span class="op" id="5111771">.</span><span class="ident" id="5111772">wroteHeader</span>&nbsp;<span class="op" id="5111784">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5111788">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5111843">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5111900">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111954">w</span><span class="op" id="5111955">.</span><span class="ident" id="5111956">cw</span><span class="op" id="5111958">.</span><span class="ident" id="5111959">header</span>&nbsp;<span class="op" id="5111966">=</span>&nbsp;<span class="ident" id="5111968">w</span><span class="op" id="5111969">.</span><span class="ident" id="5111970">handlerHeader</span><span class="op" id="5111983">.</span><span class="ident" id="5111984">clone</span><span class="op" id="5111989">(</span><span class="op" id="5111990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5111993">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5111996">w</span><span class="op" id="5111997">.</span><span class="ident" id="5111998">calledHeader</span>&nbsp;<span class="op" id="5112011">=</span>&nbsp;<span class="builtintype" id="5112013">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112019">return</span>&nbsp;<span class="ident" id="5112026">w</span><span class="op" id="5112027">.</span><span class="ident" id="5112028">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="5112042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5112045">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="5112116">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="5112183">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="5112253">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="5112321">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="5112341">//</span><br>
<span class="lineno">625</span><span class="comment" id="5112344">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="5112412">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5112482">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="5112501">const</span>&nbsp;<span class="ident" id="5112507">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="5112531">=</span>&nbsp;<span class="num" id="5112533">256</span>&nbsp;<span class="op" id="5112537">&lt;&lt;</span>&nbsp;<span class="num" id="5112540">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="5112544">func</span>&nbsp;<span class="op" id="5112549">(</span><span class="ident" id="5112550">w</span>&nbsp;<span class="op" id="5112552">*</span><span class="ident" id="5112553">response</span><span class="op" id="5112561">)</span>&nbsp;<span class="ident" id="5112563">WriteHeader</span><span class="op" id="5112574">(</span><span class="ident" id="5112575">code</span>&nbsp;<span class="builtintype" id="5112580">int</span><span class="op" id="5112583">)</span>&nbsp;<span class="op" id="5112585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112588">if</span>&nbsp;<span class="ident" id="5112591">w</span><span class="op" id="5112592">.</span><span class="ident" id="5112593">conn</span><span class="op" id="5112597">.</span><span class="ident" id="5112598">hijacked</span><span class="op" id="5112606">(</span><span class="op" id="5112607">)</span>&nbsp;<span class="op" id="5112609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112613">w</span><span class="op" id="5112614">.</span><span class="ident" id="5112615">conn</span><span class="op" id="5112619">.</span><span class="ident" id="5112620">server</span><span class="op" id="5112626">.</span><span class="ident" id="5112627">logf</span><span class="op" id="5112631">(</span><span class="string" id="5112632">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="5112683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112687">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112695">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112698">if</span>&nbsp;<span class="ident" id="5112701">w</span><span class="op" id="5112702">.</span><span class="ident" id="5112703">wroteHeader</span>&nbsp;<span class="op" id="5112715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112719">w</span><span class="op" id="5112720">.</span><span class="ident" id="5112721">conn</span><span class="op" id="5112725">.</span><span class="ident" id="5112726">server</span><span class="op" id="5112732">.</span><span class="ident" id="5112733">logf</span><span class="op" id="5112737">(</span><span class="string" id="5112738">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="5112781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112785">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112796">w</span><span class="op" id="5112797">.</span><span class="ident" id="5112798">wroteHeader</span>&nbsp;<span class="op" id="5112810">=</span>&nbsp;<span class="builtintype" id="5112812">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112818">w</span><span class="op" id="5112819">.</span><span class="ident" id="5112820">status</span>&nbsp;<span class="op" id="5112827">=</span>&nbsp;<span class="ident" id="5112829">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112836">if</span>&nbsp;<span class="ident" id="5112839">w</span><span class="op" id="5112840">.</span><span class="ident" id="5112841">calledHeader</span>&nbsp;<span class="op" id="5112854">&amp;&amp;</span>&nbsp;<span class="ident" id="5112857">w</span><span class="op" id="5112858">.</span><span class="ident" id="5112859">cw</span><span class="op" id="5112861">.</span><span class="ident" id="5112862">header</span>&nbsp;<span class="op" id="5112869">==</span>&nbsp;<span class="ident" id="5112872">nil</span>&nbsp;<span class="op" id="5112876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112880">w</span><span class="op" id="5112881">.</span><span class="ident" id="5112882">cw</span><span class="op" id="5112884">.</span><span class="ident" id="5112885">header</span>&nbsp;<span class="op" id="5112892">=</span>&nbsp;<span class="ident" id="5112894">w</span><span class="op" id="5112895">.</span><span class="ident" id="5112896">handlerHeader</span><span class="op" id="5112909">.</span><span class="ident" id="5112910">clone</span><span class="op" id="5112915">(</span><span class="op" id="5112916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5112919">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5112923">if</span>&nbsp;<span class="ident" id="5112926">cl</span>&nbsp;<span class="op" id="5112929">:=</span>&nbsp;<span class="ident" id="5112932">w</span><span class="op" id="5112933">.</span><span class="ident" id="5112934">handlerHeader</span><span class="op" id="5112947">.</span><span class="ident" id="5112948">get</span><span class="op" id="5112951">(</span><span class="string" id="5112952">&#34;Content-Length&#34;</span><span class="op" id="5112968">)</span><span class="op" id="5112969">;</span>&nbsp;<span class="ident" id="5112971">cl</span>&nbsp;<span class="op" id="5112974">!=</span>&nbsp;<span class="string" id="5112977">&#34;&#34;</span>&nbsp;<span class="op" id="5112980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5112984">v</span><span class="op" id="5112985">,</span>&nbsp;<span class="ident" id="5112987">err</span>&nbsp;<span class="op" id="5112991">:=</span>&nbsp;<span class="ident" id="5112994">strconv</span><span class="op" id="5113001">.</span><span class="ident" id="5113002">ParseInt</span><span class="op" id="5113010">(</span><span class="ident" id="5113011">cl</span><span class="op" id="5113013">,</span>&nbsp;<span class="num" id="5113015">10</span><span class="op" id="5113017">,</span>&nbsp;<span class="num" id="5113019">64</span><span class="op" id="5113021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5113025">if</span>&nbsp;<span class="ident" id="5113028">err</span>&nbsp;<span class="op" id="5113032">==</span>&nbsp;<span class="ident" id="5113035">nil</span>&nbsp;<span class="op" id="5113039">&amp;&amp;</span>&nbsp;<span class="ident" id="5113042">v</span>&nbsp;<span class="op" id="5113044">&gt;=</span>&nbsp;<span class="num" id="5113047">0</span>&nbsp;<span class="op" id="5113049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113054">w</span><span class="op" id="5113055">.</span><span class="ident" id="5113056">contentLength</span>&nbsp;<span class="op" id="5113070">=</span>&nbsp;<span class="ident" id="5113072">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113076">}</span>&nbsp;<span class="keyword" id="5113078">else</span>&nbsp;<span class="op" id="5113083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113088">w</span><span class="op" id="5113089">.</span><span class="ident" id="5113090">conn</span><span class="op" id="5113094">.</span><span class="ident" id="5113095">server</span><span class="op" id="5113101">.</span><span class="ident" id="5113102">logf</span><span class="op" id="5113106">(</span><span class="string" id="5113107">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="5113143">,</span>&nbsp;<span class="ident" id="5113145">cl</span><span class="op" id="5113147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113152">w</span><span class="op" id="5113153">.</span><span class="ident" id="5113154">handlerHeader</span><span class="op" id="5113167">.</span><span class="ident" id="5113168">Del</span><span class="op" id="5113171">(</span><span class="string" id="5113172">&#34;Content-Length&#34;</span><span class="op" id="5113188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113195">}</span><br>
<span class="lineno">655</span><span class="op" id="5113197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5113200">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="5113281">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="5113360">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="5113417">type</span>&nbsp;<span class="ident" id="5113422">extraHeader</span>&nbsp;<span class="keyword" id="5113434">struct</span>&nbsp;<span class="op" id="5113441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113444">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5113461">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113469">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5113486">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113494">transferEncoding</span>&nbsp;<span class="builtintype" id="5113511">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113519">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5113536">[</span><span class="op" id="5113537">]</span><span class="builtintype" id="5113538">byte</span>&nbsp;<span class="comment" id="5113543">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113566">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5113583">[</span><span class="op" id="5113584">]</span><span class="builtintype" id="5113585">byte</span>&nbsp;<span class="comment" id="5113590">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="5113612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5113615">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="5113663">var</span>&nbsp;<span class="ident" id="5113667">extraHeaderKeys</span>&nbsp;<span class="op" id="5113683">=</span>&nbsp;<span class="op" id="5113685">[</span><span class="op" id="5113686">]</span><span class="op" id="5113687">[</span><span class="op" id="5113688">]</span><span class="builtintype" id="5113689">byte</span><span class="op" id="5113693">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113696">[</span><span class="op" id="5113697">]</span><span class="builtintype" id="5113698">byte</span><span class="op" id="5113702">(</span><span class="string" id="5113703">&#34;Content-Type&#34;</span><span class="op" id="5113717">)</span><span class="op" id="5113718">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113721">[</span><span class="op" id="5113722">]</span><span class="builtintype" id="5113723">byte</span><span class="op" id="5113727">(</span><span class="string" id="5113728">&#34;Connection&#34;</span><span class="op" id="5113740">)</span><span class="op" id="5113741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5113744">[</span><span class="op" id="5113745">]</span><span class="builtintype" id="5113746">byte</span><span class="op" id="5113750">(</span><span class="string" id="5113751">&#34;Transfer-Encoding&#34;</span><span class="op" id="5113770">)</span><span class="op" id="5113771">,</span><br>
<span class="lineno"></span><span class="op" id="5113773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="5113776">var</span>&nbsp;<span class="op" id="5113780">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113783">headerContentLength</span>&nbsp;<span class="op" id="5113803">=</span>&nbsp;<span class="op" id="5113805">[</span><span class="op" id="5113806">]</span><span class="builtintype" id="5113807">byte</span><span class="op" id="5113811">(</span><span class="string" id="5113812">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="5113830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5113833">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5113853">=</span>&nbsp;<span class="op" id="5113855">[</span><span class="op" id="5113856">]</span><span class="builtintype" id="5113857">byte</span><span class="op" id="5113861">(</span><span class="string" id="5113862">&#34;Date:&nbsp;&#34;</span><span class="op" id="5113870">)</span><br>
<span class="lineno"></span><span class="op" id="5113872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="5113875">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5113924">//</span><br>
<span class="lineno"></span><span class="comment" id="5113927">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="5113996">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="5114066">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="5114125">func</span>&nbsp;<span class="op" id="5114130">(</span><span class="ident" id="5114131">h</span>&nbsp;<span class="ident" id="5114133">extraHeader</span><span class="op" id="5114144">)</span>&nbsp;<span class="ident" id="5114146">Write</span><span class="op" id="5114151">(</span><span class="ident" id="5114152">w</span>&nbsp;<span class="op" id="5114154">*</span><span class="ident" id="5114155">bufio</span><span class="op" id="5114160">.</span><span class="ident" id="5114161">Writer</span><span class="op" id="5114167">)</span>&nbsp;<span class="op" id="5114169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114172">if</span>&nbsp;<span class="ident" id="5114175">h</span><span class="op" id="5114176">.</span><span class="ident" id="5114177">date</span>&nbsp;<span class="op" id="5114182">!=</span>&nbsp;<span class="ident" id="5114185">nil</span>&nbsp;<span class="op" id="5114189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114193">w</span><span class="op" id="5114194">.</span><span class="ident" id="5114195">Write</span><span class="op" id="5114200">(</span><span class="ident" id="5114201">headerDate</span><span class="op" id="5114211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114215">w</span><span class="op" id="5114216">.</span><span class="ident" id="5114217">Write</span><span class="op" id="5114222">(</span><span class="ident" id="5114223">h</span><span class="op" id="5114224">.</span><span class="ident" id="5114225">date</span><span class="op" id="5114229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114233">w</span><span class="op" id="5114234">.</span><span class="ident" id="5114235">Write</span><span class="op" id="5114240">(</span><span class="ident" id="5114241">crlf</span><span class="op" id="5114245">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5114248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114251">if</span>&nbsp;<span class="ident" id="5114254">h</span><span class="op" id="5114255">.</span><span class="ident" id="5114256">contentLength</span>&nbsp;<span class="op" id="5114270">!=</span>&nbsp;<span class="ident" id="5114273">nil</span>&nbsp;<span class="op" id="5114277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114281">w</span><span class="op" id="5114282">.</span><span class="ident" id="5114283">Write</span><span class="op" id="5114288">(</span><span class="ident" id="5114289">headerContentLength</span><span class="op" id="5114308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114312">w</span><span class="op" id="5114313">.</span><span class="ident" id="5114314">Write</span><span class="op" id="5114319">(</span><span class="ident" id="5114320">h</span><span class="op" id="5114321">.</span><span class="ident" id="5114322">contentLength</span><span class="op" id="5114335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114339">w</span><span class="op" id="5114340">.</span><span class="ident" id="5114341">Write</span><span class="op" id="5114346">(</span><span class="ident" id="5114347">crlf</span><span class="op" id="5114351">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5114354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114357">for</span>&nbsp;<span class="ident" id="5114361">i</span><span class="op" id="5114362">,</span>&nbsp;<span class="ident" id="5114364">v</span>&nbsp;<span class="op" id="5114366">:=</span>&nbsp;<span class="keyword" id="5114369">range</span>&nbsp;<span class="op" id="5114375">[</span><span class="op" id="5114376">]</span><span class="builtintype" id="5114377">string</span><span class="op" id="5114383">{</span><span class="ident" id="5114384">h</span><span class="op" id="5114385">.</span><span class="ident" id="5114386">contentType</span><span class="op" id="5114397">,</span>&nbsp;<span class="ident" id="5114399">h</span><span class="op" id="5114400">.</span><span class="ident" id="5114401">connection</span><span class="op" id="5114411">,</span>&nbsp;<span class="ident" id="5114413">h</span><span class="op" id="5114414">.</span><span class="ident" id="5114415">transferEncoding</span><span class="op" id="5114431">}</span>&nbsp;<span class="op" id="5114433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114437">if</span>&nbsp;<span class="ident" id="5114440">v</span>&nbsp;<span class="op" id="5114442">!=</span>&nbsp;<span class="string" id="5114445">&#34;&#34;</span>&nbsp;<span class="op" id="5114448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114453">w</span><span class="op" id="5114454">.</span><span class="ident" id="5114455">Write</span><span class="op" id="5114460">(</span><span class="ident" id="5114461">extraHeaderKeys</span><span class="op" id="5114476">[</span><span class="ident" id="5114477">i</span><span class="op" id="5114478">]</span><span class="op" id="5114479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114484">w</span><span class="op" id="5114485">.</span><span class="ident" id="5114486">Write</span><span class="op" id="5114491">(</span><span class="ident" id="5114492">colonSpace</span><span class="op" id="5114502">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114507">w</span><span class="op" id="5114508">.</span><span class="ident" id="5114509">WriteString</span><span class="op" id="5114520">(</span><span class="ident" id="5114521">v</span><span class="op" id="5114522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5114527">w</span><span class="op" id="5114528">.</span><span class="ident" id="5114529">Write</span><span class="op" id="5114534">(</span><span class="ident" id="5114535">crlf</span><span class="op" id="5114539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5114543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5114546">}</span><br>
<span class="lineno"></span><span class="op" id="5114548">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="5114551">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5114620">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="5114643">//</span><br>
<span class="lineno"></span><span class="comment" id="5114646">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="5114717">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5114787">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5114856">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="5114922">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="5114934">func</span>&nbsp;<span class="op" id="5114939">(</span><span class="ident" id="5114940">cw</span>&nbsp;<span class="op" id="5114943">*</span><span class="ident" id="5114944">chunkWriter</span><span class="op" id="5114955">)</span>&nbsp;<span class="ident" id="5114957">writeHeader</span><span class="op" id="5114968">(</span><span class="ident" id="5114969">p</span>&nbsp;<span class="op" id="5114971">[</span><span class="op" id="5114972">]</span><span class="builtintype" id="5114973">byte</span><span class="op" id="5114977">)</span>&nbsp;<span class="op" id="5114979">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5114982">if</span>&nbsp;<span class="ident" id="5114985">cw</span><span class="op" id="5114987">.</span><span class="ident" id="5114988">wroteHeader</span>&nbsp;<span class="op" id="5115000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115004">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115015">cw</span><span class="op" id="5115017">.</span><span class="ident" id="5115018">wroteHeader</span>&nbsp;<span class="op" id="5115030">=</span>&nbsp;<span class="builtintype" id="5115032">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115039">w</span>&nbsp;<span class="op" id="5115041">:=</span>&nbsp;<span class="ident" id="5115044">cw</span><span class="op" id="5115046">.</span><span class="ident" id="5115047">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115052">keepAlivesEnabled</span>&nbsp;<span class="op" id="5115070">:=</span>&nbsp;<span class="ident" id="5115073">w</span><span class="op" id="5115074">.</span><span class="ident" id="5115075">conn</span><span class="op" id="5115079">.</span><span class="ident" id="5115080">server</span><span class="op" id="5115086">.</span><span class="ident" id="5115087">doKeepAlives</span><span class="op" id="5115099">(</span><span class="op" id="5115100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115103">isHEAD</span>&nbsp;<span class="op" id="5115110">:=</span>&nbsp;<span class="ident" id="5115113">w</span><span class="op" id="5115114">.</span><span class="ident" id="5115115">req</span><span class="op" id="5115118">.</span><span class="ident" id="5115119">Method</span>&nbsp;<span class="op" id="5115126">==</span>&nbsp;<span class="string" id="5115129">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115138">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115202">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115264">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115320">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115382">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115410">header</span>&nbsp;<span class="op" id="5115417">:=</span>&nbsp;<span class="ident" id="5115420">cw</span><span class="op" id="5115422">.</span><span class="ident" id="5115423">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115431">owned</span>&nbsp;<span class="op" id="5115437">:=</span>&nbsp;<span class="ident" id="5115440">header</span>&nbsp;<span class="op" id="5115447">!=</span>&nbsp;<span class="ident" id="5115450">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115455">if</span>&nbsp;<span class="op" id="5115458">!</span><span class="ident" id="5115459">owned</span>&nbsp;<span class="op" id="5115465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115469">header</span>&nbsp;<span class="op" id="5115476">=</span>&nbsp;<span class="ident" id="5115478">w</span><span class="op" id="5115479">.</span><span class="ident" id="5115480">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115498">var</span>&nbsp;<span class="ident" id="5115502">excludeHeader</span>&nbsp;<span class="keyword" id="5115516">map</span><span class="op" id="5115519">[</span><span class="builtintype" id="5115520">string</span><span class="op" id="5115526">]</span><span class="builtintype" id="5115527">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115533">delHeader</span>&nbsp;<span class="op" id="5115543">:=</span>&nbsp;<span class="keyword" id="5115546">func</span><span class="op" id="5115550">(</span><span class="ident" id="5115551">key</span>&nbsp;<span class="builtintype" id="5115555">string</span><span class="op" id="5115561">)</span>&nbsp;<span class="op" id="5115563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115567">if</span>&nbsp;<span class="ident" id="5115570">owned</span>&nbsp;<span class="op" id="5115576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115581">header</span><span class="op" id="5115587">.</span><span class="ident" id="5115588">Del</span><span class="op" id="5115591">(</span><span class="ident" id="5115592">key</span><span class="op" id="5115595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115600">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115609">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115613">if</span>&nbsp;<span class="ident" id="5115616">_</span><span class="op" id="5115617">,</span>&nbsp;<span class="ident" id="5115619">ok</span>&nbsp;<span class="op" id="5115622">:=</span>&nbsp;<span class="ident" id="5115625">header</span><span class="op" id="5115631">[</span><span class="ident" id="5115632">key</span><span class="op" id="5115635">]</span><span class="op" id="5115636">;</span>&nbsp;<span class="op" id="5115638">!</span><span class="ident" id="5115639">ok</span>&nbsp;<span class="op" id="5115642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115647">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115660">if</span>&nbsp;<span class="ident" id="5115663">excludeHeader</span>&nbsp;<span class="op" id="5115677">==</span>&nbsp;<span class="ident" id="5115680">nil</span>&nbsp;<span class="op" id="5115684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115689">excludeHeader</span>&nbsp;<span class="op" id="5115703">=</span>&nbsp;<span class="builtinfunc" id="5115705">make</span><span class="op" id="5115709">(</span><span class="keyword" id="5115710">map</span><span class="op" id="5115713">[</span><span class="builtintype" id="5115714">string</span><span class="op" id="5115720">]</span><span class="builtintype" id="5115721">bool</span><span class="op" id="5115725">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5115733">excludeHeader</span><span class="op" id="5115746">[</span><span class="ident" id="5115747">key</span><span class="op" id="5115750">]</span>&nbsp;<span class="op" id="5115752">=</span>&nbsp;<span class="builtintype" id="5115754">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5115760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5115763">var</span>&nbsp;<span class="ident" id="5115767">setHeader</span>&nbsp;<span class="ident" id="5115777">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115791">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115850">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115914">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5115975">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116011">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116082">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116146">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116208">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116272">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116336">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116396">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116458">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116492">if</span>&nbsp;<span class="ident" id="5116495">w</span><span class="op" id="5116496">.</span><span class="ident" id="5116497">handlerDone</span>&nbsp;<span class="op" id="5116509">&amp;&amp;</span>&nbsp;<span class="ident" id="5116512">bodyAllowedForStatus</span><span class="op" id="5116532">(</span><span class="ident" id="5116533">w</span><span class="op" id="5116534">.</span><span class="ident" id="5116535">status</span><span class="op" id="5116541">)</span>&nbsp;<span class="op" id="5116543">&amp;&amp;</span>&nbsp;<span class="ident" id="5116546">header</span><span class="op" id="5116552">.</span><span class="ident" id="5116553">get</span><span class="op" id="5116556">(</span><span class="string" id="5116557">&#34;Content-Length&#34;</span><span class="op" id="5116573">)</span>&nbsp;<span class="op" id="5116575">==</span>&nbsp;<span class="string" id="5116578">&#34;&#34;</span>&nbsp;<span class="op" id="5116581">&amp;&amp;</span>&nbsp;<span class="op" id="5116584">(</span><span class="op" id="5116585">!</span><span class="ident" id="5116586">isHEAD</span>&nbsp;<span class="op" id="5116593">||</span>&nbsp;<span class="builtinfunc" id="5116596">len</span><span class="op" id="5116599">(</span><span class="ident" id="5116600">p</span><span class="op" id="5116601">)</span>&nbsp;<span class="op" id="5116603">&gt;</span>&nbsp;<span class="num" id="5116605">0</span><span class="op" id="5116606">)</span>&nbsp;<span class="op" id="5116608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116612">w</span><span class="op" id="5116613">.</span><span class="ident" id="5116614">contentLength</span>&nbsp;<span class="op" id="5116628">=</span>&nbsp;<span class="ident" id="5116630">int64</span><span class="op" id="5116635">(</span><span class="builtinfunc" id="5116636">len</span><span class="op" id="5116639">(</span><span class="ident" id="5116640">p</span><span class="op" id="5116641">)</span><span class="op" id="5116642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116646">setHeader</span><span class="op" id="5116655">.</span><span class="ident" id="5116656">contentLength</span>&nbsp;<span class="op" id="5116670">=</span>&nbsp;<span class="ident" id="5116672">strconv</span><span class="op" id="5116679">.</span><span class="ident" id="5116680">AppendInt</span><span class="op" id="5116689">(</span><span class="ident" id="5116690">cw</span><span class="op" id="5116692">.</span><span class="ident" id="5116693">res</span><span class="op" id="5116696">.</span><span class="ident" id="5116697">clenBuf</span><span class="op" id="5116704">[</span><span class="op" id="5116705">:</span><span class="num" id="5116706">0</span><span class="op" id="5116707">]</span><span class="op" id="5116708">,</span>&nbsp;<span class="ident" id="5116710">int64</span><span class="op" id="5116715">(</span><span class="builtinfunc" id="5116716">len</span><span class="op" id="5116719">(</span><span class="ident" id="5116720">p</span><span class="op" id="5116721">)</span><span class="op" id="5116722">)</span><span class="op" id="5116723">,</span>&nbsp;<span class="num" id="5116725">10</span><span class="op" id="5116727">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5116730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116734">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5116800">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116868">if</span>&nbsp;<span class="ident" id="5116871">w</span><span class="op" id="5116872">.</span><span class="ident" id="5116873">req</span><span class="op" id="5116876">.</span><span class="ident" id="5116877">wantsHttp10KeepAlive</span><span class="op" id="5116897">(</span><span class="op" id="5116898">)</span>&nbsp;<span class="op" id="5116900">&amp;&amp;</span>&nbsp;<span class="ident" id="5116903">keepAlivesEnabled</span>&nbsp;<span class="op" id="5116921">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5116925">sentLength</span>&nbsp;<span class="op" id="5116936">:=</span>&nbsp;<span class="ident" id="5116939">header</span><span class="op" id="5116945">.</span><span class="ident" id="5116946">get</span><span class="op" id="5116949">(</span><span class="string" id="5116950">&#34;Content-Length&#34;</span><span class="op" id="5116966">)</span>&nbsp;<span class="op" id="5116968">!=</span>&nbsp;<span class="string" id="5116971">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5116976">if</span>&nbsp;<span class="ident" id="5116979">sentLength</span>&nbsp;<span class="op" id="5116990">&amp;&amp;</span>&nbsp;<span class="ident" id="5116993">header</span><span class="op" id="5116999">.</span><span class="ident" id="5117000">get</span><span class="op" id="5117003">(</span><span class="string" id="5117004">&#34;Connection&#34;</span><span class="op" id="5117016">)</span>&nbsp;<span class="op" id="5117018">==</span>&nbsp;<span class="string" id="5117021">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="5117034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117039">w</span><span class="op" id="5117040">.</span><span class="ident" id="5117041">closeAfterReply</span>&nbsp;<span class="op" id="5117057">=</span>&nbsp;<span class="builtintype" id="5117059">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117070">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5117074">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117134">hasCL</span>&nbsp;<span class="op" id="5117140">:=</span>&nbsp;<span class="ident" id="5117143">w</span><span class="op" id="5117144">.</span><span class="ident" id="5117145">contentLength</span>&nbsp;<span class="op" id="5117159">!=</span>&nbsp;<span class="op" id="5117162">-</span><span class="num" id="5117163">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117167">if</span>&nbsp;<span class="ident" id="5117170">w</span><span class="op" id="5117171">.</span><span class="ident" id="5117172">req</span><span class="op" id="5117175">.</span><span class="ident" id="5117176">wantsHttp10KeepAlive</span><span class="op" id="5117196">(</span><span class="op" id="5117197">)</span>&nbsp;<span class="op" id="5117199">&amp;&amp;</span>&nbsp;<span class="op" id="5117202">(</span><span class="ident" id="5117203">isHEAD</span>&nbsp;<span class="op" id="5117210">||</span>&nbsp;<span class="ident" id="5117213">hasCL</span><span class="op" id="5117218">)</span>&nbsp;<span class="op" id="5117220">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117224">_</span><span class="op" id="5117225">,</span>&nbsp;<span class="ident" id="5117227">connectionHeaderSet</span>&nbsp;<span class="op" id="5117247">:=</span>&nbsp;<span class="ident" id="5117250">header</span><span class="op" id="5117256">[</span><span class="string" id="5117257">&#34;Connection&#34;</span><span class="op" id="5117269">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117273">if</span>&nbsp;<span class="op" id="5117276">!</span><span class="ident" id="5117277">connectionHeaderSet</span>&nbsp;<span class="op" id="5117297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117302">setHeader</span><span class="op" id="5117311">.</span><span class="ident" id="5117312">connection</span>&nbsp;<span class="op" id="5117323">=</span>&nbsp;<span class="string" id="5117325">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117343">}</span>&nbsp;<span class="keyword" id="5117345">else</span>&nbsp;<span class="keyword" id="5117350">if</span>&nbsp;<span class="op" id="5117353">!</span><span class="ident" id="5117354">w</span><span class="op" id="5117355">.</span><span class="ident" id="5117356">req</span><span class="op" id="5117359">.</span><span class="ident" id="5117360">ProtoAtLeast</span><span class="op" id="5117372">(</span><span class="num" id="5117373">1</span><span class="op" id="5117374">,</span>&nbsp;<span class="num" id="5117376">1</span><span class="op" id="5117377">)</span>&nbsp;<span class="op" id="5117379">||</span>&nbsp;<span class="ident" id="5117382">w</span><span class="op" id="5117383">.</span><span class="ident" id="5117384">req</span><span class="op" id="5117387">.</span><span class="ident" id="5117388">wantsClose</span><span class="op" id="5117398">(</span><span class="op" id="5117399">)</span>&nbsp;<span class="op" id="5117401">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117405">w</span><span class="op" id="5117406">.</span><span class="ident" id="5117407">closeAfterReply</span>&nbsp;<span class="op" id="5117423">=</span>&nbsp;<span class="builtintype" id="5117425">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117435">if</span>&nbsp;<span class="ident" id="5117438">header</span><span class="op" id="5117444">.</span><span class="ident" id="5117445">get</span><span class="op" id="5117448">(</span><span class="string" id="5117449">&#34;Connection&#34;</span><span class="op" id="5117461">)</span>&nbsp;<span class="op" id="5117463">==</span>&nbsp;<span class="string" id="5117466">&#34;close&#34;</span>&nbsp;<span class="op" id="5117474">||</span>&nbsp;<span class="op" id="5117477">!</span><span class="ident" id="5117478">keepAlivesEnabled</span>&nbsp;<span class="op" id="5117496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117500">w</span><span class="op" id="5117501">.</span><span class="ident" id="5117502">closeAfterReply</span>&nbsp;<span class="op" id="5117518">=</span>&nbsp;<span class="builtintype" id="5117520">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5117526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5117530">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5117590">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5117651">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5117712">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117763">if</span>&nbsp;<span class="ident" id="5117766">w</span><span class="op" id="5117767">.</span><span class="ident" id="5117768">req</span><span class="op" id="5117771">.</span><span class="ident" id="5117772">ContentLength</span>&nbsp;<span class="op" id="5117786">!=</span>&nbsp;<span class="num" id="5117789">0</span>&nbsp;<span class="op" id="5117791">&amp;&amp;</span>&nbsp;<span class="op" id="5117794">!</span><span class="ident" id="5117795">w</span><span class="op" id="5117796">.</span><span class="ident" id="5117797">closeAfterReply</span>&nbsp;<span class="op" id="5117813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117817">ecr</span><span class="op" id="5117820">,</span>&nbsp;<span class="ident" id="5117822">isExpecter</span>&nbsp;<span class="op" id="5117833">:=</span>&nbsp;<span class="ident" id="5117836">w</span><span class="op" id="5117837">.</span><span class="ident" id="5117838">req</span><span class="op" id="5117841">.</span><span class="ident" id="5117842">Body</span><span class="op" id="5117846">.</span><span class="op" id="5117847">(</span><span class="op" id="5117848">*</span><span class="ident" id="5117849">expectContinueReader</span><span class="op" id="5117869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117873">if</span>&nbsp;<span class="op" id="5117876">!</span><span class="ident" id="5117877">isExpecter</span>&nbsp;<span class="op" id="5117888">||</span>&nbsp;<span class="ident" id="5117891">ecr</span><span class="op" id="5117894">.</span><span class="ident" id="5117895">resp</span><span class="op" id="5117899">.</span><span class="ident" id="5117900">wroteContinue</span>&nbsp;<span class="op" id="5117914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5117919">n</span><span class="op" id="5117920">,</span>&nbsp;<span class="ident" id="5117922">_</span>&nbsp;<span class="op" id="5117924">:=</span>&nbsp;<span class="ident" id="5117927">io</span><span class="op" id="5117929">.</span><span class="ident" id="5117930">CopyN</span><span class="op" id="5117935">(</span><span class="ident" id="5117936">ioutil</span><span class="op" id="5117942">.</span><span class="ident" id="5117943">Discard</span><span class="op" id="5117950">,</span>&nbsp;<span class="ident" id="5117952">w</span><span class="op" id="5117953">.</span><span class="ident" id="5117954">req</span><span class="op" id="5117957">.</span><span class="ident" id="5117958">Body</span><span class="op" id="5117962">,</span>&nbsp;<span class="ident" id="5117964">maxPostHandlerReadBytes</span><span class="op" id="5117987">+</span><span class="num" id="5117988">1</span><span class="op" id="5117989">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5117994">if</span>&nbsp;<span class="ident" id="5117997">n</span>&nbsp;<span class="op" id="5117999">&gt;=</span>&nbsp;<span class="ident" id="5118002">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="5118026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118032">w</span><span class="op" id="5118033">.</span><span class="ident" id="5118034">requestTooLarge</span><span class="op" id="5118049">(</span><span class="op" id="5118050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118056">delHeader</span><span class="op" id="5118065">(</span><span class="string" id="5118066">&#34;Connection&#34;</span><span class="op" id="5118078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118084">setHeader</span><span class="op" id="5118093">.</span><span class="ident" id="5118094">connection</span>&nbsp;<span class="op" id="5118105">=</span>&nbsp;<span class="string" id="5118107">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118118">}</span>&nbsp;<span class="keyword" id="5118120">else</span>&nbsp;<span class="op" id="5118125">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118131">w</span><span class="op" id="5118132">.</span><span class="ident" id="5118133">req</span><span class="op" id="5118136">.</span><span class="ident" id="5118137">Body</span><span class="op" id="5118141">.</span><span class="ident" id="5118142">Close</span><span class="op" id="5118147">(</span><span class="op" id="5118148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118164">code</span>&nbsp;<span class="op" id="5118169">:=</span>&nbsp;<span class="ident" id="5118172">w</span><span class="op" id="5118173">.</span><span class="ident" id="5118174">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118182">if</span>&nbsp;<span class="ident" id="5118185">bodyAllowedForStatus</span><span class="op" id="5118205">(</span><span class="ident" id="5118206">code</span><span class="op" id="5118210">)</span>&nbsp;<span class="op" id="5118212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5118216">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118275">_</span><span class="op" id="5118276">,</span>&nbsp;<span class="ident" id="5118278">haveType</span>&nbsp;<span class="op" id="5118287">:=</span>&nbsp;<span class="ident" id="5118290">header</span><span class="op" id="5118296">[</span><span class="string" id="5118297">&#34;Content-Type&#34;</span><span class="op" id="5118311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118315">if</span>&nbsp;<span class="op" id="5118318">!</span><span class="ident" id="5118319">haveType</span>&nbsp;<span class="op" id="5118328">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118333">setHeader</span><span class="op" id="5118342">.</span><span class="ident" id="5118343">contentType</span>&nbsp;<span class="op" id="5118355">=</span>&nbsp;<span class="ident" id="5118357">DetectContentType</span><span class="op" id="5118374">(</span><span class="ident" id="5118375">p</span><span class="op" id="5118376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118383">}</span>&nbsp;<span class="keyword" id="5118385">else</span>&nbsp;<span class="op" id="5118390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118394">for</span>&nbsp;<span class="ident" id="5118398">_</span><span class="op" id="5118399">,</span>&nbsp;<span class="ident" id="5118401">k</span>&nbsp;<span class="op" id="5118403">:=</span>&nbsp;<span class="keyword" id="5118406">range</span>&nbsp;<span class="ident" id="5118412">suppressedHeaders</span><span class="op" id="5118429">(</span><span class="ident" id="5118430">code</span><span class="op" id="5118434">)</span>&nbsp;<span class="op" id="5118436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118441">delHeader</span><span class="op" id="5118450">(</span><span class="ident" id="5118451">k</span><span class="op" id="5118452">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118463">if</span>&nbsp;<span class="ident" id="5118466">_</span><span class="op" id="5118467">,</span>&nbsp;<span class="ident" id="5118469">ok</span>&nbsp;<span class="op" id="5118472">:=</span>&nbsp;<span class="ident" id="5118475">header</span><span class="op" id="5118481">[</span><span class="string" id="5118482">&#34;Date&#34;</span><span class="op" id="5118488">]</span><span class="op" id="5118489">;</span>&nbsp;<span class="op" id="5118491">!</span><span class="ident" id="5118492">ok</span>&nbsp;<span class="op" id="5118495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118499">setHeader</span><span class="op" id="5118508">.</span><span class="ident" id="5118509">date</span>&nbsp;<span class="op" id="5118514">=</span>&nbsp;<span class="ident" id="5118516">appendTime</span><span class="op" id="5118526">(</span><span class="ident" id="5118527">cw</span><span class="op" id="5118529">.</span><span class="ident" id="5118530">res</span><span class="op" id="5118533">.</span><span class="ident" id="5118534">dateBuf</span><span class="op" id="5118541">[</span><span class="op" id="5118542">:</span><span class="num" id="5118543">0</span><span class="op" id="5118544">]</span><span class="op" id="5118545">,</span>&nbsp;<span class="ident" id="5118547">time</span><span class="op" id="5118551">.</span><span class="ident" id="5118552">Now</span><span class="op" id="5118555">(</span><span class="op" id="5118556">)</span><span class="op" id="5118557">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118564">te</span>&nbsp;<span class="op" id="5118567">:=</span>&nbsp;<span class="ident" id="5118570">header</span><span class="op" id="5118576">.</span><span class="ident" id="5118577">get</span><span class="op" id="5118580">(</span><span class="string" id="5118581">&#34;Transfer-Encoding&#34;</span><span class="op" id="5118600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118603">hasTE</span>&nbsp;<span class="op" id="5118609">:=</span>&nbsp;<span class="ident" id="5118612">te</span>&nbsp;<span class="op" id="5118615">!=</span>&nbsp;<span class="string" id="5118618">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118622">if</span>&nbsp;<span class="ident" id="5118625">hasCL</span>&nbsp;<span class="op" id="5118631">&amp;&amp;</span>&nbsp;<span class="ident" id="5118634">hasTE</span>&nbsp;<span class="op" id="5118640">&amp;&amp;</span>&nbsp;<span class="ident" id="5118643">te</span>&nbsp;<span class="op" id="5118646">!=</span>&nbsp;<span class="string" id="5118649">&#34;identity&#34;</span>&nbsp;<span class="op" id="5118660">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5118664">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5118730">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118775">w</span><span class="op" id="5118776">.</span><span class="ident" id="5118777">conn</span><span class="op" id="5118781">.</span><span class="ident" id="5118782">server</span><span class="op" id="5118788">.</span><span class="ident" id="5118789">logf</span><span class="op" id="5118793">(</span><span class="string" id="5118794">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="5118881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118886">te</span><span class="op" id="5118888">,</span>&nbsp;<span class="ident" id="5118890">w</span><span class="op" id="5118891">.</span><span class="ident" id="5118892">contentLength</span><span class="op" id="5118905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118909">delHeader</span><span class="op" id="5118918">(</span><span class="string" id="5118919">&#34;Content-Length&#34;</span><span class="op" id="5118935">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5118939">hasCL</span>&nbsp;<span class="op" id="5118945">=</span>&nbsp;<span class="builtintype" id="5118947">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5118954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5118958">if</span>&nbsp;<span class="ident" id="5118961">w</span><span class="op" id="5118962">.</span><span class="ident" id="5118963">req</span><span class="op" id="5118966">.</span><span class="ident" id="5118967">Method</span>&nbsp;<span class="op" id="5118974">==</span>&nbsp;<span class="string" id="5118977">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5118984">||</span>&nbsp;<span class="op" id="5118987">!</span><span class="ident" id="5118988">bodyAllowedForStatus</span><span class="op" id="5119008">(</span><span class="ident" id="5119009">code</span><span class="op" id="5119013">)</span>&nbsp;<span class="op" id="5119015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119019">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119034">}</span>&nbsp;<span class="keyword" id="5119036">else</span>&nbsp;<span class="keyword" id="5119041">if</span>&nbsp;<span class="ident" id="5119044">code</span>&nbsp;<span class="op" id="5119049">==</span>&nbsp;<span class="ident" id="5119052">StatusNoContent</span>&nbsp;<span class="op" id="5119068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119072">delHeader</span><span class="op" id="5119081">(</span><span class="string" id="5119082">&#34;Transfer-Encoding&#34;</span><span class="op" id="5119101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119104">}</span>&nbsp;<span class="keyword" id="5119106">else</span>&nbsp;<span class="keyword" id="5119111">if</span>&nbsp;<span class="ident" id="5119114">hasCL</span>&nbsp;<span class="op" id="5119120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119124">delHeader</span><span class="op" id="5119133">(</span><span class="string" id="5119134">&#34;Transfer-Encoding&#34;</span><span class="op" id="5119153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119156">}</span>&nbsp;<span class="keyword" id="5119158">else</span>&nbsp;<span class="keyword" id="5119163">if</span>&nbsp;<span class="ident" id="5119166">w</span><span class="op" id="5119167">.</span><span class="ident" id="5119168">req</span><span class="op" id="5119171">.</span><span class="ident" id="5119172">ProtoAtLeast</span><span class="op" id="5119184">(</span><span class="num" id="5119185">1</span><span class="op" id="5119186">,</span>&nbsp;<span class="num" id="5119188">1</span><span class="op" id="5119189">)</span>&nbsp;<span class="op" id="5119191">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119195">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119273">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119352">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119424">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119496">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5119512">if</span>&nbsp;<span class="ident" id="5119515">hasTE</span>&nbsp;<span class="op" id="5119521">&amp;&amp;</span>&nbsp;<span class="ident" id="5119524">te</span>&nbsp;<span class="op" id="5119527">==</span>&nbsp;<span class="string" id="5119530">&#34;identity&#34;</span>&nbsp;<span class="op" id="5119541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119546">cw</span><span class="op" id="5119548">.</span><span class="ident" id="5119549">chunking</span>&nbsp;<span class="op" id="5119558">=</span>&nbsp;<span class="builtintype" id="5119560">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119569">w</span><span class="op" id="5119570">.</span><span class="ident" id="5119571">closeAfterReply</span>&nbsp;<span class="op" id="5119587">=</span>&nbsp;<span class="builtintype" id="5119589">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119596">}</span>&nbsp;<span class="keyword" id="5119598">else</span>&nbsp;<span class="op" id="5119603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119608">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119665">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119711">cw</span><span class="op" id="5119713">.</span><span class="ident" id="5119714">chunking</span>&nbsp;<span class="op" id="5119723">=</span>&nbsp;<span class="builtintype" id="5119725">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119733">setHeader</span><span class="op" id="5119742">.</span><span class="ident" id="5119743">transferEncoding</span>&nbsp;<span class="op" id="5119760">=</span>&nbsp;<span class="string" id="5119762">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5119777">}</span>&nbsp;<span class="keyword" id="5119779">else</span>&nbsp;<span class="op" id="5119784">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119788">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119840">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5119894">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119933">w</span><span class="op" id="5119934">.</span><span class="ident" id="5119935">closeAfterReply</span>&nbsp;<span class="op" id="5119951">=</span>&nbsp;<span class="builtintype" id="5119953">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5119960">delHeader</span><span class="op" id="5119969">(</span><span class="string" id="5119970">&#34;Transfer-Encoding&#34;</span><span class="op" id="5119989">)</span>&nbsp;<span class="comment" id="5119991">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5120019">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120086">if</span>&nbsp;<span class="ident" id="5120089">cw</span><span class="op" id="5120091">.</span><span class="ident" id="5120092">chunking</span>&nbsp;<span class="op" id="5120101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120105">delHeader</span><span class="op" id="5120114">(</span><span class="string" id="5120115">&#34;Content-Length&#34;</span><span class="op" id="5120131">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120137">if</span>&nbsp;<span class="op" id="5120140">!</span><span class="ident" id="5120141">w</span><span class="op" id="5120142">.</span><span class="ident" id="5120143">req</span><span class="op" id="5120146">.</span><span class="ident" id="5120147">ProtoAtLeast</span><span class="op" id="5120159">(</span><span class="num" id="5120160">1</span><span class="op" id="5120161">,</span>&nbsp;<span class="num" id="5120163">0</span><span class="op" id="5120164">)</span>&nbsp;<span class="op" id="5120166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120170">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120182">if</span>&nbsp;<span class="ident" id="5120185">w</span><span class="op" id="5120186">.</span><span class="ident" id="5120187">closeAfterReply</span>&nbsp;<span class="op" id="5120203">&amp;&amp;</span>&nbsp;<span class="op" id="5120206">(</span><span class="op" id="5120207">!</span><span class="ident" id="5120208">keepAlivesEnabled</span>&nbsp;<span class="op" id="5120226">||</span>&nbsp;<span class="op" id="5120229">!</span><span class="ident" id="5120230">hasToken</span><span class="op" id="5120238">(</span><span class="ident" id="5120239">cw</span><span class="op" id="5120241">.</span><span class="ident" id="5120242">header</span><span class="op" id="5120248">.</span><span class="ident" id="5120249">get</span><span class="op" id="5120252">(</span><span class="string" id="5120253">&#34;Connection&#34;</span><span class="op" id="5120265">)</span><span class="op" id="5120266">,</span>&nbsp;<span class="string" id="5120268">&#34;close&#34;</span><span class="op" id="5120275">)</span><span class="op" id="5120276">)</span>&nbsp;<span class="op" id="5120278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120282">delHeader</span><span class="op" id="5120291">(</span><span class="string" id="5120292">&#34;Connection&#34;</span><span class="op" id="5120304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5120308">if</span>&nbsp;<span class="ident" id="5120311">w</span><span class="op" id="5120312">.</span><span class="ident" id="5120313">req</span><span class="op" id="5120316">.</span><span class="ident" id="5120317">ProtoAtLeast</span><span class="op" id="5120329">(</span><span class="num" id="5120330">1</span><span class="op" id="5120331">,</span>&nbsp;<span class="num" id="5120333">1</span><span class="op" id="5120334">)</span>&nbsp;<span class="op" id="5120336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120341">setHeader</span><span class="op" id="5120350">.</span><span class="ident" id="5120351">connection</span>&nbsp;<span class="op" id="5120362">=</span>&nbsp;<span class="string" id="5120364">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120374">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5120377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120381">w</span><span class="op" id="5120382">.</span><span class="ident" id="5120383">conn</span><span class="op" id="5120387">.</span><span class="ident" id="5120388">buf</span><span class="op" id="5120391">.</span><span class="ident" id="5120392">WriteString</span><span class="op" id="5120403">(</span><span class="ident" id="5120404">statusLine</span><span class="op" id="5120414">(</span><span class="ident" id="5120415">w</span><span class="op" id="5120416">.</span><span class="ident" id="5120417">req</span><span class="op" id="5120420">,</span>&nbsp;<span class="ident" id="5120422">code</span><span class="op" id="5120426">)</span><span class="op" id="5120427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120430">cw</span><span class="op" id="5120432">.</span><span class="ident" id="5120433">header</span><span class="op" id="5120439">.</span><span class="ident" id="5120440">WriteSubset</span><span class="op" id="5120451">(</span><span class="ident" id="5120452">w</span><span class="op" id="5120453">.</span><span class="ident" id="5120454">conn</span><span class="op" id="5120458">.</span><span class="ident" id="5120459">buf</span><span class="op" id="5120462">,</span>&nbsp;<span class="ident" id="5120464">excludeHeader</span><span class="op" id="5120477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120480">setHeader</span><span class="op" id="5120489">.</span><span class="ident" id="5120490">Write</span><span class="op" id="5120495">(</span><span class="ident" id="5120496">w</span><span class="op" id="5120497">.</span><span class="ident" id="5120498">conn</span><span class="op" id="5120502">.</span><span class="ident" id="5120503">buf</span><span class="op" id="5120506">.</span><span class="ident" id="5120507">Writer</span><span class="op" id="5120513">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120516">w</span><span class="op" id="5120517">.</span><span class="ident" id="5120518">conn</span><span class="op" id="5120522">.</span><span class="ident" id="5120523">buf</span><span class="op" id="5120526">.</span><span class="ident" id="5120527">Write</span><span class="op" id="5120532">(</span><span class="ident" id="5120533">crlf</span><span class="op" id="5120537">)</span><br>
<span class="lineno"></span><span class="op" id="5120539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5120542">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="5120611">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="5120679">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="5120748">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="5120816">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="5120854">var</span>&nbsp;<span class="op" id="5120858">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120861">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5120873">sync</span><span class="op" id="5120877">.</span><span class="ident" id="5120878">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5120887">statusLines</span>&nbsp;<span class="op" id="5120899">=</span>&nbsp;<span class="builtinfunc" id="5120901">make</span><span class="op" id="5120905">(</span><span class="keyword" id="5120906">map</span><span class="op" id="5120909">[</span><span class="builtintype" id="5120910">int</span><span class="op" id="5120913">]</span><span class="builtintype" id="5120914">string</span><span class="op" id="5120920">)</span><br>
<span class="lineno"></span><span class="op" id="5120922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5120925">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="5120993">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="5121044">func</span>&nbsp;<span class="ident" id="5121049">statusLine</span><span class="op" id="5121059">(</span><span class="ident" id="5121060">req</span>&nbsp;<span class="op" id="5121064">*</span><span class="ident" id="5121065">Request</span><span class="op" id="5121072">,</span>&nbsp;<span class="ident" id="5121074">code</span>&nbsp;<span class="builtintype" id="5121079">int</span><span class="op" id="5121082">)</span>&nbsp;<span class="builtintype" id="5121084">string</span>&nbsp;<span class="op" id="5121091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121094">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121109">key</span>&nbsp;<span class="op" id="5121113">:=</span>&nbsp;<span class="ident" id="5121116">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121122">proto11</span>&nbsp;<span class="op" id="5121130">:=</span>&nbsp;<span class="ident" id="5121133">req</span><span class="op" id="5121136">.</span><span class="ident" id="5121137">ProtoAtLeast</span><span class="op" id="5121149">(</span><span class="num" id="5121150">1</span><span class="op" id="5121151">,</span>&nbsp;<span class="num" id="5121153">1</span><span class="op" id="5121154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121157">if</span>&nbsp;<span class="op" id="5121160">!</span><span class="ident" id="5121161">proto11</span>&nbsp;<span class="op" id="5121169">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121173">key</span>&nbsp;<span class="op" id="5121177">=</span>&nbsp;<span class="op" id="5121179">-</span><span class="ident" id="5121180">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121188">statusMu</span><span class="op" id="5121196">.</span><span class="ident" id="5121197">RLock</span><span class="op" id="5121202">(</span><span class="op" id="5121203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121206">line</span><span class="op" id="5121210">,</span>&nbsp;<span class="ident" id="5121212">ok</span>&nbsp;<span class="op" id="5121215">:=</span>&nbsp;<span class="ident" id="5121218">statusLines</span><span class="op" id="5121229">[</span><span class="ident" id="5121230">key</span><span class="op" id="5121233">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121236">statusMu</span><span class="op" id="5121244">.</span><span class="ident" id="5121245">RUnlock</span><span class="op" id="5121252">(</span><span class="op" id="5121253">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121256">if</span>&nbsp;<span class="ident" id="5121259">ok</span>&nbsp;<span class="op" id="5121262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121266">return</span>&nbsp;<span class="ident" id="5121273">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5121283">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121298">proto</span>&nbsp;<span class="op" id="5121304">:=</span>&nbsp;<span class="string" id="5121307">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121319">if</span>&nbsp;<span class="ident" id="5121322">proto11</span>&nbsp;<span class="op" id="5121330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121334">proto</span>&nbsp;<span class="op" id="5121340">=</span>&nbsp;<span class="string" id="5121342">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121357">codestring</span>&nbsp;<span class="op" id="5121368">:=</span>&nbsp;<span class="ident" id="5121371">strconv</span><span class="op" id="5121378">.</span><span class="ident" id="5121379">Itoa</span><span class="op" id="5121383">(</span><span class="ident" id="5121384">code</span><span class="op" id="5121388">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121391">text</span><span class="op" id="5121395">,</span>&nbsp;<span class="ident" id="5121397">ok</span>&nbsp;<span class="op" id="5121400">:=</span>&nbsp;<span class="ident" id="5121403">statusText</span><span class="op" id="5121413">[</span><span class="ident" id="5121414">code</span><span class="op" id="5121418">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121421">if</span>&nbsp;<span class="op" id="5121424">!</span><span class="ident" id="5121425">ok</span>&nbsp;<span class="op" id="5121428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121432">text</span>&nbsp;<span class="op" id="5121437">=</span>&nbsp;<span class="string" id="5121439">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="5121454">+</span>&nbsp;<span class="ident" id="5121456">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121471">line</span>&nbsp;<span class="op" id="5121476">=</span>&nbsp;<span class="ident" id="5121478">proto</span>&nbsp;<span class="op" id="5121484">+</span>&nbsp;<span class="string" id="5121486">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5121490">+</span>&nbsp;<span class="ident" id="5121492">codestring</span>&nbsp;<span class="op" id="5121503">+</span>&nbsp;<span class="string" id="5121505">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5121509">+</span>&nbsp;<span class="ident" id="5121511">text</span>&nbsp;<span class="op" id="5121516">+</span>&nbsp;<span class="string" id="5121518">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121526">if</span>&nbsp;<span class="ident" id="5121529">ok</span>&nbsp;<span class="op" id="5121532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121536">statusMu</span><span class="op" id="5121544">.</span><span class="ident" id="5121545">Lock</span><span class="op" id="5121549">(</span><span class="op" id="5121550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121554">defer</span>&nbsp;<span class="ident" id="5121560">statusMu</span><span class="op" id="5121568">.</span><span class="ident" id="5121569">Unlock</span><span class="op" id="5121575">(</span><span class="op" id="5121576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5121580">statusLines</span><span class="op" id="5121591">[</span><span class="ident" id="5121592">key</span><span class="op" id="5121595">]</span>&nbsp;<span class="op" id="5121597">=</span>&nbsp;<span class="ident" id="5121599">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121605">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121608">return</span>&nbsp;<span class="ident" id="5121615">line</span><br>
<span class="lineno"></span><span class="op" id="5121620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5121623">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5121697">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="5121762">func</span>&nbsp;<span class="op" id="5121767">(</span><span class="ident" id="5121768">w</span>&nbsp;<span class="op" id="5121770">*</span><span class="ident" id="5121771">response</span><span class="op" id="5121779">)</span>&nbsp;<span class="ident" id="5121781">bodyAllowed</span><span class="op" id="5121792">(</span><span class="op" id="5121793">)</span>&nbsp;<span class="builtintype" id="5121795">bool</span>&nbsp;<span class="op" id="5121800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121803">if</span>&nbsp;<span class="op" id="5121806">!</span><span class="ident" id="5121807">w</span><span class="op" id="5121808">.</span><span class="ident" id="5121809">wroteHeader</span>&nbsp;<span class="op" id="5121821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5121825">panic</span><span class="op" id="5121830">(</span><span class="string" id="5121831">&#34;&#34;</span><span class="op" id="5121833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5121836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5121839">return</span>&nbsp;<span class="ident" id="5121846">bodyAllowedForStatus</span><span class="op" id="5121866">(</span><span class="ident" id="5121867">w</span><span class="op" id="5121868">.</span><span class="ident" id="5121869">status</span><span class="op" id="5121875">)</span><br>
<span class="lineno">940</span><span class="op" id="5121877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5121880">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="5121917">//</span><br>
<span class="lineno"></span><span class="comment" id="5121920">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="5121987">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="5122062">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5122106">//</span><br>
<span class="lineno"></span><span class="comment" id="5122109">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="5122179">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="5122247">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5122318">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="5122344">//</span><br>
<span class="lineno"></span><span class="comment" id="5122347">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5122416">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="5122453">//</span><br>
<span class="lineno"></span><span class="comment" id="5122456">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="5122496">//</span><br>
<span class="lineno"></span><span class="comment" id="5122499">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="5122539">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="5122610">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="5122685">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="5122738">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="5122807">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="5122877">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="5122944">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="5122973">//</span><br>
<span class="lineno"></span><span class="comment" id="5122976">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5123040">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="5123107">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="5123175">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="5123240">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5123310">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="5123379">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="5123450">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="5123521">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5123543">func</span>&nbsp;<span class="op" id="5123548">(</span><span class="ident" id="5123549">w</span>&nbsp;<span class="op" id="5123551">*</span><span class="ident" id="5123552">response</span><span class="op" id="5123560">)</span>&nbsp;<span class="ident" id="5123562">Write</span><span class="op" id="5123567">(</span><span class="ident" id="5123568">data</span>&nbsp;<span class="op" id="5123573">[</span><span class="op" id="5123574">]</span><span class="builtintype" id="5123575">byte</span><span class="op" id="5123579">)</span>&nbsp;<span class="op" id="5123581">(</span><span class="ident" id="5123582">n</span>&nbsp;<span class="builtintype" id="5123584">int</span><span class="op" id="5123587">,</span>&nbsp;<span class="ident" id="5123589">err</span>&nbsp;<span class="builtintype" id="5123593">error</span><span class="op" id="5123598">)</span>&nbsp;<span class="op" id="5123600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123603">return</span>&nbsp;<span class="ident" id="5123610">w</span><span class="op" id="5123611">.</span><span class="ident" id="5123612">write</span><span class="op" id="5123617">(</span><span class="builtinfunc" id="5123618">len</span><span class="op" id="5123621">(</span><span class="ident" id="5123622">data</span><span class="op" id="5123626">)</span><span class="op" id="5123627">,</span>&nbsp;<span class="ident" id="5123629">data</span><span class="op" id="5123633">,</span>&nbsp;<span class="string" id="5123635">&#34;&#34;</span><span class="op" id="5123637">)</span><br>
<span class="lineno"></span><span class="op" id="5123639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="5123642">func</span>&nbsp;<span class="op" id="5123647">(</span><span class="ident" id="5123648">w</span>&nbsp;<span class="op" id="5123650">*</span><span class="ident" id="5123651">response</span><span class="op" id="5123659">)</span>&nbsp;<span class="ident" id="5123661">WriteString</span><span class="op" id="5123672">(</span><span class="ident" id="5123673">data</span>&nbsp;<span class="builtintype" id="5123678">string</span><span class="op" id="5123684">)</span>&nbsp;<span class="op" id="5123686">(</span><span class="ident" id="5123687">n</span>&nbsp;<span class="builtintype" id="5123689">int</span><span class="op" id="5123692">,</span>&nbsp;<span class="ident" id="5123694">err</span>&nbsp;<span class="builtintype" id="5123698">error</span><span class="op" id="5123703">)</span>&nbsp;<span class="op" id="5123705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123708">return</span>&nbsp;<span class="ident" id="5123715">w</span><span class="op" id="5123716">.</span><span class="ident" id="5123717">write</span><span class="op" id="5123722">(</span><span class="builtinfunc" id="5123723">len</span><span class="op" id="5123726">(</span><span class="ident" id="5123727">data</span><span class="op" id="5123731">)</span><span class="op" id="5123732">,</span>&nbsp;<span class="ident" id="5123734">nil</span><span class="op" id="5123737">,</span>&nbsp;<span class="ident" id="5123739">data</span><span class="op" id="5123743">)</span><br>
<span class="lineno"></span><span class="op" id="5123745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5123748">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="5123786">func</span>&nbsp;<span class="op" id="5123791">(</span><span class="ident" id="5123792">w</span>&nbsp;<span class="op" id="5123794">*</span><span class="ident" id="5123795">response</span><span class="op" id="5123803">)</span>&nbsp;<span class="ident" id="5123805">write</span><span class="op" id="5123810">(</span><span class="ident" id="5123811">lenData</span>&nbsp;<span class="builtintype" id="5123819">int</span><span class="op" id="5123822">,</span>&nbsp;<span class="ident" id="5123824">dataB</span>&nbsp;<span class="op" id="5123830">[</span><span class="op" id="5123831">]</span><span class="builtintype" id="5123832">byte</span><span class="op" id="5123836">,</span>&nbsp;<span class="ident" id="5123838">dataS</span>&nbsp;<span class="builtintype" id="5123844">string</span><span class="op" id="5123850">)</span>&nbsp;<span class="op" id="5123852">(</span><span class="ident" id="5123853">n</span>&nbsp;<span class="builtintype" id="5123855">int</span><span class="op" id="5123858">,</span>&nbsp;<span class="ident" id="5123860">err</span>&nbsp;<span class="builtintype" id="5123864">error</span><span class="op" id="5123869">)</span>&nbsp;<span class="op" id="5123871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123874">if</span>&nbsp;<span class="ident" id="5123877">w</span><span class="op" id="5123878">.</span><span class="ident" id="5123879">conn</span><span class="op" id="5123883">.</span><span class="ident" id="5123884">hijacked</span><span class="op" id="5123892">(</span><span class="op" id="5123893">)</span>&nbsp;<span class="op" id="5123895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5123899">w</span><span class="op" id="5123900">.</span><span class="ident" id="5123901">conn</span><span class="op" id="5123905">.</span><span class="ident" id="5123906">server</span><span class="op" id="5123912">.</span><span class="ident" id="5123913">logf</span><span class="op" id="5123917">(</span><span class="string" id="5123918">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="5123963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123967">return</span>&nbsp;<span class="num" id="5123974">0</span><span class="op" id="5123975">,</span>&nbsp;<span class="ident" id="5123977">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5123990">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5123993">if</span>&nbsp;<span class="op" id="5123996">!</span><span class="ident" id="5123997">w</span><span class="op" id="5123998">.</span><span class="ident" id="5123999">wroteHeader</span>&nbsp;<span class="op" id="5124011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124015">w</span><span class="op" id="5124016">.</span><span class="ident" id="5124017">WriteHeader</span><span class="op" id="5124028">(</span><span class="ident" id="5124029">StatusOK</span><span class="op" id="5124037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124043">if</span>&nbsp;<span class="ident" id="5124046">lenData</span>&nbsp;<span class="op" id="5124054">==</span>&nbsp;<span class="num" id="5124057">0</span>&nbsp;<span class="op" id="5124059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124063">return</span>&nbsp;<span class="num" id="5124070">0</span><span class="op" id="5124071">,</span>&nbsp;<span class="ident" id="5124073">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124081">if</span>&nbsp;<span class="op" id="5124084">!</span><span class="ident" id="5124085">w</span><span class="op" id="5124086">.</span><span class="ident" id="5124087">bodyAllowed</span><span class="op" id="5124098">(</span><span class="op" id="5124099">)</span>&nbsp;<span class="op" id="5124101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124105">return</span>&nbsp;<span class="num" id="5124112">0</span><span class="op" id="5124113">,</span>&nbsp;<span class="ident" id="5124115">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124138">w</span><span class="op" id="5124139">.</span><span class="ident" id="5124140">written</span>&nbsp;<span class="op" id="5124148">+=</span>&nbsp;<span class="ident" id="5124151">int64</span><span class="op" id="5124156">(</span><span class="ident" id="5124157">lenData</span><span class="op" id="5124164">)</span>&nbsp;<span class="comment" id="5124166">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124203">if</span>&nbsp;<span class="ident" id="5124206">w</span><span class="op" id="5124207">.</span><span class="ident" id="5124208">contentLength</span>&nbsp;<span class="op" id="5124222">!=</span>&nbsp;<span class="op" id="5124225">-</span><span class="num" id="5124226">1</span>&nbsp;<span class="op" id="5124228">&amp;&amp;</span>&nbsp;<span class="ident" id="5124231">w</span><span class="op" id="5124232">.</span><span class="ident" id="5124233">written</span>&nbsp;<span class="op" id="5124241">&gt;</span>&nbsp;<span class="ident" id="5124243">w</span><span class="op" id="5124244">.</span><span class="ident" id="5124245">contentLength</span>&nbsp;<span class="op" id="5124259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124263">return</span>&nbsp;<span class="num" id="5124270">0</span><span class="op" id="5124271">,</span>&nbsp;<span class="ident" id="5124273">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124294">if</span>&nbsp;<span class="ident" id="5124297">dataB</span>&nbsp;<span class="op" id="5124303">!=</span>&nbsp;<span class="ident" id="5124306">nil</span>&nbsp;<span class="op" id="5124310">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124314">return</span>&nbsp;<span class="ident" id="5124321">w</span><span class="op" id="5124322">.</span><span class="ident" id="5124323">w</span><span class="op" id="5124324">.</span><span class="ident" id="5124325">Write</span><span class="op" id="5124330">(</span><span class="ident" id="5124331">dataB</span><span class="op" id="5124336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124339">}</span>&nbsp;<span class="keyword" id="5124341">else</span>&nbsp;<span class="op" id="5124346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124350">return</span>&nbsp;<span class="ident" id="5124357">w</span><span class="op" id="5124358">.</span><span class="ident" id="5124359">w</span><span class="op" id="5124360">.</span><span class="ident" id="5124361">WriteString</span><span class="op" id="5124372">(</span><span class="ident" id="5124373">dataS</span><span class="op" id="5124378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124381">}</span><br>
<span class="lineno"></span><span class="op" id="5124383">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="5124386">func</span>&nbsp;<span class="op" id="5124391">(</span><span class="ident" id="5124392">w</span>&nbsp;<span class="op" id="5124394">*</span><span class="ident" id="5124395">response</span><span class="op" id="5124403">)</span>&nbsp;<span class="ident" id="5124405">finishRequest</span><span class="op" id="5124418">(</span><span class="op" id="5124419">)</span>&nbsp;<span class="op" id="5124421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124424">w</span><span class="op" id="5124425">.</span><span class="ident" id="5124426">handlerDone</span>&nbsp;<span class="op" id="5124438">=</span>&nbsp;<span class="builtintype" id="5124440">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124447">if</span>&nbsp;<span class="op" id="5124450">!</span><span class="ident" id="5124451">w</span><span class="op" id="5124452">.</span><span class="ident" id="5124453">wroteHeader</span>&nbsp;<span class="op" id="5124465">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124469">w</span><span class="op" id="5124470">.</span><span class="ident" id="5124471">WriteHeader</span><span class="op" id="5124482">(</span><span class="ident" id="5124483">StatusOK</span><span class="op" id="5124491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124498">w</span><span class="op" id="5124499">.</span><span class="ident" id="5124500">w</span><span class="op" id="5124501">.</span><span class="ident" id="5124502">Flush</span><span class="op" id="5124507">(</span><span class="op" id="5124508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124511">putBufioWriter</span><span class="op" id="5124525">(</span><span class="ident" id="5124526">w</span><span class="op" id="5124527">.</span><span class="ident" id="5124528">w</span><span class="op" id="5124529">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124532">w</span><span class="op" id="5124533">.</span><span class="ident" id="5124534">cw</span><span class="op" id="5124536">.</span><span class="builtinfunc" id="5124537">close</span><span class="op" id="5124542">(</span><span class="op" id="5124543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124546">w</span><span class="op" id="5124547">.</span><span class="ident" id="5124548">conn</span><span class="op" id="5124552">.</span><span class="ident" id="5124553">buf</span><span class="op" id="5124556">.</span><span class="ident" id="5124557">Flush</span><span class="op" id="5124562">(</span><span class="op" id="5124563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5124567">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5124630">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124672">w</span><span class="op" id="5124673">.</span><span class="ident" id="5124674">req</span><span class="op" id="5124677">.</span><span class="ident" id="5124678">Body</span><span class="op" id="5124682">.</span><span class="ident" id="5124683">Close</span><span class="op" id="5124688">(</span><span class="op" id="5124689">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124693">if</span>&nbsp;<span class="ident" id="5124696">w</span><span class="op" id="5124697">.</span><span class="ident" id="5124698">req</span><span class="op" id="5124701">.</span><span class="ident" id="5124702">MultipartForm</span>&nbsp;<span class="op" id="5124716">!=</span>&nbsp;<span class="ident" id="5124719">nil</span>&nbsp;<span class="op" id="5124723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124727">w</span><span class="op" id="5124728">.</span><span class="ident" id="5124729">req</span><span class="op" id="5124732">.</span><span class="ident" id="5124733">MultipartForm</span><span class="op" id="5124746">.</span><span class="ident" id="5124747">RemoveAll</span><span class="op" id="5124756">(</span><span class="op" id="5124757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124760">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5124764">if</span>&nbsp;<span class="ident" id="5124767">w</span><span class="op" id="5124768">.</span><span class="ident" id="5124769">req</span><span class="op" id="5124772">.</span><span class="ident" id="5124773">Method</span>&nbsp;<span class="op" id="5124780">!=</span>&nbsp;<span class="string" id="5124783">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5124790">&amp;&amp;</span>&nbsp;<span class="ident" id="5124793">w</span><span class="op" id="5124794">.</span><span class="ident" id="5124795">contentLength</span>&nbsp;<span class="op" id="5124809">!=</span>&nbsp;<span class="op" id="5124812">-</span><span class="num" id="5124813">1</span>&nbsp;<span class="op" id="5124815">&amp;&amp;</span>&nbsp;<span class="ident" id="5124818">w</span><span class="op" id="5124819">.</span><span class="ident" id="5124820">bodyAllowed</span><span class="op" id="5124831">(</span><span class="op" id="5124832">)</span>&nbsp;<span class="op" id="5124834">&amp;&amp;</span>&nbsp;<span class="ident" id="5124837">w</span><span class="op" id="5124838">.</span><span class="ident" id="5124839">contentLength</span>&nbsp;<span class="op" id="5124853">!=</span>&nbsp;<span class="ident" id="5124856">w</span><span class="op" id="5124857">.</span><span class="ident" id="5124858">written</span>&nbsp;<span class="op" id="5124866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5124870">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5124924">w</span><span class="op" id="5124925">.</span><span class="ident" id="5124926">closeAfterReply</span>&nbsp;<span class="op" id="5124942">=</span>&nbsp;<span class="builtintype" id="5124944">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5124950">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5124954">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5125016">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5125067">if</span>&nbsp;<span class="ident" id="5125070">w</span><span class="op" id="5125071">.</span><span class="ident" id="5125072">conn</span><span class="op" id="5125076">.</span><span class="ident" id="5125077">werr</span>&nbsp;<span class="op" id="5125082">!=</span>&nbsp;<span class="ident" id="5125085">nil</span>&nbsp;<span class="op" id="5125089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125093">w</span><span class="op" id="5125094">.</span><span class="ident" id="5125095">closeAfterReply</span>&nbsp;<span class="op" id="5125111">=</span>&nbsp;<span class="builtintype" id="5125113">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5125119">}</span><br>
<span class="lineno"></span><span class="op" id="5125121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5125124">func</span>&nbsp;<span class="op" id="5125129">(</span><span class="ident" id="5125130">w</span>&nbsp;<span class="op" id="5125132">*</span><span class="ident" id="5125133">response</span><span class="op" id="5125141">)</span>&nbsp;<span class="ident" id="5125143">Flush</span><span class="op" id="5125148">(</span><span class="op" id="5125149">)</span>&nbsp;<span class="op" id="5125151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5125154">if</span>&nbsp;<span class="op" id="5125157">!</span><span class="ident" id="5125158">w</span><span class="op" id="5125159">.</span><span class="ident" id="5125160">wroteHeader</span>&nbsp;<span class="op" id="5125172">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125176">w</span><span class="op" id="5125177">.</span><span class="ident" id="5125178">WriteHeader</span><span class="op" id="5125189">(</span><span class="ident" id="5125190">StatusOK</span><span class="op" id="5125198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5125201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125204">w</span><span class="op" id="5125205">.</span><span class="ident" id="5125206">w</span><span class="op" id="5125207">.</span><span class="ident" id="5125208">Flush</span><span class="op" id="5125213">(</span><span class="op" id="5125214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125217">w</span><span class="op" id="5125218">.</span><span class="ident" id="5125219">cw</span><span class="op" id="5125221">.</span><span class="ident" id="5125222">flush</span><span class="op" id="5125227">(</span><span class="op" id="5125228">)</span><br>
<span class="lineno"></span><span class="op" id="5125230">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="5125233">func</span>&nbsp;<span class="op" id="5125238">(</span><span class="ident" id="5125239">c</span>&nbsp;<span class="op" id="5125241">*</span><span class="ident" id="5125242">conn</span><span class="op" id="5125246">)</span>&nbsp;<span class="ident" id="5125248">finalFlush</span><span class="op" id="5125258">(</span><span class="op" id="5125259">)</span>&nbsp;<span class="op" id="5125261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5125264">if</span>&nbsp;<span class="ident" id="5125267">c</span><span class="op" id="5125268">.</span><span class="ident" id="5125269">buf</span>&nbsp;<span class="op" id="5125273">!=</span>&nbsp;<span class="ident" id="5125276">nil</span>&nbsp;<span class="op" id="5125280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125284">c</span><span class="op" id="5125285">.</span><span class="ident" id="5125286">buf</span><span class="op" id="5125289">.</span><span class="ident" id="5125290">Flush</span><span class="op" id="5125295">(</span><span class="op" id="5125296">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5125301">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5125371">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125408">putBufioReader</span><span class="op" id="5125422">(</span><span class="ident" id="5125423">c</span><span class="op" id="5125424">.</span><span class="ident" id="5125425">buf</span><span class="op" id="5125428">.</span><span class="ident" id="5125429">Reader</span><span class="op" id="5125435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5125440">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5125510">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125547">putBufioWriter</span><span class="op" id="5125561">(</span><span class="ident" id="5125562">c</span><span class="op" id="5125563">.</span><span class="ident" id="5125564">buf</span><span class="op" id="5125567">.</span><span class="ident" id="5125568">Writer</span><span class="op" id="5125574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125579">c</span><span class="op" id="5125580">.</span><span class="ident" id="5125581">buf</span>&nbsp;<span class="op" id="5125585">=</span>&nbsp;<span class="ident" id="5125587">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5125592">}</span><br>
<span class="lineno">1065</span><span class="op" id="5125594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5125597">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5125622">func</span>&nbsp;<span class="op" id="5125627">(</span><span class="ident" id="5125628">c</span>&nbsp;<span class="op" id="5125630">*</span><span class="ident" id="5125631">conn</span><span class="op" id="5125635">)</span>&nbsp;<span class="builtinfunc" id="5125637">close</span><span class="op" id="5125642">(</span><span class="op" id="5125643">)</span>&nbsp;<span class="op" id="5125645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125648">c</span><span class="op" id="5125649">.</span><span class="ident" id="5125650">finalFlush</span><span class="op" id="5125660">(</span><span class="op" id="5125661">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5125664">if</span>&nbsp;<span class="ident" id="5125667">c</span><span class="op" id="5125668">.</span><span class="ident" id="5125669">rwc</span>&nbsp;<span class="op" id="5125673">!=</span>&nbsp;<span class="ident" id="5125676">nil</span>&nbsp;<span class="op" id="5125680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125684">c</span><span class="op" id="5125685">.</span><span class="ident" id="5125686">rwc</span><span class="op" id="5125689">.</span><span class="ident" id="5125690">Close</span><span class="op" id="5125695">(</span><span class="op" id="5125696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5125700">c</span><span class="op" id="5125701">.</span><span class="ident" id="5125702">rwc</span>&nbsp;<span class="op" id="5125706">=</span>&nbsp;<span class="ident" id="5125708">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5125713">}</span><br>
<span class="lineno"></span><span class="op" id="5125715">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="5125718">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5125788">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="5125856">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="5125925">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="5125996">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="5126049">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="5126114">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="5126182">const</span>&nbsp;<span class="ident" id="5126188">rstAvoidanceDelay</span>&nbsp;<span class="op" id="5126206">=</span>&nbsp;<span class="num" id="5126208">500</span>&nbsp;<span class="op" id="5126212">*</span>&nbsp;<span class="ident" id="5126214">time</span><span class="op" id="5126218">.</span><span class="ident" id="5126219">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="5126232">type</span>&nbsp;<span class="ident" id="5126237">closeWriter</span>&nbsp;<span class="keyword" id="5126249">interface</span>&nbsp;<span class="op" id="5126259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126262">CloseWrite</span><span class="op" id="5126272">(</span><span class="op" id="5126273">)</span>&nbsp;<span class="builtintype" id="5126275">error</span><br>
<span class="lineno"></span><span class="op" id="5126281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5126284">var</span>&nbsp;<span class="ident" id="5126288">_</span>&nbsp;<span class="ident" id="5126290">closeWriter</span>&nbsp;<span class="op" id="5126302">=</span>&nbsp;<span class="op" id="5126304">(</span><span class="op" id="5126305">*</span><span class="ident" id="5126306">net</span><span class="op" id="5126309">.</span><span class="ident" id="5126310">TCPConn</span><span class="op" id="5126317">)</span><span class="op" id="5126318">(</span><span class="ident" id="5126319">nil</span><span class="op" id="5126322">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="5126325">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="5126395">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5126465">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5126527">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="5126546">//</span><br>
<span class="lineno"></span><span class="comment" id="5126549">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="5126585">func</span>&nbsp;<span class="op" id="5126590">(</span><span class="ident" id="5126591">c</span>&nbsp;<span class="op" id="5126593">*</span><span class="ident" id="5126594">conn</span><span class="op" id="5126598">)</span>&nbsp;<span class="ident" id="5126600">closeWriteAndWait</span><span class="op" id="5126617">(</span><span class="op" id="5126618">)</span>&nbsp;<span class="op" id="5126620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126623">c</span><span class="op" id="5126624">.</span><span class="ident" id="5126625">finalFlush</span><span class="op" id="5126635">(</span><span class="op" id="5126636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126639">if</span>&nbsp;<span class="ident" id="5126642">tcp</span><span class="op" id="5126645">,</span>&nbsp;<span class="ident" id="5126647">ok</span>&nbsp;<span class="op" id="5126650">:=</span>&nbsp;<span class="ident" id="5126653">c</span><span class="op" id="5126654">.</span><span class="ident" id="5126655">rwc</span><span class="op" id="5126658">.</span><span class="op" id="5126659">(</span><span class="ident" id="5126660">closeWriter</span><span class="op" id="5126671">)</span><span class="op" id="5126672">;</span>&nbsp;<span class="ident" id="5126674">ok</span>&nbsp;<span class="op" id="5126677">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126681">tcp</span><span class="op" id="5126684">.</span><span class="ident" id="5126685">CloseWrite</span><span class="op" id="5126695">(</span><span class="op" id="5126696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5126699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5126702">time</span><span class="op" id="5126706">.</span><span class="ident" id="5126707">Sleep</span><span class="op" id="5126712">(</span><span class="ident" id="5126713">rstAvoidanceDelay</span><span class="op" id="5126730">)</span><br>
<span class="lineno"></span><span class="op" id="5126732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="5126735">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="5126799">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="5126868">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="5126926">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="5126946">func</span>&nbsp;<span class="ident" id="5126951">validNPN</span><span class="op" id="5126959">(</span><span class="ident" id="5126960">proto</span>&nbsp;<span class="builtintype" id="5126966">string</span><span class="op" id="5126972">)</span>&nbsp;<span class="builtintype" id="5126974">bool</span>&nbsp;<span class="op" id="5126979">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126982">switch</span>&nbsp;<span class="ident" id="5126989">proto</span>&nbsp;<span class="op" id="5126995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5126998">case</span>&nbsp;<span class="string" id="5127003">&#34;&#34;</span><span class="op" id="5127005">,</span>&nbsp;<span class="string" id="5127007">&#34;http/1.1&#34;</span><span class="op" id="5127017">,</span>&nbsp;<span class="string" id="5127019">&#34;http/1.0&#34;</span><span class="op" id="5127029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127033">return</span>&nbsp;<span class="builtintype" id="5127040">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127050">return</span>&nbsp;<span class="builtintype" id="5127057">true</span><br>
<span class="lineno">1115</span><span class="op" id="5127062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5127065">func</span>&nbsp;<span class="op" id="5127070">(</span><span class="ident" id="5127071">c</span>&nbsp;<span class="op" id="5127073">*</span><span class="ident" id="5127074">conn</span><span class="op" id="5127078">)</span>&nbsp;<span class="ident" id="5127080">setState</span><span class="op" id="5127088">(</span><span class="ident" id="5127089">nc</span>&nbsp;<span class="ident" id="5127092">net</span><span class="op" id="5127095">.</span><span class="ident" id="5127096">Conn</span><span class="op" id="5127100">,</span>&nbsp;<span class="ident" id="5127102">state</span>&nbsp;<span class="ident" id="5127108">ConnState</span><span class="op" id="5127117">)</span>&nbsp;<span class="op" id="5127119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127122">if</span>&nbsp;<span class="ident" id="5127125">hook</span>&nbsp;<span class="op" id="5127130">:=</span>&nbsp;<span class="ident" id="5127133">c</span><span class="op" id="5127134">.</span><span class="ident" id="5127135">server</span><span class="op" id="5127141">.</span><span class="ident" id="5127142">ConnState</span><span class="op" id="5127151">;</span>&nbsp;<span class="ident" id="5127153">hook</span>&nbsp;<span class="op" id="5127158">!=</span>&nbsp;<span class="ident" id="5127161">nil</span>&nbsp;<span class="op" id="5127165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127169">hook</span><span class="op" id="5127173">(</span><span class="ident" id="5127174">nc</span><span class="op" id="5127176">,</span>&nbsp;<span class="ident" id="5127178">state</span><span class="op" id="5127183">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127186">}</span><br>
<span class="lineno"></span><span class="op" id="5127188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5127191">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5127218">func</span>&nbsp;<span class="op" id="5127223">(</span><span class="ident" id="5127224">c</span>&nbsp;<span class="op" id="5127226">*</span><span class="ident" id="5127227">conn</span><span class="op" id="5127231">)</span>&nbsp;<span class="ident" id="5127233">serve</span><span class="op" id="5127238">(</span><span class="op" id="5127239">)</span>&nbsp;<span class="op" id="5127241">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127244">origConn</span>&nbsp;<span class="op" id="5127253">:=</span>&nbsp;<span class="ident" id="5127256">c</span><span class="op" id="5127257">.</span><span class="ident" id="5127258">rwc</span>&nbsp;<span class="comment" id="5127262">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127313">defer</span>&nbsp;<span class="keyword" id="5127319">func</span><span class="op" id="5127323">(</span><span class="op" id="5127324">)</span>&nbsp;<span class="op" id="5127326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127330">if</span>&nbsp;<span class="ident" id="5127333">err</span>&nbsp;<span class="op" id="5127337">:=</span>&nbsp;<span class="builtinfunc" id="5127340">recover</span><span class="op" id="5127347">(</span><span class="op" id="5127348">)</span><span class="op" id="5127349">;</span>&nbsp;<span class="ident" id="5127351">err</span>&nbsp;<span class="op" id="5127355">!=</span>&nbsp;<span class="ident" id="5127358">nil</span>&nbsp;<span class="op" id="5127362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127367">const</span>&nbsp;<span class="ident" id="5127373">size</span>&nbsp;<span class="op" id="5127378">=</span>&nbsp;<span class="num" id="5127380">64</span>&nbsp;<span class="op" id="5127383">&lt;&lt;</span>&nbsp;<span class="num" id="5127386">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127392">buf</span>&nbsp;<span class="op" id="5127396">:=</span>&nbsp;<span class="builtinfunc" id="5127399">make</span><span class="op" id="5127403">(</span><span class="op" id="5127404">[</span><span class="op" id="5127405">]</span><span class="builtintype" id="5127406">byte</span><span class="op" id="5127410">,</span>&nbsp;<span class="ident" id="5127412">size</span><span class="op" id="5127416">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127421">buf</span>&nbsp;<span class="op" id="5127425">=</span>&nbsp;<span class="ident" id="5127427">buf</span><span class="op" id="5127430">[</span><span class="op" id="5127431">:</span><span class="ident" id="5127432">runtime</span><span class="op" id="5127439">.</span><span class="ident" id="5127440">Stack</span><span class="op" id="5127445">(</span><span class="ident" id="5127446">buf</span><span class="op" id="5127449">,</span>&nbsp;<span class="builtintype" id="5127451">false</span><span class="op" id="5127456">)</span><span class="op" id="5127457">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127462">c</span><span class="op" id="5127463">.</span><span class="ident" id="5127464">server</span><span class="op" id="5127470">.</span><span class="ident" id="5127471">logf</span><span class="op" id="5127475">(</span><span class="string" id="5127476">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="5127508">,</span>&nbsp;<span class="ident" id="5127510">c</span><span class="op" id="5127511">.</span><span class="ident" id="5127512">remoteAddr</span><span class="op" id="5127522">,</span>&nbsp;<span class="ident" id="5127524">err</span><span class="op" id="5127527">,</span>&nbsp;<span class="ident" id="5127529">buf</span><span class="op" id="5127532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127540">if</span>&nbsp;<span class="op" id="5127543">!</span><span class="ident" id="5127544">c</span><span class="op" id="5127545">.</span><span class="ident" id="5127546">hijacked</span><span class="op" id="5127554">(</span><span class="op" id="5127555">)</span>&nbsp;<span class="op" id="5127557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127562">c</span><span class="op" id="5127563">.</span><span class="builtinfunc" id="5127564">close</span><span class="op" id="5127569">(</span><span class="op" id="5127570">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127575">c</span><span class="op" id="5127576">.</span><span class="ident" id="5127577">setState</span><span class="op" id="5127585">(</span><span class="ident" id="5127586">origConn</span><span class="op" id="5127594">,</span>&nbsp;<span class="ident" id="5127596">StateClosed</span><span class="op" id="5127607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127614">}</span><span class="op" id="5127615">(</span><span class="op" id="5127616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127620">if</span>&nbsp;<span class="ident" id="5127623">tlsConn</span><span class="op" id="5127630">,</span>&nbsp;<span class="ident" id="5127632">ok</span>&nbsp;<span class="op" id="5127635">:=</span>&nbsp;<span class="ident" id="5127638">c</span><span class="op" id="5127639">.</span><span class="ident" id="5127640">rwc</span><span class="op" id="5127643">.</span><span class="op" id="5127644">(</span><span class="op" id="5127645">*</span><span class="ident" id="5127646">tls</span><span class="op" id="5127649">.</span><span class="ident" id="5127650">Conn</span><span class="op" id="5127654">)</span><span class="op" id="5127655">;</span>&nbsp;<span class="ident" id="5127657">ok</span>&nbsp;<span class="op" id="5127660">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127664">if</span>&nbsp;<span class="ident" id="5127667">d</span>&nbsp;<span class="op" id="5127669">:=</span>&nbsp;<span class="ident" id="5127672">c</span><span class="op" id="5127673">.</span><span class="ident" id="5127674">server</span><span class="op" id="5127680">.</span><span class="ident" id="5127681">ReadTimeout</span><span class="op" id="5127692">;</span>&nbsp;<span class="ident" id="5127694">d</span>&nbsp;<span class="op" id="5127696">!=</span>&nbsp;<span class="num" id="5127699">0</span>&nbsp;<span class="op" id="5127701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127706">c</span><span class="op" id="5127707">.</span><span class="ident" id="5127708">rwc</span><span class="op" id="5127711">.</span><span class="ident" id="5127712">SetReadDeadline</span><span class="op" id="5127727">(</span><span class="ident" id="5127728">time</span><span class="op" id="5127732">.</span><span class="ident" id="5127733">Now</span><span class="op" id="5127736">(</span><span class="op" id="5127737">)</span><span class="op" id="5127738">.</span><span class="ident" id="5127739">Add</span><span class="op" id="5127742">(</span><span class="ident" id="5127743">d</span><span class="op" id="5127744">)</span><span class="op" id="5127745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127753">if</span>&nbsp;<span class="ident" id="5127756">d</span>&nbsp;<span class="op" id="5127758">:=</span>&nbsp;<span class="ident" id="5127761">c</span><span class="op" id="5127762">.</span><span class="ident" id="5127763">server</span><span class="op" id="5127769">.</span><span class="ident" id="5127770">WriteTimeout</span><span class="op" id="5127782">;</span>&nbsp;<span class="ident" id="5127784">d</span>&nbsp;<span class="op" id="5127786">!=</span>&nbsp;<span class="num" id="5127789">0</span>&nbsp;<span class="op" id="5127791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127796">c</span><span class="op" id="5127797">.</span><span class="ident" id="5127798">rwc</span><span class="op" id="5127801">.</span><span class="ident" id="5127802">SetWriteDeadline</span><span class="op" id="5127818">(</span><span class="ident" id="5127819">time</span><span class="op" id="5127823">.</span><span class="ident" id="5127824">Now</span><span class="op" id="5127827">(</span><span class="op" id="5127828">)</span><span class="op" id="5127829">.</span><span class="ident" id="5127830">Add</span><span class="op" id="5127833">(</span><span class="ident" id="5127834">d</span><span class="op" id="5127835">)</span><span class="op" id="5127836">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127844">if</span>&nbsp;<span class="ident" id="5127847">err</span>&nbsp;<span class="op" id="5127851">:=</span>&nbsp;<span class="ident" id="5127854">tlsConn</span><span class="op" id="5127861">.</span><span class="ident" id="5127862">Handshake</span><span class="op" id="5127871">(</span><span class="op" id="5127872">)</span><span class="op" id="5127873">;</span>&nbsp;<span class="ident" id="5127875">err</span>&nbsp;<span class="op" id="5127879">!=</span>&nbsp;<span class="ident" id="5127882">nil</span>&nbsp;<span class="op" id="5127886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127891">c</span><span class="op" id="5127892">.</span><span class="ident" id="5127893">server</span><span class="op" id="5127899">.</span><span class="ident" id="5127900">logf</span><span class="op" id="5127904">(</span><span class="string" id="5127905">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="5127944">,</span>&nbsp;<span class="ident" id="5127946">c</span><span class="op" id="5127947">.</span><span class="ident" id="5127948">rwc</span><span class="op" id="5127951">.</span><span class="ident" id="5127952">RemoteAddr</span><span class="op" id="5127962">(</span><span class="op" id="5127963">)</span><span class="op" id="5127964">,</span>&nbsp;<span class="ident" id="5127966">err</span><span class="op" id="5127969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127974">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5127983">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127987">c</span><span class="op" id="5127988">.</span><span class="ident" id="5127989">tlsState</span>&nbsp;<span class="op" id="5127998">=</span>&nbsp;<span class="builtinfunc" id="5128000">new</span><span class="op" id="5128003">(</span><span class="ident" id="5128004">tls</span><span class="op" id="5128007">.</span><span class="ident" id="5128008">ConnectionState</span><span class="op" id="5128023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128027">*</span><span class="ident" id="5128028">c</span><span class="op" id="5128029">.</span><span class="ident" id="5128030">tlsState</span>&nbsp;<span class="op" id="5128039">=</span>&nbsp;<span class="ident" id="5128041">tlsConn</span><span class="op" id="5128048">.</span><span class="ident" id="5128049">ConnectionState</span><span class="op" id="5128064">(</span><span class="op" id="5128065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128069">if</span>&nbsp;<span class="ident" id="5128072">proto</span>&nbsp;<span class="op" id="5128078">:=</span>&nbsp;<span class="ident" id="5128081">c</span><span class="op" id="5128082">.</span><span class="ident" id="5128083">tlsState</span><span class="op" id="5128091">.</span><span class="ident" id="5128092">NegotiatedProtocol</span><span class="op" id="5128110">;</span>&nbsp;<span class="ident" id="5128112">validNPN</span><span class="op" id="5128120">(</span><span class="ident" id="5128121">proto</span><span class="op" id="5128126">)</span>&nbsp;<span class="op" id="5128128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128133">if</span>&nbsp;<span class="ident" id="5128136">fn</span>&nbsp;<span class="op" id="5128139">:=</span>&nbsp;<span class="ident" id="5128142">c</span><span class="op" id="5128143">.</span><span class="ident" id="5128144">server</span><span class="op" id="5128150">.</span><span class="ident" id="5128151">TLSNextProto</span><span class="op" id="5128163">[</span><span class="ident" id="5128164">proto</span><span class="op" id="5128169">]</span><span class="op" id="5128170">;</span>&nbsp;<span class="ident" id="5128172">fn</span>&nbsp;<span class="op" id="5128175">!=</span>&nbsp;<span class="ident" id="5128178">nil</span>&nbsp;<span class="op" id="5128182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128188">h</span>&nbsp;<span class="op" id="5128190">:=</span>&nbsp;<span class="ident" id="5128193">initNPNRequest</span><span class="op" id="5128207">{</span><span class="ident" id="5128208">tlsConn</span><span class="op" id="5128215">,</span>&nbsp;<span class="ident" id="5128217">serverHandler</span><span class="op" id="5128230">{</span><span class="ident" id="5128231">c</span><span class="op" id="5128232">.</span><span class="ident" id="5128233">server</span><span class="op" id="5128239">}</span><span class="op" id="5128240">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128246">fn</span><span class="op" id="5128248">(</span><span class="ident" id="5128249">c</span><span class="op" id="5128250">.</span><span class="ident" id="5128251">server</span><span class="op" id="5128257">,</span>&nbsp;<span class="ident" id="5128259">tlsConn</span><span class="op" id="5128266">,</span>&nbsp;<span class="ident" id="5128268">h</span><span class="op" id="5128269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128279">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128291">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128295">for</span>&nbsp;<span class="op" id="5128299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128303">w</span><span class="op" id="5128304">,</span>&nbsp;<span class="ident" id="5128306">err</span>&nbsp;<span class="op" id="5128310">:=</span>&nbsp;<span class="ident" id="5128313">c</span><span class="op" id="5128314">.</span><span class="ident" id="5128315">readRequest</span><span class="op" id="5128326">(</span><span class="op" id="5128327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128331">if</span>&nbsp;<span class="ident" id="5128334">c</span><span class="op" id="5128335">.</span><span class="ident" id="5128336">lr</span><span class="op" id="5128338">.</span><span class="ident" id="5128339">N</span>&nbsp;<span class="op" id="5128341">!=</span>&nbsp;<span class="ident" id="5128344">c</span><span class="op" id="5128345">.</span><span class="ident" id="5128346">server</span><span class="op" id="5128352">.</span><span class="ident" id="5128353">initialLimitedReaderSize</span><span class="op" id="5128377">(</span><span class="op" id="5128378">)</span>&nbsp;<span class="op" id="5128380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5128385">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128440">c</span><span class="op" id="5128441">.</span><span class="ident" id="5128442">setState</span><span class="op" id="5128450">(</span><span class="ident" id="5128451">c</span><span class="op" id="5128452">.</span><span class="ident" id="5128453">rwc</span><span class="op" id="5128456">,</span>&nbsp;<span class="ident" id="5128458">StateActive</span><span class="op" id="5128469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128477">if</span>&nbsp;<span class="ident" id="5128480">err</span>&nbsp;<span class="op" id="5128484">!=</span>&nbsp;<span class="ident" id="5128487">nil</span>&nbsp;<span class="op" id="5128491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128496">if</span>&nbsp;<span class="ident" id="5128499">err</span>&nbsp;<span class="op" id="5128503">==</span>&nbsp;<span class="ident" id="5128506">errTooLarge</span>&nbsp;<span class="op" id="5128518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5128524">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5128567">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5128601">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5128642">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5128683">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128720">io</span><span class="op" id="5128722">.</span><span class="ident" id="5128723">WriteString</span><span class="op" id="5128734">(</span><span class="ident" id="5128735">c</span><span class="op" id="5128736">.</span><span class="ident" id="5128737">rwc</span><span class="op" id="5128740">,</span>&nbsp;<span class="string" id="5128742">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="5128789">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128795">c</span><span class="op" id="5128796">.</span><span class="ident" id="5128797">closeWriteAndWait</span><span class="op" id="5128814">(</span><span class="op" id="5128815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128821">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128830">}</span>&nbsp;<span class="keyword" id="5128832">else</span>&nbsp;<span class="keyword" id="5128837">if</span>&nbsp;<span class="ident" id="5128840">err</span>&nbsp;<span class="op" id="5128844">==</span>&nbsp;<span class="ident" id="5128847">io</span><span class="op" id="5128849">.</span><span class="ident" id="5128850">EOF</span>&nbsp;<span class="op" id="5128854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128860">break</span>&nbsp;<span class="comment" id="5128866">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128884">}</span>&nbsp;<span class="keyword" id="5128886">else</span>&nbsp;<span class="keyword" id="5128891">if</span>&nbsp;<span class="ident" id="5128894">neterr</span><span class="op" id="5128900">,</span>&nbsp;<span class="ident" id="5128902">ok</span>&nbsp;<span class="op" id="5128905">:=</span>&nbsp;<span class="ident" id="5128908">err</span><span class="op" id="5128911">.</span><span class="op" id="5128912">(</span><span class="ident" id="5128913">net</span><span class="op" id="5128916">.</span><span class="ident" id="5128917">Error</span><span class="op" id="5128922">)</span><span class="op" id="5128923">;</span>&nbsp;<span class="ident" id="5128925">ok</span>&nbsp;<span class="op" id="5128928">&amp;&amp;</span>&nbsp;<span class="ident" id="5128931">neterr</span><span class="op" id="5128937">.</span><span class="ident" id="5128938">Timeout</span><span class="op" id="5128945">(</span><span class="op" id="5128946">)</span>&nbsp;<span class="op" id="5128948">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128954">break</span>&nbsp;<span class="comment" id="5128960">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128983">io</span><span class="op" id="5128985">.</span><span class="ident" id="5128986">WriteString</span><span class="op" id="5128997">(</span><span class="ident" id="5128998">c</span><span class="op" id="5128999">.</span><span class="ident" id="5129000">rwc</span><span class="op" id="5129003">,</span>&nbsp;<span class="string" id="5129005">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="5129039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129044">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129052">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129057">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129090">req</span>&nbsp;<span class="op" id="5129094">:=</span>&nbsp;<span class="ident" id="5129097">w</span><span class="op" id="5129098">.</span><span class="ident" id="5129099">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129105">if</span>&nbsp;<span class="ident" id="5129108">req</span><span class="op" id="5129111">.</span><span class="ident" id="5129112">expectsContinue</span><span class="op" id="5129127">(</span><span class="op" id="5129128">)</span>&nbsp;<span class="op" id="5129130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129135">if</span>&nbsp;<span class="ident" id="5129138">req</span><span class="op" id="5129141">.</span><span class="ident" id="5129142">ProtoAtLeast</span><span class="op" id="5129154">(</span><span class="num" id="5129155">1</span><span class="op" id="5129156">,</span>&nbsp;<span class="num" id="5129158">1</span><span class="op" id="5129159">)</span>&nbsp;<span class="op" id="5129161">&amp;&amp;</span>&nbsp;<span class="ident" id="5129164">req</span><span class="op" id="5129167">.</span><span class="ident" id="5129168">ContentLength</span>&nbsp;<span class="op" id="5129182">!=</span>&nbsp;<span class="num" id="5129185">0</span>&nbsp;<span class="op" id="5129187">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129193">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129261">req</span><span class="op" id="5129264">.</span><span class="ident" id="5129265">Body</span>&nbsp;<span class="op" id="5129270">=</span>&nbsp;<span class="op" id="5129272">&amp;</span><span class="ident" id="5129273">expectContinueReader</span><span class="op" id="5129293">{</span><span class="ident" id="5129294">readCloser</span><span class="op" id="5129304">:</span>&nbsp;<span class="ident" id="5129306">req</span><span class="op" id="5129309">.</span><span class="ident" id="5129310">Body</span><span class="op" id="5129314">,</span>&nbsp;<span class="ident" id="5129316">resp</span><span class="op" id="5129320">:</span>&nbsp;<span class="ident" id="5129322">w</span><span class="op" id="5129323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129333">req</span><span class="op" id="5129336">.</span><span class="ident" id="5129337">Header</span><span class="op" id="5129343">.</span><span class="ident" id="5129344">Del</span><span class="op" id="5129347">(</span><span class="string" id="5129348">&#34;Expect&#34;</span><span class="op" id="5129356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129360">}</span>&nbsp;<span class="keyword" id="5129362">else</span>&nbsp;<span class="keyword" id="5129367">if</span>&nbsp;<span class="ident" id="5129370">req</span><span class="op" id="5129373">.</span><span class="ident" id="5129374">Header</span><span class="op" id="5129380">.</span><span class="ident" id="5129381">get</span><span class="op" id="5129384">(</span><span class="string" id="5129385">&#34;Expect&#34;</span><span class="op" id="5129393">)</span>&nbsp;<span class="op" id="5129395">!=</span>&nbsp;<span class="string" id="5129398">&#34;&#34;</span>&nbsp;<span class="op" id="5129401">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129406">w</span><span class="op" id="5129407">.</span><span class="ident" id="5129408">sendExpectationFailed</span><span class="op" id="5129429">(</span><span class="op" id="5129430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129435">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129448">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129512">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129582">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129642">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5129718">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129782">serverHandler</span><span class="op" id="5129795">{</span><span class="ident" id="5129796">c</span><span class="op" id="5129797">.</span><span class="ident" id="5129798">server</span><span class="op" id="5129804">}</span><span class="op" id="5129805">.</span><span class="ident" id="5129806">ServeHTTP</span><span class="op" id="5129815">(</span><span class="ident" id="5129816">w</span><span class="op" id="5129817">,</span>&nbsp;<span class="ident" id="5129819">w</span><span class="op" id="5129820">.</span><span class="ident" id="5129821">req</span><span class="op" id="5129824">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129828">if</span>&nbsp;<span class="ident" id="5129831">c</span><span class="op" id="5129832">.</span><span class="ident" id="5129833">hijacked</span><span class="op" id="5129841">(</span><span class="op" id="5129842">)</span>&nbsp;<span class="op" id="5129844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129849">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129862">w</span><span class="op" id="5129863">.</span><span class="ident" id="5129864">finishRequest</span><span class="op" id="5129877">(</span><span class="op" id="5129878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129882">if</span>&nbsp;<span class="ident" id="5129885">w</span><span class="op" id="5129886">.</span><span class="ident" id="5129887">closeAfterReply</span>&nbsp;<span class="op" id="5129903">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129908">if</span>&nbsp;<span class="ident" id="5129911">w</span><span class="op" id="5129912">.</span><span class="ident" id="5129913">requestBodyLimitHit</span>&nbsp;<span class="op" id="5129933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129939">c</span><span class="op" id="5129940">.</span><span class="ident" id="5129941">closeWriteAndWait</span><span class="op" id="5129958">(</span><span class="op" id="5129959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129969">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129977">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129981">c</span><span class="op" id="5129982">.</span><span class="ident" id="5129983">setState</span><span class="op" id="5129991">(</span><span class="ident" id="5129992">c</span><span class="op" id="5129993">.</span><span class="ident" id="5129994">rwc</span><span class="op" id="5129997">,</span>&nbsp;<span class="ident" id="5129999">StateIdle</span><span class="op" id="5130008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5130011">}</span><br>
<span class="lineno"></span><span class="op" id="5130013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5130016">func</span>&nbsp;<span class="op" id="5130021">(</span><span class="ident" id="5130022">w</span>&nbsp;<span class="op" id="5130024">*</span><span class="ident" id="5130025">response</span><span class="op" id="5130033">)</span>&nbsp;<span class="ident" id="5130035">sendExpectationFailed</span><span class="op" id="5130056">(</span><span class="op" id="5130057">)</span>&nbsp;<span class="op" id="5130059">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130062">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130112">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130165">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130215">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130265">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130305">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130349">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130353">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130407">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130457">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130504">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130552">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130605">w</span><span class="op" id="5130606">.</span><span class="ident" id="5130607">Header</span><span class="op" id="5130613">(</span><span class="op" id="5130614">)</span><span class="op" id="5130615">.</span><span class="ident" id="5130616">Set</span><span class="op" id="5130619">(</span><span class="string" id="5130620">&#34;Connection&#34;</span><span class="op" id="5130632">,</span>&nbsp;<span class="string" id="5130634">&#34;close&#34;</span><span class="op" id="5130641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130644">w</span><span class="op" id="5130645">.</span><span class="ident" id="5130646">WriteHeader</span><span class="op" id="5130657">(</span><span class="ident" id="5130658">StatusExpectationFailed</span><span class="op" id="5130681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130684">w</span><span class="op" id="5130685">.</span><span class="ident" id="5130686">finishRequest</span><span class="op" id="5130699">(</span><span class="op" id="5130700">)</span><br>
<span class="lineno">1235</span><span class="op" id="5130702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5130705">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="5130792">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="5130811">func</span>&nbsp;<span class="op" id="5130816">(</span><span class="ident" id="5130817">w</span>&nbsp;<span class="op" id="5130819">*</span><span class="ident" id="5130820">response</span><span class="op" id="5130828">)</span>&nbsp;<span class="ident" id="5130830">Hijack</span><span class="op" id="5130836">(</span><span class="op" id="5130837">)</span>&nbsp;<span class="op" id="5130839">(</span><span class="ident" id="5130840">rwc</span>&nbsp;<span class="ident" id="5130844">net</span><span class="op" id="5130847">.</span><span class="ident" id="5130848">Conn</span><span class="op" id="5130852">,</span>&nbsp;<span class="ident" id="5130854">buf</span>&nbsp;<span class="op" id="5130858">*</span><span class="ident" id="5130859">bufio</span><span class="op" id="5130864">.</span><span class="ident" id="5130865">ReadWriter</span><span class="op" id="5130875">,</span>&nbsp;<span class="ident" id="5130877">err</span>&nbsp;<span class="builtintype" id="5130881">error</span><span class="op" id="5130886">)</span>&nbsp;<span class="op" id="5130888">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130891">if</span>&nbsp;<span class="ident" id="5130894">w</span><span class="op" id="5130895">.</span><span class="ident" id="5130896">wroteHeader</span>&nbsp;<span class="op" id="5130908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130912">w</span><span class="op" id="5130913">.</span><span class="ident" id="5130914">cw</span><span class="op" id="5130916">.</span><span class="ident" id="5130917">flush</span><span class="op" id="5130922">(</span><span class="op" id="5130923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5130926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130929">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5131000">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131047">rwc</span><span class="op" id="5131050">,</span>&nbsp;<span class="ident" id="5131052">buf</span><span class="op" id="5131055">,</span>&nbsp;<span class="ident" id="5131057">err</span>&nbsp;<span class="op" id="5131061">=</span>&nbsp;<span class="ident" id="5131063">w</span><span class="op" id="5131064">.</span><span class="ident" id="5131065">conn</span><span class="op" id="5131069">.</span><span class="ident" id="5131070">hijack</span><span class="op" id="5131076">(</span><span class="op" id="5131077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131080">if</span>&nbsp;<span class="ident" id="5131083">err</span>&nbsp;<span class="op" id="5131087">==</span>&nbsp;<span class="ident" id="5131090">nil</span>&nbsp;<span class="op" id="5131094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131098">putBufioWriter</span><span class="op" id="5131112">(</span><span class="ident" id="5131113">w</span><span class="op" id="5131114">.</span><span class="ident" id="5131115">w</span><span class="op" id="5131116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131120">w</span><span class="op" id="5131121">.</span><span class="ident" id="5131122">w</span>&nbsp;<span class="op" id="5131124">=</span>&nbsp;<span class="ident" id="5131126">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131131">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131134">return</span>&nbsp;<span class="ident" id="5131141">rwc</span><span class="op" id="5131144">,</span>&nbsp;<span class="ident" id="5131146">buf</span><span class="op" id="5131149">,</span>&nbsp;<span class="ident" id="5131151">err</span><br>
<span class="lineno"></span><span class="op" id="5131155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5131158">func</span>&nbsp;<span class="op" id="5131163">(</span><span class="ident" id="5131164">w</span>&nbsp;<span class="op" id="5131166">*</span><span class="ident" id="5131167">response</span><span class="op" id="5131175">)</span>&nbsp;<span class="ident" id="5131177">CloseNotify</span><span class="op" id="5131188">(</span><span class="op" id="5131189">)</span>&nbsp;<span class="op" id="5131191">&lt;-</span><span class="keyword" id="5131193">chan</span>&nbsp;<span class="builtintype" id="5131198">bool</span>&nbsp;<span class="op" id="5131203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131206">return</span>&nbsp;<span class="ident" id="5131213">w</span><span class="op" id="5131214">.</span><span class="ident" id="5131215">conn</span><span class="op" id="5131219">.</span><span class="ident" id="5131220">closeNotify</span><span class="op" id="5131231">(</span><span class="op" id="5131232">)</span><br>
<span class="lineno">1255</span><span class="op" id="5131234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5131237">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5131295">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="5131355">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="5131410">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="5131442">type</span>&nbsp;<span class="ident" id="5131447">HandlerFunc</span>&nbsp;<span class="keyword" id="5131459">func</span><span class="op" id="5131463">(</span><span class="ident" id="5131464">ResponseWriter</span><span class="op" id="5131478">,</span>&nbsp;<span class="op" id="5131480">*</span><span class="ident" id="5131481">Request</span><span class="op" id="5131488">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5131491">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="5131519">func</span>&nbsp;<span class="op" id="5131524">(</span><span class="ident" id="5131525">f</span>&nbsp;<span class="ident" id="5131527">HandlerFunc</span><span class="op" id="5131538">)</span>&nbsp;<span class="ident" id="5131540">ServeHTTP</span><span class="op" id="5131549">(</span><span class="ident" id="5131550">w</span>&nbsp;<span class="ident" id="5131552">ResponseWriter</span><span class="op" id="5131566">,</span>&nbsp;<span class="ident" id="5131568">r</span>&nbsp;<span class="op" id="5131570">*</span><span class="ident" id="5131571">Request</span><span class="op" id="5131578">)</span>&nbsp;<span class="op" id="5131580">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131583">f</span><span class="op" id="5131584">(</span><span class="ident" id="5131585">w</span><span class="op" id="5131586">,</span>&nbsp;<span class="ident" id="5131588">r</span><span class="op" id="5131589">)</span><br>
<span class="lineno"></span><span class="op" id="5131591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5131594">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="5131614">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="5131694">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="5131737">func</span>&nbsp;<span class="ident" id="5131742">Error</span><span class="op" id="5131747">(</span><span class="ident" id="5131748">w</span>&nbsp;<span class="ident" id="5131750">ResponseWriter</span><span class="op" id="5131764">,</span>&nbsp;<span class="builtintype" id="5131766">error</span>&nbsp;<span class="builtintype" id="5131772">string</span><span class="op" id="5131778">,</span>&nbsp;<span class="ident" id="5131780">code</span>&nbsp;<span class="builtintype" id="5131785">int</span><span class="op" id="5131788">)</span>&nbsp;<span class="op" id="5131790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131793">w</span><span class="op" id="5131794">.</span><span class="ident" id="5131795">Header</span><span class="op" id="5131801">(</span><span class="op" id="5131802">)</span><span class="op" id="5131803">.</span><span class="ident" id="5131804">Set</span><span class="op" id="5131807">(</span><span class="string" id="5131808">&#34;Content-Type&#34;</span><span class="op" id="5131822">,</span>&nbsp;<span class="string" id="5131824">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5131851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131854">w</span><span class="op" id="5131855">.</span><span class="ident" id="5131856">WriteHeader</span><span class="op" id="5131867">(</span><span class="ident" id="5131868">code</span><span class="op" id="5131872">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131875">fmt</span><span class="op" id="5131878">.</span><span class="ident" id="5131879">Fprintln</span><span class="op" id="5131887">(</span><span class="ident" id="5131888">w</span><span class="op" id="5131889">,</span>&nbsp;<span class="builtintype" id="5131891">error</span><span class="op" id="5131896">)</span><br>
<span class="lineno"></span><span class="op" id="5131898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5131901">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5131970">func</span>&nbsp;<span class="ident" id="5131975">NotFound</span><span class="op" id="5131983">(</span><span class="ident" id="5131984">w</span>&nbsp;<span class="ident" id="5131986">ResponseWriter</span><span class="op" id="5132000">,</span>&nbsp;<span class="ident" id="5132002">r</span>&nbsp;<span class="op" id="5132004">*</span><span class="ident" id="5132005">Request</span><span class="op" id="5132012">)</span>&nbsp;<span class="op" id="5132014">{</span>&nbsp;<span class="ident" id="5132016">Error</span><span class="op" id="5132021">(</span><span class="ident" id="5132022">w</span><span class="op" id="5132023">,</span>&nbsp;<span class="string" id="5132025">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="5132045">,</span>&nbsp;<span class="ident" id="5132047">StatusNotFound</span><span class="op" id="5132061">)</span>&nbsp;<span class="op" id="5132063">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="5132066">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="5132118">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="5132187">func</span>&nbsp;<span class="ident" id="5132192">NotFoundHandler</span><span class="op" id="5132207">(</span><span class="op" id="5132208">)</span>&nbsp;<span class="ident" id="5132210">Handler</span>&nbsp;<span class="op" id="5132218">{</span>&nbsp;<span class="keyword" id="5132220">return</span>&nbsp;<span class="ident" id="5132227">HandlerFunc</span><span class="op" id="5132238">(</span><span class="ident" id="5132239">NotFound</span><span class="op" id="5132247">)</span>&nbsp;<span class="op" id="5132249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="5132252">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5132311">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="5132371">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5132424">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5132480">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="5132526">func</span>&nbsp;<span class="ident" id="5132531">StripPrefix</span><span class="op" id="5132542">(</span><span class="ident" id="5132543">prefix</span>&nbsp;<span class="builtintype" id="5132550">string</span><span class="op" id="5132556">,</span>&nbsp;<span class="ident" id="5132558">h</span>&nbsp;<span class="ident" id="5132560">Handler</span><span class="op" id="5132567">)</span>&nbsp;<span class="ident" id="5132569">Handler</span>&nbsp;<span class="op" id="5132577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132580">if</span>&nbsp;<span class="ident" id="5132583">prefix</span>&nbsp;<span class="op" id="5132590">==</span>&nbsp;<span class="string" id="5132593">&#34;&#34;</span>&nbsp;<span class="op" id="5132596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132600">return</span>&nbsp;<span class="ident" id="5132607">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132613">return</span>&nbsp;<span class="ident" id="5132620">HandlerFunc</span><span class="op" id="5132631">(</span><span class="keyword" id="5132632">func</span><span class="op" id="5132636">(</span><span class="ident" id="5132637">w</span>&nbsp;<span class="ident" id="5132639">ResponseWriter</span><span class="op" id="5132653">,</span>&nbsp;<span class="ident" id="5132655">r</span>&nbsp;<span class="op" id="5132657">*</span><span class="ident" id="5132658">Request</span><span class="op" id="5132665">)</span>&nbsp;<span class="op" id="5132667">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132671">if</span>&nbsp;<span class="ident" id="5132674">p</span>&nbsp;<span class="op" id="5132676">:=</span>&nbsp;<span class="ident" id="5132679">strings</span><span class="op" id="5132686">.</span><span class="ident" id="5132687">TrimPrefix</span><span class="op" id="5132697">(</span><span class="ident" id="5132698">r</span><span class="op" id="5132699">.</span><span class="ident" id="5132700">URL</span><span class="op" id="5132703">.</span><span class="ident" id="5132704">Path</span><span class="op" id="5132708">,</span>&nbsp;<span class="ident" id="5132710">prefix</span><span class="op" id="5132716">)</span><span class="op" id="5132717">;</span>&nbsp;<span class="builtinfunc" id="5132719">len</span><span class="op" id="5132722">(</span><span class="ident" id="5132723">p</span><span class="op" id="5132724">)</span>&nbsp;<span class="op" id="5132726">&lt;</span>&nbsp;<span class="builtinfunc" id="5132728">len</span><span class="op" id="5132731">(</span><span class="ident" id="5132732">r</span><span class="op" id="5132733">.</span><span class="ident" id="5132734">URL</span><span class="op" id="5132737">.</span><span class="ident" id="5132738">Path</span><span class="op" id="5132742">)</span>&nbsp;<span class="op" id="5132744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132749">r</span><span class="op" id="5132750">.</span><span class="ident" id="5132751">URL</span><span class="op" id="5132754">.</span><span class="ident" id="5132755">Path</span>&nbsp;<span class="op" id="5132760">=</span>&nbsp;<span class="ident" id="5132762">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132767">h</span><span class="op" id="5132768">.</span><span class="ident" id="5132769">ServeHTTP</span><span class="op" id="5132778">(</span><span class="ident" id="5132779">w</span><span class="op" id="5132780">,</span>&nbsp;<span class="ident" id="5132782">r</span><span class="op" id="5132783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132787">}</span>&nbsp;<span class="keyword" id="5132789">else</span>&nbsp;<span class="op" id="5132794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132799">NotFound</span><span class="op" id="5132807">(</span><span class="ident" id="5132808">w</span><span class="op" id="5132809">,</span>&nbsp;<span class="ident" id="5132811">r</span><span class="op" id="5132812">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132819">}</span><span class="op" id="5132820">)</span><br>
<span class="lineno"></span><span class="op" id="5132822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5132825">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="5132884">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="5132937">func</span>&nbsp;<span class="ident" id="5132942">Redirect</span><span class="op" id="5132950">(</span><span class="ident" id="5132951">w</span>&nbsp;<span class="ident" id="5132953">ResponseWriter</span><span class="op" id="5132967">,</span>&nbsp;<span class="ident" id="5132969">r</span>&nbsp;<span class="op" id="5132971">*</span><span class="ident" id="5132972">Request</span><span class="op" id="5132979">,</span>&nbsp;<span class="ident" id="5132981">urlStr</span>&nbsp;<span class="builtintype" id="5132988">string</span><span class="op" id="5132994">,</span>&nbsp;<span class="ident" id="5132996">code</span>&nbsp;<span class="builtintype" id="5133001">int</span><span class="op" id="5133004">)</span>&nbsp;<span class="op" id="5133006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133009">if</span>&nbsp;<span class="ident" id="5133012">u</span><span class="op" id="5133013">,</span>&nbsp;<span class="ident" id="5133015">err</span>&nbsp;<span class="op" id="5133019">:=</span>&nbsp;<span class="ident" id="5133022">url</span><span class="op" id="5133025">.</span><span class="ident" id="5133026">Parse</span><span class="op" id="5133031">(</span><span class="ident" id="5133032">urlStr</span><span class="op" id="5133038">)</span><span class="op" id="5133039">;</span>&nbsp;<span class="ident" id="5133041">err</span>&nbsp;<span class="op" id="5133045">==</span>&nbsp;<span class="ident" id="5133048">nil</span>&nbsp;<span class="op" id="5133052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133056">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133099">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133133">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133181">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133228">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133276">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133316">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133356">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133391">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133433">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133478">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133526">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133573">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133625">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133678">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133693">oldpath</span>&nbsp;<span class="op" id="5133701">:=</span>&nbsp;<span class="ident" id="5133704">r</span><span class="op" id="5133705">.</span><span class="ident" id="5133706">URL</span><span class="op" id="5133709">.</span><span class="ident" id="5133710">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133717">if</span>&nbsp;<span class="ident" id="5133720">oldpath</span>&nbsp;<span class="op" id="5133728">==</span>&nbsp;<span class="string" id="5133731">&#34;&#34;</span>&nbsp;<span class="op" id="5133734">{</span>&nbsp;<span class="comment" id="5133736">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133790">oldpath</span>&nbsp;<span class="op" id="5133798">=</span>&nbsp;<span class="string" id="5133800">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133810">if</span>&nbsp;<span class="ident" id="5133813">u</span><span class="op" id="5133814">.</span><span class="ident" id="5133815">Scheme</span>&nbsp;<span class="op" id="5133822">==</span>&nbsp;<span class="string" id="5133825">&#34;&#34;</span>&nbsp;<span class="op" id="5133828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133833">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133864">if</span>&nbsp;<span class="ident" id="5133867">urlStr</span>&nbsp;<span class="op" id="5133874">==</span>&nbsp;<span class="string" id="5133877">&#34;&#34;</span>&nbsp;<span class="op" id="5133880">||</span>&nbsp;<span class="ident" id="5133883">urlStr</span><span class="op" id="5133889">[</span><span class="num" id="5133890">0</span><span class="op" id="5133891">]</span>&nbsp;<span class="op" id="5133893">!=</span>&nbsp;<span class="string" id="5133896">&#39;/&#39;</span>&nbsp;<span class="op" id="5133900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133906">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133941">olddir</span><span class="op" id="5133947">,</span>&nbsp;<span class="ident" id="5133949">_</span>&nbsp;<span class="op" id="5133951">:=</span>&nbsp;<span class="ident" id="5133954">path</span><span class="op" id="5133958">.</span><span class="ident" id="5133959">Split</span><span class="op" id="5133964">(</span><span class="ident" id="5133965">oldpath</span><span class="op" id="5133972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133978">urlStr</span>&nbsp;<span class="op" id="5133985">=</span>&nbsp;<span class="ident" id="5133987">olddir</span>&nbsp;<span class="op" id="5133994">+</span>&nbsp;<span class="ident" id="5133996">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134006">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134012">var</span>&nbsp;<span class="ident" id="5134016">query</span>&nbsp;<span class="builtintype" id="5134022">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134032">if</span>&nbsp;<span class="ident" id="5134035">i</span>&nbsp;<span class="op" id="5134037">:=</span>&nbsp;<span class="ident" id="5134040">strings</span><span class="op" id="5134047">.</span><span class="ident" id="5134048">Index</span><span class="op" id="5134053">(</span><span class="ident" id="5134054">urlStr</span><span class="op" id="5134060">,</span>&nbsp;<span class="string" id="5134062">&#34;?&#34;</span><span class="op" id="5134065">)</span><span class="op" id="5134066">;</span>&nbsp;<span class="ident" id="5134068">i</span>&nbsp;<span class="op" id="5134070">!=</span>&nbsp;<span class="op" id="5134073">-</span><span class="num" id="5134074">1</span>&nbsp;<span class="op" id="5134076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134082">urlStr</span><span class="op" id="5134088">,</span>&nbsp;<span class="ident" id="5134090">query</span>&nbsp;<span class="op" id="5134096">=</span>&nbsp;<span class="ident" id="5134098">urlStr</span><span class="op" id="5134104">[</span><span class="op" id="5134105">:</span><span class="ident" id="5134106">i</span><span class="op" id="5134107">]</span><span class="op" id="5134108">,</span>&nbsp;<span class="ident" id="5134110">urlStr</span><span class="op" id="5134116">[</span><span class="ident" id="5134117">i</span><span class="op" id="5134118">:</span><span class="op" id="5134119">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134124">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134130">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134173">trailing</span>&nbsp;<span class="op" id="5134182">:=</span>&nbsp;<span class="ident" id="5134185">strings</span><span class="op" id="5134192">.</span><span class="ident" id="5134193">HasSuffix</span><span class="op" id="5134202">(</span><span class="ident" id="5134203">urlStr</span><span class="op" id="5134209">,</span>&nbsp;<span class="string" id="5134211">&#34;/&#34;</span><span class="op" id="5134214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134219">urlStr</span>&nbsp;<span class="op" id="5134226">=</span>&nbsp;<span class="ident" id="5134228">path</span><span class="op" id="5134232">.</span><span class="ident" id="5134233">Clean</span><span class="op" id="5134238">(</span><span class="ident" id="5134239">urlStr</span><span class="op" id="5134245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134250">if</span>&nbsp;<span class="ident" id="5134253">trailing</span>&nbsp;<span class="op" id="5134262">&amp;&amp;</span>&nbsp;<span class="op" id="5134265">!</span><span class="ident" id="5134266">strings</span><span class="op" id="5134273">.</span><span class="ident" id="5134274">HasSuffix</span><span class="op" id="5134283">(</span><span class="ident" id="5134284">urlStr</span><span class="op" id="5134290">,</span>&nbsp;<span class="string" id="5134292">&#34;/&#34;</span><span class="op" id="5134295">)</span>&nbsp;<span class="op" id="5134297">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134303">urlStr</span>&nbsp;<span class="op" id="5134310">+=</span>&nbsp;<span class="string" id="5134313">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134325">urlStr</span>&nbsp;<span class="op" id="5134332">+=</span>&nbsp;<span class="ident" id="5134335">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134346">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134350">w</span><span class="op" id="5134351">.</span><span class="ident" id="5134352">Header</span><span class="op" id="5134358">(</span><span class="op" id="5134359">)</span><span class="op" id="5134360">.</span><span class="ident" id="5134361">Set</span><span class="op" id="5134364">(</span><span class="string" id="5134365">&#34;Location&#34;</span><span class="op" id="5134375">,</span>&nbsp;<span class="ident" id="5134377">urlStr</span><span class="op" id="5134383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134386">w</span><span class="op" id="5134387">.</span><span class="ident" id="5134388">WriteHeader</span><span class="op" id="5134399">(</span><span class="ident" id="5134400">code</span><span class="op" id="5134404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134408">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134477">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134544">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134611">if</span>&nbsp;<span class="ident" id="5134614">r</span><span class="op" id="5134615">.</span><span class="ident" id="5134616">Method</span>&nbsp;<span class="op" id="5134623">==</span>&nbsp;<span class="string" id="5134626">&#34;GET&#34;</span>&nbsp;<span class="op" id="5134632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134636">note</span>&nbsp;<span class="op" id="5134641">:=</span>&nbsp;<span class="string" id="5134644">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="5134657">+</span>&nbsp;<span class="ident" id="5134659">htmlEscape</span><span class="op" id="5134669">(</span><span class="ident" id="5134670">urlStr</span><span class="op" id="5134676">)</span>&nbsp;<span class="op" id="5134678">+</span>&nbsp;<span class="string" id="5134680">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="5134686">+</span>&nbsp;<span class="ident" id="5134688">statusText</span><span class="op" id="5134698">[</span><span class="ident" id="5134699">code</span><span class="op" id="5134703">]</span>&nbsp;<span class="op" id="5134705">+</span>&nbsp;<span class="string" id="5134707">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134719">fmt</span><span class="op" id="5134722">.</span><span class="ident" id="5134723">Fprintln</span><span class="op" id="5134731">(</span><span class="ident" id="5134732">w</span><span class="op" id="5134733">,</span>&nbsp;<span class="ident" id="5134735">note</span><span class="op" id="5134739">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134742">}</span><br>
<span class="lineno"></span><span class="op" id="5134744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134747">var</span>&nbsp;<span class="ident" id="5134751">htmlReplacer</span>&nbsp;<span class="op" id="5134764">=</span>&nbsp;<span class="ident" id="5134766">strings</span><span class="op" id="5134773">.</span><span class="ident" id="5134774">NewReplacer</span><span class="op" id="5134785">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5134788">&#34;&amp;&#34;</span><span class="op" id="5134791">,</span>&nbsp;<span class="string" id="5134793">&#34;&amp;amp;&#34;</span><span class="op" id="5134800">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5134803">&#34;&lt;&#34;</span><span class="op" id="5134806">,</span>&nbsp;<span class="string" id="5134808">&#34;&amp;lt;&#34;</span><span class="op" id="5134814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5134817">&#34;&gt;&#34;</span><span class="op" id="5134820">,</span>&nbsp;<span class="string" id="5134822">&#34;&amp;gt;&#34;</span><span class="op" id="5134828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134831">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5134869">`&#34;`</span><span class="op" id="5134872">,</span>&nbsp;<span class="string" id="5134874">&#34;&amp;#34;&#34;</span><span class="op" id="5134881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134884">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5134959">&#34;&#39;&#34;</span><span class="op" id="5134962">,</span>&nbsp;<span class="string" id="5134964">&#34;&amp;#39;&#34;</span><span class="op" id="5134971">,</span><br>
<span class="lineno"></span><span class="op" id="5134973">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134976">func</span>&nbsp;<span class="ident" id="5134981">htmlEscape</span><span class="op" id="5134991">(</span><span class="ident" id="5134992">s</span>&nbsp;<span class="builtintype" id="5134994">string</span><span class="op" id="5135000">)</span>&nbsp;<span class="builtintype" id="5135002">string</span>&nbsp;<span class="op" id="5135009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5135012">return</span>&nbsp;<span class="ident" id="5135019">htmlReplacer</span><span class="op" id="5135031">.</span><span class="ident" id="5135032">Replace</span><span class="op" id="5135039">(</span><span class="ident" id="5135040">s</span><span class="op" id="5135041">)</span><br>
<span class="lineno">1375</span><span class="op" id="5135043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5135046">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="5135073">type</span>&nbsp;<span class="ident" id="5135078">redirectHandler</span>&nbsp;<span class="keyword" id="5135094">struct</span>&nbsp;<span class="op" id="5135101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135104">url</span>&nbsp;&nbsp;<span class="builtintype" id="5135109">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135117">code</span>&nbsp;<span class="builtintype" id="5135122">int</span><br>
<span class="lineno"></span><span class="op" id="5135126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5135129">func</span>&nbsp;<span class="op" id="5135134">(</span><span class="ident" id="5135135">rh</span>&nbsp;<span class="op" id="5135138">*</span><span class="ident" id="5135139">redirectHandler</span><span class="op" id="5135154">)</span>&nbsp;<span class="ident" id="5135156">ServeHTTP</span><span class="op" id="5135165">(</span><span class="ident" id="5135166">w</span>&nbsp;<span class="ident" id="5135168">ResponseWriter</span><span class="op" id="5135182">,</span>&nbsp;<span class="ident" id="5135184">r</span>&nbsp;<span class="op" id="5135186">*</span><span class="ident" id="5135187">Request</span><span class="op" id="5135194">)</span>&nbsp;<span class="op" id="5135196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135199">Redirect</span><span class="op" id="5135207">(</span><span class="ident" id="5135208">w</span><span class="op" id="5135209">,</span>&nbsp;<span class="ident" id="5135211">r</span><span class="op" id="5135212">,</span>&nbsp;<span class="ident" id="5135214">rh</span><span class="op" id="5135216">.</span><span class="ident" id="5135217">url</span><span class="op" id="5135220">,</span>&nbsp;<span class="ident" id="5135222">rh</span><span class="op" id="5135224">.</span><span class="ident" id="5135225">code</span><span class="op" id="5135229">)</span><br>
<span class="lineno">1385</span><span class="op" id="5135231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5135234">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="5135294">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="5135355">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="5135371">func</span>&nbsp;<span class="ident" id="5135376">RedirectHandler</span><span class="op" id="5135391">(</span><span class="ident" id="5135392">url</span>&nbsp;<span class="builtintype" id="5135396">string</span><span class="op" id="5135402">,</span>&nbsp;<span class="ident" id="5135404">code</span>&nbsp;<span class="builtintype" id="5135409">int</span><span class="op" id="5135412">)</span>&nbsp;<span class="ident" id="5135414">Handler</span>&nbsp;<span class="op" id="5135422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5135425">return</span>&nbsp;<span class="op" id="5135432">&amp;</span><span class="ident" id="5135433">redirectHandler</span><span class="op" id="5135448">{</span><span class="ident" id="5135449">url</span><span class="op" id="5135452">,</span>&nbsp;<span class="ident" id="5135454">code</span><span class="op" id="5135458">}</span><br>
<span class="lineno"></span><span class="op" id="5135460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5135463">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="5135507">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="5135583">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5135638">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="5135671">//</span><br>
<span class="lineno"></span><span class="comment" id="5135674">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="5135733">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="5135799">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5135861">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5135917">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5135974">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="5136034">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5136093">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="5136116">//</span><br>
<span class="lineno"></span><span class="comment" id="5136119">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="5136190">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="5136259">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5136307">//</span><br>
<span class="lineno"></span><span class="comment" id="5136310">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5136384">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="5136456">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="5136531">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="5136602">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5136644">//</span><br>
<span class="lineno"></span><span class="comment" id="5136647">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="5136711">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="5136772">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="5136806">type</span>&nbsp;<span class="ident" id="5136811">ServeMux</span>&nbsp;<span class="keyword" id="5136820">struct</span>&nbsp;<span class="op" id="5136827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5136830">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5136836">sync</span><span class="op" id="5136840">.</span><span class="ident" id="5136841">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5136850">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5136856">map</span><span class="op" id="5136859">[</span><span class="builtintype" id="5136860">string</span><span class="op" id="5136866">]</span><span class="ident" id="5136867">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5136877">hosts</span>&nbsp;<span class="builtintype" id="5136883">bool</span>&nbsp;<span class="comment" id="5136888">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="5136930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5136933">type</span>&nbsp;<span class="ident" id="5136938">muxEntry</span>&nbsp;<span class="keyword" id="5136947">struct</span>&nbsp;<span class="op" id="5136954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5136957">explicit</span>&nbsp;<span class="builtintype" id="5136966">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5136972">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5136981">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5136990">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="5136999">string</span><br>
<span class="lineno"></span><span class="op" id="5137006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5137009">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5137062">func</span>&nbsp;<span class="ident" id="5137067">NewServeMux</span><span class="op" id="5137078">(</span><span class="op" id="5137079">)</span>&nbsp;<span class="op" id="5137081">*</span><span class="ident" id="5137082">ServeMux</span>&nbsp;<span class="op" id="5137091">{</span>&nbsp;<span class="keyword" id="5137093">return</span>&nbsp;<span class="op" id="5137100">&amp;</span><span class="ident" id="5137101">ServeMux</span><span class="op" id="5137109">{</span><span class="ident" id="5137110">m</span><span class="op" id="5137111">:</span>&nbsp;<span class="builtinfunc" id="5137113">make</span><span class="op" id="5137117">(</span><span class="keyword" id="5137118">map</span><span class="op" id="5137121">[</span><span class="builtintype" id="5137122">string</span><span class="op" id="5137128">]</span><span class="ident" id="5137129">muxEntry</span><span class="op" id="5137137">)</span><span class="op" id="5137138">}</span>&nbsp;<span class="op" id="5137140">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="5137143">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="5137201">var</span>&nbsp;<span class="ident" id="5137205">DefaultServeMux</span>&nbsp;<span class="op" id="5137221">=</span>&nbsp;<span class="ident" id="5137223">NewServeMux</span><span class="op" id="5137234">(</span><span class="op" id="5137235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5137238">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="5137266">func</span>&nbsp;<span class="ident" id="5137271">pathMatch</span><span class="op" id="5137280">(</span><span class="ident" id="5137281">pattern</span><span class="op" id="5137288">,</span>&nbsp;<span class="ident" id="5137290">path</span>&nbsp;<span class="builtintype" id="5137295">string</span><span class="op" id="5137301">)</span>&nbsp;<span class="builtintype" id="5137303">bool</span>&nbsp;<span class="op" id="5137308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137311">if</span>&nbsp;<span class="builtinfunc" id="5137314">len</span><span class="op" id="5137317">(</span><span class="ident" id="5137318">pattern</span><span class="op" id="5137325">)</span>&nbsp;<span class="op" id="5137327">==</span>&nbsp;<span class="num" id="5137330">0</span>&nbsp;<span class="op" id="5137332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5137336">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137359">return</span>&nbsp;<span class="builtintype" id="5137366">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5137373">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5137376">n</span>&nbsp;<span class="op" id="5137378">:=</span>&nbsp;<span class="builtinfunc" id="5137381">len</span><span class="op" id="5137384">(</span><span class="ident" id="5137385">pattern</span><span class="op" id="5137392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137395">if</span>&nbsp;<span class="ident" id="5137398">pattern</span><span class="op" id="5137405">[</span><span class="ident" id="5137406">n</span><span class="op" id="5137407">-</span><span class="num" id="5137408">1</span><span class="op" id="5137409">]</span>&nbsp;<span class="op" id="5137411">!=</span>&nbsp;<span class="string" id="5137414">&#39;/&#39;</span>&nbsp;<span class="op" id="5137418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137422">return</span>&nbsp;<span class="ident" id="5137429">pattern</span>&nbsp;<span class="op" id="5137437">==</span>&nbsp;<span class="ident" id="5137440">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5137446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137449">return</span>&nbsp;<span class="builtinfunc" id="5137456">len</span><span class="op" id="5137459">(</span><span class="ident" id="5137460">path</span><span class="op" id="5137464">)</span>&nbsp;<span class="op" id="5137466">&gt;=</span>&nbsp;<span class="ident" id="5137469">n</span>&nbsp;<span class="op" id="5137471">&amp;&amp;</span>&nbsp;<span class="ident" id="5137474">path</span><span class="op" id="5137478">[</span><span class="num" id="5137479">0</span><span class="op" id="5137480">:</span><span class="ident" id="5137481">n</span><span class="op" id="5137482">]</span>&nbsp;<span class="op" id="5137484">==</span>&nbsp;<span class="ident" id="5137487">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="5137495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5137498">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="5137565">func</span>&nbsp;<span class="ident" id="5137570">cleanPath</span><span class="op" id="5137579">(</span><span class="ident" id="5137580">p</span>&nbsp;<span class="builtintype" id="5137582">string</span><span class="op" id="5137588">)</span>&nbsp;<span class="builtintype" id="5137590">string</span>&nbsp;<span class="op" id="5137597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137600">if</span>&nbsp;<span class="ident" id="5137603">p</span>&nbsp;<span class="op" id="5137605">==</span>&nbsp;<span class="string" id="5137608">&#34;&#34;</span>&nbsp;<span class="op" id="5137611">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137615">return</span>&nbsp;<span class="string" id="5137622">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5137627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137630">if</span>&nbsp;<span class="ident" id="5137633">p</span><span class="op" id="5137634">[</span><span class="num" id="5137635">0</span><span class="op" id="5137636">]</span>&nbsp;<span class="op" id="5137638">!=</span>&nbsp;<span class="string" id="5137641">&#39;/&#39;</span>&nbsp;<span class="op" id="5137645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5137649">p</span>&nbsp;<span class="op" id="5137651">=</span>&nbsp;<span class="string" id="5137653">&#34;/&#34;</span>&nbsp;<span class="op" id="5137657">+</span>&nbsp;<span class="ident" id="5137659">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5137662">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5137665">np</span>&nbsp;<span class="op" id="5137668">:=</span>&nbsp;<span class="ident" id="5137671">path</span><span class="op" id="5137675">.</span><span class="ident" id="5137676">Clean</span><span class="op" id="5137681">(</span><span class="ident" id="5137682">p</span><span class="op" id="5137683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5137686">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5137741">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137787">if</span>&nbsp;<span class="ident" id="5137790">p</span><span class="op" id="5137791">[</span><span class="builtinfunc" id="5137792">len</span><span class="op" id="5137795">(</span><span class="ident" id="5137796">p</span><span class="op" id="5137797">)</span><span class="op" id="5137798">-</span><span class="num" id="5137799">1</span><span class="op" id="5137800">]</span>&nbsp;<span class="op" id="5137802">==</span>&nbsp;<span class="string" id="5137805">&#39;/&#39;</span>&nbsp;<span class="op" id="5137809">&amp;&amp;</span>&nbsp;<span class="ident" id="5137812">np</span>&nbsp;<span class="op" id="5137815">!=</span>&nbsp;<span class="string" id="5137818">&#34;/&#34;</span>&nbsp;<span class="op" id="5137822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5137826">np</span>&nbsp;<span class="op" id="5137829">+=</span>&nbsp;<span class="string" id="5137832">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5137837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5137840">return</span>&nbsp;<span class="ident" id="5137847">np</span><br>
<span class="lineno"></span><span class="op" id="5137850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5137853">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="5137908">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="5137948">func</span>&nbsp;<span class="op" id="5137953">(</span><span class="ident" id="5137954">mux</span>&nbsp;<span class="op" id="5137958">*</span><span class="ident" id="5137959">ServeMux</span><span class="op" id="5137967">)</span>&nbsp;<span class="ident" id="5137969">match</span><span class="op" id="5137974">(</span><span class="ident" id="5137975">path</span>&nbsp;<span class="builtintype" id="5137980">string</span><span class="op" id="5137986">)</span>&nbsp;<span class="op" id="5137988">(</span><span class="ident" id="5137989">h</span>&nbsp;<span class="ident" id="5137991">Handler</span><span class="op" id="5137998">,</span>&nbsp;<span class="ident" id="5138000">pattern</span>&nbsp;<span class="builtintype" id="5138008">string</span><span class="op" id="5138014">)</span>&nbsp;<span class="op" id="5138016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138019">var</span>&nbsp;<span class="ident" id="5138023">n</span>&nbsp;<span class="op" id="5138025">=</span>&nbsp;<span class="num" id="5138027">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138030">for</span>&nbsp;<span class="ident" id="5138034">k</span><span class="op" id="5138035">,</span>&nbsp;<span class="ident" id="5138037">v</span>&nbsp;<span class="op" id="5138039">:=</span>&nbsp;<span class="keyword" id="5138042">range</span>&nbsp;<span class="ident" id="5138048">mux</span><span class="op" id="5138051">.</span><span class="ident" id="5138052">m</span>&nbsp;<span class="op" id="5138054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138058">if</span>&nbsp;<span class="op" id="5138061">!</span><span class="ident" id="5138062">pathMatch</span><span class="op" id="5138071">(</span><span class="ident" id="5138072">k</span><span class="op" id="5138073">,</span>&nbsp;<span class="ident" id="5138075">path</span><span class="op" id="5138079">)</span>&nbsp;<span class="op" id="5138081">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138086">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5138097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138101">if</span>&nbsp;<span class="ident" id="5138104">h</span>&nbsp;<span class="op" id="5138106">==</span>&nbsp;<span class="ident" id="5138109">nil</span>&nbsp;<span class="op" id="5138113">||</span>&nbsp;<span class="builtinfunc" id="5138116">len</span><span class="op" id="5138119">(</span><span class="ident" id="5138120">k</span><span class="op" id="5138121">)</span>&nbsp;<span class="op" id="5138123">&gt;</span>&nbsp;<span class="ident" id="5138125">n</span>&nbsp;<span class="op" id="5138127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5138132">n</span>&nbsp;<span class="op" id="5138134">=</span>&nbsp;<span class="builtinfunc" id="5138136">len</span><span class="op" id="5138139">(</span><span class="ident" id="5138140">k</span><span class="op" id="5138141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5138146">h</span>&nbsp;<span class="op" id="5138148">=</span>&nbsp;<span class="ident" id="5138150">v</span><span class="op" id="5138151">.</span><span class="ident" id="5138152">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5138157">pattern</span>&nbsp;<span class="op" id="5138165">=</span>&nbsp;<span class="ident" id="5138167">v</span><span class="op" id="5138168">.</span><span class="ident" id="5138169">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5138179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5138182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138185">return</span><br>
<span class="lineno"></span><span class="op" id="5138192">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="5138195">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="5138256">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5138322">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5138390">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="5138456">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="5138482">//</span><br>
<span class="lineno"></span><span class="comment" id="5138485">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5138549">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="5138611">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="5138672">//</span><br>
<span class="lineno"></span><span class="comment" id="5138675">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="5138741">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="5138811">func</span>&nbsp;<span class="op" id="5138816">(</span><span class="ident" id="5138817">mux</span>&nbsp;<span class="op" id="5138821">*</span><span class="ident" id="5138822">ServeMux</span><span class="op" id="5138830">)</span>&nbsp;<span class="ident" id="5138832">Handler</span><span class="op" id="5138839">(</span><span class="ident" id="5138840">r</span>&nbsp;<span class="op" id="5138842">*</span><span class="ident" id="5138843">Request</span><span class="op" id="5138850">)</span>&nbsp;<span class="op" id="5138852">(</span><span class="ident" id="5138853">h</span>&nbsp;<span class="ident" id="5138855">Handler</span><span class="op" id="5138862">,</span>&nbsp;<span class="ident" id="5138864">pattern</span>&nbsp;<span class="builtintype" id="5138872">string</span><span class="op" id="5138878">)</span>&nbsp;<span class="op" id="5138880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138883">if</span>&nbsp;<span class="ident" id="5138886">r</span><span class="op" id="5138887">.</span><span class="ident" id="5138888">Method</span>&nbsp;<span class="op" id="5138895">!=</span>&nbsp;<span class="string" id="5138898">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5138908">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5138912">if</span>&nbsp;<span class="ident" id="5138915">p</span>&nbsp;<span class="op" id="5138917">:=</span>&nbsp;<span class="ident" id="5138920">cleanPath</span><span class="op" id="5138929">(</span><span class="ident" id="5138930">r</span><span class="op" id="5138931">.</span><span class="ident" id="5138932">URL</span><span class="op" id="5138935">.</span><span class="ident" id="5138936">Path</span><span class="op" id="5138940">)</span><span class="op" id="5138941">;</span>&nbsp;<span class="ident" id="5138943">p</span>&nbsp;<span class="op" id="5138945">!=</span>&nbsp;<span class="ident" id="5138948">r</span><span class="op" id="5138949">.</span><span class="ident" id="5138950">URL</span><span class="op" id="5138953">.</span><span class="ident" id="5138954">Path</span>&nbsp;<span class="op" id="5138959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5138964">_</span><span class="op" id="5138965">,</span>&nbsp;<span class="ident" id="5138967">pattern</span>&nbsp;<span class="op" id="5138975">=</span>&nbsp;<span class="ident" id="5138977">mux</span><span class="op" id="5138980">.</span><span class="ident" id="5138981">handler</span><span class="op" id="5138988">(</span><span class="ident" id="5138989">r</span><span class="op" id="5138990">.</span><span class="ident" id="5138991">Host</span><span class="op" id="5138995">,</span>&nbsp;<span class="ident" id="5138997">p</span><span class="op" id="5138998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139003">url</span>&nbsp;<span class="op" id="5139007">:=</span>&nbsp;<span class="op" id="5139010">*</span><span class="ident" id="5139011">r</span><span class="op" id="5139012">.</span><span class="ident" id="5139013">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139020">url</span><span class="op" id="5139023">.</span><span class="ident" id="5139024">Path</span>&nbsp;<span class="op" id="5139029">=</span>&nbsp;<span class="ident" id="5139031">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139036">return</span>&nbsp;<span class="ident" id="5139043">RedirectHandler</span><span class="op" id="5139058">(</span><span class="ident" id="5139059">url</span><span class="op" id="5139062">.</span><span class="ident" id="5139063">String</span><span class="op" id="5139069">(</span><span class="op" id="5139070">)</span><span class="op" id="5139071">,</span>&nbsp;<span class="ident" id="5139073">StatusMovedPermanently</span><span class="op" id="5139095">)</span><span class="op" id="5139096">,</span>&nbsp;<span class="ident" id="5139098">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139115">return</span>&nbsp;<span class="ident" id="5139122">mux</span><span class="op" id="5139125">.</span><span class="ident" id="5139126">handler</span><span class="op" id="5139133">(</span><span class="ident" id="5139134">r</span><span class="op" id="5139135">.</span><span class="ident" id="5139136">Host</span><span class="op" id="5139140">,</span>&nbsp;<span class="ident" id="5139142">r</span><span class="op" id="5139143">.</span><span class="ident" id="5139144">URL</span><span class="op" id="5139147">.</span><span class="ident" id="5139148">Path</span><span class="op" id="5139152">)</span><br>
<span class="lineno"></span><span class="op" id="5139154">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="5139157">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="5139207">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="5139281">func</span>&nbsp;<span class="op" id="5139286">(</span><span class="ident" id="5139287">mux</span>&nbsp;<span class="op" id="5139291">*</span><span class="ident" id="5139292">ServeMux</span><span class="op" id="5139300">)</span>&nbsp;<span class="ident" id="5139302">handler</span><span class="op" id="5139309">(</span><span class="ident" id="5139310">host</span><span class="op" id="5139314">,</span>&nbsp;<span class="ident" id="5139316">path</span>&nbsp;<span class="builtintype" id="5139321">string</span><span class="op" id="5139327">)</span>&nbsp;<span class="op" id="5139329">(</span><span class="ident" id="5139330">h</span>&nbsp;<span class="ident" id="5139332">Handler</span><span class="op" id="5139339">,</span>&nbsp;<span class="ident" id="5139341">pattern</span>&nbsp;<span class="builtintype" id="5139349">string</span><span class="op" id="5139355">)</span>&nbsp;<span class="op" id="5139357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139360">mux</span><span class="op" id="5139363">.</span><span class="ident" id="5139364">mu</span><span class="op" id="5139366">.</span><span class="ident" id="5139367">RLock</span><span class="op" id="5139372">(</span><span class="op" id="5139373">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139376">defer</span>&nbsp;<span class="ident" id="5139382">mux</span><span class="op" id="5139385">.</span><span class="ident" id="5139386">mu</span><span class="op" id="5139388">.</span><span class="ident" id="5139389">RUnlock</span><span class="op" id="5139396">(</span><span class="op" id="5139397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5139401">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139462">if</span>&nbsp;<span class="ident" id="5139465">mux</span><span class="op" id="5139468">.</span><span class="ident" id="5139469">hosts</span>&nbsp;<span class="op" id="5139475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139479">h</span><span class="op" id="5139480">,</span>&nbsp;<span class="ident" id="5139482">pattern</span>&nbsp;<span class="op" id="5139490">=</span>&nbsp;<span class="ident" id="5139492">mux</span><span class="op" id="5139495">.</span><span class="ident" id="5139496">match</span><span class="op" id="5139501">(</span><span class="ident" id="5139502">host</span>&nbsp;<span class="op" id="5139507">+</span>&nbsp;<span class="ident" id="5139509">path</span><span class="op" id="5139513">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139519">if</span>&nbsp;<span class="ident" id="5139522">h</span>&nbsp;<span class="op" id="5139524">==</span>&nbsp;<span class="ident" id="5139527">nil</span>&nbsp;<span class="op" id="5139531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139535">h</span><span class="op" id="5139536">,</span>&nbsp;<span class="ident" id="5139538">pattern</span>&nbsp;<span class="op" id="5139546">=</span>&nbsp;<span class="ident" id="5139548">mux</span><span class="op" id="5139551">.</span><span class="ident" id="5139552">match</span><span class="op" id="5139557">(</span><span class="ident" id="5139558">path</span><span class="op" id="5139562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139568">if</span>&nbsp;<span class="ident" id="5139571">h</span>&nbsp;<span class="op" id="5139573">==</span>&nbsp;<span class="ident" id="5139576">nil</span>&nbsp;<span class="op" id="5139580">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139584">h</span><span class="op" id="5139585">,</span>&nbsp;<span class="ident" id="5139587">pattern</span>&nbsp;<span class="op" id="5139595">=</span>&nbsp;<span class="ident" id="5139597">NotFoundHandler</span><span class="op" id="5139612">(</span><span class="op" id="5139613">)</span><span class="op" id="5139614">,</span>&nbsp;<span class="string" id="5139616">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139623">return</span><br>
<span class="lineno"></span><span class="op" id="5139630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="5139633">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="5139690">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="5139739">func</span>&nbsp;<span class="op" id="5139744">(</span><span class="ident" id="5139745">mux</span>&nbsp;<span class="op" id="5139749">*</span><span class="ident" id="5139750">ServeMux</span><span class="op" id="5139758">)</span>&nbsp;<span class="ident" id="5139760">ServeHTTP</span><span class="op" id="5139769">(</span><span class="ident" id="5139770">w</span>&nbsp;<span class="ident" id="5139772">ResponseWriter</span><span class="op" id="5139786">,</span>&nbsp;<span class="ident" id="5139788">r</span>&nbsp;<span class="op" id="5139790">*</span><span class="ident" id="5139791">Request</span><span class="op" id="5139798">)</span>&nbsp;<span class="op" id="5139800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139803">if</span>&nbsp;<span class="ident" id="5139806">r</span><span class="op" id="5139807">.</span><span class="ident" id="5139808">RequestURI</span>&nbsp;<span class="op" id="5139819">==</span>&nbsp;<span class="string" id="5139822">&#34;*&#34;</span>&nbsp;<span class="op" id="5139826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139830">if</span>&nbsp;<span class="ident" id="5139833">r</span><span class="op" id="5139834">.</span><span class="ident" id="5139835">ProtoAtLeast</span><span class="op" id="5139847">(</span><span class="num" id="5139848">1</span><span class="op" id="5139849">,</span>&nbsp;<span class="num" id="5139851">1</span><span class="op" id="5139852">)</span>&nbsp;<span class="op" id="5139854">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139859">w</span><span class="op" id="5139860">.</span><span class="ident" id="5139861">Header</span><span class="op" id="5139867">(</span><span class="op" id="5139868">)</span><span class="op" id="5139869">.</span><span class="ident" id="5139870">Set</span><span class="op" id="5139873">(</span><span class="string" id="5139874">&#34;Connection&#34;</span><span class="op" id="5139886">,</span>&nbsp;<span class="string" id="5139888">&#34;close&#34;</span><span class="op" id="5139895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139903">w</span><span class="op" id="5139904">.</span><span class="ident" id="5139905">WriteHeader</span><span class="op" id="5139916">(</span><span class="ident" id="5139917">StatusBadRequest</span><span class="op" id="5139933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5139937">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5139945">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139948">h</span><span class="op" id="5139949">,</span>&nbsp;<span class="ident" id="5139951">_</span>&nbsp;<span class="op" id="5139953">:=</span>&nbsp;<span class="ident" id="5139956">mux</span><span class="op" id="5139959">.</span><span class="ident" id="5139960">Handler</span><span class="op" id="5139967">(</span><span class="ident" id="5139968">r</span><span class="op" id="5139969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5139972">h</span><span class="op" id="5139973">.</span><span class="ident" id="5139974">ServeHTTP</span><span class="op" id="5139983">(</span><span class="ident" id="5139984">w</span><span class="op" id="5139985">,</span>&nbsp;<span class="ident" id="5139987">r</span><span class="op" id="5139988">)</span><br>
<span class="lineno"></span><span class="op" id="5139990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5139993">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="5140048">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="5140107">func</span>&nbsp;<span class="op" id="5140112">(</span><span class="ident" id="5140113">mux</span>&nbsp;<span class="op" id="5140117">*</span><span class="ident" id="5140118">ServeMux</span><span class="op" id="5140126">)</span>&nbsp;<span class="ident" id="5140128">Handle</span><span class="op" id="5140134">(</span><span class="ident" id="5140135">pattern</span>&nbsp;<span class="builtintype" id="5140143">string</span><span class="op" id="5140149">,</span>&nbsp;<span class="ident" id="5140151">handler</span>&nbsp;<span class="ident" id="5140159">Handler</span><span class="op" id="5140166">)</span>&nbsp;<span class="op" id="5140168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5140171">mux</span><span class="op" id="5140174">.</span><span class="ident" id="5140175">mu</span><span class="op" id="5140177">.</span><span class="ident" id="5140178">Lock</span><span class="op" id="5140182">(</span><span class="op" id="5140183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140186">defer</span>&nbsp;<span class="ident" id="5140192">mux</span><span class="op" id="5140195">.</span><span class="ident" id="5140196">mu</span><span class="op" id="5140198">.</span><span class="ident" id="5140199">Unlock</span><span class="op" id="5140205">(</span><span class="op" id="5140206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140210">if</span>&nbsp;<span class="ident" id="5140213">pattern</span>&nbsp;<span class="op" id="5140221">==</span>&nbsp;<span class="string" id="5140224">&#34;&#34;</span>&nbsp;<span class="op" id="5140227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5140231">panic</span><span class="op" id="5140236">(</span><span class="string" id="5140237">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="5140262">+</span>&nbsp;<span class="ident" id="5140264">pattern</span><span class="op" id="5140271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5140274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140277">if</span>&nbsp;<span class="ident" id="5140280">handler</span>&nbsp;<span class="op" id="5140288">==</span>&nbsp;<span class="ident" id="5140291">nil</span>&nbsp;<span class="op" id="5140295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5140299">panic</span><span class="op" id="5140304">(</span><span class="string" id="5140305">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="5140324">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5140327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140330">if</span>&nbsp;<span class="ident" id="5140333">mux</span><span class="op" id="5140336">.</span><span class="ident" id="5140337">m</span><span class="op" id="5140338">[</span><span class="ident" id="5140339">pattern</span><span class="op" id="5140346">]</span><span class="op" id="5140347">.</span><span class="ident" id="5140348">explicit</span>&nbsp;<span class="op" id="5140357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5140361">panic</span><span class="op" id="5140366">(</span><span class="string" id="5140367">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="5140403">+</span>&nbsp;<span class="ident" id="5140405">pattern</span><span class="op" id="5140412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5140415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5140419">mux</span><span class="op" id="5140422">.</span><span class="ident" id="5140423">m</span><span class="op" id="5140424">[</span><span class="ident" id="5140425">pattern</span><span class="op" id="5140432">]</span>&nbsp;<span class="op" id="5140434">=</span>&nbsp;<span class="ident" id="5140436">muxEntry</span><span class="op" id="5140444">{</span><span class="ident" id="5140445">explicit</span><span class="op" id="5140453">:</span>&nbsp;<span class="builtintype" id="5140455">true</span><span class="op" id="5140459">,</span>&nbsp;<span class="ident" id="5140461">h</span><span class="op" id="5140462">:</span>&nbsp;<span class="ident" id="5140464">handler</span><span class="op" id="5140471">,</span>&nbsp;<span class="ident" id="5140473">pattern</span><span class="op" id="5140480">:</span>&nbsp;<span class="ident" id="5140482">pattern</span><span class="op" id="5140489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140493">if</span>&nbsp;<span class="ident" id="5140496">pattern</span><span class="op" id="5140503">[</span><span class="num" id="5140504">0</span><span class="op" id="5140505">]</span>&nbsp;<span class="op" id="5140507">!=</span>&nbsp;<span class="string" id="5140510">&#39;/&#39;</span>&nbsp;<span class="op" id="5140514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5140518">mux</span><span class="op" id="5140521">.</span><span class="ident" id="5140522">hosts</span>&nbsp;<span class="op" id="5140528">=</span>&nbsp;<span class="builtintype" id="5140530">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5140536">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140540">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140562">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140637">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5140691">n</span>&nbsp;<span class="op" id="5140693">:=</span>&nbsp;<span class="builtinfunc" id="5140696">len</span><span class="op" id="5140699">(</span><span class="ident" id="5140700">pattern</span><span class="op" id="5140707">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140710">if</span>&nbsp;<span class="ident" id="5140713">n</span>&nbsp;<span class="op" id="5140715">&gt;</span>&nbsp;<span class="num" id="5140717">0</span>&nbsp;<span class="op" id="5140719">&amp;&amp;</span>&nbsp;<span class="ident" id="5140722">pattern</span><span class="op" id="5140729">[</span><span class="ident" id="5140730">n</span><span class="op" id="5140731">-</span><span class="num" id="5140732">1</span><span class="op" id="5140733">]</span>&nbsp;<span class="op" id="5140735">==</span>&nbsp;<span class="string" id="5140738">&#39;/&#39;</span>&nbsp;<span class="op" id="5140742">&amp;&amp;</span>&nbsp;<span class="op" id="5140745">!</span><span class="ident" id="5140746">mux</span><span class="op" id="5140749">.</span><span class="ident" id="5140750">m</span><span class="op" id="5140751">[</span><span class="ident" id="5140752">pattern</span><span class="op" id="5140759">[</span><span class="num" id="5140760">0</span><span class="op" id="5140761">:</span><span class="ident" id="5140762">n</span><span class="op" id="5140763">-</span><span class="num" id="5140764">1</span><span class="op" id="5140765">]</span><span class="op" id="5140766">]</span><span class="op" id="5140767">.</span><span class="ident" id="5140768">explicit</span>&nbsp;<span class="op" id="5140777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140781">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140846">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5140870">path</span>&nbsp;<span class="op" id="5140875">:=</span>&nbsp;<span class="ident" id="5140878">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5140888">if</span>&nbsp;<span class="ident" id="5140891">pattern</span><span class="op" id="5140898">[</span><span class="num" id="5140899">0</span><span class="op" id="5140900">]</span>&nbsp;<span class="op" id="5140902">!=</span>&nbsp;<span class="string" id="5140905">&#39;/&#39;</span>&nbsp;<span class="op" id="5140909">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140914">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5140973">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5141006">path</span>&nbsp;<span class="op" id="5141011">=</span>&nbsp;<span class="ident" id="5141013">pattern</span><span class="op" id="5141020">[</span><span class="ident" id="5141021">strings</span><span class="op" id="5141028">.</span><span class="ident" id="5141029">Index</span><span class="op" id="5141034">(</span><span class="ident" id="5141035">pattern</span><span class="op" id="5141042">,</span>&nbsp;<span class="string" id="5141044">&#34;/&#34;</span><span class="op" id="5141047">)</span><span class="op" id="5141048">:</span><span class="op" id="5141049">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5141053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5141057">mux</span><span class="op" id="5141060">.</span><span class="ident" id="5141061">m</span><span class="op" id="5141062">[</span><span class="ident" id="5141063">pattern</span><span class="op" id="5141070">[</span><span class="num" id="5141071">0</span><span class="op" id="5141072">:</span><span class="ident" id="5141073">n</span><span class="op" id="5141074">-</span><span class="num" id="5141075">1</span><span class="op" id="5141076">]</span><span class="op" id="5141077">]</span>&nbsp;<span class="op" id="5141079">=</span>&nbsp;<span class="ident" id="5141081">muxEntry</span><span class="op" id="5141089">{</span><span class="ident" id="5141090">h</span><span class="op" id="5141091">:</span>&nbsp;<span class="ident" id="5141093">RedirectHandler</span><span class="op" id="5141108">(</span><span class="ident" id="5141109">path</span><span class="op" id="5141113">,</span>&nbsp;<span class="ident" id="5141115">StatusMovedPermanently</span><span class="op" id="5141137">)</span><span class="op" id="5141138">,</span>&nbsp;<span class="ident" id="5141140">pattern</span><span class="op" id="5141147">:</span>&nbsp;<span class="ident" id="5141149">pattern</span><span class="op" id="5141156">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5141159">}</span><br>
<span class="lineno"></span><span class="op" id="5141161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5141164">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="5141232">func</span>&nbsp;<span class="op" id="5141237">(</span><span class="ident" id="5141238">mux</span>&nbsp;<span class="op" id="5141242">*</span><span class="ident" id="5141243">ServeMux</span><span class="op" id="5141251">)</span>&nbsp;<span class="ident" id="5141253">HandleFunc</span><span class="op" id="5141263">(</span><span class="ident" id="5141264">pattern</span>&nbsp;<span class="builtintype" id="5141272">string</span><span class="op" id="5141278">,</span>&nbsp;<span class="ident" id="5141280">handler</span>&nbsp;<span class="keyword" id="5141288">func</span><span class="op" id="5141292">(</span><span class="ident" id="5141293">ResponseWriter</span><span class="op" id="5141307">,</span>&nbsp;<span class="op" id="5141309">*</span><span class="ident" id="5141310">Request</span><span class="op" id="5141317">)</span><span class="op" id="5141318">)</span>&nbsp;<span class="op" id="5141320">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5141323">mux</span><span class="op" id="5141326">.</span><span class="ident" id="5141327">Handle</span><span class="op" id="5141333">(</span><span class="ident" id="5141334">pattern</span><span class="op" id="5141341">,</span>&nbsp;<span class="ident" id="5141343">HandlerFunc</span><span class="op" id="5141354">(</span><span class="ident" id="5141355">handler</span><span class="op" id="5141362">)</span><span class="op" id="5141363">)</span><br>
<span class="lineno"></span><span class="op" id="5141365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5141368">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="5141422">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="5141449">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="5141518">func</span>&nbsp;<span class="ident" id="5141523">Handle</span><span class="op" id="5141529">(</span><span class="ident" id="5141530">pattern</span>&nbsp;<span class="builtintype" id="5141538">string</span><span class="op" id="5141544">,</span>&nbsp;<span class="ident" id="5141546">handler</span>&nbsp;<span class="ident" id="5141554">Handler</span><span class="op" id="5141561">)</span>&nbsp;<span class="op" id="5141563">{</span>&nbsp;<span class="ident" id="5141565">DefaultServeMux</span><span class="op" id="5141580">.</span><span class="ident" id="5141581">Handle</span><span class="op" id="5141587">(</span><span class="ident" id="5141588">pattern</span><span class="op" id="5141595">,</span>&nbsp;<span class="ident" id="5141597">handler</span><span class="op" id="5141604">)</span>&nbsp;<span class="op" id="5141606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5141609">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="5141676">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="5141703">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="5141772">func</span>&nbsp;<span class="ident" id="5141777">HandleFunc</span><span class="op" id="5141787">(</span><span class="ident" id="5141788">pattern</span>&nbsp;<span class="builtintype" id="5141796">string</span><span class="op" id="5141802">,</span>&nbsp;<span class="ident" id="5141804">handler</span>&nbsp;<span class="keyword" id="5141812">func</span><span class="op" id="5141816">(</span><span class="ident" id="5141817">ResponseWriter</span><span class="op" id="5141831">,</span>&nbsp;<span class="op" id="5141833">*</span><span class="ident" id="5141834">Request</span><span class="op" id="5141841">)</span><span class="op" id="5141842">)</span>&nbsp;<span class="op" id="5141844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5141847">DefaultServeMux</span><span class="op" id="5141862">.</span><span class="ident" id="5141863">HandleFunc</span><span class="op" id="5141873">(</span><span class="ident" id="5141874">pattern</span><span class="op" id="5141881">,</span>&nbsp;<span class="ident" id="5141883">handler</span><span class="op" id="5141890">)</span><br>
<span class="lineno"></span><span class="op" id="5141892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="5141895">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="5141957">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5142027">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="5142084">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5142156">func</span>&nbsp;<span class="ident" id="5142161">Serve</span><span class="op" id="5142166">(</span><span class="ident" id="5142167">l</span>&nbsp;<span class="ident" id="5142169">net</span><span class="op" id="5142172">.</span><span class="ident" id="5142173">Listener</span><span class="op" id="5142181">,</span>&nbsp;<span class="ident" id="5142183">handler</span>&nbsp;<span class="ident" id="5142191">Handler</span><span class="op" id="5142198">)</span>&nbsp;<span class="builtintype" id="5142200">error</span>&nbsp;<span class="op" id="5142206">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142209">srv</span>&nbsp;<span class="op" id="5142213">:=</span>&nbsp;<span class="op" id="5142216">&amp;</span><span class="ident" id="5142217">Server</span><span class="op" id="5142223">{</span><span class="ident" id="5142224">Handler</span><span class="op" id="5142231">:</span>&nbsp;<span class="ident" id="5142233">handler</span><span class="op" id="5142240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5142243">return</span>&nbsp;<span class="ident" id="5142250">srv</span><span class="op" id="5142253">.</span><span class="ident" id="5142254">Serve</span><span class="op" id="5142259">(</span><span class="ident" id="5142260">l</span><span class="op" id="5142261">)</span><br>
<span class="lineno"></span><span class="op" id="5142263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5142266">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="5142325">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="5142380">type</span>&nbsp;<span class="ident" id="5142385">Server</span>&nbsp;<span class="keyword" id="5142392">struct</span>&nbsp;<span class="op" id="5142399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142402">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5142417">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5142431">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142478">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5142493">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5142507">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142558">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5142573">time</span><span class="op" id="5142577">.</span><span class="ident" id="5142578">Duration</span>&nbsp;<span class="comment" id="5142587">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142646">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5142661">time</span><span class="op" id="5142665">.</span><span class="ident" id="5142666">Duration</span>&nbsp;<span class="comment" id="5142675">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142736">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="5142751">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5142765">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5142829">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5142844">*</span><span class="ident" id="5142845">tls</span><span class="op" id="5142848">.</span><span class="ident" id="5142849">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5142858">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5142910">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5142972">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143029">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143093">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143153">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143216">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143274">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5143326">TLSNextProto</span>&nbsp;<span class="keyword" id="5143339">map</span><span class="op" id="5143342">[</span><span class="builtintype" id="5143343">string</span><span class="op" id="5143349">]</span><span class="keyword" id="5143350">func</span><span class="op" id="5143354">(</span><span class="op" id="5143355">*</span><span class="ident" id="5143356">Server</span><span class="op" id="5143362">,</span>&nbsp;<span class="op" id="5143364">*</span><span class="ident" id="5143365">tls</span><span class="op" id="5143368">.</span><span class="ident" id="5143369">Conn</span><span class="op" id="5143373">,</span>&nbsp;<span class="ident" id="5143375">Handler</span><span class="op" id="5143382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143386">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143448">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143507">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5143564">ConnState</span>&nbsp;<span class="keyword" id="5143574">func</span><span class="op" id="5143578">(</span><span class="ident" id="5143579">net</span><span class="op" id="5143582">.</span><span class="ident" id="5143583">Conn</span><span class="op" id="5143587">,</span>&nbsp;<span class="ident" id="5143589">ConnState</span><span class="op" id="5143598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143602">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143665">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143720">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5143780">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5143801">ErrorLog</span>&nbsp;<span class="op" id="5143810">*</span><span class="ident" id="5143811">log</span><span class="op" id="5143814">.</span><span class="ident" id="5143815">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5143824">disableKeepAlives</span>&nbsp;<span class="builtintype" id="5143842">int32</span>&nbsp;<span class="comment" id="5143848">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="5143872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5143875">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="5143947">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="5143999">type</span>&nbsp;<span class="ident" id="5144004">ConnState</span>&nbsp;<span class="builtintype" id="5144014">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="5144019">const</span>&nbsp;<span class="op" id="5144025">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144028">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144089">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144147">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144202">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144219">StateNew</span>&nbsp;<span class="ident" id="5144228">ConnState</span>&nbsp;<span class="op" id="5144238">=</span>&nbsp;<span class="ident" id="5144240">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144247">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144311">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144365">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144428">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144482">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144535">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144596">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144610">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144666">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144729">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144790">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144832">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144844">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144896">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144965">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144981">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5145029">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5145087">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145118">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="5145130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5145133">var</span>&nbsp;<span class="ident" id="5145137">stateName</span>&nbsp;<span class="op" id="5145147">=</span>&nbsp;<span class="keyword" id="5145149">map</span><span class="op" id="5145152">[</span><span class="ident" id="5145153">ConnState</span><span class="op" id="5145162">]</span><span class="builtintype" id="5145163">string</span><span class="op" id="5145169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145172">StateNew</span><span class="op" id="5145180">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5145187">&#34;new&#34;</span><span class="op" id="5145192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145195">StateActive</span><span class="op" id="5145206">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="5145210">&#34;active&#34;</span><span class="op" id="5145218">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145221">StateIdle</span><span class="op" id="5145230">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5145236">&#34;idle&#34;</span><span class="op" id="5145242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145245">StateHijacked</span><span class="op" id="5145258">:</span>&nbsp;<span class="string" id="5145260">&#34;hijacked&#34;</span><span class="op" id="5145270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145273">StateClosed</span><span class="op" id="5145284">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="5145288">&#34;closed&#34;</span><span class="op" id="5145296">,</span><br>
<span class="lineno"></span><span class="op" id="5145298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="5145301">func</span>&nbsp;<span class="op" id="5145306">(</span><span class="ident" id="5145307">c</span>&nbsp;<span class="ident" id="5145309">ConnState</span><span class="op" id="5145318">)</span>&nbsp;<span class="ident" id="5145320">String</span><span class="op" id="5145326">(</span><span class="op" id="5145327">)</span>&nbsp;<span class="builtintype" id="5145329">string</span>&nbsp;<span class="op" id="5145336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5145339">return</span>&nbsp;<span class="ident" id="5145346">stateName</span><span class="op" id="5145355">[</span><span class="ident" id="5145356">c</span><span class="op" id="5145357">]</span><br>
<span class="lineno"></span><span class="op" id="5145359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5145362">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="5145423">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5145481">type</span>&nbsp;<span class="ident" id="5145486">serverHandler</span>&nbsp;<span class="keyword" id="5145500">struct</span>&nbsp;<span class="op" id="5145507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145510">srv</span>&nbsp;<span class="op" id="5145514">*</span><span class="ident" id="5145515">Server</span><br>
<span class="lineno"></span><span class="op" id="5145522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="5145525">func</span>&nbsp;<span class="op" id="5145530">(</span><span class="ident" id="5145531">sh</span>&nbsp;<span class="ident" id="5145534">serverHandler</span><span class="op" id="5145547">)</span>&nbsp;<span class="ident" id="5145549">ServeHTTP</span><span class="op" id="5145558">(</span><span class="ident" id="5145559">rw</span>&nbsp;<span class="ident" id="5145562">ResponseWriter</span><span class="op" id="5145576">,</span>&nbsp;<span class="ident" id="5145578">req</span>&nbsp;<span class="op" id="5145582">*</span><span class="ident" id="5145583">Request</span><span class="op" id="5145590">)</span>&nbsp;<span class="op" id="5145592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145595">handler</span>&nbsp;<span class="op" id="5145603">:=</span>&nbsp;<span class="ident" id="5145606">sh</span><span class="op" id="5145608">.</span><span class="ident" id="5145609">srv</span><span class="op" id="5145612">.</span><span class="ident" id="5145613">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5145622">if</span>&nbsp;<span class="ident" id="5145625">handler</span>&nbsp;<span class="op" id="5145633">==</span>&nbsp;<span class="ident" id="5145636">nil</span>&nbsp;<span class="op" id="5145640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145644">handler</span>&nbsp;<span class="op" id="5145652">=</span>&nbsp;<span class="ident" id="5145654">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5145671">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5145674">if</span>&nbsp;<span class="ident" id="5145677">req</span><span class="op" id="5145680">.</span><span class="ident" id="5145681">RequestURI</span>&nbsp;<span class="op" id="5145692">==</span>&nbsp;<span class="string" id="5145695">&#34;*&#34;</span>&nbsp;<span class="op" id="5145699">&amp;&amp;</span>&nbsp;<span class="ident" id="5145702">req</span><span class="op" id="5145705">.</span><span class="ident" id="5145706">Method</span>&nbsp;<span class="op" id="5145713">==</span>&nbsp;<span class="string" id="5145716">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="5145726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145730">handler</span>&nbsp;<span class="op" id="5145738">=</span>&nbsp;<span class="ident" id="5145740">globalOptionsHandler</span><span class="op" id="5145760">{</span><span class="op" id="5145761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5145764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145767">handler</span><span class="op" id="5145774">.</span><span class="ident" id="5145775">ServeHTTP</span><span class="op" id="5145784">(</span><span class="ident" id="5145785">rw</span><span class="op" id="5145787">,</span>&nbsp;<span class="ident" id="5145789">req</span><span class="op" id="5145792">)</span><br>
<span class="lineno"></span><span class="op" id="5145794">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="5145797">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5145868">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="5145931">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5145970">func</span>&nbsp;<span class="op" id="5145975">(</span><span class="ident" id="5145976">srv</span>&nbsp;<span class="op" id="5145980">*</span><span class="ident" id="5145981">Server</span><span class="op" id="5145987">)</span>&nbsp;<span class="ident" id="5145989">ListenAndServe</span><span class="op" id="5146003">(</span><span class="op" id="5146004">)</span>&nbsp;<span class="builtintype" id="5146006">error</span>&nbsp;<span class="op" id="5146012">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146015">addr</span>&nbsp;<span class="op" id="5146020">:=</span>&nbsp;<span class="ident" id="5146023">srv</span><span class="op" id="5146026">.</span><span class="ident" id="5146027">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146033">if</span>&nbsp;<span class="ident" id="5146036">addr</span>&nbsp;<span class="op" id="5146041">==</span>&nbsp;<span class="string" id="5146044">&#34;&#34;</span>&nbsp;<span class="op" id="5146047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146051">addr</span>&nbsp;<span class="op" id="5146056">=</span>&nbsp;<span class="string" id="5146058">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146070">ln</span><span class="op" id="5146072">,</span>&nbsp;<span class="ident" id="5146074">err</span>&nbsp;<span class="op" id="5146078">:=</span>&nbsp;<span class="ident" id="5146081">net</span><span class="op" id="5146084">.</span><span class="ident" id="5146085">Listen</span><span class="op" id="5146091">(</span><span class="string" id="5146092">&#34;tcp&#34;</span><span class="op" id="5146097">,</span>&nbsp;<span class="ident" id="5146099">addr</span><span class="op" id="5146103">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146106">if</span>&nbsp;<span class="ident" id="5146109">err</span>&nbsp;<span class="op" id="5146113">!=</span>&nbsp;<span class="ident" id="5146116">nil</span>&nbsp;<span class="op" id="5146120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146124">return</span>&nbsp;<span class="ident" id="5146131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146139">return</span>&nbsp;<span class="ident" id="5146146">srv</span><span class="op" id="5146149">.</span><span class="ident" id="5146150">Serve</span><span class="op" id="5146155">(</span><span class="ident" id="5146156">tcpKeepAliveListener</span><span class="op" id="5146176">{</span><span class="ident" id="5146177">ln</span><span class="op" id="5146179">.</span><span class="op" id="5146180">(</span><span class="op" id="5146181">*</span><span class="ident" id="5146182">net</span><span class="op" id="5146185">.</span><span class="ident" id="5146186">TCPListener</span><span class="op" id="5146197">)</span><span class="op" id="5146198">}</span><span class="op" id="5146199">)</span><br>
<span class="lineno"></span><span class="op" id="5146201">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="5146204">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5146272">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5146349">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="5146392">func</span>&nbsp;<span class="op" id="5146397">(</span><span class="ident" id="5146398">srv</span>&nbsp;<span class="op" id="5146402">*</span><span class="ident" id="5146403">Server</span><span class="op" id="5146409">)</span>&nbsp;<span class="ident" id="5146411">Serve</span><span class="op" id="5146416">(</span><span class="ident" id="5146417">l</span>&nbsp;<span class="ident" id="5146419">net</span><span class="op" id="5146422">.</span><span class="ident" id="5146423">Listener</span><span class="op" id="5146431">)</span>&nbsp;<span class="builtintype" id="5146433">error</span>&nbsp;<span class="op" id="5146439">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146442">defer</span>&nbsp;<span class="ident" id="5146448">l</span><span class="op" id="5146449">.</span><span class="ident" id="5146450">Close</span><span class="op" id="5146455">(</span><span class="op" id="5146456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146459">var</span>&nbsp;<span class="ident" id="5146463">tempDelay</span>&nbsp;<span class="ident" id="5146473">time</span><span class="op" id="5146477">.</span><span class="ident" id="5146478">Duration</span>&nbsp;<span class="comment" id="5146487">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146527">for</span>&nbsp;<span class="op" id="5146531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146535">rw</span><span class="op" id="5146537">,</span>&nbsp;<span class="ident" id="5146539">e</span>&nbsp;<span class="op" id="5146541">:=</span>&nbsp;<span class="ident" id="5146544">l</span><span class="op" id="5146545">.</span><span class="ident" id="5146546">Accept</span><span class="op" id="5146552">(</span><span class="op" id="5146553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146557">if</span>&nbsp;<span class="ident" id="5146560">e</span>&nbsp;<span class="op" id="5146562">!=</span>&nbsp;<span class="ident" id="5146565">nil</span>&nbsp;<span class="op" id="5146569">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146574">if</span>&nbsp;<span class="ident" id="5146577">ne</span><span class="op" id="5146579">,</span>&nbsp;<span class="ident" id="5146581">ok</span>&nbsp;<span class="op" id="5146584">:=</span>&nbsp;<span class="ident" id="5146587">e</span><span class="op" id="5146588">.</span><span class="op" id="5146589">(</span><span class="ident" id="5146590">net</span><span class="op" id="5146593">.</span><span class="ident" id="5146594">Error</span><span class="op" id="5146599">)</span><span class="op" id="5146600">;</span>&nbsp;<span class="ident" id="5146602">ok</span>&nbsp;<span class="op" id="5146605">&amp;&amp;</span>&nbsp;<span class="ident" id="5146608">ne</span><span class="op" id="5146610">.</span><span class="ident" id="5146611">Temporary</span><span class="op" id="5146620">(</span><span class="op" id="5146621">)</span>&nbsp;<span class="op" id="5146623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146629">if</span>&nbsp;<span class="ident" id="5146632">tempDelay</span>&nbsp;<span class="op" id="5146642">==</span>&nbsp;<span class="num" id="5146645">0</span>&nbsp;<span class="op" id="5146647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146654">tempDelay</span>&nbsp;<span class="op" id="5146664">=</span>&nbsp;<span class="num" id="5146666">5</span>&nbsp;<span class="op" id="5146668">*</span>&nbsp;<span class="ident" id="5146670">time</span><span class="op" id="5146674">.</span><span class="ident" id="5146675">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146691">}</span>&nbsp;<span class="keyword" id="5146693">else</span>&nbsp;<span class="op" id="5146698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146705">tempDelay</span>&nbsp;<span class="op" id="5146715">*=</span>&nbsp;<span class="num" id="5146718">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146730">if</span>&nbsp;<span class="ident" id="5146733">max</span>&nbsp;<span class="op" id="5146737">:=</span>&nbsp;<span class="num" id="5146740">1</span>&nbsp;<span class="op" id="5146742">*</span>&nbsp;<span class="ident" id="5146744">time</span><span class="op" id="5146748">.</span><span class="ident" id="5146749">Second</span><span class="op" id="5146755">;</span>&nbsp;<span class="ident" id="5146757">tempDelay</span>&nbsp;<span class="op" id="5146767">&gt;</span>&nbsp;<span class="ident" id="5146769">max</span>&nbsp;<span class="op" id="5146773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146780">tempDelay</span>&nbsp;<span class="op" id="5146790">=</span>&nbsp;<span class="ident" id="5146792">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146806">srv</span><span class="op" id="5146809">.</span><span class="ident" id="5146810">logf</span><span class="op" id="5146814">(</span><span class="string" id="5146815">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="5146855">,</span>&nbsp;<span class="ident" id="5146857">e</span><span class="op" id="5146858">,</span>&nbsp;<span class="ident" id="5146860">tempDelay</span><span class="op" id="5146869">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146875">time</span><span class="op" id="5146879">.</span><span class="ident" id="5146880">Sleep</span><span class="op" id="5146885">(</span><span class="ident" id="5146886">tempDelay</span><span class="op" id="5146895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146901">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146918">return</span>&nbsp;<span class="ident" id="5146925">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146929">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146933">tempDelay</span>&nbsp;<span class="op" id="5146943">=</span>&nbsp;<span class="num" id="5146945">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146949">c</span><span class="op" id="5146950">,</span>&nbsp;<span class="ident" id="5146952">err</span>&nbsp;<span class="op" id="5146956">:=</span>&nbsp;<span class="ident" id="5146959">srv</span><span class="op" id="5146962">.</span><span class="ident" id="5146963">newConn</span><span class="op" id="5146970">(</span><span class="ident" id="5146971">rw</span><span class="op" id="5146973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146977">if</span>&nbsp;<span class="ident" id="5146980">err</span>&nbsp;<span class="op" id="5146984">!=</span>&nbsp;<span class="ident" id="5146987">nil</span>&nbsp;<span class="op" id="5146991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146996">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147007">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147011">c</span><span class="op" id="5147012">.</span><span class="ident" id="5147013">setState</span><span class="op" id="5147021">(</span><span class="ident" id="5147022">c</span><span class="op" id="5147023">.</span><span class="ident" id="5147024">rwc</span><span class="op" id="5147027">,</span>&nbsp;<span class="ident" id="5147029">StateNew</span><span class="op" id="5147037">)</span>&nbsp;<span class="comment" id="5147039">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147068">go</span>&nbsp;<span class="ident" id="5147071">c</span><span class="op" id="5147072">.</span><span class="ident" id="5147073">serve</span><span class="op" id="5147078">(</span><span class="op" id="5147079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147082">}</span><br>
<span class="lineno"></span><span class="op" id="5147084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="5147087">func</span>&nbsp;<span class="op" id="5147092">(</span><span class="ident" id="5147093">s</span>&nbsp;<span class="op" id="5147095">*</span><span class="ident" id="5147096">Server</span><span class="op" id="5147102">)</span>&nbsp;<span class="ident" id="5147104">doKeepAlives</span><span class="op" id="5147116">(</span><span class="op" id="5147117">)</span>&nbsp;<span class="builtintype" id="5147119">bool</span>&nbsp;<span class="op" id="5147124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147127">return</span>&nbsp;<span class="ident" id="5147134">atomic</span><span class="op" id="5147140">.</span><span class="ident" id="5147141">LoadInt32</span><span class="op" id="5147150">(</span><span class="op" id="5147151">&amp;</span><span class="ident" id="5147152">s</span><span class="op" id="5147153">.</span><span class="ident" id="5147154">disableKeepAlives</span><span class="op" id="5147171">)</span>&nbsp;<span class="op" id="5147173">==</span>&nbsp;<span class="num" id="5147176">0</span><br>
<span class="lineno"></span><span class="op" id="5147178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5147181">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="5147252">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="5147309">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5147375">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="5147413">func</span>&nbsp;<span class="op" id="5147418">(</span><span class="ident" id="5147419">s</span>&nbsp;<span class="op" id="5147421">*</span><span class="ident" id="5147422">Server</span><span class="op" id="5147428">)</span>&nbsp;<span class="ident" id="5147430">SetKeepAlivesEnabled</span><span class="op" id="5147450">(</span><span class="ident" id="5147451">v</span>&nbsp;<span class="builtintype" id="5147453">bool</span><span class="op" id="5147457">)</span>&nbsp;<span class="op" id="5147459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147462">if</span>&nbsp;<span class="ident" id="5147465">v</span>&nbsp;<span class="op" id="5147467">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147471">atomic</span><span class="op" id="5147477">.</span><span class="ident" id="5147478">StoreInt32</span><span class="op" id="5147488">(</span><span class="op" id="5147489">&amp;</span><span class="ident" id="5147490">s</span><span class="op" id="5147491">.</span><span class="ident" id="5147492">disableKeepAlives</span><span class="op" id="5147509">,</span>&nbsp;<span class="num" id="5147511">0</span><span class="op" id="5147512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147515">}</span>&nbsp;<span class="keyword" id="5147517">else</span>&nbsp;<span class="op" id="5147522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147526">atomic</span><span class="op" id="5147532">.</span><span class="ident" id="5147533">StoreInt32</span><span class="op" id="5147543">(</span><span class="op" id="5147544">&amp;</span><span class="ident" id="5147545">s</span><span class="op" id="5147546">.</span><span class="ident" id="5147547">disableKeepAlives</span><span class="op" id="5147564">,</span>&nbsp;<span class="num" id="5147566">1</span><span class="op" id="5147567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147570">}</span><br>
<span class="lineno"></span><span class="op" id="5147572">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="5147575">func</span>&nbsp;<span class="op" id="5147580">(</span><span class="ident" id="5147581">s</span>&nbsp;<span class="op" id="5147583">*</span><span class="ident" id="5147584">Server</span><span class="op" id="5147590">)</span>&nbsp;<span class="ident" id="5147592">logf</span><span class="op" id="5147596">(</span><span class="ident" id="5147597">format</span>&nbsp;<span class="builtintype" id="5147604">string</span><span class="op" id="5147610">,</span>&nbsp;<span class="ident" id="5147612">args</span>&nbsp;<span class="op" id="5147617">...</span><span class="keyword" id="5147620">interface</span><span class="op" id="5147629">{</span><span class="op" id="5147630">}</span><span class="op" id="5147631">)</span>&nbsp;<span class="op" id="5147633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147636">if</span>&nbsp;<span class="ident" id="5147639">s</span><span class="op" id="5147640">.</span><span class="ident" id="5147641">ErrorLog</span>&nbsp;<span class="op" id="5147650">!=</span>&nbsp;<span class="ident" id="5147653">nil</span>&nbsp;<span class="op" id="5147657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147661">s</span><span class="op" id="5147662">.</span><span class="ident" id="5147663">ErrorLog</span><span class="op" id="5147671">.</span><span class="ident" id="5147672">Printf</span><span class="op" id="5147678">(</span><span class="ident" id="5147679">format</span><span class="op" id="5147685">,</span>&nbsp;<span class="ident" id="5147687">args</span><span class="op" id="5147691">...</span><span class="op" id="5147694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147697">}</span>&nbsp;<span class="keyword" id="5147699">else</span>&nbsp;<span class="op" id="5147704">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147708">log</span><span class="op" id="5147711">.</span><span class="ident" id="5147712">Printf</span><span class="op" id="5147718">(</span><span class="ident" id="5147719">format</span><span class="op" id="5147725">,</span>&nbsp;<span class="ident" id="5147727">args</span><span class="op" id="5147731">...</span><span class="op" id="5147734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147737">}</span><br>
<span class="lineno"></span><span class="op" id="5147739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5147742">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="5147800">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5147856">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="5147911">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="5147957">//</span><br>
<span class="lineno"></span><span class="comment" id="5147960">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="5147992">//</span><br>
<span class="lineno"></span><span class="comment" id="5147995">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="5148011">//</span><br>
<span class="lineno"></span><span class="comment" id="5148014">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="5148026">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="5148035">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5148050">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5148060">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="5148065">//</span><br>
<span class="lineno"></span><span class="comment" id="5148068">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="5148102">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5148166">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5148207">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="5148212">//</span><br>
<span class="lineno"></span><span class="comment" id="5148215">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="5148232">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="5148275">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="5148321">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5148341">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="5148381">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="5148387">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="5148392">func</span>&nbsp;<span class="ident" id="5148397">ListenAndServe</span><span class="op" id="5148411">(</span><span class="ident" id="5148412">addr</span>&nbsp;<span class="builtintype" id="5148417">string</span><span class="op" id="5148423">,</span>&nbsp;<span class="ident" id="5148425">handler</span>&nbsp;<span class="ident" id="5148433">Handler</span><span class="op" id="5148440">)</span>&nbsp;<span class="builtintype" id="5148442">error</span>&nbsp;<span class="op" id="5148448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148451">server</span>&nbsp;<span class="op" id="5148458">:=</span>&nbsp;<span class="op" id="5148461">&amp;</span><span class="ident" id="5148462">Server</span><span class="op" id="5148468">{</span><span class="ident" id="5148469">Addr</span><span class="op" id="5148473">:</span>&nbsp;<span class="ident" id="5148475">addr</span><span class="op" id="5148479">,</span>&nbsp;<span class="ident" id="5148481">Handler</span><span class="op" id="5148488">:</span>&nbsp;<span class="ident" id="5148490">handler</span><span class="op" id="5148497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148500">return</span>&nbsp;<span class="ident" id="5148507">server</span><span class="op" id="5148513">.</span><span class="ident" id="5148514">ListenAndServe</span><span class="op" id="5148528">(</span><span class="op" id="5148529">)</span><br>
<span class="lineno"></span><span class="op" id="5148531">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="5148534">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5148606">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5148685">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="5148761">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="5148843">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="5148908">//</span><br>
<span class="lineno"></span><span class="comment" id="5148911">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="5148943">//</span><br>
<span class="lineno"></span><span class="comment" id="5148946">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="5148958">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5148968">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5148983">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="5148988">//</span><br>
<span class="lineno"></span><span class="comment" id="5148991">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="5149051">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5149100">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="5149152">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="5149157">//</span><br>
<span class="lineno"></span><span class="comment" id="5149160">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="5149177">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="5149211">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="5149286">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="5149358">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="5149378">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="5149398">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="5149404">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="5149409">//</span><br>
<span class="lineno"></span><span class="comment" id="5149412">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="5149492">func</span>&nbsp;<span class="ident" id="5149497">ListenAndServeTLS</span><span class="op" id="5149514">(</span><span class="ident" id="5149515">addr</span>&nbsp;<span class="builtintype" id="5149520">string</span><span class="op" id="5149526">,</span>&nbsp;<span class="ident" id="5149528">certFile</span>&nbsp;<span class="builtintype" id="5149537">string</span><span class="op" id="5149543">,</span>&nbsp;<span class="ident" id="5149545">keyFile</span>&nbsp;<span class="builtintype" id="5149553">string</span><span class="op" id="5149559">,</span>&nbsp;<span class="ident" id="5149561">handler</span>&nbsp;<span class="ident" id="5149569">Handler</span><span class="op" id="5149576">)</span>&nbsp;<span class="builtintype" id="5149578">error</span>&nbsp;<span class="op" id="5149584">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149587">server</span>&nbsp;<span class="op" id="5149594">:=</span>&nbsp;<span class="op" id="5149597">&amp;</span><span class="ident" id="5149598">Server</span><span class="op" id="5149604">{</span><span class="ident" id="5149605">Addr</span><span class="op" id="5149609">:</span>&nbsp;<span class="ident" id="5149611">addr</span><span class="op" id="5149615">,</span>&nbsp;<span class="ident" id="5149617">Handler</span><span class="op" id="5149624">:</span>&nbsp;<span class="ident" id="5149626">handler</span><span class="op" id="5149633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149636">return</span>&nbsp;<span class="ident" id="5149643">server</span><span class="op" id="5149649">.</span><span class="ident" id="5149650">ListenAndServeTLS</span><span class="op" id="5149667">(</span><span class="ident" id="5149668">certFile</span><span class="op" id="5149676">,</span>&nbsp;<span class="ident" id="5149678">keyFile</span><span class="op" id="5149685">)</span><br>
<span class="lineno"></span><span class="op" id="5149687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5149690">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="5149759">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5149827">//</span><br>
<span class="lineno"></span><span class="comment" id="5149830">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5149897">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5149963">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="5150030">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="5150095">//</span><br>
<span class="lineno"></span><span class="comment" id="5150098">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5150141">func</span>&nbsp;<span class="op" id="5150146">(</span><span class="ident" id="5150147">srv</span>&nbsp;<span class="op" id="5150151">*</span><span class="ident" id="5150152">Server</span><span class="op" id="5150158">)</span>&nbsp;<span class="ident" id="5150160">ListenAndServeTLS</span><span class="op" id="5150177">(</span><span class="ident" id="5150178">certFile</span><span class="op" id="5150186">,</span>&nbsp;<span class="ident" id="5150188">keyFile</span>&nbsp;<span class="builtintype" id="5150196">string</span><span class="op" id="5150202">)</span>&nbsp;<span class="builtintype" id="5150204">error</span>&nbsp;<span class="op" id="5150210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150213">addr</span>&nbsp;<span class="op" id="5150218">:=</span>&nbsp;<span class="ident" id="5150221">srv</span><span class="op" id="5150224">.</span><span class="ident" id="5150225">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150231">if</span>&nbsp;<span class="ident" id="5150234">addr</span>&nbsp;<span class="op" id="5150239">==</span>&nbsp;<span class="string" id="5150242">&#34;&#34;</span>&nbsp;<span class="op" id="5150245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150249">addr</span>&nbsp;<span class="op" id="5150254">=</span>&nbsp;<span class="string" id="5150256">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150269">config</span>&nbsp;<span class="op" id="5150276">:=</span>&nbsp;<span class="op" id="5150279">&amp;</span><span class="ident" id="5150280">tls</span><span class="op" id="5150283">.</span><span class="ident" id="5150284">Config</span><span class="op" id="5150290">{</span><span class="op" id="5150291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150294">if</span>&nbsp;<span class="ident" id="5150297">srv</span><span class="op" id="5150300">.</span><span class="ident" id="5150301">TLSConfig</span>&nbsp;<span class="op" id="5150311">!=</span>&nbsp;<span class="ident" id="5150314">nil</span>&nbsp;<span class="op" id="5150318">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150322">*</span><span class="ident" id="5150323">config</span>&nbsp;<span class="op" id="5150330">=</span>&nbsp;<span class="op" id="5150332">*</span><span class="ident" id="5150333">srv</span><span class="op" id="5150336">.</span><span class="ident" id="5150337">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150351">if</span>&nbsp;<span class="ident" id="5150354">config</span><span class="op" id="5150360">.</span><span class="ident" id="5150361">NextProtos</span>&nbsp;<span class="op" id="5150372">==</span>&nbsp;<span class="ident" id="5150375">nil</span>&nbsp;<span class="op" id="5150379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150383">config</span><span class="op" id="5150389">.</span><span class="ident" id="5150390">NextProtos</span>&nbsp;<span class="op" id="5150401">=</span>&nbsp;<span class="op" id="5150403">[</span><span class="op" id="5150404">]</span><span class="builtintype" id="5150405">string</span><span class="op" id="5150411">{</span><span class="string" id="5150412">&#34;http/1.1&#34;</span><span class="op" id="5150422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150425">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150429">var</span>&nbsp;<span class="ident" id="5150433">err</span>&nbsp;<span class="builtintype" id="5150437">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150444">config</span><span class="op" id="5150450">.</span><span class="ident" id="5150451">Certificates</span>&nbsp;<span class="op" id="5150464">=</span>&nbsp;<span class="builtinfunc" id="5150466">make</span><span class="op" id="5150470">(</span><span class="op" id="5150471">[</span><span class="op" id="5150472">]</span><span class="ident" id="5150473">tls</span><span class="op" id="5150476">.</span><span class="ident" id="5150477">Certificate</span><span class="op" id="5150488">,</span>&nbsp;<span class="num" id="5150490">1</span><span class="op" id="5150491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150494">config</span><span class="op" id="5150500">.</span><span class="ident" id="5150501">Certificates</span><span class="op" id="5150513">[</span><span class="num" id="5150514">0</span><span class="op" id="5150515">]</span><span class="op" id="5150516">,</span>&nbsp;<span class="ident" id="5150518">err</span>&nbsp;<span class="op" id="5150522">=</span>&nbsp;<span class="ident" id="5150524">tls</span><span class="op" id="5150527">.</span><span class="ident" id="5150528">LoadX509KeyPair</span><span class="op" id="5150543">(</span><span class="ident" id="5150544">certFile</span><span class="op" id="5150552">,</span>&nbsp;<span class="ident" id="5150554">keyFile</span><span class="op" id="5150561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150564">if</span>&nbsp;<span class="ident" id="5150567">err</span>&nbsp;<span class="op" id="5150571">!=</span>&nbsp;<span class="ident" id="5150574">nil</span>&nbsp;<span class="op" id="5150578">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150582">return</span>&nbsp;<span class="ident" id="5150589">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150598">ln</span><span class="op" id="5150600">,</span>&nbsp;<span class="ident" id="5150602">err</span>&nbsp;<span class="op" id="5150606">:=</span>&nbsp;<span class="ident" id="5150609">net</span><span class="op" id="5150612">.</span><span class="ident" id="5150613">Listen</span><span class="op" id="5150619">(</span><span class="string" id="5150620">&#34;tcp&#34;</span><span class="op" id="5150625">,</span>&nbsp;<span class="ident" id="5150627">addr</span><span class="op" id="5150631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150634">if</span>&nbsp;<span class="ident" id="5150637">err</span>&nbsp;<span class="op" id="5150641">!=</span>&nbsp;<span class="ident" id="5150644">nil</span>&nbsp;<span class="op" id="5150648">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150652">return</span>&nbsp;<span class="ident" id="5150659">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150668">tlsListener</span>&nbsp;<span class="op" id="5150680">:=</span>&nbsp;<span class="ident" id="5150683">tls</span><span class="op" id="5150686">.</span><span class="ident" id="5150687">NewListener</span><span class="op" id="5150698">(</span><span class="ident" id="5150699">tcpKeepAliveListener</span><span class="op" id="5150719">{</span><span class="ident" id="5150720">ln</span><span class="op" id="5150722">.</span><span class="op" id="5150723">(</span><span class="op" id="5150724">*</span><span class="ident" id="5150725">net</span><span class="op" id="5150728">.</span><span class="ident" id="5150729">TCPListener</span><span class="op" id="5150740">)</span><span class="op" id="5150741">}</span><span class="op" id="5150742">,</span>&nbsp;<span class="ident" id="5150744">config</span><span class="op" id="5150750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150753">return</span>&nbsp;<span class="ident" id="5150760">srv</span><span class="op" id="5150763">.</span><span class="ident" id="5150764">Serve</span><span class="op" id="5150769">(</span><span class="ident" id="5150770">tlsListener</span><span class="op" id="5150781">)</span><br>
<span class="lineno">1880</span><span class="op" id="5150783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150786">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="5150861">//</span><br>
<span class="lineno"></span><span class="comment" id="5150864">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="5150934">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5151005">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="5151075">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="5151138">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="5151209">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="5151231">func</span>&nbsp;<span class="ident" id="5151236">TimeoutHandler</span><span class="op" id="5151250">(</span><span class="ident" id="5151251">h</span>&nbsp;<span class="ident" id="5151253">Handler</span><span class="op" id="5151260">,</span>&nbsp;<span class="ident" id="5151262">dt</span>&nbsp;<span class="ident" id="5151265">time</span><span class="op" id="5151269">.</span><span class="ident" id="5151270">Duration</span><span class="op" id="5151278">,</span>&nbsp;<span class="ident" id="5151280">msg</span>&nbsp;<span class="builtintype" id="5151284">string</span><span class="op" id="5151290">)</span>&nbsp;<span class="ident" id="5151292">Handler</span>&nbsp;<span class="op" id="5151300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151303">f</span>&nbsp;<span class="op" id="5151305">:=</span>&nbsp;<span class="keyword" id="5151308">func</span><span class="op" id="5151312">(</span><span class="op" id="5151313">)</span>&nbsp;<span class="op" id="5151315">&lt;-</span><span class="keyword" id="5151317">chan</span>&nbsp;<span class="ident" id="5151322">time</span><span class="op" id="5151326">.</span><span class="ident" id="5151327">Time</span>&nbsp;<span class="op" id="5151332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151336">return</span>&nbsp;<span class="ident" id="5151343">time</span><span class="op" id="5151347">.</span><span class="ident" id="5151348">After</span><span class="op" id="5151353">(</span><span class="ident" id="5151354">dt</span><span class="op" id="5151356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151362">return</span>&nbsp;<span class="op" id="5151369">&amp;</span><span class="ident" id="5151370">timeoutHandler</span><span class="op" id="5151384">{</span><span class="ident" id="5151385">h</span><span class="op" id="5151386">,</span>&nbsp;<span class="ident" id="5151388">f</span><span class="op" id="5151389">,</span>&nbsp;<span class="ident" id="5151391">msg</span><span class="op" id="5151394">}</span><br>
<span class="lineno">1895</span><span class="op" id="5151396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5151399">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="5151462">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="5151499">var</span>&nbsp;<span class="ident" id="5151503">ErrHandlerTimeout</span>&nbsp;<span class="op" id="5151521">=</span>&nbsp;<span class="ident" id="5151523">errors</span><span class="op" id="5151529">.</span><span class="ident" id="5151530">New</span><span class="op" id="5151533">(</span><span class="string" id="5151534">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="5151557">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="5151560">type</span>&nbsp;<span class="ident" id="5151565">timeoutHandler</span>&nbsp;<span class="keyword" id="5151580">struct</span>&nbsp;<span class="op" id="5151587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151590">handler</span>&nbsp;<span class="ident" id="5151598">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151607">timeout</span>&nbsp;<span class="keyword" id="5151615">func</span><span class="op" id="5151619">(</span><span class="op" id="5151620">)</span>&nbsp;<span class="op" id="5151622">&lt;-</span><span class="keyword" id="5151624">chan</span>&nbsp;<span class="ident" id="5151629">time</span><span class="op" id="5151633">.</span><span class="ident" id="5151634">Time</span>&nbsp;<span class="comment" id="5151639">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151679">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5151687">string</span><br>
<span class="lineno">1905</span><span class="op" id="5151694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5151697">func</span>&nbsp;<span class="op" id="5151702">(</span><span class="ident" id="5151703">h</span>&nbsp;<span class="op" id="5151705">*</span><span class="ident" id="5151706">timeoutHandler</span><span class="op" id="5151720">)</span>&nbsp;<span class="ident" id="5151722">errorBody</span><span class="op" id="5151731">(</span><span class="op" id="5151732">)</span>&nbsp;<span class="builtintype" id="5151734">string</span>&nbsp;<span class="op" id="5151741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151744">if</span>&nbsp;<span class="ident" id="5151747">h</span><span class="op" id="5151748">.</span><span class="ident" id="5151749">body</span>&nbsp;<span class="op" id="5151754">!=</span>&nbsp;<span class="string" id="5151757">&#34;&#34;</span>&nbsp;<span class="op" id="5151760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151764">return</span>&nbsp;<span class="ident" id="5151771">h</span><span class="op" id="5151772">.</span><span class="ident" id="5151773">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151782">return</span>&nbsp;<span class="string" id="5151789">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="5151869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5151872">func</span>&nbsp;<span class="op" id="5151877">(</span><span class="ident" id="5151878">h</span>&nbsp;<span class="op" id="5151880">*</span><span class="ident" id="5151881">timeoutHandler</span><span class="op" id="5151895">)</span>&nbsp;<span class="ident" id="5151897">ServeHTTP</span><span class="op" id="5151906">(</span><span class="ident" id="5151907">w</span>&nbsp;<span class="ident" id="5151909">ResponseWriter</span><span class="op" id="5151923">,</span>&nbsp;<span class="ident" id="5151925">r</span>&nbsp;<span class="op" id="5151927">*</span><span class="ident" id="5151928">Request</span><span class="op" id="5151935">)</span>&nbsp;<span class="op" id="5151937">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151940">done</span>&nbsp;<span class="op" id="5151945">:=</span>&nbsp;<span class="builtinfunc" id="5151948">make</span><span class="op" id="5151952">(</span><span class="keyword" id="5151953">chan</span>&nbsp;<span class="builtintype" id="5151958">bool</span><span class="op" id="5151962">,</span>&nbsp;<span class="num" id="5151964">1</span><span class="op" id="5151965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151968">tw</span>&nbsp;<span class="op" id="5151971">:=</span>&nbsp;<span class="op" id="5151974">&amp;</span><span class="ident" id="5151975">timeoutWriter</span><span class="op" id="5151988">{</span><span class="ident" id="5151989">w</span><span class="op" id="5151990">:</span>&nbsp;<span class="ident" id="5151992">w</span><span class="op" id="5151993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151996">go</span>&nbsp;<span class="keyword" id="5151999">func</span><span class="op" id="5152003">(</span><span class="op" id="5152004">)</span>&nbsp;<span class="op" id="5152006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152010">h</span><span class="op" id="5152011">.</span><span class="ident" id="5152012">handler</span><span class="op" id="5152019">.</span><span class="ident" id="5152020">ServeHTTP</span><span class="op" id="5152029">(</span><span class="ident" id="5152030">tw</span><span class="op" id="5152032">,</span>&nbsp;<span class="ident" id="5152034">r</span><span class="op" id="5152035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152039">done</span>&nbsp;<span class="op" id="5152044">&lt;-</span>&nbsp;<span class="builtintype" id="5152047">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152053">}</span><span class="op" id="5152054">(</span><span class="op" id="5152055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152058">select</span>&nbsp;<span class="op" id="5152065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152068">case</span>&nbsp;<span class="op" id="5152073">&lt;-</span><span class="ident" id="5152075">done</span><span class="op" id="5152079">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152083">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152091">case</span>&nbsp;<span class="op" id="5152096">&lt;-</span><span class="ident" id="5152098">h</span><span class="op" id="5152099">.</span><span class="ident" id="5152100">timeout</span><span class="op" id="5152107">(</span><span class="op" id="5152108">)</span><span class="op" id="5152109">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152113">tw</span><span class="op" id="5152115">.</span><span class="ident" id="5152116">mu</span><span class="op" id="5152118">.</span><span class="ident" id="5152119">Lock</span><span class="op" id="5152123">(</span><span class="op" id="5152124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152128">defer</span>&nbsp;<span class="ident" id="5152134">tw</span><span class="op" id="5152136">.</span><span class="ident" id="5152137">mu</span><span class="op" id="5152139">.</span><span class="ident" id="5152140">Unlock</span><span class="op" id="5152146">(</span><span class="op" id="5152147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152151">if</span>&nbsp;<span class="op" id="5152154">!</span><span class="ident" id="5152155">tw</span><span class="op" id="5152157">.</span><span class="ident" id="5152158">wroteHeader</span>&nbsp;<span class="op" id="5152170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152175">tw</span><span class="op" id="5152177">.</span><span class="ident" id="5152178">w</span><span class="op" id="5152179">.</span><span class="ident" id="5152180">WriteHeader</span><span class="op" id="5152191">(</span><span class="ident" id="5152192">StatusServiceUnavailable</span><span class="op" id="5152216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152221">tw</span><span class="op" id="5152223">.</span><span class="ident" id="5152224">w</span><span class="op" id="5152225">.</span><span class="ident" id="5152226">Write</span><span class="op" id="5152231">(</span><span class="op" id="5152232">[</span><span class="op" id="5152233">]</span><span class="builtintype" id="5152234">byte</span><span class="op" id="5152238">(</span><span class="ident" id="5152239">h</span><span class="op" id="5152240">.</span><span class="ident" id="5152241">errorBody</span><span class="op" id="5152250">(</span><span class="op" id="5152251">)</span><span class="op" id="5152252">)</span><span class="op" id="5152253">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152261">tw</span><span class="op" id="5152263">.</span><span class="ident" id="5152264">timedOut</span>&nbsp;<span class="op" id="5152273">=</span>&nbsp;<span class="builtintype" id="5152275">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152281">}</span><br>
<span class="lineno"></span><span class="op" id="5152283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="5152286">type</span>&nbsp;<span class="ident" id="5152291">timeoutWriter</span>&nbsp;<span class="keyword" id="5152305">struct</span>&nbsp;<span class="op" id="5152312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152315">w</span>&nbsp;<span class="ident" id="5152317">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152334">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152346">sync</span><span class="op" id="5152350">.</span><span class="ident" id="5152351">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152358">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5152370">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152376">wroteHeader</span>&nbsp;<span class="builtintype" id="5152388">bool</span><br>
<span class="lineno"></span><span class="op" id="5152393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152396">func</span>&nbsp;<span class="op" id="5152401">(</span><span class="ident" id="5152402">tw</span>&nbsp;<span class="op" id="5152405">*</span><span class="ident" id="5152406">timeoutWriter</span><span class="op" id="5152419">)</span>&nbsp;<span class="ident" id="5152421">Header</span><span class="op" id="5152427">(</span><span class="op" id="5152428">)</span>&nbsp;<span class="ident" id="5152430">Header</span>&nbsp;<span class="op" id="5152437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152440">return</span>&nbsp;<span class="ident" id="5152447">tw</span><span class="op" id="5152449">.</span><span class="ident" id="5152450">w</span><span class="op" id="5152451">.</span><span class="ident" id="5152452">Header</span><span class="op" id="5152458">(</span><span class="op" id="5152459">)</span><br>
<span class="lineno">1945</span><span class="op" id="5152461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152464">func</span>&nbsp;<span class="op" id="5152469">(</span><span class="ident" id="5152470">tw</span>&nbsp;<span class="op" id="5152473">*</span><span class="ident" id="5152474">timeoutWriter</span><span class="op" id="5152487">)</span>&nbsp;<span class="ident" id="5152489">Write</span><span class="op" id="5152494">(</span><span class="ident" id="5152495">p</span>&nbsp;<span class="op" id="5152497">[</span><span class="op" id="5152498">]</span><span class="builtintype" id="5152499">byte</span><span class="op" id="5152503">)</span>&nbsp;<span class="op" id="5152505">(</span><span class="builtintype" id="5152506">int</span><span class="op" id="5152509">,</span>&nbsp;<span class="builtintype" id="5152511">error</span><span class="op" id="5152516">)</span>&nbsp;<span class="op" id="5152518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152521">tw</span><span class="op" id="5152523">.</span><span class="ident" id="5152524">mu</span><span class="op" id="5152526">.</span><span class="ident" id="5152527">Lock</span><span class="op" id="5152531">(</span><span class="op" id="5152532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152535">defer</span>&nbsp;<span class="ident" id="5152541">tw</span><span class="op" id="5152543">.</span><span class="ident" id="5152544">mu</span><span class="op" id="5152546">.</span><span class="ident" id="5152547">Unlock</span><span class="op" id="5152553">(</span><span class="op" id="5152554">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152557">tw</span><span class="op" id="5152559">.</span><span class="ident" id="5152560">wroteHeader</span>&nbsp;<span class="op" id="5152572">=</span>&nbsp;<span class="builtintype" id="5152574">true</span>&nbsp;<span class="comment" id="5152579">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152603">if</span>&nbsp;<span class="ident" id="5152606">tw</span><span class="op" id="5152608">.</span><span class="ident" id="5152609">timedOut</span>&nbsp;<span class="op" id="5152618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152622">return</span>&nbsp;<span class="num" id="5152629">0</span><span class="op" id="5152630">,</span>&nbsp;<span class="ident" id="5152632">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152654">return</span>&nbsp;<span class="ident" id="5152661">tw</span><span class="op" id="5152663">.</span><span class="ident" id="5152664">w</span><span class="op" id="5152665">.</span><span class="ident" id="5152666">Write</span><span class="op" id="5152671">(</span><span class="ident" id="5152672">p</span><span class="op" id="5152673">)</span><br>
<span class="lineno">1955</span><span class="op" id="5152675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152678">func</span>&nbsp;<span class="op" id="5152683">(</span><span class="ident" id="5152684">tw</span>&nbsp;<span class="op" id="5152687">*</span><span class="ident" id="5152688">timeoutWriter</span><span class="op" id="5152701">)</span>&nbsp;<span class="ident" id="5152703">WriteHeader</span><span class="op" id="5152714">(</span><span class="ident" id="5152715">code</span>&nbsp;<span class="builtintype" id="5152720">int</span><span class="op" id="5152723">)</span>&nbsp;<span class="op" id="5152725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152728">tw</span><span class="op" id="5152730">.</span><span class="ident" id="5152731">mu</span><span class="op" id="5152733">.</span><span class="ident" id="5152734">Lock</span><span class="op" id="5152738">(</span><span class="op" id="5152739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152742">defer</span>&nbsp;<span class="ident" id="5152748">tw</span><span class="op" id="5152750">.</span><span class="ident" id="5152751">mu</span><span class="op" id="5152753">.</span><span class="ident" id="5152754">Unlock</span><span class="op" id="5152760">(</span><span class="op" id="5152761">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152764">if</span>&nbsp;<span class="ident" id="5152767">tw</span><span class="op" id="5152769">.</span><span class="ident" id="5152770">timedOut</span>&nbsp;<span class="op" id="5152779">||</span>&nbsp;<span class="ident" id="5152782">tw</span><span class="op" id="5152784">.</span><span class="ident" id="5152785">wroteHeader</span>&nbsp;<span class="op" id="5152797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152801">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152812">tw</span><span class="op" id="5152814">.</span><span class="ident" id="5152815">wroteHeader</span>&nbsp;<span class="op" id="5152827">=</span>&nbsp;<span class="builtintype" id="5152829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152835">tw</span><span class="op" id="5152837">.</span><span class="ident" id="5152838">w</span><span class="op" id="5152839">.</span><span class="ident" id="5152840">WriteHeader</span><span class="op" id="5152851">(</span><span class="ident" id="5152852">code</span><span class="op" id="5152856">)</span><br>
<span class="lineno">1965</span><span class="op" id="5152858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5152861">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="5152926">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5152995">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="5153065">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="5153077">type</span>&nbsp;<span class="ident" id="5153082">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="5153103">struct</span>&nbsp;<span class="op" id="5153110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153113">*</span><span class="ident" id="5153114">net</span><span class="op" id="5153117">.</span><span class="ident" id="5153118">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="5153130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="5153133">func</span>&nbsp;<span class="op" id="5153138">(</span><span class="ident" id="5153139">ln</span>&nbsp;<span class="ident" id="5153142">tcpKeepAliveListener</span><span class="op" id="5153162">)</span>&nbsp;<span class="ident" id="5153164">Accept</span><span class="op" id="5153170">(</span><span class="op" id="5153171">)</span>&nbsp;<span class="op" id="5153173">(</span><span class="ident" id="5153174">c</span>&nbsp;<span class="ident" id="5153176">net</span><span class="op" id="5153179">.</span><span class="ident" id="5153180">Conn</span><span class="op" id="5153184">,</span>&nbsp;<span class="ident" id="5153186">err</span>&nbsp;<span class="builtintype" id="5153190">error</span><span class="op" id="5153195">)</span>&nbsp;<span class="op" id="5153197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153200">tc</span><span class="op" id="5153202">,</span>&nbsp;<span class="ident" id="5153204">err</span>&nbsp;<span class="op" id="5153208">:=</span>&nbsp;<span class="ident" id="5153211">ln</span><span class="op" id="5153213">.</span><span class="ident" id="5153214">AcceptTCP</span><span class="op" id="5153223">(</span><span class="op" id="5153224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153227">if</span>&nbsp;<span class="ident" id="5153230">err</span>&nbsp;<span class="op" id="5153234">!=</span>&nbsp;<span class="ident" id="5153237">nil</span>&nbsp;<span class="op" id="5153241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153245">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153253">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153256">tc</span><span class="op" id="5153258">.</span><span class="ident" id="5153259">SetKeepAlive</span><span class="op" id="5153271">(</span><span class="builtintype" id="5153272">true</span><span class="op" id="5153276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153279">tc</span><span class="op" id="5153281">.</span><span class="ident" id="5153282">SetKeepAlivePeriod</span><span class="op" id="5153300">(</span><span class="num" id="5153301">3</span>&nbsp;<span class="op" id="5153303">*</span>&nbsp;<span class="ident" id="5153305">time</span><span class="op" id="5153309">.</span><span class="ident" id="5153310">Minute</span><span class="op" id="5153316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153319">return</span>&nbsp;<span class="ident" id="5153326">tc</span><span class="op" id="5153328">,</span>&nbsp;<span class="ident" id="5153330">nil</span><br>
<span class="lineno"></span><span class="op" id="5153334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="5153337">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="5153395">type</span>&nbsp;<span class="ident" id="5153400">globalOptionsHandler</span>&nbsp;<span class="keyword" id="5153421">struct</span><span class="op" id="5153427">{</span><span class="op" id="5153428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5153431">func</span>&nbsp;<span class="op" id="5153436">(</span><span class="ident" id="5153437">globalOptionsHandler</span><span class="op" id="5153457">)</span>&nbsp;<span class="ident" id="5153459">ServeHTTP</span><span class="op" id="5153468">(</span><span class="ident" id="5153469">w</span>&nbsp;<span class="ident" id="5153471">ResponseWriter</span><span class="op" id="5153485">,</span>&nbsp;<span class="ident" id="5153487">r</span>&nbsp;<span class="op" id="5153489">*</span><span class="ident" id="5153490">Request</span><span class="op" id="5153497">)</span>&nbsp;<span class="op" id="5153499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153502">w</span><span class="op" id="5153503">.</span><span class="ident" id="5153504">Header</span><span class="op" id="5153510">(</span><span class="op" id="5153511">)</span><span class="op" id="5153512">.</span><span class="ident" id="5153513">Set</span><span class="op" id="5153516">(</span><span class="string" id="5153517">&#34;Content-Length&#34;</span><span class="op" id="5153533">,</span>&nbsp;<span class="string" id="5153535">&#34;0&#34;</span><span class="op" id="5153538">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153541">if</span>&nbsp;<span class="ident" id="5153544">r</span><span class="op" id="5153545">.</span><span class="ident" id="5153546">ContentLength</span>&nbsp;<span class="op" id="5153560">!=</span>&nbsp;<span class="num" id="5153563">0</span>&nbsp;<span class="op" id="5153565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153569">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153626">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153684">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153741">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153800">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153848">mb</span>&nbsp;<span class="op" id="5153851">:=</span>&nbsp;<span class="ident" id="5153854">MaxBytesReader</span><span class="op" id="5153868">(</span><span class="ident" id="5153869">w</span><span class="op" id="5153870">,</span>&nbsp;<span class="ident" id="5153872">r</span><span class="op" id="5153873">.</span><span class="ident" id="5153874">Body</span><span class="op" id="5153878">,</span>&nbsp;<span class="num" id="5153880">4</span><span class="op" id="5153881">&lt;&lt;</span><span class="num" id="5153883">10</span><span class="op" id="5153885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153889">io</span><span class="op" id="5153891">.</span><span class="ident" id="5153892">Copy</span><span class="op" id="5153896">(</span><span class="ident" id="5153897">ioutil</span><span class="op" id="5153903">.</span><span class="ident" id="5153904">Discard</span><span class="op" id="5153911">,</span>&nbsp;<span class="ident" id="5153913">mb</span><span class="op" id="5153915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153918">}</span><br>
<span class="lineno"></span><span class="op" id="5153920">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="5153923">type</span>&nbsp;<span class="ident" id="5153928">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="5153949">struct</span><span class="op" id="5153955">{</span><span class="op" id="5153956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5153959">func</span>&nbsp;<span class="op" id="5153964">(</span><span class="ident" id="5153965">eofReaderWithWriteTo</span><span class="op" id="5153985">)</span>&nbsp;<span class="ident" id="5153987">WriteTo</span><span class="op" id="5153994">(</span><span class="ident" id="5153995">io</span><span class="op" id="5153997">.</span><span class="ident" id="5153998">Writer</span><span class="op" id="5154004">)</span>&nbsp;<span class="op" id="5154006">(</span><span class="ident" id="5154007">int64</span><span class="op" id="5154012">,</span>&nbsp;<span class="builtintype" id="5154014">error</span><span class="op" id="5154019">)</span>&nbsp;<span class="op" id="5154021">{</span>&nbsp;<span class="keyword" id="5154023">return</span>&nbsp;<span class="num" id="5154030">0</span><span class="op" id="5154031">,</span>&nbsp;<span class="ident" id="5154033">nil</span>&nbsp;<span class="op" id="5154037">}</span><br>
<span class="lineno"></span><span class="keyword" id="5154039">func</span>&nbsp;<span class="op" id="5154044">(</span><span class="ident" id="5154045">eofReaderWithWriteTo</span><span class="op" id="5154065">)</span>&nbsp;<span class="ident" id="5154067">Read</span><span class="op" id="5154071">(</span><span class="op" id="5154072">[</span><span class="op" id="5154073">]</span><span class="builtintype" id="5154074">byte</span><span class="op" id="5154078">)</span>&nbsp;<span class="op" id="5154080">(</span><span class="builtintype" id="5154081">int</span><span class="op" id="5154084">,</span>&nbsp;<span class="builtintype" id="5154086">error</span><span class="op" id="5154091">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154101">{</span>&nbsp;<span class="keyword" id="5154103">return</span>&nbsp;<span class="num" id="5154110">0</span><span class="op" id="5154111">,</span>&nbsp;<span class="ident" id="5154113">io</span><span class="op" id="5154115">.</span><span class="ident" id="5154116">EOF</span>&nbsp;<span class="op" id="5154120">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="5154123">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="5154188">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="5154247">var</span>&nbsp;<span class="ident" id="5154251">eofReader</span>&nbsp;<span class="op" id="5154261">=</span>&nbsp;<span class="op" id="5154263">&amp;</span><span class="keyword" id="5154264">struct</span>&nbsp;<span class="op" id="5154271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154274">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154296">io</span><span class="op" id="5154298">.</span><span class="ident" id="5154299">Closer</span><br>
<span class="lineno"></span><span class="op" id="5154306">}</span><span class="op" id="5154307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154310">eofReaderWithWriteTo</span><span class="op" id="5154330">{</span><span class="op" id="5154331">}</span><span class="op" id="5154332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154335">ioutil</span><span class="op" id="5154341">.</span><span class="ident" id="5154342">NopCloser</span><span class="op" id="5154351">(</span><span class="ident" id="5154352">nil</span><span class="op" id="5154355">)</span><span class="op" id="5154356">,</span><br>
<span class="lineno"></span><span class="op" id="5154358">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="5154361">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="5154429">var</span>&nbsp;<span class="ident" id="5154433">_</span>&nbsp;<span class="ident" id="5154435">io</span><span class="op" id="5154437">.</span><span class="ident" id="5154438">WriterTo</span>&nbsp;<span class="op" id="5154447">=</span>&nbsp;<span class="ident" id="5154449">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5154460">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="5154522">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="5154590">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="5154635">type</span>&nbsp;<span class="ident" id="5154640">initNPNRequest</span>&nbsp;<span class="keyword" id="5154655">struct</span>&nbsp;<span class="op" id="5154662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154665">c</span>&nbsp;<span class="op" id="5154667">*</span><span class="ident" id="5154668">tls</span><span class="op" id="5154671">.</span><span class="ident" id="5154672">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154678">h</span>&nbsp;<span class="ident" id="5154680">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="5154694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5154697">func</span>&nbsp;<span class="op" id="5154702">(</span><span class="ident" id="5154703">h</span>&nbsp;<span class="ident" id="5154705">initNPNRequest</span><span class="op" id="5154719">)</span>&nbsp;<span class="ident" id="5154721">ServeHTTP</span><span class="op" id="5154730">(</span><span class="ident" id="5154731">rw</span>&nbsp;<span class="ident" id="5154734">ResponseWriter</span><span class="op" id="5154748">,</span>&nbsp;<span class="ident" id="5154750">req</span>&nbsp;<span class="op" id="5154754">*</span><span class="ident" id="5154755">Request</span><span class="op" id="5154762">)</span>&nbsp;<span class="op" id="5154764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154767">if</span>&nbsp;<span class="ident" id="5154770">req</span><span class="op" id="5154773">.</span><span class="ident" id="5154774">TLS</span>&nbsp;<span class="op" id="5154778">==</span>&nbsp;<span class="ident" id="5154781">nil</span>&nbsp;<span class="op" id="5154785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154789">req</span><span class="op" id="5154792">.</span><span class="ident" id="5154793">TLS</span>&nbsp;<span class="op" id="5154797">=</span>&nbsp;<span class="op" id="5154799">&amp;</span><span class="ident" id="5154800">tls</span><span class="op" id="5154803">.</span><span class="ident" id="5154804">ConnectionState</span><span class="op" id="5154819">{</span><span class="op" id="5154820">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154824">*</span><span class="ident" id="5154825">req</span><span class="op" id="5154828">.</span><span class="ident" id="5154829">TLS</span>&nbsp;<span class="op" id="5154833">=</span>&nbsp;<span class="ident" id="5154835">h</span><span class="op" id="5154836">.</span><span class="ident" id="5154837">c</span><span class="op" id="5154838">.</span><span class="ident" id="5154839">ConnectionState</span><span class="op" id="5154854">(</span><span class="op" id="5154855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154861">if</span>&nbsp;<span class="ident" id="5154864">req</span><span class="op" id="5154867">.</span><span class="ident" id="5154868">Body</span>&nbsp;<span class="op" id="5154873">==</span>&nbsp;<span class="ident" id="5154876">nil</span>&nbsp;<span class="op" id="5154880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154884">req</span><span class="op" id="5154887">.</span><span class="ident" id="5154888">Body</span>&nbsp;<span class="op" id="5154893">=</span>&nbsp;<span class="ident" id="5154895">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154906">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154909">if</span>&nbsp;<span class="ident" id="5154912">req</span><span class="op" id="5154915">.</span><span class="ident" id="5154916">RemoteAddr</span>&nbsp;<span class="op" id="5154927">==</span>&nbsp;<span class="string" id="5154930">&#34;&#34;</span>&nbsp;<span class="op" id="5154933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154937">req</span><span class="op" id="5154940">.</span><span class="ident" id="5154941">RemoteAddr</span>&nbsp;<span class="op" id="5154952">=</span>&nbsp;<span class="ident" id="5154954">h</span><span class="op" id="5154955">.</span><span class="ident" id="5154956">c</span><span class="op" id="5154957">.</span><span class="ident" id="5154958">RemoteAddr</span><span class="op" id="5154968">(</span><span class="op" id="5154969">)</span><span class="op" id="5154970">.</span><span class="ident" id="5154971">String</span><span class="op" id="5154977">(</span><span class="op" id="5154978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154984">h</span><span class="op" id="5154985">.</span><span class="ident" id="5154986">h</span><span class="op" id="5154987">.</span><span class="ident" id="5154988">ServeHTTP</span><span class="op" id="5154997">(</span><span class="ident" id="5154998">rw</span><span class="op" id="5155000">,</span>&nbsp;<span class="ident" id="5155002">req</span><span class="op" id="5155005">)</span><br>
<span class="lineno"></span><span class="op" id="5155007">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="5155010">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="5155048">type</span>&nbsp;<span class="ident" id="5155053">loggingConn</span>&nbsp;<span class="keyword" id="5155065">struct</span>&nbsp;<span class="op" id="5155072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155075">name</span>&nbsp;<span class="builtintype" id="5155080">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155088">net</span><span class="op" id="5155091">.</span><span class="ident" id="5155092">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="5155097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155100">var</span>&nbsp;<span class="op" id="5155104">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155107">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5155120">sync</span><span class="op" id="5155124">.</span><span class="ident" id="5155125">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155132">uniqNameNext</span>&nbsp;<span class="op" id="5155145">=</span>&nbsp;<span class="builtinfunc" id="5155147">make</span><span class="op" id="5155151">(</span><span class="keyword" id="5155152">map</span><span class="op" id="5155155">[</span><span class="builtintype" id="5155156">string</span><span class="op" id="5155162">]</span><span class="builtintype" id="5155163">int</span><span class="op" id="5155166">)</span><br>
<span class="lineno">2050</span><span class="op" id="5155168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155171">func</span>&nbsp;<span class="ident" id="5155176">newLoggingConn</span><span class="op" id="5155190">(</span><span class="ident" id="5155191">baseName</span>&nbsp;<span class="builtintype" id="5155200">string</span><span class="op" id="5155206">,</span>&nbsp;<span class="ident" id="5155208">c</span>&nbsp;<span class="ident" id="5155210">net</span><span class="op" id="5155213">.</span><span class="ident" id="5155214">Conn</span><span class="op" id="5155218">)</span>&nbsp;<span class="ident" id="5155220">net</span><span class="op" id="5155223">.</span><span class="ident" id="5155224">Conn</span>&nbsp;<span class="op" id="5155229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155232">uniqNameMu</span><span class="op" id="5155242">.</span><span class="ident" id="5155243">Lock</span><span class="op" id="5155247">(</span><span class="op" id="5155248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155251">defer</span>&nbsp;<span class="ident" id="5155257">uniqNameMu</span><span class="op" id="5155267">.</span><span class="ident" id="5155268">Unlock</span><span class="op" id="5155274">(</span><span class="op" id="5155275">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155278">uniqNameNext</span><span class="op" id="5155290">[</span><span class="ident" id="5155291">baseName</span><span class="op" id="5155299">]</span><span class="op" id="5155300">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155304">return</span>&nbsp;<span class="op" id="5155311">&amp;</span><span class="ident" id="5155312">loggingConn</span><span class="op" id="5155323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155327">name</span><span class="op" id="5155331">:</span>&nbsp;<span class="ident" id="5155333">fmt</span><span class="op" id="5155336">.</span><span class="ident" id="5155337">Sprintf</span><span class="op" id="5155344">(</span><span class="string" id="5155345">&#34;%s-%d&#34;</span><span class="op" id="5155352">,</span>&nbsp;<span class="ident" id="5155354">baseName</span><span class="op" id="5155362">,</span>&nbsp;<span class="ident" id="5155364">uniqNameNext</span><span class="op" id="5155376">[</span><span class="ident" id="5155377">baseName</span><span class="op" id="5155385">]</span><span class="op" id="5155386">)</span><span class="op" id="5155387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155391">Conn</span><span class="op" id="5155395">:</span>&nbsp;<span class="ident" id="5155397">c</span><span class="op" id="5155398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155401">}</span><br>
<span class="lineno">2060</span><span class="op" id="5155403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155406">func</span>&nbsp;<span class="op" id="5155411">(</span><span class="ident" id="5155412">c</span>&nbsp;<span class="op" id="5155414">*</span><span class="ident" id="5155415">loggingConn</span><span class="op" id="5155426">)</span>&nbsp;<span class="ident" id="5155428">Write</span><span class="op" id="5155433">(</span><span class="ident" id="5155434">p</span>&nbsp;<span class="op" id="5155436">[</span><span class="op" id="5155437">]</span><span class="builtintype" id="5155438">byte</span><span class="op" id="5155442">)</span>&nbsp;<span class="op" id="5155444">(</span><span class="ident" id="5155445">n</span>&nbsp;<span class="builtintype" id="5155447">int</span><span class="op" id="5155450">,</span>&nbsp;<span class="ident" id="5155452">err</span>&nbsp;<span class="builtintype" id="5155456">error</span><span class="op" id="5155461">)</span>&nbsp;<span class="op" id="5155463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155466">log</span><span class="op" id="5155469">.</span><span class="ident" id="5155470">Printf</span><span class="op" id="5155476">(</span><span class="string" id="5155477">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="5155498">,</span>&nbsp;<span class="ident" id="5155500">c</span><span class="op" id="5155501">.</span><span class="ident" id="5155502">name</span><span class="op" id="5155506">,</span>&nbsp;<span class="builtinfunc" id="5155508">len</span><span class="op" id="5155511">(</span><span class="ident" id="5155512">p</span><span class="op" id="5155513">)</span><span class="op" id="5155514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155517">n</span><span class="op" id="5155518">,</span>&nbsp;<span class="ident" id="5155520">err</span>&nbsp;<span class="op" id="5155524">=</span>&nbsp;<span class="ident" id="5155526">c</span><span class="op" id="5155527">.</span><span class="ident" id="5155528">Conn</span><span class="op" id="5155532">.</span><span class="ident" id="5155533">Write</span><span class="op" id="5155538">(</span><span class="ident" id="5155539">p</span><span class="op" id="5155540">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155543">log</span><span class="op" id="5155546">.</span><span class="ident" id="5155547">Printf</span><span class="op" id="5155553">(</span><span class="string" id="5155554">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="5155577">,</span>&nbsp;<span class="ident" id="5155579">c</span><span class="op" id="5155580">.</span><span class="ident" id="5155581">name</span><span class="op" id="5155585">,</span>&nbsp;<span class="builtinfunc" id="5155587">len</span><span class="op" id="5155590">(</span><span class="ident" id="5155591">p</span><span class="op" id="5155592">)</span><span class="op" id="5155593">,</span>&nbsp;<span class="ident" id="5155595">n</span><span class="op" id="5155596">,</span>&nbsp;<span class="ident" id="5155598">err</span><span class="op" id="5155601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155604">return</span><br>
<span class="lineno"></span><span class="op" id="5155611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155614">func</span>&nbsp;<span class="op" id="5155619">(</span><span class="ident" id="5155620">c</span>&nbsp;<span class="op" id="5155622">*</span><span class="ident" id="5155623">loggingConn</span><span class="op" id="5155634">)</span>&nbsp;<span class="ident" id="5155636">Read</span><span class="op" id="5155640">(</span><span class="ident" id="5155641">p</span>&nbsp;<span class="op" id="5155643">[</span><span class="op" id="5155644">]</span><span class="builtintype" id="5155645">byte</span><span class="op" id="5155649">)</span>&nbsp;<span class="op" id="5155651">(</span><span class="ident" id="5155652">n</span>&nbsp;<span class="builtintype" id="5155654">int</span><span class="op" id="5155657">,</span>&nbsp;<span class="ident" id="5155659">err</span>&nbsp;<span class="builtintype" id="5155663">error</span><span class="op" id="5155668">)</span>&nbsp;<span class="op" id="5155670">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155673">log</span><span class="op" id="5155676">.</span><span class="ident" id="5155677">Printf</span><span class="op" id="5155683">(</span><span class="string" id="5155684">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="5155704">,</span>&nbsp;<span class="ident" id="5155706">c</span><span class="op" id="5155707">.</span><span class="ident" id="5155708">name</span><span class="op" id="5155712">,</span>&nbsp;<span class="builtinfunc" id="5155714">len</span><span class="op" id="5155717">(</span><span class="ident" id="5155718">p</span><span class="op" id="5155719">)</span><span class="op" id="5155720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155723">n</span><span class="op" id="5155724">,</span>&nbsp;<span class="ident" id="5155726">err</span>&nbsp;<span class="op" id="5155730">=</span>&nbsp;<span class="ident" id="5155732">c</span><span class="op" id="5155733">.</span><span class="ident" id="5155734">Conn</span><span class="op" id="5155738">.</span><span class="ident" id="5155739">Read</span><span class="op" id="5155743">(</span><span class="ident" id="5155744">p</span><span class="op" id="5155745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155748">log</span><span class="op" id="5155751">.</span><span class="ident" id="5155752">Printf</span><span class="op" id="5155758">(</span><span class="string" id="5155759">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="5155781">,</span>&nbsp;<span class="ident" id="5155783">c</span><span class="op" id="5155784">.</span><span class="ident" id="5155785">name</span><span class="op" id="5155789">,</span>&nbsp;<span class="builtinfunc" id="5155791">len</span><span class="op" id="5155794">(</span><span class="ident" id="5155795">p</span><span class="op" id="5155796">)</span><span class="op" id="5155797">,</span>&nbsp;<span class="ident" id="5155799">n</span><span class="op" id="5155800">,</span>&nbsp;<span class="ident" id="5155802">err</span><span class="op" id="5155805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155808">return</span><br>
<span class="lineno"></span><span class="op" id="5155815">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="5155818">func</span>&nbsp;<span class="op" id="5155823">(</span><span class="ident" id="5155824">c</span>&nbsp;<span class="op" id="5155826">*</span><span class="ident" id="5155827">loggingConn</span><span class="op" id="5155838">)</span>&nbsp;<span class="ident" id="5155840">Close</span><span class="op" id="5155845">(</span><span class="op" id="5155846">)</span>&nbsp;<span class="op" id="5155848">(</span><span class="ident" id="5155849">err</span>&nbsp;<span class="builtintype" id="5155853">error</span><span class="op" id="5155858">)</span>&nbsp;<span class="op" id="5155860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155863">log</span><span class="op" id="5155866">.</span><span class="ident" id="5155867">Printf</span><span class="op" id="5155873">(</span><span class="string" id="5155874">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="5155892">,</span>&nbsp;<span class="ident" id="5155894">c</span><span class="op" id="5155895">.</span><span class="ident" id="5155896">name</span><span class="op" id="5155900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155903">err</span>&nbsp;<span class="op" id="5155907">=</span>&nbsp;<span class="ident" id="5155909">c</span><span class="op" id="5155910">.</span><span class="ident" id="5155911">Conn</span><span class="op" id="5155915">.</span><span class="ident" id="5155916">Close</span><span class="op" id="5155921">(</span><span class="op" id="5155922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155925">log</span><span class="op" id="5155928">.</span><span class="ident" id="5155929">Printf</span><span class="op" id="5155935">(</span><span class="string" id="5155936">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="5155953">,</span>&nbsp;<span class="ident" id="5155955">c</span><span class="op" id="5155956">.</span><span class="ident" id="5155957">name</span><span class="op" id="5155961">,</span>&nbsp;<span class="ident" id="5155963">err</span><span class="op" id="5155966">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155969">return</span><br>
<span class="lineno"></span><span class="op" id="5155976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5155979">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="5156059">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="5156126">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5156185">type</span>&nbsp;<span class="ident" id="5156190">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="5156211">struct</span>&nbsp;<span class="op" id="5156218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156221">c</span>&nbsp;<span class="op" id="5156223">*</span><span class="ident" id="5156224">conn</span><br>
<span class="lineno"></span><span class="op" id="5156229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="5156232">func</span>&nbsp;<span class="op" id="5156237">(</span><span class="ident" id="5156238">w</span>&nbsp;<span class="ident" id="5156240">checkConnErrorWriter</span><span class="op" id="5156260">)</span>&nbsp;<span class="ident" id="5156262">Write</span><span class="op" id="5156267">(</span><span class="ident" id="5156268">p</span>&nbsp;<span class="op" id="5156270">[</span><span class="op" id="5156271">]</span><span class="builtintype" id="5156272">byte</span><span class="op" id="5156276">)</span>&nbsp;<span class="op" id="5156278">(</span><span class="ident" id="5156279">n</span>&nbsp;<span class="builtintype" id="5156281">int</span><span class="op" id="5156284">,</span>&nbsp;<span class="ident" id="5156286">err</span>&nbsp;<span class="builtintype" id="5156290">error</span><span class="op" id="5156295">)</span>&nbsp;<span class="op" id="5156297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156300">n</span><span class="op" id="5156301">,</span>&nbsp;<span class="ident" id="5156303">err</span>&nbsp;<span class="op" id="5156307">=</span>&nbsp;<span class="ident" id="5156309">w</span><span class="op" id="5156310">.</span><span class="ident" id="5156311">c</span><span class="op" id="5156312">.</span><span class="ident" id="5156313">w</span><span class="op" id="5156314">.</span><span class="ident" id="5156315">Write</span><span class="op" id="5156320">(</span><span class="ident" id="5156321">p</span><span class="op" id="5156322">)</span>&nbsp;<span class="comment" id="5156324">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156382">if</span>&nbsp;<span class="ident" id="5156385">err</span>&nbsp;<span class="op" id="5156389">!=</span>&nbsp;<span class="ident" id="5156392">nil</span>&nbsp;<span class="op" id="5156396">&amp;&amp;</span>&nbsp;<span class="ident" id="5156399">w</span><span class="op" id="5156400">.</span><span class="ident" id="5156401">c</span><span class="op" id="5156402">.</span><span class="ident" id="5156403">werr</span>&nbsp;<span class="op" id="5156408">==</span>&nbsp;<span class="ident" id="5156411">nil</span>&nbsp;<span class="op" id="5156415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156419">w</span><span class="op" id="5156420">.</span><span class="ident" id="5156421">c</span><span class="op" id="5156422">.</span><span class="ident" id="5156423">werr</span>&nbsp;<span class="op" id="5156428">=</span>&nbsp;<span class="ident" id="5156430">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156435">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156438">return</span><br>
<span class="lineno"></span><span class="op" id="5156445">}</span>
</div>
</body>
</html>
